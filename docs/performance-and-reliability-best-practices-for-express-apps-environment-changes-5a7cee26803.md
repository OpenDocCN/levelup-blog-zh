# Express 应用程序的性能和可靠性最佳实践—环境变化

> 原文：<https://levelup.gitconnected.com/performance-and-reliability-best-practices-for-express-apps-environment-changes-5a7cee26803>

![](img/7176fb244d031ca8dba65ac69c40adca.png)

照片由[古斯塔沃·奎蓬](https://unsplash.com/@unandalusgus?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 拍摄

当我们将 Express 应用程序用于生产用途时，即它由外部用户使用时，我们应该考虑性能，以便我们的用户在使用我们的应用程序时不会受到影响。

在本文中，我们将了解在生产环境中运行 Express 应用程序时的一些性能和可靠性最佳实践。

# 环境变化

## 将 NODE_ENV 设置为“生产”

我们可以设置`NODE_ENV`环境变量`'production'`来加速或者 app。

设置它会使 Express cache 查看模板，缓存从 CSS 扩展生成的 CSS 文件，并生成较少的详细错误消息。

仅仅通过这种改变，性能就可以提高 3 倍。

我们可以通过使用`process.env.NODE_ENV`来检查`NODE_ENV`的值。但是，我们不应该太频繁地这样做，因为每次这样做都会导致性能下降。

在开发中，我们使用命令行来设置变量。例如我们运行的 Linux 行:

```
env NODE_ENV=production
```

我们可以通过在作业文件中输入相同的命令来启动我们的应用程序。

## 确保我们的应用程序自动重启

为了确保我们的应用程序始终运行，我们应该在它崩溃时自动重启它。

为此，我们使用进程管理器在它崩溃时重启它。当遇到未捕获的异常时，节点应用程序会崩溃。我们应该确保正确处理它们，这样就不会经常崩溃。

一些流程管理器包括 StrongLoop 流程管理器、PM2 和 Forever。

我们可以使用 StrongLoop PM 在本地构建和打包，然后将其安全地部署到生产环境中。如果应用程序崩溃，它会自动重启。

还可以远程管理应用集群。它还允许我们查看 CPU 配置文件和堆快照，以监控资源使用情况。

此外，我们还可以获得性能指标，并通过 Nginx 负载均衡器的集成控制将其扩展到多台主机。

## 暴发户

Upstart 是一个系统工具，允许我们在启动时启动任务，在关机时停止任务，我们可以用它来运行我们的 Express 应用程序，在关机时停止它。

它也会在崩溃时自动重启。

## 在集群中运行我们的应用

我们可以为我们的应用启动一个进程集群，以提高它在多核系统中的性能。

它让我们将负载分配到每个 CPU 内核。

每个集群工作线程都由集群主节点控制。

我们可以使用 node-pm 或集群服务将我们的应用程序任务分配到集群中。

例如，对于 PM2，我们可以通过运行以下命令来启动 5 个工作进程:

```
pm2 start app.js -i 5
```

或者，我们可以让 PM2 自动检测我们服务器的 CPU 可以运行的最大工作线程数，并通过运行以下命令来运行这么多工作线程:

```
pm2 start app.js -i max
```

我们可以通过运行以下命令来添加工人:

```
pm2 scale app +3
```

增加 3 名工人或

```
pm2 scale app 5
```

将我们的应用程序扩展到 5 名员工即可运行。

![](img/2fd1faf048074d53b83162e97086b982.png)

照片由[盒装水更好](https://unsplash.com/@boxedwater?utm_source=medium&utm_medium=referral)上 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

## 缓存请求结果

缓存请求结果意味着我们的应用程序不必重复已经缓存的操作。

Varnish 和 Nginx 可以缓存结果，以提高我们的应用程序的性能。

## 使用负载平衡器

我们可以使用负载平衡器来运行应用程序的多个实例，这样我们就可以处理更多的流量和负载。

要使用负载平衡器运行，我们必须确保与特定会话 ID 相关联的请求连接到发起它们的实例。

这也意味着我们必须使用像 Redis 这样的数据存储来存储会话数据。

## 反向代理

反向代理位于 web 应用程序的前面，并对请求执行操作。它可以将请求定向到应用程序，处理错误页面，压缩，提供文件，负载平衡，以及许多其他事情。

它释放了 Express 来执行专门的应用程序任务，所以在 Nginx 这样的反向代理后面运行我们的应用程序是个好主意。

# 结论

我们可以通过改变服务器来提高应用的性能。

我们可以缓存结果，以便可以使用缓存的结果，而不是重复执行相同的任务。负载平衡器适用于运行一个应用程序的多个实例，但我们必须知道会话 ID，并将其与启动会话的实例相匹配。

此外，我们可以创建一个集群，以便我们的应用程序可以与多个工作人员一起运行。

反向代理让我们做我们的应用程序必须做的各种操作。它将我们的应用从压缩、缓存等任务中解放出来。

此外，将我们的应用程序环境设置为生产环境还会使 Express 对资产进行一些缓存。

为了防止异常关闭我们的应用程序，我们应该在它与进程管理器崩溃时自动重启它。