<html>
<head>
<title>Provisioning Lambda Docker Images with AWS CDK (Python)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS CDK (Python)提供Lambda Docker图像</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/provisioning-lambda-docker-images-with-aws-cdk-python-a10bffd20613?source=collection_archive---------0-----------------------#2022-04-04">https://levelup.gitconnected.com/provisioning-lambda-docker-images-with-aws-cdk-python-a10bffd20613?source=collection_archive---------0-----------------------#2022-04-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/3194d5027361484edd20d35736edf4b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/format:webp/1*mNFm7LvWyTSlKf2j0FQNqw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">Dockerized Lambda函数</figcaption></figure><p id="56d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是两篇文章的第一部分。在这一部分中，我将介绍如何提供lambda docker映像，在下一部分中，我将介绍如何与之交互。</p><p id="ffd4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">涵盖:</p><ul class=""><li id="227e" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">在CDK申报拉姆达码头形象</li><li id="3d01" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">将本地模块导入主docker脚本</li><li id="ab27" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">编写Dockerfile文件</li><li id="9a73" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">读取/写入Docker映像文件系统</li><li id="523e" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">本地测试</li></ul></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><h1 id="31ea" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">先决条件</h1><ul class=""><li id="df07" class="kw kx iq ka b kb mp kf mq kj mr kn ms kr mt kv lb lc ld le bi translated"><a class="ae mu" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank"> Docker </a>安装在本地机器上</li><li id="fe78" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">AWS CDK安装和设置正确</li></ul><p id="65fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以前与Docker的经验将是有益的，尽管我设法弄清楚这一点，这是我第一次与Docker打交道，所以你应该没事。</p><h2 id="1603" class="mv ls iq bd lt mw mx dn lx my mz dp mb kj na nb mf kn nc nd mj kr ne nf mn ng bi translated">目录结构</h2><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="b65e" class="mv ls iq nm b gy nq nr l ns nt">cdk-project<br/>|-- lambdas/<br/>    |-- docker_func/<br/>        |-- app/<br/>            |-- __init__.py<br/>            |-- components/<br/>                |-- __init__.py<br/>                |-- com1.py<br/>                |-- com2.py<br/>            |-- utils/<br/>                |-- __init__.py<br/>                |-- ut1.py<br/>            |-- main.py<br/>            |-- output.json # Optional<br/>        |-- Dockerfile<br/>        |-- README.md<br/>        |-- requirements.txt<br/>|-- project/<br/>   |-- project_stack.py</span></pre></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><h1 id="f3eb" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">过程</h1><p id="b2ec" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj nu kl km kn nv kp kq kr nw kt ku kv ij bi translated">基于上述项目结构的逐步过程。我将在这些步骤中使用的文件名与上述目录结构中的文件直接相关。</p><p id="0ca2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意:从你的CDK项目的根目录开始<code class="fe nx ny nz nm b">../#/cdk-project&gt;</code></p><ol class=""><li id="620d" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv oa lc ld le bi translated">使用CDK声明docker</li></ol><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="caea" class="mv ls iq nm b gy nq nr l ns nt"># ../project/project_stack.py</span><span id="1cc6" class="mv ls iq nm b gy ob nr l ns nt">docker_lambda = _lambda.DockerImageFunction(self, 'DockerLambda',<br/>code=_lambda.DockerImageCode.from_image_asset('lambdas/docker_func'),<br/>    timeout=Duration.seconds(30), # Default is only 3 seconds<br/>    memory_size=1000, # If your docker code is pretty complex<br/>    environment={<br/>        "BUCKET_NAME": bucket.bucket_name # Optional<br/>    }<br/>)</span></pre><p id="25bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.在新终端中，导航到docker功能的顶层:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="738c" class="mv ls iq nm b gy nq nr l ns nt">cd lambdas/docker_func</span></pre><p id="8f1b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.提供一些基本组件/实用程序</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="6ba1" class="mv ls iq nm b gy nq nr l ns nt"># app/components/com1.py</span><span id="914a" class="mv ls iq nm b gy ob nr l ns nt">class Com1():<br/> def __init__(self):<br/>  pass</span><span id="a876" class="mv ls iq nm b gy ob nr l ns nt">~~~</span><span id="be87" class="mv ls iq nm b gy ob nr l ns nt"># app/components/com2.py</span><span id="c659" class="mv ls iq nm b gy ob nr l ns nt">class Com2():<br/> def __init__(self):<br/>  pass</span><span id="d755" class="mv ls iq nm b gy ob nr l ns nt">~~~</span><span id="ce17" class="mv ls iq nm b gy ob nr l ns nt"># app/utils/ut1.py</span><span id="9ed6" class="mv ls iq nm b gy ob nr l ns nt">class Ut1():<br/> def __init__(self):<br/>  pass</span></pre><p id="2303" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.通过将<code class="fe nx ny nz nm b">__init__.py</code>添加到每个文件夹并导入#3中指定的类，将<code class="fe nx ny nz nm b">components</code>和<code class="fe nx ny nz nm b">utils</code>设置为模块。</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="9a7e" class="mv ls iq nm b gy nq nr l ns nt"># app/components/__init__.py<br/>from components.com1 import *<br/>from componented.com2 import *</span><span id="1b4d" class="mv ls iq nm b gy ob nr l ns nt">~~~</span><span id="8996" class="mv ls iq nm b gy ob nr l ns nt"># app/utils/__init__.py<br/>from utils.ut1 import *</span></pre><p id="3c3e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">警告:如果您跳过这一步，您将无法以您认为的方式导入这些模块。当docker打包您的文件时，它会将它们四处移动，这会破坏相对导入(即使它可能在本地工作)</p><p id="c206" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">5.写着<code class="fe nx ny nz nm b">Dockerfile</code>。</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="5a98" class="mv ls iq nm b gy nq nr l ns nt">FROM public.ecr.aws/lambda/python:3.8</span><span id="f61f" class="mv ls iq nm b gy ob nr l ns nt"># Copy function code<br/>COPY app/main.py ${LAMBDA_TASK_ROOT}</span><span id="a0c7" class="mv ls iq nm b gy ob nr l ns nt"># Add local dependencies<br/>ADD app/components components<br/>ADD app/utils utils<br/>ADD app/template.docx template.docx<br/># Install the function's dependencies using file requirements.txt<br/># from your project folder.</span><span id="3ae6" class="mv ls iq nm b gy ob nr l ns nt">COPY requirements.txt  .<br/>RUN  pip3 install -r requirements.txt --target "${LAMBDA_TASK_ROOT}"</span><span id="535a" class="mv ls iq nm b gy ob nr l ns nt"># Set the CMD to your handler (could also be done as a parameter override outside of the Dockerfile)<br/>CMD [ "main.handler" ]</span></pre><p id="98cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在docker文件的<em class="oc">添加本地依赖关系</em>部分有一些重要的细节。<br/>这些<code class="fe nx ny nz nm b">ADD</code>命令告诉docker，当它打包你的文件时，它需要获取<code class="fe nx ny nz nm b">source</code>的内容，并在完成后将其放入<code class="fe nx ny nz nm b">target</code>中。</p><p id="d0e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如<code class="fe nx ny nz nm b">ADD source target</code> &gt; <code class="fe nx ny nz nm b">ADD app/components components</code></p><p id="e036" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这意味着一旦我们的应用程序构建完成，我们就可以通过</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="12f1" class="mv ls iq nm b gy nq nr l ns nt">from components.com1 import Com1</span></pre><p id="6996" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后一行<code class="fe nx ny nz nm b">CMD ["main.handler"]</code>将docker入口点设置为<code class="fe nx ny nz nm b">main.py</code>中的函数<code class="fe nx ny nz nm b">handler</code>:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="1799" class="mv ls iq nm b gy nq nr l ns nt"># main.py</span><span id="fa26" class="mv ls iq nm b gy ob nr l ns nt">def handler(event, context):<br/> pass</span></pre><p id="37d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你不想把你的文件命名为<code class="fe nx ny nz nm b">main.py</code>，那就把我使用它的所有实例都改成你喜欢的名字。</p><p id="8d64" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">6.部署您的更改。最初上传需要一段时间。我是说很长一段时间。大概7到10分钟。</p></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><h1 id="c845" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">写入Docker文件系统</h1><p id="85bb" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj nu kl km kn nv kp kq kr nw kt ku kv ij bi translated">如果你尝试写一个文件，你会得到:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="5a1e" class="mv ls iq nm b gy nq nr l ns nt">[ERROR] OSError: [Errno 30] Read-only file ststel: '/path'</span></pre><p id="f471" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是因为具有任何AWS Lambda函数的唯一可写目录是<code class="fe nx ny nz nm b">/tmp</code>文件夹。</p><p id="9691" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你需要写一份文件，按如下方式做:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="d408" class="mv ls iq nm b gy nq nr l ns nt">document.save('/tmp/report.docx') # example using python-docx</span></pre><h1 id="b8ea" class="lr ls iq bd lt lu od lw lx ly oe ma mb mc of me mf mg og mi mj mk oh mm mn mo bi translated">本地测试</h1><p id="d03d" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj nu kl km kn nv kp kq kr nw kt ku kv ij bi translated">每次你做出改变时，上传docker图片可能是让你的大脑从黏糊糊变成一碗汤的最快方法。不要那样做。改为这样做。</p><p id="68db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">假设您有一个使用了<code class="fe nx ny nz nm b">python-docx</code>库的Docker映像(这不重要，这只是一个很好的例子)。您的脚本加载一个<code class="fe nx ny nz nm b">template.docx</code>文件并保存生成的<code class="fe nx ny nz nm b">output.docx</code>文件。</p><p id="fb80" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了进行本地测试，我们使用python的<code class="fe nx ny nz nm b">if __name__ == "__main__":</code>魔法为我们的处理函数提供虚拟数据。当我们手动运行脚本时，这个方法将<strong class="ka ir">T10运行。</strong></p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="3591" class="mv ls iq nm b gy nq nr l ns nt"># main.py</span><span id="21c8" class="mv ls iq nm b gy ob nr l ns nt">def handler(payload, context, prefix='/tmp/'):<br/>   # ... code<br/>   document.save(prefix+"output.json")<br/>   # ... more code<br/> <br/>   return<br/> <br/>if __name__ == "__main__":<br/>    with open("input.json") as f: # input.json sample event input<br/>        handler(json.load(f), None, prefix='')</span></pre><p id="37b2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，在上面的代码中，我对我的<code class="fe nx ny nz nm b">handler()</code>函数使用了一个<code class="fe nx ny nz nm b">prefix</code>参数。这是为了控制输出文件的写入位置。对于我的本地测试，我不希望文件被写到<code class="fe nx ny nz nm b">/tmp</code>目录，因为一旦我部署，那将是一个保留的文件夹。</p><p id="7653" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要在本地运行该文件，您需要位于<code class="fe nx ny nz nm b">app</code>文件夹中(从一开始就引用目录结构)。</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="1f5a" class="mv ls iq nm b gy nq nr l ns nt">C:\&lt;path&gt;\cdk-project\lambdas\docker_func\app&gt; python main.py</span></pre></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><p id="716c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这应该足够了。以上步骤是我让lambda正常工作所需要做的。作为参考，它的作用是:</p><ol class=""><li id="1ff4" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv oa lc ld le bi translated">一个lambda函数准备一个json对象，并将其发送到Docker映像。</li><li id="fa31" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv oa lc ld le bi translated">Docker Image解析json数据，导入第三方库，读取并填充模板文档，将输出保存到Docker文件系统，将结果上传到S3，最后将S3对象URI返回给调用它的Lambda。</li></ol><p id="18c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">希望这对任何阅读的人都有帮助。谢了。</p></div></div>    
</body>
</html>