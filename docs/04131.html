<html>
<head>
<title>Simple Telegram Bot with Python and AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python和AWS Lambda的简单电报机器人</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/simple-telegram-bot-with-python-and-aws-lambda-5eab1066b466?source=collection_archive---------1-----------------------#2020-06-11">https://levelup.gitconnected.com/simple-telegram-bot-with-python-and-aws-lambda-5eab1066b466?source=collection_archive---------1-----------------------#2020-06-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/07d19cf20247c930b96708a435408093.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JiscKAtmONJVQABVnVUQjA.png"/></div></div></figure><p id="93a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于简单的自动化任务来说，Python是一种极好的语言。它是世界上最受欢迎的语言之一，这要归功于它简单易用的语法，以及庞大的工具和库生态系统。结合像<a class="ae kw" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>这样的无服务器服务，你可以用它来实现非常划算和有用的自动化。在本文中，我将向您展示我如何构建一个简单的Python机器人，它提取雷达图像和数据并将其发送到<a class="ae kw" href="https://telegram.org/" rel="noopener ugc nofollow" target="_blank"> Telegram </a>。我们正在使用网站<a class="ae kw" href="http://lietus.lv" rel="noopener ugc nofollow" target="_blank"> lietus.lv </a>上生成的天气雷达图像，并使用机器人将其发送到Telegram。</p><h1 id="a849" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">电报设置</h1><p id="02ed" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们要做的第一件事是创建一个<strong class="ka ir">电报机器人</strong>。所有电报机器人都使用公开可用的<a class="ae kw" href="https://core.telegram.org/bots/api" rel="noopener ugc nofollow" target="_blank">机器人API </a>。这就是我们的Lambda将如何与Telegram API服务器通信，以实际执行Telegram中的命令，比如发送消息。机器人是在messenger中使用名为<a class="ae kw" href="https://telegram.me/BotFather" rel="noopener ugc nofollow" target="_blank">机器人父亲</a>的机器人创建的。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/21cd13d3c2d46592804f531d06757370.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*6kHrlRp0eT8VAv5uddqmwA.png"/></div><figcaption class="mf mg gj gh gi mh mi bd b be z dk translated">使用Telegram中的BotFather bot权限来创建bot并获取我们的API令牌。</figcaption></figure><p id="9412" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们需要使用BotFather向Telegram注册我们的bot，并获得一个<strong class="ka ir"> API令牌</strong>。这是API的主要授权机制。确保不要在任何公开的地方泄露这个令牌！否则，有人可以很容易地控制你的机器人。如果发生这种情况或者您只是忘记了令牌，不要担心——您可以随时通过再次使用BotFather来更改它。</p><p id="58a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们有了API令牌，我们已经可以开始使用我们的bot向Telegram发送消息了！从技术上来说，一个合适的电报机器人应用程序与电报API进行双向通信，有两种方式:</p><ul class=""><li id="e9de" class="mj mk iq ka b kb kc kf kg kj ml kn mm kr mn kv mo mp mq mr bi translated"><strong class="ka ir">长轮询</strong>(循环轮询电报API更新)</li><li id="5c2e" class="mj mk iq ka b kb ms kf mt kj mu kn mv kr mw kv mo mp mq mr bi translated"><strong class="ka ir"> Web-hook </strong>(注册新更新时调用的应用程序请求端点)</li></ul><p id="f633" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，我们不需要这些，因为我们的机器人只会发送消息。相反，我们可以简单地使用Telegram API<a class="ae kw" href="https://core.telegram.org/bots/api#sendphoto" rel="noopener ugc nofollow" target="_blank">send photo</a>方法。我们甚至根本不需要处理文件——我们只是将雷达图像的URL直接发送给Telegram。</p><p id="256e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们将为机器人创建一个发布内容的通道。确保将机器人添加为管理员。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/1ad20e2f942a108b35c5485ceca1a64d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*3RrIJlBkFgcg5862b-4oUg.png"/></div></figure><p id="0797" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在这里有一个小的棘手的部分。API中的所有聊天交互方法都通过特定的带符号整数ID来识别电报聊天。没有一种简单的方法可以得到它，但是一种方法是发送一条测试消息给聊天工具，然后转发给一个非常有用的机器人，叫做<a class="ae kw" href="https://t.me/RawDataBot" rel="noopener ugc nofollow" target="_blank">电报机器人Raw </a>。它将打印出消息的原始元数据。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/51db2191db0ee8e49cac3c8fab0180d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*EOOQoqSLDAqZ4DvKp6PFIA.png"/></div></figure><p id="1597" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们对<strong class="ka ir">“forward _ from _ chat”</strong>键中的<strong class="ka ir"> id </strong>感兴趣。那是我们的<strong class="ka ir"> chat_id。</strong></p><h1 id="653f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置AWS Lambda</h1><p id="4722" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">现在是时候创建我们的λ了。Lambda是一个非常强大和廉价的AWS服务，简单地说，它允许你按需运行一些代码，而不必担心托管虚拟服务器。这意味着只有当您的代码运行时，您才需要付费。在当前的定价模式下，Lambda实际上对大量的初始执行和运行时是免费的。此时，我假设您有一个AWS帐户。我们做的第一件事是前往<a class="ae kw" href="https://console.aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS控制台</a>并前往Lambda部分。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/29459955666679af487239a02e0dda9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*do7PYvwVewloUhd7N3s0Kw.png"/></div></div></figure><p id="e1c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击<strong class="ka ir">“创建功能”</strong>，会出现一个表格。我们对一个<strong class="ka ir"> Python 3.8 </strong>运行时环境感兴趣(在撰写本文时，这是Python的最新稳定版本)，并给它一个有意义的名字。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/44a97f8e78da5c54764f78b3613067c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rknM_eJU8sDeU0i8ZsHaVA.png"/></div></div></figure><p id="1eb2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的Lambda诞生了！现在我们需要做更多的设置。就像我之前说过的，你应该<strong class="ka ir">永远不要</strong>在你的代码中明文放置敏感的凭证或令牌。相反，我们可以从<strong class="ka ir">环境变量</strong>加载电报API令牌。设置一个很容易:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/5ae385ee425634dce7b9c4c06d7ad661.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l6VeGadY-gCCniV3DY-hMw.png"/></div></div></figure><p id="951b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">默认情况下，环境变量将使用一个新的对称密钥对静态进行<strong class="ka ir">加密。在生产中，强烈建议在传输过程中也加密密钥。你可以在这里阅读更多相关信息<a class="ae kw" href="https://docs.aws.amazon.com/lambda/latest/dg/security-dataprotection.html" rel="noopener ugc nofollow" target="_blank">。</a></strong></p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/87c54743a7ffd6897297cc0c53aed4a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hh02uq4VM1ckorWEadEFyA.png"/></div></div></figure><p id="b1b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这次我们可以直接在Lambda编辑器中编写代码，因为我们不需要任何外部库，这次我们保持简单。</p><h1 id="84ff" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">编写代码</h1><p id="e888" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这一次，我们将内置的<code class="fe my mz na nb b">http.client</code>模块用于HTTP请求。我们通过附加从先前定义的环境变量中获得的<code class="fe my mz na nb b">telegram_token</code>来构造端点。<code class="fe my mz na nb b">lambda_handler</code>是我们的处理函数——它是Lambda被触发时将被调用的函数。另一个选择是使用<a class="ae kw" href="https://requests.readthedocs.io/en/master/" rel="noopener ugc nofollow" target="_blank">请求</a>库，但是这次我们保留了它的准系统。我刚刚使用了一个类似于<a class="ae kw" href="https://insomnia.rest/" rel="noopener ugc nofollow" target="_blank">失眠症</a>的<strong class="ka ir"> REST </strong>客户端，它允许你在编写任何代码之前测试一个API，以及<strong class="ka ir">在大多数语言和库中生成代码</strong>。我使用的source在一个子资源中保存了一个生成的雷达图像列表，如下所示:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/ff3cb351cf75194d4c090dc57909b38e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u2jAlFmaLX_PiPsTMoNrtA.png"/></div></div></figure><p id="3964" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，我们甚至不需要使用任何库，因为Python已经内置了<code class="fe my mz na nb b">html.parse</code>模块。</p><p id="f69b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在编写了我们自己的小解析器并一起尝试之后，最终结果将如下所示:</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="f50e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以通过发送一些虚拟负载来测试我们的Lambda:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/5ffb6621d7ec90c68d3ee8c41acc4e86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1RWcDs6nSZyb2mxK8vNdfQ.png"/></div></div></figure><h1 id="fe91" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">最后的步骤:AWS EventBridge</h1><p id="d54d" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">最后一步是根据一些时间表执行我们的Lambda。典型的方法是创建一个<a class="ae kw" href="https://aws.amazon.com/eventbridge/" rel="noopener ugc nofollow" target="_blank"> EventBridge </a>触发器。您可以使用<strong class="ka ir">费率</strong>或典型的<strong class="ka ir"> cron </strong>时间表。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/2590c43299f0dc547a939d794d001f6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*phH01dCjWUVrguJGeY-Gag.png"/></div></div></figure><p id="1498" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样！您应该在Lambda设计器中看到连接器。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/339a1354ec2ff41bf5d9399c2f556fdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ybdzE2447cY9qhDLczs2NQ.png"/></div></div></figure><p id="2793" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最终结果:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/11fed727a00b0ebfb50d5658887133bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*RBb6cWLLgieGnfoMuJvfYw.png"/></div></figure><h1 id="aaa9" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">感谢阅读！</h1><p id="e946" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我希望你学到了新东西。下一次，我们可以尝试一些更高级的东西——创建一个交互式机器人，它将根据用户命令提供图像/响应。如果你有任何额外的问题，请在推特上联系我</p></div></div>    
</body>
</html>