<html>
<head>
<title>Deploy an application in Elastic Beanstalk with Nginx and with SSL, without ACM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Nginx和SSL在Elastic Beanstalk中部署应用程序，不使用ACM</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploy-an-application-in-elastic-beanstalk-with-nginx-with-ssl-without-acm-d7216a2956d5?source=collection_archive---------1-----------------------#2021-08-23">https://levelup.gitconnected.com/deploy-an-application-in-elastic-beanstalk-with-nginx-with-ssl-without-acm-d7216a2956d5?source=collection_archive---------1-----------------------#2021-08-23</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><p id="c986" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我喜欢弹性豆茎。这是一个非常棒的PaaS解决方案，通过自动扩展使应用程序部署变得轻而易举。在AWS的保护伞下，它也真的很强大，有这么多的功能。</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj kp"><img src="../Images/ad48d9871f51c98958adfab3b0a11254.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_oS8FErmI-qOe_Fmew8j5g.jpeg"/></div></div><figcaption class="lb lc gk gi gj ld le bd b be z dk translated"><a class="ae lf" href="https://unsplash.com/@freestocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">自由股票</a>在<a class="ae lf" href="https://unsplash.com/s/photos/security?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="3b74" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">在典型的场景中，负载平衡器应该处理HTTPS流量，并通过TCP 80将明文流量发送到后端服务器。但是我也看到了很多需要对从负载平衡器到终端服务器的流量进行加密的场景，这样企业就可以全程实施SSL。在这些情况下，我们还必须在web服务器(Apache/Nginx)中配置SSL。</p><p id="15dc" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">在这篇文章中，让我们用Nginx在Elastic Beanstalk中部署一个应用程序来代理请求。我们还将在Nginx中使用S3可用的证书来配置SSL(<strong class="jt iv">不使用ACM </strong>)</p><p id="dba1" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">代码托管在此处:</p><div class="lg lh gq gs li lj"><a href="https://github.com/susamn/eb-nginx-ssl" rel="noopener  ugc nofollow" target="_blank"><div class="lk ab fp"><div class="ll ab lm cl cj ln"><h2 class="bd iv gz z fq lo fs ft lp fv fx it bi translated">GitHub - susamn/eb-nginx-ssl:一个示例应用程序，展示了如何使用ssl为弹性应用程序配置Nginx…</h2><div class="lq l"><h3 class="bd b gz z fq lo fs ft lp fv fx dk translated">一个示例应用程序，展示了如何使用SSL为弹性Beanstalk设置配置Nginx。</h3></div><div class="lr l"><p class="bd b dl z fq lo fs ft lp fv fx dk translated">github.com</p></div></div><div class="ls l"><div class="lt l lu lv lw ls lx kz lj"/></div></div></a></div><p id="55e8" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我已经使用了AWS提供的简单示例应用程序，并为SSL添加了必要的文件。</p><p id="0414" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我们只需要3个文件。</p><ol class=""><li id="dbd5" class="ly lz iu jt b ju jv jy jz kc ma kg mb kk mc ko md me mf mg bi translated"><strong class="jt iv"> nginx-proxy.config <br/> </strong>这个文件启用nginx特性，这样Elastic Beanstalk就知道它需要使用nginx作为代理服务器。</li></ol><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="mh mi l"/></div></figure><blockquote class="mj mk ml"><p id="168f" class="jr js mm jt b ju jv jw jx jy jz ka kb mn kd ke kf mo kh ki kj mp kl km kn ko in bi translated">将该文件放在<strong class="jt iv">中。捆绑应用程序代码时的ebextensions </strong>文件夹。</p></blockquote><p id="d49e" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated"><strong class="jt iv"> 2。copycerts.sh </strong> <br/>该文件用于在应用程序启动前将证书文件从S3下载到应用服务器。</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="mh mi l"/></div></figure><p id="17bd" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我这里有我自己签名的证书:</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj mq"><img src="../Images/84d6f04cfd80b8006140889e6360c5bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LO5MRKXFB8olWByUsN-8Lw.png"/></div></div></figure><p id="213a" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">这里需要记住一些事情。</p><ul class=""><li id="61ec" class="ly lz iu jt b ju jv jy jz kc ma kg mb kk mc ko mr me mf mg bi translated">在与应用程序捆绑之前，此文件的执行权限(+x)。否则，我们将被EC2服务器拒绝许可。</li><li id="f424" class="ly lz iu jt b ju ms jy mt kc mu kg mv kk mw ko mr me mf mg bi translated">这个脚本需要知道证书文件在哪里。为了指定这些数据，我们需要设置env变量。<strong class="jt iv"> PRIVATE_BUCKET </strong>指定BUCKET名称，而<strong class="jt iv"> CERT_PATH </strong>指定位置。</li></ul><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj mx"><img src="../Images/3e3e52700ebe76e230d6e43e27b79a0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-HInzaT4nRZ5586vxUpRnQ.png"/></div></div></figure><ul class=""><li id="3498" class="ly lz iu jt b ju jv jy jz kc ma kg mb kk mc ko mr me mf mg bi translated">设置另一个名为<strong class="jt iv"> PORT </strong>的环境变量，以控制应用程序将使用哪个端口在本地运行。在第16 行的<strong class="jt iv">Nginx配置的应用程序和下一个文件中进行必要的更改。它告诉Nginx将应用程序的流量路由到哪里。</strong></li><li id="3ba2" class="ly lz iu jt b ju ms jy mt kc mu kg mv kk mw ko mr me mf mg bi translated">如果您有一个证书链，在这个脚本中做一些必要的修改来复制它们。</li><li id="9083" class="ly lz iu jt b ju ms jy mt kc mu kg mv kk mw ko mr me mf mg bi translated">确保授予S3对elastic beanstalk环境的访问权限，这样它启动的任何服务器都将附加该策略。转到Elastic Beanstalk<strong class="jt iv">env</strong>-&gt;<strong class="jt iv">配置</strong> - &gt; <strong class="jt iv">安全</strong>并记下实例概要文件名称。然后转到<strong class="jt iv"> IAM </strong>并将<strong class="jt iv"> S3ReadOnlyAccess </strong>策略添加到该实例概要文件中。</li></ul><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj my"><img src="../Images/62675f0b4283cb01798812a7f687f51e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HOOvmluvoFuDLF7kkCJhHg.png"/></div></div></figure><blockquote class="mj mk ml"><p id="25a9" class="jr js mm jt b ju jv jw jx jy jz ka kb mn kd ke kf mo kh ki kj mp kl km kn ko in bi translated">将该文件保存在<strong class="jt iv">中。platform/hooks/predeploy </strong>在捆绑的应用程序代码的根中，以便它在主应用程序运行之前执行，并且Nginx可以在正确的位置找到证书。</p></blockquote><p id="29a5" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated"><strong class="jt iv"> 3。https-listener.conf <br/> </strong>这是Nginx配置文件，取代了Nginx使用的原始配置文件。</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="mh mi l"/></div></figure><p id="d252" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">这个文件是相当简单的Nginx配置。它用于在运行的服务器中配置Nginx服务器行为。</p><ul class=""><li id="7972" class="ly lz iu jt b ju jv jy jz kc ma kg mb kk mc ko mr me mf mg bi translated">在第6行和第7行中，我们指出了应用服务器中的证书位置。在前面的脚本中，我们从S3复制了证书文件。</li><li id="acde" class="ly lz iu jt b ju ms jy mt kc mu kg mv kk mw ko mr me mf mg bi translated">从第15行到第21行，我们指定了位置。当Nginx收到流量时，它会根据路径将这些流量转发到这个位置。</li></ul><blockquote class="mj mk ml"><p id="8a9d" class="jr js mm jt b ju jv jw jx jy jz ka kb mn kd ke kf mo kh ki kj mp kl km kn ko in bi translated">将该文件放在<strong class="jt iv">中。捆绑应用中的platform/nginx/conf.d/ </strong>文件夹。这是AWS为Nginx配置推荐的途径。</p></blockquote><p id="dac1" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">就是这样，如果一切顺利，nginx服务器将有适当的配置，当应用程序启动时，我们将获得一个443端口，以获取HTTPS流量。</p><p id="28a5" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">通过到服务器验证它:</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj mz"><img src="../Images/f7e9c255c79baf38dd1de681828e5028.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lo-xE1SkNAPWW8m_CshnYQ.png"/></div></div></figure><p id="ac8d" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">由于有一个自签名证书，我得到了卷曲的问题。但是在理想情况下，您的客户或雇主会提供证书进行配置，所以您应该没问题。</p><h2 id="315e" class="na nb iu bd nc nd ne dn nf ng nh dp ni kc nj nk nl kg nm nn no kk np nq nr ns bi translated">当事情不顺利的时候</h2><p id="6d42" class="pw-post-body-paragraph jr js iu jt b ju nt jw jx jy nu ka kb kc nv ke kf kg nw ki kj kk nx km kn ko in bi translated">如果由于任何原因，环境无法启动，请从Elastic Beanstalk env启用日志流，并在CloudWatch中查看日志。</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj mx"><img src="../Images/d76b029b891db38a75528b866fff8137.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eab4kWEHThXNfWjtq9SSYw.png"/></div></div></figure><p id="24cf" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">查看<strong class="jt iv"> eb-engine.log </strong>以找到任何与弹性beanstalk环境设置相关的问题。</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj ny"><img src="../Images/868ad1d53f2f8c114dda7e3b8a15c2ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OBzVo-QouDv0_hT0eqQ5Hw.png"/></div></div></figure></div><div class="ab cl nz oa hy ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="in io ip iq ir"><p id="8fce" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">现在是时候配置负载平衡器将HTTPS流量转发到弹性beanatalk服务器了。</p><h1 id="2bd7" class="og nb iu bd nc oh oi oj nf ok ol om ni on oo op nl oq or os no ot ou ov nr ow bi translated">在负载平衡器中添加一个侦听器</h1><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj ox"><img src="../Images/721663b627ecf3d3a1ca92b96cf0e384.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R3o4BnZXOGrCd7Q5pOz4RQ.png"/></div></div></figure><p id="d063" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">这里我们只有一个HTTP端口转发。点击Add listenter，添加一个HTTPS监听器，将流量转发到eb服务器。</p><p id="a759" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">所以有两件事要做，非常简单。</p><ol class=""><li id="bc40" class="ly lz iu jt b ju jv jy jz kc ma kg mb kk mc ko md me mf mg bi translated">在eb服务器的安全组中添加入站规则以接受HTTPs流量。</li><li id="7b8c" class="ly lz iu jt b ju ms jy mt kc mu kg mv kk mw ko md me mf mg bi translated">在负载平衡器中添加侦听器，将HTTPs流量转发到上述安全组。</li></ol></div></div>    
</body>
</html>