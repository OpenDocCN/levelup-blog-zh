<html>
<head>
<title>An Introduction on Collecting Data from APIs with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python从API中收集数据的介绍</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/an-introduction-on-collecting-data-from-apis-with-python-c132376b0132?source=collection_archive---------12-----------------------#2021-08-31">https://levelup.gitconnected.com/an-introduction-on-collecting-data-from-apis-with-python-c132376b0132?source=collection_archive---------12-----------------------#2021-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/63110ecf57c8c89d95fae5ca5e70afcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ppyaHr3qpaX5ivZz"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Vishnu R Nair 在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="eec0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当人们想到从网上收集数据时，通常会想到直接在网站的HTML中查找数据。实际上，这就是许多人用Python开始他们的web爬行之旅的原因。至少我是这么做的。</p><p id="ca0b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您发送一个GET请求，用BeautifulSoup解析HTML并找到您需要的数据。或者，您可能需要设置Selenium来与网站交互，单击一个按钮，加载JavaScript呈现的内容，然后查找数据。</p><p id="77e1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你问我，我会说这是一个有趣的过程，但它并不总是必要的，因为它经常可以被API的使用所取代。你在网站上看到的数据很可能来自一个API。您的浏览器向端点发送请求，接收信息，然后加载前端。</p><p id="4831" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些API通常是公共的，这意味着您可以自己向它们发送请求，而无需使用浏览器。在本文中，我们将看到一个关于如何识别网站上的API以及如何直接从代码中访问它们的数据的快速介绍。</p><h1 id="c9dd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">识别API</h1><p id="d0e3" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">作为本文的一个例子，我们将从一个非常著名的体育统计网站收集数据。姑且称之为“一个统计网站”。</p><p id="c4aa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，一旦您进入了想要获取数据的页面，在本例中是一个匹配页面，按F12键打开浏览器的开发工具。然后转到网络选项卡，选择获取/XHR。</p><p id="74af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦你这样做了，你将会看到一些API响应。只是找到你需要的那一个的问题。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi me"><img src="../Images/5889bd248f42f86392b7aa5dc73c3390.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*DrmDxoWQ9BXufFahTtnKWQ.png"/></div></figure><p id="40e4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这个特殊的例子中，当我们寻找比赛的统计数据时，很容易找到API。一旦我们点击它，就会显示更多关于API的信息。</p><p id="251a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果找到合适的API不那么容易，那么就有必要一个一个地尝试，直到找到为止。通过点击“Response”选项卡，可以看到API返回的信息，从而帮助我们找到正确的信息。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/8ab48dde2c65d851ab3bcee646310286.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UX4dqBgjrVD29sj4BFcr3w.png"/></div></div></figure><p id="dd67" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里重要的是请求URL。这是我们需要发送请求的地方。如果您在浏览器中打开URL，您已经能够在JSON中看到数据。</p><p id="0439" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您是新手，并且不熟悉JavaScript对象表示法— JSON，那也没关系。它基本上是一个Python字典，它是你从API接收数据的方式。在这里阅读更多<a class="ae kc" href="https://www.json.org/json-en.html" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="6308" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">回到网址，你看到的那个数字是网站为此匹配创建的唯一ID。所以这就是你需要改变的，从几个不同的匹配中收集数据。</p><h1 id="f51c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">收集数据</h1><p id="c582" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">既然我们已经成功地确定了我们需要的API以及如何与之交互，那么这个过程中最困难的部分就完成了。</p><p id="ee3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从现在开始，我们要做的就是发送GET请求并接收我们想要的数据。这里的过程非常简单。我们所需要的就是从请求库中导入get函数，发送请求和JSON模块。</p><p id="4cf1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完成后，我们只需要在API URL中插入它需要的信息，在本例中是匹配ID，发送请求，然后用<code class="fe mk ml mm mn b">loads</code>函数解析响应的文本。</p><pre class="mf mg mh mi gt mo mn mp mq aw mr bi"><span id="9b8a" class="ms lc iq mn b gy mt mu l mv mw">from requests import get<br/>import json</span><span id="518e" class="ms lc iq mn b gy mx mu l mv mw">url = f'https://api.aStatsWebSite.com/{id}/statistics'<br/>page = get(url).text<br/>data = json.loads(page)</span></pre><p id="b865" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是数据现在的样子:</p><pre class="mf mg mh mi gt mo mn mp mq aw mr bi"><span id="3343" class="ms lc iq mn b gy mt mu l mv mw">{<br/>  "statistics": [<br/>    {<br/>      "period": "ALL",<br/>      "groups": [<br/>        {<br/>          "groupName": "Possession",<br/>          "statisticsItems": [<br/>            {<br/>              "name": "Ball possession",<br/>              "home": "58%",<br/>              "away": "42%",<br/>              "compareCode": 1<br/>            }<br/>          ]<br/>        },<br/>        {<br/>          "groupName": "Shots",<br/>          "statisticsItems": [<br/>            {<br/>              "name": "Total shots",<br/>              "home": "7",<br/>              "away": "14",<br/>              "compareCode": 2<br/>            },<br/>            {<br/>              "name": "Shots on target",<br/>              "home": "2",<br/>              "away": "4",<br/>              "compareCode": 2<br/>            }<br/>...</span></pre><p id="8df8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">到目前为止，我们已经成功地识别了API并收集了数据。现在剩下要做的就是将数据转换成表格格式并存储起来。对于这个任务，Pandas的json_normalize函数可能会有所帮助，但是在处理更复杂的json文件时，使用起来有点棘手。</p><p id="427b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个好的方法是将JSON简化成一个一层字典，然后使用pandas DataFrame.from_dict()函数。我们需要做的就是遍历“Groups”键中的列表，然后获得每个stat的“name”、“home”和“away”值。</p><pre class="mf mg mh mi gt mo mn mp mq aw mr bi"><span id="582d" class="ms lc iq mn b gy mt mu l mv mw">all_stats = {}<br/>for group in j['statistics'][0]['groups']:<br/>    for stat in group['statisticsItems']:<br/>        all_stats[stat['name']] = [stat['home'], stat['away']]</span></pre><p id="3d28" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是现在的数据:</p><pre class="mf mg mh mi gt mo mn mp mq aw mr bi"><span id="9192" class="ms lc iq mn b gy mt mu l mv mw">{'Accurate passes': ['243 (73%)', '193 (65%)'],  <br/>'Aerials won': ['33', '25'],  <br/>'Ball possession': ['53%', '47%'], <br/>'Corner kicks': ['5', '5'],  <br/>'Crosses': ['7/25 (28%)', '3/16 (19%)'],  <br/>'Dribbles': ['11/15 (73%)', '14/24 (58%)'],  <br/>'Duels won': ['87', '76'],  <br/>'Fouls': ['24', '16'],  <br/>'Goalkeeper saves': ['2', '4'],  <br/>'Interceptions': ['14', '8'],  <br/>'Offsides': ['3', '3'],  <br/>'Passes': ['332', '296'],  <br/>'Shots inside box': ['8', '8'],  <br/>'Shots off target': ['2', '7'],  <br/>'Shots on target': ['4', '3'],  <br/>'Tackles': ['27', '14'],  <br/>'Total shots': ['12', '12'],  <br/>'Yellow cards': ['2', '2']}</span></pre><p id="8a8c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在转换成数据帧:</p><pre class="mf mg mh mi gt mo mn mp mq aw mr bi"><span id="47ac" class="ms lc iq mn b gy mt mu l mv mw">df = pd.DataFrame.from_dict(all_stats)</span></pre><p id="a74f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们刚刚收集的数据的最终版本，可以按照您的喜好存储:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/54200d515fd3c46f529b8b3a00ddd885.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I0asl5bT-XfC5SRmVmKeZQ.png"/></div></div></figure><h1 id="0862" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">最终注释</h1><p id="42d0" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">当然，从单个游戏收集数据意义不大。我的意思是，如果这就是你所需要的，谷歌搜索就可以了。</p><p id="0cff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要从大量游戏中收集数据，只需在本文的第一个代码片段之前使用for循环遍历匹配id列表，以便根据需要重复这个过程。</p><p id="499d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，如果您选择使用这种方法，那么使用机制来避免代码引发异常就变得更加重要了。因此，确保在需要时使用try和except子句，在代码中插入尽可能多的暂停，以避免服务器过载和被服务器阻止，并利用代理提供商，如<a class="ae kc" href="https://infatica.io/" rel="noopener ugc nofollow" target="_blank"> Infatica </a>，因为他们能够为您提供更好的IP地址基础设施，这样您就可以确保您的代码将继续运行。</p><p id="4bc5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢您的阅读！</p></div></div>    
</body>
</html>