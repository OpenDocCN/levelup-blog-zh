<html>
<head>
<title>How to Configure Multiple Databases with Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Spring Boot配置多个数据库</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-configure-multiple-databases-with-spring-boot-81414cf4506d?source=collection_archive---------7-----------------------#2022-12-12">https://levelup.gitconnected.com/how-to-configure-multiple-databases-with-spring-boot-81414cf4506d?source=collection_archive---------7-----------------------#2022-12-12</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><figure class="gm go js jt ju jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj jr"><img src="../Images/d59ae5e4a95210ba5754e9fd185c808c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-LnEZIbywYJN4yuCgKjw2Q.png"/></div></div><figcaption class="kc kd gk gi gj ke kf bd b be z dk translated">照片由<a class="ae kg" href="https://www.pexels.com/@tima-miroshnichenko?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">马体·米罗什尼琴科</a>从<a class="ae kg" href="https://www.pexels.com/photo/man-in-red-and-blue-plaid-button-up-shirt-using-silver-macbook-5702300/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">派克斯</a>拍摄</figcaption></figure><p id="7c22" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated"><strong class="kj iv"> <em class="lf">您需要配置Spring Boot应用程序来处理多个数据源吗？</em>T9】</strong></p><p id="8dcb" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这个SO问题的大多数解决方案都有<code class="fe lg lh li lj b">@Primary</code>来标记主数据源。这不是我们所需要的，因为我们希望有平等的多个数据库。</p><p id="d9e9" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated"><strong class="kj iv"> <em class="lf">不想要主数据库怎么办？如果您想将迁移应用到多个数据源，该怎么办？</em>T15】</strong></p><p id="c288" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">我们将从这个POC repo开始，它可以在<a class="ae kg" href="https://github.com/kimhrac/poc_springboot_3_multi_databases" rel="noopener ugc nofollow" target="_blank">这个GitHub链接</a>上找到。</p><p id="4977" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">让我们来看看为Spring Boot应用程序配置多个数据库需要什么。</p><h1 id="20b5" class="lk ll iu bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">您将需要单独的实体管理器</h1><p id="24af" class="pw-post-body-paragraph kh ki iu kj b kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la mm lc ld le in bi translated">对于每个数据库，我们需要配置实体管理器工厂并填充数据源数据。</p><p id="a3e2" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这可以用下面的方法来完成。</p><pre class="mn mo mp mq gu mr lj ms bn mt mu bi"><span id="3c6e" class="mv ll iu lj b be mw mx l my mz">@Configuration  <br/>@EnableTransactionManagement  <br/>@EnableJpaRepositories(  <br/>        basePackages = "com.acme.poc.springboot.backend.database.h2.repository",  <br/>        entityManagerFactoryRef = "h2EntityManagerFactory",  <br/>        transactionManagerRef = "h2UserTransactionManager"  <br/>)  <br/>@EntityScan(basePackages = {  <br/>        "com.acme.poc.springboot.backend.database.h2.entity"  <br/>})  <br/>public class H2SQLPersistence {  <br/>private final Environment env;  <br/>public H2SQLPersistence(Environment env) {  <br/>        this.env = env;  <br/>    }  <br/><br/>    @Autowired  <br/>    @Bean("h2EntityManager")  <br/>    public EntityManager h2EntityManager(@Qualifier("h2EntityManagerFactory")  <br/>                                       LocalContainerEntityManagerFactoryBean factoryBean) {  <br/>        return factoryBean.getObject().createEntityManager();  <br/>    }  <br/>    @Autowired  <br/>    @Bean("h2UserTransactionManager")  <br/>    public PlatformTransactionManager h2UserTransactionManager(@Qualifier("h2EntityManagerFactory")  <br/>                                                                       LocalContainerEntityManagerFactoryBean factoryBean) {  <br/>        return new JpaTransactionManager() {{  <br/>            setEntityManagerFactory(factoryBean.getObject());  <br/>        }};  <br/>    }  <br/>    @Autowired  <br/>    @Bean("h2EntityManagerFactory")  <br/>    public LocalContainerEntityManagerFactoryBean h2UserEntityManagerFactory(@Qualifier("h2UserDataSource")  <br/>                                                                                     DataSource h2UserDataSource) {  <br/>        HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter() {{  <br/>            setGenerateDdl(true);  <br/>        }};  <br/>        HashMap&lt;String, Object&gt; properties = new HashMap&lt;&gt;() {{  <br/>            put("hibernate.hbm2ddl.auto", env.getProperty("hibernate.hbm2ddl.auto"));  <br/>            put("hibernate.dialect", env.getProperty("application.database.h2.hibernate.dialect"));  <br/>        }};  <br/>        PersistenceProvider provider = new HibernatePersistenceProvider();  <br/>        return new LocalContainerEntityManagerFactoryBean() {{  <br/>            setDataSource(h2UserDataSource);  <br/>            setPackagesToScan("com.acme.poc.springboot.backend.database.h2");  <br/>            setJpaVendorAdapter(vendorAdapter);  <br/>            setJpaPropertyMap(properties);  <br/>            setPersistenceProvider(provider);  <br/>        }};  <br/>    }  <br/>    @Bean("h2UserDataSource")  <br/>    public DataSource h2UserDataSource() {  <br/>        return new DriverManagerDataSource() {{  <br/>            setDriverClassName(env.getProperty("application.database.h2.driverClassName"));  <br/>            setUrl(env.getProperty("application.database.h2.url"));  <br/>            setUsername(env.getProperty("application.database.h2.username"));  <br/>            setPassword(env.getProperty("application.database.h2.password"));  <br/>        }};  <br/>    }  <br/>}</span></pre><p id="c45e" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">我们将读出属性并创建数据源。之后，我们创建实体管理器工厂。工厂bean用于设置事务管理器和实体管理器。</p><p id="f8e7" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">在实体服务中，我们将使用相关的事务管理器:</p><pre class="mn mo mp mq gu mr lj ms bn mt mu bi"><span id="cf75" class="mv ll iu lj b be mw mx l my mz">@Transactional(transactionManager = "postgresqlUserTransactionManager")</span></pre></div><div class="ab cl na nb hy nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="in io ip iq ir"><h1 id="8d9a" class="lk ll iu bd lm ln nh lp lq lr ni lt lu lv nj lx ly lz nk mb mc md nl mf mg mh bi translated">Flyway怎么样？</h1><p id="0600" class="pw-post-body-paragraph kh ki iu kj b kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la mm lc ld le in bi translated"><strong class="kj iv"> <em class="lf">您如何将数据迁移到这些数据库中？</em> </strong></p><p id="be8c" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">此解决方案中缺少的部分是Flyway迁移。我会把这部分留给你去想。</p><p id="3d56" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">我会把需要的步骤写在这里。T25】</p><p id="51a1" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">您需要获取数据源属性，并将它们加载到迁移器类中。然后遍历它们，运行到特定数据库的迁移。</p><p id="fbe2" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated"><strong class="kj iv"> <em class="lf">如果你需要这个项目与Flyway你可以支持我的工作，并在这里找到源代码:</em> </strong> <a class="ae kg" href="https://zivce.gumroad.com/l/svvxep" rel="noopener ugc nofollow" target="_blank">多数据源/数据库的Spring Boot应用</a></p></div><div class="ab cl na nb hy nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="in io ip iq ir"><h1 id="1150" class="lk ll iu bd lm ln nh lp lq lr ni lt lu lv nj lx ly lz nk mb mc md nl mf mg mh bi translated">了解该解决方案有什么重要的？</h1><p id="f240" class="pw-post-body-paragraph kh ki iu kj b kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la mm lc ld le in bi translated"><em class="lf">我们根本没有使用</em> <code class="fe lg lh li lj b"><em class="lf">@Primary</em></code> <em class="lf">标注。</em></p><p id="efd2" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这意味着这是一个真正的多数据库项目。您可以拥有不同的数据库，并且可以针对所有这些数据库。此外，您可以关闭某个数据库，转到另一个数据库。</p><p id="6dd4" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated"><em class="lf"> Flyway可以运行到每个数据库的迁移。</em></p><p id="c82f" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">如果您已经完成了上面的步骤或者找到了我的解决方案，您可以迁移到每个数据库。使用现成的flyway，您只能迁移到主数据源。</p><p id="93b8" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">以下是向H2和PostgreSQL的迁移:</p><figure class="mn mo mp mq gu jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj nm"><img src="../Images/e958dd2ce71e65822c6433d9bda51df1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zsxMhcFKM5xAvO7_ywlrpg.png"/></div></div></figure><p id="c087" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated"><em class="lf"> Flyway默认</em> <a class="ae kg" href="https://stackoverflow.com/questions/37281229/multiple-datasources-migrations-using-flyway-in-a-spring-boot-application" rel="noopener ugc nofollow" target="_blank"> <em class="lf">挑选主数据源，只向主数据源迁移</em> </a> <em class="lf">。</em></p><p id="e7e1" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">如果需要，您还可以插入任何数据库。按照最初的请求，您可以按需删除数据库。项目将继续使用配置好的数据库。</p><p id="02d8" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated"><strong class="kj iv"> <em class="lf">比恩没有必要压倒一切。</em> </strong></p><p id="f728" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">用<code class="fe lg lh li lj b">@Primary</code>你将需要一个覆盖特性。有了这个解决方案，就没有这个必要了。</p></div><div class="ab cl na nb hy nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="in io ip iq ir"><h1 id="c36e" class="lk ll iu bd lm ln nh lp lq lr ni lt lu lv nj lx ly lz nk mb mc md nl mf mg mh bi translated">分级编码</h1><p id="0f52" class="pw-post-body-paragraph kh ki iu kj b kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la mm lc ld le in bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="3b55" class="nn no iu kj b kk kl ko kp ks np kw nq la nr le ns nt nu nv bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="1d7b" class="nn no iu kj b kk nw ko nx ks ny kw nz la oa le ns nt nu nv bi translated">📰查看<a class="ae kg" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="1f31" class="nn no iu kj b kk nw ko nx ks ny kw nz la oa le ns nt nu nv bi translated">🔔关注我们:<a class="ae kg" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae kg" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae kg" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="eabe" class="pw-post-body-paragraph kh ki iu kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">🚀👉<a class="ae kg" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kj iv">加入升级人才集体，找到一份惊艳的工作</strong> </a></p></div></div>    
</body>
</html>