# 基于 Zip 的漏洞:Zip 滑和 Zip 符号链接上传

> 原文：<https://levelup.gitconnected.com/zip-based-exploits-zip-slip-and-zip-symlink-upload-21afd1da464f>

在本文中，我将带您了解两个涉及 Zip 文件的最常被利用的漏洞。我解释了这些漏洞的来源以及它们如何利用系统。之后，我们将讨论开发人员如何缓解这些攻击媒介，以保护他们的 web 应用程序以及敏感和隐私信息。

![](img/fa970cb04d8ecd63ca9c5e86174a1f7c.png)

31 年前的 1989 年，一家美国软件公司 PKWARE Inc .使用了第一个 Zip 文件。在那之后，苹果和微软这两大巨头在各自的操作系统中很快支持了 Zip 格式。从那以后，这种文件格式在编程社区内外获得了极大的流行。直到今天，在官僚或家庭环境中，人们使用 Zip 文件通过电子邮件发送多个文件。

但是什么是真正的 Zip 文件呢？

**Zip 文件是归档文件**。归档文件最初用于存储元数据和串联文件。因此，如果你以前有 7 本 pdf 格式的哈利波特，你想把它们存储在你的系统中，你可以把它们放在一个目录中，这样就没问题了。但是你们中的极客会压缩这个目录以占据更少的空间。后来实现了附加功能。如今，档案有 5 种类型:

*   **只归档**格式的串连文件。
*   **仅压缩**格式仅压缩文件。
*   **多功能**格式可以存储元数据，串接，压缩，加密，创建错误检测和恢复信息，将存档打包成自解压和自扩展的文件。
*   **软件包**格式用于创建可能是自安装文件的软件包。
*   **磁盘映像**格式用于创建海量存储卷的磁盘映像。

最流行的存档扩展名是:zip、rar、7z 和 tar。

一些开发人员在他们的 web 应用程序中使用 Zip 文件格式，以允许用户在系统上上传他们的文件。让我们看看为什么这可能是一个非常糟糕的主意。

![](img/b4d38aa7f6203b3b8d24c792b5ccafcf.png)

**拉链滑动漏洞**

让我们来看看这段服务器端代码:

这段代码提取归档文件中的所有文件，并将它们写入目标目录。我没看到任何危险信号，对吧？

再仔细看看上面的内容。在这个归档中压缩的文件可以有非常传统的名字，比如`goodboy.sh`。但是，有时候它们会有很怪异的名字，想到`../../../badboy.sh` *。*上面的代码获取文件名`e.getName()`，并将其连接到目标目录或`destinationDir`。假设目标目录是`/var/www/vulnerable-website/userfiles/`。上面的代码将在`/var`中写入`badboy.sh`，从而导致目录遍历。如果该文件已经存在，它将覆盖它。想想如果恶意文件名是`../../../../../../../bin/passwd`会怎么样。服务器将覆盖系统上的用户及其密码。`badboy.sh`还可能包含产生反向外壳的代码，这将允许攻击者连接并危害整个系统。

归档创建工具通常不允许用户添加具有这种名称的文件，尽管 zip 规范允许这样做。然而，使用正确的工具，很容易用这些路径创建文件。

为了保护服务器并避免这种任意文件上传的发生，开发人员必须在将 zip 内容写入系统之前验证它们的名称。下面是一个例子。

换句话说，我们告诉服务器将文件名和目录路径连接起来，结果存储在`canonicalDestinationFile`变量中。如果这个变量不是以允许的目录`canonicalDestinationDirPath`开始，用户试图绕过并在其他地方存储一些文件。用一个例外来阻止他。

![](img/a66fc5a2a02ffaf06cd7f919f24e4296.png)

**Zip 符号链接漏洞利用**

在我们深入第二个漏洞之前，让我们先来谈谈符号链接。

简单地说，符号链接是其他文件的快捷方式。对于系统中的任何文件，您都可以轻松地创建一个链接。

```
ln -s /home/simon/bills.txt myfinances/bills-linked.txt
```

上面的命令将把`bills-linked.txt`链接到`bills.txt`。该链接将是一个与其来源相似的文件，但存储在另一个目录中。在任一文件中发生的任何修改都将反映在另一个文件中。

有两种类型符号链接:硬链接和软链接。软符号链接的工作方式类似于快捷方式。当您打开一个文件夹的软链接时，您将被重定向到存储文件的文件夹。然而，硬链接使文件或文件夹看起来好像实际存在于符号链接的位置，而您的应用程序不会知道得更好。这使得硬符号链接在大多数情况下更加有用。

符号链接可以用于各种事情，包括将任何文件夹与 Dropbox、Google Drive 和 OneDrive 等程序同步。它们还可用于利用易受攻击的系统。

我们可以利用从符号链接创建的以下 zip 文件来攻击易受攻击的系统:

```
ln -s /etc/passwd link
zip --symlinks evil.zip link
```

这将创建一个指向`/etc/passwd`命名链接的链接，并将该链接压缩到一个档案中。当这个档案上传到服务器时，服务器将导出指向服务器中的`/etc/passwd`的链接。如果我们能以任何方式显示这个解压缩文件的内容，我们就能看到`/etc/passwd`的内容。

但是为什么我们在上传之前要压缩链接呢？不能直接把链接上传到服务器吗？小心，你将上传你自己的`/etc/passwd`到服务器。

针对此漏洞的基本对策是在创建文件之前检查该文件是否已经存在。一些 linux 系统也有针对这种攻击的内置计数器。一种是针对错误程序的“安全网”,这些程序会不安全地创建临时文件。当在目录上设置粘滞位时(如在/etc 中)，如果进程拥有符号链接，或者符号链接和目录拥有相同的所有者(通常是/etc 的根)，Linux 将只允许进程跟随符号链接。这样，即使攻击者安装了符号链接，受害者进程也无法跟踪它，并且会收到一个错误。这将可能的特权提升攻击转变为对特定进程的更良性的拒绝服务。

服务器上的大量漏洞都涉及某种恶意文件上传。Zip 文件只是一长串文件的开始。[在这篇文章](/using-word-documents-or-docx-files-to-gain-unauthorised-access-to-server-private-resources-2477b3eafb7b)中，我向你解释如何’。docx 文件也可用于权限提升和任意代码执行。对这些攻击最有效的对策是了解它们是如何发生的，并对用户的任何输入(尤其是文件)实施额外的验证步骤。