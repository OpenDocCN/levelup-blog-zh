<html>
<head>
<title>How I Locked the Whole Company out of an Amazon S3 Bucket</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我是如何把整个公司锁在亚马逊S3桶外的</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-i-locked-the-whole-company-out-of-an-amazon-s3-bucket-1781de51e4be?source=collection_archive---------10-----------------------#2021-06-01">https://levelup.gitconnected.com/how-i-locked-the-whole-company-out-of-an-amazon-s3-bucket-1781de51e4be?source=collection_archive---------10-----------------------#2021-06-01</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><h2 id="bfe9" class="ip iq ir bd b dl is it iu iv iw ix dk iy translated" aria-label="kicker paragraph">我学到了什么</h2><div class=""/><div class=""><h2 id="ef29" class="pw-subtitle-paragraph jx ja ir bd b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dk translated">要避免的S3政策反模式；以及如何打开一个S3桶</h2></div><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj kp"><img src="../Images/a80576034c37740db3c542299b03c8ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gvbO7FSV79UD2qZDGX4Jpw.jpeg"/></div></div><figcaption class="lb lc gk gi gj ld le bd b be z dk translated">美国国家航空航天局、欧空局和STScI拍摄的船底座星云</figcaption></figure><p id="95f8" class="pw-post-body-paragraph lf lg ir lh b li lj kb lk ll lm ke ln lo lp lq lr ls lt lu lv lw lx ly lz ma ik bi translated">最近，我为我的一个客户做了一个安全策略的回顾。在这个过程中，我设法不小心把自己和公司里的每个人都锁在了一个S3桶外面。这不是一个普通的桶，不，这是一个装有所有客户媒体文件的桶。想象一下，你不得不要求你所有的客户重新上传他们所有的照片、视频等…</p></div><div class="ab cl mb mc hv md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ik il im in io"><h1 id="5f41" class="mi mj ir bd mk ml mm mn mo mp mq mr ms kg mt kh mu kj mv kk mw km mx kn my mz bi translated">要避免的反模式S3政策</h1><p id="7c90" class="pw-post-body-paragraph lf lg ir lh b li na kb lk ll nb ke ln lo nc lq lr ls nd lu lv lw ne ly lz ma ik bi translated">当我将下面的策略附加到S3桶时，让我们看看我做错了什么。</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="nf ng l"/></div><figcaption class="lb lc gk gi gj ld le bd b be z dk translated">将使存储桶完全锁定的反模式S3策略声明。</figcaption></figure><p id="54f1" class="pw-post-body-paragraph lf lg ir lh b li lj kb lk ll lm ke ln lo lp lq lr ls lt lu lv lw lx ly lz ma ik bi translated">将上述策略附加到S3时段会将所有人锁定在该时段之外。在我们进入细节之前，让我先告诉你两件重要的事情:</p><ul class=""><li id="6346" class="nh ni ir lh b li lj ll lm lo nj ls nk lw nl ma nm nn no np bi translated">如果有可能的话，尝试一个<a class="ae nq" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notprincipal.html" rel="noopener ugc nofollow" target="_blank">无效<em class="nr">无效、</em> </a> <em class="nr"> </em>无效。如果你决定使用，它很可能会在你最意想不到的时候回来咬你！</li><li id="bd54" class="nh ni ir lh b li ns ll nt lo nu ls nv lw nw ma nm nn no np bi translated">有一种方法可以修复它。这实际上很容易，但是你需要根访问键。在文章的最后，我展示了需要做些什么来修复锁定的bucket。</li></ul><p id="8c61" class="pw-post-body-paragraph lf lg ir lh b li lj kb lk ll lm ke ln lo lp lq lr ls lt lu lv lw lx ly lz ma ik bi translated">现在让我们仔细看看上面的S3政策，以及为什么它是有问题的。</p><h1 id="1be3" class="mi mj ir bd mk ml nx mn mo mp ny mr ms kg nz kh mu kj oa kk mw km ob kn my mz bi translated">非主体反模式</h1><p id="36ec" class="pw-post-body-paragraph lf lg ir lh b li na kb lk ll nb ke ln lo nc lq lr ls nd lu lv lw ne ly lz ma ik bi translated">简而言之，示例策略旨在阻止任何人对数据(对象)的访问，但除了拥有角色<code class="fe oc od oe of b">ROLE_NAME</code>的用户或服务之外，桶本身也是如此。不幸的是，我们的示例策略没有正确地指定这个意图，即使假设角色也不会授予用户访问权限。</p><p id="0789" class="pw-post-body-paragraph lf lg ir lh b li lj kb lk ll lm ke ln lo lp lq lr ls lt lu lv lw lx ly lz ma ik bi translated">乍一看，如果您试图用IAM用户访问bucket，在他们承担了角色之后，访问将被授予。不会的。该操作(无论是什么)将被拒绝。即使用户具有<em class="nr"> Admin </em>访问权限或具有<em class="nr"> S3FullAccess </em>的策略，他们也会被拒绝。</p><p id="b749" class="pw-post-body-paragraph lf lg ir lh b li lj kb lk ll lm ke ln lo lp lq lr ls lt lu lv lw lx ly lz ma ik bi translated">问题在于“颠倒的逻辑”，即双重否定方法，在这种情况下最终总是正确的。对于IAM角色，<em class="nr"> NotPrincipal </em>被证明是有问题的，因为当角色由用户或服务承担时，角色的主体ARN值会略有变化。特别是，AWS安全令牌服务(STS)将会话ID附加到角色ARN中。查看以下两个命令的输出:</p><pre class="kq kr ks kt gu og of oh oi aw oj bi"><span id="372b" class="ok mj ir of b gz ol om l on oo">$ aws sts get-caller-identity<br/>{<br/>  "UserId": "UNIQUE_ROLE_ID:SESSIONID"<br/> <strong class="of jb"> </strong>"Arn"<strong class="of jb">:</strong> "arn:aws:sts::111111111111:assumed-role/<strong class="of jb">ROLE_NAME/SESSID</strong>"<br/>}</span><span id="9642" class="ok mj ir of b gz op om l on oo">$ aws iam get-role --role-name ROLE_NAME<br/>{<br/>  "RoleName": "ROLE_NAME",<br/>  "RoleId": "UNIQUE_ROLE_ID",<br/>  "Arn": "arn:aws:iam::111111111111:role/<strong class="of jb">ROLE_NAME</strong>",<br/>  "AssumeRolePolicyDocument": {...}<br/>}</span></pre><p id="20f3" class="pw-post-body-paragraph lf lg ir lh b li lj kb lk ll lm ke ln lo lp lq lr ls lt lu lv lw lx ly lz ma ik bi translated">我们可以看到，角色的ARN不同于IAM调用者(用户或服务)向存储桶发出请求的ARN。角色ARN是IAM角色本身的标识符，假定角色ARN是日志中标识角色会话的标识符。人们可能想在<em class="nr"> NotPrincipal中使用通配符。</em>然而，这是不允许的，而且理由很充分。</p><p id="4623" class="pw-post-body-paragraph lf lg ir lh b li lj kb lk ll lm ke ln lo lp lq lr ls lt lu lv lw lx ly lz ma ik bi translated">所以我首先应该做的就是不要使用<em class="nr"> NotPrincipal。</em>相反，我应该使用带有<em class="nr"> aws:userId，</em>的<em class="nr">条件</em>，如下面的代码片段所示。</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="nf ng l"/></div><figcaption class="lb lc gk gi gj ld le bd b be z dk translated">最佳实践S3策略使用aws:userId而不是NotPrincipal。</figcaption></figure><p id="a848" class="pw-post-body-paragraph lf lg ir lh b li lj kb lk ll lm ke ln lo lp lq lr ls lt lu lv lw lx ly lz ma ik bi translated">需要注意的是，在我们的条件中，我们没有使用角色的ARN，而是使用其唯一的<em class="nr">角色Id </em>来指定期望的角色<em class="nr">。</em>为了检索<em class="nr">角色Id </em>，我们可以运行<code class="fe oc od oe of b">$ aws iam get-role --role-name ROLE_NAME</code>。人们可以很容易地识别角色的惟一ID，因为在AWS中，所有角色的惟一ID都带有前缀<code class="fe oc od oe of b">AROA</code>。眼尖的读者也会注意到，我们必须在角色的唯一ID后面加上<code class="fe oc od oe of b">:*</code>。原因是STS还会将一个会话ID附加到角色的ID上，如上面的示例输出所示。</p></div><div class="ab cl mb mc hv md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ik il im in io"><h1 id="b044" class="mi mj ir bd mk ml mm mn mo mp mq mr ms kg mt kh mu kj mv kk mw km mx kn my mz bi translated">怎么修</h1><p id="7ab7" class="pw-post-body-paragraph lf lg ir lh b li na kb lk ll nb ke ln lo nc lq lr ls nd lu lv lw ne ly lz ma ik bi translated">虽然在上述策略下，不允许任何用户或服务对bucket或其对象执行任何操作，但是有一个例外。是的，它是根帐户，总是被允许查看和删除S3安全策略。</p><blockquote class="oq"><p id="758e" class="or os ir bd ot ou ov ow ox oy oz ma dk translated">解锁不可访问桶的唯一可靠方法是实际删除有问题的S3安全策略。为此，只需运行以下命令:</p></blockquote><pre class="pa pb pc pd pe og of oh oi aw oj bi"><span id="dce9" class="ok mj ir of b gz ol om l on oo">$ aws s3api delete-bucket-policy --bucket BUCKET --profile ROOT</span></pre><p id="eedb" class="pw-post-body-paragraph lf lg ir lh b li lj kb lk ll lm ke ln lo lp lq lr ls lt lu lv lw lx ly lz ma ik bi translated">如果通过环境变量管理凭证，可以省略<code class="fe oc od oe of b">--profile</code>参数。要将凭证添加到env，可以运行:</p><pre class="kq kr ks kt gu og of oh oi aw oj bi"><span id="847b" class="ok mj ir of b gz ol om l on oo">$ export AWS_DEFAULT_REGION= us-east-1 <br/>$ export AWS_ACCESS_KEY_ID=ROOT_KEY_ID<br/>$ export AWS_SECRET_ACCESS_KEY=ROOT_SECRET_KEY</span></pre></div><div class="ab cl mb mc hv md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ik il im in io"><h1 id="6540" class="mi mj ir bd mk ml mm mn mo mp mq mr ms kg mt kh mu kj mv kk mw km mx kn my mz bi translated">结束语</h1><p id="f1fe" class="pw-post-body-paragraph lf lg ir lh b li na kb lk ll nb ke ln lo nc lq lr ls nd lu lv lw ne ly lz ma ik bi translated">在本文中，我们研究了用于编写S3安全策略的反模式以及它可能导致的问题。我们还了解了如何修复这些问题，前提是用户有权访问root帐户凭据。然而，我们首先应该明确避免撰写糟糕的S3政策。以下是撰写S3保单时的一些(非常概括和简洁的)最佳实践:</p><ul class=""><li id="18ae" class="nh ni ir lh b li lj ll lm lo nj ls nk lw nl ma nm nn no np bi translated">在<em class="nr">动作</em>和<em class="nr">原则</em>中，尽量避免使用“*”或“s3:*”等通用通配符，不要用<em class="nr">条件</em>缩小语句的范围a。</li><li id="a564" class="nh ni ir lh b li ns ll nt lo nu ls nv lw nw ma nm nn no np bi translated">尽量避免<em class="nr"> NotPrincipal。</em>几乎总是可以用一个<em class="nr">条件</em>和aws:u <em class="nr"> serId </em>或<em class="nr"> aws:PrincipalArn </em>来替换。</li><li id="1c0e" class="nh ni ir lh b li ns ll nt lo nu ls nv lw nw ma nm nn no np bi translated">尝试使用IAM访问分析器。它远非完美，但在某些情况下非常有用。尤其是当一个人必须处理许多策略和资源时。</li></ul></div></div>    
</body>
</html>