<html>
<head>
<title>How-to: debug and trace problems in AWS CodeBuild</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何:调试和跟踪AWS代码构建中的问题</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-debug-trace-problems-aws-codebuild-ad73c8e62bb8?source=collection_archive---------4-----------------------#2021-03-01">https://levelup.gitconnected.com/how-to-debug-trace-problems-aws-codebuild-ad73c8e62bb8?source=collection_archive---------4-----------------------#2021-03-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ec25" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">让故障诊断代码构建更容易的指南！</h2></div><p id="dfd4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">由DPG媒体的AWS云解决方案架构师Gert Leenders为您带来</em></p><p id="0560" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">遵循DPG媒体的“除非AWS”策略，将我们的构建转移到AWS CodeBuild和AWS CodePipeline只是时间问题。将我们的遗留管道迁移到AWS CodeBuild被证明是一项非常简单的工作。出于这个原因，开发团队很快采用了CodeBuild。</strong></p><p id="3198" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，总的来说，有一个关于代码构建的抱怨:解决<code class="fe lc ld le lf b">buildspec.yml</code>中的问题很困难，主要是因为无法访问远程会话。</p><p id="30ba" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">直到去年7月，AWS <a class="ae lg" href="https://aws.amazon.com/about-aws/whats-new/2020/07/aws-codebuild-now-supports-accessing-build-environments-with-aws-session-manager/" rel="noopener ugc nofollow" target="_blank">宣布AWS CodeBuild </a>的AWS会话管理器访问。这很奇怪，但似乎这个令人敬畏的功能的发布没有引起人们的注意！？也许那是因为新闻稿似乎错过了正确的语义？如果你没有使用正确的词语，这绝对是一个很难找到的帖子——即使对谷歌来说也是如此。祈祷这篇文章能带来更多的关注:-)</p><p id="67c7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过启用远程访问，AWS会话管理器最终为AWS代码构建带来了调试功能。除了会话管理器访问，新的CodeBuild命令<code class="fe lc ld le lf b">codebuild-breakpoint</code>是这个新特性的关键。额外的调试功能使代码构建的故障排除变得不那么麻烦。它还结束了本地构建会成功，但远程代码构建会失败的噩梦——将您置于一个乏味的试错是唯一出路的境地。</p><h1 id="7653" class="lh li iq bd lj lk ll lm ln lo lp lq lr jw ls jx lt jz lu ka lv kc lw kd lx ly bi translated">实践中的AWS代码构建</h1><ol class=""><li id="3442" class="lz ma iq kh b ki mb kl mc ko md ks me kw mf la mg mh mi mj bi translated">将使用AWS会话管理器的权限添加到AWS代码版本:</li></ol><pre class="mk ml mm mn gt mo lf mp mq aw mr bi"><span id="ab2b" class="ms li iq lf b gy mt mu l mv mw">CodeBuildServiceRole:<br/>  Type: AWS::IAM::Role<br/>  Properties:<br/>    AssumeRolePolicyDocument:<br/>      Statement:<br/>        - Effect: Allow<br/>          Principal:<br/>            Service:<br/>              - codebuild.amazonaws.com<br/>          Action:<br/>            - sts:AssumeRole<br/>    Path: /<br/>    Policies:<br/>      - PolicyName: log-access<br/>        PolicyDocument:<br/>          Statement:<br/>            - Effect: Allow<br/>              Action:<br/>                - logs:CreateLogStream<br/>                - logs:PutLogEvents<br/>                - logs:CreateLogGroup<br/>              Resource:<br/>                - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/*<br/>      - PolicyName: ssm-access<br/>        PolicyDocument:<br/>          Statement:<br/>            - Effect: Allow<br/>              Action:<br/>                - ssmmessages:CreateControlChannel<br/>                - ssmmessages:CreateDataChannel<br/>                - ssmmessages:OpenControlChannel<br/>                - ssmmessages:OpenDataChannel<br/>              Resource: "*"<br/>            - Effect: Allow<br/>              Action:<br/>                - s3:GetEncryptionConfiguration<br/>                - s3:PutObject<br/>              Resource:<br/>                - arn:aws:s3:::your-log-bucket-name<br/>                - arn:aws:s3:::your-log-bucket-name/*      ...</span></pre><p id="6d65" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">备注:如果使用亚马逊S3存储您的日志，上面提到的代码构建策略只需要S3权限。万一它丢失了，你会得到一个SSM会话，提示被卡住，没有任何进一步的反馈。因此，如果使用S3存储您的日志，一定要有正确的策略。</em></p><p id="3379" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">2.给你的<code class="fe lc ld le lf b">buildspec.yml</code>添加一个断点</p><figure class="mk ml mm mn gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi mx"><img src="../Images/6a5b2b438f93c6cd69432f5eaf89d0cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b7Qqoomg5JkGf5y4"/></div></div></figure><p id="f1eb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">3.为调试启动生成</p><ul class=""><li id="c21c" class="lz ma iq kh b ki kj kl km ko nf ks ng kw nh la ni mh mi mj bi translated">使用“高级生成覆盖”开始生成</li></ul><figure class="mk ml mm mn gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nj"><img src="../Images/19ee25db2c8ade8cdea48162cc092a79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E7_O0slD5zyI6KFS"/></div></div></figure><ul class=""><li id="cc88" class="lz ma iq kh b ki kj kl km ko nf ks ng kw nh la ni mh mi mj bi translated">在“高级设置”下选择“启用会话连接”</li></ul><figure class="mk ml mm mn gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nk"><img src="../Images/a7acd2752fcc7cb228cece281868a0ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZCJ9xayW11JMyUEn"/></div></div></figure><h1 id="d370" class="lh li iq bd lj lk ll lm ln lo lp lq lr jw ls jx lt jz lu ka lv kc lw kd lx ly bi translated">使用Web控制台启动远程会话</h1><figure class="mk ml mm mn gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nl"><img src="../Images/616f31d7a4e9ef8e703d13c5566cd838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j72T2znT_d1waSbt"/></div></div></figure><h1 id="8b15" class="lh li iq bd lj lk ll lm ln lo lp lq lr jw ls jx lt jz lu ka lv kc lw kd lx ly bi translated">使用CLI启动远程会话</h1><ol class=""><li id="ece0" class="lz ma iq kh b ki mb kl mc ko md ks me kw mf la mg mh mi mj bi translated">获取构建ID(也称为构建运行)</li></ol><figure class="mk ml mm mn gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nl"><img src="../Images/dff935c10d2b996fced07f2e65d1ef79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nfI9J-XPL3ahxGsK"/></div></div></figure><p id="a8cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">2.使用生成Id获取sessionTarget</p><figure class="mk ml mm mn gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nm"><img src="../Images/7b56fc6a8dcbb05821c41501d034ea07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LFMRiG9Syqliy06k"/></div></div></figure><p id="2305" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">依我看，目前<code class="fe lc ld le lf b">batch-get-builds</code>的文档还不够。如果您没有使用正确的设置或者如果您没有使用CLI的最新版本，使用CLI获取<code class="fe lc ld le lf b">sessionTarget</code>可能会很棘手。因此，我请求将文档更改为:</p><blockquote class="nn no np"><p id="1e8e" class="kf kg lb kh b ki kj jr kk kl km ju kn nq kp kq kr nr kt ku kv ns kx ky kz la ij bi translated">复制<code class="fe lc ld le lf b">sessionTarget</code>属性值。注:<code class="fe lc ld le lf b">sessionTarget</code>仅在输出为<code class="fe lc ld le lf b">json</code>或<code class="fe lc ld le lf b">table</code>时可用。如果输出设置为<code class="fe lc ld le lf b">text</code>，则寻找<code class="fe lc ld le lf b">DEBUGSESSION</code>。如果输出中缺少该属性，请将您的CLI更新到较新的版本。</p></blockquote><p id="5d24" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">3.复制完<code class="fe lc ld le lf b">sessionTarget</code>值后，您可以使用以下命令开始新的远程会话:</p><figure class="mk ml mm mn gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nm"><img src="../Images/421bc34fc05710ad067c148c9a0ae4b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6J2bWbhTdxdjpy1c"/></div></div></figure><p id="6337" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">4.调试您的构建:-)</p><p id="74b6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你都准备好了。要停止调试会话，只需执行<code class="fe lc ld le lf b">$ codebuild-resume</code>。</p><p id="f84e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下次见！</p><p id="548d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">更多信息？另请查看此链接:<a class="ae lg" href="https://docs.aws.amazon.com/codebuild/latest/userguide/session-manager.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/code build/latest/user guide/session-manager . html</a></p></div></div>    
</body>
</html>