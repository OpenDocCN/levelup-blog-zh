<html>
<head>
<title>Automate Cross Account CloudFormation Deployment using AWS CodePipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS CodePipeline自动化跨客户云信息部署</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/automate-cross-account-cloudformation-deployment-using-aws-codepipeline-c71d81b45722?source=collection_archive---------1-----------------------#2022-06-08">https://levelup.gitconnected.com/automate-cross-account-cloudformation-deployment-using-aws-codepipeline-c71d81b45722?source=collection_archive---------1-----------------------#2022-06-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/87ce50f647f4df16478e1178f1e1ef96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZJapYpJ_f1PpnbNIK5Im4Q.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/</a></figcaption></figure><p id="ba72" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi le translated"><span class="l lf lg lh bm li lj lk ll lm di">在</span>大多数大型企业应用程序中，使用多个AWS帐户比在每个环境中使用一个AWS帐户更好。至少，您应该有一个不同的AWS帐户用于生产环境，另一个帐户用于处理其他环境。在今天的文章中，我将展示当我们涉及多个客户时，如何在这些环境之间自动创建AWS基础设施。</p><figure class="lo lp lq lr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ln"><img src="../Images/627ef03a899c84d47192321d4cbb8183.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WrJawbj4H_u2lGVwwVeP_g.png"/></div></div></figure><p id="a9d1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们的应用程序中，假设我们有三个AWS帐户</p><ul class=""><li id="08d4" class="ls lt it ki b kj kk kn ko kr lu kv lv kz lw ld lx ly lz ma bi translated">基础设施客户——负责使用管道创建自动化，维护日志文件等..(跨所有其他环境的共享应用程序)</li><li id="05d3" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated">开发客户——负责开发环境的所有AWS基础设施</li><li id="5dda" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated">生产客户—负责生产环境的所有AWS基础架构</li></ul><p id="0ab9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我将展示如何为Dev帐户进行跨帐户部署。对于生产环境也可以这样做。</p><p id="f38a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了实现这一目标，我们需要执行以下步骤。</p><ul class=""><li id="db4c" class="ls lt it ki b kj kk kn ko kr lu kv lv kz lw ld lx ly lz ma bi translated">在我们的<strong class="ki iu">开发账户</strong>中创建一个<strong class="ki iu">交叉账户-iam-角色</strong>。这个IAM角色应该拥有cloudformation所需的所有权限，以便创建/更新适当的基础设施。这个想法是，当codepipeline运行时，它将承担这个角色。</li><li id="54f4" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated">在基础设施帐户中创建代码构建角色。</li><li id="8291" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated">在<strong class="ki iu">基础设施账户</strong>中创建一个新的<strong class="ki iu"> KMS客户管理密钥</strong>。我们还需要为Dev帐户提供使用该密钥的权限。</li><li id="c55a" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated">在<strong class="ki iu">基础设施帐户</strong>中创建一个<strong class="ki iu">部署工件S3存储桶</strong>，并使用我们创建的KMS密钥对项目进行加密。</li><li id="1600" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated">授予工件存储桶为Dev帐户用户列出和获取项目的权限。</li><li id="fec8" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated">在<strong class="ki iu">基础设施帐户</strong>中创建一个<strong class="ki iu">代码构建角色</strong>，并添加一个信任关系策略来承担我们之前创建的<strong class="ki iu">跨帐户角色</strong>。</li><li id="5045" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated">运行代码管道时，假设跨帐户角色并运行cloudformation堆栈。</li></ul><p id="dd75" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">唷，那似乎很多。但不用担心，我会经历每一步。现在，既然我们知道要做什么，就让我们开始实现吧。</p><h2 id="ffb1" class="mg mh it bd mi mj mk dn ml mm mn dp mo kr mp mq mr kv ms mt mu kz mv mw mx my bi translated">创建跨帐户IAM角色</h2><p id="8bf7" class="pw-post-body-paragraph kg kh it ki b kj mz kl km kn na kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">下面是用于创建跨帐户IAM角色的cloudformation模板。确保在创建实际基础架构的开发或生产帐户上运行此操作。根据您的要求，您可以添加或删除权限。</p><p id="d56e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个模板有两个输入参数</p><ul class=""><li id="a06c" class="ls lt it ki b kj kk kn ko kr lu kv lv kz lw ld lx ly lz ma bi translated">基础设施帐户id</li><li id="8cdf" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated">环境前缀</li></ul><figure class="lo lp lq lr gt ju"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="9437" class="mg mh it bd mi mj mk dn ml mm mn dp mo kr mp mq mr kv ms mt mu kz mv mw mx my bi translated">为代码生成创建IAM角色并添加信任关系策略</h2><p id="3f7d" class="pw-post-body-paragraph kg kh it ki b kj mz kl km kn na kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">切换到基础架构帐户，然后转到IAM和角色。创建一个新角色，其中服务是CodeBuild，并添加CloudFormation完全访问权限。</p><figure class="lo lp lq lr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ng"><img src="../Images/a4ae56109d454d8a8a705d28d711994a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xyU0KNcqesLmraBSA-Ksmg.png"/></div></div></figure><p id="0ed0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，用下面的内联JSON创建一个新的定制策略。对于arn，我们需要提供我们在Dev帐户中创建的角色的arn。</p><figure class="lo lp lq lr gt ju"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="3fe6" class="mg mh it bd mi mj mk dn ml mm mn dp mo kr mp mq mr kv ms mt mu kz mv mw mx my bi translated">创建KMS客户管理密钥</h2><p id="6810" class="pw-post-body-paragraph kg kh it ki b kj mz kl km kn na kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">切换到基础结构帐户，然后转到密钥管理服务并创建一个密钥。</p><figure class="lo lp lq lr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nh"><img src="../Images/e281fb91e10d1c6312ad08507ceb4c66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l5Hg5vFlkcMoHMeN_5V2aQ.png"/></div></div></figure><p id="93fd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建用于加密和解密的对称密钥</p><figure class="lo lp lq lr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ni"><img src="../Images/0a87a2d437f9bd4ac1c7a6626bd6b6d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z-6KS4YL9tik6D72XD1LWA.png"/></div></div></figure><p id="a7b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">提供密钥名称、描述和标签。然后提供您可以管理密钥的角色/用户以及谁可以使用密钥。<strong class="ki iu">确保添加我们之前创建的codebuild IAM角色，以添加可以使用此键</strong>的角色。</p><h2 id="13a8" class="mg mh it bd mi mj mk dn ml mm mn dp mo kr mp mq mr kv ms mt mu kz mv mw mx my bi translated">创建部署工件S3存储桶</h2><p id="fff1" class="pw-post-body-paragraph kg kh it ki b kj mz kl km kn na kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">在基础设施客户中，转到S3并创建一个新的存储桶。给一个有意义的名字，比如<strong class="ki iu">跨账户-工件-开发</strong></p><p id="eeae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建对象所有权，启用ACL。</p><figure class="lo lp lq lr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nj"><img src="../Images/20fd6c57ba8380d682c56aa220d42abb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LwcBUS4z3xGMpOpi376p7A.png"/></div></div></figure><p id="3328" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">删除阻止公共访问设置上的前两个勾号</p><figure class="lo lp lq lr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/4b11f0e5416f0573f7edc95a17b23606.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TZ5vgGQSw-E3MpnLSR_Org.png"/></div></div></figure><p id="7464" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">启用桶加密，并提供我们之前创建的KMS密钥。</p><figure class="lo lp lq lr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/9b65e495976128c186776e1639a53be4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-ptU-MDs5T7OSwOqWcmnIg.png"/></div></div></figure><h2 id="79d4" class="mg mh it bd mi mj mk dn ml mm mn dp mo kr mp mq mr kv ms mt mu kz mv mw mx my bi translated">授予其他帐户对工件存储桶的权限</h2><p id="880c" class="pw-post-body-paragraph kg kh it ki b kj mz kl km kn na kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">现在，我们需要为Dev帐户提供访问这个S3存储桶的权限。为此，添加以下存储桶策略。确保更换了<strong class="ki iu">账号_ID </strong></p><figure class="lo lp lq lr gt ju"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="a58f" class="mg mh it bd mi mj mk dn ml mm mn dp mo kr mp mq mr kv ms mt mu kz mv mw mx my bi translated">Cerate代码管道和代码构建项目</h2><p id="4b23" class="pw-post-body-paragraph kg kh it ki b kj mz kl km kn na kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">现在，我们已经创建了跨客户部署所需的所有角色和基础架构。为了实现自动化，我们现在可以开始创建代码管道，一旦我们将它提交/合并到我们的存储库代码，它就会触发。</p><p id="6e7f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">转到CodePipeline并创建一个新管道。提供一个名称并转到advanced下，确保更改工件存储和加密密钥。</p><figure class="lo lp lq lr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nl"><img src="../Images/ce148da856508c8dffe2512a28301767.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LL5Q5bCvibIk18jQNZF2Zg.png"/></div></div></figure><p id="8163" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">提供源代码(code commit/GitHub)并创建codebuild项目。这里我们需要一些如下的配置。</p><p id="fc61" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">提供一个合适的名称，并选择您需要的环境映像。之后，确保作为服务角色，您通过选择现有的服务角色来提供我们之前创建的codebuild IAM角色。</p><figure class="lo lp lq lr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nm"><img src="../Images/5460e49099be999c0538fa3e3daef60f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JphHvJgKVw33hAJ5sXEcEg.png"/></div></div></figure><p id="051b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后转到附加配置并设置以下环境变量。这些变量将用于我们的buildspec.yml文件(我们接下来将创建它)</p><ul class=""><li id="25c8" class="ls lt it ki b kj kk kn ko kr lu kv lv kz lw ld lx ly lz ma bi translated"><strong class="ki iu">交叉账户角色</strong> —我们创建的交叉账户角色的arn</li><li id="6820" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated"><strong class="ki iu"> TARGET_ACCOUNT_ID </strong> —开发或生产帐户的帐户ID。</li></ul><p id="30a8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们可以创建codebuild项目和codepipline了。</p><p id="74f3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一步是在我们的存储库中创建一个<strong class="ki iu"> buildspec.yml </strong>文件。在此之前，在codebuild项目中，codebuild角色需要承担跨帐户角色。这可以使用下面的脚本来完成。</p><figure class="lo lp lq lr gt ju"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="a35b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请确保将该脚本文件添加到您的存储库的根目录。然后我们可以在buildspec.yml文件中使用这个脚本文件，如下所示。</p><figure class="lo lp lq lr gt ju"><div class="bz fp l di"><div class="ne nf l"/></div></figure><ul class=""><li id="c08d" class="ls lt it ki b kj kk kn ko kr lu kv lv kz lw ld lx ly lz ma bi translated"><strong class="ki iu"> cross-account-setup.sh </strong>是我们上面创建的脚本文件</li><li id="cef1" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated"><strong class="ki iu">—template-file src/AWS/cloudformation-stack . yml</strong>就是我们要部署的cloud formation模板。如果模板可用，您也可以提供S3 URL。</li><li id="1020" class="ls lt it ki b kj mb kn mc kr md kv me kz mf ld lx ly lz ma bi translated"><strong class="ki iu"> STACK_NAME </strong> —更改一个名称，您可以在其中命名云编队部署。</li></ul><p id="70a3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">是的，现在您可以触发部署并查看跨帐户部署是如何发生的。对于生产帐户或您想要的任何其他数量的帐户，也可以这样做。</p><p id="da02" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">参考资料:— <a class="ae kf" href="https://www.triumphtech.com/building-a-ci-cd-pipeline-for-cross-account-deployment-of-an-aws-lambda-api-with-the-serverless-framework/" rel="noopener ugc nofollow" target="_blank"> https://www .凯旋科技. com/building-a-ci-CD-pipeline-for-cross-account-deployment-of-an-AWS-lambda-API-with-the-server less-framework/</a></p></div></div>    
</body>
</html>