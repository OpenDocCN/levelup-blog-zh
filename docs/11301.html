<html>
<head>
<title>Mount files into Kubernetes Deployment via ConfigMaps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过配置映射将文件挂载到Kubernetes部署中</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/mount-files-into-your-kubernetes-deployment-via-configmaps-bedfe5350e25?source=collection_archive---------1-----------------------#2022-03-07">https://levelup.gitconnected.com/mount-files-into-your-kubernetes-deployment-via-configmaps-bedfe5350e25?source=collection_archive---------1-----------------------#2022-03-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="7964" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用ConfigMaps将文件装入Kubernetes部署的简短指南。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/c6ac425b8efc897f553825202cc0ec8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LVbXZ5bAq5sMEX0Rrh7NRA.png"/></div></div></figure><h2 id="ef22" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">要求</h2><ul class=""><li id="cdd4" class="lt lu it js b jt lv jx lw kb lx kf ly kj lz kn ma mb mc md bi translated">准备使用Kubernetes设置(例如，<a class="ae me" rel="noopener ugc nofollow" target="_blank" href="/local-kubernetes-development-using-vagrant-and-k3s-547bd5687a7f">本地设置</a>)</li><li id="c3a4" class="lt lu it js b jt mf jx mg kb mh kf mi kj mj kn ma mb mc md bi translated"><a class="ae me" href="https://kubernetes.io/docs/tasks/tools/" rel="noopener ugc nofollow" target="_blank"> kubectl </a>已安装</li></ul><h2 id="b09f" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">你将学到什么</h2><p id="d96d" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb mk kd ke kf ml kh ki kj mm kl km kn im bi translated">在本教程中，您将学习如何将一个简单的NGINX容器部署到Kubernetes，并使用ConfigMap资源将一个HTML页面注入到容器中，该页面将覆盖NGINX提供的默认<code class="fe mn mo mp mq b">index.html</code>。</p><p id="7188" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">像往常一样，我准备了一个<a class="ae me" href="https://github.com/Abszissex/medium-k8s-cf-mount-file" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>供您查看完成的代码库，并遵循本文中描述的步骤。</p><div class="mr ms gp gr mt mu"><a href="https://github.com/Abszissex/medium-k8s-cf-mount-file" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd iu gy z fp mz fr fs na fu fw is bi translated">abszisex/medium-k8s-cf-mount-file</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">github.com</p></div></div><div class="nd l"><div class="ne l nf ng nh nd ni ky mu"/></div></div></a></div><h2 id="9040" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">一般设置</h2><pre class="kp kq kr ks gt nj mq nk nl aw nm bi"><span id="a76d" class="la lb it mq b gy nn no l np nq">/<br/>|- deployment.yaml<br/>|- configmap.yaml</span></pre><p id="476a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个例子的最后，将会有两个YAML文件。定义NGINX部署的<code class="fe mn mo mp mq b">deployment.yaml</code>和定义包含定制HTML页面的配置映射的<code class="fe mn mo mp mq b">configmap.yaml</code>。</p><p id="3021" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是让我们一步一步来。</p><h2 id="0c38" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">NGINX部署</h2><p id="0578" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb mk kd ke kf ml kh ki kj mm kl km kn im bi translated">首先，我们定义NGINX部署，并验证它是否按预期工作。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="a039" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如您所看到的，我们使用了<code class="fe mn mo mp mq b">nginx:1.21.6-alpine</code> Docker图像并暴露了端口80。端口80是NGINX运行的默认端口。</p><p id="a201" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您现在可以使用<code class="fe mn mo mp mq b">kubectl apply -f deployment.yaml</code>将部署应用到Kubernetes集群。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nt"><img src="../Images/8396caed59b75fab57cd5e367ed80910.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DJS7Zfz15EwoV3BLdjAnbw.png"/></div></div></figure><h2 id="3837" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">验证NGINX部署</h2><p id="d0d7" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb mk kd ke kf ml kh ki kj mm kl km kn im bi translated">为了验证部署的创建是否按预期工作，让我们通过<code class="fe mn mo mp mq b">kubectl get all -l name=nginx</code>获取集群上所有正在运行的资源。在下图中，您可以看到NGINX Pod的一个副本是如何启动和就绪的，以及NGINX部署和副本集资源。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nu"><img src="../Images/65819a8d72d0ebb8b7d00115f2f4a24a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WqK1q_JvhkQl-kgGofS_bw.png"/></div></div></figure><p id="6b7e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的<code class="fe mn mo mp mq b">-l name=nginx</code>通过将<code class="fe mn mo mp mq b">name</code>标签定义为<code class="fe mn mo mp mq b">nginx</code>的所有资源来过滤<code class="fe mn mo mp mq b">get all</code>命令的输出。如果您没有在部署YAML文件<code class="fe mn mo mp mq b">nginx</code>中命名所有内容，它可能会打印出不同的输出。</p><p id="a1d1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您不确定时，您总是可以退回到<code class="fe mn mo mp mq b">kubectl get all</code>而不进行标签过滤，并在默认名称空间中获取所有正在运行的Kubernetes资源。</p><h2 id="b349" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">访问NGINX部署</h2><p id="635b" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb mk kd ke kf ml kh ki kj mm kl km kn im bi translated">为了验证Pod是否准备好并工作，我们可以将资源的端口转发到本地机器。您可以在不同的资源上通过<code class="fe mn mo mp mq b">kubectl</code>使用端口转发。因此，您可以直接从Pod转发端口，转发整个部署，或者在服务资源上转发(我们在本例中没有使用)。</p><p id="72d5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于这个展示，我决定在部署级别进行转发。</p><p id="9557" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用命令<code class="fe mn mo mp mq b">kubectl port-forward deployment/nginx 8080:80</code>将把部署的端口<code class="fe mn mo mp mq b">80</code>转发到端口<code class="fe mn mo mp mq b">8080</code>上的本地机器。该命令的一般语法如下:</p><p id="1e3b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mn mo mp mq b">kubectl port-forward RESOURCE_TYPE/RESOURCE_NAME LOCAL_PORT/RESOURCE_PORT</code></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nv"><img src="../Images/ceab3d286b963d6d74ba72ee33f21328.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xQ9t16IxFs_UfscqlWRzoQ.png"/></div></div></figure><p id="9e3b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用<code class="fe mn mo mp mq b">port-forwarding</code>命令，终端被阻塞，如果不停止进程，端口转发将可用。</p><p id="65fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要最终验证NGINX Pod是否按预期工作，请打开浏览器并导航到<code class="fe mn mo mp mq b">localhost:8080</code>。如果一切正常，您应该会在NGINX Docker映像中看到默认的<code class="fe mn mo mp mq b">index.html</code>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nw"><img src="../Images/efd3cc70ae7716409fba9d688f911505.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qZwIjeUwLByZnEtvXgCJbQ.png"/></div></div></figure><h2 id="6cf0" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">创建配置图</h2><p id="308a" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb mk kd ke kf ml kh ki kj mm kl km kn im bi translated">顾名思义，Kubernetes中的ConfigMaps用于以键值方式提供配置，例如，服务的环境变量，并使它们可被部署和其他资源访问。</p><p id="2cf5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是除了引用配置映射并仅提取其值并将其推入环境变量之外，配置映射还可以作为卷挂载。</p><p id="03fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下面的代码片段中，您可以看到我们将使用的ConfigMap定义。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="75bb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<code class="fe mn mo mp mq b">data</code>部分，我们定义了任意键<code class="fe mn mo mp mq b">file-from-cfgmap</code>并为其赋值。该值是通过管道操作符<code class="fe mn mo mp mq b">|</code>指示的多行字符串。该字符串包含我们希望注入到部署中的HTML内容，以覆盖NGINX Docker容器中的默认HTML文件。</p><h2 id="ecbd" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">在部署中装入配置图</h2><p id="1cb7" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb mk kd ke kf ml kh ki kj mm kl km kn im bi translated">既然已经定义了ConfigMap，就需要在部署配置中挂载它。我们将从本文开始扩展部署文件。在下面的代码片段中，我用注释标记了我添加的部分。评论上面的部分和之前一样。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="bc9d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们一步一步来，但让我们从底部的<code class="fe mn mo mp mq b">volumes</code>部分开始。在<code class="fe mn mo mp mq b">volumes</code>部分，我们定义了可能的卷以及我们希望如何命名它们。在这种情况下，我们创建一个名为<code class="fe mn mo mp mq b">mnt</code>的新卷，我们可以在以后使用它来引用这个卷。此外，我们定义卷内容应该基于名为<code class="fe mn mo mp mq b">nginx-cfmap</code>的配置图，指向我们定义的<code class="fe mn mo mp mq b">configmap.yaml</code>的<code class="fe mn mo mp mq b">metadata.name</code>属性。</p><p id="1494" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在定义卷之后，我们可以通过使用<code class="fe mn mo mp mq b">volumeMounts</code>部分将它安装到容器中。我们定义的<code class="fe mn mo mp mq b">volumeMounts</code>条目的<code class="fe mn mo mp mq b">name</code>必须与我们在<code class="fe mn mo mp mq b">volumes</code>部分→ <code class="fe mn mo mp mq b">mnt</code>中描述的名称相同。用<code class="fe mn mo mp mq b">mountPath</code>我们定义Kubernetes应该把我们挂载的内容放在哪里。这种情况下是<code class="fe mn mo mp mq b">/usr/share/nginx/html/index.html</code>。这是默认<code class="fe mn mo mp mq b">index.html</code> NGINX服务的位置。最后但同样重要的是，我们将<code class="fe mn mo mp mq b">subPath</code>定义为<code class="fe mn mo mp mq b">file-from-cfgmap</code>。因为我们正在挂载一个配置映射，所以我们必须在配置映射中指定我们想要获取其值的键的名称。部署中的<code class="fe mn mo mp mq b">volumeMounts.subPath</code>需要等于配置图的<code class="fe mn mo mp mq b">data[subPath]</code>。</p><h2 id="b119" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">把它放在一起</h2><p id="f926" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb mk kd ke kf ml kh ki kj mm kl km kn im bi translated">既然配置图和部署已经定义并准备好使用，如果两个文件都在您的目录中，我们可以通过<code class="fe mn mo mp mq b">kubectl apply -f .</code>应用两个更改/创建，或者使用单独的文件名代替<code class="fe mn mo mp mq b">.</code>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nx"><img src="../Images/26769999242f8534f4319d22953e34ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TvN7f9KOmSTk95hyGDkk-g.png"/></div></div></figure><p id="4e3b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">NGINX容器重启可能需要几秒钟。</p><p id="fb01" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们可以通过<code class="fe mn mo mp mq b">kubectl port-forward deployment/nginx 8080:80</code>再次启动端口转发，并在浏览器中验证结果。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nw"><img src="../Images/9ab689f23ee759cb1ebc593199e19a6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RH_MIKeG4Rhv7kpo_rKIMQ.png"/></div></div></figure><p id="5f30" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">而且成功了！😊</p><p id="ef20" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">边注</strong></p><p id="1647" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请记住，当您更改配置图的内容并将新的配置图应用到您的集群时，它<strong class="js iu">不会</strong>影响您已经运行的NGINX Pods。</p><p id="a8b0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里的原因是，pod一旦启动就装载配置图的内容。之后，对配置图的更改不再影响窗格。</p><p id="c687" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您不希望对您的部署进行更改来触发您的pods重启以获取新的ConfigMap内容，您绝对不应该这样做，您可以通过<code class="fe mn mo mp mq b">kubectl rollout</code>命令轻松地重启容器。</p><p id="62cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，要重新启动本教程中NGINX部署的Pod，您可以使用:</p><pre class="kp kq kr ks gt nj mq nk nl aw nm bi"><span id="f553" class="la lb it mq b gy nn no l np nq">kubectl rollout restart deployment/nginx</span></pre><h1 id="8a7a" class="ny lb it bd lc nz oa ob lf oc od oe li of og oh ll oi oj ok lo ol om on lr oo bi translated">摘要</h1><p id="1cd0" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb mk kd ke kf ml kh ki kj mm kl km kn im bi translated">在这个简短的教程中，您应该已经学会了如何将ConfigMaps中的值作为卷注入到您的部署中，以(重写)您的应用程序所使用的文件。</p><h2 id="4c8d" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">你想联系吗？</h2><p id="6350" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb mk kd ke kf ml kh ki kj mm kl km kn im bi translated">如果你想联系我，请在<a class="ae me" href="https://www.linkedin.com/in/pascal-zwikirsch-3a95a1177/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我。</p><p id="c598" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另外，可以随时查看<a class="ae me" href="https://medium.com/@mr-pascal/my-book-recommendations-4b9f73bf961b" rel="noopener">我的书籍推荐</a>📚。</p></div><div class="ab cl op oq hx or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="im in io ip iq"><div class="kp kq kr ks gt mu"><a href="https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b" rel="noopener follow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd iu gy z fp mz fr fs na fu fw is bi translated">我的书籍推荐</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">在接下来的章节中，你可以找到我对所有日常生活话题的书籍推荐，它们对我帮助很大。</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="nd l"><div class="ow l nf ng nh nd ni ky mu"/></div></div></a></div><div class="mr ms gp gr mt mu"><a href="https://mr-pascal.medium.com/membership" rel="noopener follow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd iu gy z fp mz fr fs na fu fw is bi translated">通过我的推荐链接加入Medium—Pascal Zwikirsch</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="nd l"><div class="ox l nf ng nh nd ni ky mu"/></div></div></a></div></div></div>    
</body>
</html>