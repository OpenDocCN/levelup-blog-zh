<html>
<head>
<title>Providing Developer Access to your Cloud Run Service on GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让开发者访问你在GCP上的云运行服务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/providing-developer-access-to-hosted-cloud-run-service-on-gcp-61f1f5194de3?source=collection_archive---------10-----------------------#2021-02-07">https://levelup.gitconnected.com/providing-developer-access-to-hosted-cloud-run-service-on-gcp-61f1f5194de3?source=collection_archive---------10-----------------------#2021-02-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="1893" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">保护您的云运行服务不被公开，但允许经过身份验证的开发人员/用户访问它们。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/c6e75274750a68f4408894864aca2f34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yEUUqHb7wqDpyNWb"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@markusspiske" rel="noopener ugc nofollow" target="_blank">马库斯·斯皮斯克</a>在<a class="ae le" href="https://www.unsplash.com" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="5928" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">问题</h1><p id="6120" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">当创建云运行服务时，可以设置“未经认证”的访问权限(因此它对公共互联网可用)或限制访问权限。在大多数用例中，由于安全原因，访问应该受到限制，尤其是对于后端服务。但是你也可以在Cloud Run上托管你的前端，这里需要公共访问，所以每个人都可以使用你的应用。</p><p id="f95c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我的另一篇文章中——<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/easy-serverless-deployment-of-your-react-app-using-cloud-run-c26aa79af491">使用Cloud Run轻松实现React应用的无服务器部署</a>——你可以看到一个在Cloud Run上托管React应用的例子。</p><div class="mp mq gp gr mr ms"><a rel="noopener  ugc nofollow" target="_blank" href="/easy-serverless-deployment-of-your-react-app-using-cloud-run-c26aa79af491"><div class="mt ab fo"><div class="mu ab mv cl cj mw"><h2 class="bd iu gy z fp mx fr fs my fu fw is bi translated">使用云运行轻松实现React应用的无服务器部署</h2><div class="mz l"><h3 class="bd b gy z fp mx fr fs my fu fw dk translated">使用GCP云运行将React应用作为Docker容器部署在无服务器环境中，并使其可访问…</h3></div><div class="na l"><p class="bd b dl z fp mx fr fs my fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="nb l"><div class="nc l nd ne nf nb ng ky ms"/></div></div></a></div><p id="509a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">而且对于您的前端服务，您可能不希望公众访问它。例如，您不希望公众访问您的开发或登台环境，所以您应该保护它们。而且对于内部工具来说，在使用任何应用程序代码进行身份验证之前保护它们是非常有用的。</p><p id="8ea1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，让我们来解决这个问题，只为某些用户提供访问应用程序的权限！</p><h1 id="453d" class="lm ln it bd lo lp nh lr ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj bi translated">先决条件</h1><p id="3908" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">需要一个正在运行的云运行服务，它服务于一些应该受到保护的前端。</p><p id="e829" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您还没有，请按照<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/easy-serverless-deployment-of-your-react-app-using-cloud-run-c26aa79af491">使用云运行轻松无服务器部署React应用</a>中的教程安装并运行一个。只要确保不使用<code class="fe nm nn no np b">--allow-unauthenticated</code>而是使用<code class="fe nm nn no np b">--no-allow-unauthenticated</code>来<a class="ae le" href="https://cloud.google.com/sdk/gcloud/reference/run/deploy#--[no-]allow-unauthenticated" rel="noopener ugc nofollow" target="_blank">阻止公众访问你的服务</a>！</p><h1 id="66d1" class="lm ln it bd lo lp nh lr ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj bi translated">解决方案</h1><p id="48fd" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">当你的服务启动并运行时，你可以尝试通过你的浏览器访问它，如果一切正常，浏览器会显示一些<code class="fe nm nn no np b">403 Forbidden</code>。但这是有意的，也是我们想要实现的，以防止未经授权的访问。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nq"><img src="../Images/362b5e37c892a47d1dce47284e4e807c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D9kg5VLcNcKj6DLttI2hXQ.png"/></div></div></figure><p id="90e8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们添加一些对该服务的访问。为了让一个特定的用户通过他的电子邮件访问这个服务(<code class="fe nm nn no np b">roles/run.invoker</code>)，我们可以使用<code class="fe nm nn no np b">gcloud run services add-iam-policy-binding</code>命令。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="a5c9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">添加用户后，下一步是以特定用户的身份登录，并通过CLI生成一些用于授权的承载令牌。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="e62d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">既然令牌已经生成，下一步就是将这个令牌添加到对前端服务的请求中。为此，有一个很棒的Chrome插件叫做“ModHeader”，可以添加到Chrome中。</p><div class="mp mq gp gr mr ms"><a href="https://chrome.google.com/webstore/detail/modheader/idgpnmonknjnojddfkpgkljpfnnfcklj" rel="noopener  ugc nofollow" target="_blank"><div class="mt ab fo"><div class="mu ab mv cl cj mw"><h2 class="bd iu gy z fp mx fr fs my fu fw is bi translated">ModHeader</h2><div class="mz l"><h3 class="bd b gy z fp mx fr fs my fu fw dk translated">修改HTTP请求和响应头</h3></div><div class="na l"><p class="bd b dl z fp mx fr fs my fu fw dk translated">chrome.google.com</p></div></div><div class="nb l"><div class="nt l nd ne nf nb ng ky ms"/></div></div></a></div><p id="0bdc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">添加插件后，我们需要添加一个请求头，这个请求头会自动添加到请求中，以通过服务进行身份验证。这里我们需要添加来自<code class="fe nm nn no np b">gcloud auth print-identity-token</code>命令的<code class="fe nm nn no np b">Authorization</code>头和令牌，前缀为<code class="fe nm nn no np b">Bearer </code>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nu"><img src="../Images/bb993b2b4a5eb9645edc011220a3202a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i529X2892la_krrB3CqdCw.png"/></div></div></figure><p id="dd40" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当header +键被设置时，可以点击“播放”按钮来激活具有请求报头覆盖的简档。如果现在通过浏览器再次调用服务，那么React应用程序将得到服务，因为请求现在被授权为具有服务调用权限的用户。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nv"><img src="../Images/6c73e19111df89853181f3b4c093df5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s5mYCCxuqcGpRX0ca4oR3A.png"/></div></div></figure><p id="6c87" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">很漂亮，对吧？😉</p><h1 id="43f3" class="lm ln it bd lo lp nh lr ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj bi translated">添加过滤器选项</h1><p id="3b2e" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">如果插件中只定义了<code class="fe nm nn no np b">Authorization</code>头，那么它会附加到浏览器中的所有请求上。这将会把你当前登录的所有其他网站搞得一团糟。以Twitter为例，它会突然开始抛出错误消息，因为现在发送到Twitter的<code class="fe nm nn no np b">Authorization</code>头与它们的授权不匹配。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nw"><img src="../Images/6bfdff8d127b0ef536a3c4b8fa287569.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*glt0JvdwlFr1hwa-HPkepg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">由于错误授权导致的Twitter错误</figcaption></figure><p id="acba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但幸运的是，有一个解决方案。使用ModHeader插件，你可以定义一个过滤器，使用一些URL模式来匹配你想要授权的前端服务的URL。因此，只有当URL模式匹配时，标题才会被覆盖。</p><p id="cbb8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您在您的前端服务网站上添加此过滤器，它将自动获取正确的URL并将其填入值字段。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nx"><img src="../Images/24ede28ccfb8726af958fea39ec7953c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ow26XGQSDZJRHaSVjq2ebw.png"/></div></div></figure><h1 id="c9e3" class="lm ln it bd lo lp nh lr ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj bi translated">结论</h1><p id="3d84" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">我希望我可以向您展示如何轻松访问安全的云运行服务，并激励您保护您的服务免受未经授权的访问。</p><p id="ea3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢您花时间阅读我的文章。</p><h2 id="bf89" class="ny ln it bd lo nz oa dn ls ob oc dp lw kb od oe ma kf of og me kj oh oi mi oj bi translated">你想联系吗？</h2><p id="6350" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">如果你想联系我，请在LinkedIn上打电话给我。</p><p id="c598" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另外，请随意查看<a class="ae le" href="https://medium.com/@mr-pascal/my-book-recommendations-4b9f73bf961b" rel="noopener">我的书籍推荐</a>📚。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><div class="kp kq kr ks gt ms"><a href="https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b" rel="noopener follow" target="_blank"><div class="mt ab fo"><div class="mu ab mv cl cj mw"><h2 class="bd iu gy z fp mx fr fs my fu fw is bi translated">我的书籍推荐</h2><div class="mz l"><h3 class="bd b gy z fp mx fr fs my fu fw dk translated">在接下来的章节中，你可以找到我对所有日常生活话题的书籍推荐，它们对我帮助很大。</h3></div><div class="na l"><p class="bd b dl z fp mx fr fs my fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="nb l"><div class="ok l nd ne nf nb ng ky ms"/></div></div></a></div><div class="mp mq gp gr mr ms"><a href="https://mr-pascal.medium.com/membership" rel="noopener follow" target="_blank"><div class="mt ab fo"><div class="mu ab mv cl cj mw"><h2 class="bd iu gy z fp mx fr fs my fu fw is bi translated">通过我的推荐链接加入Medium—Pascal Zwikirsch</h2><div class="mz l"><h3 class="bd b gy z fp mx fr fs my fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="na l"><p class="bd b dl z fp mx fr fs my fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="nb l"><div class="ol l nd ne nf nb ng ky ms"/></div></div></a></div></div></div>    
</body>
</html>