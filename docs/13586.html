<html>
<head>
<title>Docker Image Testing With Container Structure Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">集装箱结构测试中的Docker图像测试</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/docker-image-testing-with-container-structure-tests-b2b2e5676060?source=collection_archive---------9-----------------------#2022-09-18">https://levelup.gitconnected.com/docker-image-testing-with-container-structure-tests-b2b2e5676060?source=collection_archive---------9-----------------------#2022-09-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/b54f01839f37f34a649852762c1bb802.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jPYXzMhGfUvqjpkAx8hFmQ.png"/></div></div></figure><p id="5234" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">容器已经成为定义和一致运行软件的领先技术，有助于减少在调试问题或运行应用程序时出现的可怕的“但它在我的系统上有效”的问题。因此，通过将我们的软件及其运行时依赖项包装到一个容器映像中，我们创建了一个您可以测试的人工制品，以确保它在测试生命周期的不同阶段都能按预期工作。既然我们将这些测试期望放在我们正在创建的软件上，为什么我们不对它正在使用的容器运行时进行相同级别的测试呢？</p><p id="7e91" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">根据应用程序的运行时环境，您可能需要公开特定的标签、环境变量或在图像上构建参数。尽管如此，当您最终构建映像时，您不能保证该映像的消费者的容器映像契约按要求工作。您能确保工具正确安装到您正在构建的当前容器中吗？或者当你传入一个参数时，你的容器按预期启动？</p><p id="4d25" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在本文中，我们将介绍如何使用<a class="ae kz" href="https://github.com/GoogleContainerTools/container-structure-test" rel="noopener ugc nofollow" target="_blank">Google container tools/container-structure-test</a>，您可以根据定义的容器规范对构建的容器映像进行测试，以确保它们符合规范。通过这样做，您可以保证您的容器运行时满足其要求，因此当您使用该容器时，它将按照您的应用程序的预期工作。</p><h1 id="b680" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">问题是</h1><p id="84d0" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">假设您运行一个软件平台，该平台涉及为其他所需的服务或应用程序运行许多不同的Docker映像。为了更好地管理所有这些映像的创建，最好为运行时映像的外观设置一个规范，包括使用的标签、环境变量和构建参数，这些可能是您的日志记录或CICD设置每个人都可以使用的平台级映像所必需的。</p><p id="0e95" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要让基础设施中使用的所有容器映像都遵循一套规范，很容易为它们提供一个预配置的基本映像。然后，其他团队可以使用这个映像，并根据任何进一步的需求对其进行扩展。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div class="gh gi md"><img src="../Images/940c046bde04c9188c5ced94343f011e.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*AGRbr2lVR-pjCy7a0uB2oQ.png"/></div></figure><p id="2b53" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">但是对于图像的所有下游消费者来说，我们如何保证一组稳定的工具和配置存在，而不需要他们发现构建期间的问题是否已经通过了CICD质量关？</p><h1 id="ddf8" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">解决方案</h1><p id="8bda" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">为了解决不知道你的容器是否按预期运行的问题，Google的优秀人员已经用一个叫做容器结构测试的工具解决了这个问题。</p><div class="mi mj gp gr mk ml"><a href="https://github.com/GoogleContainerTools/container-structure-test" rel="noopener  ugc nofollow" target="_blank"><div class="mm ab fo"><div class="mn ab mo cl cj mp"><h2 class="bd iu gy z fp mq fr fs mr fu fw is bi translated">GitHub-Google container tools/container-structure-test:验证你的容器的结构…</h2><div class="ms l"><h3 class="bd b gy z fp mq fr fs mr fu fw dk translated">容器结构测试为验证容器映像的结构提供了一个强大的框架。这些测试…</h3></div><div class="mt l"><p class="bd b dl z fp mq fr fs mr fu fw dk translated">github.com</p></div></div><div class="mu l"><div class="mv l mw mx my mu mz jz ml"/></div></div></a></div><p id="6a82" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个工具。允许您为容器编写规范，以定义图像应该能够执行的内容。然后，使用提供的URI，在容器中运行每个定义的测试，以查看它是否满足规范。</p><p id="8f77" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，这款工具非常适合我们的需求，是一款可脚本化的CLI工具，可以集成到我们的CICD流程中。我们现在将看看如何定义这些容器规范，并根据映像运行它们。</p><p id="73b5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先，我们将创建一个简单的Dockerfile来定义我们想要测试的运行时。在这个文件中，我们将定义一些在容器中常见的东西，例如在容器中运行的应用程序所需的工具、参数和环境变量。</p><pre class="me mf mg mh gt na nb nc nd aw ne bi"><span id="80dc" class="nf lb it nb b gy ng nh l ni nj">FROM node:14-alpine</span><span id="f677" class="nf lb it nb b gy nk nh l ni nj"># Install packages<br/>RUN apk update &amp;&amp; apk add --update --no-cache \<br/>    git \<br/>    bash \<br/>    curl \<br/>    openssh \<br/>    python3 \<br/>    py3-pip \<br/>    py-cryptography \<br/>    wget \<br/>    curl</span><span id="108b" class="nf lb it nb b gy nk nh l ni nj">RUN apk --no-cache add --virtual builds-deps build-base python3</span><span id="0f45" class="nf lb it nb b gy nk nh l ni nj"># Update NPM<br/>RUN npm config set unsafe-perm true<br/>RUN npm update -g</span><span id="fe90" class="nf lb it nb b gy nk nh l ni nj"># Install AWSCLI<br/>RUN pip install --upgrade pip &amp;&amp; \<br/>    pip install --upgrade awscli</span><span id="65a8" class="nf lb it nb b gy nk nh l ni nj"># Install Serverless Framework<br/>RUN npm install -g serverless</span><span id="59d0" class="nf lb it nb b gy nk nh l ni nj">ENV YOUR_ENV_VAR="SOME VALUE"</span><span id="2d72" class="nf lb it nb b gy nk nh l ni nj">LABEL org.node.version="14"<br/>LABEL org.your.key="your_value"</span></pre><p id="26c7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后，我们将建立和标记这个图像，所以我们有一个人工制品，我们可以测试。</p><pre class="me mf mg mh gt na nb nc nd aw ne bi"><span id="1c40" class="nf lb it nb b gy ng nh l ni nj">docker build -f . -t test-container</span></pre><p id="d20a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在容器准备好了，我们将编写我们的规范文件。这是用YAML构建的，包括应该成功运行的命令等断言，检查具有指定权限的现有文件，并检查构建的映像中的环境变量和标签。</p><p id="ad1c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面的文件显示了测试我们之前定义的测试Docker映像的所有运行动作和配置的断言。</p><pre class="me mf mg mh gt na nb nc nd aw ne bi"><span id="0f64" class="nf lb it nb b gy ng nh l ni nj">#config.yaml<br/>schemaVersion: 2.0.0</span><span id="6e13" class="nf lb it nb b gy nk nh l ni nj">metadataTest:<br/>  env:<br/>    - key: YOUR_ENV_VAR<br/>      value: SOME VALUE<br/>  labels:<br/>    - key: 'org.node.version'<br/>      value: '14'<br/>    - key: 'org.your.key'<br/>      value: 'your_value'</span><span id="08a5" class="nf lb it nb b gy nk nh l ni nj">fileExistenceTests:<br/>  - name: 'Root'<br/>    path: '/'<br/>    shouldExist: true</span><span id="d31c" class="nf lb it nb b gy nk nh l ni nj">commandTests:<br/>  - name: "Check that nodejs is working"<br/>    command: "bash"<br/>    args:<br/>      - -c<br/>      - |<br/>         nodejs --version</span><span id="c3d5" class="nf lb it nb b gy nk nh l ni nj">- name: "Check that serverless is working"<br/>    command: "bash"<br/>    args:<br/>      - -c<br/>      - |<br/>         serverless --version</span></pre><p id="949b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在已经定义了测试，您可以使用container-structure-test CLI工具对容器映像运行这个定义。</p><pre class="me mf mg mh gt na nb nc nd aw ne bi"><span id="451f" class="nf lb it nb b gy ng nh l ni nj">container-structure-test test --image test-container --config config.yaml</span></pre><p id="fbfd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该工具将启动一个容器，并针对这个正在运行的容器运行所有测试。这确保了运行时按预期工作，而不仅仅是静态地检查docker文件，允许无声的错误悄悄通过。</p><p id="7c88" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">运行测试后，您将在终端中看到下面的测试输出来报告结果。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nl"><img src="../Images/5306e5099f0320f1edfaccd34d901fc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dzklqt0KKVbyXZkK2ijPWg.png"/></div></div></figure><p id="d41e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">正如您所看到的，很容易开始为您的图像定义规范，以确保它们按预期工作，为您的容器发布过程带来新的可靠性水平。</p><h1 id="c81b" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">包扎</h1><p id="fc8d" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">对于创建的示例，您应该已经看到了定义容器规范并针对构建的容器映像运行它是多么容易。作为一个CLI工具<code class="fe nm nn no nb b">container-structure-test</code>,你可以让它成为任何CICD过程的一部分，为你发布的容器设置一个质量关卡，以确保你的构建过程中没有无声的错误进入你的应用程序运行时。</p><p id="c9a6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您正在寻找更多的docker内容，请查看下面的文章，了解如何轻松地将CLI包装在docker容器中，使其更具可移植性。</p><div class="mi mj gp gr mk ml"><a rel="noopener  ugc nofollow" target="_blank" href="/make-your-cli-portable-with-docker-c97038fdc601"><div class="mm ab fo"><div class="mn ab mo cl cj mp"><h2 class="bd iu gy z fp mq fr fs mr fu fw is bi translated">使用Docker让您的CLI变得可移植</h2><div class="ms l"><h3 class="bd b gy z fp mq fr fs mr fu fw dk translated">假设你有一个很棒的CLI应用程序，但是你对它的安装或上线不满意…</h3></div><div class="mt l"><p class="bd b dl z fp mq fr fs mr fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="mu l"><div class="np l mw mx my mu mz jz ml"/></div></div></a></div><h1 id="3dea" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">进一步连接</h1><ul class=""><li id="09ba" class="nq nr it kd b ke ly ki lz km ns kq nt ku nu ky nv nw nx ny bi translated">如果你正在考虑获得一个中等订阅，你可以通过使用我的<a class="ae kz" href="https://aaron-kt-berry.medium.com/membership" rel="noopener">推荐链接</a>来帮助我。</li><li id="ad42" class="nq nr it kd b ke nz ki oa km ob kq oc ku od ky nv nw nx ny bi translated">查看我在<a class="ae kz" href="https://medium.com/@aaron-kt-berry" rel="noopener">媒体</a>上的其他文章，如果你想了解最新消息，可以通过<a class="ae kz" href="https://aaron-kt-berry.medium.com/subscribe" rel="noopener">电子邮件</a>订阅。</li><li id="bdd0" class="nq nr it kd b ke nz ki oa km ob kq oc ku od ky nv nw nx ny bi translated">如果你想聊天，在<a class="ae kz" href="https://twitter.com/Aaron_KT_Berry" rel="noopener ugc nofollow" target="_blank"> Twitter </a>或<a class="ae kz" href="https://www.linkedin.com/in/aaron-kt-berry/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上与我联系，如果你想雇佣我，我在<a class="ae kz" href="https://www.codementor.io/@aaronktberry" rel="noopener ugc nofollow" target="_blank"> Codementor </a>上。</li></ul></div><div class="ab cl oe of hx og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="im in io ip iq"><h1 id="95fd" class="la lb it bd lc ld ol lf lg lh om lj lk ll on ln lo lp oo lr ls lt op lv lw lx bi translated">分级编码</h1><p id="b753" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="4f37" class="nq nr it kd b ke kf ki kj km oq kq or ku os ky nv nw nx ny bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="2fa0" class="nq nr it kd b ke nz ki oa km ob kq oc ku od ky nv nw nx ny bi translated">📰查看<a class="ae kz" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="8bc3" class="nq nr it kd b ke nz ki oa km ob kq oc ku od ky nv nw nx ny bi translated">🔔关注我们:<a class="ae kz" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae kz" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae kz" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="38c3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">🚀👉<a class="ae kz" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kd iu">加入人才集体，找到一份令人惊喜的工作</strong> </a></p></div></div>    
</body>
</html>