<html>
<head>
<title>Handle Registration in FastAPI and Tortoise ORM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在FastAPI和Tortoise ORM中处理注册</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/handle-registration-in-fastapi-and-tortoise-orm-a673263bdba3?source=collection_archive---------5-----------------------#2020-12-09">https://levelup.gitconnected.com/handle-registration-in-fastapi-and-tortoise-orm-a673263bdba3?source=collection_archive---------5-----------------------#2020-12-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="dfb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个过程中掉一两滴眼泪——第三部分</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/28218d3737810456c26b3ac96af78826.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LK-Edq1fPb7fruWy"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">由<a class="ae lb" href="https://unsplash.com/@markusspiske?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Markus Spiske </a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="605c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本教程的前<a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/handle-registration-in-fastapi-and-tortoise-orm-a661162d27f1">部分，您配置了应用程序并编写了一些服务。现在是时候使用它们了。</a></p><p id="caed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将定义两个端点:</p><ul class=""><li id="4459" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated"><code class="fe ll lm ln lo b">/api/auth/register</code></li><li id="4fa3" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated"><code class="fe ll lm ln lo b">/api/auth/verify</code></li></ul><p id="0776" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我介绍了一些必须的特性，比如验证令牌。我不负责重新发送确认。理想情况下，它只对经过身份验证的用户可用，这超出了本教程的范围。</p></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><h1 id="8c6b" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">模型</h1><p id="6df6" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">在教程的第一部分，您已经创建了一个用户表。您现在就可以使用它，但是还没有方便的方法在乌龟ORM中使用它。您需要先添加一个模型。在<code class="fe ll lm ln lo b">/app/models/auth.py</code>增加以下内容:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ne nf l"/></div></figure><ul class=""><li id="37a8" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">根据迁移的数据库模式定义字段。</li><li id="39e3" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">因为模型类的命名不同于数据库表，所以您需要在<code class="fe ll lm ln lo b">Meta</code>类中指定它。</li></ul><p id="c5e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注册和确认帐户时，您需要使用两个以上的模型。</p><h2 id="ea65" class="ng mc iq bd md nh ni dn mh nj nk dp ml jy nl nm mp kc nn no mt kg np nq mx nr bi translated">创建用户</h2><pre class="km kn ko kp gt ns lo nt nu aw nv bi"><span id="dfff" class="ng mc iq lo b gy nw nx l ny nz">class CreateUser(pydantic.BaseModel):<br/>    email: pydantic.EmailStr<br/>    password: <!-- -->pydantic.SecretStr</span></pre><ul class=""><li id="a57a" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">使用Pydantic中的<code class="fe ll lm ln lo b">BaseModel</code>显式创建模型。</li><li id="6edb" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">设置<code class="fe ll lm ln lo b">email</code>字段类型进行自动验证。</li><li id="5489" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">制作密码a <code class="fe ll lm ln lo b">SecretStr</code>。</li></ul><h2 id="9479" class="ng mc iq bd md nh ni dn mh nj nk dp ml jy nl nm mp kc nn no mt kg np nq mx nr bi translated">用户</h2><pre class="km kn ko kp gt ns lo nt nu aw nv bi"><span id="e1d3" class="ng mc iq lo b gy nw nx l ny nz">User_Pydantic = pydantic_model_creator(<br/>    UserModel, <br/>    name='User', <br/>    exclude=('hashed_password', 'confirmation')<br/>)</span></pre><ul class=""><li id="afda" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">使用数据库映射创建<code class="fe ll lm ln lo b">User</code>模型。</li><li id="685c" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">这个模型将会被一个<code class="fe ll lm ln lo b">verify</code>方法返回，这个方法你马上就要写了。排除<code class="fe ll lm ln lo b">hashed_password</code>和<code class="fe ll lm ln lo b">confirmation</code>，因为不需要它们。</li></ul><p id="a496" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了这些，我们终于可以写一些…</p></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><h1 id="27a2" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">端点</h1><p id="f8ae" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">如前所述，您只公开了两个端点。</p><h2 id="7e61" class="ng mc iq bd md nh ni dn mh nj nk dp ml jy nl nm mp kc nn no mt kg np nq mx nr bi translated">/注册</h2><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="6035" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里发生了很多事情。让我们把它分解一下:</p><ul class=""><li id="723c" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">创建新的<code class="fe ll lm ln lo b">APIRouter</code>。这是注册端点所必需的。</li><li id="a2be" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">使用上述路由器注册一个<code class="fe ll lm ln lo b">/register</code>端点。</li><li id="be28" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">使用FastAPI主要好处是请求是异步处理的。所以才这么快。这里，我们定义一个函数，它将把一个<code class="fe ll lm ln lo b">CreateModel</code>作为参数。上面有It <code class="fe ll lm ln lo b">Depends</code>,表示它是必需的。这种机制也用于<a class="ae lb" href="https://fastapi.tiangolo.com/tutorial/dependencies/" rel="noopener ugc nofollow" target="_blank">依赖注入，</a>虽然我在本教程中没有涉及。</li><li id="6ec3" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">使用Tortoise，您可以通过电子邮件引用一个用户来检查它是否存在于数据库中。这意味着它是重复的，意味着您必须拒绝查询，因为用户已经存在。</li><li id="233e" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">使用发送的电子邮件和密码创建用户。您使用了来自<code class="fe ll lm ln lo b">Auth</code>类的一个实用方法。注意，这里使用了<code class="fe ll lm ln lo b">get_secret_value</code>方法，因为<code class="fe ll lm ln lo b">password</code>字段使用了来自Pydantic API的自定义<a class="ae lb" href="https://pydantic-docs.helpmanual.io/usage/types/#secret-types" rel="noopener ugc nofollow" target="_blank">类型</a>。</li><li id="b352" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">生成确认令牌，并将其ID ( <code class="fe ll lm ln lo b">jti</code>)分配给确认数据库字段。它确保用户使用他有权访问的电子邮件进行注册。</li><li id="d18a" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">将用户保存在数据库中，并发送确认电子邮件，确保消息可以在第一时间发送。</li></ul><h2 id="6c02" class="ng mc iq bd md nh ni dn mh nj nk dp ml jy nl nm mp kc nn no mt kg np nq mx nr bi translated">/验证</h2><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="75e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，这里面有很多东西，但逻辑相当简单:</p><ul class=""><li id="02f3" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">声明将<code class="fe ll lm ln lo b">token</code>作为参数的<code class="fe ll lm ln lo b">/verify</code>端点。</li><li id="5871" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">健全检查。令牌是否过期？是scope以外的<code class="fe ll lm ln lo b">registration</code>(意思是不是注册令牌)？用户是否已被激活？用户是否存在？令牌ID是否存储在数据库中？如果任何一个问题的答案是肯定的，返回一个<code class="fe ll lm ln lo b">HTTPException</code>。</li><li id="e4ed" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">激活用户。</li><li id="1d62" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">返回映射到<code class="fe ll lm ln lo b">User_Pydantic</code>模型的用户。</li></ul><p id="3a54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据本教程的范围，这些是您需要定义的唯一端点。我们来测试一下。</p></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><h1 id="9774" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">注册路由器</h1><p id="0994" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">你就快到了。在<code class="fe ll lm ln lo b">/app/main.py</code>文件中添加以下内容:</p><pre class="km kn ko kp gt ns lo nt nu aw nv bi"><span id="c2c1" class="ng mc iq lo b gy nw nx l ny nz">from routers.auth import auth_router<br/></span><span id="c20b" class="ng mc iq lo b gy oa nx l ny nz">app.include_router(<br/>    auth_router,<br/>    prefix=settings.API_PREFIX + '/auth',<br/>    tags=['Authentication'],<br/>)</span></pre><ul class=""><li id="94c5" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">为<code class="fe ll lm ln lo b">auth_router</code>注册的所有端点设置API前缀。</li><li id="d7ea" class="lc ld iq jp b jq lp ju lq jy lr kc ls kg lt kk lh li lj lk bi translated">设置<code class="fe ll lm ln lo b">Authentication</code>标签。这将在Swagger文档中显示为端点类别。</li></ul></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><h1 id="3a88" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">测试应用程序</h1><p id="d527" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">确保SMTP服务器已启动:</p><pre class="km kn ko kp gt ns lo nt nu aw nv bi"><span id="9513" class="ng mc iq lo b gy nw nx l ny nz">python -m smtpd -c DebuggingServer -n localhost:25</span></pre><p id="88bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后运行应用程序:</p><pre class="km kn ko kp gt ns lo nt nu aw nv bi"><span id="7ec9" class="ng mc iq lo b gy nw nx l ny nz">python main.py</span></pre><p id="09b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在您的浏览器中，转到<code class="fe ll lm ln lo b">localhost:8000/docs</code>。注册一个虚拟账户:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ob"><img src="../Images/800ad1e5d0e829de7e5f50a2dc5269f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LTwIJAzx-T4vmHKZjNBZxg.png"/></div></div></figure><p id="d092" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行pgAdmin。如您所见，帐户已经创建，但尚未激活:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oc"><img src="../Images/6009adfd5d90144ce1f859af2531bd84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gj_46hOHTUol4mcZdD0g7w.png"/></div></div></figure><p id="f8d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在运行SMTP守护程序的控制台窗口中，会输出一个确认链接。将其复制并粘贴到您的浏览器中。您应该得到这样的输出:</p><pre class="km kn ko kp gt ns lo nt nu aw nv bi"><span id="36f8" class="ng mc iq lo b gy nw nx l ny nz">{<br/>  "id": "e002e7b7-05c2-4ad2-85cd-a8942d75cec3",<br/>  "email": "lorem.ipsum@example.com",<br/>  "is_active": true<br/>}</span></pre><p id="4887" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">转到pgAdmin并检查用户是否已被激活:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi od"><img src="../Images/2d976a63ab6cc20a30f78042e8f4efd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*JOJb-K2rXxaSEArozfrd6g.png"/></div></figure><p id="8d7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样！您刚刚完成注册。</p></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><h1 id="55ce" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">最后的话</h1><p id="a6bb" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">感谢阅读！</p><p id="05b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有代码都可以在我的<a class="ae lb" href="https://github.com/izdwuut/fastapi-registration-tutorial/tree/part-3" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p></div></div>    
</body>
</html>