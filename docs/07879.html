<html>
<head>
<title>Up and Running with Azure Kubernetes Service (AKS) and DevOps Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">启动并运行Azure Kubernetes服务(AKS)和DevOps管道</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/up-and-running-with-azure-kubernetes-service-aks-and-devops-pipelines-2208c24378ff?source=collection_archive---------2-----------------------#2021-03-17">https://levelup.gitconnected.com/up-and-running-with-azure-kubernetes-service-aks-and-devops-pipelines-2208c24378ff?source=collection_archive---------2-----------------------#2021-03-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0284" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第1部分—在Azure门户中设置AK</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/dadf8075fd576d466fd44fbf4e54e023.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MbesJdmUhtbmBh2JE7O5Sg.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">乐队指挥——照片由来自<a class="ae kv" href="https://www.pexels.com/photo/man-performing-on-stage-2102568/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">佩克斯</a>的<a class="ae kv" href="https://www.pexels.com/@gabrielsantosfotografia?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">加布里埃尔·桑托斯·福托格拉菲亚</a>拍摄</figcaption></figure><p id="99e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在第n次在Azure中部署Kubernetes，并随后将Azure DevOps管道连接到它以实现完全自动化的部署之后，以及意识到AKS的设置和众多选项甚至对经验丰富的Azure用户来说都可能看起来势不可挡——我决定为任何在类似设置中挣扎的人记录它。接下来，在第2部分中，我们将讨论Kubernetes的内部设置；在第3部分中，我们将配置一个Azure DevOps管道来自动部署到我们的新AKS资源。</p><blockquote class="ls lt lu"><p id="0e6d" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong> <br/> Azure Portal只是在Azure中创建AKS资源的众多方式之一。其他方式包括Azure CLI和PowerShell，它们都超出了本系列的范围。</p></blockquote><p id="f194" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">好了，言归正传！</strong></p><p id="bad3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，你显然需要一个Azure账户。你说你没有？嗯，他们提供25+始终免费的服务，12个月免费的额外服务，以及前30天更多“优质”服务的200美元信用。你可以在https://azure.microsoft.com/account/free报名。如果你还没有账户的话，这应该足够给你一个类似的机会了。</p><h1 id="95ba" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">创建资源</h1><ul class=""><li id="36d6" class="mr ms iq ky b kz mt lc mu lf mv lj mw ln mx lr my mz na nb bi translated">在<a class="ae kv" href="https://portal.azure.com" rel="noopener ugc nofollow" target="_blank">https://portal.azure.com</a>登录Azure门户</li><li id="df58" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">通过从左侧菜单中选择“创建资源”来创建资源。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/28302aeb029668fae393dbb7ff00e605.png" data-original-src="https://miro.medium.com/v2/resize:fit:790/format:webp/1*o_ap5u8QR9nH82VMOUsGbw.png"/></div></figure><ul class=""><li id="3902" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated">在接下来的屏幕上，在搜索栏中输入“Kubernetes Service”。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/be58fae8556c240f2b93ec55cdaaf5fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WomxyoBGn-Uzcl_F7CBv3Q.png"/></div></div></figure><ul class=""><li id="02c7" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated">然后，选择“创建”</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/b83d9be7ea38f485af8fc6773f9057fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ah6x05sd7nuo9uAbLIh23g.png"/></div></div></figure><p id="bc03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下面的屏幕上，我们将开始配置新的Kubernetes服务。</p></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><h1 id="6e63" class="lz ma iq bd mb mc nu me mf mg nv mi mj jw nw jx ml jz nx ka mn kc ny kd mp mq bi translated">Azure Kubernetes服务(AKS)资源的初始配置</h1><h2 id="3ad7" class="nz ma iq bd mb oa ob dn mf oc od dp mj lf oe of ml lj og oh mn ln oi oj mp ok bi translated">基础</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/04ab299a5ada8ae09ec911845082cdc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z4P7fEpKJbAFNtZi3PGcGw.png"/></div></div></figure><ul class=""><li id="43c1" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated"><strong class="ky ir">订阅</strong>。大多数人只有一个，其余的人选择合适的一个。</li><li id="d6c8" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky ir">资源组</strong>。选择要添加AKS资源的资源组，或者通过<strong class="ky ir"> <em class="lv">“新建”</em> </strong>链接新建一个资源组。</li></ul><blockquote class="ls lt lu"><p id="b5f9" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong> <br/>需要注意的是，这里选择的资源组将只包含AKS资源，而不包含实际的节点池、负载平衡器和其他与之关联的底层资源。这些是在一个新的单独的资源组中创建的，这个资源组由Azure自动方便地命名。</p></blockquote><ul class=""><li id="3170" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated"><strong class="ky ir"> Kubernetes集群名称</strong>。随便你怎么命名，但是我建议你尽可能地为你所有的Azure资源坚持一个相似的命名惯例。大多数团队对此已经有了一个格式，但是在新的项目中，您会希望有一个合适的格式。我倾向于使用:<code class="fe om on oo op b"><strong class="ky ir">&lt;&lt;company/department/product&gt;&gt;-&lt;&lt;resource&gt;&gt;-&lt;&lt;environment&gt;&gt;-&lt;&lt;instance&gt;&gt;</strong></code> <br/>的格式，因此您的资源名称可能类似于:<br/> <code class="fe om on oo op b"><strong class="ky ir">digital-kubernetes-dev-01</strong></code></li></ul><blockquote class="ls lt lu"><p id="3795" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">当提到命名你的资源时，我推荐如下:</p><p id="86c8" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">—对于公司或部门，这将取决于您的场景。如果您所在的组织在同一个订阅中有多个公司(如控股公司)，您可能会希望以company或其缩写作为前缀(例如，如果您的公司是Microsoft，则前缀应为“msft”)。如果您在一家公司(典型)，您可能希望按部门或产品(如“digital”或“myapp”)进行分隔。</p><p id="dd10" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">—资源应该是不言自明的，这里唯一的建议是保持简单和一致。(例如，“kubernetes”或“database”)</p><p id="f181" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">—谈到环境，我建议根据环境选择“开发”、“生产”、“共享”、“登台”或“测试”中的一种。“共享”环境是为跨多个环境共享资源而保留的，例如Active Directory/Active Directory B2C或外壳存储帐户。</p><p id="4d07" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">—最后，实例通常只有一种格式(例如，“01”、“001”、“1”)，因为我建议在所有资源上标注一个实例编号，以防需要多个匹配相同格式的实例。一个常见的场景是存储帐户和虚拟机，您可能有不止一个(例如，digital-vm-dev-14)。</p><p id="c70e" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">你可能会问为什么这很重要，为什么标签不能用来定义和查找资源。简单的回答是，虽然我强烈推荐准确、标准化和一致的标记，但以标准化的方式格式化资源名称可以让您从资源列表中快速确定资源类型、所有权和用途/目的。这绝不是必须的，但是随着你的组织的Azure资源的增加，你可能会感谢我！</p></blockquote><ul class=""><li id="d7f5" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated"><strong class="ky ir">地区</strong>。对于该资源组中的所有资源来说，这通常应该是相同的(假设您的资源组是按环境划分的，例如digital-prod、digital-dev等)。).原因很简单:<br/> 1。潜在的入口和出口费用(在不同地区的资源之间移动数据有时会在您的账单上产生这些忍者费用)。<br/> 2。速度。在同一个地区发出请求和来回移动数据将比在全国或世界范围内做同样的事情要快得多。</li></ul><blockquote class="ls lt lu"><p id="45d0" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong> <br/>选择一个地区并坚持下去。这不一定是离你或你的公司办公室最近的地区。我(以及微软)建议你根据三个主要因素做出选择:</p><p id="63d9" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">1.<strong class="ky ir">监管、合规和数据驻留要求</strong>。那些讨厌的东西，我知道。然而，它们是你在选择一个地区时首先要考虑的因素。如果您的组织有特定的法规遵从性要求，就像许多组织一样(例如，SOX、PCI DSS等。)然后，您很可能需要选择该国存在这些法规/合规性要求的地区(例如，如果您要求SOX合规性，您将无法选择位于加拿大或巴西的地区，这只是几个例子)。数据驻留也是许多政府机构以及为政府机构或国防和金融公司提供服务的组织所关心的问题。如果需要，还有特定的Azure区域和数据中心供政府使用(包括地方政府、美国联邦政府、美国国防部/国防部，以及利用和存储高度机密信息的政府机构和组织——称为Azure Government for National Security)。</p><p id="74bd" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">监管/合规和数据驻留的可用区域</strong> <br/> <a class="ae kv" href="https://azure.microsoft.com/en-us/global-infrastructure/geographies/" rel="noopener ugc nofollow" target="_blank">选择适合您的Azure区域| Microsoft Azure </a></p><p id="b3d0" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">2.<strong class="ky ir">贵组织需要利用的资源类型的可用性</strong>。并非所有资源类型在所有地区都可用，因此，如果您的组织需要利用特定的功能，您接下来会希望在选择时考虑这些功能。<br/> <strong class="ky ir">各地区所有Azure资源类型</strong> <br/> <a class="ae kv" href="https://azure.microsoft.com/en-us/global-infrastructure/services/?products=all&amp;regions=all" rel="noopener ugc nofollow" target="_blank">各地区Azure产品|微软Azure </a></p><p id="a307" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">3.<strong class="ky ir">潜伏期</strong>。与您的客户、组织的用户或本地/托管服务器的距离很重要。很明显，您会希望选择一个最接近您的大部分用户群的区域，无论是内部还是外部，或者最接近您的内部或协同定位的服务器，这些服务器经常与您的Azure资源交换数据。在某些情况下，您可能希望将几个地区作为独立的资源组，每个资源组根据到用户群的距离提供服务(例如，如果您在东海岸和西海岸都有大量用户，您可能有两个生产资源组，一个在<strong class="ky ir"> <em class="iq">东美国2 </em> </strong>，另一个在<strong class="ky ir"> <em class="iq">西美国</em> </strong>)。<br/>注意:如果您的组织已经或计划使用快速路线，这些注意事项可能会发生变化。请咨询您的网络或IT团队，了解他们可能提供的更多信息和建议。</p><p id="fe29" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">你可以在Azure | Microsoft Docs 中阅读有关区域和可用性区域的更多信息</strong> <br/> <a class="ae kv" href="https://docs.microsoft.com/en-us/azure/availability-zones/az-overview" rel="noopener ugc nofollow" target="_blank"/></p></blockquote><ul class=""><li id="9bc4" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated"><strong class="ky ir">可用区域</strong>。默认情况下，选定区域的所有分区都会被选定。这允许节点池分布在整个区域的可用性区域中，有助于在一个区域(通常是区域中的一个或多个数据中心)出现服务中断时防止整个节点池中断。并非所有地区都支持AKS的此功能，因此如果需要，请确保选择适当的地区。<br/>在此阅读更多关于AKS集群可用性区域的信息:<br/><a class="ae kv" href="https://docs.microsoft.com/en-us/azure/aks/availability-zones#overview-of-availability-zones-for-aks-clusters" rel="noopener ugc nofollow" target="_blank">AKS集群可用性区域概述|微软文档</a></li><li id="6bfc" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky ir"> Kubernetes版本。</strong>很简单，就是Kubernetes的版本。出于明显的稳定性原因，除非您有理由使用它，否则我建议使用“预览”版本以外的版本。在撰写本文时(2021年3月)，这个版本是1.19.7。请记住，您总是可以在以后升级集群(使用滚动升级来防止任何停机)，所以不要在这个特殊的决定上花费太多时间。<br/>提供每个版本信息的Kubernetes变更日志可以在这里找到:<br/> <a class="ae kv" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/README.md" rel="noopener ugc nofollow" target="_blank"> Kubernetes变更日志</a></li><li id="7fa7" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky ir">主节点池</strong>。现在，我们开始选择将充当我们的Kubernetes节点的底层虚拟机。要改变节点大小，选择<strong class="ky ir"> <em class="lv">，改变大小</em> </strong>。根据您的特定工作负载，这可能会有很大的变化，这方面的考虑超出了本文的范围。也就是说，如果您正在部署微服务，那么如果您正确构建它们，它们将是小型、紧凑和高效的。因此，单个节点本身通常可以是“轻量级”的，并且可以通过根据需要缩放节点的数量来处理负载，这比缩放现有节点的大小容易得多(例如，与手动缩放大小相比，允许全自动的“弹性”或“可突发”容量)。我发现B2s实例附近的一些东西对Node.js微服务工作得很好(与Kubernetes节点无关！).</li></ul><blockquote class="ls lt lu"><p id="dbb6" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong> <br/>如果您发现选定的节点大小不太适合您组织的需求，可以<em class="iq">更改它</em>。<br/>在初始配置期间的“基本”页面上，您只需设置主节点池。您将能够在下一步“<strong class="ky ir">节点池</strong>”中添加更多节点池，并在以后根据需要添加更多节点池。</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/c8b24c45d994dffad6ee402b0fe6d333.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Xj8fom1P4eCU6cYNfEMoQ.png"/></div></div></figure><ul class=""><li id="6d12" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated"><strong class="ky ir">节点计数</strong>。这只是最初使用选定的节点大小创建的节点数。最小值为1，但默认为3。我强烈建议生产工作负载至少使用三个节点，尽管开发环境可以使用一个节点。然而，在任何将执行负载测试的环境中，您还会想要精确地复制生产环境选择。因此，如果您的生产环境在单个节点池中使用4个B2s节点，您将希望为执行负载测试的环境选择相同的节点(例如，“<strong class="ky ir">阶段</strong>或“<strong class="ky ir">测试</strong>”)。</li></ul><blockquote class="ls lt lu"><p id="8310" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong> <br/>显然，在前面的步骤中选择的每个可用性区域必须至少有一个节点。因此，如果您所在的地区是“<strong class="ky ir">美国东部2 </strong>”，并且选择了“<strong class="ky ir"> 1、2、3 </strong>”可用区域，那么您至少需要三个节点。</p></blockquote><h2 id="adfe" class="nz ma iq bd mb oa ob dn mf oc od dp mj lf oe of ml lj og oh mn ln oi oj mp ok bi translated">节点池</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/9b193ecbf9ed678c129c3c72df0c7f21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L8NuVYKHSNeqDIxoTNwEzg.png"/></div></div></figure><ul class=""><li id="6ac7" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated"><strong class="ky ir">节点池</strong>。在这里，我们将查看AKS资源的节点池。将列出在上一步中选择的默认节点池。您现在也有机会根据需要添加额外的节点池，方法是选择“<strong class="ky ir"> <em class="lv">”添加节点池</em> </strong>”。您也可以通过选择节点池的名称来修改节点池，例如“<strong class="ky ir"> <em class="lv"> agentpool </em> </strong>”。请注意，一旦选择了要修改的节点池(或在添加新节点池的操作过程中)，您现在还可以选择“<strong class="ky ir"> <em class="lv">每个节点的最大数量</em> </strong>”。这允许您限制将在给定节点上运行的pod的数量。因此，即使节点上还有剩余资源，如果已经达到最大数量的单元(例如，110个单元中的110个单元)，也不会向该节点部署额外的单元。<br/>我建议添加一个额外的节点池，配置为“<strong class="ky ir"> <em class="lv">用户</em> </strong>”的“<strong class="ky ir"> <em class="lv">模式</em> </strong>”和您选择的操作系统(Linux是默认的，建议使用)。然后，这个节点池将运行您的实际工作负载，而默认节点池将保持Kubernetes的运行和操作。这样，您的应用程序就不会占用可能影响底层Kubernetes系统服务的资源。</li></ul><blockquote class="ls lt lu"><p id="2217" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">抬头！</strong> <br/>如果选择默认节点池进行配置，则不能更改某些属性，如“<strong class="ky ir">模式</strong>”和“<strong class="ky ir">操作系统类型</strong>”，因为需要分别为“<strong class="ky ir">系统</strong>”和“<strong class="ky ir"> Linux </strong>”。对于额外的节点池，您可以将它们分别更改为“<strong class="ky ir">系统</strong>或“<strong class="ky ir">用户</strong>和“<strong class="ky ir"> Linux </strong>或“<strong class="ky ir"> Windows </strong>”。请记住，如果您选择“<strong class="ky ir"> Windows </strong>，您将被要求配置额外的认证属性，并且将无法使用kubenet网络插件(我们将在后面讨论)。</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/e9157c6623893ec7d65c9a21bbffe64a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hkd9nx4wqofBmVQOQM6z2g.png"/></div></div></figure><ul class=""><li id="dabe" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated"><strong class="ky ir">启用虚拟节点</strong>。如果您可能会遇到需要快速扩展来支持不可预测和随机的高突发事件(例如，一只股票的高交易量，因为它们超过收益300%！)，你可能要考虑这个选项。它将容器部署到Azure容器实例(无服务器“虚拟机”)来帮助处理负载。我强烈推荐<em class="lv">而不是</em>对<em class="lv">预期的</em>缩放事件使用此选项，因为使用容器实例所涉及的费用可能远远高于简单地调整AKS集群和相关的缩放设置。</li><li id="3d96" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky ir">启用虚拟机规模设置</strong>。如果您选择了可用性区域，则不能取消选择此选项。我想不出有多少用例是您不希望在Kubernetes实现中使用scale sets的，但是我当然也没有魔法水晶球！</li></ul><h2 id="edc2" class="nz ma iq bd mb oa ob dn mf oc od dp mj lf oe of ml lj og oh mn ln oi oj mp ok bi translated">证明</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/1f622981d2c3fc062be9815378aa61d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KWC_CfjBM3sOKfIOimvkjw.png"/></div></div></figure><ul class=""><li id="6af6" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated"><strong class="ky ir">集群基础设施</strong>。这里的选项是让AKS使用系统分配的托管身份或服务主体来管理连接到群集的云资源(如附加存储/虚拟磁盘)。如果您的组织需要管理这一点，或者减轻您的管理负担，那么服务主体可能是一个不错的选择。否则，对于本文的范围，保留默认的“<strong class="ky ir"> <em class="lv">系统分配的托管身份</em> </strong>”处于选中状态。</li><li id="4db5" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky ir"> Kubernetes认证和授权</strong>。登录后用户对群集的访问权限和能力。启用“<strong class="ky ir"> <em class="lv">基于角色的访问控制(RBAC)”</em></strong>允许权限基于用户角色，而不是逐个用户地管理。默认情况下，RBAC是启用的，我建议在任何部署中保持此<strong class="ky ir"> <em class="lv">启用</em> </strong>以及本文的范围。要使用Azure Active Directory组管理RBAC，请启用“<strong class="ky ir"> <em class="lv"> AKS管理的Azure Active Directory </em> </strong>”选项。对于本文的范围，这应该保持<strong class="ky ir"> <em class="lv">禁用</em> </strong>(默认)。</li><li id="24a4" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky ir">节点池OS磁盘加密</strong>。Azure中的资源利用微软管理的密钥进行静态和动态加密。AKS中的节点池也不例外。然而，你也可以选择BYOK(自带钥匙)。出于本文的考虑，我们将把“<strong class="ky ir"> <em class="lv">加密类型</em> </strong>”设置为<strong class="ky ir"> <em class="lv">(默认)静态加密，使用平台管理的密钥</em> </strong>。<strong class="ky ir"> <em class="lv"> </em> </strong> <br/> <br/>我们来快速切入，解释一下为什么一个组织会使用这个选项:<br/> 1 .恶意用户的窥探，这些恶意用户可能会获得对私钥的访问权。这个坏演员可能代表竞争对手，商业机密可能会被泄露。<br/> 2。如果一个密钥从另一个客户的订阅中泄露，并且微软在客户之间重复使用它(不太可能？是的。不可能？没有)。<br/> 3。为了防止政府入侵(国外或国内)和在没有适当授权或传票的情况下获取数据(让我们这么说吧，如今世界各地的政府及其领导人太经常地说，这是“你的法律，但不是我的法律”)。</li></ul><h2 id="e1cc" class="nz ma iq bd mb oa ob dn mf oc od dp mj lf oe of ml lj og oh mn ln oi oj mp ok bi translated">建立工作关系网</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/fc79d0e4ed5cd303f8c3ec74bf9bc046.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h8XownuCfAzDctzd2LA4nw.png"/></div></div></figure><ul class=""><li id="bf6e" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated"><strong class="ky ir">网络配置</strong>。这里的选项有“<strong class="ky ir"><em class="lv"/></strong>”或者“<strong class="ky ir"> <em class="lv">蔚蓝CNI </em> </strong>”。对于大多数情况来说，“<strong class="ky ir"><em class="lv">”Kubenet</em></strong>”就足够了，它为云不可知策略提供了与通用Kubernetes安装更接近的一致性。“<strong class="ky ir"> <em class="lv"> Azure CNI </em> </strong>”通常用于在更精细的级别上管理节点池和群集的VNet(虚拟网络)、子网和NSG(网络安全组)。利用“<strong class="ky ir"> <em class="lv"> Azure CNI </em> </strong>”选项的一个典型用例是防止在快速路由连接上查看时与内部网络的地址空间重叠。然而，对于本文的范围，为了简单起见，我们将把这个集合留给“<strong class="ky ir"><em class="lv">【Kubenet】</em></strong>”。</li></ul><blockquote class="ls lt lu"><p id="6d3f" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">抬起头来！ <br/>此阶段的正确选择至关重要，因为网络配置以后无法更改。以后改变这种情况的唯一方法是使用更新的网络配置和它承载的应用程序完全重新部署AKS资源。虽然这可以高度自动化，但仍然会导致不必要的、有时不可接受的停机。</p></blockquote><ul class=""><li id="c888" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated"><strong class="ky ir"> DNS名称前缀</strong>。这只是安装创建的DNS资源的前缀名称。使用我们前面讨论过的相同命名约定，一切都会好的。我们将按照<code class="fe om on oo op b"><strong class="ky ir">digital-kubernetes-dns-dev-01</strong></code>的思路输入一些东西</li><li id="f69e" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky ir">负载平衡器</strong>。选项有"<strong class="ky ir"> <em class="lv">【基本】</em> </strong>"和"<strong class="ky ir"> <em class="lv">【标准】</em> </strong>"，但是在Azure Portal中创建AKS资源时，不能从"<strong class="ky ir"> <em class="lv">【标准】</em> </strong>"进行更改(这是本系列的范围)。如果您需要一个"<strong class="ky ir"> <em class="lv">"基本</em> </strong>"负载平衡器，您将不得不利用Azure CLI或PowerShell使用ARM (Azure资源管理器)模板创建资源。</li><li id="2716" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky ir">启用HTTP应用路由</strong>。此选项创建并允许公众通过dns名称访问您的pod。这也将在您的订阅中创建一个DNS区域。此选项的目的是允许快速访问您的pod，而无需配置Kubernetes入口控制器。在本系列中，我们将使用入口控制器，因此我们将<em class="lv">而不是</em>选择“<strong class="ky ir"> <em class="lv">启用HTTP应用程序路由</em> </strong>”作为本系列的主题。</li><li id="ff80" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky ir">启用私有集群</strong>。此选项确保Kubernetes API服务器(在Azure托管订阅中)和节点池(在您的订阅中)之间的通信仅通过专用网络进行。启用此选项的替代方法是流量可以/将会在API服务器和节点池之间的订阅之间流动(通过VNets)。我们将<em class="lv">不会</em>为这个系列的范围启用这个选项。</li></ul><blockquote class="ls lt lu"><p id="6acd" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">为了更深入地了解私有集群</strong> <br/> <a class="ae kv" href="https://docs.microsoft.com/en-us/azure/aks/private-clusters" rel="noopener ugc nofollow" target="_blank">创建一个私有Azure Kubernetes服务集群——Azure Kubernetes服务|微软文档</a></p></blockquote><ul class=""><li id="d442" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated"><strong class="ky ir">设置授权IP范围</strong>。除了启用私有集群，您还可以设置一系列允许与Kubernetes API服务器通信的IP地址。我们将<em class="lv">不</em>为本系列的范围启用此选项。</li><li id="67e1" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky ir">网络政策</strong>。这个很快就会变得复杂。需要注意的重要事项是，该选项指定是否以及如何将策略应用于对特定pod的访问。此选项仅适用于Linux节点池，因为“<strong class="ky ir"> <em class="lv"> Calico </em> </strong>”和“<strong class="ky ir"> <em class="lv"> Azure </em> </strong>”选项都利用<em class="lv"> Linux IPTables </em>来实施策略。“<strong class="ky ir"> <em class="lv">无</em> </strong>”选项不应用任何网络策略(顾名思义！),“<strong class="ky ir"> <em class="lv"> Calico </em> </strong>”选项启用Calico网络策略，“<strong class="ky ir"> <em class="lv"> Azure </em> </strong>”选项启用使用Azure网络配置(VNets、子网、网络安全组等)的策略。).Azure网络仅适用于“<strong class="ky ir"> <em class="lv"> Azure CNI </em> </strong>”网络配置。对于此系列的范围，应选择“<strong class="ky ir"> <em class="lv">无</em> </strong>”选项。<br/> <br/>有关Calico的更多信息，请参见:<br/> <a class="ae kv" href="https://www.tigera.io/tigera-products/calico/" rel="noopener ugc nofollow" target="_blank">项目Calico | Tigera </a></li></ul><h2 id="96db" class="nz ma iq bd mb oa ob dn mf oc od dp mj lf oe of ml lj og oh mn ln oi oj mp ok bi translated">集成</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/b2ab6c5ffa357999342f6758fe856375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yUzODM6bht-_PYhj_uPizA.png"/></div></div></figure><p id="745e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将跳过对Integrations页面上所有选项的选择，因为它们都超出了本系列的目的范围。但是，我们<em class="lv">能不能</em>说说他们是什么！</p><ul class=""><li id="9bd3" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated">蓝色集装箱注册处。该选项将Azure容器注册表连接到AKS资源。您还可以通过选择“新建”选项来创建Azure容器注册表。稍后，我们将使用CLI工具<code class="fe om on oo op b"><strong class="ky ir">kubectl</strong></code>和我们的Azure DevOps管道进行设置。因此现在，把这个设置为“<strong class="ky ir"> <em class="lv">无</em> </strong>”。</li><li id="28b9" class="mr ms iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">Azure监视器。如果要启用对该AKS资源的监控，可以启用“<strong class="ky ir"> <em class="lv">容器监控</em> </strong>”选项，并选择适当的“<strong class="ky ir"> <em class="lv">日志分析工作区</em> </strong>”或通过选择“<strong class="ky ir"> <em class="lv">创建新的</em> </strong>”来创建一个新的。这里捕获的数据也可以通过第三方工具发送，如<em class="lv"> New Relic、Splunk、</em>和<em class="lv"> </em>许多其他工具。我们将在本系列的范围内禁用该选项，因为我们不接受指标。</li></ul><blockquote class="ls lt lu"><p id="a543" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">抬头！<br/> </strong>启用“<strong class="ky ir">集装箱监控</strong>”可以快速向您的帐户添加费用，因为每秒钟都会捕获大量指标。这并不是说不需要或不值得进行监控，这只是一个警告，以确保在收到令人讨厌的账单之前进行正确的配置！</p></blockquote><ul class=""><li id="f80b" class="mr ms iq ky b kz la lc ld lf ni lj nj ln nk lr my mz na nb bi translated">蔚蓝政策。这也超出了本系列的范围，但是对于使用Azure的成熟组织和团队来说，这无疑是一个应该启用的选项。可以在用户和角色/组级别设置策略，以管理对资源以及其他权限的修改。</li></ul><h2 id="646f" class="nz ma iq bd mb oa ob dn mf oc od dp mj lf oe of ml lj og oh mn ln oi oj mp ok bi translated">标签</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/b77bad59534c34f887da9be3a228bc40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U90YEFHGwHFNSn4Dyp9Mzg.png"/></div></div></figure><p id="bd11" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">标签对于快速定位资源、基于特定标签创建仪表板和指标以及帮助在组织内部分配计费费用非常有价值。输入您想要的任何标签，但是没有一个标签是本系列所必需的。</p><blockquote class="ls lt lu"><p id="7af2" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">建议</strong> <br/>至少，我建议在每个资源上使用以下标签:</p><p id="4bae" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">— <strong class="ky ir">环境</strong>:这应该设置为与您自己的环境分解相对应的值(例如“<strong class="ky ir"> dev </strong>”、“<strong class="ky ir"> prod </strong>”、“<strong class="ky ir"> shared </strong>”、“<strong class="ky ir"> stage </strong>”、“<strong class="ky ir"> test </strong>”等)。)</p><p id="d9ac" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">— <strong class="ky ir">部门</strong>:应设置为该资源被利用的部门名称(如“<strong class="ky ir">数字</strong>”、“<strong class="ky ir">研发</strong>”、“<strong class="ky ir">财务</strong>”等)。)</p></blockquote><h2 id="1504" class="nz ma iq bd mb oa ob dn mf oc od dp mj lf oe of ml lj og oh mn ln oi oj mp ok bi translated">审阅+创建</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/537892f00284a73e2b2f9387c91c6ba2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fA2s-BqxQ_aFHOelClMEEw.png"/></div></div></figure><p id="e44e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦Azure Portal验证了所选的配置，您就可以选择“创建”按钮并启动和运行您的AKS资源了！取决于几个因素，这可能需要五分钟到几个小时(我只见过后者一次)。平均大约二十分钟。</p><p id="5241" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">(满怀希望地)祝贺AKS部署成功！</p><h1 id="423e" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">下一个</h1><p id="4e4e" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf oy lh li lj oz ll lm ln pa lp lq lr ij bi translated">准备好继续前进并为部署容器做好准备了吗？<br/>查看<a class="ae kv" href="https://medium.com/p/1b85608e6b0d" rel="noopener"> <strong class="ky ir"> <em class="lv">第2部分—使用kubectl </em> </strong> </a>配置Kubernetes】</p></div></div>    
</body>
</html>