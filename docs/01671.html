<html>
<head>
<title>Unit Tests for Node.js APIs built with TS, Express.js and TypeORM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ts、Express.js和TypeORM构建的Node.js APIs的单元测试</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/unit-tests-for-node-js-apis-built-with-ts-express-js-and-typeorm-b6921bf92e28?source=collection_archive---------6-----------------------#2020-01-21">https://levelup.gitconnected.com/unit-tests-for-node-js-apis-built-with-ts-express-js-and-typeorm-b6921bf92e28?source=collection_archive---------6-----------------------#2020-01-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f0afaa0a610321399d0f7292403e92de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*401hTGBlrWJDNQoE4oD75w.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">作者<a class="ae kf" href="https://twitter.com/ninalimpi" rel="noopener ugc nofollow" target="_blank">卡特琳娜·林皮索妮</a></figcaption></figure><p id="a124" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几天前，我写了一篇关于如何构建Node.js REST APIs的文章。然而，我并没有涵盖任何测试场景。所以现在是时候补上这个了。</p><p id="e03d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将根据我的另一个故事中的项目结构，为单个API组件编写一个单元测试。目标是通过模仿数据库并向其路由发送HTTP请求来测试组件。</p><div class="le lf gp gr lg lh"><a href="https://medium.com/swlh/how-i-structure-my-node-js-rest-apis-4e8904ccd2fb" rel="noopener follow" target="_blank"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd iu gy z fp lm fr fs ln fu fw is bi translated">我如何构建Node.js REST APIs</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">当我开始使用Node.js在服务器端构建REST APIs时，我为“应该如何……</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">medium.com</p></div></div><div class="lq l"><div class="lr l ls lt lu lq lv jz lh"/></div></div></a></div><p id="c482" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了编写测试，我使用了以下节点模块:</p><ul class=""><li id="2c50" class="lw lx it ki b kj kk kn ko kr ly kv lz kz ma ld mb mc md me bi translated">摩卡</li><li id="2ffa" class="lw lx it ki b kj mf kn mg kr mh kv mi kz mj ld mb mc md me bi translated">柴</li><li id="33a2" class="lw lx it ki b kj mf kn mg kr mh kv mi kz mj ld mb mc md me bi translated">超级测试</li></ul><h2 id="b62a" class="mk ml it bd mm mn mo dn mp mq mr dp ms kr mt mu mv kv mw mx my kz mz na nb nc bi translated">项目结构</h2><p id="81f4" class="pw-post-body-paragraph kg kh it ki b kj nd kl km kn ne kp kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">这就是我上面提到的项目结构。当然，你也可以使用其他的。</p><pre class="ni nj nk nl gt nm nn no np aw nq bi"><span id="dd16" class="mk ml it nn b gy nr ns l nt nu">nodejs-api-structure<br/>└───src<br/>   │<br/>   └───config<br/>   │<br/>   └───api<br/>   │   │<br/>   │   └───components<br/>   │   │   │<br/>   │   │   └───user<br/>   │   │       │   controller.ts<br/>   │   │       │   model.ts<br/>   │   │       │   routes.ts<br/>   │   │       │   service.ts<br/>   │   │       │   user.spec.ts<br/>   │   │<br/>   │   └───middleware<br/>   │   │<br/>   │   │   routes.ts<br/>   │   │   server.ts<br/>   │<br/>   └───test<br/>   │   │   factory.ts<br/>   │<br/>   │   index.ts</span></pre><p id="64c5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将重点关注以下文件:</p><ul class=""><li id="b3d9" class="lw lx it ki b kj kk kn ko kr ly kv lz kz ma ld mb mc md me bi translated">工厂. ts</li><li id="f698" class="lw lx it ki b kj mf kn mg kr mh kv mi kz mj ld mb mc md me bi translated">用户规格</li></ul><h2 id="0a0d" class="mk ml it bd mm mn mo dn mp mq mr dp ms kr mt mu mv kv mw mx my kz mz na nb nc bi translated">测试工厂-工厂. ts</h2><p id="e0df" class="pw-post-body-paragraph kg kh it ki b kj nd kl km kn ne kp kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">这个文件是每个单元测试的某种设置文件。它负责数据库连接并启动Express.js服务器。</p><p id="2b1f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们使用'<em class="nv"> sqljs </em>'作为数据库类型，所以没有必要提供像MySQL或任何其他数据库那样的真实数据库。</p><p id="aca8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">实际上，代码应该是不言自明的。该类充当数据库连接和express服务器的容器。它提供了getter方法来使它们可访问，并提供了打开/关闭连接的方法。</p><figure class="ni nj nk nl gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nw"><img src="../Images/93e947d91cc826d77989c6d346351a56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mspO8QRRolRUSWKssPt3yQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">工厂. ts</figcaption></figure><h2 id="523f" class="mk ml it bd mm mn mo dn mp mq mr dp ms kr mt mu mv kv mw mx my kz mz na nb nc bi translated">组件测试-用户规格</h2><p id="e18c" class="pw-post-body-paragraph kg kh it ki b kj nd kl km kn ne kp kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">这个文件涵盖了API组件的单元测试。在那里，我们使用不同的HTTP请求方法，如<em class="nv"> POST </em>、<em class="nv"> PUT </em>、<em class="nv"> GET </em>和<em class="nv"> DELETE </em>来测试组件的API端点。</p><p id="b84b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们创建一个<code class="fe nx ny nz nn b">TestFactory</code>类和<code class="fe nx ny nz nn b">User</code>模型的新实例。<code class="fe nx ny nz nn b">mockTestUser</code>方法返回一个包含一些虚拟数据的<code class="fe nx ny nz nn b">User</code>实例。此外，我们创建了另一个实例<code class="fe nx ny nz nn b">testUserModified</code>，它具有一些修改过的属性，将用于测试<em class="nv"> PUT </em>端点。</p><figure class="ni nj nk nl gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oa"><img src="../Images/b91bd584d20219735fa1c9d83b7dabe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_FLES9kt3SLJbgxN-oX9hA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">用户规格</figcaption></figure></div><div class="ab cl ob oc hx od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="im in io ip iq"><p id="a172" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们定义Mocha的<code class="fe nx ny nz nn b">before</code>和<code class="fe nx ny nz nn b">after</code>方法。<code class="fe nx ny nz nn b">before</code>在测试开始前执行，而<code class="fe nx ny nz nn b">after</code>在测试结束后执行。</p><p id="21aa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在它们内部，我们调用工厂的<code class="fe nx ny nz nn b">init</code>和<code class="fe nx ny nz nn b">close</code>方法，这些方法在测试开始前建立一个新的数据库连接和express服务器，并在测试结束后断开连接。</p><figure class="ni nj nk nl gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oa"><img src="../Images/1b676ac021e91806d075af71379dda40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xjNlVkFe9XbksFs1nWpE3Q.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">用户规格</figcaption></figure><p id="34fb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">需要注意的一件重要事情是，当您有多个单元测试时，每个测试都会建立一个新的数据库连接和express服务器。</p><p id="48a2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了向服务器发出HTTP请求，我使用Supertest和Chai来验证服务器响应。</p></div><div class="ab cl ob oc hx od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="im in io ip iq"><p id="e7c0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是一个组件的完整代码:</p><figure class="ni nj nk nl gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oi"><img src="../Images/9854980b5b8c5b7aa1709e83c6e9a838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KiDcBpr270uUzDw_qvMWuw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">用户规格</figcaption></figure></div><div class="ab cl ob oc hx od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="im in io ip iq"><p id="2613" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">这篇文章最初发表在我的博客上。看一看。</strong></p><div class="le lf gp gr lg lh"><a href="https://larswaechter.dev/blog/nodejs-rest-api-testing/" rel="noopener  ugc nofollow" target="_blank"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd iu gy z fp lm fr fs ln fu fw is bi translated">用ts、Express.js和TypeORM构建的Node.js APIs的单元测试。</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">2020年1月8日不久前，我写了一篇关于如何构建Node.js REST APIs的文章。但是，我没有盖…</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">拉斯瓦切特.德夫</p></div></div></div></a></div></div><div class="ab cl ob oc hx od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="im in io ip iq"><p id="ce38" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我目前正在做一个兼职项目，在那里你可以看到像这样的测试场景。例如，看看那里的<code class="fe nx ny nz nn b">User</code>或<code class="fe nx ny nz nn b">Task</code>型号。</p><div class="le lf gp gr lg lh"><a href="https://github.com/Aionic-Apps/aionic-core/tree/master" rel="noopener  ugc nofollow" target="_blank"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd iu gy z fp lm fr fs ln fu fw is bi translated">Aionic-Apps/aionic-core</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">Aionic为项目管理和协作提供开源应用程序。我们的重点是简化和…</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">github.com</p></div></div><div class="lq l"><div class="oj l ls lt lu lq lv jz lh"/></div></div></a></div></div></div>    
</body>
</html>