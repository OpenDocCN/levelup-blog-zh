<html>
<head>
<title>Create AWS RDS MySQL instance with a secured master password using CloudFormation template</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CloudFormation模板创建带有安全主密码的AWS RDS MySQL实例</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/create-aws-rds-mysql-instance-with-a-secured-master-password-using-cloudformation-template-c3a767062972?source=collection_archive---------11-----------------------#2020-10-13">https://levelup.gitconnected.com/create-aws-rds-mysql-instance-with-a-secured-master-password-using-cloudformation-template-c3a767062972?source=collection_archive---------11-----------------------#2020-10-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/316c2343504b1c07c97121778cbf6d3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nPzaOvAqjxvN8Uze5kRQ1Q.jpeg"/></div></div></figure><p id="04c0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最近，我正在用CloudFormation模板创建一个MySQL RDS实例。尽管有大量来自AWS官员或社区的文档在讨论这个问题，但我觉得没有多少文档深入探讨如何确保主用户密码的安全。</p><p id="290e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当创建MySQL实例时，RDS将创建一个“主用户”,拥有管理数据库所需的所有权限。不考虑<a class="ae la" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html#cfn-rds-dbinstance-masterusername" rel="noopener ugc nofollow" target="_blank">云信息引用</a>所说的<em class="kz"> MasterUsername </em>和<em class="kz"> MasterUserPassword </em>，它们需要创建一个MySQL RDS实例。如果模板中没有提供它们，您将得到一个错误“<em class="kz">属性MasterUserPassword不能为空</em>”。将明文密码放在临时模板中可能没问题，但如果我要将模板提交给任何源代码控制系统，我一定是疯了。此外，我希望将密码安全地存储在比便利贴更好的地方。</p><p id="7c9c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">问题来了:如何指定一个<em class="kz"> MasterUserPassword </em>不是明文，可以存储在AWS上？答案是另一项AWS服务——Secrets Manager。</p><p id="894c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我不打算写已经在秘密经理的官方文件中的东西。相反，让我们得出结论，我们将需要Secrets Manager中的一个秘密、KMS中用于加密和解密该秘密的CMK，以及在创建RDS实例时使用该秘密的方法。</p><p id="f317" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是云层模板:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="1fb1" class="lk ll it lg b gy lm ln l lo lp">---<br/>Parameters:<br/>  MySQLMasterUserName:<br/>    Type: String<br/>    Default: admin<br/>    Description: Database admin user name for MySQL</span><span id="2bbf" class="lk ll it lg b gy lq ln l lo lp">Resources:<br/>  MySQLSecretKey:<br/>    Type: AWS::KMS::Key<br/>    Properties:<br/>      KeyPolicy:<br/>        Statement:<br/>          - Sid: "Enable IAM User Permissions"<br/>            Effect: "Allow"<br/>            Principal:<br/>              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root<br/>            Action: "kms:*"<br/>            Resource: "*"<br/><br/>  MySQLSecret:<br/>    Type: AWS::SecretsManager::Secret<br/>    Properties:<br/>      KmsKeyId: !Ref MySQLSecretKey<br/>      GenerateSecretString:<br/>        SecretStringTemplate: !Join [ '', [ '{"username": "', !Ref MySQLMasterUserName, '"}' ] ]<br/>        GenerateStringKey: 'password'<br/>        PasswordLength: 16<br/>        ExcludeCharacters: '"@/\'<br/><br/>  MySQLInstance:<br/>    Type: AWS::RDS::DBInstance<br/>    Properties:<br/>      DBInstanceClass: !Ref MySQLDBInstanceClass<br/>      DBName: !Ref MySQLDBName<br/>      Engine: "MySQL"<br/>      EngineVersion: "8.0.20"<br/>      MasterUsername: !Ref MySQLMasterUserName<br/>      MasterUserPassword: !Join [ '', [ '{{resolve:secretsmanager:', !Ref MySQLSecret, ':SecretString:password}}' ] ]<br/>      StorageType: gp2<br/>      AllocatedStorage: 20<br/>  <em class="kz">    </em>AvailabilityZone: !GetAtt PrivateSubnet1.AvailabilityZone<br/>      MultiAZ: False<br/>      Port: !Ref MySQLPort<br/>      DBSubnetGroupName: !Ref MySQLSubnetGroup<br/>      PubliclyAccessible: True<br/>      VPCSecurityGroups:<br/>        - !Ref MySQLSecurityGroup</span></pre><p id="916a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我想在此模板中进一步解释一些元素:</p><ol class=""><li id="97e8" class="lr ls it kd b ke kf ki kj km lt kq lu ku lv ky lw lx ly lz bi translated">这个秘密将被生成为类似<em class="kz"> {"username": "admin "，" password": "super_secure"} </em>的JSON字符串。RDS还会将一些其他信息放入这个秘密中，比如RDS实例的主机名、DB名称等。我可以在AWS控制台中检索密码，或者通过调用API <a class="ae la" href="https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html" rel="noopener ugc nofollow" target="_blank"> GetSecretValue </a>以编程方式进行检索。但是因为这是主用户凭证，所以我不会在应用程序中的任何地方使用它，它应该只在我需要管理DB实例时使用。</li><li id="79b9" class="lr ls it kd b ke ma ki mb km mc kq md ku me ky lw lx ly lz bi translated">在MySQL实例的模板中，用<em class="kz">{ { resolve:Secrets Manager:SECRET _ ARN:SECRET string:password } }</em>引用Secrets Manager中的秘密是神奇的成分。请参考此<a class="ae la" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/dynamic-references.html#dynamic-references-secretsmanager" rel="noopener ugc nofollow" target="_blank">文档</a>以获得更多解释。</li></ol><p id="6fee" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">围绕这个模板还有一些其他的主题，比如将它与VPC的一个安全组相关联，自动循环这个秘密，等等。我想我会在以后的文章中提到它们。希望这篇文章能对你有点帮助！</p></div></div>    
</body>
</html>