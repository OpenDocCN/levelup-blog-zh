<html>
<head>
<title>React lazy image loading and TypeScript — No more slow and broken images</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反应迟缓的图像加载和打字稿-不再有缓慢和破碎的图像</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/react-lazy-load-image-e6a5ca944f32?source=collection_archive---------1-----------------------#2020-10-16">https://levelup.gitconnected.com/react-lazy-load-image-e6a5ca944f32?source=collection_archive---------1-----------------------#2020-10-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/bf357e2395a53a115f197c2290f10e51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9h3c9pDvOwDu38AH"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">照片由<a class="ae jd" href="https://unsplash.com/@sigmund?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">西格蒙德</a>在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><div class=""/><p id="0494" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创造一个更好的UX并不像看起来那么简单。页面上的每个组件都很重要。在处理一段复杂的代码时，我们几乎忘记了最简单的事情，一个损坏的图像。</p><p id="bccc" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本教程中，我将解释如何在不破坏现有代码的情况下创建一个简单的<code class="fe lb lc ld le b">Image</code>组件。该组件将支持延迟加载和损坏的图像。</p><h2 id="0b29" class="lf lg jg bd lh li lj dn lk ll lm dp ln ko lo lp lq ks lr ls lt kw lu lv lw lx bi translated">1.创建图像组件</h2><p id="7d5c" class="pw-post-body-paragraph kd ke jg kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">首先，在组件库中创建一个文件夹，并创建一个名为<code class="fe lb lc ld le b">index.tsx</code>的文件。</p><pre class="md me mf mg gt mh le mi mj aw mk bi"><span id="bed6" class="lf lg jg le b gy ml mm l mn mo">mkdir -p components/Image<br/>touch components/Image/index.tsx</span></pre><p id="204e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">给<code class="fe lb lc ld le b">index.tsx</code>加上下面一行。</p><pre class="md me mf mg gt mh le mi mj aw mk bi"><span id="7c4e" class="lf lg jg le b gy ml mm l mn mo">// components/Image/index.tsx<br/><br/>import React from "react";</span><span id="6fd7" class="lf lg jg le b gy mp mm l mn mo">interface ImageProps extends React.ImgHTMLAttributes&lt;HTMLImageElement&gt; {}</span><span id="2d50" class="lf lg jg le b gy mp mm l mn mo">export default ({ ...props }: ImageProps) =&gt; {<br/>  return &lt;img {...props} /&gt;;<br/>};</span></pre><p id="f817" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">注意:</strong>我使用typescript来构建这个组件。如果您的项目不支持typescript，您可以删除键入。</p><h2 id="dab0" class="lf lg jg bd lh li lj dn lk ll lm dp ln ko lo lp lq ks lr ls lt kw lu lv lw lx bi translated">2.如何在App页面消费</h2><p id="5eef" class="pw-post-body-paragraph kd ke jg kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">您可以像使用<strong class="kf jh"> img </strong> HTML元素一样使用<strong class="kf jh"> Image </strong>组件。因为这个图像组件扩展了<code class="fe lb lc ld le b">HTMLImageElement.</code>，所以它支持所有的图像属性。</p><pre class="md me mf mg gt mh le mi mj aw mk bi"><span id="e0f8" class="lf lg jg le b gy ml mm l mn mo">// App.tsx</span><span id="638b" class="lf lg jg le b gy mp mm l mn mo">import React from "react";<br/>import Image from "./components/Image";</span><span id="ad83" class="lf lg jg le b gy mp mm l mn mo">function App() {<br/>  return (<br/>    &lt;div className="App"&gt;<br/>      &lt;section className="section"&gt;<br/>        &lt;div className="container"&gt;<br/>          &lt;h1 className="title"&gt;React Components Demo&lt;/h1&gt;<br/>          &lt;p className="subtitle"&gt;Lazy Image&lt;/p&gt;<br/>          <strong class="le jh">&lt;Image<br/>            style={{ width: 400, height: 300 }}<br/>            src="</strong><a class="ae jd" href="https://upload.wikimedia.org/wikipedia/commons/f/ff/Pizigani_1367_Chart_10MB.jpg" rel="noopener ugc nofollow" target="_blank"><strong class="le jh">https://upload.wikimedia.org/wikipedia/commons/f/ff/Pizigani_1367_Chart_10MB.jpg</strong></a><strong class="le jh">"<br/>          /&gt;</strong><br/>          &lt;br /&gt;<br/>          &lt;Image src="<a class="ae jd" href="https://doesnot.exits.com/image.png" rel="noopener ugc nofollow" target="_blank">https://doesnot.exits.com/image.png</a>" /&gt;<br/>        &lt;/div&gt;<br/>      &lt;/section&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span><span id="888a" class="lf lg jg le b gy mp mm l mn mo">export default App;</span></pre><p id="ef80" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尝试重新加载页面，你会发现图像加载非常缓慢。这是因为图像是<code class="fe lb lc ld le b">10mb</code>大。同时另一个图像将被打破。</p><figure class="md me mf mg gt is gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/e21460e50c1b22567d6d5b3de2a84910.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*19TfeH-frMkQnbM0"/></div></figure><h2 id="f410" class="lf lg jg bd lh li lj dn lk ll lm dp ln ko lo lp lq ks lr ls lt kw lu lv lw lx bi translated">3.添加默认图像道具(占位符)</h2><p id="6bbd" class="pw-post-body-paragraph kd ke jg kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">让我们添加一个默认的图像道具，修改界面。</p><pre class="md me mf mg gt mh le mi mj aw mk bi"><span id="ccfa" class="lf lg jg le b gy ml mm l mn mo">// components/Image/index.tsx</span><span id="89fc" class="lf lg jg le b gy mp mm l mn mo">interface ImageProps extends React.ImgHTMLAttributes&lt;HTMLImageElement&gt; {<br/>  <strong class="le jh">placeholderImg?: string;</strong><br/>}</span></pre><p id="1e0c" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用此<code class="fe lb lc ld le b">placeholderImg</code>图像，并在加载实际图像之前向用户显示此图像。</p><pre class="md me mf mg gt mh le mi mj aw mk bi"><span id="dba0" class="lf lg jg le b gy ml mm l mn mo">// components/Image/index.tsx<br/><br/>export default ({ placeholderImg, src, ...props }: ImageProps) =&gt; {<br/>  <strong class="le jh">const [imgSrc, setSrc] = useState(placeholderImg || src);</strong><br/>  return &lt;img {...props} src={imgSrc} /&gt;;<br/>};</span></pre><p id="bba0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在问题来了，如果我们显示一个占位符图像，那么我们将如何加载实际的图像。</p><figure class="md me mf mg gt is gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/acbe559f0be8964c084e8118ff8c3997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/0*gZ94Ja2Nxm5WgKWJ.jpg"/></div></figure><h2 id="a1b5" class="lf lg jg bd lh li lj dn lk ll lm dp ln ko lo lp lq ks lr ls lt kw lu lv lw lx bi translated">4.动态加载图像</h2><p id="3dd6" class="pw-post-body-paragraph kd ke jg kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">为此，我们将使用JavaScript中的<strong class="kf jh">图像类</strong>。我们将动态创建一个图像，并向其中添加一个事件侦听器。</p><pre class="md me mf mg gt mh le mi mj aw mk bi"><span id="f851" class="lf lg jg le b gy ml mm l mn mo">// components/Image/index.tsx</span><span id="670e" class="lf lg jg le b gy mp mm l mn mo">export default ({ src, placeholderImg, ...props }: ImageProps) =&gt; {<br/>  const [imgSrc, setSrc] = useState(placeholderImg || src);</span><span id="3054" class="lf lg jg le b gy mp mm l mn mo">  <strong class="le jh">const onLoad = useCallback(() =&gt; {<br/>    setSrc(src);<br/>  }, [src]);</strong></span><span id="25f2" class="lf lg jg le b gy mp mm l mn mo">  useEffect(() =&gt; {<br/>    <strong class="le jh">const img = new Image();<br/>    img.src = src as string;<br/>    img.addEventListener("load", onLoad);</strong></span><span id="001f" class="lf lg jg le b gy mp mm l mn mo">    return () =&gt; {<br/>      <strong class="le jh">img.removeEventListener("load", onLoad);</strong><br/>    };</span><span id="cb46" class="lf lg jg le b gy mp mm l mn mo">  }, [src, onLoad]);</span><span id="f0c8" class="lf lg jg le b gy mp mm l mn mo">  return &lt;img {...props} alt={imgSrc} src={imgSrc} /&gt;;<br/>};</span></pre><p id="4899" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里我们使用<strong class="kf jh"> useEffect </strong>来创建图像并将其加载到后台。我们可以使用<code class="fe lb lc ld le b">addEventListener</code>来监听加载事件。一旦图像被加载，我们可以用实际的src URL替换src。因为图像已经加载并缓存到浏览器中。下一次装货马上就要开始了。</p><p id="4147" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ms">因为我们在装载组件时向映像添加了事件监听器和错误监听器。我们应该在卸载组件时移除。</em></p><p id="bb09" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们来修改一下App代码。</p><pre class="md me mf mg gt mh le mi mj aw mk bi"><span id="adfe" class="lf lg jg le b gy ml mm l mn mo">// App.tsx</span><span id="13cb" class="lf lg jg le b gy mp mm l mn mo">import React from "react";<br/>import Image from "./components/Image";</span><span id="6f8d" class="lf lg jg le b gy mp mm l mn mo">function App() {<br/>  return (<br/>    &lt;div className="App"&gt;<br/>      &lt;section className="section"&gt;<br/>        &lt;div className="container"&gt;<br/>          &lt;h1 className="title"&gt;React Components Demo&lt;/h1&gt;<br/>          &lt;p className="subtitle"&gt;Lazy Image&lt;/p&gt;<br/>          <strong class="le jh">&lt;Image<br/>  style={{width: 400, height: 300 }} <br/>  placeholderImg="</strong><a class="ae jd" href="https://via.placeholder.com/400x200.png?text=This+Will+Be+Shown+Before+Load" rel="noopener ugc nofollow" target="_blank"><strong class="le jh">https://via.placeholder.com/400x200.png?text=This+Will+Be+Shown+Before+Load</strong></a><strong class="le jh">"<br/>  src="</strong><a class="ae jd" href="https://upload.wikimedia.org/wikipedia/commons/f/ff/Pizigani_1367_Chart_10MB.jpg" rel="noopener ugc nofollow" target="_blank"><strong class="le jh">https://upload.wikimedia.org/wikipedia/commons/f/ff/Pizigani_1367_Chart_10MB.jpg</strong></a><strong class="le jh">"<br/>/&gt;</strong><br/>          &lt;br /&gt;<br/>          <strong class="le jh">&lt;Image<br/>  placeholderImg="</strong><a class="ae jd" href="https://via.placeholder.com/400x200.png?text=This+Will+Be+Shown+Before+Load" rel="noopener ugc nofollow" target="_blank"><strong class="le jh">https://via.placeholder.com/400x200.png?text=This+Will+Be+Shown+Before+Load</strong></a><strong class="le jh">"<br/>  src="</strong><a class="ae jd" href="https://doesnot.exits.com/image.png" rel="noopener ugc nofollow" target="_blank"><strong class="le jh">https://doesnot.exits.com/image.png</strong></a><strong class="le jh">"<br/>/&gt;</strong><br/>        &lt;/div&gt;<br/>      &lt;/section&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span><span id="014e" class="lf lg jg le b gy mp mm l mn mo">export default App;</span></pre><figure class="md me mf mg gt is gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/c5fb3743e7f8c768d6b72955201ca5f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/0*PweTYN2Taxeqt6lo"/></div></figure><p id="b429" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ms">如果您注意到，第二个图像仍然显示占位符图像。由于图像从未加载成功，所以</em> <code class="fe lb lc ld le b"><em class="ms">setSrc</em></code> <em class="ms">从未被调用。</em></p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h2 id="151f" class="lf lg jg bd lh li lj dn lk ll lm dp ln ko lo lp lq ks lr ls lt kw lu lv lw lx bi translated">5.处理图像加载错误</h2><p id="4670" class="pw-post-body-paragraph kd ke jg kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">让我们来处理图像加载错误。为此，让我们添加另一个属性<strong class="kf jh"> errorImg </strong>和<strong class="kf jh">T3】监听<strong class="kf jh">的错误</strong>状态。</strong></p><pre class="md me mf mg gt mh le mi mj aw mk bi"><span id="30bd" class="lf lg jg le b gy ml mm l mn mo">// components/Image/index.tsx</span><span id="1dea" class="lf lg jg le b gy mp mm l mn mo">import React, { useCallback, useEffect, useState } from "react";</span><span id="57ca" class="lf lg jg le b gy mp mm l mn mo">interface ImageProps extends React.ImgHTMLAttributes&lt;HTMLImageElement&gt; {<br/>  placeholderImg?: string;<br/> <strong class="le jh"> errorImg?: string;</strong><br/>}</span><span id="097d" class="lf lg jg le b gy mp mm l mn mo">export default ({ src, placeholderImg, errorImg, ...props }: ImageProps) =&gt; {<br/>  const [imgSrc, setSrc] = useState(placeholderImg || src);<br/>  const onLoad = useCallback(() =&gt; {<br/>    setSrc(src);<br/>  }, [src]);</span><span id="a8b7" class="lf lg jg le b gy mp mm l mn mo">  <strong class="le jh">const onError = useCallback(() =&gt; {<br/>    setSrc(errorImg || placeholderImg);<br/>  }, [errorImg, placeholderImg]);</strong></span><span id="40b9" class="lf lg jg le b gy mp mm l mn mo">  useEffect(() =&gt; {<br/>    const img = new Image();<br/>    img.src = src as string;<br/>    img.addEventListener("load", onLoad);</span><span id="027a" class="lf lg jg le b gy mp mm l mn mo">    <strong class="le jh">img.addEventListener("error", onError);</strong></span><span id="10cb" class="lf lg jg le b gy mp mm l mn mo">    return () =&gt; {<br/>      img.removeEventListener("load", onLoad);<br/>      <strong class="le jh">img.removeEventListener("error", onError);</strong><br/>    };</span><span id="589b" class="lf lg jg le b gy mp mm l mn mo">  }, [src, onLoad, onError]);<br/>  return &lt;img {...props} alt={imgSrc} src={imgSrc} /&gt;;<br/>};</span></pre><p id="f89a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们来修改一下App代码。</p><pre class="md me mf mg gt mh le mi mj aw mk bi"><span id="1d08" class="lf lg jg le b gy ml mm l mn mo">// App.tsx</span><span id="69d0" class="lf lg jg le b gy mp mm l mn mo">import React from "react";<br/>import Image from "./components/Image";</span><span id="2262" class="lf lg jg le b gy mp mm l mn mo">function App() {<br/>  return (<br/>    &lt;div className="App"&gt;<br/>      &lt;section className="section"&gt;<br/>        &lt;div className="container"&gt;<br/>          &lt;h1 className="title"&gt;React Components Demo&lt;/h1&gt;<br/>          &lt;p className="subtitle"&gt;Lazy Image&lt;/p&gt;<br/>          &lt;Image<br/>            style={{ width: 400, height: 300 }}<br/>            placeholderImg="<a class="ae jd" href="https://via.placeholder.com/400x200.png?text=This+Will+Be+Shown+Before+Load" rel="noopener ugc nofollow" target="_blank">https://via.placeholder.com/400x200.png?text=This+Will+Be+Shown+Before+Load</a>"<br/>            src="<a class="ae jd" href="https://upload.wikimedia.org/wikipedia/commons/f/ff/Pizigani_1367_Chart_10MB.jpg" rel="noopener ugc nofollow" target="_blank">https://upload.wikimedia.org/wikipedia/commons/f/ff/Pizigani_1367_Chart_10MB.jpg</a>"<br/>          /&gt;<br/>          &lt;br /&gt;<br/>          &lt;Image<br/>            <strong class="le jh">errorImg="</strong><a class="ae jd" href="https://image.shutterstock.com/image-vector/no-image-available-vector-illustration-260nw-744886198.jpg" rel="noopener ugc nofollow" target="_blank"><strong class="le jh">https://image.shutterstock.com/image-vector/no-image-available-vector-illustration-260nw-744886198.jpg</strong></a><strong class="le jh">"</strong><br/>            placeholderImg="<a class="ae jd" href="https://via.placeholder.com/400x200.png?text=This+Will+Be+Shown+Before+Load" rel="noopener ugc nofollow" target="_blank">https://via.placeholder.com/400x200.png?text=This+Will+Be+Shown+Before+Load</a>"<br/>            src="<a class="ae jd" href="https://doesnot.exits.com/image.png" rel="noopener ugc nofollow" target="_blank">https://doesnot.exits.com/image.png</a>"<br/>          /&gt;<br/>        &lt;/div&gt;<br/>      &lt;/section&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span><span id="a835" class="lf lg jg le b gy mp mm l mn mo">export default App;</span></pre><figure class="md me mf mg gt is gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/c7dc3ac94001034d7832bf49f40f31aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*nJRg4Ic87ULryG5woYl7ug.png"/></div></figure><p id="a67e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">结论:</strong>现在我们已经用相同的组件实现了破损图像和延迟加载图像。</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><p id="3487" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">注意:</strong>您可以将占位符图像用作加载器，并在加载实际图像之前显示加载图像。为此，您可以使用过渡动画或Gif。</p><p id="e308" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh"> CodeSandbox Domo: </strong></p><figure class="md me mf mg gt is"><div class="bz fp l di"><div class="nc nd l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated"><strong class="ak"> CodeSandbox Domo: </strong></figcaption></figure><p id="0c40" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">谢谢你的支持。你可以在GitHub Repo中找到所有代码:<a class="ae jd" href="https://github.com/deepakshrma/react-components" rel="noopener ugc nofollow" target="_blank">deepakshrma/react-components</a></p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><p id="80ce" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ms">最初发布于</em><a class="ae jd" href="https://blog.decipher.dev/lazy-load-image-react-typescript" rel="noopener ugc nofollow" target="_blank"><em class="ms">https://blog . decipe . dev</em></a><em class="ms">。</em></p></div></div>    
</body>
</html>