<html>
<head>
<title>Build An Image Classifier For Detecting Viral Pneumonia, Bacterial Pneumonia With Azure AI And Unity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用天蓝色AI和Unity构建用于检测病毒性肺炎、细菌性肺炎的图像分类器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/build-an-image-classifier-for-detecting-viral-pneumonia-bacterial-pneumonia-with-azure-ai-and-ae616b4d3b59?source=collection_archive---------10-----------------------#2020-10-07">https://levelup.gitconnected.com/build-an-image-classifier-for-detecting-viral-pneumonia-bacterial-pneumonia-with-azure-ai-and-ae616b4d3b59?source=collection_archive---------10-----------------------#2020-10-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/6798843b57e557f6d2434163a80cecde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vJKXATl2JmvPDDlPTa3EnA.png"/></div></div></figure><blockquote class="kb"><p id="7df1" class="kc kd it bd ke kf kg kh ki kj kk kl dk translated">安东尼奥·古特雷斯的《现在是团结的时候了》</p></blockquote><h1 id="a1b3" class="km kn it bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">为什么用AI检测病毒性肺炎，细菌性肺炎？</h1><p id="e4ae" class="pw-post-body-paragraph lk ll it lm b ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg kl im bi translated">世界因2020年的新冠肺炎疫情而改变。世界各地的医务人员在抗击新冠肺炎的战斗中表现出了勇敢和坚韧，有些人甚至在履行职责时献出了生命。作为一个普通人，作为一个程序员，我也想帮忙。所以用AI来尝试帮助诊断肺部疾病，比如病毒性肺炎，细菌性肺炎，是我有兴趣尝试的一个想法。</p><p id="d443" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">我是Azure和Unity的拥护者，所以我的第一个想法是用Azure和Unity实现一个可以用于肺部胸片的图像分类器。除了游戏行业，Unity还可以在其他行业发挥作用，所以我觉得把Azure和Unity结合起来，创造一些对人有帮助的功能，是一个很有意思的想法。</p><h1 id="b955" class="km kn it bd ko kp kq kr ks kt ku kv kw kx mm kz la lb mn ld le lf mo lh li lj bi translated">Azure认知服务</h1><p id="5603" class="pw-post-body-paragraph lk ll it lm b ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg kl im bi translated">Azure是一个云计算平台，它也为开发者提供人工智能服务。<a class="ae mp" href="https://azure.microsoft.com/en-us/services/cognitive-services/" rel="noopener ugc nofollow" target="_blank"> Azure Cognitive Services </a>是一个全面的人工智能服务和认知API系列，可帮助您构建智能应用。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mq"><img src="../Images/7c92c80b302d06f6f50e81342f4ad3e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l0kKtnHp8W1hOdPcsG_SBg.png"/></div></div></figure><p id="70ac" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">如上图所示，Azure Cognitive Servies包含许多不同类型的人工智能服务，如决策服务、语言服务、语音服务、视觉服务和网络搜索服务。</p><p id="38e8" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">我们需要的是人工智能视觉服务。通过使用视觉服务，我们可以识别和分析图像、视频和数字墨水中的内容。为了训练我们自己的模型，我们可以选择视觉服务的定制视觉服务来定制图像识别以符合我们的需求。</p><h1 id="2f57" class="km kn it bd ko kp kq kr ks kt ku kv kw kx mm kz la lb mn ld le lf mo lh li lj bi translated">创建自定义Vision项目并获取数据集</h1><p id="3ac6" class="pw-post-body-paragraph lk ll it lm b ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg kl im bi translated">Azure提供的自定义视觉服务为我们开发和部署自定义计算机视觉模型提供了一个用户友好的界面。在下图中，您可以找到创建符合我们用例的自定义计算机视觉模型的过程。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mv"><img src="../Images/012bb7d47a97f151ff5a8d027c95e0d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1JU_UQt-g-w1DZBicx4ETA.png"/></div></div></figure><p id="4dd5" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">因此，让我们创建自定义视觉项目，并在线获取合适的数据集。</p><div class="mw mx gp gr my mz"><a href="https://www.customvision.ai/" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd iu gy z fp ne fr fs nf fu fw is bi translated">自定义视觉-主页</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">带上您自己的已标记图像，或使用自定义视觉快速添加标签到任何未标记的图像。使用您的标签…</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">www.customvision.ai</p></div></div></div></a></div><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ni"><img src="../Images/60c8902ac1e5859c316751827a79f9ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lpQMg7iDZ5_yCjxs-iLZVA.png"/></div></div></figure><p id="4146" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">我们需要做的第一件事是在Custom Vision站点上创建一个项目。我们应该确定项目的名称，并创建一个新的Azure认知服务资源(如果不存在的话)。项目类型有两种选择，<em class="nj">分类</em>和<em class="nj">物体检测</em>。在我们的例子中，我选择分类类型。</p><p id="cbbe" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">第二件事是寻找一个合适的数据集，这些图像用于稍后训练我们的模型。在这种情况下，我将使用Paul Mooney的数据集，您可以在这里找到它<a class="ae mp" href="https://www.kaggle.com/paultimothymooney/chest-xray-pneumonia" rel="noopener ugc nofollow" target="_blank"/>。数据集中有5，863张x光图像(JPEG)和2个类别(肺炎/正常)。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/6e91a1a11d6a502cc9cc0f7a193bc05a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/0*67ArNS_wMfMHlc1h.png"/></div></figure><p id="c098" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">正常的胸部x光片(左图)描绘了清晰的肺部，图像中没有任何异常浑浊的区域。细菌性肺炎(中)典型地表现为局灶性肺叶实变，在本例中为右上叶(白色箭头)，而病毒性肺炎(右)表现为两肺弥漫性“间质”样改变。</p><h1 id="193b" class="km kn it bd ko kp kq kr ks kt ku kv kw kx mm kz la lb mn ld le lf mo lh li lj bi translated">训练模型</h1><p id="acde" class="pw-post-body-paragraph lk ll it lm b ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg kl im bi translated">在网站上训练我们的计算机视觉模型非常容易。首先要选择合适的图片，用标签上传到我们创建的项目中。在这种情况下，我将使用三个标签对三组图像进行分类，分别是<em class="nj">病毒</em> <em class="nj">肺炎</em><em class="nj">细菌性肺炎</em><em class="nj"/>和<em class="nj">正常</em>。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nl"><img src="../Images/90bc8d2d76e927533ecd4d294b4384aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z7vhjUWEkoqZu9S5WPiSyg.png"/></div></div></figure><p id="06fb" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">选择适当数量的图像是一个好主意，所以我为每个标签选择了大约70张图像进行训练。</p><p id="11d6" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">然后点击网站右上角的培训按钮，会弹出一个窗口供您选择培训类型。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nm"><img src="../Images/bac937dc0449adfbbc499b98b68181fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCgsYkWDhT-g1ctlcPpK4w.png"/></div></div></figure><p id="0c55" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">我选择的是高级培训类型，培训预算是12小时。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nn"><img src="../Images/c75e07ca08d5cf00a5a5665c3b4f3b5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pcXbAga92rRdRiSgYCpX9w.png"/></div></div></figure><p id="38fd" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">训练结束后，我们可以在性能页面上看到结果。为了测试这个模型，我们可以通过网站上的快速测试功能快速测试它。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/d9662c75b66fbcae9b383ad195d3b00d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LRZ6pgQDAmbj5y9W1dy9kw.png"/></div></div></figure><h1 id="289e" class="km kn it bd ko kp kq kr ks kt ku kv kw kx mm kz la lb mn ld le lf mo lh li lj bi translated">整合Azure和Unity</h1><p id="7712" class="pw-post-body-paragraph lk ll it lm b ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg kl im bi translated">现在，我们得到了一个训练有素的计算机视觉模型和一个API来根据标签对图像进行分类。</p><p id="50f6" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">然而，我想将功能集成到Unity中。好在微软提供了C#语言的Azure自定义Vision SDK。所以我觉得把它们整合起来是有可能的，即使我想在Mac OS上运行。</p><p id="1da6" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">从Unity 2018开始，我们得到一个<strong class="lm iu">。net standard 2.0 </strong>兼容级别，对于Nuget包应该是完美的。只需使用一个单独的VS项目下载这个包，然后将netstandard20版本的DLL放到我们的Unity项目中。我做了一个. unitypackage文件，包含了这些需要的dll，你可以从<a class="ae mp" href="https://github.com/chenjd/Unity.DetectPneumoniaWithAzure/releases/tag/SDK" rel="noopener ugc nofollow" target="_blank">这里</a>下载。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi np"><img src="../Images/15801926fb031f187569e5d5460fa7f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kl0QbnBgMg0y2R_aiec2Jg.png"/></div></div></figure><p id="c72d" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">你可以在上图中看到我们在项目中需要的dll。</p><p id="56ba" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">然后我将在我们的Unity项目中设置C#代码。</p><pre class="mr ms mt mu gt nq nr ns nt aw nu bi"><span id="66f7" class="nv kn it nr b gy nw nx l ny nz">void <strong class="nr iu">Start</strong>()<br/>{<br/>    var ENDPOINT = Environment.GetEnvironmentVariable("CUSTOM_VISION_ENDPOINT");<br/><br/>    var predictionKey = Environment.GetEnvironmentVariable("CUSTOM_VISION_PREDICTION_KEY");<br/><br/>    _prediction = new CustomVisionPredictionClient(new Microsoft.Azure.CognitiveServices.Vision.CustomVision.Prediction.ApiKeyServiceClientCredentials(predictionKey))<br/>    {<br/>        Endpoint = ENDPOINT<br/>    };<br/>}</span></pre><p id="12b5" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">首先，我在Unity的<em class="nj"> Start </em>方法中设置环境并创建一个<em class="nj">CustomVisionPredictionClient</em>的实例。正如您在上面的代码中看到的，我们需要自定义Vision资源的<em class="nj">端点</em>和同一资源的<em class="nj">键</em>来设置Unity中的环境。</p><p id="01e7" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">您可以在自定义Vision项目站点的设置窗口中找到它们。你可以在下图中看到它。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oa"><img src="../Images/e0bfa76af74c74176adde3932cd49b42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GGcwh8c30_nNIDP2gNpxXw.png"/></div></div></figure><p id="71d1" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">如果设置不正确，您将无法连接到正确的认知服务资源。</p><p id="c441" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">然后我们可以调用<em class="nj">CustomVisionPredictionClient</em>的<code class="fe ob oc od nr b">ClassifyImage</code>方法来<em class="nj">对输入的图像进行分类。</em></p><pre class="mr ms mt mu gt nq nr ns nt aw nu bi"><span id="b7b8" class="nv kn it nr b gy nw nx l ny nz">byte[] bytes = sprite.texture.<strong class="nr iu">EncodeToPNG</strong>();<br/>_testStream = new MemoryStream(bytes);<br/><br/>var publishedModelName = "Iteration2";<br/>var result = _prediction.<strong class="nr iu">ClassifyImage</strong>(_project.Id, publishedModelName, _testStream);</span></pre><p id="7899" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">您需要提供项目的id，您也可以在您的项目站点上找到它，以及publishedModelName，您正在使用的模型(迭代)的名称。您可以在项目网站的性能页面上找到此名称。您需要提供的最后一个参数是输入图像的数据。</p><p id="88df" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">为了将Unity上下文中的纹理转换成所需的MemoryStream实例，我们调用texture的<code class="fe ob oc od nr b">EncodeToPNG</code>方法将纹理转换成字节数组，然后创建相应的MemoryStream实例。</p><p id="780b" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">最后，让我们添加一些胸部x光图像来测试Unity中的功能。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oe"><img src="../Images/63518eb665429a89fbbee4db1c0b8db2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l45ETUQmHbFMsnGyYmZ3fw.png"/></div></div></figure><p id="ac2a" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">然后你可以在下面的视频中看到，我们的Unity项目现在可以正确地对胸部x光图像进行分类。</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="90eb" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">你可以在这里找到Unity项目回购(不包括Azure部分):</p><p id="3deb" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated"><a class="ae mp" href="https://github.com/chenjd/Unity.DetectPneumoniaWithAzure" rel="noopener ugc nofollow" target="_blank">https://github.com/chenjd/Unity.DetectPneumoniaWithAzure</a></p></div><div class="ab cl oh oi hx oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="im in io ip iq"><p id="4e08" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">感谢您的阅读，希望对您有所帮助。</p><p id="8c85" class="pw-post-body-paragraph lk ll it lm b ln mh lp lq lr mi lt lu lv mj lx ly lz mk mb mc md ml mf mg kl im bi translated">在<a class="ae mp" href="https://www.linkedin.com/in/chenjd/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/chenjd/</a>聊天</p></div></div>    
</body>
</html>