<html>
<head>
<title>Sharing Output Variables between Stages in Azure DevOps Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Azure DevOps管道中的阶段之间共享输出变量</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/sharing-variables-between-stages-in-azure-devops-pipelines-59eb8decf3b0?source=collection_archive---------9-----------------------#2022-04-08">https://levelup.gitconnected.com/sharing-variables-between-stages-in-azure-devops-pipelines-59eb8decf3b0?source=collection_archive---------9-----------------------#2022-04-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/7d22319e4bd422cec71bbd9d2eafcab6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*X7--1JsLTKcJlqhG"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">约翰·巴克利普在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="7f2e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我最近参与了一个azure，Terraform项目，其中terraform <strong class="ki iu">状态文件</strong>依赖项，如Azure存储blob、容器、访问密钥等，是从PowerShell任务创建的，后来为terraform传递访问密钥以初始化其远程状态。这是在创建初始资源、SOP等和完整的IaC时消除手动依赖的一种方式！！</p><p id="ce73" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这个azure <a class="ae kf" href="https://docs.microsoft.com/en-us/azure/devops/release-notes/2020/sprint-168-update#jobs-can-access-output-variables-from-previous-stages" rel="noopener ugc nofollow" target="_blank">版本</a>之后，在管道阶段之间共享变量被启用，下面是我的PowerShell代码中的一个片段，其中“存储帐户访问密钥”被存储到变量<code class="fe le lf lg lh b"><strong class="ki iu">$STORAGE_ACCESS_KEY</strong></code>中。</p><pre class="li lj lk ll gt lm lh ln bn lo lp bi"><span id="9b30" class="lq lr it lh b be ls lt l lu lv"># Fetching the keys to access the storage account<br/>Write-Host 'Fetching storage key from '$tf.STORAGE_ACCOUNT_NAME<br/>$STORAGE_ACCESS_KEY=$(az storage account keys list --subscription $subscription_id --resource-group $tf.RESOURCE_GROUP_NAME --account-name $tf.STORAGE_ACCOUNT_NAME --query '[0].value' -o tsv)<br/>Write-Host "##vso[task.setvariable variable=accesskey;isOutput=true]$STORAGE_ACCESS_KEY"</span></pre><p id="f7a6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以看到变量<code class="fe le lf lg lh b"><strong class="ki iu">accesskey</strong></code>是用<code class="fe le lf lg lh b"><strong class="ki iu">STORAGE_ACCESS_KEY</strong></code>设置的，其中包含存储帐户访问密钥和名为<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/scripts/logging-commands" rel="noopener ugc nofollow" target="_blank">日志命令</a>的概念，您可以在脚本中定义输出变量。</p><blockquote class="lw lx ly"><p id="d5f2" class="kg kh lz ki b kj kk kl km kn ko kp kq ma ks kt ku mb kw kx ky mc la lb lc ld im bi translated">VSO代表Visual Studio Online，微软将其重命名为Visual Studio Team Services (VSTS ),后来又重命名为Azure DevOps Services。</p></blockquote><pre class="li lj lk ll gt lm lh ln bn lo lp bi"><span id="adb8" class="lq lr it lh b be ls lt l lu lv">Write-Host "##vso[task.setvariable variable=accesskey;isOutput=true]$STORAGE_ACCESS_KEY"</span></pre><p id="3489" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的脚本在名为<strong class="ki iu">设置</strong>的阶段、作业<strong class="ki iu">测试</strong>中以及名为<strong class="ki iu">先决条件</strong>的步骤中执行。<strong class="ki iu"> </strong>所以要将变量<code class="fe le lf lg lh b"><strong class="ki iu">accesskey</strong></code>传递到下一个叫做Validate的阶段，你必须使用<code class="fe le lf lg lh b"><strong class="ki iu">stageDependencies</strong></code>。下面的代码片段显示了给变量<code class="fe le lf lg lh b"><strong class="ki iu">$storage_access_key</strong></code>赋值<code class="fe le lf lg lh b"><strong class="ki iu">accesskey</strong></code>。</p><pre class="li lj lk ll gt lm lh ln bn lo lp bi"><span id="bc45" class="lq lr it lh b be ls lt l lu lv">** azure-pipelines.yml, wrote by bare hand and not tested :) **<br/>stages:<br/>- stage: Setup<br/>  displayName: "Setup Environments"<br/>  jobs:<br/>  - job : Test<br/>    steps:<br/>    - pwsh: |<br/>        Write-Host "##vso[task.setvariable                                                                        variable=accesskey;isOutput=true]$STORAGE_ACCESS_KEY"<br/>      name: pre_requisites<br/>- stage: Validate<br/>  displayName: Validations, TFLint, Scan<br/>  variables:<br/>  - name: env<br/>    value: test<br/>  - name: storage_access_key<br/>    value: $[ stageDependencies.Setup.Test.outputs['pre_requisites.accesskey'] ]</span></pre><p id="ade4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在一个阶段上，要引用另一个阶段的输出变量，应使用以下表达式格式:</p><ul class=""><li id="b9a5" class="md me it ki b kj kk kn ko kr mf kv mg kz mh ld mi mj mk ml bi translated">在阶段级别，从另一个阶段引用输出变量的格式是<code class="fe le lf lg lh b"><strong class="ki iu">dependencies.STAGE.outputs['JOB.TASK.VARIABLE']</strong></code>。</li><li id="f46c" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">在作业级别，从另一个阶段引用输出变量的格式是<code class="fe le lf lg lh b"><strong class="ki iu">stageDependencies.STAGE.JOB.outputs['TASK.VARIABLE']</strong></code>。</li></ul><p id="a214" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有关这方面的更多细节，您可以查看关于“<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&amp;tabs=yaml%2Cbatch#use-outputs-in-a-different-stage" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">在不同阶段使用输出</strong> </a>”的文档。</p><p id="fba7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="lz">注意:奇怪的是，如果您需要将值</em> <code class="fe le lf lg lh b"><em class="lz">accesskey</em></code> <em class="lz">传递给第三个阶段，比如说“验证3”，并且您在阶段“验证”中重复了相同的代码，那么您将得到一个空字符串作为</em> <code class="fe le lf lg lh b"><em class="lz">accesskey. </em></code>和一个限制，您不能在多个阶段中访问该变量！</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="7b2e" class="my lr it bd mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu bi translated">分级编码</h1><p id="fb85" class="pw-post-body-paragraph kg kh it ki b kj nv kl km kn nw kp kq kr nx kt ku kv ny kx ky kz nz lb lc ld im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="c358" class="md me it ki b kj kk kn ko kr mf kv mg kz mh ld mi mj mk ml bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="922c" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">📰查看<a class="ae kf" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="8440" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">💰免费编码面试课程<a class="ae kf" href="https://skilled.dev/?utm_source=luc&amp;utm_medium=article" rel="noopener ugc nofollow" target="_blank">查看课程</a></li><li id="8eca" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">🔔关注我们:<a class="ae kf" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae kf" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae kf" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="e3ae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">🚀👉<a class="ae kf" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>