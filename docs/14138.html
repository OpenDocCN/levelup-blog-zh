<html>
<head>
<title>Saving Terraform State Online</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在线保存地形状态</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/saving-terraform-state-online-dd61d613b5d9?source=collection_archive---------11-----------------------#2022-11-03">https://levelup.gitconnected.com/saving-terraform-state-online-dd61d613b5d9?source=collection_archive---------11-----------------------#2022-11-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5ce9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">教程-使用S3作为地形状态的后端</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ef54d2a1b16acd0d93c4b706d35e1add.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RqWbfRakCYEWXvRim4bxJQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com//?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=4004268" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/indirafoto-11470024/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=4004268" rel="noopener ugc nofollow" target="_blank"> Christel </a></figcaption></figure><h1 id="37c7" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="9d00" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在<a class="ae ky" href="https://www.mixlr.com/" rel="noopener ugc nofollow" target="_blank"> Mixlr </a>，我们使用<a class="ae ky" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>作为我们选择的工具来声明性地定义我们的基础设施。这是我们的IaC工具。它允许我们部署到任何云提供商，并保持对我们的虚拟和物理基础架构中的任何变化和发展的控制。</p><p id="20cc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">Terraform处理定义文件，通常是<code class="fe ms mt mu mv b">main.tf</code>，将其内容应用到我们的基础设施，并生成另一个工件作为输出，通常是<code class="fe ms mt mu mv b">terraform.tfstate</code>，这是它的当前状态。</p><p id="67dd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">默认情况下，开发人员运行命令后，状态文件保存在本地:</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="86b0" class="na la it mv b gy nb nc l nd ne">$ terraform apply</span></pre><p id="f7c1" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然而，这种<em class="nf">本地</em>持久性不适合在分布式团队中工作，因为许多devops工程师在同一基础设施上并行工作。他们需要有一种方法来共享<code class="fe ms mt mu mv b">terraform.tfstate</code>文件，顺便说一下，该文件不应该存储在<code class="fe ms mt mu mv b">git</code>存储库中。</p><p id="edab" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这篇博客文章是一篇教程类型的文章，它将向你展示如何将<code class="fe ms mt mu mv b">terraform.tfstate</code>文件保存在一个远程且安全的地方，在那里你的团队的所有成员都可以访问它。</p><h1 id="132d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">体系结构</h1><p id="f3d4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在我们看到实际的地形定义文件之前，让我们看一个问题解决方案的示意图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/a1874f8afa15fc679cb0745f97a11f10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/format:webp/1*8_MS3P5vm3E5Zbt87d7hwg.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">正在将状态上传到S3存储桶</figcaption></figure><p id="65af" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">从上图可以看出，当工程师<code class="fe ms mt mu mv b">applies</code>定义地形时，最后，状态被保存到AWS S3桶，而不是本地。</p><p id="85d9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了让这个架构正确运行，当多个开发人员同时处理同一个terraform repo时，需要确保没有两个开发人员可以同时改变S3存储桶的内容。</p><p id="8587" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这种并发控制是通过使用基于AWS DynamoDB表的分布式锁实现的，如下图所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/830fd2eccee778710b6f01a5c90e9b98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SV6hl-oQSwPSTmGnxz6OcA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">用于并发控制的DynamoDB表</figcaption></figure><p id="4c26" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">从上图可以看出，terraform的设置是这样配置的，当一个开发人员试图<em class="nf"> </em> <code class="fe ms mt mu mv b"><em class="nf">apply</em></code>时，它首先需要在DynamoDB表上获取一个锁。如果锁不可用，这意味着另一个开发人员已经获取了它，并正在更新S3桶中的terraform状态。如果锁是自由的，那么<code class="fe ms mt mu mv b">apply</code>命令毫无问题地继续执行，最后，具有地形状态的S3桶被更新，锁被释放。</p><h1 id="7c4b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">两个Terraform配置文件</h1><p id="3416" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们需要2个地形配置文件:</p><ol class=""><li id="8920" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated"><code class="fe ms mt mu mv b">backend_state/backend-state.tf</code></li><li id="8453" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated"><code class="fe ms mt mu mv b">main.tf</code></li></ol><h2 id="f869" class="na la it bd lb nw nx dn lf ny nz dp lj ma oa ob ll me oc od ln mi oe of lp og bi translated">S3铲斗和测功机工作台的配置(<code class="fe ms mt mu mv b">backend_state/backend-state.tf</code></h2><p id="9350" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">此文件(<code class="fe ms mt mu mv b">backend-state.tf</code>)将描述用于锁定的S3桶和DynamoDB表。我们在名为<code class="fe ms mt mu mv b">backend_state</code>的文件夹中创建它。</p><p id="e0ee" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><em class="nf">文件:backend-state.tf </em></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">S3铲斗和测功机工作台的地形配置</figcaption></figure><p id="6a67" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们希望您注意以下几点:</p><ul class=""><li id="34bf" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm oj no np nq bi translated">第12–15行:您需要提供正确的AWS概要文件名称。这是您在本地使用凭据设置的配置文件，允许您访问您的AWS帐户。</li><li id="565e" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm oj no np nq bi translated">第13行:给你的桶一个唯一的名字。</li><li id="e50e" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm oj no np nq bi translated">第26–29行:确保桶受到私有acl的保护。</li><li id="e77d" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm oj no np nq bi translated">第31–36行:启用时段版本控制。因此，如果开发人员提交了一个需要恢复的状态，回到以前的版本会容易得多。</li><li id="8ed4" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm oj no np nq bi translated">第39行:为DynamoDB表选择一个惟一的名称。</li><li id="a3c4" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm oj no np nq bi translated">第40行和第42–45行:散列键需要是<code class="fe ms mt mu mv b">LockID</code>。其他值不起作用。类型应该是<code class="fe ms mt mu mv b">S</code>，即字符串类型。</li><li id="d4f8" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm oj no np nq bi translated">第41行:我建议计费模式为<code class="fe ms mt mu mv b">PAY_PER_REQUEST</code>，因为这个表不会连续使用。</li></ul><p id="e48c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">应用后端状态地形配置:</p><p id="37b9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">准备好<code class="fe ms mt mu mv b">backend_state/backend-state.tf</code>文件后，您需要应用它:</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="8115" class="na la it mv b gy nb nc l nd ne">$ terraform -chdir=./backend_state apply</span></pre><p id="4c4f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，您已经准备好获取您的<code class="fe ms mt mu mv b">main.tf</code>文件，该文件将使用之前创建的后端进行状态存储。</p><h2 id="b0a3" class="na la it bd lb nw nx dn lf ny nz dp lj ma oa ob ll me oc od ln mi oe of lp og bi translated">主要配置</h2><p id="5e75" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">下面是一个使用分布式后端的<code class="fe ms mt mu mv b">main.tf</code>文件的例子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用分布式后端进行状态存储的地形配置</figcaption></figure><p id="ba67" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">上面的配置创建了一个EC2实例。不过，重点在于第2行和第8行之间的<code class="fe ms mt mu mv b">backend</code>声明。后端是<code class="fe ms mt mu mv b">"s3"</code>，它声明了bucket和dynamodb表，该表用于对状态变化进行并发控制。</p><h1 id="dfe6" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结束语</h1><p id="cb8e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这是一篇教程类型的帖子，教你如何使用AWS S3后端作为terraform状态存储。</p><p id="2b6c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我希望它对你有用。但是，我从你身上学到的总是比你从我身上学到的多。因此，我们非常欢迎您的评论。</p><p id="dd49" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">谢谢你，下一篇文章再见。</p><p id="9eb0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> <em class="nf">注:</em> </strong> <em class="nf">本帖原载于Mixlr </em> <a class="ae ky" href="https://blog.mixlr.com/2022/11/engineering-tutorial-saving-terraform-state-online/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=panos_matsinopoulos_saving_terraform_state_online" rel="noopener ugc nofollow" target="_blank"> <em class="nf">此处</em> </a> <em class="nf">。</em></p></div></div>    
</body>
</html>