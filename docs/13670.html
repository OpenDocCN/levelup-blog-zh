<html>
<head>
<title>Configuring Apache2 MaxClients settings</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">配置Apache2 MaxClients设置</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/configuring-apache2-maxclients-settings-645a5e14f5e3?source=collection_archive---------23-----------------------#2022-09-26">https://levelup.gitconnected.com/configuring-apache2-maxclients-settings-645a5e14f5e3?source=collection_archive---------23-----------------------#2022-09-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/632ebecbad0afe55f20d6d7599d590bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*p-t9UbrlBRHN0Yu1"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://images.unsplash.com/photo-1603041385912-d622c2700422?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1632&amp;q=80" rel="noopener ugc nofollow" target="_blank">https://images . unsplash . com/photo-1603041385912-d622c 2700422？IX lib = r b-1 . 2 . 1&amp;ixid = mnwxmja 3 fdb 8 mhxwag 90 by 1 wywdlfhx 8 fgvufdb 8 fhx 8&amp;auto = format&amp;fit = crop&amp;w = 1632&amp;q = 80</a></figcaption></figure><p id="caba" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我会告诉你我是如何解决这个问题的，但可能还有其他方法。在日志中遇到这个问题可能会令人望而生畏<code class="fe le lf lg lh b">server reached MaxClients setting, consider raising the MaxClients setting</code>，这会大大降低web服务的速度。然而，当查看服务器上的监控统计数据时，我使用的是cacti。</p><p id="9026" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是发生这种情况时的配置示例</p><pre class="li lj lk ll gt lm lh ln lo aw lp bi"><span id="82d6" class="lq lr it lh b gy ls lt l lu lv">&lt;IfModule prefork.c&gt;<br/>StartServers       8<br/>MinSpareServers    5<br/>MaxSpareServers    10<br/>ServerLimit        1024<br/>MaxClients         768<br/>MaxRequestsPerChild  4000<br/>&lt;/IfModule&gt;<br/><br/>&lt;IfModule worker.c&gt;<br/>StartServers         2<br/>MaxClients         150<br/>MinSpareThreads     25<br/>MaxSpareThreads     75 <br/>ThreadsPerChild     25<br/>MaxRequestsPerChild  0<br/>&lt;/IfModule&gt;<br/><br/><br/><br/>free -m<br/>             total       used       free     shared    buffers     cached<br/>Mem:           768        352        415          0          0         37<br/>-/+ buffers/cache:        315        452<br/>Swap:            0          0          0<br/><br/><br/><br/>top - 11:03:54 up 41 days, 11:53,  1 user,  load average: 0.05, 0.03, 0.00<br/>Tasks:  35 total,   1 running,  34 sleeping,   0 stopped,   0 zombie<br/>Cpu(s):  0.0%us,  0.0%sy,  0.0%ni, 99.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.3%st<br/>Mem:    786432k total,   389744k used,   396688k free,        0k buffers<br/>Swap:        0k total,        0k used,        0k free,    38284k cached</span></pre><p id="a0fa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我运行的是Apache 2.2，php5运行在<code class="fe le lf lg lh b">prefork</code>模式。从当前的设置来看，这意味着apache进程从8个进程开始，但是如果有10个以上的进程什么都不做；然后减少子进程，使其保持在5-10个可用进程之间。</p><p id="7d52" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">apache的增加/减少速度是每分钟1，所以这将退回到空闲可用apache进程数量相当少的情况，avg 2。平均值很低，因为你通常只有5个可用的进程，所以一旦流量增加，它就会被立即使用，apache创建新进程的速度会很慢。更糟糕的是，你的申请过程很长，所以需要更长时间才能完成。</p><figure class="li lj lk ll gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lw"><img src="../Images/79832e82351007682d95c9d6ca61a0da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W_EZB9i6JoU5ZM7T.png"/></div></div></figure><p id="c562" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您在红色峰值之前看到少量绿色，则表示没有足够的进程来接收传入流量。</p><p id="2b80" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一种处理和测试的方法是使用类似下面的配置</p><pre class="li lj lk ll gt lm lh ln lo aw lp bi"><span id="eb87" class="lq lr it lh b gy ls lt l lu lv">&lt;IfModule prefork.c&gt;<br/>  StartServers       12<br/>  MinSpareServers    12<br/>  MaxSpareServers    12<br/>  MaxClients         12<br/>  MaxRequestsPerChild  300<br/>&lt;/IfModule&gt;</span></pre><p id="8ac8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将意味着当流量增加/减少时，您不会移动分叉处理的数量，因为您总是希望使用所有的RAM并为任何增加做好准备。300意味着在300次请求之后，您将回收任何分支，以防止任何内存泄漏问题。12将是您可以处理的并行请求的数量，这应该设置为您希望处理的数量。</p><p id="7033" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">计算可以运行多少ram/进程的推荐公式</p><p id="ed83" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">MaxClients =(总RAM —操作系统的RAM—外部程序的RAM)/(每个httpd进程的RAM)</p><p id="45a2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下脚本有助于完成所需的设置</p><pre class="li lj lk ll gt lm lh ln lo aw lp bi"><span id="8c00" class="lq lr it lh b gy ls lt l lu lv">#!/bin/bash<br/><br/>echo "HostName=`hostname`"<br/><br/>#Formula<br/>#MaxClients . (RAM - size_all_other_processes)/(size_apache_process)<br/>total_httpd_processes_size=`ps -ylC httpd --sort:rss | awk '{ sum += $9 } END { print sum }'`<br/>#echo "total_httpd_processes_size=$total_httpd_processes_size"<br/>total_http_processes_count=`ps -ylC httpd --sort:rss | wc -l`<br/>echo "total_http_processes_count=$total_http_processes_count"<br/>AVG_httpd_process_size=$(expr $total_httpd_processes_size / $total_http_processes_count)<br/>echo "AVG_httpd_process_size=$AVG_httpd_process_size"<br/>total_httpd_process_size_MB=$(expr $AVG_httpd_process_size / 1024)<br/>echo "total_httpd_process_size_MB=$total_httpd_process_size_MB"<br/>total_pttpd_used_size=$(expr $total_httpd_processes_size / 1024)<br/>echo "total_pttpd_used_size=$total_pttpd_used_size"<br/>total_RAM_size=`free -m |grep Mem |awk '{print $2}'`<br/>echo "total_RAM_size=$total_RAM_size"<br/>total_used_size=`free -m |grep Mem |awk '{print $3}'`<br/>echo "total_used_size=$total_used_size"<br/>size_all_other_processes=$(expr $total_used_size - $total_pttpd_used_size)<br/>echo "size_all_other_processes=$size_all_other_processes"<br/>remaining_memory=$(($total_RAM_size - $size_all_other_processes))<br/>echo "remaining_memory=$remaining_memory"<br/>MaxClients=$((($total_RAM_size - $size_all_other_processes) / $total_httpd_process_size_MB))<br/>echo "MaxClients=$MaxClients"<br/>exit</span></pre></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="1114" class="me lr it bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">分级编码</h1><p id="017c" class="pw-post-body-paragraph kg kh it ki b kj nb kl km kn nc kp kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="4ebf" class="ng nh it ki b kj kk kn ko kr ni kv nj kz nk ld nl nm nn no bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="a00a" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">📰查看更多内容请参见<a class="ae kf" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码刊物</a></li><li id="683d" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">🔔关注我们:<a class="ae kf" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae kf" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae kf" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="5183" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">🚀👉<a class="ae kf" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">将像你这样的开发人员安置在顶级创业公司和科技公司</strong> </a></p></div></div>    
</body>
</html>