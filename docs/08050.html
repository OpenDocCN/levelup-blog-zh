<html>
<head>
<title>How to improve your code readability with CQS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用CQS提高你的代码可读性</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-improve-your-code-readability-with-cqs-b54b43ca9fa5?source=collection_archive---------9-----------------------#2021-03-30">https://levelup.gitconnected.com/how-to-improve-your-code-readability-with-cqs-b54b43ca9fa5?source=collection_archive---------9-----------------------#2021-03-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="444d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">花更多时间阅读而不是编写代码是对代码库不信任的明显标志。命令查询分离(CQS)原则可以解决这个问题。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/92873999adfdd8cf6eec10953fe56551.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bUwY0omiXf2F0FgEW3lgYQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">米海三都</figcaption></figure><p id="8d82" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">想象一下，每次你听“单身女士”这首歌都会改变。</p><p id="ea5d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">第一次:“所有的单身女士……”</p><p id="15c7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">第二次:“每一位单身女士……”</p><p id="2ff4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">第三次:“所有单身女士…”</p><p id="0ca6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果是这样的话，没有人会分享这首歌，它不会成为热门歌曲，我们也不会嘲笑“单身女士”<a class="ae lu" href="https://www.youtube.com/watch?v=kU9MuM4lP18" rel="noopener ugc nofollow" target="_blank">婴儿舞蹈</a>。人类期望事物保持不变，而他们所做的只是观察。《老友记》每次重播都必须保持原样。</p><p id="ae5b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当代码是熟悉事物的自然延伸时，它是有意义的。这就是为什么我们给变量和方法起有意义的名字，而不命名x1，x2，x3。</p><h1 id="daed" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">促进不信任的准则</h1><p id="8d5b" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">检查以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="8270" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在继续阅读之前，试着猜测每个方法应该做什么。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="fd42" class="mz lw it mv b gy na nb l nc nd">SetTemperature(int temperature) </span></pre><p id="c1c6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个方法很明显，它应该设置机器的温度。返回的int代表什么？当前温度？或者一个身份代码？不知道。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="bec4" class="mz lw it mv b gy na nb l nc nd">GetTemperatureReadings()</span></pre><p id="2d57" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">根据名称，它应该返回所有温度读数的列表。酷毙了。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="172d" class="mz lw it mv b gy na nb l nc nd">Alert(int temperature)</span></pre><p id="84af" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个方法应该会发出某种警报。</p><p id="ad9f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好了，这些方法还不错，除了SetTemperature()的返回值，我们对如何使用这个类有了一个很好的想法。但是让我们看看完整的实现。</p><h2 id="2ea8" class="mz lw it bd lx ne nf dn mb ng nh dp mf lh ni nj mh ll nk nl mj lp nm nn ml no bi translated">背后的意图</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">冰淇淋类完全实现</figcaption></figure><p id="be48" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">SetTemperature()方法将更新冰淇淋机的温度。该方法将返回机器的最终温度，并将其添加到所有读数列表中。</p><p id="f82f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果当前温度高于10度，GetTemperatureReadings()方法将触发警报，并返回所有温度的列表。</p><h2 id="591a" class="mz lw it bd lx ne nf dn mb ng nh dp mf lh ni nj mh ll nk nl mj lp nm nn ml no bi translated">问题是</h2><p id="39bc" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">我们不能相信它。</p><p id="5477" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，对于SetTemperature()方法，我们不知道它将返回什么，除非查看文档或实现。这意味着失去了时间。这就是我们如何得到“<em class="np">这个代码烂透了”的感觉。</em></p><p id="e581" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好的代码应该是自文档化的。我争取一节课零行评语。这并不总是可能的，但我会一直记在心里。</p><p id="6609" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">理想情况下，所有开发人员都将把大部分时间花在编写代码上，而不是阅读上。大多数时候感觉恰恰相反。</p><p id="fbad" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，更大的问题是GetTemperatureReadings。每次我们呼叫它，它都可能触发警报。如果我们只想得到名单，那就不好了。</p><h1 id="5765" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">重构CQS</h1><p id="9eb0" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">命令查询分离是一个编程原则，它规定每个方法都应该很容易被识别为命令或查询。换句话说，将改变系统状态的方法与查询系统状态的方法分开。</p><p id="2da2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">不要把CQS与<a class="ae lu" href="https://martinfowler.com/bliki/CQRS.html" rel="noopener ugc nofollow" target="_blank"> CQRS </a>(命令查询责任分离)混淆。CQRS是一种应用于架构层面的设计模式，而CQS是一种原则。它可以应用于方法、类或整个解决方案。你决定吧。</p><p id="33fc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你只记得这篇文章中的一件事，那就是:</p><ul class=""><li id="7701" class="nq nr it la b lb lc le lf lh ns ll nt lp nu lt nv nw nx ny bi translated">命令方法应该总是返回void</li><li id="31ed" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">查询方法应该有一个返回类型，它们永远不会改变系统的状态。</li></ul><p id="8379" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在查询的方法和改变状态的方法之间有一个清晰的分离可以让开发人员信任代码。调用查询方法不能改变系统的状态。</p><p id="215a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">想象一下，每次对数据库执行“选择”操作时，都会得到不同数量的行。那将是一场纯粹的噩梦。</p><p id="17d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">CQS就像是开发人员之间的一种通用语言，能够在最短的时间内传递最多的信息。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">牢记CQS重构代码</figcaption></figure><p id="6cf0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好吧，发生了什么？</p><p id="93dd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在SetTemperature()中，我将返回类型更改为void。现在，方法签名和名称传达了一个明确的信息:方法是一个命令。</p><p id="07ad" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我添加了一个GetTemperature()来获取当前温度。请注意，您可以调用这个方法1000次，结果不会改变(假设当前温度没有通过set调用更新)。</p><p id="fec1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">复活节彩蛋—</strong>GetTemperatureReadings()方法仍然不符合CQS。你能找出原因吗？文末的回答。</p><p id="cac9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，我删除了GetTemperatureReadings()中对Alert()的调用。相反，我添加了一个新方法来模拟作业(理想情况下，这将通过一个单独的作业类来完成)。</p><p id="46bd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们以一个扩大的班级结束。五种方法而不是三种。现在你可能会争辩说，以前在一个方法调用SetTemperature()中完成的事情，现在需要两个调用。这有点低效。对此，我说，“这无关紧要”。代码可维护性和可读性方面的收益远远大于负面影响。</p><p id="af86" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这种小效率思维随处可见。想象一下，我们将当前温度存储在一个文件中，而不是存储在内存中。现在，我们有两个文件调用，而不是一个。请不要担心。这些收益是如此之小，以至于97%的时间它们都不会产生影响。</p><blockquote class="oe"><p id="882e" class="of og it bd oh oi oj ok ol om on lt dk translated">“程序员浪费了大量的时间去考虑或担心他们程序中非关键部分的速度，当考虑到调试和维护时，这些提高效率的尝试实际上会产生强烈的负面影响。我们<em class="oo">应该</em>忘记小的效率，比方说97%的时间:<strong class="ak">过早的优化是万恶之源。然而，我们不应该错过这关键的3%的机会。”— <a class="ae lu" href="http://wiki.c2.com/?DonaldKnuth" rel="noopener ugc nofollow" target="_blank">唐纳克努特</a></strong></p></blockquote><h2 id="4419" class="mz lw it bd lx ne op dn mb ng oq dp mf lh or nj mh ll os nl mj lp ot nn ml no bi translated">规则就是用来被打破的</h2><p id="820a" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">虽然“单身女士”的打击总是一样的，但也有观察到一些东西会改变其状态的情况。例如，如果你想测量轮胎内部的压力，在安装轮胎压力计时会损失少量的空气。不损失空气的测量太麻烦了。不值得。</p><p id="b114" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">编码也一样。CQS是一个应该指导我们写代码的原则，但是有些情况下应用它会导致弊大于利。例如:</p><ul class=""><li id="2e22" class="nq nr it la b lb lc le lf lh ns ll nt lp nu lt nv nw nx ny bi translated">当我们想要弹出一个堆栈时，尽管可以遵循这个原则来实现，但在这种情况下，最好是打破它</li><li id="32b1" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">在异步上下文中-&gt;在C#异步中，你不应该返回void</li></ul><p id="a8d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">打破规则可能是有益的，但为了正确行事，你必须记住以下几点:</p><ol class=""><li id="4fa7" class="nq nr it la b lb lc le lf lh ns ll nt lp nu lt ou nw nx ny bi translated">打破规则之前先了解它</li><li id="4d02" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt ou nw nx ny bi translated">在打破规则之前先了解它。</li></ol><h1 id="230d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">外卖食品</h1><ul class=""><li id="7e8b" class="nq nr it la b lb mn le mo lh ov ll ow lp ox lt nv nw nx ny bi translated">在命令和查询之间分离方法。</li><li id="b359" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">命令方法应该返回void。</li><li id="f80d" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">查询方法应该返回值，并且永远不改变系统状态。</li><li id="9f52" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">简洁地命名你的方法</li></ul><p id="d46b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">复活节彩蛋解决方案:</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="da71" class="mz lw it mv b gy na nb l nc nd">public List&lt;int&gt; GetTemperatureReadings() //removed call to alert<br/>{<br/>    //the problem was the Add reading to temperature readings.<br/>    //the add was altering the list making this query method into a command. <br/>    return new List&lt;int&gt;(temperatureReadings); <br/>}</span></pre><h1 id="7cb5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">进一步阅读</h1><div class="oy oz gp gr pa pb"><a href="https://martinfowler.com/bliki/CommandQuerySeparation.html" rel="noopener  ugc nofollow" target="_blank"><div class="pc ab fo"><div class="pd ab pe cl cj pf"><h2 class="bd iu gy z fp pg fr fs ph fu fw is bi translated">bliki: CommandQuerySeparation</h2><div class="pi l"><h3 class="bd b gy z fp pg fr fs ph fu fw dk translated">术语“命令查询分离”是由Bertrand Meyer在他的书《面向对象软件构造》中提出的…</h3></div><div class="pj l"><p class="bd b dl z fp pg fr fs ph fu fw dk translated">martinfowler.com</p></div></div><div class="pk l"><div class="pl l pm pn po pk pp ks pb"/></div></div></a></div><div class="oy oz gp gr pa pb"><a href="https://blog.ploeh.dk/2014/08/11/cqs-versus-server-generated-ids/" rel="noopener  ugc nofollow" target="_blank"><div class="pc ab fo"><div class="pd ab pe cl cj pf"><h2 class="bd iu gy z fp pg fr fs ph fu fw is bi translated">CQS与服务器生成的id</h2><div class="pi l"><h3 class="bd b gy z fp pg fr fs ph fu fw dk translated">在保存实体时，如何既遵循命令查询分离，又给实体分配唯一的id？这个帖子…</h3></div><div class="pj l"><p class="bd b dl z fp pg fr fs ph fu fw dk translated">blog.ploeh.dk</p></div></div></div></a></div><div class="oy oz gp gr pa pb"><a href="https://danylomeister.blog/2020/06/16/cqs-and-its-impact-on-design/" rel="noopener  ugc nofollow" target="_blank"><div class="pc ab fo"><div class="pd ab pe cl cj pf"><h2 class="bd iu gy z fp pg fr fs ph fu fw is bi translated">CQS及其对设计的影响</h2><div class="pi l"><h3 class="bd b gy z fp pg fr fs ph fu fw dk translated">先从缩写说起。CQS主张命令-查询分离。这个术语是伯特兰·迈耶发明的…</h3></div><div class="pj l"><p class="bd b dl z fp pg fr fs ph fu fw dk translated">danylomeister .博客</p></div></div><div class="pk l"><div class="pq l pm pn po pk pp ks pb"/></div></div></a></div></div></div>    
</body>
</html>