<html>
<head>
<title>WebRTC: the ICE Framework, STUN and TURN Servers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">WebRTC:ICE框架、STUN和TURN服务器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/webrtc-the-ice-framework-stun-and-turn-servers-10b2972483bb?source=collection_archive---------3-----------------------#2020-03-23">https://levelup.gitconnected.com/webrtc-the-ice-framework-stun-and-turn-servers-10b2972483bb?source=collection_archive---------3-----------------------#2020-03-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/9278b9fbcbd4a8bd0fb070064da5aed4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UHOFTAUVqqW8KBXhwQxAcw.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">马库斯·斯皮斯克在<a class="ae kf" href="https://unsplash.com/s/photos/network?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="f1ef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">WebRTC(Web Real Time Communication)是一个开源项目，支持通过JavaScript API创建对等(P2P)音频和视频通信。</p><p id="899a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了建立P2P连接，对等体必须就它们想要交换的媒体类型进行通信，告诉彼此它们何时想要开始或停止通信，并且它们必须在网络中找到彼此。完整的过程被称为信令，但我们只对最后一部分感兴趣:如何尽可能直接地连接对等体。</p><p id="0442" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这并不像听起来那么简单。用户的设备通常没有公共IP地址，或者可能不允许建立任何直接连接。这就是为什么我们需要交互式连接建立(ICE)框架。</p><h1 id="3305" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">日产防盗系统</h1><p id="5d4c" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果两个用户正在打电话，一个只需拨打另一个的电话号码，另一个只需接听电话。每个电话号码只对应一个设备，电话号码足以实现直接连接。</p><p id="a819" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一方面，在互联网上，历史上没有足够的“号码”用于每个连接的设备。使用IPv4，只有大约40亿个地址可用。地址不足的问题可以通过将许多设备归入一个公共地址来解决，路由器会翻译通过它的数据包中的地址。这个过程称为网络地址转换(NAT)。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mh"><img src="../Images/c7807582b7095680705ede810e1b424a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rQ7Jru9IO5Fxnt9QvOvB_A.png"/></div></div></figure><p id="66e4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有不同类型的NAT，但其中一些为UDP流分配一个公共IP地址和一个端口(这是我们所需要的)。因此，当您想要创建与对等方的P2P连接时，第一个挑战是发现您背后的NAT类型，如果它们存在，则获取您可以提供给联系人的IP地址和端口。</p><h1 id="0a6b" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使目瞪口呆</h1><p id="8555" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">STUN(NAT会话遍历实用程序)协议可以帮助您做到这一点。当试图建立P2P连接时，您必须提供STUN服务器。在WebRTC中，您在创建表示连接的JavaScript对象时提供它:</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="f9c1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了确定您是否在NAT之后，并尽可能获得一个公共IP地址，ICE代理将向您指定的STUN服务器发送一个请求。如果有的话，NAT将在消息头中设置它的公共地址和端口。STUN服务器将尝试从不同的IP地址ping这个公共地址，以检查您是否在NAT之后，如果是，它是哪种NAT。但是如果一切顺利，STUN服务器会把这个地址和这个端口返回给你。</p><pre class="mi mj mk ml gt mo mp mq mr aw ms bi"><span id="1c82" class="mt lf it mp b gy mu mv l mw mx">   You                        NAT                     STUN server          <br/>    |------ STUN request -----&gt;|                          |                   <br/>    |   src:198.145.1.2:3000   |                          |                   <br/>    |                          |------ STUN request -----&gt;|                   <br/>    |                          |   src:128.11.22.13:8888  |                   <br/>    |                          |                          |                   <br/>    |                          |&lt;------STUN response------|                   <br/>    |                          |   ext:128.11.22.13:8888  |                   <br/>    |&lt;------STUN response------|                          |                   <br/>    |   ext:128.11.12.13:8888  |                          |</span></pre><p id="8c90" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你试图与之通信的对等体工作顺利，他也会得到它的公共地址。但这并不是我们问题的结束。</p><h1 id="fe40" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">NAT实施</h1><p id="a735" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">NAT的实现方式不尽相同，它们允许数据包通过的方式也可能不同。一些NAT实现，如一对一NAT，将允许建立P2P连接。有些，比如对称的，就不会。</p><h2 id="1d48" class="mt lf it bd lg my mz dn lk na nb dp lo kr nc nd ls kv ne nf lw kz ng nh ma ni bi translated">一对一NAT(或全锥形NAT)</h2><p id="04af" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在这种实现中，一旦内部IP地址/端口duo被映射到外部IP地址/端口duo，到达外部地址/端口的所有分组，不管它们来自哪里，都将被发送到原始的内部地址/端口。</p><p id="0ae2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果对等体在这样的NAT之后，那么获得两个对等体的公共IP地址和端口就足以建立P2P连接。</p><h2 id="abb5" class="mt lf it bd lg my mz dn lk na nb dp lo kr nc nd ls kv ne nf lw kz ng nh ma ni bi translated">对称NAT</h2><p id="4661" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在对称NAT中，外部IP地址/端口取决于内部IP地址/端口duo <strong class="ki iu">和目的地</strong>。从198.145.1.2:3000到TURN服务器的请求被映射到给定的外部源IP地址和端口。但是，如果同一个内部主机将数据包发送到不同的目的地，例如它试图与之通信的对等主机，则外部IP地址/端口将会不同。除此之外，外部主机必须先从内部主机收到数据包，然后才能发回数据包。</p><p id="8c8d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果对等体位于对称NAT之后，它们将无法通信。这就是为什么我们需要另一个解决方案:转向。</p><h1 id="2953" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">转动</h1><p id="87f2" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">当无法建立直接连接时，通信必须通过TURN服务器。TURN代表使用中继绕过NAT的遍历。顾名思义，连接会经过一个中继服务器。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/3e5a1b3a9655e82c0bec9e0d8e6928d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*hZc2iVuix_S-aTIFu_4rPQ.jpeg"/></div></figure><p id="f88f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这显然恶化了性能，并且有财务成本。STUN服务器处理非常小而简单的请求，而TURN服务器中继整个会话，这会导致更多的流量。这就是为什么你能找到公共的眩晕服务器，却找不到公共的回合服务器(至少没有一个服务器的主人知道它是公共的)。</p><h1 id="04a9" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">WebRTC中的ICE</h1><p id="7ee8" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">对于要通过TURN建立的WebRTConnection，您需要在RCTPeerConnection对象中指定您的TURN服务器的url:</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="855f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">出于上述原因，TURN服务器通常受密码保护。</p><p id="7846" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">ICE代理将首先尝试在对等体之间直接建立连接，只有在不起作用时才会切换到TURN选项。你不用自己管，你只需要监听RTCPeerConnection的事件<em class="nk"> onicecandidate </em>就可以了。每次发现候选冰时都会触发该事件。然后，您应该通过您的信号机制将候选人发送给您的同事:</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="195e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当从您的同事那里收到一个候选人时，您必须通过调用<em class="nk"> addIceCandidate </em>将其交付给ICE代理。剩下的谈判和候选人的最终选择由ICE代理负责。在候选协商结束时，如果成功，对等体可以开始通信。</p></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><p id="5724" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我希望这篇文章对你有用。如果您想亲自了解如何构建WebRTC视频聊天，并了解整个信令流程，您可以查看这一系列文章:</p><ul class=""><li id="89ae" class="ns nt it ki b kj kk kn ko kr nu kv nv kz nw ld nx ny nz oa bi translated"><a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/data-stream-from-your-webcam-and-microphone-videochat-with-javascript-step-1-29895b70808b">来自网络摄像头和麦克风的数据流:用JavaScript视频聊天第一步</a></li><li id="0da4" class="ns nt it ki b kj ob kn oc kr od kv oe kz of ld nx ny nz oa bi translated"><a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/set-up-a-connection-over-websocket-videochat-with-javascript-step-2-f78c307c4fd3">通过WebSocket建立连接:用JavaScript进行视频聊天第二步</a></li></ul></div></div>    
</body>
</html>