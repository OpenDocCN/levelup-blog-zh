<html>
<head>
<title>Run an automated ML pipeline with Ceph Bucket Notifications, TensorFlow and Flask using Openshift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Openshift运行带有Ceph桶通知、TensorFlow和Flask的自动化ML管道</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/run-an-automated-ml-pipeline-with-ceph-bucket-notifications-tensorflow-and-flask-using-openshift-2ca741c29701?source=collection_archive---------15-----------------------#2020-04-04">https://levelup.gitconnected.com/run-an-automated-ml-pipeline-with-ceph-bucket-notifications-tensorflow-and-flask-using-openshift-2ca741c29701?source=collection_archive---------15-----------------------#2020-04-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/b5edcea215d2ddd1e370841f9bea3185.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3gywbT2wpxrtmhWH.jpeg"/></div></div></figure><p id="1b99" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在当今世界，许多组织都在朝着机器学习的方向发展，因为他们理解快速获得可靠数据的强烈需求。我们被数据驱动的组织所包围，他们在寻找获取知识的最佳方式，以帮助他们做出正确的业务决策。这些组织中的大多数从成千上万的来源收集了大量的数据，但是收集原始数据本身并没有多大价值，除非我们对其进行处理和分析。当一个组织达到拥有大量数据的程度时，尽可能保持分析过程自动化以避免人工干预是非常重要的。为了使用这些自动化管道，我们需要找到合适的解决方案来帮助我们实现业务目标。</p><p id="6533" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">举一个简短的例子来说明我们如何创建这样一个自动ML管道，我们将使用一些开源解决方案来帮助我们对图像进行分类。图像分类是指计算机视觉中可以根据图像的视觉内容对图像进行分类的过程。例如，一个图像分类算法可以被设计成判断一个图像是否包含人体，另一个算法可以识别给定图像中的物体。虽然检测物体对人类来说是微不足道的，但鲁棒的图像分类仍然是计算机视觉应用中的一个挑战。</p><p id="a3e9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">演示架构的简短说明:在本演示中，我们将使用Openshift容器平台来运行不同的容器化工作负载。在Opensfhit中，我们将使用rook-ceph作为对象存储，通知Flask-Tensorflow服务关于写入S3桶的图像。我们将使用Ceph桶通知来通知使用特定后缀创建的对象，因此每次JPG图像将被上传到S3桶时，Ceph将向我们的Flask REST API抛出一个通知。当我们的REST API得到通知时，它将从Ceph获取S3对象并运行分类算法。长话短说，对于上传到我们桶中的每张图片，我们应该得到一个分类输出。</p><p id="7982" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">图像已上传(*。JPG) → S3桶→JPG图像创建通知→ HTTP端点→ Flask REST触发器→图像分类算法→推理结果</p><h1 id="f245" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">先决条件</h1><ul class=""><li id="5adf" class="lx ly it kd b ke lz ki ma km mb kq mc ku md ky me mf mg mh bi translated">Openshift容器平台(4.3.8版本)</li><li id="af22" class="lx ly it kd b ke mi ki mj km mk kq ml ku mm ky me mf mg mh bi translated">暴露S3接口的Rook-Ceph集群(octopus版本)</li><li id="d36c" class="lx ly it kd b ke mi ki mj km mk kq ml ku mm ky me mf mg mh bi translated">用于配置存储桶通知配置的通知工具(shonpaz123/notify:latest)</li><li id="3dda" class="lx ly it kd b ke mi ki mj km mk kq ml ku mm ky me mf mg mh bi translated">Flask-Tensorflow图像分类应用程序(shonpaz 123/image-class ification:最新)</li></ul><h1 id="a3aa" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">装置</h1><p id="808e" class="pw-post-body-paragraph kb kc it kd b ke lz kg kh ki ma kk kl km mn ko kp kq mo ks kt ku mp kw kx ky im bi translated">我们将首先验证我们的s3服务是否按预期工作，为此，我们将公开由rook-ceph创建的S3服务，这样我们可以将其卷曲，并获得XML:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="830b" class="mz la it mv b gy na nb l nc nd">oc expose svc rook-ceph-rgw-my-store -n rook-ceph </span><span id="34b1" class="mz la it mv b gy ne nb l nc nd">oc get route | grep rgw<br/>rook-ceph-rgw-my-store   rook-ceph-rgw-my-store-rook-ceph.apps-crc.testing          rook-ceph-rgw-my-store   http                 None</span></pre><p id="897a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在让我们转向我们的S3服务，看看我们是否得到想要的XML，表明我们的S3服务工作正常:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="cb9c" class="mz la it mv b gy na nb l nc nd">curl <a class="ae nf" href="http://rook-ceph-rgw-my-store-rook-ceph.apps-crc.testing" rel="noopener ugc nofollow" target="_blank">http://rook-ceph-rgw-my-store-rook-ceph.apps-crc.testing</a><br/>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;ListAllMyBucketsResult &gt;&lt;Owner&gt;&lt;ID&gt;anonymous&lt;/ID&gt;&lt;DisplayName&gt;&lt;/DisplayName&gt;&lt;/Owner&gt;&lt;Buckets&gt;&lt;/Buckets&gt;&lt;/ListAllMyBucketsResult&gt;</span></pre><p id="cc30" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">很好，现在我们已经运行了S3服务，让我们使用以下部署示例来运行影像分类应用程序:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="59d9" class="mz la it mv b gy na nb l nc nd">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: image-classifcation <br/>  labels:<br/>    app: image-classifciation <br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: image-classification <br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: image-classification <br/>    spec:<br/>      containers:<br/>      - name: image-classification <br/>        image: shonpaz123/image-classification<br/>        ports:<br/>        - containerPort: 5001<br/>        env: <br/>        - name: AWS_ACCESS_KEY_ID <br/>          value: replaceme <br/>        - name: AWS_SECRET_ACCESS_KEY<br/>          value: replaceme <br/>        - name: service_point <br/>          value: replaceme  <br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: image-classification-service <br/>spec:<br/>  selector:<br/>    app: image-classification <br/>  ports:<br/>    - protocol: TCP<br/>      port: 5001<br/>      targetPort: 5001</span></pre><p id="89b8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如您所见，部署获得了S3凭证和端点URL，并创建了一个监听HTTP请求的服务来开始对上传的图像进行分类。现在让我们运行这个部署:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="b298" class="mz la it mv b gy na nb l nc nd">oc create -f image-classification.yaml <br/></span><span id="70ad" class="mz la it mv b gy ne nb l nc nd">oc get pods | grep class<br/>image-classification-6d557979cf-slvqf                           1/1     Running     0          2m</span></pre><p id="0951" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">很好，现在我们已经启动并运行了分类服务，我们将必须创建一个存储桶，以便我们可以创建通知配置:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="6a78" class="mz la it mv b gy na nb l nc nd">aws s3 mb s3://image-classification --endpoint-url <a class="ae nf" href="http://rook-ceph-rgw-my-store-rook-ceph.apps-crc.testing" rel="noopener ugc nofollow" target="_blank">http://rook-ceph-rgw-my-store-rook-ceph.apps-crc.testing</a></span></pre><p id="8e77" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，在我们创建了S3存储桶之后，让我们使用Notify工具来创建通知配置，该工具将帮助我们创建所需的配置:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="f5bb" class="mz la it mv b gy na nb l nc nd">git clone <a class="ae nf" href="https://github.com/shonpaz123/notify.git" rel="noopener ugc nofollow" target="_blank">https://github.com/shonpaz123/notify.git</a> &amp;&amp; cd notify/openshift</span></pre><p id="14d6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这里，我们将使用所需的变量编辑notify.env文件:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="a76f" class="mz la it mv b gy na nb l nc nd">ACCESS_KEY=                # S3 access key <br/>SECRET_KEY=                # S3 secret key <br/>ENDPOINT_URL=              # S3 HTTP url <br/>BUCKET_NAME=               # Created S3 bucket name <br/>HTTP_ENDPOINT=             # The HTTP endpoint of our Flask service <br/>FILTER=                    # example: '{"Key": {"FilterRules": [{"Name": "suffix", "Value": ".jpg"}]}}'<br/>FILTER_TYPE=suffix         # can contain prefix/suffix/regex/metadata/tags</span></pre><p id="b4f1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我们插入正确的值之后，我们将使用Openshift功能来处理模板输入。要创建作业，需要配置通知配置:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="6b1a" class="mz la it mv b gy na nb l nc nd">oc process -f notify.yaml --param-file notify.env | oc create -f -</span></pre><p id="479e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们验证我们的作业是否已完成(作业pod名称将由notify.env文件中的FILTER_TYPE值创建):</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="e624" class="mz la it mv b gy na nb l nc nd">oc get pods | grep suffix</span><span id="19a9" class="mz la it mv b gy ne nb l nc nd">suffix-qnp5k                                                   0/1     Completed   0          2m</span></pre><p id="41f6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，在我们设置好所有的基础设施之后，让我们试着上传一张比萨饼图片，看看我们是否会得到该图片的分类。上传的图像:</p><figure class="mq mr ms mt gt ju gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/051bb386eae493f62e1b86eb4fe66561.png" data-original-src="https://miro.medium.com/v2/resize:fit:566/format:webp/1*M0IhDyNDuDSYiNKrJqASTw.png"/></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated">披萨图片上传到我们的S3桶</figcaption></figure><p id="14fd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将图像上传到我们的S3桶:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="8d30" class="mz la it mv b gy na nb l nc nd">aws s3 cp pepperoni-pizza-thinly-sliced-popular-topping-american-style-pizzerias-30402134.jpg s3://image-classification --endpoint-url <a class="ae nf" href="http://rook-ceph-rgw-my-store-rook-ceph.apps-crc.testing" rel="noopener ugc nofollow" target="_blank">http://rook-ceph-rgw-my-store-rook-ceph.apps-crc.testing</a></span></pre><p id="7f2e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在让我们检查一下Flask服务日志，看看是否有结果:</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="ba6c" class="mz la it mv b gy na nb l nc nd">oc logs image-classifcation-6d557979cf-slvqf<br/>.<br/>.<br/>.<br/>2020-04-04 19:47:14,020 - {'0.003111549': 'honeycomb', <strong class="mv iu">'0.7704552': 'pizza, pizza pie'</strong>, '0.0039080456': 'hognose snake, puff adder, sand viper', '0.0031275006': 'trifle', '0.0043221256': 'book jacket, dust cover, dust jacket, dust wrapper'}<br/>2020-04-04 19:47:14,021 - 10.128.0.136 - - [04/Apr/2020 19:47:14] "POST / HTTP/1.1" 200 -</span></pre><p id="3dcb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们可以看到，我们得到的结果表明，给定的图像有77%的可能性是一个比萨饼。</p><h1 id="c08f" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">结论</h1><p id="4ba7" class="pw-post-body-paragraph kb kc it kd b ke lz kg kh ki ma kk kl km mn ko kp kq mo ks kt ku mp kw kx ky im bi translated">正如我们所见，使用正确的软件解决方案运行ML管道非常容易。使用上述产品，我们可以创建一个自我管理的环境，使用Openshift的目标简化与基础设施的交互。有了这些，我们只需点击一个按钮，就可以创建一个智能的自我管理的数据驱动的环境。希望你喜欢这个演示，我们下次再见:)</p></div></div>    
</body>
</html>