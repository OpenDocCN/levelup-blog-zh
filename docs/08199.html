<html>
<head>
<title>Build Social Media Style Stories with Android and Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Android和Python构建社交媒体风格的故事</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/build-social-media-style-stories-with-android-and-python-aeaed2a22f9c?source=collection_archive---------4-----------------------#2021-04-08">https://levelup.gitconnected.com/build-social-media-style-stories-with-android-and-python-aeaed2a22f9c?source=collection_archive---------4-----------------------#2021-04-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1df873d82a0f25cec9f393960a13b83c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6SBQSW54zoVL4HIyQjop7g.png"/></div></div></figure><p id="1d25" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Instagram有一个受欢迎的功能，叫做Stories，灵感主要来自Snapchat。故事使用户能够创建一个视频或静态图片，它们将在很短的时间内(24小时)消失。后来，其他社交媒体平台也开发了这一功能，如Linkedin和Twitter。</p><p id="8479" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本教程中，我们将使用Vonage的视频API为Android构建这一功能，我们还需要一个服务器来处理客户端的会话和令牌，这将使用Python来构建。</p><h1 id="ed9d" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">先决条件</h1><ul class=""><li id="b77c" class="lu lv iq ka b kb lw kf lx kj ly kn lz kr ma kv mb mc md me bi translated"><a class="ae mf" href="https://www.python.org/download/releases/3.0/" rel="noopener ugc nofollow" target="_blank"> Python 3 </a></li><li id="151a" class="lu lv iq ka b kb mg kf mh kj mi kn mj kr mk kv mb mc md me bi translated"><a class="ae mf" href="https://www.djangoproject.com/" rel="noopener ugc nofollow" target="_blank">姜戈3 </a></li><li id="7fe5" class="lu lv iq ka b kb mg kf mh kj mi kn mj kr mk kv mb mc md me bi translated"><a class="ae mf" href="https://developer.android.com/studio" rel="noopener ugc nofollow" target="_blank"> Android Studio 4 </a></li><li id="b657" class="lu lv iq ka b kb mg kf mh kj mi kn mj kr mk kv mb mc md me bi translated">Android设备(可选)</li><li id="8a01" class="lu lv iq ka b kb mg kf mh kj mi kn mj kr mk kv mb mc md me bi translated"><a class="ae mf" href="https://learn.vonage.com/blog/2017/07/04/local-development-nexmo-ngrok-tunnel-dr/" rel="noopener ugc nofollow" target="_blank"> Ngrok </a>(可选)</li></ul><h1 id="4f18" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">构建服务器</h1><p id="322a" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">首先，我们将构建一个我们的移动应用程序可以与之通信的服务器。这个服务器将使用<a class="ae mf" href="https://www.djangoproject.com/" rel="noopener ugc nofollow" target="_blank"> Django </a>，一个Python web框架。</p><h2 id="5570" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">安装依赖项</h2><p id="57c2" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">首先，通过运行以下两个命令创建一个Python虚拟环境:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="0562" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我们可以为后端服务器安装依赖项:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="c8e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面的命令将安装Django，并打开Vonage视频Python SDK。</p><h2 id="5286" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">创建项目和应用程序</h2><p id="b7f3" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">通过运行以下命令初始化Django项目:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="2ab5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在开始编写代码之前，我们需要在Django项目中创建至少一个应用程序。一个Django项目可以包含许多应用程序。例如，项目A可以是一个故事应用程序，而项目B可以是一个消息应用程序或电子商务应用程序。首先，将当前目录更改为项目目录，然后用下面显示的两个命令初始化一个新的应用程序:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="3950" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您不必执行下一个命令，因为在本教程中我们不会使用数据库。但是，除非我们执行迁移命令，否则警告将持续存在，因此运行以下命令来停止这些警告。</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="af24" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了确保我们的Django web应用程序能够工作，您可以运行webserver脚本。</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="8b28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以使用端口8000访问本地主机上的web应用程序。在您的浏览器中，它将看起来像<code class="fe ng nh ni nj b">http://localhost:8000</code>。如果你访问这个网址，你会收到一条成功的信息和一张火箭的图片。</p><h2 id="675b" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">环境变量</h2><p id="15af" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们的代码将需要使用您的Vonage Video(也称为OpenTok) API密钥和秘密，它们永远不应该硬编码到您的应用程序中。为了提高应用程序的安全性，可以使用环境变量。在您的终端中，您可以设置这两个值，如下例所示。确保用您的值替换<code class="fe ng nh ni nj b">xxxxxx</code>。您可以在<a class="ae mf" href="https://www.vonage.id/communications-apis/video/" rel="noopener ugc nofollow" target="_blank"> Vonage视频API文档</a>中获得API密钥和API秘密的这些值。</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="41a5" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">创建视图</h2><p id="465c" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">视图是在Django应用程序中呈现的模板。打开<code class="fe ng nh ni nj b">storiesserver/storiesapp/views.py</code>文件，并用以下内容替换其内容:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="a88b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这段代码的第一部分创建了一个OpenTok实例，它将使用我们为API key和API secret预先设置的环境变量。</p><p id="e564" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后我们有两个全局变量，<code class="fe ng nh ni nj b">videos</code>和<code class="fe ng nh ni nj b">index</code>。它们就像内存中的迷你数据库，保存着我们的故事(或视频)信息。</p><p id="858e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在第一种方法中，我们用<code class="fe ng nh ni nj b">get_token</code>方法生成会话和令牌。为了创建一个会话，我们使用OpenTok实例中的<code class="fe ng nh ni nj b">create_session</code>方法。它接受两个参数:媒体模式和归档模式。我们将<code class="fe ng nh ni nj b">MediaModes.routed</code>值用于媒体模式，因为我们将视频作为故事发布，而不是用于视频聊天。<code class="fe ng nh ni nj b">MediaModes.routed</code>表示我们将视频发送到服务器，而不是另一个客户端。我们将<code class="fe ng nh ni nj b">ArchiveModes.manual</code>值用于存档模式，因为我们想要手动存档(记录)视频，以便获得存档id。当我们想要获取录制视频时，这个id很重要。如果没有，我们必须从存档列表中迭代它，这是不方便的。为了生成令牌，我们使用会话实例中的<code class="fe ng nh ni nj b">generate_token</code>方法。我们将过期时间值作为参数传递给这个方法。最后，我们将会话、令牌和API密钥发送给客户端。</p><p id="37d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在第二种方法中，即<code class="fe ng nh ni nj b">video_stream</code>方法，我们从存档id中获取视频URL。如果您注意到，这个方法除了通常的参数之外还有一个额外的参数，<code class="fe ng nh ni nj b">request</code>。我们如何获得存档id是在另一个方法中完成的。</p><p id="a66a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第三种方法是<code class="fe ng nh ni nj b">videos_list</code>方法，我们将视频列表发送给客户端。基本上就是我们用JSON包装的<code class="fe ng nh ni nj b">videos</code>变量。</p><p id="f503" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第四种方法是<code class="fe ng nh ni nj b">video_start_archive</code>方法，我们将视频存档。这个方法有一个额外的参数<code class="fe ng nh ni nj b">session_id</code>。我们使用OpenTok实例中的<code class="fe ng nh ni nj b">start_archive</code>方法。它接受OpenTok会话。执行此方法后，我们的视频会话将被记录。<code class="fe ng nh ni nj b">start_archive</code>方法返回存档id。我们将它存储到<code class="fe ng nh ni nj b">videos</code>变量中。除了存档id，我们还为这个视频生成了一个好听的名字，比如“故事1”、“故事2”等等。</p><p id="77a2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后一个方法是<code class="fe ng nh ni nj b">homepage</code>方法，只是为了测试Django web应用程序是否可以访问。</p><h2 id="11f8" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">创建URL映射</h2><p id="c53a" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">然后我们需要创建一个从URL到这些视图方法的映射。创建<code class="fe ng nh ni nj b">storiesserver/storiesapp/urls.py</code>文件，并将以下示例复制到该文件中:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="2992" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ng nh ni nj b">path</code>方法接受三个参数:</p><p id="8315" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">URL路径要访问的方法路由的名称，以供参考。</p><p id="d307" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，第二个路径将视图中的<code class="fe ng nh ni nj b">token</code> URL映射到<code class="fe ng nh ni nj b">get_token</code>方法。</p><p id="3287" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Django应用程序的服务器端，我们需要修改<code class="fe ng nh ni nj b">urls.py</code>文件以映射到stories URLs，因此定位文件:<code class="fe ng nh ni nj b">storiesserver/storiesserver/urls.py</code>并用以下内容替换该文件的内容:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="0677" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">Ngrok</h2><p id="f62d" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">为了在开发过程中向互联网和我们的Android设备公开Django应用程序，我们将使用Ngrok。连接您的帐户后，我们可以启动一个HTTP隧道，将它转发到我们的Django web应用程序端口8000:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="a1d1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建隧道后，您将看到类似于<code class="fe ng nh ni nj b">https://xxxxxxxx.ngrok.io</code>的公共URL。然后您需要修改<code class="fe ng nh ni nj b">storiesserver/storiesserver/settings.py</code>文件，将<code class="fe ng nh ni nj b">"xxxxxxxx.ngrok.io"</code>、<code class="fe ng nh ni nj b">"10.0.2.2"</code>和<code class="fe ng nh ni nj b">"localhost"</code>字符串添加到<code class="fe ng nh ni nj b">ALLOWED_HOSTS</code>变量中。<code class="fe ng nh ni nj b">10.0.2.2</code>地址是Android模拟器访问你电脑中本地主机的方式。</p><p id="bbd4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">修改后，您的<code class="fe ng nh ni nj b">ALLOWED_HOSTS</code>变量应该是这样的:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="a79e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后要访问<code class="fe ng nh ni nj b">token</code> URL，您应该访问这个URL: <code class="fe ng nh ni nj b"><a class="ae mf" href="https://xxxxxxxx.ngrok.io/stories/token." rel="noopener ugc nofollow" target="_blank">https://xxxxxxxx.ngrok.io/stories/token</a></code> <a class="ae mf" href="https://xxxxxxxx.ngrok.io/stories/token." rel="noopener ugc nofollow" target="_blank">。</a></p><p id="78b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">至此，您已经构建了服务器组件，该组件可以生成令牌、归档视频记录并提供视频记录URL。接下来，您将构建一个Android应用程序，作为这个服务器应用程序的客户端。使用这个移动应用程序，您可以录制视频并观看视频录制内容。</p><h1 id="4075" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">客户端</h1><p id="6767" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">启动Android Studio，创建一个新项目，选择“空活动”作为项目模板。最低SDK选择“API 16: Android 4.1(果冻豆)”语言选择“Kotlin”。</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h1 id="deb1" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">属国</h1><p id="6fc5" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在Android Studio中构建项目的第一件事是添加任何需要的依赖项。打开项目级的<code class="fe ng nh ni nj b">build.gradle</code>，在位于<code class="fe ng nh ni nj b">allprojects</code>区块内的<code class="fe ng nh ni nj b">repositories</code>区块内添加以下行。然后同步文件。</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="ac68" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你要做的第二件事是在文件上添加依赖项，这个文件有相同的名字<code class="fe ng nh ni nj b">build.gradle</code>，但是在应用级(或者模块级)。将这些线添加到<code class="fe ng nh ni nj b">dependencies</code>模块中。不要忘记同步文件。</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="63b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该项目使用了五个额外的库，它们是:</p><p id="22a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Vonage Video SDK (OpenTok) OkHttp库向我们的后端服务器发送请求，Gson库解析JSON响应，EasyPermissions库在我们的Android应用程序请求使用摄像头和麦克风的权限时处理权限，Coroutines库方便地处理非阻塞和阻塞代码。</p><h2 id="b265" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">网络安全配置</h2><p id="4142" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">这一步是可选的。如果您想用模拟器测试应用程序，而不想使用Ngrok，那么您需要创建一个网络配置文件。在<code class="fe ng nh ni nj b">res</code>目录中创建<code class="fe ng nh ni nj b">xml</code>目录，然后在<code class="fe ng nh ni nj b">xml</code>目录中创建一个名为<code class="fe ng nh ni nj b">network_security_config.xml</code>的新文件。将以下内容复制到其中:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="e6b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这意味着您可以在没有后端URL HTTPS协议的情况下开发应用程序。</p><h2 id="bdd4" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">Android清单</h2><p id="2bd1" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">要激活该网络配置，打开<code class="fe ng nh ni nj b">AndroidManifest.xml</code>文件，将以下属性添加到<code class="fe ng nh ni nj b">application</code>节点:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="07a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后在<code class="fe ng nh ni nj b">manifest</code>节点中添加以下内容。</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="7df9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们需要这两个附加物，因为我们想把我们的移动应用程序连接到我们的后端服务器。</p><p id="b5e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们在这个文件中时，让我们创建对稍后将创建的另外两个活动的引用。在唯一的<code class="fe ng nh ni nj b">activity</code>节点后添加这几行。</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="56ff" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">布局</h2><p id="8f34" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们有三个活动，但我们需要为这些活动创建3个布局。我们还需要为MainActivity中使用的RecyclerView中的行布局创建一个额外的布局。</p><p id="4bbe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，通过在<code class="fe ng nh ni nj b">app/src/main/res/layout</code>目录下创建一个名为<code class="fe ng nh ni nj b">row.xml</code>的新文件来创建行布局。将以下XML复制到这个新文件中:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="a08b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面定义了一个按钮的创建，该按钮将用于启动一个观看故事或视频的活动。</p><p id="5d7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们需要创建一个布局来显示视频。在布局目录中创建一个名为<code class="fe ng nh ni nj b">activity_viewing_story.xml</code>的新文件，并将以下XML添加到该文件中:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="88c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该布局包含一个将呈现视频的<code class="fe ng nh ni nj b">WebView</code>。</p><p id="84c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们必须创建<code class="fe ng nh ni nj b">activity_creating_story.xml</code>文件。这是本活动用来创建视频的布局。删除文件内容，并向其中添加以下代码:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="d087" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Video SDK使用ID为<code class="fe ng nh ni nj b">publisher</code>的FrameLayout来显示发送到视频服务器的视频。本活动中按钮的作用是停止录像并结束活动。</p><p id="2e5f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们需要编辑<code class="fe ng nh ni nj b">activity_main.xml</code>文件。这个文件包含MainActivity使用的布局，它将列出已经创建的所有故事(视频)。该文件还将包含一个按钮，用于启动创建视频的活动。用以下XML替换该文件的内容:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="b1e0" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">添加服务器URL</h2><p id="b97e" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">让我们在<code class="fe ng nh ni nj b">strings.xml</code>文件中定义服务器URL，该文件可以在<code class="fe ng nh ni nj b">values</code>目录中找到。为此，请将以下内容添加到您的<code class="fe ng nh ni nj b">resources</code>节点中:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="5237" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您正在使用Ngrok，请将其更改为以下示例(确保用您的ngrok URL替换<code class="fe ng nh ni nj b">xxxxx</code>):</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="7da7" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">课程和活动</h2><p id="f937" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">首先，我们需要为RecyclerView创建必要的类。RecyclerView需要一个适配器和一个容器。通过在<code class="fe ng nh ni nj b">package</code>目录中创建名为<code class="fe ng nh ni nj b">StoryViewHolder.kt</code>的文件来创建一个持有者文件。这个包类似于位于<code class="fe ng nh ni nj b">java</code>目录中的<code class="fe ng nh ni nj b">com.example.storiesapplication</code>。将以下代码复制到这个新文件中:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="c855" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于您创建的每个类或活动文件，如果您的包不同，请确保将<code class="fe ng nh ni nj b">com.example.storiesapplication</code>包更改为您的包。</p><p id="a82e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是一个标准的holder类，可以用一个字符串参数设置按钮的文本，并为按钮设置一个回调。</p><p id="b2cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建holder类后，我们需要一个adapter类。适配器是数据和RecyclerView视图之间的桥梁。在<code class="fe ng nh ni nj b">java/package/</code>目录下创建一个名为<code class="fe ng nh ni nj b">StoryAdapter.kt</code>文件的新文件，并在该文件中添加以下代码:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="674a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ng nh ni nj b">onCreateViewHolder</code>方法扩展了<code class="fe ng nh ni nj b">row</code>布局并创建了holder类的一个实例。<code class="fe ng nh ni nj b">onBindViewHolder</code>方法将数据设置到RecyclerView的特定行，而<code class="fe ng nh ni nj b">getItemCount</code>方法返回存储的项目数。</p><p id="712e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在是时候在MainActivity中创建RecyclerView了。修改<code class="fe ng nh ni nj b">MainActivity.kt</code>文件，将内容替换为以下内容:</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="f2a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ng nh ni nj b">onCreate</code>方法向该活动中的浮动按钮添加了一个回调，该回调将调用<code class="fe ng nh ni nj b">getToken</code>方法来获取令牌、会话和API密钥，然后将它们传递给<code class="fe ng nh ni nj b">CreatingStoryActivity</code>活动。RecyclerView还加载视频列表，对于每一行，我们添加一个回调来调用<code class="fe ng nh ni nj b">ViewingStoryActivity</code>活动。</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="3883" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在上面的<code class="fe ng nh ni nj b">onCreate</code>方法中，我们请求摄像机、互联网和音频录制的权限。如果我们有权限，我们将使用令牌、会话和API密钥创建一个会话对象。我们还必须为这个会话对象设置监听器。我们还在这个活动中设置了一个对按钮的回调。该按钮将发送一个停止存档视频的请求。</p><p id="d211" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们有许多会话监听器所需的方法。最重要的一个是<code class="fe ng nh ni nj b">onConnected</code>方法，如果我们的会话已经连接到OpenTok服务器，就会调用这个方法。</p><p id="8d5e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们创建一个publisher对象，并将FrameLayout设置为publisher的视图。我们还必须将我们的会话对象连接到这个publisher对象。然后，我们创建一个请求对象来开始归档视频。</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="573b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们通过向Django应用程序发送请求，从存档id中获取视频URL。然后，我们在WebView中加载URL。</p><h2 id="e86d" class="mo kx iq bd ky mp mq dn lc mr ms dp lg kj mt mu lk kn mv mw lo kr mx my ls mz bi translated">启动应用程序</h2><p id="7ebc" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">启动应用程序。如果您想使用Android设备，记得使用Ngrok或在云上部署Django应用程序。起初，你会看到一个空屏幕和一个浮动按钮。</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/74b5d56f9bf771bc7b3a9c615aada2c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3FC__bQRHlvKTUD33HgYyQ.jpeg"/></div></div></figure><p id="93ee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">按下浮动按钮，设备会将视频从您的相机传输到OpenTok服务器。当你为你的故事录制好足够的内容后，按下屏幕上的“上传故事”按钮。</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/c93ec50a57d9bbff37dcdab4a639177f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*B8cxsRYMSE-ls8a5PoXV0Q.jpeg"/></div></figure><p id="52f6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你将被重定向回主屏幕，现在显示你的故事列表。</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/25753285ec2bda304b349746aca0a73d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y968lsMMDWRZdJOYnRUNWg.jpeg"/></div></div></figure><p id="c94f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您按下故事行，您将被重定向到查看故事屏幕。您可以观看之前录制的视频。</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/ce77fcf4c6a0af47a226d760e53a9131.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*tBADvNziysKFChZoAvlU8Q.jpeg"/></div></figure><h1 id="50a3" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">结论</h1><p id="6fc7" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">这个应用程序远非完美。如果您注意到，录制的视频比录制会话短。这是因为发送视频存档请求需要时间。最重要的是，我们的故事列表是一个简单的循环视图。你可以把它们转换成水平卷轴。每个故事都被包裹成一个圆形，就像Instagram Stories的样子！我们也没有认证和授权。这个故事没有主人。这个视频在OpenTok服务器上存储了一段时间。之后，该视频将被删除。在此之前，您可以选择将视频保存到其他地方。</p><h1 id="c4a0" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">资源</h1><ul class=""><li id="aa45" class="lu lv iq ka b kb lw kf lx kj ly kn lz kr ma kv mb mc md me bi translated">点击查看我们的Vonage视频Api <a class="ae mf" href="https://www.vonage.id/communications-apis/video/" rel="noopener ugc nofollow" target="_blank">文档</a></li><li id="b38b" class="lu lv iq ka b kb mg kf mh kj mi kn mj kr mk kv mb mc md me bi translated">这篇博文的代码在<a class="ae mf" href="https://github.com/arjunaskykok/android-stories/" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上</li></ul></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><p id="31d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nt">最初发布于</em><a class="ae mf" href="https://learn.vonage.com/blog/2021/03/23/build-social-media-style-stories-with-android-and-python/" rel="noopener ugc nofollow" target="_blank"><em class="nt">https://learn . vonage . com/blog/2021/03/23/build-social-media-style-stories-with-Android-and-python/</em></a></p></div></div>    
</body>
</html>