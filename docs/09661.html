<html>
<head>
<title>Linux Auditing System: Centralized Logging to Remote Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Linux审计系统:集中登录到远程服务器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/linux-auditing-system-centralized-logging-to-remote-server-9644089702fb?source=collection_archive---------8-----------------------#2021-08-31">https://levelup.gitconnected.com/linux-auditing-system-centralized-logging-to-remote-server-9644089702fb?source=collection_archive---------8-----------------------#2021-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e8911d1d9ec06f85b5a5664cbc4838f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*F7t9nXPGbRHunIbJ"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kc" href="https://unsplash.com/@scienceinhd?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">科学高清</a>拍摄的照片</figcaption></figure><p id="fb15" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当您有多台服务器时，可能很难跟上正在发生的事情。与其在不同的机器上查看分成不同文件的数千行日志，为什么不将所有内容发送到一个中央日志记录站，在那里您可以分析所有内容而不会丢失全局？</p><p id="d493" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本文的目的是向您展示一个实际操作的例子，说明如何设置一个集中式日志记录机器，从网络的其他节点接收日志。为此，我将使用Linux审计系统。</p><p id="6c10" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">免责声明:</strong>我绝不是这方面的专家。我想和你们分享我学习和试验这种酷技术的旅程。我希望你能和我一样开心。</p><h1 id="c761" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">什么是Linux审计系统？</h1><p id="299d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">对于那些对此一无所知的人(比如几天前的我)，Linux内核审计系统是Linux内核的一个特性，它允许对系统上的任何相关操作进行深入的信息收集。</p><p id="8d0a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在内核级实现时，Linux审计系统能够记录:</p><ul class=""><li id="3b82" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated">系统调用，以及其他有用的信息，如父进程ID、进程ID、可执行文件以及调用是否成功</li><li id="4239" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">文件访问，以及执行的操作类型(读、写、执行、文件属性的更改)</li></ul><p id="4719" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">即使在某些方面，审计系统类似于标准的Unix/Linux日志记录功能，也存在一些相关的差异。其中之一是Linux审计系统不记录每个应用程序，而只记录可信的应用程序。[1]</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/117451de04444d1e4ef17446f77916f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WYHwv3QXn7JcbeH7e67FiQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图片取自:<a class="ae kc" href="https://people.redhat.com/sgrubb/audit/audit_ids_2011.pdf" rel="noopener ugc nofollow" target="_blank">https://people.redhat.com/sgrubb/audit/audit_ids_2011.pdf</a></figcaption></figure><h1 id="b8e0" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">为什么？</h1><p id="f918" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Audit为您提供了跟踪系统中安全相关信息的工具。然而，Audit <strong class="kf ir">不会为您的系统提供额外的安全性</strong>。调查系统中违反安全策略的情况非常有用，但这并不能阻止它们。Linux审计系统最大的优势是<strong class="kf ir">通用性</strong>。你可以用它监控(几乎)任何你需要的东西。另外，Linux审计系统是完全免费的，这是另一个相关的优势。[2]</p><h1 id="fa07" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">场景描述</h1><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/2fe2e5a9c7474bf8bed646342ae93b2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/format:webp/1*tMqExD93skdSI5Ob0NEy4g.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">网络描述。作者图片</figcaption></figure><p id="2eb0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">出于本教程的目的，我们将假设我们的网络由三台机器组成:</p><ul class=""><li id="b428" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated">其中两个是<strong class="kf ir">数据源</strong>(服务器一和服务器二)</li><li id="1f2d" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">第三个是我们的<strong class="kf ir">集中伐木站</strong>(站)</li></ul><p id="dde9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我用VirtualBox创建了三个不同的虚拟机，并在其中两个上安装了Ubuntu Live Server 20.04.2。三台机器在同一个NAT网络上。</p><h1 id="8a43" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">步骤1:安装和设置组件</h1><p id="7027" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Auditd是审计用户空间守护进程，默认情况下不会安装在Ubuntu上，我们必须安装它。此外，我们将需要audispd插件来将日志事件转发到远程机器。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="3588" class="nd lc iq mz b gy ne nf l ng nh">$ sudo apt install -y auditd audispd-plugins</span></pre><p id="548a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，检查是否一切正常:</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="5647" class="nd lc iq mz b gy ne nf l ng nh">$ systemctl status auditd</span></pre><p id="9a66" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你应该会得到一个绿色的信息，就像这样:</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="47e0" class="nd lc iq mz b gy ne nf l ng nh">...<br/>Active: active (running)<br/>...</span></pre><p id="e285" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，是时候设置audisp远程日志插件了。</p><p id="d6f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于每个远程服务器(在这个例子中我们只有<em class="ni">服务器一</em>和<em class="ni">服务器二)，</em>我们必须告诉插件它应该把所有事件发送到哪里。</p><p id="c4e9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">键入以下命令，将这两行放在最上面:</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="9b80" class="nd lc iq mz b gy ne nf l ng nh">$ sudo nano /etc/audisp/audisp-remote.conf<br/>remote_server = 10.0.2.6 #replace this with the IP of your central station<br/>port = 60</span></pre><h1 id="0cd2" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">步骤2:配置日志记录站</h1><p id="87a1" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">现在是在伐木站工作的时候了。</p><p id="d471" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，安装auditd。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="9ff7" class="nd lc iq mz b gy ne nf l ng nh">$ sudo apt install -y auditd</span></pre><p id="3c28" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本例中，我们不涉及防火墙，但是如果您有防火墙，不要忘记允许端口60的传入流量，否则，来自远程服务器的数据包将被拒绝。<br/>打开审计配置文件，从包含tcp_listen_port的行中删除“## ”:</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="7765" class="nd lc iq mz b gy ne nf l ng nh">$ sudo nano /etc/audit/auditd.conf<br/>...<br/>tcp_listen_port = 60<br/>...</span></pre><p id="2471" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，重新启动守护进程。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="b466" class="nd lc iq mz b gy ne nf l ng nh">$ sudo service auditd restart</span></pre><p id="898d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">注意:</strong> Auditd是高度可定制的，所以请确保查看<em class="ni">/etc/audit/Auditd . conf .</em>该文件包含特定于审计守护程序的配置信息。要了解更多，请阅读这里的文件:<a class="ae kc" href="https://linux.die.net/man/8/auditd.conf" rel="noopener ugc nofollow" target="_blank">https://linux.die.net/man/8/auditd.conf</a></p><h1 id="b551" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">步骤3:审计规则和观察者</h1><p id="2a07" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">因为我们只是在试验这个神奇的工具，所以让我们做一些非常基本的事情，比如监控对包含敏感信息的文件的访问。</p><p id="874f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们想为<em class="ni"> /etc/passwd </em>创建一个文件监视规则该怎么办？</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="ce74" class="nd lc iq mz b gy ne nf l ng nh">$ sudo nano /etc/audit/rules.d/audit.rules<br/>...<br/>-w /etc/passwd -p wrxa -k identity</span></pre><p id="fd89" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以将这条规则分为三部分:</p><ul class=""><li id="cb78" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated">-w /etc/passwd=监视/etc/passwd</li><li id="ec0d" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">-p wrxa =记录写、读、执行和属性更改权限的使用情况</li><li id="a081" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">-k identity =将密钥标识分配给该规则</li></ul><p id="0217" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，通过重新启动auditd来启用更改:</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="7055" class="nd lc iq mz b gy ne nf l ng nh">$ sudo service auditd restart</span></pre><h1 id="1b65" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">第四步:开始记录！</h1><p id="deb2" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">现在一切都已经设置好了，让我们在两台远程服务器(服务器一和服务器二)上激活远程日志插件。</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="8ce4" class="nd lc iq mz b gy ne nf l ng nh">$ sudo nano /etc/audisp/plugins.d/au-remote.conf<br/>...<br/>active = yes<br/>...</span></pre><p id="f2dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像往常一样，通过重新启动auditd来启用更改:</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="2485" class="nd lc iq mz b gy ne nf l ng nh">$ sudo service auditd restart</span></pre><p id="98c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一切顺利，当您尝试在一个远程服务器上读取、写入或更改/etc/passwd的属性时，您将在中央工作站上有一个事件。您可以像阅读普通文件一样轻松地阅读日志文件，但是，由于我们讨论的是日志，它可能是一个巨大而混乱的文件。Ausearch为这个问题提供了一个很好的解决方案，它是一个用于在审计日志中搜索事件的工具。</p><p id="4925" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，如果我们想搜索来自server-one的带有密钥标识的事件，我们只需编写:</p><pre class="mt mu mv mw gt my mz na nb aw nc bi"><span id="fd4c" class="nd lc iq mz b gy ne nf l ng nh">$ ausearch --node server-one -k identity</span></pre><h1 id="4bf7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="5800" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">像我一样随意试验这个工具！它易于配置，易于使用，并开辟了一个关于审计系统的新的可能性的世界。</p><p id="6fdb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">谢谢😉</p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><h1 id="0afc" class="lb lc iq bd ld le nq lg lh li nr lk ll lm ns lo lp lq nt ls lt lu nu lw lx ly bi translated">参考</h1><p id="0273" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">[1]: Grubb，S. (2011)。使用RHEL6和审计子系统进行本地主机入侵检测，PDF文档:<a class="ae kc" href="https://people.redhat.com/sgrubb/audit/audit_ids_2011.pdf" rel="noopener ugc nofollow" target="_blank">https://people.redhat.com/sgrubb/audit/audit_ids_2011.pdf</a></p><p id="a9b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[2]<a class="ae kc" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/security_guide/chap-system_auditing" rel="noopener ugc nofollow" target="_blank">https://access . red hat . com/documentation/en-us/red _ hat _ enterprise _ Linux/6/html/security _ guide/chap-system _ auditing</a></p></div></div>    
</body>
</html>