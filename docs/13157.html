<html>
<head>
<title>How to Improve the Performance of the Messaging Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何提高消息传递体系结构的性能</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-improve-the-performance-of-the-messaging-architecture-e1f31a2e9762?source=collection_archive---------1-----------------------#2022-08-13">https://levelup.gitconnected.com/how-to-improve-the-performance-of-the-messaging-architecture-e1f31a2e9762?source=collection_archive---------1-----------------------#2022-08-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e2e0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">5种优化技术来扩大你的武器库。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/35ecc2343f16f4ee6e9cb7011808cb0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*giW1GqSQy21WYsos"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae ky" href="https://unsplash.com/@laurentmedia?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">给</a>拍照</figcaption></figure><p id="62a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">性能问题可能发生在任何应用程序级别:数据库、数据访问层、前端等。消息代理和异步消息传递是导致性能问题的另一层原因。幸运的是，有几种方法可以在需要时使消息传递系统更快。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="45d1" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用消息批处理</h1><p id="2825" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">对于通过在短时间内交换许多异步消息来进行通信的微服务系统来说，将几条消息作为一批来处理可以大大提高性能并降低成本。</p><p id="ea4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">典型的现代消息代理支持发布者和订阅者双方的批处理<strong class="lb iu">。在第一种情况下，发布者收集几个消息，并在一个连接中将它们转发给消息代理，而不是一个接一个地发送。在第二种情况下，订户可以在一次调用中从队列中检索多条消息，在一个循环中处理它们，甚至将它们压缩成一条消息。在这两种情况下，发布者和订阅者通常使用预定义的时间间隔将传入消息添加到批处理中，然后再开始处理它。</strong></p><p id="5aed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用程序可以使用其中一种技术，甚至可以将它们结合在一起。</p><h2 id="b5c4" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">真实案例</h2><p id="a36d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在我的一个项目中，一个无服务器功能订阅了一个消息队列，每秒需要处理50到200条消息。处理一条消息会消耗大量CPU资源，因此一个函数实例无法快速处理所有消息。这导致分配了多达8个额外的函数实例来处理负载。我们遇到了每个新实例的冷启动问题，所以消息处理很慢。此外，客户不得不为额外的计算资源支付更多费用。</p><p id="ad9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后在订户端配置批处理。该函数不会在第一个传入消息到达后立即开始处理它，而是等待<em class="nl">100毫秒</em>消息代理队列中可能的下一个传入消息。</p><p id="ed76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果真的很酷:函数实例甚至可以同时接收多达30条消息，并在一次调用中处理它们。在最坏的情况下，额外提供的功能实例的数量已经从8个减少到2个。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="eaec" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">避免冷启动</h1><p id="21c2" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在消息传递体系结构中，无服务器功能或功能即服务(FaaS)通常充当订户来处理来自消息传递队列的消息。</p><p id="4c91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">FaaS提供了一个降低成本的机会，因为客户只为功能启动和运行的时间付费(情况并不总是如此，这实际上取决于托管计划)。当message broker队列中没有要处理的消息时，该函数可以在一段时间不活动后缩减到零个实例。当该功能处于非活动状态时，将不收取费用。</p><p id="3a91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">FaaS的缺点是冷启动问题。当消息到达消息代理的队列，并且没有准备好处理消息的功能实例<em class="nl">(活动功能实例的数量为零或者所有活动实例当前都忙于处理其他消息)</em>时，可能需要几秒钟来提供新的功能实例。</p><p id="93eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有几种策略可以缓解冷启动问题，从而提高系统速度:</p><ul class=""><li id="6a03" class="nm nn it lb b lc ld lf lg li no lm np lq nq lu nr ns nt nu bi translated">实现一个定期调用该函数的预定触发器，使其始终处于活动状态。</li><li id="c984" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">切换到允许您配置活动/始终开启/预热功能实例数量的另一个托管计划。</li><li id="2bea" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">将该功能的部署包大小保持在最小。该函数不应引用冗余的第三方包。</li><li id="96c4" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">该函数应该尽可能快地处理单个消息。此外，该功能应该能够同时处理许多消息。这将减少启动附加功能实例的需要，因此它们不会冷启动。</li><li id="0394" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">确保该函数不执行耗时的逻辑或者在启动时快速执行:填充内存缓存、运行数据库种子等。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="32ca" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">减少可恢复故障的机会</h1><p id="6db1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">大多数消息代理支持向订阅者重新传递消息。当订户第一次收到消息，开始处理并失败时，消息将被第二次重新传递。可能还有几次尝试，这通常在配置中指定。如果所有尝试都失败，消息将被发送到死信队列。</p><p id="5277" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在出现可恢复故障的情况下，重新传递消息会很有用。例如，为了成功处理消息，订户可能需要从外部服务(如Redis缓存、数据库或其他暂时不可用的微服务缓存)中检索数据。在这种情况下，在下一次重新传递时，外部服务可能会再次变得可用，以便订户可以成功地处理消息。</p><p id="e097" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">消息重新传递是一种使系统更加可靠的技术，但另一方面，在某些情况下，它们会变得更慢。想象一下，如果订户处理消息5秒钟，然后失败了。即使第二次尝试成功，总的消息处理时间也将是10秒。因此，经常遇到的可恢复故障确实会降低系统速度。</p><p id="212d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可恢复的失败应该尽可能少地发生，所以即使是消息代理再次尝试重新传递消息也很少发生。</p><p id="5406" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接近这一目标的一般建议可能是:</p><ul class=""><li id="0772" class="nm nn it lb b lc ld lf lg li no lm np lq nq lu nr ns nt nu bi translated">通过重新构建系统，最大限度地减少用户的外部依赖性。例如，您可以使用内存缓存代替远程缓存，或者两者结合使用。</li><li id="07ad" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">考虑为微服务实现一个<strong class="lb iu">推送机制</strong>来获取所需的数据，而不是一个<strong class="lb iu">拉取机制</strong>。这意味着微服务可以接收消息负载或HTTP请求体中的数据，而不是从数据库中查询这些数据。</li><li id="b4ba" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">考虑横向扩展和纵向扩展外部资源。例如，如果一个系统使用单个Redis实例，那么它经常会因为来自许多不同微服务的频繁请求而过载。在这种情况下，Redis实例集群会有所帮助。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4823" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">压缩大邮件</h1><p id="528d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在某些情况下，邮件的大小可以是几兆字节或更多。消息越大，执行以下操作所需的时间就越长:1)发布者将消息传递给消息代理；2)订阅者从消息代理下载消息。</p><p id="91a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当系统由于需要定期交换大量消息而运行较慢时，长期计划应该是检查消息内容中的冗余、过时片段并删除它们。有时候这能帮上大忙。</p><p id="e605" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，当每一段数据都必须保留在消息中时，开发人员可以在将消息发送到消息代理之前对其进行压缩，并在订阅方使用Gzip、Brotli或其他算法对其进行解压缩。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/2390f73da86ed250d91fee00ae4777a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z02sF2OxqGfd-s5AF__VXQ.png"/></div></div></figure><p id="8bc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">压缩可以将邮件大小减少10倍，从而加快邮件传输过程。</p><p id="cd2a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">记住额外的时间将花费在大消息的压缩和解压缩上也是很重要的。因此，在做出最终决定之前，端到端地测量性能是非常重要的。</p><h2 id="7c1a" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">索赔检查模式</h2><p id="17b2" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated"><a class="ae ky" href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/StoreInLibrary.html" rel="noopener ugc nofollow" target="_blank">认领核对</a>消息传递模式有助于将大量消息从发布者传输到订阅者。发布者将大型消息有效负载序列化并存储在数据库、blob存储或其他地方，并且只将该有效负载的ID发送给订阅者。一旦收到ID，订户就可以从外部存储中检索消息有效负载。</p><p id="0031" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该模式有助于绕过消息代理对消息大小的限制。但是，它引入了影响消息处理性能的额外网络调用和I/O操作。因此，在某些情况下，通过压缩和解压缩大消息来替换Claim-Check模式是有意义的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ef92" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">为您的消息代理切换到更高的定价方案</h1><p id="eb7e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">有时，简单地将消息代理切换到下一个定价计划/消息传递层就可以解决遇到的限制和问题。</p><p id="743b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更高的定价方案可以提供可预测的性能、更好的吞吐量、更高的限制以及其他可以加速系统的功能。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="3e56" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读。如果你喜欢你所读到的，看看下面这个故事:</p><div class="ob oc gp gr od oe"><a rel="noopener  ugc nofollow" target="_blank" href="/fast-database-fast-application-useful-db-performance-optimization-techniques-34b6926d1196"><div class="of ab fo"><div class="og ab oh cl cj oi"><h2 class="bd iu gy z fp oj fr fs ok fu fw is bi translated">快速数据库—快速应用程序(有用的数据库性能优化技术)</h2><div class="ol l"><h3 class="bd b gy z fp oj fr fs ok fu fw dk translated">了解加速关系数据库的最佳实践。</h3></div><div class="om l"><p class="bd b dl z fp oj fr fs ok fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="on l"><div class="oo l op oq or on os ks oe"/></div></div></a></div><p id="48ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有，考虑成为<a class="ae ky" href="https://esashamathews.medium.com/membership" rel="noopener">中等会员</a>。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1c70" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">分级编码</h1><p id="cdf6" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="7289" class="nm nn it lb b lc ld lf lg li no lm np lq nq lu nr ns nt nu bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="0f8b" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">📰更多内容请查看<a class="ae ky" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码刊物</a></li><li id="18df" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">🔔关注我们:<a class="ae ky" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a> | <a class="ae ky" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a> | <a class="ae ky" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="2ac5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">🚀👉<a class="ae ky" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>