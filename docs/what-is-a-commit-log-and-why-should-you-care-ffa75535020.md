# 什么是提交日志，为什么要关注它？

> 原文：<https://levelup.gitconnected.com/what-is-a-commit-log-and-why-should-you-care-ffa75535020>

在软件开发中，日志随处可见。没有它们，就不会有关系数据库、git 版本控制或大多数分析平台。

![](img/c260191a0dc6bfa3a2ebfb7ec597ae22.png)

日志。你知道，就像提交日志。

对于许多开发人员来说，这是我们与日志关系的终结。我们使用依赖于日志的工具。我们求助于日志来理解为什么会出错。直到最近，你可能会在整个职业生涯中没有比这更深入的思考。

特别是提交日志，已经走出了舞台，成为人们关注的焦点。作为 Apache Kafka 等工具的核心，提交日志对于处理不断增长的数据量、为分布式系统带来一致性以及为微服务架构提供公共的事实来源至关重要。

理解提交日志的工作方式将有助于您使用 Kafka 等工具构建更具弹性的系统。

# 这是一根木头，仅此而已

好消息是提交日志非常简单。它们是一系列记录，每个记录都有自己唯一的标识符。想要添加记录吗？没问题，它被附加在日志的末尾。想要更改现有记录吗？那你做不到；一旦写入，记录是不可改变的。

![](img/16a3b636611837b7049588a5ae801117.png)

读书呢？那总是从左到右发生。虽然没有查询，但您可以使用偏移量来指定读取的起点和终点。

仅此而已。我们都可以回家了。嗯，也许还不是时候。通常，原始的“是什么”远不如“为什么”有趣。

# 即使其他人都离开了你，日志还在

提交日志已经存在很长时间了，这是因为它们解决了软件开发中的一个核心问题。它们为系统中发生的事情以及发生的顺序提供了事实的来源。

让我们考虑一个关系数据库，比如 PostgreSQL。在 Postgres 中，提交日志被称为预写日志。在表或索引中的数据发生更改之前，每次写入 Postgres 数据库都必须首先记录在预写日志中。第一个好处是它加快了数据库写入的速度。

即使在磁盘上，写入提交日志也相对较快。写入更复杂的数据结构，如关系表，必然会更慢。只要事务被记录在预写日志中，对索引和表的更改就可以发生在内存中，随后将一个页面写入磁盘。这样，写入数据库的缓慢部分就异步发生了。即使在将表和索引更改写入磁盘之前从服务器上拔下插头，也可以按照预写日志中记录的顺序重新创建数据库。

更大的好处可能是，任何数据库都可以简单地按照预写日志从头重新创建。无论是作为灾难恢复的一部分，还是为了将实时更改流式传输到只读副本。

现在，如果提交日志可以达到同样目的，不仅仅是针对数据库，而是针对整个软件架构，会怎么样呢？

# 日志可以处理卷

假设您正在构建一个电子商务应用程序。你想更好地了解客户是如何浏览网站的，所以你记录下每一次点击，每一个搜索词，每一次页面浏览。

不管您以后如何处理这些数据，您首先需要捕获它们。也许最快的解决方案是将每个事件存储在操作数据库中。但这让你在交易中站错了队。操作数据库(很可能是关系数据库)的写时间相对较慢。这很好，因为它给你带来了很多好处，比如丰富的查询、事务性和可变性。但是现在你想做的只是获取数据，然后担心以后如何处理这些数据。

一种选择是将 Redis 放在操作数据库的前面，这样它可以吸收卷并以适合主数据库的速度缓慢释放。然而，这只是抵消了问题，让您相对昂贵的操作数据库充满了半结构化数据。访问者的数据量非常大，没有必要为了处理这种“值得拥有”的数据而增加运营数据库的成本和复杂性。

然而，提交日志是理想的。您需要存储的数据由离散的有序事件组成。提交日志的简单性意味着它们可以轻松处理比典型的关系数据库大得多的数据量。

事实上，这是 Apache Kafka 的一个典型用例，它将提交日志置于其数据模型的核心。

# 日志是真理的来源

日志很快，很简单，可以处理大量数据，并且是事实的来源。这使得它们非常适合多个自治组件构成一个系统的情况。这可能是一个成熟的微服务架构，也可能是一个整体，其中已经分离出一两个流程。

![](img/3c8f97f40d44c26f982a1caf9c0dd0b0.png)

在这些情况下，日志有两个作用。一个是它为系统的所有部分提供了一个单一的地方来发现变化。另一个是，它仅仅通过它如何工作的事实，就给那些变化强加了一个秩序。让我们回到电子商务来探讨这意味着什么。

假设我们有一个简单的电子商务应用程序，由五个不同的服务组成:目录、支付、订单、客户和运输。在这种情况下，客户订单可能采用以下路径:

1.  订单系统将客户订单写入日志。
2.  目录系统从日志中读取订单，并检查是否有足够的库存来履行订单。它发现有，因此相应地临时减少库存数量，并在日志中写入一条新记录，表明订单可以履行。
3.  支付系统读取显示订单可以履行的记录，并尝试从客户的卡中付款。支付成功，支付系统写回订单可以进行的日志。
4.  运输系统读取日志并准备订单进行配送。
5.  客户系统读取相同的条目，并用新订单的详细信息更新客户的记录。
6.  仓库中的调度员在运输系统中将包裹标记为已发送。运输系统将包裹已经运输的信息写入日志。
7.  客户系统从装运系统看到状态变化，并相应地更新客户的跟踪信息。
8.  该目录确认了先前库存水平的暂时降低。

实际上，还有更多的步骤。例如，当库存减少消息出现在日志中时，可能会有一个完整的微服务投入使用，并将操作数据库中的库存水平减少适当的量。然而，关键是，这些系统中的每一个都不会直接交互。每个都写入和读取日志。这有几个好处。

有了日志作为事实的来源，就不会有一个服务意外抢占或否决另一个服务的危险，因为一切都是按顺序发生的。另一个好处是，只要日志可用，即使某些组件离线，系统理论上也可以继续运行。

# 提交到日志

你可以建立自己的日志，但是使用 Apache Kafka 这样的工具，你可能会获得更好的时间回报。

Kafka 为您提供了提交日志的主要优势——不可变的有序事件记录——与通用数据源集成的优势，将数据写出到 Postgres 等其他系统的优势，以及对其处理的数据进行操作和转换的能力。大多数通用语言都有 SDK，如果你使用托管服务，你不需要担心管理你自己的 Kafka 集群。相信我，这不是一个小任务；看看 Heroku 如何管理他们庞大的卡夫卡实例舰队。

*日志照片由*[奥利弗·帕斯克](https://unsplash.com/@photolli) *林活页夹照片由* [*维克多·塔拉舒克*](https://unsplash.com/@viktortalashuk) *真相照片由* [*玛格达·埃勒斯*](https://www.pexels.com/@magda-ehlers-pexels)