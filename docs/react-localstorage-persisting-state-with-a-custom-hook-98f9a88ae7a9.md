# 反应💘localStorage:用自定义挂钩保持状态

> 原文：<https://levelup.gitconnected.com/react-localstorage-persisting-state-with-a-custom-hook-98f9a88ae7a9>

## 这不一定很难

![](img/d910d1536a0dc536fba4946280952004.png)

照片由 [S Migaj](https://unsplash.com/@simonmigaj?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

在构建 React 应用程序时，您可能会遇到一些情况(比如说，黑暗模式切换),此时跨页面重新加载自动保持组件的状态会很方便——在可以采用的许多解决方案中，最容易也最实用的无疑是本地存储 API。

# 本地存储概述

`localStorage`对象提供了对简单的同步键值存储的访问，其中键和值都是字符串。我们需要记住两种主要方法:

*   `**getItem**`，它接受一个`keyName`作为其唯一的参数，并返回与该键相关联的值(如果该键不存在值，则返回`null`)，以及
*   `**setItem**`，它接受一个`keyName`和`value`作为它的两个参数，并且不出所料，在给定的键上存储指定的值。

其他值得一提但与本文的目的无关的方法包括`removeItem`(在给定的`keyName`处删除一个值)和`clear`(不接受参数并删除所有存储的值)。

但是，如果我们想存储一个不是字符串的值呢？为此，我们必须使用`**JSON.stringify**`方法将它转换成一个字符串——然后，当我们想要检索数据时，我们必须`**JSON.parse**`它来获得原始值。注意，这允许存储字符串、数字、对象、数组、布尔值和`null`值:`undefined`值和函数将被`JSON.stringify`忽略，因此它们不能存储在本地存储中。

# 构建自定义挂钩

现在让我们回顾一下创建自定义 React 挂钩的过程，以便自动将组件的状态保存到本地存储中。

我们将首先创建一个`usePersistedState`函数，它接受两个参数:

*   `defaultValue`，如果无法从本地存储中检索，则为初始状态，以及
*   `localStorageKey`，用于在本地存储中存储和检索状态的唯一键。

# 从本地存储中检索状态

现在让我们编写处理基本状态检索的逻辑:正如我们提到的，我们将从本地存储中获取值，并使用`JSON.parse`来获取原始值。我们将使用`useState`钩子将我们的状态存储在内存中(这就是定制钩子的构建方式——通过组合像`useState`这样的本机钩子)。

我们现在将处理几个边缘情况。即:

*   如果本地存储中没有存储任何值，我们将使用提供的默认值，并且
*   如果存储了无效的 JSON，`JSON.parse`将抛出一个错误，我们将再次使用默认值。

在代码中，这对应于:

我们已成功检索初始值！现在，让我们继续每当状态改变时在本地存储中更新它。

# 监听更改并更新本地存储

这个更简单:每当`value`改变时，我们就使用提供的`localStorageKey`将它字符串化并存储回本地存储。我们将为此使用一个`useEffect`钩子。

在进行下一步之前，关于性能的一个注意事项:正如我们已经说过的，`localStorage` API 是同步的，这意味着它阻塞了主线程。现在，这不是简单数据的问题，但如果你在有大量复杂数据的应用程序中使用它，这可能会成为一个问题。要提高性能，您有两种选择:

*   不要在`value`改变的时候保存，而是每隔一段时间定期保存。
*   或者，去抖状态更新:即，每当`value`改变时，等待片刻，然后将状态保存到本地存储器中。这样，多次连续的状态更新只会导致一次本地存储写入。

# 包装一切:使挂钩可用

你可能已经注意到，我们的钩子一直没有返回任何东西:我们现在将通过返回`value`和`setValue`来修复这个问题，就像`useState`钩子所做的那样。所以，把所有这些放在一起，这就是我们得到的:

瞧啊！一个简单的 React 挂钩，用于在本地存储中检索和保存状态。

# 最终考虑

我们已经看到了这种方法的性能含义，所以让我们跳到其他一些考虑事项。首先，从安全的角度来看，您应该记住本地存储是以不加密的方式存储在磁盘上的，并且可以被在您的域上运行的所有 JavaScript 代码访问——这本身不是问题，但这意味着您需要格外小心来保护您的网站免受 XSS(跨站点脚本)攻击。

其次，应该提到的是，您可以在本地存储中存储的数据量有一个硬限制:5 兆字节——超过一个字节，`localStorage.setItem`就会抛出错误。但是，只要您没有存储极其复杂的数据(比如整个文件)，这应该不是一个问题——为此，您可能需要考虑其他解决方案，比如 IndexedDB API。

# 总结一下:我们学到了什么

让我们巩固一下知识吧！在本文中，我们…

*   学习了`localStorage` API 的基础知识，
*   了解了 JSON 解析和序列化，
*   应用我们关于`useState`和`useEffect`的知识来创建一个定制的 React 钩子，并且
*   做了一些关于使用`localStorage` API 的考虑。

你认为你已经掌握了所有这些概念吗？如果是这样的话，我鼓励你自己练习:比如，你可以通过去抖动状态变化来尝试改进这个钩子。否则，请随时联系并要求澄清！我会去帮忙的。