<html>
<head>
<title>Comparing Java WebSockets: Jetty vs. Netty</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">比较Java WebSockets: Jetty与Netty</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/comparing-java-websockets-jetty-vs-netty-ba128ddca313?source=collection_archive---------14-----------------------#2021-01-12">https://levelup.gitconnected.com/comparing-java-websockets-jetty-vs-netty-ba128ddca313?source=collection_archive---------14-----------------------#2021-01-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/41004440899d570b231b314991476519.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rHNaQ-uUOPVTTfUr.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">学分:<a class="ae kc" href="https://symphony-solutions.com/" rel="noopener ugc nofollow" target="_blank"> Symphony Solutions </a></figcaption></figure><p id="d7f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本文向我们展示了使用标准测试工具比较Java中两个WebSocket实现Jetty和Netty的一步一步的过程。</p><p id="425c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将通过以下属性来比较这两种实现:平均和最大响应时间、内存消耗、小数据、平均数据和大数据的最大使用线程数。</p><h1 id="d063" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">你需要什么</h1><ul class=""><li id="f187" class="lz ma iq kf b kg mb kk mc ko md ks me kw mf la mg mh mi mj bi translated">Java 8</li><li id="afa5" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">JMeter 5.1.1</li><li id="2263" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">Java IDE</li><li id="6811" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">Maven 3</li><li id="08f3" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">VisualVM或任何Java分析器</li></ul><h1 id="032e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">你将使用什么</h1><p id="47bc" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我们将使用两个WebSocket实现:</p><ul class=""><li id="c7a4" class="lz ma iq kf b kg kh kk kl ko ms ks mt kw mu la mg mh mi mj bi translated">【Eclipse基金会的码头</li><li id="bda9" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated"><a class="ae kc" href="https://github.com/mrniko/netty-socketio" rel="noopener ugc nofollow" target="_blank"> Netty开源Java实现的Socket。IO服务器</a>。</li></ul><h1 id="5a26" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">下载源</h1><p id="b7a1" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">首先，你需要从<a class="ae kc" href="https://github.com/vhavryk/compare-jetty-netty" rel="noopener ugc nofollow" target="_blank">https://github.com/vhavryk/compare-jetty-netty</a>下载源代码。</p><p id="9ba7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我已经更改了两个项目的演示，以便使用<a class="ae kc" href="https://jmeter.apache.org/" rel="noopener ugc nofollow" target="_blank"> JMeter </a>正确运行负载测试。我在两个项目中都添加了一个新文件<a class="ae kc" href="https://github.com/vhavryk/compare-jetty-netty/blob/main/native-jetty-websocket-example/src/main/java/org/eclipse/jetty/demo/DataFileLoader.java" rel="noopener ugc nofollow" target="_blank"> DataFileLoader </a>，它使用env变量<strong class="kf ir">“data-file-name”从文件中加载数据。</strong>稍后，我们将使用数据从服务器发送到客户端(JMeter)。</p><h1 id="aa87" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Jetty WebSocket服务器</h1><p id="7e84" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我改了两个文件<a class="ae kc" href="https://github.com/vhavryk/compare-jetty-netty/blob/main/native-jetty-websocket-example/src/main/java/org/eclipse/jetty/demo/EventServer.java" rel="noopener ugc nofollow" target="_blank"> EventServer </a>和EventSocket:</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="7d47" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，我们可以在连接打开后将数据从服务器发送到客户端。<br/>要构建一个项目，我们需要转到<a class="ae kc" href="https://github.com/vhavryk/compare-jetty-netty/tree/main/native-jetty-websocket-example" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">native-jetty-web socket-example</strong></a>文件夹并运行命令:</p><pre class="mv mw mx my gt nb nc nd ne aw nf bi"><span id="5426" class="ng lc iq nc b gy nh ni l nj nk"><strong class="nc ir">mvn clean install</strong></span></pre><p id="a878" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">转到<strong class="kf ir">目标</strong>文件夹并运行命令:</p><pre class="mv mw mx my gt nb nc nd ne aw nf bi"><span id="c8c5" class="ng lc iq nc b gy nh ni l nj nk"><strong class="nc ir">java -Ddata-file-name=small.json jar native-jetty-websocket-example-1.0-SNAPSHOT.jar</strong></span></pre><p id="2dc1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">之后，Jetty服务器开始使用small.json文件中的数据。</p><h1 id="32df" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Netty网络套接字服务器</h1><p id="cb96" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我已经更改了一个文件<a class="ae kc" href="https://github.com/vhavryk/compare-jetty-netty/blob/main/netty-socketio-demo/server/src/main/java/com/corundumstudio/socketio/demo/ChatLauncher.java" rel="noopener ugc nofollow" target="_blank"> ChatLauncher </a>:</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="621d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我添加了对重用地址的支持，以解决JMeter WebSocket插件的问题。此外，我将数据接收者从“所有客户端”更改为“一个连接的客户端”。要构建项目，我们需要转到<a class="ae kc" href="https://github.com/vhavryk/compare-jetty-netty/tree/main/netty-socketio-demo/server" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">netty-socketi o-demo/server</strong></a>文件夹并运行命令:</p><pre class="mv mw mx my gt nb nc nd ne aw nf bi"><span id="bfc5" class="ng lc iq nc b gy nh ni l nj nk"><strong class="nc ir">mvn clean install</strong></span></pre><p id="716e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">之后，转到<strong class="kf ir">目标</strong>文件夹并运行命令:</p><pre class="mv mw mx my gt nb nc nd ne aw nf bi"><span id="8677" class="ng lc iq nc b gy nh ni l nj nk">java -Ddata-file-name=large.json -jar demo-1.0.0-SNAPSHOT.jar</span></pre><p id="9872" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Netty服务器开始使用large.json文件中的数据。</p><h1 id="5c4a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">负载测试配置</h1><p id="9302" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我们将使用<a class="ae kc" href="https://jmeter.apache.org/" rel="noopener ugc nofollow" target="_blank"> JMeter工具</a>在<a class="ae kc" href="https://bitbucket.org/pjtr/jmeter-websocket-samplers/src/master/" rel="noopener ugc nofollow" target="_blank"> JMeter WebSocket采样器</a>的帮助下对两台服务器进行负载测试。<br/>我为Netty和Jetty服务器创建了两个不同的JMeter场景，因为Jetty服务器需要三个帧来读取数据，而Netty服务器需要五个帧。你可以在<a class="ae kc" href="https://github.com/vhavryk/compare-jetty-netty/tree/main/jmeter" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> JMeter </strong> </a>文件夹<strong class="kf ir">中找到这两种场景。</strong>此外，请忽略Netty场景中的错误，因为我们使用的插件与Netty WebSocket实现不完全兼容，它不能正确处理close事件的响应。</p><p id="586b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一般负载测试配置如下表所示:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/bcd210bd96dbd3c4816d39022af87164.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c8hxxuFKz5vmQcZgkwLQWg.png"/></div></div></figure><h1 id="5530" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">负载测试方法</h1><p id="00b6" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我们将从负载测试中收集以下数据:</p><ul class=""><li id="1c27" class="lz ma iq kf b kg kh kk kl ko ms ks mt kw mu la mg mh mi mj bi translated">数据文件大小(KB) —服务器将发送给客户端的数据</li><li id="e10f" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">打开连接的平均响应时间(毫秒)</li><li id="8c4d" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">打开连接的最大响应时间(毫秒)</li><li id="3b0e" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">读取数据的平均响应时间(毫秒)</li><li id="0af1" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">读取数据的最大响应时间(毫秒)</li><li id="2c47" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">最大堆大小(MB)</li><li id="09f0" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">创建的最大线程数</li></ul><p id="0e07" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">收集这些数据将通过以下步骤完成:</p><ol class=""><li id="72c7" class="lz ma iq kf b kg kh kk kl ko ms ks mt kw mu la nm mh mi mj bi translated">使用-Ddata-file-name={filename}参数运行服务器</li><li id="f003" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la nm mh mi mj bi translated">运行JMeter并从JMeter文件夹中打开相应的场景</li><li id="260c" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la nm mh mi mj bi translated">运行方案并收集聚合报告数据</li><li id="bf88" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la nm mh mi mj bi translated">运行VisualVM或任何Java profiler并连接到服务器</li><li id="6a73" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la nm mh mi mj bi translated">运行场景并收集监控数据:内存和创建的线程数</li><li id="b220" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la nm mh mi mj bi translated">关闭/停止探查器和服务器。</li><li id="5914" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la nm mh mi mj bi translated">对下一个数据文件重复这些步骤。</li></ol><p id="d4c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我已经完成了所有的步骤并收集了<a class="ae kc" href="https://github.com/vhavryk/compare-jetty-netty/tree/main/reports" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">报告</strong> </a>文件夹中的信息。<br/>接下来，我们将分析结果。</p><h1 id="cdb2" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">小数据负载测试分析</h1><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/1fe7cff16e65dd35a9b45962181d10c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-dOVlE7ftBjD_AMc.png"/></div></div></figure><p id="6aac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所见，对于小文件，Jetty的响应时间比Netty短。最大堆大小是可比的。但是Netty使用的线程更少。</p><p id="4b83" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">获胜者:突堤</strong></p><h1 id="89aa" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">有中间数据的负载测试分析</h1><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/9f3ab66adcaf0ba9c302249e20c63cb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FnLq-WismLa7e_kL.png"/></div></div></figure><p id="d135" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这种情况下没有明显的赢家:</p><ul class=""><li id="cf1b" class="lz ma iq kf b kg kh kk kl ko ms ks mt kw mu la mg mh mi mj bi translated">Jetty在打开连接方面稍好一些，但是消耗更多的内存和使用更多的线程。</li></ul><h1 id="46fc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">大数据负载测试分析</h1><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/b913d4befd94d9d15898654daba682b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*18UEFfaSofQxc8SM.png"/></div></div></figure><p id="5f50" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种情况下，我们有两个赢家:</p><ul class=""><li id="e758" class="lz ma iq kf b kg kh kk kl ko ms ks mt kw mu la mg mh mi mj bi translated">就响应时间而言，Jetty更好。</li><li id="dd16" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">Netty在内存消耗和线程数量方面更胜一筹。</li></ul><h1 id="6a98" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">一般分析</h1><p id="b6d6" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">根据聚合报告，我们可以发现Netty的最大响应时间比Jetty长，但消耗的内存和创建的线程更少。两个服务器都在努力争取最大时间，尤其是Netty。因此，要在生产中使用这些服务器，您需要找到处理从服务器到客户端(使用超时和重试)或/和服务器的长响应的解决方案。</p><h1 id="6d2e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">最后的话</h1><p id="18d6" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">一般来说，没有明显的赢家，但是对于客户端到服务器的数据传输中的小数据量(小于2KB)，最好使用Jetty。对于平均数据大小或任何超过10KB的数据，由于内存和线程的最佳使用，最好使用Netty。</p></div></div>    
</body>
</html>