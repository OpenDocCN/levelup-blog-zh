<html>
<head>
<title>Troubleshooting CORS Errors</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CORS错误故障排除</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/troubleshooting-cors-errors-67eaded865d1?source=collection_archive---------2-----------------------#2022-02-26">https://levelup.gitconnected.com/troubleshooting-cors-errors-67eaded865d1?source=collection_archive---------2-----------------------#2022-02-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="064f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">深入探究Azure中的设置如何CORS错误</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2e5afc473c87d056cad62eee5954cfdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wAGh6wJWDkyuu3B2"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@asher_yj" rel="noopener ugc nofollow" target="_blank">摄影张</a>在<a class="ae ky" href="https://unsplash.com/photos/8JJ_sPcUaNA" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="4e06" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">前几天，我在工作中遇到了一个需要解决的问题。我们的web应用程序无法向我们的web服务发出HTTP请求。</p><p id="58f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在网络选项卡中，您可以看到关于CORS的错误。除此之外，其中一个请求的响应代码是<code class="fe lv lw lx ly b">Ip Forbidden</code>。</p><h1 id="c499" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">四个要求</h1><p id="9e1d" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">当web应用程序在浏览器中加载时，它尝试向我们的web服务发出一个请求，这将产生以下四个请求:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mw"><img src="../Images/e6354d44f46490051c6c0731ef6856ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rWlEaXtFJhLEt1VPkUzUMA.jpeg"/></div></div></figure><p id="1468" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看为什么这里列出了四个请求。</p><h2 id="2172" class="mx ma it bd mb my mz dn mf na nb dp mj li nc nd ml lm ne nf mn lq ng nh mp ni bi translated">第一个请求——飞行前请求</h2><p id="da58" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">当我们的web应用加载时发生的第一件事是，浏览器试图向Azure APIM发出GET请求，后者又将请求转发给我们的web服务。</p><p id="86ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为发送到APIM的请求包含非标准的报头，所以浏览器会进行飞行前检查，以确保web服务器能够识别CORS。</p><p id="af64" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您从下面的截图中看到的，飞行前请求是通过APIM处理的，它有一个CORS策略，允许任何来源/HTTP动词/头。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/8027e969688af401f1f1ac1a5726f7b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5mwaDeDiWmDSbCEaVRAnRA.jpeg"/></div></div></figure><p id="fd05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">APIM向浏览器返回一个带有适当访问控制头的200 OK响应，表示可以发送实际的GET请求。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/7aa4a6fb635dafb8c48c80ab349bce16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U1r0qwMuAwQG8AfJOBty7A.png"/></div></div></figure><h2 id="7136" class="mx ma it bd mb my mz dn mf na nb dp mj li nc nd ml lm ne nf mn lq ng nh mp ni bi translated">第二个请求— xhr/Redirect</h2><p id="256f" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">由于之前成功的飞行前请求，浏览器现在可以发出原始请求。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/3d64bf707d398c4a6bf4a68c61367d85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hb8kQZ5QtgUveZw4FLt3bA.png"/></div></div></figure><p id="1b8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个请求导致了一个<code class="fe lv lw lx ly b">301 Moved Permanently</code>响应。</p><p id="940d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是因为web服务APIM将请求转发到，使用HTTP:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/8d862cb91fbf7511b00ad705767ee678.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g3Y98hiRyo8CPw5m5Atl3g.png"/></div></div></figure><p id="e770" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，web服务被设置为只允许HTTPS请求:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/5f30db2e4d98756bcf8ce76b33366e87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ANUBpBkNkzd2-wwn5iSuaw.png"/></div></div></figure><p id="1918" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">web服务返回一个301给APIM，APIM将它转发给你的浏览器，告诉浏览器使用HTTPS版本的URL。</p><h2 id="2244" class="mx ma it bd mb my mz dn mf na nb dp mj li nc nd ml lm ne nf mn lq ng nh mp ni bi translated">第三个请求—飞行前请求</h2><p id="bb5c" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">这在Network选项卡中被列为第四个请求，但实际上是要执行的第三个请求。</p><p id="6cec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您查看第二个请求的屏幕截图中的响应头，您可以看到一个Location，header，这是web服务的URL，但是在开头是HTTPS而不是HTTP。</p><p id="a654" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就像之前飞往APIM的飞行前请求一样，该请求也是飞行前请求，因为它是非标准请求。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/dde3ce282ca615be4d69668207fbd20a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fnlJi7ALOTw-Lf-vUFP6Xg.png"/></div></div></figure><p id="a79f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，响应代码是<code class="fe lv lw lx ly b">403 Ip Forbidden</code>。</p><p id="20f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是因为web服务在Azure中设置为限制IP地址:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/c00570a5821aefabb352bfb6a4757d63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aMBB802BJ1hmY12QJn_CTQ.jpeg"/></div></div></figure><h2 id="3453" class="mx ma it bd mb my mz dn mf na nb dp mj li nc nd ml lm ne nf mn lq ng nh mp ni bi translated">第四个请求— xhr (CORS误差)</h2><p id="976b" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">这在浏览器中被列为第三个请求，但并不是真正的请求，因为浏览器甚至没有发送这个请求。</p><p id="7454" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果web服务用200 OK(和适当的访问控制头)而不是<code class="fe lv lw lx ly b">Ip Forbidden</code>来响应，这就是应该发出的请求。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/ef6d7849a06e770e52a84d01644f7255.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5tn3FEb7OVs9WEd_k2WknQ.png"/></div></div></figure><p id="39fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，您可以看到“显示临时标题”。这意味着由于飞行前请求失败，浏览器无法发送请求。</p><h1 id="2f01" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">怎么修</h1><p id="8bf1" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">通过将APIM设置为使用web服务URL的HTTPS版本而不是HTTP版本，不存在CORS/Ip禁止的错误:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/0da78fdf77614d8ea7b1128c2590a671.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G3BGczdQFPKWhgTTxva4_w.png"/></div></div></figure><p id="22f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个飞行前请求的工作方式和之前一样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/89f8149f0e14e5e410c60be17e08ffad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rO8ltgInMgLLmY0HnwxIzA.png"/></div></div></figure><p id="659b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为APIM调用HTTPS版本的web服务(它可以调用，因为它的IP不受限制)，所以不需要重定向。</p><p id="f12f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请求成功，响应被发送到您的浏览器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/a9896a16ee09fab398f89ac0b3513d45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wPWoNZYyqwHFNOGaMztwIw.png"/></div></div></figure><h1 id="c457" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">摘要</h1><p id="acb1" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">我希望这可以帮助你们中的一些人，他们在Azure上有类似的问题。</p><p id="3a48" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">理解Azure是如何工作的，尤其是IP限制、APIM和CORS是如何工作的，在调试失败的HTTP请求时会非常有帮助。</p></div></div>    
</body>
</html>