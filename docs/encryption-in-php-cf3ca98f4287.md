# PHP 中的加密

> 原文：<https://levelup.gitconnected.com/encryption-in-php-cf3ca98f4287>

## 查看现代加密标准并从废弃的 mcrypt 更新到 OpenSSL

更新我的用户管理系统在我的任务清单上已经有很长时间了。其中一个主要原因是加密系统。几年前我用 PHP 5.5 创建了当前版本。那时，在互联网上推荐使用 mcrypt。然而，从那时起，mcrypt 就被弃用了，并在 PHP 7.2 中被删除。因为加密对系统至关重要，而且事后很难更改，所以我花了几个小时阅读了当前 PHP 中对称加密的最佳实践，最后选择了 AES 256 GCM。

![](img/0cffb42c6ed7c8f15bbd12ae425b2558.png)

马库斯·温克勒在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

## 俄歇电子能谱

在基于 mcrypt 的旧版本中，我使用的是 Rijndael 128 CBC。AES 是 Rijndael 的子集，有时这两个名称可以互换使用。AES 的块大小始终为 128，并且仅支持 128、192 和 256 位密钥，而 Rijndael 针对所有块大小和密钥(从 128 到 256，以 32 位为增量)进行定义。顾名思义*高级加密标准*，AES 是许多组织和公司的标准加密方法。AES 192 和 256 也用于美国最高安全级别的文件。对 AES 有一些理论上的攻击，但是没有一个在当前的硬件上是实用的。由于其高安全性和广泛的支持，AES 是加密算法的合理选择。

## GCM vs CBC

新加密方法的最大变化是从 CBC 到 GCM。在 AES 算法中，CBC 和 GCM 是不同的模式。CBC 是在 70 年代发明的，从那以后发现了一些对它的理论攻击。视情况而定，大部分情况下还是足够安全的，但是现在推荐 GCM。GCM 于 2004 年发布，被认为安全得多。它还有一个内置的认证检查，这意味着可以确认消息的完整性。

另一个优点是，在 GCM 中，加密和解密是并行的，而在 CBC 中，只有解密是并行的。这意味着大文件的加密在多核 CPU 上可以快得多，尽管我怀疑 PHP OpenSSL 实现是否利用了它，我也不需要它来加密我所拥有的小消息。

两者之间最大的区别是对初始化向量(IV)的要求。CBC 需要一个强随机化的静脉注射，如果使用亚部分随机化算法，它会变弱。GCM 不需要对 IV 进行随机化，但是如果同一个 IV 用同一个密钥使用了两次，就会有一个重大的安全问题。事实上，如果您愿意，可以为 IV 使用增量计数器。因为我打算对不同的网站和应用程序使用加密系统，所以很难跟踪所有网站和应用程序的组合计数器。然而，只要同一个键没有被使用太多次，GCM 仍然可以使用随机 IV。AES 256 GCM 的 IV 长度是 96 位，这是较短的长度，但是仍然有 2⁹⁶的可能性。为了安全起见，这个密钥在转换之前应该只使用十亿次左右。我甚至不会很快接近它，所以它完全没问题。当然，在此之前，同样的随机 IV 被选中的可能性非常小，但在这种情况下，您无论如何都不需要使用加密，因为黑客在尝试几次后猜出正确密钥的可能性也非常小。

## 密钥长度

与 mcrypt 版本中的 128 位相比，我还在新的 OpenSSL 加密中使用了更高的密钥长度 256 位。128 位密钥仍然足够安全，尤其是在使用 GCM 的附加安全性时。许多公司使用 AES 128 GCM，因为它比 AES 256 GCM 速度更快。然而，我不想再次更新系统，我只有几个用户，所以服务器性能不是问题。因此，我还不如使用更安全的版本。

此外，我的数据只有一小部分是加密的，我不存储任何敏感信息，我也不是黑客的目标，所以使用 AES 256 GCM 可能是大材小用，但我也不会受到伤害。

## 履行

这个实现没有任何特别之处。与 CBC 不同，GCM 在加密时创建一个需要提供给解密函数的授权标记，但与 IV 一样，它不需要保密，所以它被附加到结果中。mcrypt 版本的一个变化是使用了 base64 编码。我以前没有使用它，只是将二进制数据存储在数据库中，但每当我必须查看数据库时，格式就完全混乱了。另一方面，Base64 编码的文本是人类可读的，并且使数据库看起来更漂亮。它确实使用了更多的存储空间，但是我目前并没有对很多数据进行加密，所以这是一个小问题。

在研究了当前 PHP 加密的最佳实践后，我选择了 AES 256 GCM。这是最高的加密标准，用于绝密政府文件。对于我的用例来说，这几乎肯定是完全多余的，但对中情局来说足够好的东西可能足以加密我每周在杂货上花了多少钱。