<html>
<head>
<title>Monorepo: Dynamic Multi-Stage Docker Layer Caching using Kaniko + Cloud Build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Monorepo:使用Kaniko +云构建的动态多级Docker层缓存</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/monorepo-dynamic-multi-stage-docker-layer-caching-using-kaniko-cloud-build-7e201035b30b?source=collection_archive---------11-----------------------#2022-07-03">https://levelup.gitconnected.com/monorepo-dynamic-multi-stage-docker-layer-caching-using-kaniko-cloud-build-7e201035b30b?source=collection_archive---------11-----------------------#2022-07-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="ac8c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇简明的教程中，我将向您展示一种在monorepo中共享您的应用程序的Docker文件的好方法，并使用Kaniko和Cloud Build来缓存所有多阶段Docker层。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/bcd54b61c3d620c2bb399d3835054c73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*wbo-bzU0yI21_o2FEH6wbw.png"/></div></figure><h1 id="adb3" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">追踪</h1><p id="d0a9" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">这篇文章是我之前的一篇文章的后续，你可以在这里找到<a class="ae lz" rel="noopener ugc nofollow" target="_blank" href="/multi-stage-docker-layer-caching-using-kaniko-cloud-build-7e46395fb2c2"/>。</p><div class="ma mb gp gr mc md"><a rel="noopener  ugc nofollow" target="_blank" href="/multi-stage-docker-layer-caching-using-kaniko-cloud-build-7e46395fb2c2"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd iu gy z fp mi fr fs mj fu fw is bi translated">使用Kaniko +云构建的多级Docker层缓存</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">简要介绍如何在云构建中使用Kaniko，并验证多阶段Docker映像是否被正确缓存。</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="mm l"><div class="mn l mo mp mq mm mr ku md"/></div></div></a></div><p id="ad6a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以将本文视为一个“高级”版本，它是在monorepo用例的基础上创建的，其中几个服务共享同一个Dockerfile，这至少在我的工作环境中是常见的。</p><p id="51e4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">需要注意的是，我不会在本教程中遍历每一行代码，而只会遍历与这个高级版本相关的代码。因此，请务必检查之前的文章。</p><h1 id="52b7" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">GitHub知识库</h1><p id="f8e4" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">要查看使用的代码，请查看我为本文创建的<a class="ae lz" href="https://github.com/mr-pascal/medium-cloud-build-kaniko-monorepo" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>。</p><div class="ma mb gp gr mc md"><a href="https://github.com/mr-pascal/medium-cloud-build-kaniko-monorepo" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd iu gy z fp mi fr fs mj fu fw is bi translated">GitHub-Mr-Pascal/medium-cloud-build-kaniko-mono repo</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="ms l mo mp mq mm mr ku md"/></div></div></a></div><h1 id="adf3" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">文件夹结构</h1><p id="efc7" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">因此，让我们首先浏览一下我们的文件夹结构和我们将在本文中讨论的单个文件</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="9bee" class="my kx it mu b gy mz na l nb nc">|- kaniko-demo/<br/>|- kaniko-demo2/<br/>|- build.sh<br/>|- cloudbuild.yaml<br/>|- Dockerfile</span></pre><ul class=""><li id="71e6" class="nd ne it js b jt ju jx jy kb nf kf ng kj nh kn ni nj nk nl bi translated">我们的演示应用程序。只是一个新的Nest.js应用。</li><li id="8001" class="nd ne it js b jt np jx nq kb nr kf ns kj nt kn ni nj nk nl bi translated"><code class="fe nm nn no mu b">kaniko-demo2</code> —另一个演示应用。只是一个新的Nest.js应用。</li><li id="c6ea" class="nd ne it js b jt np jx nq kb nr kf ns kj nt kn ni nj nk nl bi translated"><code class="fe nm nn no mu b">build.sh</code> —一个带有参数的小型shell脚本，有助于简化我们的构建，以构建本地Docker映像或将构建提交到云构建。</li><li id="ab34" class="nd ne it js b jt np jx nq kb nr kf ns kj nt kn ni nj nk nl bi translated"><code class="fe nm nn no mu b">Dockerfile</code> —两个演示应用程序使用的Dockerfile文件。</li></ul><h1 id="5eae" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">代码</h1><p id="d42d" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">为了使之前的<a class="ae lz" rel="noopener ugc nofollow" target="_blank" href="/multi-stage-docker-layer-caching-using-kaniko-cloud-build-7e46395fb2c2">教程</a>中的示例为monorepo设置中的流线型构建步骤做好准备，我们必须调整<code class="fe nm nn no mu b">Dockerfile</code>、<code class="fe nm nn no mu b">cloudbuild.yaml</code>并提供一种通过shell脚本构建映像的动态方式。</p><h2 id="754a" class="my kx it bd ky nu nv dn lc nw nx dp lg kb ny nz lk kf oa ob lo kj oc od ls oe bi translated">Dockerfile文件</h2><p id="c62a" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">一般来说，你的<code class="fe nm nn no mu b">Dockerfile</code>在你的应用程序的文件夹里。有了monorepo，你仍然可以走这条路。即使您经常想要共享Docker构建配置，而不是为每一个服务复制&amp;粘贴它。</p><p id="4750" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为此，您的<code class="fe nm nn no mu b">Dockerfile</code>需要更加通用，并且位于您的服务文件夹之外。</p><p id="959b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们来看下面的<code class="fe nm nn no mu b">Dockerfile</code>。该文件与上一篇文章中的文件几乎相同，尽管有四行代码是新的，并标有<code class="fe nm nn no mu b">## NEW!!</code>注释，所以您更容易发现。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="56aa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们到底在那里做了什么？</p><p id="9168" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于Docker文件在实际的服务文件夹之外，我们必须为Docker提供一个指向源代码的路径，因为它可能在任何地方。为此，我们添加了一个名为<code class="fe nm nn no mu b">SRC_DIR</code>的构建参数。这个参数稍后将被设置为我们的服务的文件夹名，例如<code class="fe nm nn no mu b">kaniko-demo2</code>。使用这个参数，我们可以动态地构建到<code class="fe nm nn no mu b">package.json</code>、<code class="fe nm nn no mu b">package-lock.json</code>和剩余源文件的文件路径。</p><p id="4aa6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于<code class="fe nm nn no mu b">Dockerfile</code>，我们没有什么需要改变的了。</p><h2 id="29df" class="my kx it bd ky nu nv dn lc nw nx dp lg kb ny nz lk kf oa ob lo kj oc od ls oe bi translated">cloudbuild.yaml</h2><p id="6c05" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">当然，我们还必须告诉云构建配置，它现在必须构建Docker映像。这里我们还必须更改三行代码</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="f4b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用<code class="fe nm nn no mu b">--dockerfile=${_DOCKER_FILE}</code>参数，我们告诉Cloud Build和Kaniko，将有一个<code class="fe nm nn no mu b">_DOCKER_FILE</code>参数传递给Cloud Build命令，Kaniko应该使用这个参数作为到<code class="fe nm nn no mu b">Dockerfile</code>的路径。</p><p id="ce7b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe nm nn no mu b">--build-arg=SRC_DIR=${_APP}</code>表示将传递一个<code class="fe nm nn no mu b">_APP</code>参数，Kaniko应将该参数用作Docker构建参数<code class="fe nm nn no mu b">SRC_DIR</code>的值，该参数在<code class="fe nm nn no mu b">Dockerfile</code>中定义。</p><p id="b152" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后但同样重要的是，我们必须调整<code class="fe nm nn no mu b">--destination</code>参数的值。我们需要使用<code class="fe nm nn no mu b">${_APP}</code>而不是硬编码的<code class="fe nm nn no mu b">kaniko-demo</code>。</p><p id="6e83" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以你看，<code class="fe nm nn no mu b">cloudbuild.yaml</code>的变化也是毫不费力和直接的。</p><h2 id="8439" class="my kx it bd ky nu nv dn lc nw nx dp lg kb ny nz lk kf oa ob lo kj oc od ls oe bi translated">build.sh</h2><p id="701f" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">但是现在，让我们通过设置定制构建脚本来进入更激动人心的部分。</p><p id="c20d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下面的<code class="fe nm nn no mu b">build.sh</code>文件中，我将向您展示如何通过共享的<code class="fe nm nn no mu b">Dockerfile</code>动态构建您的应用程序，而不会增加构建上下文。</p><p id="5602" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，您可能会忽略前35行代码，因为它们更像是“辅助代码”，而不是重要的逻辑。但简而言之，这段代码为您的shell脚本提供了接受一个<code class="fe nm nn no mu b">-c</code>标志和一个<code class="fe nm nn no mu b">-a $APP</code>参数的可能性。</p><p id="9fb8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，您可以通过这些命令运行以下构建脚本:</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="a945" class="my kx it mu b gy mz na l nb nc"># Build "kaniko-demo" app on your local machine<br/>./build.sh -a kaniko-demo</span><span id="b609" class="my kx it mu b gy oh na l nb nc"># Build "kaniko-demo" app on Cloud Build<br/>./build.sh -c -a kaniko-demo</span></pre><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="a896" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我试图在shell脚本的重要部分添加一些有意义的命令，但是让我们一起来看一下它的几个部分:</p><p id="07f2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，我们为什么需要专用的Dockerfile和。dockerignore？</p><p id="b220" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可能认为你不需要一个专用的<code class="fe nm nn no mu b">Dockerfile</code>,因为无论如何都是相同的命令，对吗？但是有一个技巧，为什么它仍然是必需的，当我们将参数传递给<code class="fe nm nn no mu b">docker build</code>命令时，您将在本文的后面找到这个技巧。</p><p id="6f84" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另一方面，<code class="fe nm nn no mu b">*.dockerignore</code>非常重要。我认为构建文件夹<code class="fe nm nn no mu b">dist</code>和<code class="fe nm nn no mu b">node_modules</code>文件夹应该总是被排除在外，这是很清楚的常识。但是为什么我们首先忽略一切，然后显式启用我们想要构建的应用程序的源文件夹呢？</p><p id="a897" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Docker，还有云构建，总是接受构建上下文。在脚本中，通过<code class="fe nm nn no mu b">.</code>获取当前文件夹，其中包含所有文件和服务。当然，这不是您想要的，因为您只想构建一个服务。为了实现这一点，我们首先忽略所有内容，然后将实际的服务源代码放回去。</p><h2 id="05f7" class="my kx it bd ky nu nv dn lc nw nx dp lg kb ny nz lk kf oa ob lo kj oc od ls oe bi translated">添加参数</h2><p id="89f6" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">现在临时的<code class="fe nm nn no mu b">Dockerfile</code>和<code class="fe nm nn no mu b">.dockerignore</code>文件已经创建，我们可以提供<code class="fe nm nn no mu b">gcloud builds submit</code>和<code class="fe nm nn no mu b">docker build</code>命令服务名以及它们应该使用的<code class="fe nm nn no mu b">Dockerfile</code>。</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="ced4" class="my kx it mu b gy mz na l nb nc">## Build via Cloud Build<br/>gcloud builds submit --region europe-west2 \<br/>            --config cloudbuild.yaml \<br/>            --ignore-file $DOCKER_IGNORE_FILE \<br/>            --substitutions _DOCKER_FILE=$DOCKER_FILE,_APP=$APP \<br/>            .</span><span id="38e8" class="my kx it mu b gy oh na l nb nc"># Build via local Docker<br/>docker build -t $APP -f $DOCKER_FILE --build-arg SRC_DIR=$APP .</span></pre><p id="7530" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可能会注意到没有为<code class="fe nm nn no mu b">docker build</code>命令定义特定的<code class="fe nm nn no mu b">.dockerignore</code>文件。但这不是问题。得益于Docker v19.03版本，Docker足够聪明，可以根据提供的<code class="fe nm nn no mu b">Dockerfile</code>的名称加载自定义的<code class="fe nm nn no mu b">.dockerignore</code>文件:</p><blockquote class="oi oj ok"><p id="8d17" class="jq jr ol js b jt ju jv jw jx jy jz ka om kc kd ke on kg kh ki oo kk kl km kn im bi translated">Docker客户端首先尝试加载<code class="fe nm nn no mu b">&lt;dockerfile-name&gt;.dockerignore</code>，如果找不到，则退回到<code class="fe nm nn no mu b">.dockerignore</code>。所以<code class="fe nm nn no mu b">docker build -f Dockerfile.foo .</code>首先尝试加载<code class="fe nm nn no mu b">Dockerfile.foo.dockerignore</code>。</p></blockquote><h2 id="09f0" class="my kx it bd ky nu nv dn lc nw nx dp lg kb ny nz lk kf oa ob lo kj oc od ls oe bi translated">运行/构建它</h2><p id="4163" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">现在我们完成了配置，可以使用<code class="fe nm nn no mu b">build.sh</code>脚本运行构建，如下所示:</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="f63f" class="my kx it mu b gy mz na l nb nc">./build.sh -a kaniko-demo</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="oq or di os bf ot"><div class="gh gi op"><img src="../Images/e56f77b6c6e2307cdc37cbc099f34f7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_MR9yx6F6TIu6EKAODRmHA.png"/></div></div><figcaption class="ou ov gj gh gi ow ox bd b be z dk translated">。/build.sh -a kaniko-demo</figcaption></figure><h2 id="51dd" class="my kx it bd ky nu nv dn lc nw nx dp lg kb ny nz lk kf oa ob lo kj oc od ls oe bi translated">你想联系吗？</h2><p id="6350" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">如果你想联系我，请在LinkedIn上联系我。</p><p id="c598" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另外，可以随意查看<a class="ae lz" href="https://medium.com/@mr-pascal/my-book-recommendations-4b9f73bf961b" rel="noopener">我的书籍推荐</a>📚。</p></div><div class="ab cl oy oz hx pa" role="separator"><span class="pb bw bk pc pd pe"/><span class="pb bw bk pc pd pe"/><span class="pb bw bk pc pd"/></div><div class="im in io ip iq"><div class="kp kq kr ks gt md"><a href="https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b" rel="noopener follow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd iu gy z fp mi fr fs mj fu fw is bi translated">我的书籍推荐</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">在接下来的章节中，你可以找到我对所有日常生活话题的书籍推荐，它们对我帮助很大。</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="mm l"><div class="pf l mo mp mq mm mr ku md"/></div></div></a></div><div class="ma mb gp gr mc md"><a href="https://mr-pascal.medium.com/membership" rel="noopener follow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd iu gy z fp mi fr fs mj fu fw is bi translated">通过我的推荐链接加入Medium—Pascal Zwikirsch</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="mm l"><div class="pg l mo mp mq mm mr ku md"/></div></div></a></div></div></div>    
</body>
</html>