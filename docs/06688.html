<html>
<head>
<title>Try to find a bug in this small Python code. You will be surprised!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">试着在这个小Python代码里找一个bug。你会惊讶的！</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/bug-investigation-python-e2c5fcefbe40?source=collection_archive---------2-----------------------#2020-12-20">https://levelup.gitconnected.com/bug-investigation-python-e2c5fcefbe40?source=collection_archive---------2-----------------------#2020-12-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="909e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">尤其是，如果您从另一种编程语言切换过来</p></div><div class="ab cl ko kp hx kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="im in io ip iq"><h1 id="a9aa" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">介绍</h1><p id="b87b" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">在我更大的项目中，我有一个很难找到的bug。这是绝对不明显的，我已经失去了相当多的时间来研究它。</p><p id="3964" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以我认为一起研究这个bug会很有趣。</p><p id="8165" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将构建一个简单的树，并且已经有一个小bug在损害它。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ly"><img src="../Images/38d7c0c0340c7c4e147bc48b1e7b4b8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qwTWuMn1suZO2FrsFWXgKw.jpeg"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">来源:<a class="ae mo" href="https://www.warrenphotographic.co.uk/00725-green-tree-ants-with-mimic-bug" rel="noopener ugc nofollow" target="_blank">https://www . Warren photographic . co . uk/00725-有模仿虫的绿树蚂蚁</a></figcaption></figure><p id="a432" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们开始吧！</p></div><div class="ab cl ko kp hx kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="im in io ip iq"><h1 id="91c2" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">建造一棵树</h1><p id="af78" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">构建一棵树既简单又直接。我们只需要定义一个类节点，然后用一个列表把它们连接起来。</p><p id="b1e0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是一个实现:</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="813d" class="mu kw it mq b gy mv mw l mx my">class Node:<br/>    children = []<br/>    <br/>    def __init__(self, name, parent=None):<br/>        self.name = name<br/>        self.parent = parent<br/>        if parent is not None:<br/>            parent.children.append(self)<br/>    <br/>    def __str__(self):<br/>        return self.name</span></pre><p id="fc12" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，当我们创建一个新节点时，我们可以设置一个父节点，新节点将被插入到父节点的子节点列表中。这样，我们就可以用这个简单的函数轻松地打印出完整的树:</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="d8db" class="mu kw it mq b gy mv mw l mx my">def printer(root, level=0):<br/>    print("  "*level + "├", root.name)<br/>    for node in root.children:<br/>        printer(node, level+1)</span></pre><p id="da28" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里我们使用一个缩进的“级别”参数。我们是用Python写的，所以，对我们来说，缩进是最重要的。</p><p id="cc48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">好的。现在，一切准备就绪，让我们种一棵树:</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="47af" class="mu kw it mq b gy mv mw l mx my">root = Node("Root")<br/>node1 = Node("1",root)<br/>node11 = Node("1-1", node1)<br/>node12 = Node("1-2", node1)<br/>node13 = Node("1-3", node1)<br/>node14 = Node("1-4", node1)<br/>node15 = Node("1-5", node1)<br/>node2 = Node("2",root)<br/>node21 = Node("2-1", node2)<br/>node22 = Node("2-2", node2)<br/>node23 = Node("2-3", node2)<br/>node24 = Node("2-4", node2)<br/>node25 = Node("2-5", node2)</span></pre><p id="3721" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不错！现在让我们用上面的打印机函数打印出来:</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="b764" class="mu kw it mq b gy mv mw l mx my">printer(root)</span></pre><p id="1b2c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就是这样。我们有一个问题:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mz"><img src="../Images/7bcd57d945bf1cb15794de1d6f9b800e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5-ttwbEAKRZFqoZJIX4uVQ.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">你可能会看到这棵树永远不会结束</figcaption></figure></div><div class="ab cl ko kp hx kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="im in io ip iq"><h1 id="151a" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">调查</h1><p id="6963" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">首先，对您来说，分析上面的代码并自己找出问题会有趣得多。</p><p id="8a8a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的打印机是一个递归函数，它输出带有缩进的给定节点的名称，然后调用它自己的子节点，再缩进一点。这个功能没有问题，100%正确。</p><p id="72db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建节点有问题吗？</p><p id="f9fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不，我们将第一个节点创建为没有父节点的根节点(真可悲)，然后我们为根节点创建两个子节点，每个子节点后面跟着5个子节点。</p><p id="d59c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以，问题出在别的地方。只剩下类定义了。</p><p id="de5b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们拿一个孩子，看看里面有什么:</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="3b25" class="mu kw it mq b gy mv mw l mx my">print(node25)<br/>#output: 2-5</span></pre><p id="8371" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那很好。</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="d268" class="mu kw it mq b gy mv mw l mx my">print(node25.parent)<br/>#output: 2</span></pre><p id="9f90" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那也可以。但是父母的父母呢？嗯…</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="f987" class="mu kw it mq b gy mv mw l mx my">print(node25.parent.parent)<br/>#output: root</span></pre><p id="f2d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那也可以。让我们检查一下孩子们。</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="6f92" class="mu kw it mq b gy mv mw l mx my">print(node25.children)<br/>#output: [&lt;__main__.Node object at 0x7fb443dce750&gt;, &lt;__main__.Node object at 0x7fb443dcec10&gt;, &lt;__main__.Node object at 0x7fb443dced50&gt;, &lt;__main__.Node object at 0x7fb443dcec90&gt;, &lt;__main__.Node object at 0x7fb443dced90&gt;, &lt;__main__.Node object at 0x7fb443dcea10&gt;, &lt;__main__.Node object at 0x7fb443ad4290&gt;, &lt;__main__.Node object at 0x7fb443ad40d0&gt;, &lt;__main__.Node object at 0x7fb443ad4210&gt;, &lt;__main__.Node object at 0x7fb443ad4150&gt;, &lt;__main__.Node object at 0x7fb443dcef50&gt;, &lt;__main__.Node object at 0x7fb443ad4110&gt;]</span></pre><p id="2c4e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">什么？！有几个孩子？</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="6ba9" class="mu kw it mq b gy mv mw l mx my">print(len(node25.children))<br/>#output: 12</span></pre><p id="8560" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">嗯……我们在这里可以看到两个问题。</p><p id="f365" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一个问题是我们的列表看起来很奇怪。当然这个更重要:)</p><p id="1a35" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要解决这个问题，只需将“__str__”改为“__repr__”。这很奇怪。当我们打印出单个节点时，它使用“__str__”函数，在一个列表中，它使用“__repr__”。为什么，Python？</p><p id="bcc4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">好的，第二个问题(主要问题)是Node25有太多的子节点。让我们用“__repr__”函数再次将它们打印出来:</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="d501" class="mu kw it mq b gy mv mw l mx my">print(node25.children)<br/>#output: [1, 1-1, 1-2, 1-3, 1-4, 1-5, 2, 2-1, 2-2, 2-3, 2-4, 2-5]</span></pre><p id="4679" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">哇，除了根之外的所有节点都是Node25的子节点！</p><p id="bbac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">好，那另一个节点呢？</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="307f" class="mu kw it mq b gy mv mw l mx my">print(node21.children)<br/>#output: [1, 1-1, 1-2, 1-3, 1-4, 1-5, 2, 2-1, 2-2, 2-3, 2-4, 2-5]</span></pre><p id="b0c7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">嗯…</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="6077" class="mu kw it mq b gy mv mw l mx my">print(root.children)<br/>#output: [1, 1-1, 1-2, 1-3, 1-4, 1-5, 2, 2-1, 2-2, 2-3, 2-4, 2-5]</span></pre><p id="cc59" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在问题清楚了——他们都分享自己的孩子。</p><p id="91ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">原因如下:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi na"><img src="../Images/f4c7a4d4f2e4cbae2dc59e74ae8144b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hBTW-rLPYHDnP-F2pzADLg.jpeg"/></div></div></figure></div><div class="ab cl ko kp hx kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="im in io ip iq"><h1 id="6d54" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">问题的核心</h1><p id="12d1" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">问题的核心就在这里:</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="19c8" class="mu kw it mq b gy mv mw l mx my">class Node:<br/>    children = [] # &lt;----- THIS IS THE BUG!<br/>    <br/>    def __init__(self, name, parent=None):<br/>        self.name = name<br/>        self.parent = parent<br/>        if parent is not None:<br/>            parent.children.append(self)<br/>    <br/>    def __repr__(self):<br/>        return self.name</span></pre><p id="ae29" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">事实是，一个类中以这种方式声明的所有东西都是单例的。没错。相信我:)</p><p id="5c6c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你曾经用C++或Java编写过，那是相当令人惊讶的，不是吗？</p><p id="a2c8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里正确的实现是什么？</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="40fb" class="mu kw it mq b gy mv mw l mx my">class Node:    <br/>    def __init__(self, name, parent=None):<br/>        self.name = name<br/>        self.parent = parent<br/>        self.children = [] # &lt;--- move it here<br/>        if parent is not None:<br/>            parent.children.append(self)<br/>    <br/>    def __repr__(self):<br/>        return self.name</span></pre><p id="57b2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你想确定一个对象或者一个变量属于一个对象，总是使用“self”！</p><p id="c4d5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们再次检查:</p><pre class="lz ma mb mc gt mp mq mr ms aw mt bi"><span id="1682" class="mu kw it mq b gy mv mw l mx my">print(root.children)<br/>#out: [1, 2]</span></pre><p id="a892" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">和打印机:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/9cb0ef3f819d45cb430fd1c91c89a621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*yueILz-ttwvdclfj35ksTw.png"/></div></figure><p id="2bb7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这样好多了！感谢阅读！</p><p id="d1e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">顺便说一下，我在我的其他文章中犯了完全相同的错误，包括俄罗斯方块的实现:</p><div class="nc nd gp gr ne nf"><a rel="noopener  ugc nofollow" target="_blank" href="/writing-tetris-in-python-2a16bddb5318"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">用Python写俄罗斯方块</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">用Python和PyGame编写俄罗斯方块的分步指南</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt mi nf"/></div></div></a></div><p id="5f61" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不过从现在开始，我会很小心的:)</p></div></div>    
</body>
</html>