<html>
<head>
<title>A Guide to K3s Ingress Using Traefik with NodePort</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用带节点端口的Traefik进入K3s的指南</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-guide-to-k3s-ingress-using-traefik-with-nodeport-6eb29add0b4b?source=collection_archive---------0-----------------------#2020-12-02">https://levelup.gitconnected.com/a-guide-to-k3s-ingress-using-traefik-with-nodeport-6eb29add0b4b?source=collection_archive---------0-----------------------#2020-12-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/89f95c4b798fcda35c42cf0dd0ce96fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vc1vwYFgUOQdHF2aR86XVQ.png"/></div></div></figure><div class=""/><div class=""><h2 id="1bbf" class="pw-subtitle-paragraph kb jd je bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks dk translated">为了更好地理解无价的云概念</h2></div><p id="02b5" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">云由称为集群的短暂服务器组和为服务器分配容器的适当方式组成。容器是将应用程序打包成标准化单元的一种方式，因此它可以可靠地运行在云中的任何服务器上。将流量从外部客户端定向到云中的容器，同时确保外部客户端对云保持不可知，这是一个反复出现的问题。常见的解决方案是创建入口控制器。</p><h1 id="993e" class="lp lq je bd lr ls lt lu lv lw lx ly lz kk ma kl mb kn mc ko md kq me kr mf mg bi translated">进入</h1><blockquote class="mh mi mj"><p id="445c" class="kt ku mk kv b kw kx kf ky kz la ki lb ml ld le lf mm lh li lj mn ll lm ln lo im bi translated">进入或进入的行为或事实</p></blockquote><p id="dd01" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">入口控制器被授权负责从外部客户端接收输入流量，并确定流量应该被定向到哪个容器。</p><p id="e964" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这是一个相当直观的概念，不需要任何技术专业知识。想象一下，你正在看一场百老汇的戏剧，你有一张蓝色的票，上面写着数字10。票上没有说明。当你到达剧院时，会有一个引座员迎接你，他会把你带到剧院里一个特定的座位。你已经被引导到正确的座位，而不需要了解组织系统；然而，你明白你的票在某种程度上在交易中起了决定性的作用。现在，想象你是引座员。你的第一个问题应该是，给定一张票的颜色和号码，你如何找到座位？事实证明，剧院分为三个区域，分别对应蓝色、绿色和黄色门票。在每个区域内，座位是随机分配的。当你向顾客打招呼时，你要检查他们的票的颜色，并把他们带到正确的区域。你忽略了票号，因为这是不相关的。关键是引座员(入口)了解剧院(云)的组织系统，并能够将客户(外部客户端)指引到正确的座位(容器)，而客户(外部客户端)除了显示门票(url)的简单合同之外，不需要了解任何东西。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="82cf" class="lp lq je bd lr ls mv lu lv lw mw ly lz kk mx kl mb kn my ko md kq mz kr mf mg bi translated">Kubernetes的入口</h1><h2 id="a5c0" class="na lq je bd lr nb nc dn lv nd ne dp lz lc nf ng mb lg nh ni md lk nj nk mf nl bi translated">术语</h2><ul class=""><li id="6dbe" class="nm nn je kv b kw no kz np lc nq lg nr lk ns lo nt nu nv nw bi translated">集群:由Kubernetes管理的一组运行Pods的服务器。</li><li id="7640" class="nm nn je kv b kw nx kz ny lc nz lg oa lk ob lo nt nu nv nw bi translated">Ingress:Kubernetes Ingress将集群外部的HTTP和HTTPS流量暴露给集群内部的服务。</li><li id="bc91" class="nm nn je kv b kw nx kz ny lc nz lg oa lk ob lo nt nu nv nw bi translated">入口控制器:负责满足入口请求的应用程序。</li><li id="6d2a" class="nm nn je kv b kw nx kz ny lc nz lg oa lk ob lo nt nu nv nw bi translated">服务:Kubernetes服务是一种抽象的方式来公开在一组pod中运行的应用程序。服务的实现包括NodePort和ClusterIP。</li><li id="a6ca" class="nm nn je kv b kw nx kz ny lc nz lg oa lk ob lo nt nu nv nw bi translated">Pod:一组共享网络和存储资源的一个或多个容器。Pod的容器是协同定位和协同调度的。</li><li id="b082" class="nm nn je kv b kw nx kz ny lc nz lg oa lk ob lo nt nu nv nw bi translated">K3s:一个轻量级Kubernetes发行版。</li><li id="7eda" class="nm nn je kv b kw nx kz ny lc nz lg oa lk ob lo nt nu nv nw bi translated">容器:一个标准化的软件单元，可以在云中的任何服务器上可靠地运行。</li></ul><p id="84d0" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">Kubernetes Ingress有两个要求。</p><ol class=""><li id="9524" class="nm nn je kv b kw kx kz la lc oc lg od lk oe lo of nu nv nw bi translated">入口控制器</li><li id="be5a" class="nm nn je kv b kw nx kz ny lc nz lg oa lk ob lo of nu nv nw bi translated">进入</li></ol><p id="af1a" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这是一个为Kubernetes配置入口的端到端设置示例，这样，作为集群的外部客户端，您可以通过入口控制器访问集群中运行的Pod。一旦流量被定向到该单元，流量将被定向到该单元中的正确容器。该集群是通过将Rancher的K3s部署到一个Raspberry Pi集群来构建的。关于在Raspberry Pis上构建K3s集群的更多信息，请参见此处的<a class="ae og" href="https://medium.com/coming-about/10-minutes-to-k3s-on-raspberry-pis-efe3daf2a33d" rel="noopener"/>。</p><figure class="oi oj ok ol gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oh"><img src="../Images/27869d8e4c2269e50036368ff0a19597.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*StSV9Y39W526t9VbXo7Pmw.png"/></div></div></figure><p id="6a0e" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">上图描述了以下组件。A <code class="fe om on oo op b">Client</code>想要向a <code class="fe om on oo op b">Pod</code>发送流量。Pod被部署到K3s集群，并通过创建集群IP <code class="fe om on oo op b">Service</code>在集群内公开。客户端无法访问该服务，但是<code class="fe om on oo op b">Ingress Controller</code>可以访问该服务。入口控制器满足由<code class="fe om on oo op b">Ingress</code>定义的路由规则。入口控制器通过<code class="fe om on oo op b">NodePort</code>服务暴露给客户端。</p><figure class="oi oj ok ol gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oq"><img src="../Images/c1868aafbf93001629f22583adc7852d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5oo8LVrF2byMiXmq7vGUFw.png"/></div></div></figure><p id="caf0" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">Kubernetes没有部署入口控制器；不过<a class="ae og" href="https://rancher.com" rel="noopener ugc nofollow" target="_blank"> Rancher </a>的K3s默认部署一个。上图显示K3s选择部署<code class="fe om on oo op b">Traefik</code>作为入口控制器的实现。因此，Traefik将承担满足入口请求的责任。K3s用户提交入口请求，根据各种HTTP属性实例化传入流量的路由规则。</p><p id="473a" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">上图中描述的入口在Traefik上创建了一个路由规则，使得路径与<code class="fe om on oo op b">/</code>之后的任何内容匹配的传入流量将被重定向到端口<code class="fe om on oo op b">80</code>的服务<code class="fe om on oo op b">nginx-svc</code>。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="5996" class="lp lq je bd lr ls mv lu lv lw mw ly lz kk mx kl mb kn my ko md kq mz kr mf mg bi translated">创建K3s入口资源</h1><p id="ca5a" class="pw-post-body-paragraph kt ku je kv b kw no kf ky kz np ki lb lc or le lf lg os li lj lk ot lm ln lo im bi translated">以下指南将构建与上一节中的示例相对应的入口配置。</p><h2 id="f385" class="na lq je bd lr nb nc dn lv nd ne dp lz lc nf ng mb lg nh ni md lk nj nk mf nl bi translated">运行Traefik仪表板</h2><p id="e3dc" class="pw-post-body-paragraph kt ku je kv b kw no kf ky kz np ki lb lc or le lf lg os li lj lk ot lm ln lo im bi translated">K3s为入口控制器创建Traefik部署，但默认情况下，仪表板是禁用的。在启用仪表板的情况下运行Traefik体现了通过应用入口创建的路由规则的概念。</p><p id="040a" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">必须编辑Traefik的配置映射才能启用仪表板。</strong></p><pre class="oi oj ok ol gt ou op ov ow aw ox bi"><span id="a540" class="na lq je op b gy oy oz l pa pb">kubectl -n kube-system edit cm traefik</span></pre><p id="12c0" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">此命令允许您在终端中编辑配置图。</p><figure class="oi oj ok ol gt iv"><div class="bz fp l di"><div class="pc pd l"/></div></figure><p id="109f" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">必须添加第31行和第32行来启用仪表板。添加这些行后，要保存文件，请键入<code class="fe om on oo op b">esc + : + wq</code>。</p><p id="dddb" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">重新启动Traefik部署。</strong></p><pre class="oi oj ok ol gt ou op ov ow aw ox bi"><span id="dd5e" class="na lq je op b gy oy oz l pa pb">kubectl -n kube-system scale deploy traefik --replicas 0<br/>kubectl -n kube-system scale deploy traefik --replicas 1</span></pre><p id="327e" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">端口转发Traefik仪表板</strong></p><pre class="oi oj ok ol gt ou op ov ow aw ox bi"><span id="2838" class="na lq je op b gy oy oz l pa pb">kubectl -n kube-system port-forward deployment/traefik 8080</span></pre><p id="b2e6" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">在浏览器中打开仪表板，网址为<a class="ae og" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>。当您创建入口时，您的路由规则将显示在此仪表板上。</p><h2 id="3ca7" class="na lq je bd lr nb nc dn lv nd ne dp lz lc nf ng mb lg nh ni md lk nj nk mf nl bi translated">配置Traefik路由规则</h2><p id="b12e" class="pw-post-body-paragraph kt ku je kv b kw no kf ky kz np ki lb lc or le lf lg os li lj lk ot lm ln lo im bi translated">我们的例子不需要创建yaml文件就可以轻松完成；然而，yaml文件允许您保存您的工作，并轻松地启动和关闭整个配置设置。前面的例子将使用yaml文件，而不是命令行命令来构造Kubernetes入口资源。</p><p id="4115" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">创建部署<br/>跑<code class="fe om on oo op b">nginx</code>就可以了。将以下文件另存为<code class="fe om on oo op b">deployment.yaml</code>。</strong></p><figure class="oi oj ok ol gt iv"><div class="bz fp l di"><div class="pc pd l"/></div></figure><pre class="oi oj ok ol gt ou op ov ow aw ox bi"><span id="f6bb" class="na lq je op b gy oy oz l pa pb">kubectl create -f deployment.yaml</span></pre><p id="08ed" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">创建服务<br/> </strong>入口在入口控制器Traefik上配置路由规则。Traefik检查传入的HTTP流量，并将流量定向到已触发规则的服务。因此，流量从外部客户端流向Traefik，然后从Traefik流向服务，最后从服务流向Pod。我们现在将创建此服务。将以下文件另存为<code class="fe om on oo op b">service.yaml</code>。</p><figure class="oi oj ok ol gt iv"><div class="bz fp l di"><div class="pc pd l"/></div></figure><pre class="oi oj ok ol gt ou op ov ow aw ox bi"><span id="3e5a" class="na lq je op b gy oy oz l pa pb">kubectl create -f service.yaml</span></pre><p id="3b18" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">创建入口<br/> </strong>入口用路由规则配置Traefik。这个最小的例子将使用基于<em class="mk">路径的路由</em>规则。通过检查传入url的上下文来评估基于路径的路由规则。在这里，路径是<code class="fe om on oo op b">/</code>和<code class="fe om on oo op b">pathType: Prefix</code>。路径<code class="fe om on oo op b">/</code>捕获所有传入流量，因此像<code class="fe om on oo op b">/context1</code>、<code class="fe om on oo op b">/context2/anything</code>这样的上下文都将触发Traefik上的路由规则，因为所有这些上下文的前缀都是<code class="fe om on oo op b">/</code>。将以下文件另存为<code class="fe om on oo op b">ingress.yaml</code>。</p><figure class="oi oj ok ol gt iv"><div class="bz fp l di"><div class="pc pd l"/></div></figure><pre class="oi oj ok ol gt ou op ov ow aw ox bi"><span id="be2a" class="na lq je op b gy oy oz l pa pb">kubectl create -f ingress.yaml</span></pre><p id="5d22" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">路由规则现在将在Traefik的<a class="ae og" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">仪表板</a>上可见。</p><figure class="oi oj ok ol gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi pe"><img src="../Images/6e4c5d2c8362caac7732cc1387ab644b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dMQGnuav-4AhXMPNjJDiqA.png"/></div></div></figure><p id="1712" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">将节点端口为的入口控制器暴露给外部流量<br/> </strong>已经定义了<code class="fe om on oo op b">nginx</code>应用的入口规则，但是Traefik尚未暴露给外部流量。创建NodePort类型的服务将向客户端公开Traefik。保存以下文件<code class="fe om on oo op b">nodeport.yaml</code>。</p><figure class="oi oj ok ol gt iv"><div class="bz fp l di"><div class="pc pd l"/></div></figure><pre class="oi oj ok ol gt ou op ov ow aw ox bi"><span id="3e40" class="na lq je op b gy oy oz l pa pb">kubectl create -f nodeport.yaml</span></pre><p id="4f62" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">充当外部客户端<br/> </strong>集群的外部客户端现在可以向入口控制器发出请求。入口控制器会将流量重定向到服务<code class="fe om on oo op b">nginx-svc</code>，服务又将流量定向到Pod <code class="fe om on oo op b">nginx</code>。要充当外部客户机，我们需要集群中一台服务器的IP地址。</p><pre class="oi oj ok ol gt ou op ov ow aw ox bi"><span id="10c3" class="na lq je op b gy oy oz l pa pb">kubectl get nodes -o wide</span></pre><p id="d070" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">获取Traefik服务的任何<code class="fe om on oo op b">INTERNAL-IP</code>和我们的节点端口<code class="fe om on oo op b">30182</code>，并将其粘贴到浏览器中。将显示NGINX默认页面。请注意，外部客户端必须与群集位于同一个网络上，这样才能正常工作。</p><figure class="oi oj ok ol gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi pe"><img src="../Images/5b735a4331fd7c4e772372ec7fa79cda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D8AJDhGQxIeTL0WLeSOI8g.png"/></div></div></figure><h1 id="4c99" class="lp lq je bd lr ls lt lu lv lw lx ly lz kk ma kl mb kn mc ko md kq me kr mf mg bi translated">结束语</h1><p id="6051" class="pw-post-body-paragraph kt ku je kv b kw no kf ky kz np ki lb lc or le lf lg os li lj lk ot lm ln lo im bi translated">入口概念在云原生环境中是一个非常宝贵的概念。Kubernetes提供了入口，但是将入口控制器的实现留给了开发人员。Rancher的K3s提供Traefik作为入口控制器。如果没有入口控制器，创建入口将什么也做不了。入口控制器本身就是一个Pod，必须暴露于外部流量。在本例中，我们使用节点端口进行公开。在评估通过提交入口请求配置的路由规则之后，命中入口控制器的流量将被重定向到配置的服务。</p><h1 id="0f29" class="lp lq je bd lr ls lt lu lv lw lx ly lz kk ma kl mb kn mc ko md kq me kr mf mg bi translated">附录</h1><p id="8cbe" class="pw-post-body-paragraph kt ku je kv b kw no kf ky kz np ki lb lc or le lf lg os li lj lk ot lm ln lo im bi translated">指南中的各个文件可以合并成一个文件。通过维护一个文件，很容易创建和销毁整个入口设置。将下面的文件另存为<code class="fe om on oo op b">nginx-ingress-full.yaml</code>。</p><p id="4990" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">创建</strong></p><pre class="oi oj ok ol gt ou op ov ow aw ox bi"><span id="9c91" class="na lq je op b gy oy oz l pa pb">kubectl create -f nginx-ingress-full.yaml</span></pre><p id="71f1" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">销毁</strong></p><pre class="oi oj ok ol gt ou op ov ow aw ox bi"><span id="6e4d" class="na lq je op b gy oy oz l pa pb">kubectl delete -f nginx-ingress-full.yaml</span></pre><figure class="oi oj ok ol gt iv"><div class="bz fp l di"><div class="pc pd l"/></div></figure></div></div>    
</body>
</html>