<html>
<head>
<title>Running Python App on AWS Nitro Enclaves</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS Nitro Enclaves上运行Python应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/running-python-app-on-aws-nitro-enclaves-56024667b684?source=collection_archive---------8-----------------------#2020-11-02">https://levelup.gitconnected.com/running-python-app-on-aws-nitro-enclaves-56024667b684?source=collection_archive---------8-----------------------#2020-11-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><h1 id="f994" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">什么是AWS硝基飞地</h1><p id="042c" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">AWS Nitro Enclaves是一个运行在EC2实例旁边的独立计算环境。它使用来自EC2实例的CPU和内存资源，但是它在管理程序级别上与实例隔离，因此您的实例即使在操作系统级别上也不能访问enclave。与enclave通信的唯一方式是通过vsock通道。</p><div class="lm ln gp gr lo lp"><a href="https://aws.amazon.com/blogs/aws/aws-nitro-enclaves-isolated-ec2-environments-to-process-confidential-data/" rel="noopener  ugc nofollow" target="_blank"><div class="lq ab fo"><div class="lr ab ls cl cj lt"><h2 class="bd iu gy z fp lu fr fs lv fu fw is bi translated">AWS Nitro Enclaves -处理机密数据的隔离EC2环境| Amazon Web Services</h2><div class="lw l"><h3 class="bd b gy z fp lu fr fs lv fu fw dk translated">当我第一次告诉你关于AWS硝基系统，我说:硝基系统是一个丰富的积木的集合…</h3></div><div class="lx l"><p class="bd b dl z fp lu fr fs lv fu fw dk translated">aws.amazon.com</p></div></div><div class="ly l"><div class="lz l ma mb mc ly md me lp"/></div></div></a></div><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mf"><img src="../Images/307765b12d8cc3b296445ccb355621f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3R8LuxbIvh67lp9qqY3ysg.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">AWS Nitro Enclaves的高级概述(来自AWS文档)</figcaption></figure><h2 id="b0d3" class="mu jr it bd js mv mw dn jw mx my dp ka kz mz na ke ld nb nc ki lh nd ne km nf bi translated">那是什么意思？</h2><p id="1fad" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了更好地理解这个概念，我们可以把enclave看作一个docker容器。我们可以将我们的定制应用烘焙到一个映像中，并在enclave中运行它，就像我们在容器中运行docker映像一样。</p><p id="3525" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">不同的是，您不能访问这个特殊的<em class="nl">容器的</em>控制台、文件、指标等。它没有网络接口，也没有持久存储。</p><p id="bf17" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">你唯一能做的就是:</p><ol class=""><li id="5007" class="nm nn it kq b kr ng kv nh kz no ld np lh nq ll nr ns nt nu bi translated">运行应用程序</li><li id="58de" class="nm nn it kq b kr nv kv nw kz nx ld ny lh nz ll nr ns nt nu bi translated">通过专用的套接字隧道与外界通信。</li></ol><h1 id="3854" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">为什么我们需要AWS硝基飞地</h1><p id="cc92" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了保护机密数据，我们总是加密我们的数据。但是当我们使用数据时，我们需要在某个地方解密它。</p><p id="7d31" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">通常情况下，我们会在尽可能接近我们使用数据的地方解密数据，从而最大限度地减少泄露纯文本数据的可能性。</p><p id="c907" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">然而，为了职责分离，我们也不希望秘密处理过程离系统的其他部分太近。</p><p id="04de" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">想象一下，如果我们将支付处理系统放在电子商店的web服务器中。web服务器管理员总是可以使用“上帝模式”(或者我们所说的<em class="nl"> sudo </em>)来访问日志文件。</p><p id="908a" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">AWS Nitro Enclaves在核心应用程序附近(在同一个实例中)提供了一个安全的环境(没有人能够访问它)。解决将秘密处理过程放在远离或靠近主系统的困境。</p><h1 id="599c" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">为什么我要写这个Python演示？</h1><div class="lm ln gp gr lo lp"><a href="https://github.com/richardfan1126/nitro-enclave-python-demo/tree/master/http-proxy" rel="noopener  ugc nofollow" target="_blank"><div class="lq ab fo"><div class="lr ab ls cl cj lt"><h2 class="bd iu gy z fp lu fr fs lv fu fw is bi translated">Richard fan 1126/nitro-enclave-python-demo</h2><div class="lw l"><h3 class="bd b gy z fp lu fr fs lv fu fw dk translated">这个项目展示了我们如何使用Python套接字包在EC2实例和Nitro Enclave之间建立通信…</h3></div><div class="lx l"><p class="bd b dl z fp lu fr fs lv fu fw dk translated">github.com</p></div></div><div class="ly l"><div class="oa l ma mb mc ly md me lp"/></div></div></a></div><p id="29d0" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">在AWS硝基飞地成为GA后，我立即试用了它。然而，当我研究GitHub库时，我感到非常沮丧，因为代码不是用C就是用Rust编写的。KMS API调用部分甚至重新实现了HTTP处理。</p><ol class=""><li id="9f8a" class="nm nn it kq b kr ng kv nh kz no ld np lh nq ll nr ns nt nu bi translated">【https://github.com/aws/aws-nitro-enclaves-sdk-c T4】</li><li id="4f25" class="nm nn it kq b kr nv kv nw kz nx ld ny lh nz ll nr ns nt nu bi translated"><a class="ae ob" href="https://github.com/aws/aws-nitro-enclaves-samples" rel="noopener ugc nofollow" target="_blank">https://github.com/aws/aws-nitro-enclaves-samples</a></li></ol><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi oc"><img src="../Images/cb348c23880e3228a0647d6f79379f56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ARJ_yr3QUiNwEPO-9EGL3w.jpeg"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">SDK示例使用C来重新实现整个HTTP处理</figcaption></figure><p id="4ad0" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">我觉得我需要一个月的时间来编写像调用HTTP API一样简单的hello world程序，尤其是当我使用Python时。</p><p id="8d35" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">因此，我改变了主意，不再遵循示例，而是提出了自己的想法:编写一个代理来模拟通过Nitro Enclave的唯一网关——vsock隧道的HTTP连接。</p><h1 id="3390" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">演示是如何工作的</h1><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi od"><img src="../Images/b23c55ad71425ea00dc5974d8ca5667d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JEwiOUeHJfq0SMD6Y797Gg.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">使用代理来模拟通过vsock隧道的HTTP连接</figcaption></figure><p id="8b3e" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">对于详细的描述，你可以在<a class="ae ob" href="https://github.com/richardfan1126/nitro-enclave-python-demo/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">代码库中找到</a>的描述。我想在这篇文章中分享的是我在构建这个演示项目时发现的一些有趣的事情。</p><h2 id="5baa" class="mu jr it bd js mv mw dn jw mx my dp ka kz mz na ke ld nb nc ki lh nd ne km nf bi translated">1.选择正确的Docker图像</h2><p id="5d0d" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">对于Python应用程序开发，使用<a class="ae ob" href="https://hub.docker.com/_/python" rel="noopener ugc nofollow" target="_blank"> Python基础映像</a>将是一个明显的步骤。但是由于某种原因，python映像在Nitro Enclave中无法正常运行。</p><p id="8576" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">无论我使用标准映像、<code class="fe oe of og oh b">-slim</code>映像还是<code class="fe oe of og oh b">-alpine</code>映像，即使我的<strong class="kq iu"> Dockerfile </strong>只是运行一个简单的<code class="fe oe of og oh b">echo</code>命令，也会出现错误<code class="fe oe of og oh b">Could not open /env file: No such file or directory</code>。</p><p id="275c" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">我最终使用了amazonlinux基础映像并安装了构建过程中需要的包。虽然我仍然不知道背后的原因，它只是工作正常。</p><p id="5f70" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">如果你也遇到一些奇怪的问题，尝试使用其他基础图像。在EC2实例中起作用的可能在Enclave中不起作用。</p><h2 id="7969" class="mu jr it bd js mv mw dn jw mx my dp ka kz mz na ke ld nb nc ki lh nd ne km nf bi translated">2.正在建立HTTP连接</h2><p id="066f" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">大多数HTTP代理使用<code class="fe oe of og oh b">127.0.0.1</code>链接同一台机器上的不同应用程序。在实现HTTP-to-vsock代理时，我做了同样的事情。</p><p id="ab58" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">然而，我不知道这是否是Nitro Enclave上硬化过程的一部分。如果您运行<code class="fe oe of og oh b">ifconfig</code>没有显示网络接口，这意味着您根本无法进行任何IP连接(甚至无法连接到本地主机)。</p><p id="d36f" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">幸运的是，当我运行<code class="fe oe of og oh b">ifconfig -a</code>时，我发现本地回环<code class="fe oe of og oh b">lo</code>仍然存在。只是没有给它分配IP地址。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi oi"><img src="../Images/855041d09b6fa195d173babba752c58f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mV_CAKhKnnDBTpMPoyY1gQ.png"/></div></div></figure><p id="834a" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">所以我在引导脚本中添加了一个命令<code class="fe oe of og oh b">ifconfig lo 127.0.0.1</code>来为它分配一个IP地址。之后，我们可以使用<code class="fe oe of og oh b">127.0.0.1</code>来做应用程序之间的HTTP连接。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi oj"><img src="../Images/d8055358e6e95a613f5425d6395bc439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IxyOylfYIhiQUcwq-fW_4w.png"/></div></div></figure><p id="d4e8" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">如果您的应用程序依赖于HTTP连接(例如REST API)，您会发现这种方法非常有用，因为您可以编写自己的代理来通过vsock通道转发流量。</p><h1 id="022c" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">下一步是什么—证明</h1><h2 id="ae6b" class="mu jr it bd js mv mw dn jw mx my dp ka kz mz na ke ld nb nc ki lh nd ne km nf bi translated">什么是证明</h2><p id="6662" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">AWS Nitro Enclaves的一大特色是认证。除了数据隔离，我们可能还需要身份隔离。</p><p id="d184" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">因为Nitro Enclave没有对外部世界的网络访问，所以一切都将通过父实例。服务提供商(例如AWS KMS)应该有办法识别API调用是来自父实例还是enclave。</p><p id="a026" class="pw-post-body-paragraph ko kp it kq b kr ng kt ku kv nh kx ky kz ni lb lc ld nj lf lg lh nk lj lk ll im bi translated">证明是我们用来实现这一点的方法。我们可以使用NitroSecureModule (NSM)来获得一个签名的证明文档，并使用它来证明请求是从enclave发出的。还有一个挑战机制来避免外来者复制请求。</p><h2 id="36aa" class="mu jr it bd js mv mw dn jw mx my dp ka kz mz na ke ld nb nc ki lh nd ne km nf bi translated">我现在面临的挑战是什么</h2><p id="7c59" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">然而，AWS提供的文档对我来说仍然很难，我可能需要更多的时间来理解并希望实现Python证明过程。</p><ol class=""><li id="2351" class="nm nn it kq b kr ng kv nh kz no ld np lh nq ll nr ns nt nu bi translated"><a class="ae ob" href="https://github.com/aws/aws-nitro-enclaves-sdk-c/blob/main/docs/kmstool.md" rel="noopener ugc nofollow" target="_blank">https://github . com/AWS/AWS-nitro-enclaves-SDK-c/blob/main/docs/km stool . MD</a></li><li id="507e" class="nm nn it kq b kr nv kv nw kz nx ld ny lh nz ll nr ns nt nu bi translated"><a class="ae ob" href="https://github.com/aws/aws-nitro-enclaves-nsm-api/blob/main/docs/attestation_process.md" rel="noopener ugc nofollow" target="_blank">https://github . com/AWS/AWS-nitro-enclaves-nsm-API/blob/main/docs/metallation _ process . MD</a></li></ol><h1 id="63da" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">特征图像</h1><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi ok"><img src="../Images/844d52cbc5a4527ff5013d6cc89d0e49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AMz4g5Tv7gyvwvh2"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">照片由<a class="ae ob" href="https://unsplash.com/@ronnikurtz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">罗尼·库尔兹</a>在<a class="ae ob" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure></div></div>    
</body>
</html>