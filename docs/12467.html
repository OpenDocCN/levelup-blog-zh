<html>
<head>
<title>Testing WordPress with Mantle TestKit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Mantle TestKit测试WordPress</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/testing-wordpress-with-mantle-testkit-a2c42d3b3a8a?source=collection_archive---------19-----------------------#2022-06-12">https://levelup.gitconnected.com/testing-wordpress-with-mantle-testkit-a2c42d3b3a8a?source=collection_archive---------19-----------------------#2022-06-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c417" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">对WordPress核心测试套件的改进，向后兼容。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/beaf6009c30a1234f4568464e83e2e08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DH3pRgwg_JAKyS3j"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@sigmund?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">西格蒙德</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="035b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你从事专业的WordPress开发已经有一段时间了，你可能会遇到WordPress测试框架。这是用于测试WordPress插件和主题的标准代码。</p><p id="70eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">设置和使用也很痛苦。</p><p id="07df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对我来说，最大的痛点之一是，如果我使用WordPress框架，我完全无法模仿核心WordPress类和函数。这意味着我要么需要<a class="ae ky" href="https://blog.devgenius.io/wp-mock-or-brain-monkey-which-is-the-better-mocking-library-for-wordpress-48fd89f321fd" rel="noopener ugc nofollow" target="_blank">使用像Brain Monkey </a>这样的模仿库，放弃集成测试，要么我需要为每个项目维护两个独立的PHPUnit配置。</p><p id="79e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了<a class="ae ky" href="https://mantle.alley.co/testing/testkit.html" rel="noopener ugc nofollow" target="_blank"> Mantle TestKit </a>，情况就不再是这样了。</p><h1 id="4575" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">什么是地幔测试套件？</h1><p id="a1d1" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated"><a class="ae ky" href="https://mantle.alley.co/testing/testkit.html" rel="noopener ugc nofollow" target="_blank">地幔测试套件</a>是整个<a class="ae ky" href="https://mantle.alley.co/" rel="noopener ugc nofollow" target="_blank">地幔</a>项目的一小部分。Mantle将Laravel的灵活性和WordPress的易用性结合在一起。</p><p id="4310" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如创作者所描述的:</p><blockquote class="ms mt mu"><p id="1e50" class="kz la mv lb b lc ld ju le lf lg jx lh mw lj lk ll mx ln lo lp my lr ls lt lu im bi translated">Mantle认为企业级的WordPress开发是可能的，应该有一个简单而令人愉快的语法。</p></blockquote><h1 id="11b5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">如何在项目中安装Mantle TestKit</h1><p id="7839" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Mantle TestKit应该作为大多数测试的替代工具。如果你已经花时间升级你的WordPress测试来使用PHPUnit 9。修改客户项目时，我遇到的唯一两个问题是。</p><h2 id="4691" class="mz lw it bd lx na nb dn mb nc nd dp mf li ne nf mh lm ng nh mj lq ni nj ml nk bi translated">前期工作</h2><p id="2c49" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为插件或主题设置PHPUnit超出了本文的范围，但是有大量的<a class="ae ky" href="https://cmljnelson.blog/2021/01/05/phpunit-tests-in-wordpress-plugins-without-wp-cli-or-wp-develop-repo/" rel="noopener ugc nofollow" target="_blank"/><a class="ae ky" href="https://aaemnnost.tv/2016/12/20/installing-the-wordpress-test-suite-with-composer-part-1/" rel="noopener ugc nofollow" target="_blank"/><a class="ae ky" href="https://make.wordpress.org/core/handbook/testing/automated-testing/phpunit/#workflow-2-setting-up-the-composer-environment" rel="noopener ugc nofollow" target="_blank">信息</a> <a class="ae ky" href="https://tj.ie/getting-started-with-wordpress-and-unit-testing/#setup" rel="noopener ugc nofollow" target="_blank"> out </a>可供参考。其中一些已经过时了，但是如果你对这个主题感兴趣，我相信你完全有能力把它们放在一起。</p><p id="8b61" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">谁知道呢，也许我以后会跟进一篇关于它的文章。</p><h2 id="4519" class="mz lw it bd lx na nb dn mb nc nd dp mf li ne nf mh lm ng nh mj lq ni nj ml nk bi translated">断言数组子集</h2><p id="283d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">PHPUnit 8移除了断言<code class="fe nl nm nn no b">assertArraySubset</code>,我转换的客户端项目中的许多测试都在使用这个断言。最初，我试图重新组织测试用例来删除这些调用，但是最终我选择了简单地添加一个composer包来填充断言。</p><pre class="kj kk kl km gt np no nq nr aw ns bi"><span id="502c" class="mz lw it no b gy nt nu l nv nw">composer require --dev dms/phpunit-arraysubset-assert</span></pre><p id="7967" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从那里，我能够向我的测试添加以下行:</p><pre class="kj kk kl km gt np no nq nr aw ns bi"><span id="8c8f" class="mz lw it no b gy nt nu l nv nw">use DMS\PHPUnitExtensions\ArraySubset\ArraySubsetAsserts;</span><span id="8d11" class="mz lw it no b gy nx nu l nv nw">class Test_Class extends Test_Case {<br/>    use ArraySubsetAsserts;<br/>    ...<br/>}</span></pre><p id="295e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">突然，我又有了有效的断言。</p><p id="90a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我选择只将它添加到已经使用断言的测试中，因为我希望将来不再使用它，但是您也可以轻松地将它添加到一个定制的测试用例中，并从那里扩展您的测试。</p></div><div class="ab cl ny nz hx oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="im in io ip iq"><p id="54e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mv">喜欢这篇文章吗？</em> <a class="ae ky" href="https://travisweston.com/membership" rel="noopener ugc nofollow" target="_blank"> <em class="mv">成为会员</em></a><em class="mv"/><a class="ae ky" href="https://travisweston.com/subscribe" rel="noopener ugc nofollow" target="_blank"><em class="mv">订阅</em> </a> <em class="mv">获取更多类似这样的精彩内容！</em></p></div><div class="ab cl ny nz hx oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="im in io ip iq"><h2 id="93a4" class="mz lw it bd lx na nb dn mb nc nd dp mf li ne nf mh lm ng nh mj lq ni nj ml nk bi translated">设置项目以使用Mantle TestKit</h2><p id="cab5" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">默认情况下，Mantle TestKit作为WordPress测试框架的替代物，只是速度更快。因此，让我们看看将现有的WordPress插件从WordPress测试转换到Mantle TestKit的步骤。</p><p id="9701" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们要做的第一件事是安装TestKit。</p><pre class="kj kk kl km gt np no nq nr aw ns bi"><span id="239d" class="mz lw it no b gy nt nu l nv nw">composer require --dev mantle-framework/testkit</span></pre><p id="87ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">测试套件现已安装！</p><p id="7275" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我倾向于在<code class="fe nl nm nn no b">wp-content</code>级别安装我的composer，但是在哪里安装并不重要。无论我们在哪里做，我们只需要知道<code class="fe nl nm nn no b">wordpress-autoload.php</code>文件在哪里。这可以在我们的供应商目录中找到。</p><p id="ec7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建一个全新的<code class="fe nl nm nn no b">bootstrap.php</code>文件来开始这项工作。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="7c04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">真的就这么简单。</p><p id="9a3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，因为我们不再使用WordPress的测试框架，我们不再能够访问<code class="fe nl nm nn no b">\WP_UnitTestCase</code>，所以我们需要将我们的测试用例转换到新的Mantle测试用例。</p><p id="11d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们开始之前，让我们花一点时间来谈谈集成和单元测试。</p><h2 id="31a7" class="mz lw it bd lx na nb dn mb nc nd dp mf li ne nf mh lm ng nh mj lq ni nj ml nk bi translated">集成与单元测试</h2><p id="f354" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">尽管测试用例的名字，WordPress实际上并不包括任何形式的单元测试。这么说可能会有争议，但这是真的。你在WordPress测试框架中写的每一个测试都是一个集成测试。为什么？因为它需要你与WordPress核心代码库集成才能运行。</p><p id="ee60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Mantle TestKit允许我们做的一件事是创建真正的单元测试，并在与集成测试相同的执行中运行它们。我们可以通过扩展两个不同的测试用例来做到这一点。</p><p id="1672" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个是<code class="fe nl nm nn no b">Mantle\TestKit\Integration_Test_Case</code>，顾名思义，是我们的集成测试。这个测试用例将处理安装WordPress核心，设置数据库，以及我们执行集成测试所需的一切。</p><p id="136d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，如果你想对情况有更多的控制，你总是可以扩展掉主<code class="fe nl nm nn no b">Mantle\TestKit\Test_Case</code>类。这仍然是一个集成测试，但是它要求您在执行之前手动执行Mantle安装过程。</p><p id="69b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二个是<code class="fe nl nm nn no b">Mantle\TestKit\Unit_Test_Case</code>,它自动强制我们所有的单元测试在一个单独的进程中运行，而不传递任何全局变量，因为安装集成测试可能会使全局范围变得混乱。</p><p id="b12f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为一个最佳实践，您应该创建您自己的定制测试用例，并从这些父测试用例扩展到您自己的测试，因为您可能需要在基础之上定制您的环境。</p><h2 id="60d9" class="mz lw it bd lx na nb dn mb nc nd dp mf li ne nf mh lm ng nh mj lq ni nj ml nk bi translated">配置集成测试</h2><p id="6d56" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">每个WordPress测试都有一个共同点，那就是在安装后执行回调。这也是Mantle提供给我们的。如果您正在扩展上述的<code class="fe nl nm nn no b">Integration_Test_Case</code>，那么您所需要做的就是向您的引导程序添加一个名为<code class="fe nl nm nn no b">mantle_after_wordpress_install</code>的函数。</p><p id="9719" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您计划从根<code class="fe nl nm nn no b">Test_Case</code>类扩展，那么您可以简单地<a class="ae ky" href="https://mantle.alley.co/testing/testkit.html#adjusting-unit-test-bootstrap" rel="noopener ugc nofollow" target="_blank">将这个函数作为闭包</a>传递给<code class="fe nl nm nn no b">\Mantle\install()</code>函数。出于本教程的目的，我假设您正在使用集成测试用例。</p><h2 id="c272" class="mz lw it bd lx na nb dn mb nc nd dp mf li ne nf mh lm ng nh mj lq ni nj ml nk bi translated">配置单元测试</h2><p id="64f6" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">如果你想要单元测试，那么需要两件事。首先，您的集成测试必须使用<code class="fe nl nm nn no b">Integration_Test_Case</code>类，或者您的定制实现必须在<code class="fe nl nm nn no b">setUpBeforeClass</code>挂钩期间安装Mantle。无论哪种方式，你都不能从你的引导中运行<code class="fe nl nm nn no b">Mantle\install()</code>——否则我们将会以一个混乱的全局范围结束，不管我们喜欢与否。</p><p id="a5f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二件事是你绝对必须使用<code class="fe nl nm nn no b">Unit_Test_Case</code>——或者复制功能。如果你要这么做，为什么还要使用Mantle呢？</p><p id="05c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于我的定制单元测试类，我使用Brain Monkey并在最初配置所有的东西。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="e5f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会注意到，除了扩展Mantle Unit_Test_Case类之外，这只是一个如何为Brain Monkey配置测试用例的例子。那是因为这就是全部。</p><h1 id="656e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">我们完了</h1><p id="01b4" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">实际上，一旦您的测试扩展了您的新定制类，并且您已经解决了自动加载的任何错误，这就应该是让您的测试工作所需的全部了。</p><p id="fc7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，如果您和我一样，已经在两个单独的PHPUnit配置文件中运行了这些文件，那么最后一步就是将它们合并到一个文件中。这就像把<code class="fe nl nm nn no b">testsuite</code>块从一个复制到另一个一样简单，并且确保你正在加载你的引导程序。</p><p id="ea01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我知道你是否转换到Mantle TestKit，以及你如何喜欢它。</p><p id="8077" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有兴趣投稿，你可以在Github 上找到整个<a class="ae ky" href="https://github.com/alleyinteractive/mantle-framework" rel="noopener ugc nofollow" target="_blank"> Mantle项目，文档可以在</a><a class="ae ky" href="https://mantle.alley.co/" rel="noopener ugc nofollow" target="_blank">Mantle网站</a>上找到。</p></div><div class="ab cl ny nz hx oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="im in io ip iq"><p id="0f11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你喜欢这篇文章吗？ <a class="ae ky" href="https://travisweston.com/membership" rel="noopener ugc nofollow" target="_blank"> <em class="mv">成为会员</em> </a> <em class="mv">阅读我写的所有东西——以及媒体上的所有内容。</em></p><p id="1405" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mv">已经是会员了？</em> <a class="ae ky" href="https://travisweston.com/subscribe" rel="noopener ugc nofollow" target="_blank"> <em class="mv">订阅得到通知</em> </a> <em class="mv">我放新文章的时候。</em></p><p id="46e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mv">全披露:Mantle是由我工作的WordPress社</em> <a class="ae ky" href="https://alley.co/" rel="noopener ugc nofollow" target="_blank"> <em class="mv">巷子</em> </a> <em class="mv">创建的。我们目前正在招聘，那么为什么不</em> <a class="ae ky" href="https://alley.co/careers/" rel="noopener ugc nofollow" target="_blank"> <em class="mv">申请与我</em> </a> <em class="mv">一起工作呢！</em></p></div></div>    
</body>
</html>