<html>
<head>
<title>How to Deploy Next.js on Multiple Servers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在多台服务器上部署Next.js</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-deploy-next-js-on-multiple-servers-3b493d4ce0e9?source=collection_archive---------1-----------------------#2021-12-22">https://levelup.gitconnected.com/how-to-deploy-next-js-on-multiple-servers-3b493d4ce0e9?source=collection_archive---------1-----------------------#2021-12-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ee93" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">处理由没有会话亲缘关系的负载平衡器服务的多个Next.js实例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8aa4bed8146a50c45a300f7d43e57386.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8-16s9pyKRgn2DvM"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@baciutudor?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">都铎·巴休</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="dd38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Next.js 中的多服务器部署很棘手。如果没有正确的配置，每次您的浏览器由<a class="ae ky" href="https://en.wikipedia.org/wiki/Load_balancing_(computing)" rel="noopener ugc nofollow" target="_blank">负载平衡器</a>提供不同的实例时，都会执行硬刷新。发生这种情况是因为您的浏览器无法将您正在运行的应用程序包含的实例识别为同一应用程序的一部分。</p><p id="9da5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这打破了Next.js通常检索数据的方式，并且不允许它正常工作。因此，这不仅会导致糟糕的性能，还会妨碍Next.js的独特功能发挥作用。</p><p id="ea87" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">换句话说，你可能最终会失去Next.js带来的几乎所有好处。幸运的是，它可以被配置来避免这一切。因此，让我们看看如何在多服务器环境中部署Next.js应用程序时，使其按预期工作。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c8fe" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">了解Next.js构建ID逻辑</h1><blockquote class="mu mv mw"><p id="ffab" class="kz la mx lb b lc ld ju le lf lg jx lh my lj lk ll mz ln lo lp na lr ls lt lu im bi translated">Next.js使用在构建时生成的常量id来标识应用程序的哪个版本。当<code class="fe nb nc nd ne b"><em class="it">next build</em></code>在每台服务器上运行时，这会在多服务器部署中导致问题。为了在构建之间保持一个静态的构建id，您可以提供您自己的构建id。— <a class="ae ky" href="https://nextjs.org/docs/api-reference/next.config.js/configuring-the-build-id" rel="noopener ugc nofollow" target="_blank">配置构建ID </a></p></blockquote><p id="7793" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如官方文档中所解释的，每当启动<code class="fe nb nc nd ne b">next build</code>时，Next.js都会产生一个新的构建ID，唯一地标识新生成的实例。这意味着前面提到的多服务器部署问题只有在<code class="fe nb nc nd ne b">next build</code>命令运行多次时才会出现。事实上，启动build命令一次，然后在不同的服务器上部署生成的构建包，每个实例将具有相同的构建ID。</p><p id="15d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不幸的是，具有负载平衡器的多服务器环境通常在每次需要基于流量创建新实例时启动build命令。基本上，当当前服务器负载过大时，部署环境会动态地创建一个新实例。而要做到这一点，就启动了<code class="fe nb nc nd ne b">next build</code>，导致了不同build IDs的问题。</p><p id="74ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请记住，拥有多个具有不同构建id的实例本身并不是问题。只有在同一导航会话中为同一用户提供不同实例时，才会出现问题。这意味着，如果您的多个实例由具有会话关联性的负载平衡器提供服务，最终用户将不会遇到任何问题。这是因为一个用户将总是得到相同实例的服务。</p><p id="9696" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，用户现在正在使用的实例可能因为低流量而被删除。在这种情况下，负载平衡器将被迫为用户提供另一个实例。因此，您不应该只依赖负载平衡器。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="aa0a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Next.js中的多服务器部署</h1><p id="4ce5" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">正如这里提到的<a class="ae ky" href="https://nextjs.org/docs/api-reference/next.config.js/configuring-the-build-id" rel="noopener ugc nofollow" target="_blank"/>，Next.js允许你定义一个定制的构建ID。具体来说，可以通过使用<code class="fe nb nc nd ne b"><a class="ae ky" href="https://nextjs.org/docs/api-reference/next.config.js/introduction" rel="noopener ugc nofollow" target="_blank">next.config.js</a></code>文件中的<code class="fe nb nc nd ne b"><a class="ae ky" href="https://nextjs.org/docs/api-reference/next.config.js/configuring-the-build-id" rel="noopener ugc nofollow" target="_blank">generateBuildId</a></code>属性来实现，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="9eb5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">生成一个合适的构建ID不是一项简单的任务。例如，避免使用当前时间戳，因为<code class="fe nb nc nd ne b">next build</code>命令都是在不同的时间启动的。一个好的解决方案是使用最新的git提交散列。这将确保所有实例都有相同的构建ID。</p><p id="a0b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要实现这一点，您可以使用<code class="fe nb nc nd ne b"><a class="ae ky" href="https://www.npmjs.com/package/next-build-id" rel="noopener ugc nofollow" target="_blank">next-build-id</a></code> npm包。首先，使用以下命令将其添加到项目的依赖项中:</p><pre class="kj kk kl km gt nm ne nn no aw np bi"><span id="3b57" class="nq md it ne b gy nr ns l nt nu">npm install next-build-id</span></pre><p id="870a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以按如下方式使用它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="ff1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nb nc nd ne b">nextBuildId()</code>函数将从您的本地git存储库中返回最新的git提交散列。换句话说，这相当于:</p><pre class="kj kk kl km gt nm ne nn no aw np bi"><span id="19ac" class="nq md it ne b gy nr ns l nt nu">git rev-parse HEAD</span></pre><p id="72ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nb nc nd ne b">next-build-id</code>还提供其他选项。在其官方GitHub页面上了解更多信息。</p><p id="e438" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了验证您的Next.js实例使用了正确的构建ID，您可以查找存储在构建目录中的<code class="fe nb nc nd ne b">BUILD_ID</code>文本文件。默认情况下，它是<code class="fe nb nc nd ne b">.next</code>目录。否则，您可以从Next.js提供的静态资源的URL来验证它。您可以从浏览器开发工具的网络部分检索这些URL。事实上，这是Next.js在设置构建ID时为静态文件使用的URL格式:</p><pre class="kj kk kl km gt nm ne nn no aw np bi"><span id="779a" class="nq md it ne b gy nr ns l nt nu">/_next/static/&lt;build-ID&gt;/&lt;static-file&gt;</span></pre><p id="7fe1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，以下静态资源:</p><pre class="kj kk kl km gt nm ne nn no aw np bi"><span id="ee7b" class="nq md it ne b gy nr ns l nt nu"><a class="ae ky" href="https://www.example.com/_next/static/_buildManifest.js" rel="noopener ugc nofollow" target="_blank">https://www.example.com/_next/static/_buildManifest.js</a></span></pre><p id="8314" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">会变成:</p><pre class="kj kk kl km gt nm ne nn no aw np bi"><span id="131e" class="nq md it ne b gy nr ns l nt nu"><a class="ae ky" href="https://www.example.com/_next/static/c657j0328d606cc59cffafe62c09926eb6b749de/_buildManifest.js" rel="noopener ugc nofollow" target="_blank">https://www.example.com/_next/static/c657j0328d606cc59cffafe62c09926eb6b749de/_buildManifest.js</a></span></pre><p id="aff6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，静态资源URL现在包括“c 657j 0328d 606 cc 59 cffafe 62 c 09926 EB 6b 749 de”，它表示用作构建ID的git提交散列。</p><p id="8c0f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nb nc nd ne b">next-build-id</code>是一个很棒的工具，但请记住，它只有在您有权访问您的<code class="fe nb nc nd ne b">.git</code>文件夹时才有效。例如，在处理<a class="ae ky" href="https://aws.amazon.com/elasticbeanstalk/" rel="noopener ugc nofollow" target="_blank"> AWS弹性豆茎</a>时，情况并非如此。</p><p id="8701" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，让我们看看在使用AWS Elastic Beanstalk时，如何给build ID一个合适的值。</p><h2 id="45bf" class="nq md it bd me nv nw dn mi nx ny dp mm li nz oa mo lm ob oc mq lq od oe ms of bi translated">在AWS弹性豆茎上展开</h2><p id="2701" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">AWS Elastic Beanstalk执行部署所需的<code class="fe nb nc nd ne b"><a class="ae ky" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb3-deploy.html" rel="noopener ugc nofollow" target="_blank">eb deploy</a></code>命令依赖于<code class="fe nb nc nd ne b">git archive</code>命令。这不会复制<code class="fe nb nc nd ne b">.git</code>文件夹，使<code class="fe nb nc nd ne b">next-build-id</code>无法工作。</p><p id="b05f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，GitHub用户找到了一个变通办法。正如这里的<a class="ae ky" href="https://github.com/vercel/next.js/issues/786#issuecomment-393303217" rel="noopener ugc nofollow" target="_blank">所解释的</a>，您可以从您的本地git存储库中生成一个等于最新git提交散列的构建ID，而不需要<code class="fe nb nc nd ne b">next-build-id</code>，如下所示:</p><p id="2eea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">1.在<code class="fe nb nc nd ne b">next.config.js</code>中，赋予<code class="fe nb nc nd ne b">generateBuildId</code>属性以下值:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="5d7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2.在您的根目录中创建一个<code class="fe nb nc nd ne b"><a class="ae ky" href="https://git-scm.com/docs/gitattributes" rel="noopener ugc nofollow" target="_blank">.gitattributes</a></code>文件，并用下面的代码行初始化它:</p><pre class="kj kk kl km gt nm ne nn no aw np bi"><span id="8912" class="nq md it ne b gy nr ns l nt nu">next.config.js export-subst</span></pre><p id="cf6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个命令将由<code class="fe nb nc nd ne b">git archive</code>使用，并将负责用当前git提交散列替换“$Format:%H$”字符串。</p><p id="3bb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本地构建项目需要使用<code class="fe nb nc nd ne b">if</code>语句。这是因为“$Format:%H$”不是有效的内部版本id。因此，如果没有它，本地启动的<code class="fe nb nc nd ne b">npm run build</code>命令将会失败。特别是，当应用<code class="fe nb nc nd ne b">next.config.js export-subst</code>时，两个“$Format:%H$”字符串将被替换为提交散列，并且<code class="fe nb nc nd ne b">if</code>条件将为假。相反，如果没有<code class="fe nb nc nd ne b">next.config.js export-subst</code>命令，则<code class="fe nb nc nd ne b">if</code>语句将为真，将使用“static-build-id”构建id。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e332" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="054e" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">在这里，我们研究了如何在多服务器环境中部署Next.js应用程序。使用Next.js <code class="fe nb nc nd ne b">generateBuildId</code>特性允许您让所有实例共享相同的构建ID。这就是Next.js用来创建与客户端的会话的内容，如果没有这些信息，这是不可能的。<code class="fe nb nc nd ne b">next-build-id</code>是正确生成它的好解决方案，但是如图所示，使用AWS时需要定制逻辑。</p><p id="09be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！我希望我的故事对你有所帮助。如果有任何问题、意见或建议，请随时联系我。</p></div></div>    
</body>
</html>