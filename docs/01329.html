<html>
<head>
<title>MainWindowHandle is a Lie</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MainWindowHandle是个谎言</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/mainwindowhandle-is-a-lie-6e82e0e0fc8d?source=collection_archive---------5-----------------------#2019-12-14">https://levelup.gitconnected.com/mainwindowhandle-is-a-lie-6e82e0e0fc8d?source=collection_archive---------5-----------------------#2019-12-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="260f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何将窗口前置</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0d8b3569c1ed196308e1b1f3480d6f44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jgzVKDGBHm0cUBr6"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@slrncl" rel="noopener ugc nofollow" target="_blank"> Nicolas Solerieu </a>在<a class="ae kv" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="c3b6" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">场景</h1><p id="aba5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在工作中，我必须编写一个脚本，将不同版本的Excel文件复制到我的计算机上，并编辑副本。</p><p id="59f2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">实现这一点的代码非常简单，然而令人烦恼的是，在你保存文件后，<em class="mp"> Microsoft Excel —兼容性检查器</em>会弹出并阻塞主线程，直到你点击<em class="mp">继续</em>。</p><p id="25e8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">弹出窗口总是隐藏在我打开的其他窗口后面，我必须最小化所有东西才能看到弹出的Excel窗口。</p><p id="6d0f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">因此，我需要一种方法来自动将Excel弹出窗口放到最前面。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/9c387dc9231252cd2aea206be5d3c03a.png" data-original-src="https://miro.medium.com/v2/resize:fit:820/format:webp/0*e89X9PlZXRDEDRwl.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">兼容性检查器弹出窗口</figcaption></figure><h1 id="7540" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">解决问题的首次尝试</h1><p id="29e2" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我在网上找了一下，找到了一些可以获得Excel进程的<code class="fe mr ms mt mu b">MainWindowHandle</code>属性的代码，然后使用它作为Win32函数的输入，将该进程的窗口放到最前面:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="d0d4" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">MainWindowHandle是个谎言</h1><p id="24a8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">这段代码在其他窗口中运行良好，但是由于某种原因，Excel弹出窗口的<code class="fe mr ms mt mu b"><a class="ae kv" href="https://msdn.microsoft.com/en-us/library/system.diagnostics.process.mainwindowhandle(v=vs.110).aspx" rel="noopener ugc nofollow" target="_blank">System.Diagnostics.Process.MainWindowHandle</a></code>属性的值为0，这意味着<code class="fe mr ms mt mu b">SetForegroundWindow()</code>功能不起作用。</p><p id="3dd0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我注意到对于任何在Windows开始栏中有图标的窗口,<code class="fe mr ms mt mu b">MainWindowHandle</code>属性都是<code class="fe mr ms mt mu b">&gt; 0</code>,所以可能<code class="fe mr ms mt mu b">MainWindowHandle</code>是0，因为尽管Excel弹出窗口有GUI，但开始栏中没有图标。</p><h2 id="fe07" class="mx kx iq bd ky my mz dn lc na nb dp lg lx nc nd li mb ne nf lk mf ng nh lm ni bi translated">Windows API可以做到，我也可以</h2><p id="ab02" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在任务管理器中，我可以右键单击Excel进程，然后单击<em class="mp">前置</em>，这将成功地将弹出窗口前置，因此我知道一定有一些Win32代码可以工作。</p><p id="1dae" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">经过一些研究，我发现每个窗口都有一个句柄，不管它在开始栏中是否有图标，我只是需要另一种方法来找到正确的句柄。</p><p id="f6fe" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">原来Windows API并没有模拟主窗口的概念。这纯粹是在。NET framework，它应用试探法来确定用户认为什么是主窗口。</p><h1 id="67a4" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">可行的解决方案</h1><p id="7643" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">多亏了StackOverflow.com的指点，他指引我找到了<code class="fe mr ms mt mu b"><a class="ae kv" href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms633497.aspx" rel="noopener ugc nofollow" target="_blank">EnumWindows</a></code> Win32函数，我才能够写一些获得正确句柄的代码:)</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="d651" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在<code class="fe mr ms mt mu b">MainWindowHandle</code>属性为&gt; 0，我们可以调用<code class="fe mr ms mt mu b">SetForegroundWindow()</code>函数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="dfbb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">使用这段代码，我现在可以复制一个Excel文件，修改它，并把Excel弹出到前面自动:D</p><p id="1a26" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">看看我的<a class="ae kv" href="https://github.com/DavidKlempfner/CreatingAnExcelFile/blob/master/CreatingAnExcelFile.ps1" rel="noopener ugc nofollow" target="_blank"> GitHub </a>页面，看看复制并编辑Excel文件的全部代码。</p><p id="6de3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">整个代码还向您展示了如何在自己的线程中运行<code class="fe mr ms mt mu b">EnumWindows</code>代码，因为Excel弹出窗口阻塞了主线程，所以您必须这样做。</p></div></div>    
</body>
</html>