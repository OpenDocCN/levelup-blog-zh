<html>
<head>
<title>Security Best Practices for Using Express Apps in Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在生产中使用Express应用程序的安全最佳实践</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/security-best-practices-for-using-express-apps-in-production-d1f883ac1b41?source=collection_archive---------8-----------------------#2020-03-06">https://levelup.gitconnected.com/security-best-practices-for-using-express-apps-in-production-d1f883ac1b41?source=collection_archive---------8-----------------------#2020-03-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/9163bf6911a92352ba7d9af562bac037.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xIAb9G66AbIoWiPD"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@bernardhermant?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">伯纳德·赫尔曼</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="552e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我们将Express应用程序用于生产时，即它由外部用户使用时，我们必须小心安全性，因为它对外部世界是可用的。</p><p id="7b70" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我们将了解在生产环境中运行Express应用程序时的一些安全性最佳实践。</p><h1 id="44f3" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">不要使用过期版本的Express</h1><p id="b4b7" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">Express的过时版本不再维护，可能存在未打补丁的安全漏洞，使我们的应用程序面临各种攻击的风险。</p><h1 id="9fb1" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用TLS</h1><p id="9639" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果我们在传输需要保护的数据，我们应该使用TLS来保护用户的数据。这意味着我们避免了中间人攻击和数据包嗅探。</p><p id="243a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">即使我们的应用程序不传输安全数据，它仍然让用户更加相信我们的网站是安全的。</p><p id="0db3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以用“让我们加密”获得免费的TLS证书。这是一种自动服务，可以生成浏览器信任的新证书，</p><h1 id="871a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用头盔</h1><p id="19b8" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">头盔是一系列快速中间件，通过设置HTTP头来保护我们的应用程序在网络上存在一些众所周知的安全漏洞。</p><p id="a4af" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Helment附带的中间件包括:</p><ul class=""><li id="ddcb" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">csp</code> —设置<code class="fe mq mr ms mt b">Content-Security-Policy</code>头以帮助防止跨站点脚本攻击和其他跨站点注入。</li><li id="439a" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">hidePoweredBy</code> —移除<code class="fe mq mr ms mt b">X-Powered-By</code>标题</li><li id="a88c" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">hpkp</code> —添加公钥锁定报头，防止中间人利用伪造证书进行攻击</li><li id="9edf" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">hsts</code> —设置强制HTTPS连接到服务器的<code class="fe mq mr ms mt b">Strict-Transport-Security</code>标头。</li><li id="a99d" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">ieNoOpen</code> 0为IE 8或更高版本设置<code class="fe mq mr ms mt b">X-Download-Options</code></li><li id="53b2" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">noCache</code> —设置<code class="fe mq mr ms mt b">Cache-Control</code>和<code class="fe mq mr ms mt b">Pragma</code>头以禁用客户端缓存</li><li id="2f68" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">noSniff</code> —设置<code class="fe mq mr ms mt b">X-Content-Type-Options</code>头以防止浏览器从声明的内容类型中嗅探响应</li><li id="12c1" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">frameguard</code> —设置<code class="fe mq mr ms mt b">X-Frame-Options</code>割台以提供点击劫持保护</li><li id="82bc" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">xssFilter</code> —将<code class="fe mq mr ms mt b">X-XSS-Protection</code>设置为在最新的web浏览器中启用跨站点脚本过滤器</li></ul><p id="0478" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">至少禁用<code class="fe mq mr ms mt b">x-powered-by</code>响应头是一个好主意，这样攻击者就不会知道我们的应用是一个Express应用，并对其发起特定的攻击。</p><h1 id="a1e1" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">安全使用Cookies</h1><p id="6b85" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们可以使用<code class="fe mq mr ms mt b">express-session</code>或<code class="fe mq mr ms mt b">cookie-session</code>中间件来安全地使用cookies。</p><p id="64b7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mq mr ms mt b">express-session</code>在服务器上存储会话数据。它只将会话ID保存在cookie本身。</p><p id="8148" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以设置一个会话存储供生产使用，因为它默认使用内存存储。</p><p id="2a1f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将整个cookie存储在客户端。我们设置cookies的时候不应该超过4093字节。</p><p id="9b08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">cookie数据对客户端是可见的，所以秘密数据不应该用<code class="fe mq mr ms mt b">cookie-session</code>发送给客户端。</p><h1 id="36e5" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">不要使用默认会话Cookie名称</h1><p id="46a3" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">不应使用由Express设置的默认会话cookie名称，因为它可以识别某个应用程序正在Express上运行。</p><p id="53d8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以通过向<code class="fe mq mr ms mt b">session</code>传递一个对象来做到这一点，如下所示:</p><pre class="mz na nb nc gt nd mt ne nf aw ng bi"><span id="a47b" class="nh lf it mt b gy ni nj l nk nl">const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const session = require('express-session');<br/>const app = express();</span><span id="9d68" class="nh lf it mt b gy nm nj l nk nl">app.use(bodyParser.json());<br/>app.use(bodyParser.urlencoded({ extended: true }));</span><span id="9574" class="nh lf it mt b gy nm nj l nk nl">app.set('trust proxy', 1);<br/>app.use(session({<br/>  secret: 'secret',<br/>  name: 'sessionId'<br/>}))</span><span id="b341" class="nh lf it mt b gy nm nj l nk nl">app.listen(3000);</span></pre><figure class="mz na nb nc gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nn"><img src="../Images/298dcfc84e0565cf732ba9c9a6d10bc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*r4aJW3WxBUIg0liF"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@raividanes?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Rai Vidanes </a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="a6f3" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">设置Cookie安全选项</h1><p id="8e37" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为了增强安全性，我们可以设置各种cookie选项。以下是可用的选项:</p><ul class=""><li id="6234" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">secure</code> —确保浏览器仅通过HTTPS发送cookie</li><li id="9296" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">httpOnly</code> —确保cookie仅通过HTTP(S)发送，而不是客户端JavaScript。这有助于我们防止XSS袭击</li><li id="54ab" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">domain</code> —表示cookie的域，可用于与请求cookie的URL中的服务器的域进行比较。</li><li id="90c2" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">path</code> —指示与请求的路径进行比较的路径，然后在请求中发送cookie</li><li id="5e9b" class="mh mi it ki b kj mu kn mv kr mw kv mx kz my ld mm mn mo mp bi translated"><code class="fe mq mr ms mt b">expires</code> —设置永久cookies的到期日期。</li></ul><p id="e79d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我们可以如下使用它:</p><pre class="mz na nb nc gt nd mt ne nf aw ng bi"><span id="dac2" class="nh lf it mt b gy ni nj l nk nl">const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const session = require('express-session');<br/>const app = express();</span><span id="60bc" class="nh lf it mt b gy nm nj l nk nl">app.use(bodyParser.json());<br/>app.use(bodyParser.urlencoded({ extended: true }));<br/>const expiryDate = new Date(Date.now() + 60 * 60 * 1000)<br/>app.use(session({<br/>  name: 'session',<br/>  secret: 'secret',<br/>  keys: ['foo', 'bar'],<br/>  cookie: {<br/>    secure: true,<br/>    httpOnly: true,<br/>    domain: 'EnormousBeneficialScript--five-nine.repl.co',<br/>    path: '/',<br/>    expires: expiryDate,<br/>  }<br/>}));</span><span id="360e" class="nh lf it mt b gy nm nj l nk nl">app.get('/', (req, res) =&gt; {<br/>  req.session.foo = 'foo';<br/>  res.send(req.session.foo);<br/>})</span><span id="df57" class="nh lf it mt b gy nm nj l nk nl">app.listen(3000);</span></pre><h1 id="cef3" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">防止暴力攻击</h1><p id="ad33" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们可以对我们的授权路径进行速率限制，这样攻击者就不能使用暴力攻击来猜测存储在我们应用程序数据库中的凭证。</p><p id="80fe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我们可以通过限制拥有相同用户名和IP地址的用户尝试失败的次数来限制IP地址。</p><p id="09ed" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，如果用户尝试失败的次数达到了我们可以容忍的程度，我们就会锁定用户一段时间。</p><p id="1c08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果一天中失败的尝试超过100次，我们就会封锁该IP地址。</p><p id="7874" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以使用<a class="ae kf" href="https://github.com/animir/node-rate-limiter-flexible" rel="noopener ugc nofollow" target="_blank">灵活限速器</a>包对我们的路线进行限速。</p><h1 id="cc46" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="dbae" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为了使我们的Express应用程序在生产环境中保持安全，我们应该采取一些预防措施。</p><p id="e578" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们应该使用TLS来传输数据，以防止它们被嗅探，并防止中间人攻击。</p><p id="9a7f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们应该设置标题，防止用户找到关于我们应用的信息，并加强安全通信。</p><p id="8597" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，我们应该安全地使用cookies，用一个秘密对它进行签名，并为它们设置安全选项。</p><p id="cee5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，为了防止暴力攻击，我们应该为我们的API调用设置一个速率限制，这样攻击者就不能通过重复的登录尝试来猜测我们用户的凭证。</p></div></div>    
</body>
</html>