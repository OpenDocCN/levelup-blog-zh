<html>
<head>
<title>Azure Key Vault Secrets Automation and Integration in DevOps pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Key Vault Secrets在DevOps管道中的自动化和集成</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/automate-secrets-to-azure-key-vault-and-access-it-in-devops-pipelines-69a24ecb9602?source=collection_archive---------2-----------------------#2022-09-01">https://levelup.gitconnected.com/automate-secrets-to-azure-key-vault-and-access-it-in-devops-pipelines-69a24ecb9602?source=collection_archive---------2-----------------------#2022-09-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="5e8d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如何使用Terraform将秘密推入您的密钥库，然后在您的DevOps应用程序管道中使用它。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/3e27a279926af0c0257326fe59bc4121.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nu8Svglxf-kieKkL-vww4Q.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">杰森·登特在<a class="ae le" href="https://unsplash.com/s/photos/vault?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="0436" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">要求</h1><ol class=""><li id="91a9" class="md me it js b jt mf jx mg kb mh kf mi kj mj kn mk ml mm mn bi translated">带有秘密的服务主体(应用程序注册)。</li><li id="54bd" class="md me it js b jt mo jx mp kb mq kf mr kj ms kn mk ml mm mn bi translated">带有服务主体访问策略的Azure密钥库</li><li id="4571" class="md me it js b jt mo jx mp kb mq kf mr kj ms kn mk ml mm mn bi translated">Azure DevOps项目中的服务连接</li><li id="5417" class="md me it js b jt mo jx mp kb mq kf mr kj ms kn mk ml mm mn bi translated">YAML管道脚本中的KeyVault任务</li></ol><h1 id="fd0c" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">1.使用机密创建服务主体。</h1><p id="f96c" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated">我们的第一步是通过azure CLI创建一个服务主体，下面是要遵循的基本命令。</p><p id="f295" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">创建Azure活动目录应用程序。</strong></p><pre class="kp kq kr ks gt mw mx my bn mz na bi"><span id="affa" class="nb lg it mx b be nc nd l ne nf">az account set -s &lt;subscription&gt;<br/># name for the azure ad application<br/>appName="project_serviceprincipal"<br/># create an Azure AD application<br/>az ad app create \ <br/> --display-name $appName \     <br/> --homepage "http://localhost/$appName" \     <br/> --identifier-uris [http://localhost/$appName](http://localhost/$appName)</span></pre><p id="f29e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ng nh ni mx b">--homepage</code>和<code class="fe ng nh ni mx b">--identifier-uris</code>值不一定必须是可到达的URIs。</p><p id="56b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">创建服务主体</strong></p><p id="b194" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下一步是创建具有“贡献者”RBAC角色的服务主体。</p><pre class="kp kq kr ks gt mw mx my bn mz na bi"><span id="c7bd" class="nb lg it mx b be nc nd l ne nf">sp_password="password123" <br/>subscription_id=$(az account show --query id -o tsv) rg_name="your_resource_group_name" <br/>az ad sp create-for-rbac --name $appId --password $sp_password \                       --role contributor \                 <br/>--scopes /subscriptions/$subscription_id/resourceGroups/$rg_name</span></pre><blockquote class="nj nk nl"><p id="a389" class="jq jr nm js b jt ju jv jw jx jy jz ka nn kc kd ke no kg kh ki np kk kl km kn im bi translated">一旦运行完这个查询，az将生成包含一个<code class="fe ng nh ni mx b">password</code>键的输出，并确保您保存它以备后用，因为您无法再次检索它。</p></blockquote><h1 id="527d" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">2.使用Terraform创建Azure密钥库</h1><p id="7e24" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated">我们可以使用Terraform来配置密钥库，要求如下</p><p id="f4b9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">T15"只能从选定的虚拟网络、受信任的azure服务和受信任的internet IP访问密钥库。"</p><p id="9343" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，当您创建您的密钥库时，您可以使用<code class="fe ng nh ni mx b">azurerm_client_config</code>来读取用于运行您的Terraform代码的当前服务主体细节(您可以使用之前创建的服务主体)。</p><p id="8ed2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<code class="fe ng nh ni mx b">network_acls</code>中，我们已经将<code class="fe ng nh ni mx b">default_action</code>设置为<strong class="js iu">拒绝</strong>，所以现在密钥库对于您的网络是私有的，并且必须添加您的构建代理子网id才能访问密钥库。但问题是，你的DevOps还不是一个可信的Azure服务，还必须将你的DevOps区域IP地址(在本例中为美国南部)添加到<code class="fe ng nh ni mx b">ip_rules</code>中，才能获得DevOps管道中的密钥库访问。您可以在此处获取您的DevOps地区IP详细信息<a class="ae le" href="https://docs.microsoft.com/en-us/azure/devops/organizations/security/allow-list-ip-url?view=azure-devops&amp;tabs=IP-V4" rel="noopener ugc nofollow" target="_blank">允许的地址列表和网络连接— Azure DevOps | Microsoft Docs </a></p><p id="b435" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，<code class="fe ng nh ni mx b">access_policy</code>是一个重要的参数，您将在其中分配服务主体对密钥库的访问权限，否则您不能使用服务主体添加或列出任何机密(策略现在被视为“传统”策略，可以使用RBAC角色，我们可以使用<code class="fe ng nh ni mx b">azurerm_role_assignment</code>在terraform中创建RBAC)</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="4b3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的示例代码将一个秘密“kv_secret”插入到密钥库(我们已将“Create”角色分配给terraform服务主体)，您可以通过添加特定于资源的秘密(如存储帐户密钥、app insights API密钥等)来提高效率。</p><h1 id="dddb" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">3.在Azure DevOps中创建服务连接</h1><p id="9f35" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated">下一步是创建一个服务连接，我们稍后将在Azure DevOps管道中使用它来访问密钥库</p><ol class=""><li id="0750" class="md me it js b jt ju jx jy kb ns kf nt kj nu kn mk ml mm mn bi translated">登录到您的组织(<code class="fe ng nh ni mx b">https://dev.azure.com/{yourorganization}</code>)并选择您的项目。</li><li id="16f9" class="md me it js b jt mo jx mp kb mq kf mr kj ms kn mk ml mm mn bi translated">选择项目设置&gt;服务连接。</li><li id="2577" class="md me it js b jt mo jx mp kb mq kf mr kj ms kn mk ml mm mn bi translated">选择+新建服务连接，选择您需要的服务连接类型，然后选择下一步。</li><li id="8d58" class="md me it js b jt mo jx mp kb mq kf mr kj ms kn mk ml mm mn bi translated">我们将选择“服务主体(手动)”而不是推荐的选项，因为我们必须在单击“下一步”后提供我们的服务主体详细信息</li></ol><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/b0fa38467e25199cb1187072fb5d9c1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:934/format:webp/1*-bsTCMRXri-fjDT2Orv-Mg.png"/></div></figure><p id="e3d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.在这里，您将提供您的订阅详细信息+服务主体Id和我们在步骤1中创建并保存的“密码密钥”</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/bab79c88aa71262bdcdecb8d47a8ddfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*yfjHX8ocwajOOrNbm_-aKA.png"/></div></figure><h1 id="4f1f" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">4.使用KeyVault任务读取管道内部的秘密</h1><p id="8e7b" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated">使用<code class="fe ng nh ni mx b">AzureKeyVault@2</code>任务下载应用程序管道中的秘密。我们必须提供先前创建的服务连接&amp;密钥库名称来访问该库</p><pre class="kp kq kr ks gt mw mx my bn mz na bi"><span id="dee3" class="nb lg it mx b be nc nd l ne nf"># Azure Key Vault<br/># Download Azure Key Vault secrets<br/>- task: AzureKeyVault@2<br/>inputs:<br/>connectedServiceName: "my_service_connection"<br/>keyVaultName: "example_keyvault"<br/>secretsFilter: '*' # Downloads all secrets for the key vault<br/>runAsPreJob: true # Runs before the job starts</span></pre><p id="2e38" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">密钥库任务将作为前置作业运行，它将在任何作业之前运行，您可以将密钥分配给变量并在整个管道中使用它们。</p><pre class="kp kq kr ks gt mw mx my bn mz na bi"><span id="7244" class="nb lg it mx b be nc nd l ne nf">jobs:<br/>- job: Build<br/>  displayName: 'Build'<br/>  variables:<br/>    MySecret: $(my-secret) # this will replace the value from vault</span></pre><h2 id="51b7" class="nx lg it bd lh ny nz dn ll oa ob dp lp kb oc od lt kf oe of lx kj og oh mb oi bi translated">结论</h2><p id="0035" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated">我已经尝试解释了一种在私有网络中访问Azure密钥库以及在DevOps管道中访问它的安全方式。同样的事情还有很多其他方法，我的方法可能会有缺陷。我会很感激在采用这个之前做你的研究。快乐脚本:)</p></div></div>    
</body>
</html>