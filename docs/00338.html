<html>
<head>
<title>Taking Advantage of MongoDB’s ‘Change Streams’ for real-time IoT applications using Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Node.js利用MongoDB的“变更流”实现实时物联网应用</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/taking-advantage-of-mongodbs-change-streams-for-real-time-iot-applications-using-nodejs-a0a76ae1376d?source=collection_archive---------2-----------------------#2019-01-15">https://levelup.gitconnected.com/taking-advantage-of-mongodbs-change-streams-for-real-time-iot-applications-using-nodejs-a0a76ae1376d?source=collection_archive---------2-----------------------#2019-01-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/72b1c156d4c2845fb1faa86ea7d39cc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xsU_-vw_YwvZnIzPX7375w.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图片来自<a class="ae kc" href="https://www.pexels.com/@cookiecutter" rel="noopener ugc nofollow" target="_blank"> Pexel </a></figcaption></figure><h1 id="fe1a" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">介绍</h1><p id="dd74" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">几个月前，我参与了一个项目，该项目有一个微控制器，它带有几个传感器，连接到一台PC，不断地向它输入新数据。PC将存储和处理这些数据，生成事件触发器，通过套接字发送到网页。我需要一种方法来存储每个新事件，同时保持网页实时更新。</p><h1 id="f0c6" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">为什么是MongoDB？</h1><p id="2439" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">MongoDB是一个NoSQL(非关系)数据库，这意味着它不需要预定义的表模式。这在处理大量非结构化数据时尤其有用，这些数据在项目的生命周期中可能会改变，也可能不会改变。鉴于项目规格的简单变化可能需要添加新的传感器，或者从这些传感器存储的新数据，非关系数据库完全符合我的需求。</p><h1 id="b015" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">节点服务器</h1><p id="afe3" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">尽管有其他用于服务器开发的框架和编程语言，但Node已被证明易于实现和部署。我利用了<a class="ae kc" href="https://medium.com/javascript-scene/introduction-to-node-express-90c431f9e6fd" rel="noopener"> Express </a>并用Vue开发了网页，因为……让我们面对现实吧，Vue简直棒极了。</p><p id="cba9" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">因此，让我们深入研究代码:</p><p id="7fdd" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated"><em class="me"> server.js </em>:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="3121" class="mo ke iq mk b gy mp mq l mr ms">var MongoClient = require('mongodb').MongoClient;</span><span id="645b" class="mo ke iq mk b gy mt mq l mr ms">const pipeline = [{$project: { documentKey: false }}];</span><span id="f708" class="mo ke iq mk b gy mt mq l mr ms">MongoClient.connect("mongodb://localhost:27017?replicaSet=mongo-repl", { useNewUrlParser: true }, function(err, database) {</span><span id="ef88" class="mo ke iq mk b gy mt mq l mr ms"> if (err) throw err;</span><span id="b84d" class="mo ke iq mk b gy mt mq l mr ms"> var db = database.db("demo-db");</span><span id="3e87" class="mo ke iq mk b gy mt mq l mr ms"> console.log("[mongodb] Mongo connection established");</span><span id="630d" class="mo ke iq mk b gy mt mq l mr ms"> // Show database docs for debugging</span><span id="6806" class="mo ke iq mk b gy mt mq l mr ms"> console.log("[mongodb] Mongo db dump: ");</span><span id="a566" class="mo ke iq mk b gy mt mq l mr ms"> db.collection("data").find({},{fields: {"_id" : false }}).toArray(function(err, result) {</span><span id="79a9" class="mo ke iq mk b gy mt mq l mr ms">  if (err) throw err;</span><span id="1fb9" class="mo ke iq mk b gy mt mq l mr ms">  console.log(result);</span><span id="fb9d" class="mo ke iq mk b gy mt mq l mr ms"> });</span><span id="829c" class="mo ke iq mk b gy mt mq l mr ms"> const changeStream = db.collection("data").watch(pipeline);</span><span id="5398" class="mo ke iq mk b gy mt mq l mr ms"> changeStream.on("change", function(change) {</span><span id="3b29" class="mo ke iq mk b gy mt mq l mr ms">  dataObj = {"sensor" : change.fullDocument.sensor}</span><span id="608a" class="mo ke iq mk b gy mt mq l mr ms">  console.log(dataObj);</span><span id="73bf" class="mo ke iq mk b gy mt mq l mr ms"> });</span><span id="353e" class="mo ke iq mk b gy mt mq l mr ms">});</span></pre><p id="44f4" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">为了运行这段代码，首先需要做几件事情。</p><ul class=""><li id="8118" class="mu mv iq ld b le lz li ma lm mw lq mx lu my ly mz na nb nc bi translated">你需要<a class="ae kc" href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/" rel="noopener ugc nofollow" target="_blank">安装</a> MongoDB服务器，点击链接查看如何在Ubuntu上安装的详细说明。</li><li id="3b42" class="mu mv iq ld b le nd li ne lm nf lq ng lu nh ly mz na nb nc bi translated">安装后，您需要在项目文件夹中创建一个特定的文件夹。</li></ul><p id="5cb7" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">假设您的项目在<code class="fe ni nj nk mk b">~/project,</code>上，您需要运行:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="5d7c" class="mo ke iq mk b gy mp mq l mr ms">cd ~/project<br/>mkdir data</span></pre><p id="6c01" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">然后(这是关键部分):</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="fe23" class="mo ke iq mk b gy mp mq l mr ms">mongod --port 27017 --dbpath ./data --smallfiles --replSet mongo-repl</span></pre><p id="7715" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">在另一个终端运行中:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="c05e" class="mo ke iq mk b gy mp mq l mr ms">mongo --port 27017 --eval 'rs.initiate({"_id":"mongo-repl","members":[{"_id":0,"host":"localhost:27017"}]})'</span></pre><p id="d025" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">好吧，那这是怎么回事？基本上，在为我们所有的数据库信息创建一个文件夹后，我们需要运行<code class="fe ni nj nk mk b">mongod</code>服务(我们刚刚安装的)并为您的<strong class="ld ir"> <em class="me">副本集</em> </strong>指定端口和路径。是的，一套复制品。这就是我第一次尝试这种方法时遇到这么多麻烦的原因。为了能够<em class="me">实时观察我们数据库中的</em>变化(在mongodb的<a class="ae kc" href="https://docs.mongodb.com/manual/changeStreams/" rel="noopener ugc nofollow" target="_blank">文档</a>中定义为<em class="me">变化流</em>)，您需要运行的不是我们db的一个实例，而是一个<strong class="ld ir"> <em class="me">集群</em> </strong>。这基本上就是你用上面的代码做的事情。</p><p id="4a43" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">第一行创建副本集，指定您最近创建的<code class="fe ni nj nk mk b">data</code>文件夹，以便集群在那里存储它的信息。您还告诉<code class="fe ni nj nk mk b">mongod</code>我们的集群将在哪个端口运行，以及其他一些选项，参数<code class="fe ni nj nk mk b">replSet</code>是我们集群的名称。</p><p id="b3fb" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">之后，您需要进入<code class="fe ni nj nk mk b">mongo</code> shell并初始化我们最近创建的集群，这是第二个命令所做的。</p><p id="4818" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated"><em class="me">几个注意事项:</em></p><ul class=""><li id="65d3" class="mu mv iq ld b le lz li ma lm mw lq mx lu my ly mz na nb nc bi translated">副本集只需要初始化一次，没有必要每次都运行那个命令。</li><li id="b071" class="mu mv iq ld b le nd li ne lm nf lq ng lu nh ly mz na nb nc bi translated">如果您将它作为脚本运行，可以考虑在mongod命令的末尾添加'&amp;'，以避免使用多个终端。</li></ul><p id="0f41" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">一旦你完成了所有这些，我们就准备好运行我们的<em class="me"> server.js </em>，所以:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="48f5" class="mo ke iq mk b gy mp mq l mr ms">cd ~/project<br/>npm init<br/>npm install mongodb --save<br/>node server.js</span></pre><p id="c039" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">(我假设您熟悉Node和npm)</p><p id="3e3f" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">现在，您可以在不同的终端中运行另一个脚本，在最近创建的数据库中插入一个新项目，并查看<code class="fe ni nj nk mk b">server.js</code>如何在集群中打印每个新插入的项目。在新的终端运行中:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="21e0" class="mo ke iq mk b gy mp mq l mr ms">mongo</span></pre><p id="7176" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">这将打开Mongo的控制台，现在我们可以与我们的数据库进行交互:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="aace" class="mo ke iq mk b gy mp mq l mr ms">use demo-db<br/>db.data.insert({sensor: 'Sensor A'})</span></pre><p id="f98a" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">就像这样，在我们的<em class="me"> server.js </em>终端中，我们应该看到DB insert作为控制台日志出现。</p><h1 id="b79a" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">结论</h1><p id="b8d1" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">物联网不仅改变了我们看待硬件的方式，也改变了我们设计软件的方式。要求通常包括能够实时处理数据，并将其存储用于机器学习和大数据分析。所有这些需求都会对我们的服务器应用程序产生影响，因此选择正确的工具至关重要。</p><p id="a703" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">在数据存储方面，MongoDB已经被证明是一个非常灵活的物联网应用工具。如果一切顺利，你应该能够将这个简单的例子集成到你的项目中。</p></div><div class="ab cl nl nm hu nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ij ik il im in"><figure class="mf mg mh mi gt jr gh gi paragraph-image"><a href="https://levelup.gitconnected.com"><div class="gh gi ns"><img src="../Images/ff5028ba5a0041d2d76d2a155f00f05e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JaoZbi7tTKJ5vL7i2OAYMQ.png"/></div></a></figure><div class="nt nu gp gr nv nw"><a href="https://gitconnected.com/learn/mongodb" rel="noopener  ugc nofollow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd ir gy z fp ob fr fs oc fu fw ip bi translated">学习MongoDB -最佳MongoDB教程(2019) | gitconnected</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">8大MongoDB教程-免费学习MongoDB。课程由开发人员提交并投票，使您能够…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">gitconnected.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok jw nw"/></div></div></a></div><div class="nt nu gp gr nv nw"><a href="https://gitconnected.com/learn/node-js" rel="noopener  ugc nofollow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd ir gy z fp ob fr fs oc fu fw ip bi translated">学习Node.js -最佳Node.js教程(2019) | gitconnected</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">前31个Node.js教程-免费学习Node.js。课程由开发人员提交和投票，使您能够…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">gitconnected.com</p></div></div><div class="of l"><div class="ol l oh oi oj of ok jw nw"/></div></div></a></div></div></div>    
</body>
</html>