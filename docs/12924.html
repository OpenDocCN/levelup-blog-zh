<html>
<head>
<title>Using PowerShell files in Azure DevOps Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Azure DevOps管道中使用PowerShell文件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-use-powershell-files-in-azure-devops-pipelines-88e0ec801d1d?source=collection_archive---------2-----------------------#2022-07-22">https://levelup.gitconnected.com/how-to-use-powershell-files-in-azure-devops-pipelines-88e0ec801d1d?source=collection_archive---------2-----------------------#2022-07-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="6b1c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在Azure DevOps YAML管道中使用Powershell脚本。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/aa23e3f5a8f4d7ef0d73e992353a1ab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GXRccwG1iuj4LKEAqjhN3A.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">何塞·勒布朗在<a class="ae le" href="https://unsplash.com/s/photos/jet-fuel?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="ff34" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">脚本充当您的DevOps管道的燃料，而PowerShell在自动化您的任务中扮演着重要角色。我最近参与了一个Azure DevOps项目，其中很多自动化都是使用PowerShell编写的。在您的YAML管道中有许多运行PowerShell任务的方法，我将尝试解释其中的大部分</p><blockquote class="lf lg lh"><p id="2935" class="jq jr li js b jt ju jv jw jx jy jz ka lj kc kd ke lk kg kh ki ll kk kl km kn im bi translated">PowerShell是微软的一个任务自动化和配置管理程序，由命令行Shell和相关的脚本语言组成</p></blockquote><h1 id="c638" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">内嵌脚本</h1><p id="5e8a" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">您可以在YAML文件中将PowerShell脚本作为内联脚本运行，可以是单行脚本，也可以是多行脚本</p><p id="0b88" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mp mq mr ms b">- Powershell: "PowerShell single line"</code></p><pre class="kp kq kr ks gt mt ms mu mv aw mw bi"><span id="a936" class="mx ln it ms b gy my mz l na nb">- Powershell: |<br/>      This is script line 1<br/>        This is script line 2</span></pre><p id="6536" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是运行内联PowerShell脚本的各种方法</p><h2 id="5829" class="mx ln it bd lo nc nd dn ls ne nf dp lw kb ng nh ma kf ni nj me kj nk nl mi nm bi translated"><strong class="ak">方法一:使用powershell.exe</strong></h2><p id="eea7" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated"><code class="fe mp mq mr ms b">powershell.exe</code>是传统的<em class="li"> Windows PowerShell </em>版本(v5.1-)的可执行名称，仅构建在Windows上。NET Framework (v4.8-)它不支持跨平台执行，只在windows代理上执行。</p><pre class="kp kq kr ks gt mt ms mu mv aw mw bi"><span id="80d9" class="mx ln it ms b gy my mz l na nb">stages:<br/>  - stage: Initialize<br/>    displayName: 'Initialize Stage'<br/>    pool: "windows-server-pool"<br/>    jobs:<br/>    - job: Install<br/>      displayName: 'Install Dependencies (PowerShell)'  <br/>      steps:<br/>      - script: |<br/>         @"%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe" -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "Install-PackageProvider NuGet -Scope CurrentUser -Force"<br/>        displayName: 'Powershell Install NuGet'<br/>      - script: |<br/>            @"%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe" -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "Install-Module -Name SqlServer -AllowClobber -Scope CurrentUser -Force"<br/>        displayName: 'Powershell Install SqlServer Module'</span></pre><h2 id="d2a1" class="mx ln it bd lo nc nd dn ls ne nf dp lw kb ng nh ma kf ni nj me kj nk nl mi nm bi translated"><strong class="ak">方法二:使用pwsh.exe</strong></h2><p id="11c2" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated"><code class="fe mp mq mr ms b">pwsh[.exe]</code>是<em class="li">PowerShell【Core】</em>(V6+)的<em class="li">可执行文件名称</em>，PowerShell的跨平台版本建立在其上。NET Core /。网络5+</p><pre class="kp kq kr ks gt mt ms mu mv aw mw bi"><span id="d270" class="mx ln it ms b gy my mz l na nb">- pwsh: './SmokeTest.ps1 -url $(WebAppDeploy.AppServiceApplicationUrl)'<br/>  displayName: 'Run Smoke Test'<br/>  workingDirectory: '$(Pipeline.Workspace)/DeployScripts'<br/>  failOnStderr: true</span></pre><p id="925c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mp mq mr ms b">pwsh</code>运行PowerShell Core，它必须安装在Linux特定的代理或容器上，要在您的Linux代理中安装<strong class="js iu"> pwsh </strong>，运行</p><pre class="kp kq kr ks gt mt ms mu mv aw mw bi"><span id="1e05" class="mx ln it ms b gy my mz l na nb">sudo apt-get install -y PowerShell<br/>pwsh --version</span></pre><p id="0687" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">方法三:<strong class="js iu"> — PowerShell任务</strong></p><pre class="kp kq kr ks gt mt ms mu mv aw mw bi"><span id="3427" class="mx ln it ms b gy my mz l na nb">- powershell: |<br/>     Install-Module -Name Az -AllowClobber -Scope CurrentUser -Force<br/>     displayName: 'Install Azure Powershell'</span></pre><h2 id="12fe" class="mx ln it bd lo nc nd dn ls ne nf dp lw kb ng nh ma kf ni nj me kj nk nl mi nm bi translated">方法4: PowerShell@2任务</h2><p id="16cf" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">这是“- powershell:”和“- pwsh”的快捷方式，根据所选的选项，管道代理将位于Windows或Linux上。</p><pre class="kp kq kr ks gt mt ms mu mv aw mw bi"><span id="998c" class="mx ln it ms b gy my mz l na nb">- task: PowerShell@2<br/>  displayName: 'Run Smoke Test'<br/>  inputs:<br/>    filePath: '$(Pipeline.Workspace)/DeployScripts/SmokeTest.ps1'<br/>    arguments: '-url $(WebAppDeploy.AppServiceApplicationUrl)'<br/>    failOnStderr: true<br/>    pwsh: true</span></pre><blockquote class="lf lg lh"><p id="9404" class="jq jr li js b jt ju jv jw jx jy jz ka lj kc kd ke lk kg kh ki ll kk kl km kn im bi translated">使用内联代码的优点是将所有功能都放在一个地方，更容易看到正在发生的一切。但是，如果您有一个大型管道，这种方法可能会变得复杂。</p></blockquote><h1 id="f8f0" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">剧本</h1><p id="7b4a" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">您也可以在YAML管道中运行. ps1脚本。将. ps1文件保存在$(System下的文件夹中。DefaultWorkingDirectory)并将<code class="fe mp mq mr ms b">targetType</code>设置为<code class="fe mp mq mr ms b">filePath</code>用于执行。然后通过<code class="fe mp mq mr ms b">filePath</code>属性指定脚本运行的路径。</p><pre class="kp kq kr ks gt mt ms mu mv aw mw bi"><span id="9cef" class="mx ln it ms b gy my mz l na nb">- task: PowerShell@2<br/>  retryCountOnTaskFailure: 2<br/>  inputs:<br/>    targetType: 'filePath'<br/>    filePath: $(System.DefaultWorkingDirectory)/Scripts/health.ps1<br/>    arguments: &gt; # Use this to avoid newline characters in a  multiline string<br/>      -uri "<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/${{">https://</a>myapp.azurewebsites.net/health"<br/>  displayName: 'Health check'</span></pre><blockquote class="lf lg lh"><p id="1020" class="jq jr li js b jt ju jv jw jx jy jz ka lj kc kd ke lk kg kh ki ll kk kl km kn im bi translated">默认情况下，Azure DevOps将签出源repo中的所有代码。签出代码会将脚本文件从repo下载到管道代理上，使它们可供执行。这里的例外是`<strong class="js iu"> -部署:</strong>`作业，您必须使用-<strong class="js iu">check out:self</strong>强制签出该作业</p></blockquote><h1 id="d348" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">结论</h1><p id="1007" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">PowerShell对于DevOps工程师来说非常方便，可以在Windows和Linux代理上运行。Azure DevOps支持PowerShell内联和管道中的脚本，可以根据代码的复杂性进行选择。快乐脚本:)</p></div></div>    
</body>
</html>