<html>
<head>
<title>Securing Your Secrets In Git, The Safe Way Using GCP KMS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保护你的秘密在Git，安全的方式使用GCP KMS</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/securing-your-secrets-in-git-the-safe-way-using-gcp-kms-ada49e8386af?source=collection_archive---------18-----------------------#2021-01-11">https://levelup.gitconnected.com/securing-your-secrets-in-git-the-safe-way-using-gcp-kms-ada49e8386af?source=collection_archive---------18-----------------------#2021-01-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="7c4f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将秘密和凭证提交到git中，而不会产生安全问题。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/efb25b0f2d3dfa2ee98794c0ff8e5de3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qCr1nTC6-kK6mnKr"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">托姆·米尔科维奇在<a class="ae le" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="7687" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">许多人都有这样的问题，他们希望将一些凭证文件或其他机密提交给git，因为项目内部需要这些文件。这些可能只是机密的环境变量、服务帐户凭证、私钥或数据库登录凭证。<strong class="js iu">这些文件都不应该以纯文本的形式提交到您的git存储库中！</strong>现在您可能会问<em class="lm">“如果我不能将它们提交给我的git，我如何确保每个开发人员都有正确的凭证，并且我的CI/CD管道在构建/测试/部署我的软件时能够提供正确的环境值？”</em>。说得好，但是有一个非常简单的解决方案:</p><p id="74e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不要以纯文本的形式提交你的秘密，而是使用加密版本。当你已经在使用GCP时，这相当容易，因为谷歌提供了云密钥管理服务(KMS)。使用他们的密钥管理服务，您可以轻松地加密和解密您想要安全存储在git中的所有文件。本文将向您展示如何实现这一点。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h2 id="98d3" class="ln lo it bd lp lq lr dn ls lt lu dp lv kb lw lx ly kf lz ma mb kj mc md me mf bi translated">在GCP上设置云密钥管理服务</h2><p id="e741" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">首先，我们需要一个启用计费的GCP项目。我希望你已经有一个了。</p><p id="62a8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们必须转到GCP控制台中的“云密钥管理服务(KMS) API ”,并为您的特定项目启用该API。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ml"><img src="../Images/6fb19099c75ba64872c3533399e44e6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BRksJT3E5LbkQRVtTwECpQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">为GCP项目启用“云密钥管理服务(KMS) API”</figcaption></figure><p id="da5c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">启用KMS API后，我们需要创建一个新的密匙环。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mm"><img src="../Images/a7034615a043981abbd2af1e8a8a5a07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VSdapcZR43WvwQsNgZXcjw.png"/></div></div></figure><p id="4063" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于新的密钥环，我们必须提供名称和位置。在大多数情况下，位置并不是非常重要，但是根据位置的不同，某些功能可能不可用。查看谷歌官方文档<a class="ae le" href="https://cloud.google.com/kms/docs/locations" rel="noopener ugc nofollow" target="_blank">云KMS位置</a>获得详细概述。在我的例子中，我简单地选择“global ”,因为它是预先选择的，我不需要任何特殊功能。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mn"><img src="../Images/1f69169a20272ffdd0cc1af205e11b48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*16KWXs5hwIbeCsx0GxYhlQ.png"/></div></div></figure><p id="ab36" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当密匙环创建完成后，我们可以在列表视图中看到我们的新密匙环。现在我们必须创建一个新的密钥来添加到密钥环中。为此，只需点击我们的新钥匙圈。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mo"><img src="../Images/dd0ed9c44f6b7dc291e96253f54c1c18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0kByqF_nfSEY3KzzxLAgzA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">我们新创建的钥匙圈列表视图</figcaption></figure><p id="d022" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在密钥环详细信息页面上，我们现在可以点击“+创建密钥”按钮来创建我们的新密钥。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mp"><img src="../Images/3fcfc5d9173d3c184557e98b92fa4f40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Keaoe1BRRGk6n6c2Tv4STg.png"/></div></div></figure><p id="fd60" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在“创建密钥”页面上，我们可以保留所有预定义的值。我们需要指定的唯一值是“键名”。此外，请务必记下项目ID、密匙环名称、位置以及您将在下一个屏幕截图中使用的密匙名称，因为我们稍后会在脚本中用到这四个值。</p><p id="76a8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在你填写密钥名称后点击“创建”按钮。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mq"><img src="../Images/5bfbb580bd30800617eba29bf1bd6fa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JsF_hplk7mrHc9C44M8Wjw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">创建新密钥</figcaption></figure><p id="f38f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建完成后，我们可以在钥匙圈上的钥匙列表视图中看到我们的新钥匙。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mr"><img src="../Images/2f787beb010564b346c5f3aef0231ea2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L82P5IR0SbW8iH0U_bChDw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">键的列表视图</figcaption></figure><p id="52f3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们已经在GCP上设置了密钥，是时候在我们的代码中设置实际的加密/解密过程/脚本了。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h2 id="e36e" class="ln lo it bd lp lq lr dn ls lt lu dp lv kb lw lx ly kf lz ma mb kj mc md me mf bi translated">通过“gcloud kms”解密/加密文件</h2><p id="7288" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">回到我们的代码库，我们不能设置下面的文件结构。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/e2cb53ace7734b3ea83ecf0f17fcd007.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*R5ETIzDFXjEFBfw0lJidwA.png"/></div></figure><p id="903c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">文件夹包含了我们所有的秘密。在我们的例子中，它是一个简单的JSON文件，包含一些数据库登录凭证。实际内容在这里并不重要。</p><p id="32aa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mt mu mv mw b">.gitignore</code>文件定义了除了以<code class="fe mt mu mv mw b">.enc</code>结尾的文件外，<code class="fe mt mu mv mw b">secrets</code>文件夹中的所有文件都应该被git忽略。我选择了<code class="fe mt mu mv mw b">.enc</code>后缀来声明<code class="fe mt mu mv mw b">encrypted</code>文件，因为我希望这些文件被提交给git。</p><pre class="kp kq kr ks gt mx mw my mz aw na bi"><span id="b09e" class="ln lo it mw b gy nb nc l nd ne">### .gitignore</span><span id="ad9e" class="ln lo it mw b gy nf nc l nd ne"># Ignore all files in secrets folder<br/>secrets/**</span><span id="6896" class="ln lo it mw b gy nf nc l nd ne"># Except the files that end with '.enc'<br/>!secrets/**.enc</span></pre><p id="d2a5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除此之外，我们有一个shell脚本来加密(<code class="fe mt mu mv mw b">encrypt.sh</code>)和一个来解密(<code class="fe mt mu mv mw b">decrypt.sh</code>)我们的秘密。当您创建了这两个文件时，不要忘记对这两个文件使用<code class="fe mt mu mv mw b">chmod +x xxx.sh</code>命令，使它们可以从CLI ( Mac/Linux)执行。</p><p id="dcd7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们继续之前，请确保您已经安装了<a class="ae le" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank"> GCloud SDK </a>并且是最新的。此外，在继续之前，请确保您已使用CLI命令<code class="fe mt mu mv mw b">gcloud auth login</code>登录。</p><p id="ee69" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在让我们先来看看我们的<code class="fe mt mu mv mw b">encrypt.sh</code>。</p><pre class="kp kq kr ks gt mx mw my mz aw na bi"><span id="c0fa" class="ln lo it mw b gy nb nc l nd ne">### encrypt.sh</span><span id="5cde" class="ln lo it mw b gy nf nc l nd ne"><em class="lm">gcloud </em>kms encrypt \<br/>    --project my-medium-demo-project-299218 \<br/>    --location global \<br/>    --keyring my-demo-keyring \<br/>    --key my-demo-key \<br/>    --ciphertext-file ./secrets/my_secret_stuff.json.enc \<br/>    --plaintext-file ./secrets/my_secret_stuff.json</span></pre><p id="48e2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如你所见，这非常简单。我们使用的是暴露了<code class="fe mt mu mv mw b">encrypt</code>功能的<code class="fe mt mu mv mw b">gcloud kms</code> CLI命令。CLI参数也很容易理解。还记得我告诉过你记下你的项目ID、钥匙圈、钥匙圈的位置和键名吗？这是您必须将这些值插入到shell脚本中的地方。</p><p id="81b7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">参数<code class="fe mt mu mv mw b">ciphertext-file</code>和<code class="fe mt mu mv mw b">plaintext-file</code>定义了你的加密和纯文本文件的位置，同时注意<code class="fe mt mu mv mw b">ciphertext-file</code>处的<code class="fe mt mu mv mw b">.enc</code>后缀。</p><p id="4792" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当我们现在通过CLI中的<code class="fe mt mu mv mw b">./encrypt.sh</code>运行脚本时，我们注意到在<code class="fe mt mu mv mw b">ciphertext-file</code>中定义的位置创建了一个新文件。当检查它时，我们可以看到一些神秘的文字。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ng"><img src="../Images/ed6042e0f5a79ab54caa368f99e8455c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j1GHIJTiEXaIaNAvSYXqiA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">运行“encrypt.sh”并注意新的加密文件。</figcaption></figure><p id="5e54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于我们的加密文件看起来不错，现在我们准备将它提交给我们的git存储库。</p><p id="3b58" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是当然，其他人必须再次解密才能使用。这里<code class="fe mt mu mv mw b">decrypt.sh</code>开始发挥作用。事实上，这非常简单。</p><pre class="kp kq kr ks gt mx mw my mz aw na bi"><span id="67a6" class="ln lo it mw b gy nb nc l nd ne"><em class="lm">### decrypt.sh</em></span><span id="d4ef" class="ln lo it mw b gy nf nc l nd ne"><em class="lm">gcloud </em>kms decrypt \<br/>    --project my-medium-demo-project-299218 \<br/>    --location global \<br/>    --keyring my-demo-keyring \<br/>    --key my-demo-key \<br/>    --ciphertext-file ./secrets/my_secret_stuff.json.enc \<br/>    --plaintext-file ./secrets/my_secret_stuff.json</span></pre><p id="0f23" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意到我们的加密和解密脚本之间的区别了吗？实际上只有一个词，那就是<code class="fe mt mu mv mw b">gcloud kms</code>命令。所有参数保持不变，您只需将命令从<code class="fe mt mu mv mw b">encrypt</code>切换到<code class="fe mt mu mv mw b">decrypt</code>。很简单，对吧？</p><p id="1e11" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了验证一切正常，我们现在应该删除我们的纯文本文件<code class="fe mt mu mv mw b">./secrets/my_secret_stuff.json</code>，确保在某个地方保留一个副本，并运行<code class="fe mt mu mv mw b">./decrypt.sh</code>脚本。我们现在应该看到我们的脚本解密了我们的加密文件，并重新创建了我们最近删除的纯文本文件。</p><p id="b006" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你开始有几个秘密文件，只需将它们添加到脚本中，就可以了。</p><p id="64c6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">真的没什么了。从现在开始，你可以随时加密你的机密信息，并把它放入你的git中，只要你的KMS密钥是安全的，就没有什么好害怕的。</p><h2 id="eda2" class="ln lo it bd lp lq lr dn ls lt lu dp lv kb lw lx ly kf lz ma mb kj mc md me mf bi translated">权限被拒绝错误疑难解答</h2><p id="537e" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">如果您在运行上述脚本时碰巧收到来自GCP的任何<code class="fe mt mu mv mw b">permission denied</code>错误，请确保您的帐户拥有<code class="fe mt mu mv mw b">Cloud KMS CryptoKey Encrypter/Decrypter</code>角色或包含此角色的上级角色，如<code class="fe mt mu mv mw b">Owner</code>或<code class="fe mt mu mv mw b">Editor</code>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nh"><img src="../Images/0d4932346fa43b2cd313404e5638ed08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2l7Uyub4IE79iGgqn8xcSQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">向用户添加“云KMS密钥加密器/解密器”角色</figcaption></figure><h2 id="922b" class="ln lo it bd lp lq lr dn ls lt lu dp lv kb lw lx ly kf lz ma mb kj mc md me mf bi translated">结论</h2><p id="79a7" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">尽管您必须在您的GCP环境中做一些初始设置工作，但使用云KMS通过您的CLI解密和加密您的文件并使它们防弹以提交到您的git存储库是非常容易的。</p><p id="c6e5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢您花时间阅读我的文章。</p><h2 id="e35d" class="ln lo it bd lp lq lr dn ls lt lu dp lv kb lw lx ly kf lz ma mb kj mc md me mf bi translated">你想联系吗？</h2><p id="6350" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">如果你想联系我，请在LinkedIn上给我打电话。</p><p id="c598" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另外，请随意查看我的书籍推荐📚。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><div class="kp kq kr ks gt ni"><a href="https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b" rel="noopener follow" target="_blank"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd iu gy z fp nn fr fs no fu fw is bi translated">我的书籍推荐</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">在接下来的章节中，你可以找到我对所有日常生活话题的书籍推荐，它们对我帮助很大。</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw ky ni"/></div></div></a></div><div class="nx ny gp gr nz ni"><a href="https://mr-pascal.medium.com/membership" rel="noopener follow" target="_blank"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd iu gy z fp nn fr fs no fu fw is bi translated">通过我的推荐链接加入Medium—Pascal Zwikirsch</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="nr l"><div class="oa l nt nu nv nr nw ky ni"/></div></div></a></div></div></div>    
</body>
</html>