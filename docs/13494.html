<html>
<head>
<title>Monitor multiple container instances with Heartbeat and local Elasticsearch and Kibana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Heartbeat和本地Elasticsearch和Kibana监控多个容器实例</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/monitor-multiple-container-instances-with-heartbeat-and-local-elasticsearch-and-kibana-3ea384bb703a?source=collection_archive---------15-----------------------#2022-09-08">https://levelup.gitconnected.com/monitor-multiple-container-instances-with-heartbeat-and-local-elasticsearch-and-kibana-3ea384bb703a?source=collection_archive---------15-----------------------#2022-09-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ff4e2bb196093622da704373cfbf674d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gtJeCka-IbI3z1HfoX8scg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@lukechesser?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">卢克·切瑟</a>在<a class="ae kc" href="https://unsplash.com/s/photos/monitoring?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="495f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">很高兴在这个弹性堆栈系列中再次见到您😊。今天我们继续我们的心跳冒险，介绍<strong class="kf ir">自动发现</strong>。</p><p id="f25f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上一篇文章中，我们看到了如何将Heartbeat与local Elasticsearch和Kibana结合使用，我们还谈到了监视器。点击<a class="ae kc" href="https://blog.devgenius.io/heartbeat-with-local-elasticsearch-and-kibana-69b99f7e23a6" rel="noopener ugc nofollow" target="_blank">此链接</a>并阅读文章，以了解最新讨论情况。<em class="lb">监视器</em>被定义为我们创建的那些小配置，用来告诉Heartbeat如何收集系统和服务可用性数据。</p><p id="e53f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们的<code class="fe lc ld le lf b">heartbeat.yml</code>配置文件中，我们要求Heartbeat每隔5s从URL参数中描述的端点收集正常运行时间数据。</p><p id="2cde" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通常，您会为想要收集可用性数据的每个应用程序或服务创建一个监视器，但如果您处理的是作为Docker容器部署的应用程序，这可能会很不方便，因为您可能不知道它们的端点以及有多少实例正在运行。</p><p id="11e8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">挑战在于从一个映像监控多个容器实例，以收集可用性数据。我们需要找到一种方法来配置Heartbeat，以自动发现这些容器实例，并将动态监视器与这些实例中的每一个相关联。这个问题是通过使用一个叫做<strong class="kf ir">自动发现</strong>的特性解决的。让我们看看它是如何工作的！</p><p id="09ef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们首先在文件夹的根目录下创建一个配置文件，并将其命名为<code class="fe lc ld le lf b">config.yml</code>。我们将通过使用提供者来配置Autodiscover，以匹配来自特定映像的任何容器实例。</p><p id="5ef4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">自动发现<strong class="kf ir">提供程序</strong>的操作方式是密切关注系统事件，并以通用格式将它们转换为内部自动发现事件。Heartbeat支持三种不同的提供者:<strong class="kf ir"> Docker </strong>，<strong class="kf ir"> Kubernetes </strong> <em class="lb">(用于监视Kubernetes节点)</em>和<strong class="kf ir"> Amazon ELBs </strong> <em class="lb">(这个是实验性的)</em>。这里只说Docker。查看本页了解更多关于其他人的信息。</p><p id="13d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于每个提供者，我们需要配置一个<em class="lb">模板</em>，即一个<em class="lb">条件</em>和一个<em class="lb">配置</em>的组合。<em class="lb">条件</em>将告诉Heartbeat如何匹配和检测容器实例。这里我们要求Heartbeat从调用的docker映像"<em class="lb">Abdel hk/hello-microservice "</em>中识别任何容器实例。</p><p id="9a72" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<em class="lb">配置</em>中，我们告诉Heartbeat如何实例化将与检测到的容器实例相关联的动态监视器。我们这里的监视器是<em class="lb"> http </em>类型，每5秒检查一次<em class="lb">，并将指向动态收集的主机<em class="lb">(主机+端口)</em>。我们还可以添加一个<em class="lb">名称</em>，以便在读取Kibana上的正常运行时间数据时容易识别容器。<em class="lb">输出</em>不需要额外的信息，它总是在安全禁用的情况下保持弹性搜索。生成的代码如下:</em></p><pre class="lg lh li lj gt lk lf ll lm aw ln bi"><span id="5794" class="lo lp iq lf b gy lq lr l ls lt">heartbeat.autodiscover:<br/>  providers:<br/>    - type: docker<br/>      host: 'npipe:////./pipe/docker_engine'<br/>      templates:<br/>        - condition:<br/>          contains:<br/>            docker.container.image: abdelhk/hello-microservice<br/>          config:<br/>            - type: http<br/>              name: "${data.docker.container.name}"<br/>              hosts: ["${data.host}:${data.port}/api/hello"]<br/>              schedule: "@every 5s"</span><span id="be4d" class="lo lp iq lf b gy lu lr l ls lt">output.elasticsearch:<br/>  hosts: localhost:9200</span></pre><p id="c5fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意:本教程是在Windows系统上创建的，这就是主机被修改的原因，因为默认情况下，Docker自动发现会尝试连接到<code class="fe lc ld le lf b">unix:///var/run/docker.sock</code></p><p id="e072" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们通过运行以下命令启动Heartbeat，该命令使用<code class="fe lc ld le lf b">-c</code>标志将配置文件指定为一个参数。</p><pre class="lg lh li lj gt lk lf ll lm aw ln bi"><span id="924d" class="lo lp iq lf b gy lq lr l ls lt">./heartbeat -c config.yml -e</span></pre><p id="264a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Heartbeat现在可以识别任何符合标准的容器实例了。</p><p id="c38d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的NodeJS应用程序的图像已经可供您使用，以使任务更容易。您只需要使用以下命令从docker hub中提取它:</p><pre class="lg lh li lj gt lk lf ll lm aw ln bi"><span id="4319" class="lo lp iq lf b gy lq lr l ls lt">docker pull abdelhk/hello-microservice</span></pre><p id="9eb5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您正在处理一个不同的框架或应用程序，您总是可以构建它的映像。现在让我们创建我们的容器。您可以运行以下命令来检查有多少容器正在运行:<code class="fe lc ld le lf b">docker ps</code>目前我们只有两个容器，<em class="lb"> Elasticsearch </em>和<em class="lb"> Kibana </em>。通过运行下面的命令，一个名为<em class="lb"> hello-container-1 </em>的容器将被链接到我们主机的端口<em class="lb"> 9090 </em>并被启动。</p><pre class="lg lh li lj gt lk lf ll lm aw ln bi"><span id="f6e6" class="lo lp iq lf b gy lq lr l ls lt">docker run --name hello-container-1 -p 9090:3001 -d abdelhk/hello-microservice</span></pre><p id="3e52" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<strong class="kf ir">不同端口</strong> ( <em class="lb">主机端口</em>)和<strong class="kf ir">名称</strong>重复该命令以创建其他容器。之后开基巴纳。渲染如下所示:</p><figure class="lg lh li lj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lv"><img src="../Images/bf1a3b99e1e1d16bbec80e5f5e480950.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ztLybfbx1nQVtXu1kIe2Cw.png"/></div></div></figure><p id="4bb3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">按照配置自动为每个实例创建一个监视器<em class="lb">(这里，我们创建了3个容器)</em>。您可能已经注意到我们的容器正在运行，但是Heartbeat告诉我们它们都关闭了。这可能是因为每个容器运行在不同的网络上，主机上运行的Heartbeat不能访问这些网络。这个问题很容易通过在运行容器的同一网络上运行Heartbeat来解决。</p><p id="01fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于每个监视器，Kibana为我们提供了关于监视器执行的更多信息和一些元数据，如<em class="lb">监视器持续时间</em>，<em class="lb">随时间执行的pings】，以及<em class="lb">检查历史</em>。</em></p><figure class="lg lh li lj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lw"><img src="../Images/83d19ea8cabcf05048bd131e827c1092.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a7HihPy8MDK6NZQXn3cs5w.png"/></div></div></figure><p id="825f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们今天就到这里。请查看关于这个主题的官方文档，以了解更多细节..感谢您的阅读，如果您对本文有任何问题或评论，请在下面留下您的评论。</p><p id="504b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们下次再见，看更多的帖子🚀。</p><p id="26ac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">阿卜杜尔-巴吉</p></div></div>    
</body>
</html>