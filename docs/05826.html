<html>
<head>
<title>Modern PHP (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">现代PHP(第2部分)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/modern-php-part-2-4973f48a90c0?source=collection_archive---------14-----------------------#2020-10-05">https://levelup.gitconnected.com/modern-php-part-2-4973f48a90c0?source=collection_archive---------14-----------------------#2020-10-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="376d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">部署到云</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/37d0c3b1e58b30cadf3ced864a8e3dde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R4VXwtloO62JmX1qQAHlMg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1235959" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/colossuscloud-2086276/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1235959" rel="noopener ugc nofollow" target="_blank">巨云</a></figcaption></figure><p id="ad1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本系列的第一部分的<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/modern-php-df3d3bf343f8">中，我创建了一个非常简单的PHP应用程序，作为一个自由程序员可能会被要求做的事情的例子。但是，如果客户还没有一个面向互联网的网站，而你的项目的一部分就是创建一个，那么这篇文章就是为你准备的。</a></p><p id="79a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设您的客户已经超越了他们的Wix或Squarespace站点，希望表单得到数据库的支持，或者访问其他API，并决定拥有一个全栈定制网站。我之前的文章展示了如何制作一个数据库支持的表单，如果你能制作一个表单，你就能制作一打。它还展示了如何使用一个相对便宜的裸<a class="ae ky" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a> (GCP)虚拟机将它部署到云上(假设你没有很多流量)。</p><p id="cb0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">唯一的问题是它没有“久经沙场”。当我在虚拟机上安装了PHP应用程序，并让全世界都可以访问它时，对日志的快速扫描显示，它正在被探测漏洞，可能是邪恶的玩家在寻找托管非法内容的地方。它也没有HTTPS，所以有一个登录页面是不明智的。我们需要一个反向代理来处理这些方面。在本文中，我们将使用<a class="ae ky" href="https://nginx.org/en/" rel="noopener ugc nofollow" target="_blank"> Nginx </a>。在以后的文章中，我们还将使用Nginx为您的所有应用程序实现单点登录。</p><p id="a040" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了完成这篇文章，你需要一个域名，一个<a class="ae ky" href="https://www.cloudflare.com/" rel="noopener ugc nofollow" target="_blank"> Cloudflare </a>账户和一个GCP账户。如果这是一个真正的自由职业项目，要么你的客户会提供给你，要么你可以建议他们如何设置。你或许可以使用任何允许裸机通过SSH和HTTPS访问的云服务，我这里只是用GCP作为例子。我不会详细介绍如何设置Cloudflare和GCP；他们有大量的在线帮助来帮助您进行设置，并且对于像我们这样的简单用例来说相对简单。如果您需要获得一个域名，请确保您获得一个允许您将Cloudflare设置为您的主要和辅助DNS并且能够随意处理DNS记录的域名。我使用Namecheap.com的<a class="ae ky" href="https://www.namecheap.com/" rel="noopener ugc nofollow" target="_blank">和</a>，并能够设置它没有问题。</p><p id="b203" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您需要做的第一件事是在GCP上配置一个虚拟机，该虚拟机配有一个现代的Linux操作系统和大约10gb的硬盘空间。我用的是Ubuntu 20.04。对于我们正在做的事情，您可以提供他们提供的最小的CPU。确保您给予它外部HTTPS和SSH访问(GCP自动添加SSH访问)。一旦VM启动并运行，连接到它并安装Docker(和Docker Compose)和Git。这是您只需要安装的两个东西，所以如果您需要的话，重新配置应该很容易。</p><p id="b445" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您需要找出新虚拟机的外部IP地址，以便将其添加到Cloudflare。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/646de8b8cf8c3ae7293eefd604ddbf15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WHM4eudHKrx2tus7eDgvEw.png"/></div></div></figure><p id="1045" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上图中，第二个IP地址是外部地址。现在，您可以在DNS选项卡上转到您的Cloudflare帐户，并使用您选择的新主机名添加“A”记录。这将被添加到完整主机的域名前面。请注意，此IP地址是“短暂的”，可能会在虚拟机重启之间发生变化。你可以把它设置成静态的，只需要多花一点钱。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/bcdfdeac202ecb70f07d984a8f461105.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2KP4oiQ_hgmk7j8n2K1xaw.png"/></div></div></figure><p id="1b0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，转到Cloudflare上的SSL/TLS选项卡，选择完全(严格)模式，这样您的所有流量都将需要https，并且您的源服务器将需要Cloudflare证书。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/13b430ccb9ca973df69aa16353f4e097.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aelCsJC9Q8Vkr151Z7aaFA.png"/></div></div></figure><p id="b8dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在“原始服务器”子选项卡中，您可以创建一个证书以在虚拟机上使用。单击Create Certificate按钮，采用问题的默认值，它会给出两个长文本块，即证书和密钥。保持此页面打开，并转到虚拟机的SSH屏幕。您应该还在您的主目录中，我将把它们复制到那里。使用VI(因为它是新虚拟机上唯一可用的编辑器，打开<code class="fe lx ly lz ma b">yourdomain.com.pem</code>(替换您的实际域名)，插入第一个块中的所有文本，并保存它。接下来，打开<code class="fe lx ly lz ma b">yourdomain.com.key</code>，对第二个块做同样的操作。现在，您的证书/密钥对在虚拟机上可用了。您还应该将这两个文件的副本存储在某个安全的地方。别不小心放到GitHub上就好！</p><p id="40b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将通过Git和Docker安装我们的应用程序。我在GitHub上创建了一个名为<code class="fe lx ly lz ma b">phpappprod</code>的存储库，其中包含Nginx配置和docker-compose.yml，说明应该运行哪些应用程序。当我们在这个库中创建文件时，我们将假设所有的秘密文件都直接存储在父库中，所以它们不会意外地存储在GitHub上。将新的存储库克隆到您的本地机器上。</p><p id="997c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们只关注Nginx。下面是启动Nginx的基本<code class="fe lx ly lz ma b">docker-compose.yml</code>:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="acf0" class="mf mg it ma b gy mh mi l mj mk">version: '3.1'<br/>services:<br/>  nginx:<br/>    image: nginx<br/>    restart: always<br/>    volumes:<br/>     - ./nginx.conf:/etc/nginx/nginx.conf<br/>     - ..:/etc/certs<br/>    ports:<br/>     - "443:443"</span></pre><p id="a4b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，我们将<code class="fe lx ly lz ma b">/etc/certs</code>映射到<code class="fe lx ly lz ma b">..</code>，这样它将在父目录中查找证书。<code class="fe lx ly lz ma b">nginx.conf</code>将不包含任何秘密，所以我们将把它添加到<code class="fe lx ly lz ma b">phpappprod</code> GitHub库中，并直接从那里映射它。以下是目前<code class="fe lx ly lz ma b">nginx.conf</code>中的内容。</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="47e7" class="mf mg it ma b gy mh mi l mj mk">events {}<br/>http {<br/>  server {<br/>    listen 443 ssl;<br/>    server_name yourdomain.com;<br/>    ssl_certificate /etc/certs/yourdomain.com.pem;<br/>    ssl_certificate_key /etc/certs/yourdomain.com.key;<br/>    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;<br/>    ssl_ciphers HIGH:!aNULL:!MD5;<br/>    location ~ ^/(html|images|javascript|js|css|flash|media|static)/ {<br/>      index index.html;<br/>      root /etc/nginx/html;<br/>      expires 3s;<br/>      include /etc/nginx/mime.types;<br/>    }<br/>  }<br/>}</span></pre><p id="2f47" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">显然，用您自己的域“yourdomain.com”替换server_name、ssl_certificate和ssl_certificate_key。</p><p id="a092" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在将它们推送到GitHub之前，您可以在本地进行测试。</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="7f71" class="mf mg it ma b gy mh mi l mj mk">docker-compose up -d<br/>curl -k https://localhost/</span></pre><p id="b089" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该得到Nginx 404页面，因为您的应用程序没有绑定Nginx(并且您的应用程序没有运行)。您必须使用-k选项，因为您创建的证书仅在Cloudflare上有效。当您访问互联网上的新域时，Cloudflare将拥有自己的证书。</p><p id="0b8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">提交并将所有内容推回GitHub。现在回到VM的SSH终端，您可以克隆<code class="fe lx ly lz ma b">phpappprod</code>存储库。我们将使用该存储库将所有非机密文件“传输”到您的虚拟机。使用HTTPS模式而不是SSH模式进行克隆，因为您不会从虚拟机提交更改，也不想设置SSH密钥。然后将目录切换到存储库并启动您的服务器</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="2358" class="mf mg it ma b gy mh mi l mj mk">cd phpappprod<br/>docker-compose up -d</span></pre><p id="1027" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以在互联网上找到带有真实SSH证书的服务器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ml"><img src="../Images/0d96068aab0eb19ac72955e72f581d5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kgAyAq51rjC2267ktriQDg.png"/></div></div></figure><p id="5372" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这可能看起来不太令人印象深刻，但这是让您的应用程序在恶劣的互联网上安全运行的一大步。</p><h2 id="7dc1" class="mf mg it bd mm mn mo dn mp mq mr dp ms li mt mu mv lm mw mx my lq mz na nb nc bi translated">在您的应用程序中添加</h2><p id="702f" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">在本系列的前一篇文章中，我们有一个只有几页的简单网站。有一页展示了葡萄酒/奶酪的搭配，还有一页允许你添加更多。不是很多，但这是个好的开始。一旦你有了几个页面和一个总的主题，你就为拥有一个像样的网络应用做好了准备。您已经验证了您可以读写数据库并在web上显示它。</p><p id="2730" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有几个问题我们没有解决，开发模式应用程序有一个示例密码嵌入到系统中。它还需要一个开发环境来建立数据库。最后，数据库存储在数据库容器中，所以一旦容器消失，数据也会消失。当我们将应用程序发布到互联网上时，我们可以解决所有这些问题。</p><p id="17d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个小提示，您可能不希望您的数据库在容器中运行。那是一个合理的选择。在虚拟机上安装和设置数据库，或者甚至在单独的虚拟机上安装和设置数据库，这取决于您。GCP有一个点击MySQL安装程序，它将在虚拟机上运行一个完全配置好的数据库。但是我是一个控制狂，本文的其余部分将假设您将在容器中运行数据库。如果您不希望这样，那么您必须弄清楚如何调整应用程序，以便从您选择的外部数据源读取数据库。</p><p id="5162" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个问题是数据库的root密码；在开发版中，它就在。env文件，它被签入GitHub。这确实不是一个好主意，但是因为它只是一个开发密码，所以它使得在新的笔记本电脑上运行开发环境变得非常容易。它只影响开发环境中的数据库。GitHub好心地给我发了一个警告，说我把一个密码签入了存储库。</p><p id="1511" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们采用与证书/密钥对相同的策略，将新的秘密放入我克隆GitHub库的父目录中。这样很容易定位，但是在库之外，所以没有机会被推送到GitHub。也许你会认为我们应该把秘密保存在一个隐藏的目录中，只有根用户才有读写权限。但是，如果有人入侵了你的虚拟机，再多的保护措施也无法保密。所以最好是在方便的地方。我将调用我的文件<code class="fe lx ly lz ma b">../phpapp.env</code>(相对于存储库目录)，它现在只有一行:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="8441" class="mf mg it ma b gy mh mi l mj mk">MYSQL_ROOT_PASSWORD=&lt;your super secret password here&gt;</span></pre><p id="9ba1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们将MariaDB应用程序添加到<code class="fe lx ly lz ma b">docker-compose.yml</code>中。</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="eb1c" class="mf mg it ma b gy mh mi l mj mk">version: '3.1'<br/>services:<br/>  nginx:<br/>    image: nginx<br/>    restart: always<br/>    volumes:<br/>     - ./nginx.conf:/etc/nginx/nginx.conf<br/>     - ..:/etc/certs<br/>    ports:<br/>     - "443:443"<br/>  mariadb:<br/>    image: mariadb<br/>    restart: always<br/>    env_file:<br/>      - ../phpapp.env<br/>    ports:<br/>      - 3306:3306</span></pre><p id="d66f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我取出了生产版本中的管理应用程序。我不想把它暴露给外界，所以我将限制自己只能通过命令行访问它。</p><p id="e7fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以启动它并确认它正在运行</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="e95d" class="mf mg it ma b gy mh mi l mj mk">docker-compose up -d<br/>docker exec -it phpappprod_mariadb_1 bash<br/>mariadb -u root -p</span></pre><p id="d296" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它会提示您输入密码；您可以输入您放在<code class="fe lx ly lz ma b">../phpapp.env</code>文件中的密码，您应该会看到:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="6edf" class="mf mg it ma b gy mh mi l mj mk">Welcome to the MariaDB monitor.  Commands end with ; or \g.<br/>Your MariaDB connection id is 5<br/>Server version: 10.5.5-MariaDB-1:10.5.5+maria~focal mariadb.org binary distribution</span><span id="cdf0" class="mf mg it ma b gy ni mi l mj mk">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><span id="511f" class="mf mg it ma b gy ni mi l mj mk">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><span id="69e7" class="mf mg it ma b gy ni mi l mj mk">MariaDB [(none)]&gt;</span></pre><p id="4af5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以我们知道MariaDB已经启动并正在运行，并且root密码安全地存储在<code class="fe lx ly lz ma b">../phpapp.env</code>中</p><p id="b4f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一个问题，存储的任何数据都将存储在容器中。我们需要建立一个卷来存储外部数据。首先，停止MariaDB监视器，然后停止docker-compose:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="0941" class="mf mg it ma b gy mh mi l mj mk">docker-compose down</span></pre><p id="50ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们不希望数据库数据存储在GitHub中，但我希望保持简单，只将数据目录直接放在存储库区域内。所以我们必须在<code class="fe lx ly lz ma b">.gitignore</code>文件中添加一行:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="258c" class="mf mg it ma b gy mh mi l mj mk">data</span></pre><p id="af2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将创建数据目录，并授予它完全权限，以便我们可以从docker内部将其作为一个挂载卷进行访问:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="6bcf" class="mf mg it ma b gy mh mi l mj mk">mkdir data<br/>chmod 777 data</span></pre><p id="a3a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以将它挂载到docker-compose.yml文件中:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="e8e1" class="mf mg it ma b gy mh mi l mj mk">...<br/>mariadb:<br/>    image: mariadb<br/>    restart: always<br/>    volumes:<br/>     - ./data:/var/lib/mysql<br/>    env_file:<br/>      - ../phpapp.env<br/>    ports:<br/>      - 3306:3306</span></pre><p id="011e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您也可以让Docker创建一个卷并进行分配，但这种方式似乎更容易。如果您正在创建一系列共享一个数据库的web应用程序，这将是一个不错的选择。但我们会保持简单。我们可以通过再次启动和停止服务来确认MariaDB正在使用它:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="6ae4" class="mf mg it ma b gy mh mi l mj mk">docker-compose up -d<br/>docker-compose down<br/>ls data</span></pre><p id="50bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lx ly lz ma b">data</code>目录应该被文件填满。如果我们在本地测试这些生产脚本时需要重置数据库，我们可以删除数据目录的内容。</p><p id="ee22" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一个问题，为我们的应用程序创建数据库和表，有点棘手。在本系列的第一部分中，我们使用了几个PHP/Symfony命令，但是我们不想在我们的生产虚拟机上直接安装PHP或Symfony。请记住，目标之一是轻松(重新)供应，所以我们必须安装的越少越好。幸运的是，有一个命令可以转储必要的SQL，我们可以将它挂载到MariaDB在未初始化时查看的位置。或者，由于所有的PHP/Symfony命令都在映像中可用，您可以运行映像并覆盖Docker <code class="fe lx ly lz ma b">CMD</code>行，但是我认为从MariaDB映像中运行SQL对于习惯于从脚本中运行DDL的人来说更熟悉一些。</p><p id="851f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还需要覆盖应用程序的数据库URL。所以在你的<code class="fe lx ly lz ma b">../phpapp.env</code>文件中添加一行</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="f1e5" class="mf mg it ma b gy mh mi l mj mk">DATABASE_URL=mysql://root:&lt;pw&gt;@mariadb:3306/winelist?\   serverVersion=mariadb-10.4.11<br/>MYSQL_ROOT_PASSWORD=&lt;pw&gt;</span></pre><p id="31e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用您的新密码替换这两个<pw>。</pw></p><p id="8af4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">回到<code class="fe lx ly lz ma b">phpapp</code>存储库，假设它仍然下载了所有的依赖项，我们可以运行下面的命令让SQL创建这个表:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="f393" class="mf mg it ma b gy mh mi l mj mk">php bin/console doctrine:schema:create --dump-sql</span></pre><p id="49f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">复制它生成的SQL并返回到<code class="fe lx ly lz ma b">phpappprod</code>存储库，创建一个名为<code class="fe lx ly lz ma b">init</code>的目录，在其中创建一个名为<code class="fe lx ly lz ma b">init.sql</code>的文件并粘贴SQL。如果数据库不存在的话，我们必须对它进行一些修改，以便创建和使用数据库。我们得到的结果应该是这样的:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="2381" class="mf mg it ma b gy mh mi l mj mk">CREATE DATABASE IF NOT EXISTS winelist;<br/>USE winelist;<br/>CREATE TABLE IF NOT EXISTS wine_pairing <br/>  (id INT AUTO_INCREMENT NOT NULL, <br/>   wine VARCHAR(255) NOT NULL, <br/>   wine_description VARCHAR(255) NOT NULL, <br/>   cheese VARCHAR(255) NOT NULL, <br/>   cheese_description VARCHAR(255) NOT NULL, <br/>   pairing_notes VARCHAR(255) NOT NULL, <br/>   PRIMARY KEY(id)) <br/>   DEFAULT CHARACTER SET utf8mb4 <br/>   COLLATE `utf8mb4_unicode_ci`  <br/>   ENGINE = InnoDB;</span></pre><p id="20de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在将映射添加到<code class="fe lx ly lz ma b">docker-compose.yml</code>中。</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="9c13" class="mf mg it ma b gy mh mi l mj mk">...<br/>mariadb:<br/>    image: mariadb<br/>    restart: always<br/>    volumes:<br/>     - ./data:/var/lib/mysql<br/>     - ./init:/docker-entrypoint-initdb.d<br/>    env_file:<br/>      - ../phpapp.env<br/>    ports:<br/>      - 3306:3306</span></pre><p id="9e3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了确保它被初始化，删除数据目录的内容，然后重新启动。您可以再次运行MariaDB命令行，以确保所有内容都已初始化:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="9fcd" class="mf mg it ma b gy mh mi l mj mk">rm -rf data/*<br/>docker-compose up -d<br/>docker exec -it phpappprod_mariadb_1 bash<br/>mariadb -u root -p</span></pre><p id="144a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行describe命令来查看新的<code class="fe lx ly lz ma b">wine_list</code>表。</p><h2 id="8c4e" class="mf mg it bd mm mn mo dn mp mq mr dp ms li mt mu mv lm mw mx my lq mz na nb nc bi translated">添加反向代理</h2><p id="363a" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">我们现在已经运行了Nginx和MariaDB剩下的就是添加应用程序并设置Nginx反向代理它。这意味着<code class="fe lx ly lz ma b">docker-compose.yml</code>的另一个变化。</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="9f96" class="mf mg it ma b gy mh mi l mj mk">...<br/>  phpapp:<br/>    image: rlkamradt/phpapp<br/>    env_file:<br/>      - ../phpapp.env<br/>    ports:<br/>      - 8000:8000</span></pre><p id="8354" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将启动应用程序。将Nginx设置为反向代理相当简单；<code class="fe lx ly lz ma b">nginx.conf</code>应改为:</p><pre class="kj kk kl km gt mb ma mc md aw me bi"><span id="706d" class="mf mg it ma b gy mh mi l mj mk">events {}<br/>http {<br/>  server {<br/>    listen 443 ssl;<br/>    server_name kamradtfamily.net;<br/>    ssl_certificate /etc/certs/kamradtfamily.net.pem;<br/>    ssl_certificate_key /etc/certs/kamradtfamily.net.key;<br/>    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;<br/>    ssl_ciphers HIGH:!aNULL:!MD5;<br/>    location / {<br/>        proxy_pass <a class="ae ky" href="http://phpapp:8000" rel="noopener ugc nofollow" target="_blank">http://phpapp:8000</a>;<br/>    }<br/>  }<br/>}</span></pre><p id="c4f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将接受所有请求，并将它们传递给应用程序。请注意，我们不需要在应用程序本身上启用HTTPS，因为Nginx和应用程序之间的通信完全在一个虚拟机上进行，所以在它们之间使用不安全的通信是安全有效的。</p><p id="1ec4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将这些都上传到服务器只需要很少的努力。首先，确保您已经提交并推送了<code class="fe lx ly lz ma b">phpappprod</code>存储库中的所有变更。然后将您的<code class="fe lx ly lz ma b">../phpapp.env</code>复制到您的主目录中的虚拟机上，该目录应该是虚拟机上存储库的父目录。最简单的方法就是登录你的虚拟机，运行<code class="fe lx ly lz ma b">vi phpapp.env</code>，剪切并粘贴你的本地拷贝，就像我们在虚拟机上获取证书一样。最后，在VM上，切换到<code class="fe lx ly lz ma b">phpappprod</code>目录，并执行<code class="fe lx ly lz ma b">git pull</code>来获取我们在本地所做的所有更改。现在您可以运行<code class="fe lx ly lz ma b">docker-compose up -d</code>了，您的应用程序应该准备好发布到真正的互联网上了！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/ff1b648220576408be90829cdbc2b6bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sQ7BNVBgkykvczaQt9wcSQ.png"/></div></div></figure><p id="4c6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在清单上加了几项，你可以看看。它看起来仍然很丑，但一点点的造型会解决这个问题。</p><p id="7f7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但首先，我要关闭服务器。我敢肯定，如果我把它留在那里，当我回来的时候，一些爱开玩笑的人会把它装满滑稽的东西，或者更糟。永远不要把一个半成品的应用程序留在互联网上！</p><p id="482b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还能做什么？除了让它看起来漂亮，我们需要添加一个登录，以便只有授权的人可以添加配对。一旦我们有了登录，我会觉得让它在互联网上运行是相当安全的。一旦它被美化了，我会很高兴把它作为一个投资组合项目。我以前使用过<a class="ae ky" href="https://www.okta.com/" rel="noopener ugc nofollow" target="_blank"> Okta </a>进行授权，所以在我的下一篇文章中，我将展示如何使用它们让您的应用程序登录。</p><p id="4065" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是本文中使用的存储库:</p><div class="nk nl gp gr nm nn"><a href="https://github.com/rkamradt/phpapp/tree/v0.2" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd iu gy z fp ns fr fs nt fu fw is bi translated">rkamradt/phpapp</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">github.com</p></div></div><div class="nw l"><div class="nx l ny nz oa nw ob ks nn"/></div></div></a></div><div class="nk nl gp gr nm nn"><a href="https://github.com/rkamradt/phpappprod/tree/v0.1" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd iu gy z fp ns fr fs nt fu fw is bi translated">rkamradt/PHP pprod</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">github.com</p></div></div><div class="nw l"><div class="oc l ny nz oa nw ob ks nn"/></div></div></a></div><p id="69ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">提到的其他文章:</p><div class="nk nl gp gr nm nn"><a rel="noopener  ugc nofollow" target="_blank" href="/modern-php-df3d3bf343f8"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd iu gy z fp ns fr fs nt fu fw is bi translated">现代PHP</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">使用Upstart上最需要的项目语言之一开始你的自由职业生涯。</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="nw l"><div class="od l ny nz oa nw ob ks nn"/></div></div></a></div></div></div>    
</body>
</html>