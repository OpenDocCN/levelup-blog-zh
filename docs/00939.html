<html>
<head>
<title>Building Kubernetes Apps with Scaling on Custom Metrics: A Gentle Introduction</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建基于自定义指标的Kubernetes应用程序:一个温和的介绍</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/building-kubernetes-apps-with-custom-scaling-a-gentle-introduction-a332d7ebc795?source=collection_archive---------2-----------------------#2019-09-24">https://levelup.gitconnected.com/building-kubernetes-apps-with-custom-scaling-a-gentle-introduction-a332d7ebc795?source=collection_archive---------2-----------------------#2019-09-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/13b0e313421af23180c91c0435da1dfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*reayvDuLbWidNYMyC46ujA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">部署的系统</figcaption></figure><p id="a06c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">2020–10–25:为Kubernetes 1.19 &amp;头盔3 </strong>更新</p><p id="51b6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">GitHub Repo:</strong><a class="ae la" href="https://github.com/flipstone42/k8s-prometheus-custom-scaling" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/flip stone 42/k8s-Prometheus-custom-scaling</a></p><h2 id="86cd" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated"><strong class="ak">您将了解到的内容:</strong></h2><ul class=""><li id="3810" class="lu lv iq ke b kf lw kj lx kn ly kr lz kv ma kz mb mc md me bi translated">部署联合监控管道</li><li id="656e" class="lu lv iq ke b kf mf kj mg kn mh kr mi kv mj kz mb mc md me bi translated">使用<a class="ae la" href="https://github.com/DirectXMan12/k8s-prometheus-adapter/" rel="noopener ugc nofollow" target="_blank"> Prometheus适配器</a></li></ul><p id="eaaf" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">如果您对本教程有任何问题，请在相关的GitHub项目上留下问题。</strong></p><p id="a87a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">本教程中的项目旨在为安装项目的技术人员和您希望向其展示最终部署的任何外行人提供一个温和的介绍。它包括一个Grafana仪表板，实时显示您的部署规模。</p><p id="c304" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你不熟悉Kubernetes或普罗米修斯，这可能不是那么有用。我将尝试提供关于某些方面的更多细节的文档链接，但是您至少应该对系统有一个工作上的理解。</p><p id="d8cb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我使用<a class="ae la" href="https://kind.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">种类</a>来开发它，但是它应该可以与任何启用了<a class="ae la" href="https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/" rel="noopener ugc nofollow" target="_blank"> API聚合</a>的1.19+集群一起工作。</p><h2 id="4ffc" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated"><strong class="ak">先决条件:</strong></h2><ul class=""><li id="acd1" class="lu lv iq ke b kf lw kj lx kn ly kr lz kv ma kz mb mc md me bi translated">访问k8s集群(<code class="fe mk ml mm mn b">k8s version 1.19 </code>推荐)</li><li id="3e75" class="lu lv iq ke b kf mf kj mg kn mh kr mi kv mj kz mb mc md me bi translated"><a class="ae la" href="https://minikube.sigs.k8s.io/docs/" rel="noopener ugc nofollow" target="_blank"> Minikube </a> / <a class="ae la" href="https://kind.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">种类</a> <strong class="ke ir">推荐</strong></li><li id="bc3e" class="lu lv iq ke b kf mf kj mg kn mh kr mi kv mj kz mb mc md me bi translated">本地安装<a class="ae la" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">舵</a>舵&amp;舵<a class="ae la" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">舵</a></li></ul></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h2 id="b6d5" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated"><strong class="ak">第一步:克隆项目</strong></h2><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="2552" class="lb lc iq mn b gy nd ne l nf ng">git clone <a class="ae la" href="https://github.com/flipstone42/k8s-prometheus-custom-scaling.git" rel="noopener ugc nofollow" target="_blank">https://github.com/flipstone42/k8s-prometheus-custom-scaling.git</a></span><span id="c8d9" class="lb lc iq mn b gy nh ne l nf ng">cd k8s-prometheus-custom-scaling</span></pre><p id="cf60" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们先来看看我们要扩展的应用程序。它是使用<a class="ae la" href="http://flask.palletsprojects.com" rel="noopener ugc nofollow" target="_blank">烧瓶</a>和<a class="ae la" href="http://reactjs.org" rel="noopener ugc nofollow" target="_blank">反应</a>前端在Python中构建的。我们还利用了“<a class="ae la" href="https://github.com/rycus86/prometheus_flask_exporter" rel="noopener ugc nofollow" target="_blank">Flask Prometheus Exporter</a>”，一个优秀的社区图书馆。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae la" href="https://github.com/flipstone42/k8s-prometheus-custom-scaling/tree/master/demo_app/server.py" rel="noopener ugc nofollow" target="_blank">看完整文件这里</a></figcaption></figure><p id="2eb5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们在本地发布应用程序。如果你不熟悉<code class="fe mk ml mm mn b">docker-compose</code>，先看看这里的<a class="ae la" href="https://docs.docker.com/compose/" rel="noopener ugc nofollow" target="_blank"/>。</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="b169" class="lb lc iq mn b gy nd ne l nf ng">docker-compose up -d #add the --build flag to build locally</span></pre><p id="6f90" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果我们在浏览器中导航到<code class="fe mk ml mm mn b">localhost:8000</code>,就会看到我们的网页:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/f4a7633aefb5298cc1afae4449f9e5f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xUt7qW8oYE2raZBItjSEzA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">这是部署的应用程序的外观。</figcaption></figure><p id="56f3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这是一个非常简单的web应用程序。<em class="nl">打我！”</em>向网站的<code class="fe mk ml mm mn b">/click-button</code>端点发出POST请求。服务器中该端点上的Prometheus装饰器确保这被应用程序记录下来。</p><p id="a13e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每次POST请求到来时，应用程序增加一个<a class="ae la" href="https://prometheus.io/docs/concepts/metric_types/#counter" rel="noopener ugc nofollow" target="_blank"> Prometheus计数器</a>。这然后反映在app的<code class="fe mk ml mm mn b">/metrics</code> <em class="nl"> </em>端点，我们最终会配置一个正在运行的Prometheus实例来定期抓取。</p><p id="45ee" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果我们跑:</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="f4b8" class="lb lc iq mn b gy nd ne l nf ng">curl -s localhost:8000/metrics | grep demo_app_button_clicks</span></pre><p id="5a7d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们得到以下输出:</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="3a5b" class="lb lc iq mn b gy nd ne l nf ng"># HELP demo_app_button_clicks_total Multiprocess metric<br/># TYPE demo_app_button_clicks_total counter<br/>demo_app_button_clicks_total 0.0</span></pre><p id="1281" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这是普罗米修斯<a class="ae la" href="https://prometheus.io/docs/concepts/metric_types/#counter" rel="noopener ugc nofollow" target="_blank">计数器。让我们按一下按钮，看看再次运行该命令时会发生什么:</a></p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="c01e" class="lb lc iq mn b gy nd ne l nf ng"># HELP demo_app_button_clicks_total Multiprocess metric<br/># TYPE demo_app_button_clicks_total counter<br/>demo_app_button_clicks_total 1.0</span></pre><p id="8c6a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">假设你得到了和我一样的输出，一切都按计划进行！</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><p id="7842" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">第二步:创建一个集群</strong></p><p id="b2c4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">本指南是用k8s 1.19编写的，经过实物测试。对于本教程，我建议使用kind或minkube:</p><ul class=""><li id="a2d8" class="lu lv iq ke b kf kg kj kk kn nm kr nn kv no kz mb mc md me bi translated"><a class="ae la" href="https://kind.sigs.k8s.io/docs/user/quick-start/" rel="noopener ugc nofollow" target="_blank">实物入门</a></li><li id="743c" class="lu lv iq ke b kf mf kj mg kn mh kr mi kv mj kz mb mc md me bi translated"><a class="ae la" href="https://minikube.sigs.k8s.io/docs/start/" rel="noopener ugc nofollow" target="_blank">Minikube入门</a></li></ul><p id="7ee8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建集群后，继续下一步。</p><h2 id="eb9d" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated"><strong class="ak">第二步:安装Kube-Prometheus-Stack </strong></h2><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="5ec2" class="lb lc iq mn b gy nd ne l nf ng">helm repo add prometheus-community <a class="ae la" href="https://prometheus-community.github.io/helm-charts" rel="noopener ugc nofollow" target="_blank">https://prometheus-community.github.io/helm-charts</a></span><span id="4643" class="lb lc iq mn b gy nh ne l nf ng">helm repo update</span><span id="e905" class="lb lc iq mn b gy nh ne l nf ng">helm install prometheus-operator prometheus-community/kube-prometheus-stack -f helm-values/prometheus-operator-values.yml</span></pre><p id="97d1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们引进并安装<a class="ae la" href="https://github.com/prometheus-operator/prometheus-operator" rel="noopener ugc nofollow" target="_blank">普罗米修斯操作器</a>(通过kube-prometheus-stack图表)。这个k8s操作员将帮助我们抽象出普罗米修斯的部署。</p><blockquote class="np nq nr"><p id="2e72" class="kc kd nl ke b kf kg kh ki kj kk kl km ns ko kp kq nt ks kt ku nu kw kx ky kz ij bi translated"><em class="iq">注意:默认配置不使用选择器来发现ServiceMonitors，所以它会选择任何部署到当前名称空间的监视器。这不应该是一个问题，但是如果这是一个共享集群，就应该记住这一点。</em></p></blockquote></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h2 id="2b3c" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated"><strong class="ak">步骤3:将应用程序部署到集群并开始监控它</strong></h2><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="c76c" class="lb lc iq mn b gy nd ne l nf ng">kubectl apply -f manifests/deployment.yml -f manifests/service.yml -f manifests/ingress.yml</span></pre><p id="cb43" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这应该会将<a class="ae la" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="noopener ugc nofollow" target="_blank">部署</a>和附带的<a class="ae la" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>添加到我们的集群中。</p><p id="33db" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我还包括一个ingress资源:如果你不熟悉ingress，请阅读<a class="ae la" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank"> Kubernetes文档</a>。</p><p id="e58d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们在浏览器中查看一下普罗米修斯仪表盘。</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="598c" class="lb lc iq mn b gy nd ne l nf ng">kubectl port-forward svc/prom-demo-prometheus-opera-prometheus 9090</span></pre><p id="8f18" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你转到<a class="ae la" href="http://localhost:9090/targets" rel="noopener ugc nofollow" target="_blank">http://localhost:9090/targets</a>，你会看到一个被监控的端点列表。使用Prometheus-Operator安装的<a class="ae la" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank">CRD</a>之一，我们将确保服务受到监控。</p><p id="1245" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">除非你已经改变了Prometheus部署的一些值文件，否则你不会在这里看到<em class="nl"> prometheus-demo-app </em>。让我们改变这一点。</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="5fec" class="lb lc iq mn b gy nd ne l nf ng">kubectl apply -f manifests/service-monitor.yml</span></pre><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae la" href="https://github.com/flipstone42/k8s-prometheus-custom-scaling/manifests/service-monitor.yml" rel="noopener ugc nofollow" target="_blank">点击这里查看GitHub上的文件</a></figcaption></figure><p id="48bc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该对象指示Prometheus操作员配置正在运行的Prometheus实例，以监控标签为<em class="nl">app:Prometheus-demo-app</em>的服务</p><p id="e0cb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你回到<a class="ae la" href="http://localhost:9090/targets" rel="noopener ugc nofollow" target="_blank">http://localhost:9090/targets</a>，你应该会看到我们的演示应用程序就在那里。让我们在Prometheus仪表板中运行以下查询:</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="8761" class="lb lc iq mn b gy nd ne l nf ng">demo_app_button_clicks_total</span></pre><p id="ff94" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这告诉我们在应用程序的所有实例中，总共发出了多少点击。</p><p id="81ea" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们如何开始将此转化为我们的pod可以衡量的指标？</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h2 id="bcb6" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated"><strong class="ak">第4部分:开始缩放</strong></h2><p id="a191" class="pw-post-body-paragraph kc kd iq ke b kf lw kh ki kj lx kl km kn nv kp kq kr nw kt ku kv nx kx ky kz ij bi translated">Prometheus-Adapter 是k8s的API扩展，它使用用户定义的Prometheus查询来填充k8s资源&amp;自定义指标API。</p><p id="e6a6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们将把它安装到我们的集群中，并添加一个规则来跟踪每个pod的请求率。规则被定义为YAML，我们将把它添加到Prometheus适配器的舵图中。</p><p id="62b8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们需要定义填充<em class="nl"> custom.metrics.k8s.io </em>组的规则。</p><p id="b8bd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">以下是规则配置文档中的一段引文:</p><blockquote class="np nq nr"><p id="9e66" class="kc kd nl ke b kf kg kh ki kj kk kl km ns ko kp kq nt ks kt ku nu kw kx ky kz ij bi translated">每条规则可以大致分为四个部分:</p><p id="e1ce" class="kc kd nl ke b kf kg kh ki kj kk kl km ns ko kp kq nt ks kt ku nu kw kx ky kz ij bi translated"><strong class="ke ir">发现</strong>，它指定适配器应该如何找到该规则的所有普罗米修斯度量</p><p id="9233" class="kc kd nl ke b kf kg kh ki kj kk kl km ns ko kp kq nt ks kt ku nu kw kx ky kz ij bi translated"><strong class="ke ir"> Association </strong>，它指定适配器应该如何确定特定指标与哪些Kubernetes资源相关联。</p><p id="f918" class="kc kd nl ke b kf kg kh ki kj kk kl km ns ko kp kq nt ks kt ku nu kw kx ky kz ij bi translated"><strong class="ke ir">命名</strong>，它指定适配器应该如何在定制度量API中公开度量。</p><p id="eb21" class="kc kd nl ke b kf kg kh ki kj kk kl km ns ko kp kq nt ks kt ku nu kw kx ky kz ij bi translated"><strong class="ke ir">查询</strong>，它指定了对一个或多个Kubernetes对象的特定指标的请求应该如何转换成对Prometheus的查询。</p></blockquote><p id="d65b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们从向配置文件添加<em class="nl">规则</em>键开始:</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="40df" class="lb lc iq mn b gy nd ne l nf ng">rules: []</span></pre><p id="f60f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们只需要<strong class="ke ir">发现</strong>一个指标:<em class="nl">demo _ app _ button _ clicks _ total。</em>我们在pod标签上添加了一个非空匹配，以确保它与一个匹配相关联。</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="9633" class="lb lc iq mn b gy nd ne l nf ng">rules:<br/>- seriesQuery: 'demo_app_button_clicks_total{pod!=""}'</span></pre><p id="8c99" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">关联</strong>非常简单:Prometheus标签都直接映射到Kubernetes资源(作业、名称空间、pod等)，因此我们可以使用一个模板来映射资源:</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="45ab" class="lb lc iq mn b gy nd ne l nf ng">rules:<br/>- seriesQuery: 'demo_app_button_clicks_total{pod!=""}'<br/>  <!-- -->resources: {template: "&lt;&lt;.Resource&gt;&gt;"}</span></pre><p id="12c3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">演示按钮点击的总和是没有用的:我们需要让它按pod缩放。这就像给我们的规则添加一个简单的<strong class="ke ir">命名</strong>定义一样简单:</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="d84b" class="lb lc iq mn b gy nd ne l nf ng">rules:<br/>- seriesQuery: 'demo_app_button_clicks_total{pod!=""}'<br/>  <!-- -->resources: {template: "&lt;&lt;.Resource&gt;&gt;"}<br/>  name:<br/>    matches: "^(.*)_total"<br/>    as: "${1}_per_second"</span></pre><p id="af70" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们只剩下定义<strong class="ke ir">查询:</strong></p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="0e0b" class="lb lc iq mn b gy nd ne l nf ng">seriesQuery: 'demo_app_button_clicks_total{pod!=""}'<br/>resources: { template: "&lt;&lt;.Resource&gt;&gt;" }<br/>name:<br/>  matches: "^(.*)_total"<br/>  as: "${1}_per_second"<br/>metricsQuery: "sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)"</span></pre><p id="5135" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这是一个参数化的普罗米修斯查询。让我们来分析一下它是做什么的。</p><p id="e2a7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Series是由seriesQuery匹配的任何序列。这个规则只有一个系列，所以我们可以替换<em class="nl"> &lt; &lt;。</em>系列<em class="nl"> &gt; &gt; </em>同<em class="nl">演示_应用_按钮_点击次数_总数。&lt; &lt;。</em> LabelMatchers &gt; &gt;是适配器放置标签查询的地方(例如“pod='deployment-name-abcd-1234 ')。&lt; &lt;。GroupBy &gt; &gt;代表了您想要扩展的资源:在我们的例子中就是pods。</p><p id="1f59" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Prometheus-Adapter的一个缺点是配置是通过一个与应用程序一起部署的静态文件来完成的，而不是通过一个ConfigMap或其他一些基于API的对象。</p><p id="4ee7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们将使用另一个舵图表来部署它，并使用舵值文件编写我们的规则。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">我们的舵值文件</figcaption></figure><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="150a" class="lb lc iq mn b gy nd ne l nf ng">helm install prometheus-adapter prometheus-community/prometheus-adapter -f helm-values/prometheus-adapter-values.yml</span></pre><p id="9980" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">等待几分钟，然后运行以下查询:</p><blockquote class="np nq nr"><p id="3398" class="kc kd nl ke b kf kg kh ki kj kk kl km ns ko kp kq nt ks kt ku nu kw kx ky kz ij bi translated">jq 可从所有知名的包装经理处获得。</p></blockquote><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="df95" class="lb lc iq mn b gy nd ne l nf ng">kubectl get --raw="/apis/custom.metrics.k8s.io/v1beta1" | jq</span></pre><p id="b8db" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您的输出应该如下所示:</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="aad1" class="lb lc iq mn b gy nd ne l nf ng">{<br/>  "kind": "APIResourceList",<br/>  "apiVersion": "v1",<br/>  "groupVersion": "custom.metrics.k8s.io/v1beta1",<br/>  "resources": [<br/>    {<br/>      "name": "pods/demo_app_button_clicks_per_second",<br/>      "singularName": "",<br/>      "namespaced": true,<br/>      "kind": "MetricValueList",<br/>      "verbs": [<br/>        "get"<br/>      ]<br/>    },<br/>    {<br/>      "name": "services/demo_app_button_clicks_per_second",<br/>      "singularName": "",<br/>      "namespaced": true,<br/>      "kind": "MetricValueList",<br/>      "verbs": [<br/>        "get"<br/>      ]<br/>    },<br/>    {<br/>      "name": "jobs.batch/demo_app_button_clicks_per_second",<br/>      "singularName": "",<br/>      "namespaced": true,<br/>      "kind": "MetricValueList",<br/>      "verbs": [<br/>        "get"<br/>      ]<br/>    },<br/>    {<br/>      "name": "namespaces/demo_app_button_clicks_per_second",<br/>      "singularName": "",<br/>      "namespaced": false,<br/>      "kind": "MetricValueList",<br/>      "verbs": [<br/>        "get"<br/>      ]<br/>    }<br/>  ]<br/>}</span></pre><p id="b749" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">接下来，让我们获取pod的指标:</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="8abf" class="lb lc iq mn b gy nd ne l nf ng">kubectl get --raw="/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/demo_app_button_clicks_per_second?pod=$(kubectl get po -l app=prometheus-demo-app -o name)" | jq</span></pre><p id="9c26" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">输出应该类似于以下内容:</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="24d6" class="lb lc iq mn b gy nd ne l nf ng">{<br/>  "kind": "MetricValueList",<br/>  "apiVersion": "custom.metrics.k8s.io/v1beta1",<br/>  "metadata": {<br/>    "selfLink": "/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/demo_app_button_clicks_per_second"<br/>  },<br/>  "items": [<br/>    {<br/>      "describedObject": {<br/>        "kind": "Pod",<br/>        "namespace": "default",<br/>        "name": "prometheus-demo-app-86cc784f46-c5m66",<br/>        "apiVersion": "/v1"<br/>      },<br/>      "metricName": "demo_app_button_clicks_per_second",<br/>      "timestamp": "2019-09-20T18:06:55Z",<br/>      "value": "0"<br/>    }<br/>  ]<br/>}</span></pre><p id="734a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">注意值的零:因为我们还没有开始点击按钮，正常化的速率是每秒0。</p><p id="13fd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">运行以下命令以端口转发演示应用程序:</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="3b3b" class="lb lc iq mn b gy nd ne l nf ng">kubectl port-forward svc/prometheus-demo-app 8080</span></pre><p id="0b96" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">导航到演示应用程序的网页并敲击按钮，然后重新运行上述命令。您应该会看到速率增加。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><p id="5d92" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">第5部分:部署HPA </strong></p><p id="51db" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" rel="noopener ugc nofollow" target="_blank">水平Pod自动缩放器</a>根据满足的特定条件向部署添加新的Pod。</p><p id="365c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们将添加一个HPA，目标是每秒每pod 0.01次点击。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">点击此处查看完整文件</figcaption></figure><blockquote class="np nq nr"><p id="9205" class="kc kd nl ke b kf kg kh ki kj kk kl km ns ko kp kq nt ks kt ku nu kw kx ky kz ij bi translated">提示:如果您正在使用此工具向观众演示扩展，请调整targetAverageValue，以便在将更多pod添加到部署之前需要一定的参与度</p></blockquote><p id="3ed1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，这应该会自动扩展我们的部署，以响应超出的指标阈值。</p><p id="09dd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">运行以下命令以确认您只有一个pod在运行:</p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="3274" class="lb lc iq mn b gy nd ne l nf ng">kubectl get po -l app=prometheus-demo-app</span></pre><p id="376f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在浏览器中打开网站。</p><p id="05cd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="nl"> Minikube: </em>运行“minikube ip”，然后在浏览器中找到该地址</p><p id="f03d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">按几次按钮，然后再次运行上面的命令。</p><p id="3d47" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您应该会看到部署已经扩大了！您可以在仪表板上查看，或者只查看已部署的pod。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h2 id="cad8" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated"><strong class="ak">下一步是什么？</strong></h2><p id="1267" class="pw-post-body-paragraph kc kd iq ke b kf lw kh ki kj lx kl km kn nv kp kq kr nw kt ku kv nx kx ky kz ij bi translated"><strong class="ke ir">在Grafana </strong>中显示缩放数据</p><p id="84d5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我还包括了一个<a class="ae la" href="https://grafana.com/grafana/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>仪表板，它跟踪每个pod的指标。</p><p id="b4f2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我包括了一个配置图，它带有一个如下所示的仪表板:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/35f51edb8f1b2571ebe17436956fa571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0H-MnVfHt4SsEEbETHHw4Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana仪表板</figcaption></figure><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="72ca" class="lb lc iq mn b gy nd ne l nf ng">kubectl apply -f manifests/grafana-dashboard-configmap.yml</span></pre><p id="a094" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要查看grafana仪表板，要么为它创建一个入口，要么运行这个命令，然后转到<a class="ae la" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a></p><pre class="mv mw mx my gt mz mn na nb aw nc bi"><span id="f9c9" class="lb lc iq mn b gy nd ne l nf ng">kubectl port-forward svc/prom-demo-grafana 3000:80</span></pre><p id="7f9b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">默认用户名/密码是<em class="nl"> admin/prom-operator。</em></p><p id="75ea" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">部署入口</strong></p><p id="f913" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">清单/目录中包含一个入口文件。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><div class="mv mw mx my gt ny"><a href="https://gitconnected.com/learn/kubernetes" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd ir gy z fp od fr fs oe fu fw ip bi translated">学习Kubernetes -最佳Kubernetes教程(2019) | gitconnected</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">7大Kubernetes教程-免费学习Kubernetes。课程由开发人员提交并投票，从而实现…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">gitconnected.com</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om jw ny"/></div></div></a></div></div></div>    
</body>
</html>