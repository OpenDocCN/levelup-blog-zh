<html>
<head>
<title>Accessing Android Storage on Android 13 And Higher</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Android 13及更高版本上访问Android存储</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/read-external-storage-permission-is-deprecated-heres-the-new-way-to-access-android-storage-8ce0644e9955?source=collection_archive---------0-----------------------#2022-10-30">https://levelup.gitconnected.com/read-external-storage-permission-is-deprecated-heres-the-new-way-to-access-android-storage-8ce0644e9955?source=collection_archive---------0-----------------------#2022-10-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="93f7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Android 13引入了粒度存储权限和用于访问媒体文件的照片拾取工具</h2></div><p id="3d5a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi lb translated"><span class="l lc ld le bm lf lg lh li lj di"> S </span>从Android 13开始，<code class="fe lk ll lm ln b">READ_EXTERNAL_STORAGE</code> permission已经被弃用，取而代之的是更好的API来访问Android存储中的媒体文件。如果您的应用程序面向Android 13 (API级别33)或更高版本，并且需要访问其他应用程序创建的媒体文件，您需要更新代码以利用Android 13版本引入的新API集</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/030473696b97ef0dde61de19e3f7efb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*J3Ho_pNW70DY9zlz"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">照片由<a class="ae me" href="https://unsplash.com/@rossf?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">罗斯·芬登</a>在<a class="ae me" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="06df" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看到从Android存储访问媒体文件的两种不同方法。选择哪种方法取决于用例及业务需求。这里有两种方法:</p><h2 id="5b68" class="mf mg iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated"><strong class="ak"> 1。照片拾取器(无需许可):</strong></h2><p id="e69f" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">该工具为用户提供了一种选择媒体文件的方式，而无需授予对其整个媒体库的访问权限。</p><p id="66bd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">使用案例:</strong> <br/>如果你的app只需要访问图片、照片、视频，可以考虑使用Android Photo Picker。Android系统将负责显示媒体选择器用户界面</p><p id="00f3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Photo picker已被反向移植到所有运行Android OS 11和12的Android设备(不包括Android Go设备)，因此用户将在所有Android设备上获得统一和标准的体验</p><p id="c93b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">限制:<br/> </strong>照片拾取器有一些限制，例如，它只适用于视觉媒体类型，不适用于音频类型</p><p id="c122" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文的下一部分，我们将看到照片拾取器的实现</p><h2 id="111e" class="mf mg iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">2.请求粒度媒体权限</h2><p id="9d5e" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated"><strong class="kh ir">使用案例:<br/> </strong>虽然建议使用新的照片拾取器来请求访问所有媒体文件，但您的应用程序可能会有需要这种广泛访问的使用案例(例如图库照片备份)。对于这些特定用途，引入了新的权限，提供对特定类型的媒体文件(包括图像、视频或音频)的访问</p><p id="1d2f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从目标13开始，您必须请求一个或多个以下粒度媒体权限，而不是<code class="fe lk ll lm ln b"><a class="ae me" href="https://developer.android.com/reference/android/Manifest.permission#READ_EXTERNAL_STORAGE" rel="noopener ugc nofollow" target="_blank">READ_EXTERNAL_STORAGE</a></code>权限:</p><ol class=""><li id="cd1c" class="nd ne iq kh b ki kj kl km ko nf ks ng kw nh la ni nj nk nl bi translated"><code class="fe lk ll lm ln b">READ_MEDIA_IMAGES</code>用于访问图像</li><li id="d1ed" class="nd ne iq kh b ki nm kl nn ko no ks np kw nq la ni nj nk nl bi translated"><code class="fe lk ll lm ln b">READ_MEDIA_VIDEO</code>用于访问视频</li><li id="c98e" class="nd ne iq kh b ki nm kl nn ko no ks np kw nq la ni nj nk nl bi translated"><code class="fe lk ll lm ln b">READ_MEDIA_AUDIO</code>用于访问音频文件</li></ol><p id="b115" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">查看此决策树，帮助您决定选择哪种方法:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nr"><img src="../Images/58fbd834ed931ec1cc02826cbbe43644.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-W7EgAWxLLAMlAOLkmGU9A.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">来源:<a class="ns nt ep" href="https://medium.com/u/f51b24785c0d?source=post_page-----8ce0644e9955--------------------------------" rel="noopener" target="_blank"> Yacine Rezgui的</a>关于使用照片拾取器的文章</figcaption></figure><p id="ce9a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">既然我们已经清楚了在什么情况下选择什么方法，我们现在将研究这两种方法的实现细节</p></div><div class="ab cl nu nv hu nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="ij ik il im in"><h1 id="ec9c" class="ob mg iq bd mh oc od oe mk of og oh mn jw oi jx mq jz oj ka mt kc ok kd mw ol bi translated">照片拾取器实现</h1><p id="7a87" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi lb translated">照片选择器提供了一个可浏览、可搜索的界面，向用户展示他们的媒体库，按日期从最新到最早排序。该工具为用户提供了一种安全的内置方式来选择图像和视频，而无需授权您的应用程序访问他们的整个媒体库。</p><p id="7727" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，“相册”部分允许用户通过有用的类别进行浏览，如截图或下载。通过指定用户应该只查看照片还是只查看视频，或者通过设置他们可以选择的最大项目数，可以自定义照片选择器。</p><p id="3f06" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该工具会自动更新，随着时间的推移为您的应用程序用户提供扩展的功能，而无需更改任何代码。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi om"><img src="../Images/d481cee3910a64fd8e8b4c533cfadc26.png" data-original-src="https://miro.medium.com/v2/resize:fit:486/1*wqvXK7vX02YJOfGUGZMS2g.gif"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">照片拾取器示例。来源:<a class="ae me" href="https://developer.android.com" rel="noopener ugc nofollow" target="_blank">https://developer.android.com</a></figcaption></figure><h2 id="740e" class="mf mg iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">履行</h2><p id="adb9" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">要使用照片拾取器支持库，请包含版本1.6.0或更高版本的<code class="fe lk ll lm ln b"><a class="ae me" href="https://developer.android.com/jetpack/androidx/releases/activity#1.6.0" rel="noopener ugc nofollow" target="_blank">androidx.activity</a></code>库。这是一个简单的启动意图，它将在可用时使用照片选择器，并在旧设备上返回到ACTION_OPEN_DOCUMENT:</p><p id="f4f9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">支持库使用以下活动结果合同来启动照片拾取器:</p><ol class=""><li id="7c16" class="nd ne iq kh b ki kj kl km ko nf ks ng kw nh la ni nj nk nl bi translated"><code class="fe lk ll lm ln b"><a class="ae me" href="https://developer.android.com/reference/kotlin/androidx/activity/result/contract/ActivityResultContracts.PickVisualMedia" rel="noopener ugc nofollow" target="_blank">PickVisualMedia</a></code>:选择单幅图像或视频。</li><li id="7fc4" class="nd ne iq kh b ki nm kl nn ko no ks np kw nq la ni nj nk nl bi translated"><code class="fe lk ll lm ln b"><a class="ae me" href="https://developer.android.com/reference/kotlin/androidx/activity/result/contract/ActivityResultContracts.PickMultipleVisualMedia" rel="noopener ugc nofollow" target="_blank">PickMultipleVisualMedia</a></code>，选择多个图像或视频。</li></ol><p id="9ec1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果设备上没有照片拾取器，支持库会自动调用<code class="fe lk ll lm ln b">ACTION_OPEN_DOCUMENT</code> intent动作。</p><h2 id="7e00" class="mf mg iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">选择单个媒体项目</h2><p id="de79" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">要选择单个媒体项目，请使用<code class="fe lk ll lm ln b">PickVisualMedia</code>活动结果契约，如下面的代码片段所示:</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="on oo l"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">从存储器中选择一个可视媒体的示例</figcaption></figure><h2 id="9b1d" class="mf mg iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">选择多个媒体项目</h2><p id="9910" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">要选择多个媒体项目，请设置可选择媒体文件的最大数量，如下面的代码片段所示。</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="on oo l"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">从存储中选择多个可视媒体的示例</figcaption></figure><p id="44d5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该平台限制了您可以要求用户在照片拾取器中选择的文件的最大数量。要访问此限制，请调用<code class="fe lk ll lm ln b"><a class="ae me" href="https://developer.android.com/reference/android/provider/MediaStore#getPickImagesMaxLimit()" rel="noopener ugc nofollow" target="_blank">getPickImagesMaxLimit()</a></code>。在不支持照片选择器的设备上，此限制将被忽略。</p><p id="f423" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以通过调用<code class="fe lk ll lm ln b"><a class="ae me" href="https://developer.android.com/reference/kotlin/androidx/activity/result/contract/ActivityResultContracts.PickVisualMedia.Companion#isPhotoPickerAvailable()" rel="noopener ugc nofollow" target="_blank">isPhotoPickerAvailable</a>.</code>来验证照片拾取器在给定设备上是否可用</p><h2 id="0238" class="mf mg iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">持续媒体文件访问</h2><p id="3e4e" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">默认情况下，系统会授予您的应用程序访问媒体文件的权限，直到设备重新启动或您的应用程序停止运行。如果你的应用程序执行一些长时间运行的工作，需要在更长的时间内保持对文件的访问，那么你可以调用<code class="fe lk ll lm ln b"><a class="ae me" href="https://developer.android.com/reference/android/content/ContentResolver#takePersistableUriPermission(android.net.Uri,%20int)" rel="noopener ugc nofollow" target="_blank">takePersistableUriPermission()</a></code>方法</p><pre class="lp lq lr ls gt op ln oq or aw os bi"><span id="ec46" class="mf mg iq ln b gy ot ou l ov ow">val flag = Intent.FLAG_GRANT_READ_URI_PERMISSION<br/>context.contentResolver.takePersistableUriPermission(uri, flag)</span></pre></div><div class="ab cl nu nv hu nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="ij ik il im in"><h1 id="265a" class="ob mg iq bd mh oc od oe mk of og oh mn jw oi jx mq jz oj ka mt kc ok kd mw ol bi translated">粒度媒体权限</h1><p id="5664" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi lb translated">从API等级33开始，如果你的应用程序访问其他应用程序的媒体文件，不需要请求<code class="fe lk ll lm ln b">READ_EXTERNAL_STORAGE</code>许可。相反，请求这些权限中的一个或多个:<code class="fe lk ll lm ln b">READ_MEDIA_IMAGES</code>、<code class="fe lk ll lm ln b">READ_MEDIA_VIDEO</code>、<code class="fe lk ll lm ln b">READ_MEDIA_AUDIO</code></p><h2 id="4ad7" class="mf mg iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">履行</h2><p id="ac7a" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">若要访问其他应用程序创建的媒体文件，您必须声明适当的与储存相关的权限。下面的代码片段演示了如何声明适当的存储权限:</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="on oo l"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">Android 13上的存储权限示例</figcaption></figure><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/8941f40b8a12cb6d16ffb7f4ad641e0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:630/format:webp/1*RRlhntIYxswG14i_JJLxCQ.png"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">Android 13上的存储权限示例</figcaption></figure><p id="34b3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您同时请求<code class="fe lk ll lm ln b">READ_MEDIA_IMAGES</code>权限和<code class="fe lk ll lm ln b">READ_MEDIA_VIDEO</code>权限，只会出现一个系统权限对话框。</p><p id="5c74" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果用户之前授予您的应用程序<code class="fe lk ll lm ln b">READ_EXTERNAL_STORAGE</code>权限，系统会自动授予您的应用程序粒度媒体权限。</p></div><div class="ab cl nu nv hu nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="ij ik il im in"><p id="ceb5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">希望这篇文章对你有所帮助。如果有，别忘了点击拍手图标，并关注更多类似内容</p></div></div>    
</body>
</html>