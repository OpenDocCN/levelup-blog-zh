<html>
<head>
<title>Automating deployments to on premise servers with Azure DevOps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure DevOps自动部署到本地服务器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/automating-deployments-to-on-premis-servers-with-azure-devops-bb0e6cac4656?source=collection_archive---------0-----------------------#2019-08-09">https://levelup.gitconnected.com/automating-deployments-to-on-premis-servers-with-azure-devops-bb0e6cac4656?source=collection_archive---------0-----------------------#2019-08-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="1708" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">作为一个大部分职业生涯(非常短暂)都在从事一键式云资源部署的人，当我跳到一个遗留项目并意识到从部署流程到试运行和生产的复杂性时，我感到震惊。使用传统的。NET框架应用程序堆栈，部署过程由以下步骤组成:</p><ol class=""><li id="b94d" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">将Visual Studio中的配置目标设置为<code class="fe kx ky kz la b">release</code></li><li id="b43b" class="ko kp it js b jt lb jx lc kb ld kf le kj lf kn kt ku kv kw bi translated">构建项目</li><li id="0561" class="ko kp it js b jt lb jx lc kb ld kf le kj lf kn kt ku kv kw bi translated">复制。使用USB连接到配置为VPN访问的客户端笔记本电脑</li><li id="b1ce" class="ko kp it js b jt lb jx lc kb ld kf le kj lf kn kt ku kv kw bi translated">复制。dll通过RDP到目标服务器</li><li id="0821" class="ko kp it js b jt lb jx lc kb ld kf le kj lf kn kt ku kv kw bi translated">进入IIS管理器，将文件路径指向应用程序的新版本</li></ol><p id="c0f7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如您所看到的并且可能已经经历过的，这是一个漫长、缓慢并且容易出错的过程，如果其中一个步骤可能无法正常工作，那么这个过程通常会持续一个多小时。对我来说，不得不使用客户端笔记本电脑也是一个真正的痛点，因为它有3个不同的密码进入，其中没有一个是我设置的，也没有一个是我能记住的。这也意味着，如果我们需要进行部署，我必须在办公室使用笔记本电脑——那天不能在家工作。</p><p id="e8c8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我的第一步是<strong class="js iu">自动化构建过程</strong>。如果我们可以让Azure Pipelines至少构建这个项目，我可以下载文件并手动复制它们。网上有很多关于如何设置的指南，但最终结果意味着它给了我一个项目所需的所有文件的. zip文件。这也消除了一个常见的错误热点，它是在我的机器上本地构建的。这也意味着不管是谁写的代码，构建过程总是相同的。</p><p id="d95a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第二步是<strong class="js iu">建立一个释放管道</strong>。在Azure Pipelines中，我们想要做的是<a class="ae lg" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release/deployment-groups/index?view=azure-devops" rel="noopener ugc nofollow" target="_blank">创建一个部署组</a>，然后将我们想要部署的服务器注册为该部署组中的一个目标。这将允许我们直接部署到本地服务器。那么，我们该怎么做呢？</p><p id="2e95" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">要求:</strong></p><ul class=""><li id="abd6" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn lh ku kv kw bi translated">PowerShell 3.0或更高版本。在我们的Windows Server 2003机器上，我们需要从PowerShell 2.0升级。这是一个简单的下载，安装和重启。</li><li id="c756" class="ko kp it js b jt lb jx lc kb ld kf le kj lf kn lh ku kv kw bi translated">。NET Framework x64 4.5或更高版本</li></ul><p id="00ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">步骤:</strong></p><ol class=""><li id="c3bf" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">导航到Azure DevOps中管道下的部署组:</li></ol><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi li"><img src="../Images/49042b29516f286db2891fd45a1362b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*H-u5CdbLqzmCC9wwYNKjBQ.png"/></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">Azure DevOps &gt;管道中的部署组菜单项</figcaption></figure><p id="cee6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.创建新的部署组。这个想法是，您可以让几个服务器在同一个组中，同时将代码部署到所有这些服务器上(例如出于负载平衡的原因)。在我的例子中，我的部署组中只有一个目标，所以组的概念有点多余。</p><p id="7660" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.打开您刚刚创建的群，然后单击右上角的“注册”。这是我们实际将服务器添加到组中的步骤。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lu"><img src="../Images/225350c7953d7b73242ca13c844237e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JL99Ab-JCgyz2Nby0gb-Gg.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">注册一个目标窗口</figcaption></figure><p id="a8f3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.我们想要勾选<code class="fe kx ky kz la b">Use a personal access token in the script for authentication</code>框，将这个脚本复制到我们的服务器，并在PowerShell中以管理员身份运行它。</p><p id="20f0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.<strong class="js iu">如果脚本要求您输入认证类型，您将需要获得一个PAT令牌</strong>。这可以在你的个人资料下找到(点击右上角的图片)，然后是安全部分。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lz"><img src="../Images/1b961f6d8ec34b605e8187033c5f4899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*phEVptjMyv7OCb-hSoU5sw.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">个人访问令牌设置</figcaption></figure><p id="f101" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果还没有为您创建的令牌(名称中应该有“部署组”)，请创建一个新令牌。如果您需要创建一个新的令牌，它需要启用<code class="fe kx ky kz la b">Deployment Groups</code>范围:</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ma"><img src="../Images/f2804e11d3a99436cce2d272842145b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jL5x11zIkX5mBJWwXjeOBQ.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">部署组范围</figcaption></figure><p id="c655" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您正在创建新的令牌，它将为您提供令牌字符串，您可以将该字符串复制到剪贴板中。如果已经有一个令牌，请单击“重新生成”并复制它提供给您的令牌字符串。</p><p id="004b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">回到PowerShell，按enter使用PAT令牌身份验证，然后粘贴这个字符串。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mb"><img src="../Images/04569250afb8249b3ed00ea411688a1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*grjq6oiP6mFI8KeujeFO9g.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">将PAT令牌粘贴到PowerShell窗口中</figcaption></figure><p id="6fbb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">6.这应该会运行一遍，并询问您是否要输入该特定代理应该具有的任何标记。标签是一种标记服务器功能的方式，例如，如果您有多个web服务器，或者可能有一个单独的数据库服务器。在我的例子中，服务器既是网络又是数据库，所以我将其标记为<code class="fe kx ky kz la b">web</code>和<code class="fe kx ky kz la b">db</code>。</p><p id="4dc8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">7.该脚本将询问您希望哪个用户运行该服务。我很喜欢这个默认值，所以我只按了enter键，但是您可能希望将它的范围限定为IIS应用程序池。</p><p id="7047" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">8.就是这样！这将在<code class="fe kx ky kz la b">C:\azagent</code>创建一个新文件夹，当你推出一个新的部署时，它将保存临时文件。</p><p id="958a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您刷新注册代理的网页并刷新，您应该会看到您的服务器。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mc"><img src="../Images/0505db0b974ebfd8580e63120ed92c89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hgf9_Iqjs0Hi5gDlvuX1bQ.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">部署组中的注册代理</figcaption></figure><p id="d775" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，如果您<a class="ae lg" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release/?view=azure-devops" rel="noopener ugc nofollow" target="_blank">创建一个新的发布管道</a>，您将能够选择您新创建的部署组。我仍然使用经典的发布管道，但是如果你创建一个<code class="fe kx ky kz la b">yaml</code>发布管道，步骤将会非常相似。让我们来看一下创建发布管道的步骤。</p><ol class=""><li id="424c" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">转到管道&gt;发布，并创建一个新的发布管道</li><li id="bcac" class="ko kp it js b jt lb jx lc kb ld kf le kj lf kn kt ku kv kw bi translated">选择适当的模板。在我的例子中，我现在不担心数据库升级，所以我只选择底部的选项，即网站部署:</li></ol><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi md"><img src="../Images/dc845dde6b1647ba594a0149b08ec5b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ss209BlprJRRSAPFGtbg3w.png"/></div></div></figure><p id="d8df" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.为您的舞台命名:</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi me"><img src="../Images/bc70a27ad4c27251b8c35bf27502e26f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QKonJDHo7LOUforMhziQBQ.png"/></div></div></figure><p id="49de" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.通过单击“添加项目”链接构建项目，然后选择要从中获取的构建管道。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mf"><img src="../Images/f7ac6421f7432ad979e6d340fa6ee758.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vVBA-teD-NEfZDmxBP-PaA.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">在add an artifact屏幕中，选择您想要从哪个构建管道中获取工件</figcaption></figure><p id="2456" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.链接工件后，打开stage并在stage settings页面中设置网站名称、绑定和应用程序池名称的参数。这些设置与您在IIS管理器中配置的设置完全相同。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mg"><img src="../Images/00cedd782877c6f38170a97876245f3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uNJ9wlFzJyxd85lLdgUuww.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">在阶段设置中设置网站名称和应用程序池名称</figcaption></figure><p id="5c23" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">6.在IIS部署步骤中，将部署组设置为我们在上一节中创建的组。在本例中，我将其设置为部署到“本地”部署组。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mh"><img src="../Images/87f5daa11ac70f4a96b0085470afd5ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eL_mx6VAynYrkQWGrp5Xrg.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">在IIS部署作业设置中设置部署组</figcaption></figure><p id="da1f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">7.在“IIS Web App管理”任务中，将物理路径设置为您希望文件在服务器上实际存储的位置。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mi"><img src="../Images/32b1433503bd93ab5b1dc9f314fd2609.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RXjIM8Lmik3jwhxnGbhj2Q.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">在此Web应用程序管理任务中，设置您希望在服务器上存储应用程序文件的物理路径</figcaption></figure><p id="e4e8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您还可以在这里设置任何附加参数。在我的例子中，我需要从这些高级设置中启用32位应用程序在应用程序池中运行，所以我将它作为命令行参数传递。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mj"><img src="../Images/80f51ca2f18eb1798cf55a2224f1658f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fkRQjETh6NnB87OpN1YTWw.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">IIS应用程序池设置中添加的命令行参数</figcaption></figure><p id="ed1c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">出于好奇，命令是:</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="36cc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">8.最后，将包或文件夹设置配置为指向您希望从构建中部署的文件所在的位置:</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mm"><img src="../Images/856abf26b3da70bba37e507f589b3e40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pd5ZyITP3CZyQK228xYleA.png"/></div></div></figure><p id="aec6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了从工件中获取文件，不管它的别名是什么，我在路径中放了一些Azure Pipelines环境变量。</p><figure class="lj lk ll lm gt ln"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="60a6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我修改的另一个设置是启用XML变量替换，因此我可以将数据库连接字符串作为变量放入发布管道，并让Azrue管道管理替换。</p><p id="80a8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本质上就是这样。现在，您可以从您的构建中创建一个发布，然后可以将它部署到您的本地web服务器上。如果您正确设置了触发器，那么您可以在<code class="fe kx ky kz la b">git push</code>将代码自动构建、发布并部署到您的本地服务器上。这就是未来！</p><p id="b031" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我要部署的web服务器运行在Windows Server 2008上，我已经能够使用Azure Devops对它进行现代化，这个概念在这个应用程序创建时还是一个白日梦。</p><p id="8cc3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你有任何问题或者我错过了任何关键细节，请在评论中留下，我会尽快回复你。否则，如果这篇文章是有帮助的，给一些掌声。</p></div></div>    
</body>
</html>