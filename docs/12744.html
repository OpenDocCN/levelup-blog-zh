<html>
<head>
<title>4 Tips To Integrate Pytest With Pyspark Applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Pytest与Pyspark应用程序集成的4个技巧</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/4-tips-to-integrate-pytest-with-pyspark-applications-5a18835a6d3e?source=collection_archive---------2-----------------------#2022-07-05">https://levelup.gitconnected.com/4-tips-to-integrate-pytest-with-pyspark-applications-5a18835a6d3e?source=collection_archive---------2-----------------------#2022-07-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4713" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">节省您在开发工作流中设置测试时间的技巧</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0551adb98a1164b2774b08884a1a6d88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dsBXHt6x6e5ZGezN"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Artem Beliaikin 在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h2 id="726e" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">介绍</h2><p id="7c98" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">软件测试是软件开发的重要组成部分。一个伟大的开发人员从任何项目的第一天起就拥抱它。他们知道如何设置和调整测试配置，以便从中获得最大收益。如果你是新手，刚刚开始编写你的第一个单元/集成测试，该怎么办？</p><ul class=""><li id="8e85" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated">第一天怎么知道最佳做法？</li><li id="4913" class="mo mp it lx b ly mz mb na li nb lm nc lq nd mn mv mw mx my bi translated">集成测试套件后，如何缩短发布产品/分析/模型的时间？</li></ul><p id="04de" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">知道一些可以节省学习如何构建测试用例的时间的技巧不是很好吗？</p><h2 id="84b3" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">利益</h2><p id="3467" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">为了更加强调测试的好处:</p><ul class=""><li id="8230" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated">即使你不是软件开发人员，你仍然要编写代码来产生结果，而且，作为一个人，你总是会犯错误。测试驱动的开发将把你从你犯的意外引入的错误中拯救出来。</li><li id="14ca" class="mo mp it lx b ly mz mb na li nb lm nc lq nd mn mv mw mx my bi translated">测试用例将帮助您捕获您可能在不知不觉中引入的错误。例如，当您更改分析中的一些代码时，可能会影响其他部分。在这种情况下，多花2-3个小时编写测试用例总是值得的。</li><li id="e22d" class="mo mp it lx b ly mz mb na li nb lm nc lq nd mn mv mw mx my bi translated">另一个好处是它帮助你理解当你引入一个新的变化时代码是如何工作的，以及在你的端到端管道中你应该注意什么。此外，当您将您的代码转移给其他人进行进一步开发时，这有助于其他人检查结果，并确保整个路径仍然像它应该的那样一起工作。</li></ul><h2 id="948f" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">你会做什么</h2><p id="59d9" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">本文将关注pyspark应用程序，尤其是在数据分析用例中。</p><ul class=""><li id="84af" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated">在pandas、pyspark和pandas on spark中创建实体模型数据。</li><li id="44ef" class="mo mp it lx b ly mz mb na li nb lm nc lq nd mn mv mw mx my bi translated">构造一个配置文件和测试用例文件夹。</li><li id="0e70" class="mo mp it lx b ly mz mb na li nb lm nc lq nd mn mv mw mx my bi translated">加速pyspark应用程序的测试用例。</li><li id="0e4d" class="mo mp it lx b ly mz mb na li nb lm nc lq nd mn mv mw mx my bi translated">将实际数据框与预期数据框进行比较。</li></ul><blockquote class="nh"><p id="3539" class="ni nj it bd nk nl nm nn no np nq mn dk translated">你可以在这个<a class="ae ky" href="https://github.com/Pathairush/test_driven_data_analysis" rel="noopener ugc nofollow" target="_blank"> Github库</a>中找到下面教程的代码</p></blockquote></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h2 id="b3fb" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">1.设置您的测试数据</h2><p id="8873" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">通常，当我们编写单元测试时，我们关注于一小段代码。我们希望确保函数的行为符合我们的预期。因此，我们倾向于创建一小块模拟数据来测试我们的功能，而不是使用来自数据库的数据流。然而，不同的库有他们创建数据框的方式，如果你知道他们所有的方式就太好了。</p><p id="6e52" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">在每个库中，有多种方法来启动数据框。我只会告诉你我坚持的方式。我相信只有一种创建数据框的方法就足以在你的一生中使用。</p><h2 id="1dd1" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">熊猫</h2><p id="f89d" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">对于大家来说，最知名的数据分析库就是熊猫了。我每天都在使用它，无法想象没有它我的生活会怎样。创建熊猫数据框有多种方法，但我更喜欢的方法是输入一个列表字典，如下例所示。</p><ul class=""><li id="d09c" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated">字典的键值是Pandas列名。</li><li id="2112" class="mo mp it lx b ly mz mb na li nb lm nc lq nd mn mv mw mx my bi translated">列表中的值表示Pandas数据框中的每一行。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">创建一个模拟熊猫数据框。</figcaption></figure><p id="cdf2" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">如果您的数据集足够小，可以放入您的计算机内存中，那么Pandas数据框就可以很好地工作。如果您正在处理<strong class="lx iu">大数据，即笔记本电脑内存</strong>无法容纳的较大数据，以下方法将更适合您。</p><h2 id="2e3d" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">星火上的熊猫</h2><p id="39b8" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">Apache spark基金会最近发布了Pyspark 3.2.1，它附带了spark上有用的子模块<strong class="lx iu">熊猫(以前称为考拉)。</strong>该子模块模仿Pandas APIs，并翻译请求以在Spark集群上运行。因此，这是从Pandas环境到分布式Spark应用程序的简单方法。</p><p id="94bf" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">该库没有涵盖100%的Pandas APIs，但我发现对于基本的数据分析用例来说，它已经足够好了。这就是我们如何在Spark数据帧上启动熊猫。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">在spark数据框上创建一个模拟熊猫。</figcaption></figure><h2 id="c61e" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Pyspark</h2><p id="ec0b" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">最后，如果在你的工作场所，由于依赖问题和向后兼容性，你仍然害怕更新spark的版本。我还提供了一种直接从pyspark库中创建spark数据框的方法。</p><p id="c267" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">创建spark数据框有点烦人，因为您必须首先指定数据的整个模式，不像我们在Pandas或Pandas on spark中所做的那样，该库通过为我们推断数据模式来处理。但是，如果您有时间，这仍然是一个很好的做法，因为错误的数据类型(例如，浮点和小数)也可能导致我们的数据分析中出现意外情况。下面是如何创建spark数据框的单个列。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">创建单列模拟spark数据框。</figcaption></figure><p id="45e7" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">对于多列数据框，必须添加额外的函数来定义spark数据框方案，如下例所示。</p><ul class=""><li id="2b08" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated">StructField函数接收三个参数:列名、数据类型和可为name的布尔标志。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">创建多列模拟spark数据框。</figcaption></figure><p id="b55b" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">我曾经总是打开文档来寻找在每个库中创建数据框的方法，并意识到当我能记住以上四种语法时，对我来说这要快得多。</p></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h2 id="344b" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">2.构建一个配置文件和测试用例文件夹</h2><p id="edb9" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">有许多方法来构建开发文件夹。我将向你展示的是我目前的发展模板。我通常从两个文件夹开始:一个源文件夹和一个测试文件夹。</p><ul class=""><li id="b32b" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated">源文件夹包含我的分析，无论是Python还是Jupyter笔记本文件。</li><li id="0351" class="mo mp it lx b ly mz mb na li nb lm nc lq nd mn mv mw mx my bi translated">测试文件夹包含带有前缀“test_”约定的测试用例。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/cbad6c4bcaf1db3bc8cafda2277e0b96.png" data-original-src="https://miro.medium.com/v2/resize:fit:488/format:webp/1*el40kQYhwPmtIka1pw_s4A.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">上面的fixture展示了我如何构建分析开发文件夹fixture by author。</figcaption></figure><p id="83f0" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">本节有趣的部分是如何创建<strong class="lx iu"> conftest.py </strong>和<strong class="lx iu"> pytest.ini </strong>文件</p><ul class=""><li id="5008" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated"><strong class="lx iu">conf test . py—</strong>conf test . py文件是我们可以放置我们的<a class="ae ky" href="https://docs.pytest.org/en/7.1.x/explanation/fixtures.html" rel="noopener ugc nofollow" target="_blank"> <strong class="lx iu">夹具</strong> </a> <strong class="lx iu"> </strong>来构造和安排我们的测试用例数据的地方。夹具可以在测试文件中重用。为不同的测试用例重用相同的夹具是很方便的。fixture既可以是数据，就像我们上面的模拟数据函数，也可以是我们希望为测试会话启动的spark环境。spark环境夹具将在下一节中扮演重要角色。</li><li id="c1e3" class="mo mp it lx b ly mz mb na li nb lm nc lq nd mn mv mw mx my bi translated"><strong class="lx iu">使用conftest.py — </strong>夹具可以重复使用和模块化。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用conftest.py创建一个测试</figcaption></figure><ul class=""><li id="fac0" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated"><strong class="lx iu">不使用conftest.py — </strong>数据框仅在当前测试中可用。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">不使用conftest.py创建测试</figcaption></figure></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><ul class=""><li id="4d4f" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated"><strong class="lx iu"> pytest.ini — </strong>本节的另一个重要文件是pytest.ini文件。这是Pytest命令行的配置文件。该配置可以用来减少Pytest命令的冗长性。例如，您可以隐藏显示在终端上的<strong class="lx iu">弃用警告</strong>,只关注测试结果。为了节省每次键入-p参数的时间，您可以在pytest.ini文件中使用下面的addopts行添加它。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">pytest.ini配置文件。</figcaption></figure><ul class=""><li id="550f" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated">我们也可以定义Pytest <a class="ae ky" href="https://docs.pytest.org/en/7.1.x/how-to/mark.html" rel="noopener ugc nofollow" target="_blank"> <strong class="lx iu">标记</strong> </a> <strong class="lx iu"> </strong>来将我们的测试用例归类到我们想要的类别中。最后，它使得基于定义的标记选择我们想要运行的测试用例变得更加容易。</li><li id="d0f7" class="mo mp it lx b ly mz mb na li nb lm nc lq nd mn mv mw mx my bi translated">例如，我们用语法@pytest.mark.pandas和@pytest.mark.spark标记下面的测试。如果添加自定义标记而没有在pytest.ini文件中定义它，它将抛出未知的标记错误，您可以通过添加标记定义来修复它，如上面的sample_pytest.ini示例。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">为每个测试用例添加Pytest标记。</figcaption></figure><ul class=""><li id="8974" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated">下面是我们向Pytest命令行输入可选的mark参数时的结果。当您向代码库添加新功能时，组织和测试部分测试用例是有益的。当你有很多测试用例时，测试的运行时间会更长。所以最好在开发过程中尝试运行其中的一些。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/54b44edd7bc53a5744a674487dfba92b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T7SMBcHnu_dRup3LmA8tXw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用可选的标记参数选择测试用例；作者的夹具。</figcaption></figure><ul class=""><li id="f214" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated">你可以在配置文件<a class="ae ky" href="https://docs.pytest.org/en/6.2.x/reference.html#ini-options-ref" rel="noopener ugc nofollow" target="_blank">这里</a>寻找更详细的选项。</li></ul></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h2 id="2e2d" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">3.加速pyspark应用程序的测试用例</h2><p id="3d41" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">在这一节中，我们将具体讨论我们测试pyspark应用程序的时间。通常，spark应用程序使用spark上下文来构建底层的一切。这一部分的细微差别是强调设置过程，并分解每个测试用例之间的spark上下文。</p><p id="e445" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">下一个fixture描述了从为所有测试传递一个spark上下文到每次运行测试套件时的设置和拆卸之间的运行时间。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/a51e69879de70f0941c0e4e3c492b6c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uvZog5UnH2qjwIs6zgpzeg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">我们比较了在conftest.py中传递火花和不传递火花时的性能；作者的夹具。</figcaption></figure><p id="ff08" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">你可以注意到下面两种方法在运行时间上的巨大差异。例如，一个用17秒完成30个测试用例，另一个用1:02分钟完成同样的30个测试用例。当您为更复杂的计算运行测试用例时，这个数字会迅速增长。</p><p id="7414" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">这是两个测试用例之间的区别。</p><p id="a93c" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">当我们完成每一次运行时，我们将在没有spark上下文的情况下设置和拆除spark上下文。这个过程导致了性能时间的瓶颈。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">在每个运行的测试用例中创建和删除spark上下文。</figcaption></figure><p id="aa06" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">另一方面，在下面的例子中，我们在会话范围中设置了spark上下文的fixture，并在不同的测试用例中重用它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">将spark上下文添加到测试用例中。</figcaption></figure><p id="bdaf" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">从我的经验来看，我开始编写pyspark单元测试时并不知道这种微妙的差异，我的测试套件几乎花了我30分钟才完成(我不知道当时我是如何等待它完成的)。</p><p id="2656" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">当我知道这个技巧并将spark上下文添加到我的每个测试中时，时间量大大减少了。最后的运行时间减少到8分钟左右。所以这让我印象深刻。</p><p id="aa70" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">此外，您可以添加spark配置来优化测试运行时间。如果你对这个话题感兴趣，可以查看一下<a class="ae ky" href="https://pypi.org/project/pytest-spark/" rel="noopener ugc nofollow" target="_blank"> Pytest-spark </a>插件。最后，有一些spark上下文配置可以帮助加速这个过程，并使您的开发工作流程变得更好。</p></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h2 id="35e2" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">4.将实际数据框与预期数据框进行比较。</h2><p id="fb20" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">本文的最后一部分着眼于如何比较实际数据帧和预期数据帧。这部分最初让我很恼火，因为比较pyspark数据帧完全是手动的，我们必须自己编写一个额外的函数来比较数据帧。</p><p id="4035" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">幸运的是，在网上彻底搜索后，我找到了一个很有帮助的包<a class="ae ky" href="https://github.com/MrPowers/chispa" rel="noopener ugc nofollow" target="_blank"><strong class="lx iu">【Chispa】</strong></a><strong class="lx iu"/>，它对比较两个spark数据帧很有帮助。因此，我将向你展示两种我认为足以胜任这项任务的方法。</p><p id="1b67" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">第一种方法是使用<a class="ae ky" href="https://pandas.pydata.org/docs/reference/api/pandas.testing.assert_frame_equal.html" rel="noopener ugc nofollow" target="_blank"> pandas.testing </a>模块。我已经在上面的部分向你展示了如何使用它。在处理熊猫数据框时，它更容易使用。但是，如果使用pandas测试模块和spark数据框，则需要使用toPandas方法转换spark数据框。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用pandas测试模块断言pandas数据帧。</figcaption></figure><p id="38fd" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">不幸的是，这种方法的缺陷是toPandas方法不能保证变换数据帧的顺序。相反，您必须根据某些列对值进行排序，并重置索引号以使其具有可比性。</p><p id="57ed" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">这是一个失败的测试案例的例子。你可以看到熊猫。测试模块在故障解释方面做得很好。我可以看到实际数据帧和预期数据帧的值是100%不同的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/69e7716de8dd6ed6828d0aea4b8176a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kU16W03Cnq4E7QDhmnrvLQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来自pandas.testing模块的失败结果；作者的夹具。</figcaption></figure><p id="1507" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">第二种方法是使用Chispa库。我们可以通过用assert_df_equality行替换pandas.testing模块来使用它。该方法将直接比较两个火花数据帧。与上一个不同，我们需要从Pandas数据框架转换到Spark数据框架。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用Chispa库断言spark数据帧。</figcaption></figure><p id="d6c0" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated">下图显示了Chispa在发现实际数据帧与预期数据帧不一致时如何返回错误。许多有用的可选参数可用于微调assert函数的行为，如忽略行顺序、忽略列顺序等。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/a14aaa9fbd0d768859cf43a04d98a43b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7HG_j8vTtzUgama01p10jQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来自Chispa库的失败结果；作者的夹具。</figcaption></figure></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h2 id="9bcb" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">最后的想法</h2><p id="36e6" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">瞧啊。那时，我花了很多时间来构建我的第一个测试用例。我希望以上技巧能够帮助您将测试模块集成到pyspark应用程序中。</p><h2 id="7b2a" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">帕泰鲁什·西达</h2><p id="2827" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated"><strong class="lx iu">如果你喜欢我的工作，想支持我，</strong> <a class="ae ky" href="https://padpathairush.medium.com/membership" rel="noopener"> <strong class="lx iu">成为会员</strong> </a></p><ul class=""><li id="a03b" class="mo mp it lx b ly mq mb mr li ms lm mt lq mu mn mv mw mx my bi translated">在<a class="ae ky" href="http://padpathairush.medium.com" rel="noopener">媒体</a>上跟随我</li><li id="e9e2" class="mo mp it lx b ly mz mb na li nb lm nc lq nd mn mv mw mx my bi translated">其他渠道？<a class="ae ky" href="https://www.linkedin.com/in/pathairush/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>，<a class="ae ky" href="https://twitter.com/data_products" rel="noopener ugc nofollow" target="_blank"> Twitter </a></li></ul><p id="9ac1" class="pw-post-body-paragraph lv lw it lx b ly mq ju ma mb mr jx md li ne mf mg lm nf mi mj lq ng ml mm mn im bi translated"><strong class="lx iu">你可能喜欢的东西！</strong></p><div class="of og gp gr oh oi"><a href="https://towardsdatascience.com/in-memory-data-quality-check-tutorial-with-great-expectation-54913b1c37fa" rel="noopener follow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd iu gy z fp on fr fs oo fu fw is bi translated">内存数据质量检查——充满期待的教程</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">将数据质量检查嵌入任何数据管道的实用代码片段</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">towardsdatascience.com</p></div></div><div class="or l"><div class="os l ot ou ov or ow ks oi"/></div></div></a></div><div class="of og gp gr oh oi"><a href="https://towardsdatascience.com/data-quality-check-for-your-data-analysis-tutorial-with-pandas-7ee96d7dc4b6" rel="noopener follow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd iu gy z fp on fr fs oo fu fw is bi translated">用于数据分析的数据质量检查—熊猫教程</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">用于检查数据质量的代码片段</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">towardsdatascience.com</p></div></div><div class="or l"><div class="ox l ot ou ov or ow ks oi"/></div></div></a></div></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h1 id="101c" class="oy la it bd lb oz pa pb le pc pd pe lh jz pf ka ll kc pg kd lp kf ph kg lt pi bi translated">分级编码</h1><p id="cb65" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">感谢您成为我们社区的一员！更多内容请参见<a class="ae ky" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>。<br/>跟随:<a class="ae ky" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a>，<a class="ae ky" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">领英</a>，<a class="ae ky" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">通迅</a> <br/> <strong class="lx iu">升一级正在改造理工大招聘➡️ </strong> <a class="ae ky" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="lx iu">加入我们的人才集体</strong> </a></p></div></div>    
</body>
</html>