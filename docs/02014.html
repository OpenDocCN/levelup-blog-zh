<html>
<head>
<title>Using Poetry with Serverless Framework to Deploy Python Lambda Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用诗歌和无服务器框架部署Python Lambda函数</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-poetry-with-serverless-framework-to-deploy-python-lambda-functions-8dd424727a03?source=collection_archive---------5-----------------------#2020-02-12">https://levelup.gitconnected.com/using-poetry-with-serverless-framework-to-deploy-python-lambda-functions-8dd424727a03?source=collection_archive---------5-----------------------#2020-02-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3c1529368e149173d388396798438001.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CJForZukkRe5S6pN"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kc" href="https://unsplash.com/@iamtru?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">信托“Tru”kat sande</a>拍摄的照片</figcaption></figure><p id="c422" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们正朝着使用诗歌进行依赖性管理和隔离我们的Python环境的方向发展，而不是使用pipenv。我们之前部署Lambda函数的设置涉及到pipenv和Zappa。由于我们正在重新审视这个设置，我发现自己正在努力在AWS Lambda上部署Python函数。这主要是因为在没有像Zappa或Serverless这样的框架的情况下，我试图按照<a class="ae kc" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html#python-package-venv" rel="noopener ugc nofollow" target="_blank"> AWS文档</a>为AWS Lambda手动打包和部署我的Python脚本(在一个诗歌虚拟环境中)。没有这些框架，我无法让它正常工作。</p><p id="588d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于如何使用<a class="ae kc" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>部署Python Lambda函数，已经有很多可用的指导方针，使用不同类型的依赖管理器和框架来隔离您的Python环境。现有的指南并没有真正涵盖将无服务器与诗歌结合使用的逐步说明，所以这就是我写这篇文章的原因，实际上它非常简单！</p><p id="1f5f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些步骤基于<a class="ae kc" href="https://serverless.com/blog/serverless-python-packaging/" rel="noopener ugc nofollow" target="_blank">这篇文章</a>，但是他们使用virtualenv隔离他们的Python环境。</p><h2 id="4240" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">先决条件</h2><ul class=""><li id="c901" class="lu lv iq kf b kg lw kk lx ko ly ks lz kw ma la mb mc md me bi translated">你已经安装了<a class="ae kc" href="https://python-poetry.org/" rel="noopener ugc nofollow" target="_blank">诗歌</a></li><li id="6483" class="lu lv iq kf b kg mf kk mg ko mh ks mi kw mj la mb mc md me bi translated">您已经安装了<a class="ae kc" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank"> Node.js </a></li><li id="187d" class="lu lv iq kf b kg mf kk mg ko mh ks mi kw mj la mb mc md me bi translated">您已经安装了<a class="ae kc" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> awscli </a>并用一个(默认的)概要文件对其进行了配置</li><li id="d154" class="lu lv iq kf b kg mf kk mg ko mh ks mi kw mj la mb mc md me bi translated">您已经全局安装了<a class="ae kc" href="https://serverless.com/framework/docs/getting-started/" rel="noopener ugc nofollow" target="_blank">无服务器</a>(我选择通过npm安装)</li><li id="e835" class="lu lv iq kf b kg mf kk mg ko mh ks mi kw mj la mb mc md me bi translated">您有一个想要部署到Lambda的项目或脚本(使用诗歌进行隔离并作为依赖项管理器)</li></ul><p id="9a23" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你还没有一个项目，并且你想编码，你可以创建一个新的文件夹，init poeties(<code class="fe mk ml mm mn b">poetry init</code>)在那个文件夹中，并添加我提到的文章中提供的<code class="fe mk ml mm mn b">handler.py</code>文件。您还想在您的环境中添加numpy作为依赖项(<code class="fe mk ml mm mn b">poetry add numpy==1.18.1</code>)。然后，您将得到如下所示的文件结构:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="f4e5" class="lb lc iq mn b gy mw mx l my mz">numpy-test/<br/>    handler.py<br/>    pyproject.toml</span></pre><h1 id="5634" class="na lc iq bd ld nb nc nd lg ne nf ng lj nh ni nj lm nk nl nm lp nn no np ls nq bi translated">添加serverless.yml</h1><p id="62d6" class="pw-post-body-paragraph kd ke iq kf b kg lw ki kj kk lx km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">要使用无服务器，您需要一个配置文件。该配置需要作为一个名为<code class="fe mk ml mm mn b">serverless.yml</code>的YAML文件提供，它需要存储在您的项目文件夹的根目录中。你可以在<a class="ae kc" href="https://serverless.com/framework/docs/providers/aws/guide/serverless.yml/" rel="noopener ugc nofollow" target="_blank">这里</a>找到所有可用的属性。</p><p id="f054" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您使用自己的Python项目或脚本，您应该根据自己的需要进行编辑。此外，这不应该在生产中使用，这只是为了说明如何使用最小配置设置Lambda。</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="b7d0" class="lb lc iq mn b gy mw mx l my mz"><em class="nu"># serverless.yml<br/><br/></em>service: numpy-test<br/><br/>provider:<br/>  name: aws<br/>  runtime: python3.6<br/><br/>functions:<br/>  numpy:<br/>    handler: handler.main<br/><br/>plugins:<br/>  - serverless-python-requirements<br/><br/>custom:<br/>  pythonRequirements:<br/>    dockerizePip: non-linux</span></pre><p id="6c5b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据您是否正在使用AWS概要文件，您还可以在这个YAML文件中提供一个概要文件。</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="bd80" class="lb lc iq mn b gy mw mx l my mz">provider:<br/>  ...<br/>  profile: PROFILENAMEHERE<br/>  ...</span></pre><h1 id="f6d9" class="na lc iq bd ld nb nc nd lg ne nf ng lj nh ni nj lm nk nl nm lp nn no np ls nq bi translated">初始化npm并安装python需求插件</h1><p id="d526" class="pw-post-body-paragraph kd ke iq kf b kg lw ki kj kk lx km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">无服务器是一个节点包，我们想在当前设置中安装<code class="fe mk ml mm mn b">serverless-python-requirements</code>插件。</p><p id="a46a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行项目文件夹根目录下的<code class="fe mk ml mm mn b">npm init</code>和<code class="fe mk ml mm mn b">npm install --save serverless-python-requirements</code>。然后，您将拥有以下结构:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="fd91" class="lb lc iq mn b gy mw mx l my mz">numpy-test/<br/>    node_modules/<br/>        ....<br/>    handler.py <br/>    package.json <br/>    package-lock.json <br/>    pyproject.toml</span></pre><h1 id="7917" class="na lc iq bd ld nb nc nd lg ne nf ng lj nh ni nj lm nk nl nm lp nn no np ls nq bi translated">将依赖项导出为requirements.txt</h1><p id="e2f5" class="pw-post-body-paragraph kd ke iq kf b kg lw ki kj kk lx km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">将项目依赖项导出为requirements.txt。如果不这样做，它会说<code class="fe mk ml mm mn b">Serverless: Generating requirements.txt from pyproject.toml</code>，但是由于某种原因，这不起作用，所以在部署之前导出需求应该可以做到。</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="cfd4" class="lb lc iq mn b gy mw mx l my mz">poetry export -f requirements.txt &gt; requirements.txt --without-hashes</span></pre><h1 id="eedd" class="na lc iq bd ld nb nc nd lg ne nf ng lj nh ni nj lm nk nl nm lp nn no np ls nq bi translated">展开Lambda</h1><p id="6f9b" class="pw-post-body-paragraph kd ke iq kf b kg lw ki kj kk lx km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">我们准备好部署Lambda功能了。在部署(<code class="fe mk ml mm mn b">poetry shell</code>)之前，确保您已经激活了正确的Python环境(项目的一个)。您也可以通过运行<code class="fe mk ml mm mn b">poetry run python handler.py</code>来测试功能。</p><p id="5991" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果工作正常，使用以下命令部署Lambda:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="e04f" class="lb lc iq mn b gy mw mx l my mz">serverless deploy</span></pre><p id="f6a5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将输出:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="06f5" class="lb lc iq mn b gy mw mx l my mz">numpy-test % serverless deploy                                   <br/>Serverless: Generating requirements.txt from pyproject.toml...<br/>Serverless: Parsed requirements.txt from pyproject.toml in numpy-test/.serverless/requirements.txt...<br/>Serverless: Using static cache of requirements found at serverless-python-requirements/80ac7cc0113af153aa922ca2df559693ec011f4167582c1a351d76f2527d265f_slspyc ...<br/>Serverless: Packaging service...<br/>Serverless: Excluding development dependencies...<br/>....</span></pre><h1 id="fb25" class="na lc iq bd ld nb nc nd lg ne nf ng lj nh ni nj lm nk nl nm lp nn no np ls nq bi translated">调用Lambda</h1><p id="2424" class="pw-post-body-paragraph kd ke iq kf b kg lw ki kj kk lx km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">然后，您可以使用以下命令调用部署的Lambda函数:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="ddbb" class="lb lc iq mn b gy mw mx l my mz">serverless invoke -f numpy --log</span></pre><p id="8d86" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将输出:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="16ea" class="lb lc iq mn b gy mw mx l my mz">numpy-test % serverless invoke -f numpy --log <br/>null <br/>-------------------------------------------------------------------- START RequestId: 82df6fa0-76ac-462c-a3f9-ab2935af9e33 Version: $LATEST <br/>Your numpy array: <br/>[[ 0  1  2  3  4]  <br/> [ 5  6  7  8  9]  <br/> [10 11 12 13 14]] <br/>END RequestId: 82df6fa0-76ac-462c-a3f9-ab2935af9e33 <br/>REPORT RequestId: 82df6fa0-76ac-462c-a3f9-ab2935af9e33  Duration: 2.32 ms       Billed Duration: 100 ms Memory Size: 1024 MB    Max Memory Used: 86 MB  Init Duration: 597.45 ms</span></pre><h1 id="fd95" class="na lc iq bd ld nb nc nd lg ne nf ng lj nh ni nj lm nk nl nm lp nn no np ls nq bi translated">搞定了。</h1><p id="ab00" class="pw-post-body-paragraph kd ke iq kf b kg lw ki kj kk lx km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">现在，您已经使用无服务器和诗歌部署了Python Lambda函数。如果您对本文有任何问题、建议或评论，请告诉我！</p><h1 id="02e5" class="na lc iq bd ld nb nc nd lg ne nf ng lj nh ni nj lm nk nl nm lp nn no np ls nq bi translated">2021年7月更新</h1><p id="14a2" class="pw-post-body-paragraph kd ke iq kf b kg lw ki kj kk lx km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">这篇文章写于2020年2月。与此同时，AWS Lambda也可以处理容器图像，我强烈建议结合Terraform来研究这一点。</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><h1 id="3f05" class="na lc iq bd ld nb oc nd lg ne od ng lj nh oe nj lm nk of nm lp nn og np ls nq bi translated">分级编码</h1><p id="a869" class="pw-post-body-paragraph kd ke iq kf b kg lw ki kj kk lx km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">感谢您成为我们社区的一员！<a class="ae kc" href="https://www.youtube.com/channel/UC3v9kBR_ab4UHXXdknz8Fbg?sub_confirmation=1" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅我们的YouTube频道</strong> </a>或者加入<a class="ae kc" href="https://skilled.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> Skilled.dev编码面试课程</strong> </a>。</p><div class="oh oi gp gr oj ok"><a href="https://skilled.dev" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">编写面试问题</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">掌握编码面试的过程</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">技术开发</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy jw ok"/></div></div></a></div></div></div>    
</body>
</html>