<html>
<head>
<title>Flutter Tutorial: Music Button Animation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">颤动教程:音乐按钮动画</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/flutter-tutorial-music-button-animation-744616b14501?source=collection_archive---------2-----------------------#2020-02-29">https://levelup.gitconnected.com/flutter-tutorial-music-button-animation-744616b14501?source=collection_archive---------2-----------------------#2020-02-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="fcbb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">今天，我们将探讨如何使用Flutter创建下面的音乐按钮动画，以及如何将其抽象为可重用的<code class="fe ko kp kq kr b">PlayButton</code>小部件。一个简单的好方法是使用令人敬畏的<a class="ae ks" href="https://dartpad.dev" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> dartpad.dev </strong> </a>让你在浏览器中运行flutter应用。让我们开始吧。</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="ky kz l"/></div></figure></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><p id="7975" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">其工作方式是将多个不同颜色的斑点堆叠在一起，并以一个包含按钮的白色圆圈结束。图标本身包含在一个<a class="ae ks" href="https://api.flutter.dev/flutter/widgets/AnimatedSwitcher-class.html" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">动画开关</strong> </a>小部件中，这个小部件可以在不同的小部件之间切换(默认为淡入淡出)，同时不需要控制器工作。</p><p id="522d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们将我们想要实现的目标分成3个步骤:</p><ol class=""><li id="6eec" class="lh li it js b jt ju jx jy kb lj kf lk kj ll kn lm ln lo lp bi translated">创建一个无状态的<code class="fe ko kp kq kr b">Blob</code>小部件</li><li id="90c4" class="lh li it js b jt lq jx lr kb ls kf lt kj lu kn lm ln lo lp bi translated">在一个<code class="fe ko kp kq kr b">Stack</code>中使用<code class="fe ko kp kq kr b">Blob</code>小部件，这个小部件被包装在我们主要的有状态<code class="fe ko kp kq kr b">PlayButton</code>小部件中</li><li id="e3d3" class="lh li it js b jt lq jx lr kb ls kf lt kj lu kn lm ln lo lp bi translated">使用多个<code class="fe ko kp kq kr b">AnimationController</code>添加缩放和旋转动画</li></ol><p id="52cc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们通过创建一个单独的blob来进入它。</p><h1 id="5dbb" class="lv lw it bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">Blob小部件</h1><p id="833a" class="pw-post-body-paragraph jq jr it js b jt mt jv jw jx mu jz ka kb mv kd ke kf mw kh ki kj mx kl km kn im bi translated">Blob将是一个无状态的小部件，并将接受<code class="fe ko kp kq kr b">color</code>，由于我们将在稍后的动画中旋转和缩放它，我们还将接受一个<strong class="js iu">旋转</strong>和一个<strong class="js iu">缩放</strong>值，它们将分别被提供给<code class="fe ko kp kq kr b">Transform.rotate</code>和<code class="fe ko kp kq kr b">Transform.scale</code>函数。</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="my kz l"/></div></figure><p id="47d0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建简单斑点的一种方法是使用<code class="fe ko kp kq kr b">borderRadius</code>属性，并在所有边上使用不均匀的值。一个很好的形象化的例子可以在<a class="ae ks" href="https://9elements.github.io/fancy-border-radius/" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="cea8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们使用我们在新的Flutter应用程序中定义的Blob。</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="my kz l"/></div></figure><p id="b70c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">结果是屏幕上出现一个蓝色的斑点。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/7821c46455e3c4387113ac6bcf1d7c9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DXDEq13psUIDNcAVR_Qd_g.png"/></div></div></figure><p id="4e8e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">学习了如何创建一个blob，我们现在将专注于创建我们的主<code class="fe ko kp kq kr b">PlayButton</code>小部件，我们将把blob堆叠在彼此之上，并包含所有的逻辑。</p><h1 id="ded5" class="lv lw it bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">播放按钮部件</h1><p id="ca57" class="pw-post-body-paragraph jq jr it js b jt mt jv jw jx mu jz ka kb mv kd ke kf mw kh ki kj mx kl km kn im bi translated">这是我们动画的核心部件，将包含按钮和动画状态，因此，必须扩展<code class="fe ko kp kq kr b">StatefulWidget</code>。</p><p id="cde7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ko kp kq kr b">PlayButton</code>小部件本身将接受</p><ol class=""><li id="658d" class="lh li it js b jt ju jx jy kb lj kf lk kj ll kn lm ln lo lp bi translated"><code class="fe ko kp kq kr b">initialIsPlaying</code>无论按钮最初是否正在播放，从外部对其的进一步更改<code class="fe ko kp kq kr b">setState</code>都不会影响我们的按钮</li><li id="e2cb" class="lh li it js b jt lq jx lr kb ls kf lt kj lu kn lm ln lo lp bi translated">按钮播放/暂停时使用的<code class="fe ko kp kq kr b">playIcon</code>、<code class="fe ko kp kq kr b">pauseIcon</code>图标(默认为Flutter自带的<code class="fe ko kp kq kr b">Icons.play_arrow</code> / <code class="fe ko kp kq kr b">Icons.pause</code>)</li><li id="d2fa" class="lh li it js b jt lq jx lr kb ls kf lt kj lu kn lm ln lo lp bi translated"><code class="fe ko kp kq kr b">onPressed</code> ( <strong class="js iu"> <em class="ng">必选</em> </strong>)回调通知用户状态变化</li></ol><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="my kz l"/></div></figure><p id="6578" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们来剖析一下上面代码的<code class="fe ko kp kq kr b">_PlayButtonState</code>部分。首先，我们定义我们的状态为:a <code class="fe ko kp kq kr b">bool isPlaying</code>跟踪按钮播放/暂停，第二部分是应用于我们的<code class="fe ko kp kq kr b">Blob</code>的<code class="fe ko kp kq kr b">rotation</code>和<code class="fe ko kp kq kr b">scale</code>值。稍后，我们将制作这些<strong class="js iu">旋转</strong>和<strong class="js iu">缩放</strong>值的动画。</p><p id="ca39" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ko kp kq kr b">build</code>方法使用一个<code class="fe ko kp kq kr b">ConstrainedBox </code>来约束我们的按钮的最小高度和宽度，这些约束将让我们的按钮扩展到其父级的大小。继续往下，这是我们创建Blob小部件的<code class="fe ko kp kq kr b">Stack</code>的地方，每个小部件都有不同的旋转乘数，以显示不同的速度和轻微的偏移，以防止开始时完全重叠。<code class="fe ko kp kq kr b">Stack</code>的最后一个子元素是我们实际的圆形按钮。</p><p id="9c6d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ko kp kq kr b">_onToggle</code>方法是我们更新状态以反映按钮按下的地方。</p><p id="384f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们将替换我们的应用程序主体<code class="fe ko kp kq kr b">Blob</code>来使用下面的<code class="fe ko kp kq kr b">PlayButton</code>小部件，并查看结果。</p><pre class="kt ku kv kw gt nh kr ni nj aw nk bi"><span id="dfab" class="nl lw it kr b gy nm nn l no np">PlayButton(<br/> pauseIcon: Icon(Icons.pause, color: Colors.black, size: 90),<br/> playIcon: Icon(Icons.play_arrow, color: Colors.black, size: 90),<br/> onPressed: () {},<br/>),</span></pre><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="nq kz l"/></div></figure><p id="edeb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们缺少的只是动画。太好了！好戏开始了。</p><h1 id="1b2e" class="lv lw it bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">动画</h1><p id="6d3d" class="pw-post-body-paragraph jq jr it js b jt mt jv jw jx mu jz ka kb mv kd ke kf mw kh ki kj mx kl km kn im bi translated">除了使用内置的<a class="ae ks" href="https://flutter.dev/docs/development/ui/animations/implicit-animations" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">隐式动画</strong> </a> <strong class="js iu"> </strong>之外，在flutter中添加动画的基本模式是首先创建一个<code class="fe ko kp kq kr b">AnimationController</code>，它需要<code class="fe ko kp kq kr b">SingleTickerProviderStateMixin</code> mixin ( <code class="fe ko kp kq kr b">TickerProviderStateMixin</code>用于使用多个控制器)、<code class="fe ko kp kq kr b">addListener</code>来对有状态小部件执行<code class="fe ko kp kq kr b">setState</code>操作，从而导致重建。</p><p id="9717" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们想要的两个动画是:</p><ol class=""><li id="9497" class="lh li it js b jt ju jx jy kb lj kf lk kj ll kn lm ln lo lp bi translated">斑点可见时的无限旋转</li><li id="5ee2" class="lh li it js b jt lq jx lr kb ls kf lt kj lu kn lm ln lo lp bi translated">按钮按下时发生的音阶转换(向内和向外)</li></ol><p id="81af" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于我们已经定义了两个<code class="fe ko kp kq kr b">double</code>值— <strong class="js iu">旋转</strong>和<strong class="js iu">缩放</strong>，我们将使用两个<code class="fe ko kp kq kr b">AnimationController</code>来更新它们。我们需要两个控制器，因为旋转动画的运行独立于仅在<code class="fe ko kp kq kr b">_onToggle</code>期间发生的缩放过渡。</p><p id="4c55" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们从向有状态小部件添加两个AnimationControllers开始，我们还将添加一些持续时间为两个的常量——每个控制器一个。我们将它们标记为<code class="fe ko kp kq kr b">static const</code>，因为它们从不改变。</p><pre class="kt ku kv kw gt nh kr ni nj aw nk bi"><span id="edde" class="nl lw it kr b gy nm nn l no np">static const _kToggleDuration = Duration(milliseconds: 300);    static const _kRotationDuration = Duration(seconds: 5);</span><span id="6204" class="nl lw it kr b gy nr nn l no np">// rotation and scale animations  <br/>AnimationController _rotationController;  <br/>AnimationController _scaleController;</span></pre><p id="cf91" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们需要用<code class="fe ko kp kq kr b">initState</code>方法初始化控制器。由于<strong class="js iu">旋转</strong>无限期运行，我们将在<code class="fe ko kp kq kr b">_rotationController</code>上使用<code class="fe ko kp kq kr b">repeat</code>方法，这也将立即开始我们的动画。<code class="fe ko kp kq kr b">_scaleController</code>与此类似，但只会在按下按钮时运行。</p><pre class="kt ku kv kw gt nh kr ni nj aw nk bi"><span id="01b9" class="nl lw it kr b gy nm nn l no np">@override<br/>void initState() {</span><span id="47f3" class="nl lw it kr b gy nr nn l no np">_rotationController = AnimationController(vsync: this, <br/>duration: _kRotationDuration)<br/> ..addListener(() =&gt; setState(_updateRotation))<br/> ..repeat();     </span><span id="171e" class="nl lw it kr b gy nr nn l no np">_scaleController = AnimationController(vsync: this,                                                                                                                                                                                                                  duration: _kToggleDuration)           <br/> ..addListener(() =&gt; setState(_updateScale));<br/> <br/>super.initState();</span><span id="adc3" class="nl lw it kr b gy nr nn l no np">}</span></pre><p id="4ed4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们在小部件上定义一些辅助方法来更新我们的<strong class="js iu">旋转</strong>和<strong class="js iu">缩放。</strong>基本上，我们是在映射0..1我们的控制器的默认范围到我们的属性想要的范围。</p><pre class="kt ku kv kw gt nh kr ni nj aw nk bi"><span id="2668" class="nl lw it kr b gy nm nn l no np">void _updateRotation() =&gt; _rotation = _rotationController.value * 2 * pi;  </span><span id="ae8b" class="nl lw it kr b gy nr nn l no np">void _updateScale() =&gt; _scale = (_scaleController.value * 0.2) + 0.85;</span></pre><p id="1a05" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">旋转现在应该可以独立运行了。现在剩下唯一要做的就是在<code class="fe ko kp kq kr b">_onToggle</code>内触发尺度转换。让我们更新一下，在点击按钮时开始播放动画，如果已经播放了，就反转播放。</p><pre class="kt ku kv kw gt nh kr ni nj aw nk bi"><span id="cc0f" class="nl lw it kr b gy nm nn l no np">void _onToggle() {<br/>    setState(() =&gt; isPlaying = !isPlaying);</span><span id="fcb8" class="nl lw it kr b gy nr nn l no np">    if (_scaleController.isCompleted) {<br/>      _scaleController.reverse();<br/>    } else {<br/>      _scaleController.forward();<br/>    }<br/>    <br/>    widget.onPressed();<br/>  }</span></pre><p id="0b72" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">瞧啊。</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="ky kz l"/></div></figure><p id="ffd9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我希望你能从这个例子中有所收获，如果你有任何问题，请随时提问。你可以使用<a class="ae ks" href="https://dartpad.dev" rel="noopener ugc nofollow" target="_blank"> dartpad.dev </a>在这里 摆弄这个例子<a class="ae ks" href="http://bde67e8d1a295bbf4506ff3863addbab" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">。我跳过了图标淡入淡出过渡部分，但这只是一个简单的例子。</strong></a></p><p id="ee7a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Flutter有一个非常强大的反应式动画系统，可以用来构建精致的ui。这是整个示例的最终代码。</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="my kz l"/></div></figure><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/6eef2024e52bc42c31c78c4f898e97f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:880/format:webp/1*Z6-aDJep86lH7VIHsAlk4Q.png"/></div></figure></div></div>    
</body>
</html>