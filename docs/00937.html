<html>
<head>
<title>How to Add File Upload to Your GraphQL API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将文件上传添加到您的GraphQL API</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-add-file-upload-to-your-graphql-api-34d51e341f38?source=collection_archive---------0-----------------------#2019-09-24">https://levelup.gitconnected.com/how-to-add-file-upload-to-your-graphql-api-34d51e341f38?source=collection_archive---------0-----------------------#2019-09-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/d260de310511a513ea27f48f611f3a9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pqgNvJ9IvIRfjQejksPoug.png"/></div></div></figure><p id="5f61" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">GraphQL是一种由脸书开发的API查询语言，用于向服务器发送/接收数据。它使用自己的查询语法，但仍然通过HTTP发送数据，并且只使用一个端点来发送数据(通常是<code class="fe kz la lb lc b">POST</code> <code class="fe kz la lb lc b">/graphql</code>)。使用GraphQL的好处包括为发送的数据字段指定数据类型，并且可以指定返回的数据字段的类型。语法简单易懂。数据仍然以JSON的形式返回，以便于访问和操作。由于这些特性，开发人员迅速采用GraphQL来构建他们的API。</p><p id="4ab3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">文件上传是GraphQL最近通过库增加的功能。除了发送文本数据，它还允许我们直接用GraphQL APIs上传文件。它对许多应用程序非常有用，扩展了GraphQL的用例，使之包括任何需要文件上传和操作的内容。</p><p id="790a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">GraphQL请求仍然是HTTP请求。但是，您总是通过一个端点发送和接收数据。通常，这是<code class="fe kz la lb lc b">graphql</code>端点。所有请求都是POST请求，无论您是获取、操作还是删除数据。为了区分获取和操作数据，GraphQL请求可以分为“查询”和“突变”。以下是GraphQL请求的一个示例:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="bfc4" class="ll lm it lc b gy ln lo l lp lq">{<br/>  getPhotos(page: 1) {<br/>    photos {<br/>      id<br/>      fileLocation<br/>      description<br/>      tags<br/>    }<br/>    page<br/>    totalPhotos<br/>  }<br/>}</span></pre><p id="dd14" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">通过这个请求，我们指示服务器调用<code class="fe kz la lb lc b">getPhotos</code>解析器，这个函数将返回参数<code class="fe kz la lb lc b">page</code>设置为1的数据，然后我们想要取回<code class="fe kz la lb lc b">photos</code>数组的<code class="fe kz la lb lc b">id</code>、<code class="fe kz la lb lc b">fileLocation</code>、<code class="fe kz la lb lc b">description</code>和<code class="fe kz la lb lc b">tags</code>字段，还想要得到<code class="fe kz la lb lc b">page</code>和<code class="fe kz la lb lc b">totalPhotos</code>字段。</p><p id="415a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">GraphQL APIs可以使用任何数据库系统，因为它只改变了API层。底层的逻辑仍然和REST API一样。</p><p id="f116" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Node.js with Express对制作GraphQL APIs有很大的支持。我们可以使用<code class="fe kz la lb lc b">express-graphql</code>库来构建我们的GraphQL API。它是一个中间件，允许您在快速后端应用程序中获得GraphQL功能。</p><h1 id="0a1f" class="lr lm it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">构建后端</h1><p id="3ac3" class="pw-post-body-paragraph kb kc it kd b ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky im bi translated">我们将使用GraphQL API构建一个图库应用程序，该应用程序使用Express和一个使用带角度材料的材料设计的角度前端来接受文件上传以及一些文本数据。我们从图片库应用的后端部分开始。</p><p id="19bf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了开始构建应用程序，我们创建一个新的项目文件夹，其中包含一个<code class="fe kz la lb lc b">backend</code>文件夹来存储后端文件。然后我们进入文件夹并运行<code class="fe kz la lb lc b">npx express-generator</code>来为应用程序生成文件。</p><p id="c03d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">之后，我们需要安装一些文件，让我们在应用程序中使用JavaScript的最新功能。首先，我们为运行<code class="fe kz la lb lc b">npm i</code>生成的框架应用程序安装软件包。然后我们运行<code class="fe kz la lb lc b">npm i @babel/cli @babel/core @babel/node @babel/preset-env</code>来安装最新的Babel包，将最新的JavaScript特性加入到我们的应用中。接下来，我们需要在全球范围内安装<code class="fe kz la lb lc b">nodemon</code>,让我们在开发过程中随着代码文件的变化自动重启应用程序。在后端应用程序的项目文件夹的根级别中创建一个名为<code class="fe kz la lb lc b">.babelrc</code>的文件，并添加以下内容:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="b8fc" class="ll lm it lc b gy ln lo l lp lq">{<br/>    "presets": [<br/>        "<a class="ae mt" href="http://twitter.com/babel/preset-env" rel="noopener ugc nofollow" target="_blank">@babel/preset-env</a>"<br/>    ],</span><span id="2d62" class="ll lm it lc b gy mu lo l lp lq">}</span></pre><p id="29b8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后在<code class="fe kz la lb lc b">package.json</code>的<code class="fe kz la lb lc b">scripts</code>部分，我们放入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="c1d0" class="ll lm it lc b gy ln lo l lp lq">"babel-node": "babel-node",<br/>"start": "nodemon --exec npm run babel-node -- ./bin/www"</span></pre><p id="91c0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这使得我们可以用最新的JavaScript特性运行我们的应用程序。如果您得到错误，卸载以前版本的Babel CLI和Babel核心软件包，并再次尝试上述步骤。<code class="fe kz la lb lc b">./bin/www</code>是后端app的入口。</p><p id="d581" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，我们需要使用Sequelize CLI将初始ORM代码添加到我们的后端应用程序中。为此，我们运行<code class="fe kz la lb lc b">npx sequelize-cli init</code>将ORM代码添加到我们的应用程序中。您应该已经创建了<code class="fe kz la lb lc b">config/config.json</code>和<code class="fe kz la lb lc b">models</code>文件夹。然后我们运行<code class="fe kz la lb lc b">npm i sequelize</code>来安装Sequelize库。</p><p id="d76a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后，我们可以通过运行以下命令来构建我们的模型:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="7c91" class="ll lm it lc b gy ln lo l lp lq">npx sequelize-cli model:generate --name Photo --attributes fileLocation:string,description:string,tags:string</span></pre><p id="b94d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当我们运行使用该命令创建的迁移时，这将在我们的数据库中创建<code class="fe kz la lb lc b">Photo</code>模型和<code class="fe kz la lb lc b">Photos</code>表。现在我们将<code class="fe kz la lb lc b">config.json</code>重命名为<code class="fe kz la lb lc b">config.js</code>，并通过运行<code class="fe kz la lb lc b">npm i pg pg-hstore</code>安装<code class="fe kz la lb lc b">dotenv</code>和Postgres包。</p><p id="06a1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后在<code class="fe kz la lb lc b">config/config.js</code>中，我们放入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="3ace" class="ll lm it lc b gy ln lo l lp lq">require('dotenv').config();<br/>const dbHost = process.env.DB_HOST;<br/>const dbName = process.env.DB_NAME;<br/>const dbUsername = process.env.DB_USERNAME;<br/>const dbPassword = process.env.DB_PASSWORD;<br/>const dbPort = process.env.DB_PORT || 5432;</span><span id="fd46" class="ll lm it lc b gy mu lo l lp lq">module.exports = {<br/>    development: {<br/>        username: dbUsername,<br/>        password: dbPassword,<br/>        database: dbName,<br/>        host: dbHost,<br/>        port: dbPort,<br/>        dialect: 'postgres'<br/>    },<br/>    test: {<br/>        username: dbUsername,<br/>        password: dbPassword,<br/>        database: 'graphql_app_test',<br/>        host: dbHost,<br/>        port: dbPort,<br/>        dialect: 'postgres'<br/>    },<br/>    production: {<br/>        use_env_variable: 'DATABASE_URL',<br/>        username: dbUsername,<br/>        password: dbPassword,<br/>        database: dbName,<br/>        host: dbHost,<br/>        port: dbPort,<br/>        dialect: 'postgres'<br/>    }<br/>};</span></pre><p id="285c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这让我们可以从后端应用程序项目文件夹的根目录中创建的<code class="fe kz la lb lc b">.env</code>文件中获取数据库凭证和名称。在运行迁移之前，我们必须创建一个空数据库。使用您选择的名称创建一个空数据库，并在<code class="fe kz la lb lc b">.env</code>文件中设置值<code class="fe kz la lb lc b">DB_NAME</code>键的名称，并使用数据库密码进行同样的操作。</p><p id="2a75" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们有了运行迁移的一切。我们通过执行<code class="fe kz la lb lc b">npx sequelize-cli db:migrate</code>来运行它。您应该有一个包含照片表的空表。</p><p id="5d32" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，我们创建<code class="fe kz la lb lc b">files</code>文件夹，并将一个空的<code class="fe kz la lb lc b">.gitkeep</code>文件放入其中，这样我们就可以提交它了。</p><p id="93e1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">建立数据库连接后，我们可以开始构建逻辑。因为我们正在构建一个GraphQL API，所以我们需要为Express安装GraphQL库。为此，我们运行<code class="fe kz la lb lc b">npm i cors express-graphql graphql graphql-tools graphql-upload</code>。我们需要<code class="fe kz la lb lc b">cors</code>库，这样我们就可以与我们的前端应用程序进行通信，这将在不同的领域托管。其他的是GraphQL库。<code class="fe kz la lb lc b">graphql-upload</code>将允许我们在GraphQL端点中轻松接受文件。您可以直接传入一个JavaScript文件对象，在转换成读流后，它可以保存到磁盘。</p><p id="b91d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">安装完库之后，我们需要为我们的应用程序编写逻辑。我们在后端应用程序的根文件夹中创建了一个名为<code class="fe kz la lb lc b">graphql</code>的文件夹，其中包含了应用程序的逻辑文件。接下来，我们创建一个名为<code class="fe kz la lb lc b">resolvers.js</code>的文件，并添加以下内容:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="b271" class="ll lm it lc b gy ln lo l lp lq">const Op = require('sequelize').Op;</span><span id="88ae" class="ll lm it lc b gy mu lo l lp lq">const models = require('../models');<br/>const fs = require('fs');</span><span id="80e5" class="ll lm it lc b gy mu lo l lp lq">const storeFS = ({ stream, filename }) =&gt; {<br/>    const uploadDir = '../backend/photos';<br/>    const path = `${uploadDir}/${filename}`;<br/>    return new Promise((resolve, reject) =&gt;<br/>        stream<br/>            .on('error', error =&gt; {<br/>                if (stream.truncated)<br/>                    // delete the truncated file<br/>                    fs.unlinkSync(path);<br/>                reject(error);<br/>            })<br/>            .pipe(fs.createWriteStream(path))<br/>            .on('error', error =&gt; reject(error))<br/>            .on('finish', () =&gt; resolve({ path }))<br/>    );<br/>}</span><span id="1a03" class="ll lm it lc b gy mu lo l lp lq">export const getPhotos = async (args) =&gt; {<br/>    const page = args.page;<br/>    const photos = await models.Photo.findAll({<br/>        offset: (page - 1) * 10,<br/>        limit: 10<br/>    });<br/>    const totalPhotos = await models.Photo.count();<br/>    return {<br/>        photos,<br/>        page,<br/>        totalPhotos<br/>    };<br/>}</span><span id="6881" class="ll lm it lc b gy mu lo l lp lq">export const addPhoto = async (args) =&gt; {<br/>    const { description, tags } = args;<br/>    const { filename, mimetype, createReadStream } = await args.file;<br/>    const stream = createReadStream();<br/>    const pathObj = await storeFS({ stream, filename });<br/>    const fileLocation = pathObj.path;<br/>    const photo = await models.Photo.create({<br/>        fileLocation,<br/>        description,<br/>        tags<br/>    })<br/>    return photo;<br/>}</span><span id="b09c" class="ll lm it lc b gy mu lo l lp lq">export const editPhoto = async (args) =&gt; {<br/>    const { id, description, tags } = args;<br/>    const { filename, mimetype, createReadStream } = await args.file;<br/>    const stream = createReadStream();<br/>    const pathObj = await storeFS({ stream, filename });<br/>    const fileLocation = pathObj.path;<br/>    const photo = await models.Photo.update({<br/>        fileLocation,<br/>        description,<br/>        tags<br/>    }, {<br/>            where: {<br/>                id<br/>            }<br/>        })<br/>    return photo;<br/>}</span><span id="b321" class="ll lm it lc b gy mu lo l lp lq">export const deletePhoto = async (args) =&gt; {<br/>    const { id } = args;<br/>    await models.Photo.destroy({<br/>        where: {<br/>            id<br/>        }<br/>    })<br/>    return id;<br/>}</span><span id="f528" class="ll lm it lc b gy mu lo l lp lq">export const searchPhotos = async (args) =&gt; {<br/>    const searchQuery = args.searchQuery;<br/>    const photos = await models.Photo.findAll({<br/>        where: {<br/>            [Op.or]: [<br/>                {<br/>                    description: {<br/>                        [Op.like]: `%${searchQuery}%`<br/>                    }<br/>                },<br/>                {<br/>                    tags: {<br/>                        [Op.like]: `%${searchQuery}%`<br/>                    }<br/>                }<br/>            ]<br/>        }</span><span id="6bdd" class="ll lm it lc b gy mu lo l lp lq">});<br/>    const totalPhotos = await models.Photo.count();<br/>    return {<br/>        photos,<br/>        totalPhotos<br/>    };<br/>}</span></pre><p id="b04e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在上面的代码中，我们有GraphQL请求最终指向的解析器。我们有通过接受文件及其描述和标签字符串来添加照片的解析器。<code class="fe kz la lb lc b">edit</code>端点与此类似，只是它也接受一个整数ID，并允许用户保存他们的照片。<code class="fe kz la lb lc b">delete</code>解析器获取一个ID，让人们删除他们的照片表条目。注意，请求的所有参数都在<code class="fe kz la lb lc b">args</code>参数中。</p><p id="3ea2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们上传的文件最终作为承诺出现在<code class="fe kz la lb lc b">args</code>对象中。我们可以很容易地获取它，将其转换成流，并像使用<code class="fe kz la lb lc b">storeFS</code>函数那样保存它。我们承诺轻松保存数据，然后将文本数据顺序保存到数据库中。</p><p id="8b40" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe kz la lb lc b">searchPhotos</code>解析器获取搜索查询的字符串，然后使用以下对象在数据库中执行<code class="fe kz la lb lc b">where</code>or查询:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="b8e9" class="ll lm it lc b gy ln lo l lp lq">where: {<br/>   [Op.or]: [<br/>     {<br/>       description: {<br/>         [Op.like]: `%${searchQuery}%`<br/>       }<br/>     },<br/>     {<br/>      tags: {<br/>          [Op.like]: `%${searchQuery}%`<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="2b98" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将在描述和标签列中搜索搜索查询。</p><p id="40a6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，我们在<code class="fe kz la lb lc b">graphql</code>文件夹中创建一个名为<code class="fe kz la lb lc b">schema.js</code>的文件，并添加以下内容:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="9baf" class="ll lm it lc b gy ln lo l lp lq">const { buildSchema } = require('graphql');</span><span id="ed82" class="ll lm it lc b gy mu lo l lp lq">export const schema = buildSchema( `<br/>    scalar Upload</span><span id="88b5" class="ll lm it lc b gy mu lo l lp lq">type Photo {<br/>        id: Int,<br/>        fileLocation: String,<br/>        description: String,<br/>        tags: String<br/>    }</span><span id="174e" class="ll lm it lc b gy mu lo l lp lq">type PhotoData {<br/>        photos: [Photo],<br/>        page: Int,<br/>        totalPhotos: Int<br/>    }</span><span id="3042" class="ll lm it lc b gy mu lo l lp lq">type Query {<br/>        getPhotos(page: Int): PhotoData,<br/>        searchPhotos(searchQuery: String): PhotoData<br/>    }</span><span id="f4ab" class="ll lm it lc b gy mu lo l lp lq">type Mutation {<br/>        addPhoto(file: Upload!, description: String, tags: String): Photo<br/>        editPhoto(id: Int, file: Upload!, description: String, tags: String): Photo<br/>        deletePhoto(id: Int): Int<br/>    }<br/>`);</span></pre><p id="e3ca" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们为我们的查询和突变定义数据类型。注意，我们还在文件中定义了一个名为<code class="fe kz la lb lc b">Upload</code>的新标量类型，使我们能够通过<code class="fe kz la lb lc b">graphql-upload</code>库获取文件数据。类型<code class="fe kz la lb lc b">Query</code>包括所有的查询，冒号左边的代码是解析器的函数签名，右边是它返回的数据类型。</p><p id="6adb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">类型<code class="fe kz la lb lc b">Photo</code>和<code class="fe kz la lb lc b">PhotoData</code>是我们通过添加标量类型的字段定义的类型。<code class="fe kz la lb lc b">Int</code>和<code class="fe kz la lb lc b">String</code>是<code class="fe kz la lb lc b">express-graphql</code>包中包含的基本类型。任何带有感叹号的内容都是必需的。<code class="fe kz la lb lc b">buildSchema</code>函数构建我们将与Express GraphQL中间件一起使用的模式。<code class="fe kz la lb lc b">getPhotos</code>和<code class="fe kz la lb lc b">searchPhotos</code>是查询端点。<code class="fe kz la lb lc b">addPhoto</code>、<code class="fe kz la lb lc b">editPhoto</code>和<code class="fe kz la lb lc b">deletePhoto</code>。我们在请求中调用这些端点，就像我们在故事开始的例子中所做的那样。</p><p id="c125" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来在<code class="fe kz la lb lc b">app.js</code>中，我们输入以下内容:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="2d92" class="ll lm it lc b gy ln lo l lp lq">const createError = require('http-errors');<br/>const express = require('express');<br/>const path = require('path');<br/>const cookieParser = require('cookie-parser');<br/>const logger = require('morgan');<br/>const expressGraphql = require('express-graphql');<br/>const cors = require('cors');<br/>const app = express();<br/>import { GraphQLUpload } from 'graphql-upload'<br/>import { schema } from './graphql/schema'<br/>import {<br/>  getPhotos,<br/>  addPhoto,<br/>  editPhoto,<br/>  deletePhoto,<br/>  searchPhotos<br/>} from './graphql/resolvers'<br/>import { graphqlUploadExpress } from 'graphql-upload'</span><span id="b699" class="ll lm it lc b gy mu lo l lp lq">const root = {<br/>  Upload: GraphQLUpload,<br/>  getPhotos,<br/>  addPhoto,<br/>  editPhoto,<br/>  deletePhoto,<br/>  searchPhotos<br/>}</span><span id="ce18" class="ll lm it lc b gy mu lo l lp lq">// view engine setup<br/>app.set('views', path.join(__dirname, 'views'));<br/>app.set('view engine', 'jade');<br/>app.use(cors());<br/>app.use(logger('dev'));<br/>app.use(express.json());<br/>app.use(express.urlencoded({ extended: false }));<br/>app.use(cookieParser());<br/>app.use(express.static(path.join(__dirname, 'public')));<br/>app.use('/photos', express.static(path.join(__dirname, 'photos')));</span><span id="74b0" class="ll lm it lc b gy mu lo l lp lq">app.use(<br/>  '/graphql',<br/>  graphqlUploadExpress({ maxFileSize: 10000000, maxFiles: 10 }),<br/>  expressGraphql({<br/>    schema,<br/>    rootValue: root,<br/>    graphiql: true<br/>  })<br/>)</span><span id="c625" class="ll lm it lc b gy mu lo l lp lq">// catch 404 and forward to error handler<br/>app.use(function (req, res, next) {<br/>  next(createError(404));<br/>});</span><span id="701e" class="ll lm it lc b gy mu lo l lp lq">// error handler<br/>app.use(function (err, req, res, next) {<br/>  // set locals, only providing error in development<br/>  res.locals.message = err.message;<br/>  res.locals.error = req.app.get('env') === 'development' ? err : {};</span><span id="9318" class="ll lm it lc b gy mu lo l lp lq">// render the error page<br/>  res.status(err.status || 500);<br/>  res.render('error');<br/>});</span><span id="93c4" class="ll lm it lc b gy mu lo l lp lq">module.exports = app;</span></pre><p id="838b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们包含了用于跨域通信的CORS中间件，我们拥有的唯一端点是<code class="fe kz la lb lc b">/graphql</code>端点。我们在参数中有<code class="fe kz la lb lc b">graphqlUploadExpress({ maxFileSize: 10000000, maxFiles: 10 })</code>来启用文件上传，我们有:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="5596" class="ll lm it lc b gy ln lo l lp lq">const root = {<br/>  Upload: GraphQLUpload,<br/>  getPhotos,<br/>  addPhoto,<br/>  editPhoto,<br/>  deletePhoto,<br/>  searchPhotos<br/>}</span></pre><p id="57aa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">和</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="bb3b" class="ll lm it lc b gy ln lo l lp lq">expressGraphql({<br/>  schema,<br/>  rootValue: root,<br/>  graphiql: true<br/>})</span></pre><p id="a0df" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将模式和解析器连接在一起，并启用我们的GraphQL端点。<code class="fe kz la lb lc b">graphiql: true</code>启用一个交互式沙箱，我们可以在其中测试我们的GraphQL请求。</p><p id="7f70" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后，在<code class="fe kz la lb lc b">bin/www</code>中，我们有:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="b863" class="ll lm it lc b gy ln lo l lp lq">#!/usr/bin/env node<br/>require('dotenv').config();<br/>/**<br/> * Module dependencies.<br/> */</span><span id="2901" class="ll lm it lc b gy mu lo l lp lq">var app = require('../app');<br/>var debug = require('debug')('backend:server');<br/>var http = require('http');</span><span id="987a" class="ll lm it lc b gy mu lo l lp lq">/**<br/> * Get port from environment and store in Express.<br/> */</span><span id="5421" class="ll lm it lc b gy mu lo l lp lq">var port = normalizePort(process.env.PORT || '3000');<br/>app.set('port', port);</span><span id="bc0c" class="ll lm it lc b gy mu lo l lp lq">/**<br/> * Create HTTP server.<br/> */</span><span id="0dd1" class="ll lm it lc b gy mu lo l lp lq">var server = http.createServer(app);</span><span id="2229" class="ll lm it lc b gy mu lo l lp lq">/**<br/> * Listen on provided port, on all network interfaces.<br/> */</span><span id="5cc3" class="ll lm it lc b gy mu lo l lp lq">server.listen(port);<br/>server.on('error', onError);<br/>server.on('listening', onListening);</span><span id="b22f" class="ll lm it lc b gy mu lo l lp lq">/**<br/> * Normalize a port into a number, string, or false.<br/> */</span><span id="374b" class="ll lm it lc b gy mu lo l lp lq">function normalizePort(val) {<br/>  var port = parseInt(val, 10);</span><span id="899a" class="ll lm it lc b gy mu lo l lp lq">if (isNaN(port)) {<br/>    // named pipe<br/>    return val;<br/>  }</span><span id="157a" class="ll lm it lc b gy mu lo l lp lq">if (port &gt;= 0) {<br/>    // port number<br/>    return port;<br/>  }</span><span id="4e35" class="ll lm it lc b gy mu lo l lp lq">return false;<br/>}</span><span id="d0ea" class="ll lm it lc b gy mu lo l lp lq">/**<br/> * Event listener for HTTP server "error" event.<br/> */</span><span id="5576" class="ll lm it lc b gy mu lo l lp lq">function onError(error) {<br/>  if (error.syscall !== 'listen') {<br/>    throw error;<br/>  }</span><span id="05b3" class="ll lm it lc b gy mu lo l lp lq">var bind = typeof port === 'string'<br/>    ? 'Pipe ' + port<br/>    : 'Port ' + port;</span><span id="faa4" class="ll lm it lc b gy mu lo l lp lq">// handle specific listen errors with friendly messages<br/>  switch (error.code) {<br/>    case 'EACCES':<br/>      console.error(bind + ' requires elevated privileges');<br/>      process.exit(1);<br/>      break;<br/>    case 'EADDRINUSE':<br/>      console.error(bind + ' is already in use');<br/>      process.exit(1);<br/>      break;<br/>    default:<br/>      throw error;<br/>  }<br/>}</span><span id="9e58" class="ll lm it lc b gy mu lo l lp lq">/**<br/> * Event listener for HTTP server "listening" event.<br/> */</span><span id="9ea6" class="ll lm it lc b gy mu lo l lp lq">function onListening() {<br/>  var addr = server.address();<br/>  var bind = typeof addr === 'string'<br/>    ? 'pipe ' + addr<br/>    : 'port ' + addr.port;<br/>  debug('Listening on ' + bind);<br/>}</span></pre><p id="32ba" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">总之，这些代码文件将使我们能够使用<code class="fe kz la lb lc b">npm start</code>运行我们的GraphQL API。</p><h1 id="6bf7" class="lr lm it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">构建前端</h1><p id="3ecf" class="pw-post-body-paragraph kb kc it kd b ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky im bi translated">现在我们可以构建前端应用程序。首先通过运行<code class="fe kz la lb lc b">npm i -g @angular/cli</code>安装Angular CLI。然后转到项目文件夹的根目录，运行<code class="fe kz la lb lc b">ng new frontend</code>来搭建前端app。当系统询问您是否希望分别包含路由和样式选项时，请确保选择了路由和SCSS。</p><p id="5317" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们需要安装我们的库。我们需要一个GraphQL客户端、Angular Material和一个flux库来存储我们的应用程序的状态。我们通过运行<code class="fe kz la lb lc b">npm i @ngrx/store @angular/cdk @angular/material</code>来安装它们。该命令将分别安装通量库和角度材料。接下来我们运行<code class="fe kz la lb lc b">ng add @ngrx/store</code>来运行NGRX Store的框架代码。为了安装Angular Apollo，它是Angular的GraphQL客户端，我们运行<code class="fe kz la lb lc b">ng add apollo-angular</code>。这将添加一个新模块和其他代码，使我们能够在Angular应用程序中使用GraphQL。</p><p id="7acb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">前端应用程序将包括一个页面，用户可以获得和搜索他们的照片，另一个页面，他们可以上传新照片，编辑或删除现有的照片。他们可以获取或搜索照片的页面将成为主页。它将有一个导航左侧菜单。</p><p id="397f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们准备写代码了。我们首先运行命令来创建新文件:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="b7cb" class="ll lm it lc b gy ln lo l lp lq">ng g component editPhotoDialog --module app<br/>ng g component homePage --module app<br/>ng g component topBar --module app<br/>ng g component uploadPage --module app<br/>ng g service photo --module app</span></pre><p id="5cbb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意，我们必须通过添加<code class="fe kz la lb lc b">--module app</code>选项来指定我们想要添加代码的模块，以便它们可以在我们的主<code class="fe kz la lb lc b">app</code>模块中使用。</p><p id="825e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在应该从这些命令创建的<code class="fe kz la lb lc b">photo.service.ts</code>中，我们输入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="9ddb" class="ll lm it lc b gy ln lo l lp lq">import { Injectable } from '<a class="ae mt" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { Apollo } from 'apollo-angular';<br/>import gql from 'graphql-tag';</span><span id="dd65" class="ll lm it lc b gy mu lo l lp lq"><a class="ae mt" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>({<br/>  providedIn: 'root'<br/>})<br/>export class PhotoService {</span><span id="2d97" class="ll lm it lc b gy mu lo l lp lq">constructor(<br/>    private apollo: Apollo<br/>  ) { }</span><span id="d9e1" class="ll lm it lc b gy mu lo l lp lq">addPhoto(file: File, description: string, tags: string) {<br/>    const addPhoto = gql`<br/>      mutation addPhoto(<br/>        $file: Upload!,<br/>        $description: String,<br/>        $tags: String<br/>      ){<br/>        addPhoto(<br/>          file: $file,<br/>          description: $description,<br/>          tags: $tags<br/>        ) {<br/>          id,<br/>          fileLocation,<br/>          description,<br/>          tags<br/>        }<br/>      }<br/>    `;<br/>    return this.apollo.mutate({<br/>      mutation: addPhoto,<br/>      variables: {<br/>        file,<br/>        description,<br/>        tags<br/>      },<br/>      context: {<br/>        useMultipart: true<br/>      }<br/>    })<br/>  }</span><span id="b4be" class="ll lm it lc b gy mu lo l lp lq">editPhoto(id: number, file: File, description: string, tags: string) {<br/>    const editPhoto = gql`<br/>      mutation editPhoto(<br/>        $id: Int!,<br/>        $file: Upload!,<br/>        $description: String,<br/>        $tags: String<br/>      ){<br/>        editPhoto(<br/>          id: $id,<br/>          file: $file,<br/>          description: $description,<br/>          tags: $tags<br/>        ) {<br/>          id,<br/>          fileLocation,<br/>          description,<br/>          tags<br/>        }<br/>      }<br/>    `;<br/>    return this.apollo.mutate({<br/>      mutation: editPhoto,<br/>      variables: {<br/>        id,<br/>        file,<br/>        description,<br/>        tags<br/>      },<br/>      context: {<br/>        useMultipart: true<br/>      }<br/>    })<br/>  }</span><span id="37b9" class="ll lm it lc b gy mu lo l lp lq">getPhotos(page: number = 1) {<br/>    const getPhotos = gql`<br/>      query getPhotos(<br/>        $page: Int,<br/>      ){<br/>        getPhotos(<br/>          page: $page<br/>        ) {<br/>          photos {<br/>            id,<br/>            fileLocation,<br/>            description,<br/>            tags<br/>          },<br/>          page,<br/>          totalPhotos<br/>        }<br/>      }<br/>    `;<br/>    return this.apollo.mutate({<br/>      mutation: getPhotos,<br/>      variables: {<br/>        page,<br/>      }<br/>    })<br/>  }</span><span id="99ca" class="ll lm it lc b gy mu lo l lp lq">deletePhoto(id: number) {<br/>    const deletePhoto = gql`<br/>      mutation deletePhoto(<br/>        $id: Int,<br/>      ){<br/>        deletePhoto(<br/>          id: $id<br/>        )<br/>      }<br/>    `;<br/>    return this.apollo.mutate({<br/>      mutation: deletePhoto,<br/>      variables: {<br/>        id,<br/>      }<br/>    })<br/>  }</span><span id="a952" class="ll lm it lc b gy mu lo l lp lq">searchPhotos(searchQuery: string) {<br/>    const getPhotos = gql`<br/>      query searchPhotos(<br/>        $searchQuery: String,<br/>      ){<br/>        searchPhotos(<br/>          searchQuery: $searchQuery<br/>        ) {<br/>          photos {<br/>            id,<br/>            fileLocation,<br/>            description,<br/>            tags<br/>          },<br/>          page,<br/>          totalPhotos<br/>        }<br/>      }<br/>    `;<br/>    return this.apollo.mutate({<br/>      mutation: getPhotos,<br/>      variables: {<br/>        searchQuery,<br/>      }<br/>    })<br/>  }<br/>}</span></pre><p id="f242" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这利用了我们刚刚添加的Apollo客户端。查询字符串前的<code class="fe kz la lb lc b">gql</code>是一个标签，它被<code class="fe kz la lb lc b">gql</code>标签解析成Apollo可以使用的查询。语法非常接近上面的请求示例，除了您传入的是变量而不是数字或字符串。文件也作为变量直接传入。<code class="fe kz la lb lc b">context</code>对象中的<code class="fe kz la lb lc b">useMultipart: true</code>选项让我们用Angular Apollo上传文件。</p><p id="e7e2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后在<code class="fe kz la lb lc b">edit-photo-dialog.component.ts</code>中，我们放入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="80ab" class="ll lm it lc b gy ln lo l lp lq">import { Component, OnInit, Inject, ViewChild } from '<a class="ae mt" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { MatDialogRef, MAT_DIALOG_DATA } from '<a class="ae mt" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>';<br/>import { PhotoService } from '../photo.service';<br/>import { environment } from 'src/environments/environment';<br/>import { Store, select } from '<a class="ae mt" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { SET_PHOTOS } from '../reducers/photos-reducer';<br/>import { NgForm } from '<a class="ae mt" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';</span><span id="9bc1" class="ll lm it lc b gy mu lo l lp lq"><a class="ae mt" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-edit-photo-dialog',<br/>  templateUrl: './edit-photo-dialog.component.html',<br/>  styleUrls: ['./edit-photo-dialog.component.scss']<br/>})<br/>export class EditPhotoDialogComponent implements OnInit {<br/>  <a class="ae mt" href="http://twitter.com/ViewChild" rel="noopener ugc nofollow" target="_blank">@ViewChild</a>('photoUpload', null) photoUpload: any;<br/>  photoArrayData: any[] = [];</span><span id="e6c8" class="ll lm it lc b gy mu lo l lp lq">constructor(<br/>    public dialogRef: MatDialogRef&lt;EditPhotoDialogComponent&gt;,<br/>    <a class="ae mt" href="http://twitter.com/Inject" rel="noopener ugc nofollow" target="_blank">@Inject</a>(MAT_DIALOG_DATA) public photoData: any,<br/>    private photoService: PhotoService,<br/>    private store: Store&lt;any&gt;<br/>  ) {<br/>    store.pipe(select('photos'))<br/>      .subscribe(photos =&gt; {<br/>        this.photoArrayData = photos;<br/>      })<br/>  }</span><span id="9435" class="ll lm it lc b gy mu lo l lp lq">ngOnInit() {<br/>  }</span><span id="b209" class="ll lm it lc b gy mu lo l lp lq">clickUpload() {<br/>    this.photoUpload.nativeElement.click();<br/>  }</span><span id="cb43" class="ll lm it lc b gy mu lo l lp lq">handleFileInput(files) {<br/>    console.log(files);<br/>    this.photoData.file = files[0];<br/>  }</span><span id="e21a" class="ll lm it lc b gy mu lo l lp lq">save(uploadForm: NgForm) {<br/>    if (uploadForm.invalid || !this.photoData.file) {<br/>      return;<br/>    }<br/>    const {<br/>      id,<br/>      file,<br/>      description,<br/>      tags<br/>    } = this.photoData;<br/>    this.photoService.editPhoto(id, file, description, tags)<br/>      .subscribe(es =&gt; {<br/>        this.getPhotos();<br/>      })<br/>  }</span><span id="8fe4" class="ll lm it lc b gy mu lo l lp lq">getPhotos() {<br/>      this.photoService.getPhotos()<br/>      .subscribe(res =&gt; {<br/>        const photoArrayData = (res as any).data.getPhotos.photos.map(p =&gt; {<br/>          const { id, description, tags } = p;<br/>          const pathParts = p.fileLocation.split('/');<br/>          const photoPath = pathParts[pathParts.length - 1];<br/>          return {<br/>            id,<br/>            description,<br/>            tags,<br/>            photoUrl: `${environment.photosUrl}/${photoPath}`<br/>          }<br/>        });<br/>        this.store.dispatch({ type: SET_PHOTOS, payload: photoArrayData });<br/>        this.dialogRef.close()<br/>      })<br/>  }<br/>}</span></pre><p id="b269" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是当用户在一行照片上点击编辑时我们创建的对话框的代码。照片数据从主页传入，可以在这里编辑。一旦用户点击保存按钮，就会调用<code class="fe kz la lb lc b">save</code>函数，如果成功，就会调用<code class="fe kz la lb lc b">getPhotos</code>函数来获取最新的照片并存储到商店中。</p><p id="c5ae" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来在<code class="fe kz la lb lc b">edit-photo-dialog.component.html</code>中，我们放入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="6647" class="ll lm it lc b gy ln lo l lp lq">&lt;h2&gt;Edit Photo&lt;/h2&gt;<br/>&lt;form #photoForm='ngForm' (ngSubmit)='save(photoForm)'&gt;<br/>    &lt;div&gt;<br/>        &lt;input type="file" id="file" (change)="handleFileInput($event.target.files)" #photoUpload&gt;<br/>        &lt;button mat-raised-button (click)='clickUpload()' type='button'&gt;<br/>            Upload Photo<br/>        &lt;/button&gt;<br/>        {{photoData?.file?.name}}<br/>    &lt;/div&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input matInput placeholder="Description" required #description='ngModel' name='description'<br/>            #description='ngModel' [(ngModel)]='photoData.description'&gt;<br/>        &lt;mat-error *ngIf="description.invalid &amp;&amp; (description.dirty || description.touched)"&gt;<br/>            &lt;div *ngIf="description.errors.required"&gt;<br/>                Description is required.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input matInput placeholder="Tags" required #tags='ngModel' name='tags' [(ngModel)]='photoData.tags'<br/>            #tags='ngModel'&gt;<br/>        &lt;mat-error *ngIf="tags.invalid &amp;&amp; (tags.dirty || tags.touched)"&gt;<br/>            &lt;div *ngIf="tags.errors.required"&gt;<br/>                Tags is required.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;button mat-raised-button type='submit'&gt;Save&lt;/button&gt;<br/>&lt;/form&gt;</span></pre><p id="737c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这允许用户上传新照片，并编辑描述和标签字段。在<code class="fe kz la lb lc b">edit-photo-dialog.component.scss</code>中，我们添加:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="bb7f" class="ll lm it lc b gy ln lo l lp lq">#file {<br/>  display: none;<br/>}</span></pre><p id="9aaa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这使得文件上传输入隐藏。我们通过点击按钮调用上传对话框，并用<code class="fe kz la lb lc b">handleFileInput</code>处理程序获取文件。</p><p id="34f3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们可以创建主页了。在<code class="fe kz la lb lc b">home-page.component.ts</code>中，我们输入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="2147" class="ll lm it lc b gy ln lo l lp lq">import { Component, OnInit, ViewChild } from '<a class="ae mt" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { PhotoService } from '../photo.service';<br/>import { environment } from 'src/environments/environment';<br/>import { NgForm } from '<a class="ae mt" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';</span><span id="40f7" class="ll lm it lc b gy mu lo l lp lq"><a class="ae mt" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-home-page',<br/>  templateUrl: './home-page.component.html',<br/>  styleUrls: ['./home-page.component.scss']<br/>})<br/>export class HomePageComponent implements OnInit {<br/>  photoUrls: string[] = [];<br/>  query: any = &lt;any&gt;{};</span><span id="2023" class="ll lm it lc b gy mu lo l lp lq">constructor(<br/>    private photoService: PhotoService<br/>  ) { }</span><span id="7549" class="ll lm it lc b gy mu lo l lp lq">ngOnInit() {<br/>    this.getPhotos();<br/>  }</span><span id="a455" class="ll lm it lc b gy mu lo l lp lq">getPhotos() {<br/>    this.photoService.getPhotos()<br/>      .subscribe(res =&gt; {<br/>        this.photoUrls = (res as any).data.getPhotos.photos.map(p =&gt; {<br/>          const pathParts = p.fileLocation.split('/');<br/>          const photoPath = pathParts[pathParts.length - 1];<br/>          return `${environment.photosUrl}/${photoPath}`;<br/>        });<br/>      })<br/>  }</span><span id="854b" class="ll lm it lc b gy mu lo l lp lq">searchPhotos(searchForm: NgForm) {<br/>    if (searchForm.invalid) {<br/>      return;<br/>    }<br/>    this.searchPhotosQuery();<br/>  }</span><span id="859c" class="ll lm it lc b gy mu lo l lp lq">searchPhotosQuery() {<br/>    this.photoService.searchPhotos(this.query.search)<br/>      .subscribe(res =&gt; {<br/>        this.photoUrls = (res as any).data.searchPhotos.photos.map(p =&gt; {<br/>          const pathParts = p.fileLocation.split('/');<br/>          const photoPath = pathParts[pathParts.length - 1];<br/>          return `${environment.photosUrl}/${photoPath}`;<br/>        });<br/>      })<br/>  }<br/>}</span></pre><p id="3593" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这让我们可以获得用户保存的照片，并允许用户使用<code class="fe kz la lb lc b">searchPhotosQuery</code>功能进行搜索。我们将调用<code class="fe kz la lb lc b">photoService</code>，我们将使用Apollo客户机发出请求。</p><p id="f388" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe kz la lb lc b">home-page.component.html</code>中，我们把:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="585c" class="ll lm it lc b gy ln lo l lp lq">&lt;form #searchForm='ngForm' (ngSubmit)='searchPhotos(searchForm)'&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input matInput placeholder="Search Photos" required #search='ngModel' name='search' [(ngModel)]='query.search'&gt;<br/>        &lt;mat-error *ngIf="search.invalid &amp;&amp; (search.dirty || search.touched)"&gt;<br/>            &lt;div *ngIf="search.errors.required"&gt;<br/>                Search query is required.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;button mat-raised-button type='submit'&gt;Search&lt;/button&gt;<br/>&lt;/form&gt;<br/>&lt;br&gt;<br/>&lt;mat-grid-list cols="3" rowHeight="1:1"&gt;<br/>    &lt;mat-grid-tile *ngFor='let p of photoUrls'&gt;<br/>        &lt;img [src]='p' class="tile-image"&gt;<br/>    &lt;/mat-grid-tile&gt;<br/>&lt;/mat-grid-list&gt;</span></pre><p id="c025" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将在网格中显示照片，并允许用户通过文本输入来搜索照片。</p><p id="55f7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe kz la lb lc b">home-page.component.scss</code>中，我们添加:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="f739" class="ll lm it lc b gy ln lo l lp lq">.tile-image {<br/>  width: 100%;<br/>  height: auto;<br/>}</span></pre><p id="e78b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这会拉伸图像以适合网格。</p><p id="4917" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，在<code class="fe kz la lb lc b">reducer</code>文件夹中，我们创建了两个文件，<code class="fe kz la lb lc b">menu-reducer.ts</code>和<code class="fe kz la lb lc b">photos-reducer.ts</code>，让reducers存储我们应用程序的状态。在<code class="fe kz la lb lc b">menu-reducer.ts</code>中我们放入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="4722" class="ll lm it lc b gy ln lo l lp lq">const TOGGLE_MENU = 'TOGGLE_MENU';</span><span id="cc55" class="ll lm it lc b gy mu lo l lp lq">function menuReducer(state, action) {<br/>    switch (action.type) {<br/>        case TOGGLE_MENU:<br/>            state = action.payload;<br/>            return state;<br/>        default:<br/>            return state<br/>    }<br/>}</span><span id="469b" class="ll lm it lc b gy mu lo l lp lq">export { menuReducer, TOGGLE_MENU };</span></pre><p id="ab32" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">同样，在<code class="fe kz la lb lc b">photos-reducer.ts</code>中，我们添加:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="82b6" class="ll lm it lc b gy ln lo l lp lq">const SET_PHOTOS = 'SET_PHOTOS';</span><span id="db71" class="ll lm it lc b gy mu lo l lp lq">function photosReducer(state, action) {<br/>    switch (action.type) {<br/>        case SET_PHOTOS:<br/>            state = action.payload;<br/>            return state;<br/>        default:<br/>            return state<br/>    }<br/>}</span><span id="b20b" class="ll lm it lc b gy mu lo l lp lq">export { photosReducer, SET_PHOTOS };</span></pre><p id="be7e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将存储左侧菜单和照片的状态。在<code class="fe kz la lb lc b">reducers/index.ts</code>中，我们把:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="5977" class="ll lm it lc b gy ln lo l lp lq">import { menuReducer } from './menu-reducer';<br/>import { photosReducer } from './photos-reducer';</span><span id="8607" class="ll lm it lc b gy mu lo l lp lq">export const reducers = {<br/>  menu: menuReducer,<br/>  photos: photosReducer<br/>};</span></pre><p id="1caf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这确保了减速器可以包含在我们的<code class="fe kz la lb lc b">app</code>模块中，允许我们操纵状态。</p><p id="66ab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来在<code class="fe kz la lb lc b">top-bar.component.ts</code>中，我们把:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="4e23" class="ll lm it lc b gy ln lo l lp lq">import { Component, OnInit } from '<a class="ae mt" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { Store, select } from '<a class="ae mt" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { TOGGLE_MENU } from '../reducers/menu-reducer';</span><span id="741f" class="ll lm it lc b gy mu lo l lp lq"><a class="ae mt" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-top-bar',<br/>  templateUrl: './top-bar.component.html',<br/>  styleUrls: ['./top-bar.component.scss']<br/>})<br/>export class TopBarComponent implements OnInit {<br/>  menuOpen: boolean;</span><span id="144f" class="ll lm it lc b gy mu lo l lp lq">constructor(<br/>    private store: Store&lt;any&gt;<br/>  ) {<br/>    store.pipe(select('menu'))<br/>      .subscribe(menuOpen =&gt; {<br/>        this.menuOpen = menuOpen;<br/>      })<br/>  }</span><span id="ac51" class="ll lm it lc b gy mu lo l lp lq">ngOnInit() {<br/>  }</span><span id="20fd" class="ll lm it lc b gy mu lo l lp lq">toggleMenu() {<br/>    this.store.dispatch({ type: TOGGLE_MENU, payload: !this.menuOpen });<br/>  }<br/>}</span></pre><p id="1954" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它有一个<code class="fe kz la lb lc b">toggleMenu</code>功能，用于切换菜单状态并将状态保存在存储器中。</p><p id="2e0c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe kz la lb lc b">top-bar.component.html</code>中，我们输入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="bd5c" class="ll lm it lc b gy ln lo l lp lq">&lt;mat-toolbar&gt;<br/>    &lt;a (click)='toggleMenu()' class="menu-button"&gt;<br/>        &lt;i class="material-icons"&gt;<br/>            menu<br/>        &lt;/i&gt;<br/>    &lt;/a&gt;<br/>    Image Gallery App<br/>&lt;/mat-toolbar&gt;</span></pre><p id="bc30" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">其中显示了工具栏。</p><p id="ed22" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe kz la lb lc b">top-bar.component.scss</code>中，我们添加:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="3a6d" class="ll lm it lc b gy ln lo l lp lq">.menu-button {<br/>  margin-top: 6px;<br/>  margin-right: 10px;<br/>  cursor: pointer;<br/>}</span><span id="5acf" class="ll lm it lc b gy mu lo l lp lq">.menu-button {<br/>  color: white;<br/>}</span><span id="f506" class="ll lm it lc b gy mu lo l lp lq">.mat-toolbar-row,<br/>.mat-toolbar-single-row {<br/>  height: 64px;<br/>  background-color: #fc036b;<br/>  color: white;<br/>}</span></pre><p id="06ea" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这使得间距看起来更好。</p><p id="0ec8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe kz la lb lc b">upload-page.component.ts</code>中，我们输入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="1a18" class="ll lm it lc b gy ln lo l lp lq">import { Component, OnInit, ViewChild } from '<a class="ae mt" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { PhotoService } from '../photo.service';<br/>import { environment } from 'src/environments/environment';<br/>import { MatDialog } from '<a class="ae mt" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>';<br/>import { EditPhotoDialogComponent } from '../edit-photo-dialog/edit-photo-dialog.component';<br/>import { Store, select } from '<a class="ae mt" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { SET_PHOTOS } from '../reducers/photos-reducer';<br/>import { NgForm } from '<a class="ae mt" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';</span><span id="19bc" class="ll lm it lc b gy mu lo l lp lq"><a class="ae mt" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-upload-page',<br/>  templateUrl: './upload-page.component.html',<br/>  styleUrls: ['./upload-page.component.scss']<br/>})<br/>export class UploadPageComponent implements OnInit {<br/>  photoData: any = &lt;any&gt;{};<br/>  photoArrayData: any[] = [];<br/>  page: number = 1;<br/>  totalPhotos: number = 0;<br/>  <a class="ae mt" href="http://twitter.com/ViewChild" rel="noopener ugc nofollow" target="_blank">@ViewChild</a>('photoUpload', null) photoUpload: any;<br/>  displayedColumns: string[] = [<br/>    'photoUrl',<br/>    'description',<br/>    'tags',<br/>    'edit',<br/>    'delete'<br/>  ]</span><span id="a7c3" class="ll lm it lc b gy mu lo l lp lq">constructor(<br/>    private photoService: PhotoService,<br/>    public dialog: MatDialog,<br/>    private store: Store&lt;any&gt;<br/>  ) {<br/>    store.pipe(select('photos'))<br/>      .subscribe(photos =&gt; {<br/>        this.photoArrayData = photos;<br/>      })<br/>  }</span><span id="842d" class="ll lm it lc b gy mu lo l lp lq">ngOnInit() {<br/>    this.getPhotos();<br/>  }</span><span id="aa68" class="ll lm it lc b gy mu lo l lp lq">clickUpload() {<br/>    this.photoUpload.nativeElement.click();<br/>  }</span><span id="3c40" class="ll lm it lc b gy mu lo l lp lq">handleFileInput(files) {<br/>    console.log(files);<br/>    this.photoData.file = files[0];<br/>  }</span><span id="2209" class="ll lm it lc b gy mu lo l lp lq">save(uploadForm: NgForm) {<br/>    if (uploadForm.invalid || !this.photoData.file) {<br/>      return;<br/>    }<br/>    const {<br/>      file,<br/>      description,<br/>      tags<br/>    } = this.photoData;<br/>    this.photoService.addPhoto(file, description, tags)<br/>      .subscribe(res =&gt; {<br/>        this.getPhotos();<br/>      })<br/>  }</span><span id="8b10" class="ll lm it lc b gy mu lo l lp lq">getPhotos() {<br/>    this.photoService.getPhotos(this.page)<br/>      .subscribe(res =&gt; {<br/>        const photoArrayData = (res as any).data.getPhotos.photos.map(p =&gt; {<br/>          const { id, description, tags } = p;<br/>          const pathParts = p.fileLocation.split('/');<br/>          const photoPath = pathParts[pathParts.length - 1];<br/>          return {<br/>            id,<br/>            description,<br/>            tags,<br/>            photoUrl: `${environment.photosUrl}/${photoPath}`<br/>          }<br/>        });<br/>        this.page = (res as any).data.getPhotos.page;<br/>        this.totalPhotos = (res as any).data.getPhotos.totalPhotos;<br/>        this.store.dispatch({ type: SET_PHOTOS, payload: photoArrayData });<br/>      })<br/>  }</span><span id="72ff" class="ll lm it lc b gy mu lo l lp lq">openEditDialog(index: number) {<br/>    const dialogRef = this.dialog.open(EditPhotoDialogComponent, {<br/>      width: '70vw',<br/>      data: this.photoArrayData[index] || {}<br/>    })</span><span id="9835" class="ll lm it lc b gy mu lo l lp lq">dialogRef.afterClosed().subscribe(result =&gt; {<br/>      console.log('The dialog was closed');<br/>    });<br/>  }</span><span id="a043" class="ll lm it lc b gy mu lo l lp lq">deletePhoto(index: number) {<br/>    const { id } = this.photoArrayData[index];<br/>    this.photoService.deletePhoto(id)<br/>      .subscribe(res =&gt; {<br/>        this.getPhotos();<br/>      })<br/>  }<br/>}</span></pre><p id="e853" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这允许人们上传他们的照片，打开一个对话框进行编辑，或者删除照片。</p><p id="9ee3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它有一个文件输入来获取一个文件对象，并调用<code class="fe kz la lb lc b">photoService</code>向API发出GraphQL请求来操作照片表条目。在<code class="fe kz la lb lc b">upload-page.component.html</code>中，我们把:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="2aa7" class="ll lm it lc b gy ln lo l lp lq">&lt;div class="center"&gt;<br/>    &lt;h1&gt;Manage Files&lt;/h1&gt;<br/>&lt;/div&gt;<br/>&lt;h2&gt;Add Photo&lt;/h2&gt;<br/>&lt;form #photoForm='ngForm' (ngSubmit)='save(photoForm)'&gt;<br/>    &lt;div&gt;<br/>        &lt;input type="file" id="file" (change)="handleFileInput($event.target.files)" #photoUpload&gt;<br/>        &lt;button mat-raised-button (click)='clickUpload()' type='button'&gt;<br/>            Upload Photo<br/>        &lt;/button&gt;<br/>        {{photoData?.file?.name}}<br/>    &lt;/div&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input matInput placeholder="Description" required #description='ngModel' name='description'<br/>            #description='ngModel' [(ngModel)]='photoData.description'&gt;<br/>        &lt;mat-error *ngIf="description.invalid &amp;&amp; (description.dirty || description.touched)"&gt;<br/>            &lt;div *ngIf="description.errors.required"&gt;<br/>                Description is required.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input matInput placeholder="Tags" required #tags='ngModel' name='tags' [(ngModel)]='photoData.tags'<br/>            #tags='ngModel'&gt;<br/>        &lt;mat-error *ngIf="tags.invalid &amp;&amp; (tags.dirty || tags.touched)"&gt;<br/>            &lt;div *ngIf="tags.errors.required"&gt;<br/>                Tags is required.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;button mat-raised-button type='submit'&gt;Save&lt;/button&gt;<br/>&lt;/form&gt;</span><span id="130b" class="ll lm it lc b gy mu lo l lp lq">&lt;br&gt;<br/>&lt;h2&gt;Manage Photos&lt;/h2&gt;</span><span id="fc86" class="ll lm it lc b gy mu lo l lp lq">&lt;table mat-table [dataSource]="photoArrayData" class="mat-elevation-z8"&gt;<br/>    &lt;ng-container matColumnDef="photoUrl"&gt;<br/>        &lt;th mat-header-cell *matHeaderCellDef&gt; Photo &lt;/th&gt;<br/>        &lt;td mat-cell *matCellDef="let photo"&gt;<br/>            &lt;img [src]='photo.photoUrl' class="photo"&gt;<br/>        &lt;/td&gt;<br/>    &lt;/ng-container&gt;</span><span id="4e6a" class="ll lm it lc b gy mu lo l lp lq">&lt;ng-container matColumnDef="description"&gt;<br/>        &lt;th mat-header-cell *matHeaderCellDef&gt; Description &lt;/th&gt;<br/>        &lt;td mat-cell *matCellDef="let photo"&gt; {{photo.description}} &lt;/td&gt;<br/>    &lt;/ng-container&gt;</span><span id="ea25" class="ll lm it lc b gy mu lo l lp lq">&lt;ng-container matColumnDef="tags"&gt;<br/>        &lt;th mat-header-cell *matHeaderCellDef&gt; Tags &lt;/th&gt;<br/>        &lt;td mat-cell *matCellDef="let photo"&gt; {{photo.tags}} &lt;/td&gt;<br/>    &lt;/ng-container&gt;</span><span id="61bb" class="ll lm it lc b gy mu lo l lp lq">&lt;ng-container matColumnDef="edit"&gt;<br/>        &lt;th mat-header-cell *matHeaderCellDef&gt; Edit &lt;/th&gt;<br/>        &lt;td mat-cell *matCellDef="let photo; let i = index"&gt;<br/>            &lt;button mat-raised-button (click)='openEditDialog(i)'&gt;Edit&lt;/button&gt;<br/>        &lt;/td&gt;<br/>    &lt;/ng-container&gt;</span><span id="3510" class="ll lm it lc b gy mu lo l lp lq">&lt;ng-container matColumnDef="delete"&gt;<br/>        &lt;th mat-header-cell *matHeaderCellDef&gt; Delete &lt;/th&gt;<br/>        &lt;td mat-cell *matCellDef="let photo; let i = index"&gt;<br/>            &lt;button mat-raised-button (click)='deletePhoto(i)'&gt;Delete&lt;/button&gt;<br/>        &lt;/td&gt;<br/>    &lt;/ng-container&gt;</span><span id="c5db" class="ll lm it lc b gy mu lo l lp lq">&lt;tr mat-header-row *matHeaderRowDef="displayedColumns"&gt;&lt;/tr&gt;<br/>    &lt;tr mat-row *matRowDef="let row; columns: displayedColumns;"&gt;&lt;/tr&gt;<br/>&lt;/table&gt;</span><span id="62cf" class="ll lm it lc b gy mu lo l lp lq">&lt;mat-paginator [length]="totalPhotos" [pageSize]="10" [pageSizeOptions]="[10]"<br/>    (page)="page = $event.pageIndex + 1; getPhotos()"&gt;<br/>&lt;/mat-paginator&gt;</span></pre><p id="be6f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这显示了一个上传照片并输入描述和标签的表单，还显示了照片数据的表格行，每行都有编辑和删除按钮。用户可以通过底部的分页组件浏览每页10张照片。</p><p id="fc85" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe kz la lb lc b">upload-page.component.scss</code>中，我们输入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="c680" class="ll lm it lc b gy ln lo l lp lq">#file {<br/>  display: none;<br/>}</span><span id="37a2" class="ll lm it lc b gy mu lo l lp lq">table.mat-table,<br/>.mat-paginator {<br/>  width: 92vw;<br/>}</span><span id="61ef" class="ll lm it lc b gy mu lo l lp lq">.photo {<br/>  width: 50px;<br/>}</span></pre><p id="a01b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将隐藏文件上传输入，并将表格和分页器组件的宽度更改为相同。</p><p id="aa1f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来在<code class="fe kz la lb lc b">app-routing.module.ts</code>中，我们放入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="0007" class="ll lm it lc b gy ln lo l lp lq">import { NgModule } from '<a class="ae mt" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { Routes, RouterModule } from '<a class="ae mt" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { HomePageComponent } from './home-page/home-page.component';<br/>import { UploadPageComponent } from './upload-page/upload-page.component';</span><span id="7d46" class="ll lm it lc b gy mu lo l lp lq">const routes: Routes = [<br/>  { path: '', component: HomePageComponent },<br/>  { path: 'upload', component: UploadPageComponent },<br/>];</span><span id="e093" class="ll lm it lc b gy mu lo l lp lq"><a class="ae mt" href="http://twitter.com/NgModule" rel="noopener ugc nofollow" target="_blank">@NgModule</a>({<br/>  imports: [RouterModule.forRoot(routes)],<br/>  exports: [RouterModule]<br/>})<br/>export class AppRoutingModule { }</span></pre><p id="f768" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这会将URL路由到我们创建的页面。</p><p id="b9bb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe kz la lb lc b">app.component.ts</code>中，我们把:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="bff2" class="ll lm it lc b gy ln lo l lp lq">import { Component, HostListener } from '<a class="ae mt" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { Store, select } from '<a class="ae mt" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { TOGGLE_MENU } from './reducers/menu-reducer';</span><span id="e146" class="ll lm it lc b gy mu lo l lp lq"><a class="ae mt" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-root',<br/>  templateUrl: './app.component.html',<br/>  styleUrls: ['./app.component.scss']<br/>})<br/>export class AppComponent {<br/>  menuOpen: boolean;</span><span id="f093" class="ll lm it lc b gy mu lo l lp lq">constructor(<br/>    private store: Store&lt;any&gt;,<br/>  ) {<br/>    store.pipe(select('menu'))<br/>      .subscribe(menuOpen =&gt; {<br/>        this.menuOpen = menuOpen;<br/>      })<br/>  }</span><span id="09e8" class="ll lm it lc b gy mu lo l lp lq"><a class="ae mt" href="http://twitter.com/HostListener" rel="noopener ugc nofollow" target="_blank">@HostListener</a>('document:click', ['$event'])<br/>  public onClick(event) {<br/>    const isOutside = !event.target.className.includes("menu-button") &amp;&amp;<br/>      !event.target.className.includes("material-icons") &amp;&amp;<br/>      !event.target.className.includes("mat-drawer-inner-container")<br/>    if (isOutside) {<br/>      this.menuOpen = false;<br/>      this.store.dispatch({ type: TOGGLE_MENU, payload: this.menuOpen });<br/>    }<br/>  }</span><span id="a381" class="ll lm it lc b gy mu lo l lp lq">}</span></pre><p id="9ec4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将添加菜单和<code class="fe kz la lb lc b">router-outlet</code>元素来显示我们在<code class="fe kz la lb lc b">app-routing.module.ts</code>中指定的路线。</p><p id="1241" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe kz la lb lc b">styles.scss</code>中，我们把:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="7111" class="ll lm it lc b gy ln lo l lp lq">/* You can add global styles to this file, and also import other style files */<br/><a class="ae mt" href="http://twitter.com/import" rel="noopener ugc nofollow" target="_blank">@import</a> "~<a class="ae mt" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/prebuilt-themes/indigo-pink.css";</span><span id="3c73" class="ll lm it lc b gy mu lo l lp lq">body {<br/>  font-family: "Roboto", sans-serif;<br/>  margin: 0;<br/>}</span><span id="0a1e" class="ll lm it lc b gy mu lo l lp lq">form {<br/>  mat-form-field {<br/>    width: 95%;<br/>    margin: 0 auto;<br/>  }<br/>}</span><span id="12d7" class="ll lm it lc b gy mu lo l lp lq">.center {<br/>  text-align: center;<br/>}</span></pre><p id="18b2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这包括我们代码中的角形材质CSS。</p><p id="ef43" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe kz la lb lc b">index.html</code>中，我们把:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="af88" class="ll lm it lc b gy ln lo l lp lq">&lt;!doctype html&gt;<br/>&lt;html lang="en"&gt;</span><span id="f6e7" class="ll lm it lc b gy mu lo l lp lq">&lt;head&gt;<br/>  &lt;meta charset="utf-8"&gt;<br/>  &lt;title&gt;Frontend&lt;/title&gt;<br/>  &lt;base href="/"&gt;<br/>  &lt;link href="<a class="ae mt" href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="noopener ugc nofollow" target="_blank">https://fonts.googleapis.com/css?family=Roboto&amp;display=swap</a>" rel="stylesheet"&gt;<br/>  &lt;link href="<a class="ae mt" href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="noopener ugc nofollow" target="_blank">https://fonts.googleapis.com/icon?family=Material+Icons</a>" rel="stylesheet"&gt;<br/>  &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;<br/>  &lt;link rel="icon" type="image/x-icon" href="favicon.ico"&gt;<br/>&lt;/head&gt;</span><span id="1473" class="ll lm it lc b gy mu lo l lp lq">&lt;body&gt;<br/>  &lt;app-root&gt;&lt;/app-root&gt;<br/>&lt;/body&gt;</span><span id="5d56" class="ll lm it lc b gy mu lo l lp lq">&lt;/html&gt;</span></pre><p id="effc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这改变了标题，并在我们的应用程序中包括Roboto字体和材料图标，以显示图标。</p><p id="b0e8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后，在<code class="fe kz la lb lc b">app.module.ts</code>中我们放入:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="9591" class="ll lm it lc b gy ln lo l lp lq">import { BrowserModule } from '<a class="ae mt" href="http://twitter.com/angular/platform-browser" rel="noopener ugc nofollow" target="_blank">@angular/platform-browser</a>';<br/>import { NgModule } from '<a class="ae mt" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import {<br/>  MatButtonModule,<br/>  MatCheckboxModule,<br/>  MatInputModule,<br/>  MatMenuModule,<br/>  MatSidenavModule,<br/>  MatToolbarModule,<br/>  MatTableModule,<br/>  MatDialogModule,<br/>  MatDatepickerModule,<br/>  MatSelectModule,<br/>  MatCardModule,<br/>  MatFormFieldModule,<br/>  MatGridListModule<br/>} from '<a class="ae mt" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>';<br/>import { BrowserAnimationsModule } from '<a class="ae mt" href="http://twitter.com/angular/platform-browser" rel="noopener ugc nofollow" target="_blank">@angular/platform-browser</a>/animations';<br/>import { AppRoutingModule } from './app-routing.module';<br/>import { AppComponent } from './app.component';<br/>import { StoreModule } from '<a class="ae mt" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { reducers } from './reducers';<br/>import { TopBarComponent } from './top-bar/top-bar.component';<br/>import { FormsModule } from '<a class="ae mt" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';<br/>import { HttpClientModule, HTTP_INTERCEPTORS } from '<a class="ae mt" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>/http';<br/>import { HomePageComponent } from './home-page/home-page.component';<br/>import { PhotoService } from './photo.service';<br/>import { GraphQLModule } from './graphql.module';<br/>import { UploadPageComponent } from './upload-page/upload-page.component';<br/>import { MatPaginatorModule } from '<a class="ae mt" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/paginator';<br/>import { EditPhotoDialogComponent } from './edit-photo-dialog/edit-photo-dialog.component';</span><span id="c03e" class="ll lm it lc b gy mu lo l lp lq"><a class="ae mt" href="http://twitter.com/NgModule" rel="noopener ugc nofollow" target="_blank">@NgModule</a>({<br/>  declarations: [<br/>    AppComponent,<br/>    TopBarComponent,<br/>    HomePageComponent,<br/>    UploadPageComponent,<br/>    EditPhotoDialogComponent,<br/>  ],<br/>  imports: [<br/>    BrowserModule,<br/>    AppRoutingModule,<br/>    FormsModule,<br/>    MatButtonModule,<br/>    StoreModule.forRoot(reducers),<br/>    BrowserAnimationsModule,<br/>    MatButtonModule,<br/>    MatCheckboxModule,<br/>    MatFormFieldModule,<br/>    MatInputModule,<br/>    MatMenuModule,<br/>    MatSidenavModule,<br/>    MatToolbarModule,<br/>    MatTableModule,<br/>    HttpClientModule,<br/>    MatDialogModule,<br/>    MatDatepickerModule,<br/>    MatSelectModule,<br/>    MatCardModule,<br/>    MatGridListModule,<br/>    GraphQLModule,<br/>    MatPaginatorModule<br/>  ],<br/>  providers: [<br/>    PhotoService<br/>  ],<br/>  bootstrap: [AppComponent],<br/>  entryComponents: [<br/>    EditPhotoDialogComponent<br/>  ]<br/>})<br/>export class AppModule { }</span></pre><p id="c339" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这段代码包含了我们运行应用程序模块所需的一切。请注意，我们在<code class="fe kz la lb lc b">entryComponents</code>中有<code class="fe kz la lb lc b">EditPhotoDialogComponent</code>。这是在另一个元素中显示对话框所必需的。</p><p id="edb0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在所有这些工作之后，我们得到了以下结果:</p><figure class="ld le lf lg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/cba81dee21142a9493f2cb0a8eb27abb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*58e3u2EGusgrHUkCf3JysA.png"/></div></div></figure><figure class="ld le lf lg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/5246467e254647ab1a9ffa4f55bd5e13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_foLp4OzC6jZ9T3RKYA42g.png"/></div></div></figure><figure class="ld le lf lg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/854231083129a4f432da2fefa16b6065.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VJVPeMPxW0nf2kHcjUFK6g.png"/></div></div></figure><figure class="ld le lf lg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/d260de310511a513ea27f48f611f3a9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pqgNvJ9IvIRfjQejksPoug.png"/></div></div></figure></div></div>    
</body>
</html>