<html>
<head>
<title>The Many Things About Nested Forms in Ruby on Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ruby on Rails中关于嵌套表单的许多事情</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/the-many-things-about-nested-form-in-ruby-on-rails-15f32ed66446?source=collection_archive---------5-----------------------#2020-03-27">https://levelup.gitconnected.com/the-many-things-about-nested-form-in-ruby-on-rails-15f32ed66446?source=collection_archive---------5-----------------------#2020-03-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/95829aaf888d4bb71f2035f6985e86ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q5ps3MrKT7tNXtCsxua5eA.jpeg"/></div></div></figure><p id="a77a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在开发应用程序时，很多时候你必须创建不同类型的表单供用户填写。可能有一个简单的表单，其中只包含一个模型，也可能有更多的表单包含一系列模型。在这篇文章中，我将向你展示如何处理不同类型的情况。</p><ul class=""><li id="92d7" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">设置一个表单—有_多或有_一关系</li><li id="f116" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">删除关联的对象</li></ul></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><blockquote class="lr ls lt"><p id="28a3" class="jy jz lu ka b kb kc kd ke kf kg kh ki lv kk kl km lw ko kp kq lx ks kt ku kv ij bi translated">我所有的UI组件都是基于Fomantic-UI的。有兴趣可以参考我之前的文章做参考。</p></blockquote><div class="ly lz gp gr ma mb"><a href="https://medium.com/swlh/plugins-and-frameworks-for-your-next-ruby-on-rails-project-5793d8dee3eb" rel="noopener follow" target="_blank"><div class="mc ab fo"><div class="md ab me cl cj mf"><h2 class="bd ir gy z fp mg fr fs mh fu fw ip bi translated">下一个Ruby on Rails项目的插件和框架</h2><div class="mi l"><h3 class="bd b gy z fp mg fr fs mh fu fw dk translated">对于web开发项目，你必须有使用不同开源插件和前端框架的经验…</h3></div><div class="mj l"><p class="bd b dl z fp mg fr fs mh fu fw dk translated">medium.com</p></div></div><div class="mk l"><div class="ml l mm mn mo mk mp jw mb"/></div></div></a></div></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><h1 id="0e53" class="mq mr iq bd ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn bi translated">设置一个表单—有_多或有_一关系</h1><p id="aca7" class="pw-post-body-paragraph jy jz iq ka b kb no kd ke kf np kh ki kj nq kl km kn nr kp kq kr ns kt ku kv ij bi translated">从Rails 5.2开始，它鼓励使用form_with，默认情况下请求是异步提交的。使用我上一篇文章中的旅行模型，如果我们要在一个表单中完成它，它将是这样的:</p><pre class="nt nu nv nw gt nx ny nz oa aw ob bi"><span id="6051" class="oc mr iq ny b gy od oe l of og"><strong class="ny ir">app/views/trips/_form.html.erb</strong></span><span id="7462" class="oc mr iq ny b gy oh oe l of og">&lt;%= form_with @trip, class: "ui form" do |form| %&gt;<br/>  &lt;%= form.text_field :name, placeholder: "An exciting football trip" %&gt;<br/>&lt;% end %&gt;</span></pre><p id="34c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了使我的旅行模型更加真实，增加了一些联想。我的旅行将有多条路线。每条路线都包括许多我想去的目的地。我会在旅行开始前决定走哪条路线。这是我的模型和关联的外观:</p><pre class="nt nu nv nw gt nx ny nz oa aw ob bi"><span id="a014" class="oc mr iq ny b gy od oe l of og"><strong class="ny ir">app/models/trip.rb</strong></span><span id="a106" class="oc mr iq ny b gy oh oe l of og">class Trip &lt; AppllicationRecord <br/>  has_many :itineraries<br/>  accepts_nested_attributes_for :itineraries<br/>end</span><span id="c9fb" class="oc mr iq ny b gy oh oe l of og"><strong class="ny ir">app/models/itinerary.rb</strong></span><span id="a03a" class="oc mr iq ny b gy oh oe l of og">class Itinerary &lt; ApplicationRecord<br/>  belongs_to :trip<br/>  has_many :destinations<br/>  accepts_nested_attributes_for :destinations<br/>end</span><span id="2e4f" class="oc mr iq ny b gy oh oe l of og"><strong class="ny ir">app/models/destination.rb</strong></span><span id="1e97" class="oc mr iq ny b gy oh oe l of og">class Destination &lt; ApplicationRecord<br/>  belongs_to :itinerary <br/>end</span></pre><p id="7e7c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们用我的新模型来重温一下表单。</p><pre class="nt nu nv nw gt nx ny nz oa aw ob bi"><span id="8353" class="oc mr iq ny b gy od oe l of og"><strong class="ny ir">app/views/trips/_form.html.erb</strong></span><span id="a78e" class="oc mr iq ny b gy oh oe l of og">&lt;%= form_with @trip, class: ”ui form” do |trip_form| %&gt;<br/>&lt;div class="fields"&gt;<br/>  &lt;div class="field"&gt;<br/>    &lt;%= trip_form.label :name %&gt;<br/>    &lt;%= trip_form.text_field :name, placeholder: ”An exciting football trip” %&gt;<br/>  &lt;/div&gt;<br/>  &lt;%= trip_form.fields_for :itineraries do |itinerary_form| %&gt;<br/>  &lt;div class="fields"&gt;<br/>    &lt;div class="field"&gt;<br/>      &lt;%= itinerary_form.label :name %&gt;<br/>      &lt;%= itinerary_form.text_field :name, placeholder: ”Direct to Manchester” %&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="field"&gt;<br/>      &lt;%= itinerary_form.label :date_from %&gt;<br/>      &lt;div class="ui calendar"&gt;<br/>        &lt;div class="ui input left icon"&gt;<br/>        &lt;i class="calendar icon"&gt;&lt;/i&gt;<br/>        &lt;%= itinerary_form.text_field :text_field :date_from, placeholder: "Pick a start date" %&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="field"&gt;<br/>      &lt;%= itinerary_form.label :date_to %&gt;<br/>      &lt;div class="ui calendar"&gt;<br/>        &lt;div class="ui input left icon"&gt;<br/>        &lt;i class="calendar icon"&gt;&lt;/i&gt;<br/>        &lt;%= itinerary_form.text_field :text_field :date_to, placeholder: "Pick a end date" %&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;</span><span id="5e5d" class="oc mr iq ny b gy oh oe l of og">    &lt;%= itinerary_form.fields_for :destinations, Destionation.new do |destination_form| %&gt;<br/>    &lt;div class="fields&gt;<br/>      &lt;div class="field"&gt;<br/>        &lt;%= destination_form.label :name %&gt;<br/>        &lt;%= destination_form.text_field :name, placeholder: ”Old Trafford" %&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>    &lt;% end %&gt; <br/>  &lt;% end %&gt;<br/>  &lt;button class=“ui icon button” type=“submit”&gt;<br/>    &lt;i class="icon save"&gt;&lt;/i&gt;&amp;nbsp;Save<br/>  &lt;/button&gt;<br/>&lt;% end %&gt;</span></pre><p id="b112" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们有一个嵌套的表单，由<strong class="ka ir"> <em class="lu">行程</em> </strong>和<strong class="ka ir"> <em class="lu">目的地</em> </strong>组成。您现在可以看到表单是如何组织的。该表单在模型中有一个<code class="fe oi oj ok ny b"><strong class="ka ir">fields_for</strong></code>及其关联的<code class="fe oi oj ok ny b"><strong class="ka ir">accepts_nested_attributes_for</strong></code>。</p><p id="792b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">控制器怎么样？</p><pre class="nt nu nv nw gt nx ny nz oa aw ob bi"><span id="11d7" class="oc mr iq ny b gy od oe l of og"><strong class="ny ir">app/controllers/trips_controller.rb</strong></span><span id="f3d6" class="oc mr iq ny b gy oh oe l of og">class TripsController &lt; ApplicationController</span><span id="6cf3" class="oc mr iq ny b gy oh oe l of og">  def new<br/>    @trip = Trip.new<br/>    @trip.itineraries.build<br/>  end</span><span id="1110" class="oc mr iq ny b gy oh oe l of og">  def create <br/>    @trip = Trip.new(trip_params) <br/>    if @trip.save <br/>      redirect_to trip_path(@trip) <br/>    else<br/>      render :new <br/>    end<br/>  end</span><span id="3ec0" class="oc mr iq ny b gy oh oe l of og">  def trip_params<br/>    params.require(:trip)<br/>          .permit(:name, <br/>                  itineraries_attributes: [:id, :trip_id, :name, :date_from, :date_to, destinations_attributes: [:id, :itinerary_id, :name] ])<br/>  end</span><span id="36c3" class="oc mr iq ny b gy oh oe l of og">end</span></pre><p id="b111" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这真的很简单，rails会在幕后自动完成这些技巧。现在您已经知道如何在单个表单中创建对象及其关联。如果你想改变呢？</p><pre class="nt nu nv nw gt nx ny nz oa aw ob bi"><span id="f29e" class="oc mr iq ny b gy od oe l of og"><strong class="ny ir">app/controllers/trips_controller.rb</strong></span><span id="c7b6" class="oc mr iq ny b gy oh oe l of og">class TripsController &lt; ApplicationController<br/>  <br/>  ...  </span><span id="3798" class="oc mr iq ny b gy oh oe l of og">  def edit<br/>    @trip = Trip.find(params[:id]<br/>  end<br/> <br/>  ...</span><span id="4925" class="oc mr iq ny b gy oh oe l of og">end</span><span id="83a3" class="oc mr iq ny b gy oh oe l of og"><strong class="ny ir">app/views/trips/_form.html.erb</strong></span><span id="df51" class="oc mr iq ny b gy oh oe l of og">&lt;%= form_with @trip, class: ”ui form” do |trip_form| %&gt;<br/>&lt;div class="fields"&gt;<br/>  &lt;div class="field"&gt;<br/>    &lt;%= trip_form.label :name %&gt;<br/>    &lt;%= trip_form.text_field :name, placeholder: ”An exciting football trip” %&gt;<br/>  &lt;/div&gt;</span><span id="0a98" class="oc mr iq ny b gy oh oe l of og">  &lt;%= trip_form.fields_for :itineraries, @trip.itineraries do |itinerary_form| %&gt;<br/>    &lt;div class="fields"&gt;<br/>      &lt;div class="field"&gt;<br/>        &lt;%= itinerary_form.label :name %&gt;<br/>        &lt;%= itinerary_form.text_field :name, placeholder: ”Direct to Manchester” %&gt;<br/>      &lt;/div&gt;<br/>      &lt;div class="field"&gt;<br/>        &lt;%= itinerary_form.label :date_from %&gt;<br/>        &lt;div class="ui calendar"&gt;<br/>          &lt;div class="ui input left icon"&gt;<br/>          &lt;i class="calendar icon"&gt;&lt;/i&gt;<br/>          &lt;%= itinerary_form.text_field :text_field :date_from, placeholder: "Pick a start date" %&gt;<br/>        &lt;/div&gt;<br/>      &lt;/div&gt;<br/>      &lt;div class="field"&gt;<br/>        &lt;%= itinerary_form.label :date_to %&gt;<br/>        &lt;div class="ui calendar"&gt;<br/>          &lt;div class="ui input left icon"&gt;<br/>          &lt;i class="calendar icon"&gt;&lt;/i&gt;<br/>          &lt;%= itinerary_form.text_field :text_field :date_to, placeholder: "Pick a end date" %&gt;<br/>        &lt;/div&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/> <br/>    &lt;%= itinerary_form.fields_for :destinations, itinerary_form.object.destinations do |destination_form| %&gt;<br/>      &lt;div class="fields&gt;<br/>        &lt;div class="field"&gt;<br/>          &lt;%= destination_form.label :name %&gt;<br/>          &lt;%= destination_form.text_field :name, placeholder: ”Old Trafford" %&gt;<br/>        &lt;/div&gt;<br/>      &lt;/div&gt;<br/>    &lt;% end %&gt; <br/>  &lt;% end %&gt;<br/>  &lt;button class=“ui icon button” type=“submit”&gt;<br/>    &lt;i class="icon save"&gt;&lt;/i&gt;&amp;nbsp;Save<br/>  &lt;/button&gt;<br/>&lt;% end %&gt;</span></pre><p id="40c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以看到我们正在将实例<em class="lu">路线</em>和<em class="lu">目的地</em>传递给的<em class="lu">字段。</em></p></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><h1 id="59d2" class="mq mr iq bd ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn bi translated">删除关联的对象</h1><p id="5421" class="pw-post-body-paragraph jy jz iq ka b kb no kd ke kf np kh ki kj nq kl km kn nr kp kq kr ns kt ku kv ij bi translated">比方说，在同一张表格上，您想从您的旅程中删除一个目的地。您可以轻松地创建一个标记，让rails知道该项目将被删除。我们是这样做的:</p><pre class="nt nu nv nw gt nx ny nz oa aw ob bi"><span id="933c" class="oc mr iq ny b gy od oe l of og"><strong class="ny ir">app/models/itinerary.rb</strong></span><span id="5245" class="oc mr iq ny b gy oh oe l of og">class Itinerary &lt; ApplicationRecord<br/>  belongs_to :trip<br/>  has_many :destinations<br/>  accepts_nested_attributes_for :destinations, <strong class="ny ir">allow_destroy: true<br/></strong>end</span><span id="785c" class="oc mr iq ny b gy oh oe l of og"><strong class="ny ir">app/views/trips/_form.html.erb</strong></span><span id="c635" class="oc mr iq ny b gy oh oe l of og">&lt;%= form_with @trip, class: ”ui form” do |trip_form| %&gt;</span><span id="971d" class="oc mr iq ny b gy oh oe l of og">...</span><span id="021e" class="oc mr iq ny b gy oh oe l of og">    &lt;%= itinerary_form.fields_for :destinations, itinerary_form.object.destinations do |destination_form| %&gt;<br/>      &lt;div class="fields&gt;<br/>        &lt;div class="field"&gt;<br/>          &lt;%= destination_form.label :name %&gt;<br/>          &lt;%= destination_form.text_field :name, placeholder: ”Old Trafford" %&gt;<br/>        &lt;/div&gt;<br/>        &lt;div class=“field”&gt;<br/>          &lt;div class=“ui checkbox”&gt;<br/>            &lt;%= destination_form.check_box :_destroy %&gt;&lt;%= destination_form.label ”Delete?” %&gt;<br/>          &lt;/div&gt;<br/>        &lt;/div&gt;<br/>      &lt;/div&gt;<br/>    &lt;% end %&gt;</span><span id="8e67" class="oc mr iq ny b gy oh oe l of og">...</span><span id="0de5" class="oc mr iq ny b gy oh oe l of og">&lt;% end %&gt;</span><span id="403b" class="oc mr iq ny b gy oh oe l of og"><strong class="ny ir">app/controllers/trips_controller.rb</strong></span><span id="ac52" class="oc mr iq ny b gy oh oe l of og">class TripsController &lt; ApplicationController<br/>  <br/>  ...</span><span id="602d" class="oc mr iq ny b gy oh oe l of og">  def trip_params<br/>    params.require(:trip)<br/>          .permit(:name, <br/>                  itineraries_attributes: [:id, :trip_id, :name, :date_from, :date_to, destinations_attributes: [:id, :itinerary_id, :name, <strong class="ny ir">:_destroy</strong>] ])<br/>  end</span><span id="c2c2" class="oc mr iq ny b gy oh oe l of og">...</span><span id="e38a" class="oc mr iq ny b gy oh oe l of og">end</span></pre><p id="6035" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在路线模型中，您必须启用allow_destroy选项，并在控制器中允许使用<code class="fe oi oj ok ny b">:_destroy</code>属性。然后只需在表单中添加一个复选框。就是这样！</p><p id="2261" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您想在同一个表单中添加一个新的目的地，或者您需要从远程位置加载动态数据并显示在下拉框中，事情会变得更加复杂。享受构建你的下一个表单，它可能会令人沮丧，但却很有成就感。</p><p id="79cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下次见！</p></div></div>    
</body>
</html>