<html>
<head>
<title>How Caching Can Save Build Minutes in Bitbucket Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">缓存如何节省位桶管道中的构建时间</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-caching-can-save-build-minutes-in-bitbucket-pipelines-219d310ab277?source=collection_archive---------9-----------------------#2020-09-14">https://levelup.gitconnected.com/how-caching-can-save-build-minutes-in-bitbucket-pipelines-219d310ab277?source=collection_archive---------9-----------------------#2020-09-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6f6f5baec961ebe1f6663b1a5d842375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vTHmZhEs2C4nYurA"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kc" href="https://unsplash.com/@aronvisuals?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Aron视觉</a>拍摄的照片</figcaption></figure><p id="66ef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，我将帮助你学习如何在Bitbucket管道中正确设置缓存。这将帮助您加快管道的构建时间，因此您可以更快地交付，并花费更少的构建时间。我还将分享另一个关于如何加快你的管道的想法。</p><h1 id="1ccd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">什么是高速缓存？</h1><blockquote class="lz"><p id="c743" class="ma mb iq bd mc md me mf mg mh mi la dk translated">缓存(发音为“cashing”)是将数据存储在<a class="ae kc" href="https://searchstorage.techtarget.com/definition/cache" rel="noopener ugc nofollow" target="_blank">缓存</a>中的过程。</p><p id="5026" class="ma mb iq bd mc md me mf mg mh mi la dk translated">缓存是一个临时存储区域。例如，您通过查看网页自动请求的文件存储在您硬盘上浏览器的<a class="ae kc" href="https://searchwindowsserver.techtarget.com/definition/directory" rel="noopener ugc nofollow" target="_blank">目录</a>下的缓存子目录中。当您返回到最近查看过的页面时，浏览器可以从缓存而不是原始服务器中获取这些文件，从而节省您的时间并减轻网络的额外流量负担。</p><p id="3873" class="ma mb iq bd mc md me mf mg mh mi la dk translated">来源:<a class="ae kc" href="https://whatis.techtarget.com/definition/caching" rel="noopener ugc nofollow" target="_blank">whatis.techtarget.com</a></p></blockquote><h1 id="67ed" class="lb lc iq bd ld le lf lg lh li lj lk ll lm mj lo lp lq mk ls lt lu ml lw lx ly bi translated">比特桶管道中可以缓存什么？</h1><blockquote class="lz"><p id="796e" class="ma mb iq bd mc md me mf mg mh mi la dk translated">位桶管道能够在构建之间缓存外部构建依赖项和目录，如第三方库，从而提供更快的构建，并减少所消耗的构建分钟数。</p><p id="6efc" class="ma mb iq bd mc md me mf mg mh mi la dk translated">来源:<a class="ae kc" href="https://support.atlassian.com/bitbucket-cloud/docs/cache-dependencies/" rel="noopener ugc nofollow" target="_blank">support.atlassian.com</a></p></blockquote><p id="4a18" class="pw-post-body-paragraph kd ke iq kf b kg mm ki kj kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">根据您在管道中所做的事情，不同的内容可以缓存在Bitbucket管道中。最大的好处是存储由包管理器检索的下载的第三方库，这样你就不必一遍又一遍地下载外部库了。缓存Docker图像/层或缓存构建步骤也可以节省大量时间，后者也可以作为<a class="ae kc" href="https://support.atlassian.com/bitbucket-cloud/docs/use-artifacts-in-steps/" rel="noopener ugc nofollow" target="_blank">工件</a>在步骤之间共享。</p><p id="6c88" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以使用预定义的缓存，如<code class="fe mr ms mt mu b">docker</code>、<code class="fe mr ms mt mu b">pip</code>、<code class="fe mr ms mt mu b">node</code>和<code class="fe mr ms mt mu b">maven</code>，这些已经缓存了特定的文件夹。还可以设置<a class="ae kc" href="https://support.atlassian.com/bitbucket-cloud/docs/cache-dependencies/#Custom-caches-for-other-build-tools-and-directories" rel="noopener ugc nofollow" target="_blank">自定义缓存</a>，这里要自己设置需要缓存的路径。</p><h1 id="57ea" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">很高兴知道</h1><p id="60ab" class="pw-post-body-paragraph kd ke iq kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">下面简短扼要地总结一下你应该知道的事情。</p><ul class=""><li id="1434" class="na nb iq kf b kg kh kk kl ko nc ks nd kw ne la nf ng nh ni bi translated">成功构建时将存储一个缓存(当还没有缓存时)</li><li id="82a3" class="na nb iq kf b kg nj kk nk ko nl ks nm kw nn la nf ng nh ni bi translated">仅存储小于1GB(压缩)的缓存</li><li id="c862" class="na nb iq kf b kg nj kk nk ko nl ks nm kw nn la nf ng nh ni bi translated">缓存将在一周后过期</li><li id="9415" class="na nb iq kf b kg nj kk nk ko nl ks nm kw nn la nf ng nh ni bi translated">您不应该缓存敏感数据</li><li id="6e1c" class="na nb iq kf b kg nj kk nk ko nl ks nm kw nn la nf ng nh ni bi translated">您可以手动清除缓存</li></ul><h1 id="1c1a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">缓存第三方包</h1><p id="b55d" class="pw-post-body-paragraph kd ke iq kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">我将分享几个Bitbucket配置文件，展示如何缓存下载的第三方包，使用<code class="fe mr ms mt mu b">node</code>和<code class="fe mr ms mt mu b">pip</code>作为包管理器。我将提供有缓存和没有缓存的管道运行时间的结果。</p><h2 id="fdac" class="no lc iq bd ld np nq dn lh nr ns dp ll ko nt nu lp ks nv nw lt kw nx ny lx nz bi translated">节点缓存</h2><p id="efc0" class="pw-post-body-paragraph kd ke iq kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">我从一个简单的管道配置开始，在那里我们安装了<code class="fe mr ms mt mu b">tensorflow</code>。我认为在管道中你永远不会需要tensorflow，但这只是因为我想要一个更大的例子。这当然可以是任何包，甚至是requirements.txt。</p><pre class="oa ob oc od gt oe mu of og aw oh bi"><span id="fa22" class="no lc iq mu b gy oi oj l ok ol">image: node:10.15.3</span><span id="c611" class="no lc iq mu b gy om oj l ok ol">pipelines:<br/>  default:<br/>    - step:<br/>        script: <br/>          - npm install tensorflow@0.7.0</span></pre><p id="f2fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一次运行这个管道用了40秒，第二次和第三次分别用了15秒和14秒。让我们看看启用缓存是否真的改善了管道运行时间，这使得平均<strong class="kf ir"> 23秒</strong>。</p><pre class="oa ob oc od gt oe mu of og aw oh bi"><span id="4c95" class="no lc iq mu b gy oi oj l ok ol">image: node:10.15.3</span><span id="d8bc" class="no lc iq mu b gy om oj l ok ol">pipelines:<br/>  default:<br/>    - step:<br/>        caches:<br/>          - node<br/>        script: <br/>          - npm install tensorflow@0.7.0</span></pre><p id="93d6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一次运行上述管道用了20秒，在第一次运行时，它还没有缓存，所以它还负责创建和存储缓存，这当然需要更长的时间。我们应该在第二次和第三次运行中看到一些差异。第二次跑用了11秒，第三次跑用了12秒，平均约为<strong class="kf ir"> 14秒。</strong>因此在节点包上使用缓存已经节省了至少几秒钟。</p><h2 id="6b28" class="no lc iq bd ld np nq dn lh nr ns dp ll ko nt nu lp ks nv nw lt kw nx ny lx nz bi translated">Pip缓存</h2><p id="7965" class="pw-post-body-paragraph kd ke iq kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">我们可以对Python和pip做同样的事情，并希望我用tensorflow库再次演示它。下面是我用过的管道配置。</p><pre class="oa ob oc od gt oe mu of og aw oh bi"><span id="8497" class="no lc iq mu b gy oi oj l ok ol">image: python:3.7.3</span><span id="3d02" class="no lc iq mu b gy om oj l ok ol">pipelines:<br/>  default:<br/>    - step:<br/>        script: <br/>          - pip install tensorflow==2.3.0</span></pre><p id="a830" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一次运行，没有缓存，用了47秒，第二次用了38秒，第三次用了1分28秒。没有缓存的平均运行时间:大约<strong class="kf ir"> 58秒</strong>。我更改了管道配置，并为<code class="fe mr ms mt mu b">pip</code>添加了缓存。</p><pre class="oa ob oc od gt oe mu of og aw oh bi"><span id="24af" class="no lc iq mu b gy oi oj l ok ol">image: python:3.7.3</span><span id="d0b7" class="no lc iq mu b gy om oj l ok ol">pipelines:<br/>  default:<br/>    - step:<br/>        caches:<br/>          - pip<br/>        script: <br/>          - pip install tensorflow==2.3.0</span></pre><p id="4ede" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">启用缓存会产生以下结果:1分14秒(没有现有缓存)、42秒和43秒。平均运行时间:<strong class="kf ir"> 53秒</strong>。从平均值来看，与没有缓存的管道相比，这又是一个改进。</p><h2 id="7c55" class="no lc iq bd ld np nq dn lh nr ns dp ll ko nt nu lp ks nv nw lt kw nx ny lx nz bi translated">缓存的评估和缺点</h2><p id="ecb9" class="pw-post-body-paragraph kd ke iq kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">结果上下都有“离群值”，这让我怀疑它们是不是真的很好的例子。相同的配置有时可能相差几十秒，尽管缓存启用管道的运行时间看起来更稳定，这可能是由于下载第三方包的延迟。</p><p id="14ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当已经存在同名的缓存时，缓存将不会更新，即使您缓存的文件夹中的内容发生了变化。当您想要创建新的缓存时，应该在Bitbucket中的“管道”页面删除特定的缓存。此外，1 GB的限制可以很快达到，因此缓存仍然很少或没有用处。</p><h1 id="83a3" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">其他方法</h1><p id="b43c" class="pw-post-body-paragraph kd ke iq kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">当您的步骤中需要外部库时，另一种方法是为您的管道创建自己的Docker容器。您可以为整个管道设置Docker容器，也可以按步骤设置。如果您有一个lint步骤(使用已经安装了pylint的Python映像)和一个测试步骤(安装了测试Python应用程序的所有包),这将非常方便。这确保您不必一次又一次地安装这些依赖项。请看下面的例子，假设镜像是我自己构建并部署到DockerHub的，包含Python 3.7.3、pylint 2.6.0和pytest 6.0.2，这些名字和版本都是Docker镜像名称和标签的一部分。</p><pre class="oa ob oc od gt oe mu of og aw oh bi"><span id="5f56" class="no lc iq mu b gy oi oj l ok ol">image:<br/>  name: sschrijver/python-pylint-pytest:3.7.3-2.6.0-6.0.2</span><span id="b177" class="no lc iq mu b gy om oj l ok ol">pipelines:<br/>  default:<br/>    - step:<br/>        name: Lint<br/>        script: <br/>          - pylint .<br/>    - step:<br/>        name: Test<br/>        script: <br/>          - pytest .</span></pre><p id="5e13" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此图像的docker文件可能如下所示:</p><pre class="oa ob oc od gt oe mu of og aw oh bi"><span id="8c26" class="no lc iq mu b gy oi oj l ok ol">FROM python:3.7.3</span><span id="d578" class="no lc iq mu b gy om oj l ok ol">RUN pip install pylint==2.6.0 pytest==6.0.2</span></pre><p id="5673" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者你可以使用与上面提到的相同的原理来设置每一步的容器。</p><pre class="oa ob oc od gt oe mu of og aw oh bi"><span id="7f46" class="no lc iq mu b gy oi oj l ok ol">pipelines:<br/>  default:<br/>    - step:<br/>        name: Lint<br/>        image: sschrijver/python-pylint:3.7.3-2.6.0<br/>        script: <br/>          - pylint .<br/>    - step:<br/>        name: Test<br/>        image: sschrijver/python-pytest:3.7.3-6.0.2<br/>        script: <br/>          - pytest .</span></pre><h1 id="c363" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">问题、建议或反馈</h1><p id="1fd2" class="pw-post-body-paragraph kd ke iq kf b kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">如果您对本文有任何问题、建议或反馈，请告诉我！</p></div></div>    
</body>
</html>