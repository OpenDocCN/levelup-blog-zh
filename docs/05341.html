<html>
<head>
<title>Guide to StarCraft II Proto API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">星际争霸2原型API指南</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/guide-to-starcraft-ii-proto-api-264811da8a50?source=collection_archive---------11-----------------------#2020-08-20">https://levelup.gitconnected.com/guide-to-starcraft-ii-proto-api-264811da8a50?source=collection_archive---------11-----------------------#2020-08-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/068ca54749a0ce25bfb4a1eb15651de2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*onNN4P1jCC8DyS9GxUAm1w.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">暴雪娱乐公司的官方作品</figcaption></figure><p id="08fe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇文章将带你经历为星际争霸2客户端编写你自己的API的最初步骤。这是<strong class="kf ir">根本不需要的</strong>，社区API存在于大多数流行语言中。然而，这篇文章对基本的SC2 API包装器的工作原理提供了一些见解。</p><p id="4649" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">客户端公开了一个请求-响应风格的API，该API接受<em class="lb"> protobuf </em>消息。我为不熟悉这种格式的读者写了一篇关于<em class="lb"> protobuf </em>的文章，但它本质上只是一种二进制数据交换格式。</p><h1 id="3040" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">启动客户端</h1><p id="7732" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated"><a class="ae kc" href="https://starcraft2.com/" rel="noopener ugc nofollow" target="_blank">下载星际争霸2客户端</a>如果你还没有安装的话——它是免费的(自2017年11月14日起),不需要完整版。我们将使用默认的游戏客户端，但在一个特殊的模式下启动它。这种模式没有任何游戏内菜单。</p><p id="35e4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">星际争霸2客户端在更新时会创建一个新的文件夹(这大概主要是为了支持旧版本的游戏回放)——因此你可能会发现你的电脑上有多个客户端文件夹。导航到版本号最高的版本，并使用<em class="lb"> localhost </em>和所需的端口启动它。</p><p id="17db" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> Windows: <br/> </strong> <em class="lb">在Windows上我们还需要指定工作目录是\Support还是\Support64。否则将导致“iccuc52.dll”不存在的错误。</em></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="2463" class="mo ld iq mk b gy mp mq l mr ms">cd 'C:\Program Files (x84)\StarCraft II\'<br/>start /D .\Support .\Versions\Base{version}\SC2.exe -listen 127.0.0.1 -port 8168</span></pre><p id="3e34" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> Linux: </strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="e991" class="mo ld iq mk b gy mp mq l mr ms">cd 'StarCraft II\Versions\Base{version}\'<br/>SC2_x64 -listen 127.0.0.1 -port 8168 -headlessNoRender</span></pre><p id="04bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">苹果操作系统:</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="5426" class="mo ld iq mk b gy mp mq l mr ms">cd '/Applications/StarCraft II/Versions/Base{version}/'<br/>open SC2.app --args -listen 127.0.0.1 -port 8168</span></pre><p id="76e8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果工作正常，它将启动带有<strong class="kf ir">黑屏</strong>和图标星际争霸2鼠标的客户端——这是期望的行为。一切都好。</p><p id="dfff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">客户端还支持几个可选参数，在同时运行多个客户端时会派上用场；</p><ul class=""><li id="38b6" class="mt mu iq kf b kg kh kk kl ko mv ks mw kw mx la my mz na nb bi translated">-displaymode {1/0} <em class="lb"> … 1为全屏，0为窗口模式</em></li><li id="5d10" class="mt mu iq kf b kg nc kk nd ko ne ks nf kw ng la my mz na nb bi translated">-windowwidth {int} <em class="lb"> …以像素为单位的窗口宽度</em></li><li id="638b" class="mt mu iq kf b kg nc kk nd ko ne ks nf kw ng la my mz na nb bi translated">-windowheight {int} <em class="lb"> …以像素为单位的窗口高度</em></li><li id="7cdf" class="mt mu iq kf b kg nc kk nd ko ne ks nf kw ng la my mz na nb bi translated">-windowx {int} <em class="lb"> …以像素为单位的窗口水平位置</em></li><li id="3f56" class="mt mu iq kf b kg nc kk nd ko ne ks nf kw ng la my mz na nb bi translated">-windowy {int} <em class="lb"> …以像素为单位的窗口垂直位置</em></li></ul></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><h1 id="5ba4" class="lc ld iq bd le lf no lh li lj np ll lm ln nq lp lq lr nr lt lu lv ns lx ly lz bi translated">连接到客户端</h1><p id="cdce" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">星际争霸2客户端会在你启动应用时指定的端口上打开一个网络套接字。在启动多个实例时，请记住使用可用端口，并为每个客户端提供一个唯一的端口。在我们的例子中，API的绝对URI读数为:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="3b9b" class="mo ld iq mk b gy mp mq l mr ms">ws://127.0.0.1:8168/sc2api</span></pre><p id="f189" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以使用自己选择的语言连接到这个套接字，并开始操作客户端。API期待一个<a class="ae kc" href="https://github.com/Blizzard/s2client-proto/blob/01ab351e21c786648e4c6693d4aad023a176d45c/s2clientprotocol/sc2api.proto#L84" rel="noopener ugc nofollow" target="_blank">请求</a>消息，并将使用一个<a class="ae kc" href="https://github.com/Blizzard/s2client-proto/blob/01ab351e21c786648e4c6693d4aad023a176d45c/s2clientprotocol/sc2api.proto#L121" rel="noopener ugc nofollow" target="_blank">响应</a>消息进行响应。这些消息是简单的字节数组，可以使用星际争霸2的官方protobuf模式来解释。</p><p id="af36" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了确认连接，无需处理protobuf，可以将字节数组<em class="lb"> {66，0} </em>发送给客户端。这对应于<em class="lb">请求{ Quit = RequestQuit() } </em>的二进制形式，在接收时将使应用程序关闭。下面是实现这一点的C#代码片段。</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="2c33" class="mo ld iq mk b gy mp mq l mr ms">using System;<br/>using System.Diagnostics;<br/>using System.Net.WebSockets;<br/>using System.Threading;</span><span id="9625" class="mo ld iq mk b gy nt mq l mr ms">namespace AdequateSource {<br/>  class StarCraftConnectionExample {<br/>    public void LaunchClient() {<br/>      // Default folder path for Windows<br/>      string folderPath = @"C:\Program Files (x86)\StarCraft II";<br/>      var pInfo = new ProcessStartInfo {<br/>        // Location of correct AI client<br/>        FileName = $ "{folderPath}\\Versions\\Base60321\\SC2.exe",<br/>        // Displaymode 0 = windowed mode<br/>        Arguments = @"-listen 127.0.0.1 -port 8168 -displaymode 0",<br/>        // Give working directory to prevent missing icuin52.dll<br/>        WorkingDirectory = $ "{folderPath}\\Support"<br/>      };<br/>      Process.Start(pInfo);<br/>    }</span><span id="6055" class="mo ld iq mk b gy nt mq l mr ms">public ClientWebSocket ConnectToClient() {  <br/>      // URI = ws://{ipaddress}:{port}/sc2api<br/>      var uri = new Uri("ws://127.0.0.1:8168/sc2api");<br/>      var ws = new ClientWebSocket();<br/>      ws.ConnectAsync(uri, CancellationToken.None).Wait();<br/>      return ws;<br/>    }</span><span id="741c" class="mo ld iq mk b gy nt mq l mr ms">public void SendQuit(ClientWebSocket ws) {<br/>      // Binary representation of a Quit-Command<br/>      var message = new byte[] {66,0};<br/>      // Send command to StarCraft II Client<br/>      ws.SendAsync(new ArraySegment &lt; byte &gt; (),<br/>      WebSocketMessageType.Binary,<br/>        true,<br/>        CancellationToken.None<br/>      );<br/>    }<br/>  }<br/>}</span></pre></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><h1 id="0c06" class="lc ld iq bd le lf no lh li lj np ll lm ln nq lp lq lr nr lt lu lv ns lx ly lz bi translated">客户端控制流</h1><p id="2c60" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">在深入研究特定的请求/响应消息之前，理解客户机可能处于的不同状态是有益的。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/e246dda0729d174519d34d6bb6788d4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eyuH95Aq6mab8iY0ywWyXA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">星际争霸2客户端的简化状态图。由<a class="ae kc" href="https://adequatesource.com/" rel="noopener ugc nofollow" target="_blank">充足资源</a>绘制的图表</figcaption></figure><p id="7c61" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">客户端开始于<em class="lb">启动</em>状态，这允许你创建一个游戏或者加入一个现有的游戏。这相当于在游戏的普通版本中创建或加入多人游戏大厅。</p><p id="864a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">加入游戏将导致客户端状态机转换到<em class="lb">游戏内模式</em>，这是主要模式。星际争霸2通过小的逻辑步骤来计算一切，这些被称为<em class="lb">模拟步骤</em>。</p><p id="6e7e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认情况下，客户端将等待所有连接的代理发送一个<a class="ae kc" href="https://github.com/Blizzard/s2client-proto/blob/01ab351e21c786648e4c6693d4aad023a176d45c/s2clientprotocol/sc2api.proto#L391" rel="noopener ugc nofollow" target="_blank">步骤请求</a>，然后再进一步推进游戏。在这个待定状态下，你的代理应该请求游戏信息，计算期望的动作，并向客户提交单位订单。一旦你的代理通过发送一个步骤请求来指示游戏已经准备好，游戏将继续进行。这基本上一直持续到找到赢家。</p><p id="4031" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">游戏也可以在实时模式下进行，这意味着客户端会自动推进模拟。它将以“更快”的游戏速度运行，相当于每秒22.5个模拟步骤。</p><p id="9996" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">找到获胜者后，客户端将转换到<em class="lb">结束的</em>状态，这对应于正常游戏后显示的统计屏幕。从这里你需要重启游戏(多人游戏不支持)或者离开。</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><h1 id="5228" class="lc ld iq bd le lf no lh li lj np ll lm ln nq lp lq lr nr lt lu lv ns lx ly lz bi translated">生成Protobuf文件</h1><p id="98d5" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">protobuf消息文件使用<a class="ae kc" href="https://developers.google.com/protocol-buffers/docs/downloads" rel="noopener ugc nofollow" target="_blank">协议</a>生成。它接受协议缓冲区模式文件，并生成带有必要数据模型的源文件。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/459eaa3947a6bf9883c42307c5c6996f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9V1pEXgpBQDvBt58YSEMEQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">协议缓冲文件生成。图由<a class="ae kc" href="https://adequatesource.com/" rel="noopener ugc nofollow" target="_blank">充足的资源</a></figcaption></figure><p id="91d6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有很多方法可以获得protocol，但是我发现最简单的方法是安装protocol，至少在NET Core universe中，是通过nuget包。对于其他语言<a class="ae kc" href="https://developers.google.com/protocol-buffers/docs/downloads" rel="noopener ugc nofollow" target="_blank">请参考此处。</a></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="382c" class="mo ld iq mk b gy mp mq l mr ms">dotnet new console<br/>dotnet add package Google.Protobuf.Tools --version 3.13.0</span></pre><p id="694a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">这将把一个预编译的版本放在Windows的这个位置:</em></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="7d3b" class="mo ld iq mk b gy mp mq l mr ms">%userprofile%\.nuget\packages\google.protobuf.tools\{version}\tools</span></pre><p id="9f82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">…这里是Linux和Mac OS: </em></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="b8e1" class="mo ld iq mk b gy mp mq l mr ms">~/.nuget/packages/google.protobuf.tools/{version}/tools</span></pre><p id="40bf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://github.com/Blizzard/s2client-proto" rel="noopener ugc nofollow" target="_blank">下载星际争霸2原型文件</a>并用protocol编译它们。如果使用<a class="ae kc" href="https://developers.google.com/protocol-buffers/docs/cpptutorial" rel="noopener ugc nofollow" target="_blank"> C++ </a>、<a class="ae kc" href="https://developers.google.com/protocol-buffers/docs/javatutorial" rel="noopener ugc nofollow" target="_blank"> Java </a>和<a class="ae kc" href="https://developers.google.com/protocol-buffers/docs/javatutorial" rel="noopener ugc nofollow" target="_blank"> Python </a>就会生成你需要的文件。</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="c22f" class="mo ld iq mk b gy mp mq l mr ms">protoc -I={path} --cpp_output={dir} {path}\s2clientprotocol\sc2api.proto</span></pre><h2 id="fe3e" class="mo ld iq bd le nw nx dn li ny nz dp lm ko oa ob lq ks oc od lu kw oe of ly og bi translated">升级到Proto3 (C#、Dart、Go要求)</h2><p id="6c5d" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">星际争霸2 API是用proto2写的，C#，Dart，Go都不支持。为了使用这些语言，我们必须首先将proto文件升级到proto3。</p><ul class=""><li id="7fad" class="mt mu iq kf b kg kh kk kl ko mv ks mw kw mx la my mz na nb bi translated">将可选的关键字从所有。默认情况下，proto3中的proto文件作为字段是可选的。</li><li id="b116" class="mt mu iq kf b kg nc kk nd ko ne ks nf kw ng la my mz na nb bi translated">添加一个索引0选项，如果没有的话，添加到。原型文件。这些永远不会被使用——但它是<em class="lb"> proto3 </em>中的一个要求。重要的是你要创造一个新值，并且不要改变现有值的索引。</li><li id="e75a" class="mt mu iq kf b kg nc kk nd ko ne ks nf kw ng la my mz na nb bi translated">从<em class="lb"> syntax = "proto2" </em>更新为<em class="lb"> syntax = "proto3 "。</em></li></ul><p id="90a6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些变化将proto模式升级到proto3，允许我们使用<em class="lb">协议</em>将其编译成C#、Dart或Go。</p><h1 id="2787" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">结论</h1><p id="88bc" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">这应该能让你越过为星际争霸2编写自己的API的最大障碍。或者，您可以选择许多预制的SC2 API包装器中的一个——例如NydusNetwork。网络核心</p><div class="oh oi gp gr oj ok"><a href="https://adequatesource.com/nydusnetwork/" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">[adq_src]纽约网络</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">本文假设您正在使用。NET核心，并打算使用NydusNetwork。我尝试过…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">adequatesource.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy jw ok"/></div></div></a></div><p id="ac86" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">感谢</em> <a class="ae kc" href="https://github.com/tewalds" rel="noopener ugc nofollow" target="_blank"> <em class="lb">提莫</em> </a> <em class="lb">对Linux的修正。</em></p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><p id="8bb1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">原载于2020年8月20日https://adequatesource.com</em><em class="lb">的</em> <a class="ae kc" href="https://adequatesource.com/s2client-proto/" rel="noopener ugc nofollow" target="_blank"> <em class="lb">。</em></a></p></div></div>    
</body>
</html>