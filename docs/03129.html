<html>
<head>
<title>How to Set Up Cloudflare with Vercel (formerly ZEIT)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Vercel(以前叫ZEIT)设置Cloudflare</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-set-up-cloudflare-with-zeit-93daa7d45dd?source=collection_archive---------3-----------------------#2020-04-21">https://levelup.gitconnected.com/how-to-set-up-cloudflare-with-zeit-93daa7d45dd?source=collection_archive---------3-----------------------#2020-04-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bf67" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我如何使用Cloudflare代理我的Vercel项目的分步指南。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/4cce7c5ccbe55494e464a2b188646c65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QnTfjThYp-uuNp3XdIrfmw.jpeg"/></div></div></figure><p id="2fe5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">更新22/04/20 </strong> <em class="ln">:自本文首次发表后，</em> <a class="ae lo" href="https://vercel.com/blog/zeit-is-now-vercel" rel="noopener ugc nofollow" target="_blank"> <em class="ln"> ZEIT已更名为Vercel </em> </a> <em class="ln">。本文中涉及的步骤仍然是相关的，如果有必要，将来还会更新。</em></p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><p id="54c7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当我第一次尝试用Vercel(以前的ZEIT)设置Cloudflare时，我一直遇到问题，主要是重定向循环和“无效域配置”错误。经过数小时的研究和测试，我找到了防弹解决方案。我是这样做的。</p><h1 id="da81" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">内容</h1><ol class=""><li id="d820" class="mo mp iq kt b ku mq kx mr la ms le mt li mu lm mv mw mx my bi translated">创建一个Vercel项目。</li><li id="9a56" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">创建Cloudflare站点。</li><li id="a786" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">将Cloudflare管理的域连接到Vercel项目。</li><li id="7c9d" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">将Cloudflare管理的子域连接到Vercel项目。</li><li id="41e3" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">总结。</li></ol><h1 id="20cb" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">创建一个Vercel项目</h1><p id="0817" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ne lc ld le nf lg lh li ng lk ll lm ij bi translated">我首先通过以下方式将一个名为'<a class="ae lo" href="https://github.com/domjtalbot/a-song-of-vercel-and-cloudflare" rel="noopener ugc nofollow" target="_blank">a-song-of-vercel-and-cloud flare</a>的现有GitHub存储库导入到Vercel中:</p><ol class=""><li id="4b4c" class="mo mp iq kt b ku kv kx ky la nh le ni li nj lm mv mw mx my bi translated">在Vercel仪表板中选择“导入项目”按钮。</li><li id="a8ca" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">选择“Git Repository”选项下的“Continue”按钮。</li><li id="7a46" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">将我的项目命名为‘a-song-of-vercel-and-cloud flare’，以保持它与存储库一致。</li><li id="011f" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">将项目根目录和构建设置保留为默认设置。</li></ol><p id="b605" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Vercel随后启动了第一次构建，并分配了一个<a class="ae lo" href="http://now.sh" rel="noopener ugc nofollow" target="_blank"> now.sh </a>子域。构建完成后，我在浏览器中打开了URL，以确保一切正常。</p><h1 id="62c3" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">创建Cloudflare站点</h1><p id="368f" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ne lc ld le nf lg lh li ng lk ll lm ij bi translated">我的下一步是通过以下方式创建一个Cloudflare站点:</p><ol class=""><li id="eae7" class="mo mp iq kt b ku kv kx ky la nh le ni li nj lm mv mw mx my bi translated">在Cloudflare控制面板中选择“添加站点”按钮。</li><li id="c09c" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">进入我的领域。</li><li id="2d0f" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">选择“免费”计划。</li><li id="d0ea" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">查看Cloudflare找到的DNS记录，并丢弃那些我不需要的记录。</li><li id="6281" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">将我的域名服务器更新到Cloudflare的:<code class="fe nk nl nm nn b">ajay.ns.cloudflare.com</code>和<code class="fe nk nl nm nn b">sima.ns.cloudflare.com</code>。</li></ol><p id="a079" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">由于名称服务器的改变可能需要几个小时才能生效，所以我喝咖啡来打发时间。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/54d6c150023c4ca899f999520dfcd0bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1WQujJUDo-AQnS_K"/></div></div><figcaption class="np nq gj gh gi nr ns bd b be z dk translated">照片由<a class="ae lo" href="https://unsplash.com/@daniel_curran?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">丹尼尔·柯伦</a>在<a class="ae lo" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</figcaption></figure><h1 id="247d" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">将Cloudflare管理的域连接到Vercel</h1><p id="3e04" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ne lc ld le nf lg lh li ng lk ll lm ij bi translated">下一步是使用Vercel的DNS验证方法，将我的域名添加到我的Vercel帐户中。我是这样做的:</p><ol class=""><li id="7f20" class="mo mp iq kt b ku kv kx ky la nh le ni li nj lm mv mw mx my bi translated">在Cloudflare中创建一个名为<code class="fe nk nl nm nn b">@</code>的<code class="fe nk nl nm nn b">CNAME</code>记录，目标为<code class="fe nk nl nm nn b">alias.zeit.co</code>，并启用代理。</li><li id="26ee" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">打开终端，运行<code class="fe nk nl nm nn b">now domains add asongofzandc.xyz</code>检索验证码。</li><li id="414b" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">在Cloudflare中创建一个名为<code class="fe nk nl nm nn b">_now</code>的<code class="fe nk nl nm nn b">TXT</code>记录，在“内容”字段中包含验证码。</li><li id="a3a6" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">打开终端并运行<code class="fe nk nl nm nn b">now domains verify asongofzandc.xyz</code>。</li></ol><p id="21d4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下一步是在Cloudflare中设置HTTPS，这包括四个阶段:加密、异常、重定向和测试。我发现HTTPS是成功的关键。</p><h2 id="9aa1" class="nt lx iq bd ly nu nv dn mc nw nx dp mg la ny nz mi le oa ob mk li oc od mm oe bi translated">第一阶段:加密</h2><p id="7e99" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ne lc ld le nf lg lh li ng lk ll lm ij bi translated">为了在Cloudflare和Vercel之间创建安全连接，我在“SSL/TLS”选项卡中将Cloudflare的加密级别设置为“完全(严格)”。如果Vercel没有“Cloudflare Origin CA Certificate”，我会将加密级别设置为“Full”。</p><h2 id="6d95" class="nt lx iq bd ly nu nv dn mc nw nx dp mg la ny nz mi le oa ob mk li oc od mm oe bi translated">第二阶段:例外</h2><p id="9391" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ne lc ld le nf lg lh li ng lk ll lm ij bi translated">当Vercel构建一个项目时，构建过程的最后一步是发布一个SSL证书。作为这个步骤的一部分，Vercel向<code class="fe nk nl nm nn b">&lt;domain&gt;/.well-known/acme-challenge</code>发出一个HTTP请求。如果这个HTTP请求被重定向到HTTPS，Vercel将无法发布SSL证书。</p><p id="f84f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了防止这个特定的请求被重定向，我通过以下方式创建了一个HTTPS例外页面规则:</p><ol class=""><li id="139e" class="mo mp iq kt b ku kv kx ky la nh le ni li nj lm mv mw mx my bi translated">在Cloudflare控制面板的“页面规则”选项卡中选择“创建页面规则”。</li><li id="ee70" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">在“如果URL匹配”文本框中输入<code class="fe nk nl nm nn b">*asongofzandc.xyz/.well-known/*</code>。</li><li id="8a57" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">从“选择设置”下拉列表中选择“SSL ”,然后从“选择SSL设置”下拉列表中选择“关闭”。</li><li id="5126" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">选择“保存并部署”按钮。</li></ol><h2 id="28a2" class="nt lx iq bd ly nu nv dn mc nw nx dp mg la ny nz mi le oa ob mk li oc od mm oe bi translated">阶段3:重定向</h2><p id="d3e4" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ne lc ld le nf lg lh li ng lk ll lm ij bi translated">为了确保所有其他HTTP请求继续重定向到HTTPS，我创建了另一个页面规则:</p><ol class=""><li id="33d0" class="mo mp iq kt b ku kv kx ky la nh le ni li nj lm mv mw mx my bi translated">禁用“SSL/TLS”选项卡的“边缘证书”部分中的“始终使用HTTPS”设置。</li><li id="db30" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">在“页面规则”选项卡中选择“创建页面规则”按钮。</li><li id="17a4" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">在“如果URL匹配”文本框中输入<code class="fe nk nl nm nn b"><a class="ae lo" rel="noopener ugc nofollow" target="_blank" href="/*asongofzandc.xyz/">http://*asongofzandc.xyz/</a>*</code>。</li><li id="4266" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">从“选择设置”下拉列表中选择“总是使用HTTPS”。</li><li id="3563" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">从“订单”下拉列表中选择“最后”。</li><li id="8bdb" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">选择“保存并部署”按钮。</li></ol><h2 id="f4c2" class="nt lx iq bd ly nu nv dn mc nw nx dp mg la ny nz mi le oa ob mk li oc od mm oe bi translated">第四阶段:测试</h2><p id="5556" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ne lc ld le nf lg lh li ng lk ll lm ij bi translated">最后一步是测试HTTPS的设置是否有效。我使用<code class="fe nk nl nm nn b">curl</code>在终端中运行了两个测试:</p><ol class=""><li id="02e0" class="mo mp iq kt b ku kv kx ky la nh le ni li nj lm mv mw mx my bi translated"><strong class="kt ir">HTTP请求会被重定向到HTTPS吗？</strong> <br/>测试<code class="fe nk nl nm nn b">curl -IL <a class="ae lo" href="http://asongofzandc.xyz." rel="noopener ugc nofollow" target="_blank">http://asongofzandc.xyz</a></code>显示了从HTTP到HTTPS的单一重定向。</li><li id="1b13" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated"><strong class="kt ir">Vercel的HTTP请求会被重定向到HTTPS吗？</strong> <br/>测试<code class="fe nk nl nm nn b">curl -L <a class="ae lo" href="http://asongofzandc.xyz/.well-known/acme-challenge" rel="noopener ugc nofollow" target="_blank">http://asongofzandc.xyz/.well-known/acme-challenge</a></code>显示没有HTTPS重定向。</li></ol></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><p id="e92b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">两次成功的测试，我感到很幸运！我使用Vercel仪表板将我的域分配给我的Vercel项目。</p><p id="9e0b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">就像变魔术一样，<a class="ae lo" href="https://asongofzandc.xyz" rel="noopener ugc nofollow" target="_blank"> asongofzandc.xyz </a>现在正在展示我的Vercel项目。</p><p id="03a3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过在浏览器中检查SSL证书，我能够确认我的项目是通过Cloudflare进行的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi of"><img src="../Images/9a2dd10abd971e39508d3d4aa7f8f7e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*o3OOoT9dsaKv0PNra4XRWw.png"/></div></figure><p id="2d29" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">完美！</p><h1 id="447e" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">将Cloudflare管理的子域连接到Vercel</h1><p id="532e" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ne lc ld le nf lg lh li ng lk ll lm ij bi translated">我很好奇我的设置是否经得起未来的考验。如果我想用一个子域来代理一个不同的Vercel项目，设置起来有多容易？答案，原来是非常！</p><p id="59e1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我通过以下方式设置了一个代理不同Vercel项目的新子域名:</p><ol class=""><li id="cc89" class="mo mp iq kt b ku kv kx ky la nh le ni li nj lm mv mw mx my bi translated">将名为'<a class="ae lo" href="https://github.com/domjtalbot/vercel-and-cloudflare-dragon" rel="noopener ugc nofollow" target="_blank">vercel-and-cloud flare-dragon</a>'的新GitHub库导入到Vercel。</li><li id="2faa" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">在Cloudflare中创建一个<code class="fe nk nl nm nn b">CNAME</code>记录，命名为<code class="fe nk nl nm nn b">dragon</code>，目标为<code class="fe nk nl nm nn b">alias.zeit.co</code>，启用代理。</li><li id="c9e5" class="mo mp iq kt b ku mz kx na la nb le nc li nd lm mv mw mx my bi translated">将我的子域—<a class="ae lo" href="https://dragon.asongofzandc.xyz" rel="noopener ugc nofollow" target="_blank">dragon . asongofzandc . XYZ</a>—分配给我的新Vercel项目“vercel-and-cloudflare-dragon”。</li></ol><p id="1925" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">几秒钟之内，我的“vercel-and-cloudflare-dragon”项目就可以通过<a class="ae lo" href="https://dragon.asongofzandc.xyz" rel="noopener ugc nofollow" target="_blank">dragon . asongofzandc . XYZ</a>查看了。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><h1 id="35bf" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">摘要</h1><p id="7253" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ne lc ld le nf lg lh li ng lk ll lm ij bi translated">使用Vercel设置Cloudflare非常简单:关键在于HTTPS设置。遵循设置HTTPS的四个阶段——加密、异常、重定向、测试——您很快就能在Vercel上使用Cloudflare了。</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><p id="5cf8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我希望这是有帮助的，感谢阅读！</p></div></div>    
</body>
</html>