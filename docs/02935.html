<html>
<head>
<title>Create a Photo Gallery App Using the MERN Stack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MERN堆栈创建照片库应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/create-a-photo-gallery-app-using-mern-stack-826d7d926232?source=collection_archive---------3-----------------------#2020-04-11">https://levelup.gitconnected.com/create-a-photo-gallery-app-using-mern-stack-826d7d926232?source=collection_archive---------3-----------------------#2020-04-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8339" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">处理图像上传，并将其提供给客户端</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/7a8ec41da79a5ffc875ada39700a546d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*trICbbLPAxIoWi8aRatW6Q.gif"/></div></figure><p id="3b31" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在这篇文章中，我们将建立一个使用MERN堆栈的照片库应用程序。这似乎很简单，但通过构建这个应用程序，您将了解到:</p><p id="c288" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">1.如何上传和提供图像或任何其他文件，并将其限制为特定的文件扩展名<br/> 2。如何限制文件上传大小<br/> 3？如何在redux store中获取服务器错误并显示在前端<br/> 4。如何避免从服务器返回不必要的大量数据。如何在同一台服务器上部署客户机和服务器代码，以便在同一端口上运行它</p><p id="7ea4" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">所以让我们开始吧。</p><p id="7c96" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们将使用MongoDB来存储照片，所以在您的本地机器上安装MongoDB数据库。</p><p id="1421" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">查看本文中的<a class="ae lm" rel="noopener ugc nofollow" target="_blank" href="/how-to-install-mongodb-database-on-local-environment-19a8a76f1b92">以获得安装它的逐步指南。</a></p><p id="95bd" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们将使用<code class="fe ln lo lp lq b">create-react-app</code>来初始化项目。</p><p id="9f8b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">通过运行以下命令创建新项目:</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="edc2" class="lv lw it lq b gy lx ly l lz ma">create-react-app photo_gallery_app</span></pre><p id="d8b8" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">项目创建完成后，删除<code class="fe ln lo lp lq b">src</code>文件夹中的所有文件，并在<code class="fe ln lo lp lq b">src</code>文件夹中创建<code class="fe ln lo lp lq b">index.js, styles.scss</code>文件。同样，在<code class="fe ln lo lp lq b">src</code>文件夹中创建<code class="fe ln lo lp lq b">components,</code>和<code class="fe ln lo lp lq b">utils, actions, reducers, router and store</code>文件夹。</p><p id="52e6" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">通过从终端或命令提示符运行以下命令来安装所需的软件包:</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="b814" class="lv lw it lq b gy lx ly l lz ma">yarn add axios@0.19.2 bootstrap@4.4.1 node-sass@4.13.1 react-bootstrap@1.0.0 redux@4.0.5 react-redux@7.2.0 redux-thunk@2.3.0 react-router-dom@5.1.2</span></pre><p id="ab80" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">安装完成后，打开<code class="fe ln lo lp lq b">src/styles.scss</code>并添加以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="51d5" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用以下代码在<code class="fe ln lo lp lq b">components</code>文件夹中创建<code class="fe ln lo lp lq b">UploadForm.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="94f6" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用以下代码在<code class="fe ln lo lp lq b">components</code>文件夹中创建<code class="fe ln lo lp lq b">Header.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="e303" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">用下面的代码在<code class="fe ln lo lp lq b">components</code>文件夹中创建<code class="fe ln lo lp lq b">HomePage.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="82d4" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">用下面的代码在<code class="fe ln lo lp lq b">components</code>文件夹中创建<code class="fe ln lo lp lq b">NotFoundPage.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="1c22" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用以下代码在<code class="fe ln lo lp lq b">components</code>文件夹中创建<code class="fe ln lo lp lq b">Photo.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="58b8" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用以下代码在<code class="fe ln lo lp lq b">components</code>文件夹中创建<code class="fe ln lo lp lq b">Gallery.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="a5f4" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">用下面的代码在<code class="fe ln lo lp lq b">actions</code>文件夹中创建<code class="fe ln lo lp lq b">errors.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="d4f1" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用以下代码在<code class="fe ln lo lp lq b">actions</code>文件夹中创建<code class="fe ln lo lp lq b">photos.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="fe4f" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用以下代码在<code class="fe ln lo lp lq b">reducers</code>文件夹中创建<code class="fe ln lo lp lq b">errors.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="d72d" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用以下代码在<code class="fe ln lo lp lq b">reducers</code>文件夹中创建<code class="fe ln lo lp lq b">photos.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="e847" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">用下面的代码在<code class="fe ln lo lp lq b">router</code>文件夹中创建<code class="fe ln lo lp lq b">AppRouter.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="3dba" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">用下面的代码在<code class="fe ln lo lp lq b">store</code>文件夹中创建<code class="fe ln lo lp lq b">store.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="0323" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用以下代码在<code class="fe ln lo lp lq b">utils</code>文件夹中创建<code class="fe ln lo lp lq b">constants.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="e6ac" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在，在<code class="fe ln lo lp lq b">src</code>文件夹旁边创建一个<code class="fe ln lo lp lq b">server</code>文件夹，这样您的项目中将有三个文件夹:<code class="fe ln lo lp lq b">server</code>、<code class="fe ln lo lp lq b">public</code>和<code class="fe ln lo lp lq b">src</code>。</p><p id="8223" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在<code class="fe ln lo lp lq b">server</code>文件夹内创建<code class="fe ln lo lp lq b">db</code>、<code class="fe ln lo lp lq b">model</code>和<code class="fe ln lo lp lq b">routers</code>文件夹和一个<code class="fe ln lo lp lq b">index.js</code>文件。</p><p id="1d5b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在，让我们从<code class="fe ln lo lp lq b">server</code>文件夹中执行以下命令，在<code class="fe ln lo lp lq b">server</code>文件夹中创建一个<code class="fe ln lo lp lq b">package.json</code>文件:</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="6395" class="lv lw it lq b gy lx ly l lz ma">yarn init -y</span></pre><p id="a44b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">通过从您的终端或从<code class="fe ln lo lp lq b">server</code>文件夹<strong class="ks iu">的命令提示符运行以下命令来安装所需的包。</strong></p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="0255" class="lv lw it lq b gy lx ly l lz ma">yarn add cors@2.8.5 express@4.17.1 mongoose@5.9.7 multer@1.4.2</span></pre><p id="60ba" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在<code class="fe ln lo lp lq b">server/package.json</code>文件中添加一个新脚本来启动服务器</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="3f2b" class="lv lw it lq b gy lx ly l lz ma">"scripts": {<br/> "start": "node index.js"<br/>}</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi md"><img src="../Images/cac9fb73099376c5a53a94879e2e9159.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mn0Eykpe3LyjYiCS0y-xYw.png"/></div></div></figure><p id="92cc" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">根据您的操作系统，使用<code class="fe ln lo lp lq b">./mongod</code>或<code class="fe ln lo lp lq b">mongod.exe</code>启动MongoDB数据库服务器，如本文<a class="ae lm" rel="noopener ugc nofollow" target="_blank" href="/how-to-install-mongodb-database-on-local-environment-19a8a76f1b92">和</a>所述。</p><p id="beb6" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">用下面的代码在<code class="fe ln lo lp lq b">db</code>文件夹中创建<code class="fe ln lo lp lq b">connection.js</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="f51a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">用下面的代码在<code class="fe ln lo lp lq b">model</code>文件夹中创建<code class="fe ln lo lp lq b">Photo.js</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="2b3e" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用以下代码在<code class="fe ln lo lp lq b">routers</code>文件夹中创建<code class="fe ln lo lp lq b">photos.js</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="bf0c" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在<code class="fe ln lo lp lq b">server/index.js</code>内添加以下代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="cdf9" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在，在一个终端中通过从项目文件夹的根目录(<code class="fe ln lo lp lq b">photo_gallery_app</code>)运行<code class="fe ln lo lp lq b">yarn start</code>命令来启动react应用程序，在另一个终端中通过从<code class="fe ln lo lp lq b">server</code>文件夹运行<code class="fe ln lo lp lq b">yarn start</code>来启动服务器。</p><p id="18bd" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">您将能够在<a class="ae lm" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000/ </a>访问您的应用程序，它将向<a class="ae lm" href="http://localhost:3300/photos" rel="noopener ugc nofollow" target="_blank"> http://localhost:3300 </a>的服务器发出API请求，这是我们在<code class="fe ln lo lp lq b">utils/constants.js</code>中提供的。</p><p id="66fa" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">您可以通过进入<code class="fe ln lo lp lq b">home page</code>上传照片，并在<code class="fe ln lo lp lq b">gallery page</code>中查看所有上传的照片。</p><p id="b700" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果你打开<code class="fe ln lo lp lq b">server/index.js</code>，你会看到我们在顶部添加了<code class="fe ln lo lp lq b">cors</code>包，并将其用作</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="e160" class="lv lw it lq b gy lx ly l lz ma">app.use(cors());</span></pre><p id="8199" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是必需的，因为浏览器不允许在一个端口上运行的应用程序访问在另一个端口上运行的应用程序数据，并且会产生<code class="fe ln lo lp lq b">CORS</code>错误。</p><p id="9f19" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">因此，通过添加<code class="fe ln lo lp lq b">app.use(cors())</code>,我们确保服务器将接受来自任何客户端的传入请求。</p><p id="278d" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果您删除行<code class="fe ln lo lp lq b">app.use(cors())</code>并通过从服务器文件夹运行<code class="fe ln lo lp lq b">yarn start</code>来重启服务器，您将能够看到该错误:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mi"><img src="../Images/d31ba37178152a6ddc9b978a0d8e77e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dFu-qxHAA5qrRzWLGH_lYw.png"/></div></div></figure><p id="ef14" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">添加<code class="fe ln lo lp lq b">cors</code>可以在开发的同时测试应用程序，但是从安全的角度来看并不好，因为任何应用程序都可以访问我们的服务器数据。</p><p id="89d6" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">因此，让我们看看如何在服务器上部署React代码，以便客户端和服务器应用程序都在同一服务器上运行，并且不需要添加<code class="fe ln lo lp lq b">cors</code>，也不需要运行两个单独的命令。</p><p id="0091" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为此，打开<code class="fe ln lo lp lq b">utils/constants.js</code>并改变</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="8fb0" class="lv lw it lq b gy lx ly l lz ma">export const BASE_API_URL = 'http://localhost:3300';</span></pre><p id="5427" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">到</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="8081" class="lv lw it lq b gy lx ly l lz ma">export const BASE_API_URL = '';</span></pre><p id="27a1" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在<code class="fe ln lo lp lq b">server/index.js</code>内部，从<code class="fe ln lo lp lq b">app.use </code>中删除<code class="fe ln lo lp lq b">cors</code>的导入及其使用，并添加</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="234d" class="lv lw it lq b gy lx ly l lz ma">app.use(express.static(path.join(__dirname, '..', 'build')));</span></pre><p id="ddbe" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">以前</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="2ecc" class="lv lw it lq b gy lx ly l lz ma">app.use(photosRouter);</span></pre><p id="348b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">并在顶部为<code class="fe ln lo lp lq b">path</code>添加一个导入:</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="f73c" class="lv lw it lq b gy lx ly l lz ma">const path = require('path');</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mj"><img src="../Images/a991f89d9f10c0afec8ba5edafed3b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0cEOuHwKAxrP51Yh6GHxzQ.png"/></div></div></figure><p id="62f4" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">通过使用</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="c762" class="lv lw it lq b gy lx ly l lz ma">app.use(express.static(path.join(__dirname, '..', 'build')));</span></pre><p id="56de" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们指示<code class="fe ln lo lp lq b">express</code>服务器提供来自<code class="fe ln lo lp lq b">build</code>文件夹的所有文件，该文件夹将在我们从终端运行build命令时创建。</p><p id="103c" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在，打开react应用程序的<code class="fe ln lo lp lq b">package.json</code>并进行更改</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="14d2" class="lv lw it lq b gy lx ly l lz ma">"start": "react-scripts start",</span></pre><p id="50f0" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">到</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="46d8" class="lv lw it lq b gy lx ly l lz ma">"start-client": "react-scripts start",</span></pre><p id="a127" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">并添加新的启动脚本</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="2d50" class="lv lw it lq b gy lx ly l lz ma">"start": "yarn build &amp;&amp; node server/index.js"</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mk"><img src="../Images/1f3505120ef72aa477fd32de800415a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*90a3WuZ4v957ELdwFC9vjw.png"/></div></div></figure><p id="13fa" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这里，我们首先运行build命令，这将在我们的项目中创建一个新的<code class="fe ln lo lp lq b">build</code>文件夹，然后我们将使用<code class="fe ln lo lp lq b">node server/index.js</code>启动我们的express服务器。</p><p id="cf80" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果前两个<code class="fe ln lo lp lq b">yarn start</code>命令仍在运行，停止它们，仅从主项目文件夹(<code class="fe ln lo lp lq b">photo_gallery_app</code>)再次执行<code class="fe ln lo lp lq b">yarn start</code>。</p><p id="f656" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">一旦它被执行，您将能够从<a class="ae lm" href="http://localhost:3300/" rel="noopener ugc nofollow" target="_blank"> http://localhost:3300/ </a>访问您的应用程序</p><p id="3b6e" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在，主页和画廊页面都将按预期工作。</p><p id="4936" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">但是还有一个问题。如果刷新图库页面，您将看到一个错误:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ml"><img src="../Images/c5680ea88929065dd2ac3d9f02b19569.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7HK2lbxLWqdUz6PoiorkQA.png"/></div></div></figure><p id="49d4" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是因为，当我们进入<a class="ae lm" href="http://localhost:3300/gallery" rel="noopener ugc nofollow" target="_blank">http://localhost:3300/gallery</a>时，默认的浏览器行为是，它会在服务器上寻找<code class="fe ln lo lp lq b">/gallery</code>路由，但是我们在服务器上没有任何<code class="fe ln lo lp lq b">/gallery</code>路由。我们的React应用程序中已经有了，所以要解决这个问题，我们需要添加一些代码来处理客户端的路由。</p><p id="13b7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果用户前往<code class="fe ln lo lp lq b">/gallery</code>路线，我们将发送我们的<code class="fe ln lo lp lq b">build/index.html</code>,这是我们的React应用程序，它有可用的路线。</p><p id="35b1" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为此，打开<code class="fe ln lo lp lq b">server/index.js</code>并添加以下代码</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="c997" class="lv lw it lq b gy lx ly l lz ma">// add middleware<br/>app.use((req, res, next) =&gt; {<br/> res.sendFile(path.join(__dirname, '..', 'build', 'index.html'));<br/>});</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mm"><img src="../Images/36604129d6e0206aa957eb052429d747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xltj2wBp2R6X1J4dU4kAqA.png"/></div></div></figure><p id="e245" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">注意这里的顺序很重要，这个中间件只需要添加在下面几行之后</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="59c9" class="lv lw it lq b gy lx ly l lz ma">app.use(express.static(path.join(__dirname, '..', 'build')));<br/>app.use(photosRouter);</span></pre><p id="9eb0" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">因为如果我们在它们之前添加它，那么对于每个到服务器的请求，它将只发送<code class="fe ln lo lp lq b">index.html</code>，而我们的服务器rest APIs将永远不会被执行。</p><p id="cc60" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在，如果您通过运行<code class="fe ln lo lp lq b">yarn start</code>再次运行该应用程序，您将看到一切都在工作，并且在刷新后<a class="ae lm" href="http://localhost:3300/gallery" rel="noopener ugc nofollow" target="_blank">http://localhost:3300/gallery</a>也可以访问。</p><p id="fba3" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">注意:</strong>每当您在React或节点代码中进行任何更改时，您都需要再次运行<code class="fe ln lo lp lq b">yarn start</code>，以便它将反映在<code class="fe ln lo lp lq b">build</code>文件夹中。</p><p id="bc2e" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">让我们浏览一下React和Node应用程序的代码，以了解我们在每个文件中做了什么。</p><p id="ce6b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">让我们从服务器节点代码开始。</p><p id="77ff" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">1.在<code class="fe ln lo lp lq b">db/connection.js</code>文件中，我们正在连接到我们的MongoDB数据库，并且我们正在将该文件作为<code class="fe ln lo lp lq b">require('./db/connection');</code>导入到<code class="fe ln lo lp lq b">server/index.js</code>中</p><p id="84ba" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">2.在<code class="fe ln lo lp lq b">model/Photo.js</code>中，我们正在创建一个模型来指定我们存储在数据库中的数据类型。因为我们只存储图像，所以类型将是<code class="fe ln lo lp lq b">Buffer</code>,这是处理二进制数据的MongoDB类型之一。</p><p id="fa05" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">3.在<code class="fe ln lo lp lq b">routers/photos.js</code>中，我们从指定<code class="fe ln lo lp lq b">multer</code> npm包的配置开始。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mn"><img src="../Images/2523790d96393af3a5478685cefe48ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_zijuBElVdf5P-m6LgJ6fg.png"/></div></div></figure><p id="be1c" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><code class="fe ln lo lp lq b">multer</code>包是用来上传文件的。这里我们指定每个上传文件的最大文件大小<code class="fe ln lo lp lq b">1MB</code>，并且只接受<code class="fe ln lo lp lq b">jpg</code>或<code class="fe ln lo lp lq b">jpeg</code>图像上传。</p><p id="d03a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">4.然后，我们指定了一个post route <code class="fe ln lo lp lq b">/photos</code>来处理React应用程序上传的文件。使用<code class="fe ln lo lp lq b">upload.single('photo')</code>我们指定请求参数，我们将从中获取上传的文件数据。我们已经在React应用程序的<code class="fe ln lo lp lq b">UploadForm.js</code>中指定了<code class="fe ln lo lp lq b">name</code>参数。</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="1328" class="lv lw it lq b gy lx ly l lz ma">&lt;Form.Control type="file" name="photo" onChange={handleOnChange} /&gt;</span></pre><p id="229a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">所以</strong> <code class="fe ln lo lp lq b"><strong class="ks iu">upload.single</strong></code> <strong class="ks iu">里面的值必须与表单控件中指定的名称相匹配，否则上传文件时会出现服务器错误。</strong></p><p id="e9af" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">上传的文件数据将在<code class="fe ln lo lp lq b">req.file</code>对象中可用，我们使用<code class="fe ln lo lp lq b">req.file.buffer</code>访问二进制数据。然后我们使用<code class="fe ln lo lp lq b">await photo.save()</code>将图像保存到数据库中。</p><p id="c7bd" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">然后，我们返回存储在数据库中的照片的自动生成的id作为响应。</p><p id="91bc" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">请注意，我们不会再次发送整个文件，因为这不是必需的，因为当我们单击应用程序中的图库菜单时，会加载所有图像，从而减少响应数据的大小。</strong></p><p id="cd65" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">id是必需的，因为我们通过id访问图片，在图库页面上显示图片。</p><p id="fb15" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">下面提到的错误处理程序路线</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="d389" class="lv lw it lq b gy lx ly l lz ma">(error, req, res, next) =&gt; {<br/> if (error) {<br/>  res.status(500).send({<br/>   upload_error: error.message<br/>  });<br/> }<br/>}</span></pre><p id="b093" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">只有在上传文件时出现错误时才会执行，例如文件大小大于1 MB或者文件不是jpg或jpeg类型。</p><p id="35b9" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">5.接下来，获取<code class="fe ln lo lp lq b">/photos</code>路线，我们从数据库发回所有上传的图像数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mo"><img src="../Images/a14fcc1bb88e49df1320996b1e4934cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-pys-_GrSjwXoSZcm_cGQ.png"/></div></div></figure><p id="80a0" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">注意:</strong>我们没有在任何地方使用这条路线，我们只是用它来验证数据和进行测试。</p><p id="94b1" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">但是如果你通过访问http://localhost:3300/photos来访问它，你会看到它只返回id</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mp"><img src="../Images/6320532312b3c787e061ac5cbef0106d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SO95pff8UNWyxb3JGdy9hw.png"/></div></div></figure><p id="558d" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">由于我们在<code class="fe ln lo lp lq b">model/Photo.js</code>中添加的代码，上传的文件二进制数据没有显示</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mq"><img src="../Images/f09eb38e75a0e788b0f9c0dd96b33ba3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FOqLaCXGudjWs-JpU1p-dg.png"/></div></div></figure><p id="8eaf" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">将对集合中的每个文档执行<code class="fe ln lo lp lq b">toJSON</code>方法，在集合中我们删除不需要从API返回的数据。这是从响应中删除敏感数据的一个很好的方法，比如<code class="fe ln lo lp lq b">passwords, phone numbers</code>(如果我们有这样的东西的话)。</p><p id="774e" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">6.接下来，我们访问存储在数据库中的单个图像</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mr"><img src="../Images/88bd9045b5c0195268b7e5f923a38d73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O5qvW1QeCx5Jg80u17qcTw.png"/></div></div></figure><p id="8ca8" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用这种方法，我们在应用程序的图库页面中显示数据</p><p id="70cc" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">因此，如果您从<code class="fe ln lo lp lq b"><a class="ae lm" href="http://localhost:3300/photos" rel="noopener ugc nofollow" target="_blank">http://localhost:3300/photos</a></code>路由中获取任何<code class="fe ln lo lp lq b">_id</code>值，并将其作为<code class="fe ln lo lp lq b"><a class="ae lm" href="http://localhost:3300/photos" rel="noopener ugc nofollow" target="_blank">http://localhost:3300/photos</a>/&lt;photo_id&gt;</code>传递给该路由，那么您将能够在浏览器中直接看到该图像</p><p id="3252" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在，让我们理解我们的React代码</p><ol class=""><li id="9ef0" class="ms mt it ks b kt ku kw kx kz mu ld mv lh mw ll mx my mz na bi translated">在<code class="fe ln lo lp lq b">store/store.js</code>中，我们使用了<code class="fe ln lo lp lq b">combineReducers</code>来获取redux商店中的照片和服务器错误，因此我们可以在redux <code class="fe ln lo lp lq b">devtools</code>中看到这些错误，如下所示</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nb"><img src="../Images/5c12e5268e775f2a1da6bf4800948024.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lAhr8X-SXPJw42WKdM5XEg.png"/></div></div></figure><p id="3647" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果你的浏览器中没有安装redux <code class="fe ln lo lp lq b">devtools</code>，你可以从<a class="ae lm" href="https://chrome.google.com/webstore/detail/redux-devtools/lmhkpmbekcpmknklioeibfkpmmfibljd?hl=en" rel="noopener ugc nofollow" target="_blank">这里</a>为Chrome安装。</p><p id="6028" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">2.在<code class="fe ln lo lp lq b">actions/photos.js</code>中，我们添加了<code class="fe ln lo lp lq b">beginAddPhoto</code> action creator，它通过API调用将图像上传到服务器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nc"><img src="../Images/64fae76695f0b9190d10ac649df30def.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nr4ISkgJg5AYOcLeLkcLJw.png"/></div></div></figure><p id="d078" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">要处理文件上传，内容类型必须是<code class="fe ln lo lp lq b">multipart/form-data</code>类型。</p><p id="9b0d" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们将上传的文件数据添加到<code class="fe ln lo lp lq b">FormData</code>对象中，这是必要的，因为没有它我们将无法发送<code class="fe ln lo lp lq b">multipart/form-data</code>类型的post请求。</p><p id="45ba" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">3.然后我们有<code class="fe ln lo lp lq b">startLoadPhotos</code> action creator，它从服务器加载图像，然后通过调用<code class="fe ln lo lp lq b">loadPhotos</code> action creator将其添加到redux存储中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nd"><img src="../Images/98faf1621becd16da0ee417bb0a91b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*azJHI7eNd_rTaHHEEdylIg.png"/></div></div></figure><p id="1b6e" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">对于组件代码，我们使用<code class="fe ln lo lp lq b">React Hooks</code>。如果你是钩子的新手，看看这篇文章的介绍。</p><p id="13bd" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">大概就是这样。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ne"><img src="../Images/5e1d92e1523dc99691c57611804dbac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HLEEZQaWPH-hUXHn0RCH6A.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">大文件上传错误</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mp"><img src="../Images/c612f91c6e1de5e4f42ec7ab593ba4b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-i1GcDS1xcu3Wt_SYPkUgA.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">上传成功消息</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ml"><img src="../Images/3073bea367cbf0cceff39dd87c6f6cf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L3fOihB2rEkahoYX6_KQKA.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">图库页面</figcaption></figure><p id="8a50" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">你可以在这里找到这个应用<a class="ae lm" href="https://github.com/myogeshchavan97/photo_gallery_app" rel="noopener ugc nofollow" target="_blank">的完整源代码。</a></p><p id="639b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">今天到此为止。我希望你学到了新东西。</p><p id="2891" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">别忘了订阅我的每周简讯，里面有惊人的技巧、诀窍和文章，直接在你的收件箱</strong> <a class="ae lm" href="https://yogeshchavan.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="ks iu">这里。</strong> </a></p></div></div>    
</body>
</html>