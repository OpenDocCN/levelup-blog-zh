<html>
<head>
<title>Using Cypress with Next.js and Auth0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Cypress与Next.js和Auth0一起使用</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-cypress-with-next-js-and-auth0-2dbe7282dcf?source=collection_archive---------9-----------------------#2020-05-26">https://levelup.gitconnected.com/using-cypress-with-next-js-and-auth0-2dbe7282dcf?source=collection_archive---------9-----------------------#2020-05-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5e7e6b9320a016c9a31d088c4fc2471c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qTqk6Aqxu9QPnWhZxh1_BA.jpeg"/></div></div></figure><p id="0471" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我花了三天时间试图配置<a class="kw kx ep" href="https://medium.com/u/47c842e55929?source=post_page-----2dbe7282dcf--------------------------------" rel="noopener" target="_blank"> Cypress.io </a>与NextJS和<a class="kw kx ep" href="https://medium.com/u/9ef9638b3092?source=post_page-----2dbe7282dcf--------------------------------" rel="noopener" target="_blank"> Auth0 </a>协同工作。实现很难搞清楚，但本质上非常简单。</p><p id="ed6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这本指南将带你了解你需要知道的一切。</p><p id="af7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ky" href="https://gist.github.com/sir-dunxalot/8b8539a0baf4e76490991c3cd4c4401d" rel="noopener ugc nofollow" target="_blank">本要点</a>提供简化源代码。</p><h2 id="2972" class="kz la iq bd lb lc ld dn le lf lg dp lh kj li lj lk kn ll lm ln kr lo lp lq lr bi translated">编辑:</h2><p id="01d7" class="pw-post-body-paragraph jy jz iq ka b kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr lw kt ku kv ij bi translated">自从撰写本文<a class="ae ky" href="https://github.com/sir-dunxalot/cypress-nextjs-auth0" rel="noopener ugc nofollow" target="_blank">以来，sir-dunxalot/cypress-nextjs-auth 0</a>的发布是为了简化这个集成过程:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="c5b3" class="kz la iq mc b gy mg mh l mi mj">yarn add cypress-nextjs-auth0 --dev</span></pre><p id="8050" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ky" href="https://github.com/sir-dunxalot/cypress-nextjs-auth0" rel="noopener ugc nofollow" target="_blank">更多信息请点击这里</a>！</p><h1 id="584d" class="mk la iq bd lb ml mm mn le mo mp mq lh mr ms mt lk mu mv mw ln mx my mz lq na bi translated">我们的目标</h1><p id="0cea" class="pw-post-body-paragraph jy jz iq ka b kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr lw kt ku kv ij bi translated">我们的目标是创建一个可以在任何Cypress测试中使用的单行测试助手:</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="3e3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Auth0团队为NextJS维护了一个很棒的库，<a class="ae ky" href="https://github.com/auth0/nextjs-auth0" rel="noopener ugc nofollow" target="_blank"> nextjs-auth0 </a>。然而，<a class="ae ky" href="https://github.com/auth0/nextjs-auth0" rel="noopener ugc nofollow" target="_blank"> nextjs-auth0 </a>库不能与Cypress一起工作，因为<a class="ae ky" href="https://docs.cypress.io/guides/references/best-practices.html#Visiting-external-sites" rel="noopener ugc nofollow" target="_blank"> Cypress不允许你在测试期间访问外部站点</a>。请这样想:</p><ol class=""><li id="9c7b" class="nd ne iq ka b kb kc kf kg kj nf kn ng kr nh kv ni nj nk nl bi translated">测试用户加载您的应用程序</li><li id="a42a" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv ni nj nk nl bi translated">测试用户点击“登录”</li><li id="05b1" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv ni nj nk nl bi translated">测试用户被带到Auth0锁定屏幕——但是哦，等等！我们现在在一个不同的域(或子域)上，所以Cypress阻止了我们的请求。</li></ol><p id="1ae2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是不要害怕！通过阅读<a class="ae ky" href="https://github.com/auth0/nextjs-auth0/blob/master/src/handlers/login.ts#L70" rel="noopener ugc nofollow" target="_blank">next js-auth 0库</a>的源代码，我们可以学习如何在Cypress测试套件中进行认证。</p><p id="f923" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">相反，我们必须使用<code class="fe nr ns nt mc b">Password</code>授权登录测试用户。</p><h1 id="7014" class="mk la iq bd lb ml mm mn le mo mp mq lh mr ms mt lk mu mv mw ln mx my mz lq na bi translated">正在设置Auth0</h1><p id="4399" class="pw-post-body-paragraph jy jz iq ka b kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr lw kt ku kv ij bi translated">首先，将Auth0 Javascript库添加到我们的项目中:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="bb26" class="kz la iq mc b gy mg mh l mi mj">yarn add auth0-js --dev</span></pre><p id="9f99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其次，在你的Auth0仪表板中创建一个<strong class="ka ir">真实用户</strong>。记下他们的电子邮件和密码，因为你马上会需要这些信息。</p><p id="1504" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第三，<a class="ae ky" href="https://auth0.com/docs/api-auth/tutorials/password-grant" rel="noopener ugc nofollow" target="_blank">按照这些说明</a>在您的Auth0租户中启用资源所有者密码授权。</p><p id="4549" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些是您需要在Auth0中进行的唯一更改，以支持来自Cypress测试的身份验证。</p><h2 id="93e4" class="kz la iq bd lb lc ld dn le lf lg dp lh kj li lj lk kn ll lm ln kr lo lp lq lr bi translated">关于安全性的说明</h2><p id="c36d" class="pw-post-body-paragraph jy jz iq ka b kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr lw kt ku kv ij bi translated">本演练跳过了访问令牌验证并揭示了秘密，但我假设您能够降低测试环境中的安全性。Auth0建议您为开发、测试和生产使用单独的租户，这进一步降低了将测试用户凭证放入<code class="fe nr ns nt mc b">cypress.env.json</code>的风险。</p><h1 id="0fac" class="mk la iq bd lb ml mm mn le mo mp mq lh mr ms mt lk mu mv mw ln mx my mz lq na bi translated">验证测试用户</h1><p id="1761" class="pw-post-body-paragraph jy jz iq ka b kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr lw kt ku kv ij bi translated">接下来，让我们为Cypress创建我们的<code class="fe nr ns nt mc b">login()</code>助手(助手通常用<code class="fe nr ns nt mc b">cypress/support/index.js</code>编写):</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="27a2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，我们使用的是<a class="ae ky" href="https://docs.cypress.io/api/cypress-api/env.html#Syntax" rel="noopener ugc nofollow" target="_blank"> Cypress环境变量</a>，它是我们在<code class="fe nr ns nt mc b">cypress.env.json</code>中设置的:</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="7788" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">假设您用自己的值替换<code class="fe nr ns nt mc b">cypress.env.json</code>中的信息(注意<code class="fe nr ns nt mc b">auth0CookieSecret</code>是您选择的随机字符串)，您的用户测试将能够登录到Cypress测试中。</p><p id="537f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好的，我们在这里取得了一些进展…</p><p id="e86a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是使用这个助手运行一个测试，您将看到您的Next.js应用程序代码不会对测试用户进行身份验证。例如，如果您有一个受auth0/nextjs-auth0包保护的API路由，测试用户将无法访问该路由:</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="e266" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，我们不仅需要验证测试用户，还需要创建一个用户会话…</p><h1 id="3e3e" class="mk la iq bd lb ml mm mn le mo mp mq lh mr ms mt lk mu mv mw ln mx my mz lq na bi translated">创建用户会话</h1><p id="5fc8" class="pw-post-body-paragraph jy jz iq ka b kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr lw kt ku kv ij bi translated">我们需要模仿nextjs-auth0库的行为。</p><p id="ce0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过阅读<a class="ae ky" href="https://github.com/auth0/nextjs-auth0/blob/master/src/handlers/login.ts#L70" rel="noopener ugc nofollow" target="_blank">next js-auth 0库的源代码</a>，我们了解到在Next.js应用中创建用户会话至少有五个步骤:</p><ol class=""><li id="c1f8" class="nd ne iq ka b kb kc kf kg kj nf kn ng kr nh kv ni nj nk nl bi translated">创建一个名为<code class="fe nr ns nt mc b">a0:state</code>的cookie来跟踪正在进行的登录</li><li id="afa2" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv ni nj nk nl bi translated">验证用户身份，检索访问令牌</li><li id="0e36" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv ni nj nk nl bi translated">验证访问令牌(我跳过这一步，因为这超出了本演练的范围)</li><li id="9490" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv ni nj nk nl bi translated">使用访问令牌获取用户信息</li><li id="b070" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv ni nj nk nl bi translated">加密用户信息以创建会话对象</li><li id="d15d" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv ni nj nk nl bi translated">将加密的用户会话存储在名为<code class="fe nr ns nt mc b">a0:session</code>的会话cookie中</li></ol><p id="f1cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">nextjs-auth0使用Iron来加密会话，所以让我们将它添加到我们的依赖项中:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="d337" class="kz la iq mc b gy mg mh l mi mj">yarn add @hapi/iron --dev</span></pre><p id="103c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们不需要直接调用我们的身份验证助手，而是需要调用一个助手来执行我们刚才提到的步骤(例如，存储一个加密的用户会话)。我个人的偏好是把我们现有的<code class="fe nr ns nt mc b">login()</code> helper做成私有helper，<code class="fe nr ns nt mc b">_login()</code>，写一个新的<code class="fe nr ns nt mc b">login()</code> helper，在某个时候会调用<code class="fe nr ns nt mc b">_login()</code>。</p><p id="4a37" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是我们更新的助手:</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="5489" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，我在这里跳过了令牌验证。如果您想验证访问令牌，那么我建议您看看<a class="ae ky" href="https://github.com/panva/node-openid-client/" rel="noopener ugc nofollow" target="_blank"> openid-client-node </a>和类似的库如何验证令牌。对于我的用例，我认为在我的测试环境中验证访问令牌是不必要的。</p><h1 id="0e45" class="mk la iq bd lb ml mm mn le mo mp mq lh mr ms mt lk mu mv mw ln mx my mz lq na bi translated">尝试一下</h1><p id="4e8c" class="pw-post-body-paragraph jy jz iq ka b kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr lw kt ku kv ij bi translated">好吧…这应该行得通！</p><p id="853c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们在测试中使用新的<code class="fe nr ns nt mc b">login()</code>助手:</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="f091" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者，您可以使用Cypress的<code class="fe nr ns nt mc b">before()</code>钩子中的<code class="fe nr ns nt mc b">login()</code>助手:</p><p id="dd30" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ky" href="https://gist.github.com/sir-dunxalot/05133f7143d98bd63bcb57c8e2bcba59" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/sir-dunxalot/05133 f 7143d 98 BD 63 BCB 57 c 8e 2 bcba 59</a></p><h1 id="6d60" class="mk la iq bd lb ml mm mn le mo mp mq lh mr ms mt lk mu mv mw ln mx my mz lq na bi translated">缓存测试用户</h1><p id="367b" class="pw-post-body-paragraph jy jz iq ka b kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr lw kt ku kv ij bi translated">最后，我们希望通过缓存测试用户来避免对Auth0的不必要调用。您将很快发现您的测试套件由于授权率限制而失败。</p><p id="9ee2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这听起来可能有点奇怪，因为我们已经在使用cookies来实现持久性。然而，您可能会注意到，每次我们调用<code class="fe nr ns nt mc b">login()</code>时，我们的助手都会创建会话cookie。让我们只在会话cookie不存在的情况下创建它…</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h1 id="8d43" class="mk la iq bd lb ml mm mn le mo mp mq lh mr ms mt lk mu mv mw ln mx my mz lq na bi translated">瞧啊！</h1><p id="580a" class="pw-post-body-paragraph jy jz iq ka b kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr lw kt ku kv ij bi translated">我们的工作完成了。</p><p id="9f65" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ky" href="https://gist.github.com/sir-dunxalot/8b8539a0baf4e76490991c3cd4c4401d" rel="noopener ugc nofollow" target="_blank">本要点</a>中提供了简化的源代码。</p><p id="d564" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以通过向<code class="fe nr ns nt mc b">login()</code>助手传递凭证来支持多个测试用户(假设您已经在Auth0仪表板中创建了用户)。类似下面这样的内容会有所帮助:</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h1 id="89a7" class="mk la iq bd lb ml mm mn le mo mp mq lh mr ms mt lk mu mv mw ln mx my mz lq na bi translated">解决纷争</h1><p id="5121" class="pw-post-body-paragraph jy jz iq ka b kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr lw kt ku kv ij bi translated">如果您仍然无法完成这项工作，请记住以下几点:</p><ul class=""><li id="12f4" class="nd ne iq ka b kb kc kf kg kj nf kn ng kr nh kv nu nj nk nl bi translated">您可能需要将<code class="fe nr ns nt mc b">"chromeWebSecurity": false</code>添加到您的<code class="fe nr ns nt mc b">cypress.json</code>配置文件中。这在某些情况下似乎是必要的，但我不知道为什么。</li><li id="ba0a" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv nu nj nk nl bi translated">您需要在Auth0应用程序的设置中启用<code class="fe nr ns nt mc b">password</code>授权类型。</li><li id="84b6" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv nu nj nk nl bi translated">您需要将默认目录(在您的Auth0租户设置中)设置为<code class="fe nr ns nt mc b">Username-Password-Authentication</code>，这通常是您想要用于<code class="fe nr ns nt mc b">password</code>授权认证的数据库连接的名称(该名称将显示在Auth0仪表板- &gt;连接- &gt;数据库中)。</li><li id="1e17" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv nu nj nk nl bi translated">用户名和密码组合应该是您在Auth0 dashboard中创建的真实帐户(尽管您创建该帐户只是为了测试)。</li></ul></div></div>    
</body>
</html>