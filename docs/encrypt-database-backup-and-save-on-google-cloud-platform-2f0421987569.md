# åŠ å¯†æ•°æ®åº“å¤‡ä»½å¹¶ä¿å­˜åœ¨è°·æ­Œäº‘å¹³å°ä¸Š

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/encrypt-database-backup-and-save-on-google-cloud-platform-2f0421987569>

## ä¸ºäº†æ”¹è¿›å¤‡ä»½åŠŸèƒ½ï¼Œæˆ‘æ·»åŠ äº†åŒæ­¥åŠ å¯†å¤‡ä»½åˆ° GCPã€‚

![](img/3664c00a3264431047f44a78f845ef2f.png)

æ¥è‡ª [Pexels](https://www.pexels.com/photo/close-up-photo-of-mining-rig-1148820/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels) çš„ [panumas nikhomkhai](https://www.pexels.com/@cookiecutter?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels) æ‘„å½±

# ä»‹ç»

åœ¨æˆ‘ç”¨ä¸€ä¸ª`cronjob`è®¾ç½®äº†æˆ‘çš„æ•°æ®åº“å¤‡ä»½ä¹‹åï¼Œæˆ‘åœ¨æƒ³ä¸€ä¸ªå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨æœåŠ¡å™¨å´©æºƒçš„æƒ…å†µä¸‹ä¹Ÿæœ‰å¤‡ä»½ã€‚

æ‚¨å¯ä»¥åœ¨æ­¤é˜…è¯»æˆ‘å¦‚ä½•åˆ›å»ºè‡ªå·±çš„ç®€å•å¤‡ä»½ç­–ç•¥:

[](/everybody-needs-backups-a-lesson-learned-the-hard-way-b4b720afaa3a) [## æ¯ä¸ªäººéƒ½éœ€è¦å¤‡ä»½â€”â€”è¿™æ˜¯ä¸€ä¸ªæƒ¨ç—›çš„æ•™è®­

### æˆ‘çš„ Docker ç¾¤ä¸­çš„ä¸€ä¸ªå¤§äº‹ä»¶ï¼Œä»¥åŠäº‹ä»¶å‘ç”Ÿåæˆ‘å¼€å‘çš„è§£å†³æ–¹æ¡ˆã€‚

levelup.gitconnected.com](/everybody-needs-backups-a-lesson-learned-the-hard-way-b4b720afaa3a) 

ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯ç±»ä¼¼äºåœ¨æˆ‘çš„ç¬”è®°æœ¬ç”µè„‘ä¸Šè¿è¡Œå¹¶æ¯å¤©ä¸‹è½½æ•°æ®åº“çš„`rsync`ä½œä¸šã€‚ä½†è¿™ä¸æ˜¯ä¸€ä¸ªçœŸæ­£å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œæ‰€ä»¥æˆ‘è€ƒè™‘äº†ä¸€ä¸ªåŒ…æ‹¬äº‘å­˜å‚¨çš„è§£å†³æ–¹æ¡ˆã€‚å› ä¸º GCP æœ‰ 300 ç¾å…ƒçš„å…è´¹å­¦åˆ†ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©äº†å®ƒè€Œä¸æ˜¯ AWSã€‚

æˆ‘åœ¨è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªå…è´¹è´¦æˆ·[ï¼Œç„¶åæˆ‘åˆ›å»ºäº†æˆ‘çš„ç¬¬ä¸€ä¸ªå­˜å‚¨æ¡¶ã€‚](https://console.cloud.google.com/)

# å®‰è£… Google Cloud SDK

åœ¨äº‘æ§åˆ¶å°çš„åˆå§‹è®¾ç½®å®Œæˆåï¼Œæˆ‘æ‰§è¡Œäº†ä»¥ä¸‹æ­¥éª¤å°†æˆ‘çš„æœåŠ¡å™¨è¿æ¥åˆ° google storageã€‚å¦‚æœä½ æ­£åœ¨å’Œä¸€ä¸ªç å¤´å·¥äººç¾¤ä½“ä¸€èµ·å·¥ä½œï¼Œè¿™ä¸ªè¿‡ç¨‹å¿…é¡»åœ¨æˆ‘çš„ç¾¤ä½“ä¸­çš„æ¯ä¸ªå·¥äººèº«ä¸Šé‡å¤ã€‚å¦‚æœä½ æƒ³å»ºç«‹ä¸€ä¸ª Docker Swarmï¼Œ [**ä½ å¯ä»¥ä»æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« **](/docker-swarm-in-a-nutshell-ed2a9c42cd7c) **ä¸­è¯»åˆ°ã€‚**

**ä¸‹è½½è°·æ­Œäº‘ SDK**

```
curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-353.0.0-linux-x86_64.tar.gz 
```

**æå–å®ƒ**

```
tar -xf google-cloud-sdk-353.0.0-linux-x86_64.tar.gz
```

**å®‰è£… SDK**

```
./google-cloud-sdk/install.sh
```

å®‰è£…è¿‡ç¨‹å®Œæˆåï¼Œæ‚¨å¿…é¡»é‡æ–°è¿æ¥å¤–å£³ï¼

**åˆå§‹åŒ– SDK**

```
./google-cloud-skd/bin/gcloud init
```

åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæˆ‘å¿…é¡»ç™»å½•æˆ‘çš„è°·æ­Œè´¦æˆ·

**æ‰¾åˆ°æ°´æ¡¶**

```
gsutil ls
```

ç°åœ¨æœºå™¨å·²è¿æ¥åˆ° GCPï¼Œæˆ‘å¯ä»¥ä½¿ç”¨ ***gsutil*** æ¥å¤‡ä»½æˆ‘çš„æ•°æ®ã€‚

# åŠ å¯†

ç°åœ¨æˆ‘åœ¨æ¯å°æœåŠ¡å™¨ä¸Šéƒ½æœ‰äº† google è¿æ¥ï¼Œæˆ‘å¯ä»¥å¼€å§‹åˆ›å»ºå¤‡ä»½è„šæœ¬äº†ã€‚ä½†æ˜¯æˆ‘é¦–å…ˆæ”¶é›†äº†å…³äºå¦‚ä½•å‹ç¼©æ•°æ®åº“å¤‡ä»½å¹¶ä»¥åŠ å¯†æ–¹å¼å­˜å‚¨å®ƒä»¬çš„ä¿¡æ¯ã€‚**è°·æ­Œä¸åº”è¯¥æœ‰æˆ‘çš„æ•°æ®åº“ï¼**æˆ‘çŸ¥é“: ***åæ‰§***

æˆ‘é€‰æ‹©äº†ä¸€ä¸ªåŠ å¯†è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹ä½¿ç”¨ç³»ç»Ÿä¸Šçš„å¯†ç æ–‡ä»¶(æˆ‘ä¹Ÿå°†è¯¥æ–‡ä»¶ä¸‹è½½åˆ°äº†æˆ‘çš„æœºå™¨ä¸Š)ã€‚æ‰€ä»¥æˆ‘å¿…é¡»åˆ›å»ºä¸€ä¸ªå®‰å…¨çš„å¯†ç ï¼Œå¹¶å°†å…¶å¯¼å‡ºåˆ°ä¸€ä¸ªå˜é‡ä¸­ï¼Œç„¶åå¯ä»¥åœ¨è„šæœ¬ä¸­ä½¿ç”¨ã€‚

åœ¨æ–‡ä»¶ä¸­ç”Ÿæˆéšæœºå¯†ç 

```
head -c 100 /dev/urandom | strings -n1 | tr -d '[:space:]' | head -c 40 >> ~/.pass
```

å°†æ–‡ä»¶å¯¼å‡ºåˆ°ã€‚å½“æˆ‘åœ¨å£³é‡Œé¢çš„æ—¶å€™ï¼Œå·´æ²™å°”ä½¿ç”¨å®ƒ

```
echo "export PASS=~/.pass" >> ~/.bashrc && source ~/.bashrc
```

ä½¿æ–‡ä»¶"**å®‰å…¨**

```
chmod 400 ~/.pass
```

æœ‰äº†è¿™äº›`.pass`æ–‡ä»¶ï¼Œæˆ‘å¯ä»¥åŠ å¯†å’Œå‹ç¼©ä¸€ä¸ªæ–‡ä»¶å¤¹:

```
tar czf - . | openssl enc -e -aes-256-cbc -pbkdf2 -iter 100000 -salt -out archive.enc -pass env:PASS
```

ä¸ºäº†è§£å¯†ï¼Œæˆ‘å¿…é¡»ä½¿ç”¨:

```
openssl enc -d -aes-256-cbc -pbkdf2 -iter 100000 -salt -in archive.enc -pass env:PASS | tar zxf - --directory backup_restore
```

# åˆ›å»ºå¤‡ä»½å¤–å£³è„šæœ¬

æœ€åä¸€æ­¥æ˜¯çœŸæ­£åˆ›å»ºä¸€ä¸ª`shell-script`ï¼Œç„¶ååœ¨ä¸€ä¸ª`cronjob`ä¸­æ‰§è¡Œã€‚åœ¨ç ”ç©¶å’Œæµ‹è¯•ä¹‹åï¼Œåˆ›å»ºäº†è¿™ä¸ªè„šæœ¬:

**é‡è¦çš„æ˜¯çŸ¥é“ä½ æ˜¯å¦é˜…è¯»/ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶:**

1.  å°†`YOUR_BACKUP_STORAGE_PATH`æ›¿æ¢ä¸ºæ‚¨å­˜å‚¨å¤‡ä»½çš„è·¯å¾„ã€‚è¿™ä¸ªæ–‡ä»¶å¤¹**å¿…é¡»**æœ‰ä¸¤ä¸ªå­ç›®å½•:`backups_encrypted`å’Œ`backups`
2.  `YOUR_BUCKET_HERE`åº”æ›´æ¢ä¸ºæ‚¨æƒ³è¦ä½¿ç”¨çš„é“²æ–—ã€‚ç”¨`gsutil ls`æ‰¾
3.  `PATH_TO_GOOGLE_SDK_FOLDER`æ˜¯æ‚¨å®‰è£… Google Cloud SDK çš„æ–‡ä»¶å¤¹

è¿™ä¸ªè„šæœ¬ç°åœ¨å¯ä»¥åœ¨`cronjob`ä¸­ä½¿ç”¨:

```
30 1 * * 6 export PASS=/root/.pass; /bin/sh /PATH_TO_SCRIPT/SCRIPTNAME.sh
```

è¿™ä¸ª`cronjob`æ¯å‘¨å…­ 1:30 æ‰§è¡Œã€‚ä½¿ç”¨ [crontab.guru](https://crontab.guru/) è¿›è¡Œ`crontab`åˆ›ä½œ

**éå¸¸é‡è¦:**æ‚¨å¿…é¡»åœ¨æ‰§è¡Œè„šæœ¬ä¹‹å‰å¯¼å‡º`PASS`å˜é‡ï¼Œå› ä¸º`cronjob`ä¸æ˜¯åœ¨æ‚¨ä½œä¸ºç”¨æˆ·æ‰€åœ¨çš„ bash ä¸­æ‰§è¡Œçš„ï¼Œå¹¶ä¸”ä¹‹å‰å¯¼å‡ºçš„`PASS`å˜é‡ä¸å­˜åœ¨

**ä¹Ÿéå¸¸é‡è¦:**è®°ä½åœ¨é›†ç¾¤ä¸­çš„æ¯ä¸ª worker èŠ‚ç‚¹ä¸Šé‡æ–°åˆ›å»º`cronjob`(å¦‚æœä½ ä½¿ç”¨ Docker é›†ç¾¤çš„è¯)ã€‚**å¦åˆ™ï¼Œæ•°æ®å°†ä¼šä¸¢å¤±**ã€‚

# ç»“æŸè¯­

åœ¨è¿™ç¯‡ç®€å•çš„æ“ä½œæŒ‡å—ä¸­ï¼Œæˆ‘è§£é‡Šäº†å¦‚ä½•ä½¿ç”¨ Google Cloud SDK åœ¨æˆ‘çš„ Google Bucket ä¸­ä¿å­˜ä¸€ä¸ªåŠ å¯†çš„ zip æ–‡ä»¶ã€‚

æˆ‘æœ‰å¦ä¸€ä¸ªæ•™ç¨‹ï¼Œè§£é‡Šå¦‚ä½•ä¸Šä¼ æ–‡ä»¶åˆ°äºšé©¬é€Šã€‚æ‚¨å¯ä»¥ä»æœ¬æ•™ç¨‹å¤åˆ¶åŠ å¯†éƒ¨åˆ†ï¼Œå¹¶å°†å…¶ä¸ä¸Šä¼ åˆ° S3 çš„æ–‡ä»¶ç»“åˆèµ·æ¥:

[](https://aws.plainenglish.io/how-to-backup-your-files-to-aws-s3-b09f9378c082) [## å¦‚ä½•å°†æ‚¨çš„æ–‡ä»¶å¤‡ä»½åˆ° AWS S3

### ä¸€ä¸ªå¿«é€Ÿçš„å¯è§†åŒ–å¢å¼ºæ•™ç¨‹ï¼Œæ¶µç›–äº†å°†æ‚¨çš„é‡è¦æ–‡ä»¶ä¿å­˜åˆ° AWS S3 æ‰€éœ€çš„æ¯ä¸ªæ­¥éª¤ã€‚

aws .å¹³åŸè‹±è¯­. io](https://aws.plainenglish.io/how-to-backup-your-files-to-aws-s3-b09f9378c082) 

æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨äº‘ä¸­ä¿å­˜æ‚¨å®è´µçš„å¤‡ä»½ã€‚æˆ‘å¾ˆæƒ³å¬å¬ä½ çš„æƒ³æ³•ï¼Œå¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å†™åœ¨ä¸‹é¢ã€‚*ğŸ‘‡ğŸ‘‡ğŸ‘‡*

```
**Want to Connect With the Author?**Here's my [GitHub](https://github.com/paulknulst) handle and [LinkedId](https://linkedin.com/in/paulknulst) profile.
```

*æœ¬æ–‡æœ€åˆå‘è¡¨äºæˆ‘çš„åšå®¢*[*https://www . paulsblog . dev/encrypt-database-backup-and-save-on-Google-cloud-platform/*](https://www.paulsblog.dev/encrypt-database-backup-and-save-on-google-cloud-platform/)