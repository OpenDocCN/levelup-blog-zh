<html>
<head>
<title>Migrate from Helm 2 Tillerless to Helm 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从2号舵无舵转向3号舵</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/migrate-from-helm-2-tillerless-to-helm-3-8221284cb891?source=collection_archive---------29-----------------------#2020-03-10">https://levelup.gitconnected.com/migrate-from-helm-2-tillerless-to-helm-3-8221284cb891?source=collection_archive---------29-----------------------#2020-03-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4cb9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你和其他人一样，你至少在3.1版本发布之前不会迁移到Helm 3。2月初，它终于发布了。从那以后，我最近对Helm 2版本(<a class="ae kl" href="https://github.com/rimusz/helm-tiller" rel="noopener ugc nofollow" target="_blank">和无蒂勒插件</a>)到Helm 3.x的迁移做了一些分析，我想分享一些我的发现。</p><p id="609f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你要做的第一件事实际上是测试你所有的图表实际上是否会像Helm 3预期的那样工作。在很大程度上，我在这个特定领域没有看到任何问题，但是这完全取决于你使用的实际图表。所以为了有效地验证这一点，我建议让您的本地开发机器以干净的方式运行helm2和helm3。</p><p id="0d87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面这些提示是在Mac上完成的，假设你使用Helm 2 w/使用Brew的<a class="ae kl" href="https://github.com/rimusz/helm-tiller" rel="noopener ugc nofollow" target="_blank">无蒂勒插件</a>。您可以根据您选择的操作系统/软件包管理器的需要进行适当的修改。</p><p id="dbe9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想分享的关键概念是，您可以在集群上同时使用helm2和helm3，但是您只需要知道helm版本是如何(以及在哪里)存储在您的集群上的。Helm“发布”只不过是指向集群上部署的k8s对象的指针，意识到这一点有助于避免一些严重的混乱。</p><p id="ca42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我强烈推荐你也阅读这篇关于迁移到helm3的文章</p><h1 id="604e" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">清洁本地舵2和舵3设置</h1><p id="3211" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">让我们先把本地的helm二进制文件整理好。注意:您需要更改下面的特定版本，使其适合您在执行此操作时安装的版本。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="75d7" class="ly kn iq lu b gy lz ma l mb mc">brew uninstall helm <br/>brew uninstall helm@2 <br/>brew uninstall helm@3 <br/>brew install helm@3 </span><span id="94cf" class="ly kn iq lu b gy md ma l mb mc">cd /usr/local/bin <br/>rm helm </span><span id="b44d" class="ly kn iq lu b gy md ma l mb mc">ln -s ../Cellar/helm/3.1.1/bin/helm helm3 <br/>brew install helm@2 <br/>ln -s ../Cellar/helm\@2/2.16.3/bin/helm helm </span><span id="6079" class="ly kn iq lu b gy md ma l mb mc"># helm2 init helm init --client-only helm plugin install <a class="ae kl" href="https://github.com/rimusz/helm-tiller" rel="noopener ugc nofollow" target="_blank">https://github.com/rimusz/helm-tiller</a></span></pre><p id="a4bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">验证您的版本</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="fee5" class="ly kn iq lu b gy lz ma l mb mc">$ helm version Client: &amp;version.Version{SemVer:"v2.16.3", GitCommit:"1ee0254c86d4ed6887327dabed7aa7da29d7eb0d", GitTreeState:"clean"} <br/>Error: could not find tiller</span><span id="2b0f" class="ly kn iq lu b gy md ma l mb mc">$ helm3 version version.BuildInfo{Version:"v3.1.1", GitCommit:"afe70585407b420d0097d07b21c47dc511525ac8", GitTreeState:"clean"}</span></pre><p id="9b18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">至此，您已经对helm2和helm3命令有了一个清晰的设置。</p><h1 id="44ca" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">示例起点</h1><p id="f511" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">让我们假设您正在使用一个名为<em class="me">“myapp”</em>的掌舵图，并且您在k8s集群上的名称空间<em class="me">“名称空间-1”(tiller的名称空间和已部署的工件名称空间)中有3个现有版本(A、B和N)。</em>您用helm2列出这些对象，如下所示:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="8e66" class="ly kn iq lu b gy lz ma l mb mc">helm tiller run namespace-1 -- helm list --all</span></pre><p id="7613" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它看起来像下面这样:</p><figure class="lp lq lr ls gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi mf"><img src="../Images/9588cdba81bcb0a2a4ac008822f8f7cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p-82CLhrnJ1dRsqIGbsp1A.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">tiller将其已知helm2版本的“数据库”存储在同一个名称空间中。</figcaption></figure><h1 id="0aac" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">用helm3测试您的图表</h1><p id="acf2" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">让我们先通过helm2删除“release-n”</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="51d6" class="ly kn iq lu b gy lz ma l mb mc">helm tiller run namespace-1 -- helm delete --purge release-n</span></pre><p id="d639" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们使用helm3安装图表</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="d35f" class="ly kn iq lu b gy lz ma l mb mc">helm3 install release-n myapp --namespace namespace-1</span></pre><p id="ac21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设您的图表在helm3下运行良好，您现在的情况如下:</p><figure class="lp lq lr ls gt mg gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/69468b2b92211e721379570910327892.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/0*qsnNo1pSbwk716hi"/></div></figure><p id="604a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您的helm3安装命令不起作用，这可能是由于许多问题…最有可能的一个问题是，您可能会在生成的k8s YAML发送到Kubernetes之前遇到新的Helm3开放API验证。这通常是我在使用Helm3安装/升级现有图表时遇到的问题。这里有一个快速禁用它的方法</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="5e1e" class="ly kn iq lu b gy lz ma l mb mc">helm3 install --help <br/>... <br/>--disable-openapi-validation if set, the installation process will not validate rendered templates against the Kubernetes OpenAPI Schema <br/>...</span></pre><p id="40ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你的星盘可能会遇到其他问题，你必须单独调查每一个问题。也就是说，根据我的经验，Helm3在向后兼容方面做得非常好。</p><p id="4ffe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里还有一个你可能会遇到的令人讨厌的问题:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="2e0c" class="ly kn iq lu b gy lz ma l mb mc">is invalid: spec.clusterIP: Invalid value: "": field is immutable</span></pre><p id="6987" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他几个人也经历过这种情况，他们的图表在Helm2上运行良好(见这里的<a class="ae kl" href="https://github.com/helm/helm/issues/6378" rel="noopener ugc nofollow" target="_blank"/>和这里的<a class="ae kl" href="https://github.com/helm/helm/issues/7350" rel="noopener ugc nofollow" target="_blank"/>和这里的<a class="ae kl" href="https://github.com/helm/helm/pull/7431" rel="noopener ugc nofollow" target="_blank"/>等等)。Helm3的<em class="me">-force "</em>标志似乎存在行为差异。如果你正在使用<em class="me">-force "</em>，试着省略它。</p><h1 id="3819" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">Helm2和Helm3版本可以共存，但也有危险</h1><p id="cba9" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在上一节中，在使用Helm3测试我们的图表之前，我们强行删除了Helm2版本<em class="me">“release-n”</em>。实际上，在使用helm3进行安装/升级之前，您不必删除helm2版本……您当然可以执行以下操作:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="189a" class="ly kn iq lu b gy lz ma l mb mc">helm3 upgrade --install release-n myapp --namespace namespace-1</span></pre><p id="e6b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将产生一个类似这样的情况:</p><figure class="lp lq lr ls gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi ms"><img src="../Images/c96cfbf2dca126dd2e3ba90c82fd1702.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RS-5gFvZ9i5npOZ2cJwTZQ.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">…这可能会很糟糕</figcaption></figure><p id="9330" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们这里有什么？嗯，我们对预先存在的k8s对象执行了相同的图表(因为它们最初是通过helm2安装的)，并通过新创建的Helm3版本创建了一组指向它们的新指针。所以现在我们有多个发布指针指向同一组k8s对象…这些指针是两个独立的舵发布…一个用于helm2，另一个用于helm3。</p><p id="2bab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">理论上，这可以让你用helm2或helm3管理k8s对象…但是这非常危险，显然不推荐，因为它会导致极大的混乱。想象一下，有人删除了helm2版本，却发现helm3版本仍然在那里，并指向孤立的对象。这里的要点是，当在一个共享系统上同时使用相同的图表来试验Helm2和Helm3时，您需要小心。</p><h1 id="cac7" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">将您的Helm2版本迁移到Helm3，无需停机</h1><p id="8c15" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在解决了问题并使用Helm3在本地或测试集群上测试了您的图表之后，您将需要制定一个计划来将您的Helm2版本迁移到Helm3，最好不要停机。在生产环境中，为了升级部署工具而删除Helm2版本，然后通过Helm3安装它们是不切实际的，也是不可接受的。</p><p id="2a20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么我们如何做到这一点呢？理想情况下，我们希望能够将Helm2“发布”数据库转换为Helm3“发布”数据库，而无需实际安装/升级任何图表…让我们只转换发布数据库。你很幸运，因为有一个<a class="ae kl" href="https://github.com/helm/helm-2to3" rel="noopener ugc nofollow" target="_blank">伟大的工具可以实现这个目的，叫做helm-2to3 </a></p><p id="a057" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个工具很棒，因为它允许您将Helm2版本转换为Helm3版本，然后让您有选择地清除Helm2版本引用，而不会破坏底层的Kubernetes对象。</p><p id="b1ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，让我们安装它:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="dbe3" class="ly kn iq lu b gy lz ma l mb mc">helm3 plugin install <a class="ae kl" href="https://github.com/helm/helm-2to3" rel="noopener ugc nofollow" target="_blank">https://github.com/helm/helm-2to3</a></span></pre><p id="371a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">试运行转换<em class="me">“释放-n”:</em></p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="835a" class="ly kn iq lu b gy lz ma l mb mc">helm3 2to3 convert --tiller-out-cluster --dry-run --tiller-ns namespace-1 release-n</span></pre><p id="436f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">做一个<em class="me">“release-n”的真实转换:</em></p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="c97f" class="ly kn iq lu b gy lz ma l mb mc">helm3 2to3 convert --tiller-out-cluster --tiller-ns namespace-1 release-n</span></pre><p id="ccbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">验证Helm3中的版本:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="1eba" class="ly kn iq lu b gy lz ma l mb mc">helm3 list --all --namespace namespace-1</span></pre><p id="c88d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">验证释放仍在Helm2中:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="33dc" class="ly kn iq lu b gy lz ma l mb mc">helm tiller run namespace-1 -- helm list --all</span></pre><p id="68c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，在这一点上，您现在又处于这种情况(两个版本指向同一组k8s对象):</p><figure class="lp lq lr ls gt mg gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/12e147242f3b8e8d7365133243bb6f06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/0*xqPVczmAcXpq7N8o"/></div></figure><p id="891d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，让我们来解决这个问题，我们想摆脱Helm2发布指针，我们也可以这样做的工具！</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="7512" class="ly kn iq lu b gy lz ma l mb mc">helm3 2to3 cleanup --name release-n --tiller-ns namespace-1 --tiller-out-cluster</span></pre><p id="3e1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将使我们进入期望的状态:</p><figure class="lp lq lr ls gt mg gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/1d95ff6c173f6b5ea934b3773b2f19b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/0*4-CxiXV50uLxz7Wk"/></div></figure><p id="a5f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太好了！现在让我们在剩余的版本中重复这一点</p><p id="a706" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mv mw mx lu b">helm3 2to3 convert --tiller-out-cluster --tiller-ns namespace-1 release-a</code></p><p id="e677" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mv mw mx lu b">helm3 2to3 cleanup --name release-a --tiller-ns namespace-1 --tiller-out-cluster</code> <br/> <br/> <code class="fe mv mw mx lu b">helm3 2to3 convert --tiller-out-cluster --tiller-ns namespace-1 release-b</code></p><p id="b3a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mv mw mx lu b">helm3 2to3 cleanup --name release-b --tiller-ns namespace-1 --tiller-out-cluster</code></p><p id="450b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">…现在我们有了我们想要的状态:</p><figure class="lp lq lr ls gt mg gh gi paragraph-image"><div class="gh gi my"><img src="../Images/0d67f3c8c18520e6ee862741c5705457.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/0*y0ttSlpFlSFYEdoo"/></div></figure><p id="a9c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在看起来好多了。</p><h1 id="7b1a" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">摘要</h1><p id="3853" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">归根结底，从Helm2迁移到Helm3并不是什么大事。你绝对需要测试你的图表，了解舵“释放”是如何管理的，并观察什么指向什么，以避免混淆。同样重要的是，在开始迁移时，您要与整个团队进行沟通，并确保每个人都安装了正确的工具集，并且在迁移之前对上述版本概念有重要的理解。</p><p id="eb4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="me">原载于2020年3月10日http://bitsofinfo.wordpress.com</em><a class="ae kl" href="https://bitsofinfo.wordpress.com/2020/03/10/migrate-from-helm-2-tillerless-to-helm-3/" rel="noopener ugc nofollow" target="_blank"><em class="me"/></a><em class="me">。</em></p></div></div>    
</body>
</html>