<html>
<head>
<title>Raise the Bar of Code Quality in Python Projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">提高Python项目中的代码质量</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/raise-the-bar-of-code-quality-in-python-projects-7c49743f004f?source=collection_archive---------11-----------------------#2021-01-12">https://levelup.gitconnected.com/raise-the-bar-of-code-quality-in-python-projects-7c49743f004f?source=collection_archive---------11-----------------------#2021-01-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f98d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用isort、black、flake8创建预提交挂钩。将它添加到Github Actions中，以自动化您的代码样式检查，并保持最高的质量。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3a1e3561cfa2e62bae088ff90ebb6d97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zUOYo_3eGaVTzTY_"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">所有东西组织起来看起来都更好，代码也是！杰夫·谢尔登在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="4ba5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设你被一份理想的工作录取了。你认为你将与最有才华的同事一起工作，你感到非常兴奋。在适应日之后，你终于坐在你的办公桌前，检查你将要做的项目。</p><p id="c8ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">经过一段时间后，您意识到一切看起来比它应该的要复杂，因为在项目中没有样式检查。许多开发人员都做出了贡献，他们都像往常一样有不同的编码风格。很难理解这个项目，对吗？如果项目的所有部分都遵循相同的风格，这将非常简单。或者，如果导入是有序的，并且既没有未使用的导入，也没有未使用的变量，那就非常简单了。</p><p id="8acc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，该公司不想强迫开发人员在每次提交时考虑样式。他们能做什么？他们可以使用<strong class="ky ir">预提交钩子</strong>和<strong class="ky ir"> CI管道</strong>！在本文中，我们将定义一个预提交钩子，并将一个Github动作作为CI添加到一个基本的Python项目中。</p><p id="3100" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我不会详细解释预提交钩子或GitHub动作是如何工作的。然而，回忆简单的定义总是好的。</p><p id="4e87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://www.atlassian.com/git/tutorials/git-hooks" rel="noopener ugc nofollow" target="_blank"> Git挂钩是</a>:</p><blockquote class="ls lt lu"><p id="97fe" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">每次Git存储库中发生特定事件时自动运行的脚本。它们允许您定制Git的内部行为，并在开发生命周期的关键点触发可定制的操作。</p></blockquote><p id="4279" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://pre-commit.com/#introduction" rel="noopener ugc nofollow" target="_blank"> Git挂钩是必要的，因为</a>:</p><blockquote class="ls lt lu"><p id="aa32" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir"> Git钩子脚本</strong>对于在提交给代码评审之前识别简单问题<strong class="ky ir">很有用。我们在每次提交时运行钩子，自动指出代码中的问题，比如缺少分号、尾随空格和调试语句。通过<strong class="ky ir">在代码评审</strong>之前指出这些问题，这<strong class="ky ir">允许代码评审者专注于变更的架构，而不是浪费时间在琐碎的风格吹毛求疵上。</strong></strong></p></blockquote><p id="b2dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://pre-commit.com/#introduction" rel="noopener ugc nofollow" target="_blank">预提交框架是</a>:</p><blockquote class="ls lt lu"><p id="49f6" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">用于预提交钩子的多语言包管理器。你<strong class="ky ir">指定一个你想要的钩子列表</strong>，并且<strong class="ky ir">在每次提交</strong>之前管理用任何语言编写的钩子的安装和执行。预提交专门设计为不需要root访问权限。如果您的开发人员没有安装node，但是修改了一个JavaScript文件，那么pre-commit会自动处理下载和构建node，以便在没有root用户的情况下运行eslint。</p></blockquote><p id="ebf3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了深入理解Git挂钩，您可以查看以下链接:<a class="ae kv" href="https://towardsdatascience.com/pre-commit-hooks-you-must-know-ff247f5feb7e" rel="noopener" target="_blank"> 1 </a>、<a class="ae kv" href="https://githooks.com" rel="noopener ugc nofollow" target="_blank"> 2 </a>、<a class="ae kv" href="https://www.atlassian.com/git/tutorials/git-hooks" rel="noopener ugc nofollow" target="_blank"> 3 </a></p></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mg"><img src="../Images/afba94a93a375d9ff861ddc03e1bc642.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8GhhkibIkW39372M"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@landall?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">兰登</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="9958" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我为这篇文章创建了一个新的存储库。你可以在这里查看一下<a class="ae kv" href="https://github.com/BarisSari/medium-pre-commit-article" rel="noopener ugc nofollow" target="_blank"/>。在添加任何配置之前，请先看看有两个包的<a class="ae kv" href="https://github.com/BarisSari/medium-pre-commit-article/commit/b1e22d6c72bb7780e69893292c9d1e8e0dda2742" rel="noopener ugc nofollow" target="_blank">模块和</a> <code class="fe mh mi mj mk b"><a class="ae kv" href="https://github.com/BarisSari/medium-pre-commit-article/commit/b1e22d6c72bb7780e69893292c9d1e8e0dda2742" rel="noopener ugc nofollow" target="_blank">src</a></code> <a class="ae kv" href="https://github.com/BarisSari/medium-pre-commit-article/commit/b1e22d6c72bb7780e69893292c9d1e8e0dda2742" rel="noopener ugc nofollow" target="_blank">目录</a>。你看看<a class="ae kv" href="https://www.python.org/dev/peps/pep-0008/" rel="noopener ugc nofollow" target="_blank"> PEP 8 </a> ( <a class="ae kv" href="https://pep8.readthedocs.io/en/release-1.7.x/intro.html#error-codes" rel="noopener ugc nofollow" target="_blank"> E302，E303，更多</a>)都有造型误差:</p><p id="3959" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">src/bar/first_module.py</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">src/bar/first_module.py</figcaption></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">src/foo/first_module.py</figcaption></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">main.py</figcaption></figure></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><p id="a3fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将从项目根目录下名为<code class="fe mh mi mj mk b">.pre-commit-config.yaml</code>的文件开始，用于配置预提交挂钩:</p><pre class="kg kh ki kj gt mn mk mo mp aw mq bi"><span id="a0a3" class="mr ms iq mk b gy mt mu l mv mw">$ touch .pre-commit-config.yaml<br/>$ nano .pre-commit-config.yaml</span></pre><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="b8cc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们浏览这个配置文件时:</p><ul class=""><li id="a216" class="mx my iq ky b kz la lc ld lf mz lj na ln nb lr nc nd ne nf bi translated">使用<code class="fe mh mi mj mk b">exclude</code>关键字排除<code class="fe mh mi mj mk b">.git</code>和<code class="fe mh mi mj mk b">.tox</code>文件。预提交挂钩不会尝试修复这些文件。这是一个可选字段。</li><li id="0078" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated">每次尝试提交时，预提交挂钩都会运行。我们为此使用了<code class="fe mh mi mj mk b">default_stages: [commit]</code>关键字和值。这也是一个可选字段。其他可能的值有:<code class="fe mh mi mj mk b">commit</code>、<code class="fe mh mi mj mk b">merge-commit</code>、<code class="fe mh mi mj mk b">push</code>、<code class="fe mh mi mj mk b">prepare-commit-msg</code>、<code class="fe mh mi mj mk b">commit-msg</code>、<code class="fe mh mi mj mk b">post-checkout</code>、<code class="fe mh mi mj mk b">post-commit</code>或<code class="fe mh mi mj mk b">manual</code>。</li><li id="f740" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated">如果预提交挂钩失败，其余步骤将不会运行。对于这种行为，我们将<code class="fe mh mi mj mk b">fast_fail</code>设置为<code class="fe mh mi mj mk b">true</code>。这也是一个可选字段。这是一个可选字段，默认值也是false。</li></ul><p id="7284" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些是<a class="ae kv" href="https://pre-commit.com/#pre-commit-configyaml---top-level" rel="noopener ugc nofollow" target="_blank">顶级配置</a>。您可以使用的其他字段有<code class="fe mh mi mj mk b">default_language_version</code>、<code class="fe mh mi mj mk b">files</code>、<code class="fe mh mi mj mk b">minimum_pre_commit_version</code>和<code class="fe mh mi mj mk b">repos</code>。我们将在配置文件中只使用<code class="fe mh mi mj mk b">repos</code>。我们添加了几个存储库，它们将逐步运行:</p><ul class=""><li id="7cb8" class="mx my iq ky b kz la lc ld lf mz lj na ln nb lr nc nd ne nf bi translated">第一个是<a class="ae kv" href="https://github.com/pre-commit/pre-commit-hooks" rel="noopener ugc nofollow" target="_blank">预提交钩子</a>。我们将它用于:<code class="fe mh mi mj mk b">trailing-whitespace</code>(修剪行尾的空白)、<code class="fe mh mi mj mk b">end-of-file-fixer</code>(检查所有文件是否以换行符结尾)、<code class="fe mh mi mj mk b">check-toml</code>(检查toml文件的语法)、<code class="fe mh mi mj mk b">check-merge-conflict</code>(检查您的更改是否会导致合并冲突)。</li><li id="5176" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated">第二个是<a class="ae kv" href="https://github.com/psf/black" rel="noopener ugc nofollow" target="_blank">黑</a>，也就是<em class="lv">不折不扣的Python代码格式化器</em>。<strong class="ky ir">黑色</strong>自动修复几乎所有的造型错误。</li><li id="d814" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated">第三个是<a class="ae kv" href="https://github.com/timothycrosley/isort" rel="noopener ugc nofollow" target="_blank"> isort </a>，一个自动按照类型和名称对你的导入进行排序的库。它将Python的内置模块/包导入、第三方导入和项目模块/包导入分开。</li><li id="8e44" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated">最后一个是<a class="ae kv" href="https://gitlab.com/pycqa/flake8" rel="noopener ugc nofollow" target="_blank"> flake8 </a>。它使用PEP-8标准、pyflakes和其他库评估您的代码。即使<strong class="ky ir">黑</strong>和<strong class="ky ir">或</strong>解决了大部分问题，你可能还是会有一些错误，比如<a class="ae kv" href="https://github.com/psf/black/issues/1331" rel="noopener ugc nofollow" target="_blank">长串</a>。</li></ul><p id="0db8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如你所看到的，我们包括了几个库，除非你配置它们，否则它们可能会导致冲突。例如，当您使用默认配置时，<strong class="ky ir">黑色</strong>和<strong class="ky ir">或</strong>不同地处理长行导入。</p><p id="b130" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在安装和运行预提交钩子之前，我们将为这些库创建配置文件，它们将是兼容的。同样，我们将在项目的根目录下创建所有的新文件。</p><p id="9179" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行以下程序，为<strong class="ky ir">黑色</strong>和<strong class="ky ir">黑色</strong>创建一个名为<code class="fe mh mi mj mk b">pyproject.toml</code>的配置文件:</p><pre class="kg kh ki kj gt mn mk mo mp aw mq bi"><span id="8d39" class="mr ms iq mk b gy mt mu l mv mw">$ touch pyproject.toml<br/>$ nano pyproject.toml</span></pre><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="2001" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我发现默认的<strong class="ky ir">最大线长</strong>，<strong class="ky ir">黑色88，flake 8 79太小了。因此我通常将线长参数设置为100。当行太长时，很难一次看到所有代码，因为你应该向右滚动。但是，如果使用GitHub、Gitlab或者Bitbucket，在不滚动的情况下，仍然会看到全角行。</strong></p><p id="5d23" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于<strong class="ky ir">或</strong>，我们设置<code class="fe mh mi mj mk b">black</code>轮廓和<code class="fe mh mi mj mk b">multi_line_output</code>(即<a class="ae kv" href="https://pycqa.github.io/isort/#multi-line-output-modes" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">垂直悬挂缩进</strong> </a>)参数。你可以在这个链接中找到更多关于isort <a class="ae kv" href="https://pycqa.github.io/isort/docs/configuration/black_compatibility/" rel="noopener ugc nofollow" target="_blank">黑色兼容性的信息。</a></p><p id="ffe3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意:</strong>最好可以为<strong class="ky ir">或</strong>或<a class="ae kv" href="https://pycqa.github.io/isort/docs/configuration/config_files/" rel="noopener ugc nofollow" target="_blank">配置</a>创建一个名为<code class="fe mh mi mj mk b">.isort.cfg</code>的新文件。你应该用<code class="fe mh mi mj mk b">[settings]</code>而不是<code class="fe mh mi mj mk b">[tool.isort]</code>。请检查下面的代码:</p><pre class="kg kh ki kj gt mn mk mo mp aw mq bi"><span id="f2b1" class="mr ms iq mk b gy mt mu l mv mw">$ touch .isort.cfg<br/>$ nano .isort.cfg</span></pre><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="cc3d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们为<strong class="ky ir">片8 </strong>创建一个名为<code class="fe mh mi mj mk b">.flake8</code>的配置文件:</p><pre class="kg kh ki kj gt mn mk mo mp aw mq bi"><span id="4afa" class="mr ms iq mk b gy mt mu l mv mw">$ touch .flake8<br/>$ nano .flake8</span></pre><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="07ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如你所见，我给了<code class="fe mh mi mj mk b">max-line-length</code>相同的值，并且我排除了一些可能会带来不必要麻烦的文件。如果您使用虚拟环境，您的项目中可能会有一个<code class="fe mh mi mj mk b">venv</code>文件夹，您可以在其中安装相关的库。我可以向您保证，您不会希望flake8检查您的第三方库，因为这可能需要很长时间，并且flake8可能会发现大量的警告和错误。请不要更改您使用的第三方库的代码。如果您发现错误，请在存储库中打开问题和PR。如果需要更多改动，就叉回购，修改使用。原因是并非所有的开发人员都拥有您所拥有的环境。所以，对你有用的东西对其他人或在生产中不会有用。</p><p id="d731" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们将把所有这些配置文件添加到<code class="fe mh mi mj mk b">Git</code>中。</p><pre class="kg kh ki kj gt mn mk mo mp aw mq bi"><span id="e73e" class="mr ms iq mk b gy mt mu l mv mw">$ git add .pre-commit-config.yaml pyproject.toml .flake8</span></pre></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><p id="9763" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好的，我们准备好了。我将通过pip安装<code class="fe mh mi mj mk b">pre-commit</code>:</p><pre class="kg kh ki kj gt mn mk mo mp aw mq bi"><span id="61d0" class="mr ms iq mk b gy mt mu l mv mw">(venv) $ pip install pre-commit<br/>(venv) $ pre-commit install</span></pre><p id="4bea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我们安装了预提交钩子，它将在每次提交时运行。让我们试着提交添加的配置文件，看看我们的钩子是否运行。</p><pre class="kg kh ki kj gt mn mk mo mp aw mq bi"><span id="c9e5" class="mr ms iq mk b gy mt mu l mv mw">$ git commit -m "Add configurations"</span></pre><p id="7bc3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它应该给出以下错误:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/b1cd2983111fd463112c94657d71aa00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7d8fCYVoHUUG4-c_ZBys5A.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">我们的配置文件末尾没有换行符</figcaption></figure><p id="dc3b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好吧，再试试:</p><pre class="kg kh ki kj gt mn mk mo mp aw mq bi"><span id="3799" class="mr ms iq mk b gy mt mu l mv mw">$ git add .flake8 pyproject.toml<br/>$ git commit -m "Add configurations"</span></pre><p id="c3a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">预期产出如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/fd1239b29b20445e066b4a4216a11903.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NBjnWPo4-c2MEytM0RhuoA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">我们这次承诺没有任何问题</figcaption></figure><p id="3e6c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这次成功了。预提交钩子跳过了<strong class="ky ir">黑色</strong>、<strong class="ky ir">或</strong>和<strong class="ky ir">薄片8 </strong>步骤，因为我们没有在提交中添加任何python模块。如果我们添加它，它也会运行这些步骤。</p><p id="0d3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在安装预提交挂钩之前，我已经提交了有错误的文件。我想要的是运行预提交钩子并修复这些错误。我们可以使用<code class="fe mh mi mj mk b">pre-commit</code>的运行命令:</p><pre class="kg kh ki kj gt mn mk mo mp aw mq bi"><span id="6d7a" class="mr ms iq mk b gy mt mu l mv mw">$ pre-commit run -a </span></pre><p id="5205" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它将为所有文件运行预提交钩子(这就是<code class="fe mh mi mj mk b">-a</code>的意思)。如果您使用相同的文件，您将需要运行此命令三次，以便:</p><ol class=""><li id="b26a" class="mx my iq ky b kz la lc ld lf mz lj na ln nb lr nm nd ne nf bi translated">向模块添加新的空行，</li><li id="468a" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nm nd ne nf bi translated">使用黑色重新格式化代码</li><li id="2e55" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nm nd ne nf bi translated">使用isort重新格式化导入。</li></ol><p id="ee7e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">之后，您应该会看到一个错误，因为<strong class="ky ir">片8 </strong>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/96739ce564ff34a8e62825530f3e3ed5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HbQCcHLGFI6MDh2MqvyjQw.png"/></div></div></figure><p id="073b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从main.py中删除未使用的导入行:</p><pre class="kg kh ki kj gt mn mk mo mp aw mq bi"><span id="bf4b" class="mr ms iq mk b gy mt mu l mv mw">import random  <em class="lv"># An import which we will not use at all</em></span></pre><p id="d239" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，您可以再运行一次来确认:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/93b0d3bf52cd92c25e7c74b30e7a0964.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MwQEhLiLBVFOf7gtDplEFw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">所有步骤都通过了。文件已准备好提交</figcaption></figure><p id="1874" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行以下命令提交文件并完成教程的第一部分:</p><pre class="kg kh ki kj gt mn mk mo mp aw mq bi"><span id="ef4d" class="mr ms iq mk b gy mt mu l mv mw">$ git add main.py src/bar/first_module.py src/foo/first_module.py<br/>$ git commit -m "Run pre-commit hooks"</span></pre><p id="d108" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/BarisSari/medium-pre-commit-article/commit/519227f392054f1c23ac1a6e41076e7b1e53c066" rel="noopener ugc nofollow" target="_blank">让我们检查文件的最终版本:</a></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">src/bar/first_module.py</figcaption></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">src/foo/first_module.py</figcaption></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">main.py</figcaption></figure><p id="08ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它们看起来更优雅，对吗？以下是已修复的警告:</p><ul class=""><li id="6bd7" class="mx my iq ky b kz la lc ld lf mz lj na ln nb lr nc nd ne nf bi translated">PEP 8: E302期望在类或函数的定义之间有2个空行</li><li id="8f77" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated">PEP 8: E303方法定义之间有太多空行(2)</li><li id="245a" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated">PEP 8: E501行太长(137 &gt; 110个字符)</li><li id="9bc5" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated">PEP 8: W292文件结尾没有换行</li></ul></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><p id="61c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在教程的第二部分，我们将使用在GitHub Actions中创建的预提交钩子。<a class="ae kv" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank">Github</a>对它的定义如下:</p><blockquote class="no"><p id="bcde" class="np nq iq bd nr ns nt nu nv nw nx lr dk translated">GitHub Actions现在拥有世界一流的CI/CD，可以轻松实现所有软件工作流程的自动化。直接从GitHub构建、测试和部署您的代码。按照您想要的方式进行代码审查、分支管理和问题分类。</p></blockquote><p id="12ff" class="pw-post-body-paragraph kw kx iq ky b kz ny jr lb lc nz ju le lf oa lh li lj ob ll lm ln oc lp lq lr ij bi translated">GitHub Actions提供了很多！这是一个简洁而健壮的工具。并且拥有全面的<a class="ae kv" href="https://docs.github.com/en/free-pro-team@latest/actions/guides/building-and-testing-python" rel="noopener ugc nofollow" target="_blank">文档</a>。我将使用<a class="ae kv" href="https://github.com/actions/starter-workflows/blob/main/ci/python-package.yml" rel="noopener ugc nofollow" target="_blank">它建议的模板</a>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="6805" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在<code class="fe mh mi mj mk b">.github/workflows</code>目录下添加了这个文件。最后两步与示例模板不同:</p><ol class=""><li id="7044" class="mx my iq ky b kz la lc ld lf mz lj na ln nb lr nm nd ne nf bi translated">升级pip后，我们将通过pip安装预提交挂钩。</li><li id="9408" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nm nd ne nf bi translated">预提交将对存储库中的所有文件进行初始化和运行，但排除的文件除外。</li></ol><p id="b7b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为指定了三个Python版本，所以对于远程存储库的每个<code class="fe mh mi mj mk b">push</code>将有三个不同的构建。这是它的样子:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/6acfe0d60605d1ac8779a32a6330bf5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pHVhg7l7_bN5H1IRi9Uodw.png"/></div></div></figure><p id="5ee4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">预提交钩子的所有步骤都像预期的那样在GitHub上传递。</p><p id="3d5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，每次提交然后推送到远程时，GitHub工作流都会检查样式。此外，每次本地提交时，预提交挂钩将首先运行。它会阻止你犯错误，除非你使用<code class="fe mh mi mj mk b">force push</code>。</p><p id="959d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您现在已经有了帮助您标准化项目样式的设置。恭喜你！</p><p id="fbd0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在下面找到最新版本的存储库:</p><div class="oe of gp gr og oh"><a href="https://github.com/BarisSari/medium-pre-commit-article" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd ir gy z fp om fr fs on fu fw ip bi translated">baris sari/medium-提交前-文章</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">带有预提交钩子和GitHub动作的基本python项目</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">github.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov kp oh"/></div></div></a></div></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><h1 id="2c34" class="ow ms iq bd ox oy oz pa pb pc pd pe pf jw pg jx ph jz pi ka pj kc pk kd pl pm bi translated"><strong class="ak">结论</strong></h1><p id="f3dd" class="pw-post-body-paragraph kw kx iq ky b kz pn jr lb lc po ju le lf pp lh li lj pq ll lm ln pr lp lq lr ij bi translated">在本地和GitHub动作中使用预提交钩子非常简单。并且<strong class="ky ir">在大多数情况下，你甚至不需要手动修改你的代码</strong>，因为预提交会自动修复它们。你的钩子会自动修好它们。然而，当您有一些坚持错误时，您应该检查预提交日志并进行更改。</p><p id="f1fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请记住，拥有<strong class="ky ir">预提交挂钩并不意味着</strong>您的<strong class="ky ir">项目与所有PEP规则</strong>兼容。例如，对于PEP-8，在命名函数时应该只使用小写字母和下划线。如果您定义了一个名为TEST的函数，预提交钩子将不会报错。你应该<strong class="ky ir">知道哪些包含的库(黑，isort，flake8)能</strong> <strong class="ky ir">哪些不能</strong>。尽管如此，如果您试图遵循Python的最佳实践，预提交钩子肯定会对您有所帮助。</p><p id="2940" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意:</strong>请记住，我给模块和包起了愚蠢的名字。我试图展示预提交挂钩是多么简单和有效。这就是为什么我尽量把模块和包做得傻傻的原因。您可以查看这个<a class="ae kv" href="https://gist.github.com/sloria/7001839" rel="noopener ugc nofollow" target="_blank">要点</a>以了解Python的一些最佳实践，比如命名约定。</p><p id="b6c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注2: </strong>你也可以对其他编程语言使用预提交钩子。请检查<a class="ae kv" href="https://pre-commit.com/hooks.html" rel="noopener ugc nofollow" target="_blank">该链接</a>以查看所有支持的挂钩。</p><p id="62bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意-3: </strong>我正在使用PyCharm，即使我使用它的提交&amp;推送屏幕，它也运行预提交钩子。您可以检查您的IDE是否具有此功能，除非您使用Git的终端。</p><p id="671b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注-4: </strong>还有其他很棒的CI/CD工具，比如Travis，CircleCI，Jenkins。一旦你为你的项目设置和配置了一个预提交钩子，你总是可以通过添加几行代码把它包含到你最喜欢的CI/CD工具中。网上有很多例子。你可以去看看。</p><p id="8220" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">谢谢你一直读到最后！我期待听到你的回应。</p></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><h1 id="232e" class="ow ms iq bd ox oy oz pa pb pc pd pe pf jw pg jx ph jz pi ka pj kc pk kd pl pm bi translated">资源</h1><ul class=""><li id="606f" class="mx my iq ky b kz pn lc po lf ps lj pt ln pu lr nc nd ne nf bi translated"><a class="ae kv" href="https://github.com/psf/black" rel="noopener ugc nofollow" target="_blank">黑知识库</a> — <a class="ae kv" href="https://black.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank">文档</a></li><li id="39e6" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated"><a class="ae kv" href="https://github.com/pycqa/isort/" rel="noopener ugc nofollow" target="_blank"> Isort知识库</a> — <a class="ae kv" href="https://pycqa.github.io/isort/" rel="noopener ugc nofollow" target="_blank">文档</a></li><li id="4d2f" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated"><a class="ae kv" href="https://gitlab.com/pycqa/flake8" rel="noopener ugc nofollow" target="_blank"> Flake8知识库</a> — <a class="ae kv" href="https://flake8.pycqa.org/en/latest/index.html#quickstart" rel="noopener ugc nofollow" target="_blank">文档</a></li><li id="a08c" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated"><a class="ae kv" href="https://www.python.org/dev/peps/pep-0008/" rel="noopener ugc nofollow" target="_blank">人教版8风格指南</a></li><li id="f246" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated"><a class="ae kv" href="https://pep8.readthedocs.io/en/release-1.7.x/intro.html#error-codes" rel="noopener ugc nofollow" target="_blank"> PEP 8错误代码</a></li><li id="cbf2" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated"><a class="ae kv" href="https://www.atlassian.com/git/tutorials/git-hooks" rel="noopener ugc nofollow" target="_blank"> Git挂钩</a></li><li id="c5ed" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated"><a class="ae kv" href="http://pre-commit.com" rel="noopener ugc nofollow" target="_blank">预提交挂钩</a></li><li id="c2d2" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated"><a class="ae kv" href="https://docs.github.com/en/free-pro-team@latest/actions/guides/building-and-testing-python#starting-with-the-python-workflow-template" rel="noopener ugc nofollow" target="_blank"> Github工作流——用Python构建和测试</a></li></ul></div></div>    
</body>
</html>