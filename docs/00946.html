<html>
<head>
<title>Running a scraping platform at Google Cloud for as little as US$ 0.05/month</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌云上运行一个抓取平台，每月只需0.05美元</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/running-a-scraping-platform-at-google-cloud-for-as-little-as-us-0-05-month-6d9658982f04?source=collection_archive---------0-----------------------#2019-09-27">https://levelup.gitconnected.com/running-a-scraping-platform-at-google-cloud-for-as-little-as-us-0-05-month-6d9658982f04?source=collection_archive---------0-----------------------#2019-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6917" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最近面临着在柏林找公寓的问题。根据我以前在这方面的经验，我决定自动完成这项任务，并编写一个软件向我发送最佳交易的提醒。在本文中，我将解释我是如何构建这个平台的基础的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/4f223edf6b10fd1f5db3436550bee305.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pYrsDWO8Q-hHDrBHe6PMtg.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">由<a class="ae lb" href="https://www.flickr.com/photos/132646954@N02/40858786523" rel="noopener ugc nofollow" target="_blank"> dronepicr </a>拍摄的照片</figcaption></figure><p id="f52a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">我写的平台是一个使用Terraform部署到Google Cloud的Go应用程序。此外，它还可以从一个私有的GitHub库进行持续部署。</strong></p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="459a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">经过快速研究，我得出了以下需要监控的平台列表:</p><ul class=""><li id="2557" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">易贝·克莱纳泽根</li><li id="3c47" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">ImmobilienScout24</li><li id="909d" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">Immowelt</li><li id="f229" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">巢匹克</li></ul><p id="5a79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几个小时后，我有了一个Go二进制文件，它完成了在本地运行应用程序所需的一切。它使用一个名为<a class="ae lb" href="https://github.com/gocolly/colly" rel="noopener ugc nofollow" target="_blank"> Colly </a>的网络抓取框架来浏览所有平台列表，提取基本属性，并导出到本地文件系统中的CSV文件。</p><p id="3dc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我不想让应用程序在本地运行，所以我的第一选择是在<a class="ae lb" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> Google Cloud </a>获得一个便宜的实例。一旦我有了这个租来的虚拟机，我就可以编写一个启动脚本来编译来自GitHub的应用程序，并设置一个crontab来每天抓取平台。</p><p id="9be1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于这个特定的项目来说，这可能是最好的决定，但是我可以把这个个人问题作为探索Google云服务集成的机会吗？</p><p id="e0c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为，在过去，我参与了多个涉及某种刮擦应用程序的项目，我相信这是值得努力的。我可以很容易地在将来重用这个设置。</p><p id="2000" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我的建筑始于几个前提:</p><ul class=""><li id="2679" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">它应该使用谷歌云服务。</li><li id="fbc6" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">它应该支持每隔几分钟收集一次数据，即使我开始一天只收集一次。</li><li id="1e45" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">它应该像数字海洋(5美元)的廉价液滴一样划算。</li><li id="3204" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">应该很容易部署。理想情况下，它应该实现连续部署。</li><li id="e5e2" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">它应该支持按需触发数据收集过程—例如，在HTTP POST请求之后。</li></ul><p id="10f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我的假设是，我不需要一个全天候运行的虚拟机；因此，它的价格不应该和一个月的价格一样。事实上，我的应用程序能够在3分钟内下载我感兴趣的所有属性，所以我期望的要低得多。</p><h1 id="151e" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">建筑</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mv"><img src="../Images/68e5cc5e00edeabbb5a0df6929415110.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eSekmsMBKDdoNugqDvMMww.png"/></div></div></figure><p id="35c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我对最新的谷歌云服务进行了探索，结果发现了<a class="ae lb" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank"> Cloud Run </a>，这是一种“在完全托管的环境中或在你自己的GKE集群中运行无状态容器”的服务它仍被谷歌云归类为测试产品，基于<a class="ae lb" href="https://knative.dev/" rel="noopener ugc nofollow" target="_blank"> Knative </a>和<a class="ae lb" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>构建。关键的提议是它的定价模式:它是以毫秒为单位收费，而不是以小时为单位。</p><p id="b8b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">经过一些调整，我的Go应用程序被封装在一个Docker容器中，可以由Cloud Run运行。一旦收到HTTP POST请求，它就从所有广告的属性中收集属性，并以CSV文件的形式发布到Google存储桶。对于我的用例，我创建了两种可能的方法来访问这个端点:一种是可访问互联网的地址，这样我就可以随时触发它；另一种是通过Cloud Scheduler，它被配置为每天访问一次。</p><h1 id="e4c5" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">应用程序</h1><p id="58b4" class="pw-post-body-paragraph jn jo iq jp b jq mw js jt ju mx jw jx jy my ka kb kc mz ke kf kg na ki kj kk ij bi translated">这个应用程序相当简单:它由一个具有单一端点的HTTP服务器组成。在每次点击时，它会抓取所有平台，并将结果保存在存储桶内的CSV中。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nb"><img src="../Images/a652dce349a08347c9dc1972f3d08f2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FmZEzqlusjW54DnfX9xtqA.png"/></div></div></figure><h2 id="f2fb" class="nc ly iq bd lz nd ne dn md nf ng dp mh jy nh ni ml kc nj nk mp kg nl nm mt nn bi translated">。/main.go</h2><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi no"><img src="../Images/e8a7e47dcd16aa4fd6ef2524eb6b648b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TarFriZVRgIrDDs02Qt8yA.png"/></div></div></figure><h2 id="9f03" class="nc ly iq bd lz nd ne dn md nf ng dp mh jy nh ni ml kc nj nk mp kg nl nm mt nn bi translated">。/Dockerfile</h2><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi no"><img src="../Images/249ab05d53be7ba1322b69c45854b1fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*onH1PJ5pjYf5-PB2BoqzZA.png"/></div></div></figure><p id="b608" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他应用文件可以在<a class="ae lb" href="https://gist.github.com/Irio/3da6ee4dea8cad6613c1337a15044f09" rel="noopener ugc nofollow" target="_blank">本要诀</a>中找到。感谢所有的反馈，因为这是我的第一个Go项目之一。</p><h1 id="c1ac" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">部署</h1><ol class=""><li id="1d1f" class="lj lk iq jp b jq mw ju mx jy np kc nq kg nr kk ns lp lq lr bi translated"><a class="ae lb" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank">安装地形</a>。</li><li id="43cc" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk ns lp lq lr bi translated"><a class="ae lb" href="https://cloud.google.com/sdk/docs/quickstarts" rel="noopener ugc nofollow" target="_blank">安装Google Cloud CLI </a>并使用<br/><strong class="jp ir"><em class="nt">$ g Cloud auth log in</em></strong>登录您的账户<em class="nt"/></li><li id="d0be" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk ns lp lq lr bi translated"><a class="ae lb" href="https://console.cloud.google.com/projectcreate" rel="noopener ugc nofollow" target="_blank">创建一个Google Cloud项目</a>并将CLI配置为使用<br/><strong class="jp ir">$ g Cloud config set PROJECT PROJECT _ NAME</strong></li><li id="bd6d" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk ns lp lq lr bi translated"><a class="ae lb" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">创建一个Google云服务账户</a>用于Terraform，赋予其“所有者”角色。</li><li id="37a0" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk ns lp lq lr bi translated">为这个新的服务帐户创建并下载一个JSON密钥。将其放在<strong class="jp ir">deployment/credentials . JSON</strong>中</li><li id="98bd" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk ns lp lq lr bi translated"><a class="ae lb" href="https://console.developers.google.com/apis/library" rel="noopener ugc nofollow" target="_blank">启用以下云API</a>:<br/>*应用引擎管理API <br/> *云构建API <br/> *云运行API <br/> *云调度器API</li><li id="abdd" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk ns lp lq lr bi translated"><a class="ae lb" href="https://console.cloud.google.com/iam-admin/iam" rel="noopener ugc nofollow" target="_blank">给以<strong class="jp ir">@ Cloud build . gserviceaccount . com</strong>:<br/>*云运行管理员<br/> *云运行服务代理结尾的API服务账号赋予适当的角色</a></li><li id="f339" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk ns lp lq lr bi translated">基于您的GitHub资源库创建一个<a class="ae lb" href="https://source.cloud.google.com/repo/new" rel="noopener ugc nofollow" target="_blank">云资源库</a>。</li><li id="3a8b" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk ns lp lq lr bi translated">在<strong class="jp ir"> terraform.tfvars </strong>中设置合适的变量值。</li></ol><p id="bb65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在有了许可，使用Terraform来设置基础设施的其余部分。</p><p id="8dc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> $ cd部署<br/> $ terraform初始化<br/> $ terraform应用</strong></p><p id="0371" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">初始部署可能需要大约五分钟，因为Terraform会在配置云调度程序之前等待云运行构建和启动。</p><p id="4ee1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于Cloud Run仍处于测试阶段API端点处于alpha阶段——我无法在Terraform文件中声明所有的基础设施。作为一个临时的解决办法，我编写了几个辅助的bash脚本，通过它的CLI命令触发云API。幸运的是，当开发人员触发<strong class="jp ir"> terraform apply </strong>时，所有这些都在后台发生。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="a36a" class="lx ly iq bd lz ma nu mc md me nv mg mh mi nw mk ml mm nx mo mp mq ny ms mt mu bi translated">结果呢</h1><p id="6f2e" class="pw-post-body-paragraph jn jo iq jp b jq mw js jt ju mx jw jx jy my ka kb kc mz ke kf kg na ki kj kk ij bi translated">每天，在没有任何人工交互的情况下，Cloud Scheduler会创建一个新文件夹，其中包含许多CSV文件，包含我所在城市中最近可用的公寓。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nz"><img src="../Images/327bbdbd54bb3b2e27182246ab3dbcf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dsf0wgbMdWFuFTJRKeBFng.png"/></div></div></figure><h1 id="c865" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">成本</h1><p id="11b9" class="pw-post-body-paragraph jn jo iq jp b jq mw js jt ju mx jw jx jy my ka kb kc mz ke kf kg na ki kj kk ij bi translated">并非所有正在使用的服务都可以在<a class="ae lb" href="https://cloud.google.com/products/calculator/#id=2e6bb472-7ce9-4dd2-a2b9-15502f810fb9" rel="noopener ugc nofollow" target="_blank">官方计算器</a>中获得。无论哪种方式，我对我个人的使用做了一个粗略的估计，考虑到每天一次部署的不切实际的数量。</p><h2 id="3611" class="nc ly iq bd lz nd ne dn md nf ng dp mh jy nh ni ml kc nj nk mp kg nl nm mt nn bi translated">云存储—每月0.02美元</h2><ul class=""><li id="dd9d" class="lj lk iq jp b jq mw ju mx jy np kc nq kg nr kk lo lp lq lr bi translated">地点:美国</li><li id="754e" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">A类操作:4*30 = 120</li><li id="4de6" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">第一个月<br/> -存储:2MB*30 = 60MB</li><li id="cdce" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">第12个月<br/> -存储:2MB*365 = 730MB</li></ul><h2 id="590a" class="nc ly iq bd lz nd ne dn md nf ng dp mh jy nh ni ml kc nj nk mp kg nl nm mt nn bi translated">云运行—每月0.00美元</h2><ul class=""><li id="ea3f" class="lj lk iq jp b jq mw ju mx jy np kc nq kg nr kk lo lp lq lr bi translated">位置:美国东部1</li><li id="871f" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">分配的Cpu</li><li id="986a" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">分配的内存:1GB</li><li id="e182" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">每个容器实例的并发请求:1</li><li id="c54d" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">每个请求的执行时间(毫秒):5000</li><li id="c6bc" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">每次请求执行的出站网络带宽(KB): 1000</li><li id="393c" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">每月请求数:30</li></ul><h2 id="7332" class="nc ly iq bd lz nd ne dn md nf ng dp mh jy nh ni ml kc nj nk mp kg nl nm mt nn bi translated">云构建—每月0.00美元</h2><ul class=""><li id="ce12" class="lj lk iq jp b jq mw ju mx jy np kc nq kg nr kk lo lp lq lr bi translated">120分钟/天的免费配额</li><li id="18e4" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">4构建分钟/天</li></ul><h2 id="33cd" class="nc ly iq bd lz nd ne dn md nf ng dp mh jy nh ni ml kc nj nk mp kg nl nm mt nn bi translated">集装箱注册——每月0.02-0.19美元</h2><ul class=""><li id="f7e0" class="lj lk iq jp b jq mw ju mx jy np kc nq kg nr kk lo lp lq lr bi translated">0.026美元/GB</li><li id="b32f" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">第一个月<br/>-20MB * 30 = 600 MB<br/>-600/1024 * 0.026 = 0.02</li><li id="2d94" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">第12个月<br/> -存储:20MB * 365 = 7300 MB<br/>-7300/1024 * 0.026 = 0.19</li></ul><h2 id="f95f" class="nc ly iq bd lz nd ne dn md nf ng dp mh jy nh ni ml kc nj nk mp kg nl nm mt nn bi translated">云资源存储库—每月0.00美元</h2><ul class=""><li id="12d7" class="lj lk iq jp b jq mw ju mx jy np kc nq kg nr kk lo lp lq lr bi translated">5个项目用户的免费配额</li><li id="416a" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">1个项目</li></ul><h2 id="8825" class="nc ly iq bd lz nd ne dn md nf ng dp mh jy nh ni ml kc nj nk mp kg nl nm mt nn bi translated">云调度程序—每月0.00美元</h2><ul class=""><li id="0b37" class="lj lk iq jp b jq mw ju mx jy np kc nq kg nr kk lo lp lq lr bi translated">3个免费工作/月的免费配额</li><li id="dc5d" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">1份工作</li></ul></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="edcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">相比之下，一个f1-micro实例——具有0.6GB的RAM——在Google Cloud上运行了整整一个月，包含在免费层中；一个1.7GB的g1小型实例每月花费13.80美元。此外，根据我最初的假设和进一步的优化的准确性，考虑成本可能会降低或增加也是合理的。</p></div></div>    
</body>
</html>