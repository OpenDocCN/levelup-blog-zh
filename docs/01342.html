<html>
<head>
<title>Fluttering Dart: Futures and Isolates</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">飞舞的飞镖:未来与孤立</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/fluttering-dart-futures-and-isolates-6b4bce6d804b?source=collection_archive---------5-----------------------#2019-12-15">https://levelup.gitconnected.com/fluttering-dart-futures-and-isolates-6b4bce6d804b?source=collection_archive---------5-----------------------#2019-12-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="007a" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" rel="noopener ugc nofollow" target="_blank" href="https://levelup.gitconnected.com/fluttering-dart/home">飘动的飞镖</a></h2><div class=""/><div class=""><h2 id="3942" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">如何克服单线程的缺点</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/e90b42cc5e56ba053a0eb32070c345a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bZRpRoVISBrTaCxJ9aaL4Q.jpeg"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">照片由<a class="ae lh" href="https://unsplash.com/@createria?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Createria </a>在<a class="ae lh" href="https://unsplash.com/s/photos/wind-turbine?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="cf53" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">Dart是单线程的。这意味着我们所有的应用程序代码都在同一个线程中运行。不幸的是，如果单线程运行非常耗时的操作，比如HTTP请求，我们的代码可能会阻塞单线程的执行。</p><h2 id="ce4c" class="me mf it bd mg mh mi dn mj mk ml dp mm lr mn mo mp lv mq mr ms lz mt mu mv iz bi translated">期货</h2><p id="4560" class="pw-post-body-paragraph li lj it lk b ll mw kd ln lo mx kg lq lr my lt lu lv mz lx ly lz na mb mc md im bi translated">未来通过允许我们执行异步操作来解决这个问题。为了表示和处理这些操作的结果，我们得到了关键字<code class="fe nb nc nd ne b">async</code>和<code class="fe nb nc nd ne b">await</code>。</p><p id="e684" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">一个<code class="fe nb nc nd ne b">Future&lt;T&gt;</code>对象在未来的某个时间提供一个T类型的值。</p><p id="55e4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们继续使用我们在前面部分中使用的Cat类，并看看它们领域中的一个例子:</p><pre class="ks kt ku kv gt nf ne ng nh aw ni bi"><span id="dada" class="me mf it ne b gy nj nk l nl nm">import 'dart:math';</span><span id="ecec" class="me mf it ne b gy nn nk l nl nm">class Cat {<br/>  DateTime birthday;</span><span id="fede" class="me mf it ne b gy nn nk l nl nm">  Cat.baby() {<br/>    birthday = DateTime.now();<br/>  }</span><span id="00c8" class="me mf it ne b gy nn nk l nl nm"><strong class="ne jd">  Future</strong>&lt;<strong class="ne jd">String</strong>&gt;<strong class="ne jd"> meow</strong>()<strong class="ne jd"> asyn</strong>c {<br/>    var random = Random.secure();<br/>    <strong class="ne jd">await</strong> Future.delayed(Duration(seconds: random.nextInt(10)));<br/>    return 'Meow!';<br/>  }<br/>}</span><span id="7ee4" class="me mf it ne b gy nn nk l nl nm">void main() async {<br/>  Cat babyCat = Cat.baby();<br/>  print('Baby cat says:');<br/>  String babyCatMeow = await babyCat.meow();<br/>  print('$babyCatMeow');<br/>}</span></pre><p id="1bd2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在上面的例子中，我们创建了一只小猫。如果你不知道，猫想做什么就做什么，想什么时候做就什么时候做。喵喵叫也不例外，我们的小猫会以0-10秒的间隔随机喵喵叫。</p><p id="c1dd" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd">猫</strong>类的<strong class="lk jd">喵</strong>方法是<strong class="lk jd">异步</strong>同步的。在<strong class="lk jd">等待</strong> s随机秒数(0–10)后，它在<strong class="lk jd">未来</strong>返回一个<strong class="lk jd">字符串</strong>。<strong class="lk jd"> Future.delayed </strong>方法在给定的持续时间内停止单线程执行。注意，我们还必须使我们的<strong class="lk jd">主异步</strong>同步，并且<strong class="lk jd">等待</strong>的<strong class="lk jd">喵</strong>结果。</p><p id="96e4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这种等待结果的异步方法机制适用于任何时候，因为计算/逻辑的原因，我们需要获得一些只能/应该在未来才可用的数据。</p><h2 id="a7b7" class="me mf it bd mg mh mi dn mj mk ml dp mm lr mn mo mp lv mq mr ms lz mt mu mv iz bi translated">孤立者</h2><p id="c3c5" class="pw-post-body-paragraph li lj it lk b ll mw kd ln lo mx kg lq lr my lt lu lv mz lx ly lz na mb mc md im bi translated">我们身边越来越多的多核CPU设备上的单线程似乎有点低效。</p><p id="342c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">开发人员利用设备所有处理能力的传统方式是使用并发运行的共享内存线程。这种方法既复杂又容易出错。</p><p id="6437" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">Dart使用隔离来利用所有可用的处理能力。隔离允许真正的并行代码执行，从而提高性能和整体应用程序响应能力。</p><p id="7beb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">所有的Dart程序都从至少一个Isolate实例开始，这个实例就是<strong class="lk jd"> main </strong> <strong class="lk jd"> Isolate </strong>，我们所有的应用程序代码都在这里运行。</p><p id="99a1" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">要让我们的代码并行执行，我们必须创建新的隔离实例。这些将与主隔离并行运行。隔离是完全独立的，有自己的内存堆，确保任何其他隔离都无法访问任何隔离的状态。</p><p id="42f1" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">为了在隔离之间建立通信(发送/接收数据),我们需要交换消息。这些可以是原始值，如<code class="fe nb nc nd ne b">null</code>、<code class="fe nb nc nd ne b">num</code>、<code class="fe nb nc nd ne b">bool</code>、<code class="fe nb nc nd ne b">double</code>或<code class="fe nb nc nd ne b">String</code>，也可以是简单对象，如<code class="fe nb nc nd ne b">List&lt;Cat&gt;</code>。在隔离之间传递更复杂的对象，比如<code class="fe nb nc nd ne b">Future</code>或<code class="fe nb nc nd ne b">http.Response</code>，可能会导致错误。</p><p id="0d1d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> Isolate.spawn </strong>期望传递一个静态或顶级函数。</p><pre class="ks kt ku kv gt nf ne ng nh aw ni bi"><span id="acba" class="me mf it ne b gy nj nk l nl nm">import 'dart:math';<br/>import 'dart:isolate';</span><span id="f5cf" class="me mf it ne b gy nn nk l nl nm">class Cat {<br/>  DateTime birthday;</span><span id="df55" class="me mf it ne b gy nn nk l nl nm">  Cat.baby() {<br/>    birthday = DateTime.now();<br/>  }</span><span id="7820" class="me mf it ne b gy nn nk l nl nm">  <strong class="ne jd">static void meow(int s) async {</strong><br/>    await Future.delayed(Duration(seconds: s));<br/>    print('Meow!');<br/>  }<br/>}</span><span id="0be4" class="me mf it ne b gy nn nk l nl nm">void main() async {<br/>  var timeInterval = 10;<br/>  var random = Random.secure();<br/>  for(var i=0; i&lt;100; i++) {<br/>    <strong class="ne jd">await Isolate.spawn(Cat.meow, random.nextInt(timeInterval));</strong><br/>  }<br/>  await Future.delayed(Duration(seconds: timeInterval+1));<br/>}</span></pre><p id="d13c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们修改了Cat类，将<strong class="lk jd">喵</strong>方法转化为静态(类)方法。我们还将其更改为接受<strong class="lk jd"> s </strong>，这是一个表示猫必须喵喵叫的秒数的参数。这种方法将用于观察隔离物的工作情况。</p><p id="d9a4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在主隔离中，我们声明一个10秒的时间间隔和一个随机生成器。然后，我们在接下来的10秒钟内产生100个Cat.meow方法，每个方法都在一个专用的隔离区中运行。</p><p id="c030" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们还确保<strong class="lk jd">主隔离</strong>比它产生的其他隔离运行的时间长一点，否则我们只会看到产生的输出有0秒的延迟。</p><p id="fef9" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">当编译成JavaScript时，孤立文件被转换成网络工作者(T21)。</p><p id="458e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">请注意，这在DartPad中不起作用。您可以在您最喜欢的编辑器中的Dart/Flutter项目设置中测试它(我使用的是<a class="ae lh" href="https://code.visualstudio.com" rel="noopener ugc nofollow" target="_blank"> Visual Studio代码</a>，尽管还有其他很棒的选项)。</p></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><p id="cece" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><a class="ae lh" href="https://flutter.dev" rel="noopener ugc nofollow" target="_blank"> Flutter </a>项目既可以使用特定平台代码，也可以使用跨平台代码。后者是用<a class="ae lh" href="https://dart.dev" rel="noopener ugc nofollow" target="_blank"> Dart </a>写的，而且，构建Flutter apps，需要一些Dart的基础知识。</p><p id="4da1" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><a class="ae lh" href="https://medium.com/tag/fluttering-dart/archive" rel="noopener"/></p><p id="ace2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在本系列的前几部分中，我们介绍了Dart <a class="ae lh" href="/@constanting/fluttering-dart-9a3e74b0d9c5" rel="noopener ugc nofollow" target="_blank"> <strong class="lk jd">内置数据类型</strong> </a> <strong class="lk jd">，</strong> <a class="ae lh" href="/@constanting/fluttering-dart-b37110f4d1bf" rel="noopener ugc nofollow" target="_blank"> <strong class="lk jd">函数</strong> </a> <strong class="lk jd">，</strong> <a class="ae lh" href="/@constanting/fluttering-dart-ee493f4b0440" rel="noopener ugc nofollow" target="_blank"> <strong class="lk jd">运算符</strong> </a> <strong class="lk jd">，</strong> <a class="ae lh" href="/@constanting/fluttering-dart-the-flow-7be2080763ad" rel="noopener ugc nofollow" target="_blank"> <strong class="lk jd">控制流语句</strong> </a> <strong class="lk jd"> </strong>和<a class="ae lh" href="https://medium.com/@constanting/fluttering-dart-oop-8b92cd89a7f0" rel="noopener"> <strong class="lk jd">面向对象编程</strong> </a> <strong class="lk jd">(类、对象等等)</strong></p><p id="a4a4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在这一部分中，我们发现了如何克服Dart的单线程缺点。</p><p id="fd43" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">可以使用<a class="ae lh" href="https://dartpad.dev" rel="noopener ugc nofollow" target="_blank"><strong class="lk jd"/></a>试一试上面的一些代码示例。</p><p id="600c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在<a class="ae lh" href="https://medium.com/tag/fluttering-dart/archive" rel="noopener"><strong class="lk jd">flying Dart</strong></a>系列的下一部分，我们将深入探讨<a class="ae lh" href="https://medium.com/@constanting/fluttering-dart-libraries-and-packages-972edf864ff9" rel="noopener">库和包</a>，它们对于构建、使用、重用和共享我们的代码至关重要。</p><div class="nv nw gp gr nx ny"><a href="https://medium.com/@constanting/fluttering-dart-libraries-and-packages-972edf864ff9" rel="noopener follow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd jd gy z fp od fr fs oe fu fw jc bi translated">飞舞的飞镖:库和包</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">库和包对于在Flutter和Dart中构建、使用、重用和共享组件是至关重要的…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">medium.com</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om lb ny"/></div></div></a></div><p id="f25e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">就这些！</p></div></div>    
</body>
</html>