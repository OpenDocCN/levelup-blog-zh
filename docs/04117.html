<html>
<head>
<title>Building a Membership System in Django Under 5 Minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Django建立会员系统不到5分钟</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/building-a-membership-system-in-django-under-5-mins-5efd7e03627d?source=collection_archive---------0-----------------------#2020-06-10">https://levelup.gitconnected.com/building-a-membership-system-in-django-under-5-mins-5efd7e03627d?source=collection_archive---------0-----------------------#2020-06-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/96168a49baeefb2e5bba21412b45da15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9xSJ47WVT7UaqhmC"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com/@kellysikkema?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">凯利·西克玛</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="a361" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">明白了逻辑，那么其他的一切都是空谈。</p><p id="e240" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">开发人员在他们的网站上销售特定服务时，经常会遇到实现某种会员系统的需求，我们马上就来做这件事。</p><p id="d847" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本文只关注在现有的Django应用程序中构建或集成会员/订阅系统。处理支付可以使用Paypal或Stripe API实现，但这方面将是另一篇文章的一部分。</p><p id="d485" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们将启动一个名为Membership的新应用。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="361b" class="ln lo it lj b gy lp lq l lr ls">./manage.py startapp membership</span></pre><p id="e861" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们将进入models.py并开始添加我们将使用的必要模型。大多数实现将在数据库级完成，因此，正确定义表之间的关系将决定我们的成员资格应用程序的正确性。</p><p id="5215" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将需要3个模型——一个<strong class="ki iu">成员资格</strong>模型，保存关于成员资格类型(免费、高级或其他)的信息，价格……一个<strong class="ki iu">用户成员资格</strong>模型，保存用户信息，最后一个订阅模型将处理用户订阅。</p><p id="8469" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">先说我们的会员课。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="25cd" class="ln lo it lj b gy lp lq l lr ls">from django.db import models<br/>from django.conf import settings</span><span id="2fb1" class="ln lo it lj b gy lt lq l lr ls"># Create your models here.</span><span id="45b8" class="ln lo it lj b gy lt lq l lr ls">MEMBERSHIP_CHOICES = (<br/>(‘Premium’, ‘pre’),<br/>(‘Free’, ‘free’)<br/>)</span><span id="2781" class="ln lo it lj b gy lt lq l lr ls">class Membership(models.Model):<br/>    slug = models.SlugField(null=True, blank=True)<br/>    membership_type = models.CharField(<br/>    choices=MEMBERSHIP_CHOICES, default=’Free’,<br/>    max_length=30<br/>      )<br/>    price = models.DecimalField(default=0)</span><span id="1dba" class="ln lo it lj b gy lt lq l lr ls">def __str__(self):<br/>       return self.membership_type</span></pre><p id="3d77" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了便于学习，我们创建了两个级别的会员资格，但这取决于您。slug属性将用于URL模式。接下来，我们将讨论UserMembership类。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="740a" class="ln lo it lj b gy lp lq l lr ls">class UserMembership(models.Model):<br/>    user = models.OneToOneField(settings.AUTH_USER_MODEL,     related_name=’user_membership’, on_delete=models.CASCADE)</span><span id="fdb0" class="ln lo it lj b gy lt lq l lr ls">    membership = models.ForeignKey(Membership, related_name=’user_membership’, on_delete=models.SET_NULL, null=True)</span><span id="11cb" class="ln lo it lj b gy lt lq l lr ls">    def __str__(self):<br/>       return self.user.username</span></pre><p id="23c8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个类只包含两个属性user和membership</p><ul class=""><li id="f894" class="lu lv it ki b kj kk kn ko kr lw kv lx kz ly ld lz ma mb mc bi translated"><strong class="ki iu">用户</strong>:一对一关系，指向应用程序的用户模型。</li><li id="f148" class="lu lv it ki b kj md kn me kr mf kv mg kz mh ld lz ma mb mc bi translated"><strong class="ki iu"> membership </strong>:这是前面定义的成员模型的外键。</li></ul><p id="2816" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们将通过添加订阅模型来结束。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="002c" class="ln lo it lj b gy lp lq l lr ls">class Subscription(models.Model):<br/>    user_membership = models.ForeignKey(UserMembership, related_name=’subscription’, on_delete=models.CASCADE)</span><span id="552c" class="ln lo it lj b gy lt lq l lr ls">    active = models.BooleanField(default=True)</span><span id="971a" class="ln lo it lj b gy lt lq l lr ls">    def __str__(self):<br/>      return self.user_membership.user.username</span></pre><p id="70e3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里我们有一个UserMembership的外键，然后添加另一个属性来检查user_membership是否是活动的。</p><p id="945e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在进行迁移，然后通过运行。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="ed4a" class="ln lo it lj b gy lp lq l lr ls">./manage.py makemigrations membership<br/>./manage.py migrate</span></pre><p id="5e20" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如我在开始时所说的，最具决定性的方面是在数据库级别正确处理您的实施，这是我们到目前为止所做的，现在我们需要看到它的行动。</p><p id="bc61" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从在<code class="fe mi mj mk lj b">admin.py</code>中添加以下内容开始</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="3d3b" class="ln lo it lj b gy lp lq l lr ls">### admin.py </span><span id="ce24" class="ln lo it lj b gy lt lq l lr ls">from .models import Membership, UserMembership, Subscription</span><span id="1d38" class="ln lo it lj b gy lt lq l lr ls"># Register your models here.</span><span id="4eb8" class="ln lo it lj b gy lt lq l lr ls">admin.site.register(Membership)<br/>admin.site.register(UserMembership)<br/>admin.site.register(Subscription)</span></pre><p id="41f3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">跳过管理界面，添加两个会员实体，免费和高级。</p><p id="9c42" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来我们需要添加一个视图函数，它将负责显示所有可用的会员计划。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="2520" class="ln lo it lj b gy lp lq l lr ls">## views.py</span><span id="c58d" class="ln lo it lj b gy lt lq l lr ls">from django.views.generic import ListView<br/>from membership.models import Membership, UserMembership, Subscription</span><span id="604b" class="ln lo it lj b gy lt lq l lr ls">class MembershipView(ListView):<br/>    model = Membership<br/>    template_name = 'memberships/list.html'</span><span id="f597" class="ln lo it lj b gy lt lq l lr ls">    def get_user_membership(self):<br/>        user_membership_qs = UserMembership.objects.filter(user=self.request.user)<br/>        if user_membership_qs.exists():<br/>            return user_membership_qs.first()<br/>        return None</span><span id="b477" class="ln lo it lj b gy lt lq l lr ls">    def get_context_data(self, *args, **kwargs):<br/>        context = super().get_context_data(**kwargs)<br/>        current_membership = self.get_user_membership(self.request)<br/>        context['current_membership'] = str(current_membership.membership)<br/>        return context</span></pre><p id="4534" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们需要连接将调用视图功能的URL，并最终返回HTML模板。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="d39a" class="ln lo it lj b gy lp lq l lr ls">### urls.py</span><span id="b1b6" class="ln lo it lj b gy lt lq l lr ls">from django.urls import path, include<br/>from . import views</span><span id="7e77" class="ln lo it lj b gy lt lq l lr ls">app_name = 'membership'</span><span id="03ad" class="ln lo it lj b gy lt lq l lr ls">urlpatterns = [<br/>       path('memberships/', views.MembershipView.as_view(), name='select'),<br/>]</span></pre><p id="6f8f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">HTML模板。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="af13" class="ln lo it lj b gy lp lq l lr ls">% block content %}</span><span id="5b35" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">div</strong> <em class="ml">class</em>="container"&gt;</span><span id="e8c0" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">br</strong>&gt;</span><span id="76b8" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">h1</strong>&gt;Choose a plan according to your needs&lt;/<strong class="lj iu">h1</strong>&gt;</span><span id="6267" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">hr</strong>&gt;</span><span id="6cd3" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">div</strong> <em class="ml">class</em>="row"&gt;</span><span id="ffe6" class="ln lo it lj b gy lt lq l lr ls">{% for object in object_list %}</span><span id="c8fa" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">div</strong> <em class="ml">class</em>="col-sm-4 col-md-4"&gt;</span><span id="9e4f" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">div</strong> <em class="ml">class</em>="card" <em class="ml">style</em>="width: 18rem;"&gt;</span><span id="d287" class="ln lo it lj b gy lt lq l lr ls"><em class="ml">&lt;!-- &lt;img class="card-img-top " src="{{ object.image.url }}" alt="Card image cap"&gt; --&gt;</em></span><span id="190f" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">div</strong> <em class="ml">class</em>="card-body"&gt;</span><span id="8b92" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">h5</strong> <em class="ml">class</em>="card-title"&gt;{{ object.membership_type }}&lt;/<strong class="lj iu">h5</strong>&gt;</span><span id="23f3" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">p</strong> <em class="ml">class</em>="card-text"&gt;{{ object.desc | linebreaks }}&lt;/<strong class="lj iu">p</strong>&gt;</span><span id="5c77" class="ln lo it lj b gy lt lq l lr ls">&lt;/<strong class="lj iu">div</strong>&gt;</span><span id="0d65" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">ul</strong> <em class="ml">class</em>="list-group list-group-flush"&gt;</span><span id="dee6" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">li</strong> <em class="ml">class</em>="list-group-item"&gt; ${{ object.price }}&lt;<strong class="lj iu">small</strong>&gt;/month&lt;/<strong class="lj iu">small</strong>&gt;&lt;/<strong class="lj iu">li</strong>&gt;</span><span id="6163" class="ln lo it lj b gy lt lq l lr ls">&lt;/<strong class="lj iu">ul</strong>&gt;</span><span id="73d3" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">div</strong> <em class="ml">class</em>="card-body"&gt;</span><span id="e5f3" class="ln lo it lj b gy lt lq l lr ls">{% if object.membership_type != 'Free' %}</span><span id="66c2" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">form</strong> <em class="ml">method</em>="POST" <em class="ml">action</em>="{% url 'web:select' %}"&gt;</span><span id="5bad" class="ln lo it lj b gy lt lq l lr ls">{% csrf_token %}</span><span id="ab19" class="ln lo it lj b gy lt lq l lr ls">{% if object.membership_type != current_membership %}</span><span id="6414" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">button</strong> <em class="ml">class</em>="btn btn-warning"&gt;Change&lt;/<strong class="lj iu">button</strong>&gt;</span><span id="32a0" class="ln lo it lj b gy lt lq l lr ls">{% else %}</span><span id="53fd" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">small</strong>&gt;Your current plan&lt;/<strong class="lj iu">small</strong>&gt;</span><span id="f152" class="ln lo it lj b gy lt lq l lr ls">{% endif %}</span><span id="609a" class="ln lo it lj b gy lt lq l lr ls">&lt;<strong class="lj iu">input</strong> <em class="ml">type</em>="hidden" <em class="ml">name</em>="membership_type" <em class="ml">value</em>="{{ object.membership_type }}"&gt;</span><span id="1a6d" class="ln lo it lj b gy lt lq l lr ls">&lt;/<strong class="lj iu">form</strong>&gt;</span><span id="98ef" class="ln lo it lj b gy lt lq l lr ls">{% endif %}</span><span id="3ba6" class="ln lo it lj b gy lt lq l lr ls">&lt;/<strong class="lj iu">div</strong>&gt;</span><span id="4696" class="ln lo it lj b gy lt lq l lr ls">&lt;/<strong class="lj iu">div</strong>&gt;</span><span id="cff1" class="ln lo it lj b gy lt lq l lr ls">&lt;/<strong class="lj iu">div</strong>&gt;</span><span id="733f" class="ln lo it lj b gy lt lq l lr ls">{% endfor %}</span><span id="1a05" class="ln lo it lj b gy lt lq l lr ls">&lt;/<strong class="lj iu">div</strong>&gt;</span><span id="99bb" class="ln lo it lj b gy lt lq l lr ls">&lt;/<strong class="lj iu">div</strong>&gt;</span><span id="72be" class="ln lo it lj b gy lt lq l lr ls">{% endblock content %}</span></pre><p id="be19" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在只能看到什么是可用的，我们需要在用户注册时处理用户成员的创建。打开包含处理用户注册的代码的文件(我在signUpForm中处理我的)。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="1efe" class="ln lo it lj b gy lp lq l lr ls">### import datetime</span><span id="fa66" class="ln lo it lj b gy lt lq l lr ls">from django import forms<br/>from django.forms import ModelForm<br/>from django.contrib.auth.forms import UserCreationForm<br/>from membership.models import Membership, UserMembership, Subscription</span><span id="2da9" class="ln lo it lj b gy lt lq l lr ls">class SignUpForm(UserCreationForm):<br/>    free_membership = Membership.objects.get(membership_type=’Free’)</span><span id="58e3" class="ln lo it lj b gy lt lq l lr ls">    class Meta(UserCreationForm.Meta):<br/>       model = User</span><span id="0bf8" class="ln lo it lj b gy lt lq l lr ls">    def save(self):<br/>      user = super().save(commit=False)<br/>      user.save()</span><span id="e32e" class="ln lo it lj b gy lt lq l lr ls">      # Creating a new UserMembership<br/>      user_membership = UserMembership.objects.create(user=user, membership=self.free_membership)<br/>      user_membership.save()</span><span id="8775" class="ln lo it lj b gy lt lq l lr ls">      # Creating a new UserSubscription<br/>      user_subscription = Subscription()<br/>      user_subscription.user_membership = user_membership<br/>      user_subscription.save()<br/>      return user</span></pre><p id="dedf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们所做的只是查询免费会员资格，然后将其分配给新注册的用户，最后返回该特定用户。</p><p id="0b2a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是每个会员系统背后的逻辑，希望你能明白，如果没有，请随时留言，我很乐意跟进。</p><p id="6527" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">干杯。</p></div></div>    
</body>
</html>