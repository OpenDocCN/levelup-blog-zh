<html>
<head>
<title>Email Yourself Daily Alexa Skill Metrics Updates using Lambda, SMAPI, and SES</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Lambda、SMAPI和SES向自己发送每日Alexa技能指标更新的电子邮件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/email-yourself-daily-alexa-skill-metrics-updates-using-lambda-smapi-and-ses-9c16ac97c1f8?source=collection_archive---------12-----------------------#2020-11-16">https://levelup.gitconnected.com/email-yourself-daily-alexa-skill-metrics-updates-using-lambda-smapi-and-ses-9c16ac97c1f8?source=collection_archive---------12-----------------------#2020-11-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/fcd15c8d1d2d16ae22807669a2bdeace.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XfIGZnNlZcrv60sC"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">由<a class="ae jd" href="https://unsplash.com/@wwarby?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">威廉·沃比</a>在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><div class=""/><div class=""><h2 id="4a0f" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">每天将您的最新技能指标发送到您的收件箱，因为登录控制台太难了</h2></div><p id="cb3e" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我坚信监控Alexa技能指标的好处——除了当野外出现问题时它们可以给你重要的警告之外，观看良好的指标攀升也是非常令人愉快的！在本教程中，我们将学习如何安排Lambda通过Alexa技能管理API (SMAPI)获取你的技能指标，并将这些指标发送到你的收件箱，所有这些都使用无服务器框架进行管理。</p><p id="6882" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">SMAPI是一个API，它提供了ASK CLI或Alexa开发人员控制台中的所有相同功能。SMAPI Node.js SDK使我们能够执行这些操作，比如从Lambda函数中检索技能指标数据。</p><h1 id="de64" class="lr ls jg bd lt lu lv lw lx ly lz ma mb km mc kn md kp me kq mf ks mg kt mh mi bi translated">获取用于SMAPI身份验证的LWA令牌</h1><p id="4388" class="pw-post-body-paragraph kv kw jg kx b ky mj kh la lb mk kk ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">SMAPI通过使用Amazon (LWA)令牌登录来验证调用，所以我们的第一步将是检索一个LWA刷新令牌，我们可以在Lambda函数中使用它来检索我们想要的指标。SMAPI SDK将能够在任何时候调用我们的Lambda时将这个刷新令牌交换为有效的访问令牌。为了获得LWA刷新令牌，您需要通过LWA控制台配置LWA安全配置文件，如下所示:</p><ol class=""><li id="99c0" class="mo mp jg kx b ky kz lb lc le mq li mr lm ms lq mt mu mv mw bi translated">访问<a class="ae jd" href="http://login.amazon.com" rel="noopener ugc nofollow" target="_blank"> LWA控制台</a>并登录。</li><li id="91df" class="mo mp jg kx b ky mx lb my le mz li na lm nb lq mt mu mv mw bi translated">如果您以前没有创建过安全配置文件，您将看到如下内容:</li></ol><figure class="nd ne nf ng gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/a6f644b83cd5076d86d391dbb4c94cc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z30mhTXdksVL4CEmVAfzEQ.png"/></div></div></figure><p id="bd0f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">单击“Create a New Security Profile ”(创建新的安全配置文件)按钮并填写必填字段，将使我们能够访问获取SMAPI使用的令牌所需的凭据。</p><p id="60c8" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">3.创建个人资料后，您将看到以下屏幕:</p><figure class="nd ne nf ng gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nh"><img src="../Images/77ca1b45d826334a6968475a82ce5d20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r1dxS-7WT9nXwDDuoaspkA.png"/></div></div></figure><p id="cc72" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将使用ASK CLI将我们的LWA客户端ID和客户端密码交换为一个刷新令牌，我们将能够在lambda中使用该令牌。为了使用ASK CLI生成此令牌，我们需要更改安全配置文件中的Web设置。可以通过单击安全配置文件最右侧的齿轮图标，然后单击“Web Settings”来访问Web设置这将显示以下视图:</p><figure class="nd ne nf ng gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/ca47e0dd659fee92a990c48b5f352d0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fBL3FP1PVd-zRYlP_UZ_0w.png"/></div></div></figure><p id="3bfa" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们需要将<code class="fe nj nk nl nm b">http://127.0.0.1:9090/cb</code>和<code class="fe nj nk nl nm b"><a class="ae jd" href="https://s3.amazonaws.com/ask-cli/response_parser.html" rel="noopener ugc nofollow" target="_blank">https://s3.amazonaws.com/ask-cli/response_parser.html</a></code>添加到允许返回的URL列表中，可以通过点击右下角的编辑按钮进行修改。</p><p id="c96b" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">4.我们现在准备申请我们的LWA令牌！我们将使用ASK CLI将我们的安全配置文件中的客户端Id和客户端密码交换为刷新令牌。如果这是您第一次使用ASK CLI，您首先需要使用<code class="fe nj nk nl nm b">npm install -g ask-cli</code>安装它，并通过运行<code class="fe nj nk nl nm b">ask configure</code>配置您的ASK CLI凭据。一旦完成，运行<code class="fe nj nk nl nm b">ask util generate-lwa-tokens --client-id <strong class="kx jh">{your LWA Client ID}</strong> --client-confirmation <strong class="kx jh">{your LWA Client Secret}</strong></code>将输出一个访问和刷新令牌——刷新令牌就是我们想要的，因为它将允许我们稍后在lambda中使用SMAPI进行身份验证。</p><h1 id="d3dc" class="lr ls jg bd lt lu lv lw lx ly lz ma mb km mc kn md kp me kq mf ks mg kt mh mi bi translated">建立架构</h1><p id="fb9d" class="pw-post-body-paragraph kv kw jg kx b ky mj kh la lb mk kk ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">现在我们可以进行SMAPI调用了，我们准备开始部署一些云资源了！我们的架构将涉及一个由EventBridge规则触发的Lambda，它将通过SMAPI检索技能的指标，然后使用SES通过电子邮件发送这些数据。我们将使用无服务器框架来管理我们的云资源；这使得安排我们的Lambda变得非常容易，因为Serverless提供了一个<code class="fe nj nk nl nm b">schedule</code> Lambda事件，它负责为我们设置EventBridge规则。</p><h2 id="21fe" class="nn ls jg bd lt no np dn lx nq nr dp mb le ns nt md li nu nv mf lm nw nx mh ny bi translated">机密管理</h2><p id="a646" class="pw-post-body-paragraph kv kw jg kx b ky mj kh la lb mk kk ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">因为我们在Lambda中处理秘密，并且我们喜欢以正确的方式来玩，所以我们将使用SSM参数存储来存储我们在前面的步骤中创建的秘密和刷新令牌。记住这一点，我们现在可以将我们的LWA客户端id、密码和刷新令牌作为SecureString类型的参数添加到SSM。出于本教程其余部分的目的，我将假设我们已经分别用参数名LWA _客户端_ID、LWA _客户端_秘密和SMAPI _刷新_令牌存储了这些值。</p><h2 id="d6a0" class="nn ls jg bd lt no np dn lx nq nr dp mb le ns nt md li nu nv mf lm nw nx mh ny bi translated">创建堆栈</h2><p id="230a" class="pw-post-body-paragraph kv kw jg kx b ky mj kh la lb mk kk ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">为了构建我们的无服务器堆栈，我们将从一个名为sendNightlyUpdate的lambda函数开始，并配置一个事件在UTC时间每天晚上11:59触发Lambda:</p><pre class="nd ne nf ng gt nz nm oa ob aw oc bi"><span id="ba48" class="nn ls jg nm b gy od oe l of og">sendNightlyUpdate:<br/>  handler: handler.sendNightlyUpdate<br/>  events:<br/>    - schedule: cron(59 23 * * ? *)</span></pre><p id="6f44" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们在这里提供给cron()的参数表示我们希望Lambda被触发的分钟、小时、月、日和年——您可以在这里找到关于cron()调度AWS事件<a class="ae jd" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html" rel="noopener ugc nofollow" target="_blank">的更多细节。</a></p><p id="9336" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，我们需要确保我们的Lambda函数具有正确的IAM角色，能够访问我们在SSM的秘密(ssm:GetParameters)并通过SES发送电子邮件(SES:sendmeil)。这些角色的添加为我们提供了以下堆栈:</p><figure class="nd ne nf ng gt is"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="4f19" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在来看处理程序代码！</p><h1 id="f806" class="lr ls jg bd lt lu lv lw lx ly lz ma mb km mc kn md kp me kq mf ks mg kt mh mi bi translated">λ处理程序代码</h1><p id="8f02" class="pw-post-body-paragraph kv kw jg kx b ky mj kh la lb mk kk ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">我们剩下要做的就是在lambda处理程序中编写我们需要的代码，以获取我们的技能指标，并通过电子邮件发送它们。这将有三个不同的步骤:从他们在SSM存储的地方获得秘密和令牌，通过SMAPI检索我们的技能指标，并使用SES发送电子邮件。我将把每一步分解成它自己的功能。让我们从把秘密带出SSM开始:</p><figure class="nd ne nf ng gt is"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="451d" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们使用<code class="fe nj nk nl nm b">SSM.getParameters()</code>来保持API调用最少；这个方法为我们提供了对parameter对象数组的访问，我们将其格式化为参数名到值的映射，以便在剩余的代码中进行更清晰的访问。</p><p id="0f55" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，我们将编写一个函数，该函数将接受这些秘密以及我们感兴趣的技能的技能Id，并返回我们选择的指标:</p><figure class="nd ne nf ng gt is"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="d0cd" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们的<code class="fe nj nk nl nm b">getMetricForSkill</code>函数的第一个参数metric name是一个字符串，表示我们希望为我们的技能检索的特定度量。SMAPI支持检索描述独特客户、会话、话语等数量的多个指标——您可以在<a class="ae jd" href="https://developer.amazon.com/en-US/docs/alexa/smapi/metrics-api.html#metric-values" rel="noopener ugc nofollow" target="_blank">这个</a>文档中找到您可以检索的指标的完整列表。</p><p id="2454" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们用于指标检索的SMAPI方法是<code class="fe nj nk nl nm b">getSkillMetricsV1</code>，它采用允许您指定检索指标的skillId、指标时间周期的开始和结束时间、指标的聚合周期、您的技能阶段以及您检索指标的技能类型的参数。在这里，我们请求将我们的指标聚合到一个单独的数据点，用于实时定制技能的最后24小时。<code class="fe nj nk nl nm b">getSkillMetricsV1</code>有更多的可选参数，允许您对指标检索进行更细粒度的控制，完整的描述可以在<a class="ae jd" href="https://developer.amazon.com/en-US/docs/alexa/smapi/metrics-api.html#request-parameters" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="6213" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以在SMAPI响应的<em class="oj"> values </em>数组的第一个条目中找到我们的指标，并且知道第一个条目将包含我们正在寻找的数字，因为我们请求了类型为SINGLE的聚合周期，这意味着数据将被加起来成为一个单一的总和。</p><p id="0bdc" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，我们需要的是一个允许我们通过SES发送电子邮件的功能:</p><figure class="nd ne nf ng gt is"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="ad08" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">SES Node.js SDK为我们提供了一个<code class="fe nj nk nl nm b">sendEmail</code>函数，我们可以将目的地和源地址以及消息体和主题传递给它。需要注意的是，如果您的AWS帐户仍然在ses的沙盒中，那么您只能通过SES控制台向您已经验证的电子邮件地址发送电子邮件。使用SES验证电子邮件地址的过程非常简单，只需点击发送到该地址的确认电子邮件中的链接——您可以在这里<a class="ae jd" href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-email-addresses-procedure.html" rel="noopener ugc nofollow" target="_blank">找到该过程的分步说明</a>。如果你想发送电子邮件到任何地址，你可以通过提交请求来退出沙盒模式，如<a class="ae jd" href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/request-production-access.html" rel="noopener ugc nofollow" target="_blank">这些说明</a>中所述。SES对所有帐户都是在沙盒中开始的，所以如果你还没有采取行动摆脱它，你可能还在沙盒中。</p><p id="5789" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，我们可以将lambda处理程序中的3个步骤联系在一起:</p><figure class="nd ne nf ng gt is"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="353f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一个<code class="fe nj nk nl nm b">serverless deploy</code>晚了，嘣！我们现在有一个计划好的夜间lambda作业，它将获取我们为给定技能选择的技能指标，并通过电子邮件发送给我们。不仅如此，我们现在还知道如何通过Node.js SDK与SMAPI交互，这为各种Lambda自动化提供了可能性。让我知道你是如何创造性地运用这些能力的！</p><h2 id="b1f7" class="nn ls jg bd lt no np dn lx nq nr dp mb le ns nt md li nu nv mf lm nw nx mh ny bi translated">资源:</h2><p id="2b19" class="pw-post-body-paragraph kv kw jg kx b ky mj kh la lb mk kk ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated"><a class="ae jd" href="https://developer.amazon.com/en-US/docs/alexa/smapi/smapi-overview.html" rel="noopener ugc nofollow" target="_blank">SMAPI的AWS文档</a>，其中关于获取访问令牌<br/> <a class="ae jd" href="https://developer.amazon.com/en-US/docs/alexa/smapi/metrics-api.html#metric-values" rel="noopener ugc nofollow" target="_blank">的</a><a class="ae jd" href="https://developer.amazon.com/en-US/docs/alexa/smapi/get-access-token-smapi.html" rel="noopener ugc nofollow" target="_blank">部分</a>文档描述了通过SMAPI <br/> <a class="ae jd" href="https://developer.amazon.com/en-US/docs/alexa/smapi/metrics-api.html#request-parameters" rel="noopener ugc nofollow" target="_blank">使用</a>getskillmetricsv 1方法<br/> <a class="ae jd" href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-email-addresses-procedure.html" rel="noopener ugc nofollow" target="_blank">如何</a>验证用于SES沙箱的电子邮件地址<br/><a class="ae jd" href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/request-production-access.html" rel="noopener ugc nofollow" target="_blank">SES沙箱中的限制</a>以及如何使用cron 获得用于AWS事件<br/>的<a class="ae jd" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html" rel="noopener ugc nofollow" target="_blank"/></p><p id="53ca" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你正在寻找更简单的方法来掌握你的Alexa技能指标，你也可以看看iOS版的Alexa Stats应用程序——它允许你通过iOS应用程序检查你的技能。</p><div class="ip iq gp gr ir ok"><a href="https://apps.apple.com/us/app/alexa-stats/id1548502502#?platform=iphone" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd jh gy z fp op fr fs oq fu fw jf bi translated">Alexa统计数据</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">在旅途中获取您的Alexa技能指标使用Alexa从您的手机上关注您的所有ALEXA技能…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">apps.apple.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy ix ok"/></div></div></a></div></div></div>    
</body>
</html>