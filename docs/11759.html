<html>
<head>
<title>Service registry and discovery in Golang Cloud-Native microservice with Consul and Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang Cloud中的服务注册和发现-带有Consul和Docker的原生微服务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/service-registry-and-discovery-in-golang-cloud-native-microservice-with-consul-and-docker-731a01c648b4?source=collection_archive---------3-----------------------#2022-04-14">https://levelup.gitconnected.com/service-registry-and-discovery-in-golang-cloud-native-microservice-with-consul-and-docker-731a01c648b4?source=collection_archive---------3-----------------------#2022-04-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="33a9" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">背景</h1><p id="aa72" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这篇文章中，我将给出一个真实的演示应用程序，展示如何在基于<code class="fe lj lk ll lm b">Consul</code>和<code class="fe lj lk ll lm b">Docker</code>的<code class="fe lj lk ll lm b">Cloud-Native</code>微服务架构中进行服务注册和发现。并且服务是用<code class="fe lj lk ll lm b">Golang</code>语言开发的。</p><p id="f8ac" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">它将涵盖以下技术要点:</p><ul class=""><li id="3822" class="ls lt iq kn b ko ln ks lo kw lu la lv le lw li lx ly lz ma bi translated">集成咨询和Golang服务注册应用程序</li><li id="1d54" class="ls lt iq kn b ko mb ks mc kw md la me le mf li lx ly lz ma bi translated">将Consul与Golang应用程序集成在一起进行服务发现</li><li id="41f9" class="ls lt iq kn b ko mb ks mc kw md la me le mf li lx ly lz ma bi translated">用Docker(docker-compose)配置和运行微服务</li></ul><p id="9830" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">如你所见，这篇文章将涵盖几个重要的概念和有趣的工具。我将对它们做一个简短的介绍。</p><ul class=""><li id="477e" class="ls lt iq kn b ko ln ks lo kw lu la lv le lw li lx ly lz ma bi translated"><strong class="kn ir">云原生</strong>:这是软件行业的另一个流行语。云原生应用的关键属性之一是<code class="fe lj lk ll lm b">containerized</code>。要被认为是云原生的，应用程序必须是<code class="fe lj lk ll lm b">infrastructure agnostic</code>并且使用容器。容器为应用程序提供了作为独立环境运行的能力，能够移入和移出云，并且不依赖于任何特定的云提供商。</li><li id="4bbf" class="ls lt iq kn b ko mb ks mc kw md la me le mf li lx ly lz ma bi translated"><strong class="kn ir">服务注册和服务发现</strong>:在微服务应用中，每个服务都需要调用其他服务。为了发出请求，您的服务需要知道服务实例的网络地址。在基于云的微服务应用中，网络位置是动态分配的。因此，您的应用程序需要一种服务发现机制。另一方面，服务注册中心充当存储可用服务实例的数据库。</li><li id="6b70" class="ls lt iq kn b ko mb ks mc kw md la me le mf li lx ly lz ma bi translated"><strong class="kn ir"> Consul </strong> : Consul是我们在这个演示应用程序中用于服务注册和发现的工具。领事是<code class="fe lj lk ll lm b">CNCF(Cloud Native Computing Foundation)</code>中的一员。以后我会试着写个帖子分析一下它的源代码。</li><li id="d950" class="ls lt iq kn b ko mb ks mc kw md la me le mf li lx ly lz ma bi translated"><strong class="kn ir"> Docker-compose </strong>:是一个在Docker上运行多容器应用的工具。它允许不同的容器可以互相通信。在这篇文章中，我也将向你展示如何使用它。</li></ul><p id="8c92" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">所有的代码和配置文件都可以在这个<a class="ae mg" href="https://github.com/baoqger/service-discovery-demo" rel="noopener ugc nofollow" target="_blank"> github repo </a>中找到，请在<code class="fe lj lk ll lm b">service-discovery</code>分支查看这个帖子的演示。</p><p id="4f50" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">注:这篇文章最初发表在我的<a class="ae mg" href="https://organicprogrammer.com/2020/11/16/golang-service-discovery-consul/" rel="noopener ugc nofollow" target="_blank">个人博客</a>中，你可以在那里找到更多的技术文章。</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mh"><img src="../Images/4a779e5f4b15c3ac9d7a958378b77a03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gF1nTlYBkDjJELRj"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated"><a class="ae mg" href="https://unsplash.com/@kellysikkema?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Kelly Sikkema </a>在<a class="ae mg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="155b" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">服务注册和发现演示</h1><p id="9fed" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了解释服务注册和发现，我将运行一个简单的<code class="fe lj lk ll lm b">helloworld</code>服务器和一个每10秒钟向服务器发送请求的客户机。演示<code class="fe lj lk ll lm b">helloworld</code>服务器会在<code class="fe lj lk ll lm b">Consul</code>注册自己，这个过程就是服务注册。另一边，客户端在向服务器发送请求之前，会先向<code class="fe lj lk ll lm b">Consul</code>发送请求，找到服务器的地址。这个过程只是服务发现。好了，我们来展示一些代码。</p><figure class="mi mj mk ml gt mm"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="164f" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">上面的<code class="fe lj lk ll lm b">server.go</code>文件包含了许多代码，但是大多数都很简单，只是为了设置服务器和处理请求。</p><p id="d6df" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">有趣的部分是内部函数<code class="fe lj lk ll lm b">serviceRegistryWithConsul</code>。Consul通过配置必要的信息来提供注册服务的API。现在，我们可以关注两个字段，第一个是<code class="fe lj lk ll lm b">ID</code>,它对于每个服务都是唯一的，我们还使用它在发现过程中搜索目标服务。第二个是<code class="fe lj lk ll lm b">Check</code>，意思是<code class="fe lj lk ll lm b">health check</code>。Consul提供了这一有用的功能。在真正的微服务应用中，每个服务可能有多个实例来处理高并发时增加的请求，这被称为<code class="fe lj lk ll lm b">scalability</code>。但是有些实例可能会关闭或抛出异常，在服务发现中，我们希望过滤掉这些实例。咨询中的健康检查就是为了这个目的。我将在下一篇文章中向你展示如何做到这一点。</p><figure class="mi mj mk ml gt mm"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="da48" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">同样，在<code class="fe lj lk ll lm b">client.go</code>文件中，唯一关键的部分是<code class="fe lj lk ll lm b">serviceDiscoveryWithConsul</code>函数。基于Consul APIs，我们可以找到所有的服务。使用注册部分中设置的目标服务id(在本演示中是<code class="fe lj lk ll lm b">helloworld-server</code>)，我们可以很容易地找到地址。</p><p id="64f2" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">以上部分展示了如何在一个完整的演示中进行服务注册和发现。它大量使用了Consul APIs，我没有给出太多的解释，因为你可以在文档中找到更详细的信息。</p><p id="cec7" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">在下一节中，我将向您展示如何基于Docker和Docker-compose以云原生方式运行这个演示应用程序。</p><h1 id="1832" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">集装箱化</h1><p id="4be3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">首先，让我们为服务器创建Dockerfile，如下所示:</p><figure class="mi mj mk ml gt mm"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="034f" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">这部分很简单，如果你不明白这里使用的一些命令，请查看Docker的手册。</p><p id="e3a7" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">我将不再向客户展示docker文件，因为它与上面的几乎相同。但是你可以在这个<a class="ae mg" href="https://github.com/baoqger/service-discovery-demo" rel="noopener ugc nofollow" target="_blank"> github repo </a>里找到。</p><p id="7efd" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">现在，服务器和客户机都在容器中运行。我们还需要将Consul添加到这个应用程序中，并将这3个容器连接在一起。我们用Docker-compose来做这件事。</p><p id="64b7" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">Docker-compose由<code class="fe lj lk ll lm b">yml</code>文件驱动。在我们的例子中，情况如下:</p><figure class="mi mj mk ml gt mm"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="3733" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">关于docker-compose的用法，有几点需要提及:</p><ul class=""><li id="fc98" class="ls lt iq kn b ko ln ks lo kw lu la lv le lw li lx ly lz ma bi translated"><strong class="kn ir">网络</strong>:我们定义了一个名为<code class="fe lj lk ll lm b">my-net</code>的网络，并在所有3个服务中使用它，使它们可以相互通话。</li><li id="a1d3" class="ls lt iq kn b ko mb ks mc kw md la me le mf li lx ly lz ma bi translated"><strong class="kn ir">环境</strong>:我们可以在这个部分设置环境变量。在我们的例子中，服务器和客户机都需要向Consul发送注册和发现请求，对吗？你可以检查服务器和客户端文件，我们没有明确设置领事地址。因为Consul是以隐式的方式执行的，所以它将从名为<code class="fe lj lk ll lm b">CONSUL_HTTP_ADDR</code>的环境变量中获取值。我们用<code class="fe lj lk ll lm b">CONSUL_HTTP_ADDR=consul:8500</code>设置它。</li><li id="8ad6" class="ls lt iq kn b ko mb ks mc kw md la me le mf li lx ly lz ma bi translated"><strong class="kn ir"> docker-compose up </strong>:这是启动应用程序所需的命令。另一个有用的命令是<code class="fe lj lk ll lm b">docker-compose build</code>，它用于构建yml文件中定义的图像。当然，<code class="fe lj lk ll lm b">docker-compose down</code>可以在你想离开应用程序时停止容器。</li></ul><p id="527b" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">一切都设置好了，您可以在终端和Consul UI中验证结果，如下所示:</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mz"><img src="../Images/3230a953aaeff504ddb1ecccc5401f50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FyYCwQ0MeZsg8ADF.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">服务发现</figcaption></figure><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi na"><img src="../Images/1a96b88fbfec620016327f5085fcb8d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SZs_b_rw3BCG3dB5.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">领事-ui</figcaption></figure></div></div>    
</body>
</html>