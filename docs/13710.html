<html>
<head>
<title>Building a movies search app using Elasticsearch, Nodejs, Reactjs and IMDb API: [Part 3] Finishing the configuration of our backend</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Elasticsearch、Nodejs、Reactjs和IMDb API构建一个电影搜索应用程序:[第3部分]完成我们后端的配置</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/building-a-movies-search-app-using-elasticsearch-nodejs-reactjs-and-imdb-api-part-3-finishing-ce48f5a0be99?source=collection_archive---------4-----------------------#2022-09-29">https://levelup.gitconnected.com/building-a-movies-search-app-using-elasticsearch-nodejs-reactjs-and-imdb-api-part-3-finishing-ce48f5a0be99?source=collection_archive---------4-----------------------#2022-09-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/26a1ca9296b83c659db0e6779f8114a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UKcpy_AQVd4HmC7J0GRGfA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@lautaroandreani?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">劳塔罗·安德烈亚尼</a>在<a class="ae kc" href="https://unsplash.com/s/photos/full-stack?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="e97f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">欢迎回到使用Elasticsearch开发全栈电影搜索应用程序的系列文章😁。在前两篇文章中，我们讨论了Elasticsearch的部署部分以及规划数据存储。今天，在准备好基础之后，我们继续我们应用程序后端的实际代码，希望你们都准备好了。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/5caaea71dcd74ac5d9a38669a9aba68e.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/1*I0T8fgNx96oCsVj55spMJg.gif"/></div></figure><p id="93d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们再次回忆一下我们的应用程序的架构。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lg"><img src="../Images/afcb9442e8f553a7e0acb36b34c102f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ii1KBHGnrdtJPSp9-gZXw.png"/></div></div></figure><p id="c7b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在后端的<code class="fe lh li lj lk b">src</code>文件夹中，我们将首先添加一个包含环境变量的文件。与第一部分类似，创建一个<code class="fe lh li lj lk b">.env</code>文件，并填写通过创建IMDb帐户获得的<strong class="kf ir"> API密钥</strong>。为了将所有东西归入同一个文件，我们还添加了一个<code class="fe lh li lj lk b">IMDB_URL</code>变量。您可以自由选择您的API，只需注意返回文档的结构以及字段的名称。让我们不要忘记提及我们的应用程序将被部署的端口以及Elasticsearch的登录凭证。该文件将如下所示:</p><pre class="lc ld le lf gt ll lk lm ln aw lo bi"><span id="2c2a" class="lp lq iq lk b gy lr ls l lt lu">PORT = 3001<br/>ELASTICSEARCH_CLIENT = elastic<br/>ELASTICSEARCH_PASSWORD = TYPE_HERE </span><span id="38d4" class="lp lq iq lk b gy lv ls l lt lu">IMDb API KEYAPI_KEY = TYPE_HERE<br/>IMDB_URL = <a class="ae kc" href="https://imdb-api.com/en/API/InTheaters" rel="noopener ugc nofollow" target="_blank">https://imdb-api.com/en/API/InTheaters</a></span></pre><p id="58ec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，为了将我们的后端连接到Elasticsearch，我们使用JavaScript客户端。在<code class="fe lh li lj lk b">src</code>文件夹中，创建一个名为<code class="fe lh li lj lk b">elasticsearch</code>的a文件夹，并将下面的<code class="fe lh li lj lk b">client.js</code>文件放在那里:</p><pre class="lc ld le lf gt ll lk lm ln aw lo bi"><span id="d66c" class="lp lq iq lk b gy lr ls l lt lu">const fs = require("fs");<br/>const { Client } = require("@elastic/elasticsearch");<br/>const client = new Client({<br/>  node: "https://localhost:9200",<br/>  auth: {<br/>    username: process.env.ELASTICSEARCH_CLIENT,<br/>    password: process.env.ELASTICSEARCH_PASSWORD,<br/>  },<br/>  tls: {<br/>    ca: fs.readFileSync("./certs/ca/ca.crt"),<br/>    rejectUnauthorized: false,<br/>  },<br/>});<br/><br/>client<br/>  .ping()<br/>  .then((response) =&gt; console.log("Connected to Elasticsearch"))<br/>  .catch((error) =&gt; console.log(error));<br/><br/>module.exports = client;</span></pre><p id="5060" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里没有什么非常复杂的，我们只是通过指定<code class="fe lh li lj lk b">tls</code>对象来配置到我们的Elasticsearch安全部署的连接，这当然要感谢我们之前从Elasticsearch容器中复制的<code class="fe lh li lj lk b">ca.crt</code>文件。您可以通过点击<a class="ae kc" href="https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/client-connecting.html#auth-tls" rel="noopener ugc nofollow" target="_blank">此链接</a>获得关于该主题的更多信息。</p><p id="3d0d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仍然在后端文件夹中，创建另一个文件夹<code class="fe lh li lj lk b">data</code>，在这里我们将配置一个<code class="fe lh li lj lk b">moviesRouter</code>，它将负责从IMDb检索数据，并在Elasticsearch上索引它，现在连接已经建立。我们的<code class="fe lh li lj lk b">movie_api.js</code>文件看起来像这样:</p><pre class="lc ld le lf gt ll lk lm ln aw lo bi"><span id="ffa7" class="lp lq iq lk b gy lr ls l lt lu">const express = require('express')<br/>const axios = require('axios')<br/>const client = require('../elasticsearch/client')<br/><br/>const moviesRouter = express.Router()<br/><br/>moviesRouter.get('/', async (request, response) =&gt; {<br/>  response.json('Retrieving in theaters movies ...')<br/>  try {<br/>    console.log('Processing ...')<br/><br/>    const movies = await axios.get(<br/>      `${process.env.IMDB_URL}/${process.env.API_KEY}`<br/>    )<br/><br/>    console.log('Data retrieved successfuly')<br/><br/>    const results = movies.data.items<br/><br/>    console.log('Starting data indexation ...')<br/><br/>    results.map(async (result) =&gt; {<br/>      await client.index({<br/>        index: 'movies',<br/>        id: result.id,<br/>        body: result,<br/>        pipeline: 'movies_pipeline',<br/>      })<br/>    })<br/><br/>    console.log('Data has been indexed')<br/>  } catch (error) {<br/>    console.log(error)<br/>  }<br/>})<br/><br/>module.exports = moviesRouter</span></pre><p id="4e77" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦使用<strong class="kf ir"> axios </strong>检索到数据，我们就应用一个循环来索引Elasticsearch上的每个文档，当然是通过我们在<a class="ae kc" href="https://medium.com/@mhdabdel151/building-a-movies-search-app-using-elasticsearch-nodejs-reactjs-and-imdb-api-part-2-initiating-394796e4ecbc" rel="noopener">第2部分</a>中创建的管道，如果您还没有读过，我邀请您阅读。</p><p id="72d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">控制台日志是查看应用程序运行情况的好方法。如果发生撞车事故💢，您将直接知道失败的步骤，并可以轻松地解除问题。</p><p id="b149" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在一切都配置好了，我们只需要修改后端文件夹根目录下的<code class="fe lh li lj lk b">index.js</code>文件，如下所示:</p><pre class="lc ld le lf gt ll lk lm ln aw lo bi"><span id="d0e7" class="lp lq iq lk b gy lr ls l lt lu">require('dotenv').config()<br/>const express = require('express')<br/>const client = require('./elasticsearch/client')<br/>const moviesRouter = require('./data/movie_api')<br/>const cors = require('cors')<br/><br/>const app = express()<br/><br/>app.use('/ingest_movies', moviesRouter)<br/>app.use(cors())<br/><br/>app.get('/all', async (request, response) =&gt; {<br/>  const body = await client.search({<br/>    index: 'movies',<br/>    body: {<br/>      size: 100,<br/>    },<br/>  })<br/>  response.json(body.hits.hits)<br/>})<br/><br/>app.get('/api/movies', async (request, response) =&gt; {<br/>  const body = await client.search({<br/>    index: 'movies',<br/>    body: {<br/>      sort: [<br/>        {<br/>          imDbRating: {<br/>            order: request.query.order,<br/>          },<br/>        },<br/>      ],<br/>      query: {<br/>        bool: {<br/>          must: [<br/>            {<br/>              terms: {<br/>                genres: request.query.genres,<br/>              },<br/>            },<br/>            {<br/>              match: {<br/>                title: request.query.title,<br/>              },<br/>            },<br/>          ],<br/>        },<br/>      },<br/>    },<br/>  })<br/>  response.json(body.hits.hits)<br/>})<br/><br/>app.listen(process.env.PORT, () =&gt; {<br/>  console.log(`Server running on port ${process.env.PORT}`)<br/>})</span></pre><p id="b76e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这里，我们首先提到，对于数据索引来说，到<code class="fe lh li lj lk b">/ingest_movies</code>端点就足够了。<code class="fe lh li lj lk b">/all </code>检索所有已被索引的电影，最后，我们将基于过滤器的搜索选项与<code class="fe lh li lj lk b">/api/movies</code>端点相关联。如果你觉得合适的话，可以随意更改名字，你只需要在实现前端的时候小心一点。</p><p id="2b05" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为我们已经知道了文档的结构，所以我们可以很容易地为搜索选项选择过滤器。在这里，我们可以按<code class="fe lh li lj lk b">imDbRating</code>和<code class="fe lh li lj lk b">genres</code>对结果进行排序，并在<code class="fe lh li lj lk b">title</code>字段进行搜索。至此，与Elasticsearch的连接已经配置完毕，数据索引也已完成，您所要做的就是使用以下命令启动后端:</p><pre class="lc ld le lf gt ll lk lm ln aw lo bi"><span id="fb75" class="lp lq iq lk b gy lr ls l lt lu">yarn run dev</span></pre><p id="7196" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您在控制台中有“<em class="lw">连接到Elasticsearch </em>”，很好，否则请查找并修复错误。现在转到<a class="ae kc" href="http://localhost:3001/ingest_movies" rel="noopener ugc nofollow" target="_blank">http://localhost:3001/ingest _ movies</a>来检索电影并对其进行索引。您仍然可以在<strong class="kf ir"> Discover </strong>部分查看Kibana上的数据。</p><p id="e07d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这部分到此为止。您可以通过以下链接访问包含应用程序代码的GitHub repo:</p><div class="lx ly gp gr lz ma"><a href="https://github.com/AbdoulBaguiM/movies-search" rel="noopener  ugc nofollow" target="_blank"><div class="mb ab fo"><div class="mc ab md cl cj me"><h2 class="bd ir gy z fp mf fr fs mg fu fw ip bi translated">GitHub-AbdoulBaguiM/movies-search:用Reactjs、Nodejs和…</h2><div class="mh l"><h3 class="bd b gy z fp mf fr fs mg fu fw dk translated">用Reactjs、Nodejs和Elasticsearch构建的全栈搜索应用程序-GitHub-AbdoulBaguiM/movies-search…</h3></div><div class="mi l"><p class="bd b dl z fp mf fr fs mg fu fw dk translated">github.com</p></div></div><div class="mj l"><div class="mk l ml mm mn mj mo jw ma"/></div></div></a></div><p id="e574" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢您的阅读，如果您对本文有任何问题或评论，请在下面留下您的评论。</p><p id="799b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于使用React构建应用前端的下一部分即将到来，敬请关注🚀。</p><p id="3069" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">阿卜杜尔-巴吉</p></div></div>    
</body>
</html>