<html>
<head>
<title>Multi-stage Docker Builds in Golang with Go Modules</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Go模块在Golang中构建多级Docker</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/multi-stage-docker-builds-with-go-modules-df23b7f91a67?source=collection_archive---------1-----------------------#2019-02-07">https://levelup.gitconnected.com/multi-stage-docker-builds-with-go-modules-df23b7f91a67?source=collection_archive---------1-----------------------#2019-02-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3fcf" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个关于使用Go模块构建多阶段Docker的教程，以及如何将Docker图像大小减少数百兆字节</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/99672cfcebb94a665115794b461f908e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HeYkLXfPu1uA-xFuW2n5zA.png"/></div></div></figure><p id="e1c2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在本文中，我将向您快速演示如何为使用Go模块的Go应用程序创建较小的Docker映像。您可以在这个<a class="ae ln" href="https://github.com/Niraj-Fonseka/MultiStageDocker" rel="noopener ugc nofollow" target="_blank">资源库</a>中找到本文的所有代码。</p><p id="49b6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在一个传统的Docker构建的Go应用程序中，使用<a class="ae ln" href="https://hub.docker.com/_/golang" rel="noopener ugc nofollow" target="_blank"> Golang </a>图像是很常见的。虽然这很好，但由于Golang图像本身的大小，这些图像往往会非常大。让我们看一个例子，看看我们如何可以减少我们的图像大小数百兆字节。</p><blockquote class="lo lp lq"><p id="bee7" class="kr ks lr kt b ku kv jr kw kx ky ju kz ls lb lc ld lt lf lg lh lu lj lk ll lm ij bi translated">在我的例子中，我将使用Go模块进行依赖性管理。如果你对围棋模块不熟悉，可以看看我以前写的关于<a class="ae ln" href="https://medium.com/@fonseka.live/getting-started-with-go-modules-b3dac652066d" rel="noopener">围棋模块</a>的文章。</p></blockquote><p id="c6d0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们考虑这是我们想要dockerize的应用程序。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="7871" class="ma mb iq lw b gy mc md l me mf">package main<br/><br/>import (<br/>	"fmt"<br/><br/>	randomdata "github.com/Pallinder/go-randomdata"<br/>)<br/><br/>func main() {<br/>	fmt.Println("Running the TestApp")<br/>	fmt.Println(randomdata.SillyName())<br/>}</span></pre><p id="2840" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是我们的文档:</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="334f" class="ma mb iq lw b gy mc md l me mf">FROM golang:1.11.0-stretch <br/><br/>COPY . /SingleStage <br/>WORKDIR /SingleStage<br/><br/>ENV GO111MODULE=on<br/><br/>RUN CGO_ENABLED=0 GOOS=linux go build -o SingleStage <br/><br/>CMD ["./SingleStage"]</span></pre><p id="4ecf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如您所见，我们使用<code class="fe mg mh mi lw b">golang:1.11</code>图像作为基础图像来构建我们的应用程序，并且在构建中没有使用<code class="fe mg mh mi lw b">GOPATH</code>。那是因为Go 1.11允许你在<code class="fe mg mh mi lw b">GOPATH</code>之外构建应用。</p><p id="dc3a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在让我们来构建应用程序。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="d3cf" class="ma mb iq lw b gy mc md l me mf">docker build -t singlestagebuild .</span></pre><p id="96f1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果我们运行docker images命令并查看图像的大小，我们可以看到，即使是这样一个非常简单的应用程序，大小也接近800MB。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mj"><img src="../Images/490ac5b422f7eb66e44634f8ea7ac711.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5H1BS-UAGCRVOomOrrKGLg.png"/></div></div></figure><p id="9c04" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在让我们看看如何使用多阶段Docker构建来减小图像的大小。在这次演示中，我仍然会使用以前的Go应用程序。</p><p id="23c5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是我们的新文档。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="f75d" class="ma mb iq lw b gy mc md l me mf">#first stage - builder</span><span id="5d74" class="ma mb iq lw b gy mk md l me mf">FROM golang:1.11.0-stretch as builder</span><span id="1c06" class="ma mb iq lw b gy mk md l me mf">COPY . /MultiStage</span><span id="6b19" class="ma mb iq lw b gy mk md l me mf">WORKDIR /MultiStage</span><span id="f63d" class="ma mb iq lw b gy mk md l me mf">ENV GO111MODULE=on</span><span id="77c3" class="ma mb iq lw b gy mk md l me mf">RUN CGO_ENABLED=0 GOOS=linux go build -o MultiStage</span><span id="fe80" class="ma mb iq lw b gy mk md l me mf">#second stage</span><span id="d488" class="ma mb iq lw b gy mk md l me mf">FROM alpine:latest</span><span id="ba29" class="ma mb iq lw b gy mk md l me mf">WORKDIR /root/</span><span id="064b" class="ma mb iq lw b gy mk md l me mf">COPY --from=builder /MultiStage .</span><span id="54e7" class="ma mb iq lw b gy mk md l me mf">CMD ["./Multistage"]</span></pre><p id="8469" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在第一阶段，我们使用的图像与第一个例子中使用的图像相同。唯一的不同是，我没有使用<code class="fe mg mh mi lw b">CMD [“./Multistage”]</code>，而是使用阿尔卑斯山图像启动第二阶段，并将工作目录设置为<code class="fe mg mh mi lw b">/root/</code>。然后，我将所有内容从<code class="fe mg mh mi lw b">/MultiStage</code>目录复制到我们的构建器映像中(多级的二进制文件也在这里)。</p><p id="6df8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们来搭建一下，看看自己的形象有多大。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="5db4" class="ma mb iq lw b gy mc md l me mf">docker build -t multistage .</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ml"><img src="../Images/c517009a5b5f1d3a010189b971e2088b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sjxeDlCW8fXwkRRZhm8xCA.png"/></div></div></figure><p id="0dba" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们走吧！从781MB减少到8.15MB是一个巨大的大小差异。</p><p id="9ecc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们用作第二阶段的Alpine映像是一个极其轻量级的Linux发行版。所以您必须小心，因为您需要确保您的任何Go库没有使用任何不包含在Alpine映像中的Linux内部库/文件，如果使用了，您必须手动添加它们。让我们来看另一个例子，看看它是如何工作的。</p><p id="bddc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这个例子中，我们试图通过使用时间包中的<code class="fe mg mh mi lw b">LoadLocation()</code>函数来获得柏林的时间。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="c79d" class="ma mb iq lw b gy mc md l me mf">package main<br/><br/>import (<br/>	"fmt"<br/>	"time"<br/>)<br/><br/>func main() {<br/><br/>	location, err := time.LoadLocation("Europe/Berlin")<br/>	if err != nil {<br/>		fmt.Println(err)<br/>	}<br/><br/>	t := time.Now().In(location)<br/><br/>	fmt.Println("Time in Berlin:", t.Format("02.01.2006 15:04"))<br/>}</span></pre><p id="ec04" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在让我们对它进行分类并运行它。</p><p id="d41b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe mg mh mi lw b">docker build -t loadlocation .</code></p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="60e4" class="ma mb iq lw b gy mc md l me mf">docker run loadlocation</span></pre><p id="13d0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">啊哦…</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mm"><img src="../Images/4a49449d63705d2c664b636c4dae8689.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UHmtnDym8eZOGrpMtnhs4Q.png"/></div></div></figure><p id="0f53" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">每当我们调用时间包中的<code class="fe mg mh mi lw b">LoadLocation()</code>函数时，它就会寻找“时区数据库”(<code class="fe mg mh mi lw b">zoneinfo.zip</code>)，该数据库维护着来自世界各地的时区信息列表。由于alpine图像没有这个文件，我们必须手动将它注入到图像中。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="c645" class="ma mb iq lw b gy mc md l me mf">RUN apk add --no-cache tzdata</span></pre><p id="07e2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可能还需要将CA根证书注入到Alpine映像中。你可以通过使用<code class="fe mg mh mi lw b">apk</code>来实现。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="4457" class="ma mb iq lw b gy mc md l me mf">RUN apk --update add ca-certificates</span></pre><p id="1aa5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">或者从构建器映像复制<code class="fe mg mh mi lw b">ca-certs</code>(第一阶段)</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="3816" class="ma mb iq lw b gy mc md l me mf">COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/</span></pre><p id="c431" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们来看最后的<code class="fe mg mh mi lw b">Dockerfile</code>。</p><pre class="kg kh ki kj gt lv lw lx ly aw lz bi"><span id="1310" class="ma mb iq lw b gy mc md l me mf">#first stage - builder</span><span id="90a5" class="ma mb iq lw b gy mk md l me mf">FROM golang:1.11.0-stretch as builder</span><span id="c2dd" class="ma mb iq lw b gy mk md l me mf">COPY . /LoadLocation</span><span id="1438" class="ma mb iq lw b gy mk md l me mf">WORKDIR /LoadLocation</span><span id="46a9" class="ma mb iq lw b gy mk md l me mf">ENV GO111MODULE=on</span><span id="fbbc" class="ma mb iq lw b gy mk md l me mf">RUN CGO_ENABLED=0 GOOS=linux go build -o LoadLocation</span><span id="7931" class="ma mb iq lw b gy mk md l me mf">#second stage</span><span id="b6da" class="ma mb iq lw b gy mk md l me mf">FROM alpine:latest</span><span id="711f" class="ma mb iq lw b gy mk md l me mf">WORKDIR /root/</span><span id="0aff" class="ma mb iq lw b gy mk md l me mf">RUN apk add --no-cache tzdata</span><span id="49de" class="ma mb iq lw b gy mk md l me mf">COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/</span><span id="9f01" class="ma mb iq lw b gy mk md l me mf">COPY --from=builder /LoadLocation .</span><span id="4196" class="ma mb iq lw b gy mk md l me mf">CMD ["./LoadLocation"]</span></pre><p id="5727" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最后，让我们构建并运行映像。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mn"><img src="../Images/cca2be9e3625f24cc30fb053e16b36cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C9hLHCVcXKJUn02zSGLQHg.png"/></div></div></figure><p id="16fe" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">完美！</p><p id="199b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我希望这篇文章能帮助你优化docker构建，创建更安全(减少攻击面)、更小(8.15MB对781MB)和更干净的映像。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/9914c5dd23ac08b70eea6f4f9ba6fed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E6CoI_MRyZ1JInNPsBSHtA.png"/></div></div></figure><div class="mw mx gp gr my mz"><a href="https://gitconnected.com/learn/docker" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd ir gy z fp ne fr fs nf fu fw ip bi translated">学习Docker -最佳Docker教程(2019) | gitconnected</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">31大Docker教程-免费学习Docker。课程由开发人员提交并投票，使您能够…</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">gitconnected.com</p></div></div><div class="ni l"><div class="nj l nk nl nm ni nn kp mz"/></div></div></a></div><div class="mw mx gp gr my mz"><a href="https://gitconnected.com/learn/golang" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd ir gy z fp ne fr fs nf fu fw ip bi translated">学习围棋-最佳围棋教程(2019) | gitconnected</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">23大围棋教程-免费学习围棋。课程由开发者提交和投票，使您能够找到…</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">gitconnected.com</p></div></div><div class="ni l"><div class="no l nk nl nm ni nn kp mz"/></div></div></a></div></div></div>    
</body>
</html>