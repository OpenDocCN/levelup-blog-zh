# ä½¿ç”¨ SQL çš„çª—å£å‡½æ•°

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/working-with-sqls-window-functions-c70a2c308e9b>

S QL å¯¹äºè½¯ä»¶å·¥ç¨‹å¸ˆæ¥è¯´æ˜¯ä¸€é¡¹è‡³å…³é‡è¦çš„æŠ€èƒ½ï¼Œæ— è®ºæ˜¯æ•°æ®ç§‘å­¦å®¶ã€æ•°æ®å·¥ç¨‹å¸ˆè¿˜æ˜¯å…¶ä»–ä»»ä½•äººã€‚åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†è®²è¿°å¦‚ä½•ä½¿ç”¨ SQL çš„çª—å£å‡½æ•°ã€‚

![](img/6b7e022b6d59863c29789288e62807ce.png)

åŠ³æ‹‰Â·å…‹è±å¤«æ›¼åœ¨ [Unsplash](https://unsplash.com/s/photos/windows?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) ä¸Šçš„ç…§ç‰‡

# çª—å£åŠŸèƒ½:

çª—å£å‡½æ•°â€”â€”è¿™ä¸ªåå­—å¯èƒ½ä¼šå“åˆ°ä½ ï¼Œä½†ä½ ä¸éœ€è¦æ‹…å¿ƒã€‚çª—å£å‡½æ•°æ˜¯å¤„ç†ä¸€ç»„è¡Œè€Œä¸æ˜¯å•ä¸ªè¡Œçš„å‡½æ•°ã€‚â€œçª—å£åŠŸèƒ½â€ä¸­çš„â€œçª—å£â€æ˜¯æŒ‡ä¸€ç»„è¡Œã€‚

å®ƒä»¬å¯ä»¥ç”¨äºè®¸å¤šä¸åŒçš„äº‹æƒ…ï¼Œå…¶ä¸­ä¸€ä¸ªä¾‹å­å°±æ˜¯æ‰§è¡Œèšåˆã€‚é€šå¸¸ï¼Œå½“æˆ‘ä»¬èšåˆæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æŒ‰éèšåˆåˆ—è¿›è¡Œåˆ†ç»„ï¼Œå¦åˆ™ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªé”™è¯¯ã€‚å½“ä½¿ç”¨çª—å£å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ‹…å¿ƒè¿™ä¸ªã€‚

ç°åœ¨æ¥çœ‹è¯­æ³•ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨ **OVER()** æ¥å®šä¹‰ä¸€ä¸ªçª—å£å‡½æ•°ã€‚

## è¯­æ³•:

`function() OVER(...) AS alias`

ä¸Šè¿°è¯­æ³•å¯ä»¥è§£é‡Šå¦‚ä¸‹:

> ä¸€ä¸ªå‡½æ•°è¢«åº”ç”¨åˆ°ä¸€ä¸ªçª—å£ä¸Šã€‚

ç°åœ¨ä¸¾ä¸ªä¾‹å­ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª**åŒ¹é…**è¡¨ã€‚æˆ‘ä»¬æƒ³åšçš„æ˜¯æ‰¾å‡º*â€œæ¯åœºæ¯”èµ›è¿›äº†å¤šå°‘çƒï¼Œä¸ 2011/2012 èµ›å­£çš„æ€»ä½“å¹³å‡æ°´å¹³ç›¸æ¯”å¦‚ä½•â€*

è¯¥æŸ¥è¯¢å¦‚ä¸‹æ‰€ç¤º:

```
SELECT date, 
       (home_goals + away_goals) AS goals, 
        AVG(home_goals + away_goals) OVER() AS overall_avg
FROM match
WHERE season = '2011/2012';
```

åœ¨ä¸Šé¢çš„æŸ¥è¯¢ä¸­ï¼Œ *home_goals* è¡¨ç¤ºä¸»é˜Ÿè¿›çƒï¼Œè€Œ *away_goals* è¡¨ç¤ºå®¢é˜Ÿè¿›çƒï¼Œå¦‚æœæ‚¨å‘ç°æˆ‘ä»¬æ²¡æœ‰æŒ‰æ—¥æœŸåˆ†ç»„ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†çª—å£å‡½æ•°ã€‚

# ç”Ÿæˆç­‰çº§:

é¡¾åæ€ä¹‰å®ƒä¼šç”Ÿæˆä¸€ä¸ª**ç­‰çº§**ã€‚ä½†æ˜¯æˆ‘ä»¬å°†åœ¨ **OVER()** ä¸­æ·»åŠ ä¸€ä¸ª **ORDER BY** å­å¥ã€‚å¦‚æœä¸¤ä¸ªå€¼ç›¸åŒï¼Œé‚£ä¹ˆå®ƒå°†è¿™äº›å€¼ç»‘å®šåœ¨ä¸€èµ·ï¼Œå¹¶è·³è¿‡ç­‰çº§ä¸­çš„ä¸‹ä¸€ä¸ªå€¼(å½“æ‚¨çœ‹ä¸€çœ‹è¿™ä¸ªç¤ºä¾‹æ—¶ï¼Œæ‚¨å°±æ˜ç™½äº†)ã€‚

**ä¾‹å¦‚:**

ä½¿ç”¨ç›¸åŒçš„æ¯”èµ›è¡¨æ ¼ï¼Œæˆ‘ä»¬å°†å¯¹æ€»è¿›çƒæ•°è¿›è¡Œæ’åã€‚

```
SELECT date,
       (home_goal + away_goal) AS goals,
       RANK() OVER(ORDER BY home_goal + away_goal) AS goal_rank
FROM match
WHERE season = '2011/2012';
```

ä¸Šé¢çš„ç»“æœä¼šæ˜¯è¿™æ ·çš„:

```
Goals    goal_rank
 10         1
 10         1
 10         1
 10         1
  9         5
  8         6
  8         6
  7         8
```

å¦‚æ‚¨æ‰€è§ï¼Œå¦‚æœç›®æ ‡æ˜¯ç›¸åŒçš„ï¼Œå®ƒä»¬éƒ½å¾—åˆ°äº†ç›¸åŒçš„å€¼ï¼Œä½†å½“æ¶‰åŠåˆ°ä¸‹ä¸€ä¸ªç›®æ ‡æ—¶ï¼Œå®ƒä¼šç›´æ¥è·³åˆ°ä¸‹ä¸€ä¸ªè®¡æ•°çº§åˆ«(å¦‚ 1 é‡å¤ 4 æ¬¡ï¼Œæ‰€ä»¥ä¸‹ä¸€ä¸ªæ˜¯ 5)ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡åœ¨ **ORDER BY ä¸­çš„åˆ—ååæåˆ° **DESC** æ¥æŒ‰é™åºæ’åˆ—ã€‚**

å¦‚æœä½ æƒ³é¿å…è·³è¿‡ç­‰çº§ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨ **DENSE_RANK()** ï¼Œå®ƒå’Œ RANK ä¸€æ ·ï¼Œåªæ˜¯ä¸è·³è¿‡ç­‰çº§ã€‚é™¤äº† **ORDER BY ä¹‹å¤–ï¼Œåœ¨æŸ¥è¯¢çš„æ¯ä¸ªéƒ¨åˆ†ä¹‹åéƒ½å¤„ç† **RANK()** å‡½æ•°ã€‚**è¿™æ„å‘³ç€å®ƒä½¿ç”¨ç»“æœä¸­çš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯è¡¨æ ¼ä¸­çš„ä¿¡æ¯ã€‚

# åˆ†åŒº:

å‡è®¾æ‚¨æƒ³è¦è®¡ç®—æ¯ä¸ªå­£èŠ‚çš„ AVG()ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥åœ¨ **OVER()ä¸­ä½¿ç”¨ **PARTITION BY** å­å¥ã€‚**

çœ‹ä¸€ä¸‹è¿™ä¸ªä¾‹å­ã€‚"æ¯åœºæ¯”èµ›è¿›äº†å¤šå°‘ä¸ªçƒï¼Œä¸èµ›å­£å¹³å‡æ°´å¹³ç›¸æ¯”å¦‚ä½•ï¼Ÿ"

```
SELECT date,
       (home_goal+away_goal) AS goals,
        AVG(home_goals+away_goal) OVER(PARTITION BY season) AS                  season_avg
FROM match;
```

ä¸Šé¢çš„æŸ¥è¯¢è¿”å›ä¸€ä¸ªè¡¨ï¼Œå…¶ä¸­åŒ…å«æ¯åœºæ¯”èµ›çš„è¿›çƒä»¥åŠèµ›å­£å¹³å‡å€¼ã€‚

```
date  goals   season_avg
2010   4         4.55
2010   5         4.55
2010   1         4.55
2011   3         6.55
2011   6         6.55
2011   2         6.55
```

ç»“æœå¯èƒ½æ˜¯è¿™æ ·çš„ã€‚ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç”¨å¤šåˆ—å¯¹ T10 è¿›è¡Œåˆ†åŒºï¼Œæˆ‘ä»¬å¯ä»¥ç”¨â€œï¼Œâ€æ¥åˆ†éš”åˆ—ã€‚

# æ»‘åŠ¨çª—å£:

å®ƒæ˜¯ä¸€ç§çª—å£åŠŸèƒ½ï¼ŒåŸºæœ¬ä¸Šæ˜¯åŸºäºæ—¶é—´æˆ–åŸºäºè¡Œçš„çª—å£ã€‚æ‚¨å¯ä»¥å¯¹ç»™å®šçš„ä¸€ç»„è¡Œè¿›è¡Œåˆ†æã€‚

è¿™ä¹Ÿä½¿ç”¨äº† **OVER()** ï¼Œä½†å”¯ä¸€é¢å¤–çš„æ˜¯å®ƒä½¿ç”¨äº†ä»¥ä¸‹å†…å®¹:

> <start>å’Œ<finish>ä¹‹é—´çš„è¡Œ</finish></start>

æˆ‘ä»¬ç”¨ä¸€äº›å…³é”®å­—ä»£æ›¿å¼€å§‹å’Œç»“æŸã€‚è¿™äº›å…³é”®è¯æ˜¯:

*   å‰ä¸€è¡Œâ€”å½“å‰è¡Œä¹‹å‰çš„è¡Œã€‚
*   åç»­â€”å½“å‰è¡Œä¹‹åçš„è¡Œã€‚
*   æœªç»‘å®šçš„å‰ä¸€è¡Œâ€”æ»‘åŠ¨åˆ°å½“å‰è¡Œä¹‹å‰çš„è¾¹ç¼˜ã€‚
*   æ— ç•Œè·Ÿéšâ€”æ»‘åŠ¨åˆ°å½“å‰è¡Œä¹‹åçš„è¾¹ç¼˜è¡Œ
*   å½“å‰è¡Œâ€”æŒ‡å½“å‰è¡Œã€‚

ç°åœ¨æˆ‘å°†å‘æ‚¨å±•ç¤ºä¸€ä¸ªæŸ¥è¯¢ï¼Œè®©æˆ‘çŸ¥é“å®ƒåœ¨è¯„è®ºéƒ¨åˆ†åšä»€ä¹ˆã€‚

```
SELECT date,
       home_goal,
       away_goal,
       SUM(home_goal) 
            OVER( ORDER BY date ROWS BETWEEN UNBOUNDED  PRECEDING AND CURRENT ROW) AS running_total
FROM match
WHERE hometeam_id = 8456 AND season = '2011/2012';
```

è®©æˆ‘çŸ¥é“ä½ çš„ç­”æ¡ˆã€‚åœ¨è¯„è®ºåŒºäº’ç›¸å¸®åŠ©ã€‚

# ç»“è®º:

åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘ä»¬çœ‹äº†çœ‹:

*   ä»€ä¹ˆæ˜¯çª—å£å‡½æ•°ï¼Ÿ
*   å¦‚ä½•ä¸ä»–ä»¬åˆä½œï¼Ÿ
*   å¦‚ä½•æ’åï¼Ÿ
*   å¦‚ä½•åˆ’åˆ†ç»“æœï¼Ÿ
*   ä»€ä¹ˆæ˜¯æ¨æ‹‰çª—ï¼Ÿ

æˆ‘å¸Œæœ›è¿™ç¯‡åšå®¢å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚åœ¨ LinkedIn ä¸Šå…³æ³¨æˆ‘ã€‚å¦‚æœä½ å–œæ¬¢æˆ‘çš„ä½œå“ï¼Œé‚£å°±è¯·æˆ‘å–æ¯å’–å•¡: ***dataguy6@ybl***

å¦å¤–ï¼Œçœ‹çœ‹æˆ‘æœ€è¿‘çš„ä½œå“:

[](https://medium.datadriveninvestor.com/perfect-roadmap-to-becoming-a-devops-engineer-along-with-resources-d2285dd2bfb3) [## æˆä¸º DevOps å·¥ç¨‹å¸ˆçš„å®Œç¾è·¯çº¿å›¾ä»¥åŠèµ„æº

### å¯¹ SRE/äº‘å·¥ç¨‹ä¹Ÿå¾ˆæœ‰ç”¨

medium.datadriveninvestor.com](https://medium.datadriveninvestor.com/perfect-roadmap-to-becoming-a-devops-engineer-along-with-resources-d2285dd2bfb3) [](https://medium.datadriveninvestor.com/roadmap-to-becoming-a-game-developer-in-2022-128fed2df6c5) [## 2022 å¹´æˆä¸ºæ¸¸æˆå¼€å‘è€…çš„è·¯çº¿å›¾

### å¦‚ä½•æˆä¸ºä¸€åæ¸¸æˆå¼€å‘è€…

medium.datadriveninvestor.com](https://medium.datadriveninvestor.com/roadmap-to-becoming-a-game-developer-in-2022-128fed2df6c5) 

# åˆ†çº§ç¼–ç 

æ„Ÿè°¢æ‚¨æˆä¸ºæˆ‘ä»¬ç¤¾åŒºçš„ä¸€å‘˜ï¼æ›´å¤šå†…å®¹è§[çº§ç¼–ç å‡ºç‰ˆç‰©](https://levelup.gitconnected.com/)ã€‚
è·Ÿéš: [Twitter](https://twitter.com/gitconnected) ï¼Œ [LinkedIn](https://www.linkedin.com/company/gitconnected) ï¼Œ[è¿…](https://newsletter.levelup.dev/)
å‡ä¸€çº§å°±æ˜¯è½¬å‹ç§‘æŠ€æ‹›è˜ğŸ‘‰ [**åŠ å…¥æˆ‘ä»¬çš„äººæ‰é›†ä½“**](https://jobs.levelup.dev/talent/welcome?referral=true)