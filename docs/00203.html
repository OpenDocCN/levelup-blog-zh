<html>
<head>
<title>Solidity Smart Contract Anatomy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可靠智能合同剖析</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/solidity-smart-contract-anatomy-fb8bfb72e7ec?source=collection_archive---------1-----------------------#2018-09-03">https://levelup.gitconnected.com/solidity-smart-contract-anatomy-fb8bfb72e7ec?source=collection_archive---------1-----------------------#2018-09-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/a856497ff83ef10a1eabdbc829e05328.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*W_dbcgwju6wDdPUp"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kf" href="https://unsplash.com/@richtervet?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Rich Tervet </a>的“灰色笔记本电脑开机”</figcaption></figure><p id="efd5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">今天我就来给大家讲解一个样本的解剖<a class="ae kf" href="https://solidity.readthedocs.io/en/v0.4.24/" rel="noopener ugc nofollow" target="_blank">坚固度</a> <a class="ae kf" href="https://en.wikipedia.org/wiki/Smart_contract" rel="noopener ugc nofollow" target="_blank">智能合约</a>。这篇文章将是一个简短的指南，所以你可以得到一个概念，在一个坚实的合同中使用了什么，没有深入的东西。我的代码并不完美！所以如果你发现了什么或者有问题，请联系我。</p><p id="d746" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">什么是<strong class="ki iu"> <em class="le">坚固度</em> </strong>:</p><blockquote class="lf lg lh"><p id="6848" class="kg kh le ki b kj kk kl km kn ko kp kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated">“Solidity是一种面向契约的高级语言，用于实现智能契约。它受到了C++、Python和JavaScript的影响，旨在针对以太坊虚拟机(EVM)。”</p></blockquote><p id="b81f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该示例合同名为“<strong class="ki iu"><em class="le">freelancer . sol</em></strong>”，其想法是自由职业者可以<strong class="ki iu">设置:</strong></p><ul class=""><li id="b915" class="ll lm it ki b kj kk kn ko kr ln kv lo kz lp ld lq lr ls lt bi translated">拥有数据</li><li id="9c00" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">拥有资产</li></ul><p id="e73c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">自由职业者可以<strong class="ki iu">获得:</strong></p><ul class=""><li id="ada1" class="ll lm it ki b kj kk kn ko kr ln kv lo kz lp ld lq lr ls lt bi translated">一看自己的账户数据。</li></ul><p id="96a5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一个自由职业者<strong class="ki iu">有:</strong></p><ul class=""><li id="69b3" class="ll lm it ki b kj kk kn ko kr ln kv lo kz lp ld lq lr ls lt bi translated">一个名字</li><li id="4962" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">姓氏</li><li id="bf69" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">大量的“硬币”</li><li id="eac0" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">一笔“现金”</li><li id="a46a" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">并提供“服务”</li></ul><h2 id="2b91" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated"><a class="ae kf" href="https://solidity.readthedocs.io/en/v0.4.21/layout-of-source-files.html#version-pragma" rel="noopener ugc nofollow" target="_blank">版本</a></h2><p id="43f7" class="pw-post-body-paragraph kg kh it ki b kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">一个实性契约总是以<strong class="ki iu"> <em class="le"> pragma实性【版本】开头；</em> </strong></p><p id="a637" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">目前最新版本是我们在本合同中使用的<strong class="ki iu"> <em class="le"> 0.4.24 </em> </strong>。避免在版本号前设置插入符号(^ ),因为这会自动将您的合同更新到最新版本，这可能会破坏合同。在这个例子中，我们使用了两个<strong class="ki iu"> <em class="le">实验版</em> </strong>版本。这些是可选的。通过设置<strong class="ki iu"> <em class="le"> pragma实验“v 0 . 5 . 0”；我们正在使用一个尚未发布的版本，所以我们可以使用最新的功能。最后一行<strong class="ki iu"><em class="le">pragma experimental abiencoder v2；</em> </strong>是需要的，因为我们将在函数中返回一个struct(将在函数部分显示)。</em></strong></p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="8a35" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated">合同</h2><p id="6bfb" class="pw-post-body-paragraph kg kh it ki b kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">设置好你的版本后，你进入下一个部分，那就是对<strong class="ki iu"> <em class="le">使用名称</em> </strong> <strong class="ki iu"> <em class="le">自由职业者</em> </strong>和添加<strong class="ki iu"> <em class="le">全局变量进行约定。</em> </strong>合同可以用给定的名称调用。一个变量由一个<strong class="ki iu"> <em class="le">【类型】【函数调用】【变量名称】组成。</em> </strong></p><p id="3eed" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在contact中，我们声明了四个变量:</p><ul class=""><li id="4411" class="ll lm it ki b kj kk kn ko kr ln kv lo kz lp ld lq lr ls lt bi translated">公共所有者地址；</li><li id="50de" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">uint256私币；</li><li id="47b9" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">uint256私人现金；</li><li id="956b" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">bytes32私服；</li></ul><p id="4a07" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以看到我们使用<strong class="ki iu"> <em class="le">公有和私有，</em> </strong>除了这两个你还可以使用<strong class="ki iu"> <em class="le">内部或者外部。</em> </strong></p><ul class=""><li id="0a47" class="ll lm it ki b kj kk kn ko kr ln kv lo kz lp ld lq lr ls lt bi translated"><strong class="ki iu">外部</strong>——不能从内部进入，只能从外部进入(与公用相比，节省大约50%的<a class="ae kf" href="https://solidity.readthedocs.io/en/v0.4.24/introduction-to-smart-contracts.html?highlight=gas#gas" rel="noopener ugc nofollow" target="_blank">气体</a>)。</li><li id="ae89" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated"><strong class="ki iu">公共</strong> —每个人都可以访问。</li><li id="55cd" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated"><strong class="ki iu">内部</strong> —只有该合同及其派生的合同可以访问。</li><li id="65e3" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated"><strong class="ki iu">私有</strong> —只能从该合同访问。</li></ul><p id="a1a7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我使用了<strong class="ki iu"> <em class="le">字节32 </em> </strong>类型，而不是<strong class="ki iu"> <em class="le">字符串</em> </strong>类型，以节省更多的气体。</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="7356" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated"><a class="ae kf" href="https://solidity.readthedocs.io/en/v0.4.21/structure-of-a-contract.html?highlight=modifier#events" rel="noopener ugc nofollow" target="_blank">事件</a></h2><p id="098e" class="pw-post-body-paragraph kg kh it ki b kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">为了在每个事务中获得一些额外的信息，我们可以用一个事件记录额外的数据。在这种情况下，我们有两个事件叫做:<code class="fe nd ne nf ng b">logFreelancerChanged</code>和<code class="fe nd ne nf ng b">logAssetsChanged</code>。一个事件可以有<strong class="ki iu"> <em class="le">三个索引</em> </strong>项。有了索引，您可以使用索引参数作为过滤器来搜索这些事件。要使用事件，您可以通过<code class="fe nd ne nf ng b">emit [event_name(parameters)];</code>来完成。</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="3203" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated"><a class="ae kf" href="https://solidity.readthedocs.io/en/v0.4.21/structure-of-a-contract.html?highlight=modifier#struct-types" rel="noopener ugc nofollow" target="_blank">结构</a></h2><p id="d072" class="pw-post-body-paragraph kg kh it ki b kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">通过structs，你可以定义一个新的类型，每个自由职业者都有自己的<code class="fe nd ne nf ng b">FreelancerData</code>。在这个例子中，我们想要一些自由职业者的数据，包括:</p><ul class=""><li id="b674" class="ll lm it ki b kj kk kn ko kr ln kv lo kz lp ld lq lr ls lt bi translated">bytes32名；</li><li id="dbf1" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">bytes32姓氏；</li><li id="9b2f" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">uint256硬币；</li><li id="c2a0" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">uint256现金；</li><li id="ca3c" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated">bytes32服务；</li></ul><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="1ca7" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated"><a class="ae kf" href="https://solidity.readthedocs.io/en/v0.4.21/types.html#mappings" rel="noopener ugc nofollow" target="_blank">映射</a></h2><p id="1f34" class="pw-post-body-paragraph kg kh it ki b kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">一张地图由<code class="fe nd ne nf ng b">mapping([key_type] =&gt; [value_type]) [mapping_name];</code>组成</p><blockquote class="lf lg lh"><p id="1e1e" class="kg kh le ki b kj kk kl km kn ko kp kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated">“映射可以被看作是虚拟初始化的<a class="ae kf" href="https://en.wikipedia.org/wiki/Hash_table" rel="noopener ugc nofollow" target="_blank">散列表</a>，使得每个可能的键都存在，并被映射到字节表示全为零的值:类型的<a class="ae kf" href="https://solidity.readthedocs.io/en/v0.4.24/control-structures.html#default-value" rel="noopener ugc nofollow" target="_blank">默认值</a>。不过，相似之处到此为止:关键数据实际上并不存储在映射中，只是它的<code class="fe nd ne nf ng b">keccak256</code>散列用于查找值。”</p></blockquote><p id="f3c6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们制作了一个名为<code class="fe nd ne nf ng b">FreelancersData</code>(注意复数)的映射。我们可以使用这个地址来获得我们想要使用的自由职业者的<code class="fe nd ne nf ng b">FreelancerData</code>。</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="edac" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated"><a class="ae kf" href="https://solidity.readthedocs.io/en/v0.4.21/structure-of-a-contract.html?highlight=modifier#function-modifiers" rel="noopener ugc nofollow" target="_blank">修改器</a></h2><p id="982f" class="pw-post-body-paragraph kg kh it ki b kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">修饰符通常是可以多次使用的代码，可以添加到函数中。我们做了一个修改器叫<code class="fe nd ne nf ng b">onlyFreelancer()</code>。这仅允许数据所有者访问他/她自己的数据。如果其他人试图访问这些数据，他们会收到一条消息“发送者未经授权”。<code class="fe nd ne nf ng b">_;</code> <strong class="ki iu"> <em class="le"> </em> </strong>是说你的函数代码从哪里开始。</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="6c8a" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated">构造器</h2><p id="cb68" class="pw-post-body-paragraph kg kh it ki b kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">构造函数通过创建协定来执行，它总是需要设置为public。我们把<code class="fe nd ne nf ng b">msg.sender</code>设为<code class="fe nd ne nf ng b">owner</code>，给自由职业者零硬币和现金，给一个空的服务角色。</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="d0e0" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated"><a class="ae kf" href="https://solidity.readthedocs.io/en/v0.4.21/contracts.html#functions" rel="noopener ugc nofollow" target="_blank">功能</a></h2><p id="ba94" class="pw-post-body-paragraph kg kh it ki b kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">函数在被调用时被执行。在我们的合同中，我们声明了三个函数:<code class="fe nd ne nf ng b">setFreelancer()</code>、<code class="fe nd ne nf ng b">setAssets()</code>和<code class="fe nd ne nf ng b">myAccount()</code>。在代码中，你可以看到注释，它描述了每个函数做什么，包含什么和返回什么。</p><p id="092f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一个函数看起来像这样:</p><ul class=""><li id="57b3" class="ll lm it ki b kj kk kn ko kr ln kv lo kz lp ld lq lr ls lt bi translated"><strong class="ki iu">功能</strong></li><li id="3782" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated"><strong class="ki iu">【函数名(【参数】)】</strong>—函数名</li><li id="1be9" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated"><strong class="ki iu">【外部/公共/内部/私有】</strong> —给出访问量。</li><li id="3991" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated"><strong class="ki iu">【修改器:可选】</strong> —给出一个你之前创建的修改器</li><li id="2c79" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated"><strong class="ki iu">【查看/纯/应付:可选】</strong> —严格一点或者给个<a class="ae kf" href="https://solidity.readthedocs.io/en/v0.4.24/contracts.html#fallback-function" rel="noopener ugc nofollow" target="_blank">退路</a>。</li><li id="1414" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated"><strong class="ki iu"> returns(【类型】【名称:可选】)</strong> —函数内部返回什么。</li><li id="2cc9" class="ll lm it ki b kj lu kn lv kr lw kv lx kz ly ld lq lr ls lt bi translated"><strong class="ki iu">{[功能代码] } </strong>。—调用时要执行的代码。</li></ul><p id="3276" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe nd ne nf ng b">myAccount()</code>函数内部我们还利用了<a class="ae kf" href="https://solidity.readthedocs.io/en/v0.4.21/introduction-to-smart-contracts.html#storage-memory-and-the-stack" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu"> <em class="le">内存</em></strong></a><strong class="ki iu"><em class="le">:</em></strong></p><blockquote class="lf lg lh"><p id="1914" class="kg kh le ki b kj kk kl km kn ko kp kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated"><strong class="ki iu">“内存</strong>，其中一个契约为每个消息调用获得一个新清除的实例。存储器是线性的，可以在字节级寻址，但是读取限于256位宽，而写入可以是8位宽或256位宽。当访问(读取或写入)先前未接触的存储字(即一个字内的任何偏移)。在扩建时，必须支付燃气费用。内存越大，成本就越高(它以平方的方式扩展)。”</p></blockquote><p id="8692" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">示例:</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="33ff" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated">你可以很容易地用<a class="ae kf" href="https://remix.ethereum.org/" rel="noopener ugc nofollow" target="_blank"> Remix </a>在线测试这个智能合约。Freelancer.sol完整代码:</h2><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/4876c1387b10213e26ba6418d19c9447.png" data-original-src="https://miro.medium.com/v2/resize:fit:292/1*ZSBco9mgoreP377dkXVJNQ.gif"/></div></div></figure><h1 id="a449" class="np ma it bd mb nq nr ns me nt nu nv mh nw nx ny mk nz oa ob mn oc od oe mq of bi translated">感谢您的阅读！查看我的<a class="ae kf" href="https://github.com/jeroenouw/" rel="noopener ugc nofollow" target="_blank"> Github </a>或者我的关于区块链开发入门的帖子:</h1><div class="og oh gp gr oi oj"><a href="https://medium.com/coinmonks/blockchain-development-which-roads-are-there-f78b2ec6f320" rel="noopener follow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd iu gy z fp oo fr fs op fu fw is bi translated">区块链开发—入门</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">本指南是为那些想开始区块链开发，但不知道从哪里开始的开发者准备的。我…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">medium.comm</p></div></div><div class="os l"><div class="ot l ou ov ow os ox jz oj"/></div></div></a></div></div></div>    
</body>
</html>