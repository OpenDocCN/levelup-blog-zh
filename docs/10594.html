<html>
<head>
<title>Understanding Jobs in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解Kubernetes的工作</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/understanding-jobs-in-kubernetes-68ac21b272d8?source=collection_archive---------1-----------------------#2021-12-24">https://levelup.gitconnected.com/understanding-jobs-in-kubernetes-68ac21b272d8?source=collection_archive---------1-----------------------#2021-12-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b943" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">作业在K8s中起着重要的作用，它帮助您在应用程序中执行任务</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d583187c8dbcf68506ae8728c09dc8fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hChV9eA3TBPWhyGttvbMdA.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@arifriyanto?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Arif Riyanto </a>在<a class="ae kv" href="https://unsplash.com/s/photos/programming-language?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="37ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作业和Cron作业是Kubernetes工作负载中非常重要的部分。这些工作帮助我们完成我们分配给他们的特定任务。</p><p id="1982" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作业和Cron作业之间的主要区别是，作业将执行给定的任务，一旦任务完成，它将停止进程，并且作业仅在我们需要它运行时运行。Cron Job也做同样的事情，但是我们可以安排一个Cron Job按照给定的时间表运行。例如，我们可以安排Cron作业每小时运行一次，或者安排它在每天早上6点运行。</p><p id="de25" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我将讨论作业以及如何在您的应用程序中配置作业。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d8bd" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">配置作业</h1><p id="6f0b" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">正如您已经知道的，我们使用YAML文件来配置集群中的Kubernetes组件，并对现有组件进行更改。在这里，我们也可以使用YAML配置文件在Kubernetes中创建一个作业。让我们看一个简单的作业配置文件。</p><pre class="kg kh ki kj gt mw mx my bn mz na bi"><span id="59cb" class="nb ma iq mx b be nc nd l ne nf">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: node-app-job<br/>spec:<br/>  template:<br/>    spec:<br/>      containers:<br/>      - name: node-app-job<br/>        image: alpine   #your docker image<br/>        command: ["echo", "Welcome to my Node app"]<br/>      restartPolicy: Never</span></pre><p id="35bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的代码片段代表了一个简单的Kubernetes作业配置文件，您可以将docker图像添加到作业配置文件中。如上创建作业后，可以使用下面的命令将其应用到集群。</p><pre class="kg kh ki kj gt mw mx ng nh aw ni bi"><span id="e3c3" class="nj ma iq mx b gy nk nl l nm nf">$ kubectl apply -f node-app-job.yaml</span></pre><p id="ae54" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在终端上运行<code class="fe nn no np mx b">kubectl get all</code>命令，您会看到任务已经创建。第一次这样做时，这个过程可能需要一些时间，因为从容器注册表中提取docker映像需要一些时间。</p><p id="51d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行<code class="fe nn no np mx b">kubectl get pod --watch</code>查看事件，以便您可以观察创建作业时是否有错误。</p><p id="d30f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要查看您的作业日志，请在终端上使用从<code class="fe nn no np mx b">kubectl get all</code>命令获得的pod名称运行以下命令。</p><pre class="kg kh ki kj gt mw mx ng nh aw ni bi"><span id="3b96" class="nj ma iq mx b gy nk nl l nm nf">$ kubectl logs &lt;pod-name&gt;</span></pre><p id="242e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们在上面的确认文件中配置命令时，您将看到输出为<code class="fe nn no np mx b">Welcome to my Node app</code>。您可以使用<code class="fe nn no np mx b">kubectl describe job &lt;job-name&gt;</code>命令来获得更多关于您的工作的详细信息。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d9ea" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">更改作业配置文件</h1><p id="8d3f" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">与Kubernetes中的部署和服务不同，您不能立即更改相同的作业配置文件并重新应用它。在作业配置文件中进行更改后，在将其应用到集群之前，您需要从集群中删除以前的作业。</p><p id="06e8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令从群集中删除作业。</p><pre class="kg kh ki kj gt mw mx ng nh aw ni bi"><span id="9b7f" class="nj ma iq mx b gy nk nl l nm nf">$ kubectl delete job &lt;job-name&gt;</span><span id="398f" class="nj ma iq mx b gy nq nl l nm nf">//example</span><span id="16dd" class="nj ma iq mx b gy nq nl l nm nf">&gt; kubectl delete job node-app-job<br/>job.batch "node-app-job" deleted</span></pre><p id="0a15" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行<code class="fe nn no np mx b">kubectl get all</code>命令，并确保您已经从集群中成功删除了之前的作业。然后您可以再次运行<code class="fe nn no np mx b">kubectl apply</code>命令并检查日志。</p><p id="ae53" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们首先更改作业配置文件并研究日志。</p><pre class="kg kh ki kj gt mw mx my bn mz na bi"><span id="db31" class="nb ma iq mx b be nc nd l ne nf">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: node-app-job<br/>spec:<br/>  template:<br/>    spec:<br/>      containers:<br/>      - name: node-app-job<br/>        image: alpine<br/>        command: ["ls"]<br/>      restartPolicy: Never</span></pre><p id="612c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我更改了配置文件中的命令，这将输出alpine docker映像中的目录。此外，您可以根据自己的喜好更改docker图像和命令。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="5764" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">完成和并行</h1><p id="d2c0" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">通常，当我们创建一个作业时，它会创建一个pod并执行给定的任务。你已经通过上面的例子体验过了。但是使用<code class="fe nn no np mx b">completions</code>我们可以一个接一个地启动几个吊舱。</p><pre class="kg kh ki kj gt mw mx my bn mz na bi"><span id="d074" class="nb ma iq mx b be nc nd l ne nf">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: node-app-job<br/>spec:<br/>  completions: 2<br/>  template:<br/>    spec:<br/>      containers:<br/>      - name: node-app-job<br/>        image: alpine<br/>        command: ["echo", "Welcome to my Node app"]<br/>      restartPolicy: Never</span></pre><p id="aad4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦您添加了<code class="fe nn no np mx b">completions</code>，您将看到为该任务创建了两个pod。使用<code class="fe nn no np mx b">kubectl get pods --watch</code>命令查看它们。</p><pre class="kg kh ki kj gt mw mx ng nh aw ni bi"><span id="89ee" class="nj ma iq mx b gy nk nl l nm nf">// kubectl get pods --watch output</span><span id="f990" class="nj ma iq mx b gy nq nl l nm nf">pod/node-app-deployment-5c4694f5b-7tf8r   1/1     Running</span><span id="f75e" class="nj ma iq mx b gy nq nl l nm nf">pod/node-app-job-7pdp9                    0/1     Completed</span><span id="84fc" class="nj ma iq mx b gy nq nl l nm nf">pod/node-app-job-9924d                    0/1     ContainerCreating</span></pre><p id="3e69" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以使用<code class="fe nn no np mx b">parallelism</code>同时运行多个pod。<code class="fe nn no np mx b">parallelism</code>也用在下面的<code class="fe nn no np mx b">spec</code>下。</p><pre class="kg kh ki kj gt mw mx my bn mz na bi"><span id="7d1f" class="nb ma iq mx b be nc nd l ne nf">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: node-app-job<br/>spec:<br/>  completions: 2<br/>  parallelism: 2<br/>  template:<br/>    spec:<br/>      containers:<br/>      - name: node-app-job<br/>        image: alpine<br/>        command: ["echo", "Welcome to my Node app"]<br/>      restartPolicy: Never</span></pre><p id="b911" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在<code class="fe nn no np mx b">completions</code>下设置该特定任务需要运行的最大pod数量，并且您可以在<code class="fe nn no np mx b">parallelism</code>下定义并行运行的pod数量。</p><p id="98d5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的代码块中，我们有2个pod，我们需要这两个pod并行运行。</p><pre class="kg kh ki kj gt mw mx ng nh aw ni bi"><span id="4586" class="nj ma iq mx b gy nk nl l nm nf">// kubectl get pods --watch output</span><span id="72a7" class="nj ma iq mx b gy nq nl l nm nf">pod/node-app-deployment-5c4694f5b-7tf8r   1/1     Running</span><span id="54d8" class="nj ma iq mx b gy nq nl l nm nf">pod/node-app-job-glcn4                    0/1     ContainerCreating</span><span id="5079" class="nj ma iq mx b gy nq nl l nm nf">pod/node-app-job-ngm5p                    0/1     ContainerCreating</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="99f2" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">back offlimit &amp; activeDeadlineSeconds</h1><p id="bf65" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated"><code class="fe nn no np mx b">backoffLimit</code>当我们的作业创建失败时，帮助我们限制pod的创建。通常，当一个pod没有正确创建时，它将进入错误状态并启动另一个pod，这个过程将继续，直到您成功创建pod。</p><p id="c775" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您的作业包含不允许您的作业成功创建的内容(例如:命令错误)，它会尝试连续创建pod。当您运行<code class="fe nn no np mx b">kubectl get pods</code>时，您将看到几个具有<code class="fe nn no np mx b">Error</code>状态的pod。但是使用<code class="fe nn no np mx b">backoffLimit</code>您可以限制连续创建的pod的数量。</p><pre class="kg kh ki kj gt mw mx my bn mz na bi"><span id="d127" class="nb ma iq mx b be nc nd l ne nf">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: node-app-job<br/>spec:<br/>  backoffLimit: 2<br/>  template:<br/>    spec:<br/>      containers:<br/>      - name: node-app-job<br/>        image: alpine<br/>        command: ["ls", "/data"]<br/>      restartPolicy: Never</span></pre><pre class="nr mw mx ng nh aw ni bi"><span id="9eed" class="nj ma iq mx b gy nk nl l nm nf">kubectl get pods</span><span id="fa1b" class="nj ma iq mx b gy nq nl l nm nf">pod/node-app-deployment-5c4694f5b-7tf8r   1/1     Running</span><span id="37b9" class="nj ma iq mx b gy nq nl l nm nf">pod/node-app-job-8bfgj                    0/1     Error</span><span id="3ac9" class="nj ma iq mx b gy nq nl l nm nf">pod/node-app-job-kk8nh                    0/1     Error</span><span id="b6ea" class="nj ma iq mx b gy nq nl l nm nf">pod/node-app-job-x6fmk                    0/1     Error</span></pre><p id="e185" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nn no np mx b">activeDeadlineSeconds</code>帮助我们决定作业应该运行多少秒。为了验证这个选项，我们在我们的作业中设置了<code class="fe nn no np mx b">sleep</code>命令来运行它40秒。但是使用<code class="fe nn no np mx b"> activeDeadlineSeconds: 15</code>我们可以在15秒后终止任务。</p><pre class="kg kh ki kj gt mw mx my bn mz na bi"><span id="cee5" class="nb ma iq mx b be nc nd l ne nf">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: node-app-job<br/>spec:<br/>  activeDeadlineSeconds: 15<br/>  template:<br/>    spec:<br/>      containers:<br/>      - name: node-app-job<br/>        image: alpine<br/>        command: ["sleep", "40"]<br/>      restartPolicy: Never</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/14cd9f08fa9eaae8a0c93203915c86c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OjnaRs8fJM9vH2t5"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">作者截图</figcaption></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="9823" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="5fc6" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated"><strong class="ky ir"> <em class="nt">恭喜恭喜！</em> </strong> <em class="nt"> </em>🎉</p><p id="8578" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您已经在Kubernetes中介绍了工作的基本原理。</p><p id="dcd3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读。我希望本文中的信息对您有用。如果您发现任何可疑之处，请在下面留下您的回复，以便我可以回复您。</p><p id="114f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nt">快乐编码！</em>👨🏻‍💻</p></div></div>    
</body>
</html>