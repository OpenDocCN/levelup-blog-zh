<html>
<head>
<title>Find sensitive data in AWS S3 using AWS Macie and notify Slack users</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Macie查找AWS S3中的敏感数据，并通知Slack用户</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/find-sensitive-data-in-aws-s3-using-aws-macie-notify-slack-users-1fbcab8ad19d?source=collection_archive---------4-----------------------#2021-10-10">https://levelup.gitconnected.com/find-sensitive-data-in-aws-s3-using-aws-macie-notify-slack-users-1fbcab8ad19d?source=collection_archive---------4-----------------------#2021-10-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="5fb1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> AWS Macie </strong>是来自AWS 的<strong class="js iu">托管服务，它使用<strong class="js iu"> ML(机器学习)</strong>从存储在<strong class="js iu"> AWS S3桶</strong>中的对象中识别敏感数据，如<strong class="js iu"> PII(个人身份信息)</strong>。</strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/a04dad1bea6b52fd39b57bff7a23c509.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sqqbTcHopiVEAd6Re1C6Tw.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">AWS Macie</figcaption></figure><p id="863b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据<strong class="js iu"> NIST FIPS-199标准</strong>，以下是每个安全目标(机密性、完整性和可用性)的潜在影响定义:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi le"><img src="../Images/40fb2a919b0490e635f73acb7ae596e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g2Xiw_nXynNHKAwzgGjAKg.png"/></div></div></figure><p id="544e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lf">更多详情请参考链接— </em></p><p id="de44" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae lg" href="https://nvlpubs.nist.gov/nistpubs/fips/nist.fips.199.pdf" rel="noopener ugc nofollow" target="_blank"><em class="lf">https://nvlpubs.nist.gov/nistpubs/fips/nist.fips.199.pdf</em></a></p><p id="0353" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae lg" href="https://cdt.ca.gov/wp-content/uploads/2017/03/NIST.FIPS_.199.pd-10.pdf" rel="noopener ugc nofollow" target="_blank"><em class="lf">https://cdt.ca.gov/wp-content/uploads/2017/03/NIST.FIPS _ . 199 . PD-10 . pdf</em>T21】</a></p><p id="e19c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇博客中，我们将看到如何使用AWS Macie和AWS Lambda来发现AWS S3对象中潜在的敏感数据，并通知我们的Slack channel。</p><h1 id="dc62" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">我的架构:</h1><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mf"><img src="../Images/83ee03964e7c3bcce9bb613c4097b7cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*icEyhF9HHfuhpP32CmVovg.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">AWS Macie与其他AWS服务相结合，可在出现任何合规性问题时自动发出通知</figcaption></figure><p id="9e1c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">步骤1:创建一个松弛的网钩</strong></p><p id="5df6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">作为先决条件，准备好一个Slack Webhook，它有一个特定的通道，用于向它发送通知。如果没有，请点击链接(<a class="ae lg" href="https://api.slack.com/apps" rel="noopener ugc nofollow" target="_blank">https://api.slack.com/apps</a>)，按照Slack文档在Slack上创建一个应用程序，然后添加一个新的Webhook。</p><p id="c2e6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成后，您应该会看到您的应用程序列在Slack应用程序部分:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mg"><img src="../Images/29a534a71b3eebd89138037ae8ebb177.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cyW3wjrQfVgVVc4j1Arqsw.png"/></div></div></figure><p id="b855" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">第二步:编写AWS Lambda函数</strong></p><p id="decc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我已经使用了<strong class="js iu"> AWS SAM(无服务器应用程序模型)</strong>来创建和部署<strong class="js iu"> AWS Lambda </strong>，但是您可以使用任何其他无服务器框架或使用内置IDE(即AWS控制台上的Cloud9)直接编写/上传您的Lambda。</p><p id="ffdd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">我的Lambda项目结构(使用Node 14.x运行时):</strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mh"><img src="../Images/438ec1975ca2701565a98745ee24b8a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tWwq0eQIdr4MFm7HiWiv2g.png"/></div></div></figure><p id="1edc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> AWS SAM无服务器YAML文件:</strong></p><pre class="kp kq kr ks gt mi mj mk ml aw mm bi"><span id="faaa" class="mn li it mj b gy mo mp l mq mr">AWSTemplateFormatVersion: '2010-09-09'<br/>Transform: AWS::Serverless-2016-10-31<br/>Description: &gt;<br/>  mymacie</span><span id="782a" class="mn li it mj b gy ms mp l mq mr">SAM Template for mymacie<br/>  <br/>Globals:<br/>  Function:<br/>    Timeout: 3</span><span id="5416" class="mn li it mj b gy ms mp l mq mr">Resources:<br/>  MacieFunction:<br/>    Type: AWS::Serverless::Function<br/>    Properties:<br/>      CodeUri: macie/<br/>      Handler: app.lambdaHandler<br/>      Runtime: nodejs14.x<br/>      Architectures:<br/>        - x86_64<br/>      Events:<br/>        Macie:<br/>          Type: Api <br/>          Properties:<br/>            Path: /macie<br/>            Method: get</span><span id="9409" class="mn li it mj b gy ms mp l mq mr">Outputs:<br/>  MacieApi:<br/>    Description: "API Gateway endpoint URL for Prod stage for Hello World function"<br/>    Value: !Sub<br/>  MacieFunction:<br/>    Description: "Macie Lambda Function ARN"<br/>    Value: !GetAtt MacieFunction.Arn<br/>  MacieFunctionIamRole:<br/>    Description: "Implicit IAM Role created for Macie function"<br/>    Value: !GetAtt MacieFunctionRole.Arn</span></pre><p id="a5bf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> app.js文件</strong></p><pre class="kp kq kr ks gt mi mj mk ml aw mm bi"><span id="3b3c" class="mn li it mj b gy mo mp l mq mr">const {<br/>    IncomingWebhook<br/>} = require('<a class="ae lg" href="http://twitter.com/slack/webhook" rel="noopener ugc nofollow" target="_blank">@slack/webhook</a>');<br/>const url = process.env.SLACK_WEBHOOK_URL;<br/>const webhook = new IncomingWebhook(url);</span><span id="6806" class="mn li it mj b gy ms mp l mq mr">let response;</span><span id="f469" class="mn li it mj b gy ms mp l mq mr">exports.lambdaHandler = async (event, context) =&gt; {<br/>    try {<br/>        console.log(event.detail.resourcesAffected);<br/>        const finding = event.detail.classificationDetails.result.sensitiveData[0].category;<br/>        const findingDescription = event.detail.description;<br/>        const findingTime = event.detail.updatedAt;<br/>        const findingTimeEpoch = Math.floor(new Date(findingTime) / 1000);<br/>        const account = event.detail.accountId;<br/>        const region = event.detail.region;<br/>        const type = event.detail.type;<br/>        const jobId = event.detail.classificationDetails.jobId;<br/>        const lastSeen = `&lt;!date^${findingTimeEpoch}^{date} at {time} | ${findingTime}&gt;`;<br/>        const severity = event.detail.severity.description;<br/>        const category = event.detail.category;<br/>        const color = (`${severity}` === 'High') ? '#FF0000' : (`${severity}` === 'Medium') ? 'FFA500' : '#2091fa';<br/>        const s3BucketArn = event.detail.resourcesAffected.s3Bucket.arn;<br/>        const s3BucketObject = event.detail.resourcesAffected.s3Object.key;</span><span id="62d1" class="mn li it mj b gy ms mp l mq mr">await webhook.send({<br/>            channel: 'my-macie',<br/>            pretext: `AWS Macie in the AWS Region ${region} for AWS Account id as ${account}`,<br/>            text: `${finding}`,<br/>            attachments: [{<br/>                color: `${color}`,<br/>                title: `${findingDescription}`,<br/>                author_name: "Macie",<br/>                author_link: "<a class="ae lg" href="http://flickr.com/bobby/" rel="noopener ugc nofollow" target="_blank">http://flickr.com/bobby/</a>",<br/>                author_icon: '<a class="ae lg" href="https://k8s-nest.s3.amazonaws.com/download.png'" rel="noopener ugc nofollow" target="_blank">https://k8s-nest.s3.amazonaws.com/download.png'</a>,<br/>                thumb_url: '<a class="ae lg" href="https://k8s-nest.s3.amazonaws.com/download.png'" rel="noopener ugc nofollow" target="_blank">https://k8s-nest.s3.amazonaws.com/download.png'</a>,<br/>                fields: [{<br/>                        title: 'AWS Account',<br/>                        value: `${account}`,<br/>                        short: true<br/>                    },<br/>                    {<br/>                        title: 'AWS Region',<br/>                        value: `${region}`,<br/>                        short: true<br/>                    },<br/>                    {<br/>                        title: 'Job Id',<br/>                        value: `${jobId}`,<br/>                        short: true<br/>                    },<br/>                    {<br/>                        title: 'Severity',<br/>                        value: `${severity}`,<br/>                        short: true<br/>                    },<br/>                    {<br/>                        title: 'Type',<br/>                        value: `${type}`,<br/>                        short: true<br/>                    },<br/>                    {<br/>                        title: 'Category',<br/>                        value: `${category}`,<br/>                        short: true<br/>                    },<br/>                    {<br/>                        title: 'Finding Time (in Epoch)',<br/>                        value: `${findingTimeEpoch}`,<br/>                        short: true<br/>                    },<br/>                    {<br/>                        title: 'Last Seen',<br/>                        value: `${lastSeen}`,<br/>                        short: true<br/>                    },<br/>                    {<br/>                        title: 'Affected S3 Bucket ARN',<br/>                        value: `${s3BucketArn}`,<br/>                        short: true<br/>                    },<br/>                    {<br/>                        title: 'Affected S3 Bucket Object',<br/>                        value: `${s3BucketObject}`,<br/>                        short: true<br/>                    }<br/>                ]</span><span id="1b05" class="mn li it mj b gy ms mp l mq mr">}]<br/>        });</span><span id="488b" class="mn li it mj b gy ms mp l mq mr">// const ret = await axios(url);<br/>        response = {<br/>            'statusCode': 200,<br/>            'body': JSON.stringify({<br/>                message: 'hello macie',<br/>                // location: ret.data.trim()<br/>            })<br/>        }<br/>    } catch (err) {<br/>        console.log(err);<br/>        return err;<br/>    }</span><span id="4511" class="mn li it mj b gy ms mp l mq mr">return response<br/>};</span></pre><p id="7c63" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lf">注意:在这里，我将环境变量作为SLACK_WEBHOOK_URL传递给这个Lambda函数，其中包含在上面步骤1中创建的实际Slack Webhook的值。确保此环境变量是使用Lambda函数资源中的无服务器/云信息YAML模板传递的，或者是手动创建的。</em></p><p id="8cb0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">步骤3:为Macie服务创建一个AWS EventBridge(以前称为AWS CloudWatch事件)规则来触发这个Lambda </strong></p><p id="e05a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我已经为EventBridge创建了规则，目标是这个Lambda(在上面的步骤2中创建的):</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mt"><img src="../Images/2039fff73612c047af0822d2ff1e4838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YasmPiEBoPsf4pBVlWg4AQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">目标为Lambda的Macie的AWS EventBridge规则</figcaption></figure><p id="c1ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">步骤4:启用Macie并创建作业</strong></p><p id="5360" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> AWS Macie是一项地区性服务</strong>，这意味着每当您希望在特定地区运行S3桶扫描时，必须首先启用该服务。</p><p id="3e21" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我的情况下，我的S3水桶和梅西服务都在us-east-1(北弗吉尼亚州)。</p><p id="ead2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">启用它，然后为Macie创建一个作业(预定的或一次性的)来执行扫描。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mu"><img src="../Images/0e1c234f887a2938168397d4dbfdff61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iLW1SlIh-7ggUwEnjiy2Mw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">启用AWS Macie</figcaption></figure><p id="85ad" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面的屏幕截图显示了您希望如何运行此作业来发现敏感数据。对于这个演示，我将使用<strong class="js iu">一次性工作</strong>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mv"><img src="../Images/79b0a9559f1da751022c0b9faa135982.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0diwnyQUd1ojhNGV70Dz1g.png"/></div></div></figure><p id="13dc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些是被管理的数据标识符。如果您想排除任何特定的预定义模式或标识符，如<strong class="js iu">AUSTRALIA _ DRIVERS _ LICENSE</strong>，那么您可以选择“<strong class="js iu"> Exclude </strong>”选项，然后选择该标识符。在这个演示中，我没有排除任何东西，所以我将选择'<strong class="js iu"> All </strong>'选项。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mw"><img src="../Images/9f891024b20e8672b26f6c7e581cc1f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-izXir1vuYobStPLQJOtlA.png"/></div></div></figure><p id="0ee1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您想为敏感信息(如<strong class="js iu"> Aadhaar </strong>)添加任何带有您自己的正则表达式模式的自定义标识符，那么您可以在这里创建一个。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mx"><img src="../Images/1e8a4d4bc026fc5c6355c17578f81153.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*epVtGQG7ht6c1cTpkLJB2w.png"/></div></div></figure><p id="77e1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，给Job命名，等待Macie运行并完成结果。</p><p id="c3ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成后，您将在Macie service plus上看到摘要，并会收到一条发送到Slack频道的通知</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi my"><img src="../Images/b632db132a0125c0308d7a91059e62a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bC03wV5SzLeJREWhjbuhtQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">AWS Macie —摘要</figcaption></figure><p id="756b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">瞧吧！开始:-) 我们收到了包含以下信息的松弛通知:AWS帐户、区域、S3时段、对象名称、严重级别(在S3对象中发现的PII的高、中或低级别:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mz"><img src="../Images/4de88abfaf11cbea1352f681d4ddfd94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oAF95_Q-NbDS1OlwpQTfgg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">AWS Macie报告的时差通知</figcaption></figure><p id="2d0b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意，我已经定制了Slack消息，如果严重性为<strong class="js iu">低</strong>，则以蓝色显示消息，如果严重性为<strong class="js iu">高</strong>，则以红色显示消息。</p><p id="8dee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你喜欢这篇文章:)</p><h1 id="6aee" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated"><strong class="ak">概要:</strong></h1><p id="2756" class="pw-post-body-paragraph jq jr it js b jt na jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj ne kl km kn im bi translated">在这篇博客中，我们看到了如何使用内置机器学习技术的AWS Macie来识别和报告各种潜在的敏感数据。不仅如此，我们还可以在标准规则的基础上提供自定义模式来识别敏感数据。在这里，我们还看到了如何将AWS Macie与其他AWS服务和Slack结合使用，以构建一个自动化的完全流水线系统来报告此类事件，以便您的合规团队对数据采取进一步的行动。</p><p id="ece7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">像往常一样，您可以在GitHub存储库中找到代码:</p><div class="nf ng gp gr nh ni"><a href="https://github.com/vinod827/mymacie" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd iu gy z fp nn fr fs no fu fw is bi translated">GitHub - vinod827/mymacie</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">该项目包含无服务器应用程序的源代码和支持文件，您可以使用</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">github.com</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw ky ni"/></div></div></a></div></div></div>    
</body>
</html>