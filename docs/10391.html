<html>
<head>
<title>Running Lambda Functions Faster and Cheaper</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">运行Lambda函数更快更便宜</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/running-lambda-functions-faster-and-cheaper-416260fbc375?source=collection_archive---------10-----------------------#2021-11-30">https://levelup.gitconnected.com/running-lambda-functions-faster-and-cheaper-416260fbc375?source=collection_archive---------10-----------------------#2021-11-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="39d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简单的配置如何让您的功能更快、更便宜</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/46c4ff71a8f4cfb8add389f4a0557c49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3NdcrIaFLr0-s6NUOekDrA.jpeg"/></div></div></figure><blockquote class="kx ky kz"><p id="6443" class="jn jo la jp b jq jr js jt ju jv jw jx lb jz ka kb lc kd ke kf ld kh ki kj kk ij bi translated"><em class="iq">免责声明:我不代表亚马逊发言。观点是我自己的。</em></p></blockquote><p id="997b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，你是在告诉我，我可以更快地运行lambda中的代码，并且这样做花费更少吗？<strong class="jp ir">是的，我是！</strong></p><p id="5a6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你能告诉我怎么做吗？<strong class="jp ir">是的，我会的！</strong></p><p id="3d83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，让我们从两个要点背后的基本原理开始:</p><p id="9cf6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">1-Lambda函数如何分配CPU </strong></p><p id="1c24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然CPU在Lambda上并不是显式配置，但它是基于另一个重要配置来确定的:<strong class="jp ir">内存</strong>。</p><p id="10b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据AWS文件<a class="ae le" href="https://aws.amazon.com/lambda/faqs" rel="noopener ugc nofollow" target="_blank"><em class="la">【ref】</em></a>:</p><blockquote class="kx ky kz"><p id="95be" class="jn jo la jp b jq jr js jt ju jv jw jx lb jz ka kb lc kd ke kf ld kh ki kj kk ij bi translated">问:如何将计算资源分配给AWS Lambda功能？</p><p id="e88e" class="jn jo la jp b jq jr js jt ju jv jw jx lb jz ka kb lc kd ke kf ld kh ki kj kk ij bi translated">在AWS Lambda资源模型中，您为自己的函数选择所需的内存量，并按比例分配CPU能力和其他资源。例如，选择256MB内存分配给Lambda函数的CPU能力大约是请求128MB内存的两倍，是选择512MB内存的一半。要了解更多信息，请参见我们的<a class="ae le" href="https://docs.aws.amazon.com/lambda/latest/dg/resource-model.html" rel="noopener ugc nofollow" target="_blank">功能配置文档</a>。</p></blockquote><p id="10c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">2-Lambda函数如何计费</strong></p><p id="43ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章发表时，不考虑免费层，lambda是通过计算收费的</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lf"><img src="../Images/4a68e38f74258fcfa0c83d0e77fcb8ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ERVoeuJ5yeganoqHmTodg.png"/></div></div></figure><p id="0891" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以注意到，<em class="la">每个请求的价格</em>是一个不依赖于内存和持续时间的变量，因此，不能通过微调lambda配置来降低。</p><p id="6dfe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一方面，第一个参数基于内存和持续时间。由于<em class="la"> GB秒价格</em>是由AWS定义的常数，而<em class="la">请求总数</em>取决于服务的架构和负载，我们有一个定价公式，可以用来降低最终价格，即:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lg"><img src="../Images/83b3ae8aebe885fd82c763de30d40199.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VKIF7xGYTu_CRMaE72oh_g.png"/></div></div></figure><p id="0a14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们想要最小化<em class="la">(以千兆字节为单位的内存)*(以秒为单位的持续时间)</em>的结果，以便通过执行lambda函数来支付更便宜的费用。</p><p id="092e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，在一个场景中，我们已经有一个运行中的lambda函数，代码已经过优化，持续时间减少并不简单，我们如何才能将它最小化呢？让我们检查一下！</p><h1 id="c6e6" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">王牌:通过增加内存和CPU来最小化lambda的持续时间和价格</h1><p id="363b" class="pw-post-body-paragraph jn jo iq jp b jq mf js jt ju mg jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">因此，为了更好地解释逻辑，让我们设置几个参数。</p><p id="b080" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">x86架构的当前千兆位秒价格为每千兆位秒0.0000166667美元，请求价格为每1M请求0.20美元<a class="ae le" href="https://aws.amazon.com/lambda/pricing" rel="noopener ugc nofollow" target="_blank"><em class="la">【ref】</em></a>。</p><p id="0a47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们假设的场景中，我们有一个在128MB的lambda中运行的代码，平均持续时间为700毫秒。此外，这段代码每月运行2.5亿次请求。</p><p id="0322" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，在这种情况下，定价将是:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/9dc3cc9d89e6cc71295361600b5d9317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1174/format:webp/1*B0ZuX_AHWAPX_y4btuPltg.png"/></div></figure><p id="2181" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如前所述，王牌是最小化</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lg"><img src="../Images/83b3ae8aebe885fd82c763de30d40199.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VKIF7xGYTu_CRMaE72oh_g.png"/></div></div></figure><p id="8387" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下是0.125 * 0.7 = 0.0875。</p><p id="c65f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，如果我们将0.0875的10%最小化为0.07875，那么最终价格将从414.58美元降低到378.12美元。</p><p id="723c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">考虑到代码持续时间的一个方面是内存和CPU的可用容量，因此，增加Lambda中的内存可以大大减少执行持续时间。</p><p id="5706" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要点是:增加内存也会增加该等式中两个乘数之一，因此，第二个等式，即持续时间，必须以比内存增加更高的速率减少，以便进行有价值的权衡。</p><p id="8e17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的例子中，如果我们将内存增加到256MB (2x 128MB ),那么如果持续时间减少到一半以下，这是值得的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ml"><img src="../Images/fefe4f49fb7c13aa76acd73be42ee7f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2pNgic5njcgJ16nD-dlw-w.png"/></div></div></figure><p id="908c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在表中，我们可以注意到内存翻倍(从128MB到256MB)将持续时间减少了一半(从0.7到0.35)，因此最终结果是相同的。</p><p id="c594" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的主要目标是以高于记忆增长的速度减少我们的持续时间</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/27e2e3b37e8cc305c04fa773b9d9c7bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1174/format:webp/1*xeQDa1ryR_iV9wHpMZqOkA.png"/></div></figure><p id="2380" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面我们可以看到这个公式是如何应用的，并显示当持续时间从700毫秒减少到300毫秒时，将内存从128MB增加到256MB是值得的</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/68f5ab9419a89815173fa9578b7440d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/1*vAbsz-5nJ9kiNduDtY9Vhg.png"/></div></figure><h1 id="baa4" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">在实践中为我的应用找到正确的内存配置</h1><p id="79ae" class="pw-post-body-paragraph jn jo iq jp b jq mf js jt ju mg jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">找到正确配置的主要目标是检测内存增加不适用于上述公式的阈值。</p><p id="d51f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在某个时刻，增加记忆并不会减少持续时间，这时你应该停下来。</p><p id="ff17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下图显示了常见的模式。该曲线可能因应用程序、语言、I/O限制或CPU限制以及其他因素而异。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mn"><img src="../Images/f2141a805900608043963ab1bf331e9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aE-hIZxYzKfjzDf59f4WRA.png"/></div></div></figure><p id="e78b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我对不同的内存配置(128MB、256MB、384MB、512MB、640MB、768MB、896MB、1024MB、1280MB、1536MB、2048MB、3072MB、4096MB)执行了100倍以下的代码，并计算了<em class="la">内存*持续时间</em>值和2.5亿个请求的最终价格。</p><pre class="km kn ko kp gt mo mp mq mr aw ms bi"><span id="27f5" class="mt li iq mp b gy mu mv l mw mx">def lambda_handler(event, context):<br/>    for i in range(0, 300):<br/>        for j in range(0, 300):<br/>            for k in range(0, 300):<br/>                sum_of_indexes = i + j + k</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi my"><img src="../Images/baa76ec5c4627f83ecb7a7b64e1032c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L6H0WRTRzyUnGojIJM9siA.png"/></div></div></figure><p id="ee71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们所看到的，对于这段代码，更便宜的配置是1536MB，在p90中运行2415ms，总价为15，143.78美元，执行2.5亿次。</p><p id="6398" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">128MB的相同代码运行速度会慢12倍以上(30065毫秒)，成本会高出近4%(15，708.80美元)。</p><h1 id="edc0" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">逐步地</h1><p id="96f5" class="pw-post-body-paragraph jn jo iq jp b jq mf js jt ju mg jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">基本上，配置lambda函数内存需要做的是运行代码N次(10~30次可能就足够了),以获得每种可能的内存配置的平均持续时间，直到您注意到<em class="la">内存*持续时间</em>增加太多。然后，您应该选择在价格和持续时间之间具有最佳平衡的内存配置。</p><h1 id="b894" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">结论</h1><p id="f987" class="pw-post-body-paragraph jn jo iq jp b jq mf js jt ju mg jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">了解您用来运营和收费的工具和服务的详细信息非常重要，以便能够以最佳方式进行配置。</p><p id="827a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有时候，我们认为使用更多的资源意味着付出更多，但事实并非总是如此。当我们谈到云计算的时候，一个资源不仅仅是用硬件/容量来衡量，还要用<strong class="jp ir">时间</strong>来衡量。</p></div></div>    
</body>
</html>