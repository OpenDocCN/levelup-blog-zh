<html>
<head>
<title>Terraform: Blue/Green Deployment with Azure App Service for Containers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform:针对容器的蓝色/绿色部署和Azure应用服务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/terraform-blue-green-deployment-with-azure-app-service-for-containers-978f3cc6479f?source=collection_archive---------13-----------------------#2022-04-24">https://levelup.gitconnected.com/terraform-blue-green-deployment-with-azure-app-service-for-containers-978f3cc6479f?source=collection_archive---------13-----------------------#2022-04-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/63cd8f57b16d97e4bea158353ab7044e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5jv-219lauP8sYR358DAvA.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">你能在这幅图像中找出蓝色和绿色吗？看完这个你肯定能认出来:)图片来自dailyadvent</figcaption></figure><p id="debe" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Azure App Service支持使用部署插槽的蓝/绿部署，部署插槽用于在部署期间保持我们的应用程序零宕机，并提供一种在进入实时/生产之前预测试应用程序的方法。它减少了在云中引入突破性变化的担忧。我将尝试解释使用terraform为带有部署槽的容器创建一个高度可用的Azure Web App服务。</p><p id="b99f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Azure基础设施资源使用<a class="ae ld" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>创建，管道使用GitHub actions或Azure DevOps，你可以在这里找到完整的报告<a class="ae ld" href="https://github.com/rollendxavier/terraform_azure_webapps_bluegreen_deploy" rel="noopener ugc nofollow" target="_blank">，其中包括基本的Terraform指令。</a></p><h2 id="869f" class="le lf it bd lg lh li dn lj lk ll dp lm kq ln lo lp ku lq lr ls ky lt lu lv lw bi translated">要求</h2><p id="b444" class="pw-post-body-paragraph kf kg it kh b ki lx kk kl km ly ko kp kq lz ks kt ku ma kw kx ky mb la lb lc im bi translated">我们需要创建一个带有蓝色/绿色插槽的Azure应用服务，其中蓝色插槽是实时应用，绿色插槽用于部署新版本的容器映像，稍后针对该插槽运行测试/健康检查，以确保一切正常工作。然后将传入流量切换到带有新版本容器映像的绿色插槽。</p><p id="f6da" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">下面的文章解释了大量关于Azure App Service多阶段部署的细节。</p><p id="bd32" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><a class="ae ld" href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots" rel="noopener ugc nofollow" target="_blank">搭建搭建环境——Azure App Service |微软文档</a></p><p id="97a7" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们可以使用蓝色/绿色部署的Azure应用服务计划中的部署插槽来设置暂存环境，在将插槽交换到生产流量之前，我们可以检查插槽中的实例，从而消除应用程序的停机时间。</p><blockquote class="mc md me"><p id="fe65" class="kf kg mf kh b ki kj kk kl km kn ko kp mg kr ks kt mh kv kw kx mi kz la lb lc im bi translated">app服务必须在<strong class="kh iu">标准</strong>、<strong class="kh iu">高级</strong>或<strong class="kh iu">隔离</strong>层中运行，以便您启用多个部署插槽。</p></blockquote><p id="ca40" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">下面是我们将在本文中介绍的步骤。</p><ul class=""><li id="6711" class="mj mk it kh b ki kj km kn kq ml ku mm ky mn lc mo mp mq mr bi translated">用Terraform作为IaC创建Azure基础设施。</li><li id="9086" class="mj mk it kh b ki ms km mt kq mu ku mv ky mw lc mo mp mq mr bi translated">将容器映像推送到Azure容器注册表中</li><li id="d002" class="mj mk it kh b ki ms km mt kq mu ku mv ky mw lc mo mp mq mr bi translated">将容器图像拖入App蓝色插槽。</li><li id="00f5" class="mj mk it kh b ki ms km mt kq mu ku mv ky mw lc mo mp mq mr bi translated">将应用服务蓝色插槽换成绿色插槽。</li><li id="3444" class="mj mk it kh b ki ms km mt kq mu ku mv ky mw lc mo mp mq mr bi translated">将资源部署到Azure的管道。</li></ul><h2 id="7b7d" class="le lf it bd lg lh li dn lj lk ll dp lm kq ln lo lp ku lq lr ls ky lt lu lv lw bi translated">创建基础设施</h2><p id="b521" class="pw-post-body-paragraph kf kg it kh b ki lx kk kl km ly ko kp kq lz ks kt ku ma kw kx ky mb la lb lc im bi translated">Terraform支持<a class="ae ld" href="https://www.terraform.io/language/modules/develop" rel="noopener ugc nofollow" target="_blank">模块</a>并帮助我们实现DRY ( <em class="mf">不要重复你的代码</em>)原则。因此，我们将尝试使用下面定义的资源创建两个模块</p><ol class=""><li id="2ffd" class="mj mk it kh b ki kj km kn kq ml ku mm ky mn lc mx mp mq mr bi translated"><strong class="kh iu">容器</strong> <br/> -资源组<br/> - azure容器注册表</li><li id="406a" class="mj mk it kh b ki ms km mt kq mu ku mv ky mw lc mx mp mq mr bi translated"><strong class="kh iu"> app <br/> </strong> -资源组，<br/> -应用洞察、app服务计划、app服务、槽位、app角色等。</li></ol><p id="191e" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu"> Azure容器注册表</strong></p><p id="e62b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">下面的terraform代码片段将使用“系统分配”<a class="ae ld" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview" rel="noopener ugc nofollow" target="_blank"> azure托管身份</a>创建Azure容器注册表，其中身份是在Azure AD中创建的，它与容器实例的生命周期相关联。</p><figure class="my mz na nb gt ju"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="f191" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我将使用我以前的博客中的docker图片，你可以根据它来创建和运行docker图片。NET 5 Web app，</p><div class="ne nf gp gr ng nh"><a href="https://rollendxavier.medium.com/containerize-net-5-api-using-docker-and-kubernetes-526de1154ec9" rel="noopener follow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd iu gy z fp nm fr fs nn fu fw is bi translated">集装箱化。NET 5 API使用Docker和Kubernetes</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">在本文中，我将尝试解释部署您的。NET 5在Kubernetes集群中的应用</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">rollendxavier.medium.com</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv jz nh"/></div></div></a></div><p id="b24e" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">网络应用</strong></p><p id="be11" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们需要创建一个Linux应用服务计划，以及一个带有蓝色和绿色分段插槽的应用服务来部署我们的容器映像。</p><figure class="my mz na nb gt ju"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="f75b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">您可以看到一个资源“azurerm_role_assignment ”,它将授予应用程序的identity <strong class="kh iu"> ACRPull </strong>对容器的权限。</p><h1 id="7a9f" class="nw lf it bd lg nx ny nz lj oa ob oc lm od oe of lp og oh oi ls oj ok ol lv om bi translated">管道</h1><h2 id="2b9d" class="le lf it bd lg lh li dn lj lk ll dp lm kq ln lo lp ku lq lr ls ky lt lu lv lw bi translated"><strong class="ak">码头工人建造</strong></h2><p id="f138" class="pw-post-body-paragraph kf kg it kh b ki lx kk kl km ly ko kp kq lz ks kt ku ma kw kx ky mb la lb lc im bi translated">现在，让我们建立一个管道，使用YAML构建Docker映像并将其推送到ACR，下面是YAML文件:</p><figure class="my mz na nb gt ju"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h2 id="bc75" class="le lf it bd lg lh li dn lj lk ll dp lm kq ln lo lp ku lq lr ls ky lt lu lv lw bi translated"><strong class="ak">部署地形基础设施</strong></h2><p id="8af1" class="pw-post-body-paragraph kf kg it kh b ki lx kk kl km ly ko kp kq lz ks kt ku ma kw kx ky mb la lb lc im bi translated">你可以设置GitHub action/ Azure DevOps管道代码，对于你的基础设施管道，推荐的方法是添加一个服务主体来验证Azure，添加额外的步骤，如Lint、Validate、代码扫描等。用于生产环境。以下是terraform基础架构部署的基本作业设置。</p><figure class="my mz na nb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi on"><img src="../Images/fb2679c5980540757a38173b97353123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pAidWQZiJqCs0OMbt9QoFg.png"/></div></div></figure><p id="3779" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">部署完成后，您可以在Azure门户中看到下面的一组资源</p><figure class="my mz na nb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oo"><img src="../Images/3381b1f94b7c5cb7fd975c60ac53b54c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CCFyz0VyrEK4F-raRLtrlA.png"/></div></div></figure><figure class="my mz na nb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi op"><img src="../Images/f1d038a18b6768fbe91cbb2986d96ff6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hKkUs6TQaJNHfg8W5quuQg.png"/></div></div></figure><h2 id="c613" class="le lf it bd lg lh li dn lj lk ll dp lm kq ln lo lp ku lq lr ls ky lt lu lv lw bi translated">部署网络应用</h2><figure class="my mz na nb gt ju gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/f1c45a985e439559fe68a472014770cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:874/format:webp/1*FYDy0KqmHQDMokWgfLdQgw.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Web应用蓝/绿部署模型</figcaption></figure><p id="5943" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">您可以设置管道，将应用程序部署到蓝色插槽，然后部署到生产插槽。我在这里没有完全涵盖管道代码，下面的YAML代码片段显示了如何部署到蓝色插槽，然后切换到生产插槽:</p><pre class="my mz na nb gt or os ot ou aw ov bi"><span id="a8cd" class="le lf it os b gy ow ox l oy oz">- task: AzureWebAppContainer@1<br/>  inputs:<br/>    azureSubscription: '&lt;Azure service connection&gt;'<br/>    appName: '&lt;Name of the web app&gt;'<br/>    containers: $(containerRegistry)/$(imageRepository):$(tag)<br/>    deployToSlotOrASE: true<br/>    resourceGroupName: '&lt;Name of the resource group&gt;'<br/>    slotName: blue</span><span id="4f4b" class="le lf it os b gy pa ox l oy oz">- task: AzureAppServiceManage@0<br/>  inputs:<br/>    azureSubscription: '&lt;Azure service connection&gt;'<br/>    WebAppName: '&lt;name of web app&gt;'<br/>    ResourceGroupName: '&lt;name of resource group&gt;'<br/>    SourceSlot: blue<br/>    SwapWithProduction: true</span></pre><p id="f40f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在task1和task2之间，您可以设置您的自动化脚本，以在部署到生产插槽之前，点击运行状况检查端点或集成测试，以确认应用程序正在暂存插槽中工作。</p><p id="f1e2" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">一旦蓝色插槽与<code class="fe pb pc pd os b">https://&lt;name-of-app-service&gt;-blue.azurewebsites.net</code>和随后的绿色<code class="fe pb pc pd os b">https://&lt;name-of-app-service&gt;.azurewebsites.net</code>一起激活，您就可以点击您的端点</p><p id="e36a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">有关管道设置的更多信息，请参考<a class="ae ld" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/apps/cd/deploy-docker-webapp?view=azure-devops&amp;tabs=java%2Cyaml" rel="noopener ugc nofollow" target="_blank">将容器化的应用程序部署到Linux上的应用程序服务—Azure Pipelines | Microsoft Docs</a>。</p><h1 id="a0b7" class="nw lf it bd lg nx ny nz lj oa ob oc lm od oe of lp og oh oi ls oj ok ol lv om bi translated">结论</h1><p id="e663" class="pw-post-body-paragraph kf kg it kh b ki lx kk kl km ly ko kp kq lz ks kt ku ma kw kx ky mb la lb lc im bi translated">在将应用程序部署到Azure时，您可以使用具有<strong class="kh iu">蓝/绿部署插槽</strong>的应用程序服务<strong class="kh iu"> Terraform </strong>实现高可用性应用程序。</p><p id="c7ea" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">您可以根据自己的需求选择不同的<strong class="kh iu">管道</strong>,在生产环境中，您将期望在自动化测试的预发布环境中实现零停机。</p><p id="1262" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这是一个基本的例子，所以在您的生产场景中，您需要在切换到绿色插槽之前对蓝色插槽运行全面的自动化测试。</p><p id="ab2c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如有任何疑问，您可以通过Rollend Xavier | LinkedIn 联系我，我很乐意与您联系😀</p></div></div>    
</body>
</html>