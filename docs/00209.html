<html>
<head>
<title>Kubernetes Monitoring 101 — Core pipeline &amp; Services Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes监控101 —核心管道和服务管道</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/kubernetes-monitoring-101-core-pipeline-services-pipeline-a34cd4cc9627?source=collection_archive---------1-----------------------#2018-09-10">https://levelup.gitconnected.com/kubernetes-monitoring-101-core-pipeline-services-pipeline-a34cd4cc9627?source=collection_archive---------1-----------------------#2018-09-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c178" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解Kubernetes监控管道对于帮助您诊断运行时问题以及管理<a class="ae kl" href="https://pxlme.me/nboBkliX" rel="noopener ugc nofollow" target="_blank">pod</a>和集群的规模至关重要。监控是Kubernetes内部发展非常迅速的领域之一。它有许多作品仍然在流入，因此有些混乱。我希望在这篇文章中，我的目标是澄清这一点，并给你一个良好的开端。</p><p id="e11c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes有两个监控管道:(1) <strong class="jp ir">核心指标管道</strong>，它是Kubernetes不可或缺的一部分，并且总是与所有发行版一起安装，以及(2) <strong class="jp ir">服务监控(非核心)管道</strong>，它是一个独立的管道，Kubernetes对其没有依赖或依赖有限。继续阅读了解原因:)</p><h1 id="56ae" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">核心监控管道</h1><p id="74aa" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">有时被称为<a class="ae kl" href="https://pxlme.me/6GomlbWB" rel="noopener ugc nofollow" target="_blank">资源度量管道</a>。每个发行版都安装了核心监视管道。它为Kubernetes集群中的其他组件提供了足够的细节，以便按预期运行，例如分配pod和容器的调度程序、HPA和VPA，以便做出适当的决定来扩展pod。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/69eb52478cb69662aa279598e670ba67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8JxjlAhc7mEw-c26zQIpsw.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">核心监控管道的工作流程</figcaption></figure><p id="f548" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它的工作方式相对简单:</p><ol class=""><li id="93fb" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated">CAdvisor收集关于安装它的容器和节点的指标。注意:默认情况下，CAdvisor安装在所有集群节点上</li><li id="8493" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">Kubelet通过Kubelet APIs公开这些指标(默认为一分钟的分辨率)。</li><li id="e766" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">Metrics Server发现所有可用的节点，并调用Kubelet API来获取容器和节点资源的使用情况。</li><li id="81ad" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">度量服务器通过Kubernetes聚合API公开这些度量。</li></ol><p id="40c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">几个有用的点</strong></p><ul class=""><li id="4a41" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mt ml mm mn bi translated">库伯莱不能在没有护卫的情况下跑步。如果您尝试卸载或停止它，群集的行为将变得不可预测。</li><li id="5680" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mt ml mm mn bi translated">尽管Heapster“即将被弃用”目前依赖于CAdvisor，但CAdvisor不会很快消失。</li></ul><h1 id="4136" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">服务监控渠道</h1><p id="11d5" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">抽象的服务管道相对简单。混乱通常来自于过多的服务和代理，您可以混合和匹配它们来启动和运行您的管道。同样，你可以责怪Heapster:)</p><p id="6c5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务监视管道由三个主要组件组成:(1)收集代理，(2)度量服务器，以及(3)仪表板。我不会谈论警报，因为它有许多有趣的变化:)我计划在另一篇文章中讨论警报。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/5c86640fc77361b9637633726ef7cb9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AbZg3OPWAuHuJNonhj7Euw.jpeg"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">服务监控管道的典型工作流</figcaption></figure><p id="308b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是典型的工作流程，包括最常见的组件</p><ol class=""><li id="e66d" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated">监控代理收集节点指标。cAdvisor收集容器和pod指标。</li><li id="df26" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">监控聚合服务从其自己的代理和cAdvisor收集数据。</li><li id="5d62" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">数据存储在监控系统的存储器中。</li><li id="5703" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">监控聚合服务通过API和仪表板公开指标。</li></ol><p id="ad47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">几个注意事项:</strong></p><ul class=""><li id="4126" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mt ml mm mn bi translated"><a class="ae kl" href="https://pxlme.me/Cr_NFw-N" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>是由CNCF发起并孵化的官方监控服务器。它<a class="ae kl" href="https://pxlme.me/D4f1AwHn" rel="noopener ugc nofollow" target="_blank">直接与cAdvisor </a>集成。您不需要安装第三方代理来检索有关容器的其他指标。但是，如果您需要更深入地了解每个节点，您需要安装自己选择的代理——参见<a class="ae kl" href="https://pxlme.me/OX7__rQz" rel="noopener ugc nofollow" target="_blank"> Prometheus集成和第三方出口商页面。</a></li><li id="44ec" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mt ml mm mn bi translated">几乎所有的监控系统都依赖于Kubernetes的调度和编排。例如，它们的代理作为DeomonSets安装，并依赖Kubernetes scheduler在每个节点上调度一个实例。</li><li id="568d" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mt ml mm mn bi translated">大多数监控代理依靠Kubelet来收集与容器相关的指标，而这些指标又依赖于cAdvisor。很少有代理商独立收集集装箱相关的详细信息。</li><li id="e859" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mt ml mm mn bi translated">大多数监控聚合服务依赖于代理向它们推送指标。普罗米修斯是个例外。它从已安装的代理中提取指标。</li></ul><h1 id="1dc6" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">在Kubernetes服务渠道中，您应该考虑什么？</h1><p id="fee7" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">理想的服务管道取决于两个主要因素:(1)收集相关指标，(2)了解kubernetes集群内部的持续变化。</p><p id="0eef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个好的管道应该专注于收集相关的指标。有很多代理可以收集操作系统和流程级的指标。但是您会发现很少有人能够收集在给定节点上运行的容器的详细信息，比如运行容器的数量、容器状态、docker引擎指标等。到目前为止，cAdvisor是这项工作的最佳代理人。</p><p id="6230" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对连续变化的感知意味着监控管道知道不同的pod、容器实例，并且可以将它们与它们的父实体相关联，即部署、状态集、名称空间等。这还意味着指标服务器知道用户应该可以看到的系统范围的指标，例如待定pod的数量、节点状态等。</p><h1 id="8c10" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">度量可视化怎么样？</h1><p id="bc19" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">您可以用许多不同的方式来可视化指标。最容易与Prometheus集成的开源工具是<a class="ae kl" href="https://prometheus.io/docs/visualization/grafana/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>。然而，您将面临的挑战是构建合适的仪表板来监控正确的指标。也就是说，您应该让仪表板监控以下内容:</p><ul class=""><li id="f4f4" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mt ml mm mn bi translated"><strong class="jp ir">集群级容量利用率</strong>，这显示了整个集群和每个节点有多少CPU内存。</li><li id="a482" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mt ml mm mn bi translated"><strong class="jp ir">Kubernetes Orchestration Metrics</strong>，它跟踪集群中的pod和容器的状态。这包括pod在节点之间的分布。</li><li id="b9d0" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mt ml mm mn bi translated"><strong class="jp ir"> Kubernetes核心服务</strong>，可视化关键服务的状态，如CoreDNS、Calico和任何其他对网络、存储和pod调度重要的服务。</li><li id="675c" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mt ml mm mn bi translated">特定于应用程序的指标，用于跟踪应用程序的状态。它们应该反映用户的体验和业务关键指标。</li></ul><p id="b376" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意</strong>:你可以从<a class="ae kl" href="https://pxlme.me/9wR_GkOT" rel="noopener ugc nofollow" target="_blank">这个用于Kubernetes的Grafana模板仪表盘</a>开始。</p><blockquote class="mu mv mw"><p id="d676" class="jn jo mx jp b jq jr js jt ju jv jw jx my jz ka kb mz kd ke kf na kh ki kj kk ij bi translated">格拉夫纳不太适合警戒。我看到许多团队依靠它来创建警报规则。但是，它不如普罗米修斯警报管理器可靠和全面。</p></blockquote><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h1 id="4ade" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">要注意的变化</h1><h2 id="3143" class="nd kn iq bd ko ne nf dn ks ng nh dp kw jy ni nj la kc nk nl le kg nm nn li no bi translated">希普斯特要走了</h2><p id="2ff8" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">Heapster目前引起了一些混乱，因为它同时用于显示核心管道指标和服务指标。实际上，您可以删除Heapster，核心的Kubernetes调度和编排场景不会出现任何问题。它是默认的监控管道，我猜它仍然是许多发行版的默认管道。但是你根本不用。</p><p id="f473" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，Kubernetes社区希望让核心和服务监控管道之间的分离更加清晰。因此，Heapster将被弃用，并被Metrics Server (MS)取代，成为聚合核心指标的主要来源。可以把MS看作是Heapster的精简版。主要的直接变化是:(1)没有历史数据或查询，(2)消除了许多特定于容器的指标，只有pod焦点指标。Metrics Server旨在提供核心Kubernetes场景所需的核心指标，如自动缩放、调度等。，可能会在2019年发布。</p><h2 id="5b17" class="nd kn iq bd ko ne nf dn ks ng nh dp kw jy ni nj la kc nk nl le kg nm nn li no bi translated">度量服务器将获得更多的酷功能</h2><p id="72b7" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">Infrastore将存储Metric Server历史数据，并支持简单的类似SQL的查询。它最初将支持由指标服务器收集的指标。我猜，因为Kubernetes社区喜欢可扩展性，他们将使其可扩展，并允许将自定义指标添加到指标服务器及其存储中。</p><h1 id="da39" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">TL；速度三角形定位法(dead reckoning)</h1><ul class=""><li id="8f81" class="mf mg iq jp b jq lk ju ll jy np kc nq kg nr kk mt ml mm mn bi translated">您需要区分核心度量管道和服务管道。</li><li id="50ad" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mt ml mm mn bi translated">Heapster将被弃用。您应该选择最适合您需求的管道。</li><li id="ad92" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mt ml mm mn bi translated">社区官方工具是普罗米修斯。您可以使用各种其他开源或商业工具，但是我建议您在决定使用其他可能会让您付出很大代价的工具之前，先开始使用Prometheus。</li><li id="edc2" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mt ml mm mn bi translated">使用<a class="ae kl" href="https://pxlme.me/dRJpGP5G" rel="noopener ugc nofollow" target="_blank"> Grafana进行指标可视化</a>。但我不建议用它来报警。</li></ul></div></div>    
</body>
</html>