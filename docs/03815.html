<html>
<head>
<title>Auto-scale Kafka applications on Kubernetes with KEDA</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">KEDA在Kubernetes上的自动缩放卡夫卡应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/auto-scale-kafka-applications-on-kubernetes-with-keda-6fde6aef9d80?source=collection_archive---------2-----------------------#2020-05-28">https://levelup.gitconnected.com/auto-scale-kafka-applications-on-kubernetes-with-keda-6fde6aef9d80?source=collection_archive---------2-----------------------#2020-05-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2b4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本教程将使用代表<code class="fe kl km kn ko b">Kubernetes-based Event Driven Autoscaler</code>的<code class="fe kl km kn ko b"><a class="ae kp" href="https://keda.sh/" rel="noopener ugc nofollow" target="_blank">KEDA</a></code>演示Kubernetes上基于Kafka的消费应用程序的自动缩放</p><blockquote class="kq kr ks"><p id="e6ef" class="jn jo kt jp b jq jr js jt ju jv jw jx ku jz ka kb kv kd ke kf kw kh ki kj kk ij bi translated"><code class="fe kl km kn ko b"><a class="ae kp" href="https://cloudblogs.microsoft.com/opensource/2020/04/06/kubernetes-event-driven-autoscaling-keda-cncf-sandbox-project/" rel="noopener ugc nofollow" target="_blank"><em class="iq">KEDA</em></a></code> <a class="ae kp" href="https://cloudblogs.microsoft.com/opensource/2020/04/06/kubernetes-event-driven-autoscaling-keda-cncf-sandbox-project/" rel="noopener ugc nofollow" target="_blank"> <em class="iq">目前是CNCF沙盒项目</em> </a></p></blockquote><p id="6c71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kl km kn ko b"><em class="kt">KEDA</em></code> <em class="kt">可以根据需要处理的事件数量驱动Kubernetes中任何容器的伸缩。它是一个单一用途的轻量级组件，可以添加到任何Kubernetes集群中。KEDA与标准Kubernetes组件一起工作，如水平Pod自动缩放器，可以扩展功能而无需覆盖或复制。</em></p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi kx"><img src="../Images/6aa3b0872292caef6a17e4da9bb6b549.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Dd__VQY7gADfGlmB.png"/></div></div></figure><p id="c686" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它有一个<a class="ae kp" href="https://keda.sh/scalers/apache-kafka/" rel="noopener ugc nofollow" target="_blank">内置的Kafka缩放器</a>，可以自动缩放您的Kafka消费应用程序(传统的消费应用程序，Kafka流等)。)基于消费者补偿滞后。我将使用Azure Event Hubs作为Kafka broker(尽管这些概念适用于任何Kafka集群)，并为Kubernetes集群使用Azure Kubernetes服务(请随意使用其他服务，如<code class="fe kl km kn ko b">minikube</code>)</p><blockquote class="kq kr ks"><p id="0fc4" class="jn jo kt jp b jq jr js jt ju jv jw jx ku jz ka kb kv kd ke kf kw kh ki kj kk ij bi translated"><em class="iq">代码在</em>T5上可用</p></blockquote><p id="c2d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将经历以下内容:</p><ul class=""><li id="c949" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">快速概览</li><li id="518b" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">应用程序和KEDA配置(主要是YAMLs！说实话)</li><li id="3a0d" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">如何设置KEDA和所需的Azure服务</li><li id="9522" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">部署解决方案并观察自动扩展的效果</li></ul></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="6486" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">概观</h1><p id="d29b" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">以下是关键组件:</p><ul class=""><li id="0b25" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated"><a class="ae kp" href="https://github.com/abhirockzz/keda-eventhubs-kafka/tree/master/producer" rel="noopener ugc nofollow" target="_blank"> Producer app </a>:这是一个简单的Go app，向Kafka生成模拟的JSON数据。它使用了<code class="fe kl km kn ko b"><a class="ae kp" href="https://github.com/Shopify/sarama" rel="noopener ugc nofollow" target="_blank">sarama</a></code> <a class="ae kp" href="https://github.com/Shopify/sarama" rel="noopener ugc nofollow" target="_blank">库</a>。您可以将它作为Docker容器运行，也可以直接作为Go应用程序运行(详情见下一节)</li><li id="8c6a" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><a class="ae kp" href="https://github.com/abhirockzz/keda-eventhubs-kafka/tree/master/consumer" rel="noopener ugc nofollow" target="_blank">消费app </a>:这是另一款消费Kafka数据的Go app。为了增加一点多样性，它使用了<a class="ae kp" href="https://github.com/confluentinc/confluent-kafka-go" rel="noopener ugc nofollow" target="_blank">confuent Go Kafka客户端</a>。你将作为一名Kubernetes <code class="fe kl km kn ko b">Deployment</code>(详情见下一节)</li><li id="a63e" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><code class="fe kl km kn ko b">KEDA</code> <code class="fe kl km kn ko b">ScaledObject</code>(它定义了基于Kafka的自动缩放标准)和其他支持清单</li></ul></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="04f2" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">先决条件</h1><p id="7290" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated"><code class="fe kl km kn ko b">kubectl</code>-<a class="ae kp" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></p><p id="1532" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你选择使用Azure Event Hubs、Azure Kubernetes服务(或者两者都用)，你将需要一个<a class="ae kp" href="https://docs.microsoft.com/azure/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">微软Azure账户</a>。去报名参加一个免费的吧！</p><p id="72f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将使用<code class="fe kl km kn ko b">Helm</code>安装<code class="fe kl km kn ko b">KEDA</code>。这是安装<code class="fe kl km kn ko b">Helm</code>-<a class="ae kp" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank">https://helm.sh/docs/intro/install/</a>的文件</p><blockquote class="kq kr ks"><p id="ab0b" class="jn jo kt jp b jq jr js jt ju jv jw jx ku jz ka kb kv kd ke kf kw kh ki kj kk ij bi translated"><em class="iq">对于替代方式(</em> <code class="fe kl km kn ko b"><em class="iq">Operator Hub</em></code> <em class="iq">或YAML文件)的</em><code class="fe kl km kn ko b"><em class="iq">KEDA</em></code><em class="iq"/><a class="ae kp" href="https://keda.sh/docs/deploy/" rel="noopener ugc nofollow" target="_blank"><em class="iq">看一下文档</em> </a></p></blockquote><p id="d7a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是如何设置所需的Azure服务。</p><blockquote class="kq kr ks"><p id="4a9f" class="jn jo kt jp b jq jr js jt ju jv jw jx ku jz ka kb kv kd ke kf kw kh ki kj kk ij bi translated"><em class="iq">我建议将以下服务作为单个</em> <a class="ae kp" href="https://docs.microsoft.com/azure/azure-resource-manager/management/overview?WT.mc_id=medium-blog-abhishgu#resource-groups" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Azure资源组</em> </a> <em class="iq">的一部分安装，这样可以很容易地清理这些服务</em></p></blockquote><h2 id="e2cd" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">Azure活动中心</h2><p id="0aa9" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated"><a class="ae kp" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-about?%5BWT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Event Hubs </a>是一个数据流平台和事件摄取服务。它每秒可以接收和处理数百万个事件。<a class="ae kp" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-for-kafka-ecosystem-overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">它还提供了一个Kafka端点</a>，现有的基于Kafka的应用程序可以使用它来运行自己的Kafka集群。Event Hubs支持Apache Kafka protocol 1.0和更高版本，并与Kafka生态系统中现有的Kafka客户端应用程序和其他工具一起工作，包括<code class="fe kl km kn ko b">Kafka Connect</code>(在本博客中演示过)<code class="fe kl km kn ko b">MirrorMaker</code>等。</p><p id="77de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要设置Azure Event Hubs集群，你可以从各种选项中进行选择，包括<a class="ae kp" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-create?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">Azure门户</a>、<a class="ae kp" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-quickstart-cli?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>、<a class="ae kp" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-quickstart-powershell?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure PowerShell </a>或<a class="ae kp" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-resource-manager-namespace-event-hub?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">ARM模板</a>。一旦设置完成，您将需要连接字符串(将在后续步骤中使用)用于<a class="ae kp" href="https://docs.microsoft.com/azure/event-hubs/authenticate-shared-access-signature?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">认证到事件中心</a> — <a class="ae kp" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-get-connection-string?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">使用本指南</a>完成此步骤。</p><blockquote class="kq kr ks"><p id="18c3" class="jn jo kt jp b jq jr js jt ju jv jw jx ku jz ka kb kv kd ke kf kw kh ki kj kk ij bi translated"><em class="iq">请确保您还创建了一个活动中心(Kafka主题),我们可以向其发送数据或从其接收数据</em></p></blockquote><h2 id="c815" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">蓝色库伯内特服务</h2><p id="c3ff" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated"><a class="ae kp" href="https://docs.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Kubernetes服务(AKS) </a>让在Azure中部署托管的Kubernetes集群变得简单。它通过将大部分责任转移给Azure，降低了管理Kubernetes的复杂性和运营开销。以下是如何使用<a class="ae kp" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>、<a class="ae kp" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-portal?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure portal </a>或<a class="ae kp" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-rm-template?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> ARM模板</a>建立AKS集群的示例</p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="6a56" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">安装KEDA</h1><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="f5fd" class="nh mf iq ko b gy nx ny l nz oa">helm repo add kedacore https://kedacore.github.io/charts<br/>helm repo update</span><span id="1851" class="nh mf iq ko b gy ob ny l nz oa">kubectl create namespace keda<br/>helm install keda kedacore/keda --namespace keda</span></pre><p id="113f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将安装KEDA算子和KEDA度量API服务器(作为单独的<code class="fe kl km kn ko b">Deployment</code>)</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="cbc4" class="nh mf iq ko b gy nx ny l nz oa">kubectl get deployment -n keda</span><span id="28df" class="nh mf iq ko b gy ob ny l nz oa">NAME                              READY   UP-TO-DATE   AVAILABLE   AGE<br/>keda-operator                     1/1     1            1           1h<br/>keda-operator-metrics-apiserver   1/1     1            1           1h</span></pre><p id="4a99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查KEDA操作员日志</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="a840" class="nh mf iq ko b gy nx ny l nz oa">kubectl logs -f $(kubectl get pod -l=app=keda-operator -o jsonpath='{.items[0].metadata.name}' -n keda) -n keda</span></pre></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="6215" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">YAML时间！</h1><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/c3afe4659a9892c94ff4fff1becfb59b.png" data-original-src="https://miro.medium.com/v2/resize:fit:372/0*FmXXmmRMxuFq1l0v.gif"/></div></figure><p id="b513" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们享受反省一些错误的过程吧！</p><h2 id="bd5d" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">Kubernetes <code class="fe kl km kn ko b">Secret</code></h2><p id="a7c0" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">我们使用一个<code class="fe kl km kn ko b">Secret</code>来存储活动中心的连接细节。很快会有更多的报道...</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="5520" class="nh mf iq ko b gy nx ny l nz oa">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: eventhub-kafka-credentials<br/>data:<br/>  authMode: &lt;BASE64_AUTH_MODE&gt;<br/>  username: &lt;BASE64_EVENTHUBS_USERNAME&gt;<br/>  password: &lt;BASE64_EVENTHUBS_CONNECTION_STRING&gt;</span></pre><h2 id="4be6" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated"><code class="fe kl km kn ko b">ScaledObject</code></h2><p id="c077" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">一个<code class="fe kl km kn ko b"><a class="ae kp" href="https://keda.sh/docs/concepts/scaling-deployments/#scaledobject-spec" rel="noopener ugc nofollow" target="_blank">ScaledObject</a></code>为<a class="ae kp" href="https://keda.sh/scalers/apache-kafka/#trigger-specification" rel="noopener ugc nofollow" target="_blank"> KEDA卡夫卡定标器</a></p><p id="6c8c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意以下参考资料:</p><ul class=""><li id="ae2a" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated"><code class="fe kl km kn ko b">spec.scaleTargetRef.deploymentName</code>指向需要缩放的<code class="fe kl km kn ko b">Deployment</code>的名称</li><li id="fc5d" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><code class="fe kl km kn ko b">spec.triggers.authenticationRef</code>指向一个<code class="fe kl km kn ko b"><a class="ae kp" href="https://keda.sh/docs/concepts/authentication/#re-use-credentials-and-delegate-auth-with-triggerauthentication" rel="noopener ugc nofollow" target="_blank">TriggerAuthentication</a></code></li></ul><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="d75b" class="nh mf iq ko b gy nx ny l nz oa">apiVersion: keda.k8s.io/v1alpha1<br/>kind: ScaledObject<br/>metadata:<br/>  name: kafka-scaledobject<br/>  namespace: default<br/>  labels:<br/>    deploymentName: kafka-consumer<br/>spec:<br/>  scaleTargetRef:<br/>    deploymentName: kafka-consumer<br/>  pollingInterval: 15<br/>  cooldownPeriod: 100<br/>  maxReplicaCount: 10<br/>  triggers:<br/>    - type: kafka<br/>      metadata:<br/>        bootstrapServers: &lt;EVENTHUBS_NAMESPACE&gt;.servicebus.windows.net:9093<br/>        consumerGroup: &lt;EVENTHUB_CONSUMER_GROUP&gt;<br/>        topic: &lt;EVENTHUB_TOPIC_NAME&gt;<br/>        lagThreshold: "10"<br/>      authenticationRef:<br/>        name: eventhub-kafka-triggerauth</span></pre><h2 id="ffb3" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">消费者<code class="fe kl km kn ko b">Deployment</code></h2><p id="2cfb" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">Kafka消费者应用程序作为Kubernetes部署运行</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="69b0" class="nh mf iq ko b gy nx ny l nz oa">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: kafka-consumer<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: kafka-consumer<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: kafka-consumer<br/>    spec:<br/>      containers:<br/>        - name: kafka-consumer<br/>          image: abhirockzz/kafka-consumer<br/>          imagePullPolicy: IfNotPresent<br/>          env:<br/>            - name: KAFKA_EVENTHUB_PASSWORD<br/>              valueFrom:<br/>                secretKeyRef:<br/>                  name: eventhub-kafka-credentials<br/>                  key: password<br/>            - name: KAFKA_EVENTHUB_ENDPOINT<br/>              value: &lt;EVENTHUBS_NAMESPACE&gt;.windows.net:9093<br/>            - name: KAFKA_EVENTHUB_CONSUMER_GROUP<br/>              value: $Default<br/>            - name: KAFKA_EVENTHUB_TOPIC<br/>              value: &lt;EVENTHUB_TOPIC_NAME&gt;</span></pre><p id="fbeb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看<code class="fe kl km kn ko b">TriggerAuthentication</code>长什么样</p><h2 id="9a6e" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated"><code class="fe kl km kn ko b">TriggerAuthentication</code></h2><p id="a046" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">指的是之前描述过的<code class="fe kl km kn ko b">Secret</code>(名为<code class="fe kl km kn ko b">eventhub-kafka-credentials</code>)</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="349a" class="nh mf iq ko b gy nx ny l nz oa">apiVersion: keda.k8s.io/v1alpha1<br/>kind: TriggerAuthentication<br/>metadata:<br/>  name: eventhub-kafka-triggerauth<br/>spec:<br/>  secretTargetRef:<br/>    - parameter: authMode<br/>      name: eventhub-kafka-credentials<br/>      key: authMode<br/>    - parameter: username<br/>      name: eventhub-kafka-credentials<br/>      key: username<br/>    - parameter: password<br/>      name: eventhub-kafka-credentials<br/>      key: password</span></pre></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="ad96" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">部署</h1><p id="ee61" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">是时候看看实际情况了</p><p id="66bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从克隆<code class="fe kl km kn ko b">Git</code>回购开始:</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="f96f" class="nh mf iq ko b gy nx ny l nz oa">git clone <a class="ae kp" href="https://github.com/abhirockzz/keda-eventhubs-kafka" rel="noopener ugc nofollow" target="_blank">https://github.com/abhirockzz/keda-eventhubs-kafka</a></span></pre><p id="b7d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将为您的事件中心实例部署包含连接字符串的<code class="fe kl km kn ko b">Secret</code>。更新文件<code class="fe kl km kn ko b"><a class="ae kp" href="https://github.com/abhirockzz/keda-eventhubs-kafka/blob/master/deploy/1-secret.yaml" rel="noopener ugc nofollow" target="_blank">deploy/1-secret.yaml</a></code>，其中<code class="fe kl km kn ko b">password</code>属性包含事件中心连接字符串的base64编码值，例如<code class="fe kl km kn ko b">echo -n '&lt;eventhubs-connection-string&gt;' | base64</code></p><blockquote class="kq kr ks"><p id="c074" class="jn jo kt jp b jq jr js jt ju jv jw jx ku jz ka kb kv kd ke kf kw kh ki kj kk ij bi translated"><em class="iq">无需更改</em><code class="fe kl km kn ko b"><em class="iq">username</em></code><em class="iq"/><code class="fe kl km kn ko b"><em class="iq">authMode</em></code><em class="iq">。它们分别只是</em> <code class="fe kl km kn ko b"><em class="iq">$ConnectionString</em></code> <em class="iq">和</em> <code class="fe kl km kn ko b"><em class="iq">sasl_plain</em></code> <em class="iq">的base64版本</em></p></blockquote><p id="a65f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">展开<code class="fe kl km kn ko b">Secret</code></p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="e96d" class="nh mf iq ko b gy nx ny l nz oa">kubectl apply -f deploy/1-secret.yaml</span></pre><p id="3779" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更新文件<code class="fe kl km kn ko b"><a class="ae kp" href="https://github.com/abhirockzz/keda-eventhubs-kafka/blob/master/deploy/3-consumer.yaml" rel="noopener ugc nofollow" target="_blank">deploy/3-consumer.yaml</a></code>。检查属于<code class="fe kl km kn ko b">spec.containers.env</code>一部分的下列参考资料</p><ul class=""><li id="57a8" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated"><code class="fe kl km kn ko b">KAFKA_EVENTHUB_ENDPOINT</code> -事件中心名称空间的名称</li><li id="5301" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><code class="fe kl km kn ko b">KAFKA_EVENTHUB_TOPIC</code> -活动中心主题的名称</li></ul><p id="f8bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="7af6" class="nh mf iq ko b gy nx ny l nz oa">env:<br/>            - name: KAFKA_EVENTHUB_PASSWORD<br/>              valueFrom:<br/>                secretKeyRef:<br/>                  name: eventhub-kafka-credentials<br/>                  key: password<br/>            - name: KAFKA_EVENTHUB_ENDPOINT<br/>              value: my-eventhub.windows.net:9093<br/>            - name: KAFKA_EVENTHUB_CONSUMER_GROUP<br/>              value: $Default<br/>            - name: KAFKA_EVENTHUB_TOPIC<br/>              value: test-topic</span></pre><p id="3849" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建消费者应用程序<code class="fe kl km kn ko b">Deployment</code></p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="39f4" class="nh mf iq ko b gy nx ny l nz oa">kubectl apply -f deploy/3-consumer.yaml</span></pre><p id="ebaf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会看到消费者应用程序很快投入运行(<code class="fe kl km kn ko b">Running</code>状态)</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="b315" class="nh mf iq ko b gy nx ny l nz oa">kubectl get pods -w</span></pre><blockquote class="kq kr ks"><p id="663a" class="jn jo kt jp b jq jr js jt ju jv jw jx ku jz ka kb kv kd ke kf kw kh ki kj kk ij bi translated"><em class="iq">您可以使用</em> <code class="fe kl km kn ko b"><em class="iq">kubectl logs -f $(kubectl get pod -l=app=kafka-consumer -o jsonpath='{.items[0].metadata.name}')</em></code>查看消费者应用日志</p></blockquote><p id="0319" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建<code class="fe kl km kn ko b">TriggerAuthentication</code>，后跟<code class="fe kl km kn ko b">ScaledObject</code></p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="4c7e" class="nh mf iq ko b gy nx ny l nz oa">kubectl apply -f deploy/2-trigger-auth.yaml<br/>kubectl apply -f deploy/4-kafka-scaledobject.yaml</span></pre><blockquote class="kq kr ks"><p id="e663" class="jn jo kt jp b jq jr js jt ju jv jw jx ku jz ka kb kv kd ke kf kw kh ki kj kk ij bi translated"><em class="iq">再次检查KEDA操作员日志——您应该看到它对刚刚创建了</em> <code class="fe kl km kn ko b"><em class="iq">ScaledObject</em></code> <em class="iq">这一事实做出了反应</em></p></blockquote><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="70f3" class="nh mf iq ko b gy nx ny l nz oa">kubectl logs -f $(kubectl get pod -l=app=keda-operator -o jsonpath='{.items[0].metadata.name}' -n keda) -n keda</span></pre><p id="aebd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查消费者<code class="fe kl km kn ko b">Pod</code> - <code class="fe kl km kn ko b">kubectl get pods</code>。您将看到现在没有<code class="fe kl km kn ko b">Pod</code>了——这是因为KEDA实际上将部署缩减到了零个实例。您也可以通过检查部署来确认这一点<code class="fe kl km kn ko b">kubectl get deployment/kafka-consumer</code></p><blockquote class="kq kr ks"><p id="0f1f" class="jn jo kt jp b jq jr js jt ju jv jw jx ku jz ka kb kv kd ke kf kw kh ki kj kk ij bi translated"><em class="iq">如果您想改变这种行为，例如，至少有一个部署实例正在运行，请将</em> <code class="fe kl km kn ko b"><em class="iq">minReplicaCount</em></code> <em class="iq">属性添加到</em> <code class="fe kl km kn ko b"><em class="iq">ScaledObject</em></code> <em class="iq">(默认为</em> <code class="fe kl km kn ko b"><em class="iq">0</em></code> <em class="iq"> ) </em></p></blockquote><p id="669c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从扩展的角度来看，KEDA负责:</p><ul class=""><li id="3b98" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">根据定标器报告的指标(在这种情况下是Kafka消费者滞后),将您的应用从0定标到1个实例</li><li id="2146" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">将你的应用从1实例扩展到0</li></ul><p id="eb7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其余的繁重工作(自动缩放)由水平Pod自动缩放器(HPA)(由KEDA操作符中的控制器循环创建)完成，这是内置于Kubernetes中的本地资源</p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="3cd9" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">试验</h1><p id="5ded" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">测试自动缩放的舞台已经准备好了。在一个终端，监视消费者<code class="fe kl km kn ko b">Deployment</code>资源</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="2151" class="nh mf iq ko b gy nx ny l nz oa">kubectl get deployment -w</span></pre><p id="6f03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为producer应用程序导出环境变量—输入<code class="fe kl km kn ko b">KAFKA_EVENTHUB_ENDPOINT</code>、<code class="fe kl km kn ko b">KAFKA_EVENTHUB_CONNECTION_STRING</code>和<code class="fe kl km kn ko b">KAFKA_EVENTHUB_TOPIC</code>的值</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="741f" class="nh mf iq ko b gy nx ny l nz oa">export KAFKA_EVENTHUB_ENDPOINT=&lt;EVENTHUBS_NAMESPACE&gt;.servicebus.windows.net:9093</span><span id="f4f5" class="nh mf iq ko b gy ob ny l nz oa">export KAFKA_EVENTHUB_CONNECTION_STRING="Endpoint=sb://&lt;EVENTHUBS_NAMESPACE&gt;.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=&lt;&lt;EVENTHUBS_ACCESS_KEY&gt;"</span><span id="b7b0" class="nh mf iq ko b gy ob ny l nz oa">export KAFKA_EVENTHUB_TOPIC=&lt;TOPIC_NAME&gt;</span><span id="b858" class="nh mf iq ko b gy ob ny l nz oa">export KAFKA_EVENTHUB_USERNAME="\$ConnectionString"</span></pre><p id="97c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">构建并运行生成器应用程序</p><blockquote class="kq kr ks"><p id="0cd0" class="jn jo kt jp b jq jr js jt ju jv jw jx ku jz ka kb kv kd ke kf kw kh ki kj kk ij bi translated"><em class="iq">安装了Go ( </em> <code class="fe kl km kn ko b"><em class="iq">1.13</em></code> <em class="iq">或以上)也可以直接运行Go app-</em><code class="fe kl km kn ko b"><em class="iq">cd producer &amp;&amp; go run main.go</em></code></p></blockquote><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="ca17" class="nh mf iq ko b gy nx ny l nz oa">docker build -t producer-app producer</span><span id="d77f" class="nh mf iq ko b gy ob ny l nz oa">docker run --rm -e KAFKA_EVENTHUB_ENDPOINT=$KAFKA_EVENTHUB_ENDPOINT -e KAFKA_EVENTHUB_CONNECTION_STRING=$KAFKA_EVENTHUB_CONNECTION_STRING -e KAFKA_EVENTHUB_TOPIC=$KAFKA_EVENTHUB_TOPIC -e KAFKA_EVENTHUB_USERNAME=$KAFKA_EVENTHUB_USERNAME producer-app</span></pre><p id="0420" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将开始生成消息，您应该会看到类似以下内容的日志:</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="3fb9" class="nh mf iq ko b gy nx ny l nz oa">Event Hubs broker [&lt;EVENTHUBS_NAMESPACE&gt;.servicebus.windows.net:9093]<br/>Event Hubs topic keda-test<br/>Waiting for ctrl+c<br/>sent message {"time":"Mon Apr 27 09:21:38 2020"} to partition 1 offset 0<br/>sent message {"time":"Mon Apr 27 09:21:39 2020"} to partition 4 offset 0<br/>sent message {"time":"Mon Apr 27 09:21:40 2020"} to partition 2 offset 0<br/>sent message {"time":"Mon Apr 27 09:21:40 2020"} to partition 2 offset 1<br/>sent message {"time":"Mon Apr 27 09:21:41 2020"} to partition 2 offset 2<br/>sent message {"time":"Mon Apr 27 09:21:41 2020"} to partition 1 offset 1<br/>...</span></pre><p id="7dc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在另一个终端上，您应该看到您的应用程序随着部署中单元数量的增加而自动伸缩。</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="7384" class="nh mf iq ko b gy nx ny l nz oa">kafka-consumer   0/5   4     0     33s<br/>kafka-consumer   0/5   4     0     33s<br/>kafka-consumer   0/5   4     0     33s<br/>kafka-consumer   0/5   5     0     33s<br/>kafka-consumer   1/5   5     1     80s<br/>kafka-consumer   2/5   5     2     90s<br/>kafka-consumer   3/5   5     3     101s<br/>kafka-consumer   4/5   5     4     101s<br/>kafka-consumer   5/5   5     5     2m9s</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi od"><img src="../Images/b35c8724532c10110c252259548e35a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/0*-ViFP1caLfOeLsso.gif"/></div></figure><blockquote class="kq kr ks"><p id="6db6" class="jn jo kt jp b jq jr js jt ju jv jw jx ku jz ka kb kv kd ke kf kw kh ki kj kk ij bi translated"><em class="iq">请注意，</em> <code class="fe kl km kn ko b"><em class="iq">Pod</em></code> <em class="iq">的数量不会超过事件中心主题的分区数量。</em></p></blockquote><p id="3dc5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自置居所津贴也将反映同样的地位</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="4bc4" class="nh mf iq ko b gy nx ny l nz oa">kubectl get hpa/keda-hpa-kafka-consumer</span><span id="79e2" class="nh mf iq ko b gy ob ny l nz oa">NAME                      REFERENCE                   TARGETS       MINPODS   MAXPODS   REPLICAS   AGE<br/>keda-hpa-kafka-consumer   Deployment/kafka-consumer   10/10 (avg)   1         10        5          3m</span></pre><p id="e8b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您现在可以停止制作人应用程序。随着消息被消费(并且提交了偏移量)，消费者延迟将会持续减少。此时，实例的数量将逐渐减少到<code class="fe kl km kn ko b">0</code>。</p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="73c8" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">清理</h1><p id="74eb" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">对<a class="ae kp" href="https://keda.sh/docs/deploy/#uninstalling-keda" rel="noopener ugc nofollow" target="_blank">卸载</a> KEDA:</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="da12" class="nh mf iq ko b gy nx ny l nz oa">helm uninstall -n keda keda</span><span id="3cc9" class="nh mf iq ko b gy ob ny l nz oa">kubectl delete -f <a class="ae kp" href="https://raw.githubusercontent.com/kedacore/keda/master/deploy/crds/keda.k8s.io_scaledobjects_crd.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kedacore/keda/master/deploy/crds/keda.k8s.io_scaledobjects_crd.yaml</a></span><span id="44b3" class="nh mf iq ko b gy ob ny l nz oa">kubectl delete -f <a class="ae kp" href="https://raw.githubusercontent.com/kedacore/keda/master/deploy/crds/keda.k8s.io_triggerauthentications_crd.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kedacore/keda/master/deploy/crds/keda.k8s.io_triggerauthentications_crd.yaml</a></span></pre><p id="26e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要删除Azure服务，只需删除资源组:</p><pre class="ky kz la lb gt nt ko nu nv aw nw bi"><span id="dbc4" class="nh mf iq ko b gy nx ny l nz oa">az group delete --name &lt;AZURE_RESOURCE_GROUP&gt; --yes --no-wait</span></pre><p id="a649" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇关于使用KEDA自动扩展部署到Kubernetes的Kafka消费应用程序的博客到此结束！请加入并成为成长中的KEDA社区的一部分，详情请查看https://keda.sh/community/</p></div></div>    
</body>
</html>