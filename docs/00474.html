<html>
<head>
<title>How create-react-app fakes environment variables</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">create-react-app如何伪造环境变量</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-create-react-app-fakes-environment-variables-a08a9cb6e581?source=collection_archive---------1-----------------------#2019-03-22">https://levelup.gitconnected.com/how-create-react-app-fakes-environment-variables-a08a9cb6e581?source=collection_archive---------1-----------------------#2019-03-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="39c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在没有create-react-app的情况下编写React应用程序时，我被如何在web应用程序中使用环境变量所困扰，并且在我的构建过程中遇到了无数问题，之后我决定研究create-react-app的构建脚本是如何工作的以及它的所有魔力。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="3419" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可能很熟悉在服务器端代码中使用环境变量来根据运行环境提供不同的值。当开始开发web应用程序时，采用这种方法并开始将其放入您的web应用程序中并不罕见。</p><h1 id="b941" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">问题是</h1><p id="ebb4" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">简而言之，一个服务器可以有一组唯一的键和值。运行开发代码的服务器和运行生产代码的服务器可以拥有不同值的相同密钥，这意味着在不同服务器上运行的相同代码可以使用不同的值。</p><p id="7cc7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，node.js应用程序允许我们使用<code class="fe lv lw lx ly b">process.env</code>对象访问服务器环境。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/5f0ba6a78eba2af6f3f92f1b75440037.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*CAIRjlcrWtNxCkzwYid4JA.png"/></div></figure><p id="91bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不幸的是，这种基于环境变量的通用方法并不能很好地转化为静态web应用程序，即使是那些从流行的框架如React或Angular创建的应用程序。如果我们想在React应用程序中使用相同的方法来使用环境变量，会发生什么？</p><p id="2108" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于这个例子，我们使用CI服务器来捆绑我们的应用程序。让我们看看如何构建、部署使用相同NodeJS语法的web应用程序并将其提供给客户端。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/e1e79c25eccc1961ef00642544c4c062.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZLR7IUvsvPLhZQQ3tHgIww.png"/></div></div></figure><p id="be1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然静态web应用程序构建在具有所需环境变量的服务器上，但是当我们将应用程序提供给浏览器时，对这些变量的引用就丢失了。</p><h1 id="a002" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">解决方案</h1><p id="1577" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">但这是怎么回事呢？create-react-app文档本身说你可以这样使用环境变量(<a class="ae mm" href="https://facebook.github.io/create-react-app/docs/adding-custom-environment-variables" rel="noopener ugc nofollow" target="_blank">https://Facebook . github . io/create-react-app/docs/adding-custom-environment-variables</a>)。</p><figure class="ma mb mc md gt me"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="92e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">进一步阅读文档，您会发现环境变量只有在前缀为<code class="fe lv lw lx ly b">REACT_APP</code>时才有效。让我们对我们的假装演示进行更改:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mp"><img src="../Images/768bf98408edce854e3b74487eb35195.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2xNsgkoDzEb81ER6xijq5Q.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">突然，我们的控制台注销“1”。</figcaption></figure><p id="7fb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">create-react-app的构建脚本是否神奇地将NodeJS <code class="fe lv lw lx ly b">process</code>对象添加到了我们的web应用中？我们是否在窥视服务器的环境变量？神奇的<code class="fe lv lw lx ly b">REACT_APP</code>前缀是如何让一切运转的？</p><p id="3f9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">幸运的是，<code class="fe lv lw lx ly b">react-scripts</code>包是开源的，所以我们可以窥视其中的魔力。这样做，烟雾和镜像就清楚了，我们可以看到执行了什么样的技巧来让我们表现得好像我们可以访问构建服务器的环境变量。</p><p id="dd78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下脚本包含在create-react-app的Webpack配置(<a class="ae mm" href="https://github.com/facebook/create-react-app/tree/master/packages/react-scripts/config" rel="noopener ugc nofollow" target="_blank">https://github . com/Facebook/create-react-app/tree/master/packages/react-scripts/config</a>)的一部分中</p><figure class="ma mb mc md gt me"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="6f7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这到底是怎么回事？回想一下<strong class="jp ir">这段代码将在构建服务器</strong>上运行，我们的<code class="fe lv lw lx ly b">process.env</code>对象将在此时被填充。这段代码将遍历每个环境变量，<strong class="jp ir">过滤掉所有不以</strong>T1开头的变量。然后导出该对象。我们可以在稍后create-react-app设置其webpack配置时看到它的使用:</p><figure class="ma mb mc md gt me"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="32f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Webpack <code class="fe lv lw lx ly b">DefinePlugin</code>被传递了这个对象，它包含了我们过滤后的环境变量列表。这个插件到底是做什么的？</p><blockquote class="mu mv mw"><p id="33a1" class="jn jo mx jp b jq jr js jt ju jv jw jx my jz ka kb mz kd ke kf na kh ki kj kk ij bi translated"><code class="fe lv lw lx ly b">DefinePlugin</code>允许你创建可以在编译时配置的全局常量。—<a class="ae mm" href="https://webpack.js.org/plugins/define-plugin/" rel="noopener ugc nofollow" target="_blank">https://webpack.js.org/plugins/define-plugin/</a></p></blockquote><p id="bed7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，create-react-app正在为浏览器创建一个名为<code class="fe lv lw lx ly b">process.env</code>的新的全局常量，并将其值设置为从构建服务器获取的过滤后的环境变量的值。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nb"><img src="../Images/b6b808997049840c467c3bf0eed70e1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B5CdzsGBBDbSrsJqtvM8Gw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">谜团解开了。</figcaption></figure><h1 id="a9b1" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="f688" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">当运行构建脚本时，create-react-app检索环境变量对象，过滤掉任何没有前缀<code class="fe lv lw lx ly b">REACT_APP</code>的键，并将它们传递给Webpack <code class="fe lv lw lx ly b">DefinePlugin</code>，Webpack将该对象设置在位于<code class="fe lv lw lx ly b">process.env</code>的全局常量上。</p><h1 id="f597" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">附录—本地环境变量</h1><p id="739f" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">上面的内容是在构建服务器的伪装下编写的。我们希望能够在我们的本地开发机器上设置环境变量，这样<code class="fe lv lw lx ly b">process.env.REACT_APP_DATA</code>就不会因为没有设置任何东西而无法定义。</p><p id="153d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">幸运的是，create-react-app自带<code class="fe lv lw lx ly b">dotenv</code>。这个包将寻找一个名为<code class="fe lv lw lx ly b">.env</code>的文件，并将它读入环境变量对象。在项目根中创建一个名为<code class="fe lv lw lx ly b">.env</code>的文件，我们可以用我们的<code class="fe lv lw lx ly b">REACT_APP_DATA</code>填充它:</p><figure class="ma mb mc md gt me"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="8fe2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们在本地构建我们的应用程序时，上面定义的过程将会运行，包括在这个文件中设置的任何变量。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><figure class="ma mb mc md gt me gh gi paragraph-image"><a href="https://levelup.gitconnected.com"><div class="gh gi nc"><img src="../Images/9914c5dd23ac08b70eea6f4f9ba6fed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E6CoI_MRyZ1JInNPsBSHtA.png"/></div></a></figure><div class="nd ne gp gr nf ng"><a href="https://gitconnected.com/learn/react" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">学习React -最佳React教程(2019) | gitconnected</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">排名前49的React教程-免费学习React。课程由开发人员提交并投票，使您能够…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">gitconnected.com</p></div></div><div class="np l"><div class="nq l nr ns nt np nu mf ng"/></div></div></a></div></div></div>    
</body>
</html>