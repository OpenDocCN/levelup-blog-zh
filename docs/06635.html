<html>
<head>
<title>How to use NFS in Kubernetes Cluster — Configuring the NFS Server.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Kubernetes集群中使用NFS—配置NFS服务器。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-use-nfs-in-kubernetes-cluster-configuring-the-nfs-server-1bf4116641d4?source=collection_archive---------4-----------------------#2020-12-15">https://levelup.gitconnected.com/how-to-use-nfs-in-kubernetes-cluster-configuring-the-nfs-server-1bf4116641d4?source=collection_archive---------4-----------------------#2020-12-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="9ec3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">顾名思义，Kubernetes环境应该是无状态的。这样，您可以扩展您的应用程序，滚动升级，并重启崩溃的应用程序连续没有任何问题。</p><p id="5ab5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不幸的是，除了一些无服务器的应用程序，我们几乎需要一直保存数据。</p><p id="7cdf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在大多数情况下，数据必须保留到给定应用程序、pod甚至群集的生命周期之后。为了实现这一点，Kubernetes用户需要使用一个持久卷。</p><p id="1f12" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们在Kubernetes中有多种选择，从节点中的本地存储到云卷。</p><p id="e9ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本系列中，我将描述使用NFS创建这些持久卷的3种不同方式。</p><p id="7922" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个题目超级广泛，所以我把内容分在以下几篇文章之间:</p><ol class=""><li id="fac3" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated"><strong class="js iu">配置NFS服务器(此服务器)</strong></li><li id="4871" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated"><a class="ae lc" href="https://fabiofernandesx.medium.com/how-to-use-nfs-in-kubernetes-cluster-method-1-4071724af37c" rel="noopener">方法一——将NFS硬盘映射到每个节点的本地文件夹</a>。</li><li id="3a2d" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated"><a class="ae lc" href="https://fabiofernandesx.medium.com/how-to-use-nfs-in-kubernetes-cluster-method-2-73df4efb4c00" rel="noopener">方法2—通过永久卷配置直接连接到NFS服务器</a></li><li id="de28" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated"><a class="ae lc" href="https://fabiofernandesx.medium.com/how-to-use-nfs-in-kubernetes-cluster-storage-class-ed1179a83817" rel="noopener">创建一个存储类，通过声明自动创建一个持久卷</a>。</li></ol><h1 id="5e6a" class="ld le it bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">一般注意事项</h1><h2 id="66a7" class="mb le it bd lf mc md dn lj me mf dp ln kb mg mh lr kf mi mj lv kj mk ml lz mm bi translated">源代码</h2><p id="8962" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">本文中使用的所有文件都发布在这个GitHub资源库中:<a class="ae lc" href="https://github.com/fabiofernandesx/k8s-volumes" rel="noopener ugc nofollow" target="_blank">https://github.com/fabiofernandesx/k8s-volumes</a>。如果您发现需要修复或添加的东西，可以随意克隆它，甚至打开一个拉请求。</p><h2 id="2d03" class="mb le it bd lf mc md dn lj me mf dp ln kb mg mh lr kf mi mj lv kj mk ml lz mm bi translated">家庭实验室</h2><p id="84b4" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">对于本系列文章，我将使用我的raspberry pi Kubernetes集群，但是这些命令应该可以在任何环境下工作，包括云和虚拟机。如果你对如何创建一个raspberry pi k8s集群感兴趣，你可以在这里找到它:<a class="ae lc" href="https://medium.com/swlh/yet-another-raspberry-pi-k8s-cluster-ea05fb48e9a8" rel="noopener">又一个Raspberry Pi k8的集群</a>，或者如果你对如何使用虚拟机器创建这个集群感兴趣，你可以看看这个:<a class="ae lc" href="https://fabiofernandesx.medium.com/preparing-virtual-box-vms-to-run-kubernetes-a31c7c851566" rel="noopener">准备虚拟机器来运行Kubernetes </a>。</p><h1 id="8e66" class="ld le it bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">配置NFS服务器</h1><p id="919f" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">首先要做的是配置NFS服务器。我们想要导出5个端点:</p><ul class=""><li id="0f26" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn ms ku kv kw bi translated">/ssd/host-mapped —它将是本地磁盘中的一个文件夹，用于在集群中演示如何在每个节点上使用“映射”文件夹创建一个永久卷。</li><li id="184f" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn ms ku kv kw bi translated">/ssd/direct —它也是一个文件夹，将用于演示如何创建直接访问NFS服务器的PV，而无需先将文件夹映射到节点。</li><li id="02df" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn ms ku kv kw bi translated">/SSD/dynamic—NFS服务器本地磁盘中的另一个文件夹，它将被用作我们对群集的主要“最快”源。它将通过集群内的存储类使用动态PV创建。</li><li id="49a1" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn ms ku kv kw bi translated">/mnt/usb3/dynamic —这是一个插入NFS服务器usb3端口的外部驱动器，已装载并导出供群集使用。这将是另一个动态PV创建(通过存储类)，并将为我们的集群目的提供“中速”,具有更大的空间tho。</li><li id="7631" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn ms ku kv kw bi translated">/mnt/usb2/dynamic —与上一个类似，不同之处在于它将通过usb2连接，提供较慢的速度和1TB的空间。我不确定我会在这里分配什么，一些不常用的数据，可能是docker映像或备份。</li></ul><p id="799b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以，少说多做，让我们开始通过ssh连接到NFS服务器<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ ssh pi@192.168.2.30</em></strong></code></p><p id="a5b5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，让我们安装外部驱动器。运行:<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo fdisk -l</em></strong></code>我们可以检查我们的驱动器安装在哪里。如您所见，我将usb3 3TB驱动器连接到/dev/sdb，将usb2 1TB驱动器连接到/dev/sdc</p><figure class="mz na nb nc gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi my"><img src="../Images/4dc23a6cebc75740b793a785849c2603.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*epNyM555fTCOmFpQRH9OLQ.png"/></div></div></figure><p id="4db1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您的外部驱动器是新的，您可以使用命令<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo mkfs.ext4 /dev/sdb</em></strong></code>和<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo mkfs.ext4 /dev/sdc</em></strong></code> <strong class="js iu"> <em class="mx">在那里创建一个分区。</em>T12】</strong></p><p id="3b09" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我的不是新的，但我想从头开始，不在乎丢失那里的数据。</p><figure class="mz na nb nc gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nk"><img src="../Images/664714f26ddc0a695143dbe6470c06d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZYJZCXbwLapU7Ee26WyaHA.png"/></div></div></figure><p id="cac0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们将它安装到我们在计划中选择的路径。在我的例子中,/mnt/usb3位于/dev/sdb上，而/mnt/usb2位于/dev/sdc上</p><p id="23cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们要去1。创建文件夹— <code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo mkdir /mnt/usb2</em></strong></code>，2。将pi用户设置为文件夹的所有者<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo chown -R pi:pi /mnt/usb2</em></strong></code>，3挂载它<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo mount /dev/sdc /mnt/usb2</em></strong></code></p><p id="d66d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以使用命令<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ df -ha /dev/sdc</em></strong></code>验证挂载是否成功</p><figure class="mz na nb nc gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nl"><img src="../Images/31fd0dde04300d2fb334066815db6be8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gEWJcdNjwgGGNWEwcFSeTw.png"/></div></div></figure><p id="db54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">好了，现在，我们需要在启动时自动挂载它。我们将配置“fstab”来做这件事，但是首先，我们需要使用blkid <code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo blkid</em></strong></code>找到我们的磁盘的唯一id</p><figure class="mz na nb nc gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nm"><img src="../Images/94d89bc63bcaafd037cf2059886f1d95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aOC68NmDVXd-DBgWmGIPPQ.png"/></div></div></figure><p id="1dae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在结果中间挖掘，你会发现sdb和sdc的id。现在我们需要在引用这些磁盘id的fstab文件中配置挂载。</p><p id="3aab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用您选择的文本编辑器编辑fstab，例如。<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo nano /etc/fstab</em></strong></code> <strong class="js iu"> <em class="mx"> </em> </strong>并在文件末尾添加新的挂载(带有您在blkid中找到的id)。在我的例子中，这些线是这样的:</p><pre class="mz na nb nc gt nn mw no np aw nq bi"><span id="a3a7" class="mb le it mw b gy nr ns l nt nu">UUID=1a594e47-fcd5–41d5–8c55–174469983711 /mnt/usb3 ext4 defaults 0 0<br/>UUID=2fd11a1f-4c26-4631-87b0-5b9b0d2b4c5a /mnt/usb2 ext4 defaults 0 0</span></pre><figure class="mz na nb nc gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nv"><img src="../Images/fe4e078c82ab736ef53b86fe5c892ba2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2LbKAk9zgSmA7C2rduuIFg.png"/></div></div></figure><p id="6493" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，让我们重新启动系统，验证自动挂载是否有效。我们可以用命令检查它。<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ df -ha /dev/sd*</em></strong></code></p><figure class="mz na nb nc gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nw"><img src="../Images/be00df02e84197074d6f3fabe6fefef0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w9bG1QXuWnqu78Mc5MT6yw.png"/></div></div></figure><p id="fd2a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">PS。:请注意，我们的外部驱动器分别更改为sda和sdb，但由于我们是基于UUID安装的，所以这不成问题，并且驱动器安装在正确的位置</p><p id="85c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，我们可以配置NFS服务器来共享它。首先，让我们安装NFS服务器软件包:</p><pre class="mz na nb nc gt nn mw no np aw nq bi"><span id="6bea" class="mb le it mw b gy nr ns l nt nu"><strong class="mw iu"><em class="mx">$ sudo apt-get install nfs-kernel-server -y</em></strong></span></pre><p id="fe6f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">并编辑文件/etc/exports以导出我们想要共享的所有端点。只是快速刷新一下我们的记忆，我们想要共享(NFS导出)这些文件夹:</p><ul class=""><li id="3e7e" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn ms ku kv kw bi translated">/SSD/主机映射</li><li id="728a" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn ms ku kv kw bi translated">/固态硬盘/直接</li><li id="1b9d" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn ms ku kv kw bi translated">/固态硬盘/动态</li><li id="e59c" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn ms ku kv kw bi translated">/mnt/USB 3/动态</li><li id="2b88" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn ms ku kv kw bi translated">/mnt/usb2/dynamic</li></ul><p id="ede7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">编辑导出文件:<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo nano /etc/exports</em></strong></code>并包括以下几行:</p><pre class="mz na nb nc gt nn mw no np aw nq bi"><span id="12c5" class="mb le it mw b gy nr ns l nt nu">/ssd/host-mapped *(rw,no_root_squash,insecure,async,no_subtree_check,anonuid=1001,anongid=1001)<br/>/ssd/direct *(rw,no_root_squash,insecure,async,no_subtree_check,anonuid=1002,anongid=1002)<br/>/ssd/dynamic *(rw,no_root_squash,insecure,async,no_subtree_check,anonuid=1003,anongid=1003)<br/>/mnt/usb3/dynamic *(rw,no_root_squash,insecure,async,no_subtree_check,anonuid=1004,anongid=1004)<br/>/mnt/usb2/dynamic *(rw,no_root_squash,insecure,async,no_subtree_check,anonuid=1005,anongid=1005)</span></pre><figure class="mz na nb nc gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nx"><img src="../Images/d8f0086cd7312340d7e81945aa122d98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Kc-TVgepANckoc2eHN4yw.png"/></div></div></figure><p id="3867" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，启动NFS服务器<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo exportfs -ra</em></strong></code></p><p id="4944" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们现在将在群集节点中安装NFS，并在每个节点上映射SSD/主机映射。</p><p id="5527" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过ssh连接到每个节点并安装nfs-common <code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo apt-get install nfs-common -y</em></strong></code>。</p><p id="984b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建文件夹，将所有权传递给pi用户，并编辑fstab以自动挂载它:</p><pre class="mz na nb nc gt nn mw no np aw nq bi"><span id="cfd2" class="mb le it mw b gy nr ns l nt nu"><strong class="mw iu"><em class="mx">sudo mkdir -p /ssd/host-mapped<br/>sudo chown -R pi:pi /ssd/host-mapped<br/>sudo nano /etc/fstab</em></strong></span></pre><p id="6710" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">编辑导出文件:<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ sudo nano /etc/exports</em></strong></code>并包含以下行(将服务器IP更改为您的NFS服务器IP):</p><pre class="mz na nb nc gt nn mw no np aw nq bi"><span id="0c82" class="mb le it mw b gy nr ns l nt nu">192.168.2.30:/ssd/host-mapped  /ssd/host-mapped nfs rw 0 0</span></pre><p id="5e9d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">重启节点并使用<code class="fe mt mu mv mw b"><strong class="js iu"><em class="mx">$ df -h /ssd/host-mapped</em></strong></code>检查挂载</p><figure class="mz na nb nc gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ny"><img src="../Images/78c8cc1d0ad4326d3671738d10e282e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pWn9BpH6irWETNxgAsIS_g.png"/></div></div></figure><p id="41fc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对所有节点重复这些步骤:</p><figure class="mz na nb nc gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nz"><img src="../Images/7df423b64d1d828521f1532101c5cc82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WC7gVqbOFMlBwm0SgGjIsA.png"/></div></div></figure><figure class="mz na nb nc gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi oa"><img src="../Images/f899ebf5a6f28056fbb202c99ad27ed6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RGqHfmkP8_FYgSdKHBYb9A.png"/></div></div></figure><figure class="mz na nb nc gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ob"><img src="../Images/5e5a8e0dc6f8ff00364de495f4b61d74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bAEdsGaTCBwJXiSLYKJ6dw.png"/></div></div></figure><p id="e974" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这就是NFS的部分。在下一篇文章中，我们将开始配置我们的持久卷，并使用这些NFS配置发布一个简单的网站来存储网站文件。</p></div></div>    
</body>
</html>