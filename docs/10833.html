<html>
<head>
<title>Glue it together!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">粘在一起！</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/glue-it-together-acb796655f8d?source=collection_archive---------1-----------------------#2022-01-16">https://levelup.gitconnected.com/glue-it-together-acb796655f8d?source=collection_archive---------1-----------------------#2022-01-16</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="ca9d" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">使用Athena访问您在S3的数据，使用Glue作为中间人。</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/ac02dda2374dd362a4742bdb3a54d387.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c9JBhb69ulX28lDP"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">玛利亚·沙妮娜在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="3c2a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">分析可能是企业最重要的部分。有了它们，我们可以做出明智的决策，帮助一家公司领先于其他公司。但是生成和访问分析并不是一件容易的事情。它通常涉及生成和存储数据，将数据处理成对我们阅读有用的格式，并分析这些数据。所有这些都需要时间，而这些时间可能是不存在的。</p><p id="1f97" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是有了云计算，有几个工具可以帮助减少完成这项任务所需的时间。我要描述一些AWS解决方案，而且都是无服务器的！</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h2 id="da4e" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated"><a class="ae kz" href="https://aws.amazon.com/glue" rel="noopener ugc nofollow" target="_blank"> AWS胶水</a></h2><blockquote class="mw mx my"><p id="a6f9" class="la lb mz lc b ld le jv lf lg lh jy li na lk ll lm nb lo lp lq nc ls lt lu lv in bi translated">AWS Glue是一种无服务器的数据集成服务，可以轻松发现、准备和组合用于分析、机器学习和应用程序开发的数据。AWS Glue提供了数据集成所需的所有功能，因此您可以在几分钟内开始分析数据并投入使用，而不是几个月。</p></blockquote><p id="2439" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这听起来很奇特，可能有点复杂？但最酷的是AWS Glue自动完成了所有这些工作。我们设置好它，胶水会自动完成它的工作。</p><h2 id="eace" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated"><a class="ae kz" href="https://aws.amazon.com/athena" rel="noopener ugc nofollow" target="_blank"> AWS雅典娜</a></h2><blockquote class="mw mx my"><p id="6995" class="la lb mz lc b ld le jv lf lg lh jy li na lk ll lm nb lo lp lq nc ls lt lu lv in bi translated">Amazon Athena是一种交互式查询服务，它使得使用标准SQL分析亚马逊S3中的数据变得很容易。Athena是无服务器的，所以不需要管理基础设施，只需为运行的查询付费。</p></blockquote><p id="098f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这里SQL的使用非常强大，因为现在我们可以定义非常复杂的查询，并在需要时运行它们，比如在cron作业或HTTP端点中。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><p id="f253" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在我们知道了可以用来从数据中生成和访问分析的工具，是时候考虑用例了。假设我们有一个视频托管解决方案。我们将客户的视频存储在S3桶上，然后通过CDN (Cloudfront)交付给他们。但我们如何对这些视频进行分析，例如观看次数最多的视频或世界上哪个地方更活跃？</p><p id="d2be" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们可以设计一个这样的解决方案:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nd"><img src="../Images/31cad37884d3f4380e4fabbf940aeb35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YQDyNTTQ8FxQ3zduosVk2Q.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">视频托管平台访问分析的潜在解决方案。</figcaption></figure><ol class=""><li id="ed26" class="ne nf iu lc b ld le lg lh lj ng ln nh lr ni lv nj nk nl nm bi translated">将视频储存在S3桶中。</li><li id="d7f1" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">使用Cloudfront交付视频，并设置日志来跟踪使用情况。</li><li id="44f4" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">监听添加到S3存储桶的日志并设置通知。</li><li id="61ef" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">将带有SNS/SQS的通知发送给Lambda函数。</li><li id="f5a1" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">Lambda函数解压缩日志文件，处理文本文件中的数据，并将其以parquet*格式保存到另一个S3存储桶中。</li><li id="9003" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">创建一个胶水数据库，并选择其数据存储以前的S3桶。</li><li id="08c2" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">创建一个胶水爬虫，对着S3桶运行。crawler将自动创建必要的表和列。它还将开始填充您的数据库。</li><li id="2b44" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">此时，为了快速测试您的解决方案，您可以在AWS控制台中访问AWS Athena，执行一些快速SQL查询并获取数据。</li><li id="7a9d" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">这可以实现为APIGW + Lambda，这样您的客户端(比如React应用程序)就可以以用户友好的方式访问数据。</li></ol><h2 id="561c" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">*使用Parquet是因为它们的列数据存储格式提高了查询数据的速度。</h2></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><p id="9a43" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是我们如何建立这个基础设施呢？在Terraform的帮助下。我将只展示如何建立一个Glue数据库，它的数据存储和Athena。如何设置你自己的CDN，听日志和填充数据存储取决于你自己。我也不会为APIGW + Lambda写代码，因为有很多关于它的帖子。</p><h2 id="1836" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">创建S3存储桶</h2><p id="7528" class="pw-post-body-paragraph la lb iu lc b ld ns jv lf lg nt jy li lj nu ll lm ln nv lp lq lr nw lt lu lv in bi translated">这将是我们胶水数据库的数据存储。</p><pre class="kk kl km kn gu nx ny nz oa aw ob bi"><span id="5c5f" class="md me iu ny b gz oc od l oe of">resource "aws_s3_bucket" "logs_analytics" {<br/>  acl           = "private"<br/>  bucket        = "logs-analytics"<br/>}</span></pre><h2 id="361b" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">创建胶水数据库</h2><pre class="kk kl km kn gu nx ny nz oa aw ob bi"><span id="b387" class="md me iu ny b gz oc od l oe of">resource "aws_glue_catalog_database" "database" {<br/>  name = "database"<br/>}</span></pre><h2 id="27f4" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">创建一个胶水爬虫</h2><p id="f92f" class="pw-post-body-paragraph la lb iu lc b ld ns jv lf lg nt jy li lj nu ll lm ln nv lp lq lr nw lt lu lv in bi translated">但是首先指定其访问数据存储的权限。</p><pre class="kk kl km kn gu nx ny nz oa aw ob bi"><span id="bef7" class="md me iu ny b gz oc od l oe of">data "aws_partition" "current" {}</span><span id="795e" class="md me iu ny b gz og od l oe of">resource "aws_iam_role" "glue_crawler_role" {<br/>  name               = "crawler-role"<br/>  assume_role_policy = data.aws_iam_policy_document.glue_crawler_assume_role.json<br/>}</span><span id="1f0d" class="md me iu ny b gz og od l oe of">data "aws_iam_policy" "glue_crawler_glue" {<br/>  arn = "arn:${data.aws_partition.current.partition}:iam::aws:policy/service-role/AWSGlueServiceRole"<br/>}</span><span id="b787" class="md me iu ny b gz og od l oe of">resource "aws_iam_role_policy_attachment" "glue_crawler_glue" {<br/>  role       = aws_iam_role.glue_crawler_role.name<br/>  policy_arn = data.aws_iam_policy.glue_crawler_glue.arn<br/>}</span><span id="cfc7" class="md me iu ny b gz og od l oe of">data "aws_iam_policy_document" "glue_crawler_s3" {<br/>  policy_id = "crawler-s3"<br/>  version   = "2012-10-17"</span><span id="a632" class="md me iu ny b gz og od l oe of">statement {<br/>    effect = "Allow"<br/>    actions = [<br/>      "s3:GetObject",<br/>      "s3:PutObject"<br/>    ]</span><span id="e86b" class="md me iu ny b gz og od l oe of">resources = [aws_s3_bucket.logs_analytics.arn, "${aws_s3_bucket.logs_analytics.arn}/*"]<br/>  }<br/>}</span><span id="7368" class="md me iu ny b gz og od l oe of">resource "aws_iam_policy" "glue_crawler_s3" {<br/>  name   = "crawler-s3"<br/>  policy = data.aws_iam_policy_document.glue_crawler_s3.json<br/>}</span><span id="ab39" class="md me iu ny b gz og od l oe of">resource "aws_iam_role_policy_attachment" "glue_crawler_s3" {<br/>  depends_on = [aws_iam_role.glue_crawler_role, aws_iam_policy.glue_crawler_s3]<br/>  role       = aws_iam_role.glue_crawler_role.name<br/>  policy_arn = aws_iam_policy.glue_crawler_s3.arn<br/>}</span><span id="bfdf" class="md me iu ny b gz og od l oe of">resource "aws_glue_crawler" "glue_crawler" {<br/>  depends_on = [<br/>    aws_s3_bucket.logs_analytics,<br/>    aws_glue_catalog_database.logs_analytics,<br/>    aws_iam_role.glue_crawler_role<br/>  ]</span><span id="c31f" class="md me iu ny b gz og od l oe of">database_name = aws_glue_catalog_database.logs_analytics.name<br/>  name          = "crawler"<br/>  role          = aws_iam_role.glue_crawler_role.arn</span><span id="39f2" class="md me iu ny b gz og od l oe of">s3_target {<br/>    path = "s3://${aws_s3_bucket.logs_analytics.bucket}"<br/>  }<br/>}</span></pre><h2 id="d964" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">创建一个存储桶来存储Athena查询</h2><pre class="kk kl km kn gu nx ny nz oa aw ob bi"><span id="88d0" class="md me iu ny b gz oc od l oe of">resource "aws_s3_bucket" "athena_results" {<br/>  acl           = "private"<br/>  bucket        = "athena-results"<br/>}</span></pre></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><p id="3159" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">一旦你部署了你的Terraform代码，你就可以进入AWS Glue，选择你的爬虫并手动运行它。如果您的S3桶中已经有拼花文件，爬虫将在Glue数据库中生成一个新表，并开始用数据填充它。您还可以<a class="ae kz" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/glue_crawler#schedule" rel="noopener ugc nofollow" target="_blank">安排您的爬虫</a>定期运行，避免手动执行这个过程。</p><p id="88dd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，如果您转到Athena，您可以选择Glue数据库并对其运行查询，例如:</p><pre class="kk kl km kn gu nx ny nz oa aw ob bi"><span id="056f" class="md me iu ny b gz oc od l oe of">SELECT * FROM "database" ORDER BY "timestamp" DESC</span></pre><p id="ce89" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">返回的数据可能如下所示:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj oh"><img src="../Images/4f4f1e6324c4c336aa26c9bd8dd68db4.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/1*TvM18PNnAGZRkt3DJGLdnQ.png"/></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">Athena查询返回的数据示例</figcaption></figure><p id="a7de" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您唯一要做的就是定义服务于您的业务的SQL查询，并为您提供有价值的信息，帮助您做出更好的决策。</p><p id="d840" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">SQL是极限！🎉</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><div class="kk kl km kn gu oi"><a href="https://blog.jagonzalr.com/membership" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fp"><div class="ok ab ol cl cj om"><h2 class="bd iv gz z fq on fs ft oo fv fx it bi translated">加入我的介绍链接媒体-何塞安东尼奥冈萨雷斯罗德里格斯</h2><div class="op l"><h3 class="bd b gz z fq on fs ft oo fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oq l"><p class="bd b dl z fq on fs ft oo fv fx dk translated">blog.jagonzalr.com</p></div></div><div class="or l"><div class="os l ot ou ov or ow kt oi"/></div></div></a></div></div></div>    
</body>
</html>