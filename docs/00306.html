<html>
<head>
<title>Dockerizing and autoscaling Node.js on Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud上的Dockerizing和autoscaling Node.js</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/dockerizing-and-autoscaling-node-js-on-google-cloud-ef8db3b99486?source=collection_archive---------0-----------------------#2018-12-29">https://levelup.gitconnected.com/dockerizing-and-autoscaling-node-js-on-google-cloud-ef8db3b99486?source=collection_archive---------0-----------------------#2018-12-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/dbf4d22cb048f4bca98632dd465989f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*djuNMepGvPKxQuVVQWyDBg.png"/></div></div></figure><h2 id="e179" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">目录</h2><ul class=""><li id="948a" class="ku kv iq kw b kx ky kz la kh lb kl lc kp ld le lf lg lh li bi translated"><a class="ae lj" href="https://medium.com/p/ef8db3b99486#bc78" rel="noopener">简介</a></li><li id="9e33" class="ku kv iq kw b kx lk kz ll kh lm kl ln kp lo le lf lg lh li bi translated"><a class="ae lj" href="https://medium.com/p/ef8db3b99486#42e5" rel="noopener">设置Node.js服务器</a></li><li id="8002" class="ku kv iq kw b kx lk kz ll kh lm kl ln kp lo le lf lg lh li bi translated"><a class="ae lj" href="https://medium.com/p/ef8db3b99486#9cfa" rel="noopener">建立谷歌云</a></li><li id="22cb" class="ku kv iq kw b kx lk kz ll kh lm kl ln kp lo le lf lg lh li bi translated"><a class="ae lj" href="https://medium.com/p/ef8db3b99486#4525" rel="noopener"> Dockerize Node.js </a></li><li id="3523" class="ku kv iq kw b kx lk kz ll kh lm kl ln kp lo le lf lg lh li bi translated"><a class="ae lj" href="https://medium.com/p/ef8db3b99486#18c8" rel="noopener">将您的Docker映像部署到Google容器注册表</a></li><li id="6d63" class="ku kv iq kw b kx lk kz ll kh lm kl ln kp lo le lf lg lh li bi translated"><a class="ae lj" href="https://medium.com/p/ef8db3b99486#6aa8" rel="noopener">配置防火墙</a></li><li id="d2dc" class="ku kv iq kw b kx lk kz ll kh lm kl ln kp lo le lf lg lh li bi translated"><a class="ae lj" href="https://medium.com/p/ef8db3b99486#6387" rel="noopener">定义实例模板</a></li><li id="f15b" class="ku kv iq kw b kx lk kz ll kh lm kl ln kp lo le lf lg lh li bi translated"><a class="ae lj" href="https://medium.com/p/ef8db3b99486#aa61" rel="noopener">创建托管实例组</a></li><li id="7fb4" class="ku kv iq kw b kx lk kz ll kh lm kl ln kp lo le lf lg lh li bi translated"><a class="ae lj" href="https://medium.com/p/ef8db3b99486#ca35" rel="noopener">添加负载平衡器</a></li><li id="e7a6" class="ku kv iq kw b kx lk kz ll kh lm kl ln kp lo le lf lg lh li bi translated"><a class="ae lj" href="https://medium.com/p/ef8db3b99486#72f3" rel="noopener">限制交通</a></li><li id="0134" class="ku kv iq kw b kx lk kz ll kh lm kl ln kp lo le lf lg lh li bi translated"><a class="ae lj" href="https://medium.com/p/ef8db3b99486#c48f" rel="noopener">部署新版本</a></li></ul><h1 id="bc78" class="lp jz iq bd ka lq lr ls kd lt lu lv kg lw lx ly kk lz ma mb ko mc md me ks mf bi translated">介绍</h1><p id="291a" class="pw-post-body-paragraph mg mh iq kw b kx ky mi mj kz la mk ml kh mm mn mo kl mp mq mr kp ms mt mu le ij bi translated">这篇文章将介绍如何将Node.js服务器停靠在Google Cloud(特别是Google Computer Engine)中，并配置您的VM实例以根据流量自动缩放。第2部分将介绍如何将您的服务器连接到一个安全的MongoDB部署。</p><p id="afed" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">我们将建立一个Node.js服务器，创建一个Docker文件，并将服务器的Docker映像部署到Google容器注册中心。之后，我们将创建一个实例模板，它定义了我们的虚拟机的规范。然后，我们将设置一个托管实例组，它将根据我们的实例模板启动和扩展一组虚拟机。我们将配置托管实例组，以便在流量增加超过某个阈值时创建新实例。最后，我们将设置一个负载平衡器来重定向和平衡我们的虚拟机实例之间的传入流量。</p><p id="8103" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">请随意使用您现有的Node.js应用程序，尽管用一个简单的应用程序来完成本教程可能更容易，以避免任何不必要的错误。出于本教程的目的，我将使用我编写的节点样板脚本-<a class="ae lj" href="https://github.com/francescov1/node-boilerplate-script" rel="noopener ugc nofollow" target="_blank">https://github.com/francescov1/node-boilerplate-script</a>。</p><p id="0048" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated"><em class="na">注意:如果你正在使用你自己的Node.js代码，确保它被设置为在</em> <strong class="kw ir"> <em class="na">端口3000 </em> </strong> <em class="na">上运行，因为我将为所有Docker和Google Cloud配置使用那个端口。</em></p><h1 id="42e5" class="lp jz iq bd ka lq lr ls kd lt lu lv kg lw lx ly kk lz ma mb ko mc md me ks mf bi translated">设置Node.js服务器</h1><p id="a549" class="pw-post-body-paragraph mg mh iq kw b kx ky mi mj kz la mk ml kh mm mn mo kl mp mq mr kp ms mt mu le ij bi translated">如果您正在使用自己的Node.js应用程序，请跳过这一步。我们将克隆节点样板脚本repo，创建一个新文件夹并运行脚本。</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="96cd" class="jy jz iq ng b gy nk nl l nm nn">git clone <a class="ae lj" href="https://github.com/francescov1/node-boilerplate-script.git" rel="noopener ugc nofollow" target="_blank">https://github.com/francescov1/node-boilerplate-script.git</a></span><span id="99f4" class="jy jz iq ng b gy no nl l nm nn">mkdir gcloud-docker-node<br/>cp node-boilerplate-script/node-init.sh gcloud-docker-node/<br/>cd gcloud-docker-node/<br/>bash node-init.sh</span></pre><p id="3abe" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">几分钟后，它应该是完整的。运行<code class="fe np nq nr ng b">npm start</code>并导航到<a class="ae lj" href="http://localhost:3000/api/examples/hello" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/API/examples/hello</a>，在这里你应该会看到“hello world”。</p><h1 id="9cfa" class="lp jz iq bd ka lq lr ls kd lt lu lv kg lw lx ly kk lz ma mb ko mc md me ks mf bi translated">设置Google云</h1><p id="8494" class="pw-post-body-paragraph mg mh iq kw b kx ky mi mj kz la mk ml kh mm mn mo kl mp mq mr kp ms mt mu le ij bi translated">接下来，我们将设置谷歌计算引擎。如果您没有谷歌云帐户，请访问<a class="ae lj" href="https://cloud.google.com/free/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/free</a>了解更多信息，并获取创建帐户的说明。注册后，您将获得300美元的免费积分，因此不必担心需要为您在本教程中创建的资源付费。</p><p id="793e" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">在Google Cloud控制台中创建新项目。如果你以前从未这样做过，请参见<a class="ae lj" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/resource-manager/docs/creating-managing-projects</a>。我们将把我们的项目称为<em class="na"> gcloud-docker-node </em>。</p><p id="c3bc" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">接下来前往<a class="ae lj" href="https://cloud.google.com/sdk/docs/#install_the_latest_cloud_tools_version_cloudsdk_current_version" rel="noopener ugc nofollow" target="_blank">https://Cloud . Google . com/SDK/docs/# install _ the _ latest _ Cloud _ tools _ version _ Cloud SDK _ current _ version</a>下载Google Cloud CLI(如果您尚未下载),我们将使用它将新的代码更改部署到我们的虚拟机。</p><p id="2aa7" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">一旦安装完毕，运行<code class="fe np nq nr ng b">gcloud init</code>。这将引导您完成对CLI的身份验证和选择项目。</p><h1 id="4525" class="lp jz iq bd ka lq lr ls kd lt lu lv kg lw lx ly kk lz ma mb ko mc md me ks mf bi translated">Dockerize Node.js</h1><p id="24dd" class="pw-post-body-paragraph mg mh iq kw b kx ky mi mj kz la mk ml kh mm mn mo kl mp mq mr kp ms mt mu le ij bi translated">我们现在可以在部署Node.js服务器之前为它设置Docker。Docker允许我们以一种易于移植和可伸缩的格式来封装我们的应用程序。我不会详细介绍Docker或它的好处，所以如果你有兴趣，可以去看看https://dzone.com/articles/top-10-benefits-of-using-docker。</p><p id="21aa" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">我将使用Atom，但也可以随意使用任何其他文本编辑器。创建Dockerfile文件并。在你的文本编辑器中打开工作目录。</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="c3a5" class="jy jz iq ng b gy nk nl l nm nn">touch Dockerfile .dockerignore</span></pre><p id="f8fb" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">将以下代码添加到您的<code class="fe np nq nr ng b">.dockerignore</code>中:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="62f4" class="jy jz iq ng b gy nk nl l nm nn">node_modules<br/>npm-debug.log</span></pre><p id="c48d" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">上面定义了构建Docker映像时要忽略的文件和文件夹。将以下代码添加到docker文件中:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="bf0e" class="jy jz iq ng b gy nk nl l nm nn"># version of node to use<br/>FROM node:8</span><span id="1e05" class="jy jz iq ng b gy no nl l nm nn"># define working directory for docker<br/>WORKDIR /usr/src/app</span><span id="d30c" class="jy jz iq ng b gy no nl l nm nn"># copy all our source code into the working directory<br/>COPY . .</span><span id="801d" class="jy jz iq ng b gy no nl l nm nn"># install npm dependencies and pm2<br/>RUN npm install --only=production &amp;&amp; npm install -g pm2</span><span id="fa4a" class="jy jz iq ng b gy no nl l nm nn"># expose port 3000 for our server to run on<br/>EXPOSE 3000</span><span id="ca9d" class="jy jz iq ng b gy no nl l nm nn"># command to start our server<br/>CMD [ "pm2-runtime", "start", "index.js", "-i", "max" ]</span></pre><p id="4817" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">Pm2是一个进程管理器，我们将使用它来启动我们的服务器。它捆绑了大量很酷的功能，如集群和负载平衡。点击这里了解更多信息<a class="ae lj" href="https://pm2.io/runtime" rel="noopener ugc nofollow" target="_blank">https://pm2.io/runtime</a>。<code class="fe np nq nr ng b">CMD [ “pm2-runtime", “start", “index.js", “-i", “max ]</code>行启动尽可能多的Node.js服务器实例。Node.js每个CPU内核只能运行一个进程，所以在我们的例子中，每个VM实例只能运行一个Node.js进程，因为我们定义的实例模板使用一个单核CPU。如果您要升级虚拟机实例以运行更多内核，这将确保它们都被使用。</p><p id="c67d" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">我们还需要从<em class="na">中移除线<code class="fe np nq nr ng b">**/.env</code>。gitignore </em>文件，因为Google Cloud Container Registry将在<em class="na">之上使用这个文件。确定要忽略哪些文件(这对于第2部分尤其重要，因为第2部分将把MongoDB连接字符串放在。env)。确保如果您最终将这些代码放入git存储库，您使用类似于<a class="ae lj" href="https://github.com/AGWA/git-crypt" rel="noopener ugc nofollow" target="_blank"> git-crypt </a>的工具来确保任何秘密都不会直接提交到git中。</em></p><h1 id="18c8" class="lp jz iq bd ka lq lr ls kd lt lu lv kg lw lx ly kk lz ma mb ko mc md me ks mf bi translated">将您的Docker映像部署到Google容器注册中心</h1><p id="652a" class="pw-post-body-paragraph mg mh iq kw b kx ky mi mj kz la mk ml kh mm mn mo kl mp mq mr kp ms mt mu le ij bi translated">现在找到我们之前创建的Google Cloud项目的项目ID。为此，只需点击谷歌云控制台左上角的项目名称。项目名称的右边是ID，格式为gcloud-docker-node-XXXXXX。<em class="na">注意:您的项目ID可能包含也可能不包含项目名称后的随机数字。</em></p><p id="4860" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">要构建Docker映像并将其部署到Google容器注册中心，请运行:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="10de" class="jy jz iq ng b gy nk nl l nm nn">gcloud builds submit --tag gcr.io/&lt;project-id&gt;/docker-image .</span></pre><p id="6654" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">用您自己的项目id替换<project-id>。别忘了<code class="fe np nq nr ng b">.</code>的最后命令！如果它问你是否愿意启用云API，请说是。</project-id></p><p id="e3a9" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">该流程将经历我们在docker文件中定义的每一步。如果一切顺利，您应该以ID、创建时间、持续时间、来源、图像和<em class="na">成功</em>状态的信息结束。</p><p id="165a" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">前往谷歌容器注册中心-<a class="ae lj" href="https://console.cloud.google.com/gcr" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/gcr</a>查看您新部署的映像。</p><h1 id="6aa8" class="lp jz iq bd ka lq lr ls kd lt lu lv kg lw lx ly kk lz ma mb ko mc md me ks mf bi translated">配置防火墙</h1><p id="974d" class="pw-post-body-paragraph mg mh iq kw b kx ky mi mj kz la mk ml kh mm mn mo kl mp mq mr kp ms mt mu le ij bi translated">我们现在将添加一个简单的防火墙规则，以允许所有流量进入我们的虚拟机。一旦我们设置了负载平衡器，我们将关闭此流量，以确保它只来自负载平衡器。前往<a class="ae lj" href="https://console.cloud.google.com/networking/firewalls" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/networking/firewalls</a>并点击<em class="na">创建防火墙规则</em>。</p><p id="5329" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">命名为<strong class="kw ir"> vm-firewall-rule </strong>。在<em class="na">目标标签</em>下，键入<strong class="kw ir"> vm-firewall-tag </strong>并点击tab。我们将在设置虚拟机时指定相同的标记，以便将它们链接到该规则。在<em class="na">源IP范围</em>下，输入<strong class="kw ir"> 0.0.0.0/0 </strong>并点击tab，从而允许所有传入流量。在<em class="na">协议和端口</em>下，勾选<em class="na"> tcp </em>并在旁边的字段中输入<strong class="kw ir"> 3000 </strong>。点击<em class="na">创建</em>。</p><h1 id="6387" class="lp jz iq bd ka lq lr ls kd lt lu lv kg lw lx ly kk lz ma mb ko mc md me ks mf bi translated">定义实例模板</h1><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/1bbf77fae4696211c3a864486423a607.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9DJbzDOMjIkQ3FF4ksQE6Q.png"/></div></div></figure><p id="9a49" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">现在，我们将设置实例模板。前往计算引擎—<a class="ae lj" href="https://console.cloud.google.com/compute" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/compute</a>并点击左侧菜单栏中的<em class="na">实例模板</em>，然后点击<em class="na">创建实例模板</em>。</p><p id="94b4" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">我们将我们的模板命名为<strong class="kw ir">g cloud-docker-node-template</strong><em class="na">。</em>选中<em class="na">将容器映像部署到该虚拟机实例</em>选项，并在表单中输入<a class="ae lj" href="https://console.cloud.google.com/gcr/images/gcloud-docker-node/GLOBAL?project=gcloud-docker-node&amp;folder&amp;organizationId=327994105725" rel="noopener ugc nofollow" target="_blank"><strong class="kw ir">【gcr.io/】&lt;</strong></a><strong class="kw ir">项目id&gt;/docker-image:latest</strong>。这是我们刚刚上传的Docker图像的路径。</p><p id="fb5e" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">单击<a class="ae lj" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">管理、安全性、磁盘、网络、单独租赁</a>下拉菜单，导航至网络选项卡。在网络标签表单中，输入<strong class="kw ir"> vm-firewall-tag </strong>并点击tab。这就建立了我前面提到的与防火墙规则的联系。</p><p id="f21b" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">保持所有其他设置不变，点击<em class="na">创建</em>。</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><h1 id="aa61" class="lp jz iq bd ka lq oa ls kd lt ob lv kg lw oc ly kk lz od mb ko mc oe me ks mf bi translated">创建托管实例组</h1><p id="559b" class="pw-post-body-paragraph mg mh iq kw b kx ky mi mj kz la mk ml kh mm mn mo kl mp mq mr kp ms mt mu le ij bi translated">导航到https://console.cloud.google.com/compute/instanceGroups的<a class="ae lj" href="https://console.cloud.google.com/compute/instanceGroups" rel="noopener ugc nofollow" target="_blank">并点击<em class="na">创建实例组</em>。</a></p><p id="e67d" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">命名为<strong class="kw ir"> gcloud-docker-node-group。</strong>在<em class="na">实例模板</em>下，选择<strong class="kw ir">g cloud-node-docker-template</strong>。在<em class="na">目标CPU使用率</em>下输入75，在<em class="na">最大实例数</em>下输入5。此配置将自动添加或删除虚拟机实例，以尝试将每个实例的CPU使用率保持在75%。将其他一切保留为默认值，然后点击<em class="na"> Create。</em></p><p id="ad94" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">如果您转到<em class="na">虚拟机实例</em>选项卡，您现在应该看到至少一个虚拟机实例正在加速运行。一旦它完成引导，我们将SSH到该实例，以确保它与我们的Docker映像一起正常运行。</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/a5330d899deec295d6f984ce6c66670d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TNdreojU5UUEimeIstwqjw.png"/></div></div></figure><p id="cfd8" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">一旦您看到实例名称旁边有一个绿色的复选标记，单击<em class="na"> SSH </em>按钮旁边的箭头，然后单击<em class="na">查看gcloud命令</em>。复制显示的命令，并将其输入到您的终端中。</p><p id="6d45" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">如果SSH成功，您应该会看到以下消息；</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="57f2" class="jy jz iq ng b gy nk nl l nm nn">########################[ Welcome ]########################<br/>#  You have logged in to the guest OS.                    #<br/>#  To access your containers use 'docker attach' command  #<br/>###########################################################</span></pre><p id="06f9" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">输入<code class="fe np nq nr ng b">docker ps</code>查看当前活动的容器。将有两个容器，第一个是我们的Node.js服务器，第二个将有一个形式为<em class="na">gcr.io/stackdriver-agents/stackdriver-logging-agent:XXXXX.</em>的图像名称</p><p id="c563" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">要查看我们容器的日志，运行<code class="fe np nq nr ng b">docker logs &lt;container-id&gt;</code>，其中&lt; container-id &gt;是我们服务器容器的id(指定前几个字符即可)。</p><p id="a764" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">日志的最后一行应该是:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="de32" class="jy jz iq ng b gy nk nl l nm nn">server listening on port 3000...</span></pre><p id="7d1d" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">如果您使用了我的节点样板脚本，您可以通过从计算引擎页面(见上图)获取虚拟机的<em class="na">外部IP </em>值并在浏览器中导航到<a class="ae lj" href="http://35.227.58.115:3000/api/examples/hello" rel="noopener ugc nofollow" target="_blank">http://&lt;External-IP&gt;:3000/API/examples/hello</a>来查看它的运行情况，您应该会看到“hello world”。</p><p id="811a" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">恭喜你。现在，您已经将Node.js服务器对接并运行在Google VM上了！</p><h1 id="ca35" class="lp jz iq bd ka lq lr ls kd lt lu lv kg lw lx ly kk lz ma mb ko mc md me ks mf bi translated">添加负载平衡器</h1><p id="6a96" class="pw-post-body-paragraph mg mh iq kw b kx ky mi mj kz la mk ml kh mm mn mo kl mp mq mr kp ms mt mu le ij bi translated">现在，我们需要添加一个负载平衡器，将传入流量重定向到最不忙的虚拟机。导航到<a class="ae lj" href="https://console.cloud.google.com/net-services/loadbalancing/" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/net-services/loadbalancing</a>，点击<em class="na">创建负载平衡器</em>并选择<em class="na"> HTTP(S)负载平衡</em>。对于我们的负载平衡器，我们需要配置其前端和后端，前者将接收所有传入流量，后者将把传入流量重定向到我们的虚拟机。</p><p id="a956" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">输入<strong class="kw ir"> gcloud-docker-node-lb </strong>作为名称，点击<em class="na">后端配置。S </em>选择<em class="na">创建或选择后端服务&amp;后端桶</em>、<em class="na">后端服务</em>，最后<em class="na">创建后端服务</em>。</p><p id="09f9" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">将其命名为<strong class="kw ir"> lb-backend。</strong>在<em class="na">新后端</em>下，打开<em class="na">实例组</em>下拉菜单，选择您的托管实例组。在<em class="na">端口号</em>下输入<strong class="kw ir"> 3000 </strong>，点击<em class="na">完成</em>(不是<em class="na">创建</em>)。点击<em class="na">健康检查</em>下拉菜单，然后点击<em class="na">创建健康检查</em>。将其命名为<strong class="kw ir"> lb-health-check，</strong>将协议设置为<strong class="kw ir"> HTTP </strong>，将端口设置为<strong class="kw ir"> 3000 </strong>。点击<em class="na">保存并继续</em>，然后点击<em class="na">创建。</em></p><p id="f188" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">现在我们剩下要做的就是设置负载平衡器的前端。我们可以使用Google的托管SSL证书在面向用户的前端非常容易地设置HTTPS，但这需要我们获得一个域，因此出于本教程的目的，我们将使用HTTP。点击<em class="na">前端配置</em>，命名为<strong class="kw ir">l b-前端</strong>。点击<em class="na"> IP地址</em>下拉菜单，选择<em class="na">创建IP地址</em>。将其命名为<strong class="kw ir"> lb-ip </strong>，点击<em class="na">储备</em>。最后，点击<em class="na">完成</em>。</p><p id="de87" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">点击<em class="na">查看并最终确定</em>，确保所有值正确，然后点击<em class="na">创建</em>。</p><p id="336c" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">就是这样！在<em class="na">实例组</em>部分下(仍在负载平衡器页面上)，几分钟后，<em class="na">健康</em>下应显示<strong class="kw ir"> 1/1 </strong>，表示健康检查通过。</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/4859d3deef6437274cc1843a43c67467.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-OCcN7HKH8O7PUmh8JHr5Q.png"/></div></div></figure><p id="3714" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">一旦我们的健康检查通过，在负载平衡器页面的<em class="na">前端</em>部分中获取<em class="na"> IP:PORT </em>下的值，并导航到http://&lt;IP:PORT&gt;/API/examples/hello，在这里您将再次看到“hello world”消息，尽管这次您已经通过负载平衡器访问了您的服务器！</p><h1 id="72f3" class="lp jz iq bd ka lq lr ls kd lt lu lv kg lw lx ly kk lz ma mb ko mc md me ks mf bi translated">限制交通</h1><p id="2a3f" class="pw-post-body-paragraph mg mh iq kw b kx ky mi mj kz la mk ml kh mm mn mo kl mp mq mr kp ms mt mu le ij bi translated">既然我们的负载均衡器已经连接好了，我们可以关闭所有传入虚拟机的流量，除了负载均衡器和运行状况检查之外。导航回到防火墙规则页面，单击我们之前制定的规则<em class="na"> vm-firewall-rule </em>。点击<em class="na">编辑</em>，在<em class="na">源IP范围</em>中，将<strong class="kw ir"> 0.0.0.0/0 </strong>替换为<strong class="kw ir"> 130.211.0.0/22 </strong>和<strong class="kw ir"> 35.191.0.0/16 </strong>(输入每个IP后点击tab)。点击<em class="na">保存</em>。现在，如果您尝试通过虚拟机的外部IP地址访问服务器，浏览器将会挂起。所有流量都需要通过我们的负载均衡器进入。</p><h1 id="c48f" class="lp jz iq bd ka lq lr ls kd lt lu lv kg lw lx ly kk lz ma mb ko mc md me ks mf bi translated">部署新版本</h1><p id="52d8" class="pw-post-body-paragraph mg mh iq kw b kx ky mi mj kz la mk ml kh mm mn mo kl mp mq mr kp ms mt mu le ij bi translated">那么，如果您需要对代码进行更改，该怎么办呢？尽管我们还没有用git设置构建服务器或自动化，但是我们可以编写一个简单的脚本来用新的部署更新我们的VM实例。这包括两个步骤，第一步是构建和部署我们的Docker映像，如前所述。之后，我们需要在托管实例组上执行滚动重启，以重启虚拟机。在启动时，他们将在容器注册表中提取最新的Docker映像，这将用我们最新更新的代码构建。<em class="na">注意:滚动重启功能仍处于测试阶段，但我从未遇到过这方面的问题。</em></p><p id="0118" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">要执行滚动重启，我们首先需要安装gcloud beta CLI工具。运行<code class="fe np nq nr ng b">gcloud components install beta</code>并按照提示进行操作。</p><p id="afa2" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">完成后，我们可以使用以下命令开始滚动重启:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="ceec" class="jy jz iq ng b gy nk nl l nm nn">gcloud beta compute instance-groups managed rolling-action restart gcloud-docker-node-group --zone us-east1-b</span></pre><p id="7406" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated"><em class="na">注意:如果你使用了不同的时区，那么你需要在上面进行调整。</em></p><p id="7784" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">该命令将启动滚动重启过程。要检查其状态，请使用:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="9472" class="jy jz iq ng b gy nk nl l nm nn">gcloud beta compute instance-groups managed list-instances gcloud-docker-node-group --zone us-east1-b</span></pre><p id="900c" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">我们不需要在每次更新代码时都记住并打出这两个步骤，我们将编写一个简单的<code class="fe np nq nr ng b">deploy.sh</code>脚本来自动完成。</p><p id="0695" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">使用<code class="fe np nq nr ng b">touch deploy.sh </code>创建文件，并将两个命令复制到其中:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="4800" class="jy jz iq ng b gy nk nl l nm nn">#!/bin/bash</span><span id="ed48" class="jy jz iq ng b gy no nl l nm nn"># build docker image<br/>gcloud builds submit --tag gcr.io/&lt;project-id&gt;/docker-image . --project &lt;project-id&gt;</span><span id="796c" class="jy jz iq ng b gy no nl l nm nn"># restart instances (this loads new images)<br/>gcloud beta compute instance-groups managed rolling-action restart gcloud-docker-node-group --zone us-east1-b --project &lt;project-id&gt;</span></pre><p id="bd50" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">确保用您自己的项目ID替换<project-id>,如果您没有使用默认的，请更改区域。虽然我们的项目是由我们的CLI自动设置的，但我添加了<code class="fe np nq nr ng b">--project</code>标志，以防您需要一次为多个项目配置部署。</project-id></p><p id="5637" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">运行<code class="fe np nq nr ng b">chmod +x deploy.sh</code>启用权限。现在，如果您对代码做了任何更改，只需运行:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="8f6a" class="jy jz iq ng b gy nk nl l nm nn">./deploy.sh</span></pre><p id="a92f" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">部署新代码。</p><p id="1bdb" class="pw-post-body-paragraph mg mh iq kw b kx mv mi mj kz mw mk ml kh mx mn mo kl my mq mr kp mz mt mu le ij bi translated">就是这样！🤙我希望本教程对你有所帮助。我很想得到你的反馈，所以如果你喜欢或遇到任何问题，请在下面留下评论。请务必查看<a class="ae lj" href="https://medium.com/@francescovirga_50717/part-2-deploy-and-secure-mongodb-on-atlas-4820d539a1dc" rel="noopener">第2部分</a>！如果你有兴趣用Kubernetes做类似的事情，可以在这里查看我的帖子。</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><div class="nb nc nd ne gt oh"><a href="https://gitconnected.com/learn/node-js" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd ir gy z fp om fr fs on fu fw ip bi translated">学习Node.js -最佳Node.js教程(2019) | gitconnected</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">前33个Node.js教程-免费学习Node.js。课程由开发人员提交和投票，使您能够…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">gitconnected.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov jw oh"/></div></div></a></div></div></div>    
</body>
</html>