<html>
<head>
<title>Deploying an ML web app using Flask</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Flask部署ML web应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploying-ml-web-app-using-flask-334367735777?source=collection_archive---------15-----------------------#2021-09-14">https://levelup.gitconnected.com/deploying-ml-web-app-using-flask-334367735777?source=collection_archive---------15-----------------------#2021-09-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5d2dbdc28d03ca3069a13facab94194d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yxfY6EIyDwptkUq7YgwX1g.png"/></div></div></figure><h2 id="d265" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">简介</strong></h2><p id="78c3" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">这是我的项目分析贷款数据和使用Flask部署机器学习模型的继续。如果你对分析和建模部分感兴趣，请阅读<a class="ae lp" href="https://medium.com/@sumitkr_51302/loan-data-analysis-and-payoff-prediction-c77626697129" rel="noopener">这篇</a>。Flask提供了一个轻量级框架来开发和部署web应用程序。有许多扩展可以满足您的特定需求。我选择Flask是因为我发现它更容易学习，并在行动中展示我的机器学习模型。在这篇文章中，我将介绍使用Flask构建和部署我的机器学习模型的步骤。</p><p id="5299" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated"><strong class="kw ir">安装</strong>:</p><p id="1f9f" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">您希望在您的虚拟环境中安装Flask。我使用Pycharm和pipenv来管理我的项目。</p><p id="0845" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated"><code class="fe lv lw lx ly b">pipenv install flask</code></p><p id="5a07" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated"><strong class="kw ir">项目结构:</strong></p><p id="2984" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">下面是我的项目的目录结构:</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="b694" class="jy jz iq ly b gy mh mi l mj mk">.<br/>├── app<br/>│ ├── run.py<br/>│ └── templates<br/>│ ├── index.html<br/>│ └── template.html<br/>├── data<br/>│ └── loan_data.csv<br/>├── model<br/>│ ├── classifier.py<br/>│ └── loan_data.pkl<br/>├── notebook<br/>│ └── loan_data.ipynb<br/>├── Pipfile<br/>├── Pipfile.lock<br/>├── README.md<br/>├── static<br/>│ ├── box_plot.png<br/>│ ├── correlation.png<br/>│ ├── credit_policy.png<br/>│ ├── histogram.png<br/>│ ├── installment.png<br/>│ ├── int_rate.png<br/>│ ├── purpose_paid_not_paid.png<br/>│ ├── purpose.png<br/>│ └── results.png<br/>└── util<br/> └── custom_transformer.py</span></pre><p id="a759" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">App文件夹特定于flask。让我们浏览一下每个文件，看看它们的内容和用途</p><p id="c933" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated"><strong class="kw ir"> run.py </strong></p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="2dbb" class="jy jz iq ly b gy mh mi l mj mk">import sys<br/>import os<br/>from pathlib import Path<br/><br/><strong class="ly ir">from flask import Flask, request, render_template</strong><br/>from joblib import load<br/>import pandas as pd<br/><br/># Add util directory to path<br/>curr_dir = sys.path[0]<br/>parent_dir = Path(curr_dir).parents[0]<br/>dir = os.path.join(parent_dir, 'util')<br/>sys.path.append(dir)<br/><br/>from custom_transformer import NumericalFeatures, CategoricalFeatures<br/><br/><strong class="ly ir">app = Flask(__name__)</strong><br/><br/><strong class="ly ir">model = load('../model/loan_data.pkl')</strong><br/><br/><br/><strong class="ly ir">@app.route('/')<br/>@app.route('/index.html')</strong><br/>def display():<br/>    return render_template("index.html")<br/><br/><br/><strong class="ly ir">@app.route('/predict', methods=['GET', 'POST'])</strong><br/>def predict():<br/>    test_data = list(request.form.values())<br/>    test_data = [[convert_to_float(s) for s in test_data]]<br/>    test_data = pd.DataFrame(test_data)<br/>    result = model.predict(pd.DataFrame(test_data))<br/>    if result == 1:<br/>        string = "Loan is not expected to be paid in full"<br/>    else:<br/>        string = "Loan is expected to be paid off"<br/><br/>    # return render_template("index.html", tables=[test_data.to_html(classes='data')], titles=test_data.columns.values)<br/>    return render_template("index.html", result= "Prediction: " + string)<br/><br/><br/>def convert_to_float(s):<br/>    try:<br/>        return float(s)<br/>    except ValueError:<br/>        return s<br/><br/><br/><strong class="ly ir">def main():<br/>    app.run(port=3201, debug=True)</strong><br/><br/><br/>if __name__ == '__main__':<br/>    main()</span></pre><p id="1ee1" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">run.py是用来启动应用程序的主程序。</p><ul class=""><li id="7e15" class="ml mm iq kw b kx lq lb lr kh mn kl mo kp mp lo mq mr ms mt bi translated">Flask对象在web服务器和python应用程序之间创建一个接口</li><li id="1355" class="ml mm iq kw b kx mu lb mv kh mw kl mx kp my lo mq mr ms mt bi translated">服务器一启动，模型的pickled文件就被加载到内存中</li><li id="500b" class="ml mm iq kw b kx mu lb mv kh mw kl mx kp my lo mq mr ms mt bi translated">请求允许我们读取通过GET/POST请求传递的参数</li><li id="a471" class="ml mm iq kw b kx mu lb mv kh mw kl mx kp my lo mq mr ms mt bi translated">render_template是我们使用模板在web浏览器中渲染HTML的方式</li><li id="a5b7" class="ml mm iq kw b kx mu lb mv kh mw kl mx kp my lo mq mr ms mt bi translated">decorator app.route用于将特定的url与相关的函数进行映射。在我上面的代码中，当有对index.html的请求或者没有请求特定页面时，display()函数被调用。同样，当在服务器上请求/predict时，会调用predict()函数。</li></ul><p id="e6bd" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated"><strong class="kw ir">template.html</strong></p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="098d" class="jy jz iq ly b gy mh mi l mj mk">&lt;!doctype html&gt;<br/>&lt;html lang="en"&gt;<br/>  &lt;head&gt;<br/>    &lt;meta charset="utf-8"&gt;<br/>    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;<br/>    &lt;meta name="description" content=""&gt;<br/>    &lt;meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors"&gt;<br/>    &lt;meta name="generator" content="Hugo 0.84.0"&gt;<br/>    &lt;title&gt; {{ title }} &lt;/title&gt;<br/><br/>    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"&gt;<br/>    &lt;link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/navbars/"&gt;<br/><br/>  &lt;/head&gt;<br/>  &lt;body&gt;<br/>  &lt;nav class="navbar navbar-expand-lg navbar-dark bg-dark" aria-label="Tenth navbar example"&gt;<br/>    &lt;div class="container-fluid"&gt;<br/>      &lt;button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample08" aria-controls="navbarsExample08" aria-expanded="false" aria-label="Toggle navigation"&gt;<br/>        &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;<br/>      &lt;/button&gt;<br/><br/>      &lt;div class="collapse navbar-collapse justify-content-md-center" id="navbarsExample08"&gt;<br/>        &lt;ul class="navbar-nav"&gt;<br/>          &lt;li class="nav-item"&gt;<br/>            &lt;a class="nav-link active" aria-current="page" href="/"&gt;Loan Payoff Predictor&lt;/a&gt;<br/>          &lt;/li&gt;<br/>          &lt;li class="nav-item"&gt;<br/>            &lt;a class="nav-link" aria-current="page" target="_blank" href="https://github.com/sumitkumar-00/disaster-response/blob/master/notebook/process_data.ipynb"&gt;Exploratory Data Analysis&lt;/a&gt;<br/>          &lt;/li&gt;<br/>          &lt;li class="nav-item"&gt;<br/>            &lt;a class="nav-link" target="_blank" href="https://github.com/sumitkumar-00"&gt;GitHub Portfolio&lt;/a&gt;<br/>          &lt;/li&gt;<br/>          &lt;!--<br/>          &lt;li class="nav-item"&gt;<br/>            &lt;a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true"&gt;Disabled&lt;/a&gt;<br/>          &lt;/li&gt;<br/>          &lt;li class="nav-item dropdown"&gt;<br/>            &lt;a class="nav-link dropdown-toggle" href="#" id="dropdown08" data-bs-toggle="dropdown" aria-expanded="false"&gt;Dropdown&lt;/a&gt;<br/>            &lt;ul class="dropdown-menu" aria-labelledby="dropdown08"&gt;<br/>              &lt;li&gt;&lt;a class="dropdown-item" href="#"&gt;Action&lt;/a&gt;&lt;/li&gt;<br/>              &lt;li&gt;&lt;a class="dropdown-item" href="#"&gt;Another action&lt;/a&gt;&lt;/li&gt;<br/>              &lt;li&gt;&lt;a class="dropdown-item" href="#"&gt;Something else here&lt;/a&gt;&lt;/li&gt;<br/>            &lt;/ul&gt;<br/>          &lt;/li&gt;<br/>          --&gt;<br/>        &lt;/ul&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  &lt;/nav&gt;<br/>&lt;/div&gt;<br/><br/> <strong class="ly ir"> {% block index %}<br/>  {% endblock %}</strong><br/><br/> &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="139f" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">您使用模板来呈现网页的一部分，该部分在多个页面中是相同的，并带有动态内容的占位符。使用template.html，我正在创建标题(导航，菜单等。)并有一个以粗体显示的动态内容占位符。我在index.html扩展了这个模板，并添加了一个带有提交按钮和结果占位符的表单。当提交表单时，请求被路由到预测函数，该函数读取输入参数，然后使用模型进行预测。使用相同的index.html模板渲染结果。</p><p id="5a8c" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">您只需要执行app文件夹中的一行代码来启动web应用程序</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="1d81" class="jy jz iq ly b gy mh mi l mj mk">pipenv run python run.py</span><span id="079a" class="jy jz iq ly b gy mz mi l mj mk">* Serving Flask app 'run' (lazy loading)<br/>* Environment: production<br/>WARNING: This is a development server. Do not use it in a production deployment.<br/>Use a production WSGI server instead.<br/>* Debug mode: on<br/>* Running on http://127.0.0.1:3201/ (Press CTRL+C to quit)* Restarting with stat<br/>* Debugger is active!<br/>* Debugger PIN: 117-271-466<br/>127.0.0.1 - - [13/Sep/2021 21:18:02] "GET / HTTP/1.1" 200 -</span></pre><p id="7175" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">在任意浏览器和viola中进入<a class="ae lp" href="http://127.0.0.1:3201/" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:3201/ </a>！</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/9d16ec72b02dc2b39af903d501b3fcab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tBrJFupZdf7FEw7KdYGY3g.png"/></div></div></figure><p id="46af" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">如果你有兴趣看代码，请访问我的知识库<a class="ae lp" href="https://github.com/sumitkumar-00/loan-payoff-predictor" rel="noopener ugc nofollow" target="_blank">这里</a>。请随意提出任何改进意见。感谢您花时间阅读我的帖子。</p></div></div>    
</body>
</html>