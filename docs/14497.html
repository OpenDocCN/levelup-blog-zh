<html>
<head>
<title>Deploying Like Vercel and Netlify with Cloud Run: Live, Preview, and Modern Workflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">像Vercel和Netlify一样部署云运行:实时、预览和现代工作流</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploying-like-vercel-and-netlify-with-cloud-run-live-preview-and-modern-workflow-ea661e411136?source=collection_archive---------6-----------------------#2022-12-02">https://levelup.gitconnected.com/deploying-like-vercel-and-netlify-with-cloud-run-live-preview-and-modern-workflow-ea661e411136?source=collection_archive---------6-----------------------#2022-12-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6bb0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">现代化的工作流程释放了您的团队更快发货的潜力。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e93c796dd4e220952de5743edb894921.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n9Qi-8I_dIl0cVkXUZdFew.png"/></div></div></figure><h1 id="d9b0" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">TL；速度三角形定位法(dead reckoning)</h1><ul class=""><li id="cdde" class="lm ln it lo b lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">☁️:我们将学习如何在谷歌云上部署</li><li id="4712" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">✨:我们将学习如何用GitHub Actions设计和实现一个现代化的工作流程</li><li id="2451" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">🤿:我们将看到真实世界工作流程的代码片段</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><p id="532a" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">如果你想学习如何部署像<a class="ae nf" href="https://vercel.com/features/previews" rel="noopener ugc nofollow" target="_blank"> Vercel </a>或<a class="ae nf" href="https://www.netlify.com/products/deploy-previews/" rel="noopener ugc nofollow" target="_blank"> Netlify </a>与<a class="ae nf" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> Google Cloud </a>，这是适合你的地方。</p><p id="e072" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">Vercel和Netlify都提供了从开发到发布特性的无缝过渡，并且它们使得<a class="ae nf" href="http://localhost:3000/articles/ex-principal-engineers-guide-to-design-thinking-and-continous-delivery#what-is-continuous-delivery" rel="noopener ugc nofollow" target="_blank">连续交付</a>开箱即用。今天，我们将了解如何设计和重新创建带有<a class="ae nf" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">云运行</a>和<a class="ae nf" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub操作</a>的实时部署和<a class="ae nf" href="https://vercel.com/features/previews" rel="noopener ugc nofollow" target="_blank">部署预览</a>。</p><p id="4a1b" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">我们走吧。</p><h1 id="0920" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">现代工作流设计</h1><p id="d5e4" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt ng mx my lv nh na nb lx ni nd ne lz im bi translated">如果你熟悉<a class="ae nf" href="https://vercel.com/" rel="noopener ugc nofollow" target="_blank"> Vercel </a>或<a class="ae nf" href="https://www.netlify.com/" rel="noopener ugc nofollow" target="_blank"> Netlify </a>，你会注意到默认情况下<a class="ae nf" href="https://cloud.google.com/architecture/devops/devops-tech-trunk-based-development" rel="noopener ugc nofollow" target="_blank">基于主干的开发</a>原则。当向主<em class="nj">分支</em>推送提交或合并拉取请求时，您的代码会直接更改为<strong class="lo iu"> live </strong>。</p><p id="c3d1" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">每当您处理一个拉式请求时，两个平台都会创建<strong class="lo iu">部署预览</strong>，这样您就可以在开发过程中从您的评审者和利益相关者那里收集反馈。这种类型的工作流使我们能够尽早协作，减少错误，快速发货。</p><p id="00fe" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">为了设计工作流程，我们可以将其分为两条路径:</p><ul class=""><li id="a60f" class="lm ln it lo b lp ms lr mu lt nk lv nl lx nm lz ma mb mc md bi translated">生产工作流程:由<em class="nj">主</em>分支的<em class="nj">推</em>事件触发。</li><li id="b100" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">预览工作流:由除<em class="nj">主</em>外的所有分支中的<em class="nj"> push </em>和<em class="nj"> pull_request </em>事件触发。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e1d99da263ce7281930a7106209580a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FG4AtIJr76cEnNhbeeChSQ.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">工作流程概述</figcaption></figure><p id="aedc" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">让我们先来看看<em class="nj">生产流程</em>。</p><h1 id="a075" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">生产工作流程</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/04955f64a87c5db19e9a8e10b66b9552.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8eCoI9JsRwtmp3JRj_Vh_g.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">生产工作流程概述</figcaption></figure><p id="b508" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">生产工作流只做一件事:实时部署。当一个pull请求合并到<em class="nj"> main </em>中时，它触发工作流将您的生产构建部署到<a class="ae nf" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">云运行</a>。</p><p id="dbf8" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">工作流程如下所示:</p><p id="a758" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">设置谷歌云</p><ul class=""><li id="67ce" class="lm ln it lo b lp ms lr mu lt nk lv nl lx nm lz ma mb mc md bi translated">向谷歌云认证</li><li id="d2c5" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">设置谷歌<a class="ae nf" href="https://cloud.google.com/sdk" rel="noopener ugc nofollow" target="_blank">云SDK </a></li><li id="cdfa" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">授权将docker容器推送到<a class="ae nf" href="https://cloud.google.com/artifact-registry" rel="noopener ugc nofollow" target="_blank">工件注册表</a></li></ul><p id="efb4" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">将Docker图像推送到工件注册表</p><ul class=""><li id="0d2f" class="lm ln it lo b lp ms lr mu lt nk lv nl lx nm lz ma mb mc md bi translated">生成图像标签</li><li id="939c" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">构建docker容器</li><li id="c9a8" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">将docker容器推送到注册表</li></ul><p id="21f0" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">部署</p><ul class=""><li id="7913" class="lm ln it lo b lp ms lr mu lt nk lv nl lx nm lz ma mb mc md bi translated">部署到云运行</li></ul><h1 id="4307" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">设置谷歌云</h1><blockquote class="nr ns nt"><p id="8b7b" class="mq mr nj lo b lp ms ju mt lr mu jx mv nu mw mx my nv mz na nb nw nc nd ne lz im bi translated"><em class="it">如果你还没有Google Cloud上的项目，请按照本指南</em>  <em class="it">创建一个。我将把我的项目命名为</em> awesome-project <em class="it">。</em></p></blockquote><p id="9b8f" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">为了认证访问Google Cloud的工作流，我们可以使用GitHub的<a class="ae nf" href="https://github.com/google-github-actions/auth" rel="noopener ugc nofollow" target="_blank"> <em class="nj"> auth </em> </a>动作来创建一个访问令牌:</p><pre class="kj kk kl km gt nx ny nz bn oa ob bi"><span id="40bb" class="oc kv it ny b be od oe l of og">env:<br/>  PROJECT_ID: 'awesome-project'<br/>  SERVICE: 'homepage'<br/>  REGION: 'us-west1' # ☘️Low CO2<br/>  REGISTRY: '[YOUR_REGISTRY_ID]'<br/>  IMAGE_NAME: 'live'<br/>  WORKLOAD_IDENTITY_PROVIDER: '[YOUR_WORKLOAD_PROVIDER_ID]'<br/>  SERVICE_ACCOUNT: '[YOUR_SERVICE_ACCOUNT_ID]'<br/><br/>jobs:<br/>  deploy:<br/>    runs-on: ubuntu-20.04<br/>  steps:<br/>      - name: Checkout<br/>        uses: actions/checkout@v3<br/>      <br/>      - name: 'Authenticate to Google Cloud'<br/>        uses: 'google-github-actions/auth@v0.4.0'<br/>        id: 'auth'<br/>        with:<br/>          token_format: 'access_token'<br/>          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}<br/>          service_account: ${{ env.SERVICE_ACCOUNT }}</span></pre><p id="7dc7" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">这里我们通过<a class="ae nf" href="https://cloud.google.com/iam/docs/workload-identity-federation" rel="noopener ugc nofollow" target="_blank">工作负载身份联盟</a>进行认证。为了让它工作，我们需要</p><ul class=""><li id="bf89" class="lm ln it lo b lp ms lr mu lt nk lv nl lx nm lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys" rel="noopener ugc nofollow" target="_blank">服务账户</a></li><li id="6a11" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/iam/docs/configuring-workforce-identity-federation" rel="noopener ugc nofollow" target="_blank">一个工作负载身份提供者</a></li><li id="5918" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/blog/products/identity-security/enabling-keyless-authentication-from-github-actions" rel="noopener ugc nofollow" target="_blank">向工作负载身份提供者授予IAM角色</a>。</li></ul><p id="fcb3" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">恭喜你，你成功了！这是工作流程中最困难的部分。</p><p id="f954" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">现在，我们可以设置Cloud SDK并授权工作流能够将Docker容器推送到工件注册表:</p><pre class="kj kk kl km gt nx ny nz bn oa ob bi"><span id="0f48" class="oc kv it ny b be od oe l of og">steps:<br/>  - name: Set up Cloud SDK<br/>    uses: google-github-actions/setup-gcloud@v0<br/>  - name: Authorize Docker push<br/>    run: gcloud auth configure-docker ${{ env.REGISTRY }}</span></pre><p id="bd8e" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">您可以按照本指南来设置工件注册表以存储Docker容器。</p><h1 id="9218" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">将Docker图像推送到工件注册表</h1><p id="4ee2" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt ng mx my lv nh na nb lx ni nd ne lz im bi translated">我们现在能够推送容器，因此让我们对您的项目进行分类并标记您的图像:</p><pre class="kj kk kl km gt nx ny nz bn oa ob bi"><span id="31ff" class="oc kv it ny b be od oe l of og">steps:<br/>  - name: Generate Image Tag<br/>    id: image-tag<br/>    run: |<br/>      image_tag="$REGISTRY/$PROJECT_ID/$SERVICE/$IMAGE_NAME:${GITHUB_SHA::8}"<br/>      echo "tag=$image_tag" &gt;&gt; $GITHUB_OUTPUT<br/>  <br/>  - name: Build Docker Container<br/>    run: |<br/>      docker build -t ${{ steps.image-tag.outputs.tag }}<br/>  <br/>  - name: Push Docker Container<br/>    run: |<br/>      docker push ${{ steps.image-tag.outputs.tag }}</span></pre><h1 id="b6ea" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">部署</h1><p id="81ac" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt ng mx my lv nh na nb lx ni nd ne lz im bi translated">现在，您已经准备好使用docker容器部署到云运行了:</p><pre class="kj kk kl km gt nx ny nz bn oa ob bi"><span id="30d2" class="oc kv it ny b be od oe l of og">steps:<br/>  - name: Deploy to Cloud Run<br/>    run: |<br/>      gcloud run deploy ${{ env.SERVICE }} \<br/>        --platform "managed"<br/>        --region ${{ env.REGION }} \<br/>        --image ${{ steps.image-tag.outputs.tag }}</span></pre><p id="146c" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">默认情况下，Cloud Run会将100%的流量分配给此部署，因此所有访问者都将被定向到此版本。</p><p id="f11a" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">在云控制台中，您会找到一个指向您的云运行部署的URL。大概是这样的:<a class="ae nf" href="https://homepage-12345abcde-ez.a.run.app/" rel="noopener ugc nofollow" target="_blank"><em class="nj">https://home page-12345 abcde-ez . a . run . app</em></a>。我们稍后会在预览工作流中用到它。</p><h1 id="c0f0" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">完整的GitHub Actions制作工作流程:</h1><pre class="kj kk kl km gt nx ny nz bn oa ob bi"><span id="23aa" class="oc kv it ny b be od oe l of og"># prod-ci.yaml<br/><br/>name: Production Workflow<br/>on:<br/>  push:<br/>    branches:<br/>      - main<br/>env:<br/>  PROJECT_ID: 'awesome-project'<br/>  SERVICE: 'homepage'<br/>  REGION: 'us-west1' # ☘️Low CO2<br/>  REGISTRY: '[YOUR_REGISTRY_ID]'<br/>  IMAGE_NAME: 'live'<br/>  WORKLOAD_IDENTITY_PROVIDER: '[YOUR_WORKLOAD_PROVIDER_ID]'<br/>  SERVICE_ACCOUNT: '[YOUR_SERVICE_ACCOUNT_ID]'<br/>jobs:<br/>  deploy:<br/>    runs-on: ubuntu-20.04<br/>    steps:<br/>      - name: Checkout<br/>        uses: actions/checkout@v3<br/><br/>      - name: 'Authenticate to Google Cloud'<br/>        uses: 'google-github-actions/auth@v0.4.0'<br/>        id: 'auth'<br/>        with:<br/>          token_format: 'access_token'<br/>          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}<br/>          service_account: ${{ env.SERVICE_ACCOUNT }}<br/><br/>      - name: Set up Cloud SDK<br/>        uses: google-github-actions/setup-gcloud@v0<br/>  <br/>      - name: Authorize Docker push<br/>        run: gcloud auth configure-docker ${{ env.REGISTRY }}<br/>  <br/>      - name: Generate Image Tag<br/>        id: image-tag<br/>        run: |<br/>          image_tag="$REGISTRY/$PROJECT_ID/$SERVICE/$IMAGE_NAME:${GITHUB_SHA::8}"<br/>          echo "tag=$image_tag" &gt;&gt; $GITHUB_OUTPUT<br/><br/>      - name: Build Docker Container<br/>        run: |<br/>          docker build -t ${{ steps.image-tag.outputs.tag }}<br/><br/>      - name: Push Docker Container<br/>        run: |<br/>          docker push ${{ steps.image-tag.outputs.tag }}<br/> <br/>      - name: Deploy to Cloud Run<br/>        run: |<br/>          gcloud run deploy ${{ env.SERVICE }} \<br/>            --platform "managed"<br/>            --region ${{ env.REGION }} \<br/>            --image ${{ steps.image-tag.outputs.tag }}</span></pre><h1 id="9012" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">预览工作流</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f9d8335563e0cb05853bc85f149b90cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5IUmd87xiUPMax2yaHa1iQ.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">预览工作流概述</figcaption></figure><p id="dfde" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">预览工作流类似于生产工作流，但有一些修改:</p><p id="3c79" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">设置谷歌云</p><ul class=""><li id="2284" class="lm ln it lo b lp ms lr mu lt nk lv nl lx nm lz ma mb mc md bi translated">向谷歌云认证</li><li id="11b2" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">设置谷歌<a class="ae nf" href="https://cloud.google.com/sdk" rel="noopener ugc nofollow" target="_blank">云SDK </a></li><li id="3bb7" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">授权将docker容器推送到<a class="ae nf" href="https://cloud.google.com/artifact-registry" rel="noopener ugc nofollow" target="_blank">工件注册表</a></li></ul><p id="5e33" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">将Docker图像推送到工件注册表</p><ul class=""><li id="54cb" class="lm ln it lo b lp ms lr mu lt nk lv nl lx nm lz ma mb mc md bi translated"><strong class="lo iu">从引用中获取任务Id</strong></li><li id="2542" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">生成图像标签</li><li id="bdcc" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">构建docker容器</li><li id="89ee" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">将docker容器推送到注册表</li></ul><p id="8ecd" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">部署</p><ul class=""><li id="5df3" class="lm ln it lo b lp ms lr mu lt nk lv nl lx nm lz ma mb mc md bi translated"><strong class="lo iu">部署标签为</strong>的版本</li><li id="d471" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><strong class="lo iu">拉取请求中的注释预览URL</strong></li></ul><p id="c2bc" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">让我们来看看不同之处。</p><h1 id="f652" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">将Docker图像推送到工件注册表</h1><p id="e876" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt ng mx my lv nh na nb lx ni nd ne lz im bi translated">第一个区别是标记Docker图像。在生产工作流程中，我们在环境变量中使用常量<code class="fe oh oi oj ny b">$IMAGE_NAME</code>来标记生产图像。但是，对于预览，我们希望使用一个表示拉请求的标识符。我们使用分行名称的前8个字符作为标识符:</p><pre class="kj kk kl km gt nx ny nz bn oa ob bi"><span id="91dc" class="oc kv it ny b be od oe l of og">steps:<br/>  - name: Get Task Id from Reference<br/>  id: task<br/>  run: |<br/>    name="${{ github.ref_name }}"<br/>    lowercase="${name,,}"<br/>    echo "id=${lowercase:0:8}" &gt;&gt; $GITHUB_OUTPUT</span></pre><p id="e88b" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">作为一个例子，我将这个分支命名为<em class="nj">TASK-123-awesome-workflow</em>。<em class="nj">任务</em>步骤将从分支名称中提取任务ID <em class="nj"> task-123 </em>。</p><blockquote class="nr ns nt"><p id="1443" class="mq mr nj lo b lp ms ju mt lr mu jx mv nu mw mx my nv mz na nb nw nc nd ne lz im bi translated"><em class="it">如果你对shell脚本语法很好奇，可以看看</em> <a class="ae nf" href="https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html" rel="noopener ugc nofollow" target="_blank"> <em class="it"> Shell参数扩展</em> </a> <em class="it">。</em></p></blockquote><p id="eae1" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">标识符设置为小写，因为我们稍后将使用它来标记云运行版本。<a class="ae nf" href="https://cloud.google.com/run/docs/rollouts-rollbacks-traffic-migration#tags" rel="noopener ugc nofollow" target="_blank">云运行标签</a>的命名约定如下:</p><ul class=""><li id="74da" class="lm ln it lo b lp ms lr mu lt nk lv nl lx nm lz ma mb mc md bi translated">它允许小写字符</li><li id="70a0" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">它允许数字</li><li id="2bbf" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">它允许“-”</li><li id="bfa8" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">它的最大长度限制为63个字符</li></ul><p id="65fd" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">接下来，我们可以使用任务id来标记图像，构建一个容器，并将其推送到注册表:</p><pre class="kj kk kl km gt nx ny nz bn oa ob bi"><span id="641f" class="oc kv it ny b be od oe l of og">steps:<br/>  - name: Generate Image Tag<br/>    id: image-tag<br/>    run: |<br/>      image_tag="$REGISTRY/$PROJECT_ID/$SERVICE/${{ steps.task.outputs.id }}:${GITHUB_SHA::8}"<br/>      echo "tag=$image_tag" &gt;&gt; $GITHUB_OUTPUT<br/><br/>  - name: Build Docker Container<br/>    run: |<br/>      docker build -t ${{ steps.image-tag.outputs.tag }}<br/><br/>  - name: Push Docker Container<br/>    run: |<br/>      docker push ${{ steps.image-tag.outputs.tag }}</span></pre><h1 id="d6a4" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">部署</h1><p id="d7f6" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt ng mx my lv nh na nb lx ni nd ne lz im bi translated">现在我们已经准备好部署预览版了。该部署类似于实时部署，但有两个不同之处:</p><ul class=""><li id="fa54" class="lm ln it lo b lp ms lr mu lt nk lv nl lx nm lz ma mb mc md bi translated">与实时部署不同，我们希望将0%的流量分配给预览版。</li><li id="5ce2" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">我们希望为部署提供一个不同于实时URL的URL。</li></ul><p id="f592" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">我们可以使用<em class="nj"> —标签</em>和<em class="nj"> —无流量</em>参数来实现:</p><pre class="kj kk kl km gt nx ny nz bn oa ob bi"><span id="5b3a" class="oc kv it ny b be od oe l of og">steps:<br/>  - name: Deploy Revision with Tag<br/>      run: |<br/>        gcloud run deploy ${{ env.SERVICE }} \<br/>          --platform "managed" \<br/>          --region ${{ env.REGION }} \<br/>          --image ${{ steps.image-tag.outputs.tag }} \<br/>          --tag pr-${{ steps.task.outputs.id }} \<br/>          --no-traffic</span></pre><p id="7109" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">成功运行该步骤后，会得到这样的预览网址:<a class="ae nf" href="https://pr-task-123---homepage-12345abcde-ez.a.run.app/" rel="noopener ugc nofollow" target="_blank"><em class="nj">https://pr-task-123-home page-12345 abcde-ez . a . run . app</em></a>。</p><p id="d2da" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">最后，我们可以在pull请求上发布关于预览URL的注释:</p><pre class="kj kk kl km gt nx ny nz bn oa ob bi"><span id="6e62" class="oc kv it ny b be od oe l of og">steps:<br/>  - name: Comment Preview URL in PR<br/>    uses: mshick/add-pr-comment@v2<br/>    env:<br/>      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}<br/>    with:<br/>      message: |<br/>        🍿 Successfully deployed preview revision at https://pr-${{ steps.jira.outputs.id }}---homepage-12345abcde-ez.a.run.app<br/>      allow-repeats: false</span></pre><h1 id="3278" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">完整的GitHub动作预览工作流程</h1><pre class="kj kk kl km gt nx ny nz bn oa ob bi"><span id="ead7" class="oc kv it ny b be od oe l of og"># preview.yaml<br/><br/>name: Preview Workflow<br/>on:<br/>  push:<br/>    branches-ignore:<br/>      - main<br/>  pull_request:<br/>    branches-ignore:<br/>      - main<br/>  workflow_run:<br/>    workflows: ['Dev CI']<br/>    types: [completed]<br/>env:<br/>  PROJECT_ID: 'awesome-project'<br/>  SERVICE: 'homepage'<br/>  REGION: 'us-west1'<br/>  REGISTRY: '[YOUR_REGISTRY_ID]'<br/>  WORKLOAD_IDENTITY_PROVIDER: '[YOUR_WORKLOAD_PROVIDER_ID]'<br/>  SERVICE_ACCOUNT: '[YOUR_SERVICE_ACCOUNT_ID]'<br/>jobs:<br/>  preview:<br/>    runs-on: ubuntu-20.04<br/><br/>    permissions:<br/>      pull-requests: 'write'<br/><br/>    steps:<br/>      - name: Checkout<br/>        uses: actions/checkout@v3<br/><br/>      - name: 'Authenticate to Google Cloud'<br/>        uses: 'google-github-actions/auth@v0.4.0'<br/>        id: 'auth'<br/>        with:<br/>          token_format: 'access_token'<br/>          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}<br/>          service_account: ${{ env.SERVICE_ACCOUNT }}<br/><br/>      - name: Set up Cloud SDK<br/>        uses: google-github-actions/setup-gcloud@v0<br/><br/>      - name: Authorize Docker push<br/>        run: gcloud auth configure-docker ${{ env.REGISTRY }}<br/><br/>      # Get task id in lowercase from branch name for docker image naming convention<br/>      # More detail on base parameter expansion: https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html<br/>      - name: Get Task Id from Reference<br/>        id: task<br/>        run: |<br/>          name="${{ github.ref_name }}"<br/>          lowercase="${name,,}"<br/>          echo "id=${lowercase:0:8}" &gt;&gt; $GITHUB_OUTPUT<br/><br/>      - name: Generate Image Tag<br/>        id: image-tag<br/>        run: |<br/>          image_tag="$REGISTRY/$PROJECT_ID/$SERVICE/${{ steps.task.outputs.id }}:${GITHUB_SHA::8}"<br/>          echo "tag=$image_tag" &gt;&gt; $GITHUB_OUTPUT<br/><br/>      - name: Build Docker Container<br/>        run: |<br/>          docker build -t ${{ steps.image-tag.outputs.tag }}<br/> <br/>      - name: Push Docker Container<br/>        run: |<br/>          docker push ${{ steps.image-tag.outputs.tag }}<br/><br/>      - name: Deploy Revision with Tag<br/>        run: |<br/>          gcloud run deploy ${{ env.SERVICE }} \<br/>            --platform "managed" \<br/>            --region ${{ env.REGION }} \<br/>            --image ${{ steps.image-tag.outputs.tag }} \<br/>            --tag pr-${{ steps.jira.outputs.id }} \<br/>            --no-traffic<br/><br/>      - name: Comment Preview URL in PR<br/>        uses: mshick/add-pr-comment@v2<br/>        env:<br/>          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}<br/>        with:<br/>          message: |<br/>            🍿 Successfully deployed preview revision at https://pr-${{ steps.jira.outputs.id }}---homepage-12345abcde-ez.a.run.app<br/>          allow-repeats: false</span></pre><h1 id="c473" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">最后的想法</h1><p id="e68e" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt ng mx my lv nh na nb lx ni nd ne lz im bi translated">我们刚刚重新创建了Vercel和Netlify的现代工作流程！有一些改进使工作流更加健壮:</p><ul class=""><li id="6b64" class="lm ln it lo b lp ms lr mu lt nk lv nl lx nm lz ma mb mc md bi translated">使用短哈希作为标识符来标记预览图像和云运行版本</li><li id="9bf4" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">用预览注释步骤中的步骤输出替换硬编码的实时URL</li><li id="cfa2" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">添加清理未使用的云运行版本和Docker容器的工作流</li></ul><h1 id="9bad" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">参考</h1><ul class=""><li id="0af1" class="lm ln it lo b lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><a class="ae nf" href="https://github.com/google-github-actions/auth" rel="noopener ugc nofollow" target="_blank"> GitHub: auth GitHub动作</a></li><li id="535b" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/blog/products/identity-security/enabling-keyless-authentication-from-github-actions" rel="noopener ugc nofollow" target="_blank">文章:从GitHub Actions启用无钥匙认证— Google Cloud </a></li><li id="da63" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://vercel.com/features/previews" rel="noopener ugc nofollow" target="_blank">网站:Vercel预览</a></li><li id="ac23" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://www.netlify.com/products/deploy-previews/" rel="noopener ugc nofollow" target="_blank">网址:Netlify部署预览</a></li><li id="fe3d" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://vercel.com/" rel="noopener ugc nofollow" target="_blank">网址:Vercel </a></li><li id="80ef" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://www.netlify.com/" rel="noopener ugc nofollow" target="_blank">网址:Netlify </a></li><li id="43cf" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html" rel="noopener ugc nofollow" target="_blank">文档:Shell参数扩展— GNU </a></li><li id="e8f8" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云</a></li><li id="9782" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="http://localhost:3000/articles/ex-principal-engineers-guide-to-design-thinking-and-continous-delivery#what-is-continuous-delivery" rel="noopener ugc nofollow" target="_blank">文章:前首席工程师的设计思维和持续交付指南——刘道智</a></li><li id="75be" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">文档:云运行—谷歌云</a></li><li id="a0a9" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank">网站:GitHub Actions </a></li><li id="6180" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/architecture/devops/devops-tech-trunk-based-development" rel="noopener ugc nofollow" target="_blank">文档:DevOps tech:基于主干的开发— Google Cloud </a></li><li id="e560" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/artifact-registry" rel="noopener ugc nofollow" target="_blank">网站:神器注册表—谷歌云</a></li><li id="9f87" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/sdk" rel="noopener ugc nofollow" target="_blank">网址:Cloud SDK — Google Cloud </a></li><li id="2e5a" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/iam/docs/workload-identity-federation" rel="noopener ugc nofollow" target="_blank">文档:工作负载身份联盟—谷歌云</a></li><li id="8c53" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys" rel="noopener ugc nofollow" target="_blank">文档:创建和管理服务账号密钥-谷歌云</a></li><li id="bcc0" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/iam/docs/configuring-workforce-identity-federation" rel="noopener ugc nofollow" target="_blank">文档:配置劳动力身份联盟—谷歌云</a></li><li id="d284" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/artifact-registry/docs/docker/store-docker-container-images" rel="noopener ugc nofollow" target="_blank">文档:将Docker容器图像存储在工件注册表中——Google Cloud</a></li><li id="e739" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">文档:创建和管理项目—谷歌云</a></li><li id="aac6" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://cloud.google.com/run/docs/rollouts-rollbacks-traffic-migration#tags" rel="noopener ugc nofollow" target="_blank">文档:使用标签进行测试、流量迁移和回滚——Google Cloud</a></li><li id="b95d" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://github.com/mshick/add-pr-comment" rel="noopener ugc nofollow" target="_blank"> GitHub:添加公关评论</a></li><li id="220a" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://github.com/google-github-actions/setup-gcloud" rel="noopener ugc nofollow" target="_blank"> Github:设置-gcloud GitHub动作</a></li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><pre class="kj kk kl km gt nx ny nz bn oa ob bi"><span id="c7b4" class="oc kv it ny b be od oe l ok og">Want to Connect? This article was originally posted on <a class="ae nf" href="https://dawchihliou.github.io/articles/deploying-with-cloud-run-like-vercel-and-netlify" rel="noopener ugc nofollow" target="_blank">Daw-Chih’s website</a>.</span></pre></div></div>    
</body>
</html>