<html>
<head>
<title>Provision, setup, and secure a TinaCMS cloud editor on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS上供应、设置和保护TinaCMS云编辑器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/provision-setup-and-secure-a-tinacms-cloud-editor-on-aws-e96b0e060e7c?source=collection_archive---------5-----------------------#2020-06-24">https://levelup.gitconnected.com/provision-setup-and-secure-a-tinacms-cloud-editor-on-aws-e96b0e060e7c?source=collection_archive---------5-----------------------#2020-06-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/f53c728b6791bfa23dfada1104bfd0aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eaZlvbcPUsOR-ke5"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">在<a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae jg" href="https://unsplash.com/@pazarando?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Paz Arando </a>拍照</figcaption></figure><div class=""/><p id="af02" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我最近第一次与TinaCMS和Gatsby一起建立了一个网站，我发现开发过程相对顺利。我发现的一个明显的开发人员体验差距是在设置云编辑器方面，这也是我想在本教程中分享的。由于云编辑器脱离了开发构建，所以我不会在本教程中讨论TinaCMS生产构建和部署。如果你好奇的话，我使用了一个带有GitHub actions的CD过程来构建和部署新的静态资产到S3(带有CloudFront和静态web托管),在生产过程中对我的项目的主分支进行新的提交。</p><p id="8ffc" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们开始之前，我想解释一下，为了允许使用Gatsby对TinaCMS进行实时云编辑，您目前需要运行项目的两个独立实例；一个作为私有云编辑器，另一个作为您的生产网站。我相信一旦TinaCMS发布他们的“TinaCMS Teams”产品，这种情况可能会改变，但目前的推荐似乎是盖茨比云(【https://tinacms.org/blog/using-tinacms-on-gatsby-cloud】T4)，我发现由于他们的分支和“预览”限制，我的客户几乎无法使用。</p><p id="661e" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本教程将指导您使用Gatsby和AWS设置、供应和保护TinaCMS云编辑器。希望它能为你节省时间和金钱:-)。</p><p id="2a69" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">我会在本教程中定期链接提交，但这里是最终的</em><a class="ae jg" href="https://github.com/Integral-Stack/tinacms-cloud-editor-tutorial" rel="noopener ugc nofollow" target="_blank"><em class="le">Tina CMS-cloud-editor-tutorial</em></a><em class="le">repo。</em></p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="9c8f" class="lm ln jj bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">概观</h1><ul class=""><li id="525c" class="mk ml jj ki b kj mm kn mn kr mo kv mp kz mq ld mr ms mt mu bi translated"><a class="ae jg" href="#dd20" rel="noopener ugc nofollow">设置TinaCMS项目</a></li><li id="f657" class="mk ml jj ki b kj mv kn mw kr mx kv my kz mz ld mr ms mt mu bi translated"><a class="ae jg" href="#dbcd" rel="noopener ugc nofollow">为TinaCMS云编辑配置Gatsby</a></li><li id="819b" class="mk ml jj ki b kj mv kn mw kr mx kv my kz mz ld mr ms mt mu bi translated"><a class="ae jg" href="#fec7" rel="noopener ugc nofollow">给盖茨比添加认证</a></li><li id="6940" class="mk ml jj ki b kj mv kn mw kr mx kv my kz mz ld mr ms mt mu bi translated"><a class="ae jg" href="#0c5f" rel="noopener ugc nofollow">安全机密</a></li><li id="3f4c" class="mk ml jj ki b kj mv kn mw kr mx kv my kz mz ld mr ms mt mu bi translated"><a class="ae jg" href="#000c" rel="noopener ugc nofollow">设置AWS资源</a></li><li id="463b" class="mk ml jj ki b kj mv kn mw kr mx kv my kz mz ld mr ms mt mu bi translated"><a class="ae jg" href="#00c0" rel="noopener ugc nofollow">提供EC2实例</a></li><li id="a84e" class="mk ml jj ki b kj mv kn mw kr mx kv my kz mz ld mr ms mt mu bi translated"><a class="ae jg" href="#7a86" rel="noopener ugc nofollow">运行你的云编辑器</a></li><li id="537c" class="mk ml jj ki b kj mv kn mw kr mx kv my kz mz ld mr ms mt mu bi translated">我们该如何改进？</li></ul></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h2 id="dd20" class="na ln jj bd lo nb nc dn ls nd ne dp lw kr nf ng ma kv nh ni me kz nj nk mi nl bi translated">设置TinaCMS项目</h2><p id="6a72" class="pw-post-body-paragraph kg kh jj ki b kj mm kl km kn mn kp kq kr nm kt ku kv nn kx ky kz no lb lc ld im bi translated"><em class="le">在我们开始之前，请确保您的计算机上已经安装了node、npm和yarn。</em></p><p id="434f" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们从克隆规范的gatsby-starter-tinacms开始，安装依赖项并在本地运行项目以确保它按预期工作。如果您已经有了TinaCMS/Gatsby项目设置，那么您可以按照自己的项目进行操作。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="7174" class="na ln jj nu b gy ny nz l oa ob">git clone <a class="ae jg" href="https://github.com/tinacms/gatsby-starter-tinacms.git" rel="noopener ugc nofollow" target="_blank">https://github.com/tinacms/gatsby-starter-tinacms.git</a><br/>cd gatsby-starter-tinacms<br/>yarn install<br/>yarn start</span></pre><p id="0dcd" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果一切按预期运行，继续在GitHub上创建一个新的repo，将您的origin remote设置为新创建的repo，并推送您的代码。确保用您自己的url替换远程URL。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="f9ce" class="na ln jj nu b gy ny nz l oa ob">git remote set-url origin <a class="ae jg" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:user/project.git<br/>git push origin master</span></pre></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h2 id="dbcd" class="na ln jj bd lo nb nc dn ls nd ne dp lw kr nf ng ma kv nh ni me kz nj nk mi nl bi translated">为TinaCMS云编辑配置Gatsby</h2><p id="8e9d" class="pw-post-body-paragraph kg kh jj ki b kj mm kl km kn mn kp kq kr nm kt ku kv nn kx ky kz no lb lc ld im bi translated">如果你导航到你的<code class="fe oc od oe nu b">gatsby-config.js</code>文件，你会看到TinaCMS通过一个插件被激活。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="ccc6" class="na ln jj nu b gy ny nz l oa ob">{<br/>  resolve: "gatsby-plugin-tinacms",<br/>  options: {<br/>    plugins: ["gatsby-tinacms-git", "gatsby-tinacms-remark", "gatsby-tinacms-json"],<br/>    sidebar: {<br/>      hidden: process.env.NODE_ENV === "production",<br/>      position: "displace"<br/>    },<br/>  },<br/>},</span></pre><p id="5f3e" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe oc od oe nu b">gatsby-tinacms-git</code>的子插件将允许我们的编辑器在更新时与我们的git repo对话，所以如果你从你自己的项目开始跟进，确保你安装并添加了这个插件。此外，请注意在为生产构建应用程序时隐藏编辑器“侧边栏”的配置。这与我们想要实现的目标一致。</p><p id="2fb0" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了通知我们的云编辑器它需要在哪里推送内容更新，让我们用更详细的配置替换<code class="fe oc od oe nu b">gatsby-tinacms-git</code>插件的声明。确保用git远程repo的SSH地址替换<code class="fe oc od oe nu b">gitRemote</code>值。您可以随意用您喜欢的任何内容替换提交信息。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="d11f" class="na ln jj nu b gy ny nz l oa ob">{<br/>  resolve: "gatsby-plugin-tinacms",<br/>  options: {<br/>    plugins: [{<br/>      resolve: "gatsby-tinacms-git",<br/>      options: {<br/>        gitRemote: "<a class="ae jg" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:user/project.git",<br/>      <!-- -->  defaultCommitMessage: 'Edited with TinaCMS',<br/>        defaultCommitName: 'Cloud Editor',<br/>        defaultCommitEmail: 'git@project.com',<br/>      },<br/>    }, "gatsby-tinacms-remark", "gatsby-tinacms-json"],<br/>    sidebar: {<br/>      hidden: process.env.NODE_ENV === "production",<br/>      position: "displace"<br/>    },<br/>  },<br/>},</span></pre><p id="8556" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您的本地TinaCMS编辑器现在应该已经连接到您在GitHub上的项目了。继续前进，导航到<code class="fe oc od oe nu b">http://localhost:8000</code>的博客，点击浏览器左下方的蓝色铅笔，做一些文本修改，然后点击“保存”。</p><p id="5fb5" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您刚刚创建了一个从TinaCMS编辑器推送到GitHub的commit！在GitHub中导航到您的项目，并确认提交被推送到您的分支。</p><p id="1d28" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对应提交:<a class="ae jg" href="https://github.com/Integral-Stack/tinacms-cloud-editor-tutorial/commit/349d5093e55b38d7db6c92ab9e2aee48cc969e5d" rel="noopener ugc nofollow" target="_blank">https://github . com/Integral-Stack/Tina CMS-cloud-editor-tutorial/commit/349d 5093 e 55 b 38d 7 db 6 c 92 ab 9 e 2 aee 48 cc 969 e5d</a></p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h2 id="fec7" class="na ln jj bd lo nb nc dn ls nd ne dp lw kr nf ng ma kv nh ni me kz nj nk mi nl bi translated">向Gatsby添加身份验证</h2><p id="8857" class="pw-post-body-paragraph kg kh jj ki b kj mm kl km kn mn kp kq kr nm kt ku kv nn kx ky kz no lb lc ld im bi translated">我们即将向互联网公开CMS，我们需要一种方法来限制它的访问，只有网站的可信编辑。</p><p id="b60e" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以尝试通过AWS中的IP白名单或地理定位来限制访问，但这两种方法都不能给我们提供通过凭证认证获得的细粒度和方便的控制。</p><p id="23b9" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae jg" href="https://en.wikipedia.org/wiki/Basic_access_authentication" rel="noopener ugc nofollow" target="_blank">基本认证</a>并不是限制访问我们编辑器的最安全的方法，但它是目前最快的方法，对于我们的情况来说已经足够了。</p><p id="6962" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了最大限度地提高基本身份验证的安全性，请确保您的密码具有较高的基数和长度。我们还将启用<code class="fe oc od oe nu b">https</code>，这是必要的，因为基本Auth在通过网络发送之前只进行base64编码。最后，我们将从master以外的分支运行我们的编辑器。这样，如果我们的云编辑器碰巧遭到黑客攻击，攻击者最多能做的就是向一个甚至没有部署到生产中的分支添加一些新的提交。</p><p id="e356" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们从安装<code class="fe oc od oe nu b"><a class="ae jg" href="https://github.com/LionC/express-basic-auth" rel="noopener ugc nofollow" target="_blank">express-basic-auth</a></code>包开始。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="1bb1" class="na ln jj nu b gy ny nz l oa ob">yarn add express-basic-auth</span></pre><p id="3c0e" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">幸运的是，Gatsby给了我们一个<a class="ae jg" href="https://www.gatsbyjs.org/docs/gatsby-config/#advanced-proxying-with-developmiddleware" rel="noopener ugc nofollow" target="_blank">钩子来连接我们的Express app实例</a>，这将使安装基本auth变得轻而易举。只需将以下内容添加到您的<code class="fe oc od oe nu b">gatsyb-config.js</code>文件中:</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="7195" class="na ln jj nu b gy ny nz l oa ob">const basicAuth = require("express-basic-auth")<br/><br/>module.exports = {<br/>  siteMetadata: {<br/>  ...<br/>  },<br/>  developMiddleware: app =&gt; {<br/>    app.use(basicAuth({<br/>      users: { test: 'test' },<br/>      challenge: true,<br/>      realm: 'your app name', <br/>    }))<br/>  },<br/>  ...<br/>}</span></pre><p id="44ff" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将为应用程序的所有传入请求添加基本身份验证。显然，我们最终将添加一个用户名/密码，但是我们将使用“test”作为用户名和密码进行测试。您需要设置挑战和领域属性，以便用户浏览器知道在他们试图访问网站时提示他们输入用户名/密码。</p><p id="2865" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在重启进程并尝试访问<code class="fe oc od oe nu b"><a class="ae jg" href="http://localhost:8000" rel="noopener ugc nofollow" target="_blank">http://localhost:8000</a></code>。您应该会看到一个用户名/密码对话框。如果您正确输入了凭据，您应该能够访问该站点。</p><p id="c529" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对应提交:<a class="ae jg" href="https://github.com/Integral-Stack/tinacms-cloud-editor-tutorial/commit/5de19cd413e38e484610ba5623a83155c81af7fa" rel="noopener ugc nofollow" target="_blank">https://github . com/Integral-Stack/Tina CMS-cloud-editor-tutorial/commit/5de 19 CD 413 e 38 e 484610 ba 5623 a 83155 c 81 af 7 fa</a></p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h2 id="0c5f" class="na ln jj bd lo nb nc dn ls nd ne dp lw kr nf ng ma kv nh ni me kz nj nk mi nl bi translated">保密</h2><p id="4da0" class="pw-post-body-paragraph kg kh jj ki b kj mm kl km kn mn kp kq kr nm kt ku kv nn kx ky kz no lb lc ld im bi translated">既然我们开始探索将敏感数据添加到我们的应用程序中，我们需要确保我们不会将这些秘密暴露给公众。事实上，“敏感数据泄露”是OWASP <a class="ae jg" href="https://owasp.org/www-project-top-ten/" rel="noopener ugc nofollow" target="_blank"> #3 </a>应用程序的安全风险。我们将以最简单的方式来实现这一点，为Node集成<a class="ae jg" href="https://github.com/motdotla/dotenv" rel="noopener ugc nofollow" target="_blank"> dotenv </a>，并在运行时注入我们的敏感数据。</p><p id="29a1" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们不需要安装<code class="fe oc od oe nu b">dotenv</code>，因为它已经和Gatsby打包在一起了。然而，我们需要在<code class="fe oc od oe nu b">gatsby-config.js</code>的顶部添加一条require语句，以便正确加载我们的文件:</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="a868" class="na ln jj nu b gy ny nz l oa ob">require("dotenv").config({ path: ".env.cloud" })<br/>const basicAuth = require("express-basic-auth")<br/><br/>...<br/>modules.exports = {</span></pre><p id="e24c" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我特意给dotenv起了个名字，不会和我们常规的dotenv设置冲突。不要担心，如果文件不存在，<code class="fe oc od oe nu b">dotenv</code>不会因为它不存在而抛出任何错误。现在让我们在项目的根目录下创建我们的<code class="fe oc od oe nu b">.env.cloud</code>文件。</p><p id="7c2a" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在希望将它添加到我们的<code class="fe oc od oe nu b">.gitignore</code>文件中，这样它就不会被提交到我们的回购协议中:</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="dcc7" class="na ln jj nu b gy ny nz l oa ob"># Live Github updates<br/>.env.cloud</span></pre><p id="acaa" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们的<code class="fe oc od oe nu b">.env.cloud</code>文件中，我们将添加几个变量。确保正确填写值，尤其是强用户名和密码:</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="f19a" class="na ln jj nu b gy ny nz l oa ob">AUTH_USER=*********<br/>AUTH_PW=***************<br/>ENABLE_AUTH=true<br/>TINA_GIT_DEBOUNCE_MS=3000</span></pre><p id="e9c6" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我已经将Tina Git去抖增加到3000毫秒，因为我注意到了云编辑器上的GraphQL问题，当它保留默认值1000毫秒时。</p><p id="f6f7" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与认证相关的环境变量将允许我们切换和安全地使用我们的基本认证。它需要对您在<code class="fe oc od oe nu b">gatsby-config.js</code>的中间件进行以下更新:</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="b3d3" class="na ln jj nu b gy ny nz l oa ob">developMiddleware: app =&gt; {<br/>  if (process.env.ENABLE_AUTH) {<br/>    app.use(<br/>      basicAuth({<br/>        users: { [process.env.AUTH_USER]: process.env.AUTH_PW },<br/>        challenge: true,<br/>        realm: "your app name",<br/>      })<br/>    )<br/>  }<br/>},</span></pre><p id="05cc" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">重新启动应用程序，并确保您的新用户名和密码凭证正常工作。一旦确认，确保你提交并推送所有的新代码到GitHub。</p><p id="6813" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对应提交:<a class="ae jg" href="https://github.com/Integral-Stack/tinacms-cloud-editor-tutorial/commit/d33eef357af4569f9e232699fca794604403a0dc" rel="noopener ugc nofollow" target="_blank">https://github . com/Integral-Stack/Tina CMS-cloud-editor-tutorial/commit/d 33 eef 357 af 4569 F9 e 232699 FCA 794604403 A0 DC</a></p><h2 id="000c" class="na ln jj bd lo nb nc dn ls nd ne dp lw kr nf ng ma kv nh ni me kz nj nk mi nl bi translated">设置AWS资源</h2><p id="1888" class="pw-post-body-paragraph kg kh jj ki b kj mm kl km kn mn kp kq kr nm kt ku kv nn kx ky kz no lb lc ld im bi translated">恭喜你，你已经完成了教程的DevOps部分。我们现在将把我们的编辑器转移到云中。</p><p id="e059" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你是AWS新手，你可能想做一些其他教程来熟悉它，至少学会保护你的帐户。如果您已经有AWS帐户，请登录。我们将从配置EC2实例开始。</p><p id="303c" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">登录AWS帐户后，导航到EC2 dashboard并“启动”一个实例。我们将选择默认的"<strong class="ki jk"> Amazon Linux 2 AMI (HVM)，SSD卷类型"</strong>上的"<strong class="ki jk"> t2.micro </strong>"实例类型。如果您符合免费层资格，则此选择符合免费资格，否则此配置的按需定价非常便宜。如果您想节省更多的钱，您可以考虑运行现场或保留实例。云编辑器基本上只需要处理几个编辑器的流量。</p><figure class="np nq nr ns gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi of"><img src="../Images/85c1d1ed592fbaa9084ec8f2a2491fee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*32beNDuonj9IqFdjPX7ELA.gif"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">EC2仪表板-&gt;选择AMI -&gt;配置实例</figcaption></figure><p id="9cac" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在“<strong class="ki jk">配置</strong>”页面上，我们可以保留所有默认设置</p><p id="8e49" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在“<strong class="ki jk">添加存储</strong>”页面上，我们将使用默认的EBS存储。</p><p id="0c0f" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在“<strong class="ki jk"> Add Tags </strong>”页面上，我们将添加一个键值对<code class="fe oc od oe nu b">Name</code> : <code class="fe oc od oe nu b">YourAppName</code>，这样更容易跟踪。</p><p id="8bc0" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在“<strong class="ki jk"> Security Groups </strong>”页面上，我们希望为云编辑器创建一个新的安全组，以便通过SSH(端口22)进行访问，并创建一个自定义TCP规则，以便在端口8000上显示编辑器。然后，按照提示启动实例。</p><figure class="np nq nr ns gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi og"><img src="../Images/eb34c33fdffcca7059bfb97638f38ba4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cGB85FQXKouY7e1gq-QsCA.png"/></div></div></figure><p id="adae" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在启动实例之前，会有一个模式提示您为新实例选择或创建一个密钥对。继续创建一个新对，适当地命名它，下载它，并启动您的实例。</p><figure class="np nq nr ns gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oh"><img src="../Images/c40eaf847499bfcd7c90b8fc67e8f820.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*msChCPLcemHMeDewgPjIIA.png"/></div></div></figure><p id="b8c5" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们开始提供实例之前，我建议您设置一个弹性IP并将其附加到新运行的实例上。弹性IP是免费的，只要它们被附加到一个实例。这将维护一个默认的DNS和IP，这样如果我们停止和启动实例，IP和DNS就不会被释放。</p><figure class="np nq nr ns gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi of"><img src="../Images/982b80eb1cb6056344a361e022b7e654.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*m6BYLOu3q7KjKgCJS8sHBg.gif"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">弹性IP</figcaption></figure><h2 id="00c0" class="na ln jj bd lo nb nc dn ls nd ne dp lw kr nf ng ma kv nh ni me kz nj nk mi nl bi translated">设置EC2实例</h2><p id="a996" class="pw-post-body-paragraph kg kh jj ki b kj mm kl km kn mn kp kq kr nm kt ku kv nn kx ky kz no lb lc ld im bi translated">现在您已经下载了您的PEM密钥，让我们准备好通过SSH连接到我们的实例。我们会将pem密钥从下载文件夹移到<code class="fe oc od oe nu b">.ssh</code>文件夹。然后，我们将使用<code class="fe oc od oe nu b">chmod</code>命令保护我们的pem密钥，只允许<code class="fe oc od oe nu b">user, read</code>访问。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="e325" class="na ln jj nu b gy ny nz l oa ob">mv ~/Downloads/YourAppKP.pem ~/.ssh<br/>chmod 400 ~/.ssh/YourAppKP.pem</span></pre><p id="30ac" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了通过SSH连接，我们需要运行实例的IPv4公共IP。回到您的浏览器，访问实例页面，并单击您的实例以查看其详细信息。公共IP应该可以从“描述”选项卡中获得。</p><figure class="np nq nr ns gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi of"><img src="../Images/900e0a91c6ca86b42b9cd56cd23ea0b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*n_S8WQ8VuIJSGNHNZQENCA.gif"/></div></div></figure><p id="1b14" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我的公开IP是<code class="fe oc od oe nu b">3.224.202.92</code>。确保在下面的命令中用您自己的IP替换它。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="3029" class="na ln jj nu b gy ny nz l oa ob">ssh -i ~/.aws/YourAppKP.pem  ec2-user@3.224.202.92</span></pre><p id="46d3" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行这个命令后，您应该通过SSH连接到EC2实例。让我们通过安装必要的依赖项来准备好实例。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="575a" class="na ln jj nu b gy ny nz l oa ob">sudo yum update -y<br/>sudo yum install git -y<br/>curl -o- <a class="ae jg" href="https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh</a> | bash<br/>. ~/.nvm/nvm.sh<br/>nvm install v12<br/>npm install -g yarn</span></pre><p id="e2f9" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果一切顺利，现在您将拥有git，node 12。*、npm和yarn安装在您的实例上。我们需要做的下一件事是允许我们的实例通过我们将在实例上生成的密钥对与GitHub通信。用您自己的电子邮件替换下面的命令，并遵循默认提示。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="ef9f" class="na ln jj nu b gy ny nz l oa ob">ssh-keygen -t rsa -b 4096 -C "your_email@example.com"</span></pre><p id="f3ba" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在需要将新创建的公钥移动到我们用来设置回购的帐户的GitHub设置中。运行以下命令并复制公钥的输出。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="0051" class="na ln jj nu b gy ny nz l oa ob">cat ~/.ssh/id_rsa.pub</span></pre><p id="22d0" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">登录GitHub，导航到<strong class="ki jk">设置</strong>-&gt;-T9】SSH和GPG键，然后点击“<strong class="ki jk">新建SSH键</strong>”按钮。给密钥起一个标题，粘贴你的公钥，然后保存。</p><p id="eaf3" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您的实例现在应该能够从您的GitHub repo进行推和拉。回到EC2命令行，将项目克隆到实例上。用您自己的名称替换项目名称。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="fa47" class="na ln jj nu b gy ny nz l oa ob">git clone <a class="ae jg" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:Integral-Stack/tinacms-cloud-editor-tutorial.git</span></pre><h2 id="7a86" class="na ln jj bd lo nb nc dn ls nd ne dp lw kr nf ng ma kv nh ni me kz nj nk mi nl bi translated">运行您的云编辑器</h2><p id="3789" class="pw-post-body-paragraph kg kh jj ki b kj mm kl km kn mn kp kq kr nm kt ku kv nn kx ky kz no lb lc ld im bi translated">从我们的SSH命令行，让我们<code class="fe oc od oe nu b">cd</code>进入项目，并安装我们的npm依赖项</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="1b0f" class="na ln jj nu b gy ny nz l oa ob">cd tinacms-cloud-editor-tutorial<br/>yarn install</span></pre><p id="b4dd" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在继续使用vim或nano创建一个名为<code class="fe oc od oe nu b">.env.cloud</code>的文件，并将您的环境变量从本地<code class="fe oc od oe nu b">.env.cloud</code>文件复制并粘贴到这个新文件中。完成后，您可以在本地将<code class="fe oc od oe nu b">.env.cloud</code>从回购中删除。我们只在云编辑器中需要它。</p><p id="d3bb" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在运行云编辑器之前，我们还想通过从一个分支而不是从<code class="fe oc od oe nu b">master</code>运行来增加安全性。这意味着通过云编辑器对我们的网站所做的更改将被提交到GitHub的这个新分支上。如果你从<code class="fe oc od oe nu b">master</code>进行生产构建，这将保护某人在你的云编辑器凭证被泄露时免受任何损害。请记住，使用这种策略，您将需要定期制作一个PR，将内容更新到master中，并将它们部署到生产环境中。我将使用一个名为<code class="fe oc od oe nu b">cloud-editor</code>的分支，但是您可以随意使用。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="9894" class="na ln jj nu b gy ny nz l oa ob">git checkout -b cloud-editor</span></pre><p id="b9fc" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在准备运行我们的云编辑器。我们将需要使用主机<code class="fe oc od oe nu b">0.0.0.0</code> (INADDR_ANY)而不是localhost来运行该应用程序，以便通过我们之前设置的安全组向公众公开该应用程序。我们还需要运行与SSH会话分离的流程，这样它就可以在后台运行。</p><p id="66a5" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">基于这两个原因，我们根本不能只运行<code class="fe oc od oe nu b">yarn start</code>。在继续之前，让我们测试一下将要使用的服务器启动命令。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="d0e4" class="na ln jj nu b gy ny nz l oa ob">yarn develop -H 0.0.0.0 -S</span></pre><p id="7603" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您收到以下错误，您将需要创建一个<code class="fe oc od oe nu b">ca-certificates</code>目录。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="9b16" class="na ln jj nu b gy ny nz l oa ob">cp: cannot create regular file ‘/usr/local/share/ca-certificates/devcert.cer’: No such file or directory</span></pre><p id="8571" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行以下命令创建该目录:</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="cb49" class="na ln jj nu b gy ny nz l oa ob"># Run this command to fix the error<br/>sudo mkdir /usr/local/share/ca-certificates</span></pre><p id="29b4" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦您确认您的开发服务器可以在云中运行，我们将希望在分离模式下运行我们的命令。为了做到这一点，我们将利用<code class="fe oc od oe nu b">nohup</code>。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="e884" class="na ln jj nu b gy ny nz l oa ob">nohup yarn develop -H 0.0.0.0 -S &amp;</span></pre><p id="f837" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将看不到命令的输出，但是我们可以通过访问活动站点来检查Gatsby dev服务器是否已经启动并正在运行。为此，请导航回AWS EC2控制台，从“描述”选项卡中复制您的“公共DNS (IPv4)”地址，将其粘贴到您的浏览器中。确保在url的开头添加<code class="fe oc od oe nu b">https://</code>，并在回车前在末尾添加端口<code class="fe oc od oe nu b">:8000</code>。我的网址是这样的:</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="3bc4" class="na ln jj nu b gy ny nz l oa ob">https://ec2–3–224–202–92.compute-1.amazonaws.com:8000</span></pre><p id="cf0b" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于我们使用的是自签名SSL证书，您应该进入以下页面，在这里您需要点击“<strong class="ki jk">高级</strong>”-&gt;”<strong class="ki jk">前进到……</strong>”以访问该网站。此消息只会提示您一次。</p><figure class="np nq nr ns gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oi"><img src="../Images/98978842b864172c3d03ef8da23536ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*shuv4D32LNY57rjYN5xcxA.png"/></div></div></figure><p id="1b9a" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你的云编辑器加载了，恭喜你！应该首先提示您输入用户名和密码，然后您就可以编辑您的网页了。您需要检查的第二件事是TinaCMS " <strong class="ki jk"> Save </strong>"功能。这个操作应该会生成一个新的commit，并将其从EC2实例推送到GitHub。保存一些编辑后，进入GitHub，确保提交显示在当前运行的分支上。</p><figure class="np nq nr ns gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oj"><img src="../Images/333a9b796002bd658c48d0065d8619f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OhBPNKHY5KcYDf7jLTrN4Q.png"/></div></div></figure><p id="dff1" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本教程到此结束。请在下面评论或提问。</p><h2 id="deae" class="na ln jj bd lo nb nc dn ls nd ne dp lw kr nf ng ma kv nh ni me kz nj nk mi nl bi translated">如何才能提高？</h2><p id="eab3" class="pw-post-body-paragraph kg kh jj ki b kj mm kl km kn mn kp kq kr nm kt ku kv nn kx ky kz no lb lc ld im bi translated">作为代码的基础设施。</p><p id="1b65" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">理论上，服务器应该通过代码来提供。这意味着利用带有node的Linux docker映像，并通过docker文件安装yarn和git。此外，您会希望在运行时将所有的秘密注入到容器中。</p><p id="a1e2" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您想走AWS路线，这可能包括利用ECS进行容器管理，并从参数存储或秘密管理器注入您的秘密。这些秘密需要在ECS任务定义中定义，以便在运行时注入。在此设置中，您将能够通过Docker将端口映射到主机目标8000，并在端口80上公开应用程序。容器将位于应用程序负载平衡器之后，这将允许您在Route53中设置DNS以指向ALB，并且您可以通过使用证书管理器设置SSL证书来轻松添加https。</p><p id="1c99" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">而且，如果您想更进一步，您可以通过CloudFormation模板进行设置，以便通过代码提供AWS资源。</p><p id="67dc" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">太多了！如果有人决定这样做，请让我知道，因为我想使用代码。</p></div></div>    
</body>
</html>