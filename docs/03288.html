<html>
<head>
<title>How to Schedule Cron Jobs and Implement Health Checks in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Node.js中调度Cron作业和实现健康检查</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-schedule-cron-jobs-and-set-health-checks-in-node-js-93cf88d2c247?source=collection_archive---------3-----------------------#2020-04-30">https://levelup.gitconnected.com/how-to-schedule-cron-jobs-and-set-health-checks-in-node-js-93cf88d2c247?source=collection_archive---------3-----------------------#2020-04-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="bb00" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用Node.js中的Cron作业自动化您的任务</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/fda5b38d1f481897586864a53d903308.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rtavzSSiqmmS9QbF"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae le" href="https://unsplash.com/@fabulu75?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Fabrice Villard </a>拍摄的照片</figcaption></figure><h1 id="9afb" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">1.介绍</h1><p id="6a1c" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">Cron作业是为了让我们的生活更轻松，并在特定时间将我们从运行任务中分离出来。</p><h1 id="3108" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">让我们开始吧</h1><p id="3e6a" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">支持Cron作业的Node.js库是<strong class="js iu"> cron </strong>和<strong class="js iu"> node-cron。</strong></p><p id="e701" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae le" href="https://www.npmjs.com/package/node-cron" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">节点Cron </strong> </a></p><ol class=""><li id="6796" class="mi mj it js b jt ju jx jy kb mk kf ml kj mm kn mn mo mp mq bi translated">不如<strong class="js iu">克朗</strong>受欢迎</li><li id="094d" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">简单用法</li><li id="a3c6" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">更少的选择</li><li id="967c" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">无法控制cron作业进程</li></ol><p id="d96b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae le" href="https://www.npmjs.com/package/cron" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> Cron </strong> </a></p><ol class=""><li id="1195" class="mi mj it js b jt ju jx jy kb mk kf ml kj mm kn mn mo mp mq bi translated">比<strong class="js iu"> node-cron </strong>更受欢迎</li><li id="1710" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">有更多用于计划任务的增强选项</li><li id="0138" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">对cron作业过程有更好的控制</li></ol><p id="3eed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个故事中，我们将使用<strong class="js iu"> cron </strong>模块。</p><h1 id="90bc" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">Cron模式</h1><p id="f55d" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated"><strong class="js iu"> Cron作业</strong>用<strong class="js iu"> Cron模式</strong>调度任务，这些模式的格式如(* * 1 * *)。</p><p id="754b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">别害怕，这不是火箭科学，你两分钟就能学会。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/830bbcb1d6520d667fbfa9cff8de6377.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/0*jLS3k5evrV2euaUw.png"/></div></figure><p id="0709" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">允许操作员使用<strong class="js iu"> Cron模式</strong>:</p><ol class=""><li id="a009" class="mi mj it js b jt ju jx jy kb mk kf ml kj mm kn mn mo mp mq bi translated"><strong class="js iu"> * </strong>任意值</li><li id="91a9" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated"><strong class="js iu">、</strong>列表值ex。(0 22,23 * * *)</li><li id="842b" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated"><strong class="js iu"> - </strong>范围值ex。(0 2–23 * * *)</li><li id="6a78" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated"><strong class="js iu"> / </strong>步长值ex。( 0 0/2 * * *)</li></ol><h1 id="aa72" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">Cron模式示例</h1><ol class=""><li id="d226" class="mi mj it js b jt md jx me kb mx kf my kj mz kn mn mo mp mq bi translated">每天每小时在第5分钟运行一个Cron作业:(5 * * * *)例如(00:05，01:05，…)</li><li id="26e8" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">每天22:00运行Cron作业:(0 22 * * *)</li><li id="a701" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">每天01:00，02:00，03:00运行Cron作业:(01，2，3 * * *)</li><li id="b5bc" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">在周一至周五的22:00运行Cron作业:(0 22 * * 1–5)</li></ol></div><div class="ab cl na nb hx nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="im in io ip iq"><h1 id="8cd2" class="lf lg it bd lh li nh lk ll lm ni lo lp lq nj ls lt lu nk lw lx ly nl ma mb mc bi translated">2.基本用法</h1><p id="ccb2" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">首先，创建一个新目录:</p><pre class="kp kq kr ks gt nm nn no np aw nq bi"><span id="5d5e" class="nr lg it nn b gy ns nt l nu nv">mkdir cronJobs<br/>cd cronJobs</span></pre><p id="646b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用默认设置创建package.json文件:</p><pre class="kp kq kr ks gt nm nn no np aw nq bi"><span id="245f" class="nr lg it nn b gy ns nt l nu nv">npm init -y</span></pre><p id="042d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">安装<strong class="js iu"> cron </strong>模块:</p><pre class="kp kq kr ks gt nm nn no np aw nq bi"><span id="7bba" class="nr lg it nn b gy ns nt l nu nv">npm i cron</span></pre><p id="18b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个新文件index.js并粘贴以下代码:</p><pre class="kp kq kr ks gt nm nn no np aw nq bi"><span id="2b6f" class="nr lg it nn b gy ns nt l nu nv">var CronJob = require('cron').CronJob;</span><span id="1867" class="nr lg it nn b gy nw nt l nu nv">// New CronJob run a task every 5 seconds<br/>var job = new CronJob('*/5 * * * * *',task);</span><span id="1d9a" class="nr lg it nn b gy nw nt l nu nv">// task to execute from cron job<br/>function task(){<br/>console.log('My First Cron Job task run at: '+new Date());<br/>}</span><span id="4a9b" class="nr lg it nn b gy nw nt l nu nv">// start the cron <br/>jobjob.start();</span></pre><p id="cedc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">运行您的第一个cron作业:</p><pre class="kp kq kr ks gt nm nn no np aw nq bi"><span id="cead" class="nr lg it nn b gy ns nt l nu nv">node index.js<br/>//Console Output<br/>My First Cron Job task at: Wed Apr 29 2020 19:38:00 GMT+0300 (Eastern European Summer Time)<br/>My First Cron Job task at: Wed Apr 29 2020 19:38:05 GMT+0300 (Eastern European Summer Time)<br/>My First Cron Job task at: Wed Apr 29 2020 19:38:10 GMT+0300 (Eastern European Summer Time)<br/>...<br/>...<br/>...<br/>...</span></pre></div><div class="ab cl na nb hx nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="im in io ip iq"><h1 id="0630" class="lf lg it bd lh li nh lk ll lm ni lo lp lq nj ls lt lu nk lw lx ly nl ma mb mc bi translated">3.添加健康检查</h1><p id="7f93" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">假设您有一个cron作业正在运行，每天上午10:00备份一个数据库。数据库备份至关重要，我们必须确保任务已成功结束。出于这个原因，我们必须在cron作业中添加健康检查。</p><blockquote class="nx ny nz"><p id="4a7f" class="jq jr oa js b jt ju jv jw jx jy jz ka ob kc kd ke oc kg kh ki od kk kl km kn im bi translated"><strong class="js iu"> <em class="it"> Cron作业失败会带来灾难性的后果！</em>T41】</strong></p></blockquote><p id="206b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">实施简单的健康检查</p><ol class=""><li id="f3d9" class="mi mj it js b jt ju jx jy kb mk kf ml kj mm kn mn mo mp mq bi translated">我们将添加一个<strong class="js iu"> onComplete </strong>方法，该方法将在任务完成后执行。</li><li id="c2f9" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">我们将设置一个每10秒调用一次的函数来检查<strong class="js iu">最后一次任务执行、cron作业状态(运行或不运行)以及下一次预定执行</strong>。</li></ol><p id="0f45" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">用以下代码替换index.js文件</p><pre class="kp kq kr ks gt nm nn no np aw nq bi"><span id="4cc3" class="nr lg it nn b gy ns nt l nu nv">var CronJob = require("cron").CronJob;<br/>// New CronJob run a task every 5 seconds<br/>var job = new CronJob("*/5 * * * * *", task,onComplete);<br/>// task to execute from cron job<br/>function task() {<br/>console.log("My First Cron Job task run at: " + new Date());<br/>console.log("Next task at: " + job.nextDates(1));<br/>// call onComplete method<br/>this.onComplete();<br/>}</span><span id="c721" class="nr lg it nn b gy nw nt l nu nv">function onComplete() {<br/>console.log("Task completed");<br/>}</span><span id="9a99" class="nr lg it nn b gy nw nt l nu nv">// start the cron jobjob.start();<br/>// Add a health check every 10sec<br/>setInterval(function () {<br/>console.log("-- health check -- Last Execution" ,job.lastDate().toUTCString());<br/>console.log("-- health check -- Is job running? ", job.running);<br/>console.log("-- health check -- Next task at: " + job.nextDates(1));<br/>}, 10*1000);</span></pre><p id="a699" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">运行您的cron作业:</p><pre class="kp kq kr ks gt nm nn no np aw nq bi"><span id="8152" class="nr lg it nn b gy ns nt l nu nv">node index.js<br/>//Console Output<br/>My First Cron Job task run at: Wed Apr 29 2020 20:52:45 GMT+0300 (Eastern European Summer Time)<br/>Next task at: Wed Apr 29 2020 20:52:50 GMT+0300<br/>Task completed<br/>My First Cron Job task run at: Wed Apr 29 2020 20:52:50 GMT+0300 (Eastern European Summer Time)<br/>Next task at: Wed Apr 29 2020 20:52:55 GMT+0300<br/>Task completed<br/>-- health check -- Last Execution  Wed, 29 Apr 2020 17:52:50 GMT<br/>-- health check -- Is job running?  true<br/>-- health check -- Next task at: Wed Apr 29 2020 20:52:55 GMT+0300</span></pre></div><div class="ab cl na nb hx nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="im in io ip iq"><h1 id="425d" class="lf lg it bd lh li nh lk ll lm ni lo lp lq nj ls lt lu nk lw lx ly nl ma mb mc bi translated">参考</h1><ol class=""><li id="c28e" class="mi mj it js b jt md jx me kb mx kf my kj mz kn mn mo mp mq bi translated"><a class="ae le" href="https://www.npmjs.com/package/node-cron" rel="noopener ugc nofollow" target="_blank"> Node-Cron </a></li><li id="9c53" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated"><a class="ae le" href="https://www.npmjs.com/package/cron" rel="noopener ugc nofollow" target="_blank">克朗</a></li><li id="8ecf" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated"><a class="ae le" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank"> crontab.guru </a></li></ol></div><div class="ab cl na nb hx nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="im in io ip iq"><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oe of l"/></div></figure></div><div class="ab cl na nb hx nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="im in io ip iq"><h1 id="c764" class="lf lg it bd lh li nh lk ll lm ni lo lp lq nj ls lt lu nk lw lx ly nl ma mb mc bi translated">您可能还喜欢:</h1><div class="og oh gp gr oi oj"><a href="https://medium.com/swlh/run-python-script-from-node-js-and-send-data-to-browser-15677fcf199f" rel="noopener follow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd iu gy z fp oo fr fs op fu fw is bi translated">从Node.js运行Python脚本。</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">在本文中，我将介绍一个示例应用程序，它可以从Node.js运行python脚本，从脚本中获取数据…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">medium.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox ky oj"/></div></div></a></div><div class="og oh gp gr oi oj"><a href="https://medium.com/javascript-in-plain-english/learn-to-use-regular-expressions-like-a-ninja-in-node-js-20cfb6806f26" rel="noopener follow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd iu gy z fp oo fr fs op fu fw is bi translated">Node.js中的正则表达式备忘单</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">轻松学习、编写和执行正则表达式的详细故事。</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">medium.com</p></div></div><div class="os l"><div class="oy l ou ov ow os ox ky oj"/></div></div></a></div><div class="og oh gp gr oi oj"><a href="https://medium.com/javascript-in-plain-english/store-clean-data-by-validating-models-with-mongoose-f6453dbdbff9" rel="noopener follow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd iu gy z fp oo fr fs op fu fw is bi translated">Node.js中使用Mongoose进行数据验证</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">如何在用mongoose库将数据保存到MongoDB之前对其进行验证？</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">medium.com</p></div></div><div class="os l"><div class="oz l ou ov ow os ox ky oj"/></div></div></a></div></div></div>    
</body>
</html>