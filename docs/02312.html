<html>
<head>
<title>Build Continuous Delivery for a spring-boot application on GitLab and Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GitLab和Kubernetes上为spring-boot应用程序构建持续交付</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/build-continues-delivery-for-a-spring-boot-application-on-gitlab-and-kubernetes-6b562da099c2?source=collection_archive---------1-----------------------#2020-03-05">https://levelup.gitconnected.com/build-continues-delivery-for-a-spring-boot-application-on-gitlab-and-kubernetes-6b562da099c2?source=collection_archive---------1-----------------------#2020-03-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4c9a4d3167fc206e302e8b3aef6ead09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Fp295YJOh55F_QYN"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">泰勒·凯西在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="7253" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本教程中，我们将一步一步地为Kubernetes集群中的spring boot应用程序构建、部署和构建一个连续的交付管道，其中源代码将托管在Gitlab中。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="f5ff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">大局</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi li"><img src="../Images/f2c28f3747cb3a731e50278a223f9025.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fl-r9F-pj5GyfbEq-N8D1A.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">大局</figcaption></figure></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h2 id="8a92" class="ln lo iq bd lp lq lr dn ls lt lu dp lv ko lw lx ly ks lz ma mb kw mc md me mf bi translated">在本地安装Kubernetes集群</h2><p id="119a" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">你可以考虑在本地安装Kubernetes集群:</p><div class="ml mm gp gr mn mo"><a href="https://medium.com/@mhewedy_46874/install-kubernetes-cluster-in-virtual-machines-the-easy-way-337ef0c4e37f" rel="noopener follow" target="_blank"><div class="mp ab fo"><div class="mq ab mr cl cj ms"><h2 class="bd ir gy z fp mt fr fs mu fu fw ip bi translated">以最简单的方式在虚拟机中安装Kubernetes集群</h2><div class="mv l"><h3 class="bd b gy z fp mt fr fs mu fu fw dk translated">在这篇文章中，我们将看到如何安装一个由1个主节点和1个工作节点组成的Kubernetes v1.18集群</h3></div><div class="mw l"><p class="bd b dl z fp mt fr fs mu fu fw dk translated">medium.com</p></div></div><div class="mx l"><div class="my l mz na nb mx nc jw mo"/></div></div></a></div></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="da9d" class="nd lo iq bd lp ne nf ng ls nh ni nj lv nk nl nm ly nn no np mb nq nr ns me nt bi translated">步骤1:创建项目并在本地运行它</h1><p id="943c" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">转到<a class="ae kc" href="https://start.spring.io/#!type=maven-project&amp;language=java&amp;platformVersion=2.2.5.RELEASE&amp;packaging=jar&amp;jvmVersion=1.8&amp;groupId=com.example&amp;artifactId=hello-kubernetes&amp;name=hello-kubernetes&amp;description=Demo%20project%20for%20Spring%20Boot&amp;packageName=com.example.hello-kubernetes&amp;dependencies=web" rel="noopener ugc nofollow" target="_blank"> start.spring.io </a>并下载一个新的应用程序，将web作为依赖项(为简单起见，但您可以添加任何其他依赖项)</p><p id="bfe0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们添加一个简单的控制器</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="1c8e" class="ln lo iq nv b gy nz oa l ob oc">@RestController<br/><strong class="nv ir">public class </strong>HelloController {<br/><br/>    <strong class="nv ir">private static final </strong>String <strong class="nv ir"><em class="od">template </em></strong>= <strong class="nv ir">"Hello from %s!"</strong>;<br/>    <strong class="nv ir">private final </strong>AtomicLong <strong class="nv ir">counter </strong>= <strong class="nv ir">new </strong>AtomicLong();<br/><br/>    @Value(<strong class="nv ir">"${application.env}"</strong>)<br/>    <strong class="nv ir">private </strong>String <strong class="nv ir">env</strong>;<br/><br/>    @GetMapping(<strong class="nv ir">"/"</strong>)<br/>    <strong class="nv ir">public </strong>Greeting greeting() {<br/>        <strong class="nv ir">return new </strong>Greeting(<strong class="nv ir">counter</strong>.incrementAndGet(), String.<em class="od">format</em>(<strong class="nv ir"><em class="od">template</em></strong>, <strong class="nv ir">env</strong>));<br/>    }<br/><br/>    <strong class="nv ir">static public class </strong>Greeting {<br/>        <strong class="nv ir">public long id</strong>;<br/>        <strong class="nv ir">public </strong>String <strong class="nv ir">content</strong>;<br/><br/>        <strong class="nv ir">public </strong>Greeting(<strong class="nv ir">long </strong>id, String content) {<br/>            <strong class="nv ir">this</strong>.<strong class="nv ir">id </strong>= id;<br/>            <strong class="nv ir">this</strong>.<strong class="nv ir">content </strong>= content;<br/>        }<br/>    }<br/>}</span></pre><p id="52f2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们给<code class="fe oe of og nv b">application.properties</code>添加一个简单的属性，如下所示:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="734e" class="ln lo iq nv b gy nz oa l ob oc"><strong class="nv ir">application.env</strong>=<strong class="nv ir">dev</strong></span></pre><p id="6431" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，让我们测试从IDE本地运行的应用程序，并测试它:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="4137" class="ln lo iq nv b gy nz oa l ob oc">$ curl localhost:8080<br/>{"id":1,"content":"Hello from dev!"}</span></pre><p id="df57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在停止服务器，准备下一步</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="7021" class="nd lo iq bd lp ne nf ng ls nh ni nj lv nk nl nm ly nn no np mb nq nr ns me nt bi translated">步骤2:创建Docker图像</h1><p id="095b" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">将以下Dockerfile文件添加到应用程序的根目录</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="1ee2" class="ln lo iq nv b gy nz oa l ob oc"><strong class="nv ir">FROM </strong>openjdk:8-jdk-alpine <strong class="nv ir">AS <em class="od">builder<br/></em>WORKDIR </strong>target<strong class="nv ir">/</strong>dependency<br/><strong class="nv ir">ARG <em class="od">APPJAR</em></strong>=target<strong class="nv ir">/*</strong>.jar<br/><strong class="nv ir">COPY </strong>${<strong class="nv ir"><em class="od">APPJAR</em></strong>} app.jar<br/><strong class="nv ir">RUN </strong>jar <strong class="nv ir">-</strong>xf .<strong class="nv ir">/</strong>app.jar<br/><br/><strong class="nv ir">FROM </strong>openjdk:8-jre-alpine<br/><strong class="nv ir">VOLUME /</strong>tmp<br/><strong class="nv ir">ARG <em class="od">DEPENDENCY</em></strong>=target<strong class="nv ir">/</strong>dependency<br/><strong class="nv ir">COPY --</strong>from=<strong class="nv ir"><em class="od">builder </em></strong>${<strong class="nv ir"><em class="od">DEPENDENCY</em></strong>}<strong class="nv ir">/</strong>BOOT-INF<strong class="nv ir">/</strong>lib <strong class="nv ir">/</strong>app<strong class="nv ir">/</strong>lib<br/><strong class="nv ir">COPY --</strong>from=<strong class="nv ir"><em class="od">builder </em></strong>${<strong class="nv ir"><em class="od">DEPENDENCY</em></strong>}<strong class="nv ir">/</strong>META-INF <strong class="nv ir">/</strong>app<strong class="nv ir">/</strong>META-INF<br/><strong class="nv ir">COPY --</strong>from=<strong class="nv ir"><em class="od">builder </em></strong>${<strong class="nv ir"><em class="od">DEPENDENCY</em></strong>}<strong class="nv ir">/</strong>BOOT-INF<strong class="nv ir">/</strong>classes <strong class="nv ir">/</strong>app<br/><strong class="nv ir">ENTRYPOINT </strong>[<strong class="nv ir">"java"</strong>,<strong class="nv ir">"-cp"</strong>,<strong class="nv ir">"app:app/lib/*"</strong>,<strong class="nv ir">"com.example.hellokubernetes.HelloKubernetesApplication"</strong>]</span></pre><p id="fa67" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要测试docker文件，请在应用程序的根目录下运行以下命令:</p><blockquote class="oh oi oj"><p id="7e5a" class="kd ke od kf b kg kh ki kj kk kl km kn ok kp kq kr ol kt ku kv om kx ky kz la ij bi translated">注意:如果您没有在本地安装<strong class="kf ir"> docker </strong>，那么您可以跳到下一步，但是在本地测试它当然更好。</p></blockquote><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="f90b" class="ln lo iq nv b gy nz oa l ob oc">$ mvn clean package<br/>$ docker build -t hellokubernetes/hellokubernetes .<br/>$ <!-- -->docker run -d -p 8080:8080 <!-- -->hellokubernetes/hellokubernetes<br/>$ curl localhost:8080</span><span id="6bed" class="ln lo iq nv b gy on oa l ob oc">{"id":1,"content":"Hello from dev!"}%</span></pre><p id="cc25" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们停止容器，进入下一步</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="57f1" class="ln lo iq nv b gy nz oa l ob oc">docker rm -f $(docker ps -f expose=8080 -q)</span></pre></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="bcae" class="nd lo iq bd lp ne nf ng ls nh ni nj lv nk nl nm ly nn no np mb nq nr ns me nt bi translated">步骤3:设置Gitlab</h1><p id="670b" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">让我们创建一个Gitlab资源库，在我们的例子中，这个项目是在<a class="ae kc" href="https://gitlab.com/mhewedy/hello-kubernetes/-/tree/develop" rel="noopener ugc nofollow" target="_blank">https://gitlab.com/mhewedy/hello-kubernetes</a>创建的</p><blockquote class="oh oi oj"><p id="9a96" class="kd ke od kf b kg kh ki kj kk kl km kn ok kp kq kr ol kt ku kv om kx ky kz la ij bi translated">注意，项目URL将影响容器注册表URL</p></blockquote><p id="8656" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们推送代码之前，让我们在项目的根目录下添加<code class="fe oe of og nv b">.gitlab-ci.yml</code>文件:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="9a76" class="ln lo iq nv b gy nz oa l ob oc">services:<br/>  - docker:dind<br/>stages:<br/>  - test<br/>  - build<br/>  - deploy<br/>variables:<br/>  MAVEN_OPTS: "-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"<br/>  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true"<br/>  DOCKER_HOST: "tcp://docker:2375"<br/>  DOCKER_DRIVER: overlay2<br/>  REGISTRY_URL: registry.gitlab.com/mhewedy/hello-kubernetes<br/>  DOCKER_BUILD_ID: ${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHORT_SHA}<br/>image: maven:3.3.9-jdk-8<br/>cache:<br/>  paths:<br/>    - .m2/repository<br/>.verify: &amp;verify<br/>  stage: test<br/>  script:<br/>    - 'mvn $MAVEN_CLI_OPTS verify'<br/>  artifacts:<br/>    paths:<br/>      - target/<br/>  except:<br/>    - master<br/>verify:jdk8:<br/>  &lt;&lt;: *verify<br/>build_image:<br/>  stage: build<br/>  image: docker:git<br/>  script:<br/>    - docker login ${REGISTRY_URL} -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD}<br/>    - docker build -t ${REGISTRY_URL}:${DOCKER_BUILD_ID} .<br/>    - docker push ${REGISTRY_URL}:${DOCKER_BUILD_ID}<br/>    - docker tag ${REGISTRY_URL}:${DOCKER_BUILD_ID} ${REGISTRY_URL}:latest<br/>    - docker push ${REGISTRY_URL}:latest<br/>  only:<br/>    - develop</span></pre><p id="955b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们向GitLab添加代码:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="741f" class="ln lo iq nv b gy nz oa l ob oc">$ git init<br/>$ git remote add origin git@gitlab.com:mhewedy/hello-kubernetes.git<br/>$ git add .<br/>$ git commit -m "Initial commit"<br/>$ git push -u origin master<br/>$ git checkout -b develop  # create &amp; switch to develop branch</span></pre><p id="bde5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在转到<a class="ae kc" href="https://gitlab.com/mhewedy/hello-kubernetes/pipelines" rel="noopener ugc nofollow" target="_blank">https://gitlab.com/mhewedy/hello-kubernetes/pipelines</a>，您将看到构建正在通过，docker映像被推送到Gitlab容器注册表</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oo"><img src="../Images/cfa18afad79ef2899fc4c9a4a7f62572.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UL1VMUKzEclEco03aNJ1ew.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Gitlab管道显示构建成功</figcaption></figure><p id="68bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">反弹步骤</strong>:您可以从Gitlab注册表中提取并运行本地机器上的docker映像:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="eae8" class="ln lo iq nv b gy nz oa l ob oc">$ docker login registry.gitlab.com <strong class="nv ir">#enter your gitlab credentials</strong><br/>$ docker run -d -p 8080:8080 registry.gitlab.com/mhewedy/hello-kubernetes<br/>$ curl localhost:8080</span><span id="9ef5" class="ln lo iq nv b gy on oa l ob oc">{"id":1,"content":"Hello from dev!"}%</span></pre><p id="7c10" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">再次运行以下命令删除容器:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="cdb9" class="ln lo iq nv b gy nz oa l ob oc">docker rm -f $(docker ps -f expose=8080 -q)</span></pre></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="46f0" class="nd lo iq bd lp ne nf ng ls nh ni nj lv nk nl nm ly nn no np mb nq nr ns me nt bi translated">第四步:创建库本内特YAML</h1><p id="a4d7" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated"><strong class="kf ir">首先</strong>，你需要创建一个包含你的GitLab凭证的秘密拉图:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="c313" class="ln lo iq nv b gy nz oa l ob oc">$ <strong class="nv ir">kubectl</strong> create secret docker-registry gitlab-auth --docker-server=https://registry.gitlab.com --docker-username=<strong class="nv ir">&lt;gitlab-username&gt;</strong> --docker-password=<strong class="nv ir">&lt;gitlab-password&gt;</strong></span></pre><p id="24b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">第二个</strong>，这是<code class="fe oe of og nv b">k8s.yaml</code>文件(确保将它与您的项目一起保存，以便您可以在以后需要时使用它)</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="8da7" class="ln lo iq nv b gy nz oa l ob oc"><strong class="nv ir">apiVersion</strong>: v1<br/><strong class="nv ir">kind</strong>: ConfigMap<br/><strong class="nv ir">metadata</strong>:<br/>  <strong class="nv ir">name</strong>: hello-kubernetes-configs<br/><strong class="nv ir">data</strong>:<br/>  <strong class="nv ir">application.properties</strong>: |<br/>    application.env=prod<br/>---<br/><strong class="nv ir">apiVersion</strong>: apps/v1<br/><strong class="nv ir">kind</strong>: Deployment<br/><strong class="nv ir">metadata</strong>:<br/>  <strong class="nv ir">name</strong>: hello-kubernetes-deployment<br/><strong class="nv ir">spec</strong>:<br/>  <strong class="nv ir">replicas</strong>: 2<br/>  <strong class="nv ir">selector</strong>:<br/>    <strong class="nv ir">matchLabels</strong>:<br/>      <strong class="nv ir">app</strong>: hello-kubernetes<br/>  <strong class="nv ir">template</strong>:<br/>    <strong class="nv ir">metadata</strong>:<br/>      <strong class="nv ir">labels</strong>:<br/>        <strong class="nv ir">app</strong>: hello-kubernetes<br/>    <strong class="nv ir">spec</strong>:<br/>      <strong class="nv ir">containers</strong>:<br/>      - <strong class="nv ir">name</strong>: hello-kubernetes<br/>        <strong class="nv ir">image</strong>: registry.gitlab.com/mhewedy/hello-kubernetes<br/>        <strong class="nv ir">args</strong>: [<strong class="nv ir">"--spring.config.location=/etc/hello-kubernetes/application.properties"</strong>]<br/>        <strong class="nv ir">ports</strong>:<br/>        - <strong class="nv ir">containerPort</strong>: 8080<br/>        <strong class="nv ir">volumeMounts</strong>:<br/>        - <strong class="nv ir">name</strong>: config-vol<br/>          <strong class="nv ir">mountPath</strong>: /etc/hello-kubernetes<br/>        <strong class="nv ir">readinessProbe</strong>:<br/>          <strong class="nv ir">httpGet</strong>:<br/>            <strong class="nv ir">path</strong>: /<br/>            <strong class="nv ir">port</strong>: 8080<br/>      <strong class="nv ir">volumes</strong>:<br/>      - <strong class="nv ir">name</strong>: config-vol<br/>        <strong class="nv ir">configMap</strong>:<br/>          <strong class="nv ir">name</strong>: hello-kubernetes-configs<br/>      <strong class="nv ir">imagePullSecrets</strong>:<br/>      - <strong class="nv ir">name</strong>: gitlab-auth<br/>---<br/><strong class="nv ir">apiVersion</strong>: v1<br/><strong class="nv ir">kind</strong>: Service<br/><strong class="nv ir">metadata</strong>:<br/>  <strong class="nv ir">name</strong>: hello-kubernetes-service<br/><strong class="nv ir">spec</strong>:<br/>  <strong class="nv ir">type</strong>: LoadBalancer<br/>  <strong class="nv ir">selector</strong>:<br/>    <strong class="nv ir">app</strong>: hello-kubernetes<br/>  <strong class="nv ir">ports</strong>:<br/>  - <strong class="nv ir">port</strong>: 80<br/>    <strong class="nv ir">protocol</strong>: TCP<br/>    <strong class="nv ir">targetPort</strong>: 8080</span></pre><p id="6b8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您只需应用上述文件一次，如下所示:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="a9c4" class="ln lo iq nv b gy nz oa l ob oc">$ kubectl apply -f k8s.yaml</span></pre><p id="8414" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您可以使用以下命令测试部署:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="f68f" class="ln lo iq nv b gy nz oa l ob oc">$ curl "http://$(kubectl get svc -o jsonpath='{@.items[?(@.metadata.name=="hello-kubernetes-service")].status..ip}'):80"</span><span id="87e6" class="ln lo iq nv b gy on oa l ob oc">{"id":3,"content":"Hello from <strong class="nv ir">prod</strong>!"}</span></pre><p id="02e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">生产<strong class="kf ir">配置</strong>已经应用。</p><blockquote class="oh oi oj"><p id="8bf8" class="kd ke od kf b kg kh ki kj kk kl km kn ok kp kq kr ol kt ku kv om kx ky kz la ij bi translated">您可以像配置属性application.env一样配置生产配置(如数据库设置)</p></blockquote><p id="ee67" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以通过以下方式随时获取应用程序的URL:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="32a9" class="ln lo iq nv b gy nz oa l ob oc">$ echo "http://$(kubectl get svc -o jsonpath='{@.items[?(@.metadata.name=="hello-kubernetes-service")].status..ip}'):80"</span></pre></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="f447" class="nd lo iq bd lp ne nf ng ls nh ni nj lv nk nl nm ly nn no np mb nq nr ns me nt bi translated">步骤4:在Gitlab管道中实现CD</h1><p id="300a" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated"><strong class="kf ir">首先</strong>，让我们将Kubernetes集群<code class="fe oe of og nv b">~/.kube/config</code>作为一个变量添加到GitLab CI/CD中，转到<code class="fe oe of og nv b">Settings &gt; CI/CD &gt; Variables</code>并使用关键字<code class="fe oe of og nv b">KUBE_CONFIG_FILE</code>创建一个类型为<strong class="kf ir"> File </strong>的新变量，并使用上述文件的内容作为关键字的值。</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/b0a7fa6337f5c1f86f899e2c29aa3f08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yYrYkVYlyk73nKoC5w8UFQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Gitlab CI/CD变量</figcaption></figure><blockquote class="oh oi oj"><p id="a5d0" class="kd ke od kf b kg kh ki kj kk kl km kn ok kp kq kr ol kt ku kv om kx ky kz la ij bi translated">您可以从您的集群中获取文件<code class="fe oe of og nv b"><em class="iq">~/.kube/config</em></code>的内容，例如在GKE打开控制台和<code class="fe oe of og nv b"><em class="iq">cat ~/.kube/config</em></code>，对于数字occean，您可以从web控制台下载该文件。</p></blockquote><p id="988d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">第二个</strong>，让我们修改<code class="fe oe of og nv b">.gitlab-ci.yml</code>文件并在文件末尾添加以下内容:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="c797" class="ln lo iq nv b gy nz oa l ob oc"><strong class="nv ir">deploy_to_stage</strong>:<br/>  <strong class="nv ir">stage</strong>: deploy<br/>  <strong class="nv ir">when</strong>: manual<br/>  <strong class="nv ir">before_script</strong>:<br/>    - curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl<br/>    - chmod +x ./kubectl<br/>    - mv ./kubectl /usr/local/bin/kubectl<br/>    - kubectl version --client<br/>    - mkdir -p $HOME/.kube &amp;&amp; cp $KUBE_CONFIG_FILE "$HOME/.kube/config"<br/> <strong class="nv ir">script</strong>:<br/>    - &gt;<br/>      kubectl set image deployment hello-kubernetes-deployment<br/>      hello-kubernetes=${REGISTRY_URL}:${DOCKER_BUILD_ID}<br/>      --record</span></pre><p id="0377" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在推送至Gitlab:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="2de9" class="ln lo iq nv b gy nz oa l ob oc">$ git commit -am 'configure k8s cluster CD'<br/>$ git push origin develop # note we already switched to the develop branch</span></pre><p id="40c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">转到Gitlab管道，您会注意到管道中添加了第三个阶段，如下所示:</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oq"><img src="../Images/12d5596ebebe274fae9dc8f828a04704.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZkpbM3kmc_yO8J0CVbGhzw.png"/></div></div></figure><p id="da63" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在点击右边的第三个圆圈<strong class="kf ir">来部署到您的Kubernetes集群。</strong></p><p id="ccf2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在使用以下命令检查部署:</p><pre class="lj lk ll lm gt nu nv nw nx aw ny bi"><span id="c2a7" class="ln lo iq nv b gy nz oa l ob oc">$ kubectl rollout history deployment hello-kubernetes-deployment</span><span id="c314" class="ln lo iq nv b gy on oa l ob oc">deployment.apps/hello-kubernetes-deployment</span><span id="c802" class="ln lo iq nv b gy on oa l ob oc">REVISION  CHANGE-CAUSE</span><span id="6a32" class="ln lo iq nv b gy on oa l ob oc">1         &lt;none&gt;</span><span id="d040" class="ln lo iq nv b gy on oa l ob oc">2         &lt;none&gt;</span><span id="53ff" class="ln lo iq nv b gy on oa l ob oc">3         kubectl set image deployment hello-kubernetes-deployment hello-kubernetes=registry.gitlab.com/mhewedy/hello-kubernetes:develop_e8e1d69b --record=true</span></pre><p id="eb3b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就这样…好好享受吧！</p><blockquote class="oh oi oj"><p id="0596" class="kd ke od kf b kg kh ki kj kk kl km kn ok kp kq kr ol kt ku kv om kx ky kz la ij bi translated">注意，这是一个基本的设置，为了更安全，你需要做的不仅仅是上面的步骤。例如，您需要创建一个在<code class="fe oe of og nv b">.gitlab-ci.yml</code>中使用的服务帐户。</p></blockquote></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="be94" class="nd lo iq bd lp ne nf ng ls nh ni nj lv nk nl nm ly nn no np mb nq nr ns me nt bi translated">参考资料:</h1><p id="9de2" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated"><a class="ae kc" href="https://spring.io/guides/gs/spring-boot-kubernetes/" rel="noopener ugc nofollow" target="_blank">https://spring.io/guides/gs/spring-boot-kubernetes/</a><br/><a class="ae kc" href="https://vix.digital/blog/technology/how-get-kubernetes-pulling-private-gitlab-container-registry/" rel="noopener ugc nofollow" target="_blank">https://VIX . digital/blog/technology/how-get-kubernetes-pulling-private-git lab-container-registry/</a><br/><a class="ae kc" href="https://medium.com/@mhewedy_46874/building-a-cheap-continuous-deployment-environment-2174a5772a0c" rel="noopener">https://medium . com/@ mhewedy _ 46874/building-a-cheap-continuous-deployment-environment-2174 a 5772 a0c</a><br/><a class="ae kc" href="https://docs.spring.io/spring-boot/docs/1.0.1.RELEASE/reference/html/boot-features-external-config.html" rel="noopener ugc nofollow" target="_blank">https://docs . spring . io/spring-boot/docs/1 . 0 . 1 . 0 . 1 . release/referen</a></p></div></div>    
</body>
</html>