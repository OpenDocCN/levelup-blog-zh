<html>
<head>
<title>Compute sha256 of CSP <script/> in NodeJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">è®¡ç®—èŠ‚ç‚¹JSä¸­CSP <script/>çš„sha256</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://levelup.gitconnected.com/compute-sha256-of-csp-script-in-nodejs-720b887bcae6?source=collection_archive---------4-----------------------#2022-09-17">https://levelup.gitconnected.com/compute-sha256-of-csp-script-in-nodejs-720b887bcae6?source=collection_archive---------4-----------------------#2022-09-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c2b1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">ä¸ºå†…å®¹å®‰å…¨ç­–ç•¥è‡ªåŠ¨ç”Ÿæˆè„šæœ¬æ ‡è®°çš„SHA-256å“ˆå¸Œã€‚</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f2e983fe3580e24270e8b9aec50be0aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YGCSAPX6bq6t1kne"/></div></div></figure><p id="7281" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">å‡ å¹´æ¥ï¼Œæˆ‘ä¸€ç›´åœ¨ä½¿ç”¨åŒæ ·çš„ç­–ç•¥ä¸ºæˆ‘çš„<code class="fe lq lr ls lt b">&lt;script /&gt;</code>æ ‡ç­¾è‡ªåŠ¨è®¡ç®—SHA-256å“ˆå¸Œï¼Œæœ€è¿‘æˆ‘åœ¨å·¥ä½œä¸­å’Œåœ¨<a class="ae lu" href="https://papy.rs/" rel="noopener ugc nofollow" target="_blank"> Papyrs </a>ä¸­å†æ¬¡åº”ç”¨äº†è¿™ä¸€ç­–ç•¥(æˆ‘ç›®å‰æ­£åœ¨å°†ç”Ÿæˆåšå®¢ç©ºé—´çš„å·¥å…·åŒ…ä»æ™®é€šJavaScriptè¿ç§»åˆ°<a class="ae lu" href="https://astro.build/" rel="noopener ugc nofollow" target="_blank"> Astro </a>ï¼Œæˆ‘è®¤ä¸ºè¿™å¯èƒ½æ˜¯ä¸€ç¯‡æ–°çš„ç®€çŸ­åšå®¢æ–‡ç« çš„æœ‰è¶£ä¸»é¢˜ã€‚</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2903" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">å…¥é—¨æŒ‡å—</h1><p id="2ec1" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">è™½ç„¶å¯ä»¥æ‰‹åŠ¨è®¾ç½®<code class="fe lq lr ls lt b">sha256</code>,ä½†æˆ‘ä¸ªäººæ›´å–œæ¬¢åœ¨<code class="fe lq lr ls lt b">build</code>è„šæœ¬ç»“æŸåè‡ªåŠ¨ç”Ÿæˆå®ƒä»¬â€”â€”ä½œä¸ºä¸€é¡¹åæœŸå¤„ç†å·¥ä½œã€‚è¿™æ„å‘³ç€æˆ‘ä¾èµ–äºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œå³æ„å»ºçš„å†…å®¹æ˜¯å¯ä¿¡çš„ï¼Œå¹¶ä¸”ä¸€æ—¦ç”Ÿæˆäº†è„šæœ¬ï¼Œæˆ‘å°±è®¡ç®—å…¶å€¼ã€‚</p><p id="e604" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">ä¸ºæ­¤ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªä¸“ç”¨è„šæœ¬ï¼Œä¾‹å¦‚<code class="fe lq lr ls lt b">./build-csp.mjs</code>ï¼Œå¹¶å°†å…¶é™„åŠ åˆ°æˆ‘çš„æ„å»ºè„šæœ¬ä¸­:</p><pre class="kj kk kl km gt mz lt na nb aw nc bi"><span id="d944" class="nd md it lt b gy ne nf l ng nh">// package.json<br/><br/>{<br/>    "scripts": {<br/>        "build:csp": "node build-csp.mjs",<br/>        "build": "astro build &amp;&amp; npm run build:csp"<br/>    }<br/>}</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="de9b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">æœç´¢å’Œæ›´æ–°</h1><p id="1e03" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">å› ä¸ºæˆ‘çš„ç›®æ ‡æ˜¯åœ¨æµç¨‹çš„æœ€åæ³¨å…¥shaï¼Œæ‰€ä»¥æˆ‘åœ¨å†…å®¹å®‰å…¨ç­–ç•¥(CSP)ä¸­æ·»åŠ äº†ä¸€ä¸ªå ä½ç¬¦æ¥æœç´¢å’Œæ›´æ–°è®¡ç®—å‡ºçš„å€¼ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„CSP <code class="fe lq lr ls lt b">meta</code>æ ‡ç­¾ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†å ä½ç¬¦<code class="fe lq lr ls lt b">{{EXTRA_SHAS}}</code>:</p><pre class="kj kk kl km gt mz lt na nb aw nc bi"><span id="f85a" class="nd md it lt b gy ne nf l ng nh">&lt;meta<br/>    http-equiv="Content-Security-Policy"<br/>    content="default-src 'none';<br/>             script-src 'self' {{EXTRA_SHAS}};<br/>/&gt;</span></pre><p id="0861" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">å› ä¸ºè¿™æ ·çš„å ä½ç¬¦ä¸æ˜¯æœ‰æ•ˆçš„ç­–ç•¥ï¼Œæ‰€ä»¥æµè§ˆå™¨åœ¨è¯„ä¼°è§„åˆ™æ—¶ä¼šæŠ›å‡ºé”™è¯¯ã€‚å½“æˆ‘å¼€å‘æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œå› ä¸ºæˆ‘åªå¯¹äº§å“æ„å»ºè¿›è¡ŒåæœŸå¤„ç†ã€‚</p><p id="e23a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ç»å¸¸é¿å…åœ¨æˆ‘çš„æœ¬åœ°ç¯å¢ƒä¸­ä½¿ç”¨CSPã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘çš„Astroé¡¹ç›®ä¸­ï¼Œå¦‚æœä¸æ˜¯<code class="fe lq lr ls lt b">PROD</code>ç‰ˆæœ¬ï¼Œæˆ‘ä¼šè·³è¿‡<code class="fe lq lr ls lt b">meta</code>æ ‡ç­¾çš„æ¸²æŸ“ã€‚</p><pre class="kj kk kl km gt mz lt na nb aw nc bi"><span id="2679" class="nd md it lt b gy ne nf l ng nh">---<br/>const csp = import.meta.env.PROD;<br/>---<br/><br/>{<br/>  csp &amp;&amp; (<br/>    &lt;meta<br/>      http-equiv="Content-Security-Policy"<br/>      content="default-src 'none';<br/>      script-src 'self' {{EXTRA_SHAS}};<br/>    /&gt;<br/>  )<br/>}</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="bc9e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">åˆ—å‡ºæ‰€æœ‰HTMLæ–‡ä»¶</h1><p id="7918" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">ä¸ºäº†è®¡ç®—HTMLæ–‡ä»¶ä¸­ä½¿ç”¨çš„<code class="fe lq lr ls lt b">&lt;script /&gt;</code>å†…å®¹çš„<code class="fe lq lr ls lt b">sha256</code> shaï¼Œæˆ‘é¦–å…ˆéœ€è¦åˆ—å‡ºå·²ç»æ„å»ºçš„HTMLæ–‡ä»¶ã€‚</p><p id="b19c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">ä¸ºæ­¤ï¼Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªé€’å½’æ¢ç´¢å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¾ˆå¯èƒ½æ˜¯æˆ‘åœ¨Stackoverflowä¸Šæ‰¾åˆ°çš„ï¼Œå¹¶ä¸€ç›´ä½¿ç”¨è‡³ä»Šã€‚</p><pre class="kj kk kl km gt mz lt na nb aw nc bi"><span id="4f9c" class="nd md it lt b gy ne nf l ng nh">import { readdirSync, lstatSync } from "fs";<br/>import { join } from "path";<br/><br/>export const findEntryPoints = (dir, files) =&gt; {<br/>  readdirSync(dir).forEach((file) =&gt; {<br/>    const fullPath = join(dir, file);<br/>    if (lstatSync(fullPath).isDirectory()) {<br/>      findEntryPoints(fullPath, files);<br/>    } else {<br/>      files.push(fullPath);<br/>    }<br/>  });<br/>};<br/><br/>const entryPoints = [];<br/>findEntryPoints("dist", entryPoints);</span></pre><p id="eaa2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">ä¸€æ—¦æˆ‘å¾—åˆ°äº†æ‰€æœ‰çš„æ–‡ä»¶ï¼Œæˆ‘å°±è¿‡æ»¤æ‰é‚£äº›<code class="fe lq lr ls lt b">.html</code>çš„æ–‡ä»¶ã€‚</p><pre class="kj kk kl km gt mz lt na nb aw nc bi"><span id="f855" class="nd md it lt b gy ne nf l ng nh">import { extname } from "path";<br/><br/>const htmlEntryPoints = entryPoints.filter((entry) =&gt;<br/>  [".html"].includes(extname(entry))<br/>);</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ff28" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">å¤„ç†å’Œæ›´æ–°CSP</h1><p id="70a2" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">ä¸€æ—¦æˆ‘å¾—åˆ°äº†æ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶ï¼Œæˆ‘å°±é€šè¿‡è¯»å–å®ƒä»¬çš„å†…å®¹æ¥æ‰¹é‡æ›´æ–°å®ƒä»¬ï¼Œç”Ÿæˆç›¸å…³çš„shaå¹¶æœ€ç»ˆæ›´æ–°è§„åˆ™ã€‚</p><pre class="kj kk kl km gt mz lt na nb aw nc bi"><span id="10cb" class="nd md it lt b gy ne nf l ng nh">import { join } from "path";<br/>import { readFile } from "fs/promises";<br/><br/>const updateCSP = async (entry) =&gt; {<br/>  const indexHtml = <br/>        await readFile(join(process.cwd(), entry), "utf-8");<br/>  const scriptHashes = await computeHashes(indexHtml);<br/>  await writeCSP({ scriptHashes, indexHtml, entry });<br/>};<br/><br/>const promises = htmlEntryPoints.map(updateCSP);<br/>await Promise.all(promises);</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="5941" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">è®¡ç®—æœºsha256</h1><p id="0bf0" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">ä¸ºäº†ä¸º<code class="fe lq lr ls lt b">&lt;script /&gt;</code>æ ‡ç­¾çš„å†…å®¹åˆ›å»ºæ•£åˆ—ï¼Œæˆ‘ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æŸ¥æ‰¾è¿™äº›æ ‡ç­¾ï¼Œå¹¶ä½¿ç”¨NodeJSçš„<a class="ae lu" href="https://nodejs.org/api/crypto.html#cryptocreatehashalgorithm-options" rel="noopener ugc nofollow" target="_blank"> Crypto API </a>æ¥æœ‰æ•ˆåœ°è®¡ç®—å€¼ã€‚</p><pre class="kj kk kl km gt mz lt na nb aw nc bi"><span id="0df0" class="nd md it lt b gy ne nf l ng nh">import { createHash } from "crypto";<br/><br/>const computeHashes = (indexHtml) =&gt; {<br/>  const sw = /&lt;script[\s\S]*?&gt;([\s\S]*?)&lt;\/script&gt;/gm;<br/><br/>  const scriptHashes = [];<br/><br/>  let m;<br/>  while ((m = sw.exec(indexHtml))) {<br/>    const content = m[1];<br/><br/>    scriptHashes.push(<br/>      `'sha256-${createHash("sha256")<br/>               .update(content).digest("base64")}'`<br/>    );<br/>  }<br/><br/>  return scriptHashes;<br/>};</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0149" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">å†™å…¥ç»“æœ</h1><p id="8cac" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">æœ€åï¼Œæˆ‘ç”¨è¿™äº›æœ‰æ•ˆçš„shaæ›¿æ¢æˆ‘ä¹‹å‰å£°æ˜çš„å ä½ç¬¦ã€‚</p><pre class="kj kk kl km gt mz lt na nb aw nc bi"><span id="4056" class="nd md it lt b gy ne nf l ng nh">import { writeFile } from "fs/promises";<br/><br/>const writeCSP = async ({ scriptHashes, indexHtml, entry }) =&gt;<br/>  writeFile(<br/>    entry,<br/>    indexHtml.replace(<br/>      "{{EXTRA_SHAS}}",<br/>      scriptHashes.map((sha256) =&gt; sha256).join(" ")<br/>    ),<br/>    "utf-8"<br/>  );</span></pre><p id="e712" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">è¿™å°±æ˜¯ğŸ¥³</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9179" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">æ‘˜è¦</h1><p id="931f" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">åœ¨ç”Ÿæ´»ä¸­ï¼Œæœ‰æ—¶æ˜¯ä¸€äº›å°äº‹è®©ä½ å¼€å¿ƒï¼Œå¼€å‘è¿™ä¸ªå°åŠ©æ‰‹è„šæœ¬å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚</p><p id="2609" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">åˆ°æ— é™å’Œæ›´è¿œçš„åœ°æ–¹</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="f416" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">æ›´å¤šå†’é™©ï¼Œè¯·åœ¨ğŸ––çš„æ¨ç‰¹ä¸Šå…³æ³¨æˆ‘</p></div></div>    
</body>
</html>