<html>
<head>
<title>Committing Better Go Code with Static Analysis and Git Hooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用静态分析和Git挂钩提交更好的Go代码</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/committing-better-go-code-with-static-analysis-and-git-hooks-23216b8a1674?source=collection_archive---------3-----------------------#2019-02-08">https://levelup.gitconnected.com/committing-better-go-code-with-static-analysis-and-git-hooks-23216b8a1674?source=collection_archive---------3-----------------------#2019-02-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2d6e229d16277cf064dd35c9b1f86b01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*shaOnc_YeagLs9sNW0KXdQ.jpeg"/></div></div></figure><p id="002c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我使用Go已经有一段时间了，现在有三个静态分析工具(linters)是我日常使用的。还有几十种我可以使用的工具，但是我认为过分依赖这些工具(大部分是非官方的)来为你工作是不明智的。最终，它们将成为跟踪、维护的噩梦，并且最终可能变得无人维护或无人支持。让我们看一下包装。</p><h1 id="ef27" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Gofmt</h1><p id="ae47" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><a class="ae kw" href="https://golang.org/cmd/gofmt/" rel="noopener ugc nofollow" target="_blank"> Gofmt </a>是一个用于格式化Go代码的官方工具，从2013年开始成为语言的一部分。</p><p id="4658" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">格式化文件就像这样简单:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="ce43" class="mj ky iq mf b gy mk ml l mm mn">$ go fmt main.go</span></pre><p id="4512" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者您可以针对整个包:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="0fb8" class="mj ky iq mf b gy mk ml l mm mn">$ go fmt ./pkg/models</span></pre><p id="5614" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">格式化当前目录下的所有包(不包括<code class="fe mo mp mq mf b">vendor</code>):</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="84dc" class="mj ky iq mf b gy mk ml l mm mn">$ go fmt <strong class="mf ir">$(</strong>go list ./... | grep -v /vendor/<strong class="mf ir">)</strong></span></pre><h1 id="fa36" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">错误检查</h1><p id="957c" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">用制作者自己的话说，<a class="ae kw" href="https://github.com/kisielk/errcheck" rel="noopener ugc nofollow" target="_blank"> errcheck </a>“检查你检查的错误”。换句话说，它会扫描你的代码，并告诉你是否有任何错误。这对于那些在做了一个小小的改变后愚蠢地忘记运行应用程序的时候很有用。</p><p id="2b1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要检查包中的错误:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="ebf9" class="mj ky iq mf b gy mk ml l mm mn">$ errcheck ./pkg/models</span></pre><p id="930a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者扫描当前目录下的所有包(不包括<code class="fe mo mp mq mf b">vendor</code>):</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="6e9c" class="mj ky iq mf b gy mk ml l mm mn">$ errcheck <strong class="mf ir">$(</strong>go list ./... | grep -v /vendor/<strong class="mf ir">)</strong></span></pre><h1 id="ccfc" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">审查</h1><p id="def2" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Vet是Go中的另一个官方静态分析工具。Vet检查源代码中的可疑结构，比如参数与格式字符串不一致的Printf调用。</p><p id="53f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它的执行与Gofmt非常相似。</p><p id="812b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">审查单个文件:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="5b74" class="mj ky iq mf b gy mk ml l mm mn">$ go vet main.go</span></pre><p id="732e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查整个包:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="29e9" class="mj ky iq mf b gy mk ml l mm mn">$ go vet ./pkg/models</span></pre><p id="f55e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">审核当前目录下的所有包(不包括<code class="fe mo mp mq mf b">vendor</code>):</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="c32b" class="mj ky iq mf b gy mk ml l mm mn">$ go fmt <strong class="mf ir">$(</strong>go list ./... | grep -v /vendor/<strong class="mf ir">)</strong></span></pre><h1 id="4d2d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">用Git挂钩自动化这些工具</h1><p id="c281" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><a class="ae kw" href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks" rel="noopener ugc nofollow" target="_blank"> Git钩子</a>是自动化这些重复任务的好方法，确保你不会提交或推送任何不完整的代码。这些钩子都存储在Git项目的<code class="fe mo mp mq mf b">.git/hooks</code>子目录中，并将在预定义的Git事件列表上或之后自动执行。</p><p id="f8a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此，我们将绑定到<code class="fe mo mp mq mf b">pre-commit</code>钩子，因为我们只希望我们的脚本在将文件提交给Git之前检查它们。</p><p id="41b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe mo mp mq mf b">.git/hooks</code>中创建一个名为<code class="fe mo mp mq mf b">pre-commit</code>的新文件，并在您最喜欢的编辑器中打开它。通过从终端运行<code class="fe mo mp mq mf b">chmod +x .git/hooks/pre-commit</code>使其可执行。</p><p id="bfbc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们将项目中的文件列表存储到一个名为<code class="fe mo mp mq mf b">FILES</code>的变量中:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="8b45" class="mj ky iq mf b gy mk ml l mm mn">FILES<strong class="mf ir">=$(</strong>go list ./...  | grep -v /vendor/<strong class="mf ir">)</strong></span></pre><p id="2bca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在格式化您的代码旁边添加Gofmt:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="b5f1" class="mj ky iq mf b gy mk ml l mm mn">go fmt <strong class="mf ir">${</strong>FILES<strong class="mf ir">}</strong></span></pre><p id="21fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦格式化，我们需要检查的最重要的事情是是否有任何错误。如果有，我们可以退出脚本并阻止提交。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="4593" class="mj ky iq mf b gy mk ml l mm mn"><strong class="mf ir">{<br/>    </strong>errcheck -ignoretests <strong class="mf ir">${</strong>FILES<strong class="mf ir">}</strong><br/><strong class="mf ir">}</strong> <strong class="mf ir">||</strong> <strong class="mf ir">{<br/>    </strong>exitStatus<strong class="mf ir">=</strong>$?</span><span id="5b80" class="mj ky iq mf b gy mr ml l mm mn"><strong class="mf ir">    if</strong> <strong class="mf ir">[</strong> $exitStatus <strong class="mf ir">]</strong>; <strong class="mf ir">then<br/>	</strong>printf "\nErrors found in your code, please fix them and try again."<br/>	exit 1<br/>    <strong class="mf ir">fi</strong><br/><strong class="mf ir">}</strong></span></pre><p id="c236" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果代码没有错误，接下来我们应该检查是否有任何可疑的构造。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="1149" class="mj ky iq mf b gy mk ml l mm mn"><strong class="mf ir">{</strong><br/>    go vet <strong class="mf ir">${</strong>FILES<strong class="mf ir">}</strong><br/><strong class="mf ir">}</strong> <strong class="mf ir">||</strong> <strong class="mf ir">{</strong><br/>    exitStatus<strong class="mf ir">=</strong>$?</span><span id="8356" class="mj ky iq mf b gy mr ml l mm mn"><strong class="mf ir">    if</strong> <strong class="mf ir">[</strong> $exitStatus <strong class="mf ir">]</strong>; <strong class="mf ir">then<br/>	</strong>printf "\nIssues found in your code, please fix them and try again."<br/>	exit 1<br/>    <strong class="mf ir">fi</strong><br/><strong class="mf ir">}</strong></span></pre><p id="2a2c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里是完整的<code class="fe mo mp mq mf b">pre-commit</code>钩子。现在就把它添加到你的项目中，开始提交更好的Go代码。</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="3e79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://endaphelan.me/guides/golang/committing-better-go-code-with-static-analysis-and-git-hooks/" rel="noopener ugc nofollow" target="_blank">原帖链接</a></p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><figure class="ma mb mc md gt jr gh gi paragraph-image"><a href="https://levelup.gitconnected.com"><div class="gh gi nb"><img src="../Images/9914c5dd23ac08b70eea6f4f9ba6fed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E6CoI_MRyZ1JInNPsBSHtA.png"/></div></a></figure><div class="nc nd gp gr ne nf"><a href="https://gitconnected.com/learn/golang" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd ir gy z fp nk fr fs nl fu fw ip bi translated">学习围棋-最佳围棋教程(2019) | gitconnected</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">23大围棋教程-免费学习围棋。课程由开发者提交和投票，使您能够找到…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">gitconnected.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt jw nf"/></div></div></a></div></div></div>    
</body>
</html>