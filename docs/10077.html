<html>
<head>
<title>Prometheus Counter Metrics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">普罗米修斯计数器度量</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/prometheus-counter-metrics-d6c393d86076?source=collection_archive---------1-----------------------#2021-10-24">https://levelup.gitconnected.com/prometheus-counter-metrics-d6c393d86076?source=collection_archive---------1-----------------------#2021-10-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="61ed" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">对最基本的普罗米修斯标准的深入研究</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e61af6eeff33b351e591febf2075cb31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yS1joDYtwqCTnE8ne9NPYg.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">克里斯·贾维斯在<a class="ae kv" href="https://unsplash.com/s/photos/counting?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c011" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">普罗米修斯计数器需要一些时间来适应。官方文档很好地解释了这个理论，但是直到我创建了一些图表，我才明白这个度量是多么强大。</p><p id="62bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文将理论与图形相结合，以更好地理解普罗米修斯的反度规。我们将看到PromQL函数<code class="fe ls lt lu lv b">rate</code>、<code class="fe ls lt lu lv b">increase</code>、<code class="fe ls lt lu lv b">irate</code>和<code class="fe ls lt lu lv b">resets</code>是如何工作的，更重要的是，我们将看到一些由生产数据的计数器指标生成的图表。</p><h1 id="9c74" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">唯一的方法是向上…</h1><p id="738c" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">正如你可能从名字中猜到的，计数器计数。它以最简单的方式做到了这一点，因为它的值只能增加而不能减少。</p><p id="58bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然不可能减少正在运行的计数器的值，但可以重置计数器。应用程序重启时会发生重置。</p><p id="f047" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种行为使得counter适合于跟踪只能上升的事物。一些例子包括:</p><ul class=""><li id="505b" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr my mz na nb bi translated">你喝了多少啤酒</li><li id="7569" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">你开车行驶的总距离</li></ul><p id="e469" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">或者在应用程序开发中:</p><ul class=""><li id="c7f4" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr my mz na nb bi translated">HTTP请求的总数</li><li id="ffda" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">日志消息的总数</li><li id="62f4" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">作业执行的总量</li></ul><p id="e7ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">永远不要用计数器来计算可能上升或下降的数字。例如，您不应该使用计数器来跟踪数据库的大小，因为数据库的大小既可以扩大也可以缩小。</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><h1 id="aa98" class="lw lx iq bd ly lz no mb mc md np mf mg jw nq jx mi jz nr ka mk kc ns kd mm mn bi translated">使用计数器</h1><p id="e44b" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">在本节中，我们将了解计数器可以提供的独特见解。我们将使用一个示例度量来计算作业执行的数量。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="c45e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这段代码定义了一个名为<code class="fe ls lt lu lv b">job_execution</code>的计数器。应用度量库Micrometer将把这个度量导出为<code class="fe ls lt lu lv b">job_execution_total</code>。<code class="fe ls lt lu lv b">execute()</code>方法每30秒运行一次，每次运行时，它都会将我们的计数器加1。</p><h2 id="7b72" class="nv lx iq bd ly nw nx dn mc ny nz dp mg lf oa ob mi lj oc od mk ln oe of mm og bi translated">原始计数器值</h2><p id="ed4b" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">从原始计数器值中获得的见解在大多数情况下没有价值。如果我们绘制原始计数器值，我们会看到一条不断上升的线。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/63b063025506f575c60172dea271534b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fXCEx-W3IxXtR8kFVXfHqA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">绘制原始计数器值会导致一条直线上升。</figcaption></figure><p id="1846" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这条线会一直上升，直到我们重新启动应用程序。当应用程序重新启动时，计数器被重置为零。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/f794617154d45644e1922ecf3216dd8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3F3rbE6-F7cLsPeA9aQ-tw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">当应用程序重新启动时，计数器重置为零。</figcaption></figure><p id="d495" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">幸运的是，prom QL(Prometheus查询语言)提供了从我们的计数器中获取更有洞察力的数据的功能。</p><h2 id="5585" class="nv lx iq bd ly nw nx dn mc ny nz dp mg lf oa ob mi lj oc od mk ln oe of mm og bi translated">速度</h2><p id="8b33" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">Prometheus的<code class="fe ls lt lu lv b">rate</code>函数计算在定义的时间窗口内，计数器每秒增加的速率。以下PromQL表达式计算最后一分钟内每秒执行的作业数。</p><pre class="kg kh ki kj gt oj lv ok ol aw om bi"><span id="09cd" class="nv lx iq lv b gy on oo l op oq">rate(job_execution_total[1m])</span></pre><p id="cdd1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的作业以固定的时间间隔运行，所以将上面的表达式绘制成一条直线。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/2c9b445457ba3365007d05ac832a0ce6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jbWh_T8SPf_x8GDFsppflg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">绘制一分钟窗口内的作业执行率</figcaption></figure><p id="36cc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从图中，我们可以看到每秒大约执行0.036个作业。这个数乘以60，你得到2.16。这比预期的要高，因为我们的作业每30秒运行一次，也就是每分钟运行两次。</p><p id="d3a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">普罗米修斯抓取指标的方式会导致预期值和测量值之间的微小差异。根据时间的不同，结果值可能会更高或更低。重要的是要记住，普罗米修斯矩阵不是一门精确的科学。</p><p id="09dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">PromQL的<code class="fe ls lt lu lv b">rate</code>自动调整计数器重置和其他问题。因此，每当应用程序重新启动时，我们不会像处理原始计数器值那样看到任何奇怪的下降。</p><blockquote class="or"><p id="8fb5" class="os ot iq bd ou ov ow ox oy oz pa lr dk translated">单调性的中断(如由于目标重新启动导致的计数器重置)会自动进行调整。此外，计算会外推至时间范围的终点，考虑到遗漏的刮擦或刮擦周期与该范围的时间段不完全一致。—普罗米修斯文档</p></blockquote><p id="9c1f" class="pw-post-body-paragraph kw kx iq ky b kz pb jr lb lc pc ju le lf pd lh li lj pe ll lm ln pf lp lq lr ij bi translated">关于<code class="fe ls lt lu lv b">rate</code>函数需要注意的最后一点是，我们应该只在计数器中使用它。将<code class="fe ls lt lu lv b">rate</code>与任何其他普罗米修斯公制类型一起使用没有什么意义。</p><h2 id="0bee" class="nv lx iq bd ly nw nx dn mc ny nz dp mg lf oa ob mi lj oc od mk ln oe of mm og bi translated">提高</h2><p id="455f" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">普罗米修斯的<code class="fe ls lt lu lv b">increase</code>函数计算指定时间范围内的计数器增量。以下PromQL表达式计算过去5分钟内的作业执行数。</p><pre class="kg kh ki kj gt oj lv ok ol aw om bi"><span id="a5a7" class="nv lx iq lv b gy on oo l op oq">increase(job_execution_total[5m])</span></pre><p id="a036" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我们的作业以30秒的固定时间间隔运行，所以我们的图表应该显示一个大约为10的值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pg"><img src="../Images/d8b88d58da8f1ec43ae83ee3fc7ea21f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pBI4H7QPxvJz7Bc2GValwg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">绘制过去5分钟内的作业执行数</figcaption></figure><p id="abb6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">普罗米修斯外推<code class="fe ls lt lu lv b">increase</code>覆盖全部指定时间窗口。因此，尽管计数器仅按整数增量增加，也可能得到非整数结果。</p><p id="d743" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">类似于<code class="fe ls lt lu lv b">rate</code>，我们应该只用带计数器的<code class="fe ls lt lu lv b">increase</code>。将<code class="fe ls lt lu lv b">increase</code>与任何其他普罗米修斯公制类型一起使用没有什么意义。</p><h2 id="3357" class="nv lx iq bd ly nw nx dn mc ny nz dp mg lf oa ob mi lj oc od mk ln oe of mm og bi translated">生气的</h2><p id="8223" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">这个指标与<code class="fe ls lt lu lv b">rate</code>非常相似。就像<code class="fe ls lt lu lv b">rate</code>，<code class="fe ls lt lu lv b">irate</code>计算在一个定义的时间窗口内计数器每秒增加的速率。不同之处在于<code class="fe ls lt lu lv b">irate</code>只查看最后两个数据点。这使得<code class="fe ls lt lu lv b">irate</code>非常适合绘制易变和/或快速移动的计数器。</p><p id="8233" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面的PromQL表达式返回每秒钟执行作业的速率，查找最早两分钟前的两个最近的数据点。</p><pre class="kg kh ki kj gt oj lv ok ol aw om bi"><span id="d754" class="nv lx iq lv b gy on oo l op oq">irate(job_execution_total[2m])</span></pre><p id="c184" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们应该只使用带计数器的<code class="fe ls lt lu lv b">Irate</code>。</p><h2 id="6cd6" class="nv lx iq bd ly nw nx dn mc ny nz dp mg lf oa ob mi lj oc od mk ln oe of mm og bi translated">重置</h2><p id="0209" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">Prometheus的<code class="fe ls lt lu lv b">resets</code>函数给出指定时间窗口内计数器复位的次数。以下PromQL表达式计算过去5分钟内作业执行计数器重置的次数。</p><pre class="kg kh ki kj gt oj lv ok ol aw om bi"><span id="ebc6" class="nv lx iq lv b gy on oo l op oq">resets(job_execution_total[5m])</span></pre><p id="af53" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们应该只使用带计数器的<code class="fe ls lt lu lv b">resets</code>。</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><h1 id="3844" class="lw lx iq bd ly lz no mb mc md np mf mg jw nq jx mi jz nr ka mk kc ns kd mm mn bi translated">真实世界的示例图</h1><p id="d8c4" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">到目前为止，我们看到的图表有助于理解计数器的工作原理，但它们很无聊。</p><p id="28cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了更深入地了解这些图形在生产环境中会是什么样子，我从我们工作时的Grafana仪表板上截取了一些截图。</p><p id="13a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于不想暴露公司机密，我对所有数据进行了匿名处理…</p><p id="fc10" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下图使用<code class="fe ls lt lu lv b">increase</code>来计算每分钟处理的消息数量。当绘制24小时窗口的图表时，可以清楚地看到夜间的交通流量要低得多。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ph"><img src="../Images/68a20127691fdfc0c575e8582819ae80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qvf_pGNXF283yJ4XAiLFbw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">使用increase绘制我们每分钟处理的邮件数量</figcaption></figure><p id="0271" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里我们有相同的度量，但是这个使用<code class="fe ls lt lu lv b">rate</code>来度量每秒处理的消息数。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pi"><img src="../Images/725efdbfe7d7ba35e4769e06f1e0695c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Aa_x34acMmCHZJvv-G9YQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">使用rate来绘制我们每秒处理的消息数量</figcaption></figure><p id="01fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如人们所料，这两张图看起来一样，只是比例不同。你应该使用哪一个取决于你测量的东西和你的偏好。</p><p id="86c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个例子中，我更喜欢<code class="fe ls lt lu lv b">rate</code>变体。我认为看到我们每秒处理6.5条消息比看到我们每分钟处理390条消息更容易理解。</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><h1 id="9b5e" class="lw lx iq bd ly lz no mb mc md np mf mg jw nq jx mi jz nr ka mk kc ns kd mm mn bi translated">结论</h1><p id="49d2" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">Prometheus计数器是一个简单的指标，但是可以通过使用不同的PromQL函数来创建有价值的见解，这些函数是为计数器设计的。您应该使用哪个PromQL函数取决于被测量的对象和您正在寻找的洞察力。</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><p id="0cff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢您的阅读。我希望这有所帮助。如果您有任何问题或反馈，请随时回复。</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><h1 id="df89" class="lw lx iq bd ly lz no mb mc md np mf mg jw nq jx mi jz nr ka mk kc ns kd mm mn bi translated">参考</h1><p id="4345" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">[1]<a class="ae kv" href="https://prometheus.io/docs/concepts/metric_types/" rel="noopener ugc nofollow" target="_blank">https://prometheus.io/docs/concepts/metric_types/</a></p><p id="1f11" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[2]<a class="ae kv" href="https://prometheus.io/docs/prometheus/latest/querying/functions/" rel="noopener ugc nofollow" target="_blank">https://Prometheus . io/docs/Prometheus/latest/query/functions/</a></p></div></div>    
</body>
</html>