# Sudo 漏洞检查

> 原文：<https://levelup.gitconnected.com/ethical-hacking-part-18-sudo-vulnerability-checking-2f2ef3abb6e2>

## 道德黑客了解风险以防止攻击——检查 Linux 系统是否易受 sudo 漏洞的攻击

![](img/f7d4afdf26df8e8d868fc2d7bf863079.png)

“ **sudo** ”是一个可以在基于 Linux 的操作系统上找到的程序。它允许用户以提升的安全权限或其他用户的安全权限运行程序。通常，它用于允许非管理用户执行或运行超级用户命令。它也可以用来完全交换给另一个用户。它最初代表“**超级用户 do** ”，因为旧版本的 sudo 被设计成只能作为超级用户运行命令。

为了演示这一点，我构建了一个 Amazon EC2 实例。Redhat/CentOS EC2 实例的默认用户名是“**EC2-用户**”，Ubuntu 的默认用户名是“ **ubuntu** ”。出于本教程的目的，我将使用 Redhat，但这并不重要，因为任何基于 Linux 的实例都可以。

```
% **ssh -i mykey.pem ec2-user@54.154.166.70**
Last login: Fri Nov 20 23:31:10 2020 from ...
[ec2-user@ip-172-16-0-101 ~]$
```

如您所见，我已经使用“**ec2-用户**”登录。现在这是一个正常的非管理帐户。我将要安装“ **git** ”和“ **wget** ”，这需要超级用户权限。

```
[ec2-user@ip-172-16-0-118 ~]$ **yum install git wget -y**
Error: This command has to be run with superuser privileges (under the root user on most systems).
```

使用“ **sudo** ”有两种方法可以做到这一点。第一种是使用 sudo 运行命令。

```
[ec2-user@ip-172-16-0-118 ~]$ **sudo yum install git wget -y**
Last metadata expiration check: 0:00:40 ago on Fri 20 Nov 2020 23:41:50 UTC.
Package git-2.27.0-1.el8.x86_64 is already installed.
Package wget-1.19.5-10.el8.x86_64 is already installed.
Dependencies resolved.
Nothing to do.
Complete!
```

第二种是“ **sudo** ”到 root 然后进行安装。

```
[ec2-user@ip-172-16-0-118 ~]$ **sudo su -**
[root@ip-172-16-0-118 ~]# **yum install git wget -y**
Last metadata expiration check: 0:01:06 ago on Fri 20 Nov 2020 11:41:50 PM UTC.
Package git-2.27.0-1.el8.x86_64 is already installed.
Package wget-1.19.5-10.el8.x86_64 is already installed.
Dependencies resolved.
Nothing to do.
Complete!
```

我们将使用具有 sudo 权限的非管理帐户来学习本教程。在此之前，让我们快速浏览一下" **/etc/sudoers** "配置文件。

```
[root@ip-172-16-0-118 ~]# cat /etc/sudoers
...
ec2-user ALL=(ALL) NOPASSWD: ALL
```

我们感兴趣的部分是最后一行，它允许“**ec2-用户**”在没有密码的情况下以 root 用户身份运行一切。请注意，不要直接编辑“ **/etc/sudoers** ”文件，因为一个错误可能会将您锁定。取而代之的是使用一个名为“ **visudo** ”的编辑器，它会在保存之前进行一致性检查。

让我们退出并回到"**ec2-用户** "…

```
[root@ip-172-16-0-118 ~]# **exit**
logout
[ec2-user@ip-172-16-0-118 ~]$
```

我们现在要下载(" **git 克隆**")、[**SUDO _ 杀手**](https://github.com/TH3xACE/SUDO_KILLER) )。

```
[ec2-user@ip-172-16-0-118 ~]$ **git clone** [**https://github.com/TH3xACE/SUDO_KILLER**](https://github.com/TH3xACE/SUDO_KILLER)
Cloning into 'SUDO_KILLER'...
remote: Enumerating objects: 86, done.
remote: Counting objects: 100% (86/86), done.
remote: Compressing objects: 100% (67/67), done.
remote: Total 1103 (delta 46), reused 40 (delta 18), pack-reused 1017
Receiving objects: 100% (1103/1103), 5.92 MiB | 1.17 MiB/s, done.
Resolving deltas: 100% (676/676), done.[ec2-user@ip-172-16-0-118 ~]$ **cd SUDO_KILLER**[ec2-user@ip-172-16-0-118 SUDO_KILLER]$ **./SUDO_KILLERv2.0.5.sh -h**

 Example: ./sudo_killer.sh -c -r report.txt -e /tmp/OPTIONS:
-c  Include sudo CVE
-i  import (offline mode) from extract.sh
-e  Include export of sudo rules / sudoers file
-r  Enter report name
-p path where to save export and report
-s  Supply user password for sudo checks (NOT SECURE)
-h Displays this help textRunning with no options = limited scans/no output file
 #########################################################
```

在我们做任何事情之前，我们想运行一个更新。

```
[ec2-user@ip-172-16-0-118 SUDO_KILLER]$ **chmod +x cve_updatev2.sh** 
[ec2-user@ip-172-16-0-118 SUDO_KILLER]$ **./cve_updatev2.sh** --2020-11-20 23:50:57--  [https://www.cvedetails.com/vulnerability-list.php?vendor_id=118](https://www.cvedetails.com/vulnerability-list.php?vendor_id=118)
Resolving [www.cvedetails.com](http://www.cvedetails.com) ([www.cvedetails.com](http://www.cvedetails.com))... 172.67.172.115, 104.18.54.201, 104.18.55.201, ...
Connecting to [www.cvedetails.com](http://www.cvedetails.com) ([www.cvedetails.com)|172.67.172.115|:443](http://www.cvedetails.com)|172.67.172.115|:443)... connected.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [text/html]
Saving to: ‘cve_list.html’
...
```

通常，部署新实例的第一步是运行系统升级和更新。我不打算在这里做，因为我希望一个未打补丁的系统会有一些漏洞让我们看看。

我已经运行了“**SUDO _ 杀手**”，并用粗体突出显示了感兴趣的点。

```
[ec2-user@ip-172-16-0-118 SUDO_KILLER]$ **./SUDO_KILLERv2.0.5.sh** 
   _____ _    _ _____   ____    _  _______ _      _      ______ _____
  / ____| |  | |  __ \ / __ \  | |/ /_   _| |    | |    |  ____|  __ \
 | (___ | |  | | |  | | |  | | | ' /  | | | |    | |    | |__  | |__) |
  \___ \| |  | | |  | | |  | | |  <   | | | |    | |    |  __| |  _  /
  ____) | |__| | |__| | |__| | | . \ _| |_| |____| |____| |____| | \ \
 |_____/ \____/|_____/ \____/  |_|\_\_____|______|______|______|_|  \_\[@TH3_ACE](http://twitter.com/TH3_ACE) - BLAIS David
 Contribute and collaborate to the KILLER project @ [https://github.com/TH3xACE](https://github.com/TH3xACE)
 Please consider to give a +1 star on github to show your support![+] Intro 
Scan started at:
Fri 20 Nov 23:54:58 UTC 2020Current user: **ec2-user**================== Initial check - Quick overview =========================[+] Sudo version:
**Sudo version 1.8.29**[+] SUDO possible without a password!
Matching Defaults entries for ec2-user on ip-172-16-0-118:
    !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, env_keep="COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS", env_keep+="MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE", env_keep+="LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES", env_keep+="LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE", env_keep+="LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY", secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin**User ec2-user may run the following commands on ip-172-16-0-118:
    (ALL) NOPASSWD: ALL
    (ALL) NOPASSWD: ALL**[-] SELinux seems to be present: SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
Loaded policy name:             targeted
Current mode:                   enforcing
Mode from config file:          enforcing
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Memory protection checking:     actual (secure)
**Max kernel policy version:      32, can execute /exploits/CVE-2017-1000367-2.c if vulnerable (Check CVEs).**============== Checking for Common Misconfiguration ================[+] Sudo without password for other user, was found: 
    ALL  ALL
    ALL  ALL
[-] You can impersonate users, by running the cmd: **sudo -u [USER] /path/bin**
[-] Refer to section [Dangerous bins to escalate to other users] for the exact commands[+] Ptrace is set to zero:  
[-] All processes can be debugged, as long as they have same uid
**[-] It is possible to inject process that have valid sudo token and activate our own sudo token.
[*] Notes: refer to:** [**https://github.com/nongiach/sudo_inject**](https://github.com/nongiach/sudo_inject) **for more information
[*] Exploit: /exploits/sudo_injec**================== Checking for File owner hijacking ============================ Checking for File permission hijacking ============================== Checking for Missing scripts from sudo =============[+] The script/s found in sudoers can be found at: **/tmp/script_list**  
[+] Checking whether there are any missing scripts defined in sudoers but that no longer exists on system:=============== Checking for Excessive directory right =============[+] The script/s found in sudoers can be found at: **/tmp/script_list.txt** 
-------------------------------------------------------
============= Checking for Writable scripts within sudo  ============================ Checking for Credential Harvesting ===============**Current User: ec2-user
[+] Vulnerable to Creds Harvesting. 
[*] Exploit, refer to the exploit /exploits/credHarvest.sh**============ Checking for Dangerous environment variables ==========[+] Checking for dangerous environment variables such as PS4, PERL5OPT, PYTHONINSPECT,... .============== Checking for Dangerous binaries within sudo =========[-] dangerous bins ([**https://gtfobins.github.io/#+sudo**](https://gtfobins.github.io/#+sudo)): 
[+] Dangerous bins to escalate to root: 
[+] Dangerous bins to escalate to other users: 
Remember to run command as follow sudo -u [USER] /path/bin[*##################### SCAN_COMPLETED ##########################*]
```

正如你所看到的，这是一个非常有用的工具，不仅可以利用，还可以在你试图保护的基于 Linux 的系统上验证 sudo 的完整性。

我希望你觉得这篇文章有趣并且有用。如果您想随时了解情况，请不要忘记关注我，注册我的[电子邮件通知](https://whittle.medium.com/subscribe)。

# 迈克尔·惠特尔

*   ***如果你喜欢这个，请*** [***跟我上媒***](https://whittle.medium.com/)
*   ***更多有趣的文章，请*** [***关注我的刊物***](https://medium.com/trading-data-analysis)
*   ***有兴趣合作吗？*** [***我们上领英***](https://www.linkedin.com/in/miwhittle/) 连线吧
*   ***支持我和其他媒体作者*** [***在此报名***](https://whittle.medium.com/membership)
*   ***请别忘了为文章鼓掌:)←谢谢！***