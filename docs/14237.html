<html>
<head>
<title>Linux: System Calls and Strace</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Linux:系统调用和跟踪</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/linux-system-calls-and-strace-43898063e1f?source=collection_archive---------9-----------------------#2022-11-10">https://levelup.gitconnected.com/linux-system-calls-and-strace-43898063e1f?source=collection_archive---------9-----------------------#2022-11-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f149" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">系统调用和跟踪工具概述</h2></div><p id="df42" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当运行在Linux上的应用程序/进程想要使用由Linux内核管理的资源时，例如读取文件、创建进程等。应用程序进程对Linux内核进行系统调用，Linux内核执行必要的操作，然后将控制权交还给调用程序。strace 工具提供了在Linux上跟踪系统调用的能力。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/9856882011a5fb349025a9d2330e8391.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*k8HhsKfj8T76hp1V.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">出发地:<a class="ae lr" href="https://wizardzines.com/comics/syscalls/" rel="noopener ugc nofollow" target="_blank">https://wizardzines.com/comics/syscalls/</a></figcaption></figure><p id="1949" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了在Linux中创建一个文件，我们可以简单地用想要的文件名运行一个<code class="fe ls lt lu lv b"><strong class="kh ir">touch</strong></code> <strong class="kh ir"> </strong>命令。看起来很简单吧？但是在这个简单的任务之下，包含了如此多的系统调用。要找出所有系统调用，我们可以运行以下命令:</p><pre class="lc ld le lf gt lw lv lx ly aw lz bi"><span id="f783" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">$ strace touch test.txt</strong></span><span id="eff5" class="ma mb iq lv b gy mg md l me mf"><strong class="lv ir">-------------------------------------------------------------------</strong></span><span id="8535" class="ma mb iq lv b gy mg md l me mf"><strong class="lv ir">execve</strong>("/usr/bin/touch", ["touch", "test.txt"], 0x7fff42d6fe38 /* 18 vars */) = 0</span><span id="fcf6" class="ma mb iq lv b gy mg md l me mf">....</span></pre><p id="2717" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在执行了上面的命令之后，我们将会看到很多关于在创建一个简单文件的过程中所做的系统调用的信息。我们可以看到一个名为"<strong class="kh ir"> execve" </strong>的系统调用正在被调用，这个系统调用将执行一个驻留在"/usr/bin/touch "目录下的程序。</p><h2 id="ebb3" class="ma mb iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">查看正在运行的进程的实时系统调用</h2><p id="a2d2" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">为了跟踪正在运行的进程发出的系统调用，我们需要获取进程的PID。通过使用该特定进程的PID，我们可以查看该进程发出的实时系统调用。让我们获得"<strong class="kh ir"> kube-proxy </strong>"进程的PID:</p><pre class="lc ld le lf gt lw lv lx ly aw lz bi"><span id="4759" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">$ pidof kube-proxy</strong></span><span id="edc6" class="ma mb iq lv b gy mg md l me mf"><strong class="lv ir">----------------------------------------------------------------</strong></span><span id="bd45" class="ma mb iq lv b gy mg md l me mf">25166</span></pre><p id="eb41" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，使用PID，我们可以查看kube-proxy进程发出的未来系统调用:</p><pre class="lc ld le lf gt lw lv lx ly aw lz bi"><span id="57e7" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">$ strace -p 25166</strong></span><span id="768a" class="ma mb iq lv b gy mg md l me mf"><strong class="lv ir">-------------------------------------------------------------------</strong></span><span id="9a39" class="ma mb iq lv b gy mg md l me mf">strace: Process 25166 attached<br/>epoll_pwait(4, [], 128, 0, NULL, 140720404847384) = 0<br/>epoll_pwait(4, [], 128, 832, NULL, 140720404847448) = 0<br/>epoll_pwait(4, [], 128, 0, NULL, 140720404847384) = 0<br/>epoll_pwait(4, [], 128, 4999, NULL, 140720404847448) = 0<br/>epoll_pwait(4, [], 128, 0, NULL, 140720404847384) = 0<br/>epoll_pwait(4, [], 128, 4484, NULL, 140720404847448) = 0<br/><strong class="lv ir">getrandom</strong>("\x20\xa7\xb0\xd9\x16\x22\x76\x58", 8, 0) = 8<br/><strong class="lv ir">write</strong>(11, "\27\3\3\0\"Zl\25dan\2711i\361.K\215\343\207A&gt;\327\5_xZ\370P:H\17"..., 39) = 39<br/>.....</span></pre><h2 id="ab27" class="ma mb iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">系统调用摘要</h2><p id="32ad" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">要查看某个命令发出的系统调用次数的完整摘要，请使用以下命令:</p><pre class="lc ld le lf gt lw lv lx ly aw lz bi"><span id="ba8b" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">$ strace -c touch test<br/>-------------------------------------------------------------------</strong></span><span id="1d56" class="ma mb iq lv b gy mg md l me mf">% time     seconds  usecs/call     calls    errors <strong class="lv ir">syscall</strong><br/>------ ----------- ----------- --------- --------- ----------------<br/>  0.00    0.000000           0         1          <strong class="lv ir"> read</strong><br/>  0.00    0.000000           0         6          <strong class="lv ir"> close</strong><br/>  0.00    0.000000           0         2          <strong class="lv ir"> fstat</strong><br/>  0.00    0.000000           0         8          <strong class="lv ir"> mmap</strong><br/>  0.00    0.000000           0         3           <strong class="lv ir">mprotect</strong><br/>  0.00    0.000000           0         1           <strong class="lv ir">munmap</strong><br/>  0.00    0.000000           0         3          <strong class="lv ir"> brk</strong><br/>  0.00    0.000000           0         6          <strong class="lv ir"> pread64</strong><br/>  0.00    0.000000           0         1         1 <strong class="lv ir">access</strong><br/>  0.00    0.000000           0         1          <strong class="lv ir"> dup2</strong><br/>  0.00    0.000000           0         1          <strong class="lv ir"> execve</strong><br/>  0.00    0.000000           0         2         1 <strong class="lv ir">arch_prctl</strong><br/>  0.00    0.000000           0         3           <strong class="lv ir">openat</strong><br/>  0.00    0.000000           0         1           <strong class="lv ir">utimensat</strong><br/>------ ----------- ----------- --------- --------- ----------------<br/>100.00    0.000000                    39         2 total</span></pre><h2 id="3359" class="ma mb iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">检查某些系统调用</h2><p id="b9f4" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">要检查某些系统调用，请运行以下命令:</p><pre class="lc ld le lf gt lw lv lx ly aw lz bi"><span id="f3c7" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">$ strace  -e  trace=read touch test1.txt <br/>-------------------------------------------------------------------</strong></span><span id="0ffe" class="ma mb iq lv b gy mg md l me mf"><strong class="lv ir">read</strong>(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\300A\2\0\0\0\0\0"..., 832) = 832<br/>+++ exited with 0 +++</span><span id="1cc1" class="ma mb iq lv b gy mg md l me mf"><strong class="lv ir">********************************************************************</strong></span><span id="1130" class="ma mb iq lv b gy mg md l me mf"><strong class="lv ir">$ strace -c -e  trace=read,close touch test2.txt <br/>-------------------------------------------------------------------</strong></span><span id="4d87" class="ma mb iq lv b gy mg md l me mf">% time     seconds  usecs/call     calls    errors syscall<br/>------ ----------- ----------- --------- --------- ----------------<br/>  0.00    0.000000           0         1          <strong class="lv ir"> read</strong><br/>  0.00    0.000000           0         6         <strong class="lv ir">  close</strong><br/>------ ----------- ----------- --------- --------- ----------------<br/>100.00    0.000000                     7           total</span></pre></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><blockquote class="nk nl nm"><p id="4937" class="kf kg nn kh b ki kj jr kk kl km ju kn no kp kq kr np kt ku kv nq kx ky kz la ij bi translated"><em class="iq">如果你觉得这篇文章很有帮助，请</em> <strong class="kh ir"> <em class="iq">别忘了</em> </strong> <em class="iq">去点击</em> <strong class="kh ir"> <em class="iq">跟随</em> </strong>👉<strong class="kh ir"><em class="iq"/></strong><em class="iq"/><strong class="kh ir"><em class="iq">拍拍</em> </strong>👏<strong class="kh ir"> <em class="iq"> </em> </strong> <em class="iq">按钮帮助我写更多这样的文章。<br/>谢谢🖤 </em></p></blockquote></div></div>    
</body>
</html>