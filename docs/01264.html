<html>
<head>
<title>Why You Should Learn CIL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么你应该学习CIL</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/why-you-should-learn-cil-2435b2b8d8ae?source=collection_archive---------4-----------------------#2019-12-09">https://levelup.gitconnected.com/why-you-should-learn-cil-2435b2b8d8ae?source=collection_archive---------4-----------------------#2019-12-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="554f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><span class="l kf kg kh bm ki kj kk kl km di"> T </span>他常用的中间语言是你的语言。NET应用程序编译成。</h2></div><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi kn"><img src="../Images/970be10f9e858ba84251d40ecfced89c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*n3AR9yJaz6ZRZ7W22-Tw-g.png"/></div></figure><p id="13a0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您是. NET开发人员，您可能以前听说过它，但是知道学习它没有意义，因为它是一个“实现细节”。</p><p id="dcfe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这篇文章将提供一个例子，希望能让你相信缺乏CIL知识会导致bug。</p><h1 id="89e1" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">“已检查”关键字</h1><p id="0f51" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">如果artithmetic操作导致溢出，C#的<code class="fe mo mp mq mr b">checked</code>抛出一个<code class="fe mo mp mq mr b">OverflowException</code>。</p><h2 id="2a92" class="ms ls iq bd lt mt mu dn lx mv mw dp mb le mx my md li mz na mf lm nb nc mh nd bi translated">示例1</h2><p id="f116" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">在这个例子中，发生了溢出，您将得到一个<code class="fe mo mp mq mr b">OverflowException</code>，因为已经达到最大可能值的<code class="fe mo mp mq mr b">byte</code>加了1。</p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h1 id="0300" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">虫子</h1><p id="0612" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">现在你知道<code class="fe mo mp mq mr b">checked </code>做什么了，看看例子2。</p><h2 id="7ce0" class="ms ls iq bd lt mt mu dn lx mv mw dp mb le mx my md li mz na mf lm nb nc mh nd bi translated">示例2:</h2><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="e082" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">乍一看，这似乎应该做与示例1完全相同的事情，但事实并非如此。</p><p id="a07b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">不</strong> <code class="fe mo mp mq mr b"><strong class="kx ir">OverflowException</strong></code> <strong class="kx ir">当你试图给</strong> <code class="fe mo mp mq mr b"><strong class="kx ir">byte</strong></code> <strong class="kx ir">加1时抛出！</strong></p><h1 id="81f1" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">有什么不同？</h1><p id="9bbf" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">为了理解这里发生了什么，我们需要看一下为例1生成的去掉了<code class="fe mo mp mq mr b">checked </code>关键字的CIL。</p><h2 id="211e" class="ms ls iq bd lt mt mu dn lx mv mw dp mb le mx my md li mz na mf lm nb nc mh nd bi translated">示例1 CIL，已取消选中:</h2><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="4a74" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">不用太在意这些台词都是什么意思，看看<code class="fe mo mp mq mr b">IL_0009: <strong class="kx ir">add</strong></code>就知道了。</p><p id="2501" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">所有这些，就是把两个数字相加，255和1。</p><h2 id="951b" class="ms ls iq bd lt mt mu dn lx mv mw dp mb le mx my md li mz na mf lm nb nc mh nd bi translated">示例1 CIL，已检查:</h2><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="6655" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这几乎与移除<code class="fe mo mp mq mr b">checked </code>时生成的代码完全相同。唯一的区别是多了几条<code class="fe mo mp mq mr b">nop </code>指令，以及<code class="fe mo mp mq mr b">add</code>之后的<code class="fe mo mp mq mr b">.ovf</code>:</p><p id="ba45" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe mo mp mq mr b">IL_000a: add.ovf</code></p><p id="70ed" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这和普通的<code class="fe mo mp mq mr b">add</code>做的完全一样，但是如果有溢出，它也会抛出<code class="fe mo mp mq mr b">OverflowException</code>。</p><h1 id="f276" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">结论</h1><p id="2fc7" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated"><code class="fe mo mp mq mr b"><strong class="kx ir">checked </strong></code> <strong class="kx ir">只对直接在</strong> <code class="fe mo mp mq mr b"><strong class="kx ir">checked </strong></code> <strong class="kx ir">块内的表达式有效。</strong></p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><h1 id="3a87" class="lr ls iq bd lt lu nn lw lx ly no ma mb jw np jx md jz nq ka mf kc nr kd mh mi bi translated">十进制呢？</h1><p id="adc3" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">在这个例子中，我们使用了<code class="fe mo mp mq mr b">unchecked</code>，这保证了<code class="fe mo mp mq mr b">OverflowException </code>不会被抛出。</p><p id="5b7e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">发生这种情况时，数字会绕回最小值。</p><p id="ce49" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">(您可以更改<code class="fe mo mp mq mr b"><a class="ae ns" href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/compiler-options/checked-compiler-option" rel="noopener ugc nofollow" target="_blank">-checked</a></code>编译器选项来设置默认值是<code class="fe mo mp mq mr b">checked </code>还是<code class="fe mo mp mq mr b">unchecked</code>)。</p><h2 id="4ef3" class="ms ls iq bd lt mt mu dn lx mv mw dp mb le mx my md li mz na mf lm nb nc mh nd bi translated">示例3:</h2><p id="1ce1" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">这到底会不会扔个<code class="fe mo mp mq mr b">OverflowException</code>？</p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="5dfe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">乍一看，它看起来不会扔一个<code class="fe mo mp mq mr b">OverflowException</code>。</p><p id="6286" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">而如果是用<code class="fe mo mp mq mr b">int</code>或者<code class="fe mo mp mq mr b">byte</code>而不是<code class="fe mo mp mq mr b">decimal</code>，确实不会抛出一个<code class="fe mo mp mq mr b">OverflowException</code>。</p><p id="1b18" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">但是，它确实抛出了一个</strong>T9】</p><h2 id="cb3a" class="ms ls iq bd lt mt mu dn lx mv mw dp mb le mx my md li mz na mf lm nb nc mh nd bi translated">为什么？</h2><p id="8aa7" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">这是生成的CIL。</p><p id="a34e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意这里没有像<code class="fe mo mp mq mr b">byte</code>那样的<code class="fe mo mp mq mr b">add</code>或<code class="fe mo mp mq mr b">add.ovf</code>指令。</p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="4133" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">代替CIL内置的<code class="fe mo mp mq mr b">add</code>或<code class="fe mo mp mq mr b">add.ovf</code>指令，它使用一种叫做<code class="fe mo mp mq mr b">op_Addition</code>的方法(第12行)。</p><p id="fcd8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">尽管在C#中<code class="fe mo mp mq mr b">decimal </code>是一个基本类型，但是CLR不认为它是一个基本类型，因此没有CIL指令来操作它。</p><p id="3392" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">相反，<code class="fe mo mp mq mr b">decimal </code>类型有自己的加法、减法等方法。这意味着我们前面看到的<code class="fe mo mp mq mr b">add </code> CIL指令，不用于<code class="fe mo mp mq mr b">decimal</code>。</p><p id="ebbb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，<code class="fe mo mp mq mr b">checked </code>和<code class="fe mo mp mq mr b">unchecked </code>对<code class="fe mo mp mq mr b">decimal</code>类型没有影响。</p><h1 id="e7b0" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">摘要</h1><p id="dd2b" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">对CIL有一个基本的了解，或者至少有足够的兴趣看看CIL从你的C#代码中得到什么，可以提供对事情如何工作的难以置信的洞察力。</p><p id="7d87" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这些低层次的细节不仅令人满意地学习/理解，而且可以帮助您编写更好的、无错误的代码。</p></div></div>    
</body>
</html>