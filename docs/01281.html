<html>
<head>
<title>How to Resolve Certificate Errors in a NodeJS App with SSL Calls</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何通过SSL调用解决NodeJS应用程序中的证书错误</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-resolve-certificate-errors-in-nodejs-app-involving-ssl-calls-781ce48daded?source=collection_archive---------0-----------------------#2019-12-11">https://levelup.gitconnected.com/how-to-resolve-certificate-errors-in-nodejs-app-involving-ssl-calls-781ce48daded?source=collection_archive---------0-----------------------#2019-12-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5a02" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">解决SSL证书错误的实用指南</h2></div><p id="7c3a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在非生产环境中，使用HTTPS和服务器证书设置NodeJS应用程序相对简单。在生产环境中，如果您的Node/Express应用程序位于反向代理(如Nginx)之后，它不需要调用其他外部服务，则不需要HTTPS和服务器证书。</p><p id="6799" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然而，在现实中，您的节点应用程序将需要调用HTTPS保护的各种后端服务。默认情况下，NodeJs是用<a class="ae le" href="https://github.com/nodejs/node-v0.x-archive/blob/master/src/node_root_certs.h" rel="noopener ugc nofollow" target="_blank">一组常用的CA根证书</a>构建的。即使有了这些证书，如果您的后端服务使用自签名证书(即特定于公司的私有CA)托管，我们仍然可能会遇到与HTTPS相关的错误。</p><p id="caba" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些错误包括:</p><blockquote class="lf lg lh"><p id="c8c3" class="ki kj li kk b kl km ju kn ko kp jx kq lj ks kt ku lk kw kx ky ll la lb lc ld im bi translated"><code class="fe lm ln lo lp b"><em class="it">UNABLE_TO_GET_ISSUER_CERT_LOCALLY</em></code></p><p id="c3c5" class="ki kj li kk b kl km ju kn ko kp jx kq lj ks kt ku lk kw kx ky ll la lb lc ld im bi translated"><code class="fe lm ln lo lp b"><em class="it">UNABLE_TO_VERIFY_LEAF_SIGNATURE</em></code></p><p id="5b51" class="ki kj li kk b kl km ju kn ko kp jx kq lj ks kt ku lk kw kx ky ll la lb lc ld im bi translated"><code class="fe lm ln lo lp b"><em class="it">DEPTH_ZERO_SELF_SIGNED_CERT</em></code></p></blockquote><p id="9546" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要了解这些错误，然后才能解决它们。</p><p id="3c65" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们深入研究这些错误。</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h2 id="4f35" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">SSL握手</h2><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/1abb22eaa2906b7bd7903eff8ef3db3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*JJq75jP6uG4tXoJBdj1zCQ.png"/></div></figure><p id="c20f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些错误源于SSL握手过程。当客户端开始与服务器建立连接时，会发生TLS握手。它是客户端和服务器之间交换的一系列消息。在这些消息中，他们同意使用TLS和密码套件的版本，验证服务器的身份，并生成会话密钥。</p><p id="5137" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上图的步骤2中，服务器发送包含服务器SSL证书的消息。然后，客户端向颁发证书的CA(证书颁发机构)验证证书。这一步确认了服务器就是它所声称的那个人，并且客户端正在与域的实际所有者进行交互。</p><p id="0c9b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">抛出上述SSL错误是因为客户端无法验证在步骤2中发送的自签名服务器证书的信任链。</p><blockquote class="lf lg lh"><p id="ee45" class="ki kj li kk b kl km ju kn ko kp jx kq lj ks kt ku lk kw kx ky ll la lb lc ld im bi translated">TLS握手是一个复杂的过程，你可以阅读下面的文章了解更多的细节。</p></blockquote><div class="my mz gp gr na nb"><a rel="noopener  ugc nofollow" target="_blank" href="/deep-dive-into-tls-handshake-e029e28e2eb3"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd iu gy z fp ng fr fs nh fu fw is bi translated">深入了解TLS握手</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">逐步解释TLS 1.2握手过程</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np mw nb"/></div></div></a></div></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h2 id="dc75" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">快速而肮脏的解决方法:拒绝未授权</h2><p id="0b23" class="pw-post-body-paragraph ki kj it kk b kl nq ju kn ko nr jx kq kr ns kt ku kv nt kx ky kz nu lb lc ld im bi translated">解决这些错误最简单的方法是使用下面的“<code class="fe lm ln lo lp b">rejectUnauthorized</code>”选项。</p><pre class="mr ms mt mu gt nv lp nw nx aw ny bi"><span id="754d" class="lx ly it lp b gy nz oa l ob oc">https.request<!-- -->({ <br/>      ....,<br/>      rejectUnauthorized: false,<br/>    },<br/>...)</span></pre><p id="4877" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者将其设置为环境变量</p><pre class="mr ms mt mu gt nv lp nw nx aw ny bi"><span id="201d" class="lx ly it lp b gy nz oa l ob oc">NODE_TLS_REJECT_UNAUTHORIZED=0</span></pre><p id="86be" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然而，这种方法是不安全的，因为它禁用了服务器证书验证，使节点应用程序对<a class="ae le" href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack" rel="noopener ugc nofollow" target="_blank"> MITM </a>攻击开放。因此，强烈建议只在开发环境中禁用证书验证，而不要在生产环境中应用这种方法。</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h2 id="9948" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">使用CA选项</h2><p id="885c" class="pw-post-body-paragraph ki kj it kk b kl nq ju kn ko nr jx kq kr ns kt ku kv nt kx ky kz nu lb lc ld im bi translated">更安全的方法是指定期望从服务器获得的CA证书。换句话说，证书的通用名称需要与服务器证书相匹配。</p><pre class="mr ms mt mu gt nv lp nw nx aw ny bi"><span id="d475" class="lx ly it lp b gy nz oa l ob oc">request({ <br/>   ca: [fs.readFileSync([certificate path])],<br/>   rejectUnauthorized: true,<br/>}</span></pre><p id="35c8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如您所见，<code class="fe lm ln lo lp b">ca</code>选项是一个数组，因此如果需要，您可以设置多个证书文件。在代码中硬编码证书文件会使根据需要更新或轮换证书变得困难。为了避免这些问题，可以考虑使用配置管理工具来处理证书的安装和更新。</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h2 id="fbb0" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">节点额外证书</h2><p id="b7e1" class="pw-post-body-paragraph ki kj it kk b kl nq ju kn ko nr jx kq kr ns kt ku kv nt kx ky kz nu lb lc ld im bi translated">从节点版本7.3.0开始，引入了<code class="fe lm ln lo lp b">NODE_EXTRA_CA_CERTS</code>环境变量来指定所需的任何附加证书颁发机构(CA)证书的位置。这允许使用文件中的额外证书来扩展“根”ca。该文件应包含一个或多个<strong class="kk iu"> PEM </strong>格式的可信证书。</p><p id="d2ad" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要使用<code class="fe lm ln lo lp b">NODE_EXTRA_CA_CERTS</code>环境变量，可以在启动Node.js应用程序时指定证书文件的路径。例如，您可以使用以下命令:</p><pre class="mr ms mt mu gt nv lp od bn oe of bi"><span id="8633" class="og ly it lp b be oh oi l oj oc">NODE_EXTRA_CA_CERTS=path/to/ca/certificates.pem node app.js</span></pre><p id="707c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该命令设置<code class="fe lm ln lo lp b">NODE_EXTRA_CA_CERTS</code>变量，然后启动<code class="fe lm ln lo lp b">app.js</code> Node.js应用程序。Node.js应用程序将在进行SSL调用时使用CA证书，这将有助于解决证书错误。</p><p id="8666" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，如果为HTTPS客户端或服务器显式指定了<code class="fe lm ln lo lp b">ca</code>选项属性，额外的证书将不会生效。</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h2 id="1983" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">如何排除故障？</h2><p id="1ce8" class="pw-post-body-paragraph ki kj it kk b kl nq ju kn ko nr jx kq kr ns kt ku kv nt kx ky kz nu lb lc ld im bi translated">如果您使用了<code class="fe lm ln lo lp b">ca</code>选项或<code class="fe lm ln lo lp b">NODE_EXTRA_CA_CERTS</code>，但仍然收到相同的错误。这通常是由于使用了不正确的证书。</p><p id="992b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，让我们检查证书链，以确保所有必要的中间证书都包含在证书链中。证书链应该包括服务器证书、中间CA证书和根CA证书。</p><p id="2211" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了让<code class="fe lm ln lo lp b">ca</code>选项或额外的证书起作用，我们需要获得完整的CA链或至少是根CA证书。</p><p id="e661" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以使用<a class="ae le" href="https://www.openssl.org/" rel="noopener ugc nofollow" target="_blank"> OpenSSL </a>来检索完整的CA链，如下所示:</p><pre class="mr ms mt mu gt nv lp nw nx aw ny bi"><span id="1210" class="lx ly it lp b gy nz oa l ob oc">openssl s_client -connect ${REMHOST}:${REMPORT}</span></pre><p id="4448" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">证书链的示例如下所示。</p><figure class="mr ms mt mu gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="ol om di on bf oo"><div class="gh gi ok"><img src="../Images/fa216cd2bef6f86c59db5f83eab6a35e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7mINu9NCxlhQPfNqCYjVIw.png"/></div></div><figcaption class="op oq gj gh gi or os bd b be z dk translated">Google CA证书链</figcaption></figure><blockquote class="lf lg lh"><p id="c638" class="ki kj li kk b kl km ju kn ko kp jx kq lj ks kt ku lk kw kx ky ll la lb lc ld im bi translated">请注意，<em class="it"> showcerts </em>命令可能无法工作，如果该命令在代理后面执行或者远程服务器使用<a class="ae le" href="https://en.wikipedia.org/wiki/Server_Name_Indication" rel="noopener ugc nofollow" target="_blank"> SNI </a>。</p></blockquote><p id="e72e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果错误仍然存在，请检查以下其他内容</p><ul class=""><li id="8a2f" class="ot ou it kk b kl km ko kp kr ov kv ow kz ox ld oy oz pa pb bi translated">检查证书路径以确保证书路径正确且可被应用程序读取。</li><li id="24b7" class="ot ou it kk b kl pc ko pd kr pe kv pf kz pg ld oy oz pa pb bi translated">验证证书的格式是否正确(通常是PEM或DER)。您可以使用<code class="fe lm ln lo lp b">openssl </code>命令将证书转换成所需的格式。</li></ul></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h2 id="4039" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">摘要</h2><p id="6c4a" class="pw-post-body-paragraph ki kj it kk b kl nq ju kn ko nr jx kq kr ns kt ku kv nt kx ky kz nu lb lc ld im bi translated">在本文中，我们将详细讨论如何解决NodeJs应用程序中的证书错误。如果你在尝试了所有方法后仍然无法修复错误，那么StackOverflow就是你最好的朋友:)。</p><p id="88f5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您还不是付费媒体会员，<a class="ae le" href="https://sunnysun-5694.medium.com/membership" rel="noopener"> <strong class="kk iu">您可以通过访问此链接</strong> </a>进行注册。你可以无限制地阅读媒体上的所有报道。我会收你一部分会员费作为介绍费。</p><p id="60e9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢阅读，祝编程愉快！</p></div></div>    
</body>
</html>