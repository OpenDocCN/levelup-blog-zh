<html>
<head>
<title>Enforce Audit Policy in Kubernetes (k8s)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes (k8s)中实施审计策略</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/enforce-audit-policy-in-kubernetes-k8s-34e504733300?source=collection_archive---------3-----------------------#2021-05-22">https://levelup.gitconnected.com/enforce-audit-policy-in-kubernetes-k8s-34e504733300?source=collection_archive---------3-----------------------#2021-05-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="ae4a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ko translated"><span class="l kp kq kr bm ks kt ku kv kw di">您是否希望检查Kubernetes生产级环境的以下活动:</span></p><ol class=""><li id="4846" class="kx ky it js b jt ju jx jy kb kz kf la kj lb kn lc ld le lf bi translated">谁登录了您的Kubernetes集群？</li><li id="3739" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn lc ld le lf bi translated">哪个服务帐户或用户访问了群集中的哪些资源？</li><li id="bec2" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn lc ld le lf bi translated">谁创造了秘密或配置图？</li><li id="5496" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn lc ld le lf bi translated">谁读了ETCD的秘密，还有更多？</li></ol><p id="4469" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那么Kubernetes中的<strong class="js iu"> <em class="ll">执行审计策略</em> </strong>对你来说就是正确的选择。</p><h1 id="bcc7" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated"><strong class="ak">典型的Kubernetes环境</strong></h1><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/79ab6ce9e803b8eb713f75936b626748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*NQ2UwX3rlMlFyrOkcY_Oqw.jpeg"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">没有审计政策的Kubernetes</figcaption></figure><p id="006d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦启用，审计记录就在<a class="ae mw" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">kube-API server</strong></a>组件中开始其生命周期。每个请求在其执行的每个阶段都会生成一个审计事件，然后根据特定的策略对其进行预处理，并将其写入后端。策略决定记录什么，后端保存记录。当前的后端实现包括日志文件和webhooks。</p><p id="3e1b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">每个请求都可以记录一个相关的<em class="ll">阶段</em>。定义的<strong class="js iu">阶段</strong>为:</p><ul class=""><li id="70f9" class="kx ky it js b jt ju jx jy kb kz kf la kj lb kn mx ld le lf bi translated"><code class="fe my mz na nb b"><strong class="js iu">RequestReceived</strong></code> -审计处理程序一收到请求就生成的事件的阶段，在它被委托到处理程序链之前。</li><li id="48d1" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn mx ld le lf bi translated"><code class="fe my mz na nb b"><strong class="js iu">ResponseStarted</strong></code> -一旦发送了响应报头，但在发送响应正文之前。这个阶段只为长时间运行的请求(例如watch)生成。</li><li id="2c96" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn mx ld le lf bi translated"><code class="fe my mz na nb b"><strong class="js iu">ResponseComplete</strong></code> -响应正文已完成，不再发送字节。</li><li id="ce1c" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn mx ld le lf bi translated"><code class="fe my mz na nb b"><strong class="js iu">Panic</strong></code> -发生恐慌时生成的事件。</li></ul><h1 id="361e" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">审计策略规则和级别</h1><p id="37bf" class="pw-post-body-paragraph jq jr it js b jt nc jv jw jx nd jz ka kb ne kd ke kf nf kh ki kj ng kl km kn im bi translated">审计策略定义了关于应该记录哪些事件以及应该包括哪些数据的规则。审计策略对象结构在<code class="fe my mz na nb b"><a class="ae mw" href="https://kubernetes.io/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy" rel="noopener ugc nofollow" target="_blank">audit.k8s.io</a></code> <a class="ae mw" href="https://kubernetes.io/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy" rel="noopener ugc nofollow" target="_blank"> API组</a>中定义。当一个事件被处理时，它会按顺序与规则列表进行比较。第一个匹配规则设置事件的<em class="ll">审计级别</em>。定义的审计级别有:</p><ul class=""><li id="3997" class="kx ky it js b jt ju jx jy kb kz kf la kj lb kn mx ld le lf bi translated"><code class="fe my mz na nb b"><strong class="js iu">None</strong></code> -不记录符合此规则的事件。</li><li id="796a" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn mx ld le lf bi translated"><code class="fe my mz na nb b"><strong class="js iu">Metadata</strong></code> -日志请求元数据(请求用户、时间戳、资源、动词等。)但不是请求或响应体。</li><li id="941c" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn mx ld le lf bi translated"><code class="fe my mz na nb b"><strong class="js iu">Request</strong></code> -记录事件元数据和请求正文，但没有响应正文。这并不适用于非资源请求。</li><li id="d7e6" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn mx ld le lf bi translated"><code class="fe my mz na nb b"><strong class="js iu">RequestResponse</strong></code> -记录事件元数据、请求和响应正文。这并不适用于非资源请求。</li></ul><p id="b7fe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是一个典型的审计策略文件，至少可以看到:</p><pre class="ml mm mn mo gt nh nb ni nj aw nk bi"><span id="a02b" class="nl ln it nb b gy nm nn l no np"><em class="ll"># Log all requests at the Metadata level.</em><br/><strong class="nb iu">apiVersion</strong>: audit.k8s.io/v1<br/><strong class="nb iu">kind</strong>: Policy<br/><strong class="nb iu">rules</strong>:<br/>- <strong class="nb iu">level</strong>: Metadata</span></pre><p id="2e8e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以让它变得像下面这样复杂:)</p><pre class="ml mm mn mo gt nh nb ni nj aw nk bi"><span id="b064" class="nl ln it nb b gy nm nn l no np"><strong class="nb iu">apiVersion</strong>: audit.k8s.io/v1<br/><strong class="nb iu">kind</strong>: Policy<br/><strong class="nb iu">omitStages</strong>:<br/>  - "RequestReceived"<br/><strong class="nb iu">rules</strong>:<br/>  - <strong class="nb iu">level</strong>: RequestResponse<br/>    <strong class="nb iu">resources</strong>:<br/>    - <strong class="nb iu">group</strong>: ""<br/>      <strong class="nb iu">resources</strong>: ["pods"]<br/>  - <strong class="nb iu">level</strong>: Metadata<br/>    <strong class="nb iu">resources</strong>:<br/>    - <strong class="nb iu">group</strong>: ""<br/>      <strong class="nb iu">resources</strong>: ["pods/log", "pods/status"]<br/><br/>  - <strong class="nb iu">level</strong>: None<br/>    <strong class="nb iu">resources</strong>:<br/>    - <strong class="nb iu">group</strong>: ""<br/>      <strong class="nb iu">resources</strong>: ["configmaps"]<br/>      <strong class="nb iu">resourceNames</strong>: ["controller-leader"]<br/><br/>  - <strong class="nb iu">level</strong>: None<br/>    <strong class="nb iu">users</strong>: ["system:kube-proxy"]<br/>    <strong class="nb iu">verbs</strong>: ["watch"]<br/>    <strong class="nb iu">resources</strong>:<br/>    - <strong class="nb iu">group</strong>: "" <em class="ll"># core API group</em><br/>      <strong class="nb iu">resources</strong>: ["endpoints", "services"]<br/><br/>  - <strong class="nb iu">level</strong>: None<br/>    <strong class="nb iu">userGroups</strong>: ["system:authenticated"]<br/>    <strong class="nb iu">nonResourceURLs</strong>:<br/>    - "/api*" <em class="ll"># Wildcard matching.</em><br/>    - "/version"<br/><br/>  - <strong class="nb iu">level</strong>: Request<br/>    <strong class="nb iu">resources</strong>:<br/>    - <strong class="nb iu">group</strong>: "" <em class="ll"># core API group</em><br/>      <strong class="nb iu">resources</strong>: ["configmaps"]<br/>    <strong class="nb iu">namespaces</strong>: ["kube-system"]<br/><br/>  - <strong class="nb iu">level</strong>: Metadata<br/>    <strong class="nb iu">resources</strong>:<br/>    - <strong class="nb iu">group</strong>: "" <em class="ll"># core API group</em><br/>      <strong class="nb iu">resources</strong>: ["secrets", "configmaps"]<br/><br/>  - <strong class="nb iu">level</strong>: Request<br/>    <strong class="nb iu">resources</strong>:<br/>    - <strong class="nb iu">group</strong>: "" <em class="ll"># core API group</em><br/>    - <strong class="nb iu">group</strong>: "extensions" <em class="ll"># Version of group should NOT be included.</em><br/><br/>  - <strong class="nb iu">level</strong>: Metadata<br/>    <strong class="nb iu">omitStages</strong>:<br/>      - "RequestReceived"</span></pre><h1 id="0ea5" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">体系结构—库本内特斯的审计策略</h1><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi nq"><img src="../Images/db6e868116d39ea063bb8e77132fc5ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i-0e9v7HrdHidgtRikD81w.jpeg"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">Kubernetes —启用了审核策略</figcaption></figure><p id="6e2a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以使用Webhooks将审计日志发送到文件或远程web APIs。</p><p id="7357" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我们将强制执行<strong class="js iu"> kube api-server </strong>将审计日志发送到文件中。</p><h2 id="c32c" class="nl ln it bd lo nv nw dn ls nx ny dp lw kb nz oa ma kf ob oc me kj od oe mi of bi translated"><strong class="ak">在Kubernetes中启用审核策略(对于审核日志文件):</strong></h2><ol class=""><li id="7312" class="kx ky it js b jt nc jx nd kb og kf oh kj oi kn lc ld le lf bi translated"><strong class="js iu">创建审计政策YAML文件</strong> —前往您的Kubernetes集群，按照以下规则创建<strong class="js iu">审计政策。</strong></li></ol><pre class="ml mm mn mo gt nh nb ni nj aw nk bi"><span id="2bd1" class="nl ln it nb b gy nm nn l no np"><strong class="nb iu">apiVersion</strong>: audit.k8s.io/v1<br/><strong class="nb iu">kind</strong>: Policy<br/><strong class="nb iu">rules</strong>: <br/>  <em class="ll"># Log the request body of configmap changes in kube-system.</em><br/>  - <strong class="nb iu">level</strong>: Request<br/>    <strong class="nb iu">resources</strong>:<br/>    - <strong class="nb iu">group</strong>: "" <em class="ll"># core API group</em><br/>      <strong class="nb iu">resources</strong>: ["configmaps"]<br/>    <strong class="nb iu">namespaces</strong>: ["kube-system"]<br/><br/>  <em class="ll"># Log configmap and secret changes in all other namespaces at the Metadata level.</em><br/>  - <strong class="nb iu">level</strong>: Metadata<br/>    <strong class="nb iu">resources</strong>:<br/>    - <strong class="nb iu">group</strong>: "" <em class="ll"># core API group</em><br/>      <strong class="nb iu">resources</strong>: ["secrets", "configmaps"]<br/><br/>  <em class="ll"># A catch-all rule to log all other requests at the Metadata level.</em><br/>  - <strong class="nb iu">level</strong>: Metadata<br/>    <strong class="nb iu">omitStages</strong>:<br/>      - "RequestReceived"</span></pre><p id="5c2d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.<strong class="js iu">更新kube API-服务器清单文件</strong> —</p><pre class="ml mm mn mo gt nh nb ni nj aw nk bi"><span id="a018" class="nl ln it nb b gy nm nn l no np">- kube-apiserver<br/>    - --advertise-address=10.156.0.6<br/>    - --audit-policy-file=/etc/kubernetes/audit-policy.yaml<br/>    - --audit-log-path=/var/log/audit.log</span><span id="686d" class="nl ln it nb b gy oj nn l no np"> ---<br/> ---</span><span id="0c4c" class="nl ln it nb b gy oj nn l no np"> - mountPath: /etc/kubernetes/audit-policy.yaml<br/>   name: audit<br/>   readOnly: true<br/> — mountPath: /var/log/audit.log<br/>   name: audit-log<br/>   readOnly: false</span><span id="80d9" class="nl ln it nb b gy oj nn l no np">---<br/>---</span><span id="dd4b" class="nl ln it nb b gy oj nn l no np">volumes:<br/>  - name: audit<br/>    hostPath:<br/>     path: /etc/kubernetes/audit-policy.yaml<br/>     type: File<br/>  - name: audit-log<br/>    hostPath:<br/>      path: /var/log/audit.log<br/>      type: FileOrCreate</span></pre><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi ok"><img src="../Images/761056c0110bfac3ec29738a7f193e26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wcnNv7BLS69URIJvMxXyGg.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">k8s-API-服务器-清单文件</figcaption></figure><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi ol"><img src="../Images/a49e03ebb827689b777d8902ca6423a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4mEBuAu7wWQFWj255LTAPw.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">k8s-API-服务器-清单文件</figcaption></figure><p id="efb5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">仅此而已，前往生成的审核日志文件。</p><p id="70db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我的例子中，这是<strong class="js iu"> <em class="ll"> audit.log </em> </strong>，试着读一下，你会看到关于你的Kubernetes集群的审计日志信息在它的各个阶段被捕获，如下例所示:</p><pre class="ml mm mn mo gt nh nb ni nj aw nk bi"><span id="701a" class="nl ln it nb b gy nm nn l no np">{<br/> “kind”:”Event”,<br/> “apiVersion”:”audit.k8s.io/v1",<br/> “level”:”Metadata”,<br/> “auditID”:”a42fa658-f143–43d8-b5e6–4e101d3e15ea”,<br/> “stage”:”ResponseComplete”,<br/> “requestURI”:”/api/v1/namespaces/default/secrets?fieldManager=kubectl-create”,<br/> “verb”:”create”,<br/> “user”:{<br/> “username”:”kubernetes-admin”,<br/> “groups”:[<br/> “system:masters”,<br/> “system:authenticated”<br/> ]<br/> },<br/> “sourceIPs”:[<br/> “10.156.0.2”<br/> ],<br/> “userAgent”:”kubectl/v1.20.2 (linux/amd64) kubernetes/faecb19",<br/> “objectRef”:{<br/> “resource”:”secrets”,<br/> “namespace”:”default”,<br/> “name”:”test-secret”,<br/> “apiVersion”:”v1"<br/> },<br/> “responseStatus”:{<br/> “metadata”:{<br/> <br/> },<br/> “code”:201<br/> },<br/> “requestReceivedTimestamp”:”2021–04–03T13:50:37.009656Z”,<br/> “stageTimestamp”:”2021–04–03T13:50:38.040874Z”,<br/> “annotations”:{<br/> “authorization.k8s.io/decision”:”allow”,<br/> “authorization.k8s.io/reason”:””<br/> }<br/>}</span><span id="7da1" class="nl ln it nb b gy oj nn l no np"><br/>{<br/> “kind”:”Event”,<br/> “apiVersion”:”audit.k8s.io/v1",<br/> “level”:”Metadata”,<br/> “auditID”:”f1466b01–9b68–45ec-b3bb-b440397f6481",<br/> “stage”:”ResponseComplete”,<br/> “requestURI”:”/api/v1/namespaces/default/secrets/test-secret”,<br/> “verb”:”get”,<br/> “user”:{<br/> “username”:”kubernetes-admin”,<br/> “groups”:[<br/> “system:masters”,<br/> “system:authenticated”<br/> ]<br/> },<br/> “sourceIPs”:[<br/> “10.156.0.2”<br/> ],<br/> “userAgent”:”kubectl/v1.20.2 (linux/amd64) kubernetes/faecb19",<br/> “objectRef”:{<br/> “resource”:”secrets”,<br/> “namespace”:”default”,<br/> “name”:”test-secret”,<br/> “apiVersion”:”v1"<br/> },<br/> “responseStatus”:{<br/> “metadata”:{<br/> <br/> },<br/> “code”:200<br/> },<br/> “requestReceivedTimestamp”:”2021–04–03T13:51:08.603724Z”,<br/> “stageTimestamp”:”2021–04–03T13:51:08.607716Z”,<br/> “annotations”:{<br/> “authorization.k8s.io/decision”:”allow”,<br/> “authorization.k8s.io/reason”:””<br/> }<br/>}</span><span id="82f6" class="nl ln it nb b gy oj nn l no np"><br/>{<br/> “kind”:”Event”,<br/> “apiVersion”:”audit.k8s.io/v1",<br/> “level”:”Metadata”,<br/> “auditID”:”30be8c70-fda6–44de-8a83–3fe56161d44e”,<br/> “stage”:”ResponseComplete”,<br/> “requestURI”:”/api/v1/namespaces/default/secrets/test-secret”,<br/> “verb”:”get”,<br/> “user”:{<br/> “username”:”kubernetes-admin”,<br/> “groups”:[<br/> “system:masters”,<br/> “system:authenticated”<br/> ]<br/> },<br/> “sourceIPs”:[<br/> “10.156.0.2”<br/> ],<br/> “userAgent”:”kubectl/v1.20.2 (linux/amd64) kubernetes/faecb19",<br/> “objectRef”:{<br/> “resource”:”secrets”,<br/> “namespace”:”default”,<br/> “name”:”test-secret”,<br/> “apiVersion”:”v1"<br/> },<br/> “responseStatus”:{<br/> “metadata”:{<br/> <br/> },<br/> “code”:200<br/> },<br/> “requestReceivedTimestamp”:”2021–04–03T13:54:57.867317Z”,<br/> “stageTimestamp”:”2021–04–03T13:54:57.871369Z”,<br/> “annotations”:{<br/> “authorization.k8s.io/decision”:”allow”,<br/> “authorization.k8s.io/reason”:””<br/> }<br/>}</span></pre><p id="304c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，您可以使用以下附加标志配置<strong class="js iu"> kube api-server </strong>，以更改审核日志文件的状态:</p><ul class=""><li id="1323" class="kx ky it js b jt ju jx jy kb kz kf la kj lb kn mx ld le lf bi translated"><code class="fe my mz na nb b">--audit-log-maxage</code>定义保留旧审核日志文件的最大天数</li><li id="2120" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn mx ld le lf bi translated"><code class="fe my mz na nb b">--audit-log-maxbackup</code>定义要保留的最大审计日志文件数</li><li id="0783" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn mx ld le lf bi translated"><code class="fe my mz na nb b">--audit-log-maxsize</code>定义审核日志文件旋转前的最大大小，单位为兆字节</li></ul><h1 id="ffc9" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">总结:</h1><p id="4b15" class="pw-post-body-paragraph jq jr it js b jt nc jv jw jx nd jz ka kb ne kd ke kf nf kh ki kj ng kl km kn im bi translated">审核策略会检查您的Kubernetes群集中发生的所有请求/响应。这是一种最佳做法，应在早期阶段启用。在这个例子中，我已经向您展示了如何将审计数据发送到文件，在下一个博客中，我将展示如何将审计数据发布到Webhook API。</p><p id="5f9e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你喜欢这篇文章。</p><p id="3d09" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请在下面自由发表您的评论。</p></div></div>    
</body>
</html>