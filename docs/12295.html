<html>
<head>
<title>A declarative approach towards automating multi-stage delivery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动化多阶段交付的声明性方法</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-declarative-approach-towards-automating-multi-stage-delivery-aa2470875ec4?source=collection_archive---------19-----------------------#2022-05-29">https://levelup.gitconnected.com/a-declarative-approach-towards-automating-multi-stage-delivery-aa2470875ec4?source=collection_archive---------19-----------------------#2022-05-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="47b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将应用程序从代码阶段投入生产是一个漫长的过程，如果处理不当，该过程的很大一部分可能需要大量的人工干预。幸运的是，如果您在Kubernetes上托管这个应用程序，您可以利用一个令人难以置信的工具来自动化几乎所有的事情。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/ddb55bdec7ff66316d19fdf0c3546e19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j0_XneBoPXFbesRw"/></div></div></figure><h1 id="4d87" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">它试图解决什么？</h1><p id="2891" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">一个典型的Kubernetes应用程序的CI/CD过程从一个构建开始，该构建对应用程序代码执行一些初步测试，然后构建一个docker映像，将其推送到一个注册表，然后将其部署到dev。</p><p id="bc44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，该应用程序在开发环境中进行一系列功能测试，然后转移到试运行环境，在那里进行多轮性能测试。</p><p id="7a93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">整个过程可能涉及许多手动过程，如检查测试结果、手动评估测试结果，甚至管理环境的推广。</p><p id="4558" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，每个流程都需要自己的一套工具，如打包工具(maven、npm、gradle、…)、自动化测试工具(selenium、jmeter、…)、容器注册中心(dockerhub、jfrog、nexus、…)、部署工具(helm、kubectl、…)。您可能还需要一些脚本化的定制逻辑。当不同的应用程序使用不同版本的工具或者一起使用不同的工具时，事情会变得更加复杂。在这种情况下，每个团队都需要自己的管道，随着时间的推移，这很难维护。</p><p id="b493" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而且这还不止于此。当应用程序进入生产时，它需要监控、可观察性和支持以防出现问题。整个周期在时间和人力方面都付出了巨大的代价。Keptn(发音为captain)试图在一个工具中解决所有问题。</p><h1 id="febf" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">它是如何工作的？</h1><p id="5d19" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated"><a class="ae ma" href="https://keptn.sh/" rel="noopener ugc nofollow" target="_blank"> Keptn </a>使用可插拔工具和服务创建可重用管道，以创建端到端部署(和维护)流程。</p><p id="bf61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简单的声明性流程可以以Kubernetes资源的形式定义，以构建、测试和部署应用程序。</p><h2 id="22a8" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">事件驱动架构</h2><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mn"><img src="../Images/2d99f1a401122d2b89490e9bdb788d7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lcOsj1mdBwv4mmboW_mFgQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">来源:https://keptn.sh/docs/concepts/architecture/<a class="ae ma" href="https://keptn.sh/docs/concepts/architecture/" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure><p id="e663" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Keptn是事件驱动的，这意味着它使用定义良好的CloudEvents来处理持续交付和运营自动化过程中可能发生的几乎所有事情。不同的小服务注册这些事件，将事件转换成API调用。</p><p id="62df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一个大的列表<a class="ae ma" href="https://keptn.sh/docs/integrations/" rel="noopener ugc nofollow" target="_blank">列出了可以直接插入的可用服务</a>。如果您首选的工具不在列表中，可以选择使用webhooks和Kubernetes作业创建定制服务。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ms"><img src="../Images/eee29a1fa3bdd06675c99f1de49c9b3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ExCSXLvzCo32MJEBm14u1w.png"/></div></div></figure><p id="ba8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种方法使得添加(订阅事件)和删除(取消订阅事件)工具变得很容易；流水线中不需要硬编码。这也意味着一个构建不会被另一个阻塞。它可以为相应的服务发送一个事件以进行操作，并在接收到“完成”事件时进行报告；不需要持有资源和等待。</p><h2 id="4fc6" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">声明流程</h2><p id="d8e4" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">要声明一个流程，只需创建一个船厂类型的资源(其CRD将作为Keptn部署的一部分安装)。它可以包含诸如阶段、测试、<a class="ae ma" href="https://keptn.sh/docs/0.9.x/manage/shipyard/#deployment" rel="noopener ugc nofollow" target="_blank">部署策略</a>(如直接、蓝绿和用户管理)、阶段间测试评估、质量关等细节。</p><p id="c8cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在这里找到船厂文件<a class="ae ma" href="https://keptn.sh/docs/0.14.x/manage/shipyard/" rel="noopener ugc nofollow" target="_blank">的语法</a>。</p><p id="137d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">造船厂文件允许自定义，如</p><ul class=""><li id="0b64" class="mt mu iq jp b jq jr ju jv jy mv kc mw kg mx kk my mz na nb bi translated">手动或自动批准继续进行</li><li id="5f15" class="mt mu iq jp b jq nc ju nd jy ne kc nf kg ng kk my mz na nb bi translated">质量关口和测试评估(在后面的章节中讨论)</li><li id="bb6f" class="mt mu iq jp b jq nc ju nd jy ne kc nf kg ng kk my mz na nb bi translated">根据条件转移生产流量</li><li id="2f99" class="mt mu iq jp b jq nc ju nd jy ne kc nf kg ng kk my mz na nb bi translated">阶段失败时的回滚应用程序</li><li id="4b71" class="mt mu iq jp b jq nc ju nd jy ne kc nf kg ng kk my mz na nb bi translated">借助于<code class="fe nh ni nj nk b">triggeredOn</code>属性的复杂序列</li></ul><h2 id="0193" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">实施质量关</h2><p id="7579" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Keptn不需要任何额外的工具(或按照以下术语的服务)来实施质量检查。它带有内置的<a class="ae ma" href="https://pkg.go.dev/github.com/keptn/keptn/lighthouse-service#section-readme" rel="noopener ugc nofollow" target="_blank">灯塔服务</a>。</p><p id="4e7f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要使用它，您需要声明两件事</p><ul class=""><li id="ffb5" class="mt mu iq jp b jq jr ju jv jy mv kc mw kg mx kk my mz na nb bi translated"><strong class="jp ir">服务水平指标(SLI) </strong> <br/>需要评估的性能和安全指标</li><li id="918d" class="mt mu iq jp b jq nc ju nd jy ne kc nf kg ng kk my mz na nb bi translated"><strong class="jp ir">服务水平目标(SLO) </strong> <br/>评估SLIs中定义的指标</li></ul><p id="926a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SLOs将sli与绝对值或以前的版本指标进行比较，以生成并汇总应用程序性能和运行状况的总分。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nl"><img src="../Images/9ab9f1c744f904b668b64ab948b82423.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K2R38sVfIdDVu5NL.png"/></div></div></figure><h1 id="2d8c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">这并没有结束</h1><p id="f6cf" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Keptn不仅仅停留在部署上，它在维护方面更进一步</p><h2 id="7e1c" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">自动化操作</h2><p id="5995" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在生产失败/恶化的情况下，Keptn允许您定义一组补救步骤。它以Kubernetes补救资源的形式定义，其中包含一系列可用于补救生产故障的步骤，如扩展应用程序或关闭功能标志。</p><p id="52f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行补救步骤后，它将评估SLO(之前定义的),以检查性能是否有所提高，或者是否需要下一组步骤。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nm"><img src="../Images/054aeef8c9319eb272c1cbeed2be4b62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xy1Gyrynv9x5GK7c.png"/></div></div></figure><p id="a823" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果没有补救措施证明是有帮助的，可以将问题上报，并通知相应的团队。</p><h2 id="b6b8" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">监控和警报</h2><p id="e0f2" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">基于配置的SLIs(在前面的步骤中讨论过)，Keptn配置收集指标的抓取端点。</p><p id="db84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，基于配置的SLO，如果任何评估失败，则可以配置警报。</p><h1 id="9f22" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">离别赠言</h1><p id="76a2" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">作为一名DevOps工程师，我可以有把握地得出结论，Keptn可以让我的生活更轻松。Keptn拥有一个精心设计的架构，在保持简单的同时提供了无数的选项和定制。</p><p id="3834" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Keptn于2020年6月23日被CNCF接受，并在撰写本文时处于沙盒项目的成熟水平。要了解实际情况，请观看这个<a class="ae ma" href="https://www.cncf.io/online-programs/cncf-on-demand-webinar-introduction-to-keptn/" rel="noopener ugc nofollow" target="_blank"> CNCF点播网络研讨会:利用Keptn </a>实现从“Hello World”到企业规模的自动化SRE</p></div></div>    
</body>
</html>