<html>
<head>
<title>Connect to Google Drive and Search for Files with Python: Google Drive API with Python Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">连接到Google Drive并使用Python搜索文件:使用Python的Google Drive API第二部分</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/google-drive-api-with-python-part-ii-connect-to-google-drive-and-search-for-file-7138422e0563?source=collection_archive---------0-----------------------#2019-04-01">https://levelup.gitconnected.com/google-drive-api-with-python-part-ii-connect-to-google-drive-and-search-for-file-7138422e0563?source=collection_archive---------0-----------------------#2019-04-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="ed24" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你还没有设置你的Google Drive API，那么请按照本教程<a class="ae ko" href="https://medium.com/@thecruisy/google-drive-api-with-python-part-i-set-up-credentials-1f729cb0372b" rel="noopener">这里</a>的范围和凭证。</p><p id="6a23" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了能够访问API资源，我们需要获得访问令牌。由于我们想要访问的API资源包含敏感范围(访问Google Drive中的文件)，我们需要第一次进行浏览器身份验证。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/9d27c5753f91d44e6d1f513a12659a9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9M_6hUyuPYc7-J3eM6kNwQ.png"/></div></div></figure><p id="0d45" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们开始之前，让我们设置一个<code class="fe lb lc ld le b">virtual environment</code>来包含和安装这个项目的所有依赖项。我们将从安装<code class="fe lb lc ld le b">google-api-python-client</code>和<code class="fe lb lc ld le b">oauth2client</code>库开始。</p><pre class="kq kr ks kt gt lf le lg lh aw li bi"><span id="baea" class="lj lk it le b gy ll lm l ln lo">MacBook-Pro:~ bobthedude$ virtualenv venv_google_api<br/>MacBook-Pro:~ bobthedude$ source venv_google_api/bin/activate</span><span id="12b5" class="lj lk it le b gy lp lm l ln lo"># install all the dependent packages<br/>(venv_google_api) MacBook-Pro:~ bobthedude$ pip install google-api-python-client oauth2client</span></pre><p id="6eee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在项目目录中创建一个名为<code class="fe lb lc ld le b">credentials</code>的文件夹来存储您的<code class="fe lb lc ld le b">client_secret.json</code>，您可以从您的<strong class="js iu"> Google控制台</strong>下载它。如果你不知道如何做到这一点，按照这个教程<a class="ae ko" href="https://medium.com/@thecruisy/google-drive-api-with-python-part-i-set-up-credentials-1f729cb0372b" rel="noopener">这里</a>。</p><p id="7009" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您的项目结构应该像这样开始。<code class="fe lb lc ld le b">connect_to_google_drive.py</code>是包含连接到Google Drive API的指令的Python文件。</p><pre class="kq kr ks kt gt lf le lg lh aw li bi"><span id="cc2e" class="lj lk it le b gy ll lm l ln lo">first_medium_project<br/>|<br/>|__credentials<br/>|  |<br/>|  |__client_secret.json<br/>|<br/>|__connect_to_google_drive.py</span></pre><p id="f115" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们编写需要进入<code class="fe lb lc ld le b">connect_to_google_drive.py</code>的代码。</p><pre class="kq kr ks kt gt lf le lg lh aw li bi"><span id="19f7" class="lj lk it le b gy ll lm l ln lo">from apiclient import discovery<br/>from httplib2 import Http<br/>from oauth2client import client, file, tools<br/><br/><br/># define path variables<br/>credentials_file_path = './credentials/credentials.json'<br/>clientsecret_file_path = './credentials/client_secret.json'<br/><br/># define API scope<br/>SCOPE = 'https://www.googleapis.com/auth/drive'<br/><br/># define store<br/>store = file.Storage(credentials_file_path)<br/>credentials = store.get()</span><span id="2331" class="lj lk it le b gy lp lm l ln lo"># get access token<br/>if not credentials or credentials.invalid:<br/>    flow = client.flow_from_clientsecrets(clientsecret_file_path, SCOPE)<br/>    credentials = tools.run_flow(flow, store)</span></pre><p id="3a39" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您的访问令牌将在浏览器认证后存储在<code class="fe lb lc ld le b">credentials/credentials.json</code>中，我将在此之后进行认证。</p><p id="ed5a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，保存文件并进入您的<code class="fe lb lc ld le b">terminal</code>。按照以下命令获取您的访问令牌。<strong class="js iu">注意</strong>:如果你从一个IDE(我使用<code class="fe lb lc ld le b">PyCharm</code>)执行上面的脚本，你会得到一个错误。只有第一次，您需要从您的<code class="fe lb lc ld le b">terminal</code>执行脚本。</p><pre class="kq kr ks kt gt lf le lg lh aw li bi"><span id="834e" class="lj lk it le b gy ll lm l ln lo">(venv_google_api) MacBook-Pro:~ bobthedude$ cd first_medium_project<br/>(venv_google_api) MacBook-Pro:first_medium_project bobthedude$ python connect_to_google_drive.py</span><span id="5be6" class="lj lk it le b gy lp lm l ln lo"># below is the output of the above command<br/>/Users/bobthedude/virtualenv/venv_google_api/lib/python3.7/site-packages/oauth2client/_helpers.py:255: UserWarning: Cannot access ./credentials/credentials.json: No such file or directory<br/>  warnings.warn(_MISSING_FILE_MESSAGE.format(filename))</span><span id="2a48" class="lj lk it le b gy lp lm l ln lo">Your browser has been opened to visit:</span><span id="da57" class="lj lk it le b gy lp lm l ln lo"><a class="ae ko" href="https://accounts.google.com/o/oauth2/auth?client_id=278243817351-rg97r0faiaalfbpa6e3ecaggsgv80o7m.apps.googleusercontent.com&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8080%2F&amp;scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fdrive&amp;access_type=offline&amp;response_type=code" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/o/oauth2/auth?client_id=123456789101-ab12r1abcdefjklm1a2bcdefghi12a1a.apps.googleusercontent.com&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8080%2F&amp;scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fdrive&amp;access_type=offline&amp;response_type=code</a></span><span id="8b5c" class="lj lk it le b gy lp lm l ln lo">If your browser is on a different machine then exit and re-run this<br/>application with the command-line parameter</span><span id="1572" class="lj lk it le b gy lp lm l ln lo">--noauth_local_webserver</span></pre><p id="fc94" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">执行上述命令后，将会打开一个浏览器选项卡。选择您在上一步中设置API和凭证的Google帐户。然后点击<strong class="js iu">允许</strong>。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lq"><img src="../Images/f829dc4ba92b71322f7e67a37d88cc42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BMrE7RAHbTCCIPxjSzonyQ.png"/></div></div></figure><p id="6d6b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您想让您的<strong class="js iu">第一媒体应用程序</strong>访问您的Google Drive文件，Google将再次提示您并要求确认。继续点击<strong class="js iu">允许</strong>。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lr"><img src="../Images/7006eb8c80730de619c79e3f1e937880.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pBfGkNXUw8hQyVF3KaiaHg.png"/></div></div></figure><p id="1e27" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果成功，您的浏览器将返回包含以下文本的页面<code class="fe lb lc ld le b">The authentication flow has completed</code>。如果您返回到您的<code class="fe lb lc ld le b">terminal</code>，您应该看到额外的两行(表示认证成功)打印如下。</p><pre class="kq kr ks kt gt lf le lg lh aw li bi"><span id="1641" class="lj lk it le b gy ll lm l ln lo">/Users/bobthedude/virtualenv/venv_google_api/lib/python3.7/site-packages/oauth2client/_helpers.py:255: UserWarning: Cannot access ./credentials/credentials.json: No such file or directory<br/>  warnings.warn(_MISSING_FILE_MESSAGE.format(filename))</span><span id="ced5" class="lj lk it le b gy lp lm l ln lo">Your browser has been opened to visit:</span><span id="5d6c" class="lj lk it le b gy lp lm l ln lo"><a class="ae ko" href="https://accounts.google.com/o/oauth2/auth?client_id=278243817351-rg97r0faiaalfbpa6e3ecaggsgv80o7m.apps.googleusercontent.com&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8080%2F&amp;scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fdrive&amp;access_type=offline&amp;response_type=code" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/o/oauth2/auth?client_id=123456789101-ab12r1abcdefjklm1a2bcdefghi12a1a.apps.googleusercontent.com&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8080%2F&amp;scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fdrive&amp;access_type=offline&amp;response_type=code</a></span><span id="158c" class="lj lk it le b gy lp lm l ln lo">If your browser is on a different machine then exit and re-run this<br/>application with the command-line parameter</span><span id="7a21" class="lj lk it le b gy lp lm l ln lo">--noauth_local_webserver</span><span id="8bd0" class="lj lk it le b gy lp lm l ln lo">Authentication successful.<br/>success</span></pre><p id="b6aa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，您将看到在<code class="fe lb lc ld le b">credentials</code>文件夹中创建了一个新文件<code class="fe lb lc ld le b">credentials.json</code>。干得好！我们现在已经获得了访问令牌，可以用它来连接Google Drive API资源。</p><pre class="kq kr ks kt gt lf le lg lh aw li bi"><span id="e84d" class="lj lk it le b gy ll lm l ln lo">(venv_google_api) MacBook-Pro:first_medium_project bobthedude$ ls credentials/</span><span id="3448" class="lj lk it le b gy lp lm l ln lo"># output as below<br/>client_secret.json credentials.json</span></pre><p id="c93b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们给我们的<code class="fe lb lc ld le b">connect_to_google_drive.py</code>添加一个函数，它将检索我们在Google Drive中的所有文件。</p><pre class="kq kr ks kt gt lf le lg lh aw li bi"><span id="3204" class="lj lk it le b gy ll lm l ln lo">from apiclient import discovery, errors<br/>from httplib2 import Http<br/>from oauth2client import client, file, tools<br/><br/><br/># define variables<br/>credentials_file_path = './credentials/credentials.json'<br/>clientsecret_file_path = './credentials/client_secret.json'<br/><br/># define scope<br/>SCOPE = 'https://www.googleapis.com/auth/drive'<br/><br/># define store<br/>store = file.Storage(credentials_file_path)<br/>credentials = store.get()<br/><br/>if not credentials or credentials.invalid:<br/>    flow = client.flow_from_clientsecrets(clientsecret_file_path, SCOPE)<br/>    credentials = tools.run_flow(flow, store)<br/><br/># define API service<br/>http = credentials.authorize(Http())<br/>drive = discovery.build('drive', 'v3', http=http)<br/><br/># define a function to retrieve all files<br/>def retrieve_all_files(api_service):<br/>    results = []<br/>    page_token = None<br/><br/>    while True:<br/>        try:<br/>            param = {}<br/><br/>            if page_token:<br/>                param['pageToken'] = page_token<br/><br/>            files = api_service.files().list(**param).execute()</span><span id="78db" class="lj lk it le b gy lp lm l ln lo">            # append the files from the current result page to our list<br/>            results.extend(files.get('files'))</span><span id="762b" class="lj lk it le b gy lp lm l ln lo">            # Google Drive API shows our files in multiple pages when the number of files exceed 100<br/>            page_token = files.get('nextPageToken')<br/><br/>            if not page_token:<br/>                break<br/><br/>        except errors.HttpError as error:<br/>            print(f'An error has occurred: {error}')<br/>            break</span><span id="a327" class="lj lk it le b gy lp lm l ln lo">    # output the file metadata to console<br/>    for file in results:<br/>        print(file)<br/><br/>    return results<br/><br/># call the function<br/>all_files = retrieve_all_files(drive)</span></pre><p id="e81f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，转到您的<code class="fe lb lc ld le b">terminal</code>并执行Python脚本。</p><pre class="kq kr ks kt gt lf le lg lh aw li bi"><span id="4c74" class="lj lk it le b gy ll lm l ln lo">(venv_google_api) MacBook-Pro:first_medium_project bobthedude$ python connect_to_google_drive.py</span><span id="f72e" class="lj lk it le b gy lp lm l ln lo"># output will look like this<br/>{'kind': 'drive#file', 'id': '12345678901234TyVhFjlzOhL9MoazYiFbyABWgV9abC', 'name': 'Christmas Plan', 'mimeType': 'application/vnd.google-apps.spreadsheet'}<br/>{'kind': 'drive#file', 'id': '12345678901234sN8zlbWAptpqNOgEihTZhgKgsAbac9', 'name': 'Event Feedback', 'mimeType': 'application/vnd.google-apps.form'}<br/>{'kind': 'drive#file', 'id': '12345678901234URWSjdpbEABCDE', 'name': 'Workshop 2010', 'mimeType': 'application/vnd.google-apps.folder'}</span></pre><p id="8b62" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从上面可以看到，我们的Python脚本已经成功连接到Google Drive API资源，检索了所有文件并打印了文件元数据。</p><p id="2234" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以用这个做很多其他的事情。您可以添加几行接受文件名的代码，以便Python脚本检索您感兴趣的特定文件的文件元数据。让我们修改一下<code class="fe lb lc ld le b">retrieve_all_files</code>函数，看看它会是什么样子。</p><pre class="kq kr ks kt gt lf le lg lh aw li bi"><span id="6196" class="lj lk it le b gy ll lm l ln lo"># define a function to retrieve all files<br/>def retrieve_all_files(api_service, filename_to_search):<br/>    results = []<br/>    page_token = None<br/><br/>    while True:<br/>        try:<br/>            param = {}<br/><br/>            if page_token:<br/>                param['pageToken'] = page_token<br/><br/>            files = api_service.files().list(**param).execute()</span><span id="f3cb" class="lj lk it le b gy lp lm l ln lo"># append the files from the current result page to our list<br/>            results.extend(files.get('files'))</span><span id="17d6" class="lj lk it le b gy lp lm l ln lo"># Google Drive API shows our files in multiple pages when the number of files exceed 100<br/>            page_token = files.get('nextPageToken')<br/><br/>            if not page_token:<br/>                break<br/><br/>        except errors.HttpError as error:<br/>            print(f'An error has occurred: {error}')<br/>            break</span><span id="1fdc" class="lj lk it le b gy lp lm l ln lo"># output the file metadata to console<br/>    for file in results:<br/>        if file.get('name') == filename_to_search:<br/>            print(file)<br/>            break</span><span id="b035" class="lj lk it le b gy lp lm l ln lo"><br/>    return results, file<br/></span><span id="0817" class="lj lk it le b gy lp lm l ln lo"># call the function<br/>filename_to_search = 'Christmas Plan'<br/>all_files, search_file = retrieve_all_files(drive, filename_to_search)</span></pre><p id="2016" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本系列教程的下一部分，我将向您展示如何从Google sheet下载特定的工作表到csv文件中。此外，我们将把上面的代码转换成命令行应用程序，而不仅仅是一个普通的Python脚本。</p><p id="a8a3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以在这里看到这个教程的第一部分<a class="ae ko" href="https://medium.com/@thecruisy/google-drive-api-with-python-part-i-set-up-credentials-1f729cb0372b" rel="noopener">。</a></p><p id="91a5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">敬请期待第三部！😃</p></div></div>    
</body>
</html>