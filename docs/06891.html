<html>
<head>
<title>Create a Durable Topic Subscriber for ActiveMQ</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为ActiveMQ创建持久主题订阅者</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/create-a-durable-topic-subscriber-for-activemq-349f788afd80?source=collection_archive---------11-----------------------#2021-01-11">https://levelup.gitconnected.com/create-a-durable-topic-subscriber-for-activemq-349f788afd80?source=collection_archive---------11-----------------------#2021-01-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9ac0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Apache ActiveMQ是最流行的基于Java的开源消息服务器。它支持各种跨语言客户端和协议，如Java、C、C++、C#、Ruby、Perl、Python和PHP。<a class="ae kl" href="https://www.openlogic.com/blog/what-apache-activemq" rel="noopener ugc nofollow" target="_blank"> ActiveMQ </a>的跨语言兼容性使其成为微服务架构中理想的消息代理。</p><p id="d86f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ActiveMQ提供了一个通道来存储应该传递给各种服务的消息。该通道可以配置为以两种方式管理消息:<a class="ae kl" href="https://activemq.apache.org/how-does-a-queue-compare-to-a-topic" rel="noopener ugc nofollow" target="_blank">队列或主题</a>。</p><p id="61e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir">队列</strong>架构中，只有一个客户端(消费者)会收到发送客户端(生产者)发送的消息。</p><p id="9e67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir">主题</strong>架构中，多个客户端(订阅者)可以接收发送客户端(发布者)发送的相同消息。订阅者通知消息代理他们想要“订阅”ActiveMQ上配置的给定“主题”。</p><p id="a673" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简单地说，队列是点对点通信的理想选择，而主题是一对多通信场景的理想选择。</p><h1 id="8fe4" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">主题架构的用例</h1><p id="eea9" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">比方说，你正在为一个电子商务平台设计一个订单确认流程。用户确认订单后，您决定触发以下三项微服务:</p><ol class=""><li id="5ba0" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">触发订单管理服务来处理订单</li><li id="2f40" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">触发通知程序服务向相关人员发送通知</li><li id="28c2" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">触发分析服务来记录订单指标</li></ol><p id="4b94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些服务可以订阅ActiveMQ上的“订单确认”主题，以侦听发布者就此主题发送的消息。该通信的示意图如下所示:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/cb665db25cc11d4e13fccbc3af4f4f47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tfh7TENWH5oaI4qgO0Mejw.png"/></div></div></figure><p id="e8c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，如果这些服务中的任何一个出现故障，无法监听新订单确认消息，会发生什么呢？订单管理服务在这里是至关重要的，您不希望这个服务错过API发布的任何订单确认消息。</p><p id="a4cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在默认配置中，即使消息被发布者标记为“持久”, ActiveMQ也不会确保传递给已关闭的订阅者。</p><p id="8751" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了避免这种情况，您需要在ActiveMQ上将“订单管理服务”注册为“<strong class="jp ir">持久主题订阅者</strong>”。当订阅者注册为持久主题订阅者，然后变得不可用时，ActiveMQ将存储接收到的消息，以便在持久订阅者再次出现时传递它们。</p><h1 id="7df6" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">示例:持久订户v/s非持久订户</h1><p id="d188" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">让我们看一个例子来理解持久和非持久订户在下面的事件序列中的行为。</p><p id="d807" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里，两个订阅者都订阅了同一个主题“topic-1”。</p><p id="0b07" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">事件顺序:</strong></p><p id="0c12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.持久订户出现</p><p id="f0cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.发布者发送三条消息，内容为:“持久订阅者启动…”</p><p id="246f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.长期用户停机</p><p id="7742" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.发布者发送三条消息，内容为:“持久订户已关闭…”</p><p id="c5ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.非持久订户出现</p><p id="0357" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.发布者发送三条消息，其文本为:“非持久订阅者启动…”</p><p id="c59a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.非持久订户关闭</p><p id="4d8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8.发布者发送三条消息，其文本为:“非持久订户已关闭…”</p><p id="896c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">9.非持久订户再次出现</p><p id="abc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">10.持久订户再次出现</p><p id="0253" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">让我们先对持久订户进行编码</strong></p><p id="0542" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">订阅者可以通过使用<a class="ae kl" href="https://docs.oracle.com/javaee/7/api/javax/jms/Session.html" rel="noopener ugc nofollow" target="_blank"> javax.jms.Session </a>类中的createDurableSubscriber()方法作为持久订阅者订阅ActiveMQ上的主题。</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="e7de" class="mu kn iq mq b gy mv mw l mx my">import javax.jms.*;</span><span id="b329" class="mu kn iq mq b gy mz mw l mx my">import org.apache.activemq.ActiveMQConnectionFactory;</span><span id="410b" class="mu kn iq mq b gy mz mw l mx my">public class DurableSubscriber {</span><span id="f0e0" class="mu kn iq mq b gy mz mw l mx my">    public static Boolean <em class="na">TRANSACTIONAL </em>= false;</span><span id="4860" class="mu kn iq mq b gy mz mw l mx my">   public static String <em class="na">TOPIC_NAME </em>= "topic-1"; // Change as per<br/>                                                // your topic name</span><span id="2fa2" class="mu kn iq mq b gy mz mw l mx my">    public static void main(String[] args) throws JMSException {</span><span id="7c16" class="mu kn iq mq b gy mz mw l mx my">        String host = "localhost"; // change if ActiveMQ is <br/>                                   // installed on another system</span><span id="edbe" class="mu kn iq mq b gy mz mw l mx my">        String port = "61616";</span><span id="b17d" class="mu kn iq mq b gy mz mw l mx my">        // Creating Factory for connection</span><span id="3893" class="mu kn iq mq b gy mz mw l mx my">        ActiveMQConnectionFactory factory = new ActiveMQConnectionFactory("tcp://" + host + ":" + port);</span><span id="57aa" class="mu kn iq mq b gy mz mw l mx my">        Connection connection = factory.createConnection();</span><span id="3c39" class="mu kn iq mq b gy mz mw l mx my">        // This is just an identifier.<!-- --> </span><span id="74ad" class="mu kn iq mq b gy mz mw l mx my">        // This does not influence message delivery in any way.</span><span id="0da9" class="mu kn iq mq b gy mz mw l mx my">        connection.setClientID("DurableSubscriber");</span><span id="a6f0" class="mu kn iq mq b gy mz mw l mx my">        connection.start();</span><span id="1ece" class="mu kn iq mq b gy mz mw l mx my">        Session session = connection.createSession(<em class="na">TRANSACTIONAL</em>,</span><span id="8875" class="mu kn iq mq b gy mz mw l mx my">        Session.<em class="na">AUTO_ACKNOWLEDGE</em>);</span><span id="10e7" class="mu kn iq mq b gy mz mw l mx my">        Topic destination = session.createTopic(<em class="na">TOPIC_NAME</em>);</span><span id="080a" class="mu kn iq mq b gy mz mw l mx my">        // This is where we create a Durable Subscriber</span><span id="4a6e" class="mu kn iq mq b gy mz mw l mx my">        MessageConsumer consumer = session.createDurableSubscriber(destination, "Listener");</span><span id="2f56" class="mu kn iq mq b gy mz mw l mx my">        // Listening for messages from publisher</span><span id="38dc" class="mu kn iq mq b gy mz mw l mx my">        Message message;</span><span id="d9fe" class="mu kn iq mq b gy mz mw l mx my">        while(true) {</span><span id="dcee" class="mu kn iq mq b gy mz mw l mx my">            message = consumer.receive(1000);</span><span id="e0c3" class="mu kn iq mq b gy mz mw l mx my">            if (message instanceof TextMessage) {</span><span id="15bb" class="mu kn iq mq b gy mz mw l mx my">                TextMessage textMessage = (TextMessage) message;</span><span id="21cc" class="mu kn iq mq b gy mz mw l mx my">                String text = textMessage.getText();</span><span id="0048" class="mu kn iq mq b gy mz mw l mx my">                System.<em class="na">out</em>.println("Received: " + text);</span><span id="a915" class="mu kn iq mq b gy mz mw l mx my">            }</span><span id="61d0" class="mu kn iq mq b gy mz mw l mx my">        }</span><span id="4df7" class="mu kn iq mq b gy mz mw l mx my">    }</span><span id="c0c7" class="mu kn iq mq b gy mz mw l mx my">}</span></pre><p id="ce5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了创建非持久订户，我们将使用默认的session . createdurablesubscriber()方法，而不是使用session.createConsumer()方法。</p><p id="d27b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">代码的其余部分将保持与非持久订户相同。</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="a354" class="mu kn iq mq b gy mv mw l mx my">connection.setClientID("NonDurableSubscriber");</span><span id="53c5" class="mu kn iq mq b gy mz mw l mx my">connection.start();</span><span id="a8e4" class="mu kn iq mq b gy mz mw l mx my">Session session = connection.createSession(<em class="na">TRANSACTIONAL</em>,</span><span id="15ac" class="mu kn iq mq b gy mz mw l mx my">Session.<em class="na">AUTO_ACKNOWLEDGE</em>);</span><span id="26ea" class="mu kn iq mq b gy mz mw l mx my">Topic destination = session.createTopic(<em class="na">TOPIC_NAME</em>);</span><span id="068e" class="mu kn iq mq b gy mz mw l mx my">// Creates a non-durable subscriber</span><span id="6809" class="mu kn iq mq b gy mz mw l mx my">MessageConsumer consumer = session.createConsumer(destination);</span></pre><p id="72aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们看看订阅者如何响应我们上面提到的事件序列。我们将使用ActiveMQ的“发送JMS消息”特性来模拟发布者向我们的主题“topic-1”发送消息。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nb"><img src="../Images/1cf7a6c8944c18e66c9dc1e5a09b82e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6JUYN0U7HT16L8AP.png"/></div></div></figure><ol class=""><li id="3c11" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">持久订户出现</li><li id="354a" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">发布者发送三条消息，其文本为:持久订阅者启动…</li></ol><p id="4497" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="na">持久订户收到这些消息:</em></p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/fdf45a7726e1e4b0ef4490fc26ed8a92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/0*9UBk7p5XJkA27W7y.png"/></div></figure><p id="d679" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.长期用户停机</p><p id="738b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.发布者发送三条消息，其文本为:持久订阅者关闭…</p><p id="ec99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">没有用户可以接收这些消息。因此，我们在订户端看不到任何活动。</p><p id="8a49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.非持久订户出现</p><p id="2d87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.发布者发送三条消息，文本为:非持久订阅者启动…</p><p id="a0d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="na">非持久用户接收消息:</em></p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/926a81e8573c75cb3674052354bd4805.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/0*R1TqyAqYV4CLxrgj.png"/></div></figure><p id="862f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.非持久订户关闭</p><p id="f62b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8.发布者发送三条消息，其文本为:非持久订户已关闭…</p><p id="5d01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="na">同样，没有订户可以捕捉这些消息。</em></p><p id="8f59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">9.非持久订户再次出现</p><p id="d1aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="na">非持久订户开始监听新消息。它不接收来自ActiveMQ的任何信息，但是它不知道当它关闭时在这个主题上发送了一些消息。</em></p><p id="7ef6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">10.持久订户再次出现</p><p id="7280" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="na">一旦持久订阅者重新启动，它将接收自第3步关闭以来发送到主题“主题-1”的所有消息:</em></p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/4f1abc7bc1e8c71c0af1b5b79fb76d7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/0*TUQ_v3gl35qTsBA3.png"/></div></figure><p id="73f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">我们来分析一下这里发生了什么:</strong></p><p id="bf3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在步骤4中，没有活动订户可用于捕捉发送到“topic-1”的消息。然而，在第3步中，一个持久订户刚刚关闭。因此，ActiveMQ将存储这些消息，期望这个订户在将来的某个时间回来。</p><p id="db61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以检查ActiveMQ管理页面上的“订户”选项卡，以检查已注册的脱机持久主题订户。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nf"><img src="../Images/9dc7e414c711ef55dba448e0d2447c0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JnNxKSn8FpZK-Y24.png"/></div></div></figure><p id="595d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在步骤6中，即使有一个活动的非持久订户可以监听收到的消息，ActiveMQ仍将为注册的脱机持久订户存储消息。类似地，在第8步，当没有活动订户可以接收消息时，ActiveMQ将为离线持久订户存储这些消息。</p><p id="badc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，一旦持久订户在步骤10中出现，ActiveMQ就将所有存储的消息推送给它。</p><h1 id="d563" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><p id="37e5" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">当您的服务不能冒错过任何由发布者服务发送的消息的风险时，持久主题订阅者会很有帮助。ActiveMQ帮助您将异步通信的效率与类似于同步架构的交付保证结合起来。</p><p id="7d02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这允许更大的灵活性和改进的效率。因此，下一次当您面对一个需要消息主题架构的问题陈述时，但是您不能冒丢失事务的风险，请使用持久订阅者。</p></div></div>    
</body>
</html>