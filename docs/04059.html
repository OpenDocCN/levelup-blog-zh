<html>
<head>
<title>File Upload — Express, MongoDB, Multer &amp; S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">文件上传— Express、MongoDB、Multer和S3</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/file-upload-express-mongodb-multer-s3-7fad4dfb3789?source=collection_archive---------2-----------------------#2020-06-08">https://levelup.gitconnected.com/file-upload-express-mongodb-multer-s3-7fad4dfb3789?source=collection_archive---------2-----------------------#2020-06-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/6075cdf68d62fb8aa8ce9a1a1cd1b9e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*CIolkR8u5UuZp5aJRPVzBg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">亚马逊S3</figcaption></figure><blockquote class="jy jz ka"><p id="ac85" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这篇文章假设您有一个后端服务器，运行Express + MongoDB Atlas，并希望通过添加上传文件的能力来扩展功能，或者在本例中，添加图像。</p></blockquote><p id="9146" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">我最近犯了一个错误，试图直接上传图片到MongoDB。沮丧了几个小时后，我联系了一个朋友，他给我指出了正确的方向:亚马逊S3。</p><p id="93f5" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><em class="kd">依附关系:</em></p><p id="6d87" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><code class="fe ld le lf lg b">dotenv</code> : Dotenv是一个零依赖模块，将环境变量从<code class="fe ld le lf lg b">.env</code>文件加载到<code class="fe ld le lf lg b"><a class="ae lh" href="https://nodejs.org/docs/latest/api/process.html#process_process_env" rel="noopener ugc nofollow" target="_blank">process.env</a></code></p><p id="a79e" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><code class="fe ld le lf lg b">aws-sdk</code>:官方AWS SDK for JavaScript，可用于浏览器和移动设备，或Node.js后端</p><p id="65dc" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><code class="fe ld le lf lg b">multer</code> : Multer是处理<code class="fe ld le lf lg b">multipart/form-data</code>的node.js中间件，主要用于上传文件。它写在<a class="ae lh" href="https://github.com/mscdex/busboy" rel="noopener ugc nofollow" target="_blank">勤杂工</a>的顶部，以获得最大效率。</p><p id="8744" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><code class="fe ld le lf lg b">multer-s3</code>:AWS S3流媒体存储引擎。</p><pre class="li lj lk ll gt lm lg ln lo aw lp bi"><span id="5222" class="lq lr iq lg b gy ls lt l lu lv">npm i --save dotenv aws-sdk multer multer-s3</span></pre><h2 id="da56" class="lq lr iq bd lw lx ly dn lz ma mb dp mc la md me mf lb mg mh mi lc mj mk ml mm bi translated">开始使用:</h2><p id="b9fb" class="pw-post-body-paragraph kb kc iq ke b kf mn kh ki kj mo kl km la mp kp kq lb mq kt ku lc mr kx ky kz ij bi translated">首先，前往<a class="ae lh" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/s3/</a>创建一个账户。设置帐户后，导航至S3服务仪表板，以便创建新的存储桶。当您创建新的存储桶时，该名称必须是唯一的，并且采用符合DNS的格式。例如:“{ app-name }-个人资料-图片”，您无需进行任何特定设置，只需在设置过程中单击“下一步”即可。</p><figure class="li lj lk ll gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/099ab7de3cd3a93ba22802cfaf449c80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*53tgmgsO-ZEUgHYE4CVnrQ.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">设置S3存储桶</figcaption></figure><p id="0f34" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">创建好bucket后，单击bucket，然后选择permissions &gt; CORS配置，并输入以下代码以允许HTTP请求。</p><figure class="li lj lk ll gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mx"><img src="../Images/7e1ca780d7ed98b61e2b9219d09d22bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oi4jq9QOw3dF_Q8MLecHiA.png"/></div></div></figure><pre class="li lj lk ll gt lm lg ln lo aw lp bi"><span id="b308" class="lq lr iq lg b gy ls lt l lu lv">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;CORSConfiguration ae lh" href="http://s3.amazonaws.com/doc/2006-03-01/" rel="noopener ugc nofollow" target="_blank"&gt;http://s3.amazonaws.com/doc/2006-03-01/"&gt;<br/>&lt;CORSRule&gt;<br/>    &lt;AllowedOrigin&gt;*&lt;/AllowedOrigin&gt;<br/>    &lt;AllowedMethod&gt;GET&lt;/AllowedMethod&gt;<br/>    &lt;AllowedMethod&gt;POST&lt;/AllowedMethod&gt;<br/>    &lt;AllowedMethod&gt;PUT&lt;/AllowedMethod&gt;<br/>    &lt;AllowedHeader&gt;*&lt;/AllowedHeader&gt;<br/>&lt;/CORSRule&gt;<br/>&lt;/CORSConfiguration&gt;</span></pre><p id="60bc" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">太好了。现在我们需要获得访问密钥+秘密。为此，请打开您的帐户下拉菜单并选择“我的安全凭证”</p><figure class="li lj lk ll gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi my"><img src="../Images/35126766771444d7461e8d1f8a82736e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x87kWOuHRw_MJT-Nk1yBhA.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">在哪里可以找到访问密钥+机密</figcaption></figure><p id="baad" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">在安全凭据控制面板中，打开“访问密钥”部分。在那里，选择“创建新的访问密钥”这将为您的应用程序生成和访问密钥和机密。将密钥+秘密存储在您的计算机本地的notes应用程序中。</p><h2 id="af89" class="lq lr iq bd lw lx ly dn lz ma mb dp mc la md me mf lb mg mh mi lc mj mk ml mm bi translated"><strong class="ak">在应用程序中放置密钥+密码时要非常小心。有网络爬虫扫描GITHUB REPO的访问密钥+秘密。他们将使用你的帐户，并运行一个标签。</strong></h2><h2 id="9c61" class="lq lr iq bd lw lx ly dn lz ma mb dp mc la md me mf lb mg mh mi lc mj mk ml mm bi translated">让我们进入您的节点/快速项目。</h2><p id="c82d" class="pw-post-body-paragraph kb kc iq ke b kf mn kh ki kj mo kl km la mp kp kq lb mq kt ku lc mr kx ky kz ij bi translated">首先也是最重要的，我想确保你有你的<code class="fe ld le lf lg b">.env</code>文件设置，这样你的信用卡和S3账户是安全的。在您的<code class="fe ld le lf lg b">server</code>或<code class="fe ld le lf lg b">app</code>文件中，放置以下代码:</p><p id="fd30" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><em class="kd">/服务器</em></p><pre class="li lj lk ll gt lm lg ln lo aw lp bi"><span id="5f6a" class="lq lr iq lg b gy ls lt l lu lv"><strong class="lg ir">const cors = require("cors");<br/>app.use(cors());</strong></span></pre><p id="270d" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">太好了。设置好之后，在项目目录的根目录下创建一个<code class="fe ld le lf lg b">.gitignore</code>文件，并将<code class="fe ld le lf lg b">.env</code>放入其中。</p><p id="1346" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">现在，创建一个<code class="fe ld le lf lg b">.env</code>文件，并将您的访问密钥+密码放入其中:</p><p id="e199" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><em class="kd">。环境</em></p><pre class="li lj lk ll gt lm lg ln lo aw lp bi"><span id="f1e7" class="lq lr iq lg b gy ls lt l lu lv">S3_ACCESS_KEY=accesskeyprovided<br/>S3_ACCESS_SECRET=accesssecretprovided</span></pre><p id="4b1d" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">现在我们可以开始有趣的事情了。让我们创建一个<code class="fe ld le lf lg b">services</code>目录，在这里我们可以放置大部分上传逻辑。在服务中，创建一个名为<code class="fe ld le lf lg b">ImageUpload.js</code>的文件</p><pre class="li lj lk ll gt lm lg ln lo aw lp bi"><span id="24dd" class="lq lr iq lg b gy ls lt l lu lv">mkdir services<br/>cd services<br/>touch ImageUpload.js<br/>cd ..</span></pre><p id="8b12" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">首先让我们加载依赖项并初始化S3连接:</p><p id="2d8b" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><em class="kd">/services/image upload . js</em></p><pre class="li lj lk ll gt lm lg ln lo aw lp bi"><span id="aebc" class="lq lr iq lg b gy ls lt l lu lv">const aws = require("aws-sdk");<br/>const multer = require("multer");<br/>const multerS3 = require("multer-s3");</span><span id="f607" class="lq lr iq lg b gy mz lt l lu lv">const s3 = new aws.S3();</span></pre><p id="1f63" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">接下来，我们需要通过我们的<code class="fe ld le lf lg b">.env</code>变量插入我们的访问凭证:</p><p id="3311" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><em class="kd">/services/image upload . js</em></p><pre class="li lj lk ll gt lm lg ln lo aw lp bi"><span id="2fe5" class="lq lr iq lg b gy ls lt l lu lv">aws.config.update({<br/>  secretAccessKey: process.env.S3_ACCESS_SECRET,<br/>  accessKeyId: process.env.S3_ACCESS_KEY,<br/>  region: "us-east-2",<br/>});</span></pre><p id="2581" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">太好了。现在让我们创建一个验证文件类型的函数:</p><p id="d623" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><em class="kd">/services/imageupload . js</em></p><pre class="li lj lk ll gt lm lg ln lo aw lp bi"><span id="c5eb" class="lq lr iq lg b gy ls lt l lu lv">const fileFilter = (req, file, cb) =&gt; {<br/>  if (file.mimetype === "image/jpeg" || file.mimetype === "image/png") {<br/>    cb(null, true);<br/>  } else {<br/>    cb(new Error("Invalid file type, only JPEG and PNG is allowed!"), false);<br/>  }<br/>};</span></pre><p id="901f" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">现在，我们将设置Multer来处理图像，并将其发送到S3桶。</p><p id="046b" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><em class="kd">/services/image upload . js</em></p><pre class="li lj lk ll gt lm lg ln lo aw lp bi"><span id="715c" class="lq lr iq lg b gy ls lt l lu lv">const upload = multer({<br/>  fileFilter,<br/>  storage: multerS3({<br/>    acl: "public-read",<br/>    s3,<br/>    bucket: <strong class="lg ir">{your-bucket-name}</strong>,<br/>    metadata: function (req, file, cb) {<br/>      cb(null, { fieldName: "TESTING_METADATA" });<br/>    },<br/>    key: function (req, file, cb) {<br/>      cb(null, Date.now().toString());<br/>    },<br/>  }),<br/>});</span></pre><p id="afd5" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">在设置路线之前，确保您导出了<code class="fe ld le lf lg b">upload</code>功能。下面是完整的代码。</p><p id="4733" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><em class="kd">/services/image upload . js</em></p><pre class="li lj lk ll gt lm lg ln lo aw lp bi"><span id="1d39" class="lq lr iq lg b gy ls lt l lu lv">const aws = require("aws-sdk");<br/>const multer = require("multer");<br/>const multerS3 = require("multer-s3");<br/><br/>const s3 = new aws.S3();<br/><br/>aws.config.update({<br/>  secretAccessKey: process.env.S3_SECRET,<br/>  accessKeyId: process.env.S3_ACCESS_KEY,<br/>  region: "us-east-2",<br/>});<br/><br/>const fileFilter = (req, file, cb) =&gt; {<br/>  if (file.mimetype === "image/jpeg" || file.mimetype === "image/png") {<br/>    cb(null, true);<br/>  } else {<br/>    cb(new Error("Invalid file type, only JPEG and PNG is allowed!"), false);<br/>  }<br/>};<br/><br/>const upload = multer({<br/>  fileFilter,<br/>  storage: multerS3({<br/>    acl: "public-read",<br/>    s3,<br/>    bucket: <strong class="lg ir">{your-bucket-name}</strong>,<br/>    metadata: function (req, file, cb) {<br/>      cb(null, { fieldName: "TESTING_METADATA" });<br/>    },<br/>    key: function (req, file, cb) {<br/>      cb(null, Date.now().toString());<br/>    },<br/>  }),<br/>});<br/><br/><strong class="lg ir">module.exports = upload;</strong></span></pre><p id="c23b" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">对于我的应用程序，我想通过允许用户上传个人资料图片来扩展功能。因此，用户将向路由<code class="fe ld le lf lg b">/users/{id}/add-profile-picture</code>发送一个请求。首先，图像被上传到S3，S3发送一个包含照片URL的响应，然后我们使用[:id]参数找到使用Mongo的用户，然后将文件位置存储在用户的文档中。</p><p id="a6dd" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><em class="kd">/路线/用户</em></p><pre class="li lj lk ll gt lm lg ln lo aw lp bi"><span id="33b7" class="lq lr iq lg b gy ls lt l lu lv">const upload = require("../services/ImageUpload");<br/>const singleUpload = upload.single("image");<br/><br/>router.post("/:id/add-profile-picture", function (req, res) {<br/>  const uid = req.params.id;<br/><br/>  singleUpload(req, res, function (err) {<br/>    if (err) {<br/>      return res.json({<br/>        success: false,<br/>        errors: {<br/>          title: "Image Upload Error",<br/>          detail: err.message,<br/>          error: err,<br/>        },<br/>      });<br/>    }<br/><br/>    let update = { profilePicture: req.file.location };<br/><br/>    User.findByIdAndUpdate(uid, update, { new: true })<br/>      .then((user) =&gt; res.status(200).json({ success: true, user: user }))<br/>      .catch((err) =&gt; res.status(400).json({ success: false, error: err }));<br/>  });<br/>});</span></pre><p id="b55a" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">有了路由设置，您可以使用Postman来测试它。启动您的服务器，前往邮递员，输入相应的路线，选择表单数据，并从您的计算机中选择一个图像。确保将键设置为<code class="fe ld le lf lg b">image</code>并点击发送。</p><figure class="li lj lk ll gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi na"><img src="../Images/c14931080c00a880afb4620fbc77d682.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rm5WDYhPIXrBPAZgu34VIQ.png"/></div></div></figure><p id="95f3" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated">如果你有兴趣学习如何从React前端上传图片，请查看我的另一篇文章:</p><p id="72fa" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km la ko kp kq lb ks kt ku lc kw kx ky kz ij bi translated"><a class="ae lh" rel="noopener ugc nofollow" target="_blank" href="/react-uploading-images-a224e0fb4561">https://level up . git connected . com/react-uploading-images-a 224 E0 FB 4561</a></p></div></div>    
</body>
</html>