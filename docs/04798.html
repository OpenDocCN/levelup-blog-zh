<html>
<head>
<title>Doubles, Instance Doubles, and Spies in RSpec</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">RSpec中的替身、实例替身和间谍</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/doubles-instance-doubles-and-spies-in-rspec-82e38c0746f4?source=collection_archive---------2-----------------------#2020-07-16">https://levelup.gitconnected.com/doubles-instance-doubles-and-spies-in-rspec-82e38c0746f4?source=collection_archive---------2-----------------------#2020-07-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div class="gh gi ir"><img src="../Images/870f44559055dab718223da3e8d77339.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*1_tWwjI3auOSMtZDDDE8hw.png"/></div></figure><div class=""/><p id="ba9f" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">最近，我正在创建一个小项目，用我在Ruby中为RSpec测试所学到的新概念进行试验，并有所收获。我到底如何测试一个实例(或类！)一个模型中的方法，它完全依赖于另一个模型中的方法的结果。</p><p id="90c1" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我给你举个基本的例子。我有一个用户模型和一个宠物模型，宠物属于用户。为了掌握如何在测试中交织模型的概念，我在名为#pet_animal的用户模型上创建了一个简单的方法，并给它一个简单的true输出。然后，我想在宠物模型中创建一个名为#be_happy的方法，如果#pet_animal的输出等于owner实例参数中的true，那么该动物将返回“Purr”。原谅那些不可思议的基本方法，尤其是如果它们没有多大意义的话。这就更能理解双打等人了。</p><p id="8a20" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这是真正的基本设置！</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi kv"><img src="../Images/81dffb85da415cbb7be93f457ab5bdb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bMoWEvMPn5FxUbaS9CoaSA.png"/></div></div></figure><p id="dd19" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">所以，在宠物的测试文件夹里。我需要重新创建一个owner实例来测试#be_happy方法。第一个选择是创造一个替身。</p><h1 id="f835" class="le lf ja bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">双打</strong></h1><p id="cc18" class="pw-post-body-paragraph jx jy ja jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">double将模拟用户对象。这使您可以简化流程。如果在我们的#pet_animal方法中实现true的业务逻辑很重要，那么测试将会花费更长的时间，并且可能不会返回我们实际想要测试的内容！相反，我们可以绕过它，在double中将方法自动设置为true。允许我们测试Pet #be_happy方法。</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mh"><img src="../Images/0a4804efcb278c4a52f8a0856498cdae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ktJAfdAJ29AqN5IkhUygg.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">简单双重检验</figcaption></figure><p id="9300" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这里，我们使用let方法将我们创建的double设置为变量:owner。然后，我们使用double方法将pet_animal设置为true。</p><p id="18e2" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">接下来，我们需要创建我们的宠物的一个实例，以便我们可以调用必要的方法！</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mm"><img src="../Images/1864ecdec90bd51cc9e619f1faa54bfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ydwuI9DSkmnC-So1cHkbqQ.png"/></div></div></figure><p id="b5fb" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">第5行简单地写道，当调用#be_happy方法并且owner参数的#pet_animal方法等于true时，期望所描述的类(Pet类)的新实例等于“Purr”。</p><p id="ea82" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">你也可以把你的主题设置在顶部，这样expect方法就干净一点了。</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mn"><img src="../Images/2d10baa53da43d0717bdc06bae555c5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z7AQURwAQNl8stDv0ZH7pw.png"/></div></div></figure><p id="057f" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这两个都会给你一个及格的测试。</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mo"><img src="../Images/5c1a441835cfd0691c582d419f990344.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*91OVfL8K3ez9gdPr3feqFw.png"/></div></div></figure><p id="f328" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">不过，使用替身也有一些缺点，尽管很小:</p><ol class=""><li id="e7d2" class="mp mq ja jz b ka kb ke kf ki mr km ms kq mt ku mu mv mw mx bi translated">我们不是在模仿现实生活中的物体，而是在创造一个虚幻的物体。我可以向我们的owner变量添加甚至不在我们的用户模型中的方法，测试仍然会通过。RSpec不会验证我们在这里针对真实类定义的方法。</li><li id="da95" class="mp mq ja jz b ka my ke mz ki na km nb kq nc ku mu mv mw mx bi translated">运行测试所花的时间比实例的两倍少，但比探测的多！即使它相对较小。</li><li id="0eb9" class="mp mq ja jz b ka my ke mz ki na km nb kq nc ku mu mv mw mx bi translated">作为开发人员，我们有责任确保这些方法与现实生活中的方法相匹配。如果考虑到模型可能增长到的规模和…方法的变化，这可能会很困难！</li></ol><p id="7540" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这个链接给你一个关于性能/速度的好主意。<a class="ae nd" href="https://www.ombulabs.com/blog/rspec/ruby/spy-vs-double-vs-instance-double.html" rel="noopener ugc nofollow" target="_blank">表演。</a></p><p id="779b" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">然而，如果你确实想让你的测试更稳定，结构更好，并且速度更快。我建议在测试中使用实例替身。</p><h1 id="3973" class="le lf ja bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">实例双精度/验证双精度</h1><p id="5e02" class="pw-post-body-paragraph jx jy ja jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">这与double类似，只是它会验证double的接口，以确保它匹配它所模仿的类或实例。这使得您的测试更加严格，因为您必须正确地模拟一个对象。想象它就像一个演员和一个替身，你不想让观众(测试)认为他们之间有任何区别。</p><p id="b9d8" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">实例方法只能定义它正在复制的类上的方法。首先，确保向实例传递一个参数，双重验证RSpec将哪个类作为实例对象。</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mo"><img src="../Images/e39d08c9e866f4346c633d1bf081656a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ThIRvAtJV7baobznZM05w.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">实例_双精度方法</figcaption></figure><p id="1abf" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在，如果我向instance_double添加一个不在我们的用户类中的额外方法，RSpec将返回一个错误。</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ne"><img src="../Images/6864b48bea15354726fdf5394533e9f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PCcSWet_AD7295-Q9Cuw-A.png"/></div></div></figure><p id="f79d" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">下面你可以看到RSpec返回了一个错误消息，告诉我们#pet_your_head方法没有在User类中实现。完美！我们不希望任何额外的代码可能会导致我们在测试中不必要的问题。</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi nf"><img src="../Images/00af13ea531d0dc1447462e198d31578.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JV4aZm6ZU28azz9S6aFJ4Q.png"/></div></div></figure><p id="fff9" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">它甚至会测试你传入的参数数量是否正确，如果有的话。下面，我试图在测试中给我们的#pet_animal方法传递一个参数。</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ng"><img src="../Images/4e04e4348b59c4f643256ebd012616cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e95DGCP6_S0ky_4CVfuEIg.png"/></div></div></figure><p id="2eaa" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">但是正如我们所看到的，RSpec检查实际的方法并进行比较。然后给你一个错误，说明特定的方法不需要任何参数！所以它也会检查它们的实现和参数。这确保了我们的替身尽可能地与我们的班级相似或接近。</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi nh"><img src="../Images/c1d2568061745afe0a4ba338260be830.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*48txrHfe_cwqXuj1MXaMYw.png"/></div></div></figure><p id="0599" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">因此，为了正确实现实例变量，我们必须坚持使用该类提供的相同方法。</p><p id="fe29" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在我们必须正确地创建一个实例double。因为我想尽可能地复制这个。我已经创建了一个instance_double，其中包含了创建一个完整的用户实例和一个宠物实例所需的所有数据。</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ni"><img src="../Images/b00d34821cfd186c541d2e584cc62ce2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j9ctUu2eMjPV5FwiJZiVng.png"/></div></div></figure><p id="9a00" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在这里，您可以看到使用id和测试所需的方法创建了一个用户，使用名称和宠物所属的user_id创建了一个宠物。</p><p id="31df" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">然后我做了一个断言，期望我们的所有者调用#pet_animal方法，我希望它返回true！然后，我希望subject(或“Petty”)返回“Purr”，因为我们的owner方法等于true。我可以删除第6行，期望所有者接收该方法。但这只是一个额外的层，以确保我们测试正确。</p><p id="a9ba" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这将返回:</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi nj"><img src="../Images/f77d00205f96578a20b4e3aa58a758ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aJreFK3zqy3KgPxSDQm-gg.png"/></div></div></figure><p id="1e90" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">太棒了。最后，让我们来看看间谍。</p><h1 id="4279" class="le lf ja bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">间谍</h1><p id="3679" class="pw-post-body-paragraph jx jy ja jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">间谍很简单。它们与double非常相似，但如果有什么不同的话，那就是更不严格。主要的两个区别是:</p><ol class=""><li id="441f" class="mp mq ja jz b ka kb ke kf ki mr km ms kq mt ku mu mv mw mx bi translated">你把间谍写反了。因此，您首先在测试中调用方法，然后编写断言。</li><li id="dbc4" class="mp mq ja jz b ka my ke mz ki na km nb kq nc ku mu mv mw mx bi translated">您实际上从来不需要定义方法。你只需要创建一个可以接受任何东西的对象。</li></ol><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi nk"><img src="../Images/c177e2dad605ebd499d81d9c00de6785.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k0jeEQ9Kpyh-s_kOfFoagw.png"/></div></div></figure><p id="2887" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">尽管如此，测试将通过！</p><figure class="kw kx ky kz gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi nl"><img src="../Images/80a2f4c76aca06b9d7a52c5c9c892664.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3tIO8E6vnGJahDpgMrGVig.png"/></div></div></figure><p id="1e85" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">就是这样！双打的三个例子！我强烈推荐使用双实例，因为它们使你的代码最简洁，并且尽可能地反映类和方法！</p><p id="ff42" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">Udemy有一个很好的RSpec测试入门课程。链接到页面。</p></div></div>    
</body>
</html>