<html>
<head>
<title>How to Connect to Private AWS Resources with SSH Tunnels and Bastion Hosts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用SSH隧道和Bastion主机连接到私有AWS资源</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-connect-to-private-aws-resources-with-ssh-tunnels-and-bastion-hosts-ac5c2e12e2d3?source=collection_archive---------11-----------------------#2020-12-30">https://levelup.gitconnected.com/how-to-connect-to-private-aws-resources-with-ssh-tunnels-and-bastion-hosts-ac5c2e12e2d3?source=collection_archive---------11-----------------------#2020-12-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2201e31949183c3262ca50c328385193.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p4735iNZuUc6lO8OMP8Rog.png"/></div></div></figure><h1 id="a5b4" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">可公开访问的AWS资源的问题是</h1><p id="dd10" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">当您第一次为一个新项目开发基础设施时，您自然会为快速开发进行优化。您希望得到一些东西——任何东西——出门，因此您希望能够快速编写代码和调试问题。</p><p id="febc" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">正因为如此，在公共子网中运行服务器和数据库非常诱人，这样您就可以方便地连接到它们以进行调试会话。能够<code class="fe lz ma mb mc b">ssh my-user@my-web-server</code>进行一些现场代码调试，或者<code class="fe lz ma mb mc b">psql -U my-user -h my-database-instance</code>评估数据库的当前状态，这很好。</p><p id="729e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">当然，AWS允许你这么做。你<em class="md">可以</em>在你的网络服务器上公开SSH，你<em class="md">可以</em>在互联网上公开你的AWS关系数据库服务(RDS)和Redis/elastic cache服务器以便于访问。但是你应该吗？公开暴露数据库和服务器会产生一个非常明显的安全问题:互联网上的任何人都可以直接访问您的敏感数据。</p><p id="c0a7" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">你可能会说“没关系；我们锁定了我们的VPC安全组，这样只有我们办公室IP的人才能访问我们的EC2、RDS或ElastiCache实例。互联网上的其他人因为他们的IP地址而被阻止”。虽然这是真的——以这种方式锁定您的资源总比什么都没有好——但这种策略会产生两个陷阱:</p><ol class=""><li id="c58a" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated">允许来自您办公室IP地址的任何人访问您的AWS资源仍然是一个安全问题。wifi上的访客或初级开发人员John真的应该访问生产数据库吗？通过公共IP锁定您的资源，很难区分DevOps用户和您组织的其他人——每个人都可能使用相同的公共IP地址。此外，随着组织的发展，会产生更多的攻击媒介。您网络上的单个受损用户就可能对您的生产系统造成严重破坏。</li><li id="a4b1" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated">您的远程员工将很难获得资源。如果您的员工在家工作(在这个充满COVID的年份，他们很可能在家工作)，您将需要您的员工维护到您办公室的VPN连接，或者您将需要维护所有员工家庭IP地址的白名单。如果您的员工碰巧对机场或咖啡店的停电做出响应，他们可能会花费几分钟(几小时？)在VPC安全小组能够访问以解决停机问题之前，对他们进行人工干预。</li></ol><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/268265f130f991767ba5b7d222244bda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*qW_djSNYh6PtziO3Wfw3Og.png"/></div></div></figure><p id="2365" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这是我工作过的所有地方都必须解决的问题，所以我想这也是其他人必须面对的问题。让我们看看如何正确地做到这一点，同时优化安全性和可访问性。</p><h1 id="2ffb" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">进入AWS系统管理器</h1><p id="e65d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">让我们假设您已经遵循了安全协议，并且已经放置了各种AWS资源(EC2、RDS、ElastiCache等)。)放入私有子网，并取消了对它们的公共访问。您如何安全地授予团队成员(如您的高级开发人员和开发人员)需要的访问权限？AWS提供了<a class="ae mx" href="https://aws.amazon.com/systems-manager/" rel="noopener ugc nofollow" target="_blank">系统管理器</a>来让你检查和访问你的AWS资源——甚至那些驻留在私有子网中的资源。通过Systems Manager，用户可以用他们的AWS凭证来交换对ec2的临时shell访问。他们可以通过CLI和AWS web控制台进行访问。</p><p id="f5c2" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">要启用对EC2s的访问，只需将<a class="ae mx" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html" rel="noopener ugc nofollow" target="_blank"> AWS SSM代理</a>安装到您启动的服务器上。你可能会问,“SSM”中多余的“S”是怎么回事？这是历史——系统管理器过去被称为“简单的系统管理器”,多余的“S”被卡住了——随它去吧。好消息——如果你正在使用亚马逊的Linux、macOS、Ubuntu Server或亚马逊提供的一些Windows服务器映像来构建你的服务器，SSM代理已经为你安装好了——你只需要打开一台机器，授予它一个在AWS的<a class="ae mx" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html" rel="noopener ugc nofollow" target="_blank">文档</a>中定义的特定角色。</p><p id="c65c" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">一旦安装了带有SSM代理的EC2，就可以使用<code class="fe lz ma mb mc b">aws</code> CLI工具在实例中打开一个shell:</p><pre class="mt mu mv mw gt my mc mz na aw nb bi"><span id="a82f" class="nc jz iq mc b gy nd ne l nf ng">$ aws ssm start-session --target i-0b6c737cc21dc01a9</span><span id="1a20" class="nc jz iq mc b gy nh ne l nf ng">Starting session with SessionId: treece-0bf6ff366c16d651f<br/>sh-4.2$ whoami<br/>ssm-user<br/>sh-4.2$ cat /etc/system-release<br/>Amazon Linux release 2 (Karoo)</span></pre><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/2a045826179afff127089e5e3e40f714.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*dG2ZIMQF-54mfcn58_HllQ.png"/></div></figure><p id="8d36" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">当你安装了SSM代理，你就不需要担心IP白名单了。您的系统管理团队可以使用他们的AWS凭证从任何地方(办公室、家里，甚至是咖啡店)访问资源。没有AWS证书，初级开发人员John无法访问生产数据库。对不起，约翰！</p><h1 id="ce18" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">访问RDS或者ElastiCache呢？</h1><p id="957f" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">使用AWS Systems Manager，您可以远程访问EC2s，但是像PostgreSQL/RDS或Redis/elastic cache这样的数据库呢？AWS不允许您直接SSH到运行RDS或ElastiCache的系统。相反，我建议在您的VPC中构建一个名为<strong class="ky ir"> bastion </strong>的最小EC2实例，您可以使用Systems Manager远程访问它。你可以远程进入<strong class="ky ir">堡垒，</strong>一旦进入，你就可以访问你的数据库。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/0588a969605a6321d3f07dede278aaf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*ab8xrFDkSpkJ570AQNy3Ww.png"/></div></figure><p id="d0c9" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">确保为您的堡垒分配一个VPC安全组，并创建入口规则，以便您的RDS和ElastiCache安全组允许来自堡垒安全组的访问。一旦您完成了所有的设置，您就可以从bastion上的命令行访问您的数据库:</p><pre class="mt mu mv mw gt my mc mz na aw nb bi"><span id="4afc" class="nc jz iq mc b gy nd ne l nf ng">$ aws ssm start-session --target i-0b6c737cc21dc01a9</span><span id="27f0" class="nc jz iq mc b gy nh ne l nf ng">Starting session with SessionId: treece-048a3bf2269ad7caf<br/>sh-4.2$ psql -h 10.0.2.88 -U testuser postgres<br/>Password for user testuser: <br/>SSL connection (cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256)<br/>Type "help" for help.</span><span id="8da7" class="nc jz iq mc b gy nh ne l nf ng">postgres=&gt; CREATE TABLE users (id INT, email VARCHAR(40));<br/>CREATE TABLE</span></pre><p id="6ed9" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">你可能会问，“难道我不能在公共子网中建立一个堡垒，然后通过SSH进入吗？”是也不是。是的，你完全可以这么做。不，这不是一个好主意——这与将您的服务器和数据库留在公共子网中会带来同样的安全漏洞。</p><h1 id="4325" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">隧道…到处都是隧道</h1><p id="cc5b" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在这一点上，我们可以选择通过Systems Manager直接远程访问EC2，并且我们可以通过bastion EC2间接访问我们的数据库。我想看的最后一件事是利用穿过堡垒的SSH隧道来访问数据库资源，就好像它们是本地可访问的一样。这样，您可以将您喜欢的数据库GUI，如<a class="ae mx" href="https://www.pgadmin.org/" rel="noopener ugc nofollow" target="_blank"> pgAdmin </a>连接到您的RDS实例。</p><p id="c880" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">首先，我们需要将一个SSH公钥放入我们的堡垒。我假设您已经在<code class="fe lz ma mb mc b">$HOME/.ssh/id_rsa.pub</code>中有了一个密钥。我们将使用<code class="fe lz ma mb mc b">aws</code> CLI将用户<code class="fe lz ma mb mc b">ssm-user</code>的密钥临时加载到我们的堡垒中:</p><pre class="mt mu mv mw gt my mc mz na aw nb bi"><span id="0079" class="nc jz iq mc b gy nd ne l nf ng">$ aws ec2-instance-connect \\<br/>    send-ssh-public-key \\<br/>    --availability-zone us-east-1a \\<br/>    --instance-id i-0b6c737cc21dc01a9 \\<br/>    --instance-os-user ssm-user \\<br/>    --ssh-public-key file://$HOME/.ssh/id_rsa.pub<br/>{<br/>    "RequestId": "f8f3db2a-3107-4c0a-ae3d-94e2d7fff620",<br/>    "Success": true<br/>}</span></pre><p id="b1c2" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">接下来，我将修改我的笔记本电脑的<code class="fe lz ma mb mc b">$HOME/.ssh/config</code>文件，这样以<code class="fe lz ma mb mc b">i-</code>开始的服务器将通过我们之前使用的<code class="fe lz ma mb mc b">aws ssm start-session</code>命令代理它们的连接。我补充一下:</p><pre class="mt mu mv mw gt my mc mz na aw nb bi"><span id="3def" class="nc jz iq mc b gy nd ne l nf ng">host i-*<br/>    ProxyCommand sh -c "aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters 'portNumber=%p'"</span></pre><p id="9cb0" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">现在，我可以简单地通过<code class="fe lz ma mb mc b">ssh ssm-user@INSTANCE-ID</code>来访问我的实例:</p><pre class="mt mu mv mw gt my mc mz na aw nb bi"><span id="8a83" class="nc jz iq mc b gy nd ne l nf ng">$ ssh ssm-user@i-0b6c737cc21dc01a9<br/>Last login: Tue Dec 15 20:27:34 2020 from localhost</span><span id="fd0f" class="nc jz iq mc b gy nh ne l nf ng">       __|  __|_  )<br/>       _|  (     /   Amazon Linux 2 AMI<br/>      ___|\\___|___|</span><span id="2f39" class="nc jz iq mc b gy nh ne l nf ng">&lt;https://aws.amazon.com/amazon-linux-2/&gt;<br/>10 package(s) needed for security, out of 22 available<br/>Run "sudo yum update" to apply all updates.<br/>[ssm-user@ip-10-0-0-71 ~]$ ls<br/>file.txt system.log<br/>[ssm-user@ip-10-0-0-71 ~]$</span></pre><p id="bb61" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">现在我可以通过SSH访问我的堡垒了(即使它在一个不能从互联网访问的私有网络中！)我可以像对待任何其他SSH连接一样建立SSH隧道。例如，要创建到我的RDS实例的隧道，我只需运行:</p><pre class="mt mu mv mw gt my mc mz na aw nb bi"><span id="ef9f" class="nc jz iq mc b gy nd ne l nf ng">$ ssh ssm-user@i-0b6c737cc21dc01a9 -NL 5000:10.0.2.88:5432</span></pre><p id="06fd" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">然后从一个单独的shell中，我可以在端口5000上“本地”访问我的数据库:</p><pre class="mt mu mv mw gt my mc mz na aw nb bi"><span id="e2bb" class="nc jz iq mc b gy nd ne l nf ng">$ psql -h localhost -p 5000 -U testuser postgres<br/>Password for user testuser: <br/>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)<br/>Type "help" for help.</span><span id="2af4" class="nc jz iq mc b gy nh ne l nf ng">postgres=&gt; \\dt<br/>         List of relations<br/> Schema | Name  | Type  |  Owner   <br/>--------+-------+-------+----------<br/> public | users | table | testuser<br/>(1 row)</span></pre><p id="4cae" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">很酷吧。使用穿过你的堡垒的隧道，你可以访问驻留在你的私有网络中的任何资源，而不需要将它们暴露给互联网上的流氓…或者小约翰。</p></div></div>    
</body>
</html>