<html>
<head>
<title>How I built an NFT supply checker with AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何用AWS Lambda构建NFT供应检查器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-i-built-an-nft-supply-checker-with-aws-lambda-1d75b8323c27?source=collection_archive---------15-----------------------#2021-10-11">https://levelup.gitconnected.com/how-i-built-an-nft-supply-checker-with-aws-lambda-1d75b8323c27?source=collection_archive---------15-----------------------#2021-10-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3d31" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不可替代代币，或简称NFT，现在非常流行。每个人和他们的宠物都开始了一个NFT项目。一些人通过使用NFT致富；其他人没有。有人说救世主会把权力从大公司手中夺走，还给创造者；也有人说只是一个巨型传销。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/7b1e2cbea745ac66d40e8fbebc78fc8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oD5TIzrhrlFT1o6XQskk7w.png"/></div></div></figure><p id="f608" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不知道事情会如何发展，区块链是否会在NFT的炒作下成为下一个大事件，或者它是否会像之前的许多其他技术一样失败。但是我最近被问到的一个问题是，<strong class="jp ir">这与AWS和无服务器技术</strong>有什么关系？</p><p id="cf54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是为什么我想，让我们乘坐炒作列车，写一篇关于NFTs和无服务器技术的文章！</p><h1 id="3e3c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">区块链相关的AWS服务</h1><p id="9b53" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">当想到AWS和区块链时，我的第一个想法当然是名称中带有区块链的AWS服务:<strong class="jp ir">亚马逊管理的区块链</strong> (AMB)。</p><p id="fd21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了AMB，你可以在你选择的EC2机器上托管<strong class="jp ir">以太坊节点</strong>，由AWS管理。你可以把它想象成RDS，但是用区块链代替SQL数据库。</p><p id="a143" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你不想依赖第三方的节点，比如Infura或Alchemy，你将需要这样一个服务。这些节点可以被视为链上服务和链下服务之间的桥梁。</p><p id="e98b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ABM既不是无服务器，也不便宜；你按小时付费，最终账单可能会超过300美元，没问题。因此，您应该使用它来确保当第三方破产或您设法从第三方服务获得过高的账单时，您的节点不会宕机。</p><p id="ad9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个相关的服务是<strong class="jp ir">亚马逊量子账本数据库</strong> (QLDB)，一个托管的不可变区块链/账本。如果你需要区块链的不变性，就使用它，但是没有分散的一切，这也随之而来。它可以按需付费，而且比AMB便宜很多，所以如果你只需要一个不可变的数据库，那就选择QLDB吧。</p><h1 id="d494" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">节点还是客户端？</h1><p id="bca3" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">构成分散式以太坊系统的节点可以被视为经典设置中的服务器，或者无服务器设计中的数据库和功能。他们挖掘新的区块或验证交易；他们还执行被称为智能合同的软件。这意味着你需要连接到一个节点来访问以太坊区块链。</p><p id="9482" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们并不关注节点，所以我们对AMB不感兴趣。我们希望实现一个客户端，它向一个节点请求存储在区块链上的数据。因此，我们的例子将位于链外。</p><h1 id="fa8e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">我们将建造什么？</h1><p id="c7b8" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们将使用AWS CDK构建一个无服务器系统。它将由一个每小时调用一次的Lambda函数和一个存储离线数据的S3桶组成。我们将使用JavaScript和Ethers.js库从AWS Lambda连接到以太坊。</p><p id="77d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将检查的数据是智能合同已发布的NFT的供应。由于以太网区块链上的许多智能合约都有定义良好的接口，我们可以编写一个只需要合约地址就能完成工作的函数。</p><p id="294b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通常，AWS被视为以太坊的竞争对手，因为“以太坊只是构建后端的另一种方式”，但我认为它们可以一起工作。区块链上的交易是昂贵的，所以一些数据和计算可以外包给像AWS Lambda这样的链外系统。</p><h1 id="e440" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">如何与以太坊互动？</h1><p id="3ce7" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">要将非以太坊(离线)系统与以太坊智能合约(在线)连接，它必须连接到一个节点。我们已经了解到AWS提供了我们可以使用的相当昂贵的节点，但是还有许多服务可以免费使用。这些服务有严格的限制，但是对于这个例子，它们应该足够了。</p><p id="4dda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通常，区块链上的事务会消耗gas，但我们将只调用标记为view的函数。这样，我们连接到的节点可以简单地从其本地区块链副本中读取数据，无需任何事务，因此既不需要钱包也不需要汽油。</p><h1 id="31c5" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">基础设施</h1><p id="db02" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">让我们看一下定义我们基础架构的示例CDK堆栈。</p><pre class="km kn ko kp gt ma mb mc md aw me bi"><span id="e272" class="mf ky iq mb b gy mg mh l mi mj">const nftChecks = new s3.Bucket(this, "nftChecks");</span><span id="d8f5" class="mf ky iq mb b gy mk mh l mi mj">const nftChecker = new lambda.Function(this, "nftChecker", {<br/>  runtime: lambda.Runtime.NODEJS_14_X,<br/>  handler: "index.handler",<br/>  code: lambda.Code.fromAsset(<br/>    path.join(__dirname, "functions", "nftChecker")<br/>  ),<br/>  environment: {<br/>    BUCKET_NAME: nftChecks.bucketName,<br/>    CONTRACT_ADDRESS: "0x25ed58c027921e14d86380ea2646e3a1b5c55a8b",<br/>  },<br/>});</span><span id="606c" class="mf ky iq mb b gy mk mh l mi mj">nftChecks.grantWrite(nftChecker);</span><span id="e048" class="mf ky iq mb b gy mk mh l mi mj">const rule = new events.Rule(this, "nftCheckRule", {<br/>  schedule: events.Schedule.rate(cdk.Duration.hours(1)),<br/>});<br/>rule.addTarget(new eventsTargets.LambdaFunction(nftChecker));</span></pre><p id="591e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个桶和一个λ函数。智能契约的桶名和地址通过环境变量传递给Lambda函数。</p><p id="7ed4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个例子中，我使用了智能合约的开发者道，因为的代码是开源的，所以我知道他们实现了什么接口。</p><p id="9a95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在堆栈的末尾，用CloudWatch事件设置了时间表。</p><h1 id="2031" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">λ函数</h1><p id="aa93" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">现在，让我们看看将与以太坊交互的代码。</p><pre class="km kn ko kp gt ma mb mc md aw me bi"><span id="11c8" class="mf ky iq mb b gy mg mh l mi mj">const contractAbi = ["function totalSupply() external view returns (uint256)"];</span><span id="947e" class="mf ky iq mb b gy mk mh l mi mj">const { BUCKET_NAME, CONTRACT_ADDRESS } = process.env;</span><span id="447c" class="mf ky iq mb b gy mk mh l mi mj">exports.handler = async function () {<br/>  const provider = new ethers.providers.getDefaultProvider();<br/>  const contract = new ethers.Contract(CONTRACT_ADDRESS, contractAbi, provider);<br/>  const mintedTokens = await contract.totalSupply();</span><span id="bfe9" class="mf ky iq mb b gy mk mh l mi mj">  await s3<br/>    .putObject({<br/>      Bucket: BUCKET_NAME,<br/>      Key: new Date().toISOString() + ".json",<br/>      Body: mintedTokens + "",<br/>    })<br/>    .promise();<br/>};</span></pre><p id="e48d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一行定义了我们想要调用的智能合约的应用程序二进制接口。它只是一个字符串数组，组成了该契约的方法签名。我没有定义所有的契约方法，因为我将只调用其中的一个。</p><p id="f57c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我获取环境变量，以了解从哪里获取数据以及将数据保存到哪里。</p><p id="e650" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在函数体中，我从Ethers.js获取默认提供者，在这个例子中，函数每小时只执行一次，所以不会达到限制。尽管如此，在可能更频繁地访问节点提供者的生产系统中，您应该注册一个以太坊网关服务，如Infura或Alchemy。</p><p id="fffd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我与正确的ABI、地址和提供商签订了合同。提供商确保我们连接到正确的链(以太坊有测试链，我们不想与这些测试链通信)。ABI告诉Ethers.js契约提供了哪些方法。最后，契约的地址使Ethers.js知道在链上哪里可以找到契约。</p><p id="25e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们调用方法，该方法给出了已经创建的NFT的数量，并将其作为JSON文件保存到我们的S3桶中。文件名是ISO字符串形式的当前日期和时间；我们将会知道每小时有多少NFT被铸造出来。</p><h1 id="220d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">用Dashbird监控</h1><p id="f06f" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">如果你将一些计算转移到AWS Lambda中，你可以用<a class="ae ml" href="https://dashbird.io/" rel="noopener ugc nofollow" target="_blank"> Dashbird </a>监控它们，就像你在AWS上构建的其他无服务器系统一样。不需要额外的设置。我们可以为我们的NFT检查器设置警报，并在出现故障时得到通知。</p><p id="21b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在图1中，我们看到了Dashbird提供给我们的关于Lambda函数的一般信息。这只是类似于一些测试调用，但我们已经可以看到一些有趣的事情。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mm"><img src="../Images/245e9b7b443267618206a39517700ba7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*J0Q4oq3YERQm73Ri"/></div></div></figure><p id="af30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mn">图1: Dashbird Lambda函数细节</em></p><p id="1ce9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有的执行都是免费的，而且它们非常适合最小的内存配置。很高兴知道这一点。但是如果我们看一下图2中的Duration选项卡，我们会看到我们的函数有不同的运行时。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mo"><img src="../Images/080720afc4766a6f106e73c62494e718.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zu6UN5ELnwQzRVBu"/></div></div></figure><p id="146b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mn">图2: Dashbird Lambda持续时间标签</em></p><p id="f522" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该功能需要不到1秒到3秒的时间来完成工作。默认的Lambda调用超时为3，000毫秒，我们的函数很有可能被过早关闭。特别是，由于它每小时只调用一次，所以每次都会冷启动。</p><p id="09cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以利用Dashbird收集的信息，用更大的超时来更新我们的Lambda函数定义，这样它就不会在将来意外崩溃。</p><pre class="km kn ko kp gt ma mb mc md aw me bi"><span id="8a42" class="mf ky iq mb b gy mg mh l mi mj">const nftChecker = new lambda.Function(this, "nftChecker", {<br/>  runtime: lambda.Runtime.NODEJS_14_X,<br/>  handler: "index.handler",<br/>  timeout: cdk.Duration.seconds(30),<br/>  code: lambda.Code.fromAsset(<br/>    path.join(__dirname, "functions", "nftChecker")<br/>  ),<br/>  environment: {<br/>    BUCKET_NAME: nftChecks.bucketName,<br/>    CONTRACT_ADDRESS: "0x25ed58c027921e14d86380ea2646e3a1b5c55a8b",<br/>  },<br/>});</span></pre><h1 id="dacf" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结论</h1><p id="7fcc" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">这个小示例应用程序概述了如何将无服务器技术与区块链结合使用。Lambda函数比区块链事务更便宜、更快，因此它们适用于不需要被区块链跟踪的非关键计算。</p><p id="8751" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个例子很简单，也有些做作，但是根据区块链的状态进行自动化工作是一个实际的用例。Lambda函数可以在HTML站点上呈现统计数据，或者通知NFT的创建者他们的供应发生了变化。</p><p id="aa79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Dashbird，您可以像使用任何其他Lambda函数一样跟踪您的NFT检查器，并使用洞察力来进一步优化执行。你可以在GitHub 上找到<a class="ae ml" href="https://github.com/kay-is/serverless-nft-checker" rel="noopener ugc nofollow" target="_blank">完整的例子。</a></p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><p id="1b32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mn">延伸阅读:</em></p><p id="59eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae ml" href="https://dashbird.io/blog/serverless-hot-stock-checker/" rel="noopener ugc nofollow" target="_blank">我们如何为华尔街赌注构建一个无服务器的“stonks”checker API</a></p><p id="a81f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae ml" href="https://dashbird.io/blog/how-to-save-hundreds-hours-debugging-lambda/" rel="noopener ugc nofollow" target="_blank">如何在Lambda调试上节省几百个小时？</a></p><p id="fa5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae ml" href="https://dashbird.io/blog/failure-and-threat-detection-serverless/" rel="noopener ugc nofollow" target="_blank">具有故障和威胁检测功能的防弹无服务器应用</a></p></div></div>    
</body>
</html>