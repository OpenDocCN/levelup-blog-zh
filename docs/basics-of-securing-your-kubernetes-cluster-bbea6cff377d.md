# 保护 Kubernetes 集群的基础知识

> 原文：<https://levelup.gitconnected.com/basics-of-securing-your-kubernetes-cluster-bbea6cff377d>

![](img/d26813dc90a7b04f5586dc041ec78afa.png)

在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上由 [Rendy Novantino](https://unsplash.com/@novantino?utm_source=medium&utm_medium=referral) 拍摄的照片

*本文最初发表于*[https://www . magalix . com/blog/basics-of-securing-your-kubernetes-cluster](https://www.magalix.com/blog/basics-of-securing-your-kubernetes-cluster)

# 如何处理安全话题？

当谈到[云原生](https://www.magalix.com/blog/defining-cloud-native-apps-and-why-you-should-care)技术时，许多人陷入了忽视安全性的*陷阱。他们错误地认为，既然他们的应用程序托管在其他人的数据中心，那么*其他人*应该采取所有必要的预防措施来保护他们的业务免受数字攻击。虽然这种假设有一定的道理，但我们必须在安全方面对您(客户端)和云提供商处理的内容进行重要区分。例如，让我们假设您在 AWS (Amazon Web Service)的许多 EC2 实例上托管您的应用程序。以下是 AWS 负责的部分内容:*

*   确保 EC2 实例运行的底层基础设施足够安全，这样您就不会受到另一个用户拥有的另一个 EC2 实例的攻击。
*   采取所有必要的措施来保证没有人能够访问用于登录实例的私钥。

另一方面，AWS 不对以下情况负责(例如):

*   您的应用程序因 SQL [注入攻击](https://en.wikipedia.org/wiki/SQL_injection)而受损。代码写得很差，因此容易受到攻击。
*   应用程序的敏感部分使用弱密码或没有密码来保护用户的数据。因此，恶意攻击者将能够窃取和/或操纵这些数据，对您的业务造成损害。

以上只是一个过于简化的例子，说明了如果您没有像对待安全性那样认真对待它，会出现什么问题。此外，让第三方托管您的应用程序并不能保证您得到 100%的保护。这引出了一个重要的问题:

# “安全”到底有多安全？

如果你在网上搜索与安全相关的资料，阅读书籍，参加培训，你永远也找不到声称你能达到 100%安全水平的来源。原因很简单，没有什么是 100%安全的资源。所有信息安全专业人员都在努力实现的目标是让攻击者的工作变得更加困难。让我们以密码为例。十几年前，八个字符就足以被认为是强密码，MD5 是一种强大的哈希算法。但是现在，你可以通过使用[彩虹表](https://en.wikipedia.org/wiki/Rainbow_table)很容易地弄清楚 md5 散列密码最初是什么。解密 MD5 变得非常容易，以至于你可以在网上完成(你可以试试 https://www.md5online.org/md5-decrypt.html 的作为例子)。

所以，我想说的重点是，无论你如何努力，你只是暂时让攻击者的工作变得更加困难。您应该始终了解最新的安全实践、技术和建议。在这一系列文章中，我们将帮助您通过 [Kubernetes](https://www.magalix.com/blog/kubernetes-101-concepts-and-why-it-matters) 实现这一目标。因此，我们讨论 Kubernetes 组件的[配置，控制和限制对它们的访问。此外，我们还解释了如何确保您托管在集群上的代码不容易受到攻击，如何限制容器的行为，使它们不能被攻击者操纵。最后，我们讨论在 Kubernetes 集群中存储和检索凭证的推荐方法。](https://www.magalix.com/blog/kubernetes-configuration-management-101)

在本文中，我们首先讨论两个重要的防御原则:多层体系结构和最低特权方法。

# 多层架构

当你需要保护你的房子时，你会采取什么措施？

很自然，你会一直锁着前门，也许会安装一个警报系统，这样即使窃贼能够打开门，警报也会响起。你也可以采取额外的措施，比如不要把大量现金放在家里，而是把它们存在银行里。或者，你可以买一个保险箱，用来存放你的贵重物品。你为什么要这么做？事实上，当你决定如何保护你的房子和财产时，你是在遵循多层安全架构，即使你并不知道。让我们来看看您已经部署的层:

1.  门上的锁。
2.  警报系统。
3.  保险箱。

攻击者层 1:锁着的门层 2:报警系统层 3:安全

现在，如果攻击者能够破门而入，解除警报，他/她将很难打开保险箱。当然，可能会有人打开门，绕过警报，设法打开保险箱。但问题是这种情况发生的可能性有多大？

类似地，在设计 Kubernetes 集群安全性时，您不应该依赖单一的实践/安全层。

# 最低特权方法

让我们回到房屋安全的例子。你会把你的门锁设计成和打开保险箱的钥匙一样吗？当然不是。原因是，如果密钥丢失或被盗，它将只用于绕过一个安全层，而不是全部。所以，如果攻击者有门钥匙，他仍然需要想办法打开保险箱。如果他有保险箱的钥匙，他还是需要从前门进来。

如果我们将这个类比应用于软件，特别是 Kubernetes，你不应该授予一个组件比它实际需要的更多的特权。例如，入口控制器应该被授予对服务和名称空间的读取权限，但不应该能够修改它们。如果控制器遭到破坏，攻击者将拥有对其他组件的只读访问权限。

# 减少攻击面

在信息安全中，[攻击面](https://en.wikipedia.org/wiki/Attack_surface)是指攻击者进入系统的所有可能方式。那么，你认为只有一扇门的房子和有三个或四个门的房子，哪一个更容易受到窃贼的攻击？

入口指向的资源越多，就越容易受到攻击。在软件世界中，同样的原则仍然适用。假设您正在编写一个需要连接到外部 API 的 Python 应用程序。当您测试不同的 HTTP 访问方法时，您遇到了[请求](https://requests.kennethreitz.org/en/master/)库。然后，在使用了一段时间后，您认为这不是最好的方法，于是您选择了另一个模块。问题是你忘了从你的代码中删除**导入**请求行，这意味着尽管这个库没有被使用，它仍然对代码可用。现在，攻击者可以利用请求中的任何已知漏洞来危害您的应用程序。这种攻击可以通过简单地不导入您不使用的模块来轻松缓解。

让我们开始在 Kubernetes 上应用这些原则，从组件开始。Kubernetes 的核心是 API 服务器，所以让我们从它开始。

# 保护 API 服务器

API 服务器为 Kubernetes 控制器(和用户)提供了一个 REST 接口，以便与不同的集群组件进行交互。这是保护您的集群时要考虑的第一个也是最重要的核心组件。

默认情况下，API 服务器监听端口 8080 上的 HTTP 请求。如果您有这个默认配置，那么您和 API 服务器之间的所有通信都是以明文形式发送的。任何网络嗅探程序(例如 Wireshark)都可能泄露关于您的集群的敏感信息，包括应用程序设置(在 [configMaps](https://www.magalix.com/blog/the-configmap-pattern) 中)、机密等。如果您将集群作为云提供商的服务来运行，那么 API 服务器很可能已经在使用 TLS 上的安全端口 443 来加密通信。然而，您可以通过尝试向 API 服务器发送一个 HTTP GET 请求来检查是否是这种情况，并确保您*没有收到有效的响应。例如:*

curl -X 获取 apiserver:8080

如果您有一个有效的输出，那么您需要在启动 API 服务器时使用-unsecured-port = 0 来关闭该端口。请注意，Kubernetes 以后的版本可能已经弃用或完全删除了该选项，因此系统默认从安全端口 443 启动。在任何情况下，你都应该做这个检查。

作为参考，保护 API 服务器属于多层安全原则的范畴。我们应该保护的下一层是 kubelet 组件。

# 保护库伯勒

kubelet 是一个代理，位于集群中每个节点的顶部。它负责接收和执行针对节点上运行的容器的命令。为此，kubelet 有自己的 API 接口，通过 HTTP 请求接收指令。保护 kubelet 组件涉及到它自己的多个层:

*   **拒绝匿名访问:**我们需要确保除了经过身份验证的请求之外，不允许任何其他请求访问 kubelet。这可以通过在启动 kubelet 时设置— anonymous-auth=false 标志来实现。但是，这可能会阻止来自客户端(如 API 服务器)的合法请求得到执行。因此，在启动 API 服务器时，您还需要设置— kubelet-client-certificate 和 kubelet-client-key 标志。这些标志确保 API 使用一个证书向 kubelet 标识自己。
*   **授权所有请求:**首先确保对 kubelet 的所有请求都得到授权。这可以通过将—授权标志设置为一个[支持的值](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#authorization-modules)来实现，并确保它没有设置为 AlwaysAllow。
*   **限制 kubelet 的访问级别:**这属于我们之前讨论过的最低特权原则。kubelet 组件不应该能够控制其他节点上的容器和 pod。注意，这是在 API 服务器上完成的，而不是在 kubelet 本身。比如 kube-API server—enable-admission-plugins =…，NodeRestriction。
*   **禁用只读端口:**尽管这个端口(10255)在较新版本的 Kubernetes 中不再受支持，但您应该始终确保它没有打开(这取决于您运行的是哪个版本的 Kubernetes)。为此，您需要将-read-only-port = 0 添加到用于启动 API 服务器的标志集中。

# 固定 Etcd

etcd 是分布式数据库，包含集群正常运行所需的所有信息。如果攻击者能够获得对此数据库的写访问权限，他们就有效地控制了群集。以下启动标志将有助于降低与运行 etcd 相关的一些风险:

*   必须通过设置—证书文件和—密钥文件来启用 HTTPS 连接。
*   对 etcd 的访问必须仅限于授权请求。这可以通过设置-client-cert-auth = true 来实现。现在，任何客户端都必须提供有效的证书才能连接到 etcd。此外，您必须指示 etcd 如何验证客户端在尝试启动连接时提供的证书。这可以通过设置-trusted-ca-文件来指定用于签署证书的证书颁发机构来实现。
*   通过设置-auto-TLS = false 拒绝接受任何自签名证书。
*   将运行 etcd 的节点配置为在相互通信中也使用 HTTPS。这可以通过设置以下标志来实现:
*   — peer-client-cert-auth=true，拒绝不使用 HTTPS 并提供有效证书的请求。
*   — peer-auto-tls=false 以禁用自签名证书。
*   — peer-cert-file 用于建立安全连接的证书文件的路径。
*   —peer-key-将证书的密钥归档。它必须是未加密的。
*   — peer-trusted-ca-file 用于签署证书的可信证书颁发机构。

由于 API 服务器也与 etcd 通信，因此必须对它应用类似的配置，以便它可以通过 HTTPS 与 etcd 通信。

# TL；速度三角形定位法(dead reckoning)

*   安全性是一个非常重要的问题，绝对不能忽视，尤其是在生产环境中。
*   您永远无法达到 100%的保护级别。考虑到当前的硬件资源(最快的 CPU，计算机算法等)，你只会让攻击者的工作更加困难。).今天被认为是“防弹”的安全措施将在几年后(或更短时间内)很快过时。
*   安全性是通过多个角度实现的:多层架构、最低特权方法和减少攻击面。
*   这是讨论保护 Kubernetes 集群的最佳实践的系列文章的第一篇。在这一次，我们从加固核心 Kubernetes 组件开始。
*   核心组件包括 API 服务器、kubelet 和 etcd 数据库。它们中的每一个都有自己的一组控制其行为的标志。这些标志应该以减轻安全风险的方式设置。
*   核心组件之间常见的强化实践是对请求进行身份验证和授权。此外，应该始终通过 HTTP 使用 HTTPS 来加密不同组件之间的连接，并确保通过证书和证书颁发机构来验证身份。

*原载于 2020 年 1 月 13 日*[*【https://www.magalix.com】*](https://www.magalix.com/blog/basics-of-securing-your-kubernetes-cluster)*。*