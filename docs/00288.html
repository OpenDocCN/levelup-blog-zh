<html>
<head>
<title>Share LocalStorage/SessionStorage between different domains</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在不同的域之间共享本地存储/会话存储</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/share-localstorage-sessionstorage-between-different-domains-eb07581e9384?source=collection_archive---------0-----------------------#2018-12-22">https://levelup.gitconnected.com/share-localstorage-sessionstorage-between-different-domains-eb07581e9384?source=collection_archive---------0-----------------------#2018-12-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="18cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在多个域之间共享数据(例如一个auth令牌)可能有些困难，因为我们都知道所有浏览器端数据存储API(local storage、cookies等。)与一个特定的领域相关。</p><h1 id="fca2" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated"><strong class="ak">解决方案:</strong></h1><p id="1921" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">使用iframe将数据保存在localStorage中，然后其他域向iframe请求我们已经保存的数据。</p><p id="cd8d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">父窗口和iframe之间的这种通信可以通过postMessage API(<a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/API/Window/postMessage</a>)来实现</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ls"><img src="../Images/83df12d9a1a38f017216c99c4195eb87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u_TF6Ji1T-olEz-FoBd88Q.png"/></div></div></figure><p id="5602" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">实现:</strong></p><p id="af52" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">1-在iframe中创建一个侦听器，它保存在localStorage中传递的数据</p><p id="acad" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2-在iframe中创建一个监听器，将数据发送回去</p><p id="eeba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3-使用postMessage，我们从父节点调用iframe的保存功能</p><p id="ca46" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4-在任何其他域中，我们从iframe请求数据(使用postMessage并监听响应)。</p><h1 id="a175" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated"><strong class="ak"> Iframe代码</strong></h1><p id="1106" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">侦听消息事件，检查操作类型(保存或获取)。如果保存，则向LocalStorage添加一个项目，如果获取:使用postMessage返回数据</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="6946" class="mj kp it mf b gy mk ml l mm mn">const domains = [<br/>  "https://www.domain1.com",<br/>  "https://www.domaine2.com"<br/>]</span><span id="bd6e" class="mj kp it mf b gy mo ml l mm mn">window.addEventListener("message", messageHandler, false);</span><span id="484a" class="mj kp it mf b gy mo ml l mm mn">function messageHandler(event) {<br/>  if (!domains.includes(event.origin))<br/>    return;</span><span id="89da" class="mj kp it mf b gy mo ml l mm mn">  const { action, key, value } = event.data<br/>  if (action == 'save'){<br/>    window.localStorage.setItem(key, <!-- -->JSON.stringify(<!-- -->value))<br/>  } else if (action == 'get') {<br/>    event.source.postMessage({<br/>      action: 'returnData',<br/>      key,<br/>      JSON.parse(window.localStorage.getItem(key))<br/>    }, '*')<br/>  }<br/>}</span></pre><h1 id="88f3" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">另一个窗口代码将保存一个数据</h1><p id="de75" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">使用postMessage向iframe发送消息事件。</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="ff2a" class="mj kp it mf b gy mk ml l mm mn">const data = doSomeThingToGetData()<br/>const iframe = <!-- -->iframe = document.getElementById('iframe-id')<br/>iframe.contentWindow.postMessage({<br/>  action: 'save',<br/>  key: 'keyForData',<br/>  value: data<br/>})</span></pre><h1 id="07f1" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">现在，只要有一个窗口想要获取这些数据</h1><p id="7212" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">发送一个消息事件，并监听iframe将发回的消息事件。</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="f4c1" class="mj kp it mf b gy mk ml l mm mn">const iframe = <!-- -->iframe = document.getElementById('iframe-id')<br/>iframe.contentWindow.postMessage({<br/>  action: 'get',<br/>  key: 'keyForData'<br/>})</span><span id="e99b" class="mj kp it mf b gy mo ml l mm mn">window.addEventListener("message", messageHandler, false);</span><span id="6d53" class="mj kp it mf b gy mo ml l mm mn">function messageHandler(event) {<br/>  const { action, key, value } = event.data<br/>  if (action == 'returnData'){<br/>    useData(key, value)<br/>  }<br/>}</span></pre></div></div>    
</body>
</html>