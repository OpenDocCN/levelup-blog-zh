# 云安全桌面练习

> 原文：<https://levelup.gitconnected.com/cloud-security-table-top-exercises-629d353c268e>

![](img/05c341fd3efbdf354c81e4a92abb7ede.png)

对于安全团队来说，云是一个不断发展的、有时甚至是充满敌意的环境。即使是设计最完善的安全程序也可能成为新的攻击媒介、复杂的多阶段攻击活动，甚至是简单的误配置的牺牲品。

与灾难恢复计划一样，如果没有定期审查、实践和更新，云安全响应流程是没有用的。在理想情况下，这是安全、法规遵从性、基础架构和运营团队的跨团队工作，每季度进行一次。

尽管尽了最大努力，但以前没有实践过的新情况随时可能出现。对于安全团队来说，经常会面以创建未知情况的响应程序是很重要的，这种情况下，当检测到可疑活动或已知存在危害，但响应团队没有预定义的 sop。

下面许多场景的最初“答案”可能是“日志！”但是我鼓励你进一步思考——哪些日志？他们被送往哪里？你的安全小组能接触到它们吗？什么是保留策略？找到日志后你会怎么做？您是否有简单的方法来提取所需的安全信息？(顺便说一下:你可能会发现我以前的帖子[如何在现有的每个 AWS 服务上启用日志记录(大约 2021 年)](https://matthewdf10.medium.com/how-to-enable-logging-on-every-aws-service-in-existence-circa-2021-5b9105b87c9)，在评估 AWS 中的日志记录配置时很有帮助)。

下面的桌面练习旨在开始对话。不是所有的都适用于每一种环境。对一些人来说，标准作业程序可能已经到位。无论如何，我建议至少考虑攻击媒介的可能性，并制定一个应对计划。

# 恶意 VPC 对等请求

> **场景**:攻击者通过意外发布的文档在你的 AWS 账户中发现了 VPC 的 VPC ID，并请求 VPC 对等。您的一个用户认为这是一个合法的请求，并接受了对等连接，包括按照定义的过程创建到您的后端资源的路由。

**注意**:虽然这种攻击需要多层防御才能失败，但它确实提出了一个问题，即如何管理入站 VPC 对等请求，哪些用户有权接受它们，以及您的中央安全团队是否可以轻松地创建所有对等帐户的映射，以轻松识别不属于同一组织的帐户的外部连接。

# 妥协的λ层

> **场景**:你的团队使用的一个[第三方 Lambda 层](https://github.com/mthenw/awesome-layers)被攻破，注入了恶意代码。因为该层不是您的构建过程的一部分，所以您的构建时安全扫描不会检测到恶意负载。

**注释** : Lambda 层存在独特的安全风险。像所有来自不可信来源的代码一样，应该定期扫描和审计。

# 注入的云形成模板

> **场景**:匿名用户的 S3“读”和“写”ACL 被意外地添加到了用于存储 CloudFormation 模板的 S3 桶中，作为构建管道的一部分。恶意用户一直在复制这些模板，并向堆栈中注入恶意资源类型，如跨帐户 admin IAM 角色。

**注意**:这里有很多东西需要解开——S3 桶安全性、对您的构建机器的访问，以及对您的云构建堆栈所部署的资源的事件级监控。

# 破碎的云迹日志

> **场景**:一个有事业心的开发者在 cloudtrail 使用的 S3 桶上看到了“PutObject by CloudTrail . Amazon AWS . com”的政策，认为这是一个错误，将其删除，现在 cloud trail 日志已经被破坏了 6 个小时。

**注意**:除了 CloudTrail 使用的 S3 存储桶的权限应该受到严格限制之外，这个场景还提出了一个重要的问题:如何检测日志何时丢失*？当某些事件发生时配置警报是相当容易的，但是当*没有*事件发生时呢？虽然这可能看起来微不足道，但在初始部署过程中，这类警报往往会被忽略。*

# *一个神秘的 EC2 实例*

> ***场景**:一个名为“temp-do-not-delete”的 c5.xlarge AWS EC2 实例被发现运行在一个您的开发人员从未使用过的区域。没有人知道它是从哪里来的，但它的 CPU 在过去的 4 周内已经达到了 100%的极限。经进一步检查，发现该实例正在挖掘比特币。*

*注释:这种攻击在过去几年中已经反复出现。这种情况会对您的监控流程(尤其是在未使用的区域)以及库存管理和基于主机的安全控制提出问题。*

# *公共 AMI 上的恶意软件*

> *场景:你的几个开发团队使用的一个公共 AMI 在一次常规的恶意软件扫描中触发了一个肯定的结果。你的团队声称这个 AMI 已经使用了几个星期，更糟糕的是，基于这个图像已经创建了各种其他 AMI。*

***注意**:当然，公共 ami 应该总是被视为不可信的代码，但是当映像是基于以前的映像构建时，这个问题会成倍增长。不幸的是，没有简单的方法来查看给定 AMI 的祖先树，因此跟踪该漏洞的潜在影响将需要通过 CloudTrail 日志进行一些复杂的调查，可能会跨越多个帐户。*

# *奇怪的应用程序行为*

> ***场景**:由于短时间内“s3:DeleteObject”呼叫的数量增加，您的待命安全工程师在周六凌晨 1 点被传呼。在快速调查之后，工程师确定:1)存储桶没有启用版本控制，因此删除调用是不可逆的，2)存储桶似乎包含敏感的用户数据文件，这些文件是正在运行的应用程序的一部分，3)与该存储桶交互的应用程序需要“DeleteObject”权限作为其标准功能的一部分，但是删除率突然从 100/小时上升到 100，000/小时以上。*

***注意**:有时候最难调试的安全问题涉及到应用程序级别的异常。在这种情况下，什么构成了“正常”的“删除对象”调用率？应用程序只是收到了一个流量峰值，还是存在实际的安全隐患？在许多情况下，安全工程师可能需要让应用程序团队的其他待命工程师参与进来，这将使补救时间表变得复杂。如果怀疑存在安全漏洞，您的安全待命人员是否拥有适当的决策工具(和权限)来潜在地破坏生产应用程序？*

# *公共 AWS 密钥和机密*

> ***场景**:一个具有超级用户级别权限的 AWS 访问密钥和秘密被意外地提交给了一个公共位存储库。提交密钥的工程师很快恢复了提交，并且没有报告事故。然而，他忘记了这些密钥保留在 Git 历史中。这些密钥仅在一周后由您的安全团队进行深度搜索扫描时被发现并擦除。受影响的帐户中似乎没有任何可疑活动。*

***注意**:密钥的意外泄露是一种极其常见的云安全事件，在大型组织中几乎肯定会以令人沮丧的频率发生。您的安全团队应该有一个处理这些情况的清晰记录的流程。公开暴露特权凭证集类似于度假时不锁前门；即使你回到家，似乎什么都没被碰过，你也永远无法摆脱有人在你家的感觉。*

# *快速升级的 DDoS*

> ***场景**:一个关键应用程序 API 开始接收来自随机地理位置的流量峰值。每过一个小时，交通流量就增长 100%。到目前为止，您的自动扩展小组已经能够水平扩展您的后端实例来处理明显的 DDoS，应用程序负载平衡器似乎没有受到影响，但您的应用程序团队担心不断增长的成本和停机的可能性。您的组织当前没有订阅 AWS Shield。*

***注意**:DDoS 攻击对任何团队来说都是令人担忧的可能性，但是随着这些攻击的规模和频率的增长，应该提前计划好适当的响应。需要评估应用程序基础架构的所有级别，从 DNS 和负载平衡器到自动扩展组和策略以及监控。此外，应该有一套经批准的工具，如 AWS WAF 和 Shield，可以在此类攻击中加以利用。DDoS 攻击的中期并不是试图获得财务部门批准每月 3000 美元服务的理想时机。*

# *与无法识别的帐户 ID 共享的资源*

> ***场景**:在调试包含敏感客户数据的 RDS 数据库的问题时，一名工程师发现 7 天前的自动备份已被她不认识的 AWS 帐户 ID 共享。她向您的安全团队报告了该事件，但安全团队无法在贵组织拥有的 500 个帐户中找到该 AWS 帐户。*

***注意**:虽然这个事件可能是一个意外——一个输入错误的帐户 ID，或者一个尚未记录在您组织的 wiki 中的新帐户——但它也可能代表了一种危害。即使没有恶意意图的证据，您是否需要通知您的客户潜在的数据泄露？您有日志证明这个未知帐户从未访问过共享备份吗？你能证明你现有的某个用户或角色没有恶意共享备份吗？*

# *外国的根帐户使用*

> ***场景**:您组织的策略是在所有根用户帐户上启用 MFA，将密码和 MFA 资料锁在脱机保险箱中，并使用 IAM 角色进行日常管理。然而，就在刚才，您的安全团队收到了一个警报，您的一个 AWS 帐户的 root 帐户被从塞浦路斯访问。你在塞浦路斯没有雇员。*

*在我们所有的场景中，时间都是至关重要的，但也许没有什么比这个场景更重要了。当您的安全团队触发、读取并处理此警报时，很可能潜在的攻击者已经通过后门进入您的帐户，并可能禁止您的访问。如何将此帐户与其他未受影响的帐户隔离开来？您是否有随时可用的信息来启动 AWS 帐户恢复？您知道该帐户可以访问的其他哪些系统可以被暂时阻止吗？*

# *SSRF 漏洞和暴露的实例凭据*

> ***场景**:在一次例行的内部测试中，你的应用安全团队在一个 EC2 实例的自动缩放组中运行的应用中发现了一个 SSRF 漏洞。您的云安全团队已经介入，并且能够确认“http://169.254.169.254”端点受到影响，并且可以从公共互联网获得该实例的安全凭证。*

***注释**:如果这个场景听起来很熟悉，那是因为它是过去几年中几起高调的安全漏洞的根本原因。您需要结合应用程序级和基础设施级的访问日志来全面调查这个问题。这也是探索 [IMDS v2](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html) 的绝佳时机。*

# *赎金的 AWS 账户*

> ***场景**:您团队中的一名工程师收到一封明显的勒索邮件。主题为“我们可以访问您的帐户…”消息来自一个勒索软件组织，声称已经侵入了您的一个生产 AWS 帐户。他们列出了帐户 ID，并包括一个准确的、相当近期的“EC2 实例”页面截图作为证明。没有提供太多其他信息，但他们提到，如果他们在接下来的三个小时内没有在提供的地址收到十个比特币，他们将永久删除所有资源。*

***备注**:我怀疑很少有组织能够很好地处理这种高度紧张的情况。虽然有可能尝试恢复并保护有问题的 AWS 帐户，但提供的时间范围太紧，无法进行完整的审计并保证攻击者没有多种访问方法。希望您的组织拥有 AWS 的业务级支持，并可以与他们合作，以正确锁定或保护帐户，直到全面调查完成。*

# *影子 AWS 帐户*

> ***场景**:你的财务团队提醒你，在过去的几个月里，他们发现几个员工的信用卡上有来自“AMAZON WEB SERVICES”的信用卡费用。这些费用似乎来自没有遵循正确供应流程的 AWS 帐户。在询问了拥有信用卡的员工后，发现在这些环境中至少有三个关键的生产服务在运行。*

***注意事项**:有些安全问题是技术问题，有些是流程问题。这个场景很大程度上是一个过程。为什么员工要用自己的信用卡开户？您当前的资源调配流程是否过于繁琐？它阻碍了发布时间表吗？您能否与财务部门合作，防止 AWS 在员工个人卡上收费？*

*无论如何，您现在必须处理将这些“次要”客户整合到您现有的基础设施中。鉴于这些客户是在标准流程之外创建的，您将如何确保他们遵循所有正确的入职流程？您是将基础架构“提升并转移”到批准的客户中，还是尝试按原样合并这些客户？*

# *零日容器漏洞*

> ***场景**:RunC 宣布了一个新的零日 CVE，影响了您的 EKS 容器环境中的主机。您有超过 50，000 台主机需要尽快修补。同时，您需要监控正在运行的主机是否有泄露的迹象，因为 CVE 现在已经运行了至少 6 个小时。*

***注意**:根据您的容器环境是单租户还是多租户，您可能会遇到大问题或者更大的问题。这个特定的场景提出了一些问题，包括基础设施更新的测试部署速度有多快，以及容器、主机及其对应的云环境(IAM 访问、下游资源等)的测试部署速度有多快。)可以在预打补丁期间进行监控。您是否能够监控、快速检测和缓解来自可能受到危害的主机的非预期 IAM 访问，尤其是在做出了在修补完成之前不关闭应用程序的业务决策的情况下？*

# *悬空路由 53 资源*

> ***场景**:您收到一份来自安全研究员的关于 HackerOne 的报告，声称贵组织的一个子域正在提供恶意软件。有问题的子域似乎是几个月前被否决的项目的一部分。经过进一步的调查，您发现这个子域指向了一个 S3 存储桶，您的应用程序团队称这个存储桶作为弃用的一部分被删除了。尽管如此，该域似乎是活跃的，并提供流量，所以 S3 桶必须仍然活跃…在某处。*

***注意**:这是 AWS 中一个众所周知的安全问题，因为 S3 的全球命名空间。创建一个 Route53 记录，将其指向一个 S3 存储桶，删除该存储桶但不删除记录，攻击者就可以在自己的帐户中创建相同的存储桶来服务来自您的域的流量。清理相当简单(删除桶)，但声誉损害可能会持续。*

# *被收购的公司没有云安全政策*

> ***场景**:你的业务开发团队通知你，在明天早上财务季度开始时，你的公司将宣布它收购了一个较小的竞争对手。您将负责他们的云基础架构的集成和安全性。在与小型团队会面后，您发现他们没有任何合适的云安全策略；他们的账户对开发者来说是免费的。你现在的工作是驯服这种环境，使之符合你公司的政策。*

***注释**:这是一个难以置信的复杂情况，涉及业务、安全、运营和其他部门。您可能会在我之前写的一篇文章中找到一些有用的建议:[所以您继承了一个 AWS 帐户](https://medium.com/swlh/so-you-inherited-an-aws-account-e5fe6550607d)。*

# *增加 SES 跳出率*

> ***场景**:营销团队给你发了一封紧急邮件，声称客户没有收到他们批准的营销邮件。您的组织使用 AWS ses 发送电子邮件，在检查 SES 控制台后，发现您当前的跳出率已增长到 10%。令人怀疑的是，发送率也从之前的 50，000 英镑/天增加到了 1，000，000 英镑/天，几个小时前骤降至 0 英镑。营销部门没有人声称发送了如此大量的电子邮件，但似乎 AWS 现在已经暂停了您的 SES 访问。*

***注意事项**:从安全角度来看，您的首要任务应该是确定这实际上是否是一个安全事件。营销团队的凭证或发送平台本身是否受到威胁？您与 SES 一起使用的 AWS 帐户或该帐户中的用户是否受到威胁？或者这只是营销团队使用的脚本出错的一个案例。这也是检查您的联系方式是否在 AWS 中保持最新，以及您的 se 发送指标是否得到适当监控的好时机。*

# *过度特权化的跨环境詹金斯*

> ***场景**:年度合规性审计显示，您的一个应用程序团队一直在使用部署在开发帐户中的 Jenkins 实例，使用高特权凭证将基础架构部署到他们的开发、暂存和生产 AWS 帐户。更糟糕的是，这台构建机器运行的是一个已知 CVE 的旧版本的 Jenkins。*

***注意**:除了改进对开发人员的培训，构建机器通常是您环境中最有特权的机器。因此，它们需要更加严密的保护，不应该面向互联网，并且应该保持最新的安全补丁。您的组织有负责管理构建机器环境的团队吗？你有没有特别的账户(也许是更仔细监控的账户)来存放这些构建机器？为什么这种面向公众的机器没有被更早地发现？*

# *曝光过度的数据库*

> ***场景**:一个应用数据库被部署在一个公共子网中，由于使用安全组来限制访问，该数据库先前被给予了安全“豁免”。但是，后续审查发现，包含 CIDR 块的该组中的规则有所增长，现在已经超出贵组织拥有的网络空间几千个 IP 地址。没有检测到恶意活动。您的应用程序团队要求简单的补救措施，因为您组织的 IP 地址空间超过了安全组允许的规则数量。*

***注意**:随着您组织的成长，您可能会发现以前可以接受的安全解决方案现在已经过了保质期。安全组是一种常见的服务，裂缝就在这里开始出现。首先，添加一些包含单个 IP 地址的规则。然后，当需要添加的 IP 地址列表超过 60 个(允许添加到安全组的最大规则)时，会创建更多的组(组 a、组 b 等等)，每个组有 60 个 IP。最终，该策略失败，CIDR 数据块被添加(54.16.1.0/24、54.16.2.0/24 等)。*

*当您达到这一点时，规则很容易意外地与您的组织实际上并不拥有的网络空间重叠(可能您拥有 54 . 16 . 1 . 1–54 . 16 . 1 . 128，但不是 54.16.1.129 和更高版本，54.16.1.0/24 过度暴露了您的资源)。您的安全团队需要能够对“我如何安全地允许来自我们组织的 IP 地址的访问？”这一问题给出明确的答案*

# *结论*

*根据您的云安全成熟度以及您的组织和云环境的规模，上述场景可能看起来像是办公室中的又一天，或者是一系列结束业务的安全事件。*

*在匆忙实施特定工具或购买第三方产品来应对这些场景之前，为您的组织使用云实施定义良好的安全策略至关重要。只要正确遵守一套严格的指导原则和控制措施，经常对您的安全和工程团队进行培训，并对所有云活动保持警惕，上述许多情况都是可以预防或快速补救的。*

*对于剩余的“黑天鹅级别”安全事件，针对未知的适当程序，以及定义良好、经过实践的流程可能有助于防止孤立事件演变成安全灾难。对于大多数组织来说，高度复杂的云攻击的问题不是“如果”，而是“何时？”*