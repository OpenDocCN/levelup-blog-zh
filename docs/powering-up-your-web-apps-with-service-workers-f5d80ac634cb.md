# 由服务人员启动您的 Web 应用

> 原文：<https://levelup.gitconnected.com/powering-up-your-web-apps-with-service-workers-f5d80ac634cb>

![](img/5ff3956f5685348200de163d4a03a051.png)

意大利波西塔诺

# 概述

今天的 web 应用程序是建立在广泛的用例之上的，远远不是服务于静态文档。

我们正处于这样一个阶段，一个应用程序可以作为基于 web 的软件，具有本地应用程序的功能集。这些增强的应用被称为[渐进式网络应用](https://web.dev/progressive-web-apps/) (PWAs)。

PWA 的一个重要方面是服务人员。服务人员不亚于一个 Javascript 脚本，它运行在浏览器的后台，充当服务器和浏览器之间的代理。这使您的应用程序能够在没有任何网络连接的情况下运行，这要归功于缓存以及其他一些有用的功能，如:

*   后台同步
*   缓存控制
*   推送通知
*   网络请求拦截

渐进式 web 应用程序的目的是在作为 web 应用程序使用时，为用户提供使用服务人员等工具的原生应用程序体验。

> 渐进式网络应用(PWA)通过现代 API 进行构建和增强，以提供增强的功能、可靠性和可安装性，同时通过单一代码库在任何设备上*向任何人、任何地方提供服务。*
> 
> ——Sam Richard 和 Pete LePage 在 [web.dev](https://web.dev/what-are-pwas/)

# 什么是服务人员？

服务工作者是与您的应用程序并行运行的 Javascript 工作者。它充当 web 应用程序和您发送请求的服务器之间的附加层。然而，这种情况造成了一些限制，我也想在这一部分展开。

首先，服务人员不能直接访问 DOM 树，因此不能操作 web 页面及其 HTML 元素。您被限制通过消息与您的网页进行通信(参见 [MessageChannel API](https://developer.mozilla.org/en-US/docs/Web/API/MessageChannel) )。

此外，服务人员完全异步操作，并且严重依赖[承诺](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)。因此，您不能使用像`localStorage` API 这样的同步 API。

当服务工作者不被使用时，它被浏览器停止以减少资源使用。服务人员保持空闲状态，直到需要进行任何进一步的操作。如果有请求，浏览器将重新激活服务人员。在此过程中，服务人员保存的任何状态都将丢失。因此，在服务工作者内部存储任何状态都是有风险的，应该避免。

web 应用程序一次只能有一个活动的服务工作线程。但是有可能安装了两个服务人员。例如，当新版本的服务人员正在等待旧版本的服务人员被终止时，就会出现这种情况。这可能会导致一种误解:以前的(仍在运行的)工作器正在提供缓存的资产，但是您期望更新的服务工作器版本已经在提供服务，从而提供最新的资产。然而，有一些方法可以防止这种行为，这些方法将在*任何挑战中介绍。*一节。

由于服务人员能够拦截和修改网络请求，这可能导致巨大的安全漏洞，他们只能通过 HTTPS 分发。但是有一个例外: **localhost** 。因此，您可以在本地开发环境中轻松地与服务人员一起工作。

在 [Chrome](https://developers.google.com/web/tools/chrome-devtools/progressive-web-apps#service-workers) 和 [Firefox](https://developer.mozilla.org/en-US/docs/Tools/Application/Service_workers) 中，你可以通过进入*应用*标签，轻松查看和控制已安装的服务人员。

# 浏览器兼容性

所有现代浏览器(Chrome、Firefox 和 Safari)都支持服务人员。请参见[我可以使用…](https://caniuse.com/serviceworkers) 了解详细概述。

您可以通过检查`serviceWorker`属性的存在来探索服务工作器 API 的可用性:

```
if ('serviceWorker' in navigator) {
    // service worker supported
}
```

# 生命周期

与服务人员合作时，您必须了解其生命周期的各个阶段。这些阶段确保您不会遇到与多个版本的服务人员的任何冲突。

## 登记

您必须先注册 web 应用程序，然后才能使用服务人员。这是整个生命周期的主要起点。在此阶段，浏览器将尝试下载并解析服务人员。成功注册将触发下一步:安装。

## 装置

当注册的服务工作者与已经安装的服务工作者不匹配时(按字节比较)，浏览器将安装它。您可以使用安装阶段来缓存静态资产。成功安装后，如果之前没有注册，它将被激活，或者只要前一个服务人员被终止。

## 活跃的

一旦服务人员处于活动状态，它就能够处理请求、对消息做出反应、运行后台同步并发送通知。您也可以使用这个阶段来清除当前缓存。

## 闲置的

当服务工作者不再处理请求和其他任务时，它切换到空闲状态。

## 终止的

当服务工作者保持在空闲状态达特定时间时，浏览器将终止它以减少资源消耗。这将给予较新版本的服务工作者接管控制并被激活的机会。

# 有挑战吗？

众所周知:*权力越大，责任越大*。service worker API 丰富而强大的特性集带来了一些我们必须意识到的挑战。

最大的挑战是管理给定服务人员的不同版本。因为新注册的服务人员不会直接替换当前安装的服务人员。它将一直等到现有的服务工作者停止为其所有客户端提供服务。

当您想要替换损坏的服务工作线程，或者当您想要更改它从缓存中提供的文件时，这可能会导致问题。

第一个问题是:你不能只创建一个新的、更新的服务工作者文件，并为你的 web 应用程序注册/安装它。由于现有的服务工作者仍将提供缓存的网页，而不是具有新创建的服务工作者文件的网页，因此浏览器不会识别更新的版本并安装它。因此，您总是必须更新现有的服务工作者文件，这将导致下一个问题。

当您通过添加新的或固定的功能或更改缓存的文件来更新现有的服务工作程序时，您会遇到这样的问题:更新的服务工作程序将等待当前服务工作程序终止。

一个解决方案可能是使用`self.skipWaiting()`。这可以在安装阶段触发，并会强制更新后的服务人员激活并接管控制权。请记住，所有这些操作都是异步运行的，因此可能会导致以下情况:旧的服务已经为缓存的资产提供了服务，但是通过调用`self.skipWaiting()`激活的新的 worker 正在新的/更新的资产上运行逻辑。

总而言之，在更新现有服务人员时，您必须小心谨慎。你应该试着发布相互依赖的版本，或者至少在你的服务工作者的前一个版本仍然服务于缓存的资产时不会引起任何麻烦。如果它适用于您的 web 应用程序，您可以通过调用服务工作者注册上的`[update()](https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/update)`方法来手动运行浏览器的刷新。

# 入门指南

我们将构建一个由服务人员提供服务和缓存的简单网页。所以让我们从一个简单的 HTML 网页开始(*index.html*):

该网页仅包含一个标题和一个主元素，以及一个脚本标记，我们现在将在这里注册我们的服务人员:

首先，我们检查给定的浏览器是否支持服务工作者 API。如果是这种情况，我们为特定的范围注册服务工作者脚本。

范围声明限制了工人对 web 应用程序的某个部分的访问。在我们的示例中，我们配置服务工作者来处理请求，这些请求需要位于服务工作者当前目录及其下所有目录中的资源。

接下来，我们应该为我们的服务人员添加一些缓存功能。因此，让我们转到我们的`service-worker.js`文件，为`install`事件添加一个事件处理程序。

事件处理程序使用特定的自定义名称打开缓存，并将所有需要的文件存储在其中。

因此，一旦安装了服务人员，所有文件都存储在缓存中。但是现在，当客户请求这些文件时，它们不会被提供。要解决这个问题，我们得听听`fetch`事件。每当客户端从 URL 请求资源时，都会调度事件。

一旦`fetch`事件到来，服务人员将尝试用

*   要么是缓存的文件(如果它能在缓存中找到它)
*   或者它将从 URL 获取它

让我们通过服务我们的网页并关闭网络连接来看看缓存功能的运行情况:

![](img/8eee4f8bc97a1dcd5ab913ffe50bd709.png)

在 Chrome DevTools 中将网络连接设置为“离线”

刷新网站，仍然会提供网页。当我们检查网络选项卡时，我们看到我们的网页没有被下载，而是由服务人员提供服务。

![](img/8c883404807cfa1948ae7c021ee78743.png)

Chrome DevTools 网络标签

我们已经通过使用服务工作者 API 为我们的网页实现了一个简单的缓存功能。下一步可能是实现后台同步，以防客户端失去连接并重新联机，或者在运行长期任务后向网页发送消息。

您可以在此找到完整的示例应用程序:

[](https://github.com/j-sommer/service-worker-starter) [## j-Sommer/服务人员-初学者

### 用于服务人员开发的简单示例 web 应用程序 GitHub 是 5000 多万开发人员的家园，他们一起工作…

github.com](https://github.com/j-sommer/service-worker-starter)