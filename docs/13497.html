<html>
<head>
<title>As a Programmer, You Should Know What the Essence of Process Switching Is.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">作为一个程序员，你应该知道进程切换的本质是什么。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/as-a-programmer-you-should-know-what-the-essence-of-process-switching-is-cf1774b3a233?source=collection_archive---------18-----------------------#2022-09-08">https://levelup.gitconnected.com/as-a-programmer-you-should-know-what-the-essence-of-process-switching-is-cf1774b3a233?source=collection_archive---------18-----------------------#2022-09-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/0ebd7ab43bcd223db84972fe10dc1357.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PkrETHeuo4wd8FMw"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@brookecagle?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">布鲁克·卡吉尔</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="69ec" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们都知道操作系统最重要的功能之一就是多任务能力，可以运行超过<code class="fe le lf lg lh b">CPUs</code>数量的程序。为了实现这个功能，它必须能够在多个进程之间分配有限的<code class="fe le lf lg lh b">CPU</code>资源。从程序员的角度来看，我们的程序一直在运行，但从<code class="fe le lf lg lh b">CPU’s</code>的角度来看，程序实际上是“走走停停”的。当程序开始和停止时，就涉及到切换的过程。那么流程切换的本质是什么呢？</p><p id="8f0f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本质上，函数调用和进程切换非常相似，人们可能会想，这怎么可能呢？别急，看完这个你就明白了。</p><h1 id="b9b0" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">函数调用</h1><p id="55c2" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">我们先来看看函数调用。函数调用是这样的。当<code class="fe le lf lg lh b">B function</code>被执行时<code class="fe le lf lg lh b">A function</code>调用<code class="fe le lf lg lh b">B function.</code>，它将跳回<code class="fe le lf lg lh b">A function</code>(此时<code class="fe le lf lg lh b">A function</code>和<code class="fe le lf lg lh b">B function</code>在同一进程中)</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="fc32" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">过程是这样的</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/290a6a1c79a6bb59fec6051e450e3b81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*Pesu458nyYVoGELvryVslg.png"/></div></figure><p id="849d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">function B</code>执行完成后，控制权将转移到<code class="fe le lf lg lh b">A</code>。所谓控制权是指告诉CPU继续执行<code class="fe le lf lg lh b">function A</code>。</p><p id="868d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是你有没有想过<code class="fe le lf lg lh b">function A</code>调用<code class="fe le lf lg lh b">function B</code>，当<code class="fe le lf lg lh b">function B</code>执行完毕的时候<code class="fe le lf lg lh b">function B</code>一定要跳回<code class="fe le lf lg lh b">function A</code>？不一定，既然<code class="fe le lf lg lh b">function B</code>可以把控制权转移给<code class="fe le lf lg lh b">A</code>，那么它也可以把控制权转移给<code class="fe le lf lg lh b">function C</code>。</p><p id="6829" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">听起来很神奇，不是吗？<code class="fe le lf lg lh b">A function</code>调用<code class="fe le lf lg lh b">B functio</code> n，当<code class="fe le lf lg lh b">B function</code>被执行时，可以跳转到<code class="fe le lf lg lh b">C function</code>，但是如何做到这一点呢？让我们来看一段神奇的代码。</p><p id="417a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一段神奇的代码</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="7797" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">想想这段代码运行时的输出？</p><p id="8954" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有的同学可能会说，主函数调用<code class="fe le lf lg lh b">funcA</code>，<code class="fe le lf lg lh b">funcA</code>函数调用<code class="fe le lf lg lh b">funcB</code>，<code class="fe le lf lg lh b">funcB</code>函数看起来就是一堆作业。执行完成后返回<code class="fe le lf lg lh b">funcA</code>，<code class="fe le lf lg lh b">funcA</code>返回主函数，所以执行后不会输出任何东西。</p><p id="f1f8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">是这样的吗？我们编译运行一下吧(我用的是GCC 5 . 2 . 0版，64位机，没有启用编译优化，不同编译器版本运行效果可能不一样)。</p><pre class="ml mm mn mo gt ms lh mt mu aw mv bi"><span id="b636" class="mw lj it lh b gy mx my l mz na">$ ./a.out<br/>jump to funcC !!!</span></pre><p id="9c1a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">可能有人会惊讶，这怎么可能？</p><p id="3927" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这一段没有调用<code class="fe le lf lg lh b">funcC</code>，但是为什么会运行<code class="fe le lf lg lh b">funcC</code>函数？</p><p id="50e6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">程序员常说“<strong class="ki iu">代码</strong>里没有秘密”，这句话不完全对，应该是“机器指令里没有秘密”，后来我想了想，这句话也不完全对，因为对于我们来说<code class="fe le lf lg lh b">CPU</code>如何执行机器指令是一个黑盒。我们只能从一般原理上讲出<code class="fe le lf lg lh b">CPU</code>是如何执行一条机器指令的，但这里真正的细节只有<code class="fe le lf lg lh b">intel/AMD</code>等处理器厂商知道。而有些魔鬼就在这些细节里。</p><h1 id="3ac9" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">魔鬼细节</h1><p id="dc33" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">现在，让我们回到本文的主题，首先看看生成的机器指令是什么样子的:</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="72a2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些说明在说什么？</p><p id="04a8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们首先看看普通的函数调用</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nb"><img src="../Images/9639748ab3530ae0de584a2f2f733ef5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f0chB-WPN5IJrqS4ecU0xA.png"/></div></div></figure><p id="1c56" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当<code class="fe le lf lg lh b">function B</code>执行完毕时，此时的堆栈帧为</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nc"><img src="../Images/e35d40599f4aab0855a1dbe4c0640c6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qi7A0YE2IDWD-R-28ai-hg.png"/></div></div></figure><p id="b15b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">function B</code>的最后一条机器指令通常是:<code class="fe le lf lg lh b">ret</code>。该指令的目的是将当前栈顶的内容弹出到<code class="fe le lf lg lh b">%rip</code>寄存器中。<code class="fe le lf lg lh b">CPU</code>将从内存中取出指令，并根据rip中的值执行。<code class="fe le lf lg lh b">ret</code>指令会将之前保存的返回地址放入rip寄存器，以便<code class="fe le lf lg lh b">CPU</code>可以继续执行<code class="fe le lf lg lh b">A function</code>中的后续代码，即<code class="fe le lf lg lh b">++a</code>行代码。</p><p id="0420" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">可能有人看到了，如果我们有办法修改<code class="fe le lf lg lh b">A stack</code>帧上的返回地址，不就可以实现“打到哪里”了吗？</p><p id="4f21" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">*(p+2) = (long)funcC</code>在代码中，这一行将原本指向funcB的返回地址修改为指向<code class="fe le lf lg lh b">funcC</code></p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nd"><img src="../Images/1d541362aa597b2d13c8ad2c84428aeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*khhSR3OHSrt8diuQWKa72g.png"/></div></div></figure><p id="8e13" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这样，当funcB函数完成后，会直接跳转到<code class="fe le lf lg lh b">funcC</code>函数，从而实现可控的执行流程切换。进程切换的本质与此相同，只是进程切换需要将<code class="fe le lf lg lh b">stack</code>(和地址空间)一起切换。切换过程的上下文也被保存。</p><p id="47d1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">可能有人看到了，上面的进程叫做缓冲区溢出攻击，要达到的目的和进程切换是一样的:实现控制权的转移，但缓冲区溢出攻击是非法的，不符合预期(符合黑客的预期，但不符合<code class="fe le lf lg lh b">OS</code>设计师制定的游戏规则)，而进程切换是合法的，是预期的(符合<code class="fe le lf lg lh b">OS</code>设计师的预期)。</p><p id="22a7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">而且有时候，黑客(真正意义上的)和<code class="fe le lf lg lh b">OS</code>设计师是一堆人。</p><p id="9790" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">好了，现在你应该对进程切换有了更直观的认识。</p><h1 id="0d90" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">最后</h1><p id="b8a3" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated"><strong class="ki iu">感谢阅读。</strong>我期待着<strong class="ki iu"> </strong>您的关注和阅读更多高质量的文章。</p><div class="ne nf gp gr ng"><div role="button" tabindex="0" class="ab bv gv cb fp nh ni bn nj jz ex"><div class="nk l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw nl nm fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l nl nm fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----cf1774b3a233--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="np nq gw l"><h2 class="bd iu tz ou fp ua fr fs ub fu fw is bi translated">更好的编程</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi uc au ud ue uf qj ug an eh ei uh ui uj el em eo de bk ep" href="https://medium.com/@omgzui/list/better-programing-9b4c9bb174aa?source=post_page-----cf1774b3a233--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="uk l fo"><span class="bd b dl z dk">108 stories</span></div></div></div><div class="oc dh od fp ab oe fo di"><div class="di nu bv nv nw"><div class="dh l"><img alt="" class="dh" src="../Images/3e6ce891363c151131c5993ca0dcc526.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7cAp-WibSblfO7hT"/></div></div><div class="di nu bv nx ny nz"><div class="dh l"><img alt="" class="dh" src="../Images/a7dd413de22f319a3c4729c9e737feb8.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*FcmHdVfoUOhlJlsG"/></div></div><div class="di bv oa ob nz"><div class="dh l"><img alt="" class="dh" src="../Images/3666e533060c4dc70c7e80f31bccbcba.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*V6I1dcf-gpxiYTjb"/></div></div></div></div></div><div class="ne nf gp gr ng"><div role="button" tabindex="0" class="ab bv gv cb fp nh ni bn nj jz ex"><div class="nk l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw nl nm fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l nl nm fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----cf1774b3a233--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="np nq gw l"><h2 class="bd iu tz ou fp ua fr fs ub fu fw is bi translated">新闻</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi uc au ud ue uf qj ug an eh ei uh ui uj el em eo de bk ep" href="https://medium.com/@omgzui/list/news-67ec0a972660?source=post_page-----cf1774b3a233--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="uk l fo"><span class="bd b dl z dk">23 stories</span></div></div></div><div class="oc dh od fp ab oe fo di"><div class="di nu bv nv nw"><div class="dh l"><img alt="" class="dh" src="../Images/c3f36b36bf050f98fd5a8e3c89103cad.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*LISEmTdz19k7BAHY"/></div></div><div class="di nu bv nx ny nz"><div class="dh l"><img alt="" class="dh" src="../Images/8459df5aae62dc00f04377e09544be88.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*RvBGLw3V9JZfn_HO"/></div></div><div class="di bv oa ob nz"><div class="dh l"><img alt="" class="dh" src="../Images/2864058bcedc8c1cd6492624ba9671c6.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*IUWVb3zTn1_HKV9P"/></div></div></div></div></div></div><div class="ab cl oi oj hx ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="im in io ip iq"><h1 id="bf84" class="li lj it bd lk ll op ln lo lp oq lr ls lt or lv lw lx os lz ma mb ot md me mf bi translated">分级编码</h1><p id="76a3" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="39e6" class="ou ov it ki b kj kk kn ko kr ow kv ox kz oy ld oz pa pb pc bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="ccdb" class="ou ov it ki b kj pd kn pe kr pf kv pg kz ph ld oz pa pb pc bi translated">📰查看<a class="ae kf" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="9eea" class="ou ov it ki b kj pd kn pe kr pf kv pg kz ph ld oz pa pb pc bi translated">🔔关注我们:<a class="ae kf" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae kf" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae kf" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="1a62" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">🚀👉<a class="ae kf" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">加入升级人才集体，找到一份惊艳的工作</strong> </a></p></div></div>    
</body>
</html>