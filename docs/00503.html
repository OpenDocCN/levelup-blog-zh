<html>
<head>
<title>Styling a spreadsheet-like formula editor in a web page</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在网页中设计类似电子表格的公式编辑器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/styling-a-spreadsheet-like-formula-editor-in-a-web-page-c63cba8bfb1c?source=collection_archive---------5-----------------------#2019-04-01">https://levelup.gitconnected.com/styling-a-spreadsheet-like-formula-editor-in-a-web-page-c63cba8bfb1c?source=collection_archive---------5-----------------------#2019-04-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/27c5155d39ffa47ba33c5c0f741ef0a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uSqF0gqxkDguboIk2_MFkw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">从枯燥到生动的格式，因为你键入它！</figcaption></figure><div class=""/><p id="c9cf" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你用过Google Sheets吗？您可能已经注意到，当您编辑包含公式的单元格时，Sheets会以一种特定的格式显示各种组件:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div class="gh gi la"><img src="../Images/7df0aa875b9d65892917ee43733390bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*1QJtiLXa1lPCGpAIC1RtDA.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">数字常量、函数和单元格地址都有特定的样式</figcaption></figure><p id="3bf0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">床单的作用不止于此。它会发现语法错误(比如函数中有太多的右括号或额外的参数)，当然也会执行实际的计算。</p><p id="5f43" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在本文中，我们将使用JavaScript和CSS在网页中重现类似的行为，除了计算步骤。完整代码可在github 获得。为了简洁起见，我们将只提及其中的一些部分。</p><h1 id="2239" class="lg lh jf bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">公式语法</h1><p id="d2b1" class="pw-post-body-paragraph kc kd jf ke b kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv mi kx ky kz ij bi translated">在这个练习中，我们将使用有限的公式语法。具体而言，每个元素的传统含义如下:</p><ul class=""><li id="7603" class="mj mk jf ke b kf kg kj kk kn ml kr mm kv mn kz mo mp mq mr bi translated">格式为<strong class="ke jg"> ZZ999 </strong>的单元格地址，最多包含两个字母和三个数字:A1、B22、FG4、WA901</li><li id="aa42" class="mj mk jf ke b kf ms kj mt kn mu kr mv kv mw kz mo mp mq mr bi translated">数字，可选前导符号和可选小数部分:94，-78.02，. 00009等。</li><li id="620a" class="mj mk jf ke b kf ms kj mt kn mu kr mv kv mw kz mo mp mq mr bi translated">四个算术运算符:<strong class="ke jg"> + </strong>，<strong class="ke jg"> - </strong>，<strong class="ke jg"> * </strong>，<strong class="ke jg"> / </strong></li><li id="1981" class="mj mk jf ke b kf ms kj mt kn mu kr mv kv mw kz mo mp mq mr bi translated">字符串或文本常量，任何用双引号括起来的东西:“柏林”、“900”、“饶了我吧”。这样我们就避免了电子表格中典型的最初的<strong class="ke jg"> + </strong>或<strong class="ke jg"> = </strong>。</li><li id="a88e" class="mj mk jf ke b kf ms kj mt kn mu kr mv kv mw kz mo mp mq mr bi translated">关系运算符:<strong class="ke jg"> = </strong>，<strong class="ke jg"> &lt; </strong>，<strong class="ke jg"> &lt; = </strong>，<strong class="ke jg"> &gt; </strong>，<strong class="ke jg"> &gt; = </strong>，<strong class="ke jg">！= </strong></li><li id="5f53" class="mj mk jf ke b kf ms kj mt kn mu kr mv kv mw kz mo mp mq mr bi translated">二元逻辑运算符:<strong class="ke jg">与</strong>、<strong class="ke jg">或</strong>、<strong class="ke jg">异或</strong>。</li><li id="17e8" class="mj mk jf ke b kf ms kj mt kn mu kr mv kv mw kz mo mp mq mr bi translated">一元逻辑运算符:<strong class="ke jg">非</strong>。</li><li id="5d22" class="mj mk jf ke b kf ms kj mt kn mu kr mv kv mw kz mo mp mq mr bi translated">只有4个函数，其中两个有一个参数(<strong class="ke jg"> exp </strong>，<strong class="ke jg"> log </strong>)，一个有两个参数(<strong class="ke jg"> index </strong>，查找一个字符串常量在另一个字符串中的位置)，一个有三个参数:<strong class="ke jg"> if </strong></li><li id="11d5" class="mj mk jf ke b kf ms kj mt kn mu kr mv kv mw kz mo mp mq mr bi translated">分号:<strong class="ke jg">；</strong>这将用于分隔函数中的自变量</li><li id="6376" class="mj mk jf ke b kf ms kj mt kn mu kr mv kv mw kz mo mp mq mr bi translated">括号，左括号和右括号，用于括起函数参数并改变运算符的自然优先级。</li><li id="4ba1" class="mj mk jf ke b kf ms kj mt kn mu kr mv kv mw kz mo mp mq mr bi translated">空白和制表符将被识别，但被赋予空的语法值。</li></ul><p id="dd65" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这是非常基本的，但是您可以将相同的原则应用于更复杂的语法。根据这些规则，有效的、无样式的公式可以是:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/95aacc1a6df31b1291ed41cbae645368.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*Sv0L1QG5S-cQZ_RVOxl9Mg.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">一个有效的，统一风格的公式</figcaption></figure><h1 id="4671" class="lg lh jf bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">符号化</h1><p id="db29" class="pw-post-body-paragraph kc kd jf ke b kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv mi kx ky kz ij bi translated">如果我们想对数字、函数和字符串应用不同的风格，我们需要识别各个项目。将一个长的或短的公式转换成单独的记号叫做——是的，记号化。上述公式将在标记列表中进行标记化后进行转换:</p><pre class="lb lc ld le gt my mz na nb aw nc bi"><span id="82a5" class="nd lh jf mz b gy ne nf l ng nh">function if - left parenthesis - cell A10 - equals - cell MG9 - semicolon - function log - left parenthesis; cell A10; semicolon - right parenthesis - semicolon - function exp - left parenthesis - number 5.7 - operator division - number 22 - right parenthesis - right parenthesis</span></pre><p id="18f2" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一些标记完全由其类定义——左括号就是左括号。然而，其他一些标记是由它的类<em class="ni">和</em>的值定义的，特别是数字和字符串常量。为此，我们定义了一个只有令牌类型和值的<em class="ni">令牌</em>类，该值可能为空。</p><p id="beef" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在表征公式的各种方法中，我们将求助于正则表达式。对于正则表达式，要么你知道并使用它们，要么你不知道，它们会吓到你。你可以在<a class="nj nk ep" href="https://medium.com/u/23fa5db91f77?source=post_page-----c63cba8bfb1c--------------------------------" rel="noopener" target="_blank"> Zeeshan Ahmad </a>的<a class="ae lf" href="https://medium.com/tech-tajawal/regular-expressions-the-last-guide-6800283ac034" rel="noopener">帖子</a>中找到复习者。对于11种标记类型中的每一种，我们都分配了一个正则表达式和一个CSS类，示例如下:</p><pre class="lb lc ld le gt my mz na nb aw nc bi"><span id="9d9b" class="nd lh jf mz b gy ne nf l ng nh">// maps regular expressions to token types</span><span id="347f" class="nd lh jf mz b gy nl nf l ng nh">var lexicalDict = {}</span><span id="32ea" class="nd lh jf mz b gy nl nf l ng nh">(...)</span><span id="fdd6" class="nd lh jf mz b gy nl nf l ng nh">lexicalDict['LOGICALOPERATOR'] = new TokenTypeProperties(/^(and|or|xor)/, 'log-class') </span><span id="f738" class="nd lh jf mz b gy nl nf l ng nh">(...)</span></pre><p id="d60a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们使用一个<code class="fe nm nn no mz b">TokenTypeProperties</code>类来保存与令牌类型相关联的样式数据(基本上是CSS引用的一个类)和一个属性，我们在其中存储正则表达式来帮助我们对该类型进行令牌化。这个类包含一个<code class="fe nm nn no mz b">htmlChunk</code>方法，该方法将构建与令牌相关联的样式化html span。</p><p id="5899" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对象<code class="fe nm nn no mz b">lexicalDict</code>拥有令牌类型与其对应的<code class="fe nm nn no mz b">TokenTypeProperties</code>的关联。函数<code class="fe nm nn no mz b">tokenize</code>将<code class="fe nm nn no mz b">lexicalDict</code>的所有条目应用于公式，识别代币并丢弃它以处理公式的其余部分，并重复该过程直到它被消耗。</p><p id="a1a8" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在这个过程的最后，我们从原始公式中获得了所需的令牌列表。一个<code class="fe nm nn no mz b">UNKNOWN</code>标记类型是为意外字符保留的。我们将以特定的方式设计它们。</p><h1 id="7579" class="lg lh jf bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">设计各种令牌的样式</h1><p id="d19c" class="pw-post-body-paragraph kc kd jf ke b kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv mi kx ky kz ij bi translated">下一步是构建公式的样式版本，并将其显示在我们的网页中。为了编辑公式，我们使用带有<code class="fe nm nn no mz b">contenteditable="true"</code>的可编辑div。</p><p id="33b0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在我们的JavaScript中，我们附加了一个<code class="fe nm nn no mz b">oninput</code>事件处理程序，它将随着公式中的每次变化而触发。</p><p id="2410" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们的事件处理程序所做的是为每个令牌创建一个包含一个<strong class="ke jg"> span </strong>元素的序列，这样就可以对每个令牌应用适当的CSS。详情见代码。像<code class="fe nm nn no mz b">A22/3</code>这样的小公式会生成如下HTML:</p><pre class="lb lc ld le gt my mz na nb aw nc bi"><span id="0acd" class="nd lh jf mz b gy ne nf l ng nh">&lt;div contenteditable="true" id="formula-editor"&gt;<br/>  &lt;span id="#chunk-0" class="id-class"&gt;A22&lt;/span&gt;<br/>  &lt;span id="#chunk-1" class="op-class"&gt;/&lt;/span&gt;<br/>  &lt;span id="#chunk-2" class="num-class"&gt;3&lt;/span&gt;<br/>&lt;/div&gt;</span></pre><p id="e404" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每个令牌都有我们想要的自定义样式。如果我们只添加或删除一个字符，整个公式将被重新格式化。这是你在github上找到的CSS的样子:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div class="gh gi np"><img src="../Images/c5e0ded70fc398eaba08d9a2060c35e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:288/format:webp/1*C3K6B88Iq8VnSnginLvPww.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">光标在右边时，A22/3会是什么样子</figcaption></figure><p id="e720" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这允许我们在键入和更正公式时重新格式化公式，提供非常动态的用户体验。见下文:</p><figure class="lb lc ld le gt is"><div class="bz fp l di"><div class="nq nr l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在我们键入公式时格式化公式</figcaption></figure><h1 id="8079" class="lg lh jf bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">光标位置</h1><p id="bf5e" class="pw-post-body-paragraph kc kd jf ke b kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv mi kx ky kz ij bi translated">我们需要尊重重新格式化后的光标位置。在格式化之前，我们将当前光标位置存储在<code class="fe nm nn no mz b">getCaretPosition</code>中。在对我们的公式进行样式化之后，我们在<code class="fe nm nn no mz b">restoreCaretPosition</code>中恢复那个值，如果整个长度减少了，可能会减少它。然后，我们遍历被光标位置完全覆盖的各种HTML块，并在最后一个完全或部分覆盖的块的中间设置选择。</p><h1 id="d033" class="lg lh jf bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">语法呢？</h1><p id="5eef" class="pw-post-body-paragraph kc kd jf ke b kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv mi kx ky kz ij bi translated">我们所做的还不够。我们希望向客户报告语法错误。像这样的一行</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/63cdad0d6d311b3bdb39d7d1fa294faa.png" data-original-src="https://miro.medium.com/v2/resize:fit:672/format:webp/1*GrIH_IB5YWyZX3X1fO_TYQ.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">公式不正确</figcaption></figure><p id="a6d3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">有两个语法错误:<code class="fe nm nn no mz b">log</code>不能有两个参数，<code class="fe nm nn no mz b">exp</code>后跟一个数字。我们应该能够发现这些错误，并以某种方式将它们可视化。</p><p id="2a08" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要做到这一点，我们需要建立对应于这个公式的语法树，然后检查这样的树是否与语言的规则兼容。我们将在下一篇文章中解决这个问题。</p><h1 id="6bcb" class="lg lh jf bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">结论</h1><p id="8236" class="pw-post-body-paragraph kc kd jf ke b kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv mi kx ky kz ij bi translated">以regex为主要工具的优秀的旧式词法分析和以CSS为形式的现代HTML5、JavaScript的结合帮助我们产生了一个看起来很好的、随用随取的公式编辑器。然而，我们需要添加更多的功能来捕捉任何语法错误。目前你可以在<a class="ae lf" href="https://github.com/angelnew/formulaeditor.git" rel="noopener ugc nofollow" target="_blank"> github </a>中播放并微调编辑器。</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><div class="lb lc ld le gt oa"><a href="https://gitconnected.com/learn/javascript" rel="noopener  ugc nofollow" target="_blank"><div class="ob ab fo"><div class="oc ab od cl cj oe"><h2 class="bd jg gy z fp of fr fs og fu fw je bi translated">学习JavaScript -最佳JavaScript教程(2019) | gitconnected</h2><div class="oh l"><h3 class="bd b gy z fp of fr fs og fu fw dk translated">50大JavaScript教程-免费学习JavaScript。课程由开发人员提交并投票，从而实现…</h3></div><div class="oi l"><p class="bd b dl z fp of fr fs og fu fw dk translated">gitconnected.com</p></div></div><div class="oj l"><div class="ok l ol om on oj oo ix oa"/></div></div></a></div></div></div>    
</body>
</html>