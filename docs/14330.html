<html>
<head>
<title>Boosting your Kafka integration tests using Redpanda with Go 🚀</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Redpanda和Go增强您的Kafka集成测试🚀</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/boosting-your-kafka-integration-tests-using-redpanda-with-go-247e4276c61d?source=collection_archive---------10-----------------------#2022-11-17">https://levelup.gitconnected.com/boosting-your-kafka-integration-tests-using-redpanda-with-go-247e4276c61d?source=collection_archive---------10-----------------------#2022-11-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="457f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">以testcontainers和dockertest为例</h2></div><blockquote class="kf kg kh"><p id="9515" class="ki kj kk kl b km kn jr ko kp kq ju kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">集成测试是编排测试。他们不测试业务规则。更确切地说，它们测试的是组件组合在一起的效果。它们是管道测试，确保组件正确连接，并且可以清晰地相互通信。<a class="ae lf" href="https://www.amazon.com/Clean-Coder-Conduct-Professional-Programmers/dp/0137081073" rel="noopener ugc nofollow" target="_blank">【1】</a></p></blockquote></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><p id="91ac" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">大家好！在这篇文章中，我想谈谈<a class="ae lf" href="https://redpanda.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kl ir">、Redpanda </strong> </a>，以及我们将如何在我们的集成测试中以两个流行的库为例来实现它；<a class="ae lf" href="https://github.com/testcontainers/testcontainers-go" rel="noopener ugc nofollow" target="_blank"> <strong class="kl ir"> testcontainers </strong> </a>和<a class="ae lf" href="https://github.com/ory/dockertest" rel="noopener ugc nofollow" target="_blank"> <strong class="kl ir"> dockertest </strong> </a>。</p><blockquote class="kf kg kh"><p id="66ed" class="ki kj kk kl b km kn jr ko kp kq ju kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kl ir">TL；DR</strong>:<a class="ae lf" href="https://github.com/Abdulsametileri/integration-tests-with-redpanda" rel="noopener ugc nofollow" target="_blank">https://github . com/abdulsamiteleri/integration-tests-with-red panda</a></p></blockquote><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi lq"><img src="../Images/be99c27d1185198ea6bbac5f0d55f84e.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*yv5Oeof8zv7wRrwWZlZHrQ.png"/></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">图:地鼠想学习如何实现Redpanda</figcaption></figure><h2 id="9300" class="mc md iq bd me mf mg dn mh mi mj dp mk ln ml mm mn lo mo mp mq lp mr ms mt mu bi translated">什么是Redpanda🤔</h2><p id="e9c5" class="pw-post-body-paragraph ki kj iq kl b km mv jr ko kp mw ju kr ln mx ku kv lo my ky kz lp mz lc ld le ij bi translated"><strong class="kl ir"> Redpanda </strong>是一个Kafka兼容的流数据平台，速度快10倍，硬件效率高6倍。它也是无JVM、无ZooKeeper、<a class="ae lf" href="https://redpanda.com/blog/redpanda-official-jepsen-report-and-analysis/" rel="noopener ugc nofollow" target="_blank"> Jepsen测试</a>，并且源代码可用。<a class="ae lf" href="https://redpanda.com/" rel="noopener ugc nofollow" target="_blank">【2】</a></p><h2 id="6f05" class="mc md iq bd me mf mg dn mh mi mj dp mk ln ml mm mn lo mo mp mq lp mr ms mt mu bi translated">我为什么要用Redpanda🤔</h2><p id="1985" class="pw-post-body-paragraph ki kj iq kl b km mv jr ko kp mw ju kr ln mx ku kv lo my ky kz lp mz lc ld le ij bi translated">有了Redpanda的这些优秀属性，我们可以轻松地在测试中使用它，而无需运行Kafka和Zookeeper容器。(更好的启动时间和无故障)。此外，由于它的兼容性，不需要更改Kafka所在的任何生产代码。</p><p id="ecf1" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">正如我们已经知道的，编写和维护集成测试是困难的。我们希望尽快得到这些测试的结果。在用Redpanda替换了我们的集成测试之后，我们的测试比旧的Kafka测试工作得非常快。所以我想和你分享🔥</p><p id="64ce" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">在进入实现细节之前，我想通知你；我将用一个漂亮的测试库<a class="ae lf" href="https://github.com/stretchr/testify" rel="noopener ugc nofollow" target="_blank">作证</a><em class="kk">(suite和assert包)</em>。所以如果你没有任何经验，我强烈建议你去看看。</p><p id="e81d" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">注意:我将为每个<code class="fe na nb nc nd b"><em class="kk">(TestContainerWrapper, DockerTestWrapper)</em></code>创建一个包装器结构，并主要编写我们需要的三个方法:<code class="fe na nb nc nd b">RunContainer</code>、<code class="fe na nb nc nd b">CleanUp</code>、<code class="fe na nb nc nd b">GetBrokerAddresses</code>。</p><p id="4995" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">注2:我想测试两个功能，以确保我的应用程序可以成功地生成Kafka消息和使用Kafka消息。</p><p id="aff1" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">我们开始吧！</p></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><h2 id="d17c" class="mc md iq bd me mf mg dn mh mi mj dp mk ln ml mm mn lo mo mp mq lp mr ms mt mu bi translated">👉用testcontainers实现</h2><p id="35ba" class="pw-post-body-paragraph ki kj iq kl b km mv jr ko kp mw ju kr ln mx ku kv lo my ky kz lp mz lc ld le ij bi translated">首先，在我们的集成测试开始工作之前，我们必须确保我们的设置过程已经完成并准备好继续。</p><p id="a520" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">我们的测试套件如下所示。我们创建了<code class="fe na nb nc nd b">TestContainerWrapper</code>结构，并将其用于套件生命周期方法。</p><figure class="lr ls lt lu gt lv"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="e435" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">首先，我们可以专注于<code class="fe na nb nc nd b">RunContainer</code>实现。</p><figure class="lr ls lt lu gt lv"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="f8ef" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">在提供了Redpanda映像和版本之后，我们公开了<strong class="kl ir"> 9092 </strong>端口。<strong class="kl ir">小心；这个公开的端口号是从容器的角度来看的！</strong>从主机的角度来看<em class="kk">，</em> Testcontainers在一个随机的空闲端口上公开它。这是为了避免本地运行的软件或并行测试运行之间可能出现的端口冲突。<a class="ae lf" href="https://www.testcontainers.org/features/networking/" rel="noopener ugc nofollow" target="_blank">【3】</a>。因此，我们需要获得映射端口<strong class="kl ir"> 9092 </strong>来从我们的主机连接代理。</p><p id="1d6f" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">我们使用默认的<code class="fe na nb nc nd b">redpanda start</code>命令。有几个不同的参数:这要看你测试的是什么等等。Redpanda容器以<em class="kk">开头——dev-container</em>。在此模式下，<a class="ae lf" href="https://github.com/redpanda-data/redpanda/blob/36902e558294680e6d89e501a80e4e09811bc815/src/go/rpk/pkg/cli/cmd/redpanda/start.go#L1062" rel="noopener ugc nofollow" target="_blank">默认情况下会传递几个其他参数。</a></p><p id="2e20" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">我将true传递给了<code class="fe na nb nc nd b">AutoRemove</code>标志，因此容器将在停止时从主机中移除。</p><p id="bde6" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">最后，我曾经给我的错误<a class="ae lf" href="https://go.dev/blog/go1.13-errors" rel="noopener ugc nofollow" target="_blank"> <em class="kk"> (%w) </em> </a>添加了额外的上下文，以了解哪个流引发了错误。</p><figure class="lr ls lt lu gt lv"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="a4fc" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">上面没有具体的逻辑。在我们的集成测试完成之后，我们应该终止我们的容器。我总是尝试使用<code class="fe na nb nc nd b">context.WithTimeout</code>来完成这类任务。<code class="fe na nb nc nd b">Terminate</code>方法应使其在最多5秒内返回。</p><h2 id="95a0" class="mc md iq bd me mf mg dn mh mi mj dp mk ln ml mm mn lo mo mp mq lp mr ms mt mu bi translated">👉用Dockertest实现</h2><p id="7362" class="pw-post-body-paragraph ki kj iq kl b km mv jr ko kp mw ju kr ln mx ku kv lo my ky kz lp mz lc ld le ij bi translated">因为套件生命周期与testcontainer部分相同，所以我跳过了这一部分。</p><figure class="lr ls lt lu gt lv"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="0a3b" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">乍一看，您意识到我们实现了我们的自由端口实现，并将其与我们的容器集成在一起。因为没有暴露的随机主机端口作为testcontainer，所以我们应该自己做。</p><p id="f58c" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated"><code class="fe na nb nc nd b">ExposedPorts</code>为容器的透视图。</p><p id="25b8" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated"><code class="fe na nb nc nd b">PortBinding</code>用于提供容器和主机端口的映射绑定。</p><p id="3e06" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">我们还需要显式地设置<code class="fe na nb nc nd b"><a class="ae lf" href="https://www.confluent.io/blog/kafka-listeners-explained/" rel="noopener ugc nofollow" target="_blank">advertise-kafka-addr</a></code>来提供从我们的主机到容器的连接。为什么我们不在testcontainer部分设置它🤔。这是因为容器9092端口在内部暴露给了空闲的随机主机端口。但是在这里，如果我们不提供这个，我们必须作为主机的9092端口连接。所以我们不想使用静态主机端口进行并行运行。</p><p id="c64a" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">我们还提供了一个<code class="fe na nb nc nd b">retryFunc</code>来了解我们的容器是否准备好了。RetryFunc尝试连接Kafka brokers，如果连接成功建立，我们可以继续前进，或者尝试用可调退避时间重新连接。</p><figure class="lr ls lt lu gt lv"><div class="bz fp l di"><div class="ne nf l"/></div></figure><figure class="lr ls lt lu gt lv"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="4080" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">在<code class="fe na nb nc nd b">cleanUp</code>端，我们清除我们的容器，从docker中删除容器和链接的卷。</p><h2 id="298e" class="mc md iq bd me mf mg dn mh mi mj dp mk ln ml mm mn lo mo mp mq lp mr ms mt mu bi translated">我们的测试🚀</h2><p id="12af" class="pw-post-body-paragraph ki kj iq kl b km mv jr ko kp mw ju kr ln mx ku kv lo my ky kz lp mz lc ld le ij bi translated">我总是试着把我的测试和给定时间分开。它的意思是，在某种情况下，当某种行为被执行时，就会发生一系列的后果。</p><p id="7a67" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">我还尝试用下划线来命名我的测试。这样，通过搜索go test输出，很容易找到失败的函数。</p><figure class="lr ls lt lu gt lv"><div class="bz fp l di"><div class="ne nf l"/></div></figure></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><p id="fa96" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated"><strong class="kl ir">源代码:</strong><a class="ae lf" href="https://github.com/Abdulsametileri/integration-tests-with-redpanda" rel="noopener ugc nofollow" target="_blank">https://github . com/abdulsamiteleri/integration-tests-with-red panda</a></p></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><p id="b49c" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">感谢您的阅读💛；你也可以看看我的其他文章。</p><ul class=""><li id="67bb" class="ng nh iq kl b km kn kp kq ln ni lo nj lp nk le nl nm nn no bi translated"><a class="ae lf" href="https://medium.com/trendyol-tech/kafka-exception-c-r-onsumer-37c459e4849d" rel="noopener">卡夫卡例外Cronsumer </a></li><li id="2e36" class="ng nh iq kl b km np kp nq ln nr lo ns lp nt le nl nm nn no bi translated"><a class="ae lf" href="https://itnext.io/lets-implement-a-real-time-package-tracking-app-with-rabbitmq-and-web-socket-using-go-80f5a5ca5c55" rel="noopener ugc nofollow" target="_blank">让我们使用Go </a>通过RabbitMQ和Web socket实现一个实时包裹跟踪应用程序</li><li id="e0b1" class="ng nh iq kl b km np kp nq ln nr lo ns lp nt le nl nm nn no bi translated"><a class="ae lf" href="https://itnext.io/lets-implement-basic-service-discovery-using-go-d91c513883f6" rel="noopener ugc nofollow" target="_blank">让我们使用Go实现基本的服务发现</a></li><li id="f2cf" class="ng nh iq kl b km np kp nq ln nr lo ns lp nt le nl nm nn no bi translated"><a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/how-was-i-build-a-version-control-system-vcs-using-pure-go-83ec8ec5d4f4">我如何使用pure Go构建一个版本控制系统(VCS)</a></li><li id="ff7d" class="ng nh iq kl b km np kp nq ln nr lo ns lp nt le nl nm nn no bi translated"><a class="ae lf" href="https://medium.com/modanisa-engineering/integrating-grafana-notifications-with-gitlab-pipeline-to-restart-debezium-tasks-using-go-1378c9eaf7b8" rel="noopener">将Grafana通知与GitLab管道集成，使用Go重新启动Debezium任务</a></li><li id="ed98" class="ng nh iq kl b km np kp nq ln nr lo ns lp nt le nl nm nn no bi translated"><a class="ae lf" href="https://medium.com/codex/introduction-to-keycloak-227c3902754a" rel="noopener">键盘锁简介</a></li></ul></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><h2 id="5e56" class="mc md iq bd me mf mg dn mh mi mj dp mk ln ml mm mn lo mo mp mq lp mr ms mt mu bi translated">参考</h2><p id="0bb2" class="pw-post-body-paragraph ki kj iq kl b km mv jr ko kp mw ju kr ln mx ku kv lo my ky kz lp mz lc ld le ij bi translated">[1]《干净的程序员:职业程序员的行为准则》</p><p id="3633" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">[2]https://redpanda.com<a class="ae lf" href="https://redpanda.com/" rel="noopener ugc nofollow" target="_blank"/></p><p id="7b59" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated">[3]<a class="ae lf" href="https://www.testcontainers.org/features/networking/" rel="noopener ugc nofollow" target="_blank">https://www.testcontainers.org/features/networking/</a></p><p id="aae1" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ln kt ku kv lo kx ky kz lp lb lc ld le ij bi translated"><a class="ae lf" href="https://www.confluent.io/blog/kafka-listeners-explained/" rel="noopener ugc nofollow" target="_blank">https://www.confluent.io/blog/kafka-listeners-explained/</a></p></div></div>    
</body>
</html>