<html>
<head>
<title>Serverless load testing at scale with Artillery 🚀</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">火炮规模的无服务器负载测试🚀</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/serverless-load-testing-at-scale-with-artillery-53ef6c8b77f7?source=collection_archive---------0-----------------------#2021-07-29">https://levelup.gitconnected.com/serverless-load-testing-at-scale-with-artillery-53ef6c8b77f7?source=collection_archive---------0-----------------------#2021-07-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/b02f2f4842a884a3f30d95037e6a6178.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y4k2QDTE-0CXPpWGe8PaMg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">迈克·范·登博斯在<a class="ae jd" href="https://unsplash.com/s/photos/loading?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><div class=""><h2 id="047a" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">使用无服务器框架和大炮对无服务器应用程序进行负载、冒烟、功能和模糊测试，并提供支持代码示例！</h2></div><figure class="kw kx ky kz gt is gh gi paragraph-image"><div class="gh gi kv"><img src="../Images/f050ad67bbe5151e6def96f21410db2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*AgbmkGAuMdtmHFsLQ6Hc7g.png"/></div></figure><h1 id="c205" class="la lb jg bd lc ld le lf lg lh li lj lk km ll kn lm kp ln kq lo ks lp kt lq lr bi translated">介绍</h1><p id="3205" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">下面的文章描述了如何使用<a class="ae jd" href="https://artillery.io/" rel="noopener ugc nofollow" target="_blank">大炮</a>和<a class="ae jd" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>对你的无服务器应用进行负载测试，支持代码repo在<a class="ae jd" href="https://github.com/leegilmorecode/serverless-load-testing-artillery" rel="noopener ugc nofollow" target="_blank">这里</a>可用。有负载，烟雾，模糊和功能测试的例子，并生成报告。</p><h2 id="8708" class="mo lb jg bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq mz bi translated">支持视频</h2><figure class="kw kx ky kz gt is"><div class="bz fp l di"><div class="na nb l"/></div></figure><h2 id="c605" class="mo lb jg bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq mz bi translated">为什么要负载测试？</h2><blockquote class="nc nd ne"><p id="b546" class="ls lt nf lu b lv ng kh lx ly nh kk ma ni nj md me nk nl mh mi nm nn ml mm mn ij bi translated"><strong class="lu jh"> " </strong>为什么要对完全可伸缩的无服务器应用程序进行负载测试？转移到无服务器的原因肯定是首先否定了负载测试的需要吗？？<strong class="lu jh">🤔</strong></p></blockquote><p id="4448" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">在我看来，当使用企业级无服务器架构时，由于其他关键因素，你仍然需要进行负载测试；例如:</p><p id="7591" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">❌可扩展性较差的下游服务，以及它们如何应对lambda的突然扩展(<em class="nf">可能是集成了遗留系统或数据库技术的最大连接数</em> ) <br/> ❌异步最终一致的流程符合最终用户可接受的阈值。<br/> ❌ <a class="ae jd" href="https://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html" rel="noopener ugc nofollow" target="_blank">硬和软AWS区域限制</a>。<br/> ❌预留和供应的并发配置如何大规模影响端点。<br/> ❌内存配置在lambdas上。<br/> ❌，甚至是lambdas本身写得很差的代码(<em class="nf">内存泄漏、糟糕的批处理配置等</em>)。</p><p id="9746" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">下面直观地显示了这一点:</p><figure class="kw kx ky kz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi no"><img src="../Images/559b2337a4171ba2502469d1bea4494d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jQSWjUyCgwkWBLg8MdqP5A.png"/></div></div></figure><h2 id="23a0" class="mo lb jg bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq mz bi translated">火炮是什么？</h2><p id="2a94" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated"><a class="ae jd" href="https://artillery.io/" rel="noopener ugc nofollow" target="_blank">cannon</a>是一个开源的负载和功能/冒烟测试解决方案，它可以作为您使用NPM的无服务器解决方案的依赖项来安装，<a class="ae jd" href="https://artillery.io/docs/guides/guides/test-script-reference.html" rel="noopener ugc nofollow" target="_blank">使用yml文件</a>和<a class="ae jd" href="https://artillery.io/docs/guides/guides/test-script-reference.html#Payload-Files" rel="noopener ugc nofollow" target="_blank">附带的CSV文件来配置负载测试数据</a>，并在您的管道内运行以进行常规负载/冒烟测试。也有额外的社区插件可以使用，其中一个允许模糊测试。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="65a7" class="la lb jg bd lc ld nw lf lg lh nx lj lk km ny kn lm kp nz kq lo ks oa kt lq lr bi translated">示例架构</h1><p id="7ebc" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">这篇博客文章附带的基本示例无服务器<a class="ae jd" href="https://github.com/leegilmorecode/serverless-load-testing-artillery" rel="noopener ugc nofollow" target="_blank">代码报告</a>具有以下架构:</p><blockquote class="nc nd ne"><p id="1c4a" class="ls lt nf lu b lv ng kh lx ly nh kk ma ni nj md me nk nl mh mi nm nn ml mm mn ij bi translated">请注意，这是演示火炮使用的最小代码和架构，所以这不是生产就绪，不符合编码和架构最佳实践</p></blockquote><ol class=""><li id="148a" class="ob oc jg lu b lv ng ly nh mb od mf oe mj of mn og oh oi oj bi translated">大炮使用CSV文件中的员工通过<code class="fe ok ol om on b">POST employees</code>端点(<a class="ae jd" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank">AWS API Gateway</a>&gt;<a class="ae jd" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank">AWS Lambda</a>)创建新员工。</li><li id="438f" class="ob oc jg lu b lv oo ly op mb oq mf or mj os mn og oh oi oj bi translated">员工记录被保存到<code class="fe ok ol om on b">employees</code> <a class="ae jd" href="https://aws.amazon.com/dynamodb" rel="noopener ugc nofollow" target="_blank"> AWS DynamoDB </a>表中。</li><li id="ae1d" class="ob oc jg lu b lv oo ly op mb oq mf or mj os mn og oh oi oj bi translated">cannon迭代CSV文件，对单个雇员执行<code class="fe ok ol om on b">GET employee</code>。</li></ol><figure class="kw kx ky kz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ot"><img src="../Images/c09301a4b779a1a400a7ad14d27ac933.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jnAwV4Ew09cYxVm8e8pwJQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">这个简单演示的示例体系结构</figcaption></figure><h2 id="adf6" class="mo lb jg bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq mz bi translated">这个场景中的测试会带来什么好处？</h2><p id="c3da" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">在上面的简单架构场景中，使用cannon，您将能够断言:</p><ol class=""><li id="4da1" class="ob oc jg lu b lv ng ly nh mb od mf oe mj of mn og oh oi oj bi translated">我们是否在<a class="ae jd" href="https://aws.amazon.com/dynamodb/" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>上正确设置了<a class="ae jd" href="https://aws.amazon.com/dynamodb/pricing/provisioned/" rel="noopener ugc nofollow" target="_blank">调配的容量</a>，或者我们是否会由于缺少可用资源而受到限制？我们是应该增加它，还是根据我们的预期规模来按需改变<a class="ae jd" href="https://aws.amazon.com/dynamodb/pricing/on-demand/" rel="noopener ugc nofollow" target="_blank"/>？(<em class="nf">例如，黑色星期五的等效负荷是什么样的？</em>)</li><li id="7601" class="ob oc jg lu b lv oo ly op mb oq mf or mj os mn og oh oi oj bi translated">我们是否在lambdas上正确设置了<a class="ae jd" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html#configuration-concurrency-reserved" rel="noopener ugc nofollow" target="_blank">保留的</a> / <a class="ae jd" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html#configuration-concurrency-provisioned" rel="noopener ugc nofollow" target="_blank">供应的</a>并发？冷启动看起来怎么样，我们会因为负载得到429风格的响应吗？</li><li id="a623" class="ob oc jg lu b lv oo ly op mb oq mf or mj os mn og oh oi oj bi translated">响应时间(<em class="nf">延迟</em>)是否在我们针对最终用户的<a class="ae jd" href="https://www.scaledagileframework.com/nonfunctional-requirements/" rel="noopener ugc nofollow" target="_blank"> NFRs </a>范围内？即平均响应时间是否可以接受？一个例子可以是一个员工下载他们生成的工资单，一个生成定制的PNG图片的服务，一个根据外部服务检查你的信用检查的服务，等等</li><li id="1719" class="ob oc jg lu b lv oo ly op mb oq mf or mj os mn og oh oi oj bi translated">断言的API响应在功能上是否正确？也就是说，在一个新版本发布后，我们是否得到了我们期望的正确的属性？</li><li id="b030" class="ob oc jg lu b lv oo ly op mb oq mf or mj os mn og oh oi oj bi translated">如果我们发布过多/不足，发送不良/恶意的有效载荷等，我们会得到什么样的回应？我们的API验证工作正常吗？</li></ol><p id="422b" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">正如你所看到的，即使在上面这个非常琐碎的例子中，火炮测试也有很多好处。用潜在的异步处理和涉及的更多AWS服务/配置、集成的下游遗留/较慢的系统以及对API进行的功能更改来推断这一点；从在管道中运行的联合负载和功能/冒烟测试套件的角度，展示了这种方法是多么有用。</p><h1 id="1665" class="la lb jg bd lc ld le lf lg lh li lj lk km ll kn lm kp ln kq lo ks lp kt lq lr bi translated">如何部署示例代码？</h1><blockquote class="nc nd ne"><p id="8cb8" class="ls lt nf lu b lv ng kh lx ly nh kk ma ni nj md me nk nl mh mi nm nn ml mm mn ij bi translated"><em class="jg"> 🛑 </em></p></blockquote><p id="8dc9" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">在文件夹的根目录下运行<code class="fe ok ol om on b">npm i</code>，然后运行<code class="fe ok ol om on b">npm run deploy:develop</code>，这将安装所有的依赖项，然后部署到AWS。</p><p id="796c" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">这将使用无服务器框架(即API、计算层和数据库)为您生成资源。您将看到与此类似的输出:</p><figure class="kw kx ky kz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ou"><img src="../Images/c5dfa8836d62279f4ea58ad8066233be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r0_s8fzoPnc7pYoVvMJqKA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">运行npm的输出运行部署:开发</figcaption></figure><p id="f43c" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">然后，在<code class="fe ok ol om on b">tests/load.yml</code>文件中，将<code class="fe ok ol om on b">environments &gt; develop</code>部分中的<code class="fe ok ol om on b">target</code>属性修改为运行部署时生成的基本URL(<em class="nf">我已经为staging和production添加了条目，只是为了展示这是如何工作的</em>)。一个例子:</p><pre class="kw kx ky kz gt ov on ow ox aw oy bi"><span id="06c7" class="mo lb jg on b gy oz pa l pb pc">environments:<br/>   develop:<br/>      target: "<strong class="on jh">https://</strong>something<strong class="on jh">.execute-api.eu-west-1.amazonaws.com/develop</strong>"</span></pre><blockquote class="nc nd ne"><p id="2a2f" class="ls lt nf lu b lv ng kh lx ly nh kk ma ni nj md me nk nl mh mi nm nn ml mm mn ij bi translated"><em class="jg">💡</em>实际上，这将是您众所周知的域端点，例如使用AWS Route 53和CloudFront，显然我不会在这个简单的示例中这样做，但是您通常不会像上面那样修改这个文件。</p></blockquote><p id="24a8" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">然后您可以使用<code class="fe ok ol om on b">npm run test:load:develop</code>运行负载测试，这将在results文件夹中生成一个<code class="fe ok ol om on b">develop.json</code>文件，并在reports文件夹中生成一个带有时间戳的报告。</p><p id="b813" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">您还可以运行<code class="fe ok ol om on b">npm run test:smoke:develop</code>,它将运行一组冒烟测试而不是负载测试，并生成一个如上的报告。</p><p id="39e0" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">最后，对于使用cannon运行功能测试(<em class="nf">包括</em> <a class="ae jd" href="https://owasp.org/www-community/Fuzzing" rel="noopener ugc nofollow" target="_blank"> <em class="nf">模糊化</em> </a>)运行<code class="fe ok ol om on b">npm run test:func:develop</code>，这将产生测试运行的文本文件报告(<em class="nf">包括任何失败的测试和导致失败的设置数据/场景等</em></p><blockquote class="nc nd ne"><p id="fec9" class="ls lt nf lu b lv ng kh lx ly nh kk ma ni nj md me nk nl mh mi nm nn ml mm mn ij bi translated"><em class="jg">💡CSV文件中的模拟员工数据是使用https://www.mockaroo.com/的免费优秀资源<a class="ae jd" href="https://www.mockaroo.com/" rel="noopener ugc nofollow" target="_blank">生成的</a></em></p></blockquote></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="c47a" class="la lb jg bd lc ld nw lf lg lh nx lj lk km ny kn lm kp nz kq lo ks oa kt lq lr bi translated">这是怎么配置的？</h1><p id="d8f5" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">主炮配置被分成两个文件(<em class="nf">实际上你可以进一步分割</em>):</p><p id="fd6a" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated"><strong class="lu jh"> load.yml </strong>用于负载和烟雾测试。<br/> <strong class="lu jh"> functional.yml </strong>用于功能测试(<em class="nf"> inc fuzzing </em>)。</p><p id="9e6e" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">yml文件通过NPM脚本调用，每个脚本运行生成输出JSON文件的测试，以及获取JSON文件并生成报告的post脚本:</p><pre class="kw kx ky kz gt ov on ow ox aw oy bi"><span id="228c" class="mo lb jg on b gy oz pa l pb pc">"test:smoke:develop": "DEBUG=plugin:expect $(npm bin)/artillery run --output ./tests/data/results/smoke-develop.json -e smoke-develop ./tests/load.yml",</span><span id="3bf9" class="mo lb jg on b gy pd pa l pb pc">"posttest:smoke:develop": "$(npm bin)/artillery report --output ./tests/data/reports/smoke/report-smoke-develop-\"$(date \"+%Y-%m-%d_%H-%M-%S\")\".html ./tests/data/results/smoke-develop.json",</span></pre><h2 id="8f8f" class="mo lb jg bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq mz bi translated">load.yml</h2><p id="1f5d" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">负载测试文件<code class="fe ok ol om on b">load.yml</code>如下所示，带有详细注释:</p><figure class="kw kx ky kz gt is"><div class="bz fp l di"><div class="pe nb l"/></div></figure><blockquote class="nc nd ne"><p id="2122" class="ls lt nf lu b lv ng kh lx ly nh kk ma ni nj md me nk nl mh mi nm nn ml mm mn ij bi translated"><em class="jg">💡</em>如您所见，冒烟测试和负载测试之间的唯一区别在于冒烟测试是作为一个虚拟用户(即无负载)按顺序一次运行一个测试。</p></blockquote><p id="0274" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">测试数据是从一个<code class="fe ok ol om on b">data.csv</code>文件中提取的，在配置中有下面一行:</p><pre class="kw kx ky kz gt ov on ow ox aw oy bi"><span id="4c14" class="mo lb jg on b gy oz pa l pb pc">payload:<br/>   path: "./data/data.csv" # pull in the employee data csv</span></pre><p id="794a" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">您还可以看到,<code class="fe ok ol om on b"><a class="ae jd" href="https://www.npmjs.com/package/artillery-plugin-expect" rel="noopener ugc nofollow" target="_blank">expect</a></code>插件被用来确保:</p><p id="2b8c" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">正在返回✔️正确的状态代码。<br/> ✔️返回正确的内容类型。<br/> ✔️的回答具有正确的性质。<br/> ✔️对返回值进行一些正确的测试，例如<code class="fe ok ol om on b">fullName</code>，它是代码中<code class="fe ok ol om on b">firstName</code>和<code class="fe ok ol om on b">surname</code>属性的串联。</p><h2 id="10c0" class="mo lb jg bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq mz bi translated">functional.yml</h2><p id="ee6c" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">功能和模糊测试可以在下面的<code class="fe ok ol om on b">functional.yml</code>文件摘录中看到，带有详细注释:</p><figure class="kw kx ky kz gt is"><div class="bz fp l di"><div class="pe nb l"/></div></figure><p id="7486" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">从上面你可以看到,<code class="fe ok ol om on b"><a class="ae jd" href="https://artillery.io/docs/guides/plugins/plugin-fuzzer.html" rel="noopener ugc nofollow" target="_blank">fuzzer</a></code>插件已经被引入，它将产生错误的输入用于我们的测试，如下所示:</p><pre class="kw kx ky kz gt ov on ow ox aw oy bi"><span id="54d3" class="mo lb jg on b gy oz pa l pb pc">firstName: "{{ naughtyString }}"</span></pre><p id="628d" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">我们正在明确测试:</p><p id="2a51" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">✔️ ️that，我们的lambda函数中的有效载荷验证工作正常。<br/> ✔️检查正确的预期响应代码。<br/> ✔️检查正在返回的正确响应。</p><blockquote class="nc nd ne"><p id="00c7" class="ls lt nf lu b lv ng kh lx ly nh kk ma ni nj md me nk nl mh mi nm nn ml mm mn ij bi translated"><em class="jg">💡</em>功能测试由一个虚拟用户运行，类似于烟雾测试。</p></blockquote><p id="6822" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">我们在代码中添加了一个基本的<code class="fe ok ol om on b">validate</code>函数，它使用<a class="ae jd" href="https://json-schema.org/" rel="noopener ugc nofollow" target="_blank"> JSON模式</a>和<a class="ae jd" href="https://ajv.js.org/" rel="noopener ugc nofollow" target="_blank"> AJV </a>来检查我们的输入负载，如果有任何失败，它会抛出一个名为<code class="fe ok ol om on b">AppError</code>的自定义错误类型:</p><figure class="kw kx ky kz gt is"><div class="bz fp l di"><div class="pe nb l"/></div></figure><p id="a2a9" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">自定义的<code class="fe ok ol om on b">AppError</code>错误类型允许我们区分我们在代码中抛出的已知错误(<em class="nf">例如我们通过AJV </em>验证的错误请求)和未捕获的错误。<strong class="lu jh">我们这样做是因为如果出现未知错误，我们不想在响应中返回堆栈跟踪或秘密！</strong></p><p id="93ac" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">lambda处理程序中使用的基本<strong class="lu jh"> </strong>通用错误处理程序的示例如下所示(<em class="nf">默认为500错误，带有标准错误消息</em>):</p><figure class="kw kx ky kz gt is"><div class="bz fp l di"><div class="pe nb l"/></div></figure><p id="91df" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">然后，我们可以使用JSON模式测试有效负载输入，如下所示，用于创建employee端点:</p><figure class="kw kx ky kz gt is"><div class="bz fp l di"><div class="pe nb l"/></div></figure><p id="d468" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">如果有效载荷验证失败，我们可以返回正确的响应，可以使用上面的功能测试进行验证！</p><figure class="kw kx ky kz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pf"><img src="../Images/f0673e462fe857eb30190889076ae08d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2At1bjfoXBPCz1kqT2xaWw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">可以在我们的功能测试中检查的示例响应</figcaption></figure></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="59e5" class="la lb jg bd lc ld nw lf lg lh nx lj lk km ny kn lm kp nz kq lo ks oa kt lq lr bi translated">举报！📈</h1><p id="07ab" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">一旦测试已经运行，一个<a class="ae jd" href="https://docs.npmjs.com/cli/v7/using-npm/scripts#pre--post-scripts" rel="noopener ugc nofollow" target="_blank"> NPM post脚本</a>在<code class="fe ok ol om on b">reports</code>文件夹中为给定的环境和测试类型生成一个本地报告；例如:<code class="fe ok ol om on b">report-load-develop-2021–07–28_20–27–07.html</code></p><figure class="kw kx ky kz gt is gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/c6e4603e1ef257d35a5054075418d809.png" data-original-src="https://miro.medium.com/v2/resize:fit:1030/format:webp/1*-dKKhUs_IsrBLz-DGZgnLQ.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">生成报告的文件夹结构示例</figcaption></figure><p id="20fc" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">然后，您可以打开基本生成的报告并查看它，它显示了以下示例输出:</p><figure class="kw kx ky kz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ph"><img src="../Images/acb83eab852848a4f2131f97672c08a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nem9oBaQTapaz2ATy3A3Ig.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">本地生成的基本报告</figcaption></figure><p id="9635" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">如果你想从生成的JSON输出中看到一个更好的报告风格，你可以进入<a class="ae jd" href="https://reportviewer.artillery.io/" rel="noopener ugc nofollow" target="_blank">https://reportviewer.artillery.io/</a>并上传生成的JSON文件以获得以下结果:</p><figure class="kw kx ky kz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pi"><img src="../Images/c6422aa9a169a3896cbe7df152b7e216.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C52F1Wr_23hYhM9SKOEV7w.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">通过<a class="ae jd" href="https://reportviewer.artillery.io/" rel="noopener ugc nofollow" target="_blank">https://reportviewer.artillery.io/</a>生成的漂亮报告</figcaption></figure><p id="1bd2" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">在大多数浏览器中，您可以<code class="fe ok ol om on b">select &gt; edit &gt; print &gt; print to pdf</code>获得PDF格式的可下载报告。</p><p id="9211" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">两个yml文件中的以下配置确保了如果我们有任何错误，或者如果延迟超过某个阈值，管道将会失败:</p><pre class="kw kx ky kz gt ov on ow ox aw oy bi"><span id="66b9" class="mo lb jg on b gy oz pa l pb pc">ensure:<br/>   p95: 1000 # ensure latency is equal to or under 1000ms<br/>   maxErrorRate: 0 # no percentage of error rate i.e. no errors or pipeline fails</span></pre></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="8ed8" class="la lb jg bd lc ld nw lf lg lh nx lj lk km ny kn lm kp nz kq lo ks oa kt lq lr bi translated">插件🔌</h1><p id="afe6" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">火炮有许多插件，可以和它一起使用来扩展它的功能，例如:</p><p id="6fc3" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated"><a class="ae jd" href="https://www.npmjs.com/package/artillery-plugin-cloudwatch" rel="noopener ugc nofollow" target="_blank"><strong class="lu jh">cannon-plugin-cloud watch</strong></a>—cannon . io的插件，将响应数据记录到AWS CloudWatch中。</p><p id="1b04" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">这个插件使得在你的HTTP API上运行一些模糊测试变得容易。使用它来发送意想不到的负载到您的端点，看看有什么问题，并修复它，使您的应用程序更安全，更有弹性。这个插件产生的有效载荷是基于令人敬畏的<a class="ae jd" href="https://github.com/minimaxir/big-list-of-naughty-strings/" rel="noopener ugc nofollow" target="_blank">淘气字符串大列表</a>。</p><p id="9975" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated"><a class="ae jd" href="https://www.npmjs.com/package/artillery-plugin-sns" rel="noopener ugc nofollow" target="_blank"><strong class="lu jh">cannon-plugin-SNS</strong></a>—cannon . io的插件，发布对AWS SNS主题的响应数据。</p><p id="b436" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated"><a class="ae jd" href="https://www.npmjs.com/package/artillery-plugin-dynamodb" rel="noopener ugc nofollow" target="_blank"><strong class="lu jh">cannon-plugin-dynamo db</strong></a>—cannon . io的一个插件，将统计数据发布到AWS DynamoDB。</p><p id="3be8" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">查看更多插件<a class="ae jd" href="https://www.npmjs.com/search?q=artillery-plugin-&amp;page=0&amp;perPage=20" rel="noopener ugc nofollow" target="_blank">这里</a>，显然你也可以创建自己的插件。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="83f6" class="la lb jg bd lc ld nw lf lg lh nx lj lk km ny kn lm kp nz kq lo ks oa kt lq lr bi translated">扩展到企业级负载测试！👊🏼</h1><p id="f89a" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">随着cannon社区的加入，您可以发出的请求数量受到运行测试的机器资源的限制(<em class="nf">即性能和网络</em>)。</p><p id="985d" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">为了减轻这种情况并超越平均规模，您可以利用<a class="ae jd" href="https://www.artillery.io/docs/guides/guides/running-tests-with-artillery-pro" rel="noopener ugc nofollow" target="_blank">火炮专业</a>如果:</p><ol class=""><li id="cafd" class="ob oc jg lu b lv ng ly nh mb od mf oe mj of mn og oh oi oj bi translated">您想知道您的高流量服务(<em class="nf">内部或公共</em>)是否能够处理大量的流量负载(<em class="nf">即性能或负载测试</em>)。</li><li id="4e4d" class="ob oc jg lu b lv oo ly op mb oq mf or mj os mn og oh oi oj bi translated">您希望在部署新的变更之后测试您的服务是否如您所期望的那样运行(<em class="nf">即验收测试</em>)。</li><li id="021a" class="ob oc jg lu b lv oo ly op mb oq mf or mj os mn og oh oi oj bi translated">您希望随时监控您的企业服务，以确保您的服务的延迟处于控制之下(<em class="nf">即监控模式</em>)。</li></ol><blockquote class="nc nd ne"><p id="c046" class="ls lt nf lu b lv ng kh lx ly nh kk ma ni nj md me nk nl mh mi nm nn ml mm mn ij bi translated"><strong class="lu jh"> <em class="jg">注意</em> </strong> <em class="jg">:根据您的使用情况和组织情况查看</em> <a class="ae jd" href="https://www.artillery.io/pricing" rel="noopener ugc nofollow" target="_blank"> <em class="jg">定价</em> </a> <em class="jg">页面。</em></p></blockquote></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="c8c9" class="la lb jg bd lc ld nw lf lg lh nx lj lk km ny kn lm kp nz kq lo ks oa kt lq lr bi translated">可供选择的事物</h1><p id="1500" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">这里要提一点的是，市面上还有其他比较成熟的工具，比如<a class="ae jd" href="https://jmeter.apache.org/" rel="noopener ugc nofollow" target="_blank">Apache JMeter</a>；然而，canary可能适合您当前的需求，它非常轻量级，因为它是使用NPM安装的，可以在CI管道中运行，并且还有canary的<a class="ae jd" href="https://artillery.io/pro/" rel="noopener ugc nofollow" target="_blank"> Pro版本，它具有增强的功能，并与AWS等建立了更好的集成</a></p><p id="1dae" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">在我看来，它是这项工作的正确工具，也是在设计和开发新的无服务器解决方案时，您头脑中的另一个工具！🛠</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="36cb" class="la lb jg bd lc ld nw lf lg lh nx lj lk km ny kn lm kp nz kq lo ks oa kt lq lr bi translated">包扎</h1><p id="2b75" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">我很乐意就以下任何一个问题与您联系:</p><p id="be4a" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated"><a class="ae jd" href="https://www.linkedin.com/in/lee-james-gilmore/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/lee-james-gilmore/</a>T20】https://twitter.com/LeeJamesGilmore<a class="ae jd" href="https://twitter.com/LeeJamesGilmore" rel="noopener ugc nofollow" target="_blank">T22】</a></p><p id="9b15" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">如果你觉得这些文章鼓舞人心或有用，请随时用虚拟咖啡<a class="ae jd" href="https://www.buymeacoffee.com/leegilmore" rel="noopener ugc nofollow" target="_blank">https://www.buymeacoffee.com/leegilmore</a>来支持我，不管怎样，让我们联系和聊天吧！☕️</p><p id="54ca" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">如果你喜欢这些帖子，请关注我的简介<a class="ae jd" href="https://medium.com/u/2906c6def240?source=post_page-----39c4f4ae5aff----------------------" rel="noopener">李·詹姆斯·吉尔摩</a>以获取更多的帖子/系列，不要忘记联系我并打招呼👋</p><p id="fb62" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">如果你喜欢，也请使用帖子底部的“鼓掌”功能！(<strong class="lu jh"> <em class="nf">可以不止一次鼓掌！！</em> </strong>)</p><p id="10f8" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated"><strong class="lu jh">本文由</strong><a class="ae jd" href="https://www.sedai.io/" rel="noopener ugc nofollow" target="_blank"><strong class="lu jh">sedai . io</strong></a>赞助</p><figure class="kw kx ky kz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pj"><img src="../Images/4c77bc2d275bd557dda90aa2fe842d2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LJqkQYFI-KAGHOI3cHWxJQ.png"/></div></div></figure></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="7eec" class="la lb jg bd lc ld nw lf lg lh nx lj lk km ny kn lm kp nz kq lo ks oa kt lq lr bi translated">关于我</h1><p id="4a0b" class="pw-post-body-paragraph ls lt jg lu b lv lw kh lx ly lz kk ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">"<em class="nf">大家好，我是Lee，英国的AWS认证技术架构师和首席软件工程师，目前是技术云架构师和首席无服务器开发人员，过去5年主要从事AWS上的全栈JavaScript工作。</em></p><p id="106f" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">我认为自己是一个无服务器的布道者，热爱AWS、创新、软件架构和技术。</p><p id="8d41" class="pw-post-body-paragraph ls lt jg lu b lv ng kh lx ly nh kk ma mb nj md me mf nl mh mi mj nn ml mm mn ij bi translated">提供的信息是我个人的观点，我对信息的使用不承担任何责任。*** </p></div></div>    
</body>
</html>