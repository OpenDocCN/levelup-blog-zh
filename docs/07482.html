<html>
<head>
<title>Optional.stream()</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Optional.stream()</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/optional-stream-36de5ef2b11d?source=collection_archive---------10-----------------------#2021-02-21">https://levelup.gitconnected.com/optional-stream-36de5ef2b11d?source=collection_archive---------10-----------------------#2021-02-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c5c94a17f14bd67d2682e1e95b8da8d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UWzO6EgEucssJ092QnY2Mw.jpeg"/></div></div></figure><p id="58d1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本周，我了解了<code class="fe kw kx ky kz b">Optional</code>的一个漂亮的“新”特性，我想在这篇文章中分享一下。从Java 9开始就有了，所以它的新颖性是相对的。</p><p id="0986" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们从下面的序列开始计算订单的总价:</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="9534" class="li lj iq kz b gy lk ll l lm ln">public BigDecimal getOrderPrice(Long orderId) {<br/>    List&lt;OrderLine&gt; lines = orderRepository.findByOrderId(orderId);<br/>    BigDecimal price = BigDecimal.ZERO;       // 1<br/>    for (OrderLine line : lines) {<br/>        price = price.add(line.getPrice());   // 2<br/>    }<br/>    return price;<br/>}</span></pre><ol class=""><li id="7ece" class="lo lp iq ka b kb kc kf kg kj lq kn lr kr ls kv lt lu lv lw bi translated">为价格提供一个累加器变量</li><li id="9a1a" class="lo lp iq ka b kb lx kf ly kj lz kn ma kr mb kv lt lu lv lw bi translated">将每一行的价格加到总价中</li></ol><p id="bd4a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如今，使用流而不是迭代可能更合适。以下代码片段与上一个代码片段等效:</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="04b2" class="li lj iq kz b gy lk ll l lm ln">public BigDecimal getOrderPrice(Long orderId) {<br/>    List&lt;OrderLine&gt; lines = orderRepository.findByOrderId(orderId);<br/>    return lines.stream()<br/>                .map(OrderLine::getPrice)<br/>                .reduce(BigDecimal.ZERO, BigDecimal::add);<br/>}</span></pre><p id="f890" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们关注一下<code class="fe kw kx ky kz b">orderId</code>变量:它可能是<code class="fe kw kx ky kz b">null</code>。</p><p id="1fd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">处理<code class="fe kw kx ky kz b">null</code>值的必要方式是在方法开始时检查它——并最终抛出:</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="6992" class="li lj iq kz b gy lk ll l lm ln">public BigDecimal getOrderPrice(Long orderId) {<br/>    if (orderId == null) {<br/>        throw new IllegalArgumentException("Order ID cannot be null");<br/>    }<br/>    List&lt;OrderLine&gt; lines = orderRepository.findByOrderId(orderId);<br/>    return lines.stream()<br/>                .map(OrderLine::getPrice)<br/>                .reduce(BigDecimal.ZERO, BigDecimal::add);<br/>}</span></pre><p id="ab9d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">功能性的方法是将<code class="fe kw kx ky kz b">orderId</code>包裹在<code class="fe kw kx ky kz b">Optional</code>中。这是使用<code class="fe kw kx ky kz b">Optional</code>的代码的样子:</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="5c00" class="li lj iq kz b gy lk ll l lm ln">public BigDecimal getOrderPrice(Long orderId) {<br/>    return Optional.ofNullable(orderId)                        // 1    <br/>            .map(orderRepository::findByOrderId)                // 2   <br/>            .flatMap(lines -&gt; {                                 // 3  <br/>                BigDecimal sum = lines.stream()<br/>                        .map(OrderLine::getPrice)<br/>                        .reduce(BigDecimal.ZERO, BigDecimal::add);<br/>                return Optional.of(sum);                       // 4     <br/>            }).orElse(BigDecimal.ZERO);                        // 5    <br/>}</span></pre><ol class=""><li id="74ca" class="lo lp iq ka b kb kc kf kg kj lq kn lr kr ls kv lt lu lv lw bi translated">用<code class="fe kw kx ky kz b">Optional</code>包裹<code class="fe kw kx ky kz b">orderId</code></li><li id="f6fc" class="lo lp iq ka b kb lx kf ly kj lz kn ma kr mb kv lt lu lv lw bi translated">查找相关订单行</li><li id="5da9" class="lo lp iq ka b kb lx kf ly kj lz kn ma kr mb kv lt lu lv lw bi translated">使用<code class="fe kw kx ky kz b">flatMap()</code>得到一个<code class="fe kw kx ky kz b">Optional&lt;BigDecimal&gt;</code>；<code class="fe kw kx ky kz b">map()</code>会得到一个<code class="fe kw kx ky kz b">Optional&lt;Optional&lt;BigDecimal&gt;&gt;</code></li><li id="bedf" class="lo lp iq ka b kb lx kf ly kj lz kn ma kr mb kv lt lu lv lw bi translated">我们需要将结果包装到一个<code class="fe kw kx ky kz b">Optional</code>中，以符合方法签名</li><li id="57f4" class="lo lp iq ka b kb lx kf ly kj lz kn ma kr mb kv lt lu lv lw bi translated">如果<code class="fe kw kx ky kz b">Optional</code>不包含值，则总和为<code class="fe kw kx ky kz b">0</code></li></ol><p id="fca5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kw kx ky kz b">Optional</code>降低代码可读性！我相信可读性应该每次都胜过代码风格。</p><p id="c61c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，<code class="fe kw kx ky kz b">Optional</code>提供了一个<code class="fe kw kx ky kz b">stream()</code>方法(从Java 9开始)。它允许简化功能管道:</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="913d" class="li lj iq kz b gy lk ll l lm ln">public BigDecimal getOrderPrice(Long orderId) {<br/>    return Optional.ofNullable(orderId)<br/>            .stream()<br/>            .map(orderRepository::findByOrderId)<br/>            .flatMap(Collection::stream)<br/>            .map(OrderLine::getPrice)<br/>            .reduce(BigDecimal.ZERO, BigDecimal::add);<br/>}</span></pre><p id="f77b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是每行的类型摘要:</p><ol class=""><li id="30e9" class="lo lp iq ka b kb kc kf kg kj lq kn lr kr ls kv lt lu lv lw bi translated"><code class="fe kw kx ky kz b">Optional.ofNullable(orderId)</code> : <code class="fe kw kx ky kz b">Optional&lt;Long&gt;</code></li><li id="ccbb" class="lo lp iq ka b kb lx kf ly kj lz kn ma kr mb kv lt lu lv lw bi translated"><code class="fe kw kx ky kz b">stream()</code> : <code class="fe kw kx ky kz b">Stream&lt;Long&gt;</code></li><li id="746e" class="lo lp iq ka b kb lx kf ly kj lz kn ma kr mb kv lt lu lv lw bi translated"><code class="fe kw kx ky kz b">map(orderRepository::findByOrderId)</code> : <code class="fe kw kx ky kz b">Stream&lt;List&lt;OrderLine&gt;&gt;</code></li><li id="5f9a" class="lo lp iq ka b kb lx kf ly kj lz kn ma kr mb kv lt lu lv lw bi translated"><code class="fe kw kx ky kz b">flatMap(Collection::stream)</code> : <code class="fe kw kx ky kz b">Stream&lt;OrderLine&gt;</code></li><li id="c07e" class="lo lp iq ka b kb lx kf ly kj lz kn ma kr mb kv lt lu lv lw bi translated"><code class="fe kw kx ky kz b">map(OrderLine::getPrice)</code> : <code class="fe kw kx ky kz b">Stream&lt;BigDecimal&gt;</code></li><li id="3bb3" class="lo lp iq ka b kb lx kf ly kj lz kn ma kr mb kv lt lu lv lw bi translated"><code class="fe kw kx ky kz b">reduce(BigDecimal.ZERO, BigDecimal::add)</code> : <code class="fe kw kx ky kz b">BigDecimal</code></li></ol><p id="2978" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">功能代码不一定意味着可读的代码。有了最后的变化，我相信两者都有。</p><p id="f6a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">更进一步:</strong></p><ul class=""><li id="345a" class="lo lp iq ka b kb kc kf kg kj lq kn lr kr ls kv mc lu lv lw bi translated"><a class="ae md" href="https://docs.oracle.com/en/java/javase/15/docs/api/java.base/java/util/Optional.html#stream()" rel="noopener ugc nofollow" target="_blank"> Option.stream() Javadoc </a></li></ul></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><p id="edc8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ml">原载于2021年2月21日</em> <a class="ae md" href="https://blog.frankel.ch/optional-stream/" rel="noopener ugc nofollow" target="_blank"> <em class="ml">一个Java怪胎</em> </a> <em class="ml">。</em></p></div></div>    
</body>
</html>