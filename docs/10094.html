<html>
<head>
<title>Modern data storage on Android: Meet Jetpack DataStore — Part 1/2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android上的现代数据存储:了解Jetpack数据存储—第1/2部分</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/modern-data-storage-on-android-meet-jetpack-datastore-part-1-2-9f314c994fc8?source=collection_archive---------3-----------------------#2021-10-26">https://levelup.gitconnected.com/modern-data-storage-on-android-meet-jetpack-datastore-part-1-2-9f314c994fc8?source=collection_archive---------3-----------------------#2021-10-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="35ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">谷歌最近发布了其新的Android数据存储解决方案的稳定版本:DataStores。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/c53216fe01b14eba0712b9d03292bf3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3QAk_xrVEusv3mXLwfLNvw.png"/></div></div></figure><h1 id="d15f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">介绍</h1><p id="4a9e" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">当我们谈论android的数据存储解决方案时，很容易想到SharedPreferences，这是一种非常简单快捷的将数据保存到应用程序中的方法，但如果管理不当，当应用程序的大小和复杂性增加时，它可能会导致许多难以解决的问题。Jetpack DataStore是SharedPreferences的可能替代品，可以解决其中的许多问题。</p><h2 id="aabd" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">什么是Jetpack数据存储？</h2><blockquote class="mm mn mo"><p id="04dd" class="jn jo mp jp b jq jr js jt ju jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj kk ij bi translated">“Jetpack DataStore是一个数据存储解决方案，允许您使用<a class="ae mt" href="https://developers.google.com/protocol-buffers" rel="noopener ugc nofollow" target="_blank">协议缓冲区</a>存储键值对或类型化对象。DataStore使用Kotlin协同例程和流来异步、一致和事务性地存储数据。”</p><p id="2e0d" class="jn jo mp jp b jq jr js jt ju jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj kk ij bi translated">——【developer.android.com T2】</p></blockquote><p id="b0d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有两种不同类型的数据存储，preference和proto数据存储，第一种非常类似于SharedPreferences的工作方式，它实现起来更简单，但没有类型安全，第二种使用协议缓冲区来序列化数据，它的实现更复杂，但有很多优点。在本文中，我将讨论PreferencesDataStore以及如何实现它，但是请继续关注第2部分，在第2部分中，我将讨论ProtoDataStore以及随着您的项目变大，它对于应用程序开发的许多优势。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mu"><img src="../Images/e0069c9a96a76c7bd1bfb8ef2f67eec4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y0uWmyzqs0f2Aiu4Hs4ERQ.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated"><a class="ae mt" href="https://developer.android.com/codelabs/android-preferences-datastore#3" rel="noopener ugc nofollow" target="_blank">谷歌代码实验室</a></figcaption></figure><h1 id="340f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">履行</h1><p id="7c7f" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">让我们看看如何在应用程序中使用首选项数据存储，在本例中，我们将实现一个简单的计数器数据存储，稍后我们将使用它创建一个应用程序。</p><h2 id="864c" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">步骤1:添加依赖关系</h2><p id="7de7" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">要在您的应用程序中使用Jetpack数据存储，请将依赖项添加到您的app/build.gradle文件:</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="e131" class="ma ky iq na b gy ne nf l ng nh">implementation "androidx.datastore:datastore-preferences:1.0.0"</span></pre><h2 id="5fe7" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">步骤2:创建数据存储</h2><p id="4fa2" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">将依赖项添加到应用程序后，您现在可以创建第一个数据存储，为此，您需要创建上下文对象的扩展:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">如何创建新的数据存储</figcaption></figure><h2 id="b848" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">步骤3:创建数据存储的密钥</h2><p id="540e" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">使用SharedPreferences，您可以使用硬编码的字符串键来写入和读取数据，这在数据存储中是不可能的，您需要创建一个key对象，您可以这样创建它:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">如何为首选项数据存储创建密钥</figcaption></figure><p id="a655" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这看起来像是一个额外的步骤，但实际上非常有帮助，因为您的项目越来越大，这将迫使开发人员将所有的键放在一个集中的位置(或者他们必须在每次读/写数据存储时创建一个键的实例，这不是一个很好的做法)，并确保如果键在未来发生变化，您的类和文件将不会使用旧的不推荐使用的键。</p><p id="d388" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以创建其他类型的PreferenceKey:</p><ul class=""><li id="ea85" class="nk nl iq jp b jq jr ju jv jy nm kc nn kg no kk np nq nr ns bi translated">booleanPreferencesKey (名称:字符串)</li><li id="8c8e" class="nk nl iq jp b jq nt ju nu jy nv kc nw kg nx kk np nq nr ns bi translated"><a class="ae mt" href="https://developer.android.com/reference/kotlin/androidx/datastore/preferences/core/package-summary#doublePreferencesKey(kotlin.String)" rel="noopener ugc nofollow" target="_blank"> doublePreferencesKey </a>(名称:字符串)</li><li id="da5a" class="nk nl iq jp b jq nt ju nu jy nv kc nw kg nx kk np nq nr ns bi translated"><a class="ae mt" href="https://developer.android.com/reference/kotlin/androidx/datastore/preferences/core/package-summary#floatPreferencesKey(kotlin.String)" rel="noopener ugc nofollow" target="_blank"> floatPreferencesKey </a>(名称:字符串)</li><li id="77b3" class="nk nl iq jp b jq nt ju nu jy nv kc nw kg nx kk np nq nr ns bi translated"><a class="ae mt" href="https://developer.android.com/reference/kotlin/androidx/datastore/preferences/core/package-summary#intPreferencesKey(kotlin.String)" rel="noopener ugc nofollow" target="_blank"> intPreferencesKey </a>(名称:字符串)</li><li id="edf8" class="nk nl iq jp b jq nt ju nu jy nv kc nw kg nx kk np nq nr ns bi translated"><a class="ae mt" href="https://developer.android.com/reference/kotlin/androidx/datastore/preferences/core/package-summary#longPreferencesKey(kotlin.String)" rel="noopener ugc nofollow" target="_blank"> longPreferencesKey </a>(名称:字符串)</li><li id="1e27" class="nk nl iq jp b jq nt ju nu jy nv kc nw kg nx kk np nq nr ns bi translated"><a class="ae mt" href="https://developer.android.com/reference/kotlin/androidx/datastore/preferences/core/package-summary#stringPreferencesKey(kotlin.String)" rel="noopener ugc nofollow" target="_blank"> stringPreferencesKey </a>(名称:字符串)</li><li id="18a6" class="nk nl iq jp b jq nt ju nu jy nv kc nw kg nx kk np nq nr ns bi translated"><a class="ae mt" href="https://developer.android.com/reference/kotlin/androidx/datastore/preferences/core/package-summary#stringSetPreferencesKey(kotlin.String)" rel="noopener ugc nofollow" target="_blank">stringSetPreferencesKey</a>(名称:字符串)</li></ul><h2 id="757c" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">步骤4:将数据写入数据存储</h2><p id="659e" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">要将数据写入数据存储，我们需要调用edit()方法，让我们创建一个函数来完成这项工作:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">如何在首选项数据存储中写入/编辑数据</figcaption></figure><h2 id="6f94" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">步骤5:从数据存储中读取数据</h2><p id="041e" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">要读取数据，我们需要从datastore中访问"<em class="mp"> data </em>"属性，data属性是一个<a class="ae mt" href="https://developer.android.com/kotlin/flow" rel="noopener ugc nofollow" target="_blank"><em class="mp">Flow</em></a><em class="mp">&lt;</em><a class="ae mt" href="https://developer.android.com/reference/kotlin/androidx/datastore/preferences/core/Preferences" rel="noopener ugc nofollow" target="_blank"><em class="mp">Preferences</em></a><em class="mp">&gt;</em>，因此我们可以获得整个首选项，也可以将其映射为我们实际需要的值:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">从数据存储中读取数据</figcaption></figure><h2 id="2064" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">步骤6:处理异常</h2><p id="6f8e" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">使用flow对象，我们还可以捕获异常:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">如何捕获数据存储异常</figcaption></figure><h2 id="ec8a" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">步骤7:创建DataStoreManager(可选)</h2><p id="7dbd" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">为了充分利用数据存储，最好使用一个集中式类来保存与读取和写入数据相关的每个逻辑，而不要直接公开数据存储，这样可以确保这是应用程序中唯一会对数据存储进行实际更改的地方，从而防止代码重复以及可能导致的问题:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="34b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用这种方法，我们不能直接编辑数据存储，我们需要使用管理器，确保每个IO操作都在单个类中处理。</p><h1 id="1468" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">在我们的应用中使用数据存储</h1><p id="fbe2" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">现在我们已经看到了如何实现数据存储，让我们看看如何在我们的计数器应用程序示例中使用它。</p><h2 id="cba8" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">第一步:主要活动布局</h2><p id="b4c9" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们的计数器将有一个非常简单的界面，我们将有一个编辑文本来显示和设置计数器的当前值，2个按钮用于将值增加和减少1，最后一个按钮用于将编辑文本的当前值设置到数据存储中:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h2 id="4d20" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">步骤2:实例化我们的经理</h2><p id="bb15" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">布局准备好了，我们就可以开始我们的活动类了，让我们从获取所有我们需要的视图并添加管理器开始。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="6580" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，我们用<em class="mp">CounterDataStoreManager(this)，</em>实例化了我们的计数器数据存储管理器，但这仅在活动中是可能的(活动是一个上下文)，如果您在片段或自定义视图中这样做，您将需要将“context”或“requireContext()”而不是“this”传递给构造函数。</p><h2 id="9f35" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">步骤3:读取数据存储</h2><p id="d247" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">要读取我们的数据存储的内容，我们所要做的就是“收集”我们的流，这样，每当计数器值有任何变化时，就会触发一个回调:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h2 id="26a7" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">步骤4:用户交互</h2><p id="7e48" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">现在我们已经有了所有的基础，让我们实现点击监听器:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="f4a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，完整的主要活动:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ni nj l"/></div></figure></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><p id="629e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样！现在你有了一个全功能和持久的计数器应用程序。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi of"><img src="../Images/27d0c45f303d6968b118199e8a92738b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*WIVaOtBE9n_nPvEbhib5zg.gif"/></div></figure></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><p id="782d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在这里找到源代码:</p><div class="og oh gp gr oi oj"><a href="https://github.com/GB0307/android_datastore_counter_app" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">GitHub-GB 0307/Android _ datastore _ counter _ app</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">在GitHub上创建一个帐户，为GB 0307/Android _ datastore _ counter _ app开发做贡献。</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">github.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox kv oj"/></div></div></a></div><p id="6e45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望这篇文章对你有用！请继续关注第2部分，在那里我将讨论原型数据存储，一旦发布，请关注我以获得通知。</p></div></div>    
</body>
</html>