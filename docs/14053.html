<html>
<head>
<title>Flutter — Offline First</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">颤动—离线优先</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/flutter-offline-first-da871c36cfc0?source=collection_archive---------3-----------------------#2022-10-28">https://levelup.gitconnected.com/flutter-offline-first-da871c36cfc0?source=collection_archive---------3-----------------------#2022-10-28</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><figure class="it iu gq gs iv iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj is"><img src="../Images/977a84fb74dd182d5e43fa6b83550c20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TDc3rWklaETwhY66ZIHcow.png"/></div></div><figcaption class="jd je gk gi gj jf jg bd b be z dk translated"><a class="ae jh" href="/@simbu/membership" rel="noopener ugc nofollow" target="_blank">加入媒体</a>查看所有<a class="ae jh" href="https://medium.com/@simbu/flutter-digestableme-articles-4b39de2d82fc" rel="noopener">文章</a>，或者查看<a class="ae jh" href="/@simbu/flutter-digestableme-code-ecb5027fb7b1" rel="noopener ugc nofollow" target="_blank">代码</a>。</figcaption></figure><div class=""/><blockquote class="kh ki kj"><p id="60a3" class="kk kl km kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li in bi translated">离线是我的默认状态，连接是一个很好的补充</p><p id="5c53" class="kk kl km kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li in bi translated">克里斯蒂安·米勒</p></blockquote><p id="9d2d" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">为了首先支持离线，我添加了一个新特性，它监视客户端设备连接，并用两个值“在线”和“离线”更新“连接”状态。</p><figure class="lm ln lo lp gu iw gi gj paragraph-image"><div class="ab gv cl lq"><img src="../Images/14e012d10637f97907a0e249c9359327.png" data-original-src="https://miro.medium.com/v2/format:webp/1*8G-8Wny_z9MZrTCpki2VXA.png"/></div><figcaption class="jd je gk gi gj jf jg bd b be z dk translated">连接检测器—示例故事</figcaption></figure><figure class="lm ln lo lp gu iw gi gj paragraph-image"><div class="ab gv cl lq"><img src="../Images/82432ad6a4a0f5aa527c9ebc9723a063.png" data-original-src="https://miro.medium.com/v2/format:webp/1*5Yu0-vC1zhPuWmFUANN0cA.png"/></div><figcaption class="jd je gk gi gj jf jg bd b be z dk translated">连接检测功能测试</figcaption></figure><p id="11d3" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">在mini '_Offline First_ '系列的下一篇文章中，我将使用新的连接性检测，在脱机时将数据请求指向本地数据库，并在联机API可用时同步它们。</p><h2 id="d75b" class="lr ls jk bd lt lu lv dn lw lx ly dp lz lj ma mb mc lk md me mf ll mg mh mi mj bi translated">哒哒</h2><figure class="lm ln lo lp gu iw gi gj paragraph-image"><div class="ab gv cl lq"><img src="../Images/2d85a15fe5c1ee734c0ec4c8ea54c77f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*H_kPeoOuCVCsHpPsCmOx8w.png"/></div><figcaption class="jd je gk gi gj jf jg bd b be z dk translated">特性测试报告</figcaption></figure><figure class="lm ln lo lp gu iw gi gj paragraph-image"><div class="ab gv cl lq"><img src="../Images/b5bb251b5d55bc288bccae4176339c8f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*vNiZmQOOMOMqJVwfiDM_4A.png"/></div><figcaption class="jd je gk gi gj jf jg bd b be z dk translated">功能测试日志摘录</figcaption></figure><p id="dda5" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">使用<a class="ae jh" href="https://pub.dev/packages/connectivity_plus" rel="noopener ugc nofollow" target="_blank"> connectivity_plus </a>包很容易实现这个特性。</p><p id="8b14" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">它只需要一个新的提供商:</p><pre class="lm ln lo lp gu mk ml mm mn aw mo bi"><span id="dcd2" class="lr ls jk ml b gz mp mq l mr ms">// Package imports:<br/>import 'package:connectivity_plus/connectivity_plus.dart';<br/>import 'package:digestable_prologue/connection_detector/model/network_connection_state.dart';<br/>import 'package:hooks_riverpod/hooks_riverpod.dart';<br/><br/>class NetworkConnectionStateNotifier<br/>    extends StateNotifier&lt;NetworkConnectionState&gt; {<br/>  NetworkConnectionStateNotifier(super.state);<br/><br/>  setNetworkStateByConnectivityResult(ConnectivityResult connectivityResult) {<br/>    var onlineStates = &lt;ConnectivityResult&gt;[<br/>      ConnectivityResult.wifi,<br/>      ConnectivityResult.ethernet,<br/>      ConnectivityResult.mobile<br/>    ];<br/><br/>    var isOnlineState = onlineStates.contains(connectivityResult);<br/><br/>    state = isOnlineState<br/>        ? NetworkConnectionState.online<br/>        : NetworkConnectionState.offline;<br/>  }<br/>}<br/><br/>final networkConnectionStateProvider = StateNotifierProvider&lt;<br/>    NetworkConnectionStateNotifier, NetworkConnectionState&gt;(<br/>  (ref) =&gt; NetworkConnectionStateNotifier(NetworkConnectionState.offline),<br/>);</span></pre><p id="7d8d" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">和一个枚举:</p><pre class="lm ln lo lp gu mk ml mm mn aw mo bi"><span id="9b5c" class="lr ls jk ml b gz mp mq l mr ms">enum NetworkConnectionState {<br/>  offline,<br/>  online<br/>}</span></pre><p id="74df" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">以及带有单个事件引导语句的<a class="ae jh" href="https://pub.dev/packages/connectivity_plus" rel="noopener ugc nofollow" target="_blank"> connectivity_plus </a>包:</p><pre class="lm ln lo lp gu mk ml mm mn aw mo bi"><span id="de9f" class="lr ls jk ml b gz mp mq l mr ms">@override<br/>void initState() {<br/>   super.initState();<br/>   ...<br/>   subscription = Connectivity()<br/>        .onConnectivityChanged<br/>        .listen((ConnectivityResult connectivityResult) {<br/>      ref<br/>          .read(networkConnectionStateProvider.notifier)<br/>          .setNetworkStateByConnectivityResult(connectivityResult);<br/>    });<br/>}</span></pre><h2 id="80d3" class="lr ls jk bd lt lu lv dn lw lx ly dp lz lj ma mb mc lk md me mf ll mg mh mi mj bi translated">经验值</h2><h2 id="9219" class="lr ls jk bd lt lu lv dn lw lx ly dp lz lj ma mb mc lk md me mf ll mg mh mi mj bi translated">测试优先有助于改进和简化设计</h2><p id="7d84" class="pw-post-body-paragraph kk kl jk kn b ko mt kq kr ks mu ku kv lj mv ky kz lk mw lc ld ll mx lg lh li in bi translated">我最初的设计草图是这样的:</p><figure class="lm ln lo lp gu iw gi gj paragraph-image"><div class="ab gv cl lq"><img src="../Images/b3ee2a87c5922e1d2ec24db2c1163472.png" data-original-src="https://miro.medium.com/v2/format:webp/1*b3BcpVYl75PMMG8x80uEZg.png"/></div><figcaption class="jd je gk gi gj jf jg bd b be z dk translated">初始设计</figcaption></figure><p id="5527" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">用一个可以在测试中被覆盖的服务来包装包调用是正确的。</p><p id="4159" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">但是当我开始编写引导程序和功能测试步骤时，它变得复杂了，特别是考虑到GetConnectivity()方法是一个异步的未来，它很快就感觉像一个代码味道，糟糕，超过了复杂的代码。</p><p id="0394" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">最重要的是，我意识到我不需要在“_PrologueApp_”小部件中使用新的ConnectivityServiceProvider。</p><p id="3042" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">取而代之的是，我可以简单地通过这个包监听一个连接性变化事件，然后调用NetworkStateProvider，让它根据ConnectivityResult决定它是在线还是离线。</p><h2 id="1b30" class="lr ls jk bd lt lu lv dn lw lx ly dp lz lj ma mb mc lk md me mf ll mg mh mi mj bi translated">不重要的</h2><h2 id="78bb" class="lr ls jk bd lt lu lv dn lw lx ly dp lz lj ma mb mc lk md me mf ll mg mh mi mj bi translated">flutter_gherkin步长匹配问题</h2><p id="5351" class="pw-post-body-paragraph kk kl jk kn b ko mt kq kr ks mu ku kv lj mv ky kz lk mw lc ld ll mx lg lh li in bi translated">这</p><figure class="lm ln lo lp gu iw gi gj paragraph-image"><div class="ab gv cl lq"><img src="../Images/e02f1f27fbb59ebda9a9007dd6574671.png" data-original-src="https://miro.medium.com/v2/format:webp/1*yLyMAO5MEUjbtUnddlGNHA.png"/></div><figcaption class="jd je gk gi gj jf jg bd b be z dk translated">摆动小黄瓜跑步</figcaption></figure><p id="0262" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">匹配这个</p><figure class="lm ln lo lp gu iw gi gj paragraph-image"><div class="ab gv cl lq"><img src="../Images/1e2a4215f16cce0a427c2ad0e89b8967.png" data-original-src="https://miro.medium.com/v2/format:webp/1*xIBy9Xec44ZuTDrodeP5ZQ.png"/></div><figcaption class="jd je gk gi gj jf jg bd b be z dk translated">iPhone的一步</figcaption></figure><p id="ec7b" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">而不是这个</p><figure class="lm ln lo lp gu iw gi gj paragraph-image"><div class="ab gv cl lq"><img src="../Images/fc527ffe348a272d687f84fbfd24cb5a.png" data-original-src="https://miro.medium.com/v2/format:webp/1*yoFgPXQ2YJqr_FXlIsra7g.png"/></div><figcaption class="jd je gk gi gj jf jg bd b be z dk translated">飞行模式下的iPhone步骤</figcaption></figure><p id="0c2d" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">导致测试失败，因为网络连接设置为wifi！</p><figure class="lm ln lo lp gu iw gi gj paragraph-image"><div class="ab gv cl lq"><img src="../Images/066d2fdb95ad72cda0a0e5bb8f64a7de.png" data-original-src="https://miro.medium.com/v2/format:webp/1*RUva59na5NDblVXNOxHcqA.png"/></div><figcaption class="jd je gk gi gj jf jg bd b be z dk translated">测试失败</figcaption></figure><p id="761a" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">我将创建一个针对flutter_gherkin的PR来解决这个问题。</p><p id="9c2f" class="pw-post-body-paragraph kk kl jk kn b ko kp kq kr ks kt ku kv lj kx ky kz lk lb lc ld ll lf lg lh li in bi translated">为了解决这个问题，我把“一部iPhone”改名为“一部苹果iPhone”。</p><h2 id="16da" class="lr ls jk bd lt lu lv dn lw lx ly dp lz lj ma mb mc lk md me mf ll mg mh mi mj bi translated">声音和视觉</h2><figure class="lm ln lo lp gu iw gi gj paragraph-image"><div class="ab gv cl lq"><img src="../Images/07290e1a6b6f257c74b2cd1bb8a31ada.png" data-original-src="https://miro.medium.com/v2/format:webp/1*0KYrH47a6ScfyJg-lTvBlg.png"/></div><figcaption class="jd je gk gi gj jf jg bd b be z dk translated">波西海德——假人</figcaption></figure><h2 id="e978" class="lr ls jk bd lt lu lv dn lw lx ly dp lz lj ma mb mc lk md me mf ll mg mh mi mj bi translated">链接</h2><ul class=""><li id="e3e9" class="my mz jk kn b ko mt ks mu lj na lk nb ll nc li nd ne nf ng bi translated"><a class="ae jh" href="https://medium.com/flutter-community/offline-first-with-flutter-be1e8335d976" rel="noopener">先脱机再用颤振</a></li></ul><h2 id="569c" class="lr ls jk bd lt lu lv dn lw lx ly dp lz lj ma mb mc lk md me mf ll mg mh mi mj bi translated">-包裹</h2><ul class=""><li id="5ff3" class="my mz jk kn b ko mt ks mu lj na lk nb ll nc li nd ne nf ng bi translated"><a class="ae jh" href="https://pub.dev/packages/connectivity_plus" rel="noopener ugc nofollow" target="_blank">连通性_plus </a></li></ul></div></div>    
</body>
</html>