<html>
<head>
<title>Send Email From Firebase Cloud Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Firebase云功能发送电子邮件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/send-email-from-firebase-cloud-functions-e406e1f3eea7?source=collection_archive---------1-----------------------#2020-08-19">https://levelup.gitconnected.com/send-email-from-firebase-cloud-functions-e406e1f3eea7?source=collection_archive---------1-----------------------#2020-08-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e31f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何从Firebase云功能发送包含HTML内容的电子邮件</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/39e74394969123cd610ce7e1d8f73f51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dsCLua-wdb1qDvvAfz8MmA.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">沃洛季米尔·赫里先科在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="4174" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你可能想象的那样，在<a class="ae ky" href="https://deckdeckgo.com" rel="noopener ugc nofollow" target="_blank"> DeckDeckGo </a>，我们没有任何合作者来检查公开发布的幻灯片是否有下降内容。我们也还没有实现一个能做到这一点的机器学习机器人。</p><p id="d690" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我正在手动处理这样的任务。我得补充一点，这样做让我很开心。到目前为止发表的所有演讲都很有趣。</p><p id="d3fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管如此，我必须被告知何时甲板出版。这就是为什么我实现了一个<a class="ae ky" href="https://firebase.google.com/docs/functions" rel="noopener ugc nofollow" target="_blank"> Firebase Cloud函数</a>来给我自己发送一封电子邮件，其中包含我快速查看新内容所需的所有信息。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3807" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">设置新的云功能</h1><p id="dcff" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我假设你已经有一个Firebase项目，也已经创建了一些功能。如果没有，可以按照下面的<a class="ae ky" href="https://firebase.google.com/docs/functions/get-started" rel="noopener ugc nofollow" target="_blank">指南</a>开始。</p><p id="b618" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，注意我使用的是<a class="ae ky" href="https://www.typescriptlang.org/" rel="noopener ugc nofollow" target="_blank">类型脚本</a>。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="191b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">我们开始吧</h1><p id="3aed" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">一个函数需要一个触发器，这就是为什么我们在一个名为<code class="fe mz na nb nc b">demo</code>的集合上的<code class="fe mz na nb nc b">index.ts</code>中注册一个函数(当然你的集合可以有不同的名字)。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="6f73" class="nh md it nc b gy ni nj l nk nl">import * as functions from 'firebase-functions';</span><span id="326d" class="nh md it nc b gy nm nj l nk nl">export const watchCreate<strong class="nc iu"><em class="nn"> </em></strong>=<br/>       functions.<br/>       firestore.<br/>       document('demo/{demoId}').onCreate(onCreateSendEmail);</span></pre><p id="10ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以使用任何其他触发器或生命周期，不一定是<code class="fe mz na nb nc b">create</code>那个。</p><p id="35b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了响应触发器的执行，我们声明了一个新的函数来检索新创建的值(<code class="fe mz na nb nc b">const demo = snap.data()</code>)，并且现在添加了一个<code class="fe mz na nb nc b">TODO</code>，它应该被一个有效的发送电子邮件的方法所取代。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="44aa" class="nh md it nc b gy ni nj l nk nl">import { EventContext } from "firebase-functions";<br/>import { DocumentSnapshot } from "firebase-functions/lib/providers/firestore";</span><span id="ec22" class="nh md it nc b gy nm nj l nk nl">interface Demo {<br/>  content: string;<br/>}<br/><br/>async function onCreateSendEmail(<br/>                 snap: DocumentSnapshot, <br/>                 _context: EventContext) {<br/>  const demo: Demo = snap.data() as Demo;<br/><br/>  try {<br/>    // TODO: send email<br/>  } catch (err) {<br/>    console.error(err);<br/>  }<br/>}</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="60f5" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">节点邮件程序</h1><p id="2fc1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了有效地发送邮件，我们将使用<a class="ae ky" href="https://nodemailer.com/" rel="noopener ugc nofollow" target="_blank"> Nodemailer </a>。</p><blockquote class="no np nq"><p id="d390" class="kz la nn lb b lc ld ju le lf lg jx lh nr lj lk ll ns ln lo lp nt lr ls lt lu im bi translated">Nodemailer是Node.js应用程序的一个模块，可以轻松发送电子邮件。该项目始于2010年，当时没有发送电子邮件的合理选项，今天它是大多数Node.js用户默认采用的解决方案。</p><p id="c0ef" class="kz la nn lb b lc ld ju le lf lg jx lh nr lj lk ll ns ln lo lp nt lr ls lt lu im bi translated">Nodemailer在MIT许可证下获得许可。</p></blockquote><p id="fc28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你所注意到的，Nodemailer不仅与Firebase Cloud函数兼容，还与任何<a class="ae ky" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>项目兼容。</p><p id="71dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了在我们的项目中安装它，我们运行以下命令:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="c4d5" class="nh md it nc b gy ni nj l nk nl">npm install nodemailer --save</span></pre><p id="447c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们还安装了它的类型定义。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="c0db" class="nh md it nc b gy ni nj l nk nl">npm install @types/nodemailer --save-dev</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="df5c" class="nh md it bd me nu nv dn mi nw nx dp mm li ny nz mo lm oa ob mq lq oc od ms oe bi translated">SMTP传输</h2><p id="bf92" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Nodemailer使用SMTP作为传递邮件的主要传输方式。因此，您的电子邮件服务提供商应该支持这样的协议。它还支持LTS或STARTTLS扩展。在这篇文章中，我们将使用STARTTLS，因此我们将设置标志<code class="fe mz na nb nc b">secure</code>为<code class="fe mz na nb nc b">false</code>来激活这个协议。</p><p id="4b90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在库<a class="ae ky" href="https://nodemailer.com/smtp/" rel="noopener ugc nofollow" target="_blank">文档</a>中找到所有选项。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c315" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">配置</h1><p id="db24" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">特别是如果您的项目是开源的，您可能会有兴趣不在代码中硬编码您的SMTP登录、密码和主机，而是将它们隐藏在配置中。</p><p id="93ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Firebase提供这样的能力。我们可以创建一个脚本来<code class="fe mz na nb nc b">set</code>这些。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="bb0c" class="nh md it nc b gy ni nj l nk nl">#!/bin/sh<br/>firebase functions:config:set mail.from="hello@domain.com" mail.pwd="password" mail.to="david@domain.com" mail.host="mail.provider.com"</span></pre><p id="5f41" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了在我们的函数中检索这些配置，我们可以通过<code class="fe mz na nb nc b">functions.config()</code>访问配置，后跟我们刚刚在上面定义的键。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="378f" class="nh md it nc b gy ni nj l nk nl">const mailFrom: string = functions.config().mail.from;<br/>const mailPwd: string = functions.config().mail.pwd;<br/>const mailTo: string = functions.config().mail.to;<br/>const mailHost: string = functions.config().mail.host;</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="5fb0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">发送电子邮件</h1><p id="a660" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们有了传输，我们有了配置，我们只需要最后一块:消息。</p><p id="6c3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我更喜欢发送我自己的HTML电子邮件，允许我在内容中包含链接，这就是为什么在这里，我们也使用这样的格式。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="afdf" class="nh md it nc b gy ni nj l nk nl">const mailOptions = {<br/>  from: mailFrom,<br/>  to: mailTo,<br/>  subject: 'Hello World',<br/>  html: `&lt;p&gt;${demo.content}&lt;/p&gt;`<br/>};</span></pre><p id="761d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以使用Nodemailer来创建通道，并最终发送我们的电子邮件。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="bba0" class="nh md it nc b gy ni nj l nk nl">const transporter: Mail = nodemailer.createTransport({<br/>  host: mailHost,<br/>  port: 587,<br/>  secure: false, // STARTTLS<br/>  auth: {<br/>    type: 'LOGIN',<br/>    user: mailFrom,<br/>    pass: mailPwd<br/>  }<br/>});</span><span id="7cc1" class="nh md it nc b gy nm nj l nk nl">await transporter.sendMail(mailOptions);</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a4dd" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">总共</h1><p id="eb1d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">总而言之，我们的功能如下:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="a4ee" class="nh md it nc b gy ni nj l nk nl">import * as functions from 'firebase-functions';<br/><br/>import { EventContext } from "firebase-functions";<br/>import { DocumentSnapshot } from "firebase-functions/lib/providers/firestore";<br/><br/>import * as Mail from "nodemailer/lib/mailer";<br/>import * as nodemailer from "nodemailer";<br/><br/>export const watchCreate<strong class="nc iu"><em class="nn"> </em></strong>=<br/>       functions.<br/>       firestore.<br/>       document('demo/{demoId}').onCreate(onCreateSendEmail);<br/><br/>interface Demo {<br/>  content: string;<br/>}<br/><br/>async function onCreateSendEmail(<br/>                 snap: DocumentSnapshot, <br/>                 _context: EventContext) {<br/>  const demo: Demo = snap.data() as Demo;<br/><br/>  try {<br/>    const mailFrom: string = functions.config().info.mail.from;<br/>    const mailPwd: string = functions.config().info.mail.pwd;<br/>    const mailTo: string = functions.config().info.mail.to;<br/>    const mailHost: string = functions.config().info.mail.host;<br/><br/>    const mailOptions = {<br/>      from: mailFrom,<br/>      to: mailTo,<br/>      subject: 'Hello World',<br/>      html: `&lt;p&gt;${demo.content}&lt;/p&gt;`<br/>    };<br/><br/>    const transporter: Mail = nodemailer.createTransport({<br/>      host: mailHost,<br/>      port: 587,<br/>      secure: false, // STARTTLS<br/>      auth: {<br/>        type: 'LOGIN',<br/>        user: mailFrom,<br/>        pass: mailPwd<br/>      }<br/>    });<br/><br/>    await transporter.sendMail(mailOptions);<br/>  } catch (err) {<br/>    console.error(err);<br/>  }<br/>}</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="25aa" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">摘要</h1><p id="b1be" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在Firebase和Nodemailer的帮助下，可以相对快速地设置触发电子邮件的功能。我希望这篇介绍能给你一些关于如何实现这样一个特性的提示，并且希望你能在下一次演讲中尝试使用<a class="ae ky" href="https://deckdeckgo.com" rel="noopener ugc nofollow" target="_blank"> DeckDeckGo </a>。</p><p id="358c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我期待着收到一封电子邮件，告诉我我必须检查您发布的幻灯片😉。</p><p id="d8b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到无限和更远的地方！</p><p id="2b4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大卫</p></div></div>    
</body>
</html>