# Rails 超高速性能的终极指南

> 原文：<https://levelup.gitconnected.com/ultimate-guide-to-blazing-fast-performance-in-rails-1-77e281a1df52>

## 如何让 Rails 扩展到每分钟数百万个请求？

![](img/e1c889139515f457f6676f618cbfe7a0.png)

马里奥·卡尔沃在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

当你希望你的项目或创业有高的开发速度时，Ruby on Rails 是一个巨大的框架。它开箱即用，并附带了大量的幕后魔术，使您的生活更加轻松。然而，就性能而言，它并不被认为是最快的框架。您会发现个人和公司偏离 Rails 而转向其他事物的例子。尽管如此，仍有许多公司成功地扩展了 Rails，并取得了成功——看看 Airbnb、Github、Gitlab 和 Shopify 就知道了。

所以在您跳槽之前，您应该考虑在使用 Rails 时将性能放在第一位，您也可以成功。本文旨在列出我多年来学到的最重要的技巧和诀窍，让 Rails 以极快的速度运行，并扩展到每分钟数百万个请求。

## 目录

1.  [通用提示](#ab52)
2.  [活动记录(数据库)](#fbdb)
3.  [服务器&硬件](#4b25)
4.  [顶上的樱桃(杂项)](#a05e)
5.  [高级](#19aa)

# 一般提示

首先，有一些在 Rails 项目中实现的通用技巧，可以帮助你走向成功。

## 建立一个 APM

如果您不首先度量它，您就不能提高性能，这使得有必要跟踪和监控正确的度量。您应该跟踪加载时间、请求时间和数据库查询时间等。就我个人而言，我发现 [New Relic](https://newrelic.com/) 是 Rails 最好的 APM 工具之一，但是价格有点贵。一个更实惠的选择是 SkyLight 的免费试用。

## 保持最新

我个人知道为你的项目更新 Rails 版本是多么可怕，如果你让它过时太久，我同情那些经历这种折磨的人。所以帮你自己一个忙，试着与 Ruby 和 Rails 的新版本保持同步。这将有助于您避免跨越多个版本的痛苦，并确保您拥有所有更新的性能增强。

## 帕累托原则(80/20 法则)

这是一个众所周知的软件开发规则——帕累托原则。它也被称为“重要的少数法则”，指出对于大多数事件，80%的结果是由 20%的原因产生的。这背后的想法是，当您有更大的问题需要解决时，不要在微优化上浪费时间。如果您的数据库查询非常慢，那么通过在序列化中减少毫秒数，您不会有太大的成就。所以小心选择你的战斗。

## 保持精简

Rails 背后有一个令人惊叹的社区和一个宝石库支持，可以轻松帮助您完成复杂的任务。但是很容易忘乎所以地将宝石添加到项目中，导致膨胀。在选择添加到项目中的 gem 时要小心，并尽量保持依赖关系的精简。

## 偷懒——在后台工作中做

每当你需要做一些复杂或长时间运行的事情时，考虑把它扔给后台工作人员——发送电子邮件、推送通知、上传图片等等。最小化主线程中的工作将确保对用户的快速响应。对我们来说，好消息是 Rails 有多种选择来轻松实现这一点——[Sidekiq](https://github.com/mperham/sidekiq)、 [Rescue](https://github.com/resque/resque) 或 [ActiveJob](https://guides.rubyonrails.org/v4.2/active_job_basics.html) 。

## **改变你的串行器**

如果您的项目中有一个 API，您最有可能使用 ActiveModelSerializers gem 来序列化您的数据。我强烈建议切换到网飞的 fast_jsonapi。这个 gem 比默认的 ActiveModelSerializers 快得多，我个人可以凭经验证明这一点。

## 把我藏在外面

有时，如果您有大量静态数据，或者您不能让事情变得更快，另一种替代方法是使用缓存。Rails 使得开箱即用变得非常容易。下面是一个使用到期时间进行缓存的简单示例:

```
# Lets say you have some categories you offer in your project.Rails.cache.fetch("categories", expires_in: 5.minutes) do 
   Categories.all.map(&:name)
end
```

# 活动记录(数据库)

ActiveRecord 是 Rails 提供的神奇的 ORM(有史以来最好的 ORM 之一)。很容易陷入易用性而不了解细节，这可能会在未来导致瓶颈。

## **使用你的数据库**

这是许多开发人员没有注意到或没有实现的事情，因为他们急于用代码做所有的事情，或者可能他们被编写原始 SQL 吓倒了。但是只要可能或方便，你应该使用你的数据库。在 Ruby 中处理和排序数据结构会占用大量 CPU 时间，而你的数据库可以毫不费力地做到这一点。

## 偷看窗帘后面

不要沉迷于动态记录的魔力，而不去担心幕后发生的事情。为了清除性能瓶颈，您需要查看被触发的实际查询并理解它们。在开发环境中，Rails 将打印出所有正在运行的查询，这允许您注意到任何不必要的查询。此外，这里有一些技巧可以帮助你更深入地挖掘:

## SQL 魔法

别担心，我不会建议你用原始的 SQL 查询写所有的东西。但是学习 SQL 和数据库设计的基础知识将帮助您更好地理解幕后发生的事情，并允许您根据需要优化查询。作为一名软件开发人员，这是一项很有价值的技能，将对你的职业生涯大有帮助。

## 吝啬

提高查询效率的一个方法是只选择您真正需要的内容。指定需要数据库检索哪些列，而不是执行`SELECT *`。默认情况下，ActiveRecord 选择所有内容，但是您可以利用`select`或`pluck`来解决这个问题。

## N+1 个查询

这是一个经典问题。如果您从数据库加载一个`Blog`，然后试图通过遍历记录来查找该博客的所有评论，那么您是在强迫 Rails 为每个评论运行一个查询。这可以通过预加载注释`Blog.includes(:comments)`来消除，并有助于避免 N+1 查询问题。 **Pro 提示:**看看 [Bullet](https://github.com/flyerhzm/bullet) gem 帮你找到任何 N+1 的查询问题。

## 组合查询

当在一个项目中与多个开发人员的大型团队合作时，有时您会注意到每个接触代码库的人可能会在整个代码路径中添加查询。通常，这些查询可以在代码路径的顶部合并成更少的查询。这确保了没有重复的查询，并允许数据库有策略地完成繁重的工作。

## 索引，索引，索引

这是不应被忽视的数据库最佳实践。如果索引不正确，将会对数据库性能产生负面影响，并导致不必要的表扫描。当构建一个新特性时，要提前考虑项目中将要查询的内容，并尝试添加正确的索引。如果你有一个现有的项目，你总是可以使用[活动记录医生](https://github.com/gregnavis/active_record_doctor)或 [LolDBA](https://github.com/plentz/lol_dba) 来嗅出缺失的索引。

## 迁移

当您大规模运行时，您的表中有数百万条记录，不幸的是，在 Rails 中运行迁移的正常方式将会失败。他们会在很长一段时间内出错或锁定表格，使您的网站瘫痪。在过去处理过这个问题之后，有两个工具可以为您解决这个棘手问题:

*   [**Gh-ost**](https://github.com/github/gh-ost) **:** 这是一个 MySQL 的无触发在线模式迁移解决方案，也是唯一一个适合我大规模使用的工具。
*   [**LHM**](https://github.com/soundcloud/lhm)**:**这将在您的表仍在线时迁移它们，而不会锁定您的表。

## 极端提示:如果你敢，就使用原始 SQL

如果有一个端点迫切需要性能，您可以考虑将整个功能中的所有活动记录查询合并到顶部的一个大规模 SQL 查询中，以提取满足用例所需的任何记录。**免责声明:**是的，维护海量的原始 SQL 查询很难，可读性也比较差。但我确实提到这只是在绝望的情况下。

# 服务器和硬件

在部署 Rails 项目时，需要记住一些关于底层基础设施和架构的事情。

## 选择可扩展的架构

随着云基础设施的发展，构建裸机服务器来扩展应用程序的日子已经一去不复返了。当决定 Rails 项目的底层架构时，您应该利用可伸缩的基于云的系统。例如，您可以使用 AWS Fargate 或 Kubernetes 根据需要自动扩展 dockerized Rails 应用程序。

## 布罗特利压缩

Brotli 是另一种基于 gzip 的压缩算法，有多处改进，压缩比更好。现在大多数 web 服务器都支持它，添加它是优化压缩速度的一种简单方法。嗯，谁不想免费提高网络性能呢？(参考: [Brotli vs Gzip](http://www.instantshift.com/2018/03/02/gzip-vs-brotli-compression/) )

## 给它更多的果汁

Rails 因使用大量内存而臭名昭著，尤其是当您有多个 puma workers 在运行时。所以不要让你的应用程序口渴，从一开始就给它一些果汁。您可以利用云提供商上的内存优化实例来帮助您取得成功。不要忘记留意服务器上的交换使用情况。

## 调谐

从 Rails 5 开始，Rails 的 web 服务器已经切换到 Puma，默认情况下，它将只运行一个 worker。一旦设置好 Rails 部署，就要确保将工作线程的数量增加到机器上可用的内核或更合理的数量。

## HTTP/2

如果您正在使用类似 Nginx 的反向代理，请确保您打开了 HTTP/2 选项，以获得所有的性能优势。

# 顶端的樱桃(杂项)

我们就要到达终点了——这一部分是关于性能的一些额外提示。

## 不要使用动态方法

Rails magic 是有代价的。其中一些方法会消耗大量资源，最好不要使用它们。例如，`find_by()`和`find_all_by()`有点慢，因为它们需要遍历`method_missing`并根据数据库中的列列表解析名称。

## 节流

随着您的扩展，您肯定会在各种端点上遇到恶意尝试，这些尝试无法被缓存，并且会导致消耗资源的昂贵操作。为了解决这个问题，我建议添加一个类似 [rack-attack](https://github.com/kickstarter/rack-attack) 的插件，在登录、重置密码或注册等端点上实现节流。

## 了解你的 O(n) vs O(1)

随着数据集大小的增加，我们需要注意代码在时间复杂度方面的影响。在需要处理或循环大量数据的情况下，可以考虑使用散列，而不是默认使用数组。

## 总是使用 CDN

你所有的静态资产都应该由 CDN 提供，并确保缓存策略是合理的。如果您想要对缓存失效进行粒度控制，可以考虑使用 e 标签和缓存控制。

# 先进的

极端情况下，可以考虑一些高级优化。我认为，如果你已经达到了这一点，可能是时候考虑为你的项目的某些计算密集型部分使用其他语言了，所以我将保持这一部分的简短。

## 复习 C 语言

Ruby 的主要实现是用 C 语言编写的，这允许你用 C 语言重写代码中较慢的部分——例如，如果你正在使用加密算法来生成证书。如果您对深入 C 代码的想法不感兴趣，您可以利用 Rails 社区用 C 编写的第三方 gem。

## 更快的后台作业

随着后台工作量的增加，您可以将后台工作人员切换到性能更好的语言。通过利用 Redis 或亚马逊 SQS 这样的队列，工作人员可以脱离到他们自己的微服务中。检查这个 Sidekiq 兼容的 [go-workers](https://github.com/jrallison/go-workers) 库或者用[水晶](https://github.com/mperham/sidekiq.cr)编写的 sidekick 版本作为两个选项。

## 尝试更快版本的 Ruby

有一些 Ruby 的实现旨在提高性能。如果你对这些变化感兴趣，快速浏览一下[松露红宝石](https://github.com/oracle/truffleruby)或 [JRub](https://www.jruby.org/) y

# 底线

如果我们看看使用 Rails 的公司，我们会发现他们能够利用 Rails 惊人的开发速度将客户放在第一位，并在扩展时设法提高性能。在本文中，我们讨论了提高性能的多种技巧和诀窍。我希望这个指南对你有所帮助。下次见。

# 喜欢谈论科技或创业？

你很幸运，我也是！如果你想聊聊前沿技术、企业家精神或创业的风险，可以在推特(Twitter)或领英(LinkedIn)上找到我。