<html>
<head>
<title>How To Easily Build Great Domain Events</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何轻松构建伟大的领域事件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-easily-build-great-domain-events-c2be0b24a108?source=collection_archive---------14-----------------------#2021-02-09">https://levelup.gitconnected.com/how-to-easily-build-great-domain-events-c2be0b24a108?source=collection_archive---------14-----------------------#2021-02-09</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><div class=""/><figure class="gl gn jt ju jv jw gh gi paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="gh gi js"><img src="../Images/555a4a2fb0c672931f4754f82378ab2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*838nJHDO_YT8LRhY"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">丹尼尔·麦卡洛在<a class="ae kh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="4ba7" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">决定如何最好地构造一个域事件可能是困难的，在本文中，我将解释一种方法来确定什么信息应该进入一个域事件以使其有用。</p><h1 id="6b6e" class="lg lh iv bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">什么是域事件？</h1><p id="e916" class="pw-post-body-paragraph ki kj iv kk b kl me kn ko kp mf kr ks kt mg kv kw kx mh kz la lb mi ld le lf io bi translated">域事件是应用程序发出的通知，告知发生了一些事情。它在你们的生态系统中广播，任何人都可以听。域事件不指定哪些应用程序应该采取行动；每个应用程序都可以根据特定的域事件决定是否需要采取任何措施。</p><p id="3b5b" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">一个类似的真实世界的例子是，一个市场交易者向所有路人大喊土豆特价。有些人可能会觉得这笔交易很有趣，于是走过去看一看，有些人可能会问和他们在一起的人是否应该买些土豆，而其余的人则根本不理会他们的喊叫，继续做他们的事情。</p><p id="377c" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">要记住的最重要的事情之一是，域事件是在给定时间点发生的事情的快照。像真实世界的事件一样，它们是不可变的——它们在发布后不能更改或更新。出于这个原因，用过去式表达它们是很重要的——不要用“用户注册”作为域事件，而应该用“用户注册”。</p><h1 id="9d7d" class="lg lh iv bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak">为什么要使用域事件？</strong></h1><p id="bbb6" class="pw-post-body-paragraph ki kj iv kk b kl me kn ko kp mf kr ks kt mg kv kw kx mh kz la lb mi ld le lf io bi translated">领域事件有多种用例。最常见的一种方法是对您的生态系统中发生的事情进行审计跟踪。这可以用于合规性或调试。由域事件生成的审计跟踪让您可以很容易地看到到底发生了什么。</p><p id="8594" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">领域事件的另一个常见用例是将系统彼此分离。在一个拥有多个不同职责的系统的架构中，您可以通过转移到由域事件提供的异步通信来打破系统之间的紧密耦合，其中生产者现在不再关心消费者是否采取了进一步的行动。当应用程序需要及时响应时，它们总是需要彼此直接对话，但是如果需要采取通常不是时间关键的动作(例如发送电子邮件),这是域事件的完美用例。</p><p id="7297" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">例如，考虑一个允许用户购买文具的应用程序。当购买发生时，买家会期待它被交付。由于交付不是用户参与的事情，因此与用户交互的应用程序可以发布一个“order purchased”域事件，负责交付的应用程序可以使用该事件，并采取所需的行动将文具交付给买方。</p><p id="f1e6" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">我将介绍的最后一个用例是数据分析。在分析用户行为时，企业拥有尽可能多的信息是至关重要的，这样它就可以改进他们的产品，并了解他们应该把精力放在哪里。</p><p id="1653" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">在我们开始构造领域事件之前，我想快速介绍一下领域事件的一些一般方面。</p></div><div class="ab cl mj mk hz ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="io ip iq ir is"><h1 id="2299" class="lg lh iv bd li lj mq ll lm ln mr lp lq lr ms lt lu lv mt lx ly lz mu mb mc md bi translated"><strong class="ak">我如何设计领域活动？</strong></h1><p id="464e" class="pw-post-body-paragraph ki kj iv kk b kl me kn ko kp mf kr ks kt mg kv kw kx mh kz la lb mi ld le lf io bi translated">我用来构造域事件的方法最容易被描述为询问。我问自己四个简单的问题，看看领域事件是否能回答这些问题:</p><h2 id="99e0" class="mv lh iv bd li mw mx dn lm my mz dp lq kt na nb lu kx nc nd ly lb ne nf mc ng bi translated"><strong class="ak">发生了什么？</strong></h2><p id="70e1" class="pw-post-body-paragraph ki kj iv kk b kl me kn ko kp mf kr ks kt mg kv kw kx mh kz la lb mi ld le lf io bi translated">这是最重要的问题；如果这个问题不容易回答，那么领域事件可能不适合这个目的。一般来说，一个领域事件的<em class="nh">什么</em>大多是通过名字来回答的。这是一个<em class="nh">领域</em>事件，因此应该描述与您的领域相关的重要事情。例如，如果您在医疗保健行业工作，您可能拥有诸如患者、医生和预约等术语，以及反映该领域的领域事件，如“预约”、“患者已注册”和“医生已分配到预约”。这应该让任何阅读该事件的人都清楚<em class="nh">是什么</em>。记住，名字要用过去式！</p><p id="530e" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">可能还需要补充信息来回答<em class="nh"> what </em>，例如，对于“已付款”，您可能希望至少提供付款方式和金额。</p><p id="fe11" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">以预约为例，<em class="nh">什么</em>可能是这样的:</p><pre class="ni nj nk nl gt nm nn no np aw nq bi"><span id="343c" class="mv lh iv nn b gy nr ns l nt nu">{<br/>  "event": {<br/>    "schema": "iglu:com.examplecompany/appointment_booked/1-0-0",<br/>    "data": {<br/>      "appointment_id": 1<br/>      "appointment_type": "checkup"<br/>    }<br/>  }<br/>}</span></pre><p id="d0f0" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">在示例中，我们将使用JSON模式。它可以用来定义你的域事件应该采用什么格式，这里有更多关于JSON模式如何工作的信息。</p><h2 id="930f" class="mv lh iv bd li mw mx dn lm my mz dp lq kt na nb lu kx nc nd ly lb ne nf mc ng bi translated">什么时候发生的？</h2><p id="242f" class="pw-post-body-paragraph ki kj iv kk b kl me kn ko kp mf kr ks kt mg kv kw kx mh kz la lb mi ld le lf io bi translated">这是一个非常简单的问题，但是知道域事件何时发生非常有用。对某些事件来说，这可能不重要，但对其他事件来说，这将是至关重要的。</p><p id="2622" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">与任何软件一样，总会有事情不按计划进行的时候——例如，假设由于网络问题，您的一个服务器发布域事件时出现问题，而其他的都很好。这意味着一些事件没有被接收到——如果下游应用程序管理订单的交付，如果事件上没有时间戳，并且用户对其交付地址进行了两次更改，但第一个事件(包含错误的交付地址，已被第二个事件取代)实际上在第二个事件之后被接收到，会发生什么情况？快递会送到错误的地址。但是，如果事件上有时间戳，下游系统可以确保如果它在最后一次更新之前接收到带有时间戳的事件，它不会更新传递地址。</p><p id="803d" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">这也是为什么确保事件有效负载上的时间戳是实际事件发生的时间，而不是事件发布的时间非常重要——这属于消息有效负载的元数据部分。</p><p id="01b1" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">让我们将的时间<em class="nh">添加到“预约”示例中:</em></p><pre class="ni nj nk nl gt nm nn no np aw nq bi"><span id="a187" class="mv lh iv nn b gy nr ns l nt nu">{<br/>  "event": {<br/>   "schema": "iglu:com.examplecompany/appointment_booked/1-0-0",<br/>    "data": {<br/>      "appointment_id": 1<br/>      "appointment_type": "checkup",<br/>      "booked_at": "2021-01-01T13:13:35Z",<br/>      "appointment_timestamp": "2021-01-18T15:00:00Z"<br/>    }<br/>  }<br/>  "metadata": {<br/>    "published_at": "2021-01-01T13:13:47Z"<br/>  }<br/>}</span></pre><h2 id="fc1f" class="mv lh iv bd li mw mx dn lm my mz dp lq kt na nb lu kx nc nd ly lb ne nf mc ng bi translated"><strong class="ak">这次活动的参与者是谁？</strong></h2><p id="eea4" class="pw-post-body-paragraph ki kj iv kk b kl me kn ko kp mf kr ks kt mg kv kw kx mh kz la lb mi ld le lf io bi translated">虽然从表面上看<em class="nh">域名事件是关于谁的</em>听起来不言自明，但还是有一些细微差别需要考虑。如果举一个简单的例子，客户在网站上下订单，您会期望发布一个“order purchased”域事件，其中包含下订单的用户的某种标识符—例如，用户ID。</p><p id="3edc" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">然而，如果用户也可以拨打一个电话号码进行订购，然后有一个销售代理代表用户进行订购，会发生什么情况呢？在这种情况下，不仅要包含订单所属用户的标识符，还要包含在系统中实际下订单的销售代理的信息，例如，代理ID。</p><p id="c23e" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">这将允许消费者从事件中获得更多的上下文，在这个例子中，能够区分用户和下订单的销售代理是非常有用的信息。例如，如果没有关于代理的任何信息，就不可能确定在线订单与电话订单之间的百分比，而这对于公司来说是非常有价值的。</p><p id="3491" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">这就是我们的活动现在的样子，添加了的<em class="nh">:</em></p><pre class="ni nj nk nl gt nm nn no np aw nq bi"><span id="2851" class="mv lh iv nn b gy nr ns l nt nu">{<br/>  "event": {<br/>    "schema": "iglu:com.examplecompany/appointment_booked/1-0-0",<br/>    "data": {<br/>      "appointment_id": 1<br/>      "appointment_type": "checkup",<br/>      "booked_at": "2021-01-01T13:13:35Z",<br/>      "appointment_timestamp": "2021-01-18T15:00:00Z"<br/>      "patient_id": 900<br/>      "booked_by": "sales_agent"<br/>      "booked_by_id": 500<br/>    }<br/>  }<br/>  "metadata": {<br/>    "published_at": "2021-01-01T13:13:47Z"<br/>  }<br/>}</span></pre><h2 id="f9a9" class="mv lh iv bd li mw mx dn lm my mz dp lq kt na nb lu kx nc nd ly lb ne nf mc ng bi translated"><strong class="ak">在哪里发生的？</strong></h2><p id="f763" class="pw-post-body-paragraph ki kj iv kk b kl me kn ko kp mf kr ks kt mg kv kw kx mh kz la lb mi ld le lf io bi translated">最后，域事件发生在哪里？通常，这意味着在什么样的设备上——是在您的移动应用程序上吗？你网站上的平板电脑用户？还是桌面用户？</p><p id="e58b" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">然而，继续我们预约的例子，预约发生的地点是一个关键的信息。最后，让我们将<em class="nh"> where </em>添加到我们的示例中:</p><pre class="ni nj nk nl gt nm nn no np aw nq bi"><span id="ef78" class="mv lh iv nn b gy nr ns l nt nu">{<br/>  "event": {<br/>    "schema": "iglu:com.examplecompany/appointment_booked/1-0-0",<br/>    "data": {<br/>      "appointment_id": 1<br/>      "appointment_type": "checkup",<br/>      "booked_at": "2021-01-01T13:13:35Z",<br/>      "appointment_timestamp": "2021-01-18T15:00:00Z"<br/>      "user_id": 900<br/>      "booked_by": "sales_agent"<br/>      "location": "Westminster Hospital"<br/>    }<br/>  }<br/>  "metadata": {<br/>    "published_at": "2021-01-01T13:13:47Z",<br/>    "device_type": "mobile"<br/>  }<br/>}</span></pre></div><div class="ab cl mj mk hz ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="io ip iq ir is"><h1 id="0f1d" class="lg lh iv bd li lj mq ll lm ln mr lp lq lr ms lt lu lv mt lx ly lz mu mb mc md bi translated"><strong class="ak">您如何知道您已经涵盖了所有内容？</strong></h1><p id="9d8b" class="pw-post-body-paragraph ki kj iv kk b kl me kn ko kp mf kr ks kt mg kv kw kx mh kz la lb mi ld le lf io bi translated">如果您可以使用您的域事件中的信息回答上述问题，这是一个好迹象，表明它是一个包含正确信息的有用的域事件。</p><p id="d1a0" class="pw-post-body-paragraph ki kj iv kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">您可以尝试自己回答上面的问题，或者更好的测试您的域事件的方法是询问其他人上面的问题，看看他们是否可以使用您的域事件中包含的信息来回答。</p><h2 id="010c" class="mv lh iv bd li mw mx dn lm my mz dp lq kt na nb lu kx nc nd ly lb ne nf mc ng bi translated"><strong class="ak">参考文献</strong></h2><ul class=""><li id="3599" class="nv nw iv kk b kl me kp mf kt nx kx ny lb nz lf oa ob oc od bi translated"><a class="ae kh" href="https://json-schema.org/learn/getting-started-step-by-step.html" rel="noopener ugc nofollow" target="_blank"> JSON模式</a></li></ul></div></div>    
</body>
</html>