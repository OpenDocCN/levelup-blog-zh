<html>
<head>
<title>How to run Nightwatch tests on Heroku Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Heroku管道上运行夜间监视测试</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-run-nightwatch-tests-on-heroku-pipelines-7c21de641003?source=collection_archive---------12-----------------------#2020-01-26">https://levelup.gitconnected.com/how-to-run-nightwatch-tests-on-heroku-pipelines-7c21de641003?source=collection_archive---------12-----------------------#2020-01-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn js jt ju jv gh gi paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gh gi jr"><img src="../Images/fb813730879ea5e3f0c71e067ed975d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OkHnV7j9jgKxy29R255LLQ.png"/></div></div></figure><p id="0807" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">端到端测试是每一个良好的持续集成过程中非常重要的一部分，而<a class="ae la" href="https://nightwatchjs.org/" rel="noopener ugc nofollow" target="_blank"> Nightwatch.js </a>是一个非常好的工具。在本文中，我将向您展示如何轻松地将Nightwatch集成到Heroku构建管道中。我们将使用<a class="ae la" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>和<a class="ae la" href="https://expressjs.com/de/" rel="noopener ugc nofollow" target="_blank"> Express </a>，测试将在Chrome浏览器中运行。</p><p id="0857" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">你可以在这里找到完成的范例项目<a class="ae la" href="https://github.com/TimonBerlin/heroku-pipelines-nightwatch" rel="noopener ugc nofollow" target="_blank"/></p><blockquote class="lb lc ld"><p id="4fb7" class="kc kd le ke b kf kg kh ki kj kk kl km lf ko kp kq lg ks kt ku lh kw kx ky kz im bi translated"><em class="it">“再多的测试也不能证明一个软件是对的，一次测试就能证明一个软件是错的。”</em></p><p id="9587" class="kc kd le ke b kf kg kh ki kj kk kl km lf ko kp kq lg ks kt ku lh kw kx ky kz im bi translated"><em class="it"> -阿米尔·加莱</em></p></blockquote><h1 id="0d9e" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">拥有正确的构建包</h1><p id="4c0a" class="pw-post-body-paragraph kc kd it ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz im bi translated">首先，我们必须定义所需的构建包。使用buildpacks，您可以指定Heroku应该如何设置运行您的应用程序和ci的机器。如果你想了解更多关于buildpacks的信息，你可以看看Heroku <a class="ae la" href="https://devcenter.heroku.com/articles/buildpacks" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="3370" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">出于我们的目的，我们需要三个构建包:</p><ol class=""><li id="10e5" class="ml mm it ke b kf kg kj kk kn mn kr mo kv mp kz mq mr ms mt bi translated">运行我们的应用程序。<a class="ae la" href="https://elements.heroku.com/buildpacks/heroku/heroku-buildpack-nodejs" rel="noopener ugc nofollow" target="_blank">链接</a></li><li id="f848" class="ml mm it ke b kf mu kj mv kn mw kr mx kv my kz mq mr ms mt bi translated">谷歌Chrome来运行我们的夜间监控测试。<a class="ae la" href="https://elements.heroku.com/buildpacks/heroku/heroku-buildpack-google-chrome" rel="noopener ugc nofollow" target="_blank">链接</a></li><li id="b18a" class="ml mm it ke b kf mu kj mv kn mw kr mx kv my kz mq mr ms mt bi translated">和ChromeDriver，以便Nightwatch可以控制Chrome浏览器。<a class="ae la" href="https://elements.heroku.com/buildpacks/heroku/heroku-buildpack-chromedriver" rel="noopener ugc nofollow" target="_blank">链接</a></li></ol><p id="f0b9" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">我们只需在项目的基础上添加一个<code class="fe mz na nb nc b">app.json</code>文件，然后添加下面的代码块。</p><figure class="nd ne nf ng gt jv"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="9a33" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">如果你想知道更多关于<code class="fe mz na nb nc b">app.json</code>的信息，你可以在这里查阅关于它的文档<a class="ae la" href="https://devcenter.heroku.com/articles/app-json-schema" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="6a1b" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">就是这样！现在我们已经完成了构建包的设置。</p><h1 id="8397" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated"><em class="jq">创建守夜配置</em></h1><p id="a83a" class="pw-post-body-paragraph kc kd it ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz im bi translated">既然我们已经将those驱动程序和浏览器添加到我们的环境中，我们需要告诉Nightwatch在哪里可以找到它们。我们通过创建新的Nightwatch配置或向现有配置添加环境来实现这一点。</p><p id="8ee1" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">在本例中，我们将创建一个名为<code class="fe mz na nb nc b">nightwatch_heroku.conf.js</code>的新配置文件。</p><p id="f1a4" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">为了让一切工作，我们必须添加一些配置的东西。在webdriver键下，我们必须指定<code class="fe mz na nb nc b">server_path</code>。这里我们需要将目录添加到ChromeDriver中。当您使用建议的构建包时，驱动程序的默认路径是<code class="fe mz na nb nc b">/app/.chromedriver/bin/chromedriver</code>。</p><p id="0a9c" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">我们还必须在<code class="fe mz na nb nc b">desiredCapabilities</code>下添加Chrome二进制文件的路径。安装Chrome浏览器的buildpack会自动添加一个带有正确路径的环境变量，所以我们可以使用它。</p><p id="e86a" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">就是这样！现在我们有了守夜人的配置文件。</p><figure class="nd ne nf ng gt jv"><div class="bz fp l di"><div class="nh ni l"/></div></figure><h1 id="6c04" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">准备您的index.js</h1><p id="f1c9" class="pw-post-body-paragraph kc kd it ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz im bi translated">在开始测试之前，我们需要在我们的<code class="fe mz na nb nc b">index.js</code>上做一些准备。</p><p id="bfde" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">首先，我们必须确保我们的应用程序使用正确的端口。Heroku会用我们可以使用的端口自动设置一个环境变量。因此，我们将使用该端口或一些默认端口进行本地测试。</p><figure class="nd ne nf ng gt jv"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="d093" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">我们还必须确保我们的应用程序在启动过程完成时会发出一个事件。我们通过简单地使用listen函数的回调方法来做到这一点。在我们的应用程序监听到所需的端口后，我们只需发出一个事件。</p><figure class="nd ne nf ng gt jv"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="7ace" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">如果您使用的是express之外的任何其他框架，您必须找到自己的实现。</p><p id="151b" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">就是这样！我们的<code class="fe mz na nb nc b">index.js</code>现在准备好了。在下一步中，我们将创建一个test runner脚本，它现在可以等到应用程序完全启动后再开始测试。</p><h1 id="48a1" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">创建测试运行程序脚本</h1><p id="e21d" class="pw-post-body-paragraph kc kd it ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz im bi translated">接下来，我们必须创建一个守夜人跑步者。这个运行者将从代码而不是命令行启动Nightwatch。我们创建一个名为<code class="fe mz na nb nc b">herokuTestRunner.js</code>的新文件。</p><p id="5533" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">正如你在下面的代码中看到的，首先我们等待我们的应用程序发出<code class="fe mz na nb nc b">listening</code>事件。现在我们知道应用程序已经准备好了，我们可以开始测试了。这是通过Nightwatch cli函数完成的。我们只需指定配置文件的路径，并在<code class="fe mz na nb nc b">argv</code>对象中传递它。在这个对象中，您可以添加任何Nightwatch cli参数。</p><p id="5cb5" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">之后，我们开始测试，并定义在出现错误或所有测试成功运行的情况下会发生什么。如果我们的测试过程以除零以外的任何值终止，Heroku会将这个构建标记为失败。</p><figure class="nd ne nf ng gt jv"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="4332" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">现在我们已经做好了运行夜间监视测试的一切准备！</p><h1 id="5b69" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">自动运行测试</h1><p id="0f86" class="pw-post-body-paragraph kc kd it ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz im bi translated">每当我们在Heroku上建立一个分支，我们也想运行我们的守夜人测试。我们只需添加另一个npm脚本来执行我们的测试运行程序。只需在您的<code class="fe mz na nb nc b">package.json</code>中添加以下行即可。</p><figure class="nd ne nf ng gt jv"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="7e40" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">现在我们必须告诉Heroku在测试我们的应用程序时应该运行哪个脚本。这是在<code class="fe mz na nb nc b">app.json</code>中完成的，我们简单地添加下面的块。</p><figure class="nd ne nf ng gt jv"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="2bf5" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">因此，我们只需在那里添加我们的正常测试，还可以添加我们的自定义Nightwatch脚本。就是这样！现在当你触发你的Heroku CI时，你应该看到你的运行守夜人测试正在运行。</p><h1 id="ee17" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="b571" class="pw-post-body-paragraph kc kd it ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz im bi translated">如果你没有时间通读所有这些，下面是基本步骤:</p><ol class=""><li id="6dca" class="ml mm it ke b kf kg kj kk kn mn kr mo kv mp kz mq mr ms mt bi translated">将Chrome和ChromeDriver的构建包添加到您的<code class="fe mz na nb nc b">app.json</code></li><li id="6f94" class="ml mm it ke b kf mu kj mv kn mw kr mx kv my kz mq mr ms mt bi translated">用Chrome和ChromeDriver的正确路径为Heroku创建一个定制的Nightwatch配置。</li><li id="55d0" class="ml mm it ke b kf mu kj mv kn mw kr mx kv my kz mq mr ms mt bi translated">在代码中创建一个守夜人跑步者。</li><li id="eb57" class="ml mm it ke b kf mu kj mv kn mw kr mx kv my kz mq mr ms mt bi translated">添加一个npm脚本来运行Heroku Nightwatch runner。</li><li id="b64d" class="ml mm it ke b kf mu kj mv kn mw kr mx kv my kz mq mr ms mt bi translated">将npm脚本添加到您的<code class="fe mz na nb nc b">app.json</code>中，这样Heroku将在每次构建时运行它。</li></ol><p id="122e" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">正如我之前提到的，你可以在GitHub <a class="ae la" href="https://github.com/TimonBerlin/heroku-pipelines-nightwatch" rel="noopener ugc nofollow" target="_blank">这里</a>查看示例项目。</p><p id="0dd4" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><strong class="ke iu">测试愉快！</strong></p></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><p id="d018" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><em class="le">最初发表于</em><a class="ae la" href="https://github.com/TimonBerlin/heroku-pipelines-nightwatch" rel="noopener ugc nofollow" target="_blank">https://github.com/TimonBerlin/heroku-pipelines-nightwatch</a></p></div></div>    
</body>
</html>