<html>
<head>
<title>Detecting Music With ShazamKit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ShazamKit检测音乐</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/detecting-music-with-shazamkit-c36168cfba5e?source=collection_archive---------8-----------------------#2021-07-27">https://levelup.gitconnected.com/detecting-music-with-shazamkit-c36168cfba5e?source=collection_archive---------8-----------------------#2021-07-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e65bf730fd6b447dd54b02522db3d198.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OyoWNgOwbSBag23D30Zvng.png"/></div></div></figure><p id="9dd3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本教程中，您将使用<a class="ae kw" href="https://developer.apple.com/documentation/shazamkit" rel="noopener ugc nofollow" target="_blank"> ShazamKit </a>来检测音乐播放，并将其作为消息发送到与iOS 的<a class="ae kw" href="https://developer.nexmo.com/client-sdk/overview" rel="noopener ugc nofollow" target="_blank"> Vonage客户端SDK的聊天中。ShazamKit在iOS 15及更高版本中可用，在撰写本文时还处于测试阶段。</a></p><h1 id="d67e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">先决条件</h1><ul class=""><li id="b883" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated">一个苹果开发者账号和一个运行iOS 15的测试设备。</li><li id="79c4" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">Xcode 13。</li><li id="2e8f" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">Cocoapods为iOS安装Vonage客户端SDK。</li><li id="f24c" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">我们的命令行界面。可以用npm install nexmo-cli@beta -g安装。</li></ul><h1 id="22ed" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Vonage API帐户</h1><p id="00c6" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">要完成本教程，您将需要一个<a class="ae kw" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2021-07-08-detecting-music-with-shazamkit" rel="noopener ugc nofollow" target="_blank"> Vonage API帐户</a>。如果你还没有，你可以今天就<a class="ae kw" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2021-07-08-detecting-music-with-shazamkit" rel="noopener ugc nofollow" target="_blank">注册</a>开始用免费的信用点数建造。一旦你有了一个帐户，你可以在<a class="ae kw" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2021-07-08-detecting-music-with-shazamkit" rel="noopener ugc nofollow" target="_blank"> Vonage API仪表板</a>的顶部找到你的API密匙和API秘密。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/941d1ebad7252085aa9c1e88f9dc18f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9RUNrmWVrhuK9uZKQ1igZA.png"/></div></div></figure><h1 id="9a40" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">启动项目</h1><p id="f1fd" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">本教程将建立在Vonage开发者门户的<a class="ae kw" href="https://developer.nexmo.com/client-sdk/tutorials/in-app-messaging/introduction/swift" rel="noopener ugc nofollow" target="_blank">“创建聊天应用”</a>项目之上。本教程将从从GitHub克隆完成的项目开始，但如果你不熟悉使用Vonage Client SDK for iOS构建聊天app，可以从教程开始。如果您遵循本教程，可以直接跳到启用ShazamKit部分。</p><h2 id="e577" class="ms ky iq bd kz mt mu dn ld mv mw dp lh kj mx my ll kn mz na lp kr nb nc lt nd bi translated">设置Vonage应用程序</h2><p id="c251" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">您现在需要创建一个Vonage应用程序。应用程序包含连接到Vonage所需的安全和配置信息。在您的终端中使用mkdir <code class="fe ne nf ng nh b">vonage-tutorial</code>为您的项目创建一个目录，然后使用cd <code class="fe ne nf ng nh b">vonage-tutorial</code>切换到新目录。使用以下命令创建一个Vonage应用程序:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="47b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一个名为<code class="fe ne nf ng nh b">.nexmo-app</code>的文件被创建在您的项目目录中，它包含新创建的Vonage应用程序ID和私钥。还创建了名为private.key的私钥文件。</p><p id="8c94" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，为您的应用程序创建用户。您可以通过运行以下命令来实现:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="a916" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建对话:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="3ac5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将您的用户添加到对话中，用您之前的对话ID替换<code class="fe ne nf ng nh b">CONV_ID</code>:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="71aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">客户端SDK使用JWTs进行身份验证。JWT标识用户名、关联的应用程序ID和授予用户的权限。它是使用您的私钥签名的，以证明它是有效的令牌。您可以通过运行以下命令为您的用户创建一个JWT，用您之前的应用程序ID替换<code class="fe ne nf ng nh b">APP_ID</code>:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h1 id="2f73" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">克隆iOS项目</h1><p id="dd4f" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">要获得iOS项目的本地副本，请打开您的终端并输入<code class="fe ne nf ng nh b">git clone git@github.com:nexmo-community/clientsdk-app-to-app-chat-swift.git</code>。使用<code class="fe ne nf ng nh b">cd clientsdk-app-to-app-chat-swift</code>将目录切换到<code class="fe ne nf ng nh b">clientsdk-app-to-app-chat-swift</code>文件夹。然后通过运行<code class="fe ne nf ng nh b">pod install</code>安装项目的依赖项。完成后，您可以通过运行open AppToAppChat.xcworkspace来打开Xcode项目。</p><h1 id="4721" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">验证客户端SDK</h1><p id="a5d1" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在<code class="fe ne nf ng nh b">ViewController.swift</code>文件的底部，有一个为我们的用户Alice和Bob提供静态属性的<code class="fe ne nf ng nh b">User</code>结构。用您之前在终端中生成的值替换<code class="fe ne nf ng nh b">CONVERSATION_ID</code>、<code class="fe ne nf ng nh b">ALICE_JWT</code>和<code class="fe ne nf ng nh b">BOB_JWT</code>。</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h1 id="eef3" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">启用Shazam</h1><p id="0b13" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">项目打开后，确保您有一个惟一的包标识符，并启用自动签名。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/708a3559af0436d9716d7d3046ffd83b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JEOqCiDN04_NQwIOrnLGkw.png"/></div></div></figure><p id="db0a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，访问苹果开发者门户网站上你的账户的<a class="ae kw" href="http://developer.apple.com/account/resources/identifiers/list" rel="noopener ugc nofollow" target="_blank">标识符部分</a>。找到您的捆绑包标识符，并在<em class="nl">应用服务</em>下启用ShazamKit。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/1633b9d76373787528a1725f58d16ecf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qz8hYK88U1IgjGed79zXlw.png"/></div></div></figure><h1 id="75ff" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">检测音乐</h1><h2 id="b04b" class="ms ky iq bd kz mt mu dn ld mv mw dp lh kj mx my ll kn mz na lp kr nb nc lt nd bi translated">麦克风权限</h2><p id="b287" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">麦克风权限</p><p id="1058" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要检测正在播放的音乐，您需要访问设备的麦克风，这需要您的许可。您的项目包含一个包含应用程序元数据的<code class="fe ne nf ng nh b">Info.plist</code>文件——您可以在AppToAppChat组中找到该文件。</p><p id="2cf2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">需要在<code class="fe ne nf ng nh b">Info.plist</code>文件中添加一个新条目:</p><ol class=""><li id="c6bf" class="lv lw iq ka b kb kc kf kg kj nn kn no kr np kv nq md me mf bi translated">将鼠标悬停在列表中的最后一个条目上，然后单击出现的小+按钮。</li><li id="0f05" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv nq md me mf bi translated">从下拉列表中，选择<code class="fe ne nf ng nh b">Privacy - Microphone Usage Description</code>并添加<code class="fe ne nf ng nh b">To detect music with Shazam</code>作为其值。</li></ol><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/b593fe0decc55c6821d0be0de3114ed1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GdmRuNNQ2ZckYuTORDRlvA.png"/></div></div></figure><p id="06ad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你的<code class="fe ne nf ng nh b">Info.plist</code>应该是这样的:</p><p id="3732" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，打开您的<code class="fe ne nf ng nh b">AppDelegate.swift</code>文件并导入<code class="fe ne nf ng nh b">AVFoundation</code>:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="d929" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，调用<code class="fe ne nf ng nh b">application:didFinishLaunchingWithOptions:</code>内的<code class="fe ne nf ng nh b">requestRecordPermission:</code>:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h2 id="0ed4" class="ms ky iq bd kz mt mu dn ld mv mw dp lh kj mx my ll kn mz na lp kr nb nc lt nd bi translated">创建音频缓冲区</h2><p id="1072" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">该应用程序将使用麦克风连续检测背景中的音乐，因此您需要从麦克风创建一个音频缓冲区，以传递给ShazamKit。打开<code class="fe ne nf ng nh b">ChatViewController.swift</code>文件，导入<code class="fe ne nf ng nh b">AVFoundation</code>、<code class="fe ne nf ng nh b">ShazamKit</code>并将这些属性添加到类中:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="8e2e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来向名为<code class="fe ne nf ng nh b">startAnalysingAudio</code>的类添加一个新函数:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="b1e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该功能使用<code class="fe ne nf ng nh b"><a class="ae kw" href="https://developer.apple.com/documentation/avfaudio/avaudioengine" rel="noopener ugc nofollow" target="_blank">AVAudioEngine</a></code>来访问麦克风的输入。<code class="fe ne nf ng nh b">AVAudioEngine</code>是一个健壮的框架，允许你通过插入/链接节点对象来操作音频。您只对这个应用程序的<code class="fe ne nf ng nh b">inputNode</code>的输出<code class="fe ne nf ng nh b">bus 0</code>感兴趣。<code class="fe ne nf ng nh b">installTap</code>函数允许您观察输出，并允许您访问<code class="fe ne nf ng nh b">AVAudioNodeTapBlock</code>，它是一个<code class="fe ne nf ng nh b">AVAudioPCMBuffer</code>和<code class="fe ne nf ng nh b">AVAudioTime</code>元组的typealias。然后，缓冲区和时间都会传递给<code class="fe ne nf ng nh b">SHSession</code>上的<code class="fe ne nf ng nh b">matchStreamingBuffer</code>功能，该功能会尝试将播放的任何音乐与Shazam目录进行匹配。</p><p id="9aa6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要结束这个过程，您需要添加一个名为<code class="fe ne nf ng nh b">stopAnalysingAudio</code>的函数，它将安全地停止观察输入:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="955b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将会话的委托设置为此类，调用<code class="fe ne nf ng nh b">viewDidLoad</code>函数底部的<code class="fe ne nf ng nh b">startAnalysingAudio</code>和<code class="fe ne nf ng nh b">logout</code>函数中的<code class="fe ne nf ng nh b">stopAnalysingAudio</code>:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h1 id="cd10" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><code class="fe ne nf ng nh b">SHSessionDelegate</code></h1><p id="1065" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">现在应用程序正在向ShazamKit传递一个缓冲区，您需要实现<code class="fe ne nf ng nh b">SHSessionDelegate</code>来接收更新。在文件底部创建扩展名:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="d887" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当ShazamKit没有发现匹配或错误时，调用<code class="fe ne nf ng nh b">didNotFindMatchFor</code>函数。否则，当找到匹配时，将调用<code class="fe ne nf ng nh b">didFind</code>函数。</p><p id="c15f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">匹配结果以不同置信度的数组形式返回，但您将获得第一个结果。此外，该函数将匹配ID与上一次匹配进行比较，以确保当您向聊天发送消息时，每次匹配只发生一次。</p><h1 id="c639" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">尝试一下</h1><p id="883f" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在您的iOS设备和模拟器上构建并运行(CMD + R)项目。在每台设备上以不同的用户身份登录。如果你在后台播放一些音乐，物理iOS设备会将音频缓冲区传递给ShazamKit。如果歌曲与Shazam目录匹配，将会向聊天室发送一条消息。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/7ec817d89542d80b201f03152e55107c.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/1*GWJ5qYJg619VuxEkbZtN8g.png"/></div></figure><h1 id="5f63" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">接下来呢？</h1><p id="f64e" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">你可以在<a class="ae kw" href="https://github.com/nexmo-community/swift-app-to-app-shazamkit" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到已经完成的项目。使用客户端SDK，您可以做更多的事情。了解有关developer.nexmo.com<a class="ae kw" href="https://developer.nexmo.com/client-sdk/overview" rel="noopener ugc nofollow" target="_blank">的客户端SDK和developer.apple.com</a><a class="ae kw" href="https://developer.apple.com/documentation/shazamkit" rel="noopener ugc nofollow" target="_blank">的ShazamKit的更多信息</a></p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><p id="59fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nl">最初发布于</em><a class="ae kw" href="https://learn.vonage.com/blog/2021/07/08/detecting-music-with-shazamkit/" rel="noopener ugc nofollow" target="_blank"><em class="nl">https://learn . vonage . com/blog/2021/07/08/detecting-music-with-shazamkit/</em></a></p></div></div>    
</body>
</html>