<html>
<head>
<title>How to use Azure pipelines for automatic certificate renewal</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Azure管道进行自动证书续订</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-use-azure-pipelines-for-automatic-certificate-renewal-2870f5930c5?source=collection_archive---------10-----------------------#2022-12-09">https://levelup.gitconnected.com/how-to-use-azure-pipelines-for-automatic-certificate-renewal-2870f5930c5?source=collection_archive---------10-----------------------#2022-12-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/e0c3cd76e5e738519097604130c98c91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZmjxPHdbo-5lwDetBuX9Cg.png"/></div></div></figure><div class=""/><p id="f896" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">近年来，web浏览器使SSL引起了所有用户的注意。谷歌Chrome在2017年1月<a class="ae kw" href="https://security.googleblog.com/2016/09/moving-towards-more-secure-web.html" rel="noopener ugc nofollow" target="_blank"/>开始转向更安全的网络，并自2018年7月<a class="ae kw" href="https://blog.chromium.org/2018/02/a-secure-web-is-here-to-stay.html" rel="noopener ugc nofollow" target="_blank"/>起将所有通过HTTP提供的页面显示为“不安全”。如今，为HTTPS网站提供服务是必须的，因此维护SSL证书的过程至关重要。有许多创建证书的工具，许多web主机包括免费管理(<a class="ae kw" href="https://www.cloudflare.com/en-gb/ssl/" rel="noopener ugc nofollow" target="_blank"> Cloudflare SSL </a>，<a class="ae kw" href="https://learn.microsoft.com/en-us/azure/app-service/configure-ssl-certificate" rel="noopener ugc nofollow" target="_blank"> Azure管理证书</a>)。</p><h1 id="79da" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">什么是SSL证书？</h1><p id="2f6e" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">简单地说，SSL证书是一种数字证书，用于验证网站的身份。这些证书允许网站通过HTTPS而不是HTTP提供内容来加密。</p><p id="2211" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">SSL证书由可信的证书颁发机构(CA)进行数字签名，例如<a class="ae kw" href="https://www.digicert.com/" rel="noopener ugc nofollow" target="_blank"> DigiCert </a>。任何人都可以创建证书，但是浏览器只信任由可信CA签名的证书。</p><p id="95ed" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">证书只在给定的时间内有效。一旦证书过期，浏览器将不再信任它。证书必须在到期前更新，这样您的站点才不会不安全。</p><h1 id="a8ff" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">为什么网站需要SSL证书？</h1><p id="722e" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">拥有SSL证书的主要原因是为了让一个站点可以在整个HTTPS提供服务。这提供了客户端和服务器之间的加密，以保持用户数据的私密性。拥有这种端到端加密可以防止中间人攻击，这种攻击会使攻击者能够窃听通信。让该网站服务于HTTPS意味着用户将在他们的地址栏看到可信赖的挂锁，向他们保证他们的连接是安全的。</p><figure class="mb mc md me gt is gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/df407e56d5581a6cd9c7b90395ae03a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RjTu1xVmmoZlVfn_.png"/></div><figcaption class="mf mg gj gh gi mh mi bd b be z dk translated">浏览器地址栏中的挂锁</figcaption></figure><p id="1947" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要从CA接收SSL证书，您必须验证您拥有该域—通常通过DNS。这意味着用户可以确信托管该站点的服务器是由拥有该域的同一批人运行的，并且该站点是可信的。</p><h1 id="3ee4" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">管理SSL证书</h1><p id="0155" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">过去，企业会从CA购买证书。然后，他们需要在证书到期前手动更新证书，并将其重新上传到服务器。这些证书通常是长期有效的(1-2年),因此不需要经常更新。这是一个仍然被广泛使用的选项，然而，许多企业现在选择使用免费服务来获得他们的证书。</p><p id="c031" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可以免费创建自签名证书。顾名思义，这些证书不是由可信的CA签名的，也不会被浏览器信任。这是因为没有外部权威机构来验证其所声称的来源。这种类型的证书通常用于开发，因为它可以在本地被信任。</p><figure class="mb mc md me gt is gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/c6d4af69e49db6f1e8cbed42b37345c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BfPQWjCBQWP5ZObq.png"/></div><figcaption class="mf mg gj gh gi mh mi bd b be z dk translated">开发证书</figcaption></figure><p id="d834" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">让我们加密</a>是一个免费、自动化、开放和可信的CA，它已经成为一项非常受欢迎的服务，每天颁发<a class="ae kw" href="https://letsencrypt.org/stats/#daily-issuance" rel="noopener ugc nofollow" target="_blank">~ 300万个证书</a>。自动化工具可以与Let's Encrypt一起使用，在证书到期前自动更新证书——这类工具包括<a class="ae kw" href="https://www.win-acme.com/" rel="noopener ugc nofollow" target="_blank"> win-acme </a>和<a class="ae kw" href="https://poshac.me/" rel="noopener ugc nofollow" target="_blank"> Posh-ACME </a>。这些是Audacia用于托管在虚拟机上的应用程序的工具，因为它们可以轻松设置为后台任务来管理证书。</p><p id="d11c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了进一步简化这个过程，许多主机服务提供免费的证书管理。我们的许多系统托管在Azure应用服务中，自2021年5月<a class="ae kw" href="https://azure.microsoft.com/en-gb/updates/app-service-managed-certificates-now-generally-available/" rel="noopener ugc nofollow" target="_blank">起</a>提供免费的证书管理。开发人员只需设置一次证书，Azure将无限期处理续订。诸如此类的流程减少了企业维护和监控SSL证书的需求，从而降低了出错的风险。</p><h1 id="7537" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">为什么我们仍然需要一个自动化续订的工具？</h1><p id="ff1b" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">虽然我们的应用程序托管在Azure应用服务中，但由于缺乏对通配符证书的支持，我们无法使用他们的托管证书。我们提供了一个多租户应用程序，客户可以通过一个自定义的子域，例如<code class="fe mj mk ml mm b">customer-1.our-app.com</code>和<code class="fe mj mk ml mm b">customer-2.our-app.com</code>进行访问。我们不是每次添加新客户时都给应用服务分配一个新的自定义域(Azure有500个自定义域的硬性限制)，而是将<code class="fe mj mk ml mm b">*.our-app.com</code>指向应用服务。为了让我们的客户在访问产品时看到挂锁，我们需要获得一个通配符证书。</p><figure class="mb mc md me gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ma"><img src="../Images/c7ec1fca5fb75a32940065112e790e5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rrs6HnIAHRJq70E7.png"/></div></div><figcaption class="mf mg gj gh gi mh mi bd b be z dk translated">多租户域</figcaption></figure><p id="b7b6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于我们没有在VM中托管我们的应用程序，所以像我们为其他应用程序所做的那样使用win-acme并不简单。仅仅为了更新我们的证书而运行虚拟机是不经济的。</p><p id="c4d5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">相反，我们的流程是让某人每隔几个月手动运行一次Let's Encrypt并上传证书。我们的两个环境总共有10个证书需要续订。这一过程并不理想，因为每次需要1-2个小时，而且工程主管是唯一有权更新生产系统的人。</p><p id="e6d9" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们估计一个自动化系统大约需要一天的时间来建立。由于手动过程每两个月花费两个小时，所以只需要8个月就可以获得投资开发时间的回报。自动化将大大降低由于忘记更新或人员不在而导致证书过期的风险。</p><h1 id="83eb" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">我们如何自动续订我们的证书？</h1><p id="c4c0" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们的回购托管在Azure DevOps中，我们按计划使用Azure管道来处理我们的证书续订。这使开发者和利益相关者可以从管道状态中轻松了解续订情况。</p><p id="6c83" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我不会详细说明我们是如何设置的，因为这必须归功于布伦特·罗宾逊的优秀向导。这被用作我们的过程的基础，经过一些调整，使它更适合我们的需要。</p><figure class="mb mc md me gt is gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/698f3eb253fc641d6809ee51170c4a72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dxj0V1i1FM26Lxg2.png"/></div><figcaption class="mf mg gj gh gi mh mi bd b be z dk translated">证书续订流程</figcaption></figure><p id="fdd7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，管道试图从Azure Blob存储容器下载缓存的Posh-ACME数据。这包含先前创建的证书的域、指纹和日期。</p><p id="0b90" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，Posh-ACME将根据缓存的数据对自己进行配置，并确定是否需要请求新的证书。如果以前的证书将在接下来的30天内过期，将从Let's Encrypt请求新的证书。</p><p id="a9ef" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我们从Azure Key Vault获取当前证书，并将该证书的指纹与来自Posh-ACME的指纹进行比较。如果指纹不匹配，则生成新的证书。</p><p id="6a0b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，新证书被上传到密钥库，Azure Front Door将在接下来的72小时内自动提取该证书。</p><p id="3fe4" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">管道的最后一步是将新的Posh-ACME数据上传到Blob存储，以便在下一次运行的第一步中下载。</p><h1 id="8cca" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">摘要</h1><p id="569e" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">托管网站时，SSL证书是浏览器和用户信任您的网站的一项要求。使用由你的主机提供商管理的证书是降低出错风险的明显选择。但是，在某些情况下，这些功能可能无法使用。对于这个Audacia项目，使用Azure Pipelines和Posh-ACME是一个很好的解决方案，因为它运行起来很便宜，而且我们在现有的Azure DevOps项目中获得了我们续订状态的出色可见性。</p><p id="ba7a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://audacia.co.uk/" rel="noopener ugc nofollow" target="_blank"> Audacia </a>是一家总部位于英国的软件开发公司，总部位于利兹。在我们的技术洞察博客上查看更多来自我们的顾问、业务分析师、开发人员和测试人员团队的<a class="ae kw" href="https://bit.ly/3VKKFUy" rel="noopener ugc nofollow" target="_blank">技术洞察</a>。</p><p id="a47f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文由Audacia高级软件开发人员Jack Percy撰写。Jack目前在一个团队中使用VueJS和。网芯。在此项目之前，他曾在多个行业工作过，包括汽车维修和房屋建筑。杰克喜欢所有的东西，尤其是CI和CD。</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="0742" class="kx ky jb bd kz la mu lc ld le mv lg lh li mw lk ll lm mx lo lp lq my ls lt lu bi translated">分级编码</h1><p id="2632" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="ccdb" class="mz na jb ka b kb kc kf kg kj nb kn nc kr nd kv ne nf ng nh bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="a51b" class="mz na jb ka b kb ni kf nj kj nk kn nl kr nm kv ne nf ng nh bi translated">📰查看更多内容请参见<a class="ae kw" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码刊物</a></li><li id="fcda" class="mz na jb ka b kb ni kf nj kj nk kn nl kr nm kv ne nf ng nh bi translated">🔔关注我们:<a class="ae kw" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae kw" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae kw" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="712c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">🚀👉<a class="ae kw" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="ka jc">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>