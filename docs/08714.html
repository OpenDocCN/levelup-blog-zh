<html>
<head>
<title>Automate Microservice Deployment to AWS ECS Fargate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动将微服务部署到AWS ECS Fargate</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/automate-microservice-deployment-to-aws-ecs-fargate-475172bffc80?source=collection_archive---------3-----------------------#2021-05-28">https://levelup.gitconnected.com/automate-microservice-deployment-to-aws-ecs-fargate-475172bffc80?source=collection_archive---------3-----------------------#2021-05-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="e387" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用Gitlab CI简化Fargate部署。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/e9e36ccb18429650f4f30e1a740f7e63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1TcxEWFr_SGFFub4OKELIg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">AWS ECS:<a class="ae le" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/ecs/</a></figcaption></figure><p id="9b49" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要通过Gitlad CD管道向ECS FARGATE集群部署或更新服务，我们需要4样东西</p><ol class=""><li id="4329" class="lf lg it js b jt ju jx jy kb lh kf li kj lj kn lk ll lm ln bi translated">。gitlab-ci.yml —包含gitlab runner部署服务时要执行的步骤。</li><li id="58e1" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lk ll lm ln bi translated">具有ECS、ECR和EC2相关权限的用户</li></ol><ul class=""><li id="91d0" class="lf lg it js b jt ju jx jy kb lh kf li kj lj kn lt ll lm ln bi translated"><a class="ae le" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/ecr_managed_policies.html" rel="noopener ugc nofollow" target="_blank">亚马逊C2 containerregistryfull access</a></li><li id="03b2" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lt ll lm ln bi translated">一个<a class="ae le" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_managed_policies.html" rel="noopener ugc nofollow" target="_blank">mazonec 2 containerservicerole</a></li><li id="cfea" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lt ll lm ln bi translated"><a class="ae le" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html" rel="noopener ugc nofollow" target="_blank">亚马逊任务执行规则</a></li></ul><p id="9cce" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.docker-compose.yml —描述要部署的映像、要监听的端口、日志组</p><p id="e080" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.ecs-params.yml —描述任务大小、群集的网络配置</p><p id="ccf6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.aws-config . sh-包含步骤2中IAM用户的AWS凭据。</p><p id="ad4a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我希望部署的服务的目录结构如下所示</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/e263b7631f879b159ecd7c1848f14ab0.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/1*_QEMhWX6wzg5YX4akNcgew.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">要部署的微服务的目录结构</figcaption></figure><p id="08d7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">微服务文件夹包含我们正在部署的服务的src文件。。gitlab-ci.yml文件由Gitlab CI选择执行。文件的内容如下。请注意，这里只显示了与部署相关的配置项文件的一部分。我们要更新的集群已存在于名为“test-cluster”的AWS环境中，该集群在中被声明为变量。gitlab-ci文件作为AWS_CLUSTER_NAME</p><ol class=""><li id="0904" class="lf lg it js b jt ju jx jy kb lh kf li kj lj kn lk ll lm ln bi translated"><strong class="js iu">。gitlab-ci.yml文件</strong></li></ol><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="e275" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.<strong class="js iu"> IAM用户</strong></p><p id="5c41" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">IAM用户的AWS访问密钥— AWS_ACCESS_KEY_ID和AWS_SECRET_ACCESS_KEY是在gitlab项目环境中的项目→设置→ CI/CD →变量下配置的</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lx"><img src="../Images/516486380c4cac865f5a5beb6cc60d87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d3p-5fKlgWoJKjk0MBoh8w.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">CI管道的项目环境变量设置</figcaption></figure><p id="dfc1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这不是最佳的安全实践，因为这些密钥很容易被有权访问该项目的团队成员访问或更改。有一种更好的获取凭证的方法，那就是使用AWS STS，并假设一个角色具有执行ECS和ECR操作的权限。在以后的文章中会有更多的介绍。目前，如果你信任你的团队成员，这就可以了。</p><p id="372e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.<strong class="js iu"> docker-compose.yml </strong></p><p id="b1fe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">docker-compose文件用于创建服务，它包含要部署的映像、端口信息和日志组</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="773a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.e <strong class="js iu"> cs-params.yml </strong></p><p id="b3ba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当使用<code class="fe ly lz ma mb b">ecs-cli compose</code>或<code class="fe ly lz ma mb b">ecs-cli compose service</code>命令(如在我们的CD管道中)来管理Amazon ECS任务和服务时，Amazon ECS任务定义中的某些字段与Docker合成文件中的字段不对应。您可以使用带有<code class="fe ly lz ma mb b">--ecs-params</code>标志的ECS参数文件来指定这些值。默认情况下，该命令在名为<code class="fe ly lz ma mb b">ecs-params.yml</code>的当前目录中查找ECS参数文件。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="4dc0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.<strong class="js iu"> aws-config.sh </strong></p><p id="5564" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ecs-cli工具需要IAM凭据来运行服务。它们由aws-config.sh文件提供。存储在CI/CD变量设置中的凭证被读取并存储在配置文件中。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="6657" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你做过类似的工作吗？你采取了什么方法？我很想听听你的经历。</p><p id="1a19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢阅读。如果你对此有想法，一定要留下评论。如果你觉得这篇文章有帮助，给我一些掌声？。</p><div class="mc md gp gr me mf"><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/cmd-ecs-cli-compose-ecsparams.html" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd iu gy z fp mk fr fs ml fu fw is bi translated">使用Amazon ECS参数</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">当使用ecs-cli撰写或ecs-cli撰写服务命令来管理您的Amazon ECS任务和服务时，有…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">docs.aws.amazon.com</p></div></div><div class="mo l"><div class="mp l mq mr ms mo mt ky mf"/></div></div></a></div></div></div>    
</body>
</html>