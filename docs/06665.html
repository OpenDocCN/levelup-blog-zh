<html>
<head>
<title>Quick Tekton Guide for OpenShift and Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OpenShift和Kubernetes的快速Tekton指南</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-setup-a-tekton-ci-cd-environment-442dae6bd301?source=collection_archive---------1-----------------------#2020-12-18">https://levelup.gitconnected.com/how-to-setup-a-tekton-ci-cd-environment-442dae6bd301?source=collection_archive---------1-----------------------#2020-12-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/51c38b29fe385b5e3d1c3d2a6552a2f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PD9OLqltm_Pmvtbor5w8og.jpeg"/></div></div></figure><div class=""/><p id="f27a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">用示例代码在OpenShift 4或Kubernetes 1.16+上用Tekton (v0.19.0)创建云原生管道。</em></p><p id="4ac5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kx" href="https://github.com/tektoncd/pipeline" rel="noopener ugc nofollow" target="_blank"> Tekton </a>是一个开源工具，它将CI/CD作业作为Kubernetes集群中的容器来运行。该工具可用于构建、测试、培训或部署您的程序。我使用Tekton取得了一些成功，但是没有找到太多的文档，所以我把这个例子<a class="ae kx" href="https://github.com/tekton-example" rel="noopener ugc nofollow" target="_blank">项目</a>放在一起，学习并帮助其他人测试这个令人兴奋的开源工具。本文将向您展示如何运行这个示例，并希望您熟悉这个工具是如何工作的。</p><p id="6108" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">注意</em> : Tekton处于测试阶段。有关Tekton的最新指南，请参见Tekton <a class="ae kx" href="https://github.com/tektoncd/pipeline/tree/main/docs" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="9c52" class="ky kz jb bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">概观</h1><p id="fe4a" class="pw-post-body-paragraph jy jz jb ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">Tekton通过创建Kubernetes自定义资源定义来工作。这些资源对象用于管理代码的生命周期。示例代码是一个存储在git中的二进制应用程序，它构建在一个映像中，并作为一个容器部署在Kubernetes集群中。</p><p id="4a2e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这主要包括三个目录:</p><p id="1023" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">资源/ </em> <br/> <em class="kw">任务/ </em> <br/> <em class="kw">管道/ </em></p><p id="a7f5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有一个java库、<a class="ae kx" href="https://github.com/tekton-example/common-java-dependencies" rel="noopener ugc nofollow" target="_blank">common-Java-dependencies</a>和<a class="ae kx" href="https://github.com/tekton-example/java-app-example" rel="noopener ugc nofollow" target="_blank"> java-app-example </a>二进制的存储库。在<a class="ae kx" href="https://github.com/tekton-example/java-app-example/tree/main/k8s" rel="noopener ugc nofollow" target="_blank"> k8s/ </a>下，二进制文件有一个http端点，定义为在网络上公开应用程序。</p><p id="b63f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个例子可以扩展到<a class="ae kx" href="https://en.wikipedia.org/wiki/Blue-green_deployment" rel="noopener ugc nofollow" target="_blank">蓝绿色部署</a>，或者与<a class="ae kx" href="https://argo-cd.readthedocs.io/en/stable/core_concepts/" rel="noopener ugc nofollow" target="_blank"> ArgoCD </a>一起使用。请随意解构这些构件，并将其用于其他编程语言。</p><p id="e19f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">管道执行以下步骤:</p><ol class=""><li id="ca6c" class="mb mc jb ka b kb kc kf kg kj md kn me kr mf kv mg mh mi mj bi translated"><strong class="ka jc">构建二进制</strong>应用的依赖<a class="ae kx" href="https://github.com/tekton-example/common-java-dependencies" rel="noopener ugc nofollow" target="_blank">库</a>，然后构建二进制</li><li id="0212" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated"><strong class="ka jc">使用<a class="ae kx" href="https://github.com/tekton-example/java-app-example/blob/main/src/main/docker/Dockerfile.jvm" rel="noopener ugc nofollow" target="_blank">docker文件</a>创建一个</strong> <strong class="ka jc">容器图像</strong></li><li id="a1d3" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated"><strong class="ka jc">将映像</strong>推送到私有映像注册表(<a class="ae kx" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> DockerHub </a>)</li><li id="044c" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated"><strong class="ka jc">使用Tekton资源文件部署并公开二进制文件</strong></li></ol><p id="3d8d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更具体地说，这包括以下步骤:</p><ol class=""><li id="f8ed" class="mb mc jb ka b kb kc kf kg kj md kn me kr mf kv mg mh mi mj bi translated">安装git</li><li id="b973" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">安装Maven</li><li id="636c" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">克隆库</li><li id="d783" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">构建库jar</li><li id="17e1" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">克隆二进制文件</li><li id="2db4" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">构建并打包二进制jar</li><li id="e9fa" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">创建二进制文件的容器映像</li><li id="0982" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">用skopeo推动形象</li><li id="a70a" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">创建资源文件<em class="kw">或</em>发布新版本的二进制文件</li></ol><p id="a4f6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi">—</p><p id="e86c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">与其他CI/CD工具相比，Tekton很有趣，因为它可以共享Kubernetes环境中使用的相同机器。在示例源代码中，我将其简化为一个步骤，即创建PipelineRun资源。如果你愿意，你也可以用一个<a class="ae kx" href="https://tekton.dev/docs/triggers/" rel="noopener ugc nofollow" target="_blank">触发器</a>来自动操作。</p><h1 id="fcdd" class="ky kz jb bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">使用Tekton</h1><p id="c7c9" class="pw-post-body-paragraph jy jz jb ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">下面是让它在您自己的环境中工作所需的内容。</p><h2 id="c380" class="mp kz jb bd la mq mr dn le ms mt dp li kj mu mv lm kn mw mx lq kr my mz lu na bi translated">安装Tekton</h2><p id="b15e" class="pw-post-body-paragraph jy jz jb ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">您可以使用<a class="ae kx" href="https://operatorhub.io/operator/tektoncd-operator" rel="noopener ugc nofollow" target="_blank">操作器</a>安装Tekton。在撰写本文时，它使用了一个旧的测试版本(0.15.2对0.19.0)，但它也安装了<a class="ae kx" href="https://github.com/tektoncd/dashboard" rel="noopener ugc nofollow" target="_blank"> Tekton仪表板</a>。</p><p id="afb7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我建议遵循以下官方步骤:</p><ol class=""><li id="7071" class="mb mc jb ka b kb kc kf kg kj md kn me kr mf kv mg mh mi mj bi translated"><a class="ae kx" href="https://github.com/tektoncd/pipeline/blob/master/docs/install.md" rel="noopener ugc nofollow" target="_blank"> TektonCD安装</a>或<a class="ae kx" href="https://tekton.dev/docs/getting-started/" rel="noopener ugc nofollow" target="_blank"> TektonCD入门</a></li><li id="4db2" class="mb mc jb ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated"><a class="ae kx" href="https://github.com/tektoncd/cli" rel="noopener ugc nofollow" target="_blank"> TektonCD CLI安装</a></li></ol><figure class="nc nd ne nf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nb"><img src="../Images/224850c98aec7b0ad62272205f36e03a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bEelOo9ZMDZ-8xeQsvkLGA.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk translated">Easy OpenShift TektonCD安装示例</figcaption></figure><p id="c4bb" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这在<em class="kw"> tekton-pipelines </em>名称空间中为Tekton创建了所有必要的资源。最值得注意的是，我们看到了管道、管道运行、任务等的CRD。您不需要CLI工具，但建议您使用。</p><h2 id="7a61" class="mp kz jb bd la mq mr dn le ms mt dp li kj mu mv lm kn mw mx lq kr my mz lu na bi translated">鉴定</h2><ol class=""><li id="c164" class="mb mc jb ka b kb lw kf lx kj nk kn nl kr nm kv mg mh mi mj bi translated">如果您没有使用operator install，请使用kubectl创建一个带有<code class="fe nn no np nq b">cluster-admin</code>的<a class="ae kx" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/" rel="noopener ugc nofollow" target="_blank">服务帐户</a>，或者将Tekton分配给一个现有的SA。</li></ol><pre class="nc nd ne nf gt nr nq ns nt aw nu bi"><span id="1428" class="mp kz jb nq b gy nv nw l nx ny">kubectl create configmap config-defaults \<br/>--from-literal=default-service-account=pipelineSA \<br/>-o yaml -n tekton-pipelines \<br/>--dry-run=client  | kubectl replace -f -</span><span id="4433" class="mp kz jb nq b gy nz nw l nx ny">kubectl create clusterrolebinding pipeline --clusterrole=cluster-admin --serviceaccount=my_other_namespace:pipelineSA</span></pre><p id="dda8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.创建图像注册表机密。把它和服务协议联系起来。</p><pre class="nc nd ne nf gt nr nq ns nt aw nu bi"><span id="e073" class="mp kz jb nq b gy nv nw l nx ny">kubectl create secret docker-registry my-docker-registry-secret \<br/> — docker-server=docker.io \<br/> — docker-username=&lt;username&gt; \<br/> — docker-password=&lt;api_token&gt; \<br/> — docker-email=&lt;email&gt;</span><span id="b1ec" class="mp kz jb nq b gy nz nw l nx ny">kubectl secrets link pipeline <!-- -->my-docker-registry-secret</span></pre><p id="bfe0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您需要它来提取依赖项，您还需要添加以下内容:</p><p id="5cc5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nn no np nq b">kubectl secrets link pipeline srd-docker-registry --for=pull</code></p><p id="c74c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于git，Tekton想要一个关于这个秘密的特定注释，如下所示</p><figure class="nc nd ne nf gt is"><div class="bz fp l di"><div class="oa ob l"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk translated">GitHub认证的密码</figcaption></figure><p id="2d83" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nn no np nq b">kubectl create -f gitsecret.yaml<br/>kubectl secrets link pipeline gitsecret</code></p><h2 id="21d1" class="mp kz jb bd la mq mr dn le ms mt dp li kj mu mv lm kn mw mx lq kr my mz lu na bi translated">创建管道存储</h2><p id="b11f" class="pw-post-body-paragraph jy jz jb ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">管道需要一个地方来克隆源代码和共享缓存的构建工件。为此，Tekton提供了一个名为Workspaces的测试功能，可以跨任务挂载和共享卷。</p><p id="0338" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是创建5Gi PersistentVolumeClaim的yaml:</p><figure class="nc nd ne nf gt is"><div class="bz fp l di"><div class="oa ob l"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk translated">管道共享缓存的PersistentVolumeClaim</figcaption></figure><p id="954e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nn no np nq b">kubectl create -f pipeline-pvc.yaml</code></p><p id="2566" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这通过工作区安装到管道，并作为管道的参数给出。通过创建PipelineRun对象，可以方便地提供管道的参数。例如，此部分将包含在PipelineRun yaml:</p><pre class="nc nd ne nf gt nr nq ns nt aw nu bi"><span id="a811" class="mp kz jb nq b gy nv nw l nx ny">workspaces:<br/>- name: source<br/>    persistentVolumeClaim:<br/>      claimName: pipeline-pvc</span></pre><p id="83a8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi">—</p><p id="a114" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者，您可能会发现在每次管道执行时生成一个新的PVC比使用相同的PVC进行缓存更好。如果您想采用这种方法，可以在PipelineRun中这样定义它:</p><pre class="nc nd ne nf gt nr nq ns nt aw nu bi"><span id="abd1" class="mp kz jb nq b gy nv nw l nx ny">workspaces:<br/>  - name: source<br/>    volumeClaimTemplate:<br/>      spec:<br/>        resources:<br/>          requests:<br/>            storage: 5Gi<br/>        volumeMode: Filesystem<br/>        accessModes:<br/>          - ReadWriteOnce</span></pre><p id="5fb8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">欲了解更多信息，请查看此有用的<a class="ae kx" href="https://github.com/tektoncd/pipeline/blob/master/docs/auth.md" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h2 id="c924" class="mp kz jb bd la mq mr dn le ms mt dp li kj mu mv lm kn mw mx lq kr my mz lu na bi translated">配置Tekton任务</h2><p id="6837" class="pw-post-body-paragraph jy jz jb ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">最后，配置<code class="fe nn no np nq b">tasks/</code>资源对象以满足您的需求。您可以从<code class="fe nn no np nq b">git-clone</code>任务开始，它只需要源代码的URL作为它的参数，即<code class="fe nn no np nq b"><a class="ae kx" href="https://github.com/tekton-example/java-app-example.git" rel="noopener ugc nofollow" target="_blank">https://github.com/tekton-example/java-app-example.git</a></code>。完成后，用<code class="fe nn no np nq b">kubectl create -f tasks/</code>创建它们。</p><p id="90c3" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">示例项目中提供的一些其他任务包括:</p><p id="5a2d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nn no np nq b">maven-build</code> —生成settings.xml文件或使用现有文件。它是git存储库安装到Tekton工作区的源参数。<br/> <code class="fe nn no np nq b">build-maven-image</code> —构建、容器化和推送java映像。<br/> <code class="fe nn no np nq b">apply-manifests</code> —创建OpenShift资源，以使用来自映像注册表的最新映像来部署和/或更新java应用程序。</p><p id="f48d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">测试任务的一种方法是使用tekton CLI，如下所示:</p><pre class="nc nd ne nf gt nr nq ns nt aw nu bi"><span id="9d13" class="mp kz jb nq b gy nv nw l nx ny">tkn task start git-clone --param url=<a class="ae kx" href="https://github.com/tekton-example/java-app-example.git" rel="noopener ugc nofollow" target="_blank">https://github.com/tekton-example/java-app-example.git</a> --param revision=main --param subdirectory=application-source --workspace name=output,claimName=pipeline-pvc --showlog</span></pre><p id="aeea" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">任务完成后，您就可以创建管道并使用PipelineRun对象触发它了:</p><p id="4f4d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nn no np nq b">kubectl create -f java-app-example-pipelinerun.yaml</code></p><p id="aafa" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用Tekton CLI监控管道进度也很方便:</p><p id="bc4e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nn no np nq b">tkn pr logs -Lf</code></p><p id="7f90" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看<a class="ae kx" href="https://hub.tekton.dev/" rel="noopener ugc nofollow" target="_blank"> Tekton目录</a>了解更多创意。</p><p id="3ecb" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">在</em> <a class="ae kx" href="https://www.linkedin.com/in/steele-desmond/" rel="noopener ugc nofollow" target="_blank"> <em class="kw"> LinkedIn </em> </a> <em class="kw">上跟我连线。<br/>感谢阅读。</em></p></div></div>    
</body>
</html>