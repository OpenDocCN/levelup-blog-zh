<html>
<head>
<title>Deploy CI/CD pipeline on GCP using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform在GCP部署CI/CD管道</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploy-ci-cd-pipeline-on-gcp-using-terraform-364e533dd465?source=collection_archive---------4-----------------------#2020-05-29">https://levelup.gitconnected.com/deploy-ci-cd-pipeline-on-gcp-using-terraform-364e533dd465?source=collection_archive---------4-----------------------#2020-05-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e79b41425d643590f60d804933cbaa6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rBkUFNeWaA2gFirmQFN39A.jpeg"/></div></div></figure><h1 id="a9ad" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">介绍</h1><p id="d2dd" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">最近，我创建了一个应用程序<a class="ae lu" href="https://medium.com/@vikramshinde/config-service-using-google-sheet-6ac126b1c742" rel="noopener">配置服务</a>，它从Google Sheet获取配置数据。这个应用程序是使用GCP无服务器服务<strong class="ky ir">云源库</strong>、<strong class="ky ir">云构建</strong>、<strong class="ky ir">容器注册表、</strong>和<strong class="ky ir">云运行</strong>部署的。</p><p id="cd82" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">在本文中，我们将看到如何使用<strong class="ky ir"> Terraform </strong>来自动化这个CI/CD管道。</p><h1 id="9369" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">设置</h1><p id="fafd" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">为了完成本指南，您需要安装以下工具</p><ul class=""><li id="2ee6" class="ma mb iq ky b kz lv ld lw lh mc ll md lp me lt mf mg mh mi bi translated"><a class="ae lu" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>:本指南使用Terraform部署资源。</li><li id="41a9" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated"><a class="ae lu" href="https://git-scm.com/" rel="noopener ugc nofollow" target="_blank"> Git </a> : Git用于克隆示例代码并触发新的部署。</li><li id="21ba" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">GCP :你需要一个启用计费的GCP账户。</li></ul><h2 id="2a6a" class="mo jz iq bd ka mp mq dn ke mr ms dp ki lh mt mu km ll mv mw kq lp mx my ku mz bi translated">创建GCP项目</h2><p id="9dba" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">为本教程创建一个GCP项目。</p><h2 id="4a15" class="mo jz iq bd ka mp mq dn ke mr ms dp ki lh mt mu km ll mv mw kq lp mx my ku mz bi translated">创建服务帐户</h2><ul class=""><li id="a893" class="ma mb iq ky b kz la ld le lh na ll nb lp nc lt mf mg mh mi bi translated">创建服务帐户。</li><li id="4724" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">分配角色:编辑、安全管理员、服务使用消费者和源存储库管理员。</li><li id="c6f1" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">下载密钥并将其重命名为terraform-key.json</li></ul><h2 id="c114" class="mo jz iq bd ka mp mq dn ke mr ms dp ki lh mt mu km ll mv mw kq lp mx my ku mz bi translated">启用云资源管理器API</h2><ul class=""><li id="2639" class="ma mb iq ky b kz la ld le lh na ll nb lp nc lt mf mg mh mi bi translated">转到链接<a class="ae lu" href="https://console.cloud.google.com/apis/library/cloudresourcemanager.googleapis.com" rel="noopener ugc nofollow" target="_blank">https://console . cloud . Google . com/APIs/library/cloudresourcemanager . Google APIs . com</a></li><li id="776d" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">点击启用API</li></ul><p id="a2cc" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">一切都准备好了。让车轮转动起来！！</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="34da" class="jy jz iq bd ka kb nk kd ke kf nl kh ki kj nm kl km kn nn kp kq kr no kt ku kv bi translated">使用Terraform部署GCP无服务器资源</h1><p id="7531" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">克隆包含示例代码的以下存储库，然后切换到<code class="fe np nq nr ns b">terraform</code>目录:</p><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="caf6" class="mo jz iq ns b gy ob oc l od oe">$ git clone  <a class="ae lu" href="https://github.com/vikramshinde12/config-service-googlesheet.git" rel="noopener ugc nofollow" target="_blank">https://github.com/vikramshinde12/config-service-googlesheet.git</a></span><span id="26d9" class="mo jz iq ns b gy of oc l od oe">$ cd  config-service-googlesheet/terraform</span></pre><p id="ee30" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">接下来，将<code class="fe np nq nr ns b">terrform.tfvars.example</code>文件复制到<code class="fe np nq nr ns b">terraform.tfvars</code>。您需要替换<code class="fe np nq nr ns b">project</code>变量的值。</p><p id="a433" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">然后，将服务帐户密钥terraform-key.json复制到该文件夹中。</p><p id="856a" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">执行以下命令来设置Google凭证。</p><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="295f" class="mo jz iq ns b gy ob oc l od oe">$ export GOOGLE_CLOUD_KEYFILE_JSON=terraform-key.json</span></pre><p id="a0a5" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">执行地形脚本</strong></p><p id="adc8" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">首先初始化地形。</p><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="e20f" class="mo jz iq ns b gy ob oc l od oe">$ terraform init</span></pre><figure class="nt nu nv nw gt jr gh gi paragraph-image"><div class="gh gi og"><img src="../Images/7676627aa01dc174cd58bc298efe7635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*N4vXkEJFjoy4uFwMk2W58w.png"/></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk translated">初始化地形</figcaption></figure><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="2eda" class="mo jz iq ns b gy ob oc l od oe">$ terraform plan</span></pre><div class="nt nu nv nw gt ab cb"><figure class="ol jr om on oo op oq paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><img src="../Images/46fdac82d8b389481106f469d659f166.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/1*2JyXX50h-uc7OVm5XYTXrQ.png"/></div></figure><figure class="ol jr or on oo op oq paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><img src="../Images/793a44c4883eb34757e7c86596e7e4f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*qM2bGtisiXnOyq3OWRM5pg.png"/></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk os di ot ou translated">地形图</figcaption></figure></div><p id="2e06" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">现在，将更改后的应用到GCP平台。</p><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="ffa0" class="mo jz iq ns b gy ob oc l od oe">$ terraform apply</span></pre><p id="eed9" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">输出将向您显示进度，并最终显示URL。</p><figure class="nt nu nv nw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ov"><img src="../Images/db0e447d1023f3cface32d7f2e48f9b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TJeTbgEcpoLqGiCXrKIOVg.png"/></div></div></figure><p id="3723" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">单击URL，这将打开示例应用程序。</p><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="119c" class="mo jz iq ns b gy ob oc l od oe">$ terraform output url</span></pre><figure class="nt nu nv nw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ow"><img src="../Images/1b1ef2fcb201d56a9a7f565ddda5ebaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lj5Mxla8mCzcZ-wIjRHSDw.png"/></div></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk translated">示例应用程序</figcaption></figure><p id="a686" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">到目前为止，我们已经推出了一个样本谷歌应用程序，但是，在下一步，我们将部署一个自定义应用程序。</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="979c" class="jy jz iq bd ka kb nk kd ke kf nl kh ki kj nm kl km kn nn kp kq kr no kt ku kv bi translated">部署自定义应用程序</h1><p id="eec5" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">如果您已经在上一步中克隆了git存储库，请转到根文件夹。</p><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="c06b" class="mo jz iq ns b gy ob oc l od oe">$ cd ..</span></pre><p id="7c6c" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">然后运行以下命令，将我们的云源代码存储库添加为Git remote:</p><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="7b0c" class="mo jz iq ns b gy ob oc l od oe">$ git remote add google <a class="ae lu" href="https://source.developers.google.com/p/[PROJECT_ID]/r/[REPO_NAME]" rel="noopener ugc nofollow" target="_blank">https://source.developers.google.com/p/[PROJECT_ID]/r/[REPO_NAME]</a></span></pre><p id="625f" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">注意:</strong>您必须用您的GCP项目ID替换<code class="fe np nq nr ns b">[PROJECT_ID]</code>，用您的云资源存储库repo名称替换<code class="fe np nq nr ns b">[REPO_NAME]</code>。您可以从上一步中Terraform的输出中获得repo url。</p><p id="3fd6" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">现在，是时候把app源代码推送到我们的云源回购了。</p><p id="fe19" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">Google Cloud Build将触发新的构建，并在Cloud Run上自动部署结果Docker容器。这是作为资源库根目录中的<strong class="ky ir"> cloudbuild.yaml </strong>文件自动处理的。</p><figure class="nt nu nv nw gt jr"><div class="bz fp l di"><div class="ox oy l"/></div></figure><p id="6ab8" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">按下代码</strong></p><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="49c1" class="mo jz iq ns b gy ob oc l od oe">git push --all google</span></pre><h1 id="2651" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">访问示例应用程序</h1><p id="a192" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这个示例应用程序是Google Sheet上的配置服务。</p><p id="e2ac" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">要访问应用程序，您需要遵循以下步骤</p><ul class=""><li id="cd6e" class="ma mb iq ky b kz lv ld lw lh mc ll md lp me lt mf mg mh mi bi translated">使用任何谷歌帐户创建谷歌表。</li></ul><figure class="nt nu nv nw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oz"><img src="../Images/ba7ed3eb6804e1436f0155d533d6cd11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4JxsUcmFtkvOtU3x.png"/></div></div></figure><ul class=""><li id="f0bd" class="ma mb iq ky b kz lv ld lw lh mc ll md lp me lt mf mg mh mi bi translated">与示例应用程序中创建的服务帐户共享该表</li></ul><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="356c" class="mo jz iq ns b gy ob oc l od oe">$ cd terraform<br/>$ terraform output google_service_account_email</span></pre><ul class=""><li id="df9d" class="ma mb iq ky b kz lv ld lw lh mc ll md lp me lt mf mg mh mi bi translated">点击GET API/project/&lt;&gt;/env/&lt;&gt;/key/&lt;&gt;</li></ul><figure class="nt nu nv nw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pa"><img src="../Images/2c8876c98d33de54f0d039cb69abc912.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Gh_7WQ-Y2iJqIamO.png"/></div></div></figure><h1 id="4d59" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">打扫</h1><p id="a07c" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">首先，永久删除Terraform创建的资源:</p><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="55c2" class="mo jz iq ns b gy ob oc l od oe">$ terraform destroy</span></pre><figure class="nt nu nv nw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pb"><img src="../Images/36875fdfae3eca26a4ea2de35bf4ef38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Y-s2HBZ-xpZl3ppjrpLOg.png"/></div></div></figure><p id="9cee" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">接下来，删除Terraform管理项目及其所有资源:</p><pre class="nt nu nv nw gt nx ns ny nz aw oa bi"><span id="8960" class="mo jz iq ns b gy ob oc l od oe">$ <!-- -->gcloud projects delete [project_id]</span></pre><h1 id="9007" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="fc95" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated"><strong class="ky ir"> Terraform </strong>之所以伟大，是因为它充满活力的开源社区、简单的模块范式以及它是云不可知的事实。</p><h1 id="3506" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">参考</h1><div class="pc pd gp gr pe pf"><a href="https://www.terraform.io/docs/providers/google/guides/getting_started.html" rel="noopener  ugc nofollow" target="_blank"><div class="pg ab fo"><div class="ph ab pi cl cj pj"><h2 class="bd ir gy z fp pk fr fs pl fu fw ip bi translated">HashiCorp的Google provider - Terraform入门</h2><div class="pm l"><h3 class="bd b gy z fp pk fr fs pl fu fw dk translated">在Google Cloud控制台中创建一个项目，并对该项目进行计费。本指南中的任何示例都将…</h3></div><div class="pn l"><p class="bd b dl z fp pk fr fs pl fu fw dk translated">www.terraform.io</p></div></div><div class="po l"><div class="pp l pq pr ps po pt jw pf"/></div></div></a></div><div class="pc pd gp gr pe pf"><a href="https://www.terraform-best-practices.com/" rel="noopener  ugc nofollow" target="_blank"><div class="pg ab fo"><div class="ph ab pi cl cj pj"><h2 class="bd ir gy z fp pk fr fs pl fu fw ip bi translated">欢迎</h2><div class="pm l"><h3 class="bd b gy z fp pk fr fs pl fu fw dk translated">如果你对某些话题感兴趣，请竖起大拇指，或者对你最想了解的问题竖起大拇指。如果你觉得…</h3></div><div class="pn l"><p class="bd b dl z fp pk fr fs pl fu fw dk translated">www.terraform-best-practices.com</p></div></div><div class="po l"><div class="pu l pq pr ps po pt jw pf"/></div></div></a></div></div></div>    
</body>
</html>