<html>
<head>
<title>Sending Slack Messages From Bitbucket Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从位桶管道发送松弛消息</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/sending-slack-messages-from-bitbucket-pipelines-7efc6fc63dc7?source=collection_archive---------6-----------------------#2021-07-19">https://levelup.gitconnected.com/sending-slack-messages-from-bitbucket-pipelines-7efc6fc63dc7?source=collection_archive---------6-----------------------#2021-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="eda6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在空闲时间获取安全报告或平台计划输出</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/39986d190075253e989993556c46f509.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hXHAcwpsIOFqkq22"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@austindistel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Austin Distel </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="574c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有时，您希望在Slack中获得一个额外的通知，告知Bitbucket Pipelines管道中发生了什么，而不打开Bitbucket Pipelines接口。比如说；当一个应用程序正在构建但包含易受攻击的包时，或者当所有自动步骤都已通过而您必须触发一个手动步骤时，请注意。在本文中，我将向您展示几个如何做到这一点的例子。</p><h1 id="ea13" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">先决条件</h1><p id="e93b" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">有一个<a class="ae kv" href="https://bitbucket.org/atlassian/slack-notify/src/master/" rel="noopener ugc nofollow" target="_blank">松弛通知管道</a>可用于位桶管道。你唯一需要做的就是在你的Slack workspace中配置一个webhook，将它的URL添加到你的Bitbucket帐户变量或者存储库变量中作为<code class="fe mp mq mr ms b">SLACK_WEBHOOK_URL</code>——或者其他任何你知道你在做什么的东西——并且在你设置好之后按照这个指南来做。如果您在提到的某个话题上遇到困难，请遵循以下指南:</p><ul class=""><li id="13d0" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr my mz na nb bi translated"><a class="ae kv" href="https://api.slack.com/messaging/webhooks" rel="noopener ugc nofollow" target="_blank">设置一个松弛的网钩</a>，直到并包括步骤3。</li><li id="4b44" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><a class="ae kv" href="https://support.atlassian.com/bitbucket-cloud/docs/variables-and-secrets/" rel="noopener ugc nofollow" target="_blank">位桶帐户和存储库变量</a>，转到工作区/存储库变量</li></ul><h1 id="bc27" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">发送简单的信息</h1><p id="2783" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">如果你想发送一个简单的消息到你的Slack workspace，设置非常简单，你的<code class="fe mp mq mr ms b">bitbucket-pipelines.yml</code>看起来如下。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="981a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将在每次管道运行时发送hello world消息。正如你在下面看到的，这是它在松弛状态下的样子。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/e5d4a6b2c110480daf9af46554c842ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f8DdcIdsSRiPLmM98j5UJg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">这是从位桶管道发送的松弛消息的外观</figcaption></figure><p id="3ffe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您在管道中有一些手动步骤，并且您希望在可以执行这个手动步骤时得到通知，这可能会很方便，例如:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="992e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">闲置时此管道的输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/f42319e9e29812374efd598c0e0ef663.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n0CGZLYG6ECwU1xm-u0iPw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">发送到Slack的消息，通知我们何时可以运行手动步骤</figcaption></figure><h1 id="2993" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">向时差发送报告</h1><p id="34ff" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">让我们假设您想要运行一个依赖检查来扫描易受攻击的包，并在每次管道运行时向Slack发送一个报告。在我的例子中，我想为一个Python应用程序使用库'<a class="ae kv" href="https://pypi.org/project/safety/" rel="noopener ugc nofollow" target="_blank"> safety </a>'，但是你当然可以使用你自己的语言与另一个产生一些输出的漏洞扫描器结合使用。</p><p id="faa7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在通过一个<code class="fe mp mq mr ms b">pip install</code>安装安全之后，安全可以基于一个——在我的例子中是— <code class="fe mp mq mr ms b">requirements.txt</code>文件生成一个报告。我添加了一个包含依赖关系<code class="fe mp mq mr ms b">insecure-package==0.1.0</code>的<code class="fe mp mq mr ms b">requirements.txt</code>文件。然后您可以运行<code class="fe mp mq mr ms b">safety check -r requirements.txt</code>，它将生成以下输出。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/2743a712fd1f848d769e6a36371dbccb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*Fk7jT2_nPwunk5pRDthodA.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">安全报告</figcaption></figure><p id="3f79" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这个输出出现在我的Bitbucket管道接口中，但也出现在Slack中。为此，我们将使用<code class="fe mp mq mr ms b">tee</code>，它允许我们标准输出文本，但也将输出写入一个文件，然后该文件可以被松弛管道拾取，从而产生以下管道配置:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="0ccc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在步骤之间共享工件，因此我们将报告保存到<code class="fe mp mq mr ms b">safety_log.txt</code>，然后可以在slack通知管道的消息中保存为<code class="fe mp mq mr ms b">cat</code>。</p><p id="67d6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这在我们的Bitbucket Pipelines接口中很好地打印了安全检查的报告，如下所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/90ce8891206be4bad39d1a96c47ee3f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U2zQ_c0HkcThQNrtrqm2eQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">Bitbucket管道中的安全报告</figcaption></figure><p id="a60b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管如此，slack消息还是有点混乱，就像你在下图中看到的那样。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/19b3ffd9f5ccdaf9b431195def143b7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*JZg9B7vznnq0Sc4YGAsTqA.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">杂乱的松弛消息包括我们的报告</figcaption></figure><p id="fd44" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要解决这个问题，我们可以替换以下代码行:</p><pre class="kg kh ki kj gt no ms np nq aw nr bi"><span id="19c0" class="ns lt iq ms b gy nt nu l nv nw">safety check -r requirements.txt | tee safety_log.txt</span></pre><p id="53b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以用下面一行替换它，以打印从第15行开始的所有内容:</p><pre class="kg kh ki kj gt no ms np nq aw nr bi"><span id="ce28" class="ns lt iq ms b gy nt nu l nv nw">safety check -r requirements.txt | tail -n +15 | tee safety_log.txt</span></pre><p id="e89c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果也有点乱，就像你在下图中看到的那样。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/63d217c9f44651c62b34cd76375912f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*4T66D3qz67vix8t7Per0lA.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">跳过报告中的14行</figcaption></figure><p id="7f3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您也可以选择仅打印易受攻击的依赖项，方法是将其替换为以下行:</p><pre class="kg kh ki kj gt no ms np nq aw nr bi"><span id="1b91" class="ns lt iq ms b gy nt nu l nv nw">safety check -r requirements.txt --bare | tee safety_log.txt</span></pre><p id="6848" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就像你在下图中看到的，在我看来，这产生了一个非常优雅和简短的信息。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/dcae29f055d8b9471fd0706c16ceb991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*oAmAE7tvwY-bZtGpXZgwPQ.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">仅显示易受攻击的包</figcaption></figure><h1 id="977b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">添加上下文</h1><p id="695e" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">如果您为所有这些消息使用一个Slack通道，那么就不会真正清楚哪个管道刚刚为哪个存储库运行了。我们可以在notify-slack管道中添加<code class="fe mp mq mr ms b">PRETEXT</code>变量，默认为“从管道发送的通知#…”。<br/>我们可以使用由Bitbucket自动注入的变量来提供更多的上下文，比如存储库slug和branch。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">相同的bitbucket-pipelines.yml配置，但添加了托辞变量</figcaption></figure><p id="0c36" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">导致以下松弛消息:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/ef0d3c9b1df2dd47f86a94c4d06578e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QBArga7OAcn_DJcWLNLRbQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">包含更多上下文的备用消息，如存储库名称和分支</figcaption></figure><p id="b36f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您还可以添加更多的逻辑，以查看是否有任何易受攻击的包，并发送消息“没有发现易受攻击的包！”<code class="fe mp mq mr ms b">safety_log.txt</code>为空时。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">检查是否有任何易受攻击的依赖项</figcaption></figure><p id="7291" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从我们的<code class="fe mp mq mr ms b">requirements.txt</code>中移除<code class="fe mp mq mr ms b">insecure-package==0.1.0</code>后，会产生以下Slack消息。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/5f5097d9418c1c48c413d627928daea6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/format:webp/1*zhV3jwwBnnjwQLdQTyehdQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">消息表明没有易受攻击的软件包</figcaption></figure><h1 id="d0e1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">就是这样！</h1><p id="5399" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">这是将文件内容发送到松弛通道的几个例子。就像我说的，你可以用你自己的语言和依赖漏洞扫描器来使用它，或者你可以和其他工具一起使用，比如terraform，code linters，单元测试等等。</p><h1 id="f1b3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">问题、建议或反馈</h1><p id="9a89" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">如果您对本文有任何问题、建议或反馈，请告诉我！</p></div></div>    
</body>
</html>