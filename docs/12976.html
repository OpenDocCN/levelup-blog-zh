<html>
<head>
<title>Firebase JS v9 — embrace pipe() and curry() with the new API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">firebase JS v9——用新的API拥抱pipe()和curry()</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/firebase-js-v9-embrace-pipe-and-curry-with-the-new-api-d480b0d0f67a?source=collection_archive---------6-----------------------#2022-07-27">https://levelup.gitconnected.com/firebase-js-v9-embrace-pipe-and-curry-with-the-new-api-d480b0d0f67a?source=collection_archive---------6-----------------------#2022-07-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/376519247e8ec52ce570c396ccbe279e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nqKR3NhBArdZkB8PV-gmWw.png"/></div></div></figure><p id="9717" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Firebase用v9版本改变了他们的Javascript API。以前的方法是链式的，这使得它们更具可读性:</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="la lb l"/></div></figure><p id="d606" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，Firebase 9采用了一种更加模块化、面向函数式编程的方法:</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="la lb l"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">最后，我们来比较一下:</figcaption></figure><p id="d06d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这带来了一些好处:</p><ul class=""><li id="4815" class="lg lh iq ka b kb kc kf kg kj li kn lj kr lk kv ll lm ln lo bi translated">对Firebase团队来说，测试功能更容易</li><li id="1ae4" class="lg lh iq ka b kb lp kf lq kj lr kn ls kr lt kv ll lm ln lo bi translated">促进树的摇动(减少包的大小——编译时丢弃不用的模块/函数)</li></ul><p id="ebb2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，当API用户(开发者)尝试一些更现实的东西时，事情就变得混乱了(人们已经<a class="ae lu" href="https://www.reddit.com/r/Firebase/comments/vy9dfv/the_v9_js_sdk_is_a_horrendous_developer_experience/" rel="noopener ugc nofollow" target="_blank">抱怨</a>):</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="la lb l"/></div></figure><p id="b174" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从代码读者的角度来看，操作现在是向后的。任何有一点编程经验的人都不应该编写这样的代码。解决这个问题的好办法是使用变量:</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="la lb l"/></div></figure><p id="9d95" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，避免过度使用变量是一个好主意，因为它会引入更多的错误可能性。可能有一个更好的方法来使用新的API:尝试用<em class="lv">处理</em>新的函数，并用<em class="lv">管道处理</em>它们。如果您是函数式编程的新手，我建议您阅读其他文章来理解这两个概念是如何工作的。</p><p id="cde4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了简化它:</p><ul class=""><li id="1edf" class="lg lh iq ka b kb kc kf kg kj li kn lj kr lk kv ll lm ln lo bi translated">pipe()返回一个我们可以调用的函数。任何参数都将传递给列表中的第一项，我们将得到最后一项的结果。</li><li id="0e68" class="lg lh iq ka b kb lp kf lq kj lr kn ls kr lt kv ll lm ln lo bi translated">curry()返回提供的相同函数，我们可以部分完成该函数以便稍后执行(当提供了所有参数时)。从<em class="lv"> ref </em>到<a class="ae lu" href="https://firebase.google.com/docs/reference/js/database.md#ref" rel="noopener ugc nofollow" target="_blank"> docs </a>:如果我们<code class="fe lw lx ly lz b">const refC = curry(ref)</code>，我们可以调用<code class="fe lw lx ly lz b">const refDb = refC(database)</code>以及后来的<code class="fe lw lx ly lz b">refDb('users')</code>。</li></ul><p id="e7fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Firebase的API通常将上下文(引用、数据库)作为第一个参数，将特定于函数的信息(路径、有效载荷)作为第二个参数(<a class="ae lu" href="https://dev.to/richytong/practical-functional-programming-in-javascript-data-last-1gjo" rel="noopener ugc nofollow" target="_blank"> data-last </a>)。所以我们从右边的<em class="lv">开始。例如，在<code class="fe lw lx ly lz b">ref() </code>中，首先提供路径，然后当我们有了数据库时再获取引用。</em></p><p id="9b43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ramda 是一个很棒的FP库，但是它没有提供一个直接的方法来进行反向currying。所以我们用洛达什的<a class="ae lu" href="https://lodash.com/docs/4.17.15#curryRight" rel="noopener ugc nofollow" target="_blank"> <em class="lv"> curryRight </em> </a>。如果你用的是ESM，安装<code class="fe lw lx ly lz b">lodash-es</code>吧。</p><p id="ffea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最初我们得到:</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="la lb l"/></div></figure><p id="9be6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">后一种选择满足了FP避免变量的原则，但是可读性较差(尤其是调用您刚刚创建的函数)。第一个选项可读性更强，并且可以将操作导出到单独的文件中，以便重用。</p><p id="08db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">至少我们应该将curried API导出到一个单独的文件中:</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="la lb l"/></div></figure><p id="1be1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们不必区分<em class="lv"> ref </em>和<em class="lv"> refC </em>。</p><p id="8f62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你在两个选项之间的选择取决于你的情况。我不得不重构一个现有的Vue.js应用程序，第二种方法更简单，因为每个Vue组件都直接使用Firebase，没有任何服务功能(例如，<code class="fe lw lx ly lz b">/services/users/getUser</code>)。一个真实的例子:</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="la lb l"/></div></figure><p id="b611" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我的目标不是纯函数，所以插入外部变量(表单状态、用户ID)是微不足道的。</p><p id="7d55" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另一方面，当创建一个<em class="lv">新的</em>应用程序时，你应该将动作外化到服务文件中。</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="la lb l"/></div></figure><p id="b87f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好多了。如果您决定使用另一种数据库技术，这个函数很容易替换。虽然需要把我们的第一个逻辑元素(<code class="fe lw lx ly lz b">usersRef</code>)移到底部会带来一些混乱。</p><p id="aeb2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不幸的是，general currying并不支持打字稿。当你使用这个函数时，解释器不能理解输出的内容。在这种情况下，您可以完全放弃lodash，手动执行这些功能:</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="la lb l"/></div></figure><p id="e356" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，让我们做一个简单的比较:</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="la lb l"/></div></figure><p id="373c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">希望这对你有用。我还没有完成对我的应用程序的重构，所以没有时间来解决这个问题。从中取之所需，应用自己的喜好，得到适合自己的风格。</p><p id="49c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于Docker用户，我已经为两个API版本创建了一个<a class="ae lu" href="https://github.com/marius321967/firebase-9-fp-playground" rel="noopener ugc nofollow" target="_blank">演示</a>(里面有说明)。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><p id="e200" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意#1:新的Firebase v9 SDK提供了一个<a class="ae lu" href="https://firebase.google.com/docs/web/modular-upgrade#about_the_compat_libraries" rel="noopener ugc nofollow" target="_blank"> <em class="lv"> compat </em> </a> API，它允许方法链接并减少了重构的需要——这超出了本文的范围。</p><p id="ee3f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意#2:本文使用实时数据库。其他模块未测试。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h1 id="021d" class="mh mi iq bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">分级编码</h1><p id="8725" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="06f7" class="lg lh iq ka b kb kc kf kg kj li kn lj kr lk kv ll lm ln lo bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="2116" class="lg lh iq ka b kb lp kf lq kj lr kn ls kr lt kv ll lm ln lo bi translated">📰查看<a class="ae lu" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="bd85" class="lg lh iq ka b kb lp kf lq kj lr kn ls kr lt kv ll lm ln lo bi translated">🔔关注我们:<a class="ae lu" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae lu" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae lu" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="d93d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">🚀👉<a class="ae lu" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>