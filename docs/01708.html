<html>
<head>
<title>Angular Validations Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">角度验证引擎</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/angular-validations-engine-a4c06b7d3274?source=collection_archive---------8-----------------------#2020-01-23">https://levelup.gitconnected.com/angular-validations-engine-a4c06b7d3274?source=collection_archive---------8-----------------------#2020-01-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/e62a8b9fc9cf496b7045d071a43f7a2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:812/format:webp/1*owJGzhYIsBe1Fzjk_RV46g.png"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">来源:angular.io</figcaption></figure><p id="e4ef" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">大家好！在本文中，我们将讨论反应式表单，以及如何设置一个通用引擎来处理错误，而无需创建重复的条件代码来显示基于反应式表单当前状态的错误消息。</p><p id="2275" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">自从我开始使用angular，特别是反应式表单，我总是有点厌倦，我需要不断地重复相同的代码，只是为了检查特定的formControl中是否存在错误，然后有条件地显示错误消息。</p><p id="1610" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有一天，我想知道是否有可能创建一些代码，将普遍适用于我的所有表单，每当formControl上发生错误时，它将能够简单地检查错误键并显示相应的错误消息。</p><p id="8690" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以，让我们开始挖掘它，并把我们的手！</p><p id="582c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们的用户应该能够用合适的语言与我们的应用程序进行交互。为了实现我们的多语言逻辑，我们将使用一个名为ngx-translate的不错的库。让我们来设置一下:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="ee33" class="li lj it le b gy lk ll l lm ln">npm install @ngx-translate/core --save</span><span id="a53a" class="li lj it le b gy lo ll l lm ln">npm install @ngx-translate/http-loader --save</span></pre><p id="3984" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在assets/i18n文件夹中添加必要的英语和法语翻译文件:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="7f31" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">设置应用模块:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="1e97" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们已经有了翻译库，我们需要一个表单来开始工作。让我们把它放在我们的app.component.html档案里:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="ca98" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们在app.component.ts文件中添加必要的逻辑:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="3bde" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一个html表单由一个或多个表单控件元素组成，用来设置表单数据，所以对于每个元素，我们都需要一个相应的角度反应式表单控件来处理验证逻辑。所以让我们建立一个角度反应表单组来关联我们的表单和表单控制元素。但是，与通常手工创建不同，让我们使用一个非常好的库RxWeb，它利用typescript decorators来帮助我们生成表单组。</p><p id="6694" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先让我们安装RxWeb:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="69b8" class="li lj it le b gy lk ll l lm ln">npm install @rxweb/reactive-form-validators</span></pre><p id="305c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在让我们创建表单模型。我们的示例场景将是一个用户注册页面，因此让我们创建一个注册模型:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="c05e" class="li lj it le b gy lk ll l lm ln">ng generate class models/resgister --skiptests=true</span></pre><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="0d69" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们用每个属性的RxWeb验证器来设置我们的注册模型:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="390d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在让我们一起努力。首先，让我们在应用程序组件的init上创建表单组:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="49b5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们将控件应用于表单输入:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="40a9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们有一个合适的表单和所有的验证逻辑设置，但我们仍然需要一种方法来监听每当用户与表单元素交互时由我们的反应式表单控件抛出的所有错误。</p><p id="cfab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先，让我们生成一个单独的角度模块，以保持我们所有的代码与我们的验证引擎相关。这样，我们可以保持解决方案整洁有序:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="bd62" class="li lj it le b gy lk ll l lm ln">ng generate module validations-module</span></pre><p id="cd3c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，让我们创建一个指令来处理来自控件的错误:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="374e" class="li lj it le b gy lk ll l lm ln">ng generate directive validations-module/directives/control-errors/control-errors</span></pre><p id="cfca" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们的指令代码:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="cdbf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如您所见，我们正在处理三个可观察到的问题:</p><ul class=""><li id="3028" class="lr ls it kd b ke kf ki kj km lt kq lu ku lv ky lw lx ly lz bi translated">当用户触摸表单控件时触发的触摸事件</li><li id="2114" class="lr ls it kd b ke ma ki mb km mc kq md ku me ky lw lx ly lz bi translated">用户键入数据时触发的值更改事件</li><li id="e9f6" class="lr ls it kd b ke ma ki mb km mc kq md ku me ky lw lx ly lz bi translated">当formControl验证状态改变时触发的控件状态改变(通常在我们操作验证状态时使用，因为验证是在后端完成的，我们希望用适当的错误消息来呈现)</li></ul><p id="29ed" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了让每个字段有一个合适的名称显示在错误消息上，我们使用一个指令输入来接收一个翻译键。之后，我们将把它和一般的错误信息一起插入。</p><p id="1bf7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们还完成了由基于destroySubject的merge操作符创建的内部可观察对象，这样我们避免了由未完成的可观察对象导致的内存泄漏。</p><p id="cf0b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">目前，我们正在监听表单控件抛出的所有验证错误。我们仍然需要获取错误，找到相应的错误消息并显示给用户。为了做到这一点，让我们创建一个静态助手类来处理这个问题:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="89e1" class="li lj it le b gy lk ll l lm ln">ng generate class validations-module/helpers/error-helper --skipTests=true</span></pre><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="2c77" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">正如您所看到的，这个helper类只有一个公共方法(getError ),它接收两个参数字段名转换和formControl错误。它返回AutoError或DefaultError的实例。自动错误将由我们的验证引擎处理，并将自动向用户显示正确的错误消息。我们的验证引擎不会处理DefaultErrors，它将像普通的反应式表单验证一样工作。为了显示错误信息，我们需要实现这样的代码。当我们需要以一种定制的方式显示错误时，比如在一个对话框或一条消息中，这是非常有用的。</p><p id="5480" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当处理AutoErrors时，如果error键匹配一个错误，那么我们创建并返回一个AutoError对象的新实例。否则，我们检查它是否已经是AutoError或DefaultError的实例，并返回它以便以后显示。如果错误既不是AutoError也不是DefaultError类型，我们抛出一个异常。</p><p id="f97e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">助手可以接收并显示由验证器传递的自定义错误消息。我们已经在注册模型的电子邮件验证器属性上设置了一个。</p><p id="e195" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由于ngx-translate允许在翻译中插入值，因此该助手还处理从验证错误对象中获取值的逻辑，这些值随后将被插入到消息中。</p><p id="2060" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们来听听当用户触摸或输入一些文本时表单控件元素内的交互。如果它只是简单地提交表单而没有任何交互呢？因此，让我们创建另一个指令来处理这个用例:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="2a42" class="li lj it le b gy lk ll l lm ln">ng generate directive validations-module/directives/form-submit/form-submit --skipTests=true</span></pre><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="b9ec" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里我们使用shareReplay操作符，每个表单只有一个事件侦听器，而不是每个控件一个。</p><p id="b549" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们已经实现了所有的逻辑来观察我们所有的表单控件验证、表单提交动作并生成正确的错误对象和翻译，酷！但是我们仍然需要挑选自动错误，并用一些漂亮的外观和感觉向用户显示正确的错误消息，所以让我们为此创建一个组件:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="88c3" class="li lj it le b gy lk ll l lm ln">ng generate component validations-module/components/auto-error --skipTests=true</span></pre><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="3672" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如您所见，该组件只处理翻译成用户所选语言的AutoError对象的表示。如果您试图在表单完成过程中更改语言，它也会更新错误消息。</p><p id="5c01" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们有适当的组件来呈现我们的错误。因此，让我们实现一些代码来动态地创建这个组件并将其注入DOM。让我们改进我们的控制错误指令:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="17b1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们的引擎可以使用了。让我们启动我们的应用程序，测试我们的表单验证！</p><p id="106c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这里，您可以使用一些额外的自定义验证器来检查完整的工作示例，并使用window alert显示一个默认错误:</p><div class="mf mg gp gr mh mi"><a href="https://stackblitz.com/github/jgomesmv/AngularValidationsEngine" rel="noopener  ugc nofollow" target="_blank"><div class="mj ab fo"><div class="mk ab ml cl cj mm"><h2 class="bd iu gy z fp mn fr fs mo fu fw is bi translated">角度验证引擎</h2><div class="mp l"><h3 class="bd b gy z fp mn fr fs mo fu fw dk translated">完整示例</h3></div><div class="mq l"><p class="bd b dl z fp mn fr fs mo fu fw dk translated">stackblitz.com</p></div></div><div class="mr l"><div class="ms l mt mu mv mr mw jv mi"/></div></div></a></div></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><blockquote class="ne nf ng"><p id="6021" class="kb kc nh kd b ke kf kg kh ki kj kk kl ni kn ko kp nj kr ks kt nk kv kw kx ky im bi translated">归功于以下人员的出色工作和帮助:</p><p id="7bea" class="kb kc nh kd b ke kf kg kh ki kj kk kl ni kn ko kp nj kr ks kt nk kv kw kx ky im bi translated"><a class="ae nl" href="https://netbasal.com/make-your-angular-forms-error-messages-magically-appear-1e32350b7fa5" rel="noopener ugc nofollow" target="_blank">https://net basal . com/make-your-angular-forms-error-messages-magically-appear-1e 32350 b7fa 5</a></p><p id="2778" class="kb kc nh kd b ke kf kg kh ki kj kk kl ni kn ko kp nj kr ks kt nk kv kw kx ky im bi translated"><a class="ae nl" href="https://medium.com/@oojhaajay/new-way-to-validate-the-angular-reactive-form-2c4fe4f13373" rel="noopener">https://medium . com/@ oojhaajay/new-way-to-validate-the-angular-reactive-form-2 C4 Fe 4 f 13373</a></p><p id="e53e" class="kb kc nh kd b ke kf kg kh ki kj kk kl ni kn ko kp nj kr ks kt nk kv kw kx ky im bi translated">【https://github.com/ngx-translate/core T4】</p></blockquote></div></div>    
</body>
</html>