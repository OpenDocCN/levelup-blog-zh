# å¦‚ä½•å¤„ç† JavaScript ä¸­çš„å¼‚æ­¥ä»£ç 

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/how-to-deal-with-asynchronous-code-in-javascript-e9f437b46832>

> JavaScript é»˜è®¤ä¸º ***åŒæ­¥*** å¹¶ä¸”æ˜¯å•çº¿ç¨‹çš„ã€‚
> è¿™æ„å‘³ç€ä»£ç ä¸èƒ½åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œå®ƒä¼šåœ¨ ***æå‡*** ä¹‹åæŒ‰é¡ºåºæ‰§è¡Œä½ çš„ä»£ç å—ã€‚

åƒ Cã€Javaã€C#ã€PHPã€Goã€Rubyã€Swift å’Œ Python è¿™æ ·çš„ç¼–ç¨‹è¯­è¨€åœ¨é»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯åŒæ­¥çš„ï¼Œå…¶ä¸­ä¸€äº›è¯­è¨€é€šè¿‡ä½¿ç”¨çº¿ç¨‹å’Œäº§ç”Ÿæ–°çš„è¿›ç¨‹æ¥å¤„ç†å¼‚æ­¥ã€‚

è¿™æ˜¯ä¸€ä¸ªåŒæ­¥ä»£ç çš„ä¾‹å­

```
const a = 1;
console.log(a + 1);
console.log('3');
handleSomething();
```

ä¸€è¡Œè¡Œä»£ç è¢«ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°è¿ç»­æ‰§è¡Œã€‚

ç”±äº JavaScript è¯ç”Ÿäºæµè§ˆå™¨å†…éƒ¨ï¼Œå®ƒçš„ä¸»è¦å·¥ä½œï¼Œåœ¨å¼€å§‹æ—¶ï¼Œæ˜¯å“åº”ç”¨æˆ·çš„åŠ¨ä½œï¼Œå¦‚`onClick`ã€`onMouseOver`ã€`onChange`ã€`onSubmit`ç­‰ç­‰ã€‚å®ƒå¦‚ä½•ç”¨åŒæ­¥ç¼–ç¨‹æ¨¡å‹åšåˆ°è¿™ä¸€ç‚¹å‘¢ï¼Ÿ

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¾‹å¦‚å½“ä½ æƒ³ä»ä¸€ä¸ªæœåŠ¡å™¨è·å–ä¸€äº›æ•°æ®æ—¶(è¿™å¯èƒ½éœ€è¦ä¸€æ®µæœªçŸ¥çš„æ—¶é—´),å¦‚æœä½ çš„ç¨‹åºåœ¨ç­‰å¾…è·å–æ•°æ®æ—¶å®Œå…¨å†»ç»“ï¼Œæ•ˆç‡ä¼šéå¸¸ä½ã€‚å› æ­¤ï¼Œé€šå¸¸ä¸è¿™æ ·åšï¼Œè€Œæ˜¯åœ¨åå°è¿è¡Œè·å–ä»»åŠ¡ã€‚
è¿™æ„å‘³ç€å¦‚æœä¸€è¡Œä¸­æœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œè€Œå‡½æ•° A æ˜¯ ***å¼‚æ­¥çš„*** ï¼Œé‚£ä¹ˆå‡½æ•° B å°†åœ¨å‡½æ•° A ä»åœ¨è¿è¡Œæ—¶æ‰§è¡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå‡½æ•° B ä¾èµ–äºå‡½æ•° A è·å–çš„æ•°æ®ï¼Œä½ å°±ä¼šé‡åˆ°é—®é¢˜ã€‚

> å¼‚æ­¥æ„å‘³ç€äº‹æƒ…å¯ä»¥ç‹¬ç«‹äºä¸»ç¨‹åºæµå‘ç”Ÿã€‚

# å¤è¯•

è¿™ä¸ªé—®é¢˜ç”¨ ***å›è°ƒ*** è§£å†³äº†ã€‚

å›è°ƒæ˜¯ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œä½œä¸ºä¸€ä¸ªå€¼ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°ï¼Œåªåœ¨äº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œã€‚æœ‰äº†å›è°ƒï¼Œä½ å¯ä»¥ä¿è¯å‡½æ•° B åªåœ¨å‡½æ•° A å®Œæˆå®ƒçš„ä»»åŠ¡åè¢«è°ƒç”¨ï¼Œå› ä¸ºå‡½æ•° A å®é™…ä¸Šæ˜¯è´Ÿè´£è°ƒç”¨å‡½æ•° B çš„äººã€‚

```
// doSomething => functionA
// callback => functionBfunction doSomething (options, callback) {
    callback (options);
}doSomething(options, callback);
```

å›è°ƒå¯¹äºç®€å•çš„æƒ…å†µå¾ˆæœ‰ç”¨ï¼Œä½†æ˜¯æ¯ä¸ªå›è°ƒéƒ½ä¼šå¢åŠ ä¸€å±‚åµŒå¥—ï¼Œå½“ä½ æœ‰å¾ˆå¤šå›è°ƒçš„æ—¶å€™ï¼Œä»£ç ä¼šå¾ˆå¿«å˜å¾—å¤æ‚ã€‚

```
window.addEventListener('load', () => {
  document.getElementById('button').addEventListener('click', () => {
    setTimeout(() => {
      items.forEach(item => {
        //your code here
      })
    }, 2000)
  })
})
```

è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ 4 å±‚ä»£ç ï¼Œä½†æ˜¯ä½ å·²ç»çœ‹åˆ°äº†æ›´å¤šçš„åµŒå¥—å±‚ï¼Œè¿™å¹¶ä¸æœ‰è¶£ã€‚

> ***ä» ES6*** å¼€å§‹ï¼ŒJavaScript å¼•å…¥äº†å‡ ä¸ªç‰¹æ€§æ¥å¸®åŠ©æˆ‘ä»¬å¤„ç†ä¸æ¶‰åŠå›è°ƒçš„å¼‚æ­¥ä»£ç :

# æ‰¿è¯º

***æ‰¿è¯º*** æ˜¯å¤„ç†å›è°ƒå›°å¢ƒå’Œé˜²æ­¢åœ¨ä»£ç ä¸­ç¼–å†™è¿‡å¤šå›è°ƒçš„ä¸€ç§æ–¹æ³•ã€‚

ä¸€æ—¦æ‰¿è¯ºè¢«è°ƒç”¨ï¼Œå®ƒå°†ä»**æœªå†³çŠ¶æ€**å¼€å§‹ã€‚è¿™æ„å‘³ç€è°ƒç”¨è€…å‡½æ•°ç»§ç»­æ‰§è¡Œï¼ŒåŒæ—¶ç­‰å¾…æ‰¿è¯ºè¿›è¡Œè‡ªå·±çš„å¤„ç†ï¼Œå¹¶ç»™è°ƒç”¨è€…å‡½æ•°ä¸€äº›åé¦ˆã€‚

æ­¤æ—¶ï¼Œè°ƒç”¨è€…å‡½æ•°ç­‰å¾…å®ƒè¿”å›å¤„äº**å·²è§£å†³çŠ¶æ€**æˆ–**å·²æ‹’ç»çŠ¶æ€**çš„æ‰¿è¯ºï¼Œä½†æ˜¯*å‡½æ•°ç»§ç»­æ‰§è¡Œï¼ŒåŒæ—¶æ‰¿è¯ºå·¥ä½œ*ã€‚

promise å¯¹è±¡çš„æ„é€ å‡½æ•°è¯­æ³•æ˜¯:

```
let promise = new Promise(function(resolve, reject) {
  // executor (the producing code, "singer")
});
```

äº§ç”Ÿçš„`promise`å¯¹è±¡å…·æœ‰å†…éƒ¨å±æ€§:

*   `state` â€”æœ€åˆä¸ºâ€œå¾…å®šâ€ï¼Œç„¶åå˜ä¸ºâ€œå·²å±¥è¡Œâ€æˆ–â€œå·²æ‹’ç»â€ï¼Œ
*   `result` â€”æ‚¨é€‰æ‹©çš„ä»»æ„å€¼ï¼Œæœ€åˆä¸º`undefined`ã€‚

å½“æ‰§è¡Œç¨‹åºå®Œæˆä½œä¸šæ—¶ï¼Œå®ƒåº”è¯¥è°ƒç”¨ä¸€ä¸ªä½œä¸ºå‚æ•°è·å¾—çš„å‡½æ•°:

*   `resolve(value)` â€”è¡¨ç¤ºä½œä¸šæˆåŠŸå®Œæˆ:
*   å°†`state`è®¾ç½®ä¸º`"fulfilled"`ï¼Œ
*   å°†`result`è®¾ç½®ä¸º`value`ã€‚
*   `reject(error)` â€”è¡¨ç¤ºå‘ç”Ÿäº†é”™è¯¯:
*   å°†`state`è®¾ç½®ä¸º`"rejected"`ï¼Œ
*   å°†`result`è®¾ç½®ä¸º`error`ã€‚

![](img/1a9d96672bb3c7517fd0c2a5d6f0549b.png)

> `**resolve**`å’Œ`**reject**` â€”è¿™äº›å‡½æ•°ç”± JavaScript å¼•æ“é¢„å®šä¹‰ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦åˆ›å»ºå®ƒä»¬ã€‚ç›¸åï¼Œæˆ‘ä»¬åº”è¯¥ç¼–å†™æ‰§è¡Œç¨‹åºåœ¨å‡†å¤‡å¥½çš„æ—¶å€™è°ƒç”¨å®ƒä»¬ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ª Promise æ„é€ å‡½æ•°å’Œä¸€ä¸ªç®€å•çš„ executor å‡½æ•°çš„ä¾‹å­:

```
let promise = new Promise(function(resolve, reject) {
  // the function is executed automatically when the promise is constructed

  // after 1 second signal that the job is done with the result "done"
  setTimeout(() => resolve("done"), 1000);
});
```

â€œå¤„ç†â€ä¸€ç§’é’Ÿåï¼Œæ‰§è¡Œè€…è°ƒç”¨`resolve("done")`äº§ç”Ÿç»“æœ:

![](img/b67fdf7b89feacf79980f9bcd399e9c8.png)

è¿™æ˜¯ä¸€ä¸ªæˆåŠŸå®Œæˆå·¥ä½œçš„ä¾‹å­ï¼Œä¸€ä¸ªâ€œå®ç°çš„æ‰¿è¯ºâ€ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªæ‰§è¡Œè€…é”™è¯¯åœ°æ‹’ç»æ‰¿è¯ºçš„ä¾‹å­:

```
let promise = new Promise(function(resolve, reject) {
  // after 1 second signal that the job is finished with an error
  setTimeout(() => reject(new Error("Whoops!")), 1000);
});
```

æ‰§è¡Œäººè¦åšä¸€äº›é€šå¸¸éœ€è¦æ—¶é—´çš„äº‹æƒ…ç„¶åè°ƒç”¨`resolve`æˆ–è€…`reject`æ¥æ”¹å˜å¯¹åº”çš„æ‰¿è¯ºå¯¹è±¡çš„çŠ¶æ€ã€‚

> è®¸è¯ºå¯ä»¥ ***æ¶ˆè€—*** æˆ–è€…ä½¿ç”¨ã€‚

```
const doSomething = new Promise()
//...

const checkIfItsDone = () => {
  doSomething
    .then(ok => {
      console.log(ok)
    })
    .catch(err => {
      console.error(err)
    })
}
```

è¿è¡Œ`checkIfItsDone()`å°†æ‰§è¡Œ`doSomething()`æ‰¿è¯ºï¼Œå¹¶ç­‰å¾…å®ƒè§£å†³ï¼Œä½¿ç”¨`then`å›è°ƒï¼Œå¦‚æœæœ‰é”™è¯¯ï¼Œå®ƒå°†åœ¨`catch` å›è°ƒä¸­å¤„ç†å®ƒã€‚

> æ‰¿è¯ºçš„å¼•å…¥æ˜¯ä¸ºäº†è§£å†³è‘—åçš„*å›è°ƒå›°å¢ƒ*ï¼Œä½†æ˜¯å®ƒä»¬æœ¬èº«å¼•å…¥äº†å¤æ‚æ€§å’Œè¯­æ³•å¤æ‚æ€§ã€‚

# å¼‚æ­¥/ç­‰å¾…

ç”±äº ES2017 å¼‚æ­¥ JavaScript ä½¿ç”¨äº† async/await è¯­æ³•ï¼Œå› æ­¤æ›´åŠ ç®€å•ã€‚

## å¼‚æ­¥å‡½æ•°

ä»¥ä¸€ç§æ›´èˆ’é€‚çš„æ–¹å¼ï¼Œä»–ä»¬å‡å°‘äº†æ‰¿è¯ºå‘¨å›´çš„æ ·æ¿æ–‡ä»¶ï¼Œä»¥åŠé“¾æ¥æ‰¿è¯ºçš„â€œä¸è¦æ‰“ç ´é“¾æ¡â€çš„é™åˆ¶ã€‚å®ƒéå¸¸å®¹æ˜“ç†è§£å’Œä½¿ç”¨ã€‚

`async`å…³é”®å­—æ”¾åœ¨å‡½æ•°ä¹‹å‰ï¼Œå…³é”®å­—`await`è®© JavaScript ç­‰å¾…ï¼Œç›´åˆ°æ‰¿è¯ºå®Œæˆå¹¶è¿”å›ç»“æœã€‚

```
async function f() {

  let promise = new Promise((resolve, reject) => {
    setTimeout(() => resolve("done!"), 1000)
  });

  let result = await promise; // wait till the promise resolves (*)

  alert(result); // "done!"
}

f();
```

åœ¨ä»»ä½•å‡½æ•°å‰é¢åŠ ä¸Š`async`å…³é”®å­—æ„å‘³ç€è¯¥å‡½æ•°å°†è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œå¹¶å°†éæ‰¿è¯ºåŒ…è£…åœ¨å…¶ä¸­ã€‚`await`å­—é¢æ„æ€æ˜¯è®© JavaScript ç­‰åˆ°æ‰¿è¯ºè¾¾æˆï¼Œç„¶åç»§ç»­å¤„ç†ç»“æœã€‚è¿™ä¸ä¼šæ¶ˆè€—ä»»ä½• CPU èµ„æºï¼Œå› ä¸ºå¼•æ“å¯ä»¥åŒæ—¶åšå…¶ä»–å·¥ä½œ:æ‰§è¡Œå…¶ä»–è„šæœ¬ï¼Œå¤„ç†äº‹ä»¶ç­‰ã€‚

å¦‚æœä½ æƒ³è·å¾—æ›´å¤šçš„é˜…è¯»èµ„æ–™ï¼Œè¿™é‡Œæœ‰ä¸€äº›æˆ‘æœ€å–œæ¬¢çš„å…³äºæ‰¿è¯ºå’Œå¼‚æ­¥/ç­‰å¾…ç¼–ç çš„åšæ–‡:

[](/understand-javascript-promises-by-building-a-promise-from-scratch-84c0fd855720) [## JavaScript æ‰¿è¯ºâ€”â€”é€šè¿‡æ„å»ºä¸€ä¸ªç®€å•çš„æ‰¿è¯ºç¤ºä¾‹æ¥ç†è§£ JavaScript æ‰¿è¯º

### ä¸€æ­¥ä¸€æ­¥çš„æ•™ç¨‹ï¼Œç¡®ä¿ä½ å®Œå…¨ç†è§£ JavaScript çš„æ‰¿è¯ºæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä»â€¦

levelup.gitconnected.com](/understand-javascript-promises-by-building-a-promise-from-scratch-84c0fd855720) [](https://flaviocopes.com/javascript-promises/) [## ç†è§£ JavaScript æ‰¿è¯º

### å­¦ä¹  JavaScriptï¼Ÿä¸‹è½½æˆ‘çš„å…è´¹ JavaScript æ‰‹å†ŒğŸ”¥æ‰¿è¯ºé€šå¸¸è¢«å®šä¹‰ä¸ºä¸€ç§ä»·å€¼çš„ä»£è¡¨â€¦

flaviocopes.com](https://flaviocopes.com/javascript-promises/) [](https://hackernoon.com/javascript-promises-and-why-async-await-wins-the-battle-4fc9d15d509f) [## JavaScript:æ‰¿è¯ºå’Œä¸ºä»€ä¹ˆ Async/Await èµ¢å¾—äº†è¿™åœºæˆ˜æ–—

### å¼‚æ­¥å‡½æ•°åœ¨ JavaScript ä¸­æœ‰å¥½æœ‰åã€‚å¥½çš„ä¸€é¢æ˜¯å¼‚æ­¥å‡½æ•°â€¦

hackernoon.com](https://hackernoon.com/javascript-promises-and-why-async-await-wins-the-battle-4fc9d15d509f) 

æ„Ÿè°¢é˜…è¯»ï¼:)