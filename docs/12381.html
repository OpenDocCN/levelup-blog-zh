<html>
<head>
<title>Create an Optimized Rust Alpine Docker Image</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建优化的Rust Alpine Docker图像</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/create-an-optimized-rust-alpine-docker-image-1940db638a6c?source=collection_archive---------2-----------------------#2022-06-06">https://levelup.gitconnected.com/create-an-optimized-rust-alpine-docker-image-1940db638a6c?source=collection_archive---------2-----------------------#2022-06-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="f42d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在Alpine Docker映像上运行Rust应用程序并不简单。但是不用担心。我将向您展示如何基于Alpine Linux创建一个优化的小型Rust Docker映像。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/27f985263bba3747eabc6a34e4ea75cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0uJB2qBaaGR1biF82CBOgw.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Rust编程语言</figcaption></figure><h2 id="7c7b" class="le lf it bd lg lh li dn lj lk ll dp lm kb ln lo lp kf lq lr ls kj lt lu lv lw bi translated">GitHub知识库</h2><p id="0fdf" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">如果您对整个应用程序感兴趣，并且想要查看使用的代码，请查看我为本文创建的这个<a class="ae mc" href="https://github.com/mr-pascal/medium-rust-dockerize" rel="noopener ugc nofollow" target="_blank"> GitHub资源库</a>。</p><div class="md me gp gr mf mg"><a href="https://github.com/mr-pascal/medium-rust-dockerize" rel="noopener  ugc nofollow" target="_blank"><div class="mh ab fo"><div class="mi ab mj cl cj mk"><h2 class="bd iu gy z fp ml fr fs mm fu fw is bi translated">GitHub-Mr-Pascal/medium-rust-dockerize</h2><div class="mn l"><h3 class="bd b gy z fp ml fr fs mm fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mo l"><p class="bd b dl z fp ml fr fs mm fu fw dk translated">github.com</p></div></div><div class="mp l"><div class="mq l mr ms mt mp mu ky mg"/></div></div></a></div><p id="b4cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于这个演示，我使用<code class="fe mv mw mx my b">warp</code>和<code class="fe mv mw mx my b">tokio</code>机箱建立了一个简单的web服务器，并且只暴露了一个返回字符串<code class="fe mv mw mx my b">Hello, :text!</code>的<code class="fe mv mw mx my b">GET /hello/:text</code>端点。</p><p id="9d3a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用这个小的web服务器，我们可以在文章的结尾验证Docker映像已经构建并正确运行。</p><h2 id="33fa" class="le lf it bd lg lh li dn lj lk ll dp lm kb ln lo lp kf lq lr ls kj lt lu lv lw bi translated">为什么不能简单地使用Alpine作为运行时</h2><p id="1289" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">如果您以“正常”的方式构建Docker映像，那么在Alpine上运行Rust应用程序时会遇到错误，即使您的Docker构建成功了。</p><p id="cedb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它崩溃是因为Alpine上缺少特定的库，而许多Rust应用程序都需要运行这些库。为什么我说“很多”？因为看起来一个简单的“Hello World”程序似乎工作得很好，但是当你把板条箱<code class="fe mv mw mx my b">tokio</code>包含到你的应用程序中时，它就会崩溃。</p><p id="01b7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里的解决方案是<a class="ae mc" href="https://rust-lang.github.io/rustup/cross-compilation.html" rel="noopener ugc nofollow" target="_blank">交叉编译</a>。</p><p id="d57e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用交叉编译，我们可以告诉<code class="fe mv mw mx my b">cargo</code>用目标<code class="fe mv mw mx my b">x86_64-unknown-linux-musl</code>编译我们的应用程序，使我们的应用程序与Alpine一起工作。</p><h2 id="cbf3" class="le lf it bd lg lh li dn lj lk ll dp lm kb ln lo lp kf lq lr ls kj lt lu lv lw bi translated">文档文件</h2><p id="b30f" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">但是现在，让我们检查一下实际的docker文件，不要担心，我将在后面描述为什么我们应该包括其中的一些步骤。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="c8e6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在上面的Dockerfile文件中，您可以看到以下内容:</p><p id="16a5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在最开始，我们只将<code class="fe mv mw mx my b">Cargo.toml</code>和<code class="fe mv mw mx my b">Cargo.lock</code>复制到Docker映像。我们这样做是为了编译已经存在于Docker缓存层中的应用程序依赖项。因此，当只有应用程序发生变化，而依赖关系没有变化时，我们不必重新编译它们，因为它们没有发生任何变化。</p><p id="39cb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另外，您可以看到我们通过<code class="fe mv mw mx my b">rustup target add x86_64-unknown-linux-musl</code>添加了一个编译目标。这是稍后在<code class="fe mv mw mx my b">cargo build</code>命令中使用<code class="fe mv mw mx my b">--target x86_64-unknown-linux-musl</code>的先决条件。这就是交叉编译的魔力。我们没有使用默认目标，而是定义了另一个平台来构建应用程序。</p><p id="2bbd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">随后，我们将<code class="fe mv mw mx my b">src</code>文件夹中的实际源代码复制到Docker镜像中，并再次运行<code class="fe mv mw mx my b">cargo build</code>，我们的依赖项已经在上面构建了几行代码和新目标。</p><p id="fcbd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后但并非最不重要的一点是，必须提到您通常使用的构建应用程序的路径已经改变。因此，如果您已经有一个Dockerfile，并且只是用这里概述的步骤替换了构建步骤，那么当试图将创建的二进制文件从<code class="fe mv mw mx my b">builder</code>复制到<code class="fe mv mw mx my b">runtime</code>阶段时，由于路径改变，构建步骤将会中断。</p><p id="1429" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您运行<code class="fe mv mw mx my b">cargo build</code>命令而不运行修改后的<code class="fe mv mw mx my b">--target</code>命令，那么构建的二进制路径如下:</p><pre class="kp kq kr ks gt nb my nc nd aw ne bi"><span id="fea8" class="le lf it my b gy nf ng l nh ni">/usr/src/medium-rust-dockerize/target/release/medium-rust-dockerize</span></pre><p id="244b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">即使通过使用非默认的构建目标，路径也会变为:</p><pre class="kp kq kr ks gt nb my nc nd aw ne bi"><span id="d821" class="le lf it my b gy nf ng l nh ni">/usr/src/medium-rust-dockerize/target/x86_64-unknown-linux-musl/release/medium-rust-dockerize</span></pre><p id="9502" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以在<code class="fe mv mw mx my b">target</code>和<code class="fe mv mw mx my b">release</code>部分之间增加了一个额外的<code class="fe mv mw mx my b">x86_64-unknown-linux-musl</code>。</p><h2 id="4cf4" class="le lf it bd lg lh li dn lj lk ll dp lm kb ln lo lp kf lq lr ls kj lt lu lv lw bi translated">验证docker文件是否有效</h2><p id="2854" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">我建议你克隆我的<a class="ae mc" href="https://github.com/mr-pascal/medium-rust-dockerize" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>来验证一切都工作正常。</p><p id="2454" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">克隆完成后，您可以运行以下命令来验证Docker映像是否成功创建，以及容器是否能够顺利启动应用程序。</p><pre class="kp kq kr ks gt nb my nc nd aw ne bi"><span id="5478" class="le lf it my b gy nf ng l nh ni"># Build the Docker image<br/>docker build -t rust-web-alpine .</span><span id="0711" class="le lf it my b gy nj ng l nh ni"># Run the Docker container<br/>docker run --rm -p 3030:3030 --name server rust-web-alpine</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nk"><img src="../Images/622b6149da00b2790817448fd3005a56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ubHVXeKN3G4a5gt3KWf2sA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">(缓存的)Docker版本</figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nl"><img src="../Images/eb5a52dfc7f3d49c24207dd0bb06ff74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L0bYx_BucAXyM6YxlhaHTw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">启动容器</figcaption></figure><p id="9143" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">容器成功启动后，您可以通过到达<code class="fe mv mw mx my b">localhost:3030/hello/&lt;someString&gt;</code>来检查它是否在工作，如下图所示。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nm"><img src="../Images/7467c9ac09393b88ab398b7c9dbf89e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8EaI7t3d77ksV8Hn34Ft9Q.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">chrome:localhost:3030/hello/Pascal</figcaption></figure><p id="b2db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后但同样重要的是，让我们使用<code class="fe mv mw mx my b">docker images</code>命令检查创建的Docker图像的大小。</p><p id="a7a4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如下图所示，Rust web服务器只有<strong class="js iu"> 12.6MB的图像大小。</strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nn"><img src="../Images/3a506ccd9038f19bbf58dd90c3d9affb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NcqBnQSR7evej66PIHxTJQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">docker图像</figcaption></figure><h2 id="ed61" class="le lf it bd lg lh li dn lj lk ll dp lm kb ln lo lp kf lq lr ls kj lt lu lv lw bi translated">你想联系吗？</h2><p id="6350" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">如果你想联系我，请在LinkedIn上给我打电话。</p><p id="c598" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，请随意查看我的书籍推荐📚。</p></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><div class="kp kq kr ks gt mg"><a href="https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b" rel="noopener follow" target="_blank"><div class="mh ab fo"><div class="mi ab mj cl cj mk"><h2 class="bd iu gy z fp ml fr fs mm fu fw is bi translated">我的书籍推荐</h2><div class="mn l"><h3 class="bd b gy z fp ml fr fs mm fu fw dk translated">在接下来的章节中，你可以找到我对所有日常生活话题的书籍推荐，它们对我帮助很大。</h3></div><div class="mo l"><p class="bd b dl z fp ml fr fs mm fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="mp l"><div class="nv l mr ms mt mp mu ky mg"/></div></div></a></div><div class="md me gp gr mf mg"><a href="https://mr-pascal.medium.com/membership" rel="noopener follow" target="_blank"><div class="mh ab fo"><div class="mi ab mj cl cj mk"><h2 class="bd iu gy z fp ml fr fs mm fu fw is bi translated">通过我的推荐链接加入Medium—Pascal Zwikirsch</h2><div class="mn l"><h3 class="bd b gy z fp ml fr fs mm fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="mo l"><p class="bd b dl z fp ml fr fs mm fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="mp l"><div class="nw l mr ms mt mp mu ky mg"/></div></div></a></div></div></div>    
</body>
</html>