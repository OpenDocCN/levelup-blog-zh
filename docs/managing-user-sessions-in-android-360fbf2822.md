# 在 Android 中管理用户会话

> 原文：<https://levelup.gitconnected.com/managing-user-sessions-in-android-360fbf2822>

我最终不得不建造我的图书馆

![](img/2e4e474305901145df5758124016e127.png)

在过去的 3 个月里，我一直在并行开发 3 个 Android 应用程序。我不得不承认，这确实让你付出了代价。然而，你也开始认识到模式和冗余。其中一个模式是关于用户会话管理的。

让我们先简单了解一下什么是会话管理，而不要过多涉及技术细节。通常，术语会话管理是指只要某些条件成立，就保持某些系统值或状态的过程。我们希望维护的常见状态的一个例子是那些经过身份验证的用户身份。

Android 提供了几种方法来实现这一点，但一种常见的方法是使用 SharedPreferences，它提供了一种以键-值对的形式存储和检索原始数据类型的简化方法。还有像 AccountManagers 这样的其他方法，但是说实话，如果您正在开发一个简单的应用程序，这种方法就有点过头了。

## 那么，在一次典型的会议中，具体包括哪些内容呢？

当用户输入有效的凭据(*电话号码和 OTP 组合、用户名/电子邮件和密码组合等*)时，典型的流程大致如下:

*   凭证由服务器验证
*   服务器发送回响应
*   该响应包含访问令牌、刷新令牌和到期时间(通常以秒为单位)

一旦您收到这个响应，维护一个会话将类似于:

*   存储令牌、访问令牌和到期时间
*   通过添加用户登录时间和令牌到期时间来跟踪实际到期日期
*   当用户回到应用程序时，根据他们回来的时间和令牌应该过期的时间，检查令牌是否过期
*   如果令牌过期，则使用刷新令牌调用服务器以获取新的访问令牌
*   替换访问令牌、刷新令牌和到期时间
*   重复

对于一个应用程序来说，这很好。构建一个简单的效用函数来完成所有这些，瞧，你就完成了。然而，请注意，当使用多个独立的应用程序时，这变得多么多余？

![](img/185fcb3aad9c888c96b8c6ffb4a0b6a7.png)

我寻找一个现有的库，它能做我想让它做的事情。我发现了几个，虽然它们没有被维护，而且似乎被废弃了。

本着 DRY 原则的精神，我决定将这个实用函数打包成一个类，并将其导出为一个库。

## 它是做什么的？

这个库抽象了我们刚刚提到的内容，剩下的只是对各种方法的简单调用。

让我们看看我们的出发点。我首先决定使用单例模式。我这样做是为了确保一个全局访问点和一个我想要使用的对象实例。幸运的是，科特林让这变得超级简单

我们将使用的单例对象

下一步是为我们需要的方法定义存根

在非常基本的层面上，我们希望:

*   开始会话
*   检查当前会话是否处于活动状态
*   如果需要，结束会话

## 1.启动用户会话

如上所述，一旦我们从服务器检索到带有访问令牌、刷新令牌和到期时间的响应，用户会话就会开始。因此，要启动用户会话，我们需要:

*   存储访问令牌
*   存储到期时间=用户登录时间+令牌到期时间

我们将使用共享的引用。因此，我们也需要上下文。

让我们重构启动会话的方法来反映这一点:

## 2.检查会话是否处于活动状态

下一步是我们更新方法来检查当前会话是否仍然是活动的或者应该结束。

为了让我们检查当前会话是否是活动的，我们需要知道它是在什么时间被检查的。这就是我们称为“当前时间”的论点

## 3.结束会话

最后，我们需要结束会话。这包括从 SharedPreference 中清除所有数据。

## 使用图书馆的一个例子

使用活动上的库来启动会话并检查当前会话的示例如下:

## 结论

我很想听听你们是如何处理会议的。我将致力于重构这个库，这样您只需启动一次会话，并且检查会话是否处于活动状态是作为后台任务来完成的，这样就不需要一直调用方法来检查会话。

建议也非常感谢

这个库可以在 GitHub 上找到—[https://github.com/HenryKenya/session-manager-android](https://github.com/HenryKenya/session-manager-android)

![](img/b4030e5e0890aad40c500ef3e32a3a39.png)