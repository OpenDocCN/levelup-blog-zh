<html>
<head>
<title>Step by Step slow guide — Kubernetes Cluster on Raspberry Pi 4B — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">循序渐进指南—树莓Pi 4B上的Kubernetes集群—第2部分</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/step-by-step-slow-guide-kubernetes-cluster-on-raspberry-pi-4b-part-2-e1f2ee8f3011?source=collection_archive---------6-----------------------#2020-01-11">https://levelup.gitconnected.com/step-by-step-slow-guide-kubernetes-cluster-on-raspberry-pi-4b-part-2-e1f2ee8f3011?source=collection_archive---------6-----------------------#2020-01-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/e60a774ddbd1f9a7dea978fd6abaf15a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mVzICHn68XKHdaYM"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">约瑟夫·巴里恩托斯在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="9bbd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在前一部分中，我们准备好了主节点和工作节点。有了这些，我们可以继续将containerd运行时和Kubernetes安装到我们的Raspberry Pi集群中。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="0ff2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们不会处理Ansible之类的，因为我们没有太多的节点，做就是学习。因此，我们将打开几个终端窗口，并通过ssh进入所有节点。首先，让我们确保所有内容都是最新的，并在所有节点上运行:</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="0adf" class="lu lv it lq b gy lw lx l ly lz">sudo apt update<br/>sudo apt upgrade<br/>sudo apt dist-upgrade</span></pre><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ma"><img src="../Images/e75cd9542032f82ae5ed8f5d57e46011.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S3mz9nClDDlBJ5gHV2Gqow.png"/></div></div></figure><p id="96bb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了让Kubernetes工作，我们需要禁用swap。幸运的是，默认情况下，这个映像上的交换是禁用的，所以我们不需要在那里做任何事情。</p><p id="d1f0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要设置用于Kubernetes所需的资源监控和隔离的Linux控制组。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="8ffd" class="lu lv it lq b gy lw lx l ly lz">sudo nano /boot/firmware/cmdline.txt</span></pre><p id="042d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并将下面一行添加到该行的末尾</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="1d23" class="lu lv it lq b gy lw lx l ly lz">cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory</span></pre><p id="32e1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们可以重新启动我们的节点</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="01e8" class="lu lv it lq b gy lw lx l ly lz">sudo reboot</span></pre><p id="0d90" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要向所有节点添加Kubernetes存储库</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="8fef" class="lu lv it lq b gy lw lx l ly lz">sudo apt-get install apt-transport-https<br/>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -<br/>echo "deb https://apt.kubernetes.io/ kubernetes-<!-- -->xenial<!-- --> main" | sudo tee -a /etc/apt/sources.list.d/kubernetes.list</span></pre><p id="6b9e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们将更新repo并在所有节点上安装kubeadm</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="b371" class="lu lv it lq b gy lw lx l ly lz">sudo apt-get update<br/>sudo apt-get install kubeadm</span></pre><p id="6bc7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于容器运行时，我们将使用containerd，它在CPU、内存和启动时间方面应该比Docker更高效。这似乎也是像GKE和AWS这样的云提供商正在使用的。我们将使用Kubernetes文档中稍加修改的步骤，您可以在这里找到<a class="ae kf" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="d6b1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们将处理所有节点上的先决条件:</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="cd5d" class="lu lv it lq b gy lw lx l ly lz">echo 'overlay<br/>br_netfilter' | sudo tee -a /etc/modules-load.d/containerd.conf<br/>sudo modprobe overlay<br/>sudo modprobe br_netfilter<br/>echo 'net.bridge.bridge-nf-call-iptables  = 1<br/>net.ipv4.ip_forward                 = 1<br/>net.bridge.bridge-nf-call-ip6tables = 1' | sudo tee -a /etc/sysctl.d/99-kubernetes-cri.conf<br/>sudo sysctl --system</span></pre><p id="0121" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们可以添加存储库并将containerd安装到所有节点上</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="8236" class="lu lv it lq b gy lw lx l ly lz"><em class="mb"># Install containerd</em><br/><em class="mb">## Set up the repository</em><br/><em class="mb">### Install packages to allow apt to use a repository over HTTPS</em><br/>sudo apt-get install \<br/>    apt-transport-https \<br/>    ca-certificates \<br/>    curl \<br/>    gnupg-agent \<br/>    software-properties-common<br/><br/><em class="mb">### Add Docker’s official GPG key</em><br/>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -<br/><br/><em class="mb">### Add Docker apt repository.</em><br/>sudo add-apt-repository \<br/>   "deb https://download.docker.com/linux/ubuntu \<br/>   focal \<br/>   stable"</span><span id="0aab" class="lu lv it lq b gy mc lx l ly lz"><em class="mb">## Install containerd</em><br/>sudo apt-get update<br/>sudo apt-get install containerd.io<br/><br/><em class="mb"># Configure containerd</em><br/>sudo containerd config default | sudo tee /etc/containerd/config.toml<br/><br/><em class="mb"># Restart containerd</em><br/>sudo systemctl restart containerd</span></pre><p id="ee17" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们需要配置kubelet代理来使用containerd，所以让我们编辑</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="0c10" class="lu lv it lq b gy lw lx l ly lz">sudo nano /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></pre><p id="9dc2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并在其他环境设置下添加下面一行</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="1741" class="lu lv it lq b gy lw lx l ly lz">Environment="KUBELET_EXTRA_ARGS=--cgroup-driver=systemd --container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock"</span></pre><p id="012b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">重载和重启守护进程是我们接下来要做的</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="2983" class="lu lv it lq b gy lw lx l ly lz">sudo systemctl daemon-reload<br/>sudo systemctl restart kubelet.service</span></pre><p id="3c53" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将为crictl配置端点，它基本上可以用来代替docker与容器进行交互</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="8e0e" class="lu lv it lq b gy lw lx l ly lz">sudo nano /etc/crictl.yaml</span></pre><p id="6c9a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">加上这一行</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="1c14" class="lu lv it lq b gy lw lx l ly lz">runtime-endpoint: unix:///run/containerd/containerd.sock</span></pre><p id="bf94" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们将预取kubernetes系统映像并初始化我们的主节点</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="5925" class="lu lv it lq b gy lw lx l ly lz">sudo kubeadm config images pull<br/>sudo kubeadm init --cri-socket /run/containerd/containerd.sock</span></pre><p id="0ad5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们为我们的用户配置kubectl</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="9381" class="lu lv it lq b gy lw lx l ly lz">mkdir -p $HOME/.kube<br/>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br/>sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></pre><p id="30c0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，init命令的打印输出将包含将节点加入集群所需的密钥。您应该在所有工作节点上运行该命令。例如</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="d99e" class="lu lv it lq b gy lw lx l ly lz"># DO NOT COPY THIS COMMAND. USE ONE YOU GOT AS RESULT IN INIT<br/>sudo kubeadm join 192.168.1.80:6443 --token o92ntx.6lkn88kb3m7f7     --discovery-token-ca-cert-hash sha256:1dee61cf705803f6284573a987e82654e639b3948b6cab7ffdb793b762</span></pre><p id="feb8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在可以从主节点检查我们的集群</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="f34e" class="lu lv it lq b gy lw lx l ly lz">sudo kubectl get nodes</span></pre><p id="80ae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你应该能看到这样的东西:</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi md"><img src="../Images/81ee688d9f63ce83b06f4c78c5659cc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jxmwzGY1_zJZHKR6xKUEJw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Kubernetes集群中的节点</figcaption></figure></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="db3f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">暂时就这样了。请注意，节点被标记为未运行，这是因为它们之间还没有联网。这就是我们下一部分要做事情。</p><div class="me mf gp gr mg mh"><a href="https://medium.com/@astrujic/step-by-step-slow-guide-kubernetes-cluster-on-raspberry-pi-4b-part-3-899fc270600e" rel="noopener follow" target="_blank"><div class="mi ab fo"><div class="mj ab mk cl cj ml"><h2 class="bd iu gy z fp mm fr fs mn fu fw is bi translated">循序渐进指南—树莓Pi 4B上的Kubernetes集群—第3部分</h2><div class="mo l"><h3 class="bd b gy z fp mm fr fs mn fu fw dk translated">在之前的par中，我们初始化了主节点并添加了工作节点。现在我们需要添加网络——印花布和负载…</h3></div><div class="mp l"><p class="bd b dl z fp mm fr fs mn fu fw dk translated">medium.com</p></div></div><div class="mq l"><div class="mr l ms mt mu mq mv jz mh"/></div></div></a></div><div class="me mf gp gr mg mh"><a href="https://medium.com/@astrujic/step-by-step-slow-guide-kubernetes-cluster-on-raspberry-pi-4b-part-1-6e4179c89cbc" rel="noopener follow" target="_blank"><div class="mi ab fo"><div class="mj ab mk cl cj ml"><h2 class="bd iu gy z fp mm fr fs mn fu fw is bi translated">循序渐进指南—树莓Pi 4B上的Kubernetes集群—第1部分</h2><div class="mo l"><h3 class="bd b gy z fp mm fr fs mn fu fw dk translated">基于RaspberryPi 4B、Containerd、Project Calico、MetalLB和Ubuntu Server的Kubernetes集群</h3></div><div class="mp l"><p class="bd b dl z fp mm fr fs mn fu fw dk translated">medium.com</p></div></div><div class="mq l"><div class="mw l ms mt mu mq mv jz mh"/></div></div></a></div></div></div>    
</body>
</html>