<html>
<head>
<title>Github Actions: Matrix Releases</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Github动作:矩阵发布</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/github-actions-matrix-releases-80d3210587a8?source=collection_archive---------5-----------------------#2020-11-21">https://levelup.gitconnected.com/github-actions-matrix-releases-80d3210587a8?source=collection_archive---------5-----------------------#2020-11-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/5bc125a85291557019856deac87e78dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WDyNUdfpZPK4rN4g"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">马库斯·斯皮斯克在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="7c81" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最近，我参与的一个软件项目要求发布多个平台的版本。下面是我如何使用Github Action的<em class="le">矩阵策略实现它的。</em></p><h2 id="0dde" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">TLDR</h2><p id="11f1" class="pw-post-body-paragraph kg kh it ki b kj ly kl km kn lz kp kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">这里可以只看代码<a class="ae kf" href="https://github.com/nwillc/syncher/blob/master/.github/workflows/RELEASE.yaml" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="b0d9" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">放</h2><p id="87ba" class="pw-post-body-paragraph kg kh it ki b kj ly kl km kn lz kp kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">我开始了一个只有一个目标平台的项目。我从未在Github中使用工件实现过<em class="le">发布</em>过程，但是自从我最近在我的CI/CD中使用Github Actions后，我就在寻找解决方案。我找到了<a class="ae kf" href="https://github.com/actions/create-release" rel="noopener ugc nofollow" target="_blank"> actions/create-release </a>，它让我用大约一页的YAML对一个版本标签做了如下推送:</p><ul class=""><li id="2ea3" class="md me it ki b kj kk kn ko kr mf kv mg kz mh ld mi mj mk ml bi translated">创建二进制工件</li><li id="f524" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">创建一个版本</li><li id="c939" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">将二进制文件添加到版本中</li></ul><p id="c3e0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它实现简单，运行完美，我所要做的就是标记我的代码来启动它。</p><h2 id="233d" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">然后…</h2><p id="ba17" class="pw-post-body-paragraph kg kh it ki b kj ly kl km kn lz kp kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">我需要发布第二个目标平台。没问题，我修改了YAML如下:</p><ul class=""><li id="e3a9" class="md me it ki b kj kk kn ko kr mf kv mg kz mh ld mi mj mk ml bi translated">为平台A创建二进制工件</li><li id="7d3c" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">为平台B创建二进制工件</li><li id="1b9b" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">创建一个版本</li><li id="3911" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">将二进制文件A添加到版本中</li><li id="2ee3" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">将二进制文件B添加到发行版中</li></ul><p id="6fab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你能看到事情的发展，对吗？当我需要添加第三个目标平台时，我再次剪切和粘贴东西，让它工作，然后开始重构它。</p><h2 id="24af" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">进入矩阵</h2><p id="c74b" class="pw-post-body-paragraph kg kh it ki b kj ly kl km kn lz kp kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">我查看了动作步骤中的循环，但却发现了<a class="ae kf" href="https://docs.github.com/en/free-pro-team@latest/actions/reference/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix" rel="noopener ugc nofollow" target="_blank">矩阵策略</a>，它允许<em class="le">一个作业</em>运行<em class="le">多个配置。</em>于是，我将我的单一工作分解为三项:</p><ul class=""><li id="624a" class="md me it ki b kj kk kn ko kr mf kv mg kz mh ld mi mj mk ml bi translated">工作1:使用矩阵策略构建所有目标平台<em class="le">工件</em></li><li id="12c4" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">工作2:创建一个<em class="le">版本</em></li><li id="7df6" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">工作3:使用矩阵策略将所有工件添加到发布中</li></ul><p id="c52b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我不打算给出最终YAML的详细演示，这会有点多，但你可以在这里看到它。让我们只看结构:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="349c" class="lf lg it mw b gy na nb l nc nd">jobs:</span><span id="8728" class="lf lg it mw b gy ne nb l nc nd">  # Job 1<br/>  artifacts:<br/>    strategy:<br/>      matrix:<br/>        target: [ <br/>            { 'os': 'darwin', 'arch': 'amd64' }, <br/>            { 'os': 'linux', 'arch': 'amd64' }, <br/>            { 'os': 'linux', 'arch': '386' } <br/>          ]</span><span id="2acb" class="lf lg it mw b gy ne nb l nc nd">    steps:  <br/>    - name: Create Artifact</span><span id="1883" class="lf lg it mw b gy ne nb l nc nd">  # Job 2<br/>  release:<br/>    runs-on: ubuntu-latest<br/>    needs: artifacts<br/> <br/>    steps:<br/>    - name: Create Release</span><span id="a60b" class="lf lg it mw b gy ne nb l nc nd">  # Job 3<br/>  add:<br/>    needs: [ artifacts, release ]<br/>    strategy:<br/>      matrix:<br/>        target: [ <br/>            { 'os': 'darwin', 'arch': 'amd64' }, <br/>            { 'os': 'linux', 'arch': 'amd64' }, <br/>            { 'os': 'linux', 'arch': '386' } <br/>          ]</span><span id="9466" class="lf lg it mw b gy ne nb l nc nd">    steps:<br/>    - name: Upload to release<br/>     </span></pre><p id="e3dd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有了这个结构，我们有三个任务，两个用<em class="le">矩阵策略</em>运行，所以它们将为所有的<em class="le">目标</em>并行运行，中间有一个发布任务。</p><h2 id="42b4" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">挑战</h2><p id="7b78" class="pw-post-body-paragraph kg kh it ki b kj ly kl km kn lz kp kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">这种结构确实带来了一些挑战:</p><ul class=""><li id="7e70" class="md me it ki b kj kk kn ko kr mf kv mg kz mh ld mi mj mk ml bi translated">首先，在个作业之间共享工件<em class="le">。有具体的行动。你需要在一个任务中<em class="le">上传工件</em>，然后在另一个任务中<em class="le">下载工件</em>。</em></li><li id="cda2" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">第二，<em class="le">释放</em>作业创建一个<em class="le">添加</em>作业所需的url。Actions为此提供了一个<em class="le">输出</em>机制。您在<em class="le">发布</em>中捕获输出，并在<em class="le">添加中通过名称引用它。</em></li></ul><p id="df5a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有了这些解决方案，我成功地做了我想做的事情。</p><p id="0681" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">进展如何？</strong></p><ul class=""><li id="649c" class="md me it ki b kj kk kn ko kr mf kv mg kz mh ld mi mj mk ml bi translated"><strong class="ki iu">优点</strong>:我移除了剪切&amp;粘贴，现在添加新目标只是更新目标列表的问题。现在可以并行执行的是，请注意，这是一个后台进程，所以我不会等待它。</li><li id="7855" class="md me it ki b kj mm kn mn kr mo kv mp kz mq ld mi mj mk ml bi translated">缺点:作业之间共享文件和值会产生开销。最终的YAML比以前更好，但不像我希望的那么简单。</li></ul></div></div>    
</body>
</html>