# 反向代理和客户端连接

> 原文：<https://levelup.gitconnected.com/linux-kernel-tuning-for-high-performance-networking-f3256ffecf98>

## 高性能网络系列的 Linux 内核调优

![](img/cb7613924f1213955e9f6a31a8c91dec.png)

肖恩·林在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

# 短暂的港口

当客户端连接到服务器时，使用临时端口。当操作上游工作线程的反向代理时，连接到工作线程的代理服务创建客户端套接字，上游工作线程创建服务器端套接字。当反向代理需要同时建立多个上行连接时，当上行连接的数量超过反向代理主机上的临时端口范围时，会出现 ***临时端口耗尽*** 。在这种情况下，可以增加临时端口范围，使更多的套接字可用于代理服务器，从而允许更多的连接。

检测短暂的端口耗尽依赖于建立客户端连接的软件，但通常在应用程序的错误日志中会提到上游或代理“没有可用的客户端端口”错误。另一个症状是大量连接处于 TIME_WAIT 状态。当然，只需对照总数检查客户端连接的数量，就能确定已经达到了短暂的端口限制。

使用中的临时端口的数量可以通过 bash 作为 root 来检查，可能需要为您的系统修改脚本:

如果可用端口数量很少，请考虑增加端口范围。

**临时端口范围** IANA 客户端连接的建议临时端口范围是端口 49152–65535。端口 1024–49151 被 IANA 视为半保留端口，因为应用程序开发人员可以为他们的应用程序注册一个端口，但只有当这些注册的服务之一在服务器上运行并侦听注册的端口时，才需要关注这些端口。

默认情况下，许多 linux 内核中的网络堆栈默认使用端口 32768–61000 来维护服务器端的通信会话。这仅允许最多 28，232 个 TCP 连接。为了增加临时端口的数量并允许更多的代理连接，应该扩大该端口范围，以处理反向代理中配置的代理连接的数量。

系统端口号应排除在此范围之外，因此所选的最低端口应不低于 1024，但也必须高于系统上任何已配置的侦听器所使用的最高端口，以避免端口冲突。例如，如果有一个服务正在侦听端口 9990 上的连接，最低的临时端口应该是 9991 或更高。对于具有环境端口方案的系统，选择方案中最高端口以上的端口。

虽然 web 服务器倾向于在端口 80 和 443 上运行，但是修改侦听器以使用非标准端口的主要原因是为了允许服务作为非根服务帐户被轻松控制。在这种情况下，web 服务器应该位于能够将流量路由到非标准端口的负载平衡器之后。许多服务使用 1024 和 9999 范围内的侦听器就能很好地运行，因此排除这个范围可以灵活地在系统上配置服务侦听器，同时仍然可以将上游连接可用的临时端口数量增加近一倍。虽然不是唯一的好处，但开放 8976 个端口的侦听器端口范围也为制定端口方案标准创造了选择，以帮助管理由开发、测试、用户验收、试运行和生产环境组成的企业环境。

**示例** Nginx 在端口 6180/6143 监听生产流量，在端口 9443 监听 nginx API 流量，并且是几个后端服务的反向代理。
因此，最低的短命端口应该是 9444 或以上；然而，为了避免试图维护部落知识转移所导致的问题，10000 将是一个好的选择，因为它在最常见的侦听器端口之外，并且提供了一个易于记住并与团队共享的标准:“不要在 10000 以上的侦听器端口上配置任何服务。”

00-IP-本地-端口-范围. conf

# 最大分段寿命

许多反向代理服务器可以在负载下看到“TIME_WAIT”中连接数的增加。这是打开/关闭许多客户端连接的结果，有几个设置来处理这个问题。

## 在 TIME_WAIT 中重用连接

如果通过将`***net.ipv4.tcp_tw_reuse***`设置为 1 来启用，内核可以重用处于“TIME_WAIT”状态的连接，因此如果系统经历了大量的“TIME_WAIT ”,这可能是在受影响的系统上测试的一个好设置。

在 linux 中，根据您的内核版本，MSL 被设置为以下内核设置之一。

*   net . net filter . nf _ conn track _ TCP _ time out _ time _ wait
*   net . IP v4 . net filter . IP _ conntrack _ TCP _ time out _ time _ wait