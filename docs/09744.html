<html>
<head>
<title>Running Airflow in Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker中的运行气流</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/running-airflow-in-docker-759068fb43b2?source=collection_archive---------6-----------------------#2021-09-09">https://levelup.gitconnected.com/running-airflow-in-docker-759068fb43b2?source=collection_archive---------6-----------------------#2021-09-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="cdcc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">对接你的气流的数据管道，以简化和加快部署，并允许兼容性</h2></div><p id="b7cb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">想象一下这样一个场景，您必须运行多个日常作业来从数据湖/数据库中提取数据，对它们进行预处理，并将清理后的数据集存储到专用存储中。如果我们必须每天运行管道，不断检查可能的错误，这将是一项极其乏味的工作。这就是Airflow派上用场的地方:它为您提供了自动构建和监控多个数据管道的所有工具。然而，气流设置对新来者来说可能具有挑战性，因为它需要多层依赖关系。这就是码头工人T2出现的原因。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/0ea3281f1c8e1e920eb393183adaaa66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*x-2FDKK9gaw__zsN"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated"><a class="ae lu" href="https://unsplash.com/@guibolduc?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">纪尧姆·博尔达克</a>在<a class="ae lu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="b585" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇文章是我最近开始的与气流相关的系列文章的一部分:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="c7df" class="ma mb it lw b gy mc md l me mf">1. <a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/airflow-for-data-pipeline-101-7a42cc28cf3a">Airflow for Data Pipeline 101</a><br/>2. <a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/airflow-decorators-for-a-clean-data-pipeline-48ebdf12e9b0">Airflow: Decorators for a Clean Data Pipeline</a><br/>3. Airflow: Unit Tests for Bug-Free Pipeline<br/>4. Running Airflow in Docker (<em class="mg">THIS</em>)<br/>5. <em class="mg">TBD...</em></span></pre><p id="9307" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，我将带您了解如何在Docker中部署您的气流任务。Docker是一个容器化工具，允许您部署和维护您的数据管道，而不管底层操作系统或软件。它节省了安装必要的依赖项以启动和运行数据管道所需的时间。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="01c6" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">Table of Content:<br/></strong>1. Airflow recap<br/>2. Setting up Docker<br/>3. Setting up a simple task<br/>4. Running Airflow within Docker </span></pre><p id="fc5c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">事不宜迟，让我们直接进入主题吧！</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="07e2" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">气流概述</h1><p id="4023" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">在我们开始之前，请确保您的机器中的气流设置正确，并且您对气流的工作原理有一个基本的了解。本系列的第一篇文章<a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/airflow-for-data-pipeline-101-7a42cc28cf3a">将指导您完成安装和设置过程。</a></p><p id="46a9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正确设置后，您将能够查看Airflow web GUI，如下图所示。该页面将突出显示您的所有管道、它们的所有者、时间表以及用于监控系统健康状况的相关诊断。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nk"><img src="../Images/53dddb9a7468b32eaebf5b32b17eec57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e5_BQ10jLCcGxxyWv0pOaQ.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">气流网络用户界面(图片由作者提供)</figcaption></figure></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="9b69" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">设置Docker</h1><p id="23f8" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">这篇文章假设读者对Docker有一定程度的了解。如果你需要介绍，请关注这篇<a class="ae lu" href="http://www.marknagelberg.com/digging-into-data-science-tools-docker/" rel="noopener ugc nofollow" target="_blank">帖子</a>。</p><p id="6134" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们必须做的第一件事是通过在终端中键入以下命令来获取气流的Docker图像。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="7a89" class="ma mb it lw b gy mc md l me mf">docker pull puckel/docker-airflow</span></pre><p id="fcf3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">过一会儿你会看到下面的回应。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nl"><img src="../Images/7d9dee3ea7851ce049556d751292556c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lBQ_W3_WNw1PV7aexxX0kQ.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">Docker拉取结果(图片由作者提供)</figcaption></figure><p id="d145" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以在终端中输入<code class="fe nm nn no lw b">docker images</code>来查看docker图片列表。将显示包括气流在内的docker图像列表。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi np"><img src="../Images/4b746cdb5f4feffaf2bda89c87267e62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tUiVLUjtZEJ_kGdeir19Xw.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">Docker气流图像(作者提供)</figcaption></figure><p id="eed9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们可以使用下面的命令运行我们的dockerized Airflow。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="d93e" class="ma mb it lw b gy mc md l me mf">docker run -d -p 8080:8080 puckel/docker-airflow webserver</span></pre><p id="db68" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你访问<code class="fe nm nn no lw b">http://localhost:8080/admin</code>，你会看到一个气流图形用户界面。干得好！</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nq"><img src="../Images/28d6c3e6a530034c5082281fd15c8f86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rpzPnzPPMRUYZtsMSdUz8g.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">Dockerized Airflow GUI(图片由作者提供)</figcaption></figure></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="e84b" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">设置一个简单的任务</h1><p id="db51" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">回想一下在我们之前的帖子中，我们一直使用一个简单的DAG任务来打印出一串<code class="fe nm nn no lw b">hello world</code>如果你想逐行理解整个代码，请参考<a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/airflow-for-data-pipeline-101-7a42cc28cf3a">我之前的帖子</a>。为了简洁起见，下面提供了位于<code class="fe nm nn no lw b">~/airflow/dags</code>的整个Python脚本(通常)。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="d2d5" class="ma mb it lw b gy mc md l me mf">import datetime as dt<br/>from airflow import DAG<br/>from airflow.operators.bash_operator import BashOperator</span><span id="85e2" class="ma mb it lw b gy nr md l me mf">default_args = {<br/>    'owner': 'me',<br/>    'start_date': dt.datetime(2021, 9, 4)<br/>}</span><span id="9c05" class="ma mb it lw b gy nr md l me mf"># Define DAG<br/>with DAG('airflow_tutorial_v01', default_args) as dag:<br/>    print_hello = BashOperator(task_id='print_hello',<br/>        bash_command='echo hello')</span><span id="9d7e" class="ma mb it lw b gy nr md l me mf">    print_world = BashOperator(task_id='print_world',<br/>        bash_command='echo world')</span><span id="4ca2" class="ma mb it lw b gy nr md l me mf"># Construct DAG<br/>print_hello &gt;&gt; print_world</span></pre><p id="b6de" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在要做的最后一件事是允许我们的容器访问DAG任务列表。我们可以通过使用<code class="fe nm nn no lw b">-v</code>参数指出容器可以访问的目录路径来做到这一点。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="bb2e" class="ma mb it lw b gy mc md l me mf">docker run -d -p 8080:8080 -v /path/to/dags/on/your/local/machine/:/usr/local/airflow/dags puckel/docker-airflow webserver</span></pre><p id="6671" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，在我们的(默认)案例中，我们有:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="4f7b" class="ma mb it lw b gy mc md l me mf">docker run -d -p 8080:8080 -v /home/user/airflow/dags:/usr/local/airflow/dags  puckel/docker-airflow webserver</span></pre><p id="59e8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">注意:</strong>确保您已经终止了早期的容器实例，以防止端口号重叠。</p><ul class=""><li id="5ae6" class="ns nt it kk b kl km ko kp kr nu kv nv kz nw ld nx ny nz oa bi translated"><code class="fe nm nn no lw b">docker ps</code>获取集装箱id(例如<strong class="kk iu"> 61c4 </strong> 9cd161f8)</li><li id="d3b9" class="ns nt it kk b kl ob ko oc kr od kv oe kz of ld nx ny nz oa bi translated"><code class="fe nm nn no lw b">docker kill &lt;container_id&gt;</code>为简单起见，您可以使用前4位数字</li></ul><p id="335d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几分钟后，你可以刷新页面看到我们的<code class="fe nm nn no lw b">hello world</code>任务！</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nk"><img src="../Images/64dd7ff55d7b2680a21694f4946e1690.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bz8SSqNY9hmz54-6k00oHQ.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">将本地DAG安装到Docker(图片由作者提供)</figcaption></figure></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="f502" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">Docker内的运行气流</h1><p id="ef9f" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">我们想做的最后一件事是在Docker容器内部运行气流。</p><p id="8a3d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以这样做，首先通过终端输出中的<code class="fe nm nn no lw b">docker ps</code>标识我们的容器的名称，我的容器名为<code class="fe nm nn no lw b">gifted_newton</code></p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi og"><img src="../Images/41c310184109c9023cb5067ddc2969da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wtgDCNsg6uj6RHogudVmlQ.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">查找我们的容器的名称(图片由作者提供)</figcaption></figure><p id="f4e7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们将在容器内部初始化一个bash终端。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="0465" class="ma mb it lw b gy mc md l me mf">docker exec -ti &lt;container name&gt; bash</span></pre><p id="c762" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，在我们的案例中，它将是:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="0ecc" class="ma mb it lw b gy mc md l me mf">docker exec -ti gifted_newton bash</span></pre><p id="906d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在你在你的集装箱的终端！您可以在终端中运行一个简单的测试命令，例如:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="56dc" class="ma mb it lw b gy mc md l me mf">airflow test airflow_tutorial_v01 print_hello 2021-09-04</span></pre><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oh"><img src="../Images/c4cb8a4b4fb71f21b9b0cb87d07fc9ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n4oS3s1uC0LR486Sz9P9xg.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">我们气流测试的输出(图片由作者提供)</figcaption></figure><h1 id="b68e" class="mo mb it bd mp mq oi ms mt mu oj mw mx jz ok ka mz kc ol kd nb kf om kg nd ne bi translated">结论</h1><p id="cf7c" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">就是这样！使用Docker运行气流给我们带来了几个好处，包括易于设置。它还为我们构建、编辑和部署我们的气流任务提供了一个清晰的界面。我正在下气流的兔子洞，敬请关注未来更多学习分享！</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><p id="fcb6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mg">如果你喜欢这篇文章，请考虑订阅我的</em> <a class="ae lu" href="https://tinyurl.com/2npw2fnz" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu"> <em class="mg">电子邮件简讯</em> </strong> </a> <em class="mg">在那里，我定期用简单的英语和漂亮的可视化语言总结编程技巧和人工智能研究论文。</em></p></div></div>    
</body>
</html>