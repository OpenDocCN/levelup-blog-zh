<html>
<head>
<title>Simulating Floating Point Division in Solidity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Solidity中模拟浮点除法</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/simulating-floating-point-division-in-solidity-35b56d2b597e?source=collection_archive---------2-----------------------#2022-03-17">https://levelup.gitconnected.com/simulating-floating-point-division-in-solidity-35b56d2b597e?source=collection_archive---------2-----------------------#2022-03-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c331" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">区块链开发教程04</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e4d72626baa5f76974956c1ce137b964.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RyDKVB_5OwklhmJGX2Nuzg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">无意义的封面图片。</figcaption></figure><p id="dd2b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">目前，我正在做一个NFT项目，它需要浮点除法来计算稀有度。经过一番研究，我了解到Solidity并不完全支持浮点数。然而，我还是完成了任务。在本教程中，我将分享我的方法。</p><h1 id="82ca" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">当前状态</h1><p id="a4d6" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">在Solidity中，定点数是浮点数的类型。然而，根据<a class="ae mo" href="https://docs.soliditylang.org/en/latest/types.html#fixed-point-numbers" rel="noopener ugc nofollow" target="_blank">官方文件</a>:</p><blockquote class="mp mq mr"><p id="5e52" class="kv kw ms kx b ky kz jr la lb lc ju ld mt lf lg lh mu lj lk ll mv ln lo lp lq ij bi translated">Solidity还不完全支持定点数。它们可以被声明，但不能被赋值给或从。</p></blockquote><p id="136b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">换句话说，没用。</p><h1 id="a24f" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">现有的解决方案</h1><p id="4d2b" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">很多人选择<a class="ae mo" href="https://github.com/abdk-consulting/abdk-libraries-solidity/blob/master/ABDKMath64x64.sol#L219" rel="noopener ugc nofollow" target="_blank"> ABDK Math 64.64库</a>。函数<code class="fe mw mx my mz b">divi()</code>处理浮点除法。它接受两个有符号的256位整数，并返回一个有符号的128位整数，模拟64.64位定点数。</p><h1 id="6ea4" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">我的解决方案</h1><p id="f8e8" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">经过一些研究，我想出了我的解决方案，这是代码。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="7291" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这个想法很简单。小数有整数部分和小数部分。就整体而言，该部门将完成这项工作。对于小数部分，该函数首先将分子缩放<code class="fe mw mx my mz b">10^n</code>倍，然后用分母除数，最后用缩放因子<code class="fe mw mx my mz b">10^n</code>取余数。</p><p id="cb2c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">此外，出于可读性和显示目的，还有一个返回为<code class="fe mw mx my mz b">result</code>的浮点字符串版本。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/9fcb1b295e466f73d9f1d0f6b16a5965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3JrI6DR1nQpdvTTy2KmIoA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图一。混音演示</figcaption></figure><p id="9ecf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我用Remix部署了这个契约来测试。如你所见，输入是<code class="fe mw mx my mz b">3, 10, 3</code>，这意味着我想将10除以3，并保留3个小数点。而结果是<code class="fe mw mx my mz b">3.333</code>。</p><h1 id="a61f" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">警告和更好的解决方案</h1><p id="cb0e" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">当我在写上面的部分时，我意识到有一个问题，<strong class="kx ir">舍入误差</strong>。我试着计算20除以3，会得到<code class="fe mw mx my mz b">6.666</code>，而预期的结果是<code class="fe mw mx my mz b">6.667</code>。</p><p id="4ac8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了解决舍入误差，我改进了像专家一样处理舍入误差的代码。请随意部署此合同并亲自试用:)</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="e8c8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你尝试过，你可能会发现这个问题。用两位小数计算34 / 33得出的结果是1.3，而正确的结果应该是1.03。问题是该函数将余数从百分之一位移到十分之一位，因为余数是个位数，而我们期望它是两位数。为了提高性能，这个函数应该在余数之前加上0，然后再组合成输出字符串。下面是解决方案。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="427e" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">离别赠言</h1><p id="1afc" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">你有它！我希望这篇教程对你有所帮助。如果您有任何问题或建议(例如，如何改进代码)，请随时留下评论。如果你想让我写其他关于区块链发展的话题，也请告诉我！</p><pre class="kg kh ki kj gt nd mz ne nf aw ng bi"><span id="4c1e" class="nh ls iq mz b gy ni nj l nk nl"><strong class="mz ir">Want to Connect?</strong>Please feel free to reach out (<a class="ae mo" href="https://www.linkedin.com/in/zhaosicong/" rel="noopener ugc nofollow" target="_blank">my LinkedIn</a>).</span></pre></div></div>    
</body>
</html>