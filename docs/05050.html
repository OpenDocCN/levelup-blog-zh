<html>
<head>
<title>Introduction to Rack middleware</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">机架中间件简介</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/introduction-to-rack-middleware-97d87474632d?source=collection_archive---------14-----------------------#2020-07-31">https://levelup.gitconnected.com/introduction-to-rack-middleware-97d87474632d?source=collection_archive---------14-----------------------#2020-07-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="cc65" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">什么是Rack，我们如何使用它？</p><p id="a4f9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ko translated">作为一名Rails开发人员，在软件开发的美丽旅程中，我经常对这个美丽框架的不同组成部分感到好奇。每当我有时间的时候，我都喜欢深入其中的一个主题，阅读它并试图理解它们，如何使用它们，并利用这些知识来开发更好的应用程序。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi kx"><img src="../Images/65b57cc0b5bf517bfafb781e66e1d805.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ob-qS8GW6cHdhj1RNsiBhQ.png"/></div></div></figure><p id="0e3f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Ruby on Rails的其中一个重要部分当然是Rack，它值得我们花时间去了解一下。在学习Rack的过程中，我发现了许多优秀的用法来提高我的技能，让我的生活更加轻松。</p></div><div class="ab cl lj lk hx ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="im in io ip iq"><h1 id="c03b" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated"><strong class="ak">什么是中间件？</strong></h1><p id="0482" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi ko translated"><span class="l kp kq kr bm ks kt ku kv kw di"> T </span>他的术语被大量使用，以至于很难准确定义它，而是在整个行业给它一些不同的定义。我们将主要关注web开发和中间件在Rails应用程序中的使用。</p><blockquote class="mt mu mv"><p id="2d28" class="jq jr mw js b jt ju jv jw jx jy jz ka mx kc kd ke my kg kh ki mz kk kl km kn im bi translated">中间件是一个(定义宽松的)术语，指的是使系统各部分能够通信和管理数据的任何软件或服务。它是处理组件和输入/输出之间的通信的软件，因此开发人员可以专注于他们的应用程序的特定目的。</p></blockquote><p id="6e48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在像Ruby on Rails这样的服务器端web应用程序框架中，这个术语通常用来指像Rack中间件这样的预构建组件或库，它们可以被添加到框架的请求/响应处理管道中，在该管道中，数据流经一系列任务或阶段。非常常见的例子是日志记录、身份验证和其他，这些往往是每个人在多个应用程序中都需要的助手，它们基本上拦截一个请求，对它做一些事情并传递它。</p></div><div class="ab cl lj lk hx ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="im in io ip iq"><h1 id="9284" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">什么是Rack？</h1><p id="258c" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi ko translated">ack为用Ruby开发web应用程序提供了一个最小的、模块化的、适应性强的接口。通过以尽可能简单的方式包装HTTP请求和响应，它将web服务器、web框架和它们之间的软件(所谓的中间件)的API统一和提取到一个方法调用中。</p><p id="ca81" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Rack应用程序的特点是应用程序对象响应调用方法。call方法接受环境对象作为参数，并返回Rack响应对象。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi na"><img src="../Images/dd2d6353e7fc3b67dc569a48adb504d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dY3J04qvnnWpjid0fkRr-A.png"/></div></div></figure><p id="08c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就其核心而言，理解Rack不仅仅是一个请求/响应过滤器是很重要的，它还有更多的功能，Rack是一个web服务器接口约定，是web服务器和用Ruby编程语言开发的web应用程序之间的模块化接口。</p><h2 id="e890" class="nb lr it bd ls nc nd dn lw ne nf dp ma kb ng nh me kf ni nj mi kj nk nl mm nm bi translated">简单的机架应用</h2><p id="63da" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">为了更好地理解，让我们来看看这个漂亮而简单的Rack应用程序，看看它的代码。</p><p id="536e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将使用WEBrick作为机架兼容的web服务器，但它们中的任何一个都可以。让我们创建一个返回JSON字符串的简单web应用程序。首先，我们需要在我们的目录中创建一个config.ru文件，在我们的配置文件中，我们将有以下代码:</p><pre class="ky kz la lb gt nn no np nq aw nr bi"><span id="0a0b" class="nb lr it no b gy ns nt l nu nv"><strong class="no iu">class Application<br/> def</strong> <strong class="no iu">call</strong>(env)<br/>    status  <strong class="no iu">=</strong> 200<br/>    headers <strong class="no iu">=</strong> { "Content-Type" <strong class="no iu">=&gt;</strong> "text/html" }<br/>    body    <strong class="no iu">=</strong> ["This is our small Rack app."]<br/><br/>    [status, headers, body]<br/>  <strong class="no iu">end</strong><br/><strong class="no iu">end</strong><br/><br/>run Application.<strong class="no iu">new</strong></span></pre><p id="c788" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Rack gem附带了一个名为rackup的小可执行程序(命令行程序),所以让我们运行它。</p><pre class="ky kz la lb gt nn no np nq aw nr bi"><span id="178d" class="nb lr it no b gy ns nt l nu nv">$ rackup<br/>[2015-05-15 18:37:42] INFO  WEBrick 1.3.1<br/>[2015-05-15 18:37:42] INFO  ruby 2.2.1 (2015-02-26) [x86_64-darwin14]<br/>[2015-05-15 18:37:42] INFO  WEBrick::HTTPServer#start: pid=17588 port=9292</span></pre><p id="de72" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们的web应用程序已经启动，我们可以将浏览器指向localhost:9292，我们应该会看到文本<code class="fe nw nx ny no b">This is our small Rack app.</code></p><p id="b2a4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，在Ruby on Rails中，Rack请求命中<code class="fe nw nx ny no b">ActionDispatch::Routing.Mapper</code>并依赖于env散列，如果任何路由匹配，它将env散列传递给应用程序以计算响应，否则它立即用404响应。</p></div><div class="ab cl lj lk hx ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="im in io ip iq"><h1 id="9da6" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">把宝石放在架子上</h1><p id="c039" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi ko translated">除了作为一个惯例，它还是一个众所周知的瑰宝，它提供了强大的功能。在我们前面提到的例子中，我们已经使用了Rack gem附带的rackup命令。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi nz"><img src="../Images/2588532cd59fbc66820f9236604e7318.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9tqQwmlNnO_Q_SgJxWfUJQ.jpeg"/></div></div></figure><p id="731f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在服务器和框架之间，可以使用中间件根据您的应用需求定制Rack。Rack本身附带了相当多的服务静态文件的中间件，设置默认的Content-Type头来响应删除请求期间创建的临时文件。所有<a class="ae oa" href="https://github.com/rack/rack" rel="noopener ugc nofollow" target="_blank">中间件</a>的详细列表请参见文档。</p></div><div class="ab cl lj lk hx ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="im in io ip iq"><h1 id="9854" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">社区</h1><p id="2004" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi ko translated">围绕Rack gem还有一个很棒的社区，它生产预构建的机架组件，帮助您处理诸如认证、授权、缓存、装饰等任务。如需完整列表，请访问关于<a class="ae oa" href="https://github.com/rack/rack/wiki/List-of-Middleware" rel="noopener ugc nofollow" target="_blank">机架中间件</a>的机架官方文档。</p><p id="43de" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，既然我们在这里，让我们来看几个例子。</p><h2 id="994d" class="nb lr it bd ls nc nd dn lw ne nf dp ma kb ng nh me kf ni nj mi kj nk nl mm nm bi translated">SEO优化</h2><p id="b8c9" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">SEO代表“搜索引擎优化”这是一种提高网站流量的质量和数量的做法，也是对你的品牌曝光率的一种做法，如今，在打造产品时，它得到了很多关注。</p><p id="def4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最近，我的工作伙伴接到了删除URL末尾的斜杠的任务，我们可以找到一个由其社区开发的rescue in Rack组件。</p><p id="d49f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Rack-rewrite 是用于定义和应用重写规则的Rack中间件，它非常容易使用，对于我们的目的来说，我们需要做的就是安装gem并在我们的应用程序中调用它。</p><pre class="ky kz la lb gt nn no np nq aw nr bi"><span id="fb8b" class="nb lr it no b gy ns nt l nu nv">config.middleware.insert_before(Rack::Runtime, Rack::Rewrite) do<br/> r301 %r{^/(.*)/$}, ‘/$1’<br/>end</span></pre><h2 id="3cfc" class="nb lr it bd ls nc nd dn lw ne nf dp ma kb ng nh me kf ni nj mi kj nk nl mm nm bi translated">证明</h2><p id="3cdb" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">从头开始进行身份验证可能会很困难，并且可能会导致不可预见的问题。这里我们可以从另一个Rack中间件<a class="ae oa" href="https://github.com/wardencommunity/warden" rel="noopener ugc nofollow" target="_blank"> Warden </a>得到很多帮助，Warden提供了一种在基于Rack的Ruby应用中进行认证的机制。它考虑到了在同一个机架实例中共享多个应用程序。</p><p id="a156" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">典狱长天生就是偷懒的。也就是说，如果您不使用它，它不会做任何事情，但当您使用它时，它会立即开始工作，并提供一种底层机制，允许在任何基于机架的应用程序中进行身份验证。</p></div><div class="ab cl lj lk hx ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="im in io ip iq"><h1 id="2c8d" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">结论</h1><p id="ebc8" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">当我开始写和读关于这个话题的文章时，我真的没有太在意这个问题，这很容易被认为是理所当然的，但它让我们的生活变得更加轻松。</p><p id="0490" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虽然我不是一个疯狂的科学家、大师或前辈，但我发现写关于Rails的主题，尤其是关于Rails框架的重要部分，是令人满意的。</p><p id="33f0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你会发现这篇文章很有趣，很有帮助。</p><h1 id="2a50" class="lq lr it bd ls lt ob lv lw lx oc lz ma mb od md me mf oe mh mi mj of ml mm mn bi translated">参考</h1><p id="0006" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated"><a class="ae oa" href="https://github.com/rack/rack" rel="noopener ugc nofollow" target="_blank"> <em class="mw">官方文档</em> </a></p><p id="99c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae oa" href="https://stackoverflow.com/questions/2256569/what-is-rack-middleware" rel="noopener ugc nofollow" target="_blank"> <em class="mw">这个超赞的StackOverflow线程</em> </a></p><p id="0a1f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae oa" href="https://webapps-for-beginners.rubymonstas.org/rack/hello_world.html" rel="noopener ugc nofollow" target="_blank">试管架上的Rubymonsters主题</a></p></div></div>    
</body>
</html>