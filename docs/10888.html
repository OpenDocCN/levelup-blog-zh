<html>
<head>
<title>Cloud Monitoring, We Need to Chat</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云监控，我们需要聊天</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/cloud-monitoring-we-need-to-chat-54c45b346a21?source=collection_archive---------8-----------------------#2022-01-20">https://levelup.gitconnected.com/cloud-monitoring-we-need-to-chat-54c45b346a21?source=collection_archive---------8-----------------------#2022-01-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/616fb327d9af1f6da2f48208c8d11212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*52cqGE4qZtdNMmmC"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">沃洛季米尔·赫里先科在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="56c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://cloud.google.com/monitoring" rel="noopener ugc nofollow" target="_blank">云监控</a>是跟踪运行在谷歌云平台上的工作负载的应用指标和错误的重要工具。除了其仪表板功能，它还允许您定义警报策略，以便在出现错误或指标高于阈值时自动通知您。</p><p id="48fb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">云监控支持不同的<a class="ae kc" href="https://cloud.google.com/monitoring/support/notification-options" rel="noopener ugc nofollow" target="_blank">通知渠道</a>，如电子邮件、短信或Slack，但奇怪的是，不是谷歌自己的聊天应用，它是谷歌工作区的一部分。我个人更喜欢在团队聊天中而不是通过电子邮件获得警报，这样团队可以更容易地协调解决事件。</p><p id="121b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">幸运的是，使用<a class="ae kc" href="https://cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">云功能</a>和<a class="ae kc" href="https://cloud.google.com/pubsub" rel="noopener ugc nofollow" target="_blank"> Pub/Sub </a>，我们几乎可以立刻构建与Google Chat的集成。设置如下:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/f036bfe45015f4b8bfe1584fad654d06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q0_JsytDj4PCUrSbh001Vw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">警报将发布到Pub/Sub，然后通过云功能转发到Google Chat</figcaption></figure><p id="26a5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们从配置Google Chat开始，回溯到云监控中的警报策略。</p><p id="3f3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们需要<a class="ae kc" href="https://developers.google.com/chat/how-tos/webhooks#setting_up_an_incoming_webhook" rel="noopener ugc nofollow" target="_blank">在Google聊天空间中创建一个webhook </a>来发布警报。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lg"><img src="../Images/bfddc52f157327f253b03fbb97dba36c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*enDqI9FGp2BWD6-Zcu1jxQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">创建一个网页挂钩，复制网址</figcaption></figure><p id="aa4e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们编写云函数，将监控警报转发到上一步中生成的webhook URL。我们不能在云监控中直接使用这个webhook作为通知渠道，而是需要一个云功能，因为Google Chat需要一个与云监控不同的消息有效负载结构。如<a class="ae kc" href="https://cloud.google.com/monitoring/support/notification-options#pubsub" rel="noopener ugc nofollow" target="_blank">文档</a>中所述，警报消息是以下形式的JSON:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lh"><img src="../Images/1069ab466a78f89dea2abe62e1a94d99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JlNbONvzrh7EFq3mz5qJUw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">来源:<a class="ae kc" href="https://cloud.google.com/monitoring/support/notification-options#pubsub" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/monitoring/support/notification-options # pubsub</a></figcaption></figure><p id="3471" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，Google Chat，<a class="ae kc" href="https://developers.google.com/chat/api/guides/message-formats/basic#basic_unformatted_messages" rel="noopener ugc nofollow" target="_blank">期望</a>有效载荷看起来像这样:<code class="fe li lj lk ll b">{"text": "Here goes the message content"}</code>。因此，我们为Google Chat定义了一个消息模板，其中包含感兴趣的警报参数的占位符(例如<code class="fe li lj lk ll b">incident[summary]</code>),并使用一个云函数将占位符替换为警报的实际值，并将生成的JSON转发给Google Chat。</p><p id="3f04" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们使用Python和fancier <a class="ae kc" href="https://developers.google.com/chat/api/guides/message-formats/cards" rel="noopener ugc nofollow" target="_blank">卡消息</a>格式，而不是基本的文本格式。它基本上只需要三行代码和消息模板(完整代码也在<a class="ae kc" href="https://github.com/jsarbach/cloud-monitoring-2-google-chat" rel="noopener ugc nofollow" target="_blank"> Github </a>上):</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="lm ln l"/></div></figure><p id="aa2a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，我们不是以字典的形式定义模板，并循环遍历所有嵌套层来替换占位符，而是将模板定义为JSON字符串，使用<code class="fe li lj lk ll b">format()</code>进行替换，然后将其解析到字典中。这是一行代码，而不是许多代码:</p><pre class="lc ld le lf gt lo ll lp lq aw lr bi"><span id="14c0" class="ls lt iq ll b gy lu lv l lw lx">message = json.loads(MESSAGE_TEMPLATE.format(**alert))</span></pre><p id="2614" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">应用<code class="fe li lj lk ll b">format()</code>时<a class="ae kc" href="https://docs.python.org/3/library/string.html#format-string-syntax" rel="noopener ugc nofollow" target="_blank">转义</a>需要用到模板串中的双花括号<code class="fe li lj lk ll b">{{...}}</code>。</p><p id="a981" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该部署了！</p><pre class="lc ld le lf gt lo ll lp lq aw lr bi"><span id="542f" class="ls lt iq ll b gy lu lv l lw lx">gcloud functions deploy monitoring-alerts --entry-point monitoring_alerts --region europe-west6 --runtime python39 <br/>--trigger-topic monitoring-alerts</span></pre><p id="071c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">发布/订阅主题<code class="fe li lj lk ll b">monitoring-alerts</code>是为我们自动创建的。因此，剩下要做的就是建立一个相应的发布/订阅通知通道，并在我们的<a class="ae kc" href="https://cloud.google.com/monitoring/alerts/using-alerting-ui" rel="noopener ugc nofollow" target="_blank">警报策略</a>中使用它。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ly"><img src="../Images/24372e402173e537cae9cb65edf7b161.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u7cL7ApWkpvCh561gJESAw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">为监控警报创建通知通道…</figcaption></figure><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/2ece0db8bfe140e2c36d1f540998e8a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/1*kJ78D4GSU9Hy1q3k9D_FdA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">…并在警报策略中使用它</figcaption></figure><p id="9fff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样。现在，享受谷歌聊天中显示的提醒信息吧(但别忘了关注它们)。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/957fdd59b41179827d49102ae96f3336.png" data-original-src="https://miro.medium.com/v2/resize:fit:838/format:webp/1*Dp7hsPGO3HisiQ5y0xWRtA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">哦，你好，你这个大错误</figcaption></figure></div></div>    
</body>
</html>