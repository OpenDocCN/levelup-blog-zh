<html>
<head>
<title>Set up Helm on your GKE cluster with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用地形在你的GKE集群上设置头盔</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/set-up-helm-on-your-gke-cluster-with-terraform-898f44faaaa5?source=collection_archive---------7-----------------------#2022-11-28">https://levelup.gitconnected.com/set-up-helm-on-your-gke-cluster-with-terraform-898f44faaaa5?source=collection_archive---------7-----------------------#2022-11-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="0de4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇简短的文章中，我将向您展示如何使用Terraform通过GKE在GCP上设置Kubernetes集群，并在没有任何手动干预的情况下使用Terraform应用您的舵图。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/edce2c556f8279c55af92c5956a11b68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*T9IZ-uodKgnni9oIkJaNgw.png"/></div></figure><p id="e317" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> GitHub库</strong></p><p id="4608" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您想一次看到所有代码，或者想以后再查看，我为您准备了一个小的存储库:</p><div class="kw kx gp gr ky kz"><a href="https://github.com/mr-pascal/medium-tf-gke-helm" rel="noopener  ugc nofollow" target="_blank"><div class="la ab fo"><div class="lb ab lc cl cj ld"><h2 class="bd iu gy z fp le fr fs lf fu fw is bi translated">GitHub-Mr-Pascal/medium-TF-gke-helm</h2><div class="lg l"><h3 class="bd b gy z fp le fr fs lf fu fw dk translated">出现此错误时:错误:试图加载应用程序默认凭据，因为凭据或…</h3></div><div class="lh l"><p class="bd b dl z fp le fr fs lf fu fw dk translated">github.com</p></div></div><div class="li l"><div class="lj l lk ll lm li ln ku kz"/></div></div></a></div><h1 id="27ce" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">为什么？</h1><p id="c15e" class="pw-post-body-paragraph jq jr it js b jt mm jv jw jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn im bi translated">通常情况下，您可以在通过Terraform或ClickOps设置集群后登录集群，并直接在其中应用舵图。</p><p id="22e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是除了您需要额外的访问和权限之外，对于大型企业公司来说，这可能不是一件好事。此外，如果您正在使用Terraform，您通常不希望登录到您创建的基础架构并进行一些手动强制更改，即使它只是应用一个舵图。</p><p id="42cb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，在本文中，您将看到如何在Kubernetes集群上应用舵图(我在这里选择了GCP)，但实际上，定义舵图资源的Terraform并不关心您的集群在哪里运行。</p><h1 id="2896" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">代码</h1><p id="9b18" class="pw-post-body-paragraph jq jr it js b jt mm jv jw jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn im bi translated">但是让我们来看看实际的代码。尽管我不会浏览所有的代码，只看必要的部分。如果您想查看整个设置，请查看公共存储库。</p><h2 id="18c5" class="mr lp it bd lq ms mt dn lu mu mv dp ly kb mw mx mc kf my mz mg kj na nb mk nc bi translated">GKE集群设置</h2><p id="06cb" class="pw-post-body-paragraph jq jr it js b jt mm jv jw jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn im bi translated">如果您没有在GCP上运行，而是想使用GKE，您可以跳过这一部分。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="d772" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">关于这段代码没有太多要说的，因为它主要取自<a class="ae nf" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_node_pool" rel="noopener ugc nofollow" target="_blank">官方terraform文档</a>。但是需要注意的是，默认的节点池被删除(“remove_default_node_pool=true”)，一个单独管理的节点池(“google_container_node_pool”资源)是根据提供者的建议创建的。</p><p id="40cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">名为“google_client_config”的数据资源是必不可少的，因为Helm provider将需要这个资源来获得一个连接到GKE集群的令牌。</p><h2 id="f756" class="mr lp it bd lq ms mt dn lu mu mv dp ly kb mw mx mc kf my mz mg kj na nb mk nc bi translated">舵设置</h2><p id="fb53" class="pw-post-body-paragraph jq jr it js b jt mm jv jw jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn im bi translated">将要应用的舵图可以在<a class="ae nf" href="https://github.com/mr-pascal/medium-tf-gke-helm/tree/main/helm" rel="noopener ugc nofollow" target="_blank">提到的库</a>的舵文件夹中找到。我不会详述这些文件，因为它们是不相关的，可能是你想应用的任意舵图。</p><p id="0b74" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下面的代码片段中，您可以找到Helm provider和Terraform资源初始化。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="6fb4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了知道在哪里应用helm图表以及如何连接到底层Kubernetes集群，必须使用集群的访问令牌(“令牌”)来初始化Helm提供程序，当然，还要知道可以到达集群的位置(“主机”)。还有其他方法来初始化它，但这是当前设置中最简单的一种。</p><p id="2a81" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您使用的是Terraform管理的GKE集群，您可以通过引用集群资源和google客户端配置来获取这些值(参见“GKE集群设置”一节)。</p><p id="6697" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">“helm_release”资源是代表您想要应用的掌舵图的资源。你必须引用本地文件路径到你的舵图，例如。/helm”来引用与此Terraform代码在同一层的“helm”文件夹。</p><p id="a7f8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您通过Terraform维护您的GKE集群(或任何其他云)，那么添加“依赖于”元参数是必不可少的。</p><p id="3cf6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">原因是Helm需要在访问集群之前知道集群何时准备好。如果“depends_on”不存在，并且群集将与Helm资源一起创建，那么它将失败，因为Helm将尝试访问尚未准备好的群集，因为它刚刚被创建。这就是为什么必须明确设置这些资源之间的依赖关系。</p><h2 id="d7bb" class="mr lp it bd lq ms mt dn lu mu mv dp ly kb mw mx mc kf my mz mg kj na nb mk nc bi translated">运行它</h2><p id="105f" class="pw-post-body-paragraph jq jr it js b jt mm jv jw jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn im bi translated">但是现在，让我们验证一下一切是否如预期的那样工作。为此，最好克隆<a class="ae nf" href="https://github.com/mr-pascal/medium-tf-gke-helm" rel="noopener ugc nofollow" target="_blank">存储库</a>，并在运行之前配置本地gcloud SDK(如果您使用GCP)。</p><p id="1d99" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于即将出现的shell命令，确保将“YOUR_PROJECT”替换为您的GCP项目。</p><p id="5a90" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，让我们通过以下方式交叉检查地形图:</p><pre class="kp kq kr ks gt ng nh ni bn nj nk bi"><span id="cbe0" class="nl lp it nh b be nm nn l no np">terraform plan -var “project=YOUR_PROJECT”</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi nq"><img src="../Images/f33434133305e0bbdf0bdd850d847349.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SBPa8rDwZdPAhNYl"/></div></div><figcaption class="nv nw gj gh gi nx ny bd b be z dk translated">地形图</figcaption></figure><p id="3ca4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">整个计划太长了，无法在这里发布，但是如果您在您的机器上运行它，请随意进一步检查它。</p><p id="12d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">总的来说，五个资源看起来不错，因为我们在“main.tf”文件中有上面提到的三个资源和两个API启用，您不必担心。</p><p id="006a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在让我们应用它:</p><pre class="kp kq kr ks gt ng nh ni bn nj nk bi"><span id="59dd" class="nl lp it nh b be nm nn l no np">terraform apply -var “project=YOUR_PROJECT”</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi nz"><img src="../Images/10a7db74d401163d28bbc6b719227754.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rpmI95glEfNsdA7k"/></div></div><figcaption class="nv nw gj gh gi nx ny bd b be z dk translated">地形应用</figcaption></figure><p id="05bb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如您在上面的图像中看到的，创建集群大约需要8分钟(但我也看到了长达15分钟的时间),另外还需要1.5分钟来设置节点池和应用Helm图表。因此，在使用集群时，要做好相当长时间等待的准备。</p><p id="67e5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">快速查看GCP控制台也可以验证集群是否正在运行</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi nq"><img src="../Images/4682415136732fb5e5d28bfba9dd7cef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7Q0z1T7IiGLVK3BG"/></div></div><figcaption class="nv nw gj gh gi nx ny bd b be z dk translated">GCP的库贝内特斯星团</figcaption></figure><p id="3180" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">掌舵图中定义的部署也正常运行:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi oa"><img src="../Images/78576cbcecd1db7ca8781a5bb492483c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y0kfNnBg6W-WOvL-"/></div></div><figcaption class="nv nw gj gh gi nx ny bd b be z dk translated">Kubernetes在GCP的工作量</figcaption></figure><h2 id="652c" class="mr lp it bd lq ms mt dn lu mu mv dp ly kb mw mx mc kf my mz mg kj na nb mk nc bi translated">清除</h2><p id="f198" class="pw-post-body-paragraph jq jr it js b jt mm jv jw jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn im bi translated">现在，如果您想再次清理集群和舵图，只需运行以下命令，但要准备好再等几分钟，直到集群关闭:</p><pre class="kp kq kr ks gt ng nh ni bn nj nk bi"><span id="472d" class="nl lp it nh b be nm nn l no np">terraform destroy -var "project=YOUR_PROJECT"</span></pre><h2 id="9c17" class="mr lp it bd lq ms mt dn lu mu mv dp ly kb mw mx mc kf my mz mg kj na nb mk nc bi translated">你想联系吗？</h2><p id="6350" class="pw-post-body-paragraph jq jr it js b jt mm jv jw jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn im bi translated">如果你想联系我，请通过<a class="ae nf" href="https://www.linkedin.com/in/pascal-zwikirsch-3a95a1177/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我。</p><p id="c598" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另外，可以随意查看<a class="ae nf" href="https://medium.com/@mr-pascal/my-book-recommendations-4b9f73bf961b" rel="noopener">我的书籍推荐</a>📚。</p></div><div class="ab cl ob oc hx od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="im in io ip iq"><div class="kp kq kr ks gt kz"><a href="https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b" rel="noopener follow" target="_blank"><div class="la ab fo"><div class="lb ab lc cl cj ld"><h2 class="bd iu gy z fp le fr fs lf fu fw is bi translated">我的书籍推荐</h2><div class="lg l"><h3 class="bd b gy z fp le fr fs lf fu fw dk translated">在接下来的章节中，你可以找到我对所有日常生活话题的书籍推荐，它们对我帮助很大。</h3></div><div class="lh l"><p class="bd b dl z fp le fr fs lf fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="li l"><div class="oi l lk ll lm li ln ku kz"/></div></div></a></div><div class="kw kx gp gr ky kz"><a href="https://mr-pascal.medium.com/membership" rel="noopener follow" target="_blank"><div class="la ab fo"><div class="lb ab lc cl cj ld"><h2 class="bd iu gy z fp le fr fs lf fu fw is bi translated">通过我的推荐链接加入Medium—Pascal Zwikirsch</h2><div class="lg l"><h3 class="bd b gy z fp le fr fs lf fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="lh l"><p class="bd b dl z fp le fr fs lf fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="li l"><div class="oj l lk ll lm li ln ku kz"/></div></div></a></div></div></div>    
</body>
</html>