<html>
<head>
<title>How To Create An EC2 Instance With Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Terraform创建EC2实例</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/devops-how-to-create-an-ec2-instance-with-terraform-a1f8285ee5f7?source=collection_archive---------1-----------------------#2022-03-22">https://levelup.gitconnected.com/devops-how-to-create-an-ec2-instance-with-terraform-a1f8285ee5f7?source=collection_archive---------1-----------------------#2022-03-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a195" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何使用Terraform在AWS上创建EC2实例的分步指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5e92f02d933bbf11de20f0473c78e4f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_o23gdMhMpspNEH-BvwDgA.png"/></div></div></figure><p id="8b05" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">除了我的另一篇文章<a class="ae lq" rel="noopener ugc nofollow" target="_blank" href="/devops-why-you-should-use-terraform-667f0411e383">为什么你应该使用Terraform </a>，我将向你展示如何开始使用Terraform。如果您没有阅读这篇文章，我建议您在继续阅读本文之前先阅读这篇文章。</p><p id="a850" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本指南中，我们将使用Terraform在AWS上启动一个EC2实例(Ubuntu Server 20.04 LTS)。此外，我们将设置一个VPC，通过Terraform自动创建一个密钥对，通过SSH连接到您的EC2实例，我们将在我们的服务器上安装NGINX。我们只是通过代码来实现这一切！听起来不错，对吧？</p><p id="94a8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你还没有安装Terraform，请按照官方的<a class="ae lq" href="https://learn.hashicorp.com/tutorials/terraform/install-cli" rel="noopener ugc nofollow" target="_blank">安装指南</a>操作。本文基于Terraform版本1.1.7。</p><p id="fd8b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我已经把这个项目上传到了<a class="ae lq" href="https://github.com/hellokvn/terraform-aws-ec2-nginx" rel="noopener ugc nofollow" target="_blank"> Github </a>。</p><h1 id="ef32" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">创建IAM用户</h1><p id="ed3e" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">但是，我们需要手动处理AWS上的一个小问题。我们需要<strong class="kw iu">为Terraform </strong>创建一个新的IAM用户，该用户有权限创建我们要用Terraform编码的所有这些很酷的东西。但是，别担心，很快就好了，跟我来。</p><p id="1822" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">登录AWS控制台，转到IAM仪表板，创建一个新用户。以下是重要的设置:</p><ul class=""><li id="106b" class="mo mp it kw b kx ky la lb ld mq lh mr ll ms lp mt mu mv mw bi translated">访问类型:<code class="fe mx my mz na b">Programmatic</code></li><li id="2521" class="mo mp it kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated">权限:<code class="fe mx my mz na b">AdminstratorAccess</code></li></ul><p id="4db3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">根本不建议选择<code class="fe mx my mz na b">AdminstratorAccess</code>。你永远不应该那样做。但是为了简单起见，我们就这么走。请记住，以后只授予您的Terraform用户必要的权限，尤其是在生产AWS帐户上。</p><p id="6d79" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下面是我对创建新用户的总结。你这边看起来应该差不多。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/5bf4b54a3dea9571500d7046a6f61788.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nwaj2aJQHMoZqNRo6BnU6w.png"/></div></div></figure><p id="c6fc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">继续，然后<strong class="kw iu">保存/下载</strong>访问密钥<strong class="kw iu">和<strong class="kw iu">秘密访问密钥</strong>，我们很快就会需要它们。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/c8cad5143a1430d7576c2c7bb6f29485.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tjLNL7tYJmuUc93N4HEEYw.png"/></div></div></figure></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="94ee" class="lr ls it bd lt lu np lw lx ly nq ma mb jz nr ka md kc ns kd mf kf nt kg mh mi bi translated">地形工程</h1><p id="6651" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">就这样，现在我们可以开始用Terraform编码了。</p><h2 id="5fa7" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">创建项目</h2><pre class="kj kk kl km gt og na oh oi aw oj bi"><span id="01de" class="nu ls it na b gy ok ol l om on">$ mkdir terraform-ec2-nginx<br/>$ cd terraform-ec2-nginx<br/>$ code .</span></pre><h2 id="5db9" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">项目结构</h2><p id="0439" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">像往常一样，在我的指南中，我将继续使用最终的文件结构。</p><pre class="kj kk kl km gt og na oh oi aw oj bi"><span id="b3d8" class="nu ls it na b gy ok ol l om on">$ mkdir network ec2<br/>$ touch main.tf providers.tf locals.tf terraform.tfvars<br/>$ touch vpc/data.tf vpc/main.tf vpc/outputs.tf vpc/variables.tf<br/>$ touch ec2/main.tf ec2/outputs.tf ec2/variables.tf ec2/userdata.json</span></pre><p id="220f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你可能不知道这个文件名是什么意思，但是请听我说，我很快就会解释它们。</p><p id="c0e6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是你应该知道的是，我们不需要在Terraform中导入/导出文件。Terraform很聪明，可以帮我们处理这件事。</p><p id="1793" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你的产品结构应该是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/bacc8201d302317e83a605971b244e29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AmSpBEV2PUs9ZFQ8JsAl8Q.png"/></div></div></figure></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="81df" class="lr ls it bd lt lu np lw lx ly nq ma mb jz nr ka md kc ns kd mf kf nt kg mh mi bi translated">准备变量、局部变量和提供程序</h1><p id="6f11" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">首先，我们将编写are(环境)变量、局部变量，并将AWS配置为根目录中的提供者。</p><h2 id="0e37" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">环境变量</h2><p id="e920" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">这里是我们存储刚刚在IAM仪表板上创建的用户的<strong class="kw iu">访问密钥</strong>和<strong class="kw iu">秘密访问密钥</strong>的地方。只要把它们插在引号之间。</p><p id="3ed9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Terraform将自动使用该文件，将其输入作为Terraform代码中的变量进行处理。</p><blockquote class="op oq or"><p id="74e5" class="ku kv os kw b kx ky ju kz la lb jx lc ot le lf lg ou li lj lk ov lm ln lo lp im bi translated"><strong class="kw iu"><em class="it">terra form . TF vars<br/></em></strong><em class="it">这个文件处理通常</em> <strong class="kw iu"> <em class="it">敏感值</em> </strong> <em class="it">。始终将此文件添加到您的。如果你使用Git，忽略它。</em></p></blockquote><p id="a4b8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们给<code class="fe mx my mz na b">terraform.tfvars</code>添加一些代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="1ca5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe mx my mz na b">access_ip</code>稍后将指定我们可以从哪个IP连接/从web访问我们的服务器(HTTP/SSH)。<code class="fe mx my mz na b">0.0.0.0/0</code>的意思是，每个人都可以连接并访问我们的服务器。</p><h2 id="51fc" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">变量</h2><p id="4257" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">正如我刚才所说的，环境变量将作为<a class="ae lq" href="https://www.terraform.io/language/values/variables" rel="noopener ugc nofollow" target="_blank">变量</a>来处理，所以我们必须再次声明它们，但是保留在我的，我们已经在<code class="fe mx my mz na b">terraform.tfvars</code>文件中定义了最敏感的变量。</p><p id="bbb7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">另外，我们在这里增加了一个叫做<code class="fe mx my mz na b">aws_region</code>的变量</p><p id="d27e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有些人会争辩说，这个变量也可能是敏感的，但是为了演示，我们在这个文件中用默认值<code class="fe mx my mz na b">eu-central-1</code>定义它。用您的首选地区替换此值。你可以在这里找到所有地区的列表。根据你的位置选择最适合你的。</p><p id="a0a9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们给<code class="fe mx my mz na b">variables.tf</code>添加代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="3203" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">提供者</h2><p id="eca4" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">由于我们将使用AWS，我们需要注册并配置AWS作为<a class="ae lq" href="https://www.terraform.io/language/providers" rel="noopener ugc nofollow" target="_blank">提供者</a>。正如你从<strong class="kw iu">第10行到第12行</strong>所看到的，我们已经开始使用我们的(环境)变量了。</p><p id="a994" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们给<code class="fe mx my mz na b">providers.tf</code>添加代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="b01f" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">当地人</h2><p id="5286" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">局部变量类似于变量，但是我们有时使用的一种模式是使用局部变量作为基于(可能缺少或未耦合的)变量的编程派生值。</p><p id="af2b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这里，我们将为EC2实例指定VPC的CIDR和安全组。我们允许每个人通过SSH、HTTP和HTTPS访问我们的服务器。出于安全原因，不建议让任何人访问SSH。推荐的方法是只授予需要访问的IP地址访问权限，比如您自己和其他系统管理员。</p><p id="a18c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是你知道，为了简单起见…</p><p id="3949" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们给<code class="fe mx my mz na b">locals.tf</code>添加代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="6805" class="lr ls it bd lt lu np lw lx ly nq ma mb jz nr ka md kc ns kd mf kf nt kg mh mi bi translated">创造一个VPC</h1><p id="a47f" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">现在，我们将配置两个模块中的第一个。</p><h2 id="e189" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">变量</h2><p id="11a7" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">VPC模块稍后将接收变量，因此我们需要通过定义这些给定的变量来为此做准备。</p><p id="aa65" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们给<code class="fe mx my mz na b">network/variables.tf</code>添加代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="64d4" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">数据源</h2><p id="3af1" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated"><a class="ae lq" href="https://www.terraform.io/language/data-sources" rel="noopener ugc nofollow" target="_blank">数据源</a>允许Terraform使用在Terraform之外定义的信息，例如，由AWS等注册提供商定义的信息。</p><p id="fe2f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这个特定的例子中，我们将基于我们的AWS区域获得所有的AWS可用性区域，作为一个字符串列表。</p><p id="358b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">就我的特殊情况:<code class="fe mx my mz na b">eu-central-1a</code> <code class="fe mx my mz na b">eu-central-1b</code> <code class="fe mx my mz na b">eu-central-1c</code></p><p id="64b1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您定义了一个不同的AWS区域，那么这个数据源的返回将会不同。但是不要太在意这个，因为它是根据您定义的区域自动生成的。</p><p id="113f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们添加代码到<code class="fe mx my mz na b">network/data.tf</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="86fd" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">资源</h2><p id="546c" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">文件<code class="fe mx my mz na b">main.tf</code>通常是我们定义的任何模块的核心。这里是我们在这个特例中将VPC设置为<a class="ae lq" href="https://www.terraform.io/language/resources" rel="noopener ugc nofollow" target="_blank">资源</a>的地方。但是，除了配置VPC，我们还需要做更多的工作。我们需要配置子网、路由表(它们必须相互关联)、配置安全组等等。我想你对这些很熟悉。</p><p id="be76" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个文件中的特性是最后一个资源<code class="fe mx my mz na b">aws_security_group</code>。我们在这里使用了一个<a class="ae lq" href="https://www.terraform.io/language/expressions/dynamic-blocks" rel="noopener ugc nofollow" target="_blank">动态块</a>。我建议阅读文档来理解这个关键字是如何工作的。</p><p id="c32d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们给<code class="fe mx my mz na b">network/main.tf</code>添加代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="6952" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">输出</h2><p id="fe9d" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">在设置我们的VPC、安全组等等之后，我们将返回一些数据作为<a class="ae lq" href="https://www.terraform.io/language/values/outputs" rel="noopener ugc nofollow" target="_blank">输出</a>。所以我们可以在其他模块中使用这些数据。因为我们要建立一个EC2实例，所以我们需要安全组ID。</p><p id="4b62" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们给<code class="fe mx my mz na b">network/outputs.tf</code>添加代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="c68b" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">将VPC添加为模块</h2><p id="2859" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">现在，我们需要将整个VPC配置添加为一个模块。记住，我说过，我们需要给VPC构型一些变量，现在我们要这么做了。</p><p id="3e29" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当心，我们现在在根目录中！</p><p id="4cd6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们给<code class="fe mx my mz na b">main.tf</code>添加代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="579c" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">测试VPC</h2><p id="f3e6" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">如果您想测试VPC配置，那么您可以这样做。向下滚动到本文的<strong class="kw iu">命令</strong>部分。但这是很随意的。我将在设置EC2实例后解释这些命令。</p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="f886" class="lr ls it bd lt lu np lw lx ly nq ma mb jz nr ka md kc ns kd mf kf nt kg mh mi bi translated">EC2实例</h1><p id="b000" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">现在，让我们继续配置我们的EC2实例。这里不会面对太多新的关键词，所以这个很快就搞定了。</p><h2 id="558c" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">变量</h2><p id="d0f2" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">这个文件很有趣。因为我们稍后将从VPC模块接收输出变量，所以我们必须为EC2模块定义它们。</p><p id="18c4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们给<code class="fe mx my mz na b">ec2/variables.tf</code>添加代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="c65c" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">用户数据</h2><p id="de76" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">在这个文件中，我们指定了在第一次启动EC2实例时运行的配置脚本。这是我们安装NGINX和其他所有我们想安装在EC2实例上的东西的地方。</p><p id="fa6f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们给<code class="fe mx my mz na b">ec2/userdata.tpl</code>添加代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="454e" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">资源</h2><p id="04b7" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">所以这个文件非常重要。在这里，我们配置我们的EC2实例。所以我们在这里做的是创建一个密钥对，我们也把它下载到我们的根目录。稍后我们需要这个密钥对来连接到我们的EC2实例。此外，我们设置了EC2实例，并将一个<a class="ae lq" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html" rel="noopener ugc nofollow" target="_blank">弹性IP </a>关联到服务器。</p><p id="8f6b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们添加代码到<code class="fe mx my mz na b">ec2/main.tf</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="491e" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">输出</h2><p id="f424" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">同样，我们有一些想要返回的输出。</p><p id="e9f6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们给<code class="fe mx my mz na b">ec2/outputs.tf</code>添加代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="b275" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">将EC2添加为模块</h2><p id="805d" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">现在，我们需要添加EC2配置作为一个模块。正如我所说的，我们要添加一些变量，因为它需要一些变量。</p><p id="dec6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们把根目录下的文件<code class="fe mx my mz na b">main.tf</code>从</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="e5d3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">到</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="69a5" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">一般输出</h2><p id="6f55" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">请记住，我们在EC2模块上定义了一些输出，我们希望这些输出在我们将更改提交并应用到AWS之后显示在我们的终端中。因此，我们很容易找到EC2实例的IP，而不是查看整个Terraform <a class="ae lq" href="https://www.terraform.io/language/state" rel="noopener ugc nofollow" target="_blank"> State </a>文件。这大大简化了事情。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="7c9c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">好消息！我们完成了编码。</p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="a38a" class="lr ls it bd lt lu np lw lx ly nq ma mb jz nr ka md kc ns kd mf kf nt kg mh mi bi translated">命令</h1><p id="7183" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">现在，一切准备就绪。所以现在有几个命令可以使用。像往常一样，我强烈建议您阅读每个命令的官方文档，以了解一切。</p><h2 id="c8e2" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">何时使用每个命令？</h2><p id="8e26" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">完成更改后，运行<code class="fe mx my mz na b">terraform init</code>、<code class="fe mx my mz na b">terraform validate</code>、<code class="fe mx my mz na b">terraform plan</code>和<code class="fe mx my mz na b">terraform apply</code>来应用您所做的更改。</p><p id="5085" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你想破坏你的整个配置，那么你需要运行<code class="fe mx my mz na b">terraform destory</code>。</p><p id="e4cb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在您的终端中执行以下命令。</p><h2 id="69b6" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">初始化</h2><p id="276c" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated"><a class="ae lq" href="https://www.terraform.io/cli/commands/init" rel="noopener ugc nofollow" target="_blank"> init </a>用于初始化包含Terraform配置文件的工作目录。每当您克隆一个Terraform存储库或添加一个新模块时，只需运行init。</p><pre class="kj kk kl km gt og na oh oi aw oj bi"><span id="ee8b" class="nu ls it na b gy ok ol l om on">$ terraform init</span></pre><h2 id="17e1" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">使生效</h2><p id="70a4" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated"><a class="ae lq" href="https://www.terraform.io/cli/commands/validate" rel="noopener ugc nofollow" target="_blank"> validate </a>命令验证您的配置。在应用更改之前，请运行此命令。</p><pre class="kj kk kl km gt og na oh oi aw oj bi"><span id="ce3d" class="nu ls it na b gy ok ol l om on">$ terraform validate</span></pre><h2 id="4ebb" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">计划</h2><p id="9881" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated"><a class="ae lq" href="https://www.terraform.io/cli/commands/plan" rel="noopener ugc nofollow" target="_blank"> plan </a>命令创建一个执行计划，让您预览Terraform计划对您的基础设施进行的更改。小心，输出会很长。在应用更改之前，请运行此命令。</p><pre class="kj kk kl km gt og na oh oi aw oj bi"><span id="1c1c" class="nu ls it na b gy ok ol l om on">$ terraform plan</span></pre><h2 id="4388" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">应用</h2><p id="182d" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated"><a class="ae lq" href="https://www.terraform.io/cli/commands/apply" rel="noopener ugc nofollow" target="_blank">应用</a>命令执行地形图中建议的动作。这意味着，我们将提交并应用我们对AWS的更改/更新，换句话说，这个命令创建了VPC和EC2实例。</p><pre class="kj kk kl km gt og na oh oi aw oj bi"><span id="0005" class="nu ls it na b gy ok ol l om on">$ terraform apply<br/>or<br/>$ terraform apply --auto-approve</span></pre><p id="09f3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://www.terraform.io/cli/commands/apply" rel="noopener ugc nofollow" target="_blank">应用</a>命令执行地形图中建议的动作。这意味着，我们将提交并应用我们对AWS的更改，换句话说，这个命令创建了VPC和EC2实例。执行该命令需要一段时间。</p><h2 id="31d2" class="nu ls it bd lt nv nw dn lx nx ny dp mb ld nz oa md lh ob oc mf ll od oe mh of bi translated">销毁(现在不运行！)</h2><p id="a49d" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated"><a class="ae lq" href="https://www.terraform.io/cli/commands/destroy" rel="noopener ugc nofollow" target="_blank"> destroy </a>命令破坏了我们的整个配置。现在不要运行它。</p><pre class="kj kk kl km gt og na oh oi aw oj bi"><span id="0f8b" class="nu ls it na b gy ok ol l om on">$ terraform destory<br/> or<br/>$ terraform destroy --auto-approve</span></pre><p id="de63" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如此重复，运行<code class="fe mx my mz na b">terraform init</code>、<code class="fe mx my mz na b">terraform validate</code>、<code class="fe mx my mz na b">terraform plan</code>，如果一切正常，那么运行<code class="fe mx my mz na b">terraform apply</code>。</p><p id="11fa" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">暂时跳过<code class="fe mx my mz na b">terraform destroy</code>！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/d8851840897d0ddf8ab27fa7bfb60c96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UbQ_s2686Dw9COq_VtGVWQ.png"/></div></div></figure><p id="47b7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">太好了！您的EC2实例正在运行。在这个截图的底部，您可以看到我们刚刚定义的输出。给服务器1-2分钟时间完全启动，安装NGINX也需要几秒钟。然后就可以访问我们输出的EC2公有IP了。</p><p id="53da" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我的情况下，我可以在我的网络浏览器中访问<code class="fe mx my mz na b">http://52.59.1.145</code>。这个链接对你不起作用，用你从终端得到的IP地址来代替它。</p><p id="8879" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以下是我得到的回报:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/46e3231670f149b7700dd3afa41805f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*694fyOikH6YhikK0I9o_aw.png"/></div></div></figure><p id="48aa" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们的NGINX正在工作。此外，让我们通过SSH连接到我们的服务器。只有两个进一步的步骤。</p><p id="63bd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">记住，Terraform创建了一个<strong class="kw iu">密钥对</strong>，我们也将它下载到我们的项目根目录中，但是首先我们需要使它可读。</p><pre class="kj kk kl km gt og na oh oi aw oj bi"><span id="31c0" class="nu ls it na b gy ok ol l om on">$ chmod 400 key.pem</span></pre><blockquote class="op oq or"><p id="ffb6" class="ku kv os kw b kx ky ju kz la lb jx lc ot le lf lg ou li lj lk ov lm ln lo lp im bi translated"><strong class="kw iu"> <em class="it">重要:</em> </strong> <em class="it">使用chmod命令更改权限后，如果您在Terraform上销毁并重新应用您的配置，Terraform可能很难覆盖此文件。因此，为了防止这种情况，请手动删除、移动或重命名该文件，如果您运行</em> <code class="fe mx my mz na b"><em class="it">terraform destory</em></code> <em class="it">！</em></p></blockquote><p id="2b86" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在让我们连接到EC2实例，只需在终端内用输出的IP替换<code class="fe mx my mz na b">YOUR_SERVER_IP</code>。</p><pre class="kj kk kl km gt og na oh oi aw oj bi"><span id="4a61" class="nu ls it na b gy ok ol l om on">$ ssh -i "key.pem" ubuntu@YOUR_SERVER_IP</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/99973171962dd3abf12e2a71ca2fb333.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VWp4FkV3zuz-T6zupaCECQ.png"/></div></div></figure><p id="7a67" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">恭喜恭喜！</strong>一切按预期运行。感谢您阅读我关于如何用Terraform创建EC2实例的文章。我希望，你能学到新的东西。Terraform是DevOps中一个很棒的工具，有比你刚才看到的更多的可能性。</p><p id="f51e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我已经把这个项目上传到了<a class="ae lq" href="https://github.com/hellokvn/terraform-aws-ec2-nginx" rel="noopener ugc nofollow" target="_blank"> Github </a>。</p><p id="fc5b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">干杯！</p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><p id="09a4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我希望你喜欢读这篇文章。如果你愿意支持我成为一名作家，可以考虑注册<a class="ae lq" href="https://medium.com/@hellokevinvogel/membership" rel="noopener">成为一名媒体会员</a>。每月只需5美元，你就可以无限制地使用Medium。</p><p id="f64b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">想支持我？给我买杯咖啡。</p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="f3e0" class="lr ls it bd lt lu np lw lx ly nq ma mb jz nr ka md kc ns kd mf kf nt kg mh mi bi translated">接下来阅读</h1><div class="pa pb gp gr pc pd"><a rel="noopener  ugc nofollow" target="_blank" href="/nestjs-microservices-with-grpc-api-gateway-and-authentication-part-1-2-650009c03686"><div class="pe ab fo"><div class="pf ab pg cl cj ph"><h2 class="bd iu gy z fp pi fr fs pj fu fw is bi translated">NestJS:具有gRPC、API网关和认证的微服务—第1/2部分</h2><div class="pk l"><h3 class="bd b gy z fp pi fr fs pj fu fw dk translated">分步指南:带有gRPC、API网关、认证和验证的NestJS应用程序</h3></div><div class="pl l"><p class="bd b dl z fp pi fr fs pj fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="pm l"><div class="pn l po pp pq pm pr ks pd"/></div></div></a></div><div class="pa pb gp gr pc pd"><a href="https://javascript.plainenglish.io/3-reasons-why-typescript-is-better-than-javascript-76443330f248" rel="noopener  ugc nofollow" target="_blank"><div class="pe ab fo"><div class="pf ab pg cl cj ph"><h2 class="bd iu gy z fp pi fr fs pj fu fw is bi translated">TypeScript优于JavaScript的3个原因</h2><div class="pk l"><h3 class="bd b gy z fp pi fr fs pj fu fw dk translated">是时候停止在TypeScript上使用JavaScript了</h3></div><div class="pl l"><p class="bd b dl z fp pi fr fs pj fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="pm l"><div class="ps l po pp pq pm pr ks pd"/></div></div></a></div><div class="pa pb gp gr pc pd"><a href="https://blog.bitsrc.io/solid-principles-in-typescript-153e6923ffdb" rel="noopener  ugc nofollow" target="_blank"><div class="pe ab fo"><div class="pf ab pg cl cj ph"><h2 class="bd iu gy z fp pi fr fs pj fu fw is bi translated">带打字稿的固体原理(2022)</h2><div class="pk l"><h3 class="bd b gy z fp pi fr fs pj fu fw dk translated">TypeScript对用JavaScript编写干净的代码产生了巨大的影响。但是总有办法…</h3></div><div class="pl l"><p class="bd b dl z fp pi fr fs pj fu fw dk translated">blog.bitsrc.io</p></div></div><div class="pm l"><div class="pt l po pp pq pm pr ks pd"/></div></div></a></div></div></div>    
</body>
</html>