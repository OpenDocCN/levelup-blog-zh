<html>
<head>
<title>How Doing Queries In Views Can Degrade The Performance Of Your Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在视图中执行查询会降低应用程序的性能</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-doing-queries-in-views-can-degrade-the-performance-of-your-application-bf737622fdc4?source=collection_archive---------12-----------------------#2021-12-02">https://levelup.gitconnected.com/how-doing-queries-in-views-can-degrade-the-performance-of-your-application-bf737622fdc4?source=collection_archive---------12-----------------------#2021-12-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e133" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在MVC框架中优化查询</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4da96bb8ce9931683530315d80d6db48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6qQdqsxb0yiNYdPQ"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@chuttersnap?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> CHUTTERSNAP </a>拍摄</figcaption></figure><p id="5659" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">MVC——模型视图控制器，软件开发中最流行的框架之一。我犯了很多错误，也看到其他人犯了同样的错误。</p><p id="fdd0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我使用MVC已经很多年了，也在各种语言中使用过。我工作过的一些流行的MVC框架有Ruby On Rails、Django、Revel等。</p><p id="a067" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">开发人员犯这些错误有很多原因。以下是我注意到的一些常见原因:</p><ul class=""><li id="dfde" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">新手由于缺乏经验而犯错误。</li><li id="68ba" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">专家对框架和错误感到舒服。</li><li id="8112" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">一个快速的改变，实际上是一个没有经过深思熟虑的改变。</li></ul><p id="27db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">影响应用程序性能的最常见错误之一是—在视图代码中查询数据库。</p><p id="593a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将使用Ruby On Rails和ERB来演示查询可能在视图中引起的问题。</p><p id="55db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将演示如何使用<em class="mj"> Ruby On Rails </em>和<em class="mj"> ERB </em>。这可以适用于任何MVC框架。</p><h1 id="ebef" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">n + 1查询</h1><p id="24ed" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">假设我们有以下两个模型:</p><p id="e4e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们考虑一个博客应用，它有以下两种模式，博客和评论:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/6c3226c26bcc13415679224fb4265518.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HQ8v6lhq1frw0DPKq8tZXw.png"/></div></div></figure><p id="dede" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们假设有一个GET route /blogs，它显示所有的博客，每个博客上有一个评论。</p><p id="ad8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是获取所有博客的控制器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/8e855379e0f9b8e87271a719aea57084.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XuHdd_Ybt17dS6AzBmDC5g.png"/></div></div></figure><p id="9bb6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">控制器调用视图“app/views/blogs/index.html.erb”来呈现包含所有博客的页面。而“app/views/blogs/_blog.html.erb”是渲染博客的部分博客。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/b03cc07f73ab586a88944be782881da6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CukYishvXdPvKFZ8mWd__w.png"/></div></div></figure><p id="19c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，如果在<em class="mj"> blogs </em>表中有100个博客，那么将执行1 + 100个查询来呈现index.html页面:</p><ul class=""><li id="47ed" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">1从博客表中获取所有博客的查询。</li><li id="944d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">在局部视图中，当调用<em class="mj"> blog.comments </em>时，它会查询comments表以获取每个博客的评论。这个数到100。</li></ul><p id="760f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">解决方案</strong></p><p id="3950" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样的工作可以用1个或最多2个查询来完成。在Rails中，这被称为急切加载。不是在视图中运行查询，而是在查询博客时将评论加载到控制器本身中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/ec0efdcdbfc07df08e145ce8b8159bc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*duIM-Rxq9DPS-JE_6q-_fg.png"/></div></div></figure><p id="5980" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这执行两个查询:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/bbf16dbf08b47eb231a3f0094295d485.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cQkx56YotA6VtwTGhKwB9A.png"/></div></div></figure><p id="e844" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个查询是获取所有博客，第二个查询是从第一个查询的结果中获取所有博客id的所有评论。</p><p id="e5d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将查询数量减少到2。使用连接也可以做到这一点。</p><h1 id="eeb4" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">分散代码</h1><p id="58b7" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">在视图中编写查询会使您的代码看起来很糟糕并且难以理解。如果一个新开发人员只看控制器和输出，他可能很难理解。</p><p id="c298" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">解决方案</strong></p><p id="1b21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在模型中编写DB查询并在控制器中调用它们是MVC框架的精髓。没有这样的规则，但是遵循MVC的惯例会使你的代码更容易理解和修改。</p><h1 id="bf1c" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">数据库性能</h1><p id="f6f9" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">更多的查询意味着更多的数据库负载。当查询发生在一个视图中时，它是一个经常被调用的API，这会给数据库带来不必要的负载。</p><p id="e955" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当从视图中执行查询时，如示例所示，在每次局部视图渲染时都会调用DB。</p><p id="9dab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">解决方案</strong></p><p id="c39c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过仔细设计模型和控制器来优化数据库查询可以减少数据库服务器上的负载。</p><div class="nm nn gp gr no np"><a href="https://singhamrit.medium.com/subscribe" rel="noopener follow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd iu gy z fp nu fr fs nv fu fw is bi translated">每当Amrit Pal Singh发布内容时，您都会收到一封电子邮件。</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">每当Amrit Pal Singh发布内容时，您都会收到一封电子邮件。通过注册，您将创建一个中型帐户，如果您还没有…</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">singhamrit.medium.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od ks np"/></div></div></a></div><h1 id="ba7f" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">结论</h1><p id="f0fb" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">尽管我已经给出了一个<em class="mj"> Ruby on Rails </em>的例子，但是这个概念可以是任何MVC框架。</p><p id="852f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我经常看到开发人员犯这样的错误，有时是无意识的，但大部分是有意识的。我在评论中发现过这一点，犯过这样的错误，我自己也清理过很多次这样的代码。</p><p id="dc37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以上例子要从理解概念的角度来看。代码没有优化。</p><p id="2f55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你在MVC框架中遇到过这样的问题吗？</p><p id="f493" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p></div></div>    
</body>
</html>