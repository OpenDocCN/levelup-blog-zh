<html>
<head>
<title>Anonymous Web Scraping with Node.js, Tor, Puppeteer and cheerio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Node.js、Tor、木偶师和cheerio进行匿名网络抓取</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/anonymous-web-scrapping-with-node-js-tor-apify-and-cheerio-3b36ec6a45dc?source=collection_archive---------0-----------------------#2020-01-24">https://levelup.gitconnected.com/anonymous-web-scrapping-with-node-js-tor-apify-and-cheerio-3b36ec6a45dc?source=collection_archive---------0-----------------------#2020-01-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/105bd3d1809e4a55747795c6401a6acb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Zq1RSCl88XCEUbEYMMCAg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">拥抱Tor和Node.js的力量来匿名抓取网页。—<a class="ae kc" href="https://unsplash.com/photos/S2eX-jJSiOM?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">印度瑜伽士</a>在<a class="ae kc" href="https://unsplash.com/search/photos/calm?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="3603" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">网络抓取是从网站中提取数据的技术。该术语通常用于自动数据提取。今天，我将向你展示如何匿名抓取网站。你想要隐藏你的身份的原因是由于许多网络服务器对网站应用规则，在一定数量的连续请求后禁止IP。我们将使用<a class="ae kc" href="https://github.com/puppeteer/puppeteer" rel="noopener ugc nofollow" target="_blank">木偶师</a>访问网页，使用<a class="ae kc" href="https://github.com/cheeriojs/cheerio" rel="noopener ugc nofollow" target="_blank"> cheerio </a>解析HTML，使用<a class="ae kc" href="https://www.torproject.org/" rel="noopener ugc nofollow" target="_blank"> Tor </a>从不同的IP地址运行每个请求。</p><blockquote class="lb lc ld"><p id="6fbe" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">虽然网页抓取的法律方面各不相同，有许多灰色地带，但请记住始终遵守您抓取的每个网页的服务条款。本·伯纳德写了一篇关于这些法律问题的好文章。</p></blockquote><h1 id="9993" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">设置Tor</h1><p id="2d4e" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">首先，我们必须使用下面的命令安装Tor客户机。</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="50c2" class="mu lj iq mq b gy mv mw l mx my">sudo apt-get install tor</span></pre><h1 id="a8b0" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">配置Tor</h1><p id="5d5f" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">接下来，我们将配置我们的Tor客户端。默认Tor配置使用一个<a class="ae kc" href="https://en.wikipedia.org/wiki/SOCKS" rel="noopener ugc nofollow" target="_blank"> SOCKS </a>端口，为我们提供一个通往单个出口节点(即一个IP地址)的电路。这对于日常使用很方便，比如浏览，但对于我们的特定场景，我们需要多个IP地址，这样我们就可以在抓取时在它们之间切换。</p><p id="044b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们将简单地打开额外的端口来监听<a class="ae kc" href="https://en.wikipedia.org/wiki/SOCKS" rel="noopener ugc nofollow" target="_blank"> SOCKS </a>连接。这是通过在主配置文件的<code class="fe mz na nb mq b">/etc/tor</code>下添加多个<code class="fe mz na nb mq b">SocksPort</code>选项来实现的。</p><p id="4f97" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用你喜欢的编辑器打开<code class="fe mz na nb mq b">/etc/tor/torrc</code>文件，并在文件末尾添加下一行。</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="1d1b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里有几点需要注意:</p><ul class=""><li id="3ca9" class="ne nf iq kf b kg kh kk kl ko ng ks nh kw ni la nj nk nl nm bi translated">每个<code class="fe mz na nb mq b">SocksPort</code>的值是一个数字，Tor将监听来自SOCKS应用程序(如浏览器)的连接。</li><li id="c083" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">因为<code class="fe mz na nb mq b">SocksPort</code>值是一个要打开的端口，该端口一定没有被另一个进程使用。</li><li id="d5b2" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">初始端口以值<code class="fe mz na nb mq b">9050</code>开始。这是Tor客户端的默认SOCKS。</li><li id="88d9" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated"><strong class="kf ir">我们绕过</strong>值<code class="fe mz na nb mq b"><strong class="kf ir">9051</strong></code>。Tor使用此端口来允许连接到此端口的外部应用程序控制Tor进程。</li><li id="03de" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">作为一个简单的约定，为了打开更多的端口，我们在<code class="fe mz na nb mq b">9051</code>后面的每个值加1。</li></ul><p id="380c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">重启tor客户端以应用新的更改。</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="dc7c" class="mu lj iq mq b gy mv mw l mx my">sudo /etc/init.d/tor restart</span></pre><h1 id="d63d" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">创建新的节点项目</h1><p id="262e" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">为你的项目创建一个新目录，我称之为<code class="fe mz na nb mq b">superWebScraping</code>。</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="7784" class="mu lj iq mq b gy mv mw l mx my">mkdir superWebScraping</span></pre><p id="b1a4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导航到<code class="fe mz na nb mq b">superWebScraping</code>并初始化一个空节点项目。</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="f65f" class="mu lj iq mq b gy mv mw l mx my">cd superWebScraping &amp;&amp; npm init -y</span></pre><p id="bfa8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">安装所需的依赖项。</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="f6ef" class="mu lj iq mq b gy mv mw l mx my">npm i --save puppeteer<!-- --> cheerio</span></pre><h1 id="3d65" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">使用木偶师浏览</h1><p id="13d5" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated"><a class="ae kc" href="https://github.com/puppeteer/puppeteer" rel="noopener ugc nofollow" target="_blank">木偶师</a>是一个<a class="ae kc" href="https://developers.google.com/web/updates/2017/04/headless-chrome" rel="noopener ugc nofollow" target="_blank">无头浏览器</a>，它使用<a class="ae kc" href="https://chromedevtools.github.io/devtools-protocol/" rel="noopener ugc nofollow" target="_blank"> DevTools协议</a>与<a class="ae kc" href="https://www.google.com/chrome/" rel="noopener ugc nofollow" target="_blank"> Chrome </a>或<a class="ae kc" href="https://www.chromium.org/" rel="noopener ugc nofollow" target="_blank">Chrome</a>进行通信。我们之所以不使用请求库，比如<a class="ae kc" href="https://www.npmjs.com/package/tor-request" rel="noopener ugc nofollow" target="_blank"> tor-request </a>，是因为请求库无法处理动态加载内容的SPA网站。</p><p id="b683" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建一个<code class="fe mz na nb mq b">index.js</code>文件并添加下面的脚本。语句被内联记录。</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="a13b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用运行脚本</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="e443" class="mu lj iq mq b gy mv mw l mx my">node index.js</span></pre><p id="a64f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您应该会看到Chromium浏览器导航到<a class="ae kc" href="https://api.ipify.org" rel="noopener ugc nofollow" target="_blank">https://api.ipify.org</a>，如下图所示</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/99fc67a4e1b5ae97f89c7b0a9627ef16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YTPeS730jihtRUQJ28ThZw.png"/></div></div></figure><p id="7982" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在示例中选择特定的web页面是有原因的。https://api.ipify.org能够把我们的公共IP地址发给我们。这是你正在浏览网页的IP，没有使用Tor。</p><p id="eada" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过在<code class="fe mz na nb mq b">puppeteer.launch</code>语句中添加以下键来更改上述代码:</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="721a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们为浏览器提供了<code class="fe mz na nb mq b"> --proxy-server</code>参数。这个参数的值告诉浏览器在我们本地机器的端口<code class="fe mz na nb mq b">9050</code>上使用socks5代理。端口的值是我们之前在<code class="fe mz na nb mq b">torrc</code>文件中提供的值之一。</p><p id="623f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在再次运行脚本。</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="d5c3" class="mu lj iq mq b gy mv mw l mx my">node index.js</span></pre><p id="eb0d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这一次，您应该会看到一个不同的IP地址。这是Tor电路自带的IP。</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/4c603ad34a87274d24c0a3b2408eb95e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VudGr6lBoAlP4Djc_VX9Pw.png"/></div></div></figure><p id="2589" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的是<code class="fe mz na nb mq b">144.217.7.33</code>，但你可能有一个不同的。请注意，如果您在同一个端口<code class="fe mz na nb mq b">9050</code>上再次运行该脚本，您将获得与之前相同的IP地址。</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/4c603ad34a87274d24c0a3b2408eb95e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VudGr6lBoAlP4Djc_VX9Pw.png"/></div></div></figure><p id="f4ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是我们在Tor配置中开放许多端口的原因。尝试使用另一个端口，比如<code class="fe mz na nb mq b">9053</code>。IP将不会相同。</p><h1 id="ce62" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">勉强满足于麦片</h1><p id="976c" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">现在我们有了一个很好的方法来获取我们的页面，是时候刮它们了。我们将使用cheerio库。Cheerio是一个HTML解析器，设计用来使用与jQuery相同的API。我们的任务是刮掉<a class="ae kc" href="https://news.ycombinator.com/" rel="noopener ugc nofollow" target="_blank">黑客新闻</a>的最后5个帖子标题。</p><p id="6bbf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们导航到<a class="ae kc" href="https://news.ycombinator.com/" rel="noopener ugc nofollow" target="_blank">黑客新闻</a>。</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/a6a8a4fc590fb770d69ae09d475fd406.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cbpk6VOBeRabUQaLMXLhjQ.png"/></div></div></figure><p id="d572" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们想刮前5个标题(“哈克姆(1972)，“拉里·罗伯茨已经去世”，等等)。使用我的浏览器的DevTools检查一篇文章的标题，我可以看到每篇文章都用一个HTML link元素包装，这个元素有<code class="fe mz na nb mq b">storylink</code>类。</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/e96f680a7a074a891883690be4ae6525.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CB4LvugprTfW5QOV6iOXiQ.png"/></div></div></figure><p id="f551" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们要遵循的程序可以用下面的列表来表示:</p><ul class=""><li id="5d8d" class="ne nf iq kf b kg kh kk kl ko ng ks nh kw ni la nj nk nl nm bi translated">使用Tor代理以无头模式启动浏览器实例</li><li id="c046" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">创建新页面</li><li id="5e72" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">导航到<a class="ae kc" href="https://news.ycombinator.com/" rel="noopener ugc nofollow" target="_blank">https://news.ycombinator.com/</a></li><li id="1205" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">获取页面HTML内容</li><li id="5fb5" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">在Cheerio中加载HTML内容</li><li id="1349" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">创建一个数组来保存文章标题。</li><li id="d986" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">访问所有拥有<code class="fe mz na nb mq b">storylink</code>类的元素</li><li id="2ded" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">使用Cherrio的<a class="ae kc" href="https://cheerio.js.org/#slice-start-end-" rel="noopener ugc nofollow" target="_blank"> slice() </a>方法，只获得前5个这样的元素。</li><li id="0c97" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">使用Cherrio的<a class="ae kc" href="https://cheerio.js.org/#each-functionindex-element-" rel="noopener ugc nofollow" target="_blank"> each() </a>方法迭代这5个元素。</li><li id="69b7" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated">在数组中添加每篇文章的标题。</li></ul><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="8aad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是上面代码的输出。</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/b30adbfb3147a5d118c577ff8efb3fa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K2U6x5KVJD8bxZyTH-89eA.png"/></div></div></figure><h1 id="7468" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">不同IP的连续刮擦</h1><p id="02c4" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">最后要考虑的是利用我们在torrc文件中定义的所有SOCKS端口。这很容易。我们将定义一个数组，每一项都是不同的端口号。然后我们将把<code class="fe mz na nb mq b">main()</code>重命名为<code class="fe mz na nb mq b">scrape()</code>,我们将定义一个新的<code class="fe mz na nb mq b">main()</code>函数，每次用不同的端口调用<code class="fe mz na nb mq b">scrape()</code>。</p><p id="960e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是完整的代码。</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h1 id="9d1b" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">结论</h1><p id="95ad" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">这篇文章旨在为你提供一个温和的网络抓取的介绍。谢谢你花时间阅读它。🙏</p></div></div>    
</body>
</html>