<html>
<head>
<title>3 Useful Tips for Developers when using Spring Cloud Config</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开发人员在使用Spring Cloud Config时的3个有用提示</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/3-useful-tips-for-developers-when-using-spring-cloud-config-de7b874f9911?source=collection_archive---------4-----------------------#2022-07-04">https://levelup.gitconnected.com/3-useful-tips-for-developers-when-using-spring-cloud-config-de7b874f9911?source=collection_archive---------4-----------------------#2022-07-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="297c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">与Spring Boot分享我在理解Spring Cloud Config时发现的有用内容</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/540bebaffab5699b9b537d5a0f363a08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ae7ztydy0-O2tYOjhIgMSg.png"/></div></div></figure><p id="71ec" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://betterprogramming.pub/5-observations-on-spring-boots-loading-precedence-for-properties-files-with-spring-cloud-config-331d1af9052e" rel="noopener ugc nofollow" target="_blank">之前，我写过关于使用Spring Boot和Spring Cloud Config </a>开发时属性文件的优先顺序。如果你还没有这样做的话，一定要检查一下。在本文中，我将分享一些有用的技巧，帮助我理解属性文件的优先顺序，以及使用Spring Cloud Config高效开发的方法。事不宜迟，我们开始吧！</p><div class="lr ls gp gr lt lu"><a href="https://github.com/bkjam/config-server-order" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd iu gy z fp lz fr fs ma fu fw is bi translated">GitHub-bkjam/config-server-order:了解Spring boot的优先顺序…</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">这是我的探索，尝试了解在Spring Boot使用时属性文件是如何加载的</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">github.com</p></div></div><div class="md l"><div class="me l mf mg mh md mi ks lu"/></div></div></a></div></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="3641" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">技巧1:调试属性源加载优先顺序</h1><p id="13cc" class="pw-post-body-paragraph ku kv it kw b kx ni ju kz la nj jx lc ld nk lf lg lh nl lj lk ll nm ln lo lp im bi translated">调试Spring Boot应用程序的属性源加载优先级的最简单方法是启用<a class="ae lq" href="https://docs.spring.io/spring-boot/docs/current/actuator-api/htmlsingle/" rel="noopener ugc nofollow" target="_blank"> Spring Boot执行器API </a>中的<code class="fe nn no np nq b">env</code>端点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/a2a8572199942792632bda7a4fbc3da0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eR8Jk2sm6vqq5ABFimCpFw.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">向build.gradle.kts添加执行器依赖项</figcaption></figure><p id="716f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">添加上面的致动器依赖项，并在应用程序的<code class="fe nn no np nq b">application.yaml</code>中设置下面的配置，以启用<code class="fe nn no np nq b">env</code>端点。</p><pre class="kj kk kl km gt nw nq nx ny aw nz bi"><span id="7ba6" class="oa mr it nq b gy ob oc l od oe">management.endpoints.web.exposure.include: env</span></pre><p id="483f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，浏览到<code class="fe nn no np nq b">http://localhost:8080/actuator/env</code>查看房产来源信息。你应该得到这样的东西。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/a66c542d014bb52c7974d845626fe450.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*StN9Ln4qvBSRt44bhUW4OQ.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated"><a class="ae lq" href="http://localhost/actuator/env" rel="noopener ugc nofollow" target="_blank">/执行器/环境</a>端点示例的屏幕截图</figcaption></figure><p id="c64f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">优先级顺序是自上而下的，其中索引0具有最高优先级。除了属性文件，您还可以找到通过命令行参数、系统属性或环境变量设置的属性。这对于确保为所有部署环境加载正确的属性非常有用。</p><h1 id="a7c1" class="mq mr it bd ms mt og mv mw mx oh mz na jz oi ka nc kc oj kd ne kf ok kg ng nh bi translated">技巧#2:使用Spring Cloud Config进行本地主机开发</h1><p id="4b59" class="pw-post-body-paragraph ku kv it kw b kx ni ju kz la nj jx lc ld nk lf lg lh nl lj lk ll nm ln lo lp im bi translated">当您的Spring Boot应用程序从外部源(例如Spring Cloud Config Server)加载属性时，在开发时测试您的配置可能会令人沮丧和乏味。这是因为要更新属性，您必须更新属性文件，提交更改并将其推送到远程git存储库。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/3fcfd504a5b4fb3621a3ae5be6a6e175.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*82EGjGWNzni8GqpJ5uD9lA.png"/></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">演示设置概述</figcaption></figure><p id="a357" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以上面的设置为例，我们将有一个从Spring Cloud配置服务器加载属性的Spring Boot应用程序(config-client)。为了促进本地主机的开发，我们希望能够更新属性并立即反映变化。为此，我们可以使用以下几种方法:</p><h2 id="9536" class="oa mr it bd ms om on dn mw oo op dp na ld oq or nc lh os ot ne ll ou ov ng ow bi translated">1-使用属性“spring . cloud . config . allow-override”</h2><p id="9c39" class="pw-post-body-paragraph ku kv it kw b kx ni ju kz la nj jx lc ld nk lf lg lh nl lj lk ll nm ln lo lp im bi translated">如果您参考Spring Cloud文档中的<a class="ae lq" href="https://cloud.spring.io/spring-cloud-static/spring-cloud.html#overriding-bootstrap-properties" rel="noopener ugc nofollow" target="_blank">覆盖远程属性的值</a>一节，您会发现通过在远程git存储库中的<code class="fe nn no np nq b">application.yaml</code>中设置以下配置，可以用本地属性覆盖远程属性。</p><pre class="kj kk kl km gt nw nq nx ny aw nz bi"><span id="f485" class="oa mr it nq b gy ob oc l od oe"># application.yaml<br/>spring.cloud.config:<br/>    allow-override: true<br/>    override-none: true<br/>    override-system-properties: false</span></pre><p id="6108" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，这只有在您使用引导配置(<code class="fe nn no np nq b">spring-cloud-starter-bootstrap</code>)从Spring Cloud Config Server导入属性时才有效。例如。</p><pre class="kj kk kl km gt nw nq nx ny aw nz bi"><span id="9175" class="oa mr it nq b gy ob oc l od oe"># bootstrap.properties<br/>spring.application.name=config-client<br/>spring.cloud.config.fail-fast=true<br/>spring.cloud.config.uri=http://localhost:8888 # Config Server URL</span></pre><p id="75a0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在Spring Boot 2.4更新中，从Spring Cloud Config Server导入属性的推荐方式是使用<code class="fe nn no np nq b">application.yaml</code>文件中的<code class="fe nn no np nq b">spring.config.import</code>属性，而不是<code class="fe nn no np nq b">bootstrap.properties</code>文件中的<code class="fe nn no np nq b">spring.cloud.config.uri</code>属性。</p><p id="dd9f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，<code class="fe nn no np nq b">override-none</code>属性不再像预期的那样工作，因为它是在引导配置中处理的，这不再是推荐的方法。在<a class="ae lq" href="https://github.com/spring-cloud/spring-cloud-config/issues/1856" rel="noopener ugc nofollow" target="_blank"> Spring Cloud Config的Github问题</a>中也强调了这个问题。</p><p id="1504" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，如果您不使用引导配置从Spring Cloud Config Server导入属性，属性<code class="fe nn no np nq b">spring.cloud.config.allow-override</code>可能不适合您。</p><h2 id="a341" class="oa mr it bd ms om on dn mw oo op dp na ld oq or nc lh os ot ne ll ou ov ng ow bi translated">2-使用“局部”弹簧轮廓</h2><p id="509e" class="pw-post-body-paragraph ku kv it kw b kx ni ju kz la nj jx lc ld nk lf lg lh nl lj lk ll nm ln lo lp im bi translated">正如我在<a class="ae lq" href="https://betterprogramming.pub/5-observations-on-spring-boots-loading-precedence-for-properties-files-with-spring-cloud-config-331d1af9052e" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>中提到的，外部属性文件总是覆盖打包的文件(无论是否特定于概要文件)。因此，我们可以利用Spring概要文件来加载特定于环境的属性文件。为此，我们将使用一个<code class="fe nn no np nq b">local</code> Spring概要文件，并在项目的根中使用一个相应的特定于概要文件的属性文件(<code class="fe nn no np nq b">application-local.yaml</code>)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/ad5c89bd515acf371b5163ed2dec462a.png" data-original-src="https://miro.medium.com/v2/resize:fit:866/format:webp/1*zz5vOgmYt-3vXIk8WYNZjw.png"/></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">典型Spring Boot应用程序项目的文件夹结构</figcaption></figure><p id="7d7d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本质上，我们在<code class="fe nn no np nq b">src/main/resource/application.yaml</code>中从Spring Cloud Config Server导入远程属性文件。然后我们将在项目根目录下的config文件夹中创建一个<code class="fe nn no np nq b">application-local.yaml</code>属性文件。设置好这个文件夹结构后，我们现在可以在本地主机上运行Spring Boot应用程序了:</p><pre class="kj kk kl km gt nw nq nx ny aw nz bi"><span id="e332" class="oa mr it nq b gy ob oc l od oe">gradle config-client:bootRun \<br/>    -Pargs=--spring.profiles.active=dev,local</span></pre><p id="6898" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Spring Boot应用程序将使用活动的Spring概要文件<code class="fe nn no np nq b">dev</code>和<code class="fe nn no np nq b">local</code>执行，后者具有更高的优先级。因此，它将按以下顺序(从高到低)加载属性文件:</p><ul class=""><li id="8d41" class="oy oz it kw b kx ky la lb ld pa lh pb ll pc lp pd pe pf pg bi translated"><code class="fe nn no np nq b">application-local.yaml</code>(配置文件夹)—外部(本地)</li><li id="b96b" class="oy oz it kw b kx ph la pi ld pj lh pk ll pl lp pd pe pf pg bi translated"><code class="fe nn no np nq b">config-client-dev.yaml</code>(配置服务器)—外部(远程)</li><li id="af10" class="oy oz it kw b kx ph la pi ld pj lh pk ll pl lp pd pe pf pg bi translated"><code class="fe nn no np nq b">config-client.yaml</code>(配置服务器)—外部(远程)</li><li id="5c8d" class="oy oz it kw b kx ph la pi ld pj lh pk ll pl lp pd pe pf pg bi translated"><code class="fe nn no np nq b">application.yaml</code>(类路径)—内部(本地)</li></ul><p id="326b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如您所见，<code class="fe nn no np nq b">application-local.yaml</code>将具有最高的优先级，这在您在本地主机上开发时非常有用。</p><p id="70e6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">此外，当我们整理或构建Spring Boot应用程序时，config文件夹将不包含在内。因此，在git存储库中包含config文件夹是安全的，以便于其他开发人员进行本地主机开发。</p><h2 id="9974" class="oa mr it bd ms om on dn mw oo op dp na ld oq or nc lh os ot ne ll ou ov ng ow bi translated">3 —连接到本地主机Spring云配置服务器</h2><p id="518b" class="pw-post-body-paragraph ku kv it kw b kx ni ju kz la nj jx lc ld nk lf lg lh nl lj lk ll nm ln lo lp im bi translated">最后一种方法是运行localhost Spring Cloud Config Server实例。我们可以在文件系统中本地定位属性文件，而不是从远程git存储库中加载属性文件。幸运的是，Spring Cloud Config Server为我们提供了<code class="fe nn no np nq b">native</code>配置模式，简化了这种配置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pm"><img src="../Images/4a353cf5499ecf354fa56eec3d08f8f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cerfMxGXELBzyHrOleZtyQ.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">Spring Cloud Config Server中的“本地”配置文件配置示例</figcaption></figure><p id="38e6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用localhost Spring云配置服务器有几个注意事项。</p><ul class=""><li id="3dac" class="oy oz it kw b kx ky la lb ld pa lh pb ll pc lp pd pe pf pg bi translated">首先，当我们在本地开发时，我们必须将Spring Boot应用程序配置为指向本地Spring Cloud Config Server实例，而不是远程实例。这可以通过使用不同的弹簧轮廓很容易地实现。</li><li id="54ec" class="oy oz it kw b kx ph la pi ld pj lh pk ll pl lp pd pe pf pg bi translated">其次，我们必须手动更新本地文件系统中的配置，以便从远程git存储库中获取最新的配置。当我们在远程属性文件可以随时更新的团队中工作时，这是非常重要的。</li><li id="7162" class="oy oz it kw b kx ph la pi ld pj lh pk ll pl lp pd pe pf pg bi translated">最后，如果Spring Cloud Config Server被配置为从多个远程git存储库加载，这种方法可能很难管理。</li></ul><p id="b4ba" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">总的来说，这是一个“不错”的方法，但是我会推荐方法2，因为这种方法需要开发人员大量的手动干预。</p><h1 id="f787" class="mq mr it bd ms mt og mv mw mx oh mz na jz oi ka nc kc oj kd ne kf ok kg ng nh bi translated">技巧#3:在运行时刷新属性</h1><p id="602f" class="pw-post-body-paragraph ku kv it kw b kx ni ju kz la nj jx lc ld nk lf lg lh nl lj lk ll nm ln lo lp im bi translated">最后一点是，Spring Cloud提供了一些方法，允许Spring Cloud Config客户端刷新它们的属性，而无需重启客户端。为此，只需在Spring Boot应用程序(config-client)中启用<a class="ae lq" href="https://docs.spring.io/spring-boot/docs/current/actuator-api/htmlsingle/" rel="noopener ugc nofollow" target="_blank"> Spring Boot执行器API </a>的<code class="fe nn no np nq b">refresh</code>端点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/a2a8572199942792632bda7a4fbc3da0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eR8Jk2sm6vqq5ABFimCpFw.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">向build.gradle.kts添加执行器依赖项</figcaption></figure><p id="4d47" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">添加上面的致动器依赖关系，并在<code class="fe nn no np nq b">application.yaml</code>中设置下面的配置，以启用<code class="fe nn no np nq b">refresh</code>端点。</p><pre class="kj kk kl km gt nw nq nx ny aw nz bi"><span id="cd82" class="oa mr it nq b gy ob oc l od oe">management.endpoints.web.exposure.include: refresh</span></pre><p id="bd31" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe nn no np nq b">/actuator/refresh</code>端点只刷新由<code class="fe nn no np nq b">@ConfigurationProperties</code>标注的属性。如果我们想要刷新用<code class="fe nn no np nq b">@Value</code>注释的属性，我们必须包含<code class="fe nn no np nq b">@RefreshScope</code>注释。下面是一个使用Restful API用例的例子。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pn po l"/></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">Spring Boot Restful API端点代码示例</figcaption></figure><p id="e841" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在上面的例子中，每当我们更新属性<code class="fe nn no np nq b">my.custom.property</code>时，我们可以使用执行器端点<code class="fe nn no np nq b">/actuator/refresh</code>在config-client中触发刷新。要验证属性是否已经更新，只需点击我们创建的API端点<code class="fe nn no np nq b">/api/print</code>。这是一个简单的用例，目的是向您介绍Spring Cloud Config的<code class="fe nn no np nq b">/refresh</code>特性。</p><p id="3f0c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，在典型的云环境中，会有多个客户机实例，使用<code class="fe nn no np nq b">/actuator/refresh</code>端点刷新每个客户机的配置会非常繁琐。幸运的是，Spring Cloud Bus通过一个轻量级的消息代理(例如Kafka / RabbitMQ)来帮助自动更新属性。我不会在这篇文章中讨论这个问题，但是请自行查看:)</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="4085" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="46ca" class="pw-post-body-paragraph ku kv it kw b kx ni ju kz la nj jx lc ld nk lf lg lh nl lj lk ll nm ln lo lp im bi translated">这是我在使用Spring Cloud Config开发时学到的3个技巧。谢谢你一直读到最后。我希望你能从这篇文章中学到一些新的东西。如果你喜欢这篇文章，请关注我！快乐学习:)</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="c853" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">分级编码</h1><pre class="kj kk kl km gt nw nq nx ny aw nz bi"><span id="2137" class="oa mr it nq b gy ob oc l od oe">Thanks for being a part of our community! More content in the <a class="ae lq" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">Level Up Coding publication</a>.<br/>Follow: <a class="ae lq" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>, <a class="ae lq" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>, <a class="ae lq" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">Newsletter</a></span><span id="01e3" class="oa mr it nq b gy pp oc l od oe">Level Up is transforming tech recruiting<strong class="nq iu"> </strong>👉<strong class="nq iu"> </strong><a class="ae lq" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"><strong class="nq iu">Join our talent collective</strong></a></span></pre></div></div>    
</body>
</html>