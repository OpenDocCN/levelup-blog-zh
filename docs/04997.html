<html>
<head>
<title>How to Backup and Restore your Dockerized Postgres Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何备份和恢复您的Dockerized Postgres数据库</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-backup-and-restore-your-dockerized-postgres-database-a76a11ccf53e?source=collection_archive---------1-----------------------#2020-07-29">https://levelup.gitconnected.com/how-to-backup-and-restore-your-dockerized-postgres-database-a76a11ccf53e?source=collection_archive---------1-----------------------#2020-07-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn js jt ju jv gh gi paragraph-image"><div class="gh gi jr"><img src="../Images/e00efb10c3a1d04ce2eed788cef43cda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EM-900sogIG9CDCic6dJNQ.jpeg"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片通过<a class="ae kc" href="https://www.pexels.com" rel="noopener ugc nofollow" target="_blank">像素</a></figcaption></figure><h1 id="93cb" class="kd ke it bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">介绍</h1><p id="f0e8" class="pw-post-body-paragraph lb lc it ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">随着公司数据量的不断增加，保护数据的任务变得越来越具有挑战性，尤其是在云中。因此，对可靠的备份和恢复解决方案的需求从未像现在这样大。</p><p id="548d" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">据IBM的<a class="ae kc" href="https://www.ibm.com/cloud/learn/backup-and-restore" rel="noopener ugc nofollow" target="_blank">，</a>称，备份和恢复指的是将数据定期复制到单独的辅助设备上，然后在数据由于断电、网络攻击、人为错误或灾难等不同事件而丢失或损坏的情况下，使用这些副本来恢复公司的关键数据的技术和实践。</p><p id="959b" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">本文的目的是解释如何使用由Postgres wiki和s3fs-fuse项目提供的备份脚本将Postgres数据库备份到S3对象存储，我在之前的文章中已经解释过了。它还解释了如何在备份完<em class="me"> </em>后恢复数据库。</p><h1 id="3945" class="kd ke it bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">使用Docker的Postgres数据库</h1><p id="560e" class="pw-post-body-paragraph lb lc it ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">基于<a class="ae kc" href="https://docs.docker.com/get-started/overview/" rel="noopener ugc nofollow" target="_blank"> Docker的官方文件</a>。Docker被定义为一个开发、发布和运行应用程序的开放平台。它提供了在称为容器的隔离环境中打包和运行应用程序的能力。</p><p id="292f" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">一个<a class="ae kc" href="https://www.docker.com/resources/what-container" rel="noopener ugc nofollow" target="_blank">容器</a>是一个标准的软件单元，它封装了代码及其所有的依赖项，因此应用程序可以快速可靠地从一个计算环境运行到另一个计算环境。Docker容器映像是一个轻量级的、独立的、可执行的软件包，包括运行应用程序所需的一切。</p><p id="789f" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">要安装Docker，请按照以下步骤操作Ubuntu:</p><ol class=""><li id="d70a" class="mf mg it ld b le lz li ma lm mh lq mi lu mj ly mk ml mm mn bi translated"><a class="ae kc" href="https://docs.docker.com/engine/install/ubuntu/#prerequisites" rel="noopener ugc nofollow" target="_blank">安装Docker引擎</a></li><li id="f226" class="mf mg it ld b le mo li mp lm mq lq mr lu ms ly mk ml mm mn bi translated"><a class="ae kc" href="https://docs.docker.com/compose/install/" rel="noopener ugc nofollow" target="_blank">安装对接器构成</a></li><li id="515c" class="mf mg it ld b le mo li mp lm mq lq mr lu ms ly mk ml mm mn bi translated"><a class="ae kc" href="https://docs.docker.com/engine/install/linux-postinstall/" rel="noopener ugc nofollow" target="_blank">安装后的设置步骤</a></li></ol><p id="8332" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">一旦完成，您就可以创建<code class="fe mt mu mv mw b">sudo mkdir /opt/docker-compose/; </code>目录并创建<code class="fe mt mu mv mw b">docker-compose.yml</code>文件。在该文件中放入以下内容:</p><figure class="mx my mz na gt jv"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="dab4" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">在这里，我决定定义一个与Camunda平台相关的postgres数据库映像，这样，camunda平台中所有可用的演示数据都将存储在我们的postgres数据库中。在这种情况下，我们的初始数据库不会是空的，所以我们可以直接开始使用它。</p><p id="8a7d" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">然后，在同一个<code class="fe mt mu mv mw b">/opt/docker-compose </code>目录中运行以下命令来创建并运行您的容器:</p><figure class="mx my mz na gt jv"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="3880" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">为了查看存储在数据库中的数据，可以使用CLI或DBeaver。</p><h2 id="ddfe" class="nd ke it bd kf ne nf dn kj ng nh dp kn lm ni nj kr lq nk nl kv lu nm nn kz no bi translated">选项1 : DBeaver</h2><p id="cd6f" class="pw-post-body-paragraph lb lc it ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">按如下方式安装DBeaver:</p><figure class="mx my mz na gt jv"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">DBeaver安装</figcaption></figure><p id="18ec" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">然后将其配置为访问本地postgres数据库。</p><figure class="mx my mz na gt jv gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi np"><img src="../Images/656d8807f793e46dcc0914f5f8d31fad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d_68Sm-s4RGw8mX12kYhoA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">DBeaver。</figcaption></figure><p id="09dd" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">最后，您可以访问您的表格并查看camunda的数据。</p><figure class="mx my mz na gt jv gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/5f0f03064fe0514c5cccc2931418d66d.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/format:webp/1*UIxCpjA87L-MARguOs4xpw.png"/></div></figure><h2 id="8d90" class="nd ke it bd kf ne nf dn kj ng nh dp kn lm ni nj kr lq nk nl kv lu nm nn kz no bi translated">选项2 : CLI</h2><p id="7728" class="pw-post-body-paragraph lb lc it ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">使用以下命令访问postgres数据库:</p><pre class="mx my mz na gt nv mw nw nx aw ny bi"><span id="be42" class="nd ke it mw b gy nz oa l ob oc">docker exec -it postgres psql -U camunda</span></pre><p id="2d07" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">然后运行<code class="fe mt mu mv mw b">\dt</code>命令来显示所有可用的表。</p><h1 id="15ea" class="kd ke it bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">Postgres备份脚本</h1><p id="d422" class="pw-post-body-paragraph lb lc it ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">如<a class="ae kc" href="https://wiki.postgresql.org/wiki/Automated_Backup_on_Linux" rel="noopener ugc nofollow" target="_blank">官方postgres wiki </a>中所定义。我将定义两个主文件:<code class="fe mt mu mv mw b">pg_backup.config </code>和<code class="fe mt mu mv mw b">pg_backup_rotated.sh</code>。</p><figure class="mx my mz na gt jv"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">pg_backup.config</figcaption></figure><p id="31c4" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">确保正确指定:</p><p id="4f8b" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated"><code class="fe mt mu mv mw b">BACKUP_DIR:</code>您的备份将存储在哪里</p><p id="4669" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated"><code class="fe mt mu mv mw b">USERNAME:</code>您数据库的用户名(即camunda)</p><figure class="mx my mz na gt jv"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">pg _备份_旋转. sh</figcaption></figure><p id="5c2f" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">为了执行上述备份脚本，请运行以下命令:</p><pre class="mx my mz na gt nv mw nw nx aw ny bi"><span id="1315" class="nd ke it mw b gy nz oa l ob oc">./opt/docker-compose/pg_backup_rotated.sh</span></pre><p id="9a6c" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">完成后，您可以访问您的备份目录来查看您的postgres备份。</p><blockquote class="od oe of"><p id="c123" class="lb lc me ld b le lz lg lh li ma lk ll og mb lo lp oh mc ls lt oi md lw lx ly im bi translated">如果您希望您的备份存储在云上，在S3对象存储上，您可以查看我的文章<a class="ae kc" href="https://medium.com/swlh/mounting-your-object-storage-bucket-as-a-file-system-on-your-ecs-instance-a878380a3c21" rel="noopener">将您的对象存储桶作为文件系统挂载到您的ECS实例上</a>。然后，您需要修改<code class="fe mt mu mv mw b">pg_backup.config</code>文件，将<code class="fe mt mu mv mw b">BACKUP_DIR</code>目录设置为您安装的S3存储桶。</p></blockquote><p id="bada" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">为了对每天特定时间执行的备份进行编程，您可以使用<code class="fe mt mu mv mw b">crontab -e </code>并添加以下行:</p><pre class="mx my mz na gt nv mw nw nx aw ny bi"><span id="dbc9" class="nd ke it mw b gy nz oa l ob oc">00 00 * * 1 cd /opt/docker-compose; /opt/docker-compose/pg_backup_rotated.sh -c /opt/docker-compose/pg_backup.config</span></pre><p id="1945" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">沿着这条线，我们的数据库将在每周一的午夜被提升。</p><h1 id="32d2" class="kd ke it bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">恢复您的Postgres数据库</h1><p id="6c4f" class="pw-post-body-paragraph lb lc it ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我们的数据库备份将作为<code class="fe mt mu mv mw b">camunda.sql.gz</code>存储在<code class="fe mt mu mv mw b">/backup/</code>中。首先，你需要解压它，这将会给你<code class="fe mt mu mv mw b">camunda.sql</code>。</p><pre class="mx my mz na gt nv mw nw nx aw ny bi"><span id="71ca" class="nd ke it mw b gy nz oa l ob oc">gzip -d camunda.sql.gz</span></pre><p id="8079" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">然后在<code class="fe mt mu mv mw b">/opt/docker-compose/</code>下创建<code class="fe mt mu mv mw b">initdb.d</code>目录并将<code class="fe mt mu mv mw b">camunda.sql</code>放入其中。然后，创建一个新的postgres数据库</p><figure class="mx my mz na gt jv"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="8e9e" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">确保在之前的<code class="fe mt mu mv mw b">docker-compose.yml</code>中创建的旧postgres和camunda已关闭或关闭并删除。</p><pre class="mx my mz na gt nv mw nw nx aw ny bi"><span id="6c5f" class="nd ke it mw b gy nz oa l ob oc"># If you want to stop and remove your stopped containers: <br/>docker stop $(docker ps -a -q) &amp;&amp; docker rm $(docker ps -a -q)</span></pre><p id="727c" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">启动新的postgres容器</p><pre class="mx my mz na gt nv mw nw nx aw ny bi"><span id="4873" class="nd ke it mw b gy nz oa l ob oc">docker-compose up -d </span></pre><p id="0eab" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">在postgres容器的创建过程中，将执行<code class="fe mt mu mv mw b">docker-entrypoint-initdb.d</code>来填充数据库，它包含已挂载的<code class="fe mt mu mv mw b">camunda.sql</code>。</p><p id="8192" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">访问您的postgres数据库:</p><pre class="mx my mz na gt nv mw nw nx aw ny bi"><span id="4ca6" class="nd ke it mw b gy nz oa l ob oc">docker exec -it postgres psql -U camunda</span></pre><p id="ba36" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">运行<code class="fe mt mu mv mw b">\dt</code>来验证您已经备份了所有丢失的表。</p><p id="c78a" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated">最后，对于本教程，您可以运行以下命令来停止和删除docker容器:</p><pre class="mx my mz na gt nv mw nw nx aw ny bi"><span id="85f2" class="nd ke it mw b gy nz oa l ob oc">docker stop $(docker ps -a -q) &amp;&amp; docker rm $(docker ps -a -q) &amp;&amp; docker ps </span></pre><h1 id="bc35" class="kd ke it bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">参考资料:</h1><p id="df16" class="pw-post-body-paragraph lb lc it ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated"><a class="ae kc" href="https://wiki.postgresql.org/wiki/Automated_Backup_on_Linux" rel="noopener ugc nofollow" target="_blank">Linux上的自动备份</a></p><p id="c5ef" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated"><a class="ae kc" href="https://medium.com/@mohammedhammoud/how-to-backup-and-restore-postgresql-database-using-pg-dump-and-pg-restore-c340427e46e2" rel="noopener">如何使用pg_dump和pg_restore备份和恢复PostgreSQL数据库</a></p><p id="1a1e" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated"><a class="ae kc" href="https://gist.github.com/gilyes/525cc0f471aafae18c3857c27519fc4b" rel="noopener ugc nofollow" target="_blank">备份、恢复docker容器中的postgres</a></p><p id="ea72" class="pw-post-body-paragraph lb lc it ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly im bi translated"><a class="ae kc" href="https://medium.com/@wkrzywiec/database-in-a-docker-container-how-to-start-and-whats-it-about-5e3ceea77e50" rel="noopener">Docker容器中的数据库——如何启动以及它有什么作用</a></p></div></div>    
</body>
</html>