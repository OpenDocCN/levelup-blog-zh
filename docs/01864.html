<html>
<head>
<title>Building your own SMS Serverless API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建您自己的SMS无服务器API</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/building-your-own-sms-serverless-api-c8d09c0b65eb?source=collection_archive---------12-----------------------#2020-02-03">https://levelup.gitconnected.com/building-your-own-sms-serverless-api-c8d09c0b65eb?source=collection_archive---------12-----------------------#2020-02-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/41c3845b0038ea05e302e69f73710d64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Yywz2qP79BcS6wpT"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@ninjason?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">梁杰森</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="5b7f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">比方说，您有一个特定的需求或任务，您需要向您的用户发送并发的SMS消息。如果你很务实，不想重新发明轮子，你很可能会使用像<a class="ae kf" href="https://www.twilio.com/sms" rel="noopener ugc nofollow" target="_blank"> Twilio </a>或<a class="ae kf" href="https://www.messagebird.com/en/sms" rel="noopener ugc nofollow" target="_blank"> MessageBird </a>这样的服务。</p><p id="4f3d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但也有可能出于某种原因，您需要构建自己的解决方案。也许您更喜欢构建自己的价格更具竞争力的解决方案，或者您只是想通过一个已定义的使用案例来了解更多关于无服务器的信息。</p><p id="4cea" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果以上任何一个对你来说都是真的，那么让我们看看如何在AWS上构建你自己的无服务器API来发送SMS消息到世界上的任何电话号码。</p><h1 id="56fe" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">开始前</h1><p id="8d0a" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">您需要在机器上安装以下工具:</p><ul class=""><li id="0fd0" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated"><a class="ae kf" href="https://docs.npmjs.com/cli/install" rel="noopener ugc nofollow" target="_blank"><strong class="ki iu"/></a><strong class="ki iu"/>可通过您的CLI控制台访问。</li><li id="8be7" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><a class="ae kf" href="https://serverless.com/framework/docs/providers/aws/guide/installation/" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">无服务器框架</strong> </a> <strong class="ki iu">，</strong>全球安装，可通过您的CLI控制台访问。</li><li id="78d7" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">一个<a class="ae kf" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu"> AWS账户</strong> </a>，一个IAM用户，拥有为您的CLI或控制台配置的<a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html" rel="noopener ugc nofollow" target="_blank">凭证。</a></li><li id="8939" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">一个<a class="ae kf" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu"> AWS用户角色</strong> </a>来执行您的lambda，拥有以下权限:<br/> * AWS SNS访问<br/> * AWS DynamoDB访问<br/> * CloudWatch日志创建</li></ul><p id="0c61" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您也可以<a class="ae kf" href="https://serverless.com/framework/docs/providers/aws/guide/iam/" rel="noopener ugc nofollow" target="_blank">在您的无服务器配置</a>中设置角色。从安全角度来看，在更安全的流程中生成角色访问可能更好，但这超出了本文的范围。</p><h1 id="6f8d" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">建筑</h1><figure class="mw mx my mz gt ju gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/a4d1e4bcc77602975cd64f7154effc22.png" data-original-src="https://miro.medium.com/v2/resize:fit:586/format:webp/1*p4QlpPJhYxfaXX_pbA5WGw.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">无服务器SMS API体系结构</figcaption></figure><p id="f0fb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要发送我们的短信，我们将使用<a class="ae kf" href="https://docs.aws.amazon.com/sns/latest/dg/sms_publish-to-phone.html" rel="noopener ugc nofollow" target="_blank"> AWS SNS " <em class="na">发布到手机</em> </a>"来发送我们的消息，因此我们可以委托发送短信。我们还需要一个<a class="ae kf" href="https://docs.aws.amazon.com/apigateway/" rel="noopener ugc nofollow" target="_blank"> AWS API网关</a>来向世界或其他应用程序公开我们的服务。我们将需要2个lambda函数来执行我们的定制业务逻辑。</p><p id="98c2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们需要一个数据库来存储发送的消息，以便我们可以在以后查询或审计这些消息，实际上，这可以是任何数据库，但为了易于部署我们的无服务器架构，我们将使用<a class="ae kf" href="https://aws.amazon.com/dynamodb/" rel="noopener ugc nofollow" target="_blank"> AWS Dynamo DB </a>。</p><h1 id="7eff" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">初始配置</h1><p id="d4f0" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">首先，您需要初始化您的项目，将这个NPM配置复制到您的<strong class="ki iu">包中</strong></p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="bc99" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后运行命令安装依赖项:</p><pre class="mw mx my mz gt nd ne nf ng aw nh bi"><span id="732d" class="ni lf it ne b gy nj nk l nl nm">$ npm install</span></pre><p id="8f26" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们使用<strong class="ki iu"> <em class="na"> AWS SDK </em> </strong>连接到AWS，使用<strong class="ki iu"> <em class="na"> moment </em> </strong>和<strong class="ki iu"> <em class="na"> uuid </em> </strong>包为数据库中的记录生成日期和id。</p><h1 id="c32a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">无服务器配置</h1><p id="6a22" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">现在创建一个<strong class="ki iu"> serverless.yml </strong>文件，并使用以下信息:</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="81a5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请确保您还将信息更新为与您当前的AWS帐户和地区相匹配的信息。确保执行角色使用您之前创建的角色的ARN。</p><p id="3c47" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们设置了两个函数，一个是<strong class="ki iu"> <em class="na"> send </em> </strong>函数，它将处理发送SMS的逻辑。以及一个<strong class="ki iu"> <em class="na">历史</em> </strong>函数，我们将用它来查询已发送的消息。</p><p id="522d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用无服务器框架的<a class="ae kf" href="https://serverless.com/framework/docs/providers/aws/events/apigateway/" rel="noopener ugc nofollow" target="_blank">魔法，只需声明<strong class="ki iu"> <em class="na"> http </em> </strong>事件，就会自动创建一个API网关作为我们堆栈的一部分，具有两个端点，即在<strong class="ki iu"> <em class="na">路径</em> </strong>配置下指定的端点。这些端点将触发lambda函数；</a></p><p id="1e0d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为我们需要一个Dynamo DB，所以我们也可以用我们的无服务器配置来创建它。然而，在这种情况下，为了保持我们的配置文件有组织和干净，我们将把它移到一个<a class="ae kf" href="https://github.com/foxxor/aws-sms-api/blob/master/resources/dynamodb.yml" rel="noopener ugc nofollow" target="_blank">资源配置文件</a>中来声明组件。然后在配置中，我们只需导入资源文件。</p><p id="11dc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">声明了所有的资源和组件后，我们现在可以实现应用程序的逻辑了。</p><h1 id="603a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">应用代码</h1><h2 id="3ef2" class="ni lf it bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">项目结构</h2><p id="213e" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为了保持代码的整洁，我们将以下面的方式构建代码，试图分离关注点，并使应用程序易于维护和测试。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/d9e7c5c29edce9ee8154d3e243b7c792.png" data-original-src="https://miro.medium.com/v2/resize:fit:638/format:webp/1*1YNSFtUqqBkRKrz7oSrXuA.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">项目文件结构</figcaption></figure><p id="751e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您不需要遵循相同的结构，但是在这个例子中，我将把任何执行外部调用的逻辑移动到它们自己的类文件中。数据库调用的适配器和SMS请求的服务。</p><p id="5780" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">lambda函数将在同一个文件中，但是您也可以为每个lambda使用单独的文件。在这种情况下，由于两个函数的配置是相同的，我将把它们放在一起。</p><h2 id="a90b" class="ni lf it bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">外部呼叫类别</h2><p id="1e26" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们将实现的第一个类是我们的SMS服务，它将初始化AWS SDK并使用SMS数据调用SNS <em class="na"> publish </em>方法。然后，AWS将发送SMS并返回消息ID，然后应用程序将存储它，以便以后与历史端点一起使用。</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">短信服务</figcaption></figure><p id="a20a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于数据库适配器类，我们需要再次调用AWS SDK来初始化Dynamo DB调用。和2个函数，一个创建记录，另一个能够使用电话号码查询数据库。</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="3580" class="ni lf it bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">λ函数</h2><p id="8d70" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">首先，我们需要包含我们已经创建的服务和适配器，并初始化我们需要的配置，以调用AWS服务。之后，我们可以添加lambda函数。</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="87dd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为我们正在处理API网关HTTP请求和响应，所以我们将接收到一个<em class="na"> HTTP </em>数据对象，而不是一个事件，这个数据对象包含发送到我们API的请求数据。</p><p id="c3c5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们用先前定义的配置初始化这些类，然后我们验证消息和电话号码是否被正确接收。否则，lambda将返回400 HTTP错误代码，因为请求无效。</p><p id="8300" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们调用SMS服务来发送SMS，并使用服务将记录存储在DynamoDB中。</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="2ac4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于历史lambda，我们做了类似的处理，但是这次我们验证了提供了<strong class="ki iu"> <em class="na">电话号码</em> </strong>。并调用适配器来检索所有相关的记录。</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h1 id="943e" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">部署</h1><p id="7b06" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">既然已经定义了所有的应用程序，我们只需要部署它:</p><pre class="mw mx my mz gt nd ne nf ng aw nh bi"><span id="883c" class="ni lf it ne b gy nj nk l nl nm">$ serverless deploy</span></pre><p id="242e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">部署完成后，您将看到以下信息:</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/002bea51771506b4c5c3d2537ceee5d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RsG49SUcmXHnCWZqJhcLJQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">无服务器框架部署</figcaption></figure><ul class=""><li id="bb6e" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">关于由无服务器框架创建的CloudFormation堆栈的一般信息</li><li id="4a1b" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">已部署资源的数量(S3部署桶、lambdas、DynamoDB、SNS队列等。)</li><li id="ba26" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">指向您的端点的URL</li><li id="0d1d" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">lambda函数名称</li></ul><p id="e0fb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您可以开始使用您的API，只需调用端点传递适当的数据，SMS消息应该会立即发送。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oa"><img src="../Images/a6a7453b51dbb346c6cc135ab9fcf90b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*smgXehwa1S4ebausnCj6Vg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">API发送消息调用</figcaption></figure><p id="00fc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">瞧，我收到了一条手机短信。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ob"><img src="../Images/aec628739461abcc523c624db96f92f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qa7Cfes8-3MQ_cL6j_ZFvA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">短信捕获</figcaption></figure><p id="5623" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">也可以根据我之前发消息用的电话号码查询历史:</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oc"><img src="../Images/0bf58bb485bb58f0410c8ac43664f9ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XnMBNxiec9EWj99H7d9NJA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">API历史查询调用</figcaption></figure></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><p id="a4df" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样！您现在可以从自己的无服务器应用程序轻松发送SMS消息。</p><p id="ff08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以在我的GitHub库中找到这个项目的副本<a class="ae kf" href="https://github.com/foxxor/aws-sms-api" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>