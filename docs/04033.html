<html>
<head>
<title>Idiomatic TensorFlow on Android — Get started with the TensorFlow Support Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android上的惯用TensorFlow—开始使用tensor flow支持库</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/idiomatic-tensorflow-on-android-get-started-with-the-tensorflow-support-library-c12fe96bc029?source=collection_archive---------8-----------------------#2020-06-06">https://levelup.gitconnected.com/idiomatic-tensorflow-on-android-get-started-with-the-tensorflow-support-library-c12fe96bc029?source=collection_archive---------8-----------------------#2020-06-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/093446a654a9125bc68382081d7a8d9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xjsEPItNww_khr8o2me-xg.png"/></div></div></figure><h1 id="d43a" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">在Android上处理数据不方便！</h1><p id="5d3d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">如果您以前在Android上使用过TensorFlow Lite，那么您可能必须处理预处理数据的繁琐任务，在静态类型语言中使用<code class="fe lu lv lw lx b">Float</code>数组，或者在数据适合模型消费之前调整大小、转换、规范化和执行任何其他标准任务。</p><p id="26b6" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">嗯，不会再有了！<a class="ae md" href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/lite/experimental/support/java" rel="noopener ugc nofollow" target="_blank"> TFLite支持库</a> nightly现已可用，在这篇文章中，我们将回顾它的用法并围绕<code class="fe lu lv lw lx b">tflite</code>模型构建一个包装器。</p><blockquote class="me mf mg"><p id="36c0" class="kw kx mh ky b kz ly lb lc ld lz lf lg mi ma lj lk mj mb ln lo mk mc lr ls lt ij bi translated"><strong class="ky ir">注意:</strong>这篇文章的配套资源库<a class="ae md" href="https://github.com/ATechnoHazard/object-detection-yolo" rel="noopener ugc nofollow" target="_blank">在这里</a>可以找到。跟随，或者直接跳到源头！</p></blockquote><p id="0176" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">非常感谢<a class="ml mm ep" href="https://medium.com/u/46b642aa7f12?source=post_page-----c12fe96bc029--------------------------------" rel="noopener" target="_blank"> Tanmay Thakur </a>和<a class="ml mm ep" href="https://medium.com/u/d1a8d99d1836?source=post_page-----c12fe96bc029--------------------------------" rel="noopener" target="_blank"> Ubaid Usmani </a>对python实现的帮助。没有他们的帮助，这是不可能的。</p><h1 id="3744" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">这篇文章的范围</h1><p id="3a2d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这篇文章仅限于围绕<code class="fe lu lv lw lx b">tflite</code>模型加载和创建一个包装类；但是，您可以在上面链接的存储库中看到一个功能完整的项目。代码被自由地注释并且非常简单。</p><p id="fa34" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">如果您还有任何疑问，请随时联系我并发表评论。我很乐意帮助你。</p><h1 id="0a18" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">设置项目</h1><p id="ba0b" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们将在Android设备上部署流行的YOLOv3对象检测模型的<a class="ae md" href="https://github.com/ATechnoHazard/yolo-tflite" rel="noopener ugc nofollow" target="_blank"> TFLite版本</a>。事不宜迟，让我们开始吧。</p><p id="82c9" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">使用Android Studio创建一个新项目，随意命名，然后等待初始的<code class="fe lu lv lw lx b">gradle</code>同步完成。接下来，我们将安装依赖项。</p><h2 id="feba" class="mn jz iq bd ka mo mp dn ke mq mr dp ki lh ms mt km ll mu mv kq lp mw mx ku my bi translated">添加依赖关系</h2><p id="fdcd" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">将以下依赖项添加到您的应用程序级<code class="fe lu lv lw lx b">build.gradle</code>。</p><figure class="mz na nb nc gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="8676" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">让我们看看它们是什么，以及我们为什么需要它们。</p><ol class=""><li id="c65a" class="nf ng iq ky b kz ly ld lz lh nh ll ni lp nj lt nk nl nm nn bi translated"><strong class="ky ir">快速许可</strong>:这是一个很棒的库，可以快速简单地授予许可。</li><li id="10bf" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated"><strong class="ky ir"> Tensorflow Lite </strong>:这是核心的TFLite库。</li><li id="51f3" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated"><strong class="ky ir"> Tensorflow Lite支持</strong>:这是我们将用来简化数据相关任务的支持库。</li><li id="db38" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">这是一个库，提供了一个简单的API来访问相机。</li></ol><h2 id="3713" class="mn jz iq bd ka mo mp dn ke mq mr dp ki lh ms mt km ll mu mv kq lp mw mx ku my bi translated">配置gradle项目</h2><p id="be07" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在我们为代码做好准备之前，我们的项目还需要一些配置。在应用级<code class="fe lu lv lw lx b">build.gradle</code>文件中，在<code class="fe lu lv lw lx b">android</code>块下添加以下选项。</p><figure class="mz na nb nc gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="9866" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">我们需要添加这个的原因是因为我们将在我们的资产中运输模型，这在默认情况下会压缩它。这是一个问题，因为解释器不能加载压缩模型。</p><blockquote class="me mf mg"><p id="4b7e" class="kw kx mh ky b kz ly lb lc ld lz lf lg mi ma lj lk mj mb ln lo mk mc lr ls lt ij bi translated"><strong class="ky ir">注意:</strong>完成初始配置后，再次运行<code class="fe lu lv lw lx b">gradle</code>同步以获取所有依赖项。</p></blockquote><h1 id="2abf" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">进入代码</h1><p id="3a60" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">先做最重要的事情；我们需要一个模型来加载。我用的那个可以在这里找到<a class="ae md" href="https://raw.githubusercontent.com/ATechnoHazard/yolo-tflite/master/models/detect.tflite" rel="noopener ugc nofollow" target="_blank">。将模型放入<code class="fe lu lv lw lx b">app/src/main/assets</code>内。这将使我们能够在运行时加载它。</a></p><p id="4fcb" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">检测到的物体的标签可以在<a class="ae md" href="https://raw.githubusercontent.com/ATechnoHazard/object-detection-yolo/master/app/src/main/assets/labelmap.txt" rel="noopener ugc nofollow" target="_blank">这里</a>找到。将它们放在与模型相同的目录中。</p><blockquote class="me mf mg"><p id="bc89" class="kw kx mh ky b kz ly lb lc ld lz lf lg mi ma lj lk mj mb ln lo mk mc lr ls lt ij bi translated"><strong class="ky ir">警告:</strong>如果你打算使用自己定制的车型，一句忠告；输入和输出形状可能与此项目中使用的形状不匹配。</p></blockquote><h2 id="7fc0" class="mn jz iq bd ka mo mp dn ke mq mr dp ki lh ms mt km ll mu mv kq lp mw mx ku my bi translated">创建包装类</h2><p id="ef5a" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们将把我们的模型及其相关方法包装在一个名为<code class="fe lu lv lw lx b">YOLO</code>的类中。初始代码如下。</p><figure class="mz na nb nc gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="4855" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">让我们把这个类分解成它的核心功能和行为。</p><ol class=""><li id="0990" class="nf ng iq ky b kz ly ld lz lh nh ll ni lp nj lt nk nl nm nn bi translated">首先，创建后，该类通过支持库提供的<code class="fe lu lv lw lx b">FileUtil</code>类从app <code class="fe lu lv lw lx b">assets</code>加载模型。</li><li id="bf89" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">接下来，我们有一个班级成员。<code class="fe lu lv lw lx b">interpreter</code>是不言自明的，它是一个TFLite解释器的实例。</li><li id="ed62" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">最后，我们有一些静态变量。这些只是模型的文件名和我们的<code class="fe lu lv lw lx b">assets</code>里面的标签。</li></ol><p id="2c98" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">继续，让我们添加一个方便的方法来从<code class="fe lu lv lw lx b">assets</code>加载我们的标签。</p><figure class="mz na nb nc gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="361d" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">在这里，我们声明了一个方法，该方法加载标签文件并将成员变量延迟初始化为返回值。</p><p id="c346" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">让我们言归正传。我们现在要定义一个方法，它接收一个位图，将其传递到模型中，并返回检测到的对象类。</p><figure class="mz na nb nc gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="5434" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">哇，那是一堵代码墙！我们来过一遍，分解一下。</p><p id="79e1" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">我们已经声明了一些新的惰性初始化变量；一个<code class="fe lu lv lw lx b">ImageProcessor</code>和一个<code class="fe lu lv lw lx b">TensorImage</code>。这些是由支持库公开的类，使得加载图像和处理图像更加简单。</p><p id="c1ae" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">如此处所示，我们可以将一个<code class="fe lu lv lw lx b">bitmap</code>直接加载到<code class="fe lu lv lw lx b">TensorImage</code>中，然后将其传递给<code class="fe lu lv lw lx b">ImageProcessor</code>进行进一步处理。</p><p id="2980" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated"><code class="fe lu lv lw lx b">ImageProcessor</code>有几个可用的操作，但是我们在这里使用的是将我们的输入图像调整到300 * 300。这是因为我们的模型的输入大小需要300 * 300的图像。</p><p id="ce28" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">处理完图像后，我们创建几个<code class="fe lu lv lw lx b">TensorBuffers</code>。这些是张量的表示，我们可以很容易地操作和访问。这些<code class="fe lu lv lw lx b">TensorBuffers</code>的形状由模型决定。查看模型摘要，找出合适的形状。</p><p id="aaba" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">我们将<code class="fe lu lv lw lx b">TensorImage</code>加载到输入<code class="fe lu lv lw lx b">TensorBuffer</code>中，然后将输入和输出缓冲区传递给解释器。</p><blockquote class="me mf mg"><p id="d4d7" class="kw kx mh ky b kz ly lb lc ld lz lf lg mi ma lj lk mj mb ln lo mk mc lr ls lt ij bi translated"><strong class="ky ir">注:</strong>yolo v3型号有多个输出。这就是我们必须使用多个输出缓冲器的原因。</p></blockquote><p id="842e" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">运行推理后，解释器设置输出缓冲区的内部<code class="fe lu lv lw lx b">FloatArrays</code>。现在，我们只对包含预测类的那个感兴趣。使用方便的kotlin <code class="fe lu lv lw lx b">map</code>函数，我们将标签映射到模型输出的数值类并返回它们。</p><p id="e722" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">这个类现在可以被我们的应用程序用来在一个<code class="fe lu lv lw lx b">bitmap</code>上运行推理。多方便啊！</p><h1 id="d946" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="6c53" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">就是这样！与不使用支持库的项目相比；我们将编写更多的代码来调整图像的大小，将位图转换成<code class="fe lu lv lw lx b">float</code>数组，手动分配浮点数组来存储输出，等等。</p><p id="5abe" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">TensorFlow支持库因此简化了开发人员的工作；尽管是夜间播放，但以我的经验来看，它相当稳定。</p><p id="5c15" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">要了解更多信息，请查看支持库<code class="fe lu lv lw lx b">readme</code> <a class="ae md" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/experimental/support/java/README.md" rel="noopener ugc nofollow" target="_blank">此处</a>。到目前为止，还没有任何正式的文档，但是<code class="fe lu lv lw lx b">readme</code>包含了开发者快速入门所需的所有信息。</p><p id="6ad6" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">注意安全，玩得开心！</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><div class="mz na nb nc gt oa"><a href="https://skilled.dev" rel="noopener  ugc nofollow" target="_blank"><div class="ob ab fo"><div class="oc ab od cl cj oe"><h2 class="bd ir gy z fp of fr fs og fu fw ip bi translated">编写面试问题</h2><div class="oh l"><h3 class="bd b gy z fp of fr fs og fu fw dk translated">一个完整的平台，在这里我会教你找到下一份工作所需的一切，以及…</h3></div><div class="oi l"><p class="bd b dl z fp of fr fs og fu fw dk translated">技术开发</p></div></div><div class="oj l"><div class="ok l ol om on oj oo jw oa"/></div></div></a></div></div></div>    
</body>
</html>