<html>
<head>
<title>PostgreSQL restore-ready Docker image</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PostgreSQL恢复就绪Docker映像</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/postgresql-restore-ready-docker-image-7001a54400e9?source=collection_archive---------13-----------------------#2020-01-15">https://levelup.gitconnected.com/postgresql-restore-ready-docker-image-7001a54400e9?source=collection_archive---------13-----------------------#2020-01-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c4635d8b8dd5cb8d2802eebc7e646c42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XBc_Q8_bYt57VQNj"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kc" href="https://unsplash.com/@victoire_jonch?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Victoire Joncheray </a>拍摄的照片</figcaption></figure><p id="dfc4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇文章旨在分享我在个人项目中创建的PostgreSQL恢复就绪映像。很简单，只有几行字。</p><p id="1926" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，您可以从我的<a class="ae kc" href="https://github.com/diegohordi/pgsql-restore-ready-image.git" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中克隆或下载本文中使用的Dockerfile和bash脚本。</p><p id="9b3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了构建新的映像，我们扩展了Docker Hub 上最新的<a class="ae kc" href="https://hub.docker.com/_/postgres" rel="noopener ugc nofollow" target="_blank"> Postgres映像，并复制了一个bash文件，其中包含创建新数据库的指令，并使用给定的备份文件恢复它。</a></p><p id="0398" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们把手弄脏吧！</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h2 id="174e" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">文档文件</h2><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="a983" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在第1行，我们扩展了<a class="ae kc" href="https://hub.docker.com/_/postgres" rel="noopener ugc nofollow" target="_blank">最新的官方Postgres映像</a>，从第2行到第5行，我们创建了build-args和环境变量，我们将在bash文件中使用它们来恢复数据库。在第6行，我们创建了卷，在第8行，我们将通过build-args传递的给定备份文件复制到创建的卷。在#10，我们将bash文件复制到图像的入口点。在第11行(如果你使用的是Windows ),我们将bash文件最后一行的字符从DOS转换到Unix。在第12行，我们授予bash文件正确运行的权利。最后，我们向主机公开PostgreSQL的默认端口5432。</p><h2 id="866e" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">bash文件</h2><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="57df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在第3行，我们使用postgres用户创建了具有给定名称的数据库。在#4，我们恢复数据库，在#5，我们授予用户postgres对所创建的数据库的权限。第2行和第6行只是为了报告状态。</p><h2 id="7a74" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">建立形象</h2><p id="7c4c" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">要构建映像，只需从放置Dockerfile的目录中执行下面的代码，替换您想要的名称和标记的<tag-name>，备份文件的名称的<backup-file-name>，最后是您想要恢复的数据库的名称的<database-name>。</database-name></backup-file-name></tag-name></p><p id="2383" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了简单起见，我建议您将备份文件放在Dockerfile的同一个目录中。</p><pre class="mb mc md me gt mm mn mo mp aw mq bi"><span id="e1a6" class="li lj iq mn b gy mr ms l mt mu">docker build -t &lt;image-name:tag-name&gt; . --build-arg FILE=&lt;backup-file-name&gt; --build-arg DBNAME=&lt;database-name&gt;</span></pre><h2 id="612f" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">创建容器</h2><p id="e53b" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">要创建容器，执行下面的代码，替换您想要的名称的<container-name>，您想要用来访问数据库的端口的<port-number>，以及您的映像名称的<tag-name>。</tag-name></port-number></container-name></p><pre class="mb mc md me gt mm mn mo mp aw mq bi"><span id="f718" class="li lj iq mn b gy mr ms l mt mu">docker run -d --name &lt;container-name&gt; -p &lt;port-number&gt;:5432 &lt;image-name:tag-name&gt;</span></pre><h2 id="5e64" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">访问数据库</h2><p id="ef8c" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">要从您的容器的主机访问数据库，只需使用主机<strong class="kf ir"> localhost </strong>和您在用户<strong class="kf ir"> postgres </strong>的&lt;端口号&gt;中给出的端口号，无需密码。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h2 id="ae66" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">结论</h2><p id="55ad" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">在这篇文章中，我分享了如何通过一个简单的恢复命令来扩展官方Postgres映像，允许您在容器准备就绪后立即访问数据库。</p><p id="661c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我用它来节省短时间项目的时间和资源，但是您可以扩展它并执行其他命令，例如vacuum。</p><p id="5f16" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢您的阅读，如果您有任何问题，请联系我。=)</p><h2 id="ceb3" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">参考</h2><p id="d921" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated"><a class="ae kc" href="https://docs.docker.com/engine/reference/commandline/build/" rel="noopener ugc nofollow" target="_blank"> Docker构建参考指南</a></p><p id="b64b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://docs.docker.com/engine/reference/commandline/run/" rel="noopener ugc nofollow" target="_blank">码头工人运行参考指南</a></p><p id="0068" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://hub.docker.com/_/postgres" rel="noopener ugc nofollow" target="_blank"> Postgres官方形象</a></p><p id="b1f7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://www.postgresql.org/docs/9.2/app-pgrestore.html" rel="noopener ugc nofollow" target="_blank">pg _ restore参考指南</a></p></div></div>    
</body>
</html>