<html>
<head>
<title>Best Practices for WebAssembly using GoLang (1.15+)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GoLang (1.15+版)进行WebAssembly的最佳实践</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/best-practices-for-webassembly-using-golang-1-15-8dfa439827b8?source=collection_archive---------6-----------------------#2020-12-06">https://levelup.gitconnected.com/best-practices-for-webassembly-using-golang-1-15-8dfa439827b8?source=collection_archive---------6-----------------------#2020-12-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4818" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">减小二进制文件的大小</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/192c2a7b646d0c7834bf945ff87e4289.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gHJUvm9wb2ayqYu9Ju1i1g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">与<a class="ae ky" href="https://www.canva.com/" rel="noopener ugc nofollow" target="_blank"> Canva </a>合影。</figcaption></figure><p id="2a38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://cesarwilliam.medium.com/how-to-run-golang-1-15-code-in-a-browser-using-webassembly-e755bc733e8d" rel="noopener">在我的上一篇文章</a>中，我展示了如何通过GoLang配置、开发和生成WASM文件。在这篇文章中，我将向你展示<strong class="lb iu">最佳实践</strong>以及如何在一个真实的<strong class="lb iu">现代网络项目</strong>中使用这些策略。</p><h1 id="d810" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">为什么要减小二进制文件的大小</h1><p id="372f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">如果您已经使用Go生成了一个web assembly二进制文件，您可能已经注意到文件有多大了。当我们在网页上加载这个二进制文件时，它会影响页面上其他资源的加载。它也能影响交互时间(TTI)。TTI测量了一个页面完全交互需要多长时间。较长的TTI会给用户带来令人沮丧的体验，比如，网站看起来已经准备好了，但当用户试图与之交互时，却什么也没发生。</p><p id="db1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将向您展示两种生成较小二进制文件的策略。第一种(大多数情况下推荐)是使用<a class="ae ky" href="https://www.gzip.org/" rel="noopener ugc nofollow" target="_blank"> gzip </a>，另一种是使用名为<a class="ae ky" href="https://tinygo.org/" rel="noopener ugc nofollow" target="_blank"> TinyGo </a>的编译器。</p><h1 id="b47d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">使用gzip(推荐)</strong></h1><p id="27db" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Gzip是一种文件格式和软件应用程序，在Unix和类似Unix的系统上使用，用于在将HTTP内容提供给客户端之前对其进行压缩。我们将在编译Go文件后使用<code class="fe mt mu mv mw b">gzip</code>命令。</p><p id="e51e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用这个Go文件(<a class="ae ky" href="https://cesarwilliam.medium.com/how-to-run-golang-1-15-code-in-a-browser-using-webassembly-e755bc733e8d" rel="noopener">来自我的上一篇文章</a>)作为例子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><h2 id="5a09" class="mz lw it bd lx na nb dn mb nc nd dp mf li ne nf mh lm ng nh mj lq ni nj ml nk bi translated">编译我们的围棋代码</h2><p id="c67f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在我们全力以赴进行gzip压缩之前，我们可以做一些事情来使二进制文件变得更小:剥离它们。</p><p id="6a88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以<strong class="lb iu">使用</strong> <a class="ae ky" href="https://golang.org/cmd/link/" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> -s和-w链接器标志</strong> </a>来剥离调试信息，如下所示:</p><pre class="kj kk kl km gt nl mw nm nn aw no bi"><span id="1485" class="mz lw it mw b gy np nq l nr ns">GOOS=js GOARCH=wasm go build -ldflags="-s -w" -o main.wasm</span></pre><p id="c790" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个策略中，我们将使用我在上一篇关于WebAssembly 的文章中生成的相同的Wasm JavaScript加载器:</p><pre class="kj kk kl km gt nl mw nm nn aw no bi"><span id="d208" class="mz lw it mw b gy np nq l nr ns">$ cp “$(go env GOROOT)/misc/wasm/wasm_exec.js” .</span></pre><h2 id="6358" class="mz lw it bd lx na nb dn mb nc nd dp mf li ne nf mh lm ng nh mj lq ni nj ml nk bi translated">压缩Wasm文件</h2><p id="e471" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了<em class="ms"> gzip </em>我们编译的文件<code class="fe mt mu mv mw b">main.wasm</code>，我们将使用以下命令:</p><pre class="kj kk kl km gt nl mw nm nn aw no bi"><span id="1451" class="mz lw it mw b gy np nq l nr ns">gzip -9 -v -c main.wasm &gt; main.wasm.gz</span></pre><h2 id="5f5f" class="mz lw it bd lx na nb dn mb nc nd dp mf li ne nf mh lm ng nh mj lq ni nj ml nk bi translated">创建HTML文件</h2><p id="6f3b" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了在HTML文档中使用压缩的二进制文件，我们必须对gzip压缩文件进行解压缩(或<em class="ms"> ungzip </em>)。为此，我们可以使用<a class="ae ky" href="https://github.com/nodeca/pako" rel="noopener ugc nofollow" target="_blank"> Pako JS库</a>，然后像往常一样实例化我们的Go程序。首先，我们将从CDN导入Pako库，然后使用<code class="fe mt mu mv mw b">ungzip</code>函数来扩展我们的文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="d56d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是一个完整的HTML文件的例子，它使用了Wasm(编译自我们在上一篇文章中创建的Go文件),由gzip压缩:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="f7ac" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用TinyGo</h1><p id="f3d1" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">TinyGo是一个为小地方开发的Go编译器。TinyGo并不打算编译任何可能的围棋程序。编译器无需修改就能编译大多数Go程序。<a class="ae ky" href="https://tinygo.org/lang-support/" rel="noopener ugc nofollow" target="_blank">支持的大多数语言特性</a>，包括:<em class="ms">切片</em>、<em class="ms">接口</em>、<em class="ms">闭包</em>和<em class="ms">绑定方法</em>。</p><blockquote class="nt"><p id="4d64" class="nu nv it bd nw nx ny nz oa ob oc lu dk translated">TinyGo是一个用于小地方的Go编译器。它重用了<a class="ae ky" href="https://golang.org/pkg/go/" rel="noopener ugc nofollow" target="_blank"> Go语言工具</a>和<a class="ae ky" href="http://llvm.org/" rel="noopener ugc nofollow" target="_blank"> LLVM </a>使用的库，提供了一种编译用Go编程语言编写的程序的替代方法。</p></blockquote><h2 id="451b" class="mz lw it bd lx na od dn mb nc oe dp mf li of nf mh lm og nh mj lq oh nj ml nk bi translated"><strong class="ak">安装TinyGo </strong></h2><p id="ad49" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">上面的命令将使用<em class="ms"> brew </em>在macOS上安装TinyGo。在这里你可以找到<a class="ae ky" href="https://tinygo.org/getting-started/linux" rel="noopener ugc nofollow" target="_blank"> Linux </a>、<a class="ae ky" href="https://tinygo.org/getting-started/macos" rel="noopener ugc nofollow" target="_blank"> macOS </a>、<a class="ae ky" href="https://tinygo.org/getting-started/windows" rel="noopener ugc nofollow" target="_blank"> Windows </a>和<a class="ae ky" href="https://tinygo.org/getting-started/using-docker" rel="noopener ugc nofollow" target="_blank"> Docker </a>的使用说明。</p><pre class="kj kk kl km gt nl mw nm nn aw no bi"><span id="f0aa" class="mz lw it mw b gy np nq l nr ns">$ <!-- -->brew tap tinygo-org/tools<br/>$ brew install tinygo</span></pre><h2 id="b474" class="mz lw it bd lx na nb dn mb nc nd dp mf li ne nf mh lm ng nh mj lq ni nj ml nk bi translated"><strong class="ak">生成Wasm JavaScript加载程序</strong></h2><p id="ae7d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在我的上一篇文章中，我向你展示了当你使用默认的Go编译器时，如何生成Wasm JavaScript loader。当您使用TinyGo时，您必须以这种方式生成加载程序:</p><pre class="kj kk kl km gt nl mw nm nn aw no bi"><span id="8067" class="mz lw it mw b gy np nq l nr ns">cp $(tinygo env TINYGOROOT)/targets/wasm_exec.js .</span></pre><h2 id="7114" class="mz lw it bd lx na nb dn mb nc nd dp mf li ne nf mh lm ng nh mj lq ni nj ml nk bi translated"><strong class="ak">编译您的Go代码</strong></h2><pre class="kj kk kl km gt nl mw nm nn aw no bi"><span id="f92f" class="mz lw it mw b gy np nq l nr ns">tinygo build -o main.wasm -target wasm ./main.go</span></pre><p id="6019" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在你可以像我们在我的上一篇文章中所做的那样，在你的HTML中加载<code class="fe mt mu mv mw b">main.wasm</code>。</p><h1 id="5033" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="70a5" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在这篇文章中，我们学习了如何减少Wasm二进制文件来改善我们的应用程序的页面。我们看到了两种策略，应该根据您在Go程序中使用的功能来选择。下一次，我将向您展示如何通过Webpack在React应用程序中使用Web程序集文件。</p></div></div>    
</body>
</html>