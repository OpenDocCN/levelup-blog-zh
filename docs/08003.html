<html>
<head>
<title>MSDF text rendering for WebGL with msdf-bmfont-xml</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于msdf-bmfont-xml的web GL MSDF文本渲染</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/msdf-font-rendering-in-webgl-91ce192d2bec?source=collection_archive---------7-----------------------#2021-03-28">https://levelup.gitconnected.com/msdf-font-rendering-in-webgl-91ce192d2bec?source=collection_archive---------7-----------------------#2021-03-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="acf8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://openglobus.org/examples/fonts/fonts.html" rel="noopener ugc nofollow" target="_blank">此处举例</a></p><p id="159e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用msdf-bmfont-xml工具为msdf生成字体集和渲染纹理，这样标签看起来更漂亮！它得到了<a class="ae kl" href="https://github.com/soimy/msdf-bmfont-xml" rel="noopener ugc nofollow" target="_blank"> msdf-bmfont-xml </a>工具的帮助，该工具用于生成字体图集和渲染多通道有符号距离场(msdf)纹理。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/9a85a55a4d8deb4fc0ce85816175726a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gHj9PvNYojGfBWCPxDK2oA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">【https://openglobus.org/examples/fonts/fonts.html】例子链接:T4</figcaption></figure><p id="576f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/soimy/msdf-bmfont-xml" rel="noopener ugc nofollow" target="_blank"> msdf-bmfont-xml </a>允许你从ttf字体生成各种纹理图谱。在我们的例子中，atlas纹理是一个多通道有符号距离场，与原始有符号距离场形成对比，它呈现字母的锐角。</p><p id="0002" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我想告诉你什么是字母存储图集，以及如何使用WebGL显示文本。</p><h2 id="ff01" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">纹理图谱<a class="ae kl" href="https://github.com/soimy/msdf-bmfont-xml" rel="noopener ugc nofollow" target="_blank"> msdf-bmfont-xml </a></h2><p id="f853" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">字体纹理图册是一种纹理，上面保存有符号图像。每张图片都有对应的纹理坐标。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/70fcc43da82f43c417a96d99fb09f99d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*pfabom65k8_2Vutn3Xh6hQ.png"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">roboto-512 x512的常规字体图册图像</figcaption></figure><p id="bdd2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了创建地图集，我使用了以下命令:</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="6748" class="lc ld iq mc b gy mg mh l mi mj">msdf-bmfont.cmd — reuse -i .\charset.txt -m 512,512 -f json -o %1.png -s 32 -r 8 -p 1 -t msdf %1</span></pre><p id="94bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其中%1 —是ttf字体文件的名称，charset.txt —是一个包含一组符号的文件，地图集就是为这些符号构建的，其余的参数您可以在<a class="ae kl" href="https://github.com/soimy/msdf-bmfont-xml" rel="noopener ugc nofollow" target="_blank"> msdf-bmfont-xml </a>的官方存储库页面上找到。</p><p id="0f69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果运行命令成功，将创建几个文件。我们对png图集纹理和json图集描述感兴趣。</p><p id="9178" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://github.com/soimy/msdf-bmfont-xml" rel="noopener ugc nofollow" target="_blank"> msdf-bmfont-xml </a>中，符号的所有信息都存储在chars部分，例如字母<strong class="jp ir"><em class="mk">【q】</em>(上图中的</strong>)的坐标为<strong class="jp ir"> <em class="mk"> x = 131，y = 356，宽度= 22，高度= 32，</em> </strong>，即左上角的坐标为<strong class="jp ir"><em class="mk">【131，356】</em></strong>，右下角的坐标为所以，如果字体图像有512×512像素大小，那么纹理坐标中的<strong class="jp ir"><em class="mk">【q】</em></strong>字母分别是<strong class="jp ir"><em class="mk">【131/512，356/512】</em></strong>和<strong class="jp ir"><em class="mk">【153/512，388/512】</em></strong>。如果我们将这些纹理坐标应用到绘制矩形的着色器，那么我们将在这个矩形中看到我们的符号。最重要的是，我们知道字形(或符号)的宽度和高度，这允许我们设置矩形的大小，使符号看起来比例正确。</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="f0ab" class="lc ld iq mc b gy mg mh l mi mj"><em class="mk">{<br/>    id: 113,<br/>    char: “q”,<br/>    width: 22,<br/>    height: 32,<br/>    xoffset: -3,<br/>    yoffset: 11,<br/>    xadvance: 18,<br/>    x: 131,<br/>    y: 356,<br/>    ...<br/>}</em></span></pre><p id="6388" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">字符串中字符定位的其他重要参数有:</p><p id="5709" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> xoffsеt </strong> —字符的水平偏移量，以像素为单位</p><p id="b4dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">yooffset</strong>—字符垂直偏移，以像素为单位</p><p id="a318" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> xadvance </strong> —字形宽度；从字形的左边界到该行下一个字符开始的距离</p><p id="ccae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，glyph有<strong class="jp ir"> id </strong>，它标识水平字距表中的一个字母。字距调整—是两个特定字母之间的距离。</p><h1 id="1351" class="ml ld iq bd le mm mn mo lh mp mq mr lk ms mt mu ln mv mw mx lq my mz na lt nb bi translated">示例:显示文本“Wg！”对于Arial字体</h1><p id="c052" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">字形参数:</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="09b2" class="lc ld iq mc b gy mg mh l mi mj">W: <strong class="mc ir">width</strong>: 37, <strong class="mc ir">height</strong>: 31, <strong class="mc ir">xoffset</strong>: -4, <strong class="mc ir">yoffset</strong>: 4, <strong class="mc ir">xadvance</strong>: 30</span><span id="4a2a" class="lc ld iq mc b gy nc mh l mi mj">g: <strong class="mc ir">width</strong>: 23, <strong class="mc ir">height</strong>: 32, <strong class="mc ir">xoffset</strong>: -3, <strong class="mc ir">yoffset</strong>: 10, <strong class="mc ir">xadvance</strong>: 18</span><span id="3202" class="lc ld iq mc b gy nc mh l mi mj">! : <strong class="mc ir">width</strong>: 11, <strong class="mc ir">height</strong>: 31, <strong class="mc ir">xoffset</strong>: -1, <strong class="mc ir">yoffset</strong>: 4, <strong class="mc ir">xadvance</strong>: 9</span></pre><p id="3062" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">坐标原点在左上角，最初字形位于一条线上(下图中上方的绿线)，根据<strong class="jp ir">宽度</strong>参数，每个字形在该线上有自己的位置。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nd"><img src="../Images/bd001b88670708d6a776cec587e17f2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4R4zW93HVF7EeeD6immk-g.png"/></div></div></figure><p id="fd58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下图显示了根据<strong class="jp ir"> yoffsset </strong>参数，字符相对于水平(中心)轴的垂直偏移。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ne"><img src="../Images/aa669bf568b5d65e8d0f2e59bbaeeb92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jWptZyoeRyHmIPKuNVVlnQ.png"/></div></div></figure><p id="60e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">蓝色线条显示<strong class="jp ir"> xadvance </strong>参数(到该行下一个字符的距离)，每个字符也根据参数<strong class="jp ir"> xoffset </strong>水平移动。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nf"><img src="../Images/b7c5fa9f1dd6ba8921c6e61f42e72910.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lRQxsBqaruIWDYlFf-NJXg.png"/></div></div></figure><p id="89ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以认为当前版本已经准备好了，但是，为了获得最佳质量，您应该应用字距调整选项，即两个特定字符相对于彼此的偏移量。在这个例子中，我没有显示字距调整；显示文本时，<strong class="jp ir"> xoffset </strong>参数会考虑字距调整。</p><h2 id="9cce" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">MSDF文本渲染</h2><p id="0068" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">通过调用drawArrays函数将每个字形绘制为正方形，其中输入缓冲区是数组的顶点缓冲区:</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="dab3" class="lc ld iq mc b gy mg mh l mi mj">vec2 a_vertices = [0, 0, 0, -1, 1, -1, 1, -1, 1, 0, 0, 0]</span></pre><p id="4a6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">构建字体集时，基本字符参数将被规范化:</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="f381" class="lc ld iq mc b gy mg mh l mi mj"><strong class="mc ir">imageSize </strong>= 512; //Atlas image texture size<strong class="mc ir"><br/>nWidth </strong>= <strong class="mc ir">width </strong>/ imageSize; <em class="mk">//normalized glyph width</em><br/><strong class="mc ir">nHeight </strong>= <strong class="mc ir">height </strong>/ imageSize; <em class="mk">//normalized glyph height</em><br/><strong class="mc ir">nAdvance </strong>= <strong class="mc ir">xadvance </strong>/ imageSize; <em class="mk">//</em>normalized glyph size to the next character in the line<br/><strong class="mc ir">nXOffset </strong>= <strong class="mc ir">xoffset </strong>/ imageSize; <em class="mk">//</em>normalized horizontal offset<br/><strong class="mc ir">nYOffset </strong>= 1.0 — <strong class="mc ir">yoffset </strong>/ imageSize; <em class="mk">//</em>normalized vertical offset</span></pre><h2 id="8217" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">GLSL片段着色器</h2><p id="87df" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/openglobus/openglobus/blob/master/src/og/shaders/label.js" rel="noopener ugc nofollow" target="_blank">链接到源代码</a></p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="0ea9" class="lc ld iq mc b gy mg mh l mi mj"><strong class="mc ir">Vertex shader:</strong></span><span id="f0b2" class="lc ld iq mc b gy nc mh l mi mj"><em class="mk">...</em></span><span id="01fe" class="lc ld iq mc b gy nc mh l mi mj">vec2 v = screenPos + (a_vertices * a_gliphParam.xy + a_gliphParam.zw + vec2(advanceOffset, 0.0)) * a_size;</span><span id="ab83" class="lc ld iq mc b gy nc mh l mi mj"><em class="mk">Где:</em></span><span id="5cd3" class="lc ld iq mc b gy nc mh l mi mj"><strong class="mc ir"><em class="mk">screenPos </em></strong><em class="mk">- screen space string coordinates<br/></em><strong class="mc ir"><em class="mk">a_vertices </em></strong><em class="mk">- quad vertices<br/></em><strong class="mc ir"><em class="mk">a_gliphParam </em></strong><em class="mk">- glyph metrics, where:<br/></em><strong class="mc ir"><em class="mk">x</em></strong><em class="mk"> - nWidth, </em><strong class="mc ir"><em class="mk">y</em></strong><em class="mk"> - nHeight, </em><strong class="mc ir"><em class="mk">z</em></strong><em class="mk"> - nXOffset, </em><strong class="mc ir"><em class="mk">w</em></strong><em class="mk"> - nYOffset<br/></em><strong class="mc ir"><em class="mk">advanceOffset </em></strong><em class="mk">- total offset by nAdvance, for each next glyph in the string<br/></em><strong class="mc ir"><em class="mk">a_size </em></strong><em class="mk">- screen space font size in pixels</em></span><span id="e533" class="lc ld iq mc b gy nc mh l mi mj"><strong class="mc ir">Fragment shader:</strong></span><span id="29c6" class="lc ld iq mc b gy nc mh l mi mj">...</span><span id="d77a" class="lc ld iq mc b gy nc mh l mi mj">const float imageSize = 512.0;<br/>const float distanceRange = 8.0;</span><span id="e0e4" class="lc ld iq mc b gy nc mh l mi mj">layout(location = 0) out vec4 outScreen;</span><span id="a2c9" class="lc ld iq mc b gy nc mh l mi mj">float median(float r, float g, float b) {<br/>    return max(min(r, g), min(max(r, g), b));<br/>}</span><span id="bf6c" class="lc ld iq mc b gy nc mh l mi mj">float getDistance() {<br/>    vec3 msdf = texture(fontTexture, v_uv).rgb;<br/>    return median(msdf.r, msdf.g, msdf.b);<br/>}</span><span id="9332" class="lc ld iq mc b gy nc mh l mi mj">void main () {<br/>    vec2 dxdy = fwidth(v_uv) * vec2(imageSize);<br/>    float dist = getDistance() + min(v_weight, 0.5 – 1.0 / DIST_RANGE) — 0.5;<br/>    float opacity = clamp(dist * distanceRange / length(dxdy) + 0.5, 0.0, 1.0);<br/><br/>    outScreen = vec4(v_rgba.rgb, opacity * v_rgba.a);<br/>}</span><span id="5665" class="lc ld iq mc b gy nc mh l mi mj"><em class="mk">Где:</em></span><span id="655b" class="lc ld iq mc b gy nc mh l mi mj"><strong class="mc ir"><em class="mk">fontTexture </em></strong><em class="mk">- font atlas texture<br/></em><strong class="mc ir"><em class="mk">v_weight </em></strong><em class="mk">- glyph weight from 0 to 1, for outline. By default is 0. Outline is rendered first pass with v_weight value.<br/></em><strong class="mc ir"><em class="mk">v_uv </em></strong><em class="mk">- texture coordinates of glyph in font atlas<br/></em><strong class="mc ir"><em class="mk">v_rgba </em></strong><em class="mk">- цвет символа или окантовки</em></span><span id="84c0" class="lc ld iq mc b gy nc mh l mi mj">...</span></pre><p id="fdca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望我已经足够清楚地解释了如何使用字体集，以及如何在我的项目中使用<a class="ae kl" href="https://github.com/soimy/msdf-bmfont-xml" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">msdf-BM font-XML</strong></a><strong class="jp ir"/>。这种方法显著提高了地图上文本标注的质量。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ng"><img src="../Images/a497edc93005b15707e9862fdbb617ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tztqqLVKR1IkovWcIeAb_g.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">使用openglobus库的Microavia UAV航路规划编辑器示例</figcaption></figure><p id="0545" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请在评论中写下你用什么来渲染字体，以及你认为如何提高文本标签的质量？</p><p id="9070" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有问题可以在<a class="ae kl" href="https://openglobus.org" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> openglobus </strong> </a>论坛<a class="ae kl" href="https://groups.google.com/forum/#!forum/openglobus" rel="noopener ugc nofollow" target="_blank">https://groups.google.com/forum/#!forum/openglobus</a>上提问，我一定会回答！</p><p id="23fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">干杯！</p><h2 id="70af" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">有用的来源:</h2><div class="nh ni gp gr nj nk"><a href="https://github.com/Chlumsky/msdfgen" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd ir gy z fp np fr fs nq fu fw ip bi translated">Chlumsky/msdfgen</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">这是一个用于从矢量形状和字体字形中生成带符号距离场的实用程序，用作纹理…</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">github.com</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny kw nk"/></div></div></a></div><div class="nh ni gp gr nj nk"><a href="https://github.com/soimy/msdf-bmfont-xml" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd ir gy z fp np fr fs nq fu fw ip bi translated">soimy/msdf-bmfont-xml</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">将. ttf字体文件转换为多通道有符号距离字段，然后输出打包的spritesheets和xml(.fnt}或…</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">github.com</p></div></div><div class="nt l"><div class="nz l nv nw nx nt ny kw nk"/></div></div></a></div><div class="nh ni gp gr nj nk"><a href="https://learnopengl.com/In-Practice/Text-Rendering" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd ir gy z fp np fr fs nq fu fw ip bi translated">文本渲染</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">在你的图形冒险的某个阶段，你会想要在OpenGL中绘制文本。与你可能期望的相反…</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">learnopengl.com</p></div></div><div class="nt l"><div class="oa l nv nw nx nt ny kw nk"/></div></div></a></div><div class="nh ni gp gr nj nk"><a href="https://github.com/openglobus/openglobus" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd ir gy z fp np fr fs nq fu fw ip bi translated">openglobus/openglobus</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">OpenGlobus是一个javascript库，用于显示交互式3d地图和行星，包括地图拼图、图像和…</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">github.com</p></div></div><div class="nt l"><div class="ob l nv nw nx nt ny kw nk"/></div></div></a></div></div></div>    
</body>
</html>