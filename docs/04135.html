<html>
<head>
<title>Using SQLite with Rust and Actix Web (with Tests)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Rust和Actix Web上使用SQLite(带测试)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-sqlite-with-rust-and-actix-web-with-tests-11a935ac3d95?source=collection_archive---------5-----------------------#2020-06-11">https://levelup.gitconnected.com/using-sqlite-with-rust-and-actix-web-with-tests-11a935ac3d95?source=collection_archive---------5-----------------------#2020-06-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bb534bd1d894a8a360bd2ed0eff3d496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Y_p2i3T0L0Y3w9Hw.jpg"/></div></div></figure></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><p id="b6ed" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">在本文中，我们将探讨如何在文件和内存模式下将SQLite(与Diesel结合)与Rust一起使用。</p><h1 id="49d4" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">先决条件</h1><p id="eac1" class="pw-post-body-paragraph kf kg iq kh b ki mb kk kl km mc ko kp kq md ks kt ku me kw kx ky mf la lb lc ij bi translated">除了安装Rust &amp; Diesel CLI之外，还要为您的平台安装SQLite:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="e20d" class="mp le iq ml b gy mq mr l ms mt"># Linux<br/>$ sudo apt install sqlite3 libsqlite3-0 libsqlite3-dev</span><span id="c361" class="mp le iq ml b gy mu mr l ms mt"># OSX<br/>$ brew install sqlite3</span></pre><h1 id="f957" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">创建项目(<a class="ae mv" href="https://github.com/ukchukx/diesel-sqlite/commit/bd1f5209c522c9df1540cc1806821a4268870e7d" rel="noopener ugc nofollow" target="_blank">提交</a>)</h1><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="0f77" class="mp le iq ml b gy mq mr l ms mt">$ cargo new diesel-sqlite<br/>$ cd diesel-sqlite</span></pre><p id="ff94" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">添加以下依赖项:</p><ul class=""><li id="b01b" class="mw mx iq kh b ki kj km kn kq my ku mz ky na lc nb nc nd ne bi translated">柴油机提供ORM能力。</li><li id="a016" class="mw mx iq kh b ki nf km ng kq nh ku ni ky nj lc nb nc nd ne bi translated">我们的web层。</li><li id="4ffe" class="mw mx iq kh b ki nf km ng kq nh ku ni ky nj lc nb nc nd ne bi translated">Dotenv用于处理环境变量。</li><li id="1bc2" class="mw mx iq kh b ki nf km ng kq nh ku ni ky nj lc nb nc nd ne bi translated">Uuid来生成id。</li></ul><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="5e43" class="mp le iq ml b gy mq mr l ms mt">[dependencies]<br/>actix-rt = "1.0"<br/>actix-web = "2.0"<br/>chrono = { version = "0.4.11", features = ["serde"] }<br/>diesel = { version = "1.4.4", features = ["sqlite", "uuidv07", "chrono"] }<br/>dotenv = "0.15.0"<br/>serde = { version = "1.0", features = ["derive"] }<br/>serde_json = "1.0"<br/>uuid = { version = "0.8", features = ["serde", "v4"] }</span></pre><p id="93ac" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">接下来，创建一个带有<code class="fe nk nl nm ml b">DATABASE_URL</code>的<code class="fe nk nl nm ml b">.env</code>文件:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="0e6a" class="mp le iq ml b gy mq mr l ms mt">DATABASE_URL=users.db</span></pre><h1 id="e9e4" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">初始化Diesel并创建迁移脚本(<a class="ae mv" href="https://github.com/ukchukx/diesel-sqlite/commit/4c06113bb82a3ac66910f430e4274a154c3c02d2" rel="noopener ugc nofollow" target="_blank">提交</a>)</h1><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="6c01" class="mp le iq ml b gy mq mr l ms mt">$ diesel setup<br/>$ diesel migration generate create_users</span></pre><p id="449a" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">将以下SQL语句添加到生成的向上和向下迁移文件中。</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="0e9d" class="mp le iq ml b gy mq mr l ms mt">-- migrations/xxxx_create_users/up.sql</span><span id="8503" class="mp le iq ml b gy mu mr l ms mt">CREATE TABLE IF NOT EXISTS users (<br/>  id CHARACTER(36) NOT NULL PRIMARY KEY,<br/>  email VARCHAR(60),<br/>  phone VARCHAR(20),<br/>  created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,<br/>  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL<br/>);</span><span id="2b8f" class="mp le iq ml b gy mu mr l ms mt">CREATE TRIGGER IF NOT EXISTS UpdateTimestamps AFTER UPDATE ON users<br/>  FOR EACH ROW WHEN NEW.updated_at &lt;= OLD.updated_at <br/>BEGIN <br/>  update users set updated_at=CURRENT_TIMESTAMP where id=OLD.id;  <br/>END;</span><span id="fc96" class="mp le iq ml b gy mu mr l ms mt">-- migrations/xxxx_create_users/down.sql</span><span id="11c5" class="mp le iq ml b gy mu mr l ms mt">DROP TRIGGER IF EXISTS UpdateTimestamps;</span><span id="d646" class="mp le iq ml b gy mu mr l ms mt">DROP TABLE IF EXISTS users;</span></pre><p id="6aea" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">通过运行以下命令创建<code class="fe nk nl nm ml b">users</code>表:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="3bff" class="mp le iq ml b gy mq mr l ms mt">$ diesel migration run</span></pre><p id="88d4" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">运行之后，Diesel应该会在<code class="fe nk nl nm ml b">src/schema.rs</code>中为您创建一个模式。</p><p id="4d55" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">让我们重新组织我们的数据库文件:</p><ul class=""><li id="db34" class="mw mx iq kh b ki kj km kn kq my ku mz ky na lc nb nc nd ne bi translated">在<code class="fe nk nl nm ml b">src</code>目录下创建一个<code class="fe nk nl nm ml b">db</code>目录。</li><li id="e2a4" class="mw mx iq kh b ki nf km ng kq nh ku ni ky nj lc nb nc nd ne bi translated">将<code class="fe nk nl nm ml b">src/schema.rs</code>移动到<code class="fe nk nl nm ml b">db</code>目录中。</li><li id="44f2" class="mw mx iq kh b ki nf km ng kq nh ku ni ky nj lc nb nc nd ne bi translated">将<code class="fe nk nl nm ml b">diesel.toml</code>中的<code class="fe nk nl nm ml b">file</code>变量从<code class="fe nk nl nm ml b">src/schema.rs</code>更新为<code class="fe nk nl nm ml b">src/db/schema.rs</code>。</li><li id="78d9" class="mw mx iq kh b ki nf km ng kq nh ku ni ky nj lc nb nc nd ne bi translated">在<code class="fe nk nl nm ml b">db</code>目录下创建一个文件<code class="fe nk nl nm ml b">models.rs</code>。</li></ul><p id="2083" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">之后，使用以下内容创建一个文件<code class="fe nk nl nm ml b">src/db.rs</code>:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="3bbb" class="mp le iq ml b gy mq mr l ms mt">// src/db.rs<br/>pub mod models;<br/>pub mod schema;</span></pre><h1 id="17da" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">创建模型(<a class="ae mv" href="https://github.com/ukchukx/diesel-sqlite/commit/537b998b7ce67197f07ab1cd6cc82b55d170d63a" rel="noopener ugc nofollow" target="_blank">提交</a>)</h1><p id="b712" class="pw-post-body-paragraph kf kg iq kh b ki mb kk kl km mc ko kp kq md ks kt ku me kw kx ky mf la lb lc ij bi translated">首先，我们将嵌入我们的迁移，因为我们希望在测试中使用SQLite的内存模式。另一个好处是，我们的迁移被编译到我们的应用程序中，创建一个可执行文件，消除对文件系统的依赖。</p><p id="5b3c" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">将<code class="fe nk nl nm ml b">diesel_migrations</code>添加到我们的依赖关系中:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="0b38" class="mp le iq ml b gy mq mr l ms mt"># Cargo.toml</span><span id="fbda" class="mp le iq ml b gy mu mr l ms mt">[dependencies]<br/># ...<br/>diesel_migrations = "1.4.0"</span></pre><p id="6c6c" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">将这些添加到<code class="fe nk nl nm ml b">main.rs</code>的顶部:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="9874" class="mp le iq ml b gy mq mr l ms mt">// src/main.rs<br/>#[macro_use]<br/>extern crate diesel;<br/>#[macro_use]<br/>extern crate diesel_migrations;<br/></span><span id="69b4" class="mp le iq ml b gy mu mr l ms mt">mod db;<br/>// ...</span></pre><p id="c3ad" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">在<code class="fe nk nl nm ml b">src/db.rs</code>中，粘贴:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="9576" class="mp le iq ml b gy mq mr l ms mt">// src/db.rs</span><span id="31e3" class="mp le iq ml b gy mu mr l ms mt">// ...<br/>embed_migrations!();</span><span id="736a" class="mp le iq ml b gy mu mr l ms mt">pub fn establish_connection() -&gt; SqliteConnection {<br/>    if cfg!(test) {<br/>        let conn = SqliteConnection::establish(":memory:")<br/>          .unwrap_or_else(|_| panic!("Error creating test database"));<br/>        <br/>        let _result = diesel_migrations::run_pending_migrations(&amp;conn);</span><span id="d389" class="mp le iq ml b gy mu mr l ms mt">        conn<br/>    } else {<br/>        dotenv().ok();<br/>    <br/>        let database_url = env::var("DATABASE_URL").expect("DATABASE_URL must be set");<br/>    <br/>        SqliteConnection::establish(&amp;database_url)<br/>          .unwrap_or_else(|_| panic!("Error connecting to {}", database_url))<br/>    }<br/>}</span></pre><p id="52b4" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">我们利用Rust在<code class="fe nk nl nm ml b">establish_connection()</code>中的条件编译功能，为测试返回一个内存连接，为正常运行返回一个文件连接。</p><p id="071b" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">将此粘贴到<code class="fe nk nl nm ml b">src/db/models.rs</code>:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="82f8" class="mp le iq ml b gy mq mr l ms mt">use uuid::Uuid;<br/>use serde::{Deserialize, Serialize};<br/>use diesel::prelude::*;</span><span id="960c" class="mp le iq ml b gy mu mr l ms mt">use super::schema::users;<br/>use super::schema::users::dsl::users as user_dsl;<br/></span><span id="26d8" class="mp le iq ml b gy mu mr l ms mt">#[derive(Debug, Deserialize, Serialize, Queryable, Insertable)]<br/>#[table_name = "users"]<br/>pub struct User {<br/>    pub id: String,<br/>    pub email: Option&lt;String&gt;,<br/>    pub phone: Option&lt;String&gt;,<br/>    pub created_at: chrono::NaiveDateTime,<br/>    pub updated_at: chrono::NaiveDateTime,<br/>}</span><span id="c0b5" class="mp le iq ml b gy mu mr l ms mt">impl User {<br/>    pub fn list(conn: &amp;SqliteConnection) -&gt; Vec&lt;Self&gt; {<br/>        user_dsl.load::&lt;User&gt;(conn).expect("Error loading users")<br/>    }</span><span id="9ada" class="mp le iq ml b gy mu mr l ms mt">    pub fn by_id(id: &amp;str, conn: &amp;SqliteConnection) -&gt; Option&lt;Self&gt; {<br/>        if let Ok(record) = user_dsl.find(id).get_result::&lt;User&gt;(conn) {<br/>            Some(record)<br/>        } else {<br/>            None<br/>        }<br/>    }</span><span id="441f" class="mp le iq ml b gy mu mr l ms mt">    pub fn by_email(email_str: &amp;str, conn: &amp;SqliteConnection) -&gt; Option&lt;Self&gt; {<br/>        use super::schema::users::dsl::email;</span><span id="61b6" class="mp le iq ml b gy mu mr l ms mt">        if let Ok(record) = user_dsl.filter(email.eq(email_str)).first::&lt;User&gt;(conn) {<br/>            Some(record)<br/>        } else {<br/>            None<br/>        }<br/>    }</span><span id="873b" class="mp le iq ml b gy mu mr l ms mt">    pub fn by_phone(phone_str: &amp;str, conn: &amp;SqliteConnection) -&gt; Option&lt;Self&gt; {<br/>        use super::schema::users::dsl::phone;</span><span id="9b2a" class="mp le iq ml b gy mu mr l ms mt">        if let Ok(record) = user_dsl.filter(phone.eq(phone_str)).first::&lt;User&gt;(conn) {<br/>            Some(record)<br/>        } else {<br/>            None<br/>        }<br/>    }</span><span id="65ec" class="mp le iq ml b gy mu mr l ms mt">    pub fn create(email: Option&lt;&amp;str&gt;, phone: Option&lt;&amp;str&gt;, conn: &amp;SqliteConnection) -&gt; Option&lt;Self&gt; {<br/>        let new_id = Uuid::new_v4().to_hyphenated().to_string();<br/>        <br/>        if email.is_none() &amp;&amp; phone.is_none() {<br/>            return None<br/>        } <br/>                <br/>        if phone.is_some() {<br/>            if let Some(user) = Self::by_phone(&amp;phone.unwrap(), conn) {<br/>                return Some(user)<br/>            } <br/>        }<br/>        <br/>        if email.is_some() {<br/>            if let Some(user) = Self::by_email(&amp;email.unwrap(), conn) {<br/>                return Some(user)<br/>            } <br/>        }</span><span id="d5ba" class="mp le iq ml b gy mu mr l ms mt">        let new_user = Self::new_user_struct(&amp;new_id, phone, email);</span><span id="8fdd" class="mp le iq ml b gy mu mr l ms mt">        diesel::insert_into(user_dsl)<br/>            .values(&amp;new_user)<br/>            .execute(conn)<br/>            .expect("Error saving new user");</span><span id="544c" class="mp le iq ml b gy mu mr l ms mt">        Self::by_id(&amp;new_id, conn)<br/>    }</span><span id="9377" class="mp le iq ml b gy mu mr l ms mt">    fn new_user_struct(id: &amp;str, phone: Option&lt;&amp;str&gt;, email: Option&lt;&amp;str&gt;) -&gt; Self {<br/>        User {<br/>            id: id.into(),<br/>            email: email.map(Into::into),<br/>            phone: phone.map(Into::into),<br/>            created_at: chrono::Local::now().naive_local(),<br/>            updated_at: chrono::Local::now().naive_local(),<br/>        }<br/>    }<br/>}<br/></span><span id="213f" class="mp le iq ml b gy mu mr l ms mt">#[cfg(test)]<br/>mod user_test;</span></pre><p id="bc91" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">首先，我们声明import并声明我们的<code class="fe nk nl nm ml b">User</code>结构。<br/>我们的每个<code class="fe nk nl nm ml b">User</code>方法都带有一个<code class="fe nk nl nm ml b">SqliteConnection</code>参数，所以我们可以传递任何我们想要的连接(测试或其他),而不必改变方法。<br/>对于查询方法，Diesel返回一个<code class="fe nk nl nm ml b">Result</code>，我们用<a class="ae mv" href="https://doc.rust-lang.org/std/result/enum.Result.html#method.ok" rel="noopener ugc nofollow" target="_blank">将它转换成一个<code class="fe nk nl nm ml b">Option</code>。ok() </a>来符合我们的返回类型。</p><p id="cd66" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">在<code class="fe nk nl nm ml b">create()</code>中，我们首先确保在创建新的<code class="fe nk nl nm ml b">User</code>记录之前，数据库中不存在提供的电子邮件和/或电话。</p><p id="2e7e" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">在文件的底部，我们声明按照惯例，测试是在位于<code class="fe nk nl nm ml b">src/db/models/user_test.rs</code>的文件中声明的。</p><p id="9289" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">将这些测试粘贴到文件中:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="42cd" class="mp le iq ml b gy mq mr l ms mt">use crate::db::{establish_connection, models::User};</span><span id="d47b" class="mp le iq ml b gy mu mr l ms mt">#[test]<br/>fn create_user_with_phone_and_email() {<br/>    let conn = establish_connection();<br/>    let email = Some("test@email.com");<br/>    let phone = Some("123456789");</span><span id="47a7" class="mp le iq ml b gy mu mr l ms mt">    let user = User::create(email, phone, &amp;conn).unwrap();</span><span id="e573" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(user.email.unwrap().as_str(), email.unwrap());<br/>    assert_eq!(user.phone.unwrap().as_str(), phone.unwrap());<br/>}</span><span id="c0db" class="mp le iq ml b gy mu mr l ms mt">#[test]<br/>fn create_user_with_phone_only() {<br/>    let conn = establish_connection();<br/>    let email = None;<br/>    let phone = Some("123456789");</span><span id="fcf1" class="mp le iq ml b gy mu mr l ms mt">    let user = User::create(email, phone, &amp;conn).unwrap();</span><span id="0c79" class="mp le iq ml b gy mu mr l ms mt">    assert!(user.email.is_none());<br/>    assert_eq!(user.phone.unwrap().as_str(), phone.unwrap());<br/>}</span><span id="ca17" class="mp le iq ml b gy mu mr l ms mt">#[test]<br/>fn create_user_with_email_only() {<br/>    let conn = establish_connection();<br/>    let email = Some("test@email.com");<br/>    let phone = None;</span><span id="e657" class="mp le iq ml b gy mu mr l ms mt">    let user = User::create(email, phone, &amp;conn).unwrap();</span><span id="72ea" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(user.email.unwrap().as_str(), email.unwrap());<br/>    assert!(user.phone.is_none());<br/>}</span><span id="f485" class="mp le iq ml b gy mu mr l ms mt">#[test]<br/>fn create_user_with_existing_email() {<br/>    let conn = establish_connection();<br/>    let email = Some("test@email.com");<br/>    let phone = None;</span><span id="34b8" class="mp le iq ml b gy mu mr l ms mt">    let user = User::create(email, phone, &amp;conn).unwrap();<br/>    let existing_user = User::create(email, phone, &amp;conn).unwrap();</span><span id="6b4c" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(user.id, existing_user.id);<br/>}</span><span id="47ac" class="mp le iq ml b gy mu mr l ms mt">#[test]<br/>fn create_user_with_existing_phone() {<br/>    let conn = establish_connection();<br/>    let email = None;<br/>    let phone = Some("123456789");</span><span id="10de" class="mp le iq ml b gy mu mr l ms mt">    let user = User::create(email, phone, &amp;conn).unwrap();<br/>    let existing_user = User::create(email, phone, &amp;conn).unwrap();</span><span id="e401" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(user.id, existing_user.id);<br/>}</span><span id="1315" class="mp le iq ml b gy mu mr l ms mt">#[test]<br/>fn list_users() {<br/>    let conn = establish_connection();<br/>    let email = None;<br/>    let phone = Some("123456789");</span><span id="d207" class="mp le iq ml b gy mu mr l ms mt">    let user = User::create(email, phone, &amp;conn).unwrap();<br/>    let existing_users = User::list(&amp;conn);</span><span id="fee3" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(1, existing_users.len());<br/>    assert_eq!(user.id, existing_users[0].id);<br/>}</span><span id="a1b6" class="mp le iq ml b gy mu mr l ms mt">#[test]<br/>fn get_user_by_phone() {<br/>    let conn = establish_connection();<br/>    let email = None;<br/>    let phone = Some("123456789");</span><span id="ed47" class="mp le iq ml b gy mu mr l ms mt">    let user = User::create(email, phone, &amp;conn).unwrap();<br/>    let existing_user = User::by_phone(&amp;phone.unwrap(), &amp;conn).unwrap();</span><span id="d138" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(user.id, existing_user.id);<br/>}</span><span id="be86" class="mp le iq ml b gy mu mr l ms mt">#[test]<br/>fn get_user_by_email() {<br/>    let conn = establish_connection();<br/>    let email = Some("test@email.com");<br/>    let phone = None;</span><span id="46f6" class="mp le iq ml b gy mu mr l ms mt">    let user = User::create(email, phone, &amp;conn).unwrap();<br/>    let existing_user = User::by_email(&amp;email.unwrap(), &amp;conn).unwrap();</span><span id="3ac6" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(user.id, existing_user.id);<br/>}</span><span id="b0db" class="mp le iq ml b gy mu mr l ms mt">#[test]<br/>fn get_user_by_id() {<br/>    let conn = establish_connection();<br/>    let email = Some("test@email.com");<br/>    let phone = Some("123456789");</span><span id="f642" class="mp le iq ml b gy mu mr l ms mt">    let user = User::create(email, phone, &amp;conn).unwrap();<br/>    let existing_user = User::by_id(&amp;user.id, &amp;conn).unwrap();</span><span id="88c4" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(user.id, existing_user.id);<br/>}</span></pre><h1 id="e15e" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">添加一个web服务(<a class="ae mv" href="https://github.com/ukchukx/diesel-sqlite/commit/a987f138b2e9b74d818d09fafe28c7bb76e9357c" rel="noopener ugc nofollow" target="_blank">提交</a>)</h1><p id="302f" class="pw-post-body-paragraph kf kg iq kh b ki mb kk kl km mc ko kp kq md ks kt ku me kw kx ky mf la lb lc ij bi translated">更新我们的<code class="fe nk nl nm ml b">actix-web</code>依赖项，提供一些2.0中没有的测试工具，并添加<code class="fe nk nl nm ml b">r2d2</code>来帮助连接池:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="d19f" class="mp le iq ml b gy mq mr l ms mt">[dependencies]<br/># ...<br/>actix-web = "3.0.0-alpha.1"<br/>diesel = { version = "1.4.4", features = ["sqlite", "uuidv07", "r2d2", "chrono"] }<br/>r2d2 = "0.8.8"<br/>r2d2-diesel = "1.0.0"</span></pre><p id="39ea" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">让我们重构<code class="fe nk nl nm ml b">src/db.rs</code>来使用连接池:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="37bb" class="mp le iq ml b gy mq mr l ms mt">// src/db.rs<br/>// ...<br/>use diesel::sqlite::SqliteConnection;<br/>use r2d2_diesel::ConnectionManager;<br/>use r2d2::Pool;<br/></span><span id="69e2" class="mp le iq ml b gy mu mr l ms mt">embed_migrations!();<br/></span><span id="da3a" class="mp le iq ml b gy mu mr l ms mt">pub type DbPool = Pool&lt;ConnectionManager&lt;SqliteConnection&gt;&gt;;<br/></span><span id="1611" class="mp le iq ml b gy mu mr l ms mt">pub fn run_migrations(conn: &amp;SqliteConnection) {<br/>  let _ = diesel_migrations::run_pending_migrations(&amp;*conn);<br/>}</span><span id="6816" class="mp le iq ml b gy mu mr l ms mt">pub fn establish_connection() -&gt; DbPool {<br/>    if cfg!(test) {<br/>        let manager = ConnectionManager::&lt;SqliteConnection&gt;::new(":memory:");<br/>        let pool = r2d2::Pool::builder().build(manager).expect("Failed to create DB pool.");<br/>        <br/>        run_migrations(&amp;pool.get().unwrap());</span><span id="29b0" class="mp le iq ml b gy mu mr l ms mt">        pool<br/>    } else {<br/>        dotenv().ok();<br/>    <br/>        let database_url = env::var("DATABASE_URL").expect("DATABASE_URL must be set");<br/>        let manager = ConnectionManager::&lt;SqliteConnection&gt;::new(&amp;database_url);<br/>        <br/>        r2d2::Pool::builder().build(manager).expect("Failed to create DB pool.")<br/>    }<br/>}</span></pre><p id="707d" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">我们还将创建测试连接池与运行迁移分开。</p><p id="fcee" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">在我们的每个模型测试中，我们改变了获取联系的方式</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="25f5" class="mp le iq ml b gy mq mr l ms mt">let conn = establish_connection();</span></pre><p id="c28f" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">到</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="ba37" class="mp le iq ml b gy mq mr l ms mt">let conn = establish_connection().get().unwrap();</span></pre><p id="1182" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">创建一个服务模块<code class="fe nk nl nm ml b">src/services.rs</code>并粘贴:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="4afb" class="mp le iq ml b gy mq mr l ms mt">// src/services.rs<br/>pub mod user;</span><span id="67a1" class="mp le iq ml b gy mu mr l ms mt">#[cfg(test)]<br/>mod user_test;</span></pre><p id="bb2e" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">然后我们创建用户服务文件<code class="fe nk nl nm ml b">src/services/user.rs</code>并粘贴:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="9e27" class="mp le iq ml b gy mq mr l ms mt">// src/services/user.rs<br/>use actix_web::{HttpResponse, web};<br/>use serde::{Serialize, Deserialize};</span><span id="e5d8" class="mp le iq ml b gy mu mr l ms mt">use crate::db::{DbPool, models::User};</span><span id="9ba4" class="mp le iq ml b gy mu mr l ms mt">#[derive(Serialize, Deserialize)]<br/>pub struct UserForm {<br/>    email: Option&lt;String&gt;,<br/>    phone: Option&lt;String&gt;,<br/>}</span><span id="6020" class="mp le iq ml b gy mu mr l ms mt">pub fn create(user_form: web::Json&lt;UserForm&gt;, pool: web::Data&lt;DbPool&gt;) -&gt; HttpResponse {<br/>    let conn = pool.get().unwrap();</span><span id="0f29" class="mp le iq ml b gy mu mr l ms mt">    match User::create(user_form.email.as_deref(), user_form.phone.as_deref(), &amp;conn) {<br/>        Some(user) =&gt; HttpResponse::Ok().json(user),<br/>        _ =&gt; HttpResponse::InternalServerError().json("Could not create user")<br/>    }<br/>}</span><span id="9659" class="mp le iq ml b gy mu mr l ms mt">pub fn index(pool: web::Data&lt;DbPool&gt;) -&gt; HttpResponse {<br/>    let conn = pool.get().unwrap();</span><span id="24f3" class="mp le iq ml b gy mu mr l ms mt">    HttpResponse::Ok().json(User::list(&amp;conn))<br/>}</span><span id="4d84" class="mp le iq ml b gy mu mr l ms mt">pub fn get(id: web::Path&lt;String&gt;, pool: web::Data&lt;DbPool&gt;) -&gt; HttpResponse {<br/>    let conn = pool.get().unwrap();</span><span id="eb23" class="mp le iq ml b gy mu mr l ms mt">    match User::by_id(&amp;id, &amp;conn) {<br/>        Some(user) =&gt; HttpResponse::Ok().json(user),<br/>        _ =&gt; HttpResponse::NotFound().json("Not Found")<br/>    }<br/>}</span><span id="b128" class="mp le iq ml b gy mu mr l ms mt">pub fn init_routes(cfg: &amp;mut web::ServiceConfig) {<br/>    /* <br/>     * index: curl -i -X GET -H "Content-Type: application/json" http://localhost:5000/users<br/>     * get: curl -i -X GET -H "Content-Type: application/json" http://localhost:5000/users/&lt;id&gt;<br/>     * post: curl -i -X POST -H "Content-Type: application/json" -d '{"email":"xxx", "phone": "yyy"}' http://localhost:5000/users<br/>     */<br/>    <br/>    cfg.service(<br/>        web::resource("/users")<br/>            .route(web::post().to(create))<br/>            .route(web::get().to(index))<br/>    )<br/>    .service(<br/>        web::scope("/users")<br/>            .route("/{id}", web::get().to(get)),<br/>    );<br/>}</span></pre><p id="e6e4" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><code class="fe nk nl nm ml b">create()</code>、<code class="fe nk nl nm ml b">index()</code>和<code class="fe nk nl nm ml b">get()</code>通过id处理用户的创建、列表和获取。<br/> <code class="fe nk nl nm ml b">init_routes()</code>将我们的路线添加到网络服务器。</p><p id="2985" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">然后我们更新<code class="fe nk nl nm ml b">src/main.rs</code>来启动我们的web服务器:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="cd95" class="mp le iq ml b gy mq mr l ms mt">// src/main.rs</span><span id="8d87" class="mp le iq ml b gy mu mr l ms mt">// ...<br/>#[macro_use]<br/>extern crate serde_json;<br/>extern crate r2d2_diesel;<br/></span><span id="7652" class="mp le iq ml b gy mu mr l ms mt">// ...<br/>mod services;<br/></span><span id="4745" class="mp le iq ml b gy mu mr l ms mt">#[actix_rt::main]<br/>async fn main() -&gt; std::io::Result&lt;()&gt; {<br/>    use actix_web::{App, HttpServer, web::JsonConfig};</span><span id="8723" class="mp le iq ml b gy mu mr l ms mt">    let conn_pool = db::establish_connection();</span><span id="d3f4" class="mp le iq ml b gy mu mr l ms mt">    HttpServer::new(move || {<br/>        App::new()<br/>            .data(conn_pool.clone())<br/>            .data(JsonConfig::default().limit(4096))<br/>            .configure(services::user::init_routes)<br/>    })<br/>    .bind("0.0.0.0:5000")?<br/>    .run()<br/>    .await<br/>}</span></pre><p id="1180" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">有了这个更新，我们的服务就可以接收和处理请求了。</p><p id="8da0" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">让我们添加测试，这样我们就可以有一些保证，我们的服务做了它的帐单。<br/>在<code class="fe nk nl nm ml b">src/services/user_test.rs</code>中，粘贴:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="0405" class="mp le iq ml b gy mq mr l ms mt">// src/services/user_test.rs<br/>use actix_web::{<br/>    App,<br/>    test::{read_body_json, read_body, init_service, TestRequest}<br/>};</span><span id="e9d4" class="mp le iq ml b gy mu mr l ms mt">use crate::{db::{models::User, establish_connection}, services::user::init_routes};</span><span id="35b0" class="mp le iq ml b gy mu mr l ms mt">#[actix_rt::test]<br/>async fn create_user_from_api() {<br/>    let test_email   = "test@email.com";<br/>    let test_phone   = "123456789";<br/>    let request_body = json!({ "email": test_email, "phone": test_phone });<br/>    let conn_pool    = establish_connection();<br/>    let mut app      = init_service(App::new().data(conn_pool.clone()).configure(init_routes)).await;</span><span id="68be" class="mp le iq ml b gy mu mr l ms mt">    let resp = TestRequest::post()<br/>      .uri("/users")<br/>      .set_json(&amp;request_body)<br/>      .send_request(&amp;mut app)<br/>      .await;</span><span id="3d33" class="mp le iq ml b gy mu mr l ms mt">    assert!(resp.status().is_success(), "Failed to create user");</span><span id="378a" class="mp le iq ml b gy mu mr l ms mt">    let user: User = read_body_json(resp).await;</span><span id="fb60" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(user.email.unwrap(), test_email);<br/>    assert_eq!(user.phone.unwrap(), test_phone);<br/>}</span><span id="d137" class="mp le iq ml b gy mu mr l ms mt">#[actix_rt::test]<br/>async fn get_user_from_api_by_id() {<br/>    let test_email   = "test@email.com";<br/>    let test_phone   = "123456789";<br/>    let request_body = json!({ "email": test_email, "phone": test_phone });<br/>    let conn_pool    = establish_connection();<br/>    let mut app      = init_service(App::new().data(conn_pool.clone()).configure(init_routes)).await;</span><span id="2d9f" class="mp le iq ml b gy mu mr l ms mt">    let create_resp = TestRequest::post()<br/>      .uri("/users")<br/>      .set_json(&amp;request_body)<br/>      .send_request(&amp;mut app)<br/>      .await;</span><span id="98cd" class="mp le iq ml b gy mu mr l ms mt">    assert!(create_resp.status().is_success(), "Failed to create user");</span><span id="5272" class="mp le iq ml b gy mu mr l ms mt">    let created_user: User = read_body_json(create_resp).await;<br/>    println!("/users/{}", created_user.id);<br/>    <br/>    let resp = TestRequest::get()<br/>      .uri(format!("/users/{}", created_user.id).as_str())<br/>      .send_request(&amp;mut app)<br/>      .await;</span><span id="2117" class="mp le iq ml b gy mu mr l ms mt">    assert!(resp.status().is_success(), "Failed to get user");</span><span id="edba" class="mp le iq ml b gy mu mr l ms mt">    let retrieved_user: User = read_body_json(resp).await;</span><span id="10cc" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(created_user.id, retrieved_user.id);<br/>}</span><span id="5b06" class="mp le iq ml b gy mu mr l ms mt">#[actix_rt::test]<br/>async fn list_users_from_api() {<br/>    let test_email   = "test@email.com";<br/>    let test_phone   = "123456789";<br/>    let request_body = json!({ "email": test_email, "phone": test_phone });<br/>    let conn_pool    = establish_connection();<br/>    let mut app      = init_service(App::new().data(conn_pool.clone()).configure(init_routes)).await;</span><span id="f3a9" class="mp le iq ml b gy mu mr l ms mt">    let mut list_resp = TestRequest::get().uri("/users").send_request(&amp;mut app).await;<br/>    <br/>    assert!(list_resp.status().is_success(), "Failed to list users");</span><span id="a12d" class="mp le iq ml b gy mu mr l ms mt">    let mut body = read_body(list_resp).await;  <br/>    let mut retrieved_users: Vec&lt;User&gt; = serde_json::from_slice::&lt;Vec&lt;User&gt;&gt;(&amp;body).unwrap();</span><span id="4d67" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(retrieved_users.len(), 0);</span><span id="e3e2" class="mp le iq ml b gy mu mr l ms mt">    let create_resp = TestRequest::post()<br/>      .uri("/users")<br/>      .set_json(&amp;request_body)<br/>      .send_request(&amp;mut app)<br/>      .await;</span><span id="969f" class="mp le iq ml b gy mu mr l ms mt">    assert!(create_resp.status().is_success(), "Failed to create user");<br/>    <br/>    list_resp = TestRequest::get().uri("/users").send_request(&amp;mut app).await;</span><span id="f084" class="mp le iq ml b gy mu mr l ms mt">    assert!(list_resp.status().is_success(), "Failed to list users");</span><span id="beca" class="mp le iq ml b gy mu mr l ms mt">    body = read_body(list_resp).await;    <br/>    retrieved_users = serde_json::from_slice::&lt;Vec&lt;User&gt;&gt;(&amp;body).unwrap();</span><span id="aab3" class="mp le iq ml b gy mu mr l ms mt">    assert_eq!(retrieved_users.len(), 1);<br/>}</span></pre><p id="98cf" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">完整的代码可以在这里找到<a class="ae mv" href="https://github.com/ukchukx/diesel-sqlite" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="1d2f" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">信用</h1><p id="bb99" class="pw-post-body-paragraph kf kg iq kh b ki mb kk kl km mc ko kp kq md ks kt ku me kw kx ky mf la lb lc ij bi translated">马库斯·温克勒在Unsplash上拍摄的照片。</p></div></div>    
</body>
</html>