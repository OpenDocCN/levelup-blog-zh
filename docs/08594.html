<html>
<head>
<title>Creating Kubernetes (k8s) cluster by joining Google Cloud Platform (GCP) Virtual Machines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过加入谷歌云平台(GCP)虚拟机创建Kubernetes (k8s)集群</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/creating-kubernetes-k8s-cluster-by-joining-google-cloud-platform-gcp-virtual-machines-e1f52c465a1c?source=collection_archive---------2-----------------------#2021-05-15">https://levelup.gitconnected.com/creating-kubernetes-k8s-cluster-by-joining-google-cloud-platform-gcp-virtual-machines-e1f52c465a1c?source=collection_archive---------2-----------------------#2021-05-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="73fc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ko translated">ubernetes (k8s)是一项了不起的技术，我很喜欢它。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/47cd313500e9f2fb2b4fcbf6ddb0f709.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*PSo3kXV2pHkwLdmiYoYbkA.png"/></div></figure><p id="29ef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Kubernetes有各种形式，从普通的Kubernetes到RedHat OpenShift这样的交钥匙解决方案。事实上，您可以在本地机器上使用Minikube提供一个单节点Kubernetes(k8s)集群。</p><p id="3e20" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我将向您展示我们如何利用由<strong class="js iu">谷歌云</strong>提供的<strong class="js iu">虚拟机</strong>来构建一个<strong class="js iu"> Kubernetes集群</strong>。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi lf"><img src="../Images/ce30c057274ad3ab3866c5799d4b7bf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GlXFDTF0zFHuN4PdOg9VSQ.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">谷歌云平台</figcaption></figure><p id="e1d5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将在<strong class="js iu">谷歌云平台(GCP) </strong>上启动3个虚拟机，然后通过bash终端运行一些脚本，使其中一个虚拟机成为Kubernetes的<strong class="js iu">主节点</strong>或<strong class="js iu">控制平面节点</strong>，其余2个节点成为<strong class="js iu">工作节点</strong>，从而形成一个Kubernetes集群。最后，我们将在新创建的Kubernetes集群上安排一个<strong class="js iu"> NGINX </strong> pod。</p><p id="e283" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们继续之前，我假设你已经注册了谷歌云平台(谷歌为1年的使用提供300美元的免费信用),否则就在<a class="ae lo" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com</a>注册。</p><p id="9b1f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来前往您的GCP帐户并登录。通过浏览控制台上的左侧菜单，转到虚拟机部分。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi lp"><img src="../Images/94af9e866745eb1a3c117ed427cf21d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HLdn31_BCCJQ4HtDIsONdg.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">GCP —虚拟机控制台</figcaption></figure><p id="fc3c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以使用控制台启动新的虚拟机，也可以使用本地系统的终端。</p><p id="6c6c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我讨厌网络控制台，更喜欢总是终端来减少时间。</p><p id="01c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lq">注意，你需要在你的机器上安装Google Cloud SDK。点击这个链接，按照你的特定操作系统(macOS，Windows，Linux等)的步骤操作:- </em></p><div class="lr ls gp gr lt lu"><a href="https://cloud.google.com/sdk/docs/quickstart" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd iu gy z fp lz fr fs ma fu fw is bi translated">快速入门:云SDK入门|云SDK文档</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">" type": "thumb-down "，" id": "hardToUnderstand "，" label ":"难以理解" }，{ "type": "thumb-down "，" id"…</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">cloud.google.com</p></div></div><div class="md l"><div class="me l mf mg mh md mi ld lu"/></div></div></a></div><p id="d02d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您像我一样，那么在您的终端(在Mac上)或命令提示符(在Windows上)上执行以下命令，在GCP上配置虚拟机:-</p><pre class="ky kz la lb gt mj mk ml mm aw mn bi"><span id="5955" class="mo mp it mk b gy mq mr l ms mt">gcloud compute instances create k8s-master — zone=europe-west3-c<br/> — machine-type=e2-medium<br/> — image=ubuntu-1804-bionic-v20201014<br/> — image-project=ubuntu-os-cloud<br/> — boot-disk-size=50GB</span><span id="4823" class="mo mp it mk b gy mu mr l ms mt">gcloud compute instances create k8s-worker-1  — zone=europe-west3-c<br/> — machine-type=e2-medium<br/> — image=ubuntu-1804-bionic-v20201014<br/> — image-project=ubuntu-os-cloud<br/> — boot-disk-size=50GB</span><span id="bac9" class="mo mp it mk b gy mu mr l ms mt">gcloud compute instances create k8s-worker-2  — zone=europe-west3-c<br/> — machine-type=e2-medium<br/> — image=ubuntu-1804-bionic-v20201014<br/> — image-project=ubuntu-os-cloud<br/> — boot-disk-size=50GB</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mv"><img src="../Images/2668ccd60849e85eb1489636b15dfa6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CPqb9LD9wo4KSvzSsLHJ8Q.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">虚拟机1(我们称之为k8s-master)</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mw"><img src="../Images/63833f6375e75a63a4a9e92d961845c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3UTANij8d7XRzUz07WINPw.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">虚拟机2 (k8s-worker-1)</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mx"><img src="../Images/4ec02b0a22dcb7bd5a81b22ab52423a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*51EV-iFagT-Jz1xyD6zzjg.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">虚拟机3 (k8s-worker-2)</figcaption></figure><p id="1b1f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lq">顺便提一下，我在这里用OS Ubuntu bionic版本和50 GB的磁盘空间启动了虚拟机。</em></p><p id="356a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">在您的本地终端上运行这个命令来验证所有正在运行的实例的状态:- </strong></p><pre class="ky kz la lb gt mj mk ml mm aw mn bi"><span id="6c23" class="mo mp it mk b gy mq mr l ms mt">gcloud compute instances list</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi my"><img src="../Images/6d2bc17c58a5161fd8f53147b30ca8b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4xDmRvD_frb39O6476Qx_g.png"/></div></div></figure><p id="ea96" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">在您的本地终端上运行此命令，使用所需的端口范围打开防火墙:- </strong></p><pre class="ky kz la lb gt mj mk ml mm aw mn bi"><span id="b9cd" class="mo mp it mk b gy mq mr l ms mt">gcloud compute firewall-rules create nodeports — allow tcp:30000–40000</span></pre><p id="f511" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，使用<strong class="js iu"> gcloud </strong> ssh命令从本地终端ssh到主节点:-</p><pre class="ky kz la lb gt mj mk ml mm aw mn bi"><span id="5412" class="mo mp it mk b gy mq mr l ms mt">gcloud compute ssh k8s-master</span></pre><p id="c3a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后运行以下命令，使该虚拟机成为Kubernetes (k8s)主节点:-</p><pre class="ky kz la lb gt mj mk ml mm aw mn bi"><span id="2c84" class="mo mp it mk b gy mq mr l ms mt">sudo -i<br/>bash &lt;(curl -s <a class="ae lo" href="https://raw.githubusercontent.com/vinod827/k8s-nest/main/iac/k8s/cluster-gcp/install_master.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/vinod827/k8s-nest/main/iac/k8s/cluster-gcp/install_master.sh</a>)</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mz"><img src="../Images/f526a6d33252d12d0903fe000a8e2517.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_QWPIt-vUiFoQ8nRdRZTeA.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">主网点</figcaption></figure><pre class="ky kz la lb gt mj mk ml mm aw mn bi"><span id="9a81" class="mo mp it mk b gy mq mr l ms mt">Note down the generated token below, this is important as it will be used to join the worker nodes:-</span><span id="fb20" class="mo mp it mk b gy mu mr l ms mt">Then you can join any number of worker nodes by running the following on each as root:</span><span id="4740" class="mo mp it mk b gy mu mr l ms mt">kubeadm join 10.156.0.6:6443 — token &lt;value withheld&gt; \<br/> — discovery-token-ca-cert-hash sha256:b8f250d499f443311a745ed9b92a7eac1723850a120d53f7c71f2aac347b301b<br/>serviceaccount/weave-net created<br/>clusterrole.rbac.authorization.k8s.io/weave-net created<br/>clusterrolebinding.rbac.authorization.k8s.io/weave-net created<br/>role.rbac.authorization.k8s.io/weave-net created<br/>rolebinding.rbac.authorization.k8s.io/weave-net created<br/>daemonset.apps/weave-net created</span><span id="7b77" class="mo mp it mk b gy mu mr l ms mt">### COMMAND TO ADD A WORKER NODE ###<br/>kubeadm join 10.156.0.6:6443 — token lglinc.htskyjdchamfi581 — discovery-token-ca-cert-hash sha256:b8f250d499f443311a745ed9b92a7eac1723850a120d53f7c71f2aac347b301b</span><span id="61b4" class="mo mp it mk b gy mu mr l ms mt">sudo -i<br/>bash &lt;(curl -s <a class="ae lo" href="https://raw.githubusercontent.com/vinod827/k8s-nest/main/iac/k8s/cluster-gcp/install_worker.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/vinod827/k8s-nest/main/iac/k8s/cluster-gcp/install_worker.sh</a>)</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi na"><img src="../Images/782a217f9690e84b5580626a86c775de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aimq1atPHll3Mxntbrxcvg.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">主节点—带令牌的输出</figcaption></figure><p id="75ba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我这里是令牌<strong class="js iu">b 8f 250d 499 f 443311 a 745 ed 9 b 92 a 7 EAC 1723850 a 120d 53 f 7 c 71 F2 AAC 347 b 301 b</strong></p><p id="0fca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">类似地，首先使用<strong class="js iu"> gcloud </strong> SSH命令进入每个worker节点，然后执行以下命令:-</p><pre class="ky kz la lb gt mj mk ml mm aw mn bi"><span id="6473" class="mo mp it mk b gy mq mr l ms mt">gcloud compute ssh k8s-worker-1</span><span id="b8ae" class="mo mp it mk b gy mu mr l ms mt">sudo -i<br/>bash &lt;(curl -s <a class="ae lo" href="https://raw.githubusercontent.com/vinod827/k8s-nest/main/iac/k8s/cluster-gcp/install_worker.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/vinod827/k8s-nest/main/iac/k8s/cluster-gcp/install_worker.sh</a>)</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi nb"><img src="../Images/54d6d150613e91e50d0cf0fb376637aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pvgngGvnAU-TwE06a_O3AA.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">工作节点— 1</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi nc"><img src="../Images/cf842d23d1f95028e0bbb62d1f3276f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IGK0WDjl5KcaBXclz73AEw.png"/></div></div></figure><p id="69cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，在作为Kubernetes集群一部分的每个worker节点上运行下面的命令【T4:-</p><pre class="ky kz la lb gt mj mk ml mm aw mn bi"><span id="0189" class="mo mp it mk b gy mq mr l ms mt">kubeadm join 10.156.0.6:6443 — token lglinc.htskyjdchamfi581 — discovery-token-ca-cert-hash sha256:b8f250d499f443311a745ed9b92a7eac1723850a120d53f7c71f2aac347b301b</span></pre><p id="2795" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(<em class="lq">注意:在您的情况下，令牌会有所不同，因此相应地进行更改)</em></p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi nd"><img src="../Images/51ae9b7c6b7e0e0dda500d239d122e76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uPOmHNkQnj7s9qBv3uf5qQ.png"/></div></div></figure><p id="1504" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">瞧！！！你的Kubernetes (k8s)集群已经准备好了</strong></p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/ebf9598a9e51708ca6d18031f3e9a7bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:550/format:webp/1*QLM2nYUALtTMuB9MH-POgQ.png"/></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">库伯内特斯</figcaption></figure><p id="fa21" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">测试您的Kubernetes集群</strong></p><p id="6eed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在主节点上运行下面的命令，您应该会看到Kubernetes (k8s)集群的节点数</p><pre class="ky kz la lb gt mj mk ml mm aw mn bi"><span id="ade7" class="mo mp it mk b gy mq mr l ms mt">kubectl get nodes -o wide</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi nf"><img src="../Images/3b954b327a2e4b255a8b3c0c51f68513.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IoUhpE4AgTCO6tQREEy9HA.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">我们可爱的Kubernetes星团</figcaption></figure><p id="985f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们在集群中运行第一个NGINX pod</p><pre class="ky kz la lb gt mj mk ml mm aw mn bi"><span id="42de" class="mo mp it mk b gy mq mr l ms mt">kubectl run mynginx — image nginx</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi ng"><img src="../Images/2ea8ba0cb5bd76ea95f0b7d5a7f857ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5MhfxApxg0boRfakkBAfqA.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">Kubernetes集群上的NGINX Pod</figcaption></figure><p id="6945" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你喜欢这篇文章:)</p><p id="1f26" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">和往常一样，GitHub资源库中提供了完整的源代码。请随意派生这个库，并在这里贡献您的IaC(基础设施代码)</p><div class="lr ls gp gr lt lu"><a href="https://github.com/vinod827/k8s-nest/tree/main/iac/k8s/cluster-gcp" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd iu gy z fp lz fr fs ma fu fw is bi translated">vinod827/k8s-nest</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">所有k8s都住在这里。通过在GitHub上创建帐户，为vinod827/k8s-nest开发做出贡献。</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">github.com</p></div></div><div class="md l"><div class="nh l mf mg mh md mi ld lu"/></div></div></a></div></div></div>    
</body>
</html>