<html>
<head>
<title>How I replaced a MySQL Log Database with a Serverless Pipeline on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何在AWS上用无服务器管道替换MySQL日志数据库</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/replacing-a-mysql-log-database-with-a-serverless-piepeline-on-aws-2083de09062a?source=collection_archive---------5-----------------------#2021-01-18">https://levelup.gitconnected.com/replacing-a-mysql-log-database-with-a-serverless-piepeline-on-aws-2083de09062a?source=collection_archive---------5-----------------------#2021-01-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3efa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章是关于一个项目，在这个项目中，我替换了一个正在运行的服务的基于MySQL的日志系统。</p><h1 id="a856" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">为什么我们需要自己的日志系统？</h1><p id="7ef2" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">因为Google Analytics或者Firebase是不够的。尽管它支持各种各样的数据分析工具，但您仍然需要一个定制的日志系统来进行详细的分析。对用户操作的详细实验需要在自定义日志流中收集精确设计的日志。</p><h1 id="6475" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">MySQL，你对我很好</h1><p id="f9d0" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">旧的日志系统是基于MySQL RDS的。日志请求通过负载平衡器到达API服务器，就像与应用服务相关的其他请求一样。API服务器将区分与日志相关的URL并调用日志服务，这将触发SQL事务将它们保存在MySQL数据库中。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/896b98159a961dda47abf6c2f0d8dd20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r15FEhZhHL5SuQ54.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">旧数据流</figcaption></figure><p id="6c4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢信:MySQL做得很好。流量峰值通过分片、配置优化和实例升级得到了很好的处理。它没有丢失任何数据，并返回正确的结果。直到读事务要花好几分钟，我才注意到效率低下。</p><p id="4777" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">MySQL对于日志来说太重了。在没有任何删除的情况下堆积数据后，查询变得越来越慢。索引不仅对正在运行的系统有风险，而且毫无意义，因为分析查询是非标准化的。</p><p id="0fc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，log sysetm没有珍惜MySQL的复杂特性。简单的文本存储可以很好地完成这项工作。日志数据库主要是面向写的。在此期间，唯一读取的事务是对周报的几个查询。</p><p id="e8e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，我决定建立一个新的日志管道。</p><h1 id="cfef" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">是突破的时候了</h1><h1 id="45a6" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">从RDS到S3</h1><p id="be4e" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">为了替换MySQL RDS，我创建了一个S3桶，并在其中创建了与旧数据库中的表相对应的文件夹。为了每15分钟将请求中的JSON主体转换成文本文件，Lambda和Kinesis的结合是一个完美的选择。</p><p id="e207" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Lambda解析JSON主体，并根据端点将数据传递给相应的Kinesis数据流。Kinesis数据流定期将堆叠的数据刷新到Kinesis Firehose。Kinesis Firehose将数据编码成指定的数据格式，如parquet或Apache ORC，最后将它们保存在S3文件夹中。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi me"><img src="../Images/d07be98d8ae2aa0c842b0038fcc44ade.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/0*j5WTE7Fziu-L5fH1.png"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">将RDS替换为S3，将EC2替换为Lambda和Kinesis</figcaption></figure><h2 id="b767" class="mf km iq bd kn mg mh dn kr mi mj dp kv jy mk ml kz kc mm mn ld kg mo mp lh mq bi translated">用负载平衡器连接日志流</h2><blockquote class="mr ms mt"><p id="ec41" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated"><em class="iq">TL；博士:转到</em> <strong class="jp ir"> <em class="iq">三审</em></strong><em class="iq"/></p></blockquote><p id="edfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在是时候将日志流的入口Lambda连接到API了。</p><p id="6b91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第一次试验:添加API网关将请求重定向到Lambda </strong></p><p id="0aee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最初的想法是使用API网关。API Gateway接受请求并将它们传递给Lambda函数。这是第一个挑战。API Gateway确实允许你为一个点使用自定义域，只要它属于你；但是，您不能完全自定义URL。API Gateway以这样的格式分配它:<a class="ae my" href="https://yourdomain.com/custom/path/{API_GATEWAY_ID}." rel="noopener ugc nofollow" target="_blank"><em class="mu"/><strong class="jp ir"><em class="mu">【API _ Gateway _ ID }</em></strong>。</a></p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mz"><img src="../Images/9fbf9c97f595b4d8870e5e364085431b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qmG2YQGW3UuCq8Vv.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">第一次尝试——为API Gateway上的日志收集创建新的URL，并将数据交付给Lambda</figcaption></figure><p id="f658" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">web服务很可能采用这种设计，因为更改端点相对容易。然而，在应用服务的情况下，保留旧的端点是很重要的，因为是旧的版本。即使我们更新了移动应用程序以在新的端点上运行日志记录，大多数人仍会使用旧版本。我们承担不起丢失数据的后果。</p><p id="0da2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第二次尝试:让传统负载平衡器将请求重定向到Lambda </strong></p><p id="afca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二个设计稍微走了一点弯路，让负载平衡器将日志相关的请求重定向到Lambda函数。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi na"><img src="../Images/44354dccefa96fed1bdad335566a0a64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kNBD5CISN3GhP7-Q.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">第二种设计——只将与日志相关的请求重定向到Lambda</figcaption></figure><p id="037b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个挑战就在这里。我们在经典的负载平衡器(CLB)上运行，它不提供基于请求端点路径的重定向。</p><p id="d1b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第三次试验:将经典负载平衡器更新为应用负载平衡器</strong></p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nb"><img src="../Images/4b096222a8e6bb813a42535026d1cf0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SqimthYmZtwBMZvg.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">第三种设计—将传统负载平衡器更新为应用程序负载平衡器</figcaption></figure><p id="5ede" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对第二个设计稍加修改就成功了。我将经典负载平衡器升级为应用程序负载平衡器，它提供基于端点路径的重定向。</p><h1 id="7af1" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">如何访问数据</h1><p id="06eb" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">虽然该设计被证明可以成功地堆叠数据，但我们需要一种方法来访问文本文件并运行一些查询。因为到目前为止团队是用SQL查询分析数据的，所以支持SQL查询是一个至关重要的需求。快速交易是一个优势。</p><p id="6edc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">亚马逊电子病历是最好的选择。虽然有点贵，但很值得。它支持流行的数据分析产品，如Spark、Hive、Flink、Zeppelin等。云大数据平台易于扩展，仅按运行时间收费。只要你不忘记关闭实例，账单就不会让你吃惊。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nb"><img src="../Images/112126f77c9d68dac9e3fc5c2f6921e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nRXOqbWWiLg2M4yM.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">EMR作为数据分析工具访问S3</figcaption></figure><h1 id="c5e3" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">我能说转变是成功的吗？</h1><p id="4641" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">对于新的体系结构，一些问题是意料之中的。</p><h2 id="4807" class="mf km iq bd kn mg mh dn kr mi mj dp kv jy mk ml kz kc mm mn ld kg mo mp lh mq bi translated">复杂结构</h2><p id="b386" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">以前，一个EC2实例处理所有事情。它接收、解析、保存数据。新设计被分解成4个AWS产品:ALB、Lambda、Kinesis Datastream和Kinesis Firehose。与旧的简单设计相比，新设计需要额外的关注来理解日志流。</p><h2 id="444a" class="mf km iq bd kn mg mh dn kr mi mj dp kv jy mk ml kz kc mm mn ld kg mo mp lh mq bi translated">昂贵的电子病历</h2><p id="14a6" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">EMR价格由EMR本身和计算能力(EC2)两部分组成。截至2021年1月，EMR实例的价格从0.193美元开始。与旧日志系统中的RDS相比，它的成本相当高。</p><p id="0eb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尽管如此，我还是要说利大于弊。</p><h2 id="cca4" class="mf km iq bd kn mg mh dn kr mi mj dp kv jy mk ml kz kc mm mn ld kg mo mp lh mq bi translated">运营成本更低</h2><p id="cd76" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">MySQL RDS实例的成本预计是Lambda、Kinesis Datastream、Kinesis Firehose、S3和EMR的总成本的两倍。甚至旧系统的部分成本也隐藏在主API服务器的成本之下，因为它们处理日志流量。</p><h2 id="bc79" class="mf km iq bd kn mg mh dn kr mi mj dp kv jy mk ml kz kc mm mn ld kg mo mp lh mq bi translated">易于维护</h2><p id="1954" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">新的无服务器架构需要更少的维护。Lambda和Kinesis都提供自动缩放功能；所以，没有必要让一个开发者一直看着流量。</p><p id="cba6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，创建和删除日志流也很方便。尤其是一个经常进行特性测试的团队会充分享受到这种好处。您不必再修改服务器中的代码并部署它们。Lambda中的几行代码和Kinesis上的几个点击就可以了。</p><h2 id="2835" class="mf km iq bd kn mg mh dn kr mi mj dp kv jy mk ml kz kc mm mn ld kg mo mp lh mq bi translated">更强大的数据分析工具</h2><p id="0d19" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">虽然以前的系统只提供MySQL查询进行数据分析，但EMR中包含了各种大数据分析框架。如果您想最大限度地提高速度，您可以轻松地扩大实例。</p><h1 id="0596" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">给行驶中的汽车换轮子</h1><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nc"><img src="../Images/c4325daa152c87cde3ab01c19f87ec9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-GG17r_ZVATuYbaw.jpeg"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">照片由<a class="ae my" href="https://unsplash.com/@gohrhyyan?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Goh Rhy Yan </a>在<a class="ae my" href="https://unsplash.com/s/photos/tire-change?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="ac8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个过程特别复杂，因为它是对正在运行的服务的日志流的替换。</p><h2 id="94f0" class="mf km iq bd kn mg mh dn kr mi mj dp kv jy mk ml kz kc mm mn ld kg mo mp lh mq bi translated">为以前发布的应用程序保留旧的端点</h2><p id="4792" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">不是每个用户都在同一个页面上。一些用户会永远保留第一次下载的版本。由于这些旧的应用程序将它们的数据传送到旧的端点，因此使用新端点进行日志记录的设计是不可行的。</p><h2 id="812b" class="mf km iq bd kn mg mh dn kr mi mj dp kv jy mk ml kz kc mm mn ld kg mo mp lh mq bi translated">无缝管理转换</h2><p id="13e0" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">缺少值会破坏数据的完整性。以日志流替换为代价的数据泄漏是不可接受的。这个转换必须经过周密的计划，这样我们就不会同时丢失一个请求。</p><p id="af58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个项目是去年设计并实施的。虽然我查阅了AWS的更新说明以了解最新情况，但是任何评论都是非常受欢迎的！感谢阅读。</p></div></div>    
</body>
</html>