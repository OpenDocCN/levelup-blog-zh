<html>
<head>
<title>Serverless local logging 🚀</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器本地日志记录🚀</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/serverless-local-logging-cc966ace0d0d?source=collection_archive---------2-----------------------#2021-05-30">https://levelup.gitconnected.com/serverless-local-logging-cc966ace0d0d?source=collection_archive---------2-----------------------#2021-05-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/214f65a21c6d9b2d3819160424ae7a2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pKhA0VUv5q4tlJICAv3uUA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">乔安娜·科辛斯卡在<a class="ae jd" href="https://unsplash.com/s/photos/pattern-background-hex?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><div class=""><h2 id="035f" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">本地运行无服务器应用时的实用日志。</h2></div><p id="d6e9" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当使用像<a class="ae jd" href="https://github.com/dherault/serverless-offline" rel="noopener ugc nofollow" target="_blank">无服务器离线</a>这样的框架时，我认为最大的痛点之一是访问将在云中生成的对等<a class="ae jd" href="https://aws.amazon.com/cloudwatch/" rel="noopener ugc nofollow" target="_blank"> CloudWatch日志</a>🔥。本文向您展示了在本地以最有效的方式无服务器离线运行时，如何轻松地模拟CloudWatch日志。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h2 id="0545" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">最优解！✔️</h2><p id="3ad9" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">当我最初着手解决这个问题时，我想的正是我想要实现的目标:</p><ol class=""><li id="901d" class="mw mx jg kx b ky kz lb lc le my li mz lm na lq nb nc nd ne bi translated"><strong class="kx jh">访问</strong>:可以访问日志，不仅仅是通过标准的终端输出，还可以在运行开发测试或基本负载测试时检查物理日志(例如使用<a class="ae jd" href="https://artillery.io/" rel="noopener ugc nofollow" target="_blank"><em class="nf">cannon</em></a>),就像我使用CloudWatch一样。如果需要的话，我希望能够在闲暇时阅读、导出和操作，以及在开发过程中引用..🤔</li><li id="e489" class="mw mx jg kx b ky ng lb nh le ni li nj lm nk lq nb nc nd ne bi translated"><strong class="kx jh">漂亮</strong>:我想让日志变得<em class="nf">漂亮</em>！没有什么比黑白冗长平凡日志更糟糕的了！🙈</li><li id="91e8" class="mw mx jg kx b ky ng lb nh le ni li nj lm nk lq nb nc nd ne bi translated">仅本地:我只是想让它影响本地无服务器运行，而不是部署到云中。在云中，CloudWatch是AWS上的王者，我不需要编写额外的物理日志。👑</li><li id="fd2f" class="mw mx jg kx b ky ng lb nh le ni li nj lm nk lq nb nc nd ne bi translated">我希望能够在多个项目中使用这个解决方案。(<em class="nf">干</em>)。👊🏼</li></ol><h2 id="f988" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">解决方案是…自定义记录器！✏️</h2><p id="0c09" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">我对此问题的解决方案是创建一个自定义记录器，它将:</p><ol class=""><li id="ed2e" class="mw mx jg kx b ky kz lb lc le my li mz lm na lq nb nc nd ne bi translated"><strong class="kx jh">仅脱机</strong>:仅在脱机模式下本地记录到文件。</li><li id="bd0c" class="mw mx jg kx b ky ng lb nh le ni li nj lm nk lq nb nc nd ne bi translated"><strong class="kx jh">分割日志</strong>:我想把日志分割成“仅错误”和“所有”组合日志，以便于查看。</li><li id="016a" class="mw mx jg kx b ky ng lb nh le ni li nj lm nk lq nb nc nd ne bi translated"><strong class="kx jh">丰富多彩的</strong>:我希望日志丰富多彩，易于阅读，无论是在物理日志中，还是在终端输出中。</li><li id="a89b" class="mw mx jg kx b ky ng lb nh le ni li nj lm nk lq nb nc nd ne bi translated"><strong class="kx jh">调试日志</strong>:我还想在本地记录调试日志，但不是在部署到云时。</li><li id="51df" class="mw mx jg kx b ky ng lb nh le ni li nj lm nk lq nb nc nd ne bi translated"><strong class="kx jh">测试</strong>:我使用<a class="ae jd" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank"> Jest </a>进行我的TDD/BDD/集成测试，并且在运行测试时不想记录到终端或物理磁盘，但是在本地的所有其他场景中，我希望将其记录到磁盘<strong class="kx jh"> <em class="nf">和</em> </strong>终端。</li></ol><p id="ed6c" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">考虑到这一点，我使用<a class="ae jd" href="https://www.npmjs.com/package/winston" rel="noopener ugc nofollow" target="_blank"> Winston </a>创建了一个定制的logger包，当在离线模式下运行时，它将在本地记录到磁盘(【all and error only，包括调试日志)，而当部署到AWS时，它将只正常记录到CloudWatch。简单！🤘</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h2 id="58b9" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">一个简单的例子..</h2><p id="e443" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">下面是一个非常基本的例子，告诉你如何做到这一点。我个人喜欢<a class="ae jd" href="https://en.wikipedia.org/wiki/Monorepo" rel="noopener ugc nofollow" target="_blank"> Monorepo的</a>到<a class="ae jd" href="https://lerna.js.org/" rel="noopener ugc nofollow" target="_blank"> Lerna </a>或<a class="ae jd" href="https://nx.dev/" rel="noopener ugc nofollow" target="_blank"> Nx </a>，所以有一个可重用的日志包是有意义的，它可以跨所有服务使用，而不是发布它并通过<a class="ae jd" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank"> npm </a> ( <em class="nf">将其拉入每个repo，尽管这显然是一个替代方案！</em></p><p id="63b7" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh"> <em class="nf">注</em> </strong> <em class="nf">:当创建一个实际的生产包时，您可以通过配置来更改文件夹目的地、日志名称等。</em></p><figure class="nm nn no np gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nl"><img src="../Images/e77a5025ad0656cd3d2642bcfb04d11d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KdDRRoG5lkVc_r-AKP7O9A.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">记录器的基本类型脚本代码示例。</figcaption></figure><p id="3a3a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这意味着，当您离线运行无服务器时，<em class="nf">process . env .</em><strong class="kx jh"><em class="nf">IS _ OFFLINE</em></strong><em class="nf"/><a class="ae jd" href="https://www.serverless.com/plugins/serverless-offline#the-processenvis_offline-variable" rel="noopener ugc nofollow" target="_blank">环境变量已经为其设置好了</a>，因此我们可以区分在云中运行还是通过无服务器离线运行的上下文。</p><p id="fdd0" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，离线模式下的日志被写入本地磁盘，如下图所示，位于一个日志文件夹中(<em class="nf">被很好地分离出来</em>)。</p><figure class="nm nn no np gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nq"><img src="../Images/c3909ee1ec6cf7c1d798387276f55e53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2f-fCYPPUoasiexiZALDDA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">示例本地日志记录文件夹和日志在全部(合并)和仅错误之间拆分。</figcaption></figure><p id="d40b" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当使用这个自定义日志记录器和离线运行无服务器时，本地日志的输出是丰富多彩的，易于阅读，颜色编码到日志级别，时间戳，分割日志，其中还包括调试日志。每个lambda也有自己的日志，就像CloudWatch一样。</p><figure class="nm nn no np gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nr"><img src="../Images/79d5d9ed6e333e6b2a43b54617f9cc82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*699IvGHfcupIrpaiNVws_A.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用自定义记录器时的日志输出示例。</figcaption></figure><p id="7e9c" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在终端中，日志也以类似的方式格式化，并进行完美的颜色编码，易于阅读，两种类型的日志还包括时间戳:</p><figure class="nm nn no np gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ns"><img src="../Images/d05dd9f1773b6c1861425eff90e50117.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ne0Ak-Qv5FSfAQTz8Or2_Q.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用自定义记录器的无服务器离线终端输出。</figcaption></figure><p id="b997" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当通过Jest运行测试时，除了Jest测试通过和失败之外，我不想在终端日志中看到任何输出，所以在这个场景中，我在<code class="fe nt nu nv nw b">node_modules</code>旁边添加了一个<code class="fe nt nu nv nw b">__mocks__</code>文件夹，它具有以下名称和代码:</p><p id="31e1" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh"> /__mocks__/winston.ts </strong></p><figure class="nm nn no np gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nx"><img src="../Images/4f4b02d732fc063102167ea2f34c5a0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bkp3ACTyYoftyUxWLl98aA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用Jest模仿Winston包的基本示例。</figcaption></figure><p id="3319" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这意味着这个场景中的底层Winston包在只运行测试时被<a class="ae jd" href="https://jestjs.io/docs/manual-mocks" rel="noopener ugc nofollow" target="_blank">用空的jest函数模仿了</a>，所以我们覆盖了这个功能，并且不在Jest测试运行输出中显示任何日志或者写到磁盘。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="3604" class="ny lz jg bd ma nz oa ob md oc od oe mg km of kn mj kp og kq mm ks oh kt mp oi bi translated">包扎</h1><p id="168b" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">我希望您发现这个基本示例很有用，并可以在此基础上继续学习！</p><p id="9ce9" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们连接以下任何一项:</p><p id="8ad1" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae jd" href="https://www.linkedin.com/in/lee-james-gilmore/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/lee-james-gilmore/</a>T8<a class="ae jd" href="https://twitter.com/LeeJamesGilmore" rel="noopener ugc nofollow" target="_blank">https://twitter.com/LeeJamesGilmore</a></p><p id="f5a3" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你觉得这篇文章有用，请随时用虚拟咖啡<a class="ae jd" href="https://www.buymeacoffee.com/leegilmore" rel="noopener ugc nofollow" target="_blank">https://www.buymeacoffee.com/leegilmore</a>来支持我，不管怎样，让我们联系和聊天吧！☕️</p><p id="24e7" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你喜欢这篇文章，请关注我的简介<a class="ae jd" href="https://medium.com/u/2906c6def240?source=post_page-----39c4f4ae5aff----------------------" rel="noopener">李·詹姆斯·吉尔摩</a>以获取更多的文章/系列，不要忘记联系我并问好👋</p><p id="b621" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh">本文由</strong><a class="ae jd" href="https://www.sedai.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kx jh">sedai . io</strong></a>赞助</p><figure class="nm nn no np gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oj"><img src="../Images/4c77bc2d275bd557dda90aa2fe842d2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LJqkQYFI-KAGHOI3cHWxJQ.png"/></div></div></figure><h1 id="43b8" class="ny lz jg bd ma nz ok ob md oc ol oe mg km om kn mj kp on kq mm ks oo kt mp oi bi translated">关于我</h1><p id="7e8f" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated"><strong class="kx jh"> " </strong> <em class="nf">大家好，我是Lee，英国的AWS认证解决方案架构师和多语言软件工程师，是一名云架构师和首席开发人员，在过去5年中主要从事AWS上的全栈JavaScript工作。</em></p><p id="4e37" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我认为自己是一个无服务器的布道者，热爱AWS、创新、软件架构和技术。<strong class="kx jh"/></p><p id="5c84" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh"> **所提供的信息是我个人的观点，我对这些信息的使用不承担任何责任。</strong></p></div></div>    
</body>
</html>