<html>
<head>
<title>Solving Bitbucket Pipelines Memory Issues</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解决位桶管道内存问题</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/solving-bitbucket-pipelines-memory-issues-62c5a236ef96?source=collection_archive---------0-----------------------#2020-09-08">https://levelup.gitconnected.com/solving-bitbucket-pipelines-memory-issues-62c5a236ef96?source=collection_archive---------0-----------------------#2020-09-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2a65e74e106dc570f2446a278d965162.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jeV2DHbpCzYRyGhu"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@yancymin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">扬西·敏</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="c75e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于我们的团队越来越多地使用位桶管道，我们更经常遇到的是位桶管道因错误<code class="fe lb lc ld le b">Container ‘docker' exceeded memory limit</code>而失败。在这篇文章中，我将告诉你如何解决这个问题。本文的范围是解决在Bitbucket管道中使用Docker服务容器时的内存问题，但是当您不使用这个特定的服务容器时，肯定可以使用特定的部分。</p><figure class="lg lh li lj gt jr gh gi paragraph-image"><div class="gh gi lf"><img src="../Images/14f52548c658a56545b33f5739b3ec70.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*xO2fu6DwoTMwLpr34FLuGQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">超出内存错误位桶管道</figcaption></figure><h1 id="4d94" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated"><strong class="ak">TL；博士</strong></h1><p id="c444" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">使用<em class="mn">bit bucket-pipelines . yml</em>中的<code class="fe lb lc ld le b">(option).size</code>和<code class="fe lb lc ld le b">definitions.services.docker.memory</code>来增加管道和服务容器中的内存限制。</p><pre class="lg lh li lj gt mo le mp mq aw mr bi"><span id="e534" class="ms ll iq le b gy mt mu l mv mw">...</span><span id="1af6" class="ms ll iq le b gy mx mu l mv mw">definitions:<br/>  services:<br/>    docker:<br/>      memory: 7128</span><span id="8235" class="ms ll iq le b gy mx mu l mv mw">pipelines:<br/>  branches:<br/>    master:<br/>      - step:<br/>          size: 2x<br/>          name: 'PIPELINE NAME'<br/>          script:<br/>            - ...<br/>...</span></pre><h1 id="7b46" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">一些背景</h1><p id="bf51" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">我们将位桶管道用于几个任务；自动化测试、林挺代码、版本控制(增加版本号+创建/更新发布分支)以及构建和部署工件。后者可以是，例如；</p><ul class=""><li id="29ca" class="my mz iq kf b kg kh kk kl ko na ks nb kw nc la nd ne nf ng bi translated">构建Docker映像(Python)并将它们上传到AWS ECR，然后在ECS上触发服务的“强制新部署”。</li><li id="fdcc" class="my mz iq kf b kg nh kk ni ko nj ks nk kw nl la nd ne nf ng bi translated">构建Python库并将它们发布到我们的私有PyPI注册中心。</li><li id="cb78" class="my mz iq kf b kg nh kk ni ko nj ks nk kw nl la nd ne nf ng bi translated">构建Angular应用程序并将构建文件上传到S3，然后触发CloudFront失效。</li></ul><p id="6da7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">大多数时候，在Bitbucket管道中构建Docker容器会导致我们的问题。我们是一个数据科学实验室，对大型机器学习和深度学习包并不陌生。有时，在Docker容器中安装这些包可能需要很长时间，没有什么比长时间等待最终失败更令人沮丧的了。</p><h2 id="d4cc" class="ms ll iq bd lm nm nn dn lq no np dp lu ko nq nr ly ks ns nt mc kw nu nv mg nw bi translated">bitbucket-pipelines.yml示例</h2><p id="5a7a" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">让我们假设如下，我们有一个内容如下的<code class="fe lb lc ld le b">bitbucket-pipelines.yml</code>。该文件定义了在管道中采取的操作。我们在资源库的根目录下还有一个<code class="fe lb lc ld le b">Dockerfile</code>，包含一个需要大量内存的进程，这个<code class="fe lb lc ld le b">Dockerfile</code>实际上将在管道中构建。</p><p id="596f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">bit bucket-pipelines . yml</strong></p><pre class="lg lh li lj gt mo le mp mq aw mr bi"><span id="791e" class="ms ll iq le b gy mt mu l mv mw">pipelines:<br/>  branches:<br/>    master:<br/>      - step:<br/>          name: 'Deploy'<br/>          script:<br/>            - curl -O <a class="ae kc" href="https://bootstrap.pypa.io/get-pip.py" rel="noopener ugc nofollow" target="_blank">https://bootstrap.pypa.io/get-pip.py</a> &amp;&amp; python get-pip.py &amp;&amp; pip install awscli<br/>            - docker build -t $PROJECT_NAME .<br/>            - docker tag $PROJECT_NAME:latest $ACCOUNT_ID.dkr.ecr.eu-west-1.amazonaws.com/$PROJECT_NAME:latest<br/>            - docker push $ACCOUNT_ID.dkr.ecr.eu-west-1.amazonaws.com/$PROJECT_NAME<br/>          services:<br/>            - docker</span></pre><p id="6cb4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这条管道的作用:</p><ul class=""><li id="d90b" class="my mz iq kf b kg kh kk kl ko na ks nb kw nc la nd ne nf ng bi translated">安装pip</li><li id="9422" class="my mz iq kf b kg nh kk ni ko nj ks nk kw nl la nd ne nf ng bi translated">安装awcli以与AWS通信(我们已经设置了包含AWS凭证的存储库变量)</li><li id="d7f0" class="my mz iq kf b kg nh kk ni ko nj ks nk kw nl la nd ne nf ng bi translated">建立形象</li><li id="f457" class="my mz iq kf b kg nh kk ni ko nj ks nk kw nl la nd ne nf ng bi translated">标记图像</li><li id="ccb4" class="my mz iq kf b kg nh kk ni ko nj ks nk kw nl la nd ne nf ng bi translated">将图像推送到AWS ECR</li></ul><p id="119d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">services: — docker</code>行允许我们在这个管道中使用Docker。</p><p id="b8e1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">注意:</strong>我们实际上已经构建了我们自己的映像，包含了我们在管道中需要的所有需求(awscli、林挺等等)，所以我们脚本中的第一行<code class="fe lb lc ld le b">curl -0..</code>在我们当前的设置中实际上已经被淘汰了。</p><h1 id="9968" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">增加记忆</h1><blockquote class="nx"><p id="7c9a" class="ny nz iq bd oa ob oc od oe of og la dk translated">用于管道中Docker操作的Docker-in-Docker守护进程被视为服务容器，因此默认内存限制为1024 MB。这也可以通过在定义部分更改内置docker服务的内存设置来调整为128 MB和3072/7128 MB之间的任何值。</p><p id="f913" class="ny nz iq bd oa ob oc od oe of og la dk translated">来源:<a class="ae kc" href="https://support.atlassian.com/bitbucket-cloud/docs/databases-and-service-containers/" rel="noopener ugc nofollow" target="_blank">support.atlassian.com</a></p></blockquote><p id="6a48" class="pw-post-body-paragraph kd ke iq kf b kg oh ki kj kk oi km kn ko oj kq kr ks ok ku kv kw ol ky kz la ij bi translated">每步的默认可用内存是4096 MB。在上面的引用中可以看到，Docker被视为一个服务容器，默认情况下，它将这个服务容器的限制设置为1024 MB。我们可以做的第一件事是尝试将这个限制增加到3072 MB。这是您可以在管道中使用的剩余内存，另外1024 MB已经为开销预留了。如果您没有使用服务容器，那么您可以跳过这一部分，因为在您的步骤中已经有了最大的可用资源。</p><p id="5410" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">增加内存而不调整<code class="fe lb lc ld le b">size</code>值不会影响构建时间。您可以通过在现有的<code class="fe lb lc ld le b">bitbucket-pipelines.yml</code>文件中添加以下内容来增加Docker服务容器的内存限制。</p><pre class="lg lh li lj gt mo le mp mq aw mr bi"><span id="9f70" class="ms ll iq le b gy mt mu l mv mw">definitions:<br/>  services:<br/>    docker:<br/>      memory: 3072</span><span id="6b9b" class="ms ll iq le b gy mx mu l mv mw">pipelines:<br/>  branches:<br/>    master:<br/>      - step:<br/>          name: 'Deploy'<br/>          script:<br/>            - curl -O <a class="ae kc" href="https://bootstrap.pypa.io/get-pip.py" rel="noopener ugc nofollow" target="_blank">https://bootstrap.pypa.io/get-pip.py</a> &amp;&amp; python get-pip.py &amp;&amp; pip install awscli<br/>            - docker build -t $PROJECT_NAME .<br/>            - docker tag $PROJECT_NAME:latest $ACCOUNT_ID.dkr.ecr.eu-west-1.amazonaws.com/$PROJECT_NAME:latest<br/>            - docker push $ACCOUNT_ID.dkr.ecr.eu-west-1.amazonaws.com/$PROJECT_NAME<br/>          services:<br/>            - docker</span></pre><p id="410e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当调整Docker服务容器的内存不足，并且您的管道仍然由于内存问题而失败时，您可以使用<code class="fe lb lc ld le b">size</code>将管道内的资源加倍(总共8192 MB)。请注意，这实际上会使构建时间加倍，所以默认情况下不要增加大小。您可能希望寻找其他方法来减少管道中所需的内存。</p><p id="f179" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以为整个管道设置<code class="fe lb lc ld le b">size</code>,也可以分步设置。如果您的管道中有许多步骤，但只有一个步骤由于内存问题而失败，我建议只为需要额外资源的步骤加倍资源，这样您在该特定步骤中只需花费两倍的构建时间。如果您将整个管道的资源增加一倍，您将为整个管道的构建分钟数支付两倍的费用，这可能是不必要的。下面举个例子来增加单个步骤的记忆。</p><pre class="lg lh li lj gt mo le mp mq aw mr bi"><span id="be29" class="ms ll iq le b gy mt mu l mv mw">definitions:<br/>  services:<br/>    docker:<br/>      memory: 7128</span><span id="e5d1" class="ms ll iq le b gy mx mu l mv mw">pipelines:<br/>  branches:<br/>    master:<br/>      - step:<br/>          size: 2x<br/>          name: 'Deploy'<br/>          script:<br/>            - curl -O <a class="ae kc" href="https://bootstrap.pypa.io/get-pip.py" rel="noopener ugc nofollow" target="_blank">https://bootstrap.pypa.io/get-pip.py</a> &amp;&amp; python get-pip.py &amp;&amp; pip install awscli<br/>            - docker build -t $PROJECT_NAME .<br/>            - docker tag $PROJECT_NAME:latest $ACCOUNT_ID.dkr.ecr.eu-west-1.amazonaws.com/$PROJECT_NAME:latest<br/>            - docker push $ACCOUNT_ID.dkr.ecr.eu-west-1.amazonaws.com/$PROJECT_NAME<br/>          services:<br/>            - docker</span></pre><p id="4fd5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所见，我们在步骤中添加了一个新属性，名为<code class="fe lb lc ld le b">size</code>，并赋予其值<code class="fe lb lc ld le b">2x</code>。你现在可以在<code class="fe lb lc ld le b">1x</code>和<code class="fe lb lc ld le b">2x</code>之间选择，默认为<code class="fe lb lc ld le b">1x</code>。你可能也注意到了，我把<code class="fe lb lc ld le b">definitions.services.docker</code>的内存增加到了7128 MB(总共8192 MB——预留1024 MB)。就像我之前提到的，如果您没有使用服务容器，将<code class="fe lb lc ld le b">size</code>设置为值<code class="fe lb lc ld le b">2x</code>就足以在一个步骤中使资源翻倍。还要注意，如果您在另一个步骤中使用Docker服务容器，您也需要增加该步骤的大小。</p><p id="8691" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想增加整个管道的资源，您可以简单地执行以下操作。就像我之前说的，你将为你的整个管道支付两倍的建造时间。</p><pre class="lg lh li lj gt mo le mp mq aw mr bi"><span id="baa3" class="ms ll iq le b gy mt mu l mv mw">options:<br/>  size: 2x</span><span id="f8fb" class="ms ll iq le b gy mx mu l mv mw">definitions:<br/>  services:<br/>    docker:<br/>      memory: 7128</span><span id="88e6" class="ms ll iq le b gy mx mu l mv mw">pipelines:<br/>  branches:<br/>    master:<br/>      - step:<br/>          name: 'Deploy'<br/>          script:<br/>            - curl -O <a class="ae kc" href="https://bootstrap.pypa.io/get-pip.py" rel="noopener ugc nofollow" target="_blank">https://bootstrap.pypa.io/get-pip.py</a> &amp;&amp; python get-pip.py &amp;&amp; pip install awscli<br/>            - docker build -t $PROJECT_NAME .<br/>            - docker tag $PROJECT_NAME:latest $ACCOUNT_ID.dkr.ecr.eu-west-1.amazonaws.com/$PROJECT_NAME:latest<br/>            - docker push $ACCOUNT_ID.dkr.ecr.eu-west-1.amazonaws.com/$PROJECT_NAME<br/>          services:<br/>            - docker</span></pre><h1 id="b7e5" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">其他方法</h1><p id="dc0a" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">当您使用大量需要特定包的图像时，如tensorflow、fbprophet或pytorch，创建已经包含特定组合的基础图像可能也很有趣，如Python的X版本与fbprophet X版本的组合。如果您这样做，您将不必在特定项目的管道中反复安装这些包，这将减少特定项目的构建时间。请记住在需要时更新这些基础映像，并使用基础映像更新每个<code class="fe lb lc ld le b">Dockerfile</code>。</p><h1 id="6f29" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">问题、建议或反馈</h1><p id="5337" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">如果您对本文有任何问题、建议或反馈，请告诉我！</p></div></div>    
</body>
</html>