<html>
<head>
<title>Consumer Tests with Pact, Junit5, SpringBoot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pact、Junit5、SpringBoot的消费者测试</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/consumer-tests-with-pact-junit5-springboot-b9dff34aa302?source=collection_archive---------1-----------------------#2018-12-24">https://levelup.gitconnected.com/consumer-tests-with-pact-junit5-springboot-b9dff34aa302?source=collection_archive---------1-----------------------#2018-12-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d483e33d13c4926c1c97a582bdab8df3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2lmvWuZk_-0AWVYJ"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@aniket940518?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Aniket Bhattacharya </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><blockquote class="kd ke kf"><p id="cd1d" class="kg kh ki kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">你会放火烧你的房子来测试你的烟雾报警器吗？<br/><a class="ae kc" href="https://docs.pact.io/" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://docs . pact . io</em></a></p></blockquote><p id="9ff6" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">消费者创建消费者测试，该测试确认消费者和它所依赖的提供者之间的契约。</p><p id="89f6" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">Pact是消费者驱动的，也就是说，它是由消费者运行的测试驱动的，正如我们将在下面看到的。</p><p id="464e" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">pact框架基于消费者定义的交互来创建Pact文件。然后用它来验证服务交互的提供者。在标记为成功之前，提供者需要通过基于来自消费者的文件的测试。</p><p id="0afe" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">这种验证是由Pact框架提供的，它允许对消费者和提供者进行独立测试，而不必将两者集成在一起。当您有过多的微服务时，这是一个巨大的优势。</p><p id="6165" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">以下是Java、Spring和Junit5中使用的。</p><h1 id="2225" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated"><strong class="ak">消费端</strong></h1><p id="1b2c" class="pw-post-body-paragraph kg kh iq kj b kk mg km kn ko mh kq kr lf mi ku kv lg mj ky kz lh mk lc ld le ij bi translated"><a class="ae kc" href="https://github.com/DiUS/pact-jvm/tree/master/pact-jvm-consumer-junit5" rel="noopener ugc nofollow" target="_blank">https://github . com/DiUS/pact-JVM/tree/master/pact-JVM-consumer-JUnit 5</a></p><h2 id="0ac5" class="ml lj iq bd lk mm mn dn lo mo mp dp ls lf mq mr lw lg ms mt ma lh mu mv me mw bi translated">POM摘录</h2><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="d47e" class="ml lj iq nc b gy ng nh l ni nj">   &lt;dependency&gt;<br/>            &lt;groupId&gt;au.com.dius&lt;/groupId&gt;<br/>            &lt;artifactId&gt;pact-jvm-consumer-junit5_2.12&lt;/artifactId&gt;<br/>            &lt;version&gt;3.5.24&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>        <br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.hamcrest&lt;/groupId&gt;<br/>            &lt;artifactId&gt;hamcrest-core&lt;/artifactId&gt;<br/>            &lt;version&gt;1.3&lt;/version&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>    &lt;/dependency&gt;<br/><br/><br/>    &lt;build&gt;<br/>        &lt;plugins&gt;<br/>            &lt;plugin&gt;<br/>                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br/>                &lt;version&gt;3.8.0&lt;/version&gt;<br/>                &lt;configuration&gt;<br/>                    &lt;source&gt;1.8&lt;/source&gt;<br/>                    &lt;target&gt;1.8&lt;/target&gt;<br/>                &lt;/configuration&gt;<br/>            &lt;/plugin&gt;<br/>            &lt;plugin&gt;<br/>                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;<br/>                &lt;configuration&gt;<br/>                    &lt;systemPropertyVariables&gt;<br/>                        &lt;pact.rootDir&gt;target/pacts&lt;/pact.rootDir&gt;<br/>                    &lt;/systemPropertyVariables&gt;<br/>                &lt;/configuration&gt;<br/>            &lt;/plugin&gt;<br/>        &lt;/plugins&gt;<br/>    &lt;/build&gt;</span></pre><h2 id="3f2e" class="ml lj iq bd lk mm mn dn lo mo mp dp ls lf mq mr lw lg ms mt ma lh mu mv me mw bi translated">测试示例</h2><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="e676" class="ml lj iq nc b gy ng nh l ni nj">import au.com.dius.pact.consumer.MockServer;<br/>import au.com.dius.pact.consumer.Pact;<br/>import au.com.dius.pact.consumer.dsl.PactDslWithProvider;<br/>import au.com.dius.pact.consumer.junit5.PactConsumerTestExt;<br/>import au.com.dius.pact.consumer.junit5.PactTestFor;<br/>import au.com.dius.pact.model.RequestResponsePact;<br/>import org.apache.http.HttpResponse;<br/>import org.apache.http.client.fluent.Request;<br/>import org.junit.jupiter.api.Test;<br/>import org.junit.jupiter.api.extension.ExtendWith;<br/><br/>import static org.hamcrest.CoreMatchers.is;<br/>import static org.hamcrest.MatcherAssert.assertThat;<br/>import static org.hamcrest.core.IsEqual.equalTo;<br/><br/><br/>@ExtendWith(PactConsumerTestExt.class)<br/>@PactTestFor(providerName = "test_provider", port = "1234")<br/>public class ATest {<br/><br/><br/>    @Pact(provider="test_provider", consumer="test_consumer")<br/>    public RequestResponsePact createPact(PactDslWithProvider builder) {<br/>        return builder<br/>                .given("test state")<br/>                .uponReceiving("ExampleJavaConsumerPactTest test interaction")<br/>                .path("/")<br/>                .method("GET")<br/>                .willRespondWith()<br/>                .status(200)<br/>                .body("{\"responsetest\": true}")<br/>                .toPact();<br/>    }<br/><br/>    @Test<br/>    void test(MockServer mockServer) throws Exception {<br/>        HttpResponse httpResponse = Request.Get(mockServer.getUrl() + "/").execute().returnResponse();<br/>        assertThat(httpResponse.getStatusLine().getStatusCode(), is(equalTo(200)));<br/>    }<br/>}</span></pre><h2 id="6e16" class="ml lj iq bd lk mm mn dn lo mo mp dp ls lf mq mr lw lg ms mt ma lh mu mv me mw bi translated">契约文件</h2><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="850c" class="ml lj iq nc b gy ng nh l ni nj">{<br/>    "provider": {<br/>        "name": "test_provider"<br/>    },<br/>    "consumer": {<br/>        "name": "test_consumer"<br/>    },<br/>    "interactions": [<br/>        {<br/>            "description": "ExampleJavaConsumerPactTest test interaction",<br/>            "request": {<br/>                "method": "GET",<br/>                "path": "/"<br/>            },<br/>            "response": {<br/>                "status": 200,<br/>                "body": {<br/>                    "responsetest": true<br/>                }<br/>            },<br/>            "providerStates": [<br/>                {<br/>                    "name": "test state"<br/>                }<br/>            ]<br/>        }<br/>    ],<br/>    "metadata": {<br/>        "pactSpecification": {<br/>            "version": "3.0.0"<br/>        },<br/>        "pact-jvm": {<br/>            "version": "3.5.24"<br/>        }<br/>    }<br/>}</span></pre><p id="6e40" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">运行测试</p><p id="6f05" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated"><code class="fe nk nl nm nc b">mvn clean test</code></p><p id="ceef" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">这应该会在目录target/pacts中创建上面的包文件</p><h1 id="46f6" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated"><strong class="ak">制作人结束</strong></h1><h2 id="8120" class="ml lj iq bd lk mm mn dn lo mo mp dp ls lf mq mr lw lg ms mt ma lh mu mv me mw bi translated">POM摘录</h2><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="b1eb" class="ml lj iq nc b gy ng nh l ni nj">&lt;dependencies&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;au.com.dius&lt;/groupId&gt;<br/>            &lt;artifactId&gt;pact-jvm-provider-junit5_2.12&lt;/artifactId&gt;<br/>            &lt;version&gt;3.5.24&lt;/version&gt;<br/>            &lt;exclusions&gt;<br/>                &lt;exclusion&gt;<br/>                    &lt;groupId&gt;junit&lt;/groupId&gt;<br/>                    &lt;artifactId&gt;junit&lt;/artifactId&gt;<br/>                &lt;/exclusion&gt;<br/>            &lt;/exclusions&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.springframework&lt;/groupId&gt;<br/>            &lt;artifactId&gt;spring-test&lt;/artifactId&gt;<br/>            &lt;version&gt;5.0.8.RELEASE&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>    &lt;/dependencies&gt;<br/><br/><br/>    &lt;build&gt;<br/>        &lt;plugins&gt;<br/>            &lt;plugin&gt;<br/>                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br/>                &lt;version&gt;3.8.0&lt;/version&gt;<br/>                &lt;configuration&gt;<br/>                    &lt;source&gt;1.8&lt;/source&gt;<br/>                    &lt;target&gt;1.8&lt;/target&gt;<br/>                &lt;/configuration&gt;<br/>            &lt;/plugin&gt;<br/><br/><br/>            &lt;plugin&gt;<br/>                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;<br/>                &lt;version&gt;2.22.0&lt;/version&gt;<br/>                &lt;dependencies&gt;<br/>                    &lt;dependency&gt;<br/>                        &lt;groupId&gt;org.junit.platform&lt;/groupId&gt;<br/>                        &lt;artifactId&gt;junit-platform-surefire-provider&lt;/artifactId&gt;<br/>                        &lt;version&gt;1.2.0&lt;/version&gt;<br/>                    &lt;/dependency&gt;<br/>                    &lt;dependency&gt;<br/>                        &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;<br/>                        &lt;artifactId&gt;junit-jupiter-engine&lt;/artifactId&gt;<br/>                        &lt;version&gt;5.2.0&lt;/version&gt;<br/>                    &lt;/dependency&gt;<br/>                &lt;/dependencies&gt;<br/>                &lt;configuration&gt;<br/>                    &lt;systemPropertyVariables&gt;<br/>                        &lt;pact.rootDir&gt;target/pacts&lt;/pact.rootDir&gt;<br/>                    &lt;/systemPropertyVariables&gt;<br/>                &lt;/configuration&gt;<br/>            &lt;/plugin&gt;<br/><br/><br/>        &lt;/plugins&gt;<br/>    &lt;/build&gt;</span></pre><p id="58a5" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">将pact文件从消费者(现在)复制到生产者项目模块目标目录</p><h2 id="30f1" class="ml lj iq bd lk mm mn dn lo mo mp dp ls lf mq mr lw lg ms mt ma lh mu mv me mw bi translated">试验码</h2><p id="6a1d" class="pw-post-body-paragraph kg kh iq kj b kk mg km kn ko mh kq kr lf mi ku kv lg mj ky kz lh mk lc ld le ij bi translated">这要求producer service已经启动，并假定它与一个端点一起运行(http://localhost:8080/service/)。</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="b89a" class="ml lj iq nc b gy ng nh l ni nj">@Provider("test-provider")<br/>@PactFolder("target/pacts")<br/>public class ProducerTest {<br/><br/>    private String providerUrl = "http://localhost:8080/service/";<br/><br/><br/>    @TestTemplate<br/>    @ExtendWith(PactVerificationInvocationContextProvider.class)<br/>    void pactVerificationTestTemplate(PactVerificationContext context)<br/>    {<br/>        context.verifyInteraction();<br/>    }<br/><br/><br/>    @BeforeEach<br/>    void before(PactVerificationContext context) throws Exception {<br/>        context.setTarget(HttpTestTarget.fromUrl(new URL(<br/>                providerUrl)));<br/>    }<br/><br/>    @State({"test state"})<br/>    public void toState() {<br/>    }</span></pre><p id="a8a0" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">那就跑</p><p id="a114" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated"><code class="fe nk nl nm nc b">mvn clean test</code></p><p id="5f41" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">输出如下所示:</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="8efb" class="ml lj iq nc b gy ng nh l ni nj">Verifying a pact between consumer and test_provider<br/>  Given test state<br/>  GET REQUEST<br/>    returns a response which<br/>      has status code 200 (OK)<br/>      includes headers<br/>        "Content-Type" with value "application/json" (OK)<br/>      has a matching body (OK)</span></pre><h2 id="d4a6" class="ml lj iq bd lk mm mn dn lo mo mp dp ls lf mq mr lw lg ms mt ma lh mu mv me mw bi translated">用跳趾试验</h2><p id="354e" class="pw-post-body-paragraph kg kh iq kj b kk mg km kn ko mh kq kr lf mi ku kv lg mj ky kz lh mk lc ld le ij bi translated">这使用了一个测试spring runner，因此您不需要单独运行该服务，尽管它涉及到模拟应用程序的某些部分。</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="9ee2" class="ml lj iq nc b gy ng nh l ni nj">@ExtendWith(SpringExtension.class)<br/>@SpringBootTest(classes = Application.class, webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT,<br/>        properties = "server.port=8080")<br/><br/><br/>@Provider("test-provider")<br/>@PactFolder("src/test/resources/pacts")<br/>public class SpringProducerTest {<br/><br/>    @MockBean<br/>    private Service service;<br/><br/><br/>    @BeforeEach<br/>    void setupTestTarget(PactVerificationContext context) {<br/>        context.setTarget(new HttpTestTarget("localhost", 8080, "/context"));<br/>    }<br/><br/>    @TestTemplate<br/>    @ExtendWith(PactVerificationInvocationContextProvider.class)<br/>    void pactVerificationTestTemplate(PactVerificationContext context) {<br/>        context.verifyInteraction();<br/>    }<br/><br/>    @State({"test State"})<br/>    public void toState() {<br/>        when(service.get(anyString()).thenReturn("dummy");<br/>    }<br/><br/>}</span></pre><h1 id="b148" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">打包文件管理</h1><p id="6101" class="pw-post-body-paragraph kg kh iq kj b kk mg km kn ko mh kq kr lf mi ku kv lg mj ky kz lh mk lc ld le ij bi translated">您可以使用pact broker来存放和提供pact文件。在这种情况下，包文件注释由包代理注释代替。</p><p id="a070" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">或者，如果您有一个存储库，那么对于消费者来说，管道的一部分是发布到repo，而对于生产者来说，管道的一部分是在运行测试之前从repo中检索文件。</p></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><p id="1a0f" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated"><em class="ki">原载于2018年12月24日</em><a class="ae kc" href="http://blog.ramjee.uk/2018/12/24/microservices-and-consumer-tests/" rel="noopener ugc nofollow" target="_blank"><em class="ki">blog . ramjee . uk</em></a><em class="ki">。</em></p></div></div>    
</body>
</html>