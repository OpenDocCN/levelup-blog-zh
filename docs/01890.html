<html>
<head>
<title>View your “dark code” in Rust</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Rust中查看您的“黑暗代码”</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/view-your-dark-code-in-rust-3b2e9699ea7e?source=collection_archive---------16-----------------------#2020-02-04">https://levelup.gitconnected.com/view-your-dark-code-in-rust-3b2e9699ea7e?source=collection_archive---------16-----------------------#2020-02-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8735" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">并且知道你的代码真正在做什么</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ec8c116982c587729819fce96e1cb77e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AhZJoG91cDsxbS9irPM-fg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">“我可以拥有黑暗代码吗？”—<a class="ae ky" href="https://unsplash.com/@miklevasilyev?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">米哈伊尔·瓦西里耶夫</a>在<a class="ae ky" href="https://unsplash.com/s/photos/hide?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="8255" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://doc.rust-lang.org/1.7.0/book/macros.html" rel="noopener ugc nofollow" target="_blank">宏</a>和<a class="ae ky" href="https://doc.rust-lang.org/reference/attributes.html" rel="noopener ugc nofollow" target="_blank">属性</a>在Rust中比比皆是，而且经常有用(不，重要！)来了解他们是如何改变你的源代码的。这些知识对帮助您很重要:</p><ol class=""><li id="1cf0" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">更深入地了解您的代码在做什么。</li><li id="9a35" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">当使用宏或属性产生意外结果时，可以更容易、更有效地调试源代码。</li></ol><p id="0748" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/dtolnay/cargo-expand" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> cargo-expand </strong> </a>是一个有用的cargo子命令，可以安装并运行它来“扩展”您源代码中的宏和属性(以下统称为“代码快捷方式”)，并向您显示正在生成的代码。</p><p id="b05e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设您从下面的代码开始，其中我们有一个简单的叫做<code class="fe mj mk ml mm b">PersonDetails</code>的<code class="fe mj mk ml mm b">struct</code>，我们希望这个类型是可打印的。</p><p id="79de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">代码如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="7896" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我通过使用从<code class="fe mj mk ml mm b">fmt::Debug</code>特征派生的<code class="fe mj mk ml mm b">Derive</code>属性，使<code class="fe mj mk ml mm b">PersonDetails</code> <a class="ae ky" href="https://doc.rust-lang.org/rust-by-example/hello/print/print_debug.html" rel="noopener ugc nofollow" target="_blank">可打印</a>。</p><blockquote class="mp"><p id="c9a8" class="mq mr it bd ms mt mu mv mw mx my lu dk translated">但是<em class="mz">如何</em> <em class="mz">准确地</em>使用这个属性和<code class="fe mj mk ml mm b">fmt::Debug</code>特征使结构可打印呢？</p><p id="a495" class="mq mr it bd ms mt mu mv mw mx my lu dk translated">事实证明，您可以<strong class="ak"> <em class="mz">扩展</em> </strong>属性，并使用<strong class="ak"> rust </strong>编译器查看生成的代码。</p></blockquote><p id="3b00" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">不幸的是:</p><ol class=""><li id="66b6" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">扩展代码快捷方式所需的<code class="fe mj mk ml mm b">rustc</code>命令要求您首先安装，然后手动切换到rust nightly工具链。</li><li id="de2a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">生成的代码打印到终端，带有不理想的<strong class="lb iu">格式</strong>，没有<strong class="lb iu">语法高亮</strong>。</li><li id="3c34" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">完成后，您需要切换回非夜间版本的工具链。</li></ol><p id="012c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的项目根目录下，我需要运行:</p><p id="bb9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">rustup override set nightly</code></p><p id="63d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后:</p><p id="e3da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">cargo rustc —-profile=check -- -Zunstable-options --pretty=expanded</code></p><p id="fa67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">产生以下结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/f0f92cda034fe85b28ab2520f9d615c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dNVohe6S7YXQLzq0Dwg8Aw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用带有右标志的rustc扩展输出。</figcaption></figure><p id="45cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您会发现有些地方的格式很简单，尤其是在<code class="fe mj mk ml mm b">main</code>函数中。</p><p id="e784" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们用<a class="ae ky" href="https://github.com/dtolnay/cargo-expand" rel="noopener ugc nofollow" target="_blank"> cargo-expand </a>做同样的事情。</p><p id="6cb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">cargo install cargo-expand</code></p><p id="cfc6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的系统上安装了<code class="fe mj mk ml mm b">rustfmt</code>工具，cargo-expand将使用它来格式化/修饰生成的代码。</p><p id="8ade" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">即使没有安装<code class="fe mj mk ml mm b">rustfmt</code>也可以运行<code class="fe mj mk ml mm b">cargo expand</code>。要安装<code class="fe mj mk ml mm b">rustfmt</code>运行:</p><p id="5c12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">rustup component add rustfmt</code></p><p id="b697" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然cargo-expand也在幕后使用rust的夜间构建，但它并不期望您手动更改您正在工作的项目的默认工具链。</p><p id="e547" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用cargo-expand扩展同一个示例中的代码快捷方式会产生:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/97ac44da6d3b0343699e4e32b70a5688.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aR1VEc8v7Ykv-sUbLP5EcQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用“货物扩展”扩展代码输出</figcaption></figure><p id="ceb9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">观察到:</p><ol class=""><li id="973a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">格式化时，输出可以更好地利用空白。✨</li><li id="74cc" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">输出是语法高亮显示的！🎉</li></ol><p id="b2e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">前进，探索，并在包含其他宏的代码上尝试<code class="fe mj mk ml mm b">cargo expand</code>比如<code class="fe mj mk ml mm b">vec!</code>或者使用<a class="ae ky" href="https://blog.usejournal.com/6-useful-rust-macros-that-you-might-not-have-seen-before-59d1386f7bc5" rel="noopener ugc nofollow" target="_blank">这些超级有用的属性</a>。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="c653" class="nn no it bd np nq nr ns nt nu nv nw nx jz ny ka nz kc oa kd ob kf oc kg od oe bi translated">参考</h1><p id="46a6" class="pw-post-body-paragraph kz la it lb b lc of ju le lf og jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">货物扩展:<a class="ae ky" href="https://github.com/dtolnay/cargo-expand" rel="noopener ugc nofollow" target="_blank">https://github.com/dtolnay/cargo-expand</a></p><p id="a494" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">鲁斯特普:<a class="ae ky" href="https://rustup.rs/" rel="noopener ugc nofollow" target="_blank">https://rustup.rs/</a></p><p id="926a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">https://github.com/rust-lang/rustfmt</p><p id="6353" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">宏:<a class="ae ky" href="https://doc.rust-lang.org/1.7.0/book/macros.html" rel="noopener ugc nofollow" target="_blank">https://doc.rust-lang.org/1.7.0/book/macros.html</a></p><p id="4a0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">属性:<a class="ae ky" href="https://doc.rust-lang.org/reference/attributes.html" rel="noopener ugc nofollow" target="_blank">https://doc.rust-lang.org/reference/attributes.html</a></p><p id="e16a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">6个你以前可能没见过的有用的Rust宏:<a class="ae ky" href="https://blog.usejournal.com/6-useful-rust-macros-that-you-might-not-have-seen-before-59d1386f7bc5" rel="noopener ugc nofollow" target="_blank">https://blog . use journal . com/6-useful-Rust-macros-the-you-may-not-before-seen-59d 1386 F7 BC 5</a></p></div></div>    
</body>
</html>