<html>
<head>
<title>Gracefully Shut Down Go Web Servers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">优雅地关闭Go Web服务器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/gracefully-shut-down-go-web-servers-69ba980a2b7c?source=collection_archive---------11-----------------------#2022-12-19">https://levelup.gitconnected.com/gracefully-shut-down-go-web-servers-69ba980a2b7c?source=collection_archive---------11-----------------------#2022-12-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f41528f28359fa7c7e2d7b453f7c1f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q0eyE8egZOPiqEYZAArkjQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://github.com/MariaLetta/free-gophers-pack" rel="noopener ugc nofollow" target="_blank">https://github.com/MariaLetta/free-gophers-pack</a></figcaption></figure><p id="40cf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正常关机是web服务器的一项常见任务，也是一项非常重要的功能。我们将研究如何在Golang做到这一点。让我们开始吧。</p><h1 id="f783" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">什么是优雅关机？</h1><p id="1ac0" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果您的web服务器在关闭服务器之前等待您的活动请求得到处理，这意味着您正在优雅地关闭服务器。</p><h2 id="a045" class="me lc iq bd ld mf mg dn lh mh mi dp ll ko mj mk lp ks ml mm lt kw mn mo lx mp bi translated">为什么重要？</h2><p id="10da" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">想象你正在逛商店。他们晚上10点关门。晚上9点55分和10点的时候你都在里面。他们将关闭商店，不接受任何新的顾客，但帮助里面的顾客，为他们服务，然后他们就会回家。他们优雅地关闭了商店。</p><p id="f797" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于web服务器来说，这也是同样的想法。你得到一个关闭网络服务器的信号。然后，您将不会接受任何新的请求，服务于活动的请求，然后关闭web服务器。</p><h2 id="2c65" class="me lc iq bd ld mf mg dn lh mh mi dp ll ko mj mk lp ks ml mm lt kw mn mo lx mp bi translated">例子</h2><p id="d04c" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">让我们创建一个运行在端口8000上的web服务器。然后创建一个goroutine来运行web服务器，这样它就不会阻塞代码。</p><h2 id="f8c5" class="me lc iq bd ld mf mg dn lh mh mi dp ll ko mj mk lp ks ml mm lt kw mn mo lx mp bi translated">运行web服务器</h2><p id="f23c" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">srv。ListenAndServe将在端口8000上运行web服务器。如果有任何错误，我们将记录错误。</p><p id="5947" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可能会注意到额外的检查错误。就是(呃，http。ErrServerClosed)。当您关闭或关闭服务器时，http。ErrServerClosed将被返回，所以在运行web服务器时它不是一个错误，所以我将忽略这个错误。</p><h2 id="baed" class="me lc iq bd ld mf mg dn lh mh mi dp ll ko mj mk lp ks ml mm lt kw mn mo lx mp bi translated">为什么使用渠道？</h2><blockquote class="mq mr ms"><p id="0b53" class="kd ke mt kf b kg kh ki kj kk kl km kn mu kp kq kr mv kt ku kv mw kx ky kz la ij bi translated">从一个信道取回接收是一个阻塞操作。</p></blockquote><p id="b3cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我定义了一个<code class="fe mx my mz na b">os.Signal</code>通道来阻塞应用程序，直到收到来自操作系统的信号。当程序中断时，<code class="fe mx my mz na b">signal.Notify</code>将向<code class="fe mx my mz na b">quit</code>通道发送信号。用<code class="fe mx my mz na b">ctrl + c</code>就可以了。</p><h2 id="b7d6" class="me lc iq bd ld mf mg dn lh mh mi dp ll ko mj mk lp ks ml mm lt kw mn mo lx mp bi translated">为什么上下文超时？</h2><p id="00a3" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">假设我们的代码中有一个bug，我们正在关闭服务器以使用修复这个bug的新版本。想象一下，这个bug让我们在几分钟内处理一个活动请求。所以我们不应该等那么久。在下面的代码中，我说，嘿，不要等待超过30秒。关闭服务器，即使30秒后有任何活动请求。这就是使用超时上下文的原因。<code class="fe mx my mz na b">srv.Shutdown</code>会在30秒内优雅地关闭服务器。</p><pre class="nb nc nd ne gt nf na ng bn nh ni bi"><span id="6ce3" class="nj lc iq na b be nk nl l nm nn">package main<br/><br/>import (<br/> "context"<br/> "errors"<br/> "log"<br/> "net/http"<br/> "os"<br/> "os/signal"<br/> "time"<br/>)<br/><br/>func main() {<br/> srv := &amp;http.Server{<br/>  Addr: ":8000",<br/> }<br/> go func() {<br/>  if err := srv.ListenAndServe(); err != nil &amp;&amp; !errors.Is(err, http.ErrServerClosed) {<br/>   log.Fatal(err)<br/>  }<br/> }()<br/> quit := make(chan os.Signal, 1)<br/> signal.Notify(quit, os.Interrupt)<br/> &lt;-quit<br/> ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)<br/> defer cancel()<br/> if err := srv.Shutdown(ctx); err != nil {<br/>  log.Fatal(err)<br/> }<br/>}</span></pre></div><div class="ab cl no np hu nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ij ik il im in"><p id="82b2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当您关闭web服务器时，不要忘记优雅地关闭它。</p></div></div>    
</body>
</html>