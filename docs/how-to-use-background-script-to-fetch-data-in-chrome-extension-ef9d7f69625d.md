# å¦‚ä½•ä½¿ç”¨åå°è„šæœ¬è·å– Chrome æ‰©å±•ä¸­çš„æ•°æ®

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/how-to-use-background-script-to-fetch-data-in-chrome-extension-ef9d7f69625d>

![](img/06e6dc4a91951db9cba57d9d6197eee6.png)

é»‘å®¢æ ‡ç­¾:Chrome æ‰©å±•ï¼Œåœ¨æ–°æ ‡ç­¾ä¸ŠæŸ¥çœ‹ GitHub è¶‹åŠ¿é¡¹ç›®ğŸ“ˆ

å¦‚æœä½ ä¸ç¡®å®šå¦‚ä½•ç¼–å†™ä¸€ä¸ª chrome æ‰©å±•ï¼Œå¯ä»¥å…ˆçœ‹çœ‹æˆ‘ä¹‹å‰çš„æ•…äº‹ [**å¦‚ä½•ç”¨ React.js åœ¨ 5 åˆ†é’Ÿå†…åˆ›å»ºä¸€ä¸ªè·¨æµè§ˆå™¨æ‰©å±•**](/how-to-use-react-js-to-create-chrome-extension-in-5-minutes-2ddb11899815) ã€‚å®ƒæ•™ä½ å¦‚ä½•ä½¿ç”¨ create-react-app ä¸ºæ–°æ ‡ç­¾é¡µæ„å»ºä¸€ä¸ªæµè§ˆå™¨æ‰©å±•ã€‚

æˆ‘ä»¬æ„å»ºçš„æ‰©å±•å¾ˆå¥½ï¼Œä½†æ˜¯æ¯æ¬¡ç”¨æˆ·æ‰“å¼€ä¸€ä¸ªæ–°æ ‡ç­¾ï¼Œæˆ‘ä»¬å°†ä» API é‡æ–°åŠ è½½æœ€æ–°çš„è¶‹åŠ¿åº“ï¼Œè¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿã€‚å³ä½¿åªéœ€è¦ä¸€ç§’é’Ÿï¼Œå¯¹äºä¸€ä¸ªæ–°çš„æ ‡ç­¾é¡µæ‰“å¼€æ¥è¯´ä»ç„¶å¾ˆæ…¢ã€‚

> å¦‚æœæˆ‘ä»¬å®šæœŸåœ¨åå°è·å–æ•°æ®ï¼Œå°†æ•°æ®ä¿å­˜åœ¨ localStorage ä¸­ï¼Œå¹¶åœ¨æ‰“å¼€ä¸€ä¸ªæ–°æ ‡ç­¾æ—¶è¯»å–å®ƒï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿ

æˆ‘èŠ±äº†å‡ å¤©æ—¶é—´ç ”ç©¶å®ƒï¼Œå‘ç°å®ƒæ˜¯å®Œå…¨å¯è¡Œçš„ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä¸ä½ åˆ†äº«æˆ‘åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ‰€å­¦åˆ°çš„ä¸œè¥¿ã€‚

# 1.å‘ manifest.json æ·»åŠ åå°è„šæœ¬

åå°è„šæœ¬å¯ä»¥å¯¹æµè§ˆå™¨äº‹ä»¶åšå‡ºååº”å¹¶æ‰§è¡ŒæŸäº›æ“ä½œï¼Œåå°é¡µé¢åœ¨éœ€è¦æ—¶åŠ è½½ï¼Œç©ºé—²æ—¶å¸è½½ã€‚è¦ä½¿ç”¨èƒŒæ™¯æ–‡ä»¶ï¼Œåœ¨`manifest.json`æ–‡ä»¶ä¸­å£°æ˜å¦‚ä¸‹:

![](img/8a08611448a567da108275736e8e7463.png)

ä½ ä¼šæ³¨æ„åˆ°`persistent`å‚æ•°ï¼Œåœ¨æ‰©å±•çš„ç”Ÿå‘½å‘¨æœŸä¸­å­˜åœ¨ä¸€ä¸ªæŒä¹…çš„èƒŒæ™¯é¡µé¢ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªå®ä¾‹åœ¨ Chrome æµè§ˆå™¨çš„èƒŒæ™¯ä¸­è¿è¡Œï¼Œç­‰å¾…ç”¨æˆ·ä¸æ‰©å±•äº¤äº’ã€‚

æ ¹æ®[è°·æ­Œå¼€å‘è€…æ–‡æ¡£](https://developer.chrome.com/extensions/background_migration)ï¼Œæ›´æ¨èä½¿ç”¨éæŒä¹…æ¨¡å¼ï¼Œå®ƒå¯ä»¥å¸®åŠ©é™ä½ä½ çš„æ‰©å±•çš„èµ„æºæˆæœ¬ã€‚éæŒä¹…åå°è„šæœ¬æ˜¯å®Œå…¨åŸºäºäº‹ä»¶çš„ï¼Œå®ƒä¿æŒä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å®ƒä»¬ç›‘å¬çš„äº‹ä»¶è§¦å‘ï¼Œå¯¹æŒ‡å®šçš„æŒ‡ä»¤åšå‡ºååº”ï¼Œç„¶åå¸è½½ã€‚äº‹ä»¶çš„ä¸€äº›ä¾‹å­åŒ…æ‹¬:

*   è¯¥æ‰©å±•é¦–å…ˆè¢«å®‰è£…æˆ–æ›´æ–°åˆ°æ–°ç‰ˆæœ¬ï¼Œæˆ–è€…æµè§ˆå™¨è¢«é‡æ–°å¯åŠ¨ã€‚
*   èƒŒæ™¯é¡µæ­£åœ¨ä¾¦å¬ä¸€ä¸ªäº‹ä»¶ï¼Œè¯¥äº‹ä»¶å·²è¢«è°ƒåº¦ã€‚(ä¾‹å¦‚ï¼Œæˆ‘ä»¬å°†åˆ›å»º`[alarm](https://developers.chrome.com/extensions/alarms)`æ¥å®šæœŸè°ƒåº¦äº‹ä»¶)
*   å†…å®¹è„šæœ¬æˆ–å…¶ä»–æ‰©å±•[å‘é€æ¶ˆæ¯ã€‚](https://developer.chrome.com/extensions/messaging)
*   æ‰©å±•ä¸­çš„å¦ä¸€ä¸ªè§†å›¾ï¼Œæ¯”å¦‚å¼¹å‡ºçª—å£ï¼Œè°ƒç”¨`[runtime.getBackgroundPage](https://developer.chrome.com/extensions/runtime#method-getBackgroundPage)`ã€‚

# 2.æ·»åŠ è­¦æŠ¥ä»¥å®šæœŸè§¦å‘æ“ä½œ

æ‚¨å¯èƒ½ç†Ÿæ‚‰ä»¥ä¸‹å®šæœŸè¿è¡Œçš„ä»£ç :

```
window.setInterval(function() {
  console.log('Hello, world!'); 
}, 1000 * 60 * 3);
```

ä¸Šé¢å°ç€â€œä½ å¥½ï¼Œä¸–ç•Œï¼â€æ¯ 3 åˆ†é’Ÿã€‚ä¸ºäº†å°†å…¶æ›´æ”¹ä¸ºåŸºäºäº‹ä»¶çš„è­¦æŠ¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨[è­¦æŠ¥ API](https://developer.chrome.com/extensions/alarms) æ¥ä»£æ›¿ã€‚

```
chrome.alarms.create('refresh', { periodInMinutes: 3 });
```

ç„¶åæ·»åŠ ä¸€ä¸ªç›‘å¬å™¨ã€‚

```
chrome.alarms.onAlarm.addListener((alarm) => {
  alert("Hello, world!");
});
```

æˆ‘ä»¬å°†éœ€è¦åœ¨å®‰è£…æ‰©å±•æ—¶åˆ›å»ºä¸€ä¸ªè­¦æŠ¥ï¼Œä»¥ä¾¿æ¯ 3 åˆ†é’Ÿåœ¨åå°è§¦å‘ä¸€æ¬¡è­¦æŠ¥ï¼Œè¿™æ˜¯æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢çš„`background.js`ã€‚

è¦ä½¿ç”¨è­¦æŠ¥ï¼Œæ‚¨è¿˜éœ€è¦åœ¨`manifest.json`ä¸­æ·»åŠ `alarms`æƒé™

# 3.è°ƒè¯•åå°è„šæœ¬

ä¸ºäº†æµ‹è¯•ä¸Šè¿°è„šæœ¬æ˜¯å¦èƒ½æŒ‰é¢„æœŸè¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°æµ‹è¯•å®ƒã€‚è¿™å’Œ[ä¸Šä¸€ä¸ªæ•…äº‹](/how-to-use-react-js-to-create-chrome-extension-in-5-minutes-2ddb11899815)ä¸­çš„æ­¥éª¤éå¸¸ç›¸ä¼¼ã€‚

1.  ç¡®ä¿å¼€å‘è€…æ¨¡å¼æ‰“å¼€ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚
2.  ç‚¹å‡»â€œLoad unpackedâ€ï¼Œç›®æ ‡æ–‡ä»¶å¤¹åŒ…å«æ‚¨çš„`manifest.json`ã€‚
3.  ä½ åº”è¯¥ç‚¹å‡»`background page`,è€Œä¸æ˜¯åœ¨æ–°æ ‡ç­¾é¡µä¸Šæ£€æŸ¥ï¼Œå› ä¸ºèƒŒæ™¯é¡µæ­£åœ¨ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œã€‚
4.  å¦‚æœæ‚¨åœ¨æœ¬åœ°æ›´æ”¹äº†ä»£ç ï¼Œåˆ™éœ€è¦å•å‡» reloadã€‚

![](img/b7357091cc85b3b6b7dac6a523d2383c.png)

æœ¬åœ°æµ‹è¯•æ‰©å±•

ä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºï¼Œè­¦æŠ¥æ¯ 3 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ã€‚

![](img/62c9b8a9122ac95fde9a270d0514312b.png)

æ£€æŸ¥åå°è„šæœ¬

æ‚¨ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ£€æŸ¥**ç½‘ç»œ**ã€**æœ¬åœ°å­˜å‚¨**ã€‚å¦‚æœæ‚¨çš„æ‰©å±•ä¿®æ”¹äº†æ–°æ ‡ç­¾ï¼Œæœ¬åœ°å­˜å‚¨å°†åœ¨æ‚¨çš„æ‰©å±•ä¸­å…±äº«ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨åå°è„šæœ¬å’Œæ–°æ ‡ç­¾æ‰©å±•ä¹‹é—´ä¼ é€’æ•°æ®çš„æ–¹å¼ã€‚

# 4.æå–æ•°æ®å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨

ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸºæœ¬çš„è­¦æŠ¥å·¥ä½œï¼Œè®©æˆ‘ä»¬è·å–æ•°æ®å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ã€‚åæ¥åœ¨æˆ‘ä»¬çš„ React æ‰©å±•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åŠ è½½æ—¶ç›´æ¥ä»æœ¬åœ°å­˜å‚¨è¯»å–ï¼Œè€Œä¸æ˜¯ä» API è·å–ã€‚

1.  æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªâ€œ**åˆ·æ–°**â€è­¦æŠ¥ï¼Œä»¥ä¾¿åœ¨é¦–æ¬¡å®‰è£…æˆ–å‡çº§æ‰©å±•æ—¶æ¯ 30 åˆ†é’Ÿè·å–å¹¶ä¿å­˜æ•°æ®ã€‚
2.  æˆ‘ä»¬å°†åœ¨ chrome é‡å¯æ—¶è·å–æ•°æ®ï¼Œä»¥ä¾¿ç”¨æˆ·è·å¾—æœ€æ–°æ•°æ®ã€‚
3.  æˆ‘ä»¬è¿˜å°†æ¯ 5 åˆ†é’Ÿåˆ›å»ºå¦ä¸€ä¸ªâ€œ**çœ‹é—¨ç‹—**â€è­¦æŠ¥ï¼Œä»¥æ£€æŸ¥åˆ·æ–°è­¦æŠ¥æ˜¯å¦ä»ç„¶å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œæˆ‘ä»¬å°†åˆ›å»ºå®ƒã€‚(è¿™é‡Œå¯èƒ½ä¸éœ€è¦)

# 5.é‡ç”¨é€»è¾‘å¹¶è½¬æ¢åˆ° ES5

ä¸Šé¢çš„ä»£ç æœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦è§£å†³å®ƒä»¬:

1.  è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ²¡æœ‰ä¸º`fetchRepositories`å’Œ`saveToLocalStorage`ç¼–å†™å®ç°ï¼Œå®ƒä»¬å¾ˆå¯èƒ½å·²ç»å­˜åœ¨äºæ‚¨çš„ React åº”ç”¨ç¨‹åºä¸­ï¼Œå°†å®ç°å¤åˆ¶åˆ°`background.js`æ˜¯å¾ˆå¥½çš„ï¼Œä½†å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿé‡ç”¨è¿™äº›å‡½æ•°ä»¥ä¿æŒä»£ç å¹²ç‡¥ï¼Œé‚£ä¼šæ›´å¥½ã€‚
2.  æˆ‘ä»¬å·²ç»ä½¿ç”¨ ES6 è¯­æ³•ç¼–å†™äº†`background.js`ï¼Œæ¯”å¦‚`**=>**`å’Œ`**async await**`ï¼Œæ—§çš„æµè§ˆå™¨å¯èƒ½æ— æ³•è¿è¡Œå®ƒã€‚

è¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨`webpack`æ¥å¸®åŠ©å°†ä»£ç æ†ç»‘å’Œä¼ è¾“åˆ° ES5ã€‚

## 5.1 å®‰è£…ä¾èµ–é¡¹

```
yarn add --dev webpack-cli npm-run-all rimraf
```

æ³¨æ„ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å®‰è£…`webpack.` ( `react-scripts`å·²ç»ä¾èµ–äºå®ƒï¼Œå®ƒä¼šæŠ±æ€¨`webpack`çš„å¦ä¸€ä¸ªå®ä¾‹)ã€‚å¦‚æœæ‚¨æ²¡æœ‰ä½¿ç”¨`create-react-app`ï¼Œè¯·éšæ„å®‰è£…å®ƒã€‚

## 5.2 æ›´æ”¹æ„å»ºè„šæœ¬

ç°åœ¨æ›´æ”¹æ‚¨çš„`build`è„šæœ¬æ¥æ„å»ºæ‚¨çš„åº”ç”¨ç¨‹åºå’Œåå°è„šæœ¬:

```
"prebuild": "rimraf build",
"build": "npm-run-all build:*",
"build:app": "INLINE_RUNTIME_CHUNK=false react-scripts build",
"build:bg": "webpack --mode production ./src/background.js --output ./build/background.js",
```

æˆ‘ä»¬å·²ç»åœ¨[ä¹‹å‰çš„æ•™ç¨‹](/how-to-use-react-js-to-create-chrome-extension-in-5-minutes-2ddb11899815)ä¸­ä»‹ç»è¿‡`INLINE_RUNTIME_CHUNK=false`ã€‚æ›´æ”¹åï¼Œå¦‚æœæ‚¨è¿è¡Œ`npm run build`ï¼Œå®ƒå°†æ‰§è¡Œ

*   æ¸…æ´`build`æ–‡ä»¶å¤¹
*   ä½¿ç”¨`react-script`æ†ç»‘ React æ‰©å±•
*   ä½¿ç”¨ webpack æ†ç»‘`src/background.js`å¹¶å¯¼å‡ºåˆ°`build/background.js`

## 5.3 é‡æ„ã€‚/src/èƒŒæ™¯. js

åœ¨æ‚¨çš„`src/background.js`ä¸­ï¼Œæ‚¨å¯ä»¥è‡ªç”±å¯¼å…¥ä»»ä½•å¤–éƒ¨åº“ï¼Œå¦‚`lodash`æˆ–ä»å…¶ä»–æ–‡ä»¶å¯¼å…¥å¸¸é‡/å‡½æ•°ï¼Œå¦‚:

```
import { 
  fetchRepositories, 
  saveToLocalStorage
} from './lib/helpers';chrome.runtime.onInstalled.addListener(() => {
...
```

ä½ çš„ä»£ç ç°åœ¨æ›´å¹²å‡€äº†ã€‚

## 5.4 æ›´æ–° ESlint é…ç½®

å¦‚æœä½ åœ¨ä½ çš„ç¼–è¾‘å™¨ä¸­ä½¿ç”¨ ESLintï¼Œå®ƒå¯èƒ½ä¼šæŠ±æ€¨åœ¨ä½ çš„`./src/background.js`ä¸­æ²¡æœ‰å®šä¹‰`chrome`ã€‚è¿™æ˜¯å› ä¸º`chrome` API åªåœ¨æ‰©å±•ä¸­å¯ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰ ESLint æˆ‘ä»¬æ­£åœ¨å¼€å‘æ‰©å±•ï¼Œè¯·å¿½ç•¥è¿™äº›ã€‚

åœ¨æ‚¨çš„`package.json`ä¸­æ·»åŠ /æ›´æ–°ä»¥ä¸‹è¡Œã€‚

```
"eslintConfig": {
  "extends": "react-app",
  "env": {
    "browser": true,
    "webextensions": true
  }
}
```

æŠŠ`webextensions`åŠ åˆ°`env`åï¼Œç¼–è¾‘å°±ä¸å†æŠ±æ€¨äº†ã€‚

## 5.5 æ·»åŠ ã€‚å·´ä¼¯å°”å…‹

Webpack å°†éœ€è¦ä¸€ä¸ª`.babelrc`æ–‡ä»¶æ¥ç¼–è¯‘ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ·»åŠ å®ƒã€‚å› ä¸º`react-scripts`å·²ç»å®‰è£…äº†`babel-presets-react-app`ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨å®ƒã€‚

```
{
  "presets": ["react-app"]
}
```

ç°åœ¨è¿è¡Œ`npm run build`å°†ä¼šåœ¨ä½ çš„`build`æ–‡ä»¶å¤¹ä¸­æœ‰ä½ å®Œæ•´çš„æ‰©å±•å’Œç¼–è¯‘å¥½çš„åå°è„šæœ¬ã€‚

# å°±æ˜¯è¿™æ ·ï¼

å¦‚æœä½ å¥½å¥‡çš„è¯ï¼Œä½ å¯ä»¥åœ¨ GitHub ä¸ŠæŸ¥çœ‹æˆ‘çš„æ‰©å±•çš„æäº¤ä¸­æ‰€æœ‰è¢«ä¿®æ”¹çš„æ–‡ä»¶[ã€‚](https://github.com/huchenme/hacker-tab-extension/commit/ff765829f2d96ea5e53265b11d4a27cec4133b5d)

è°¢è°¢ä½ è¯»åˆ°è¿™é‡Œã€‚ä½ å¯ä»¥åœ¨ [Github](https://github.com/huchenme/hacker-tab-extension) ä¸­æŸ¥çœ‹æºä»£ç ï¼Œæˆ–è€…åœ¨ [Chrome ç½‘ç»œå•†åº—](https://chrome.google.com/webstore/detail/hacker-tab/ibomigipadcieapbemkegkmadbbanbgm)å’Œ [Firefox é™„åŠ ç»„ä»¶ä¸­å¿ƒ](https://addons.mozilla.org/en-US/firefox/addon/hacker-tab/)ä¸‹è½½æ‰©å±•ï¼Œç¥ä½ é»‘å®¢æ„‰å¿«ï¼Œè®©æˆ‘çŸ¥é“ä½ æ„å»ºäº†ä»€ä¹ˆï¼