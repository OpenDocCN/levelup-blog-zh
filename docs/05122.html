<html>
<head>
<title>Jenkinsfile Explained with Example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jenkinsfile举例说明</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/jenkinsfile-explained-with-example-ba2d27850880?source=collection_archive---------10-----------------------#2020-08-05">https://levelup.gitconnected.com/jenkinsfile-explained-with-example-ba2d27850880?source=collection_archive---------10-----------------------#2020-08-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jq jr js jt"><div class="bz fp l di"><div class="ju jv l"/></div></figure><h1 id="23d1" class="jw jx it bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">代理人</strong></h1><p id="25d1" class="pw-post-body-paragraph ku kv it kw b kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">让我们从将要执行某个阶段的<code class="fe ls lt lu lv b">agent</code>开始。可以是整个<code class="fe ls lt lu lv b">pipeline</code>也可以是某个<code class="fe ls lt lu lv b">stage</code>。在顶级代理中，我们将其设置为<code class="fe ls lt lu lv b">none</code>，因此我们需要设置每个阶段要使用的代理。</p><p id="a59c" class="pw-post-body-paragraph ku kv it kw b kx lw kz la lb lx ld le lf ly lh li lj lz ll lm ln ma lp lq lr im bi translated">让我们讨论下面的代理类型:</p><pre class="mb mc md me gt mf lv mg mh aw mi bi"><span id="70cf" class="mj jx it lv b gy mk ml l mm mn">agent {<br/>  docker {<br/>    image 'alxibra/forstok-apigateway:0.0.1'<br/>    label 'slave'<br/>  }<br/>}</span></pre><p id="8253" class="pw-post-body-paragraph ku kv it kw b kx lw kz la lb lx ld le lf ly lh li lj lz ll lm ln ma lp lq lr im bi translated">这意味着我们使用基本映像<code class="fe ls lt lu lv b">alxibra/forstok-apigateway:0.0.1</code>在docker环境中运行我们的阶段。<code class="fe ls lt lu lv b">label</code>表示你要执行哪个带有某个标签的服务器。我们有2台服务器运行Jenkins，我们用<code class="fe ls lt lu lv b">master</code>和<code class="fe ls lt lu lv b">slave</code>标记我们的服务器。</p><p id="25de" class="pw-post-body-paragraph ku kv it kw b kx lw kz la lb lx ld le lf ly lh li lj lz ll lm ln ma lp lq lr im bi translated">关于代理的更多信息，你可以阅读关于<a class="ae mo" href="https://www.jenkins.io/doc/book/pipeline/syntax/#agent" rel="noopener ugc nofollow" target="_blank">代理</a>的文档。</p><h1 id="758b" class="jw jx it bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">环境</strong></h1><p id="5dc3" class="pw-post-body-paragraph ku kv it kw b kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">我们在这里没有什么可以解释的，因为它本身已经解释清楚了。但是如果您想知道凭证从何而来。我们可以去<strong class="kw iu">管理詹金斯&gt;安全&gt;管理凭证</strong></p><pre class="mb mc md me gt mf lv mg mh aw mi bi"><span id="bff5" class="mj jx it lv b gy mk ml l mm mn">AWS_KEY = credentials('AWS_KEY')</span></pre><h1 id="e9b0" class="jw jx it bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">当</strong></h1><p id="ddcc" class="pw-post-body-paragraph ku kv it kw b kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated"><code class="fe ls lt lu lv b">when</code>该指令用于阶段运行的条件。下面的<code class="fe ls lt lu lv b">when</code>条件意味着除了在分支<code class="fe ls lt lu lv b">master</code>中，该阶段总是运行</p><pre class="mb mc md me gt mf lv mg mh aw mi bi"><span id="61d0" class="mj jx it lv b gy mk ml l mm mn">when {<br/>  not {<br/>    branch 'master'<br/>  }<br/>}</span></pre><p id="4ebe" class="pw-post-body-paragraph ku kv it kw b kx lw kz la lb lx ld le lf ly lh li lj lz ll lm ln ma lp lq lr im bi translated">更多信息参见本<a class="ae mo" href="https://www.jenkins.io/doc/book/pipeline/syntax/#when" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="2aca" class="jw jx it bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">步骤</strong></h1><p id="d2a0" class="pw-post-body-paragraph ku kv it kw b kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated"><code class="fe ls lt lu lv b">steps</code>完成该阶段需要做些什么</p><pre class="mb mc md me gt mf lv mg mh aw mi bi"><span id="748f" class="mj jx it lv b gy mk ml l mm mn">steps('test') {<br/>  sh 'bundle exec rspec'<br/>}</span></pre><p id="b636" class="pw-post-body-paragraph ku kv it kw b kx lw kz la lb lx ld le lf ly lh li lj lz ll lm ln ma lp lq lr im bi translated">上面的脚本我们需要运行命令<code class="fe ls lt lu lv b">bundle exec rspec</code>。每个<code class="fe ls lt lu lv b">steps</code>可以有多个命令。对于当前情况，我们只需要一个命令。</p><h1 id="e536" class="jw jx it bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">平行</strong></h1><p id="5212" class="pw-post-body-paragraph ku kv it kw b kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">我们可以并行运行多个阶段。首先我们需要创建父<code class="fe ls lt lu lv b">stage</code>，在<code class="fe ls lt lu lv b">stage</code>中放置<code class="fe ls lt lu lv b">parallel</code>指令。在<code class="fe ls lt lu lv b">parallel</code>里面放上你想要的几个<code class="fe ls lt lu lv b">stage</code>。</p><pre class="mb mc md me gt mf lv mg mh aw mi bi"><span id="5c6f" class="mj jx it lv b gy mk ml l mm mn">stage('QA'){<br/>  paralle {<br/>    stage('linter'){<br/>      .......<br/>    }<br/>    stage('test') {<br/>      ........<br/>    }<br/>  }<br/>}</span></pre><p id="abdd" class="pw-post-body-paragraph ku kv it kw b kx lw kz la lb lx ld le lf ly lh li lj lz ll lm ln ma lp lq lr im bi translated">更多信息请参见本<a class="ae mo" href="https://www.jenkins.io/doc/book/pipeline/syntax/#parallel" rel="noopener ugc nofollow" target="_blank">文档</a></p><h1 id="14a6" class="jw jx it bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">发帖</strong></h1><p id="7331" class="pw-post-body-paragraph ku kv it kw b kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">某一阶段完成或失败后的附加步骤。我们定义了两个条件<code class="fe ls lt lu lv b">success</code>和<code class="fe ls lt lu lv b">failure</code>。他们都向我们发送懈怠状态的通知。关于<code class="fe ls lt lu lv b">post</code>中条件的更多信息，请参见<a class="ae mo" href="https://www.jenkins.io/doc/book/pipeline/syntax/#post" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="f571" class="pw-post-body-paragraph ku kv it kw b kx lw kz la lb lx ld le lf ly lh li lj lz ll lm ln ma lp lq lr im bi translated">现在我试着解释Jenkinsfile在上面的文件中做了什么</p><figure class="mb mc md me gt jt gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/da246e7ed1025ad83d60ba54a55020f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*V8kIeCqRgfroWuI4OaS-0w.png"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">当分支不是主时</figcaption></figure><p id="ad48" class="pw-post-body-paragraph ku kv it kw b kx lw kz la lb lx ld le lf ly lh li lj lz ll lm ln ma lp lq lr im bi translated">当分支不是<code class="fe ls lt lu lv b">master</code>时，我们只运行<code class="fe ls lt lu lv b">linter</code>并并行测试，而不执行<code class="fe ls lt lu lv b">build image</code>和<code class="fe ls lt lu lv b">deploy to production</code>。</p><figure class="mb mc md me gt jt gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/0e071e261a6c9815b2444d0b603bf447.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*_am_tTEcHBvAhZJ3F5Ct4w.png"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">当分支是主时</figcaption></figure><p id="6a0c" class="pw-post-body-paragraph ku kv it kw b kx lw kz la lb lx ld le lf ly lh li lj lz ll lm ln ma lp lq lr im bi translated">现在我们想要发布我们的应用程序，我们需要将它部署到生产环境中。首先，我们需要构建应用程序，构建完成后，我们可以将它部署到生产环境中。如果部署状态为成功或失败，jenkins会将状态发送给slack。</p></div></div>    
</body>
</html>