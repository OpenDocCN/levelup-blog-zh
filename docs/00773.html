<html>
<head>
<title>Reverse Geo-coding using K-Dimensional Trees</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用K维树的反向地理编码</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/reverse-geo-coding-using-k-dimensional-trees-adc542c524b4?source=collection_archive---------1-----------------------#2019-07-23">https://levelup.gitconnected.com/reverse-geo-coding-using-k-dimensional-trees-adc542c524b4?source=collection_archive---------1-----------------------#2019-07-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1b53e6f7a9f67b6d428aec5c034ef3e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bkeDLIN5yj6WPqgWhJO5pQ.jpeg"/></div></div></figure><h2 id="eaf8" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">你需要什么</h2><p id="c6d8" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">对于这个项目，我们将使用<code class="fe lp lq lr ls b">reverse_geocoder</code> <a class="ae lt" href="https://github.com/thampiman/reverse-geocoder" rel="noopener ugc nofollow" target="_blank">库</a>(由Ajay Thampi开发)，它是由(Richard Penman)开发的<code class="fe lp lq lr ls b">reverse_geocode</code> <a class="ae lt" href="https://bitbucket.org/richardpenman/reverse_geocode/src/default/" rel="noopener ugc nofollow" target="_blank">库</a>的改进。</p><h2 id="a387" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">它是如何工作的</h2><p id="0a25" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">这两种方法都使用K维树来查找最近的邻居。<code class="fe lp lq lr ls b">reverse_geocode</code> <a class="ae lt" href="https://bitbucket.org/richardpenman/reverse_geocode/src/default/" rel="noopener ugc nofollow" target="_blank">库</a>仅使用单线程搜索，而<code class="fe lp lq lr ls b">reverse_geocoder</code>使用多线程K维树。</p><p id="c021" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">为什么两者都用K-D树？k是树的维数。k维树有助于划分空间，就像二分搜索法树有助于划分直线一样。K-D树递归地划分空间区域，在树的每一层创建二进制空间划分。K-D树在涉及多维搜索关键字的搜索中是有用的(例如，范围搜索和最近邻搜索等)。)</p><h2 id="8749" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">装置</h2><p id="b683" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated"><code class="fe lp lq lr ls b">pip install reverse_geocoder</code></p><h2 id="9992" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">导入先决条件</h2><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="55f1" class="jy jz iq ls b gy mh mi l mj mk">import pandas as pd<br/>import io<br/>import reverse_geocoder as rg</span></pre><p id="0384" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">这里的自定义数据源是<a class="ae lt" href="https://raw.githubusercontent.com/thampiman/reverse-geocoder/master/reverse_geocoder/rg_cities1000.csv" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="6316" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">查看默认值，您可能想要使用您的自定义文件。根据我与不同组织合作的经验，大多数公司将形成自己的“区域”,这与行政区(即县、省、选区等)有很大不同。好的一面是，您可以将自定义数据源添加为CSV格式，并且具有以下标题:</p><ul class=""><li id="a2bc" class="ml mm iq kw b kx lu lb lv kh mn kl mo kp mp lo mq mr ms mt bi translated">纬度</li><li id="1a03" class="ml mm iq kw b kx mu lb mv kh mw kl mx kp my lo mq mr ms mt bi translated">经度</li><li id="4d26" class="ml mm iq kw b kx mu lb mv kh mw kl mx kp my lo mq mr ms mt bi translated">名称(地点的名称)—地点的名称。</li><li id="d78c" class="ml mm iq kw b kx mu lb mv kh mw kl mx kp my lo mq mr ms mt bi translated">admin1 (Admin 1区域)—您可以随意使用，例如国家、县、省</li><li id="ba57" class="ml mm iq kw b kx mu lb mv kh mw kl mx kp my lo mq mr ms mt bi translated">管理2(管理2区域)—例如，选区或更大的区域，如东非、沙无然非洲等。</li><li id="f6c2" class="ml mm iq kw b kx mu lb mv kh mw kl mx kp my lo mq mr ms mt bi translated">cc(ISO 3166-1 alpha-2国家代码，例如，对于肯尼亚，它是KE)。</li></ul><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="3c8d" class="jy jz iq ls b gy mh mi l mj mk">#Load File with Geocodes and regions<br/>geo = rg.RGeocoder(mode=2, verbose=True, stream=io.StringIO(open(‘rg_cities1000.csv’, encoding=’utf-8').read()))</span></pre><p id="6bd9" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">接下来，我们加载包含GPS坐标的文件，并希望获得它们的区域。</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="18d4" class="jy jz iq ls b gy mh mi l mj mk">data = pd.read_csv(‘my_data.csv’)</span></pre><p id="f352" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">快速浏览一下数据:</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="2989" class="jy jz iq ls b gy mh mi l mj mk"># Preview Data<br/>print(data.head(10))</span></pre><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/fa1d04d8894b4bf0b25d8682bae0efe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*hwrkM2oeRDAZXjMrETkR4w.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">预览数据</figcaption></figure><p id="0d40" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">让我们把我们需要的放入一个新的变量中，并传递给<code class="fe lp lq lr ls b">geo.query()</code>函数。您可以跳过这一部分，只在传递数据帧时对其进行切片。</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="ada5" class="jy jz iq ls b gy mh mi l mj mk">coordinates = data[[‘Lat’,’Long’]]<br/>results = geo.query(coordinates)</span></pre><p id="edbc" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">或者</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="f290" class="jy jz iq ls b gy mh mi l mj mk">results = geo.query(data[['Lat','Long']])</span></pre><p id="59db" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">这是结果的样子。这是非常不可读的，对不对？</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/2150c4addcc195d3fe4bd1c38fd79747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KYAi2DwQm7V6bJtKrKgzeQ.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">反向_地理编码器结果</figcaption></figure><p id="56cc" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">让我们看看字典列表中的第一行，了解数据是如何排列的。</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="5ca1" class="jy jz iq ls b gy mh mi l mj mk">Row1 = (results[0:1])<br/>Row1[0:1]</span><span id="ad6c" class="jy jz iq ls b gy nf mi l mj mk">Row1</span></pre><p id="4b23" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">它看起来是这样的:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/36db5c2b3ea705b4973ee6d990171abb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*e0cmCAemXeuM_z0K7ktNlg.png"/></div></figure><p id="ed8d" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">我们需要提取我们需要的变量。即名称、管理员1等。</p><p id="2379" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">让我们得到它！</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="6502" class="jy jz iq ls b gy mh mi l mj mk">Name = [d[‘name’] for d in results]<br/>Name</span></pre><p id="fa09" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">这将打印出一个大列表，如下所示</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/143bee7d51fc1afe57cefd90dc385d05.png" data-original-src="https://miro.medium.com/v2/resize:fit:766/format:webp/1*51pDz_ODmTJxOQiZZT8e_w.png"/></div></div></figure><p id="e54d" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">我们如何把这个和其他的放入一个数据框架？这很简单，我们只需要提取值，并把它们放入如下所示的数据框中</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="5651" class="jy jz iq ls b gy mh mi l mj mk">regions = pd.DataFrame(columns=[‘Name’], data=Name)<br/>regions[‘admin1’] = pd.DataFrame(columns=[‘admin1’], data=admin1)<br/>regions[‘admin2’] = pd.DataFrame(columns=[‘admin2’], data=admin2)<br/>regions[‘cc’] = pd.DataFrame(columns=[‘cc’], data=cc)<br/>regions[‘index’] = regions.index</span><span id="362c" class="jy jz iq ls b gy nf mi l mj mk">regions.head(10)</span></pre><p id="7ec3" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">这是它看起来的样子。很整洁，是吧？</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/3bd7db86cfcc96dfc68759e80691de3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0O0Ae7nRBACdzU2Ufs80yg.png"/></div></div></figure><p id="2451" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">就是这样！</p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><h1 id="4384" class="nq jz iq bd ka nr ns nt kd nu nv nw kg nx ny nz kk oa ob oc ko od oe of ks og bi translated">奖励:将结果加入我们的数据</h1><p id="3da2" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">让我们为我们的结果添加一个索引:</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="b69c" class="jy jz iq ls b gy mh mi l mj mk"># Add index column to our results<br/>region['index'] = region.index<br/>region.head(10)</span></pre><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oh"><img src="../Images/181a4514eeac02e7c295990ce3307243.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qTK-sEBk63RFGau0pFpXeg.png"/></div></div></figure><p id="88fc" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">让我们也为我们的数据添加一个索引列(有纬度和经度的那个)。</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="89e9" class="jy jz iq ls b gy mh mi l mj mk">data['index'] = data.index<br/>print(data.head(10))</span></pre><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/a37f5ff8648a91378ddd1a3573bf307e.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/format:webp/1*8CL4utcQeE30dHIjYgxN_Q.png"/></div></figure><p id="d539" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">我们将使用索引列来合并两个数据框。</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="1fc3" class="jy jz iq ls b gy mh mi l mj mk">region_and_data = data.merge(region, left_on='index', right_on='index')<br/>region_and_data.head(5)</span></pre><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/57d04b2bac19d84738c1b957bef9700d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FVSuOCD2xM8PeozTh1E5ew.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">合并数据</figcaption></figure><h1 id="9340" class="nq jz iq bd ka nr ok nt kd nu ol nw kg nx om nz kk oa on oc ko od oo of ks og bi translated">奖励:导出到CSV</h1><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="e31d" class="jy jz iq ls b gy mh mi l mj mk"># Export data to CSV<br/>region_and_data.to_csv ('region_and_data.csv', index=None, header = True)</span></pre></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><h1 id="ad8b" class="nq jz iq bd ka nr ns nt kd nu nv nw kg nx ny nz kk oa ob oc ko od oe of ks og bi translated">奖励:超过IOPub数据速率。</h1><p id="9011" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">如果您正在使用Jupyter Notebook，并且在打印结果时出现以下错误:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/6dd11975ed6491f2a2610646ad55ab89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ks88EbONtoaHcmQjNDvt3Q.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">Jupyter笔记本— IOPub数据速率超出错误。</figcaption></figure><p id="daf1" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">在命令行上运行这个命令，重启Jupyter并运行您的代码:</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="b3a8" class="jy jz iq ls b gy mh mi l mj mk">jupyter notebook — NotebookApp.iopub_data_rate_limit=1.0e10</span></pre><p id="3080" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">然后使用将显示的URL类似于。</p><pre class="lz ma mb mc gt md ls me mf aw mg bi"><span id="4b7b" class="jy jz iq ls b gy mh mi l mj mk">h<a class="ae lt" href="http://localhost:8889/?token=1930859f498ad9f1e6b1cf72e714916316571df0813eb22e" rel="noopener ugc nofollow" target="_blank">ttp://localhost:8889/?token=1930859f498ad9f1e6b1cf7214916316571df0813eb22e</a></span></pre><p id="7f9e" class="pw-post-body-paragraph ku kv iq kw b kx lu kz la lb lv ld le kh lw lg lh kl lx lj lk kp ly lm ln lo ij bi translated">这一切都在我的<a class="ae lt" href="https://github.com/JosephMagiya/Reverse-Geo-coding-using-K-Dimensional-Trees" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>上。看看这个。</p></div></div>    
</body>
</html>