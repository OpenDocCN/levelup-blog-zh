<html>
<head>
<title>How to parse forms using Google Cloud Document AI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用谷歌云文档AI解析表单</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-parse-forms-using-google-cloud-document-ai-68ad47e1c0ed?source=collection_archive---------3-----------------------#2020-10-14">https://levelup.gitconnected.com/how-to-parse-forms-using-google-cloud-document-ai-68ad47e1c0ed?source=collection_archive---------3-----------------------#2020-10-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ad41" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">从纸质表单中提取结构化数据的分步指南</h2></div><p id="c9eb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">许多业务流程，尤其是涉及与客户和合作伙伴交互的业务流程，都涉及到纸质表单。作为消费者，我们习惯于填写表格来申请保险、进行保险索赔、指定医疗保健偏好、申请就业、扣缴税款等。这些交易的另一方的企业得到一个表单，他们需要解析该表单，从中提取特定的数据片段，并使用该表单填充数据库。</p><h2 id="a199" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">输入表单</h2><p id="df06" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">Google Cloud Document AI自带表单解析功能。让我们用它来解析一个活动披露表单。这些是美国每场政治竞选都需要向联邦选举委员会提交的表格。这种形式的一个例子:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi lz"><img src="../Images/3f940c3dcb008ba721ae16d96549021f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*MjREdGkpQS0VI1oTUzAVew.png"/></div></div></figure><h2 id="5945" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">上传到云存储</h2><p id="2281" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">需要将表单加载到云存储中，以便文档AI能够访问它。完整的代码可以在GitHub的这个笔记本上找到。</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="0c8d" class="lb lc iq mn b gy mr ms l mt mu">gsutil cp scott_walker.pdf \<br/>          gs://{BUCKET}/formparsing/scott_walker.pdf</span></pre><h2 id="814c" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">创建请求</h2><p id="4fbd" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">要调用文档AI，我们需要创建一个请求JSON结构，如下所示:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="1d91" class="lb lc iq mn b gy mr ms l mt mu">{<br/>   "inputConfig":{<br/>      "gcsSource":{<br/>         "uri":"${PDF}"<br/>      },<br/>      "mimeType":"application/pdf"<br/>   },<br/>   "documentType":"general",<br/>   "formExtractionParams":{<br/>      "enabled":true<br/>   }<br/>}</span></pre><p id="7b76" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们将它发送给服务:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="b88b" class="lb lc iq mn b gy mr ms l mt mu">curl -X POST \<br/>  -H "Authorization: Bearer "$(gcloud auth application-default print-access-token) \<br/>  -H "Content-Type: application/json; charset=utf-8" \<br/>  -d <a class="ae ml" href="http://twitter.com/request" rel="noopener ugc nofollow" target="_blank">@request</a>.json \<br/>  <a class="ae ml" href="https://${REGION}-documentai.googleapis.com/v1beta2/projects/${PROJECT}/locations/us/documents:process" rel="noopener ugc nofollow" target="_blank">https://${REGION}-documentai.googleapis.com/v1beta2/projects/${PROJECT}/locations/us/documents:process</a></span></pre><h2 id="732a" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">解析响应</h2><p id="d47f" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">响应是一个JSON文档，我们可以解析它以提取我们想要的数据。响应有一个包含所有提取文本的文本字段。您可以通过以下方式获得:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="2b2a" class="lb lc iq mn b gy mr ms l mt mu">allText = response['text']</span></pre><p id="419d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，该文本包含“库存现金”字样，因为它出现在以下形式中:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/3e4e07d5f02d71f9978d2ea950fafb50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*uF2igcbQdcLwDoFoxChrlw.png"/></div></figure><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/a24f3671b1beeca808ecc8f689cd2ee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:628/format:webp/1*6PS7Gt9ayc0NqJOAK8T8jQ.png"/></div></figure><p id="f38e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">比方说，我们想找到该活动目前手头的实际金额($75，931.36)。该信息可在表格的第二页找到。因此，我们可以查找page=1(从page=0开始)并查看文本块或提取表单字段。</p><p id="5ddd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">文本块更低级；表单字段是一个更高层次的抽象。让我们两个都看看。</p><h2 id="a280" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">方法1:从文本块</h2><p id="d572" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">例如，如何在page=1上获得block=5:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="ff76" class="lb lc iq mn b gy mr ms l mt mu">response['pages'][1]['blocks'][5]</span></pre><p id="e9e4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该块本身是一个JSON结构:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="5002" class="lb lc iq mn b gy mr ms l mt mu">{'layout': {'textAnchor': {'textSegments': [{'startIndex': '1716',<br/>     'endIndex': '1827'}]},<br/>  'confidence': 1,<br/>  'boundingPoly': {'normalizedVertices': [{'x': 0.068627454, 'y': 0.24873738},<br/>    {'x': 0.6764706, 'y': 0.24873738},<br/>    {'x': 0.6764706, 'y': 0.25757575},<br/>    {'x': 0.068627454, 'y': 0.25757575}]},<br/>  'orientation': 'PAGE_UP'}}</span></pre><p id="2cc9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以依次解析它以获得textSegment的开始和结束索引:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="da52" class="lb lc iq mn b gy mr ms l mt mu">startIndex = int(response['pages'][1]['blocks'][5]['layout']['textAnchor']['textSegments'][0]['startIndex'])<br/>endIndex = int(response['pages'][1]['blocks'][5]['layout']['textAnchor']['textSegments'][0]['endIndex'])</span></pre><p id="548c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在全文中使用开始和结束索引:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="7c43" class="lb lc iq mn b gy mr ms l mt mu">allText[startIndex:endIndex]</span></pre><p id="64e4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">给了我们:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="eda7" class="lb lc iq mn b gy mr ms l mt mu">'6. CASH ON HAND AT BEGINNING OF REPORTING PERIOD .............................................................\n'</span></pre><p id="2780" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嗯，那是block=5。什么是block=6？</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mx"><img src="../Images/b7cea570bfd6b5c54617212829e653be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tqA2sh_rZ4ZH98qxgNTSbw.png"/></div></div></figure><p id="5d8f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">是的，75931.36美元。</p><h2 id="4aa2" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">方法2:表单域</h2><p id="681c" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">文档AI理解这种形式由名称-值对组成。因此，我们可以在这个层次上解析JSON响应。让我们先写一个助手函数:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="37ae" class="lb lc iq mn b gy mr ms l mt mu">def extractText(allText, elem):<br/>    startIndex = int(elem['textAnchor']['textSegments'][0]['startIndex'])<br/>    endIndex = int(elem['textAnchor']['textSegments'][0]['endIndex'])<br/>    return allText[startIndex:endIndex].strip()</span></pre><p id="891a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要获得第二页上的第三个表单字段，我们需要:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="5618" class="lb lc iq mn b gy mr ms l mt mu">response['pages'][1]['formFields'][2]</span></pre><p id="0d04" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这为我们提供了以下结构:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="aec6" class="lb lc iq mn b gy mr ms l mt mu">{'fieldName': {'textAnchor': {'textSegments': [{'startIndex': '1719',<br/>     'endIndex': '1765'}]},<br/>  'confidence': 0.9962783,<br/>  'boundingPoly': {'normalizedVertices': [{'x': 0.0922335, 'y': 0.24873738},<br/>    {'x': 0.4584429, 'y': 0.24873738},<br/>    {'x': 0.4584429, 'y': 0.2587827},<br/>    {'x': 0.0922335, 'y': 0.2587827}]},<br/>  'orientation': 'PAGE_UP'},<br/> 'fieldValue': {'textAnchor': {'textSegments': [{'startIndex': '1716',<br/>     'endIndex': '1842'}]},<br/>  'confidence': 0.9962783,<br/>  'boundingPoly': {'normalizedVertices': [{'x': 0.068627454, 'y': 0.24873738},<br/>    {'x': 0.90849674, 'y': 0.24873738},<br/>    {'x': 0.90849674, 'y': 0.26767677},<br/>    {'x': 0.068627454, 'y': 0.26767677}]},<br/>  'orientation': 'PAGE_UP'}}</span></pre><p id="21b6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，我们可以使用以下方法提取字段名和字段值:</p><pre class="ma mb mc md gt mm mn mo mp aw mq bi"><span id="9e23" class="lb lc iq mn b gy mr ms l mt mu">fieldName = extractText(allText, response['pages'][1]['formFields'][2]['fieldName'])<br/>fieldValue = extractText(allText, response['pages'][1]['formFields'][2]['fieldValue'])</span></pre><p id="c52b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p><h2 id="4bd4" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">后续步骤:</h2><ol class=""><li id="953b" class="my mz iq kh b ki lu kl lv ko na ks nb kw nc la nd ne nf ng bi translated">试试看:<a class="ae ml" href="https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/form_parser/formparsing.ipynb" rel="noopener ugc nofollow" target="_blank">https://github . com/Google cloud platform/training-data-analyst/blob/master/blogs/form _ parser/form parsing . ipynb</a></li><li id="3c8b" class="my mz iq kh b ki nh kl ni ko nj ks nk kw nl la nd ne nf ng bi translated">阅读文件:<a class="ae ml" href="https://cloud.google.com/document-ai/docs/process-forms" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/document-ai/docs/process-forms</a></li><li id="313c" class="my mz iq kh b ki nh kl ni ko nj ks nk kw nl la nd ne nf ng bi translated">阅读关于返回结构的参考:<a class="ae ml" href="https://cloud.google.com/document-ai/docs/reference/rpc/google.cloud.documentai.v1beta2#formfield" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/document-ai/docs/reference/RPC/Google . cloud . documentai . v1 beta</a>2</li></ol></div></div>    
</body>
</html>