<html>
<head>
<title>Deploying Docker Containers With Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ansible部署Docker容器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploying-docker-containers-with-ansible-2a74a420e2b1?source=collection_archive---------0-----------------------#2021-08-19">https://levelup.gitconnected.com/deploying-docker-containers-with-ansible-2a74a420e2b1?source=collection_archive---------0-----------------------#2021-08-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/ab6fc128f2b0ddf0abfeb72b2aa297ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kbNRxHSDomFgMHMUGt_m-w.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@william07?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">威廉·威廉</a>在<a class="ae kf" href="https://unsplash.com/s/photos/container?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure></div><div class="ab cl kg kh hx ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="im in io ip iq"><p id="0cef" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">Ansible无疑是最有影响力和最普遍的配置管理工具之一。Docker是集装箱化的行业标准。当你把它们结合在一起时会发生什么？魔法，那是什么。</p><p id="e390" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">有很多不同的方法来实现微服务和部署容器。你可以使用Kubernetes，Docker Swarm，Python，甚至shell脚本。这样的例子不胜枚举。但是如果你只需要将一些基本的容器部署到已经在Ansible库存中的主机上，那么最简单的方法就是使用Ansible。</p><p id="fb83" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">在本文中，我们将探索如何使用Ansible在主机上运行Docker容器。它非常简单明了，可以让您现有的剧本和角色保持整洁。让我们开始吧。</p><h2 id="420d" class="ll lm it bd ln lo lp dn lq lr ls dp lt ky lu lv lw lc lx ly lz lg ma mb mc md bi translated">先决条件</h2><p id="88b9" class="pw-post-body-paragraph kn ko it kp b kq me ks kt ku mf kw kx ky mg la lb lc mh le lf lg mi li lj lk im bi translated">在接下来的几个步骤中，我们将在本地部署Nginx Docker容器。如果你不熟悉Nginx，它是一种轻量级的快速网络服务器，被许多公司用于托管网站和其他服务。一旦Nginx容器启动并运行，我们将能够通过访问Nginx测试页面来确认它的工作。</p><p id="f22a" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">在继续之前，确保您已经在主机上安装了Docker是很重要的。您可以使用<code class="fe mj mk ml mm b">docker ps</code>检查运行中的容器。如果您还没有安装Docker，请访问:</p><p id="cea1" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated"><a class="ae kf" href="https://docs.docker.com/engine/install/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/engine/install/</a></p><p id="39f6" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">为了让Ansible能够部署容器，您还需要使用Ansible指向的同一Python版本安装以下Python模块:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="0471" class="ll lm it mm b gy mv mw l mx my">pip3 install docker</span></pre><p id="40d6" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">如果你安装了模块，Ansible不能识别它的存在，你可能需要检查你使用的Python版本是否正确。您的主机可能有多个不同的版本，或者Ansible可能使用了错误的版本。通过将<code class="fe mj mk ml mm b">ansible_python_interpreter</code>变量设置为当前Python安装的路径，可以将Ansible指向正确的方向。</p><h2 id="d1bd" class="ll lm it bd ln lo lp dn lq lr ls dp lt ky lu lv lw lc lx ly lz lg ma mb mc md bi translated">构建行动手册</h2><p id="376e" class="pw-post-body-paragraph kn ko it kp b kq me ks kt ku mf kw kx ky mg la lb lc mh le lf lg mi li lj lk im bi translated">现在我们已经安装了依赖项，我们可以继续构建我们的剧本了。在这个例子中，我们将使用一个只有一个任务的剧本来部署容器:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="445b" class="ll lm it mm b gy mv mw l mx my"># playbook.yml<br/>---<br/>- hosts: localhost<br/>  connection: local<br/>  tasks:<br/>    - name: deploy nginx docker container<br/>      docker_container:<br/>        image: nginx:stable<br/>        name: nginx<br/>        state: started<br/>        auto_remove: true<br/>        ports:<br/>          - "8080:80"</span></pre><p id="b84e" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">该行动手册中的所有内容都是独立的，因此您可以在本地使用<code class="fe mj mk ml mm b">ansible-playbook</code>进行部署。主机和连接都是本地的。在<code class="fe mj mk ml mm b">docker_container</code>任务中，我们传递图像、名称、状态等标准参数。这与<code class="fe mj mk ml mm b">docker-compose</code>的语法非常相似，所以如果你曾经在compose中写过任何东西，你会有宾至如归的感觉。</p><p id="ecee" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">最后，为了测试我们的新web服务器，我们将端口8080向下转发到容器内的端口80。</p><h2 id="b244" class="ll lm it bd ln lo lp dn lq lr ls dp lt ky lu lv lw lc lx ly lz lg ma mb mc md bi translated">把所有的放在一起</h2><p id="3cc8" class="pw-post-body-paragraph kn ko it kp b kq me ks kt ku mf kw kx ky mg la lb lc mh le lf lg mi li lj lk im bi translated">我们的剧本准备好了，我们准备运行我们的新容器。为了部署容器，发出以下Ansible命令:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="8ece" class="ll lm it mm b gy mv mw l mx my">ansible-playbook playbook.yml</span></pre><p id="310d" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">假设一切都成功了，现在您应该能够使用<code class="fe mj mk ml mm b">docker ps</code>检查正在运行的容器了。现在你可以打开浏览器，前往<code class="fe mj mk ml mm b">localhost:8080</code>查看Nginx测试页面:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/1cb68a00a498cee51d83f64e65863900.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hwA54hRgVOwvFW2QHgYhFg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Nginx欢迎页面。</figcaption></figure><p id="9fba" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">如果您能够看到测试页面，那么这个闪亮的新Nginx容器已经启动并运行在正确的端口上。为了停止正在运行的容器，你可以简单地发出<code class="fe mj mk ml mm b">docker stop nginx</code>命令，容器将关闭并自动移除(由前面的<code class="fe mj mk ml mm b">auto_remove: true</code>变量设置)。</p><h2 id="0501" class="ll lm it bd ln lo lp dn lq lr ls dp lt ky lu lv lw lc lx ly lz lg ma mb mc md bi translated">后续步骤</h2><p id="2666" class="pw-post-body-paragraph kn ko it kp b kq me ks kt ku mf kw kx ky mg la lb lc mh le lf lg mi li lj lk im bi translated">既然您已经尝试了在本地部署一个容器，那么您可以轻松地扩展这个剧本，使其适用于多个容器、不同的动态版本，甚至可以使用Ansible <code class="fe mj mk ml mm b">docker_compose</code>模块和现有的compose文件。有关这两个模块的详细使用信息，请查阅以下官方文档:</p><ul class=""><li id="b03d" class="na nb it kp b kq kr ku kv ky nc lc nd lg ne lk nf ng nh ni bi translated"><a class="ae kf" href="https://docs.ansible.com/ansible/latest/collections/community/docker/docker_container_module.html" rel="noopener ugc nofollow" target="_blank">可能的文档— docker_container </a></li><li id="71f6" class="na nb it kp b kq nj ku nk ky nl lc nm lg nn lk nf ng nh ni bi translated"><a class="ae kf" href="https://docs.ansible.com/ansible/latest/collections/community/docker/docker_compose_module.html" rel="noopener ugc nofollow" target="_blank">可提交的文档— docker_compose </a></li></ul><p id="41a3" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated">尽管使用像Kubernetes这样的服务来构建和部署容器可能有更好的方法，但是这些方法增加了不必要的复杂性。如果您的唯一目标是获得运行在一小组机器上的基本服务，如Nginx或其他实用程序，Ansible可能是一种更简单、更快速的方法。尤其是如果您已经在环境中利用它进行配置管理。</p></div><div class="ab cl kg kh hx ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="im in io ip iq"><p id="50a6" class="pw-post-body-paragraph kn ko it kp b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk im bi translated"><em class="no">感谢阅读！有了这些工具，您可以快速、轻松地构建适度复杂的部署，与您现有的配置管理系统紧密集成。查看</em> <a class="ae kf" href="https://medium.com/swlh/5-simple-ansible-tweaks-for-better-playbooks-fd9b789d5bca" rel="noopener"> <em class="no"> 5个简单可行的调整以获得更好的剧本</em> </a> <em class="no">以获得更多可行的技巧！</em></p></div></div>    
</body>
</html>