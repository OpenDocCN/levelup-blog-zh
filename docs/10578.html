<html>
<head>
<title>Encrypt Database Backup And Save On Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">加密数据库备份并保存在谷歌云平台上</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/encrypt-database-backup-and-save-on-google-cloud-platform-2f0421987569?source=collection_archive---------11-----------------------#2021-12-22">https://levelup.gitconnected.com/encrypt-database-backup-and-save-on-google-cloud-platform-2f0421987569?source=collection_archive---------11-----------------------#2021-12-22</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="a81f" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">为了改进备份功能，我添加了同步加密备份到GCP。</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/3664c00a3264431047f44a78f845ef2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KefUpgflMMiOGSjcNHI12g.jpeg"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">来自<a class="ae kz" href="https://www.pexels.com/photo/close-up-photo-of-mining-rig-1148820/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a>的<a class="ae kz" href="https://www.pexels.com/@cookiecutter?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> panumas nikhomkhai </a>摄影</figcaption></figure><h1 id="72f7" class="la lb iu bd lc ld le lf lg lh li lj lk ka ll kb lm kd ln ke lo kg lp kh lq lr bi translated">介绍</h1><p id="a6e8" class="pw-post-body-paragraph ls lt iu lu b lv lw jv lx ly lz jy ma mb mc md me mf mg mh mi mj mk ml mm mn in bi translated">在我用一个<code class="fe mo mp mq mr b">cronjob</code>设置了我的数据库备份之后，我在想一个好的解决方案，在服务器崩溃的情况下也有备份。</p><p id="3089" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">您可以在此阅读我如何创建自己的简单备份策略:</p><div class="mx my gq gs mz na"><a rel="noopener  ugc nofollow" target="_blank" href="/everybody-needs-backups-a-lesson-learned-the-hard-way-b4b720afaa3a"><div class="nb ab fp"><div class="nc ab nd cl cj ne"><h2 class="bd iv gz z fq nf fs ft ng fv fx it bi translated">每个人都需要备份——这是一个惨痛的教训</h2><div class="nh l"><h3 class="bd b gz z fq nf fs ft ng fv fx dk translated">我的Docker群中的一个大事件，以及事件发生后我开发的解决方案。</h3></div><div class="ni l"><p class="bd b dl z fq nf fs ft ng fv fx dk translated">levelup.gitconnected.com</p></div></div><div class="nj l"><div class="nk l nl nm nn nj no kt na"/></div></div></a></div><p id="a342" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">第一个想法是类似于在我的笔记本电脑上运行并每天下载数据库的<code class="fe mo mp mq mr b">rsync</code>作业。但这不是一个真正好的解决方案，所以我考虑了一个包括云存储的解决方案。因为GCP有300美元的免费学分，所以我选择了它而不是AWS。</p><p id="6322" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">我在这里创建了一个免费账户<a class="ae kz" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">，然后我创建了我的第一个存储桶。</a></p><h1 id="2ed0" class="la lb iu bd lc ld le lf lg lh li lj lk ka ll kb lm kd ln ke lo kg lp kh lq lr bi translated">安装Google Cloud SDK</h1><p id="b436" class="pw-post-body-paragraph ls lt iu lu b lv lw jv lx ly lz jy ma mb mc md me mf mg mh mi mj mk ml mm mn in bi translated">在云控制台的初始设置完成后，我执行了以下步骤将我的服务器连接到google storage。如果你正在和一个码头工人群体一起工作，这个过程必须在我的群体中的每个工人身上重复。如果你想建立一个Docker Swarm， <a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/docker-swarm-in-a-nutshell-ed2a9c42cd7c"> <strong class="lu iv">你可以从我的另一篇文章</strong> </a> <strong class="lu iv">中读到。</strong></p><p id="c5d1" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated"><strong class="lu iv">下载谷歌云SDK </strong></p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="13db" class="nt lb iu mr b gz nu nv l nw nx">curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-353.0.0-linux-x86_64.tar.gz<!-- --> </span></pre><p id="8f04" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated"><strong class="lu iv">提取它</strong></p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="3621" class="nt lb iu mr b gz nu nv l nw nx">tar -xf google-cloud-sdk-353.0.0-linux-x86_64.tar.gz</span></pre><p id="5ed7" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated"><strong class="lu iv">安装SDK </strong></p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="b63c" class="nt lb iu mr b gz nu nv l nw nx">./google-cloud-sdk/install.sh</span></pre><p id="b294" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">安装过程完成后，您必须重新连接外壳！</p><p id="7f1f" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated"><strong class="lu iv">初始化SDK </strong></p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="37fe" class="nt lb iu mr b gz nu nv l nw nx">./google-cloud-skd/bin/gcloud init</span></pre><p id="8c72" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">在初始化过程中，我必须登录我的谷歌账户</p><p id="f3ce" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated"><strong class="lu iv">找到水桶</strong></p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="b751" class="nt lb iu mr b gz nu nv l nw nx">gsutil ls</span></pre><p id="04b1" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">现在机器已连接到GCP，我可以使用<strong class="lu iv"> <em class="ny"> gsutil </em> </strong>来备份我的数据。</p><h1 id="40b3" class="la lb iu bd lc ld le lf lg lh li lj lk ka ll kb lm kd ln ke lo kg lp kh lq lr bi translated">加密</h1><p id="fd0e" class="pw-post-body-paragraph ls lt iu lu b lv lw jv lx ly lz jy ma mb mc md me mf mg mh mi mj mk ml mm mn in bi translated">现在我在每台服务器上都有了google连接，我可以开始创建备份脚本了。但是我首先收集了关于如何压缩数据库备份并以加密方式存储它们的信息。<strong class="lu iv">谷歌不应该有我的数据库！</strong>我知道:<strong class="lu iv"> <em class="ny">偏执</em> </strong></p><p id="d9e3" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">我选择了一个加密过程，该过程使用系统上的密码文件(我也将该文件下载到了我的机器上)。所以我必须创建一个安全的密码，并将其导出到一个变量中，然后可以在脚本中使用。</p><p id="6cf5" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">在文件中生成随机密码</p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="f043" class="nt lb iu mr b gz nu nv l nw nx">h<!-- -->ead -c 100 /dev/urandom | strings -n1 | tr -d '[:space:]' | head -c 40 &gt;&gt; ~/.pass</span></pre><p id="e7da" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">将文件导出到。当我在壳里面的时候，巴沙尔使用它</p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="2a95" class="nt lb iu mr b gz nu nv l nw nx">echo "export PASS=~/.pass" &gt;&gt; ~/.bashrc &amp;&amp; source ~/.bashrc</span></pre><p id="ce28" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">使文件"<strong class="lu iv">安全</strong></p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="7231" class="nt lb iu mr b gz nu nv l nw nx">c<!-- -->hmod 400 ~/.pass</span></pre><p id="953b" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">有了这些<code class="fe mo mp mq mr b">.pass</code>文件，我可以加密和压缩一个文件夹:</p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="5bcf" class="nt lb iu mr b gz nu nv l nw nx">tar czf - . | openssl enc -e -aes-256-cbc -pbkdf2 -iter 100000 -salt -out archive.enc -pass env:PASS</span></pre><p id="a5f7" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">为了解密，我必须使用:</p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="0b26" class="nt lb iu mr b gz nu nv l nw nx">openssl enc -d -aes-256-cbc -pbkdf2 -iter 100000 -salt -in archive.enc -pass env:PASS | tar zxf - --directory backup_restore</span></pre><h1 id="39d1" class="la lb iu bd lc ld le lf lg lh li lj lk ka ll kb lm kd ln ke lo kg lp kh lq lr bi translated">创建备份外壳脚本</h1><p id="266f" class="pw-post-body-paragraph ls lt iu lu b lv lw jv lx ly lz jy ma mb mc md me mf mg mh mi mj mk ml mm mn in bi translated">最后一步是真正创建一个<code class="fe mo mp mq mr b">shell-script</code>，然后在一个<code class="fe mo mp mq mr b">cronjob</code>中执行。在研究和测试之后，创建了这个脚本:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nz oa l"/></div></figure><p id="eee5" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated"><strong class="lu iv">重要的是知道你是否阅读/使用这个文件:</strong></p><ol class=""><li id="e4c1" class="ob oc iu lu b lv ms ly mt mb od mf oe mj of mn og oh oi oj bi translated">将<code class="fe mo mp mq mr b">YOUR_BACKUP_STORAGE_PATH</code>替换为您存储备份的路径。这个文件夹<strong class="lu iv">必须</strong>有两个子目录:<code class="fe mo mp mq mr b">backups_encrypted</code>和<code class="fe mo mp mq mr b">backups</code></li><li id="b20f" class="ob oc iu lu b lv ok ly ol mb om mf on mj oo mn og oh oi oj bi translated"><code class="fe mo mp mq mr b">YOUR_BUCKET_HERE</code>应更换为您想要使用的铲斗。用<code class="fe mo mp mq mr b">gsutil ls</code>找</li><li id="0aa9" class="ob oc iu lu b lv ok ly ol mb om mf on mj oo mn og oh oi oj bi translated"><code class="fe mo mp mq mr b">PATH_TO_GOOGLE_SDK_FOLDER</code>是您安装Google Cloud SDK的文件夹</li></ol><p id="f383" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">这个脚本现在可以在<code class="fe mo mp mq mr b">cronjob</code>中使用:</p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="7c60" class="nt lb iu mr b gz nu nv l nw nx">30 1 * * 6 export PASS=/root/.pass; /bin/sh /PATH_TO_SCRIPT/SCRIPTNAME.sh</span></pre><p id="6a2d" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">这个<code class="fe mo mp mq mr b">cronjob</code>每周六1:30执行。使用<a class="ae kz" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank"> crontab.guru </a>进行<code class="fe mo mp mq mr b">crontab</code>创作</p><p id="f2f4" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated"><strong class="lu iv">非常重要:</strong>您必须在执行脚本之前导出<code class="fe mo mp mq mr b">PASS</code>变量，因为<code class="fe mo mp mq mr b">cronjob</code>不是在您作为用户所在的bash中执行的，并且之前导出的<code class="fe mo mp mq mr b">PASS</code>变量不存在</p><p id="4f7a" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated"><strong class="lu iv">也非常重要:</strong>记住在集群中的每个worker节点上重新创建<code class="fe mo mp mq mr b">cronjob</code>(如果你使用Docker集群的话)。<strong class="lu iv">否则，数据将会丢失</strong>。</p><h1 id="a796" class="la lb iu bd lc ld le lf lg lh li lj lk ka ll kb lm kd ln ke lo kg lp kh lq lr bi translated">结束语</h1><p id="2a1a" class="pw-post-body-paragraph ls lt iu lu b lv lw jv lx ly lz jy ma mb mc md me mf mg mh mi mj mk ml mm mn in bi translated">在这篇简单的操作指南中，我解释了如何使用Google Cloud SDK在我的Google Bucket中保存一个加密的zip文件。</p><p id="7971" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">我有另一个教程，解释如何上传文件到亚马逊。您可以从本教程复制加密部分，并将其与上传到S3的文件结合起来:</p><div class="mx my gq gs mz na"><a href="https://aws.plainenglish.io/how-to-backup-your-files-to-aws-s3-b09f9378c082" rel="noopener  ugc nofollow" target="_blank"><div class="nb ab fp"><div class="nc ab nd cl cj ne"><h2 class="bd iv gz z fq nf fs ft ng fv fx it bi translated">如何将您的文件备份到AWS S3</h2><div class="nh l"><h3 class="bd b gz z fq nf fs ft ng fv fx dk translated">一个快速的可视化增强教程，涵盖了将您的重要文件保存到AWS S3所需的每个步骤。</h3></div><div class="ni l"><p class="bd b dl z fq nf fs ft ng fv fx dk translated">aws .平原英语. io</p></div></div><div class="nj l"><div class="op l nl nm nn nj no kt na"/></div></div></a></div><p id="6bbd" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated">我希望这篇文章对您有所帮助，并且能够在云中保存您宝贵的备份。我很想听听你的想法，如果你有任何问题，请写在下面。<em class="ny">👇👇👇</em></p><pre class="kk kl km kn gu np mr nq nr aw ns bi"><span id="443a" class="nt lb iu mr b gz nu nv l nw nx"><strong class="mr iv">Want to Connect With the Author?</strong></span><span id="1da2" class="nt lb iu mr b gz oq nv l nw nx">Here's my <a class="ae kz" href="https://github.com/paulknulst" rel="noopener ugc nofollow" target="_blank">GitHub</a> handle and <a class="ae kz" href="https://linkedin.com/in/paulknulst" rel="noopener ugc nofollow" target="_blank">LinkedId</a> profile.</span></pre></div><div class="ab cl or os hy ot" role="separator"><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow"/></div><div class="in io ip iq ir"><p id="ccd4" class="pw-post-body-paragraph ls lt iu lu b lv ms jv lx ly mt jy ma mb mu md me mf mv mh mi mj mw ml mm mn in bi translated"><em class="ny">本文最初发表于我的博客</em><a class="ae kz" href="https://www.paulsblog.dev/encrypt-database-backup-and-save-on-google-cloud-platform/" rel="noopener ugc nofollow" target="_blank"><em class="ny">https://www . paulsblog . dev/encrypt-database-backup-and-save-on-Google-cloud-platform/</em></a></p></div></div>    
</body>
</html>