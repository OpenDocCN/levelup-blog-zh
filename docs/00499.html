<html>
<head>
<title>Trool: a spreadsheet rule engine for NodeJS/TypeScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">trool:NodeJS/TypeScript的电子表格规则引擎</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/trool-a-spreadsheet-rule-engine-for-nodejs-typescript-edcb05fca231?source=collection_archive---------1-----------------------#2019-04-01">https://levelup.gitconnected.com/trool-a-spreadsheet-rule-engine-for-nodejs-typescript-edcb05fca231?source=collection_archive---------1-----------------------#2019-04-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="384a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从你的代码中去掉规则，这样非工程师也可以随时更新</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/52ec6fce8af662eaac98e2dd99c3045f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L_5Oh0QLfMxn1p3JFYcPaw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Trool让你的程序随时更新变得容易！</figcaption></figure><h1 id="a2ab" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Trool简介</h1><p id="891b" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">Trool是一个简单的用于NodeJS的npm库，它允许你以电子表格的格式为你的程序创建规则。企业的工程时间可能会很昂贵:您希望将其保持在最低水平。问题是，随着时间的推移，根据业务需要，您的程序可能需要许多小的更新。每次需要做小改动的时候就找程序员是浪费钱。与其在代码中硬编码这些小的变化，为什么不把它们移到电子表格中，这样你或者你团队中的非工程师就可以快速地做出改变。</p><blockquote class="me mf mg"><p id="5fa2" class="jn jo mh jp b jq jr js jt ju jv jw jx mi jz ka kb mj kd ke kf mk kh ki kj kk ij bi translated">虽然Trool可以在NodeJS中直接与JavaScript (ES5或ES6)一起使用，但所有文档都是TypeScript格式的，我们鼓励您使用这种格式。</p></blockquote></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="1f8c" class="lb lc iq bd ld le ms lg lh li mt lk ll lm mu lo lp lq mv ls lt lu mw lw lx ly bi translated">链接</h1><div class="mx my gp gr mz na"><a href="https://www.npmjs.com/package/trool" rel="noopener  ugc nofollow" target="_blank"><div class="nb ab fo"><div class="nc ab nd cl cj ne"><h2 class="bd ir gy z fp nf fr fs ng fu fw ip bi translated">trool</h2><div class="nh l"><h3 class="bd b gy z fp nf fr fs ng fu fw dk translated">用TypeScript编写的NodeJS规则引擎</h3></div><div class="ni l"><p class="bd b dl z fp nf fr fs ng fu fw dk translated">www.npmjs.com</p></div></div><div class="nj l"><div class="nk l nl nm nn nj no kv na"/></div></div></a></div><div class="mx my gp gr mz na"><a href="https://github.com/seanpmaxwell/trool" rel="noopener  ugc nofollow" target="_blank"><div class="nb ab fo"><div class="nc ab nd cl cj ne"><h2 class="bd ir gy z fp nf fr fs ng fu fw ip bi translated">seanpmaxwell/Trool</h2><div class="nh l"><h3 class="bd b gy z fp nf fr fs ng fu fw dk translated">用TypeScript编写的NodeJS的规则引擎。通过在…上创建帐户，为seanpmaxwell/Trool开发做出贡献</h3></div><div class="ni l"><p class="bd b dl z fp nf fr fs ng fu fw dk translated">github.com</p></div></div><div class="nj l"><div class="np l nl nm nn nj no kv na"/></div></div></a></div></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="99d2" class="lb lc iq bd ld le ms lg lh li mt lk ll lm mu lo lp lq mv ls lt lu mw lw lx ly bi translated">它是如何工作的</h1><p id="3dd8" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">要使用Trool，您只需创建要更新的类和电子表格，将它们传递给一个Trool方法，您将收到所有相同的对象，但根据您的规则进行了更新。电子表格的工作方式是检查所提供对象的属性，并根据满足条件的方式调用每个对象的方法。如果您想在整个电子表格的多个地方重用值，您可以创建<strong class="jp ir"> <em class="mh">导入</em> </strong>，它们是简单的键/值对列表。导入可以在电子表格中硬编码，也可以通过NodeJS代码传递。这是一个电子表格的示例。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nq"><img src="../Images/4a4d8601c86e61fce4eb44b186338f13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0oyWLdXoH2P2ry3ihgCt_g.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Trool电子表格，用于根据游客年龄和团体规模设定门票价格</figcaption></figure></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="4088" class="lb lc iq bd ld le ms lg lh li mt lk ll lm mu lo lp lq mv ls lt lu mw lw lx ly bi translated">装置</h1><pre class="km kn ko kp gt nr ns nt nu aw nv bi"><span id="01c4" class="nw lc iq ns b gy nx ny l nz oa">$ npm install --save trool</span><span id="0faf" class="nw lc iq ns b gy ob ny l nz oa">// the library includes the typings files so you don't need to install @types/trool</span></pre></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="cd30" class="lb lc iq bd ld le ms lg lh li mt lk ll lm mu lo lp lq mv ls lt lu mw lw lx ly bi translated">辅导的</h1><h2 id="147a" class="nw lc iq bd ld oc od dn lh oe of dp ll jy og oh lp kc oi oj lt kg ok ol lx om bi translated">设置Trool</h2><p id="3ead" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">安装Trool后，在程序中导入并实例化它。您可以向构造函数传递一个布尔值，这取决于您是否希望Trool在运行时显示任何日志记录数据。您应该在开发期间打开它，在生产时关闭它。</p><pre class="km kn ko kp gt nr ns nt nu aw nv bi"><span id="ce7f" class="nw lc iq ns b gy nx ny l nz oa">import Trool from 'trool';<br/><br/>class PriceCalculator {<br/><br/>    private trool: Trool;<br/><br/>    constructor() {<br/>        this.trool = new Trool(true);<br/>    }<br/>}</span></pre><h2 id="832d" class="nw lc iq bd ld oc od dn lh oe of dp ll jy og oh lp kc oi oj lt kg ok ol lx om bi translated">事实</h2><p id="fa55" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">要使用Trool，您必须首先理解一个<strong class="jp ir">事实</strong>的概念。事实是需要更新的实例对象或实例对象数组。若要创建事实，请实现一个TypeScript类，并确保每个属性都有getters和setters。如果你看上面截图中的单元格<code class="fe on oo op ns b">2A</code>，可以看到单元格的内容是<code class="fe on oo op ns b"><strong class="jp ir">Table</strong>: Visitors</code>。访问者是使用一组<code class="fe on oo op ns b">Visitor</code>实例对象创建的。</p><p id="7364" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建了TypeScript类之后，必须将事实传递给事实持有者对象中的Trool。事实持有者对象是一个JSON对象，键是电子表格中要访问的事实的名称，值是实例对象的数组。因此，使用<code class="fe on oo op ns b"><strong class="jp ir">Table</strong>: Visitors</code>，我们需要设置一个事实持有者对象，将访问者作为键，将单个访问者或访问者数组作为值。</p><pre class="km kn ko kp gt nr ns nt nu aw nv bi"><span id="5a6d" class="nw lc iq ns b gy nx ny l nz oa">public calculate() {</span><span id="bc39" class="nw lc iq ns b gy ob ny l nz oa">    const factsHolder = {<br/>        Visitors: [new Visitor(), new Visitor()]<br/>    }<br/>}</span></pre><h2 id="9a83" class="nw lc iq bd ld oc od dn lh oe of dp ll jy og oh lp kc oi oj lt kg ok ol lx om bi translated">决策表</h2><p id="7d2c" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">设置好事实后，打开Excel、LibreOffice Calc或您选择的其他电子表格工具。为了更新事实，我们需要建立一个<strong class="jp ir">决策表</strong>。决策表是一组操作(列)和规则(行)。如果规则通过，将调用操作来更新事实。如果事实是一个数组，决策表将遍历每个实例对象，并将其逻辑应用于每个值。</p><p id="f5c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">表格的第一个单元格指定了事实，它必须遵循精确的格式<code class="fe on oo op ns b"><strong class="jp ir">Table</strong>: "Name of the fact"</code>，否则将会抛出错误。接下来创建至少一个<strong class="jp ir">条件</strong>列和一个<strong class="jp ir">动作</strong>列。如果所有条件都通过，将执行该操作。您实现的条件和操作的数量没有限制，但是您必须指定其中一个，并且所有条件必须在所有操作之前。</p><p id="81ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在决策表的第二行，为条件和动作创建操作。条件必须是布尔运算，格式为<code class="fe on oo op ns b">factAttribute operator $param</code>。换句话说，<code class="fe on oo op ns b">$param</code>必须在操作的右侧。操作左侧的属性可以是常规方法或getter，但它必须是其中之一，并且存在于实例对象上。如果没有，Trool将抛出一个错误。</p><p id="7b79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">动作是当所有条件评估为<code class="fe on oo op ns b">true</code>时要触发的操作。该操作可以是事实上的setter或常规方法。如果使用常规方法，可以指定多个<code class="fe on oo op ns b">$param</code>。</p><p id="c5ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">规则</strong>是要传递给条件和动作操作的值的列表。规则的第一个单元格必须指定规则名称，该名称可以是任何值，但不能为空。在决策表上，Trool将遍历每个规则中的单元格，然后移动到下一个规则。单元格中的值将替换操作中的<code class="fe on oo op ns b">$param</code>值，操作将执行。如果某个条件的单元格为空，它将自动计算为真。如果某个规则的所有条件都为真，则将执行具有该规则值的操作。但是，如果一个单元格是空，则动作操作将不会执行。单元格值必须是可以用比较运算符计算的值，强烈建议您坚持使用原语，不要使用对象作为值。</p><p id="72fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看一个简单的决策表，它有1个条件、1个动作和2个规则(<em class="mh">“设定价格—常规”</em>和<em class="mh">“设定价格—季节”</em>)。Trool将遍历Tickets数组，首先查看<code class="fe on oo op ns b">option</code>的getter，并将其与每个规则的单元格值进行比较。在第一个规则(<em class="mh">设置价格-常规</em>)中，该表将查看每张票的<code class="fe on oo op ns b">option</code>属性是否设置为<em class="mh">“常规”</em>。如果是，将调用<code class="fe on oo op ns b">price</code>的设置器并设置值<code class="fe on oo op ns b">70</code>。<em class="mh">“定价—常规”</em>结束后，表格进入<em class="mh">“定价—季节”</em>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/f8d470ea75780e9c2de02a963d8305b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/1*iLB9US-jNmnw1RYlPy_6Iw.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">用于设置默认票价的决策表</figcaption></figure><p id="4c2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢Trool，如果您的机票价格定期变化或您希望在未来添加新的机票选项，您不必浪费宝贵的工程时间！</p><h2 id="0dc7" class="nw lc iq bd ld oc od dn lh oe of dp ll jy og oh lp kc oi oj lt kg ok ol lx om bi translated">进口</h2><p id="d9ae" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">假设有一个特定的值需要在多个表中使用，比如说，你需要字符串值总是以某种方式拼写。对于门票选项<em class="mh">“季节”</em>，你可能总是想确保它拼写为<em class="mh">季节</em>而不是<em class="mh">季节性</em>或其他什么。这就是进口派上用场的地方。通常，通过导入而不是直接使用字符串值来防止拼写错误是一个好主意。导入可以在电子表格中实现，也可以通过代码传递。对于较大的应用程序，您可能需要动态创建导入，并需要通过代码传递它们。对于简单的应用程序，建议您将导入保留在电子表格中。</p><p id="f3bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要在电子表格中创建导入，从单元格<code class="fe on oo op ns b"><strong class="jp ir">Import:</strong> “Import Name”</code>开始。接下来的行将作为键/值对添加到导入中，直到它到达一个空行、表或新导入。出于可读性的目的，您应该用空行将导入和决策表分开。</p><p id="6e78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是一个包含2个键/值对的导入示例。对于这个导入，您可以说<code class="fe on oo op ns b">TicketTypes.SEASON</code>，而不是为规则<em class="mh">“设置价格-季节”</em>做“季节”。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi or"><img src="../Images/a05a11ff0039c15e7ca7b6db1bb7d15a.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/1*wz9ljFTGK7g1IeKJbqP2BA.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">票证类型导入</figcaption></figure><p id="3972" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想通过代码传递导入，就像事实一样，它们必须通过holder对象来传递。该键必须是导入的名称和导入本身的值。对于我们刚刚在电子表格中进行的导入<em class="mh"> </em> <code class="fe on oo op ns b">TicketTypes</code>，下面是在代码中做同样事情的等效操作:</p><pre class="km kn ko kp gt nr ns nt nu aw nv bi"><span id="e06a" class="nw lc iq ns b gy nx ny l nz oa">public calculate(): void {</span><span id="8917" class="nw lc iq ns b gy ob ny l nz oa">    const factsHolder = {<br/>        Visitors: [new Visitor(), new Visitor()]<br/>    }</span><span id="4a98" class="nw lc iq ns b gy ob ny l nz oa">    const importsHolder = {<br/>        TicketTypes: {<br/>            REGULAR: 'Regular',<br/>            SEASON: 'Season'<br/>        }<br/>    }<br/>}</span></pre><h2 id="9252" class="nw lc iq bd ld oc od dn lh oe of dp ll jy og oh lp kc oi oj lt kg ok ol lx om bi translated">使用Trool</h2><p id="5c85" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">一旦你完成了电子表格的设置，确保将其导出为<em class="mh">。csv </em>文件。在Trool实例上，调用方法<code class="fe on oo op ns b">applyRules(…)</code>，传递csv文件的路径、事实对象，以及您决定在代码中而不是在电子表格中创建的任何导入。这个方法是异步的，它返回一个包含相同事实持有者对象的承诺，但是所有事实都根据调用的操作更新。现在，NodeJS程序可以继续使用它需要的所有更新值了。</p><pre class="km kn ko kp gt nr ns nt nu aw nv bi"><span id="4acf" class="nw lc iq ns b gy nx ny l nz oa">public <strong class="ns ir">async</strong> calculate(): Promise&lt;void&gt; {</span><span id="d5f4" class="nw lc iq ns b gy ob ny l nz oa">    const factsHolder = {<br/>        Visitors: [new Visitor(), new Visitor()]<br/>    }</span><span id="761b" class="nw lc iq ns b gy ob ny l nz oa">    const importsHolder = {<br/>        TicketTypes: {<br/>            REGULAR: 'Regular',<br/>            SEASON: 'Season'<br/>        }<br/>    }</span><span id="22b7" class="nw lc iq ns b gy ob ny l nz oa">    try {<br/>        const csvFilePath = path.join(__dirname,'filename.csv');</span><span id="0013" class="nw lc iq ns b gy ob ny l nz oa">        const <strong class="ns ir">updatedFacts</strong> = <strong class="ns ir">await</strong> this.trool.applyRules( csvFilePath, factsHolder, importsHolder);<br/><br/>    } catch (err) {<br/>        console.log(err.message);<br/>    }<br/>}</span></pre></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="03b6" class="lb lc iq bd ld le ms lg lh li mt lk ll lm mu lo lp lq mv ls lt lu mw lw lx ly bi translated">结论</h1><p id="5bfa" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">希望Trool对你大有用处，并大大减少你的工程时间。使用Trool的规则比一篇文章中所能描述的要多。我强烈建议您通过上面发布的GitHub链接阅读自述文件，以避免在实现决策表时出现错误。</p><p id="621e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您觉得这篇文章/库有帮助，请启动GitHub repo:)</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><div class="km kn ko kp gt na"><a href="https://gitconnected.com/learn/node-js" rel="noopener  ugc nofollow" target="_blank"><div class="nb ab fo"><div class="nc ab nd cl cj ne"><h2 class="bd ir gy z fp nf fr fs ng fu fw ip bi translated">学习Node.js -最佳Node.js教程(2019) | gitconnected</h2><div class="nh l"><h3 class="bd b gy z fp nf fr fs ng fu fw dk translated">前33个Node.js教程-免费学习Node.js。课程由开发人员提交和投票，使您能够…</h3></div><div class="ni l"><p class="bd b dl z fp nf fr fs ng fu fw dk translated">gitconnected.com</p></div></div><div class="nj l"><div class="os l nl nm nn nj no kv na"/></div></div></a></div></div></div>    
</body>
</html>