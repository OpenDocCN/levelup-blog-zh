<html>
<head>
<title>Architecting a CI/CD pipeline for container and microservice-based applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为基于容器和微服务的应用构建CI/CD管道</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/architecting-a-ci-cd-pipeline-for-container-and-microservice-based-applications-120f4b470681?source=collection_archive---------0-----------------------#2019-05-07">https://levelup.gitconnected.com/architecting-a-ci-cd-pipeline-for-container-and-microservice-based-applications-120f4b470681?source=collection_archive---------0-----------------------#2019-05-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ebab980541f1f653bf238ae1ecfbd7e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y5OLLcxI3Bc2c2Zrxw5Rvg.jpeg"/></div></div></figure><p id="da09" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我最近有机会与一位客户合作，使用容器编排技术提供一个可管理、安全、可扩展和高度可用的架构，用于水平自动扩展和自我修复系统。</p><p id="5f15" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们提出了使用AWS管理的Kubernetes服务(EKS)来轻松部署、管理和扩展容器化应用程序的架构。传统DevOps管道由CI/CD管道组成，其中包括代码存储库(位存储桶)、用于持续集成的自动化服务器(Jenkins ),用于部署。</p><p id="c177" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然Jenkins管道从CI延伸到CD，但现有的CI/CD自动化并没有利用不可变基础架构的优势。Jenkins不是为在Kubernetes中部署而设计的，而且由于该团队不熟悉kubectl术语，因此需要一个易于管理的平台来进行可靠的部署。</p><p id="ee59" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们使用Jenkins和Spinnaker推出了一个CI/CD管道，这是一个开源的多云连续交付平台，可以帮助客户交付代码，对客户没有任何影响。像临冬城的<em class="kw">琼恩·雪诺</em>一样，Spinnaker被证明是合法的继承人，简化了库伯内特的建造和部署过程。</p><p id="f773" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文将带您了解spinnaker如何与各种工具和服务无缝集成，从而自动化示例应用程序的部署。你可以在这里【https://www.spinnaker.io/ T4】探索更多关于Spinnaker及其特性的信息。</p><blockquote class="ky kz la"><p id="55bf" class="jy jz kw ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">当你张开大三角帆的时候，你就准备好随风飞翔了</p></blockquote><h1 id="ce4a" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">安装三角帆</h1><p id="b911" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">有几种方法可以安装Spinnaker。我们将使用名为Halyard的命令行管理工具来部署和配置Spinnaker。(可以参考官方安装指南:<a class="ae kx" href="https://www.spinnaker.io/setup/install/" rel="noopener ugc nofollow" target="_blank">https://www.spinnaker.io/setup/install/</a>)。下面是推进这一部署的一些要求。</p><ol class=""><li id="7104" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv mm mn mo mp bi translated">一个K8s群集，具有足够的资源来支持大约10个机架的部署。</li><li id="fdab" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">Jenkins服务器，可访问AWS ECR注册表以推送docker图像。</li></ol><p id="e738" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们创建一个专用的spinnaker名称空间</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="1c83" class="ne lf iq na b gy nf ng l nh ni">kubectl create ns spinnaker</span></pre><p id="6264" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其次，让我们创建一个升降索部署来配置Spinnaker。请放心使用最新稳定版本的升降索。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="71cc" class="ne lf iq na b gy nf ng l nh ni">kubectl create deployment hal --image gcr.io/spinnaker-marketplace/halyard:1.15.0</span></pre><p id="6058" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将创建一个具有集群管理员角色的服务帐户，并将该帐户添加到halyard部署规范中。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="24d3" class="ne lf iq na b gy nf ng l nh ni">kubectl create -f <a class="ae kx" href="https://raw.githubusercontent.com/SystemicEmotions/demoapp/master/spinnaker/accnt.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/SystemicEmotions/demoapp/master/spinnaker/accnt.yaml</a></span></pre><p id="9815" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编辑升降索部署以添加服务帐户，如下所示:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="22b5" class="ne lf iq na b gy nf ng l nh ni">spec:<br/>  serviceAccountName: spinnaker-service-account<br/>  containers:<br/>  - image: gcr.io/spinnaker-marketplace/halyard:1.15.0</span></pre><p id="adca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦升降索吊舱启动并运行，让我们启动一个shell会话来运行升降索命令</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="2d8e" class="ne lf iq na b gy nf ng l nh ni">kubectl exec -it &lt;halyard-pod&gt; bash</span></pre><h2 id="7a88" class="ne lf iq bd lg nj nk dn lk nl nm dp lo kj nn no ls kn np nq lw kr nr ns ma nt bi translated">配置持久性存储</h2><p id="6361" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">我们将在Spinnaker中为持久化应用程序设置和已配置的管道配置S3。我们需要创建一个桶和一个目录，如下所示。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="cbd9" class="ne lf iq na b gy nf ng l nh ni">hal config storage s3 edit --access-key-id &lt;access-id&gt; \<br/>--region &lt;region&gt; \<br/>--bucket &lt;bucket-name&gt; \<br/>--root-folder &lt;spin-folder&gt; \<br/>--secret-access-key</span><span id="b9a6" class="ne lf iq na b gy nu ng l nh ni">hal config storage edit --type s3</span></pre><h2 id="f452" class="ne lf iq bd lg nj nk dn lk nl nm dp lo kj nn no ls kn np nq lw kr nr ns ma nt bi translated">配置容器注册表(ECR)</h2><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="a756" class="ne lf iq na b gy nf ng l nh ni">hal config provider docker-registry enable</span><span id="1a50" class="ne lf iq na b gy nu ng l nh ni">hal config provider docker-registry account add my-ecr-registry \<br/>--address <a class="ae kx" href="https://161764708719.dkr.ecr.us-east-1.amazonaws.com" rel="noopener ugc nofollow" target="_blank">&lt;</a>aws-ecr-address&gt; \<br/>--username AWS \<br/>--password-command “aws --region us-east-1 ecr get-authorization-token --output text --query ‘authorizationData[].authorizationToken’ | base64 -d | sed ‘s/^AWS://’”</span></pre><h2 id="3387" class="ne lf iq bd lg nj nk dn lk nl nm dp lo kj nn no ls kn np nq lw kr nr ns ma nt bi translated">启用Kubernetes提供程序并添加ECR注册表</h2><p id="ffcf" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">Spinnaker帐户映射到可以针对K8s集群进行身份验证的凭证。它还包括一个或多个docker注册帐户，用作图像源。这里，我们将用指定的帐户配置上一步中提到的ECR registry。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="f85d" class="ne lf iq na b gy nf ng l nh ni">hal config provider kubernetes enable<br/>hal config provider kubernetes account add my-k8s-account --docker-registries my-ecr-registry<br/>hal config deploy edit --type distributed --account-name my-k8s-account</span></pre><p id="f72b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意最后一个命令中指定的分布式类型的使用。在分布式安装中，Halyard分别部署Spinnaker的每个<a class="ae kx" href="https://www.spinnaker.io/reference/architecture" rel="noopener ugc nofollow" target="_blank">微服务</a>。强烈建议在生产中使用。</p><h2 id="96dd" class="ne lf iq bd lg nj nk dn lk nl nm dp lo kj nn no ls kn np nq lw kr nr ns ma nt bi translated">配置Spinnaker与默认的k8s集群进行交互</h2><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="cd7c" class="ne lf iq na b gy nf ng l nh ni">kubectl config set-cluster default --server=https://kubernetes.default --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span id="bea6" class="ne lf iq na b gy nu ng l nh ni">kubectl config set-context default --cluster=default</span><span id="3463" class="ne lf iq na b gy nu ng l nh ni">token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)<br/>kubectl config set-credentials user --token=$token<br/>kubectl config set-context default --user=user<br/>kubectl config use-context default</span></pre><h2 id="5048" class="ne lf iq bd lg nj nk dn lk nl nm dp lo kj nn no ls kn np nq lw kr nr ns ma nt bi translated">将Jenkins master配置为从Spinnaker触发构建</h2><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="221c" class="ne lf iq na b gy nf ng l nh ni">hal config ci jenkins enable<br/>hal config ci jenkins master add my-jenkins-master \<br/>--address &lt;Jenkins URL&gt; \<br/>--username &lt;admin&gt; \<br/>--password</span></pre><h2 id="fc1b" class="ne lf iq bd lg nj nk dn lk nl nm dp lo kj nn no ls kn np nq lw kr nr ns ma nt bi translated">为Gate (API网关)和Deck (UI)创建服务</h2><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="3f38" class="ne lf iq na b gy nf ng l nh ni">kubectl create -f <a class="ae kx" href="https://raw.githubusercontent.com/SystemicEmotions/demoapp/master/spinnaker/svcs.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/SystemicEmotions/demoapp/master/spinnaker/svcs.yaml</a></span></pre><p id="a25c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">记下负载平衡器DNS端点</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="1d59" class="ne lf iq na b gy nf ng l nh ni">kubectl get svc -n spinnaker -o wide</span></pre><p id="6254" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们希望为端口9000的外部DNS设置UI (Deck ),为端口8084的外部DNS设置API (Gate)。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="6e16" class="ne lf iq na b gy nf ng l nh ni">hal config security ui edit --override-base-url http://&lt; deck — external-IP&gt;:9000<br/>hal config security api edit --override-base-url http://&lt; gate- external-IP&gt;:8084</span></pre><h2 id="369e" class="ne lf iq bd lg nj nk dn lk nl nm dp lo kj nn no ls kn np nq lw kr nr ns ma nt bi translated">使用身份提供者配置身份验证</h2><p id="3fb1" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">Spinnaker支持多种身份验证和授权选项。我们将使用基于SAML的IDP Okta来实现单点登录(SSO)。让我们在Okta中创建一个应用程序，并复制metadata.xml。为了在Okta中创建应用程序，我们将定义以下内容:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="8fa3" class="ne lf iq na b gy nf ng l nh ni"><em class="kw">Single Sign On URL — http://&lt;gate-endpoint&gt;:8084/saml/SSO<br/>Audience URI — spinnaker-test<br/>NameID format — EmailAdress</em></span></pre><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/2e1151f780e3dd9422e8c8298b4da6c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*kr7U1A17syG8C1F1eKNvhQ.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">在Okta创建Spinnaker应用程序</figcaption></figure><p id="4606" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">生成一个keystore，并在一个新的Java Keystore中键入一些密码。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="1d03" class="ne lf iq na b gy nf ng l nh ni">keytool -genkey -v -keystore saml.jks -alias saml -keyalg RSA -keysize 2048 -validity 10000</span></pre><p id="02fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后使用下面的halyard命令来配置认证</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="1001" class="ne lf iq na b gy nf ng l nh ni">hal config security authn saml edit \<br/>--keystore /home/spinnaker/saml.jks \<br/>--keystore-alias saml \<br/>--keystore-password &lt;mypass&gt; \<br/>--metadata /home/spinnaker/metadata.xml \<br/>--issuer-id spinnaker-test \<br/>--service-address-url http://&lt;gate-endpoint&gt;:8084</span></pre><h2 id="f86c" class="ne lf iq bd lg nj nk dn lk nl nm dp lo kj nn no ls kn np nq lw kr nr ns ma nt bi translated">选择spinnaker版本并应用部署</h2><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="cf74" class="ne lf iq na b gy nf ng l nh ni">hal version list<br/>hal config version edit --version 1.x.x</span></pre><p id="a16b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在运行最后一个命令之前，我们可以使用下面的命令查看自定义配置</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="2671" class="ne lf iq na b gy nf ng l nh ni">hal config list</span></pre><p id="f9cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后部署选定版本的spinnaker。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="aeab" class="ne lf iq na b gy nf ng l nh ni">hal deploy apply</span></pre></div><div class="ab cl oa ob hu oc" role="separator"><span class="od bw bk oe of og"/><span class="od bw bk oe of og"/><span class="od bw bk oe of"/></div><div class="ij ik il im in"><h2 id="9966" class="ne lf iq bd lg nj nk dn lk nl nm dp lo kj nn no ls kn np nq lw kr nr ns ma nt bi translated">在Jenkins中配置构建</h2><p id="b41d" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">在我们能够从Spinnaker部署应用程序之前，我们需要创建一个管道来构建映像并将其从Jenkins推送到ECR。</p><p id="bd7a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将使用下面的存储库进行示例部署。</p><p id="a321" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">https://github.com/SystemicEmotions/demoapp<a class="ae kx" href="https://github.com/SystemicEmotions/demoapp" rel="noopener ugc nofollow" target="_blank"/></p><p id="1966" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是存储库的内容</p><p id="bd6b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Dockerfile —使用nginx作为基本图像对静态html文件进行dockerize。</p><p id="2db0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Jenkinsfile —它定义了Jenkins中的各个阶段:克隆报告-&gt;构建映像-&gt;测试映像-&gt;将映像推送到ECR</p><p id="72b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Index.html—一个静态的html页面</p><p id="a3aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我定义了一个webhook，用于在任何代码更改提交到github存储库时触发spinnaker管道。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/e0d93d43afc3681fec046127541f14af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*QTq3dQlQQrsvehMh_pyyLg.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">在github存储库中定义webhook</figcaption></figure><p id="76db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Jenkins中创建一个管道项目，并定义存储库URL和脚本路径。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/0e5d6691f714cfafd2ccd5b030325557.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*-NGoPE3Sl5A5zikc6A2Csw.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">在詹金斯创建管道项目</figcaption></figure><p id="1107" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，我们需要在Jenkins中为ECR创建凭证，并修改Jenkinsfile中的“Push image”阶段以使用该凭证。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="7bbd" class="ne lf iq na b gy nf ng l nh ni">stage(‘Push image’) { docker.withRegistry(‘https://xxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com', ‘ecr:us-east-1:aws_ecr_cred’) {<br/>app.push(“latest”)<br/>}<br/>}</span></pre><p id="c163" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们继续手动触发构建。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/067cb069f37f361e4905d30d69142c2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*b1utSodlRvvhmGHgUX84Hw.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">Jenkins的工作是构建映像并将其推送到ECR</figcaption></figure><p id="3112" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦管道成功执行，我们应该能够看到ECR中列出的docker映像。我们现在可以开始创建管道，以便在Spinnaker中自动化整个构建和部署过程。</p><h2 id="093b" class="ne lf iq bd lg nj nk dn lk nl nm dp lo kj nn no ls kn np nq lw kr nr ns ma nt bi translated">在Spinnaker中为应用程序部署创建一个服务器组</h2><p id="83a2" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">我们将为应用程序部署创建一个服务器组。为了从公共网络访问网页，我们将首先从Spinnaker控制台创建一个负载平衡器。在创建新负载平衡器部分的高级设置下，将类型定义为负载平衡器。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/5c1b2c49e767411dbf70a0a4f839b7c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*LGkrBBY4t43UvckFjXzg3w.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">从Spinnaker控制台创建负载平衡器</figcaption></figure><p id="e484" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建负载平衡器后，我们将使用在Jenkins构建期间构建并推送到ECR的映像，在基础架构部分下创建一个服务器组(一组pod)。另外，指定我们在上一步中创建的负载平衡器。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/3aaefe8697f8588ed34d2faa4da6cb4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*E_JgJ0xLtTbcZvwZl-yqDA.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">创建服务器组来部署映像</figcaption></figure><p id="4ef3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦创建了服务器组，我们应该能够在kubernetes集群中看到正在运行的pods。我们现在应该能够使用负载平衡器端点来访问示例网页，它应该看起来像下面这样。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/944cefbc46b9c2b029cb2fdc9909ef20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*fraEkt55KWkD006Tm849tA.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">部署在kubernetes集群中的示例网页</figcaption></figure><h2 id="909c" class="ne lf iq bd lg nj nk dn lk nl nm dp lo kj nn no ls kn np nq lw kr nr ns ma nt bi translated">在Spinnaker中为持续部署创建管道</h2><p id="7a27" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">现在，让我们在Spinnaker中构建一个用于持续部署的管道。我们将在此管道中定义4个阶段。</p><ol class=""><li id="994d" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv mm mn mo mp bi translated">配置——这将包括一个触发器，用于获得Github代码库中任何代码更改的通知。</li></ol><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/f15e7720d8f639d3485c9097b9ebdd23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*mA8v3HDxi4zBDCvQdHSYmA.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">配置webhook以触发管道</figcaption></figure><p id="cd5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.Jenkins —在此阶段，我们将指定Jenkins主服务器并配置Jenkins作业，以触发阶段1之后的构建。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/1879261492b94ae6fa2296bc32138fc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*2i33GbghEl8pfyAscwwxhw.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">配置Jenkins主服务器以触发Jenkins作业</figcaption></figure><p id="4cac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.Deploy —这里我们将使用现有的应用程序部署配置模板，该模板是我们在开始创建服务器组时指定的。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/3595b6b71724db7ddbbed6331190aa87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*USsl-zmmhQqqAPkvuVmqOg.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">创建部署配置</figcaption></figure><p id="7dfe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.销毁服务器组—在此阶段，一旦我们的新pod启动并运行，我们将销毁之前的服务器组。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/46ab34618ff2dbd9b41c466c8e67b636.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*tqhXndV6NppFi_0y8XFUpA.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">创建最后一个阶段来销毁之前的服务器组</figcaption></figure><p id="dd1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦我们完成了管道的创建，让我们试着在Github中提交对index.html文件的修改。只要我们在Github中提交更改，Spinnaker管道就会被触发。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/a887e98654c35f614cd5f1324a6b50dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*CZ3p0pw-1dF7RJ1Ir69NPg.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">Spinnaker管道正在进行中</figcaption></figure><p id="68f5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦所有四个阶段都完全成功，我们应该能够看到新的变化反映在我们的网页上。这里有一个我录制的视频的链接，作为https://youtu.be/N4e3Zf1yFWY的演示。</p><p id="ccc3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">非常感谢您的反馈。</p></div></div>    
</body>
</html>