<html>
<head>
<title>How To Write Data From GSheets To Your Database Using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Python将GSheets中的数据写入数据库</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/write-datasets-from-g-sheet-to-your-database-with-python-bd2c2643f958?source=collection_archive---------2-----------------------#2021-03-05">https://levelup.gitconnected.com/write-datasets-from-g-sheet-to-your-database-with-python-bd2c2643f958?source=collection_archive---------2-----------------------#2021-03-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4a3f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在本教程中，学习如何用几行代码构建一个简单的ETL来跨系统移动Google电子表格数据。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8e286fa8453db15566755571228647d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JQm-OG1ZWPJZIz_2"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">格伦·卡斯滕斯-彼得斯在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="1441" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">想象一下:</em>您正在收集数据源以构建新的报告，并意识到一些数据集仍然由您的利益相关者手动更新并存储在Google电子表格中…听起来很熟悉吧？</p><p id="fe26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，您有两个选择:要么开办一个速成班来教您的技术水平较低的同事使用SQL和数据仓库，要么您自己用Python来自动化这个过程。</p><p id="7ce6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本教程中，您将学习如何通过连接到<strong class="lb iu"> Google Drive API </strong>使用Python从Google电子表格中提取数据集，然后使用<code class="fe lw lx ly lz b">SQLAlchemy</code>包将它们存储到数据库表中。</p><blockquote class="ma"><p id="d620" class="mb mc it bd md me mf mg mh mi mj lu dk translated">通过一步一步地遵循教程，您将能够用很少的代码在很短的时间内自动完成另一个乏味的任务。我们开始吧！</p></blockquote><div class="mk ml mm mn mo mp"><a href="https://towardsdatascience.com/10-csvkit-commands-data-engineers-must-know-a91b34e182e8" rel="noopener follow" target="_blank"><div class="mq ab fo"><div class="mr ab ms cl cj mt"><h2 class="bd iu gy z fp mu fr fs mv fu fw is bi translated">数据工程师必须知道的10个Csvkit命令</h2><div class="mw l"><h3 class="bd b gy z fp mu fr fs mv fu fw dk translated">在本教程中，学习如何使用csvkit和psql来分析、转换和移动数据跨系统的命令…</h3></div><div class="mx l"><p class="bd b dl z fp mu fr fs mv fu fw dk translated">towardsdatascience.com</p></div></div><div class="my l"><div class="mz l na nb nc my nd ks mp"/></div></div></a></div><h1 id="ad7c" class="ne nf it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">与Google Drive API交互</h1><p id="4f91" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">为了在不使用UI的情况下从Google电子表格中提取数据，您需要通过Python调用Google Drive API。</p><p id="04a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有许多方法可以实现这一点，但下面描述的步骤很可能需要较少的时间和代码:</p><ol class=""><li id="82ff" class="ob oc it lb b lc ld lf lg li od lm oe lq of lu og oh oi oj bi translated">导航到<a class="ae ky" href="https://console.developers.google.com/" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu">Google API控制台</strong> </a>并创建一个新项目。从现在开始，您将启用的所有API都将是这个项目的一部分。如果需要，您当然可以创建多个项目或编辑当前的项目。</li><li id="148a" class="ob oc it lb b lc ok lf ol li om lm on lq oo lu og oh oi oj bi translated">现在，在顶部栏中，选择“<strong class="lb iu">启用API和服务</strong>”，然后搜索Google Drive API和Google Sheets API。这两者都需要启用。</li><li id="5ecc" class="ob oc it lb b lc ok lf ol li om lm on lq oo lu og oh oi oj bi translated">如果您最后启用了Google Drive API，请停留在其专用部分并选择“<strong class="lb iu">创建凭证</strong>”。或者，您可以在主项目仪表板的底部找到已启用API的列表。</li><li id="6c82" class="ob oc it lb b lc ok lf ol li om lm on lq oo lu og oh oi oj bi translated">在“<strong class="lb iu">将凭证添加到您的项目</strong>”屏幕中，只需选择与截图中完全相同的选项。例如，小心选择“其他非UI ”,因为您将通过Python与API进行交互。</li><li id="3982" class="ob oc it lb b lc ok lf ol li om lm on lq oo lu og oh oi oj bi translated">在最后一步中，创建一个<strong class="lb iu">服务帐户</strong>，使与API的交互成为可能，并选择“<strong class="lb iu">所有者</strong>作为角色。然后，您将被允许下载JSON格式的服务帐户凭证。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/0dd8122c4b8397207a8d2d9b5f60e13e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xGZdgL4qW-cw5btYVq67cw.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/4c3edc924be0a81a4224db466e324ed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2IWRUXnpDcEoN_u82Tl4NQ.png"/></div></div></figure><p id="1762" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">6.打开你下载的文件，复制<strong class="lb iu">客户端邮箱</strong>地址。然后导航到您希望使用Python阅读的电子表格，单击<em class="lv">文件&gt;共享</em>并粘贴电子邮件以授予服务用户访问权限。</p><p id="37c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">7.<strong class="lb iu"><em class="lv">*可选</em> </strong> <em class="lv"> : </em>将带有凭证的文件移动到将托管您的Python笔记本/脚本的同一文件夹中。这一步不是必需的，但会使您在检索凭证时更加轻松。</p><p id="f369" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样的无聊步骤！还有一个好消息是<em class="lv">你只需要经历这些步骤一次，然后你就可以继续使用同一个客户端电子邮件来访问你想要的电子表格</em> <strong class="lb iu">。</strong>现在让我们写一些代码。</p><h1 id="3cfa" class="ne nf it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated"><strong class="ak">从G-Sheets中读取数据</strong></h1><p id="ebbe" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">您需要下载和导入的包如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="f771" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以简单地使用下面的<em class="lv">用户定义函数</em>从电子表格中检索数据:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="db92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个函数的作用是:</p><ol class=""><li id="bdd0" class="ob oc it lb b lc ld lf lg li od lm oe lq of lu og oh oi oj bi translated">在前两行中，它定义了调用的范围，在本例中是与Google Drive交互，并指定了之前下载的凭证文件的路径。在这种情况下，假设文件被移动到与Python笔记本相同的文件夹中。</li><li id="6096" class="ob oc it lb b lc ok lf ol li om lm on lq oo lu og oh oi oj bi translated">在接下来的两行中，它从指定的路径中检索凭证，并使用它们授权通过Python访问Google电子表格。</li><li id="dfe6" class="ob oc it lb b lc ok lf ol li om lm on lq oo lu og oh oi oj bi translated">在最后两行中，授权的客户机用于打开电子表格，选择一个特定的表，并将所有记录作为字典提取出来。最终，字典被转换成数据帧。</li></ol><p id="ce89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该函数有两个参数(<code class="fe lw lx ly lz b">spreadsheet_name</code>和<code class="fe lw lx ly lz b">sheet_num</code>)。下面是在一个名为<code class="fe lw lx ly lz b">Retail_Transactions</code>的电子表格上进行的测试，该表格只包含一张工作表:</p><pre class="kj kk kl km gt ot lz ou ov aw ow bi"><span id="b4ed" class="ox nf it lz b gy oy oz l pa pb">gsheet2df(‘<!-- -->Retail_Transactions<!-- -->’, 0)</span></pre><p id="f877" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请记住，在Python中，索引是从零开始的，因此要选择电子表格中的第一张工作表，您需要设置<code class="fe lw lx ly lz b">sheet_num = 0</code>。通过运行该函数，将获得以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/0a8a93c0087b0d93906a2223e055bbf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vO4wEVdHNXyPLi-D5esf2w.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用gsheet2df函数创建的df的头</figcaption></figure><p id="9d9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，在将这个df写到它的目标表之前，您可以在这个df上应用您希望的所有转换。</p><p id="4176" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://towardsdatascience.com/write-datasets-from-g-sheet-to-your-database-with-python-bd2c2643f958" rel="noopener" target="_blank">https://towards data science . com/write-datasets-from-g-sheet-to-your-database-with-python-bd2c 2643 f 958</a></p><h1 id="3de2" class="ne nf it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">将数据写入数据库表</h1><p id="fc73" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">让我们假设在应用了一些操作之后，您最终能够将这些数据写入数据仓库表中，以将其用作您的报告解决方案的一部分。本教程展示了如何使用<code class="fe lw lx ly lz b">SQLAlchemy</code>包连接到红移数据库，但是同样的代码也适用于其他数据库(<em class="lv">你只需要稍微修改一下连接字符串</em>)。</p><p id="cb05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">特别是，您应该使用下面的代码片段创建一个连接字符串，并建立到Redshift的连接:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="2e3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦连接就绪，您就可以使用pandas <code class="fe lw lx ly lz b">.to_sql</code>方法在首选模式中创建一个表:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="3af5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还要记住将对表的访问权授予您的DB用户，以便您能够使用SQL查询数据。</p><p id="344e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">整个脚本现在可以通过Airflow进行调度，或者通过一个替代的调度工具定期运行，以完全自动化该过程！</p><h1 id="c30a" class="ne nf it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">结论</h1><p id="b645" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">在本教程中，您已经学习了如何自动化从pandas数据框架中的Google电子表格中提取数据，并最终将数据写入您首选的数据仓库中的表中的过程。所涉及的代码量非常有限，这使得这些步骤适用于不同的用例。</p><blockquote class="ma"><p id="6198" class="mb mc it bd md me mf mg mh mi mj lu dk translated">你知道一种更快捷的方法来连接到谷歌电子表格并从中获取数据吗？如果有，请在评论中分享！</p></blockquote></div></div>    
</body>
</html>