<html>
<head>
<title>Supercharging Python’s Scalability</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">增强Python的可伸缩性</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/supercharging-pythons-scalability-1eec2f501dd5?source=collection_archive---------6-----------------------#2020-04-17">https://levelup.gitconnected.com/supercharging-pythons-scalability-1eec2f501dd5?source=collection_archive---------6-----------------------#2020-04-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d759" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我们如何把一个简单的Flask应用程序变成一个怪物</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5bc24d010cf0888bb7591888d0388cee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PXcBlM20gpVUFvnc.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">途经technotification.com<a class="ae ky" href="https://www.technotification.com/2018/05/top-5-python-programming-ide.html" rel="noopener ugc nofollow" target="_blank">的</a><a class="ae ky" href="https://www.technotification.com/author/sagar" rel="noopener ugc nofollow" target="_blank">萨加尔</a></figcaption></figure><p id="8217" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数据科学中的大多数前沿工作都是由Python开创的。对于软件行业来说尤其如此，Python是机器学习部署的首选。</p><p id="c733" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，这提出了一个明显的悖论:<strong class="lb iu">调和了Python独特的能力和其根本缺乏可伸缩性。</strong></p><p id="2e3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任何试图将Jupyter笔记本转化为高吞吐量、高可伸缩性的微服务的人都会理解——这当然不容易。在这篇文章中，我将分享我是如何让一个ML服务为每秒<strong class="lb iu"> 10个请求</strong>服务到每秒<strong class="lb iu"> 200个请求</strong>服务的，并且还有增长的空间。</p><h2 id="338b" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">高级方法</h2><p id="1fb8" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">当考虑可伸缩性时，我们需要考虑可以扩展的维度。我们可以探索哪些轴？</p><p id="2907" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天，我们将关注两个问题:</p><ol class=""><li id="bc01" class="mu mv it lb b lc ld lf lg li mw lm mx lq my lu mz na nb nc bi translated">多个进程(大小)</li><li id="7f1a" class="mu mv it lb b lc nd lf ne li nf lm ng lq nh lu mz na nb nc bi translated">同步与异步处理(速度)</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/c51c9c55622bc3ef3a6c11fffcaad6a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*rrukd8PTTHhz6QqTelBawA.png"/></div></figure><p id="072e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您将<em class="mt">区域</em>视为您的服务可以服务的请求数量，我们的目标是使我们的最终产品看起来像右图。</p><p id="5b12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，我们该怎么做呢？</p><h2 id="3e3d" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">最低限度</h2><blockquote class="nj nk nl"><p id="deb1" class="kz la mt lb b lc ld ju le lf lg jx lh nm lj lk ll nn ln lo lp no lr ls lt lu im bi translated">让我们快速后退一步。我们需要了解蓝色方块是什么样子的。</p></blockquote><p id="97e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">研究？<em class="mt">搞定。</em></p><p id="e3ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实验？<em class="mt">搞定。</em></p><p id="e7ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">微服务时间到了。将一个模型从实验室带入生产需要一个web框架。我选择的框架是Flask，如果你不熟悉的话，<a class="ae ky" href="https://flask.palletsprojects.com/en/1.1.x/foreword/#what-does-micro-mean" rel="noopener ugc nofollow" target="_blank">你应该是</a>。我把笔记本上的代码翻译成了回购协议，并在整个程序上安装了一个Flask应用程序。通过添加一些POST端点，我已经成功地将我的数据科学转化为“生产就绪”代码。</p><p id="6e12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们大多数人都到了这一步。假设一切正常，从技术上来说，你的代码已经<em class="mt">准备好部署了</em>。</p><p id="3e41" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，运行一个单一的进程，同步烧瓶应用程序不会做得很好。我们的肯定没有。它倒下了，每秒超过10-12个请求后出现巨大的延迟峰值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/31564e05231843a96ab67933eaf89ff0.png" data-original-src="https://miro.medium.com/v2/resize:fit:426/format:webp/1*eZdZaj71jiwV_vZEmphvcA.png"/></div></figure><p id="a181" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是最低值的样子，离它的最大潜力还很远。</p><h2 id="b1f6" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">升级1:流程</h2><p id="53e1" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">再来看我们的第一轴:<em class="mt">单处理vs多处理。</em></p><p id="f636" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了澄清任何混淆，这里不涉及多处理库。相反，我们将讨论<a class="ae ky" href="https://gunicorn.org/" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu"/></a>。</p><p id="f924" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Gunicorn允许我们运行单个应用程序的多个<strong class="lb iu">工作进程</strong>。这真的很简单，我们可以很容易地增加或减少我们的工人数量。例如，下面的代码运行myapp的两个workers。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="2a9a" class="lv lw it nr b gy nv nw l nx ny">gunicorn -w 2 myapp:app</span></pre><p id="a1c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了它，我们能够将请求服务率提高一倍，从10%提高到20%(令人震惊。硬件允许的话，你可以增加工人的数量。对于我们的服务，服务器只能处理2。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/1c86f42dd23ea96f83c26e14aae0c82b.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*52ZT4_oVhZfwjEpBmL9EzA.png"/></div></figure><p id="26aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们做得更好，但现在真正的升级来了。</p><h2 id="49d2" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">升级2:同步到异步</h2><blockquote class="nj nk nl"><p id="e6d9" class="kz la mt lb b lc ld ju le lf lg jx lh nm lj lk ll nn ln lo lp no lr ls lt lu im bi translated">为了充分理解我们试图解决的问题，你应该熟悉为什么存在这种限制。Python建立在全局解释器锁(GIL)的基础上，它本质上是线程运行的互斥锁。为了限制竞争条件和防止奇怪的错误，GIL被创建了，随之而来的是对Python可伸缩性限制的(理所当然的)抗议。</p></blockquote><p id="e73c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你不熟悉这两者的区别，我建议你<a class="ae ky" href="https://stackoverflow.com/questions/748175/asynchronous-vs-synchronous-execution-what-does-it-really-mean" rel="noopener ugc nofollow" target="_blank">读完这篇文章再回来</a>。</p><p id="5f5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的目标是将<strong class="lb iu">升级</strong> <strong class="lb iu"> Gunicorn workers </strong>到<strong class="lb iu">支持异步处理</strong>。那么，我们该怎么做呢？我们用夸脱和超立方。</p><p id="c039" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更具体地说，我们:</p><ol class=""><li id="32a5" class="mu mv it lb b lc ld lf lg li mw lm mx lq my lu mz na nb nc bi translated">用夸脱替换烧瓶</li><li id="1946" class="mu mv it lb b lc nd lf ne li nf lm ng lq nh lu mz na nb nc bi translated">用Hypercorn代替Gunicorn</li></ol><blockquote class="nj nk nl"><p id="9e6e" class="kz la mt lb b lc ld ju le lf lg jx lh nm lj lk ll nn ln lo lp no lr ls lt lu im bi translated">Quart和Hypercorn，像许多其他Python框架一样，是建立在用于异步处理的Python库<a class="ae ky" href="https://docs.python.org/3/library/asyncio.html" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> Asyncio </strong> </a>之上的。</p></blockquote><h2 id="8952" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">烧瓶至夸脱</h2><p id="4b19" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">升级烧瓶到夸脱，这几乎是滑稽的简单。你所要做的就是用<strong class="lb iu">夸脱</strong>替换<strong class="lb iu">烧瓶</strong>，并在适当的地方添加<strong class="lb iu">异步</strong>和<strong class="lb iu">等待</strong>关键字。</p><p id="abe2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，这段代码:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="762b" class="lv lw it nr b gy nv nw l nx ny">from flask import Flask, render_template </span><span id="0d40" class="lv lw it nr b gy oa nw l nx ny">app = Flask(__name__) </span><span id="9a25" class="lv lw it nr b gy oa nw l nx ny">@app.route(‘/’) <br/>def hello(): <br/>    return render_template(‘index.html’, hello=’world’) </span><span id="8b35" class="lv lw it nr b gy oa nw l nx ny">app.run()</span></pre><p id="a033" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">变成了这样:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="8d3f" class="lv lw it nr b gy nv nw l nx ny">from <strong class="nr iu">quart</strong> import <strong class="nr iu">Quart</strong>, render_template </span><span id="1b8d" class="lv lw it nr b gy oa nw l nx ny">app = <strong class="nr iu">Quart</strong>(__name__) </span><span id="72c2" class="lv lw it nr b gy oa nw l nx ny">@app.route(‘/’) <br/><strong class="nr iu">async</strong> def hello(): <br/>    return <strong class="nr iu">await</strong> render_template(‘index.html’, hello=’world’) </span><span id="94a0" class="lv lw it nr b gy oa nw l nx ny">app.run()</span></pre><p id="1d21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简单吧？</p><h2 id="b825" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">Gunicorn到Hypercorn</h2><p id="d9fe" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">现在，Gunicorn工人不支持Asyncio。相反，我们需要将他们升级为超级员工。</p><p id="a7cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，只需安装并运行:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="c2fc" class="lv lw it nr b gy nv nw l nx ny">pip install hypercorn<br/>hypercorn -w 2 myapp:app</span></pre><p id="16ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再简单不过了。</p><p id="fc40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过一系列相对简单的升级，我们能够将一个简单的Flask应用程序从每秒<strong class="lb iu"> 10个请求</strong>提升到每秒<strong class="lb iu"> 200个请求</strong>，只需要两个进程！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/991f3f630aae396180c038df296150d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fWknSYrBdRHalayF.jpg"/></div></div></figure><h2 id="12bc" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">结论</h2><p id="ad27" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">垂直和水平缩放始终是选项—在适当的时候使用它们而不是过早地使用<em class="mt"/>非常重要。在花钱解决这个问题之前，请确保您最大限度地利用了现有的硬件。</p><p id="ab31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，还有很多空间可以继续尝试。例如，你可以用<strong class="lb iu"/><a class="ae ky" href="https://www.uvicorn.org/" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu">Uvicor</strong></a><strong class="lb iu">n workers</strong>来替换<strong class="lb iu"> Hypercorn workers </strong>来进一步提升性能。不要害怕发挥创造力。</p><p id="0b7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/52187b0050c9a24fc262480b4cc1a1d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mc_Gvr8pMJE6QAJj"/></div></div></figure></div></div>    
</body>
</html>