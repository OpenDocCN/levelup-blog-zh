# 如何免费(或极其便宜地)拥有自己的私人包装商

> 原文：<https://levelup.gitconnected.com/how-to-host-your-own-private-packagist-for-free-or-extremely-cheap-faf44eca3647>

## 对于自由职业者或小公司来说，私人 Packagist 账户可能过于昂贵。为什么不举办自己的，免费的？

![](img/14c26a97142b1616e9d8b6cd0a1ee9c1.png)

在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上由[小米勒](https://unsplash.com/@mildlee?utm_source=medium&utm_medium=referral)拍摄的照片

我不认为 Composer 和 Packagist 可以被认为是 PHP 历史上的一个转折点。由于能够更容易地在项目中包含包，社区聚集在一个工具周围，它很快成为 PHP 包管理的事实上的标准。

没过多久，一个私有版本的市场就发展起来了，它允许我们托管自己的包，但不能公开发布。Packagist 对此作出了回应，并创造了一种专用的 Packagist 产品，正是为了做到这一点——以高价安全地访问包裹。

如果你能负担得起，价格是值得的，但我们这些不能或只想为个人项目或自由客户提供一些便利套餐的人怎么办？这就是我们今天要解决的问题。

# 为什么不直接用 Packagist？

在撰写本文时，Packagist 提供了其私有 Packagist 产品的两个版本。面向€以上大型组织的自托管版本每年 1，260 英镑，云托管版本每月最低€49 英镑，超过三个用户的每月每用户额外€14 英镑。

如果你需要 Packagist 提供的所有东西，这个价格可能正是你正在寻找的，如果是这样，你还不如放弃阅读，去注册。此外，如果我没有提到 Packagist 的人非常适合合作，那我就失职了，所以如果你对自己完成所有这些设置不感兴趣，[可以联系他们](mailto:contact@packagist.com)寻求一个未经宣传的单用户计划。

# 该项目

然而，如果你像我一样，有时你想自己动手建造它。我给自己一个挑战，尽可能便宜地创建我的包存储库。在我的情况下，它不是免费的，但我会涵盖那些可选的费用，当我们到达他们。

这个项目创建起来几乎不需要时间，只要你不经常使用，它可以免费托管在 Heroku 上。带宽成本是这类项目的杀手。

# 介绍 Satis

Satis 是一个开源的静态 Composer 库生成器。这是一种冗长的说法，Satis 是一个程序，我们用它来生成所有必要的文件，使 Composer 将我们的网站识别为一个存储库。我们能手工完成所有这些吗？

大概吧。

我们会想要吗？

当然不是。我不知道你怎么想，但我完全是在自动化处理日常事务。这不就是我们建造这个的原因吗？

# 配置 Satis

如果你像我最初一样，坚持阅读文档，设置 Satis 可能会令人困惑。幸运的是，你有我。

首先，我们将从创建 Satis 项目开始。为了使我们的部署过程简单，我们希望 Satis 成为我们的存储库的根——稍后将详细介绍。Composer 为我们提供了一个简单明了的命令:

```
composer create-project composer/satis --stability=dev heroku-packagist
```

至少在撰写本文时，稳定性标志对于所有要安装的依赖项都是必不可少的。这将在您的当前目录中创建一个`heroku-packagist`目录，其中将包含没有 git 存储库的项目。

在我们开始修改项目之前，让我们创建:

```
cd heroku-packagist
git init .
git add .
git commit -am"Unconfigured Satis project"
```

现在，您应该有一个包含初始项目的主分支。我们开始配置吧，好吗？

*喜欢这篇文章吗？* [*成为会员*](https://travisweston.com/membership) *和* [*订阅*](https://travisweston.com/subscribe) *获取更多类似这样的精彩内容！*

## Satis 配置

Satis 使用单个文件来配置静态站点的构建。因为这一个文件控制一切，它可以像你需要的那样复杂或简单。对于这个项目，我们将遵循 KISS 方法并保持简单，好吗？

让我们一次解决一个问题:

## 名字

**Name** 是您的 Satis 项目的名称。即使搜索 Satis 文档也会使您相信这可以是一个任意的字符串，但实际上，这个名称必须遵循与 Composer 包相同的命名约定。在这里，我使用我的 Github 用户名作为团队名称，将我们的测试包命名为`heroku-packagist`。

## 主页

**主页**是我们将托管这些包的 URL。我们还没有，但它将是我们下一步构建的 Heroku 应用程序的完整 URL。

## 仓库

**储存库**是一个储存库数组，我们希望将其下载并存储在我们的打包程序中。Satis 将下载这些包，并为项目中需要这些包的人创建档案。

这个数组的每个元素都是一个对象，至少包含字段**类型**和 **url** 。这些字段通常会被设置为“vcs”和我们的 Github 库的 URL。这个 URL 可以是 git url 或 HTTPS url。

或者，我们也可以在这里包含一个名称字段，其中包含包的名称。

## 全部需要

require-all 字段告诉 Satis 下载软件包的所有可用版本，并为我们存储它们。如果您控制您将使用的所有项目，您可以删除它，并用格式与 Composer require 字段相同的 Require 字段替换它。

## 档案馆

archive 字段接受一个带有许多可选字段的对象，但是告诉 Satis 在哪里创建包档案。在这个例子中，我们只使用**目录的**键来告诉 Satis 将档案存储在`dist`目录中。稍后会详细介绍。

现在我们已经创建了配置文件，我们可以保存它，提交到我们的存储库，然后继续到 Heroku 应用程序。

# 创建 Heroku 应用程序

你需要[创建一个免费的 Heroku 账户](https://signup.heroku.com/login)。完成后，登录并创建一个新应用。它会问你名字和国家。我们不需要将此应用程序添加到管道中。

创建您的应用程序后，您将看到的第一个屏幕是**部署**选项卡。在这个屏幕上，我们希望选择 Github 作为我们的部署方法。你被要求连接你的 Github 帐户，你需要这样做。

在搜索表单中输入存储库名称，然后点击 search。如果我们做得对，您的存储库应该出现在表单下方，旁边有一个 **Connect** 按钮。按那个按钮。

连接后，选择**启用自动部署**按钮，我们现在完成了 Heroku 的配置。您需要注意在屏幕顶部的**打开应用**按钮下链接的应用 URL，并使用该 URL 更新您的 Satis.json。之后，我们需要考虑保护我们的包裹。

## 关于私有存储库的一句话

这个项目的目标是创造一个免费或尽可能便宜的私人包装商。在我的项目中，我为我的包使用私有的 Github 库。这是 4 美元/月的费用，我不认为这是这个项目成本的一部分。

然而，如果你还没有订阅 Github，你可以创建一个免费的 Gitlab.com 账户，并在那里托管你的私有库。上面详细描述的部署过程是设计用来使用 Github 完成的，但是您也可以安装 Heroku CLI 客户端并使用它进行部署。我在这里不是这么做的。

# 保护您的包裹

这是这个项目中技术含量最高的部分。为了创建一个真正的私有包存储库，我们需要保护我们的包。我们可以用很多方法做到这一点，但是因为我们的目标不是创建一个销售给其他人的产品，所以我们将使用基本的 Auth 向我们的新静态站点添加一个简单的用户名和密码。

为了用 Heroku 做到这一点，我们将使用 Apache2 的 **htaccess** 和 **htpasswd** 文件。我们还将使用 htaccess 文件在部署后加载正确的目录，因为我们不想加载根 Satis 文件夹。

## htpasswd

对于这个例子，我将装载一个装有 [VVV](https://varyingvagrantvagrants.org/) 的流浪机器。您可以配置 VVV 加载您的 Satis 项目作为一个文件夹或创建您的文件并手动复制到您的项目根。

首先，我们需要确保我们已经安装了`apache2-utils`，因为它不是 VVV 默认的。

```
apt install apache2-utils
```

注意:如果你遇到了一个`dpkg`错误，就像我第一次这样做时遇到的一样，[你将需要纠正第一个](https://askubuntu.com/questions/1109982/e-could-not-get-lock-var-lib-dpkg-lock-frontend-open-11-resource-temporari)。

现在我们已经安装了 Apache 2-utils，我们可以访问`htpasswd`命令了。该命令将获取您选择的用户名，并要求输入密码，然后生成一个新的。htpasswd 文件供我们使用。

```
htpasswd -c .htpasswd heroku-packagist
```

这将在`.htpasswd`文件中创建`heroku-packagist`用户，出于我们的目的，为了简单起见，我使用了密码`private`，但是您应该使用比这更安全的密码。

现在，将该文件复制到您的 Satis 项目的根目录，并提交它。

接下来，我们需要使用它。

## htaccess

让 Heroku 为我们工作的真正关键是我们的 htaccess 文件。我们使用这个文件有两个目的:基本认证和使用`web`目录作为我们的根目录，而不是项目根目录。

看一下要点，第 1–4 行显示了如何启用基本身份验证，而第 6–9 行显示了如何使用重写规则来加载正确的目录。有很多文章讨论如何配置 htaccess 文件，所以我现在就不做讨论了。

现在是时候部署我们的项目了！将新的 htaccess 添加到存储库中，提交并推送！

# 部署项目

如果您还记得，在前面，我们单击了启用自动部署的按钮。在我们的推送之后，如果你查看 Heroku 的**概览**标签，你应该会看到一个**最新活动**提要。如果我们已经正确地完成了我们的工作，我们应该会看到一个全新的行来表达类似于`your@email.com: Deploy 123abc45`的意思。

如果是这样的话，我们现在需要做的就是点击打开应用程序按钮。在新选项卡中，我们应该看到一个基本的身份验证登录弹出窗口。输入你选择的用户名和密码，瞧，你应该看到你的私人包装！

如果出于某种原因，您看到一行写着 **Build failed** ，那么您的 satis.json 可能有问题。您可以在本地测试这个问题，方法是在您的机器上进行更改并运行 Build 命令，直到它在那里正常工作。一旦这样做了，您就可以再次将所有内容推送到您的存储库中。

# 测试我们新的包存储库

看来我们已经完成了任务。我们有 Heroku 免费招待我们的私人包装商！但是，如果它不安装包，它能工作吗？

让我们来测试一下！

首先，打开一个新文件夹，并初始化 Composer:

```
composer init
```

由于这只是一个测试，我们可以接受所有问题的默认设置，除非我们需要交互依赖。我们将手动操作。

我们需要手动将我们的存储库添加到配置中的**存储库**键下。类型应该是 **Composer，**并且 url 应该是我们 Heroku 应用程序的 URL。因为我们在 Heroku 上托管，所以我们有一个 SSL 密钥，这应该是我们需要的所有定制。

正如我在例子中提到的，如果我们的包是开发包，我们将需要添加最小稳定性和首选稳定性键。但是，如果您的包不是开发包，您可以省略它们。

现在运行 composer install，应该会要求您输入用户名和密码。将用户名和密码存储在配置文件中通常不是一个好主意，但是因为我们使用的是基本的 Auth，所以您也可以将它们作为一对`username:password`添加到 URL 中。

# 结论

这就是创建一个简单的私有包存储库所需要的一切，它托管在 Heroku 上，在世界的任何地方都可以使用。这对于想要在具有构建管道的客户端项目上使用私有包的小团队或自由职业者来说非常好。

最终，一个更强大的系统可能对更大的团队或机构更好。Spatie 发布了一个详细的指南，使用 Laravel 和许可证密钥来保护这种类型的系统。这是一个很好的系统，如果你提供收费的软件包的话。如果没有，您可能会喜欢本文中基于 Heroku 的免费系统。

你喜欢这篇文章吗？ [*成为会员*](https://travisweston.com/membership) *准备好特拉维斯·韦斯顿写的所有东西——以及媒体上所有其他可用的东西。*

*已经是会员了？* [*订阅得到通知*](https://travisweston.com/subscribe) *特拉维斯·韦斯顿写的每一篇文章。*