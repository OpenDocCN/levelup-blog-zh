<html>
<head>
<title>Job Processing and Event Queue with AWS Lambda and Serverless Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda和无服务器Redis的作业处理和事件队列</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/job-processing-and-event-queue-with-aws-lambda-and-serverless-redis-d84a05dff0de?source=collection_archive---------22-----------------------#2021-06-22">https://levelup.gitconnected.com/job-processing-and-event-queue-with-aws-lambda-and-serverless-redis-d84a05dff0de?source=collection_archive---------22-----------------------#2021-06-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d35cef7c666cde10075f5177e8b7207d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uUogIyQL0_Q__PfIdUrFZw.png"/></div></div></figure><h1 id="cd73" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">动机</h1><p id="1731" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">无服务器功能凭借其动态伸缩和灵活的定价模式非常适合许多任务。但是当你有一个由长时间运行的复杂步骤组成的任务时，在一个单一的无服务器功能中运行它是不可行的。一个简单的解决方案就是从无服务器功能中卸载复杂的任务。您可以在自己喜欢的环境中异步处理这些功能，这也可以是其他无服务器功能、无服务器容器或传统的基于服务器的流程。为了减轻您的任务，您需要一个可靠的事件队列。在本文中，我们将使用Upstash Redis来实现这一目的。</p><h1 id="d506" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">方案</h1><p id="2ad3" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">你正在为你的公司开发一个<code class="fe lu lv lw lx b">New Employee Registration</code>表格。将员工记录保存到数据库中是比较容易的部分。以下是可以做的事情:</p><ul class=""><li id="d7c2" class="ly lz iq ky b kz ma ld mb lh mc ll md lp me lt mf mg mh mi bi translated">创建帐户(电子邮件、slack等)。</li><li id="a1f7" class="ly lz iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">向员工发送电子邮件。</li><li id="0994" class="ly lz iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">给招聘经理和其他人发邮件。</li><li id="c2e2" class="ly lz iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">为IT部门创建一张JIRA票证，以便他们安装员工的计算机。</li></ul><p id="63a7" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">对于更大的公司，这个列表可能会更长。</p><ul class=""><li id="d058" class="ly lz iq ky b kz ma ld mb lh mc ll md lp me lt mf mg mh mi bi translated">您希望表单具有响应性。您确实希望新员工在单击提交后等待几分钟。</li><li id="f438" class="ly lz iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">以上步骤可能会有变化。每当添加新过程时，您都不希望更新您的代码。</li></ul><p id="7e18" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">解耦侧过程将解决上述问题。当新员工注册时，您可以将新事件推送到相关的任务队列中；那么另一个进程将消耗该任务。</p><p id="b172" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">让我们构建示例应用程序:</p><h1 id="a7b2" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">项目设置</h1><p id="5444" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">该项目将包括两个模块:</p><ul class=""><li id="e815" class="ly lz iq ky b kz ma ld mb lh mc ll md lp me lt mf mg mh mi bi translated">生产者将是一个无服务器的功能，将接收注册新员工所需的输入参数。它还会为任务队列生成事件。</li><li id="07ae" class="ly lz iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">消费者将是一个工作者应用程序，它将不断地消耗任务队列。</li></ul><p id="82d3" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">(源代码见<a class="ae mr" href="https://github.com/upstash/examples/tree/master/task-queue" rel="noopener ugc nofollow" target="_blank"/>)</p><h1 id="33b2" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">技术堆栈</h1><ul class=""><li id="0537" class="ly lz iq ky b kz la ld le lh ms ll mt lp mu lt mf mg mh mi bi translated">用于无服务器计算的AWS Lambda</li><li id="8e7f" class="ly lz iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">作为无服务器分销商，抢了的风头</li><li id="52db" class="ly lz iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated"><a class="ae mr" href="https://github.com/OptimalBits/bull" rel="noopener ugc nofollow" target="_blank">公牛</a>为任务队列实现</li><li id="9c67" class="ly lz iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">用于项目部署的无服务器框架</li></ul><h1 id="af51" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">上传数据库</h1><p id="2a98" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">您可以从<a class="ae mr" href="https://docs.upstash.com/" rel="noopener ugc nofollow" target="_blank"> Upstash </a>创建一个免费的Redis数据库。Upstash的好处是它的每请求定价，价格上限为120美元。所以你将支付你所使用的，但不高于120美元。</p><p id="6331" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">创建数据库后，复制端点、端口和密码，在接下来的步骤中会用到。</p><h1 id="3212" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">生产者代码</h1><p id="15b3" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们的生产者将是无服务器函数，它将获得请求参数并为队列产生任务。在现实世界中，这段代码应该做保存到数据库这样的事情，但是为了简单起见，我不会实现它。</p><p id="51fe" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">1-通过<code class="fe lu lv lw lx b">serverless</code>命令创建一个无服务器项目。</p><pre class="mv mw mx my gt mz lx na nb aw nc bi"><span id="918f" class="nd jz iq lx b gy ne nf l ng nh">➜  serverless</span><span id="a742" class="nd jz iq lx b gy ni nf l ng nh">Serverless: No project detected. Do you want to create a new one? Yes</span><span id="bc48" class="nd jz iq lx b gy ni nf l ng nh">Serverless: What do you want to make? AWS Node.js</span><span id="96bf" class="nd jz iq lx b gy ni nf l ng nh">Serverless: What do you want to call this project? producer</span><span id="d25c" class="nd jz iq lx b gy ni nf l ng nh">Project successfully created in 'producer' folder.</span><span id="b278" class="nd jz iq lx b gy ni nf l ng nh">You can monitor, troubleshoot, and test your new service with a free Serverless account.</span><span id="9642" class="nd jz iq lx b gy ni nf l ng nh">Serverless: Would you like to enable this? No</span><span id="c7e2" class="nd jz iq lx b gy ni nf l ng nh">You can run the “serverless” command again if you change your mind later.</span></pre><p id="6a7f" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">2-安装<a class="ae mr" href="https://github.com/OptimalBits/bull" rel="noopener ugc nofollow" target="_blank">公牛</a>:</p><p id="806a" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><code class="fe lu lv lw lx b">npm install bull</code></p><p id="4c55" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">三功能代码:</p><pre class="mv mw mx my gt mz lx na nb aw nc bi"><span id="daa9" class="nd jz iq lx b gy ne nf l ng nh">var Queue = require('bull');</span><span id="d538" class="nd jz iq lx b gy ni nf l ng nh">var settings = {<br/>stalledInterval: 300000, // How often check for stalled jobs (use 0 for never checking).<br/>guardInterval: 5000, // Poll interval for delayed jobs and added jobs.<br/>drainDelay: 300 // A timeout for when the queue is in drained state (empty waiting for jobs).<br/>}</span><span id="9f68" class="nd jz iq lx b gy ni nf l ng nh">module.exports.hello = async (event) =&gt; {<br/>var taskQueue = new Queue('employee registration',<br/>{redis: {port: 32016, host: 'us1-upward-ant-32016.upstash.io', password: 'ake4ff120d6b4216df220736be7eab087', tls: {}}}<br/>, settings);<br/>await taskQueue.add({event: event})</span><span id="bb92" class="nd jz iq lx b gy ni nf l ng nh">// TODO save the employee record to a database<br/>return { message: 'New employee event enqueued! 34', event };<br/>};</span></pre><p id="65ea" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">注1:不要忘记替换您自己的Redis端点、端口和密码。如果禁用了TLS，请移除TLS部分。</p><p id="2664" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">注2:我们为事件队列(Bull)提供了额外的参数(设置),因此它将不会利用Upstash配额。根据您对事件延迟的容忍度来更新间隔参数。</p><h1 id="ae2b" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">消费者代码</h1><pre class="mv mw mx my gt mz lx na nb aw nc bi"><span id="338b" class="nd jz iq lx b gy ne nf l ng nh">var Queue = require('bull');</span><span id="b4ba" class="nd jz iq lx b gy ni nf l ng nh">var settings = {<br/>stalledInterval: 300000, // How often check for stalled jobs (use 0 for never checking).<br/>guardInterval: 5000, // Poll interval for delayed jobs and added jobs.<br/>drainDelay: 300 // A timeout for when the queue is in drained state (empty waiting for jobs).<br/>}</span><span id="03b1" class="nd jz iq lx b gy ni nf l ng nh">var taskQueue = new Queue('employee registration',<br/>{redis: {port: 32016, host: 'us1-upward-ant-32016.upstash.io', password: 'ake4ff120d6b4216df220736be7eab087', tls: {}}}<br/>, settings);</span><span id="b082" class="nd jz iq lx b gy ni nf l ng nh">taskQueue.process(function (job, done) {<br/>console.log(job.data)<br/>// TODO process the new employee event<br/>done();<br/>}).catch(err =&gt; {<br/>console.log(err)<br/>});</span></pre><p id="2089" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">我们将编写一个基本的节点应用程序来使用这些事件。创建一个新目录，运行<code class="fe lu lv lw lx b">npm init</code>和<code class="fe lu lv lw lx b">npm install bull</code>。然后创建index.js，如下所示:</p><p id="c426" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">注1:不要忘记替换您自己的Redis端点、端口和密码。如果禁用了TLS，请移除TLS部分。</p><p id="61cf" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">注2:我们为事件队列(Bull)提供了额外的参数(设置),因此它将不会利用Upstash配额。根据您对事件延迟的容忍度来更新间隔参数。</p><h1 id="cd78" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">测试应用程序</h1><p id="c15f" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">首先使用以下命令运行消费者应用程序</p><p id="4040" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><code class="fe lu lv lw lx b">node index</code></p><p id="50ee" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">要测试生成器代码，请运行:</p><pre class="mv mw mx my gt mz lx na nb aw nc bi"><span id="698a" class="nd jz iq lx b gy ne nf l ng nh">serverless invoke local -f hello -d "{name:'Bill Gates', email:'<a class="ae mr" href="mailto:bill@upstash.com" rel="noopener ugc nofollow" target="_blank">bill@upstash.com</a>', position:'Developer', date:'20210620'}"</span></pre><p id="2a03" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">您将看到生成器将记录如下:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/072d5cc265f07371868311a552dddbe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Owe5RHwSyoyBJEoy.png"/></div></div></figure><p id="1db6" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">消费者将登录如下:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/e3b996d23621a86843f4d0a60ce7c4f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IGWElW0CNk9bajbM.png"/></div></div></figure></div><div class="ab cl nl nm hu nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ij ik il im in"><p id="7cf6" class="pw-post-body-paragraph kw kx iq ky b kz ma lb lc ld mb lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><em class="ns">最初发表于</em><a class="ae mr" href="https://docs.upstash.com/tutorials/job_processing" rel="noopener ugc nofollow" target="_blank"><em class="ns">https://docs.upstash.com</em></a><em class="ns">。</em></p></div></div>    
</body>
</html>