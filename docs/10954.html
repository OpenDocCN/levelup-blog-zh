<html>
<head>
<title>Using Golang to Listen to and Parsing GitHub Webhooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Golang监听和解析GitHub Webhooks</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-golang-to-listen-to-and-parsing-github-webhooks-1e072686b55f?source=collection_archive---------5-----------------------#2022-01-31">https://levelup.gitconnected.com/using-golang-to-listen-to-and-parsing-github-webhooks-1e072686b55f?source=collection_archive---------5-----------------------#2022-01-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="baeb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">设置本地Golang web服务器和响应GitHub webhooks的分步指南。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/98aac8af881115bee13e22d3a8f3159e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sAgXCYqVNv_XAuPp"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Andrey Metelev 在<a class="ae le" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h2 id="775a" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">要求</h2><ul class=""><li id="ff5f" class="ly lz it js b jt ma jx mb kb mc kf md kj me kn mf mg mh mi bi translated"><a class="ae le" href="https://go.dev/dl/" rel="noopener ugc nofollow" target="_blank"> Go安装完毕</a></li><li id="1e04" class="ly lz it js b jt mj jx mk kb ml kf mm kj mn kn mf mg mh mi bi translated"><a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/exposing-your-local-web-server-to-the-public-internet-using-ngrok-85f32652a87b"> ngrok已安装</a>(或类似的东西)</li><li id="4411" class="ly lz it js b jt mj jx mk kb ml kf mm kj mn kn mf mg mh mi bi translated">GitHub帐户和演示库(可以是私有的或公共的)</li></ul><h2 id="7c80" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">你将学到什么</h2><ul class=""><li id="de7f" class="ly lz it js b jt ma jx mb kb mc kf md kj me kn mf mg mh mi bi translated">在存储库中创建GitHub webhooks</li><li id="1a9e" class="ly lz it js b jt mj jx mk kb ml kf mm kj mn kn mf mg mh mi bi translated">创建一个小型本地Go web服务器，监听GitHub事件并解析它们</li><li id="55cb" class="ly lz it js b jt mj jx mk kb ml kf mm kj mn kn mf mg mh mi bi translated">使您的本地web服务器对公共internet可用</li><li id="c8a3" class="ly lz it js b jt mj jx mk kb ml kf mm kj mn kn mf mg mh mi bi translated">将webhooks从GitHub发送到您的本地web服务器</li></ul><p id="5092" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">像往常一样，我准备了一个<a class="ae le" href="https://github.com/Abszissex/medium-golang-github-webhooks" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>供您查看完成的代码库，并遵循本文中描述的步骤。</p><div class="mo mp gp gr mq mr"><a href="https://github.com/Abszissex/medium-golang-github-webhooks" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">GitHub-abszisex/medium-golang-GitHub-web hooks</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div><div class="na l"><div class="nb l nc nd ne na nf ky mr"/></div></div></a></div><h2 id="5b31" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">设置</h2><p id="7d0a" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb ng kd ke kf nh kh ki kj ni kl km kn im bi translated">源代码方面，我们的设置只包含三个文件。</p><pre class="kp kq kr ks gt nj nk nl nm aw nn bi"><span id="ac21" class="lf lg it nk b gy no np l nq nr">|- go.mod<br/>|- go.sum<br/>|- main.go</span></pre><ul class=""><li id="46d6" class="ly lz it js b jt ju jx jy kb ns kf nt kj nu kn mf mg mh mi bi translated">包含我们想要包含的必要Go模块的版本和名称</li><li id="8b09" class="ly lz it js b jt mj jx mk kb ml kf mm kj mn kn mf mg mh mi bi translated"><code class="fe nv nw nx nk b">go.sum</code>，这将在安装我们的Go模块并确保安装了正确的版本时自动生成。</li><li id="ef7e" class="ly lz it js b jt mj jx mk kb ml kf mm kj mn kn mf mg mh mi bi translated"><code class="fe nv nw nx nk b">main.go</code>，我们实际的商业逻辑。</li></ul><p id="f53d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">必需模块(go.mod) </strong></p><p id="10a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于我们的演示，我们需要安装以下Go模块。</p><ul class=""><li id="1e95" class="ly lz it js b jt ju jx jy kb ns kf nt kj nu kn mf mg mh mi bi translated"><a class="ae le" href="https://github.com/go-playground/webhooks/" rel="noopener ugc nofollow" target="_blank">github.com/go-playground/webhooks/v6</a>→用于将GitHub webhook事件解析成Go结构的强大助手库</li><li id="88f8" class="ly lz it js b jt mj jx mk kb ml kf mm kj mn kn mf mg mh mi bi translated"><a class="ae le" href="github.com/gofiber/fiber/" rel="noopener ugc nofollow" target="_blank">github.com/gofiber/fiber</a>→网络服务器框架</li><li id="300a" class="ly lz it js b jt mj jx mk kb ml kf mm kj mn kn mf mg mh mi bi translated">github.com/valyala/fasthttp→一个HTTP模块，也包含一个助手类，用于将<code class="fe nv nw nx nk b">fasthttp</code>请求转换为<code class="fe nv nw nx nk b">http</code>请求</li></ul><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="a7b6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">业务逻辑(main.go) </strong></p><p id="8094" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下面的代码片段中，您可以看到<code class="fe nv nw nx nk b">main.go</code>文件的内容，我们将逐步介绍。为了更好地理解代码和解释它做什么，我在代码中添加了大的注释部分，而不是在代码片段之外解释它。出于可读性的原因，所以你可以直接从上到下阅读，我没有使用任何我通常推荐用于生产就绪代码的专用函数。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="1494" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了验证应用程序是否按预期启动，让我们通过<code class="fe nv nw nx nk b">go run main.go</code>来启动它。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oa"><img src="../Images/3cb1ad16facad30993ee2b1ec98d5394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7KxYA-hdr0GQxjuBuHE0RQ.png"/></div></div></figure><p id="04a5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是当然，我们运行在<code class="fe nv nw nx nk b">localhost:3000</code>上的本地服务器还不能用于GitHub webhooks，因为它不能从公共互联网上访问。</p><p id="550c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了使服务器对公共互联网可用，这样GitHub webhooks就可以到达，请参考我的另一篇文章<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/exposing-your-local-web-server-to-the-public-internet-using-ngrok-85f32652a87b"> <strong class="js iu">使用ngrok </strong> </a>解释这一点。</p><div class="mo mp gp gr mq mr"><a rel="noopener  ugc nofollow" target="_blank" href="/exposing-your-local-web-server-to-the-public-internet-using-ngrok-85f32652a87b"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">使用ngrok向公共互联网公开您的本地Web服务器</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">关于如何使用ngrok将本地运行的web服务器暴露给公共互联网的简短介绍。</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="na l"><div class="ob l nc nd ne na nf ky mr"/></div></div></a></div><p id="7ae1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您已经在使用ngrok或其他工具来公开您的本地服务器，那么您可以继续。</p><p id="2b79" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您已经使用了ngrok，您可以通过运行<code class="fe nv nw nx nk b">ngrok http localhost:3000</code>使您的服务器公开可用，这样ngrok将为您生成一个随机域，它会将所有对它的请求转发到您的本地服务器。</p><p id="ba91" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您的终端应该如下图所示:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oc"><img src="../Images/9d3da629cff1ef4f3e4b9dc6455e2915.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nUS-1ltaGDX4Dm2cSAKwsA.png"/></div></div></figure><p id="070b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">终端中显示的<a class="ae le" href="https://xxxxxxx.ngrok.io" rel="noopener ugc nofollow" target="_blank">https://xxxxxxx . ngrok . io</a>域是您的特定域，我们将在本教程中将其用作GitHub webhooks目标。</p><p id="4856" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">创建GitHub webhook </strong></p><p id="9f03" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在服务器正在运行，是时候创建和测试webhoook了。</p><p id="f2e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要这样做，进入你的库的<strong class="js iu">设置→ Webhooks </strong>部分，如下图所示，点击“添加webhook”按钮。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi od"><img src="../Images/6eb25d881faac888efdfabc52a4d2636.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EcFUIySPMMFNLyvpPXU1Ww.png"/></div></div></figure><p id="c376" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在“添加webhook”部分，我们使用自动生成的ngrok域的HTTPS版本。获得正确的URL路径非常重要。在上面的例子中，服务正在侦听路由<code class="fe nv nw nx nk b">/webhook</code>上的POST请求，因此有效负载URL应该是<a class="ae le" href="https://xxxxxx.ngrok.io/webhook" rel="noopener ugc nofollow" target="_blank">https://xxxxxx.ngrok.io/webhook</a>。</p><p id="8b2f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下图中，我们还将内容类型设置为<code class="fe nv nw nx nk b">application/json</code>并添加了一个秘密<code class="fe nv nw nx nk b">my_secret</code>。我总是鼓励使用一个秘密，这样不是每个人都能够调用你的服务的webhook端点，但是你有适当的验证。此外，我们不会监听所有事件，但是我强烈建议只选择您真正想要监听的事件，以防止服务器上不必要的负载。因此，让我们选择“让我选择单个事件”，如下所示。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oe"><img src="../Images/8709bbbbe41bbbb5e0b8756ed66d17cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eyus-zTuBzNhvsLDd0uK8w.png"/></div></div></figure><p id="6b0d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本演示中，我们只对“问题评论”事件感兴趣。这样，如果有人对某个问题发表评论，我们的服务器就会得到通知。根据您的用例，您当然可以使用任何其他事件。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi of"><img src="../Images/b83af8323891710b88de10f1e4af693c.png" data-original-src="https://miro.medium.com/v2/resize:fit:726/format:webp/1*T4NWJqXUyBQc0eBbL_C0ng.png"/></div></figure><p id="49a6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建webhook后，GitHub会自动向定义的URL发送一个ping事件。但是GitHub只在创建时这样做一次，而不是在你对webhook做任何改变的时候。</p><p id="8f8e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如你在下图中看到的，服务器收到了一个webhook，但是因为它不是被定义为<code class="fe nv nw nx nk b">hook.parse(...)</code>的事件之一，所以打印了一个错误。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi og"><img src="../Images/81af485310659cdd0e9d612ce78ae320.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*oXe3bFgnPGIl7XWtXTa2tw.png"/></div></div></figure><p id="1c66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，在GitHub资源库的“Webhooks”概述中，您会看到webhook已经成功交付并得到确认。发生这种情况是因为服务器返回了<code class="fe nv nw nx nk b">c.SendStatus(200)</code>，这意味着它将总是确认webhook请求，只要它没有因为一个未观察到的错误而中断。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi od"><img src="../Images/47745cbd3cbd5a5a12c188aab7c5041b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bJ19mLpqHlP3HHGob5G9Nw.png"/></div></div></figure><p id="f777" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">触发GitHub webhook </strong></p><p id="6b51" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在服务器正在运行，并向公共互联网公开，webhook被正确定义为向本地服务器发送请求，是时候触发webhook了。</p><p id="1628" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为此，我们将转到GitHub存储库的“问题”部分并创建一个新问题，如下图所示。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi od"><img src="../Images/e71c54e0b8f606d5d4e6a2837f205a83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z-DNe681xkd81dK_xeJunQ.png"/></div></div></figure><p id="ce33" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">问题的创建还没有触发webhook，因为我们只对评论事件感兴趣。因此，让我们用文本“Trigger webhook”创建一个新的评论，并点击“评论”按钮。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi od"><img src="../Images/248393ce5cca05b5872f96358c11ca3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CzIJwawWFgFoReiIxrLnHA.png"/></div></div></figure><p id="1add" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">提交评论后，您应该会在运行服务器的终端上看到一些控制台输出。</p><p id="ec2c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我的例子中，我以用户“Abszissex”的身份创建了“Trigger webhook”注释，如下图右侧所示。左边可以看到我的终端，服务器在那里运行，把用户和评论内容打印到终端。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oh"><img src="../Images/56d61777418d681339563612ae590f8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xKJSCVA0zUX8G1RdLqxAyQ.png"/></div></div></figure><h2 id="cef6" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">摘要</h2><p id="89e6" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb ng kd ke kf nh kh ki kj ni kl km kn im bi translated">在这篇短文中，您应该已经学会了如何设置一个Go webserver来监听和解析GitHub webhook事件，以及如何在您的GitHub存储库中设置它们。</p><h2 id="4fcc" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">你想联系吗？</h2><p id="6350" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb ng kd ke kf nh kh ki kj ni kl km kn im bi translated">如果你想联系我，请在LinkedIn上打电话给我。</p><p id="c598" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另外，请随意查看我的书籍推荐📚。</p></div><div class="ab cl oi oj hx ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="im in io ip iq"><div class="kp kq kr ks gt mr"><a href="https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b" rel="noopener follow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">我的书籍推荐</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">在接下来的章节中，你可以找到我对所有日常生活话题的书籍推荐，它们对我帮助很大。</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="na l"><div class="op l nc nd ne na nf ky mr"/></div></div></a></div><div class="mo mp gp gr mq mr"><a href="https://mr-pascal.medium.com/membership" rel="noopener follow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">通过我的推荐链接加入Medium—Pascal Zwikirsch</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="na l"><div class="oq l nc nd ne na nf ky mr"/></div></div></a></div></div></div>    
</body>
</html>