<html>
<head>
<title>Scaling an ECS Service Based On AWS SQS Queue Items</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于AWS SQS队列项目扩展ECS服务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/scaling-an-ecs-service-based-on-aws-sqs-queue-items-b2f20ad7c998?source=collection_archive---------1-----------------------#2021-02-01">https://levelup.gitconnected.com/scaling-an-ecs-service-based-on-aws-sqs-queue-items-b2f20ad7c998?source=collection_archive---------1-----------------------#2021-02-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fe3c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">本文将帮助您根据AWS SQS项目中的项目数量来扩展ECS服务。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a0d819d43c85033347c73f073a8c71c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TIpuAQFbcMsODRg8"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@jstrippa?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">詹姆斯·哈里逊</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="5eef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您有一个脚本或服务处理一个必须处理高峰时刻的队列时，扩展ECS服务可能是必要的。您可能希望有更多的进程并行地从队列中挑选项目，这样队列的处理速度会更快。</p><p id="f537" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是我最近不得不做的事情，并不是没有斗争，希望你在读完这篇文章后会少一些麻烦。毕竟这并没有那么难。</p><p id="0652" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将在本文中使用Terraform，但是您当然可以在AWS控制台中手动创建这些资源。如果你还不熟悉它，Terraform是一个基础设施即代码(IaC)软件工具，允许你定义和设置你在云环境中需要的所有资源作为代码，而不必点击特定云提供商的控制台。</p><h2 id="2e5c" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">先决条件</h2><ul class=""><li id="9e5c" class="ml mm iq ky b kz mn lc mo lf mp lj mq ln mr lr ms mt mu mv bi translated">您想要扩展的ECS服务</li><li id="a635" class="ml mm iq ky b kz mw lc mx lf my lj mz ln na lr ms mt mu mv bi translated">SQS队列</li></ul><h1 id="00cb" class="nb lt iq bd lu nc nd ne lx nf ng nh ma jw ni jx md jz nj ka mg kc nk kd mj nl bi translated">我们要做什么</h1><p id="93b0" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">我们将根据队列中的项目数量来扩展我们的服务。</p><ul class=""><li id="46ae" class="ml mm iq ky b kz la lc ld lf np lj nq ln nr lr ms mt mu mv bi translated">如果队列中有0个项目，则任务数必须设置为0。</li><li id="9015" class="ml mm iq ky b kz mw lc mx lf my lj mz ln na lr ms mt mu mv bi translated">如果队列项目数&gt; 0且≤ 500，则任务数必须设置为1。</li><li id="5d59" class="ml mm iq ky b kz mw lc mx lf my lj mz ln na lr ms mt mu mv bi translated">如果队列项目大于500且小于等于1000，则最多可扩展到2个任务。</li><li id="ceb8" class="ml mm iq ky b kz mw lc mx lf my lj mz ln na lr ms mt mu mv bi translated">如果队列项目超过1000个，最多可扩展到3个任务。</li></ul><h1 id="0fe8" class="nb lt iq bd lu nc nd ne lx nf ng nh ma jw ni jx md jz nj ka mg kc nk kd mj nl bi translated">Terraform脚本</h1><p id="99dc" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">从现在开始，我将讨论我们地形脚本的不同部分。您可以在文章末尾找到我完整的Terraform脚本，其中还包括任务定义、ECS服务等资源。</p><h2 id="9625" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">自动缩放目标</h2><p id="4160" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">您必须添加一个指向现有ECS服务的自动扩展目标。如前所述，这个服务也可以使用Terraform来设置，但是也可以使用AWS控制台手动创建。</p><p id="4b87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在自动缩放目标中，您可以提供想要缩放的维的最小和最大容量。在我们的例子中，我们想要扩展<code class="fe ns nt nu nv b">ecs:service:DesiredCount</code>,它指示在我们的服务中应该运行多少任务。如果正在运行的任务数量没有达到预期数量，ECS将启动所需数量的任务。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h2 id="bbb1" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">自动缩放策略</h2><p id="bee9" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">设置自动缩放目标后，我们可以开始定义我们的缩放策略。</p><p id="caeb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">向上扩展的策略<br/> </strong>在向上扩展我们服务的自动扩展策略中，我们定义了当一个特定的指标满足某些条件时，我们希望调整<code class="fe ns nt nu nv b">DesiredCount</code>的<code class="fe ns nt nu nv b">ExactCapacity</code>(我们指的是上面定义的自动扩展目标的可扩展维度)。</p><p id="f837" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当队列中有1到500个项目时，我们希望期望的计数为1；当队列中有500到1000个项目时，期望的计数为2；当队列中有超过1000个项目时，期望的计数为3。<strong class="ky ir">请注意:</strong>下限为‘大于’，上限为‘小于或等于’。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="0de2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">缩减策略<br/> </strong>当队列中没有项目时，我们还希望将所需计数缩减为0，因此我们还添加了一个自动缩减策略。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h2 id="2d0f" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">CloudWatch度量警报</h2><p id="c71a" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">我们现在已经定义了我们的策略，但是还没有这些策略的触发器。我们必须通过CloudWatch指标警报来触发策略。在我们的例子中，这些度量警报不断地查看队列中的项目数量，并在超过我们定义的阈值时发出警报。</p><p id="e3b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以在此指标警报触发时设置一个操作，它会将指标值传递给该操作。我们正在观察的度量是我们的SQS队列的<code class="fe ns nt nu nv b">ApproximateNumberOfMessagesVisible</code>度量。这是AWS在您创建SQS队列时自动提供的度量。</p><p id="471e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">横向扩展<br/> </strong>我们创建了一个横向扩展指标警报，当队列的<code class="fe ns nt nu nv b">ApproximateNumberOfMessagesVisible</code>为1或更大值时，该警报就会发出警报。警报操作是我们的向上扩展策略，它将根据价值决定要做什么。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="d521" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> Scale In <br/> </strong>我们对Scale In做了同样的操作，我们希望当队列中的项目数为0时触发我们的scale down策略。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h1 id="64e1" class="nb lt iq bd lu nc nd ne lx nf ng nh ma jw ni jx md jz nj ka mg kc nk kd mj nl bi translated">差不多就是这样！</h1><p id="e433" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">这就是我根据SQS队列中的项目数量来扩展ECS服务所做的工作。我没有解释每一个设置，你可能需要调整脚本来满足你的需求。你也可以动态地创建<code class="fe ns nt nu nv b">step_scaling_policy_configuration</code>，这样你就不必在自动缩放策略中提供一个完整的步长调整列表。</p><h1 id="33de" class="nb lt iq bd lu nc nd ne lx nf ng nh ma jw ni jx md jz nj ka mg kc nk kd mj nl bi translated">问题、建议或反馈</h1><p id="19e1" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">如果您对本文有任何问题、建议或反馈，请告诉我！</p><h1 id="b81d" class="nb lt iq bd lu nc nd ne lx nf ng nh ma jw ni jx md jz nj ka mg kc nk kd mj nl bi translated">最后的话</h1><p id="87ae" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">我要感谢Redditor <a class="ae kv" href="https://www.reddit.com/user/JohnPreston72/" rel="noopener ugc nofollow" target="_blank"> JohnPreston72 </a>，他非常好心地提供了一些<a class="ae kv" href="https://github.com/EWS-Network/s3tosftp" rel="noopener ugc nofollow" target="_blank">云形成脚本</a>。基于u/JohnPreston72提供的脚本，我能够自己设置缩放并编写自己的Terraform脚本(参见下面的完整脚本)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure></div></div>    
</body>
</html>