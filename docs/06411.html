<html>
<head>
<title>“Deny All” AWS S3 Bucket Policy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">“拒绝所有”AWS S3存储桶策略</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deny-all-aws-s3-bucket-policy-822696ed969f?source=collection_archive---------5-----------------------#2020-11-23">https://levelup.gitconnected.com/deny-all-aws-s3-bucket-policy-822696ed969f?source=collection_archive---------5-----------------------#2020-11-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="46c3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何创建一个AWS S3存储桶策略来拒绝所有访问<strong class="ak">而不被</strong>锁定</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c8a6bf35e238962d52e41b445080d0dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wLYepKiyJvhsPHgrN2htXw.png"/></div></div></figure><h1 id="839c" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">TL；灾难恢复—创建一个不太安全的安全策略</h1><p id="16c6" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">最佳实践是通过使用存储桶策略，明确授予已识别实体在您的亚马逊S3存储桶上执行操作的权限。您可以通过配置您的存储桶策略来拒绝所有实体的所有操作，除非另外列出。但是，在此过程中，您可能会意外地将自己锁定在自己的存储桶之外，这不仅会阻止对策略本身的修改，还会取消您使用AWS CLI或AWS控制台删除存储桶的权限。这可能特别令人恼火，因为S3存储桶名称是全局范围的，所以您将无法创建具有该名称的存储桶，除非它被删除，即使在另一个地区或帐户。</p><p id="6ccf" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">下面的策略包含一个声明，该声明将拒绝所有资源对存储桶<code class="fe mn mo mp mq b">bucket-name</code>的所有操作，但允许您修改存储桶策略、清空存储桶、删除存储桶以及修改各种其他存储桶权限/管理设置的几个操作除外。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="be36" class="mv kv it mq b gy mw mx l my mz">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Sid": "AllowDeletingAllowModifyBucket",<br/>      "Effect": "Deny",<br/>      "Principal": "*",<br/>      "NotAction": [<br/>        "s3:Delete*",<br/>        "s3:GetBucket*",<br/>        "s3:ListBucket*",<br/>        "s3:PutBucket*"<br/>      ],<br/>      "Resource": [<br/>        "arn:aws:s3:::bucket-name",<br/>        "arn:aws:s3:::bucket-name/*"<br/>      ]<br/>    }<br/>  ]<br/>}</span></pre><h1 id="0fe5" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">政策细分</h1><p id="8630" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated"><a class="ae na" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/using-with-s3-actions.html" rel="noopener ugc nofollow" target="_blank"> AWS S3铲斗动作文档</a>概述了每个动作所代表的内容。然而，文档并不是以用例为中心的。您在AWS控制台上考虑的操作(例如删除存储桶)可能需要在存储桶策略中允许多个操作。</p><h2 id="f19c" class="mv kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">不是行动</h2><p id="fed8" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">请注意上面的bucket policy语句中的双重否定——拒绝not操作的效果。换句话说，正如在<a class="ae na" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html" rel="noopener ugc nofollow" target="_blank"> AWS S3文档</a>中所描述的，该策略明确允许某些行为，而拒绝所有其他行为。</p><h2 id="2bed" class="mv kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">修改存储桶策略</h2><p id="5f09" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">要在AWS控制台上修改bucket策略，您需要对bucket策略具有读写权限。这些行动各不相同。简单地授予自己对存储桶策略的写访问权限不会授予对AWS控制台的访问权限来加载策略以进行编辑，因此您的访问将被拒绝。如果您没有授予自己读取权限，可以使用AWS CLI来更新存储桶策略。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="cc0b" class="mv kv it mq b gy mw mx l my mz">"s3:GetBucketPolicy",<br/>"s3:PutBucketPolicy"</span></pre><h2 id="a6b7" class="mv kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated"><strong class="ak">删除桶</strong></h2><p id="49c7" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">最好明确列出您希望在存储桶策略中允许的每个操作，而不是使用通配符。当您设计策略时，下面的操作非常简洁，非常适合实验，因为它允许您删除存储桶中的项目以及存储桶本身。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="ff21" class="mv kv it mq b gy mw mx l my mz">"s3:Delete*"</span></pre><p id="57c6" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">显而易见，您可以使用以下操作在AWS控制台上授予自己删除空的 S3存储桶的能力。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="d3b0" class="mv kv it mq b gy mw mx l my mz">"s3:DeleteBucket",<br/>"s3:ListBucketVersions"</span></pre><p id="67ba" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">如果您的存储桶<strong class="lo iu">不是空的</strong>，您需要在AWS控制台上给自己三个额外的动作来清空存储桶，然后才能删除它。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="7987" class="mv kv it mq b gy mw mx l my mz">"s3:DeleteBucket",<br/>"s3:DeleteObject",<br/>"s3:GetBucketVersioning",<br/>"s3:ListBucket",<br/>"s3:ListBucketVersions"</span></pre><h2 id="c0f4" class="mv kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">查看和修改其他铲斗设置</h2><p id="0075" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">您可能希望access在AWS控制台上修改许多选项，包括版本、标记、存储桶策略、访问控制列表、指标、生命周期规则等。请随意根据您的用例对这些进行微调。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="8ad2" class="mv kv it mq b gy mw mx l my mz">"s3:GetBucket*",<br/>"s3:ListBucket*",<br/>"s3:PutBucket*"</span></pre><h2 id="f7d8" class="mv kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">桶与桶内容</h2><p id="056a" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">从资源的角度理解S3存储桶本身与存储桶的内容是不同的，这一点很重要。例如，存储桶策略或其他存储桶管理选项作用于存储桶本身，而像<code class="fe mn mo mp mq b">s3:DeleteObject</code>这样的操作作用于存储桶中的项目。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="7150" class="mv kv it mq b gy mw mx l my mz">"Resource": [<br/>        "arn:aws:s3:::bucket-name",<br/>        "arn:aws:s3:::bucket-name/*"<br/>      ]</span></pre><h1 id="4194" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">测试一下</h1><p id="ed59" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">有时，不清楚AWS控制台需要什么只读权限才能执行操作。令人欣慰的是，当你试图在控制台上执行一个被拒绝的操作时，会出现一个错误对话框，并指出它缺少权限。创造完美的政策需要反复试验。在<a class="ae na" href="https://aws.amazon.com/free" rel="noopener ugc nofollow" target="_blank"> AWS免费层</a>下，你可以免费创建一个bucket，上传一个文本文件到里面，然后在几分钟内自己测试各种bucket策略。完成测试后，记得删除资源！</p></div><div class="ab cl nm nn hx no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="im in io ip iq"><p id="c144" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><em class="nt">披露声明:2020奎因·维萨克。观点是作者个人的观点。使用或展示的所有商标和其他知识产权是其各自所有者的财产。</em></p></div></div>    
</body>
</html>