<html>
<head>
<title>5 tips for troubleshooting apps on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">排除Kubernetes上应用程序故障的5个技巧</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/5-tips-for-troubleshooting-apps-on-kubernetes-835b6b539c24?source=collection_archive---------4-----------------------#2020-03-13">https://levelup.gitconnected.com/5-tips-for-troubleshooting-apps-on-kubernetes-835b6b539c24?source=collection_archive---------4-----------------------#2020-03-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="e3f4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在经历了从<a class="ae ko" href="https://www.docker.com" rel="noopener ugc nofollow" target="_blank"> Docker </a>到Docker Swarm，再到<a class="ae ko" href="https://kubernetes.io" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>的转变，并处理了这些年来各种API的变化之后，我已经能够很轻松地找出我的部署中的问题并找到解决方法。</p><p id="6b36" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">事情并不总是那样，你必须从某个地方开始，也许那就是你今天所处的位置——开始？无论你在旅途中的哪个地方，我都想给你5个我认为有用的故障排除技巧，以及一些额外的使用技巧。</p><h1 id="74d8" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">介绍你的“瑞士军刀”</h1><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ln"><img src="../Images/8368a8821ca00f9047ff78d44b89cd29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nj27D-WiKDnttiKyiduwyw.jpeg"/></div></div><figcaption class="lz ma gj gh gi mb mc bd b be z dk translated">好的工具显示出使用的迹象。</figcaption></figure><p id="75d7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你的瑞士军刀(如果你来自美国，读“皮革人”)是一种多用途工具，像所有好的工具一样，应该好好使用，有点磨损。</p><p id="eb04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">而且你猜对了，是<code class="fe md me mf mg b">kubectl</code>。让我们从5个“附件”开始，以及当事情出错时你如何使用它们。</p><p id="ad66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">场景将会是:<strong class="js iu">我的YAML被接受，但是我的服务没有启动</strong>和<strong class="js iu">它启动了，但是不能正常工作</strong>。</p><ol class=""><li id="bf0e" class="mh mi it js b jt ju jx jy kb mj kf mk kj ml kn mm mn mo mp bi translated"><code class="fe md me mf mg b">kubectl get deployment/pods</code></li></ol><p id="9904" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是您的第一个访问端口，您可能已经知道了，但是它如此重要的原因是它提供了顶级信息，而无需您进行大量输入。</p><p id="49f0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您正在为您的工作负载使用一个部署(您应该这样)，那么您有几个选择:</p><ul class=""><li id="10d8" class="mh mi it js b jt ju jx jy kb mj kf mk kj ml kn mq mn mo mp bi translated"><code class="fe md me mf mg b">kubectl get deploy</code></li><li id="529a" class="mh mi it js b jt mr jx ms kb mt kf mu kj mv kn mq mn mo mp bi translated"><code class="fe md me mf mg b">kubectl get deploy -n namespace</code></li><li id="8c3a" class="mh mi it js b jt mr jx ms kb mt kf mu kj mv kn mq mn mo mp bi translated"><code class="fe md me mf mg b">kubectl get deploy --all-namespaces [or "-A"]</code>(不客气)</li></ul><p id="5f04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">理想情况下，你希望看到1/1或等价的，2/2等。这将表明您的部署已被接受，并已尝试部署某些东西。</p><p id="b219" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，您可能想要查看<code class="fe md me mf mg b">kubectl get pods</code>以查看部署的后备Pod是否正确启动。</p><p id="7345" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.<code class="fe md me mf mg b">kubectl get events</code></p><p id="0d02" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我很惊讶我不得不经常向那些对Kubernetes有问题的人解释这个小宝贝。这个命令打印出给定名称空间中的事件，对于发现关键问题非常有用，比如崩溃的pod或无法提取的容器图像。</p><p id="0403" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Kubernetes中的日志是*未排序的*因此，您将需要添加以下内容，摘自<a class="ae ko" href="https://docs.openfaas.com/deployment/troubleshooting/" rel="noopener ugc nofollow" target="_blank"> OpenFaaS文档</a>。</p><pre class="lo lp lq lr gt mw mg mx my aw mz bi"><span id="ae3a" class="na kq it mg b gy nb nc l nd ne">$ kubectl get events --sort-by=.metadata.creationTimestamp</span></pre><p id="5c11" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe md me mf mg b">kubectl get events</code>的表亲是kubectl describe，就像<code class="fe md me mf mg b">get deploy/pod</code>一样，它使用对象的名称:</p><pre class="lo lp lq lr gt mw mg mx my aw mz bi"><span id="c9df" class="na kq it mg b gy nb nc l nd ne">kubectl describe deploy/figlet -n openfaas</span></pre><p id="158c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你会在这里得到非常详细的信息。在我们忘记之前，您可以描述大多数事情，包括<code class="fe md me mf mg b">nodes</code>，它将显示您是否由于资源限制或其他问题而无法安排Pod。</p><p id="e5ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.<code class="fe md me mf mg b">kubectl logs</code></p><p id="cbe7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你知道这一天要来了，但还是有很多人用错了方法。</p><p id="9af4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您有一个部署，比如说在<code class="fe md me mf mg b">cert-manager</code>名称空间中的<code class="fe md me mf mg b">cert-manager</code>，那么许多人认为他们首先必须找到Pod的长(唯一)名称，并将其用作他们的参数。不对！</p><pre class="lo lp lq lr gt mw mg mx my aw mz bi"><span id="1b2b" class="na kq it mg b gy nb nc l nd ne">kubectl logs deploy/cert-manager -n cert-manager</span></pre><p id="3eab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要跟踪日志，请添加<code class="fe md me mf mg b">-f</code></p><pre class="lo lp lq lr gt mw mg mx my aw mz bi"><span id="faed" class="na kq it mg b gy nb nc l nd ne">kubectl logs deploy/cert-manager -n cert-manager -f</span></pre><p id="7188" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了避免获取每个可能的日志条目，您还可以使用<code class="fe md me mf mg b">--tail</code>将它限制在最后几行:</p><pre class="lo lp lq lr gt mw mg mx my aw mz bi"><span id="fe6a" class="na kq it mg b gy nb nc l nd ne">kubectl logs deploy/cert-manager -n cert-manager --tail 100</span></pre><p id="a020" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以把这三者结合起来。</p><p id="3c73" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您的部署或Pod有任何标签，您可以使用<code class="fe md me mf mg b">-l app=name</code>或任何其他标签集来附加到一个或多个匹配Pod的日志中。</p><pre class="lo lp lq lr gt mw mg mx my aw mz bi"><span id="9560" class="na kq it mg b gy nb nc l nd ne">kubectl logs -l app=nginx</span></pre><p id="0e66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有一些像<a class="ae ko" href="https://github.com/wercker/stern" rel="noopener ugc nofollow" target="_blank"> stern </a>和<a class="ae ko" href="https://github.com/boz/kail" rel="noopener ugc nofollow" target="_blank"> kail </a>这样的工具可以帮助你匹配模式并节省一点打字时间，但是我发现它们会分散注意力。</p><p id="4b9d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.<code class="fe md me mf mg b">kubectl get -o yaml</code></p><p id="b758" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当你开始使用由另一个项目或者像Helm这样的工具生成的YAML时，你会很快需要它。在生产中检查图像的版本或您在某处设置的注释也很有用。</p><pre class="lo lp lq lr gt mw mg mx my aw mz bi"><span id="b3c2" class="na kq it mg b gy nb nc l nd ne">kubectl run nginx-1 --image=nginx --port=80 --restart=Always</span></pre><p id="62d5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我是用“总是”重启还是“从不”重启来部署的？</p><pre class="lo lp lq lr gt mw mg mx my aw mz bi"><span id="759e" class="na kq it mg b gy nb nc l nd ne">kubectl get deploy/nginx-1 -o yaml</span></pre><p id="8007" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们知道了。更重要的是，我们可以添加<code class="fe md me mf mg b">--export</code>并将YAML保存在本地，以编辑它并再次附加它。</p><p id="e252" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">编辑YAML现场直播的另一个选项是<code class="fe md me mf mg b">kubectl edit</code>，如果你被<code class="fe md me mf mg b">vim</code>卡住了，不知道发生了什么，在命令前面加上<code class="fe md me mf mg b">VISUAL=nano</code>会更容易编辑。</p><p id="17b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.<code class="fe md me mf mg b">kubectl scale</code> —你又开又关了吗？</p><p id="4092" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe md me mf mg b">kubectl scale</code>可用于将部署及其pod缩减至零个副本，实际上是杀死所有副本。当您将比例放大到1/1时，将创建一个新的Pod，重新启动您的应用程序。</p><p id="f26a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">语法非常简单，您可以重新启动代码并再次运行测试。</p><pre class="lo lp lq lr gt mw mg mx my aw mz bi"><span id="9619" class="na kq it mg b gy nb nc l nd ne">kubectl scale deploy/nginx-1 --replicas=0<br/>kubectl scale deploy/nginx-1 --replicas=1</span></pre><p id="0861" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以使用的替代方法是<code class="fe md me mf mg b">kubectl rollout restart deploy/nginx-1.</code></p><p id="1c51" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要知道一个部署是否“准备好”,使用<code class="fe md me mf mg b">kubectl rollout status deploy/nginx-1</code>,它将阻塞，直到通过健康检查。你可能还需要使用一个延长的超时，或者一个无限的超时<code class="fe md me mf mg b">--timeout=0s</code> / <code class="fe md me mf mg b">--timeout=60s</code>。</p><p id="80aa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">6.端口转发</p><p id="d323" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我知道我说过有5条建议，但我们还需要一条。通过kubectl的端口转发允许我们在自己的计算机上公开本地或远程集群上的服务，以便在任何已配置的端口上访问它，而无需在互联网上公开它。</p><p id="3b78" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是一个访问Nginx部署的例子，但是是在本地:</p><pre class="lo lp lq lr gt mw mg mx my aw mz bi"><span id="0cf6" class="na kq it mg b gy nb nc l nd ne">kubectl port-forward deploy/nginx-1 8080:80</span></pre><p id="3214" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有些人认为这只适用于部署或pod，他们错了。服务是公平的游戏，通常是正确的选择，因为它们会模仿生产集群中的配置。</p><p id="a1f7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你想在互联网上公开一个服务，你通常会使用一个负载平衡器服务，或者运行<code class="fe md me mf mg b">kubectl expose:</code></p><pre class="lo lp lq lr gt mw mg mx my aw mz bi"><span id="0135" class="na kq it mg b gy nb nc l nd ne">kubectl expose deployment nginx-1 --port=80 --type=LoadBalancer</span></pre><p id="720c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另一种选择是使用云本地隧道，如<a class="ae ko" href="https://github.com/inlets/inlets-operator" rel="noopener ugc nofollow" target="_blank">入口运营商</a>。</p><h2 id="6dac" class="na kq it bd kr nf ng dn kv nh ni dp kz kb nj nk ld kf nl nm lh kj nn no ll np bi translated">现在尝试一下</h2><p id="3467" class="pw-post-body-paragraph jq jr it js b jt nq jv jw jx nr jz ka kb ns kd ke kf nt kh ki kj nu kl km kn im bi translated">我希望这6个命令和提示对你有用。现在轮到您在真实的集群上测试它们了。</p><p id="f543" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以在笔记本电脑上创建集群，或者使用托管云产品。</p><p id="8d6c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我最喜欢的地方发展选项是:</p><ul class=""><li id="bbd1" class="mh mi it js b jt ju jx jy kb mj kf mk kj ml kn mq mn mo mp bi translated"><a class="ae ko" href="https://medium.com/@alexellisuk/walk-through-install-kubernetes-to-your-raspberry-pi-in-15-minutes-84a8492dc95a" rel="noopener">带k3sup的树莓Pi集群</a></li><li id="d054" class="mh mi it js b jt mr jx ms kb mt kf mu kj mv kn mq mn mo mp bi translated"><a class="ae ko" href="https://github.com/rancher/k3d/releases" rel="noopener ugc nofollow" target="_blank"> k3d (k3s在Docker中运行)</a></li><li id="c266" class="mh mi it js b jt mr jx ms kb mt kf mu kj mv kn mq mn mo mp bi translated"><a class="ae ko" href="https://k3sup.dev/" rel="noopener ugc nofollow" target="_blank"> k3sup —通过SSH将k3s安装到任何虚拟机或机器上</a></li></ul><p id="8ea0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当然还有<a class="ae ko" href="https://blog.alexellis.io/be-kind-to-yourself/" rel="noopener ugc nofollow" target="_blank">KinD——Docker</a>里的Kubernetes。</p><p id="83d7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你喜欢这篇文章吗？你想看更多吗？<a class="ae ko" href="https://github.com/sponsors/alexellis" rel="noopener ugc nofollow" target="_blank">通过GitHub赞助商订阅我的优质简讯</a>或<a class="ae ko" href="https://www.alexellis.io/" rel="noopener ugc nofollow" target="_blank">在Twitter/LinkedIn上关注我</a></p></div></div>    
</body>
</html>