<html>
<head>
<title>Destination Heroku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">目的地Heroku</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/destination-heroku-86a5811a199c?source=collection_archive---------30-----------------------#2020-06-01">https://levelup.gitconnected.com/destination-heroku-86a5811a199c?source=collection_archive---------30-----------------------#2020-06-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="eccd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在“<a class="ae ko" rel="noopener ugc nofollow" target="_blank" href="/moving-away-from-aws-and-onto-heroku-d84852b9884d">从AWS迁移到Heroku </a>”一文中，我介绍了我想从亚马逊流行的AWS解决方案迁移到Heroku的应用程序。虽然AWS确实满足了我的客户(我的岳母)的需求，但我希望有一个解决方案，让我有限的时间能够专注于提供业务解决方案，而不是跟上开发运维流程。</p><h1 id="aecb" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">快速回顾</h1><p id="9b3b" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">作为一个TL；(博士太长；没看)到原文章，我给婆婆开的小企业建了一个Angular客户端和一个Java API。在Elastic Beanstalk和S3上运行应用程序一年后，我想看看是否有更好的解决方案，让我能够更加专注于编写功能和增强功能，而不必担心学习、理解和执行AWS生态系统中固有的类似DevOps的方面。</p><h1 id="32f3" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">创建新帐户</h1><p id="3c0e" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">我需要做的第一件事是在<a class="ae ko" href="https://www.heroku.com/" rel="noopener ugc nofollow" target="_blank"> Heroku </a>创建一个新账户。这个过程非常简单，只需要最少的信息就可以开始:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ls"><img src="../Images/5a7301e405475714ce379c4437a048c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ij51lOHBNSVg1Ka5.png"/></div></div></figure><p id="91fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦我的账户被创建并登录，我就可以使用“<strong class="js iu">创建新应用</strong>”按钮正式进入隐喻的Heroku池:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi me"><img src="../Images/f46ff79c511c3b4c134e34656d28f755.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MvF6RH0fwZwCt-wb.png"/></div></div></figure><p id="b8b9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">新的申请流程要求输入名称(我选择了“amhs”)和地区(美国):</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mf"><img src="../Images/82c2ca96645746036a9729d457414777.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MVNkVTzq3gapHZvH.png"/></div></div></figure><p id="2eb5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">单击创建应用程序按钮后，我被重定向回Heroku主页:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi me"><img src="../Images/c673a186c2e79fad5a2032de47af08d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9I6p1vJP-LsfZph-.png"/></div></div></figure><p id="4f6c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有了现在创建的“amhs”应用程序，我现在可以更深入地研究这个过程了。</p><h1 id="4ad2" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">准备我的本地机器</h1><p id="6db7" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">为了准备我的本地MacBook Pro与Heroku交互，我继续使用Homebrew在终端中使用以下命令安装了<a class="ae ko" href="https://devcenter.heroku.com/articles/heroku-cli" rel="noopener ugc nofollow" target="_blank"> Heroku CLI </a>:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="434e" class="ml kq it mh b gy mm mn l mo mp">brew install heroku/brew/heroku</span></pre><p id="8d9c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">安装完成后，我发出以下命令，允许Heroku CLI使用我的信息:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="b354" class="ml kq it mh b gy mm mn l mo mp">heroku login</span></pre><p id="8b86" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">登录命令将与您的默认web浏览器交互，以完成身份验证过程。</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="d010" class="ml kq it mh b gy mm mn l mo mp">heroku: Press any key to open up the browser to login or q to exit:<br/>Opening browser to <a class="ae ko" href="https://cli-auth.heroku.com/auth/cli/browser/key-goes-here" rel="noopener ugc nofollow" target="_blank">https://cli-auth.heroku.com/auth/cli/browser/key-goes-here</a></span></pre><p id="64c3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">打开浏览器到<a class="ae ko" href="https://cli-auth.heroku.com/auth/cli/browser/key-goes-here" rel="noopener ugc nofollow" target="_blank">https://cli-auth.heroku.com/auth/cli/browser/key-goes-here</a></p><p id="2b19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">验证后，将出现一个类似于下面所列的屏幕:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/f38ac720d3291e115bb7c32108930b88.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/0*n3CGJ6k1oAlhXq2t.png"/></div></figure><p id="6389" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">终端会话将包含类似于以下注释的文本:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="2839" class="ml kq it mh b gy mm mn l mo mp">Logging in... done</span><span id="b27f" class="ml kq it mh b gy mr mn l mo mp">Logged in as name@example.com</span></pre><p id="f493" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如所料，使用Heroku CLI时也需要git。因为我的其他开发工作，我已经安装了git，但是这里有关于如何安装git的说明。</p><p id="0c16" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你的本地机器上有自制软件，你也可以使用<code class="fe ms mt mu mh b">brew install git</code>。</p><h1 id="f55e" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">设置amhs应用程序</h1><p id="3ea9" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">在Heroku中打开amhs应用程序可以进一步配置应用程序:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi me"><img src="../Images/e08b3c12fba7757c0d3fd9103367a568.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IiC9Pnjq2Bed9vn1.png"/></div></div></figure><p id="f0ba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我首先知道我需要的是一个数据库。对于这个项目，我决定使用MySQL。搜索插件并使用搜索字符串“MySQL”提供了以下选项:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi me"><img src="../Images/94746ed01aa8d064bc5bef0532dd16ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1cmSDAEdQiD9BPAx.png"/></div></div></figure><p id="334c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过一些快速研究，我决定坚持使用标准化的数据库，并选择了ClearDB MySQL选项。此时，我也选择了Ignite-Free选项:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/59822c9ff658c00e5517b61eacb6aa4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:930/format:webp/0*a8g9UWPtWGtKG4On.png"/></div></figure><p id="b112" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mw">请注意——在成功提供附加服务之前，您需要有一张信用卡，该附加服务用于在出现问题时可靠地识别和联系客户。</em></p><p id="efab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用MySQL选项后，amhs屏幕更新如下所示:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi me"><img src="../Images/d6d60840d8bcc19785a322847310a55c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mvSdzzUeIFA_GZEr.png"/></div></div></figure><p id="4e4f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">也可以使用以下命令来完成这些相同的步骤:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="d1bd" class="ml kq it mh b gy mm mn l mo mp">heroku addons:create cleardb:ignite</span></pre><p id="8f96" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Heroku CLI实际上有一个实用程序，可以使用以下命令复制现有的MySQL数据库:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="b827" class="ml kq it mh b gy mm mn l mo mp">heroku addons:create cleardb:ignite --fork=mysql://user:password@myhostname.com/database</span></pre><p id="ce7d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这种情况下，我决定手动设置数据库并插入一些测试记录，这将在下一节中描述。</p><h1 id="fdd8" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">准备数据库</h1><p id="0a5d" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">在Heroku中创建和运行了一个空的MySQL实例后，下一步是发送必要的DDL来创建表。</p><p id="1b8c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，我需要确定数据库的URL。Heroku CLI具有以下命令来完成此任务:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="9f2c" class="ml kq it mh b gy mm mn l mo mp">heroku config --app amhs</span></pre><p id="32c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">其中Heroku CLI的响应类似于:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="09c2" class="ml kq it mh b gy mm mn l mo mp">=== amhs Config Vars<br/>CLEARDB_DATABASE_URL: mysql://name:password@somehost.cleardb.net/heroku_someId?reconnect=true</span></pre><p id="d4ac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有了这些信息，我就能够利用DbVisualizer(我选择的SQL工具)来设置预期的表和基本配置数据。</p><p id="85e2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在Java API端，我使用连接信息来更新spring.datasource值。</p><p id="062d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">仍然在本地模式下，我重启了Spring Boot Java API和Angular应用程序的一个本地实例。登录后，我可以访问系统配置，查看我插入的测试值:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi me"><img src="../Images/58cde577c91c4a308d618fc726fde9ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JL5J4Lv6xF3df92O.png"/></div></div></figure><p id="5ae9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此时，Java API在本地运行，但是在Heroku中访问新的ClearDB数据库。</p><h1 id="2df0" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">为Heroku准备好Java API</h1><p id="77e4" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">Java API现在使用ClearDB MySQL数据库，下一步是更新基于Spring Boot的API以在Heroku上运行。</p><p id="e15d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于AMHS应用程序已经在git存储库中，我只需要执行下面的Heroku CLI命令，就可以让API将更新推送到在Heroku中创建的amhs应用程序中:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="2d44" class="ml kq it mh b gy mm mn l mo mp">heroku git:remote -a amhs</span></pre><p id="2ead" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Heroku CLI的响应输出如下:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="275f" class="ml kq it mh b gy mm mn l mo mp">set git remote heroku to <a class="ae ko" href="https://git.heroku.com/amhs.git" rel="noopener ugc nofollow" target="_blank">https://git.heroku.com/amhs.git</a></span></pre><p id="056b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，我通过发出以下命令来验证远程配置:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="ed8f" class="ml kq it mh b gy mm mn l mo mp">git remote -v</span></pre><p id="a700" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">git CLI响应了以下信息:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="fef5" class="ml kq it mh b gy mm mn l mo mp">heroku <a class="ae ko" href="https://git.heroku.com/amhs.git" rel="noopener ugc nofollow" target="_blank">https://git.heroku.com/amhs.git</a> (fetch)</span><span id="7ef5" class="ml kq it mh b gy mr mn l mo mp">heroku <a class="ae ko" href="https://git.heroku.com/amhs.git" rel="noopener ugc nofollow" target="_blank">https://git.heroku.com/amhs.git</a> (push)</span><span id="eada" class="ml kq it mh b gy mr mn l mo mp">origin git@gitlab.com:my-repo/amhs-api.git (fetch)</span><span id="adad" class="ml kq it mh b gy mr mn l mo mp">origin git@gitlab.com:my-repo/amhs-api.git (push)</span></pre><p id="f2d5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我创建了一个Procfile，并将该文本文件放在AMHS存储库的根目录下。内容很简单:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="d1ca" class="ml kq it mh b gy mm mn l mo mp">web: java -jar target/amhs-api-2.0.0.jar</span></pre><p id="788b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">重要的值在“target/”的右边，它表示我的项目的artifactId和POM版本的连接。</p><p id="d357" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一切准备就绪后，下一步是签入我的项目中的变更。由于我在一个名为feature/heroku_demo <em class="mw">的分支中工作，</em>我执行了以下命令将我的代码(位于feature/hero_demo分支<em class="mw"> ) </em>推入Heroku git远程(目标是主分支):</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="1612" class="ml kq it mh b gy mm mn l mo mp">git push heroku feature/heroku_demo:master</span></pre><p id="7e04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Heroku CLI响应了以下信息。</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="9963" class="ml kq it mh b gy mm mn l mo mp">Enumerating objects: 737, done.</span><span id="cbc6" class="ml kq it mh b gy mr mn l mo mp">Counting objects: 100% (737/737), done.</span><span id="252a" class="ml kq it mh b gy mr mn l mo mp">Delta compression using up to 16 threads</span><span id="08c1" class="ml kq it mh b gy mr mn l mo mp">Compressing objects: 100% (586/586), done.</span><span id="e8ff" class="ml kq it mh b gy mr mn l mo mp">Writing objects: 100% (737/737), 163.43 KiB | 5.11 MiB/s, done.</span><span id="dc7c" class="ml kq it mh b gy mr mn l mo mp">Total 737 (delta 244), reused 0 (delta 0)</span><span id="96be" class="ml kq it mh b gy mr mn l mo mp">remote: Compressing source files... done.</span><span id="d318" class="ml kq it mh b gy mr mn l mo mp">remote: Building source:</span><span id="3b0c" class="ml kq it mh b gy mr mn l mo mp">remote:</span><span id="fed8" class="ml kq it mh b gy mr mn l mo mp">remote: -----&gt; Java app detected</span><span id="9c38" class="ml kq it mh b gy mr mn l mo mp">remote: -----&gt; Installing JDK 1.8... done</span><span id="72e2" class="ml kq it mh b gy mr mn l mo mp">remote: -----&gt; Installing Maven 3.6.2... done</span><span id="d3c6" class="ml kq it mh b gy mr mn l mo mp">remote: -----&gt; Executing Maven</span><span id="8048" class="ml kq it mh b gy mr mn l mo mp">remote: $ mvn -DskipTests clean dependency:list install</span><span id="e73c" class="ml kq it mh b gy mr mn l mo mp">remote: [INFO] Scanning for projects...</span><span id="3117" class="ml kq it mh b gy mr mn l mo mp">remote: [INFO] ------------------------------------------------------------------------</span><span id="5ee3" class="ml kq it mh b gy mr mn l mo mp">remote: [INFO] BUILD SUCCESS</span><span id="eb0d" class="ml kq it mh b gy mr mn l mo mp">remote: [INFO] ------------------------------------------------------------------------</span><span id="7aa7" class="ml kq it mh b gy mr mn l mo mp">remote: [INFO] Total time: 47.107 s</span><span id="6ba0" class="ml kq it mh b gy mr mn l mo mp">remote: [INFO] Finished at: 2020-04-18T18:31:39Z</span><span id="8251" class="ml kq it mh b gy mr mn l mo mp">remote: [INFO] ------------------------------------------------------------------------</span><span id="eac1" class="ml kq it mh b gy mr mn l mo mp">remote: -----&gt; Discovering process types</span><span id="2d60" class="ml kq it mh b gy mr mn l mo mp">remote: Procfile declares types -&gt; web</span><span id="e7ae" class="ml kq it mh b gy mr mn l mo mp">remote:</span><span id="955d" class="ml kq it mh b gy mr mn l mo mp">remote: -----&gt; Compressing...</span><span id="2ad9" class="ml kq it mh b gy mr mn l mo mp">remote: Done: 91.2M</span><span id="4769" class="ml kq it mh b gy mr mn l mo mp">remote: -----&gt; Launching...</span><span id="89ef" class="ml kq it mh b gy mr mn l mo mp">remote: Released v5</span><span id="3f01" class="ml kq it mh b gy mr mn l mo mp">remote: <a class="ae ko" href="https://amhs.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">https://amhs.herokuapp.com/</a> deployed to Heroku</span><span id="6348" class="ml kq it mh b gy mr mn l mo mp">remote:</span><span id="f7b6" class="ml kq it mh b gy mr mn l mo mp">remote: Verifying deploy... done.</span><span id="35f6" class="ml kq it mh b gy mr mn l mo mp">To <a class="ae ko" href="https://git.heroku.com/amhs.git" rel="noopener ugc nofollow" target="_blank">https://git.heroku.com/amhs.git</a></span><span id="48d3" class="ml kq it mh b gy mr mn l mo mp">* [new branch] feature/heroku_demo -&gt; master</span></pre><h1 id="3b4d" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">验证API</h1><p id="8456" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">回顾Heroku Overview屏幕，我可以看到我的构建不仅成功了，而且代码也部署好了！</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi me"><img src="../Images/28a5c720254e7cdd69082813037896d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ea4sN7gTpk6d9dnN.png"/></div></div></figure><p id="c1e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，我可以使用<a class="ae ko" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>发出以下GET请求:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="f1be" class="ml kq it mh b gy mm mn l mo mp"><a class="ae ko" href="https://amhs.herokuapp.com/staff?sortColumn=lastName&amp;sortDirection=asc&amp;status=active" rel="noopener ugc nofollow" target="_blank">https://amhs.herokuapp.com/staff?sortColumn=lastName&amp;sortDirection=asc&amp;status=active</a></span></pre><p id="5d9c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它返回了200 HTTP状态代码和以下数据:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="5683" class="ml kq it mh b gy mm mn l mo mp">[</span><span id="098a" class="ml kq it mh b gy mr mn l mo mp">{</span><span id="b98e" class="ml kq it mh b gy mr mn l mo mp">"id":1,</span><span id="fa6f" class="ml kq it mh b gy mr mn l mo mp">"firstName":"Amy",</span><span id="fe85" class="ml kq it mh b gy mr mn l mo mp">"lastName":"Admin",</span><span id="303c" class="ml kq it mh b gy mr mn l mo mp">"nickName":"",</span><span id="ffd2" class="ml kq it mh b gy mr mn l mo mp">"role":{</span><span id="d2ae" class="ml kq it mh b gy mr mn l mo mp">"id":3,</span><span id="8a2c" class="ml kq it mh b gy mr mn l mo mp">"name":"Admin"</span><span id="aee4" class="ml kq it mh b gy mr mn l mo mp">},</span><span id="6f49" class="ml kq it mh b gy mr mn l mo mp">"manager":null,</span><span id="14be" class="ml kq it mh b gy mr mn l mo mp">"active":true,</span><span id="c15f" class="ml kq it mh b gy mr mn l mo mp">"created":"2020-04-18T13:31:06.000+0000",</span><span id="a275" class="ml kq it mh b gy mr mn l mo mp">"updated":"2020-04-18T13:31:16.000+0000",</span><span id="8bee" class="ml kq it mh b gy mr mn l mo mp">"initials":"AA"</span><span id="11a7" class="ml kq it mh b gy mr mn l mo mp">},</span><span id="4833" class="ml kq it mh b gy mr mn l mo mp">{</span><span id="d0e2" class="ml kq it mh b gy mr mn l mo mp">"id":3,</span><span id="ae51" class="ml kq it mh b gy mr mn l mo mp">"firstName":"Alice",</span><span id="bbfb" class="ml kq it mh b gy mr mn l mo mp">"lastName":"Agent",</span><span id="d14f" class="ml kq it mh b gy mr mn l mo mp">"nickName":"",</span><span id="e560" class="ml kq it mh b gy mr mn l mo mp">"role":{</span><span id="33b9" class="ml kq it mh b gy mr mn l mo mp">"id":2,</span><span id="503c" class="ml kq it mh b gy mr mn l mo mp">"name":"Agent"</span><span id="c5ac" class="ml kq it mh b gy mr mn l mo mp">},</span><span id="0110" class="ml kq it mh b gy mr mn l mo mp">"manager":{</span><span id="6c76" class="ml kq it mh b gy mr mn l mo mp">"id":2,</span><span id="d5f6" class="ml kq it mh b gy mr mn l mo mp">"firstName":"Marty",</span><span id="5ad0" class="ml kq it mh b gy mr mn l mo mp">"lastName":"Manager",</span><span id="cdf5" class="ml kq it mh b gy mr mn l mo mp">"nickName":"",</span><span id="6f3c" class="ml kq it mh b gy mr mn l mo mp">"role":{</span><span id="9f22" class="ml kq it mh b gy mr mn l mo mp">"id":1,</span><span id="aa5f" class="ml kq it mh b gy mr mn l mo mp">"name":"Manager"</span><span id="c854" class="ml kq it mh b gy mr mn l mo mp">},</span><span id="59ac" class="ml kq it mh b gy mr mn l mo mp">"manager":null,</span><span id="853d" class="ml kq it mh b gy mr mn l mo mp">"active":true,</span><span id="78b8" class="ml kq it mh b gy mr mn l mo mp">"created":"2020-04-18T13:31:20.000+0000",</span><span id="b085" class="ml kq it mh b gy mr mn l mo mp">"updated":"2020-04-18T13:31:28.000+0000",</span><span id="78e8" class="ml kq it mh b gy mr mn l mo mp">"initials":"MM"</span><span id="3204" class="ml kq it mh b gy mr mn l mo mp">},</span><span id="8009" class="ml kq it mh b gy mr mn l mo mp">"active":true,</span><span id="30e3" class="ml kq it mh b gy mr mn l mo mp">"created":"2020-04-18T13:31:35.000+0000",</span><span id="b264" class="ml kq it mh b gy mr mn l mo mp">"updated":"2020-04-18T13:31:44.000+0000",</span><span id="94e6" class="ml kq it mh b gy mr mn l mo mp">"initials":"AA"</span><span id="a637" class="ml kq it mh b gy mr mn l mo mp">},</span><span id="7876" class="ml kq it mh b gy mr mn l mo mp">{</span><span id="83cb" class="ml kq it mh b gy mr mn l mo mp">"id":2,</span><span id="596a" class="ml kq it mh b gy mr mn l mo mp">"firstName":"Marty",</span><span id="3180" class="ml kq it mh b gy mr mn l mo mp">"lastName":"Manager",</span><span id="7d72" class="ml kq it mh b gy mr mn l mo mp">"nickName":"",</span><span id="c9d8" class="ml kq it mh b gy mr mn l mo mp">"role":{</span><span id="9fa7" class="ml kq it mh b gy mr mn l mo mp">"id":1,</span><span id="ec11" class="ml kq it mh b gy mr mn l mo mp">"name":"Manager"</span><span id="5274" class="ml kq it mh b gy mr mn l mo mp">},</span><span id="56b1" class="ml kq it mh b gy mr mn l mo mp">"manager":null,</span><span id="f8c6" class="ml kq it mh b gy mr mn l mo mp">"active":true,</span><span id="a7eb" class="ml kq it mh b gy mr mn l mo mp">"created":"2020-04-18T13:31:20.000+0000",</span><span id="5e1f" class="ml kq it mh b gy mr mn l mo mp">"updated":"2020-04-18T13:31:28.000+0000",</span><span id="f4d1" class="ml kq it mh b gy mr mn l mo mp">"initials":"MM"</span><span id="acd2" class="ml kq it mh b gy mr mn l mo mp">}</span><span id="9b1f" class="ml kq it mh b gy mr mn l mo mp">]</span></pre><p id="befe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我更新了Angular客户端中的<code class="fe ms mt mu mh b">environment.ts</code>文件，以使用相同的Java API，并且我能够看到相同的数据，现在我的本地Spring Boot Java API不再运行:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi me"><img src="../Images/00fd3e98239331de2452177a713bb4b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8dzuWE-PKMzw4fau.png"/></div></div></figure><h1 id="5e65" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">添加安全和环境变量</h1><p id="4a12" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">以确保我没有处理Okta集成的安全问题。我已经移除了Java API的安全性。现在，我想包含必要的更新以确保Java API再次安全。</p><p id="857b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在REST控制器级别，我只需包含以下注释:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="81be" class="ml kq it mh b gy mm mn l mo mp">@PreAuthorize("hasAuthority('AmhsUser') || #oauth2.hasScope('openid')")</span></pre><p id="276e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我在Heroku配置中为amhs应用程序设置必要的键/值对:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi me"><img src="../Images/cf67370f18dc9a9a5eae876313d34daf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*deoBff4T1Yq4VQlX.png"/></div></div></figure><p id="71f4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，我必须在<code class="fe ms mt mu mh b">application.yml</code>中引用这些变量:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="366f" class="ml kq it mh b gy mm mn l mo mp">security:</span><span id="66ad" class="ml kq it mh b gy mr mn l mo mp">oauth2:</span><span id="15d6" class="ml kq it mh b gy mr mn l mo mp">client:</span><span id="0586" class="ml kq it mh b gy mr mn l mo mp">clientId: ${CLIENT_ID}</span><span id="f29e" class="ml kq it mh b gy mr mn l mo mp">clientSecret: ${CLIENT_SECRET}</span><span id="28fe" class="ml kq it mh b gy mr mn l mo mp">resource:</span><span id="1fce" class="ml kq it mh b gy mr mn l mo mp">tokenInfoUri: ${TOKEN_INFO_URI}</span><span id="8471" class="ml kq it mh b gy mr mn l mo mp">spring:</span><span id="31e3" class="ml kq it mh b gy mr mn l mo mp">datasource:</span><span id="d108" class="ml kq it mh b gy mr mn l mo mp">url: ${CLEARDB_DATABASE_URL}</span><span id="b580" class="ml kq it mh b gy mr mn l mo mp">server:</span><span id="3dc6" class="ml kq it mh b gy mr mn l mo mp">port: ${PORT}</span></pre><p id="04dd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虽然我的<code class="fe ms mt mu mh b">application.yml</code>的其他值被隐藏了，但是我也想包含<code class="fe ms mt mu mh b">server.port</code>引用，因为记住这一点很重要。</p><p id="0a54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，查看Heroku中的概览屏幕，您可以看到所做的更新:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi me"><img src="../Images/1a893cc7b91f0b6f03904ae611f6afc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*i0Yo62abrEbLLWD4.png"/></div></div></figure><p id="e19a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要从Java API查看日志，只需发出以下命令:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="1133" class="ml kq it mh b gy mm mn l mo mp">heroku logs --tail</span></pre><p id="e68f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它产生以下输出:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="87d2" class="ml kq it mh b gy mm mn l mo mp">2020-04-19T14:12:15.000000+00:00 app[api]: Build started by user name@example.com</span><span id="a8bd" class="ml kq it mh b gy mr mn l mo mp">2020-04-19T14:12:41.789903+00:00 heroku[web.1]: Restarting</span><span id="16b8" class="ml kq it mh b gy mr mn l mo mp">2020-04-19T14:12:41.793282+00:00 heroku[web.1]: State changed from up to starting</span><span id="02aa" class="ml kq it mh b gy mr mn l mo mp">2020-04-19T14:12:41.526199+00:00 app[api]: Deploy 6d365207 by user name@example.com</span><span id="99cd" class="ml kq it mh b gy mr mn l mo mp">2020-04-19T14:12:41.526199+00:00 app[api]: Release v11 created by user name@example.com</span><span id="d563" class="ml kq it mh b gy mr mn l mo mp">2020-04-19T14:12:48.587250+00:00 app[web.1]: Setting JAVA_TOOL_OPTIONS defaults based on dyno size. Custom settings will override them.</span><span id="692c" class="ml kq it mh b gy mr mn l mo mp">2020-04-19T14:12:48.591623+00:00 app[web.1]: Picked up JAVA_TOOL_OPTIONS: -Xmx300m -Xss512k -XX:CICompilerCount=2 -Dfile.encoding=UTF-8</span><span id="c757" class="ml kq it mh b gy mr mn l mo mp">2020-04-19T14:12:50.722260+00:00 app[web.1]:</span><span id="c4bc" class="ml kq it mh b gy mr mn l mo mp">2020-04-19T14:12:50.722261+00:00 app[web.1]: :: AMHS API :: Running Spring Boot 2.0.3.RELEASE :: Port #9095 ::</span><span id="fb01" class="ml kq it mh b gy mr mn l mo mp">2020-04-19T14:12:50.722406+00:00 app[web.1]:</span><span id="0cc4" class="ml kq it mh b gy mr mn l mo mp">2020-04-19T14:12:49.000000+00:00 app[api]: Build succeeded</span><span id="52aa" class="ml kq it mh b gy mr mn l mo mp">2020-04-19T14:12:50.982144+00:00 app[web.1]: 2020-04-19 14:12:50.978 INFO 4 --- [ main] com.amhs.Application : Starting Application v2.0.0 on 3d90674b-0075-4d18-a6e0-91b6ca68bc3f with PID 4 (/app/target/amhs-api-2.0.0.jar started by u6224 in /app)</span></pre><p id="1a97" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">看到我运行的是Spring Boot 2.0.3，我的任务清单上肯定增加了一个Spring Boot更新。:)</p><h1 id="1c31" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">部署Java API的新方法</h1><p id="976b" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">我想研究Heroku而不是继续使用AWS的主要原因之一是它能够专注于我客户的业务需求。做全职工作和从事自由写作项目并没有给我提供太多的额外时间——尤其是家里有一个蹒跚学步的孩子。基本上，我想找到一个解决方案，不需要花费太多的精力来为我的岳母部署变更。</p><p id="20f7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一切就绪后，amhs应用程序的部署已简化为以下git命令:</p><pre class="lt lu lv lw gt mg mh mi mj aw mk bi"><span id="a080" class="ml kq it mh b gy mm mn l mo mp">git push heroku master</span></pre><p id="ce18" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这很容易记住，因为我通常将我的更改合并到master中。</p><h1 id="bcbc" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">结论</h1><p id="71e9" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">当我回顾我之前的说明(对于AWS)时，以下步骤不再需要:</p><ul class=""><li id="5fa9" class="mx my it js b jt ju jx jy kb mz kf na kj nb kn nc nd ne nf bi translated">手动构建供Elastic Beanstalk使用的JAR文件</li><li id="33cf" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated">导航到弹性Beanstalk UI</li><li id="67da" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated">手动定位并上传在上述步骤中创建的JAR文件</li><li id="e10f" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated">验证版本匹配(<code class="fe ms mt mu mh b">pom.xml</code>和JAR版本)</li><li id="67a1" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated">手动按下部署按钮</li></ul><p id="c3ff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虽然这些步骤并不十分痛苦，但每次我想发布新代码供我岳母使用时，它们都需要我花费时间来执行。然而，使用Heroku，我需要做的只是执行一个我已经熟悉使用的简单git命令。还有快速“回滚”到早期版本的能力——我将在以后的文章中详述。对我来说似乎是个胜利。</p><p id="b692" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">成本并不是这个实验的核心焦点，但是我觉得我应该指出，这里部署的所有东西都不会产生任何月成本。不错，当你考虑到我的Heroku解决方案在日常基础上需要的工作更少时。</p><p id="d432" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下一篇文章中，我将重点介绍Angular客户端，以及如何使用Heroku代替AWS S3来存放Angular和相关库使用的静态文件。</p><p id="69fe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">祝你今天过得愉快！</p></div></div>    
</body>
</html>