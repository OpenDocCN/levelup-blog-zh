<html>
<head>
<title>Facebook Instant Games 1v1 Multiplayer using Firebase (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Firebase的脸书即时游戏1v1多人游戏(第2部分)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/facebook-instant-games-1v1-multiplayer-using-firebase-part-2-baeea1145b79?source=collection_archive---------1-----------------------#2018-07-23">https://levelup.gitconnected.com/facebook-instant-games-1v1-multiplayer-using-firebase-part-2-baeea1145b79?source=collection_archive---------1-----------------------#2018-07-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="9a4f" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">请看这里的第一部分:<a class="ae kp" href="https://medium.com/@mixalisdobs/facebook-instant-games-1v1-multiplayer-using-firebase-part-1-30c1f6e32b92" rel="noopener">脸书即时游戏1v1多人使用Firebase(第一部分)</a></p></blockquote><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/fdd9f580b0e979db1555602aef554be3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3sv9HuPbWWoDjhZ-"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">丽贝卡·奥利弗在<a class="ae kp" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="3d43" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi lj translated"><span class="l lk ll lm bm ln lo lp lq lr di">在</span>第一部分中，我们解释了脸书即时游戏的多人游戏特性的前端，现在让我们看看使用Firebase Firestore-DB和函数的后端逻辑(一个沙盒NodeJS环境，无需拥有服务器即可编写后端逻辑)</p><p id="4092" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">你可以这样开始:</p><blockquote class="jn jo jp"><p id="ca76" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><a class="ae kp" href="https://firebase.google.com/docs/functions/get-started?authuser=1" rel="noopener ugc nofollow" target="_blank">https://firebase.google.com/docs/functions/get-started?authuser=1 </a></p></blockquote><p id="1141" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">现在假设我们的环境已经设置好了，让我们编写一些逻辑来处理前端请求</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/6033005c60c1adfd4db40f74d341993a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pmnD1O9nILQPGwCe"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">照片由<a class="ae kp" href="https://unsplash.com/@atgranberry?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">艾丹·格兰贝里</a>在<a class="ae kp" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="971b" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi lj translated">首先，这里是我在我的项目中使用的导入(你可能需要也可能不需要)</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="3e85" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">然后这里有一个小片段做用户验证(以确保您的用户确实来自脸书即时游戏)</p><p id="25ab" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">你可以在脸书应用设置页面找到你的<code class="fe mb mc md me b">APP_SECRET</code></p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="60c3" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">现在让我们为<code class="fe mb mc md me b">startMatchmaking</code>设定终点</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="cb2d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">上面我们正在接受一个http请求，我们接收用户FB-Id和标签(自定义标签)以及他们的签名，以便验证他们的身份。</p><p id="502f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">函数的其余部分只是将这些数据添加到<code class="fe mb mc md me b">bountyQueueRef</code>集合中，并以用户FB-Id作为文档名(因此是惟一的)创建一个文档。完成后，该函数向前端发送一个响应，通知一切正常，用户现在在队列中。</p><p id="45ee" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">接下来我们创建<code class="fe mb mc md me b">findMatch</code>函数，它在排队的玩家之间进行实际的匹配。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="3895" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">我们再次收到一个http请求，并验证发送方。之后，我们尝试将发件人与队列中的其他人进行匹配，如果该算法发现一个非发件人的未标记(已与某人匹配)用户，则它会立即标记该用户，使他们对其他可能的并发搜索不可见，同时它还会标记发件人，以便他们也不会被其他搜索选中。</p><blockquote class="jn jo jp"><p id="2a60" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">在这里阅读，为什么使用事务在数据库上读/写是好的。<a class="ae kp" href="https://firebase.google.com/docs/firestore/manage-data/transactions?authuser=1" rel="noopener ugc nofollow" target="_blank">https://firebase . Google . com/docs/firestore/manage-data/transactions？authuser=1 </a></p></blockquote><p id="7648" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">该函数将带有匹配玩家数据的响应返回给发送方，这基本上是不相关的，因为实际的功能是在这两行代码完成执行时触发的:</p><pre class="kr ks kt ku gt mf me mg mh aw mi bi"><span id="285a" class="mj mk iq me b gy ml mm l mn mo">t.set(bountyQueueRef.doc(queueEntry.userFBId), queueEntry, { merge: true }); // store their data again but flagged</span><span id="da43" class="mj mk iq me b gy mp mm l mn mo">t.set(bountyQueueRef.doc(userFBId), data, { merge: true }); // store our data again but flagged</span></pre><p id="f5c8" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">因为我们已经在两个播放器的前端<code class="fe mb mc md me b">addBountyQueueListener</code>设置了事件监听器。当<code class="fe mb mc md me b">set</code>操作完成对数据库的写操作时，事件监听器接收到一个事件。</p><p id="98cf" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">然后前端通过使用</p><pre class="kr ks kt ku gt mf me mg mh aw mi bi"><span id="6042" class="mj mk iq me b gy ml mm l mn mo">FBInstant.context.createAsync(userFBId)</span></pre><p id="bb58" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">如本教程第1部分所述:<a class="ae kp" href="https://medium.com/@mixalisdobs/facebook-instant-games-1v1-multiplayer-using-firebase-part-1-30c1f6e32b92" rel="noopener">https://medium . com/@ mixalisdobs/Facebook-instant-games-1 v1-multiplayer-using-firebase-Part-1-30 C1 f 6 e 32 b 92</a></p><p id="6acc" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">我希望你能发现上面的信息是有用的，如果你想让我解释得更好，或者如果你确实通过使用所描述的方法做出了一些东西，请给我留言！</p><p id="32a0" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">尽情享受吧！</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi mq"><img src="../Images/d4d9385c6f7da68d066378271a41d499.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y0sUJldXrjq7IpH7"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">照片由<a class="ae kp" href="https://unsplash.com/@alx_andru?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Al x </a>在<a class="ae kp" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure></div></div>    
</body>
</html>