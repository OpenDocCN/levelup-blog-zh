<html>
<head>
<title>Create a Dockerfile for Node.js Applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Node.js应用程序创建docker文件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/create-a-dockerfile-for-nodejs-applications-7310c298daee?source=collection_archive---------0-----------------------#2019-05-14">https://levelup.gitconnected.com/create-a-dockerfile-for-nodejs-applications-7310c298daee?source=collection_archive---------0-----------------------#2019-05-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/99f60b0c52a0d58575e10d80830ec976.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EcVcSN-UfoMCUcQyLW8JTg.png"/></div></div></figure><p id="6f6d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">本文将向您展示如何为您的节点应用程序创建Docker文件，使它能够作为Docker容器运行。你应该先安装Docker 才能运行Docker命令。</p><p id="9e25" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要创建Docker容器，您需要在您的项目上创建一个Docker文件。使用这个文件，您可以创建一个Docker容器，它可以在任何平台上运行，而不需要在实际的机器上安装任何库。</p><p id="5861" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Docker允许您将应用程序及其环境和所有依赖项打包到一个封装的“盒子”中，称为容器。通常，容器由运行在精简版Linux操作系统中的应用程序组成。图像是容器的蓝图，容器是图像的运行实例。</p><h1 id="25ff" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak">创建一个简单的Node.js应用程序</strong></h1><blockquote class="ly lz ma"><p id="d542" class="kb kc mb kd b ke kf kg kh ki kj kk kl mc kn ko kp md kr ks kt me kv kw kx ky im bi translated">注意:如果您的计算机上有节点项目，您可以使用预先存在的应用程序。如果没有，这个简单的应用程序将为您提供一个基本的应用程序来部署。</p></blockquote><p id="bd65" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先，创建一个新目录，并在其中创建一个<code class="fe mf mg mh mi b">package.json</code>文件:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="2dd1" class="mr lb it mi b gy ms mt l mu mv">{<br/>  "name": "nodejs app",<br/>  "version": "1.0.0",<br/>  "description": "create a dockerfile on Nodejs project",<br/>  "author": "sarasa Gunawardhana",<br/>  "main": "server.js",<br/>  "scripts": {<br/>    "start": "node server.js"<br/>  },<br/>  "dependencies": {<br/>    "express": "^4.16.1"<br/>  }<br/>}</span></pre><p id="2b7c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">运行<code class="fe mf mg mh mi b">npm install</code>。</p><p id="e0b4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后，创建一个使用<a class="ae kz" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express.js </a>框架定义web应用程序的<code class="fe mf mg mh mi b">server.js</code>文件:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="084c" class="mr lb it mi b gy ms mt l mu mv">'use strict';</span><span id="9d48" class="mr lb it mi b gy mw mt l mu mv">const express = require('express');</span><span id="0529" class="mr lb it mi b gy mw mt l mu mv">// Constants<br/>const PORT = 3000;</span><span id="5ca1" class="mr lb it mi b gy mw mt l mu mv">const app = express();<br/>app.get('/', (req, res) =&gt; {<br/>  res.send('Docker and Nodejs');<br/>});</span><span id="e772" class="mr lb it mi b gy mw mt l mu mv">app.listen(PORT, HOST);<br/>console.log(`Running on <a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/${HOST}:${PORT}`);">${PORT}`);</a></span></pre><p id="0ece" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在接下来的步骤中，您将创建一个Dockerfile文件。</p><h1 id="7af3" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak">创建Dockerfile文件</strong></h1><p id="51f0" class="pw-post-body-paragraph kb kc it kd b ke mx kg kh ki my kk kl km mz ko kp kq na ks kt ku nb kw kx ky im bi translated">创建一个文件作为D <strong class="kd iu"> ockerfile </strong></p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="8a48" class="mr lb it mi b gy ms mt l mu mv">touch Dockerfile<br/># OR<br/>nano Dockerfile</span></pre><p id="2f39" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们需要做的第一件事是定义我们想要建立什么样的形象。这里我们将使用最新的节点，版本11。</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="2c63" class="mr lb it mi b gy ms mt l mu mv">FROM node:11</span></pre><p id="dff6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，我们创建一个目录来保存映像中的应用程序代码，这将是您的应用程序的工作目录:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="c755" class="mr lb it mi b gy ms mt l mu mv"># Create app directory<br/>WORKDIR /usr/src/app</span></pre><p id="aae0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个映像已经安装了Node.js和NPM，所以接下来我们需要做的是使用<code class="fe mf mg mh mi b">npm</code>二进制文件安装您的应用程序依赖项。请注意，如果您使用的是<code class="fe mf mg mh mi b">npm</code>版本4或更早版本，将会生成<code class="fe mf mg mh mi b">package-lock.json</code>文件<em class="mb">而不是</em>。</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="14a2" class="mr lb it mi b gy ms mt l mu mv"># Install app dependencies<br/># A wildcard is used to ensure both package.json AND package-lock.json are copied<br/># where available (npm@5+)<br/>COPY package*.json ./<br/><br/>RUN npm install<br/># If you are building your code for production<br/># RUN npm ci --only=production</span></pre><p id="0857" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意，我们不是复制整个工作目录，而是复制<code class="fe mf mg mh mi b">package.json</code>文件。这允许我们利用缓存的Docker层。bitJudo在这里对这个<a class="ae kz" href="http://bitjudo.com/blog/2014/03/13/building-efficient-dockerfiles-node-dot-js/" rel="noopener ugc nofollow" target="_blank">有很好的解释。此外，注释中指定的<code class="fe mf mg mh mi b">npm ci</code>命令有助于为生产环境提供更快、更可靠、可重复的构建。你可以在这里阅读更多关于这个</a><a class="ae kz" href="https://blog.npmjs.org/post/171556855892/introducing-npm-ci-for-faster-more-reliable" rel="noopener ugc nofollow" target="_blank">的内容</a>。</p><p id="e322" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要将应用程序的源代码捆绑到Docker映像中，请使用<code class="fe mf mg mh mi b">COPY</code>指令:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="c906" class="mr lb it mi b gy ms mt l mu mv"># Bundle app source<br/>COPY . .</span></pre><p id="da64" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您的应用程序绑定到端口<code class="fe mf mg mh mi b">8080</code>，因此您将使用<code class="fe mf mg mh mi b">EXPOSE</code>指令让<code class="fe mf mg mh mi b">docker</code>守护进程映射它:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="163a" class="mr lb it mi b gy ms mt l mu mv">EXPOSE 3000</span></pre><p id="a2dd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后但同样重要的是，使用定义运行时的<code class="fe mf mg mh mi b">CMD</code>来定义运行应用程序的命令。这里我们将使用基本的<code class="fe mf mg mh mi b">npm start</code>，它将运行<code class="fe mf mg mh mi b">node server.js</code>来启动您的服务器:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="9465" class="mr lb it mi b gy ms mt l mu mv">CMD [ "npm", "start" ]</span></pre><p id="44e2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您的<code class="fe mf mg mh mi b">Dockerfile</code>现在应该是这样的:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="3ecd" class="mr lb it mi b gy ms mt l mu mv">FROM node:8<br/><br/># Create app directory<br/>WORKDIR /usr/src/app<br/><br/># Install app dependencies<br/># A wildcard is used to ensure both package.json AND package-lock.json are copied<br/># where available (npm@5+)<br/>COPY package*.json ./<br/><br/>RUN npm install<br/># If you are building your code for production<br/># RUN npm ci --only=production<br/><br/># Bundle app source<br/>COPY . .<br/><br/>EXPOSE 3000<br/>CMD [ "npm", "start" ]</span></pre><h1 id="4904" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">建立你的形象</h1><p id="f52c" class="pw-post-body-paragraph kb kc it kd b ke mx kg kh ki my kk kl km mz ko kp kq na ks kt ku nb kw kx ky im bi translated">转到包含您的<code class="fe mf mg mh mi b">Dockerfile</code>的目录，运行下面的命令来构建Docker映像。<code class="fe mf mg mh mi b">-t</code>标志允许您标记您的图像，以便稍后使用<code class="fe mf mg mh mi b">docker images</code>命令更容易找到:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="fdf8" class="mr lb it mi b gy ms mt l mu mv">$ docker build -t &lt;your username&gt;/node-web-app .</span></pre><p id="aec2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您的图像现在将由Docker列出:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="7dfa" class="mr lb it mi b gy ms mt l mu mv">$ docker images</span><span id="5e5a" class="mr lb it mi b gy mw mt l mu mv"># Example<br/>REPOSITORY                      TAG        ID              CREATED<br/>node                            8          1934b0b038d1    5 days ago<br/>&lt;your username&gt;/node-web-app    latest     d64d3505b0d2    1 minute ago</span></pre><h1 id="130a" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">运行图像</h1><p id="8d8b" class="pw-post-body-paragraph kb kc it kd b ke mx kg kh ki my kk kl km mz ko kp kq na ks kt ku nb kw kx ky im bi translated">用<code class="fe mf mg mh mi b">-d</code>运行您的映像以分离模式运行容器，让容器在后台运行。<code class="fe mf mg mh mi b">-p</code>标志将公共端口重定向到容器内的私有端口。运行您之前构建的映像:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="25a7" class="mr lb it mi b gy ms mt l mu mv">$ docker run -p 49160:8080 -d &lt;your username&gt;/node-web-app</span></pre><p id="638d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">打印应用程序的输出:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="f659" class="mr lb it mi b gy ms mt l mu mv"># Get container ID<br/>$ docker ps</span><span id="724c" class="mr lb it mi b gy mw mt l mu mv"># Print app output<br/>$ docker logs &lt;container id&gt;</span><span id="248c" class="mr lb it mi b gy mw mt l mu mv"># Example<br/>Running on <a class="ae kz" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a></span></pre><p id="2cf0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你需要进入容器内部，你可以使用<code class="fe mf mg mh mi b">exec</code>命令:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="155d" class="mr lb it mi b gy ms mt l mu mv"># Enter the container<br/>$ docker exec -it &lt;container id&gt; /bin/bash</span></pre><h1 id="c0a0" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">试验</h1><p id="d812" class="pw-post-body-paragraph kb kc it kd b ke mx kg kh ki my kk kl km mz ko kp kq na ks kt ku nb kw kx ky im bi translated">要测试您的应用程序，请获取Docker映射的应用程序端口:</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="33b0" class="mr lb it mi b gy ms mt l mu mv">$ docker ps</span><span id="0176" class="mr lb it mi b gy mw mt l mu mv"># Example<br/>ID            IMAGE                                COMMAND    ...   PORTS<br/>ecce33b30ebf  &lt;your username&gt;/node-web-app:latest  npm start  ...   49160-&gt;8080</span></pre><p id="ffb6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在上面的例子中，Docker将容器内部的端口<code class="fe mf mg mh mi b">8080</code>映射到机器上的端口<code class="fe mf mg mh mi b">49160</code>。</p><p id="b6c5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，您可以使用<code class="fe mf mg mh mi b">curl</code>调用您的应用程序(如果需要，通过<code class="fe mf mg mh mi b">sudo apt-get install curl</code>安装):</p><pre class="mj mk ml mm gt mn mi mo mp aw mq bi"><span id="d5c4" class="mr lb it mi b gy ms mt l mu mv">$ curl -i localhost:49160</span><span id="d3ab" class="mr lb it mi b gy mw mt l mu mv">HTTP/1.1 200 OK<br/>X-Powered-By: Express<br/>Content-Type: text/html; charset=utf-8<br/>Content-Length: 12<br/>ETag: W/"c-M6tWOb/Y57lesdjQuHeB1P/qTV0"<br/>Date: Mon, 13 Nov 2017 20:53:59 GMT<br/>Connection: keep-alive</span><span id="0e40" class="mr lb it mi b gy mw mt l mu mv">Docker on nodejs</span></pre><h1 id="a26b" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">如果这篇文章有帮助，请点击拍手👏按钮下面几下，以示你对作者的支持！</h1></div></div>    
</body>
</html>