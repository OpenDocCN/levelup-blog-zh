# 如何设计可靠的微服务

> 原文：<https://levelup.gitconnected.com/how-to-design-reliable-microservices-5efba55172da>

![](img/df1b87864b0bd733934cb04adab9d0ea.png)

[尼克·奈特](https://unsplash.com/@nicknight?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/t/architecture?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍照

正常运行时间百分比为 99.9%的微服务应用程序可以被认为是高度可用的，但随着数量的增加，0.1%的停机时间很快就会变得明显。每 1000 个请求中，可能只有一个失败，但是每一百万个请求中呢？那就是 1000 次失败。

微服务应用中不可能消除故障。相反，您需要专注于设计容错的微服务，能够从故障中优雅地恢复或减轻这些故障对您系统的影响。

在本文中，我们将探讨微服务应用中的故障源，如何减轻故障或其对系统的影响，以及如何最大限度地提高服务可用性——本质上是设计和确保可靠、容错微服务的独特方法。

# 失败的原因

故障导致不可靠的微服务。但是在一个复杂的系统中，失败是不可避免的。毫无疑问，在应用程序生命周期的某个时刻，会出现故障。

您需要了解您的应用程序可能容易遭受的不同类型的故障，因为这将使您能够快速做出反应并设计适当的缓解策略。

在微服务中，您的服务和另一个组件之间的每个交互点都代表一个可能的故障点。故障可能发生在四个主要方面:

*   五金器具
*   沟通
*   属国
*   内部的

让我们分别看一下每一点:

*   **硬件** :
    无论您在哪里运行服务——在公共云中还是在本地，服务的可靠性都将在很大程度上取决于支撑它们的物理和虚拟基础架构。应用程序这一层的故障通常是最具灾难性的，因为硬件故障会影响组织内多个服务的运行。应用程序硬件层内的一些故障原因:
    -主机
    -数据中心
    -主机配置
    -物理网络
    -操作系统和资源隔离
*   **沟通:** 微服务基本上都是沟通:同步沟通；异步通信；具有内部依赖性的通信；与外部依赖的通信。失败可能发生在这些交互的某一点上，如果处理不当，其影响可能会波及整个应用程序。
    通信故障的可能来源包括:
    -网络
    -防火墙
    -消息系统
    - DNS
    -健康检查不佳
*   **依赖关系:** 一个微服务包含多个依赖关系，既有外部的，也有内部的。在外部，微服务应用程序可能依赖于第三方 API，而在内部，服务可能依赖于数据库。这些依赖点是微服务中的潜在故障点。依赖相关故障的一些来源包括:
    -超时
    -非反向兼容功能
    -内部组件故障
    -外部依赖
*   **内部:** 这种失败的根源很大程度上是由糟糕的设计、不充分的开发、糟糕的测试或者不正确的服务部署造成的。如果一个服务设计得不好，并且实际上在生产中失败了，它对整个系统的影响将是有害的。

您已经看到了系统中可能出现故障的各个方面。接下来，让我们看看可以用来减轻系统中这些故障影响的不同策略。

# 减轻系统故障影响的策略

如果你要构建一个复杂的系统，那么在你的系统中不可避免的会出现故障。有了这些知识，您需要设计和构建您的服务，以便能够最小化故障的影响，最大化可用性，并快速恢复。

可以采用以下策略来实现容错和可靠的系统:

*   **重试** 这个策略很棘手。它能够对最终用户隐藏异常行为的发生，但是如果使用不当，它会加剧原来的问题并使系统恶化。

    故障可能是持续性的，也可能是孤立的。如果故障是孤立的，那么重试策略将有助于减轻故障的影响，但是如果故障是持续的，重试可能会使问题恶化并进一步破坏系统的稳定。

    您需要使用一种重试策略，这种策略可以在间歇性故障期间提高系统的弹性，而不会在持续故障发生时导致系统崩溃。这种策略被称为*指数后退。*这个想法是给一个系统在负载下恢复的时间。

    *这是怎么实现的？
    重试对于处理间歇性故障来说是完美的，但是在面对持续性故障时需要小心，因为它们会导致您的系统不稳定。*
*   **超时** 当你向一个服务发出请求后必须等待一段时间才能得到响应时，资源就被消耗掉了。可以通过在 HTTP 请求中设置截止时间或超时来节省这些资源。如果没有收到任何响应，您希望超时，但如果响应下载缓慢，则不希望超时。

    有些错误是瞬间发生的，但很多失败是缓慢的。例如，如果服务的请求过载，响应可能会很慢，从而消耗发出请求的服务的资源，同时等待可能永远不会到来的响应。如果不设置请求超时，无响应性很容易在整个微服务中蔓延。
*   **回退** 当失败发生时，我们可以采用三个回退选项:
    — **适度降级:**假设您正在构建一个微博应用程序，您会希望无法发布新更新的用户能够查看、喜欢其他用户的更新，并与之互动。优雅的降级技术非常适合这种情况。因此，用户不会因为服务故障而无法使用我们的应用程序，我们可以适当地降级该服务，并允许他们在应用程序中执行其他功能。

    — **缓存:**如果我们在失败之前缓存对服务的查询结果，我们仍然能够向我们的客户和服务合作者提供信息。这确保了我们系统的改进性能，并导致一个可靠的系统。
    如果你的系统是全球分布的，你甚至可以依靠托管在另一个地区的服务——这就是亚马逊如何从他们的任何全球数据中心服务给定的客户。
*   **断路器:** 在电气布线中，[断路器](https://www.eaton.com/us/en-us/products/electrical-circuit-protection/circuit-breakers/circuit-breakers-fundamentals.html)的基本功能是在保护继电器检测到故障后中断电流。类似地，在分布式系统中，断路器是一种模式，用于暂停对失败服务的请求，以防止级联故障。

    断路器设计背后的两个原则:
    —远程通信应该在出现问题时迅速失败，而不是浪费资源等待可能永远不会到来的响应。
    —如果依赖关系持续失败，最好停止进一步请求，直到依赖关系恢复。

    你可以跟踪失败请求的数量；如果错误率超过阈值或配置的极限，则断路器断开。应该缩短对协作服务的进一步请求，并在可能的情况下执行适当的回退。一旦电路被打开，就不应该一直保持打开状态。断路器需要发送试用请求来确定服务是否可用。在这种试验状态下，电路是半开的。如果请求成功，电路应该关闭；否则，它将保持开放。与其他重试一样，这些尝试请求应该以指数级回退进行调度。
*   **异步通信:** 服务间长链的同步通信导致系统整体可用性低。使用 message queue 之类的通信代理进行异步通信，是一种可以用来提高系统可靠性的策略。
    建议在不需要立即响应的情况下使用这种方法。异步通信加强了更高级别的微服务自治，并有助于防止同步交互的服务常见的问题。

# 最大化服务可用性

在上一节中，我们研究了可以用来确保服务间通信容错的策略。在这一节中，我们将探索可以用来在单个服务中最大化可用性的技术:

*   **负载平衡和服务健康:**
    您可以部署应用程序的多个实例以确保冗余。负载平衡器将根据其他服务的健康状况和服务请求的能力，在这些实例之间分配来自这些服务的请求。
    在上一节中，只有当您向服务发出请求时，您才能确定服务的健康状况和服务请求的能力。这不是最佳方法。在向服务发出请求之前，您需要知道该服务是否足够健康，能够满足请求。这可以通过*健康检查*来实现。每个服务都应实施适当的健康检查。如果一个服务实例变得不健康，它将不再接收来自其他服务的流量。健康检查可以分为两种类型:
    — **活性**:该检查确定应用程序是否已经启动并正在运行，以及它是否能够接受请求并做出响应。如果服务实例不健康——如果它没有响应，或者返回一个错误消息——负载平衡器不应该在那里传递请求。

    — **准备就绪**:服务处于活动状态并不保证它将服务请求。就绪检查旨在指示服务是否准备好为请求提供服务。这种检查还有助于我们确定服务的依赖项——数据库、配置、第三方服务等。—身体健康，足以满足需求。
*   **费率限制:** 如果服务请求呼叫不受限制，就会出现不健康的服务使用模式。上游合作者可能会进行多次调用，而单个批处理调用可能更合适。显式限制在一个时间范围内协作服务的可用请求率或总请求数是我们可以用来确保服务不会过载的一种策略。

# 性能试验

我们探索的策略和技术将使您能够最大化服务可用性，但是您需要一种方法来验证您的服务能够容忍故障并优雅地恢复。这可以通过彻底的测试来实现。当可预测和不可预测的故障都发生时，测试可以确保您的设计是有效的。在这一节中，我们将探索负载测试和混乱测试:

*   **负载测试:** 负载测试有助于您了解当大量数据在单个服务之间传输时，应用程序的行为。它还帮助您公开没有针对可伸缩性进行优化的应用程序组件。这样，您可以防止生产环境中由大量用户负载导致的故障。
    在对微服务进行负载测试时，需要记住以下一些提示:
    -以高风险服务为目标，而不是 100%测试
    -利用多个运行时环境
    -根据服务水平协议进行测试
    -测量请求/响应比率以外的性能指标
    -使用服务虚拟化，而不是等待功能依赖
*   **混沌测试:**
    混沌测试将你的微服务应用推向生产失败。它测试由外部因素引起的故障，即不是由微服务内部引起的故障，例如网络故障、虚拟机故障、数据库故障等。通过引入不稳定性和故障，它模拟了真实的系统故障。这将暴露您的系统承受真正混乱的能力，并让您的工程团队做好应对这些故障的准备。
    根据混沌[网站](https://principlesofchaos.org/)的原理，混沌测试是发现系统弱点的实验，可以通过以下四个步骤进行:
    -将正常系统的可测输出定义为“稳态”
    -假设该系统在对照组和实验组中均保持不变。
    -引入反映现实世界故障事件的变量，例如，移除服务器、使用故障硬盘、切断网络连接、引入更高的频率级别等。
    -通过寻找对照组和实验组之间的稳态差异，尝试反驳第二步中的假设。如果稳定状态保持不变，我们将对我们的系统更有信心，但是如果发现了弱点，我们将知道我们系统的哪一部分需要改进，以防止或减少生产中发生故障的可能性。

在微服务应用中，失败是不可避免的。在本文中，我们研究了微服务应用中可能出现故障的各个方面。我们探索了可以用来减轻系统中这些故障影响的策略和技术。最后，我们看到了如何使用性能测试方法来验证我们的服务是真正容错的，并且可以优雅地恢复。

# 额外资源

[](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/partial-failure-strategies) [## 处理部分失败的策略

### 要处理部分失败，请使用这里描述的策略之一。使用异步通信(例如…

docs.microsoft.com](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/partial-failure-strategies) [](https://blog.risingstack.com/designing-microservices-architecture-for-failure/) [## 为故障上升堆栈工程设计微服务架构

### 微服务架构使得通过明确定义的服务边界隔离故障成为可能。但是就像在…

blog.risingstack.com](https://blog.risingstack.com/designing-microservices-architecture-for-failure/) [](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/architect-microservice-container-applications/resilient-high-availability-microservices) [## 微服务中的弹性和高可用性

### 处理意外故障是最难解决的问题之一，尤其是在分布式系统中。大部分…

docs.microsoft.com](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/architect-microservice-container-applications/resilient-high-availability-microservices)