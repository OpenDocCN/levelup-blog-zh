<html>
<head>
<title>Const Behind the Scenes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">幕后的Const</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/const-behind-the-scenes-53ea6c1c1964?source=collection_archive---------11-----------------------#2021-07-19">https://levelup.gitconnected.com/const-behind-the-scenes-53ea6c1c1964?source=collection_archive---------11-----------------------#2021-07-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f798" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">看看常量在。NET框架</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b47930125d52e2f5b328e7a240d87263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*StNLVEoHClmEQLOT"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@grisu48" rel="noopener ugc nofollow" target="_blank">费利克斯</a>在<a class="ae ky" href="https://unsplash.com/photos/Au8KMj4JBDo" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="fd66" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">const是什么？</h1><p id="0e24" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">当变量被标记为<code class="fe mn mo mp mq b">const</code>时，其值不能改变。</p><p id="3fbe" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">例如<code class="fe mn mo mp mq b">const int BoilingTempCelcius = 100;</code></p><p id="38ee" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">一个常量在编译时必须是可确定的，这意味着只有原始类型(<code class="fe mn mo mp mq b">bool</code>、<code class="fe mn mo mp mq b">int</code>、<code class="fe mn mo mp mq b">long</code>、<code class="fe mn mo mp mq b">string</code>等)才能被标记为常量。</p><p id="ec33" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">但是，如果将值设置为null，C#允许您将非基元类型声明为<code class="fe mn mo mp mq b">const</code>:</p><p id="3191" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated"><code class="fe mn mo mp mq b">const SomeComplexType x = null;</code></p><h1 id="52a0" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">从库中引用一个常量</h1><p id="663e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们来看看当从类库中引用<code class="fe mn mo mp mq b">const</code>时可能发生的一些奇怪的事情。</p><h2 id="2b42" class="mw la it bd lb mx my dn lf mz na dp lj ma nb nc ll me nd ne ln mi nf ng lp nh bi translated">这些项目</h2><p id="8237" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">创建新的。NET Framework控制台应用程序项目，名为SomeConsoleApp，并将类库添加到名为SomeLibrary的解决方案中:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/4dea051d9ac563ffa21903df155001f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ipmeojx7vSUOxOHt-eGlGA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">控制台应用程序和类库使用。净4.7.2</figcaption></figure><p id="a061" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">您的控制台应用程序的Program.cs类应包含以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="6cf7" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">在SomeLibrary项目中创建一个名为SomeClass的类，并粘贴以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h2 id="d6e5" class="mw la it bd lb mx my dn lf mz na dp lj ma nb nc ll me nd ne ln mi nf ng lp nh bi translated">运行应用程序</h2><p id="8b9a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">构建解决方案，然后运行SomeConsoleApp.exe，这可以在<code class="fe mn mo mp mq b">&lt;your project root folder&gt;\SomeConsoleApp\SomeConsoleApp\bin\Debug</code>中找到。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/a4976b710172233b902983ffd6d31c35.png" data-original-src="https://miro.medium.com/v2/resize:fit:528/format:webp/1*53hbFq-fF1VTvuR3jyLCYA.png"/></div></figure><p id="3e92" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">正如你所料，我们可以看到60的价值通过。</p><h2 id="ba32" class="mw la it bd lb mx my dn lf mz na dp lj ma nb nc ll me nd ne ln mi nf ng lp nh bi translated">更新和构建</h2><p id="c3cb" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在将SomeClass.cs中的值从60更新为70，保存该文件并在解决方案资源管理器中右键单击SomeLibrary，然后单击Build。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/b9efb70bb36e8c41c21fd105a507fbf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EAL3kT1baWg63CRq7j3Bpg.png"/></div></div></figure><h2 id="aebf" class="mw la it bd lb mx my dn lf mz na dp lj ma nb nc ll me nd ne ln mi nf ng lp nh bi translated">重新运行应用程序</h2><p id="1e53" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果您再次运行SomeConsoleApp.exe，您会注意到值没有改变:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/a4976b710172233b902983ffd6d31c35.png" data-original-src="https://miro.medium.com/v2/resize:fit:528/format:webp/1*53hbFq-fF1VTvuR3jyLCYA.png"/></div></figure><p id="4efe" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">这似乎不太直观，因为我们已经在控制台应用程序中引用了<code class="fe mn mo mp mq b">SomeClass.SomeConst</code>，并且我们已经重新构建了发生变化的项目，这是一个库。</p><h2 id="b64f" class="mw la it bd lb mx my dn lf mz na dp lj ma nb nc ll me nd ne ln mi nf ng lp nh bi translated">删除引用</h2><p id="763b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们看看如果删除项目引用会发生什么。</p><p id="1e11" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">转到<code class="fe mn mo mp mq b">&lt;your project root folder&gt;\SomeConsoleApp\SomeConsoleApp\bin\Debug</code>并删除SomeLibrary.dll:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/76f5736fa584830244dd502a811106af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*cpZEpYBjirp0ds3cXHmOcA.png"/></div></figure><h2 id="5984" class="mw la it bd lb mx my dn lf mz na dp lj ma nb nc ll me nd ne ln mi nf ng lp nh bi translated">重新运行应用程序</h2><p id="77f1" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果您再次运行SomeConsoleApp.exe，您会注意到该值仍然显示！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/a4976b710172233b902983ffd6d31c35.png" data-original-src="https://miro.medium.com/v2/resize:fit:528/format:webp/1*53hbFq-fF1VTvuR3jyLCYA.png"/></div></figure><h2 id="7fc4" class="mw la it bd lb mx my dn lf mz na dp lj ma nb nc ll me nd ne ln mi nf ng lp nh bi translated">这是怎么回事？</h2><p id="2e35" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在编译期间，<code class="fe mn mo mp mq b">SomeClass.SomeConst</code>的值直接嵌入CIL码中:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi no"><img src="../Images/2f87149e7520b7a087cb0d24da7d376a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*TsofXwqUYoMtaSXxxAb_7w.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">第13行显示了硬编码的值60(来自ILSpy的截图)</figcaption></figure><p id="b4ec" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">在第13行，您可以看到<code class="fe mn mo mp mq b">SomeClass.SomeConst</code>参考值已经被实际值60取代。</p><p id="25ca" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">下面是基于CIL生成的C#代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/b25fc7e78a2bf9674fc9fcde37794d93.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*n5Zdf9aN4wJhX1VwiUcWBA.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">显示硬编码60的C#代码(来自ILSpy的截图)</figcaption></figure><p id="f40c" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">编译器基本上是找到代码中引用<code class="fe mn mo mp mq b">const</code>的地方，直接用值替换它。</p><p id="def7" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">如果希望该值更新为70，则需要重新编译SomeConsoleApp。</p><h1 id="5ea3" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">有趣的事实</h1><p id="9a62" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated"><code class="fe mn mo mp mq b">const</code>值的这种直接嵌入导致了一些有趣的事实:</p><ul class=""><li id="7be0" class="nq nr it lt b lu mr lx ms ma ns me nt mi nu mm nv nw nx ny bi translated">您不能在带有<code class="fe mn mo mp mq b">const</code>声明的行上放置断点(因为该行在执行过程中实际上并不存在)。</li><li id="5e0c" class="nq nr it lt b lu nz lx oa ma ob me oc mi od mm nv nw nx ny bi translated">常量不需要在运行时为它们分配任何内存。</li><li id="3a0b" class="nq nr it lt b lu nz lx oa ma ob me oc mi od mm nv nw nx ny bi translated">你不能得到一个常数的地址。</li><li id="4ce2" class="nq nr it lt b lu nz lx oa ma ob me oc mi od mm nv nw nx ny bi translated">不能通过引用传递常数。</li></ul><h1 id="61e4" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">关于。NET 5.0？</h1><p id="fdb7" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果您使用。NET 5.0，并运行SomeConsoleApp.exe，您会得到这个错误(要查看这个错误，您需要打开。exe通过cmd):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/0eb4151aa19394e019c73b7f654574a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ShXWzR3H5wqr7Zfr"/></div></div></figure><p id="bd26" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">这是因为。NET 5.0会在<code class="fe mn mo mp mq b">\SomeLibrary\SomeConsoleApp\bin\Debug\net5.0</code>文件夹中生成一个名为SomeConsoleApp.deps.json的文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/308952b236b6b74b7a3a2e261b77fd9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*FCjA3IVpBvYWsrUGHGQtBA.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">显示SomeConsoleApp.deps.json</figcaption></figure><p id="b7af" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">该文件如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">对某库的引用</figcaption></figure><p id="45b7" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">如您所见，该文件包含对某个库的引用。</p><p id="9005" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">为了运行SomeConsoleApp.deps.json，您需要删除或重命名someconseleapp . deps . JSON</p><h1 id="657d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">摘要</h1><p id="8b30" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">由于常数的工作方式，以及可能出现的跨程序集版本问题，所以只对永远不会改变的值使用它们是很重要的。</p><h1 id="87d6" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">资源</h1><div class="og oh gp gr oi oj"><a href="https://www.oreilly.com/library/view/clr-via-c/9780735668737/" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd iu gy z fp oo fr fs op fu fw is bi translated">CLR via C#，第四版</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">深入挖掘并掌握公共语言运行库、C#和。网络开发。由编程专家领导…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">www.oreilly.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox ks oj"/></div></div></a></div></div></div>    
</body>
</html>