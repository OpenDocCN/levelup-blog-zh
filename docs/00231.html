<html>
<head>
<title>React Native: Implementing Browser-Based Authentication using Expo’s AuthSession Component</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React Native:使用Expo的AuthSession组件实现基于浏览器的认证</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/react-native-implementing-browser-based-authentication-using-expos-authsession-component-ffee25b50ae8?source=collection_archive---------0-----------------------#2018-10-12">https://levelup.gitconnected.com/react-native-implementing-browser-based-authentication-using-expos-authsession-component-ffee25b50ae8?source=collection_archive---------0-----------------------#2018-10-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/194498d76a1d55d4fdde9e54f7a4ae05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Ve1W3XgzRLvSLRinmiFmA.jpeg"/></div></div></figure><p id="ec6b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是我的书《反应本地烹饪书》的摘录，第二版，由Packt出版社出版，将于今年冬天出版。</p><p id="39cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本教程将介绍如何使用Expo的<code class="fe kx ky kz la b">AuthSession</code>组件在React本地应用中实现身份验证。有关如何使用Expo开发应用程序的更多信息，您可以阅读我以前的文章，<a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/expo-vs-react-native-cli-a-guide-to-bootstrapping-new-react-native-apps-6f0fcafee58f"> Expo vs React Native CLI:引导新React Native应用程序的指南</a>。</p><p id="2ac5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">AuthSession</code>建立在Expo的<code class="fe kx ky kz la b">WebBrowser</code>组件之上，该组件可用于通过嵌入在应用程序中的浏览器打开网站。典型的登录工作流包括四个步骤:</p><ol class=""><li id="aaa9" class="lc ld iq ka b kb kc kf kg kj le kn lf kr lg kv lh li lj lk bi translated">用户发起</li><li id="a7ac" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">Web浏览器打开登录页面</li><li id="03f7" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">身份验证提供程序在成功登录时提供重定向</li><li id="aa29" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">React本机应用程序处理重定向</li></ol><p id="271f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个应用程序中，我们将使用Spotify API通过用户登录获取我们应用程序的Spotify帐户信息。前往<a class="ae lb" href="https://beta.developer.spotify.com/dashboard/applications" rel="noopener ugc nofollow" target="_blank">https://beta.developer.spotify.com/dashboard/applications</a>创建一个新的Spotify开发帐户(如果你还没有的话)并创建一个新的Spotify应用程序。你可以给这个应用起任何你喜欢的名字。一旦用Spotify创建了应用程序，您将会在应用程序的信息中看到一个<strong class="ka ir">客户端ID </strong>字符串。在构建React本机应用程序时，我们将需要这个ID。</p><h1 id="da4e" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">做好准备</h1><p id="ee93" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">我们将通过在Expo中创建一个新的应用程序来开始构建这个项目。我将为我的应用程序使用名称<code class="fe kx ky kz la b">browser-based-auth</code>。</p><p id="ebb9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">重定向URI也需要在我们上面创建的Spotify应用程序白名单。重定向的url应该是<a class="ae lb" href="https://auth.expo.io/@YOUR_EXPO_USERNAME/YOUR_APP_SLUG." rel="noopener ugc nofollow" target="_blank">https://auth.expo.io/@YOUR_EXPO_USERNAME/YOUR_APP_SLUG.</a>的形式，因为我的Expo用户名是<code class="fe kx ky kz la b">warlyware</code>，并且因为我们正在构建的这个React原生应用程序被命名为<code class="fe kx ky kz la b">browser-based-auth</code>，所以我的重定向URI是<a class="ae lb" href="https://auth.expo.io/@warlyware/browser-based-auth." rel="noopener ugc nofollow" target="_blank">https://auth.expo.io/@warlyware/browser-based-auth.</a>请务必将其添加到Spotify应用程序设置中的重定向URIs列表。</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><a href="https://gitconnected.com"><div class="gh gi mt"><img src="../Images/26797da0642875dc5a034a11d5991f56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vLqV3O21wXUs-3CpOK9n9Q.png"/></div></a></figure><h1 id="4d15" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">怎么做</h1><p id="d9be" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">1.我们将从打开React本地项目根目录中的<code class="fe kx ky kz la b">App.js</code>文件开始。让我们删除所有的样板代码，以便我们可以一起从头开始。第一步是导入我们将使用的依赖项。</p><pre class="mu mv mw mx gt my la mz na aw nb bi"><span id="b763" class="nc lr iq la b gy nd ne l nf ng">import React, { Component } from 'react';<br/>import { TouchableOpacity, StyleSheet, Text, View } from 'react-native';<br/>import { AuthSession } from 'expo';<br/>import { FontAwesome } from '@expo/vector-icons';</span></pre><p id="9bce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.让我们也将客户机ID声明为一个常量，供以后使用。复制我们之前创建的Spotify应用程序的客户端ID，以便我们可以将其保存在CLIENT_ID常量中。</p><pre class="mu mv mw mx gt my la mz na aw nb bi"><span id="8e4b" class="nc lr iq la b gy nd ne l nf ng">const CLIENT_ID = Your-Spotify-App-Client-ID;</span></pre><p id="b453" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.让我们创建App类和初始的<code class="fe kx ky kz la b">state</code>。<code class="fe kx ky kz la b">userInfo</code>属性将保存我们从Spotify API收到的用户信息，<code class="fe kx ky kz la b">didError</code>是一个布尔值，用于跟踪登录期间是否发生了错误。</p><pre class="mu mv mw mx gt my la mz na aw nb bi"><span id="bd26" class="nc lr iq la b gy nd ne l nf ng">export default class App extends React.Component {<br/>  state = {<br/>    userInfo: null,<br/>    didError: false<br/>  };</span><span id="5932" class="nc lr iq la b gy nh ne l nf ng">  // Defined in following steps<br/>}</span></pre><p id="93a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.接下来，让我们定义用户登录Spotify的方法。<code class="fe kx ky kz la b">AuthSession</code>组件的<code class="fe kx ky kz la b">getRedirectUrl</code>方法提供了登录后返回React原生应用所需的重定向URL，这与我们在Spotify应用的<em class="kw">准备就绪</em>部分保存的重定向URI相同。然后，我们将在登录请求中使用重定向，我们将使用<code class="fe kx ky kz la b">AuthSession.startAsync</code>方法启动该请求，向Spotify端点传递一个属性设置为<code class="fe kx ky kz la b">authUrl</code>的options对象，以便通过应用程序授权用户数据。在本教程末尾的<em class="kw">部分有更多关于这个网址的信息。</em></p><pre class="mu mv mw mx gt my la mz na aw nb bi"><span id="d9ca" class="nc lr iq la b gy nd ne l nf ng">handleSpotifyLogin = async () =&gt; {<br/>  let redirectUrl = AuthSession.getRedirectUrl();<br/>  let results = await AuthSession.startAsync({<br/>    authUrl:<br/>    `<a class="ae lb" href="https://accounts.spotify.com/authorize?client_id=${CLIENT_ID" rel="noopener ugc nofollow" target="_blank">https://accounts.spotify.com/authorize?client_id=${CLIENT_ID</a>}<br/>    &amp;redirect_uri=${encodeURIComponent(redirectUrl)}<br/>    &amp;scope=user-read-email&amp;response_type=token`<br/>  });</span><span id="c422" class="nc lr iq la b gy nh ne l nf ng">// Defined in next step<br/>};</span></pre><p id="5ae7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">5.我们将点击Spotify端点进行用户认证的结果保存在本地变量<code class="fe kx ky kz la b">results</code>中。如果results对象的type属性返回除了<code class="fe kx ky kz la b">‘success’</code>之外的任何内容，那么就会发生错误，所以我们将相应地更新state的<code class="fe kx ky kz la b">didError</code>属性。否则，我们将使用从authorization获得的访问令牌来访问<code class="fe kx ky kz la b">/me</code>端点，以获取用户信息，我们将把这些信息保存到<code class="fe kx ky kz la b">this.state.userInfo</code>。</p><pre class="mu mv mw mx gt my la mz na aw nb bi"><span id="c270" class="nc lr iq la b gy nd ne l nf ng">handleSpotifyLogin = async () =&gt; {<br/>  if (results.type !== 'success') {<br/>    this.setState({ didError: true });<br/>  } else {<br/>    const userInfo = await axios.get(`<a class="ae lb" href="https://api.spotify.com/v1/me`" rel="noopener ugc nofollow" target="_blank">https://api.spotify.com/v1/me`</a>, {<br/>      headers: {<br/>        "Authorization": `Bearer ${results.params.access_token}`<br/>      }<br/>    });<br/>    this.setState({ userInfo: userInfo.data });<br/>  }<br/>};</span></pre><p id="3af5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">6.既然已经定义了auth相关的方法，让我们创建<code class="fe kx ky kz la b">render</code>函数。我们将使用<code class="fe kx ky kz la b">FontAwesome</code> Expo图标库来显示Spotify徽标，添加一个允许用户登录的按钮，并添加根据<code class="fe kx ky kz la b">this.state.didError</code>的值呈现错误或用户信息的方法。一旦在<code class="fe kx ky kz la b">state</code>的<code class="fe kx ky kz la b">userInfo</code>属性中保存了数据，我们还将禁用登录按钮。</p><pre class="mu mv mw mx gt my la mz na aw nb bi"><span id="b511" class="nc lr iq la b gy nd ne l nf ng">render() {<br/>  return (<br/>    &lt;View style={styles.container}&gt;<br/>      &lt;FontAwesome<br/>        name="spotify"<br/>        color="#2FD566"<br/>        size={128}<br/>      /&gt;<br/>      &lt;TouchableOpacity<br/>        style={styles.button}<br/>        onPress={this.handleSpotifyLogin}<br/>        disabled={this.state.userInfo ? true : false}<br/>      &gt;<br/>        &lt;Text style={styles.buttonText}&gt;<br/>          Login with Spotify<br/>        &lt;/Text&gt;<br/>      &lt;/TouchableOpacity&gt;<br/>      {this.state.didError ?<br/>        this.displayError() :<br/>        this.displayResults()<br/>      }<br/>    &lt;/View&gt;<br/>  );<br/>}</span></pre><p id="4d1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">7.接下来，让我们定义处理错误的JSX。该模板只是显示一条一般性的错误消息，指示用户应该再试一次。</p><pre class="mu mv mw mx gt my la mz na aw nb bi"><span id="a832" class="nc lr iq la b gy nd ne l nf ng">displayError = () =&gt; {<br/>  return (<br/>    &lt;View style={styles.userInfo}&gt;<br/>      &lt;Text style={styles.errorText}&gt;<br/>        There was an error, please try again.<br/>      &lt;/Text&gt;<br/>    &lt;/View&gt;<br/>  );<br/>}</span></pre><p id="dba5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">8.<code class="fe kx ky kz la b">displayResults</code>函数将是一个<code class="fe kx ky kz la b">View</code>组件，如果有userInfo保存到state，它将显示用户的图像、用户名和电子邮件地址，否则将提示用户登录。</p><pre class="mu mv mw mx gt my la mz na aw nb bi"><span id="b2ba" class="nc lr iq la b gy nd ne l nf ng">displayResults = () =&gt; {<br/>  { return this.state.userInfo ? (<br/>    &lt;View style={styles.userInfo}&gt;<br/>      &lt;Image<br/>        style={styles.profileImage}<br/>        source={ {'uri': this.state.userInfo.images[0].url} }<br/>      /&gt;<br/>      &lt;View&gt;<br/>        &lt;Text style={styles.userInfoText}&gt;<br/>          Username:<br/>        &lt;/Text&gt;<br/>        &lt;Text style={styles.userInfoText}&gt;<br/>          {this.state.userInfo.id}<br/>        &lt;/Text&gt;<br/>        &lt;Text style={styles.userInfoText}&gt;<br/>          Email:<br/>        &lt;/Text&gt;<br/>        &lt;Text style={styles.userInfoText}&gt;<br/>          {this.state.userInfo.email}<br/>        &lt;/Text&gt;<br/>      &lt;/View&gt;<br/>    &lt;/View&gt;<br/>  ) : (<br/>    &lt;View style={styles.userInfo}&gt;<br/>      &lt;Text style={styles.userInfoText}&gt;<br/>        Login to Spotify to see user data.<br/>      &lt;/Text&gt;<br/>    &lt;/View&gt;<br/>  )}<br/>}</span></pre><p id="db4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">9.这个食谱的样式很简单。它使用了灵活的分栏布局，应用了Spotify的黑色和绿色配色方案，并增加了字体大小和边距。</p><pre class="mu mv mw mx gt my la mz na aw nb bi"><span id="404d" class="nc lr iq la b gy nd ne l nf ng">const styles = StyleSheet.create({<br/>  container: {<br/>    flexDirection: 'column',<br/>    backgroundColor: '#000',<br/>    flex: 1,<br/>    alignItems: 'center',<br/>    justifyContent: 'space-evenly',<br/>  },<br/>  button: {<br/>    backgroundColor: '#2FD566',<br/>    padding: 20<br/>  },<br/>  buttonText: {<br/>    color: '#000',<br/>    fontSize: 20<br/>  },<br/>  userInfo: {<br/>    height: 250,<br/>    width: 200,<br/>    alignItems: 'center',<br/>  },<br/>  userInfoText: {<br/>    color: '#fff',<br/>    fontSize: 18<br/>  },<br/>  errorText: {<br/>    color: '#fff',<br/>    fontSize: 18<br/>  },<br/>  profileImage: {<br/>    height: 64,<br/>    width: 64,<br/>    marginBottom: 32<br/>  }<br/>});</span></pre><p id="318f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">10.现在，如果我们运行该应用程序，我们应该能够登录Spotify，并看到用于登录的帐户的相关图像、用户名和电子邮件地址！</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/283a807f38d80bb5497c723736c773b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*U4pEDDoALYYIc6k9.png"/></div></div></figure><h1 id="cfbc" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">它是如何工作的</h1><p id="68c7" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">在第4步中，我们创建了处理Spotify登录过程的方法。<code class="fe kx ky kz la b">AuthSession.startAsync</code>方法只需要一个由Spotify开发者文档提供的<code class="fe kx ky kz la b">authUrl</code>。所需的四个部分是客户端ID、用于处理来自Spotify的响应的重定向URI、指示应用程序请求的用户信息范围的范围参数，以及<code class="fe kx ky kz la b">token</code>的<code class="fe kx ky kz la b">response_type</code>参数。我们只需要来自用户的基本信息，所以我们请求了一个范围类型<code class="fe kx ky kz la b">user-read-email</code>。有关所有可用范围的信息，请查看位于<a class="ae lb" href="https://beta.developer.spotify.com/documentation/general/guides/scopes/" rel="noopener ugc nofollow" target="_blank">https://beta . developer . Spotify . com/documentation/general/guides/scopes/</a>的文档。</p><p id="5861" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在步骤5中，我们完成了Spotify登录处理程序。如果登录不成功，我们相应地更新<code class="fe kx ky kz la b">didError</code> on状态。如果成功了，我们就使用这个响应来访问Spotify API端点以获取用户数据[<a class="ae lb" href="https://api.spotify.com/v1/me" rel="noopener ugc nofollow" target="_blank">https://api.spotify.com/v1/me</a>]。根据Spotify的文档，我们用<code class="fe kx ky kz la b">Bearer ${results.params.access_token}</code>定义了get请求的授权头来验证请求。当这个请求成功时，我们将返回的用户数据存储在<code class="fe kx ky kz la b">userInfo</code>状态对象中，该对象将重新呈现UI并显示用户的信息。</p><p id="7340" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要深入了解Spotify的认证流程，您可以在<a class="ae lb" href="https://beta.developer.spotify.com/documentation/general/guides/authorization-guide/" rel="noopener ugc nofollow" target="_blank">https://beta . developer . Spotify . com/documentation/general/guides/authorization-guide/</a>找到该指南。</p><p id="2687" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你也可以在<a class="ae lb" href="https://github.com/warlyware/react-native-cookbook/tree/master/chapter-5/browser-based-auth" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/warlyware/react-native-cookbook/tree/master/chapter-5/browser-based-auth</a>的GitHub上看看这个教程的源代码。</p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><p id="58a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">如果您觉得这篇文章有帮助，请花点时间👏 👏 👏。你也可以</em> <a class="ae lb" href="https://medium.com/@warlyware" rel="noopener"> <em class="kw">关注我</em> </a> <em class="kw">获取更多关于React Native、Vue、JavaScript开发的文章。</em></p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><figure class="mu mv mw mx gt jr gh gi paragraph-image"><a href="http://levelup.gitconnected.com"><div class="ab gu cl nq"><img src="../Images/a5f9dfbe503d8543c6f72bdbef622101.png" data-original-src="https://miro.medium.com/v2/format:webp/1*E8lHUzxrIT5VDhu7fUS6gg.png"/></div></a></figure><div class="nr ns gp gr nt nu"><a href="https://gitconnected.com/learn/react-native" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd ir gy z fp nz fr fs oa fu fw ip bi translated">学习React Native -最佳React Native教程(2019) | gitconnected</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">10大React原生教程。课程由开发者提交并投票，使您能够找到最好的…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">gitconnected.com</p></div></div><div class="od l"><div class="oe l of og oh od oi jw nu"/></div></div></a></div></div></div>    
</body>
</html>