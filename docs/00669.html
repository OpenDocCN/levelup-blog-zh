<html>
<head>
<title>Rails — Nested Forms in Three Steps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Rails —分三步的嵌套表单</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/rails-nested-forms-in-three-steps-5580f0ad0e?source=collection_archive---------1-----------------------#2019-06-24">https://levelup.gitconnected.com/rails-nested-forms-in-three-steps-5580f0ad0e?source=collection_archive---------1-----------------------#2019-06-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/e178d3034f65d48448206c863cdf2365.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/0*dOpwwj3QrEg9T-9D"/></div></figure><p id="5e44" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">Rails充满了魔力。表单助手，尤其是构建直接链接到Ruby对象的表单的能力，是Rails的魅力之一，我很难理解。</p><p id="5077" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这是一个在rails中设置嵌套表单的快速指南。</p><p id="d160" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">首先，什么是嵌套表单？顾名思义，它是一种形式中的形式。更具体地说，嵌套表单创建或操作的模型不同于父表单的模型。</p><p id="b9b1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">假设我们有两个模型——主人和狗。一个主人可以养很多只狗，一只狗属于一个主人。</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="2538" class="le lf it la b gy lg lh l li lj">class Owner &lt; ActiveRecord::Base<br/> has_many :dogs<br/>end</span></pre><p id="6879" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">和</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="91c9" class="le lf it la b gy lg lh l li lj">class Dog &lt; ActiveRecord::Base<br/> belongs_to :owner<br/>end</span></pre><p id="c090" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">创建新狗的表单如下所示:</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="e5e0" class="le lf it la b gy lg lh l li lj">&lt;h1&gt;Create a new Dog:&lt;/h1&gt;</span><span id="d358" class="le lf it la b gy lk lh l li lj">&lt;%= form_for(@dog) do |f|%&gt;</span><span id="0cec" class="le lf it la b gy lk lh l li lj">  &lt;div&gt;<br/>    &lt;%= f.label :name%&gt;<br/>    &lt;%= f.text_field :name%&gt;<br/>  &lt;/div&gt;&lt;br&gt;<br/>	<br/>  &lt;div&gt;<br/>    &lt;%= f.label :breed%&gt;<br/>    &lt;%= f.text_field :breed%&gt;<br/>  &lt;/div&gt;&lt;br&gt;<br/>	<br/>  &lt;div&gt;<br/>    &lt;%= f.label :age%&gt;<br/>    &lt;%= f.text_field :age%&gt;<br/>  &lt;/div&gt;&lt;br&gt;<br/>	<br/>  &lt;div&gt;<br/>    &lt;label for="dog_owner_id"&gt;Select an owner:&lt;/label&gt;<br/>    &lt;%= f.collection_select :owner_id, owner.all, :id, :name, prompt: true%&gt;<br/>  &lt;/div&gt;&lt;br&gt;<br/>	<br/>  &lt;%= f.submit %&gt;<br/>	<br/>&lt;% end %&gt;</span></pre><p id="78b7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">上面的表单使用户能够从已经保存到数据库中的所有者中选择所有者，但是如果他们需要创建一个新的所有者呢？让用户意识到这一点，然后去另一个页面创建一个主人，然后回到这个页面创建狗，这将是一个糟糕的用户体验。嵌套表单拯救世界！</p><p id="ca72" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">第一步—型号</strong></p><p id="c619" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">将<code class="fe ll lm ln la b">accepts_nested_attributes_for</code>方法添加到模型中，在我们的例子中，我们的主表单是用于狗的。这是为指定的关联(所有者)定义属性编写器的类方法。你可以在<a class="ae lo" href="https://api.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html" rel="noopener ugc nofollow" target="_blank">这里</a>阅读。</p><p id="fcb5" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们的所有者类现在看起来像这样:</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="7578" class="le lf it la b gy lg lh l li lj">class Dog &lt; ActiveRecord::Base<br/> belongs_to :owner<br/> accepts_nested_attributes_for :owner<br/>end</span></pre><p id="56d9" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">步骤2 —查看</strong></p><p id="13e1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">接下来，我们需要通过添加嵌套表单来更新视图。为此，我们将使用<a class="ae lo" href="https://api.rubyonrails.org/v5.2.3/classes/ActionView/Helpers/FormHelper.html#method-i-fields_for" rel="noopener ugc nofollow" target="_blank"> </a> <code class="fe ll lm ln la b"><a class="ae lo" href="https://api.rubyonrails.org/v5.2.3/classes/ActionView/Helpers/FormHelper.html#method-i-fields_for" rel="noopener ugc nofollow" target="_blank">fields_for</a></code>，它像<code class="fe ll lm ln la b">form_for</code>一样产生一个FormBuilder对象。</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="46c4" class="le lf it la b gy lg lh l li lj">&lt;div&gt;<br/>  &lt;h3&gt;Or create a new owner:&lt;/h3&gt;<br/>  &lt;%= f.fields_for :owner, Owner.new do |owner_attributes|%&gt;<br/>      &lt;%= owner_attributes.label :name, "Owner Name:" %&gt;<br/>      &lt;%= owner_attributes.text_field :name %&gt;<br/>  &lt;% end %&gt;<br/>&lt;/div&gt;</span></pre><p id="2f69" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们更新后的表单如下所示:</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="4e80" class="le lf it la b gy lg lh l li lj">&lt;h1&gt;Create a new Dog:&lt;/h1&gt;</span><span id="4e83" class="le lf it la b gy lk lh l li lj">&lt;%= form_for(@dog) do |f|%&gt;</span><span id="6694" class="le lf it la b gy lk lh l li lj">  &lt;div&gt;<br/>    &lt;%= f.label :name%&gt;<br/>    &lt;%= f.text_field :name%&gt;<br/>  &lt;/div&gt;&lt;br&gt;<br/>	<br/>  &lt;div&gt;<br/>    &lt;%= f.label :breed%&gt;<br/>    &lt;%= f.text_field :breed%&gt;<br/>  &lt;/div&gt;&lt;br&gt;<br/>	<br/>  &lt;div&gt;<br/>    &lt;%= f.label :age%&gt;<br/>    &lt;%= f.text_field :age%&gt;<br/>  &lt;/div&gt;&lt;br&gt;<br/>	<br/>  &lt;div&gt;<br/>    &lt;label for="dog_owner_id"&gt;Select an owner:&lt;/label&gt;<br/>    &lt;%= f.collection_select :owner_id, owner.all, :id, :name, prompt: true%&gt;<br/>  &lt;/div&gt;&lt;br&gt;</span><span id="3c6b" class="le lf it la b gy lk lh l li lj">  &lt;div&gt;<br/>    &lt;h3&gt;Or create a new owner:&lt;/h3&gt;<br/>    &lt;%= f.fields_for :owner, Owner.new do |owner_attributes|%&gt;<br/>        &lt;%= owner_attributes.label :name, "Owner Name:" %&gt;<br/>        &lt;%= owner_attributes.text_field :name %&gt;<br/>    &lt;% end %&gt;<br/>  &lt;/div&gt;<br/>	<br/>  &lt;%= f.submit %&gt;<br/>	<br/>&lt;% end %&gt;</span></pre><p id="9c47" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">步骤3a —控制器</strong></p><p id="9e7e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">当用户提交原始表单时，控制器的动作是创建一只狗的新实例。对于嵌套表单，我们还需要创建一个新的所有者实例，并将该所有者与狗相关联。这是通过<code class="fe ll lm ln la b">build</code>方法完成的。</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="20c0" class="le lf it la b gy lg lh l li lj">class DogsController &lt; ApplicationController</span><span id="a39e" class="le lf it la b gy lk lh l li lj">  def new<br/>   @dog = Dog.new<br/>   @dog.build_owner <br/>  end</span><span id="0588" class="le lf it la b gy lk lh l li lj"> end</span></pre><p id="a145" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">步骤3b —控制器</strong></p><p id="37e0" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们还需要更新控制器中的强参数。在狗模型中使用<code class="fe ll lm ln la b">accepts_nested_attributes_for</code>给这个类增加了一个新的属性。</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="8f32" class="le lf it la b gy lg lh l li lj">class DogsController &lt; ApplicationController</span><span id="5446" class="le lf it la b gy lk lh l li lj">  def  dog_params<br/>    params.require(:dog).permit(:name, :breed, :age owner_attributes: [:name])<br/>  end<br/>	<br/>end</span></pre></div></div>    
</body>
</html>