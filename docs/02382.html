<html>
<head>
<title>Running SQL Queries from a ‘.sql’ file in NodeJS (SQLite)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从运行SQL查询。NodeJS (sqlite)中的“SQL”文件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/running-sql-queries-from-an-sql-file-in-a-nodejs-app-sqlite-a927f0e8a545?source=collection_archive---------3-----------------------#2020-03-10">https://levelup.gitconnected.com/running-sql-queries-from-an-sql-file-in-a-nodejs-app-sqlite-a927f0e8a545?source=collection_archive---------3-----------------------#2020-03-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/29601bd86a14c238762f0ba8e0f2ce10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*jirS8XKKK0GaflQSNW7b0g.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">信用:https://i0.wp.com</figcaption></figure><p id="faa9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章中，我将展示如何让我的NodeJS应用程序使用<code class="fe kw kx ky kz b">sqlite3</code>和NodeJS’<code class="fe kw kx ky kz b">fs</code>API从一个SQL文件运行我的SQL查询。即使您没有使用SQLite，您可能仍然会发现我在这里使用的技术很有帮助(您可以跳过SQLite特定的部分)。</p><p id="757a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">背景</strong>:我需要使用一个SQL文件来启动并运行我的SQLite数据库，这个文件正好有195，369行SQL代码！我需要将这些查询发送到数据库，最好的方式是通过编程，但是怎么做呢？</p><p id="c090" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你发现自己处于这种情况，这篇文章是关于我如何能够安全并按时完成这个挑战的。</p><p id="7722" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是我采取的步骤。</p><p id="ee62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">步骤1 </strong>，安装名为<code class="fe kw kx ky kz b"><a class="ae la" href="https://www.npmjs.com/package/sqlite3" rel="noopener ugc nofollow" target="_blank">sqlite3</a></code>的NPM包(此处阅读sqlite3文档<a class="ae la" href="https://github.com/mapbox/node-sqlite3/wiki/API" rel="noopener ugc nofollow" target="_blank">)。<code class="fe kw kx ky kz b">sqlite3</code>帮助您连接到SQLite数据库并运行查询。</a></p><p id="7246" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">步骤2 </strong>，在你要运行SQL的JS文件中，导入/要求<code class="fe kw kx ky kz b">sqlite3</code>和<code class="fe kw kx ky kz b">fs</code>(不，你不需要安装这个。自带NodeJS)。</p><p id="907e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">步骤3，</strong>设置内存数据库连接，如下所示:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="0877" class="lj lk iq kz b gy ll lm l ln lo">let <em class="lp">db</em> = new sqlite3.Database('mydatabase', (<em class="lp">err</em>) =&gt; {<br/>   if (<em class="lp">err</em>){<br/>       return console.error(<em class="lp">err</em>.<em class="lp">message</em>);<br/>   }<br/>   console.log('Connected to the in-memory SQlite database.');<br/>});</span></pre><p id="ef1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">紧密联系，像这样:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="a543" class="lj lk iq kz b gy ll lm l ln lo"><em class="lp">db</em>.close((<em class="lp">err</em>) =&gt; {<br/>  if (<em class="lp">err</em>) {<br/>    return console.error(<em class="lp">err</em>.<em class="lp">message</em>);<br/>  }<br/>  console.log('Closed the database connection.');<br/>});</span></pre><p id="8d5a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">第四步，</strong>通过<code class="fe kw kx ky kz b">node db.js</code>或别的什么运行文件，看看设置是否真的有效。</p><p id="29bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">步骤5 </strong>，使用<code class="fe kw kx ky kz b">fs</code>将SQL查询作为字符串读取并解析到JS文件中，如下所示:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="24f9" class="lj lk iq kz b gy ll lm l ln lo">const <em class="lp">dataSql</em> = <em class="lp">fs</em>.readFileSync('./data.sql').toString();</span></pre><p id="3ff8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，我可以在<code class="fe kw kx ky kz b">dataSql</code>变量中使用全部195，369行SQL查询。</p><p id="33a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我是这样把它们放在一起的:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="75a4" class="lj lk iq kz b gy ll lm l ln lo">// Require or import the dependencies</span><span id="ea24" class="lj lk iq kz b gy lq lm l ln lo">const <em class="lp">fs</em> = require('fs');<br/>const <em class="lp">sqlite3</em> = require('sqlite3').verbose();<br/></span><span id="dfca" class="lj lk iq kz b gy lq lm l ln lo">// Read the SQL file</span><span id="0401" class="lj lk iq kz b gy lq lm l ln lo">const <em class="lp">dataSql</em> = <em class="lp">fs</em>.readFileSync('./data.sql').toString();</span><span id="d40d" class="lj lk iq kz b gy lq lm l ln lo"><br/>// Setup the database connection</span><span id="23c3" class="lj lk iq kz b gy lq lm l ln lo">let <em class="lp">db</em> = new sqlite3.Database('mydatabase', (<em class="lp">err</em>) =&gt; {<br/>  if (<em class="lp">err</em>) {<br/>    return console.error(<em class="lp">err</em>.<em class="lp">message</em>);<br/>  }</span><span id="730f" class="lj lk iq kz b gy lq lm l ln lo">  console.log('Connected to the in-memory SQLite database.');<br/>});</span><span id="b639" class="lj lk iq kz b gy lq lm l ln lo"><br/>// Convert the SQL string to array so that you can run them one at a time.<br/>// You can split the strings using the query delimiter i.e. `;` in // my case I used `);` because some data in the queries had `;`.</span><span id="f88d" class="lj lk iq kz b gy lq lm l ln lo">const <em class="lp">dataArr</em> = <em class="lp">dataSql</em>.toString().split(');');<br/></span><span id="e99f" class="lj lk iq kz b gy lq lm l ln lo">// db.serialize ensures that your queries are one after the other depending on which one came first in your `dataArr`</span><span id="9071" class="lj lk iq kz b gy lq lm l ln lo"><em class="lp">db</em>.serialize(() =&gt; {</span><span id="613b" class="lj lk iq kz b gy lq lm l ln lo">  // db.run runs your SQL query against the DB</span><span id="5d3a" class="lj lk iq kz b gy lq lm l ln lo"><em class="lp">  db</em>.run('PRAGMA foreign_keys=OFF;');</span><span id="cc35" class="lj lk iq kz b gy lq lm l ln lo"><em class="lp">  db</em>.run('BEGIN TRANSACTION;');</span><span id="3be9" class="lj lk iq kz b gy lq lm l ln lo"><em class="lp">  // Loop through the `dataArr` and db.run each query<br/>  dataArr</em>.forEach((<em class="lp">query</em>) =&gt; {<br/>    if(<em class="lp">query</em>) {<br/>      // Add the delimiter back to each query before you run them<br/>      // In my case the it was `);`</span><span id="a557" class="lj lk iq kz b gy lq lm l ln lo">      <em class="lp">query</em> += ');';<br/>      <em class="lp">db</em>.run(<em class="lp">query</em>, (<em class="lp">err</em>) =&gt; {<br/>         if(<em class="lp">err</em>) throw <em class="lp">err</em>;<br/>      });<br/>    }<br/>  });</span><span id="a7dc" class="lj lk iq kz b gy lq lm l ln lo"><em class="lp">  db</em>.run('COMMIT;');<br/>});<br/></span><span id="80c9" class="lj lk iq kz b gy lq lm l ln lo">// Close the DB connection</span><span id="2c16" class="lj lk iq kz b gy lq lm l ln lo"><em class="lp">db</em>.close((<em class="lp">err</em>) =&gt; {<br/>  if (<em class="lp">err</em>) {<br/>    return console.error(<em class="lp">err</em>.<em class="lp">message</em>);<br/>  }<br/>  console.log('Closed the database connection.');<br/>});</span></pre><p id="0fd2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你阅读上面的代码有困难，这里有一个Github要点给你。</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lr ls l"/></div></figure><p id="61be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是啊。就是这样！在运行<code class="fe kw kx ky kz b">node index.js</code>时，查询运行，我需要的东西被加载到我的SQLite数据库中。</p><p id="7c68" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你有任何问题或建议，请在下面给我留言。如果你觉得这篇文章有趣，别忘了鼓励我；)</p><p id="15a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lp">感谢阅读！</em></p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><p id="dfaa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">鸣谢:我发现这个网站非常有用<a class="ae la" href="https://www.sqlitetutorial.net/sqlite-nodejs/" rel="noopener ugc nofollow" target="_blank">https://www.sqlitetutorial.net/sqlite-nodejs/</a>。看看这个。</p></div></div>    
</body>
</html>