<html>
<head>
<title>Google Tag Manager Server-Side — How To Manage Custom Vendor Tags</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google标签管理器服务器端——如何管理定制的供应商标签</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/google-tag-manager-server-side-how-to-manage-custom-vendor-tags-21bef51bc89e?source=collection_archive---------1-----------------------#2020-09-17">https://levelup.gitconnected.com/google-tag-manager-server-side-how-to-manage-custom-vendor-tags-21bef51bc89e?source=collection_archive---------1-----------------------#2020-09-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0e3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">分析社区同意:谷歌标签管理服务器端的<a class="ae kl" href="https://blog.google/products/marketingplatform/360/improve-performance-and-security-server-side-tagging/" rel="noopener ugc nofollow" target="_blank">发布是行业的一个重要里程碑。它不仅强调了向服务器端分析技术的范式转变，还可能彻底颠覆组织收集数据和构建数据模型的方式。</a></p><p id="9959" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文不是对服务器端标签管理的概念及其术语的介绍。Simo Ahava 和Julius Fedorovicius 精彩地详细报道了这一点。本教程通过引导您完成<strong class="jp ir">一个关于如何为不属于Googleverse </strong>的定制供应商配置GTM服务器端的基本示例，建立在这些基础之上。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/c88ee2b08c78833d1ea01f11164e1ec2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eZj0NkqN9-f2YVmhMqUehw.png"/></div></div></figure><p id="c92d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于该产品目前仍处于早期阶段，其功能和可用文档主要集中在Google环境中。内置的客户端、标签和变量只关注通过服务器端容器实现Google Analytics。虽然这对于设置您的GA测量非常有益，但部署服务器端标签管理的首要目标应该是让组织<strong class="jp ir">在服务器上集中管理多个不同的标签</strong>以显著减少客户端负载。</p><p id="641f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我将带您浏览一个示例工作流，它说明了当<strong class="jp ir">的目标是为一个定制供应商</strong>收集、准备和分发数据时，GTM服务器端设置的不同组件是如何协同工作的，例如Internet、Snowplow或脸书的Adobe Analytics。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ky"><img src="../Images/7d642e6a0a7eef66c3fe1f90fea7a886.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I33_QkvP-eXwgQwZrToajg.png"/></div></div></figure><h1 id="bde9" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">它是如何工作的</h1><p id="4009" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">对于这个例子，我想管理互联网上<a class="ae kl" href="https://www.atinternet.com/en/" rel="noopener ugc nofollow" target="_blank">的测量请求。正确处理数据需要特定的命中结构。它由集合域、路径和查询字符串中的多个跟踪参数组成:</a></p><p id="f650" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mc md me mf b">https://collectionDomain.com/hit.xiti?param1=value1&amp;param2=value2...</code></p><p id="4fc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想使用GTM服务器端收集数据，将其解析为事件模型，并使用该事件数据将测量结果从服务器发送到AT Internet，而不是直接从浏览器发送到AT Internet服务器。</p><h2 id="774b" class="mg la iq bd lb mh mi dn lf mj mk dp lj jy ml mm ln kc mn mo lr kg mp mq lv mr bi translated">1 -将数据发送到GTM服务器端容器</h2><p id="7d30" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">大多数测量工具的跟踪数据是通过客户端浏览器中的JavaScript获取的，并发送给供应商收集服务器。虽然每个供应商在这里都需要一个特定的原始hit结构(例如<a class="ae kl" href="https://developers.google.com/analytics/devguides/collection/protocol/v1" rel="noopener ugc nofollow" target="_blank"> Google的测量协议</a>)，但是一个设计良好的GTM服务器端设置可以让您在一个通用的服务器容器跟踪请求中收集不同供应商端点所需的所有数据。这个跟踪请求可以由任何类型的JavaScript生成。对于下面的hit(由AT Internet Smartttag库生成)，请注意，默认的<strong class="jp ir">集合域</strong>需要用您的GTM容器的域替换为<strong class="jp ir">:</strong></p><pre class="kn ko kp kq gt ms mf mt mu aw mv bi"><span id="b80e" class="mg la iq mf b gy mw mx l my mz"><strong class="mf ir">https://gtm-abcde12-a1aaa.uc.r.appspot.com</strong>/hit.xiti?s=123456&amp;idclient=12345678&amp;col=2&amp;ts=1600256597557&amp;vtag=5.22.0&amp;ptag=js&amp;r=1368x912x24x24&amp;re=675x770&amp;hl=12x43x17&amp;lng=en-GB&amp;events=[{"name":"page.display","data":{"page":"Nicolas Hinternesch - Music","adblock":"active"}}]</span></pre><h2 id="1a02" class="mg la iq bd lb mh mi dn lf mj mk dp lj jy ml mm ln kc mn mo lr kg mp mq lv mr bi translated">2 -构建自定义客户端模板</h2><p id="a59d" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">对于传入的GA请求，有内置的客户端可用。但是，它们不适用于结构不同的请求——如上图所示。因此，我们必须构建自己的客户端模板，能够处理您计划管理的请求:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi na"><img src="../Images/ec295184a0095c6c7ecf591fc7af3962.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ENSj8zAURKUm2DWGNpGJw.png"/></div></div></figure><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="c6ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了执行客户端和标签模板中的大多数代码，您需要使用Google提供的<a class="ae kl" href="https://developers.google.com/tag-manager/serverside/api" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">服务器端标签API</strong></a>。您还必须在模板编辑器中授予相关的<strong class="jp ir">权限</strong>。</p><p id="8373" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于我们简单的工作流程，客户必须完成一些基本任务:</p><p id="0fb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">声明请求<br/> </strong>指定您希望这个客户机响应哪些请求，并声明匹配的请求(第17行)。</p><p id="45f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">将数据存储在事件模型中<br/> </strong>客户端的主要任务之一就是将传入的数据存储在结构化的事件模型中。因此，各种标签可以利用这个统一的事件数据来填充它们的传出跟踪请求。<br/>虽然有内置的API来自动构建传入的GA点击并将数据解析到事件模型，但当您使用其他供应商的端点时，这必须通过自定义代码来完成。这可以通过将来自查询字符串的输入数据存储在一个<em class="nd">事件</em>对象中来实现(第23行)。<br/>此外，我们可以从传入的请求中检索头值(第13行)，并将它们添加到事件对象中(第37行)。IP地址也是如此，它可以通过<em class="nd"> getRemoteAddress </em> API获得(第15行)。通过在事件数据中传递它们，我们可以在以后使用它们来覆盖我们发出的请求的请求头。</p><p id="d886" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">运行容器</strong></p><p id="56bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在预览模式下监控客户端存储的事件数据:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ne"><img src="../Images/82e6a4609939a8de69fb4bded6296174.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MGtg-Z3-_cazzixWhDgE_Q.png"/></div></div></figure><h2 id="f4b2" class="mg la iq bd lb mh mi dn lf mj mk dp lj jy ml mm ln kc mn mo lr kg mp mq lv mr bi translated">3 -构建自定义标记模板</h2><p id="38f4" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">从现在开始，<em class="nd">常规</em> GTM逻辑再次发挥作用。我们可以创建触发器和标记来管理我们的测量调用。在这种情况下，我希望我的标记在每次我的定制客户端处理请求时被触发:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nf"><img src="../Images/93c492b39cd91fccb2a8dc8b993d7f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0mvwBIwzxfZaGB-hKYNfjA.png"/></div></div></figure><p id="26de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，GA有一个内置的标签模板。对于其他供应商，我们必须编写一个自定义的:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ng"><img src="../Images/1237522a1b04734e15088cf732f5a43b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7-0viMAhelTzuglUfF7TTQ.png"/></div></div></figure><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="8fd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自定义标签模板必须执行以下任务:</p><p id="335e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">从用户<br/> </strong>处获取想要的采集域，这是数据应该发送到的域。它可以在标签创建期间从用户的输入字段中收集:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nh"><img src="../Images/dad3401e6d6e0536d2361d7027eb75f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qT-gbTTe-X09N0YjyO6Hjw.png"/></div></div></figure><p id="be9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">构建跟踪请求<br/> </strong>为了将请求URL(第11行)放在一起，我们需要检索集合域(第8行)以及来自事件对象的数据(第9行)。虽然这对于一个基本的请求来说已经足够了，但是我们还可以向发出的请求添加一些重要的<strong class="jp ir">头</strong>(第24行)。这些头值由客户端获取并存储。这就是像推荐人或用户代理这样的信息被处理并转发给定制供应商的方式。此外，您可以覆盖传出请求的IP地址，以匹配传入请求中的实际用户IP地址。请注意，这取决于定制供应商是否以及如何接受覆盖IP地址。常见的技术包括<em class="nd"> x-forwarded-for </em>头(第27行)或一个URL参数。但这取决于供应商。如果我们不覆盖像IP或UA这样的值，传出的请求默认发送服务器容器的值。还请注意，管理IP地址被视为PII。一些供应商倾向于默认截断IP，但一定要注意隐私合规性。<br/>请注意，所建立的URL<em class="nd">而非</em>必须是为了在互联网上获得成功。除了根据<a class="ae kl" href="https://developers.atinternet-solutions.com/general-en/craft-your-hit/" rel="noopener ugc nofollow" target="_blank"> ATI hit制作标准</a>修补URL，我们还可以参考<a class="ae kl" href="https://docs.adobe.com/content/help/en/analytics/implementation/home.html" rel="noopener ugc nofollow" target="_blank"> Adobe Analytics实施指南</a>或任何其他供应商文档来使用相同的事件数据并构建符合不同请求模式的hit URL。</p><p id="bf15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">向供应商端点发送GET请求<br/> </strong>最后一步，我们可以向URL发出GET请求，以便最终将数据传递给定制的供应商端点(第29行)。确保包含标题(第31行)。</p><p id="380a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就行了。对于每个事件，可以在预览模式下查看标签发送的传出请求:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ni"><img src="../Images/435d367fde6a047b0db6cc86628380c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8oavN8GYU3y0_rZU2XgYOA.png"/></div></div></figure><p id="46d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，这只是一个<strong class="jp ir">裸机实现</strong>。一个正常运行的生产设置将包括其他关键方面，比如服务器端cookie处理和一个(最好是)定制域。但是本教程应该让您对通过服务器端GTM配置定制供应商度量时所涉及的一般过程和组件有一个相当好的理解。</p><h1 id="9889" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">关于GTM服务器端的结束语</h1><p id="8215" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">总之，强调服务器端跟踪和服务器端标签管理之间的<strong class="jp ir">差异很重要</strong>。我经常听到这些术语互换使用。但是，在考虑服务器端实现的各种选项时，理解这种差异是很重要的:</p><p id="452f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">服务器端追踪</strong>基于直接从提供网页内容的服务器发送追踪点击。这样，整个数据收集过程就不会通过任何客户端技术。当然，这里的数据可用性非常有限。</p><p id="84df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">然而，服务器端标签管理</strong>提供了一个很好的解决方案，可以集中管理和分发所有不同供应商终端收集的数据，同时尽可能减少客户端负载。客户端仍在收集数据。<strong class="jp ir">但是</strong>不是让客户端将100个不同的点击分配给100个不同的服务，而是浏览器可以在一个请求中将数据发送到一个自定义域，同时在服务器上处理对所有端点的分发。<br/> <br/>我个人最喜欢这一重新设计的流程，因为它推动组织走向<strong class="jp ir">智能数据收集</strong>和<strong class="jp ir">统一数据模型</strong>。</p><p id="a03d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">他们是<strong class="jp ir">被迫</strong> …</p><ul class=""><li id="2e4f" class="nj nk iq jp b jq jr ju jv jy nl kc nm kg nn kk no np nq nr bi translated">…思考哪些信息实际上<strong class="jp ir">需要包含在</strong>跟踪请求中，以满足不同测量供应商的需求</li><li id="2970" class="nj nk iq jp b jq ns ju nt jy nu kc nv kg nw kk no np nq nr bi translated">…创建一种<strong class="jp ir">独立于供应商的方法，在事件级别构建此数据</strong>，使其可用于所有端点。这将证明在数据治理方面非常有益。</li></ul><p id="772e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nd"> —如果您对这个过程有疑问，发现了代码中的一个bug，或者您只是想讨论分析:请随时联系</em><a class="ae kl" href="https://hinternesch.com/?at_medium=affiliate&amp;at_campaign=Medium&amp;at_creation=GTMSSCustomVendorTags&amp;at_format=link" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="nd"/></strong></a><strong class="jp ir"><em class="nd">。</em></strong><em class="nd">——</em></p><h1 id="5036" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">更新</h1><p id="45aa" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">关于步骤2:构建定制客户端模板，我已经写得更详细了。你可以在<a class="ae kl" href="https://github.com/NHinternesch/gtm-server-client-custom-event-parser" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到新文章<a class="ae kl" href="https://nhinternesch.medium.com/google-tag-manager-server-side-parsing-event-data-from-any-custom-vendor-request-4d2ea7f25991" rel="noopener">这里</a>和相应的GTM服务器端客户端模板。</p></div></div>    
</body>
</html>