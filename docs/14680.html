<html>
<head>
<title>How to Build a DAO with Truffle</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用块菌造刀</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-build-a-dao-with-truffle-82bf95f2a8a4?source=collection_archive---------8-----------------------#2022-12-16">https://levelup.gitconnected.com/how-to-build-a-dao-with-truffle-82bf95f2a8a4?source=collection_archive---------8-----------------------#2022-12-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/2ee52b6cfcc859eb47b5f39b954c2c3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iASaOxdJxIPqSkcBxnTlGg.jpeg"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">在<a class="ae jg" href="https://unsplash.com/s/photos/partnership?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae jg" href="https://unsplash.com/es/@varpap?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Vardan Papikyan </a>拍摄的照片</figcaption></figure><h2 id="f4b6" class="jh ji jj bd b dl jk jl jm jn jo jp dk jq translated" aria-label="kicker paragraph">咖啡店里的编码</h2><div class=""/><div class=""><h2 id="d8c9" class="pw-subtitle-paragraph kp js jj bd b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dk translated">亲身体验Ganache和Truffle套件</h2></div><p id="dde1" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">自从小本智(Satoshi Nakomoto)在他2009年的开创性白皮书中介绍了比特币和区块链以来，创新的数量令人震惊。如今，我们有了加密货币、NFT和其他无需中介就能创造、拥有和转移的数字资产。</p><p id="5a1c" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">然而，也许区块链和智能合同取得的最重大进步之一是治理和工作的未来。前述技术使<strong class="lj jt">、</strong>也称为<a class="ae jg" href="https://consensys.net/blog/blockchain-explained/what-is-a-dao-and-how-do-they-work/" rel="noopener ugc nofollow" target="_blank">、<strong class="lj jt"> DAOs </strong>、</a>成为可能。</p><p id="888b" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">Dao是由社区领导的实体，没有中央权威。想想公司，但全球化，由每个成员控制和拥有，并有智能合同来执行链上的规则。Dao允许来自世界各地的人们走到一起，实现一个共同的目标，甚至在这个过程中因他们的贡献而获得报酬。</p><p id="1361" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">Dao已经被用来维护和管理我们这个时代一些最激动人心的Web3项目。一些例子包括<a class="ae jg" href="https://compound.finance/" rel="noopener ugc nofollow" target="_blank">复合道</a>，它决定其同名的借出协议如何操作；KlimaDAO ，通过碳资产支持的令牌解决气候变化问题；以及<a class="ae jg" href="https://www.fwb.help/" rel="noopener ugc nofollow" target="_blank"> FWB </a>，旨在塑造web3的文化景观。</p><p id="6df7" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在本文中，我们将看看DAO是如何工作的，现有的DAO的类型，以及DAO的组件。然后，我们将使用<a class="ae jg" href="https://trufflesuite.com/docs/ganache/" rel="noopener ugc nofollow" target="_blank"> Ganache </a>和<a class="ae jg" href="https://trufflesuite.com/" rel="noopener ugc nofollow" target="_blank"> Truffle套件</a>构建我们自己的全功能、链上治理DAO。</p><h1 id="e353" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">Dao是如何工作的？</h1><p id="3af1" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">如前所述，Dao是一种机制，它允许多个人走到一起，为一个共同的目标而努力。DAO成员通过使用治理令牌在区块链上投票和处理事务来实现这一点。</p><p id="5759" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在引擎盖下，Dao只不过是智能合约的集合。即使是最简单的Dao通常也有以下三个合同:</p><ol class=""><li id="9a16" class="na nb jj lj b lk ll ln lo lq nc lu nd ly ne mc nf ng nh ni bi translated"><strong class="lj jt">治理令牌</strong> <br/>一个<a class="ae jg" href="https://ethereum.org/en/developers/docs/standards/tokens/erc-20/" rel="noopener ugc nofollow" target="_blank"> ERC-20 </a>或一个具有投票权的ERC-721令牌。在大多数情况下，每个代币代表一票。你拥有的代币越多，你对某个特定决定的影响力就越大。</li><li id="71fb" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">管理者 <br/>一个智能契约，负责创建提案，允许成员使用他们的令牌对提案进行投票，并根据投票结果执行提案。</li><li id="818c" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated"><strong class="lj jt">主DAO或国库</strong> <br/>智能合约持有资金和DAO的数据，由管理者根据投票结果进行修改。</li></ol><p id="5391" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">概括地说，Dao有两种风格:链上治理和链外治理。</p><p id="d7e0" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">前者通常在网上进行投票，并要求参与者支付汽油费才能投票。后者进行离线投票，并取消参与者的汽油费——但引入了现在必须信任的非链元素。</p><h1 id="08f7" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">构建具有链上治理的道</h1><p id="8b68" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">现在我们已经了解了DAOs，让我们来构建自己的DAOs吧！</p><p id="2073" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在本教程中，我们将使用<a class="ae jg" href="https://trufflesuite.com/" rel="noopener ugc nofollow" target="_blank"> Truffle套件</a>构建一个简单但功能齐全的DAO。为此，我们将构建以下内容:</p><ol class=""><li id="b3b5" class="na nb jj lj b lk ll ln lo lq nc lu nd ly ne mc nf ng nh ni bi translated">实施ERC 20治理令牌的智能合约</li><li id="0174" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">赋予上述令牌投票权的调控器，允许创建、投票和执行提案。</li><li id="1ca8" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">持有DAO的状态和资金的DAO契约</li><li id="ab43" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">一个模拟脚本，用于空投治理令牌、创建提案、进行投票以及执行投票结果。在这里，我们将创建一个提议，向贡献者发送几个DAO令牌作为奖励。</li></ol><h1 id="f85a" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">步骤1:安装NPM和节点</h1><p id="223f" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">我们将使用node和npm来构建我们的项目。如果您的本地机器上没有安装这些软件，您可以在这里<a class="ae jg" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank">安装</a>。</p><p id="2a66" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">要确保一切正常运行，请运行以下命令:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="2822" class="nx me jj nt b be ny nz l oa ob">$ node -v</span></pre><p id="289d" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">如果一切顺利，您应该会看到node的版本号。</p><h1 id="6cba" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">步骤2:创建一个节点项目并安装依赖项</h1><p id="9dd1" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">让我们通过运行以下命令来设置一个空的项目存储库:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="7cc9" class="nx me jj nt b be ny nz l oa ob">$ mkdir truffle-dao &amp;&amp; cd truffle-dao<br/>$ npm init -y</span></pre><p id="beba" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们将使用EVM智能合约的世界级开发环境和测试框架<a class="ae jg" href="https://trufflesuite.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="lj jt"> Truffle </strong> </a>来构建和部署我们的智能合约。它将为我们提供完成教程所需的所有工具。</p><p id="0f9f" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">运行以下命令安装Truffle:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="4d8c" class="nx me jj nt b be ny nz l oa ob">$ npm install -g truffle</span></pre><p id="677b" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们现在可以通过运行以下命令来创建一个准系统Truffle项目:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="983e" class="nx me jj nt b be ny nz l oa ob">$ truffle init</span></pre><p id="8481" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">要检查一切是否正常，请运行:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="d2e0" class="nx me jj nt b be ny nz l oa ob">$ truffle - version</span></pre><p id="adaf" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们现在已经成功配置了松露。接下来，让我们安装<a class="ae jg" href="https://www.openzeppelin.com/" rel="noopener ugc nofollow" target="_blank"><strong class="lj jt">OpenZeppelin</strong></a><strong class="lj jt"/>contracts包。这是一组经过实战检验的智能合同，它们将使我们能够访问ERC-20治理令牌和链上调控器基础实现，在此基础上，我们将构建我们的组件合同。</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="af70" class="nx me jj nt b be ny nz l oa ob">$ npm install -s @openzeppelin/contracts</span></pre><p id="35c4" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">记住，智能合约是不可变的。一旦它们被部署在mainnet上，就不能被修改。因此，在部署之前确保它们能够工作是很重要的。为了解决这个问题，我们将在以太坊区块链的本地实例上测试我们的DAO的功能。这是由Truffle的<a class="ae jg" href="https://trufflesuite.com/ganache/" rel="noopener ugc nofollow" target="_blank"> <strong class="lj jt"> Ganache </strong> </a>实现的——一键创建个人和本地以太坊区块链。</p><p id="15e7" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">通过运行以下命令进行全局安装:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="4a12" class="nx me jj nt b be ny nz l oa ob">$ npm install -g ganache</span></pre><h1 id="5a9a" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">步骤3:创建ERC 20治理令牌</h1><p id="279f" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">我们准备开始编码了！</p><p id="0cda" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在你喜欢的代码编辑器(比如VS代码)中打开truffle项目。在<code class="fe oc od oe nt b">contracts</code>文件夹中，创建一个新文件，并将其命名为<code class="fe oc od oe nt b">GovToken.sol</code>。</p><p id="2a4b" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们将编写一个简单的实现投票功能的ERC 20协议。我们还将允许合同的所有者铸造新的代币，对供应没有任何限制。</p><p id="2d7b" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">理想情况下，我们应该将这个令牌契约的所有权转移到我们将在后面的步骤中创建的主DAO契约，并允许DAO成员对新令牌的创建进行投票。在典型的DAO中，让一个人/钱包拥有所有的控制权并不是一个好的做法。然而，为了保持简单和快速，我们将坚持将所有权分配给正在部署的钱包。</p><p id="1a15" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">将以下代码添加到<code class="fe oc od oe nt b">GovToken.sol</code>:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="9d2c" class="nx me jj nt b be ny nz l oa ob">// SPDX-License-Identifier: MIT<br/>pragma solidity ^0.8.9;<br/><br/>import "@openzeppelin/contracts/token/ERC20/ERC20.sol";<br/>import "@openzeppelin/contracts/access/Ownable.sol";<br/>import "@openzeppelin/contracts/token/ERC20/extensions/draft-ERC20Permit.sol";<br/>import "@openzeppelin/contracts/token/ERC20/extensions/ERC20Votes.sol";<br/><br/>contract GovToken is ERC20, Ownable, ERC20Permit, ERC20Votes {<br/>  constructor() ERC20("GovToken", "GT") ERC20Permit("GovToken") {}<br/><br/>  function mint(address to, uint256 amount) public onlyOwner {<br/>    _mint(to, amount);<br/>  }<br/><br/>  // The following functions are overrides required by Solidity.<br/>  function _afterTokenTransfer(address from, address to, uint256 amount)<br/>    internal<br/>    override(ERC20, ERC20Votes)<br/>  {<br/>    super._afterTokenTransfer(from, to, amount);<br/>  }<br/><br/>  function _mint(address to, uint256 amount)<br/>    internal<br/>    override(ERC20, ERC20Votes)<br/>  {<br/>  super._mint(to, amount);<br/>  }<br/><br/>  function _burn(address account, uint256 amount)<br/>    internal<br/>    override(ERC20, ERC20Votes)<br/>  {<br/>  super._burn(account, amount);<br/>  }<br/>}</span></pre><p id="df87" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">通过运行以下命令，确保合同编译正确:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="162e" class="nx me jj nt b be ny nz l oa ob">$ truffle compile</span></pre><h1 id="8a94" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">步骤4:创建调控器</h1><p id="e5a8" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">在<code class="fe oc od oe nt b">contracts</code>文件夹中，创建一个新文件，命名为<code class="fe oc od oe nt b">DaoGovernor.sol</code>。</p><p id="ca1a" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们将创建一个实现<a class="ae jg" href="https://wizard.openzeppelin.com/#governor" rel="noopener ugc nofollow" target="_blank"> OpenZeppelin的链上治理</a>的调控器契约，其灵感来自于Compound的治理模型。该合同将允许我们创建提案，对提案进行投票，并在其驻留的区块链上执行任何代码。</p><p id="ba6c" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">将以下代码添加到<code class="fe oc od oe nt b">DaoGovernor.sol</code>。</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="2313" class="nx me jj nt b be ny nz l oa ob">// SPDX-License-Identifier: MIT<br/>pragma solidity ^0.8.9;<br/><br/>import "@openzeppelin/contracts/governance/Governor.sol";<br/>import "@openzeppelin/contracts/governance/extensions/GovernorCountingSimple.sol";<br/>import "@openzeppelin/contracts/governance/extensions/GovernorVotes.sol";<br/>import "@openzeppelin/contracts/governance/extensions/GovernorVotesQuorumFraction.sol";<br/><br/>contract DaoGovernor is Governor, <br/>         GovernorCountingSimple, <br/>         GovernorVotes,<br/>         GovernorVotesQuorumFraction {<br/><br/>  constructor(IVotes _token)<br/>    Governor("DaoGovernor")<br/>    GovernorVotes(_token)<br/>    GovernorVotesQuorumFraction(4)<br/>  {}<br/><br/>  function votingDelay() public pure override returns (uint256) {<br/>    return 1; // 1 block<br/>  }<br/><br/>  function votingPeriod() public pure override returns (uint256) {<br/>    return 5; // 5 blocks<br/>  }<br/><br/>  // The following functions are overrides required by Solidity.<br/>  function quorum(uint256 blockNumber)<br/>    public<br/>    view<br/>    override(IGovernor, GovernorVotesQuorumFraction)<br/>    returns (uint256)<br/>  {<br/>    return super.quorum(blockNumber);<br/>  }<br/>}</span></pre><p id="0b96" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">关于我们的州长，有几件事需要注意:</p><ol class=""><li id="273c" class="na nb jj lj b lk ll ln lo lq nc lu nd ly ne mc nf ng nh ni bi translated">构造函数接受一个<code class="fe oc od oe nt b">token</code> <em class="of"> </em>作为参数。我们将在这里传递上一步中创建的治理令牌，以便在这个调控器中赋予它投票权。</li><li id="b9bf" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">我们已经将<code class="fe oc od oe nt b">votingDelay</code> <em class="of"> </em>设置为一个块。这意味着对提案的投票将在创建提案的街区之后的一个街区开始。</li><li id="a4f0" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">我们将<code class="fe oc od oe nt b">votingPeriod</code> <em class="of"> </em>设置为五个块。这意味着投票将只在五个街区内开放(大约1分钟)。在现实世界的Dao中，这个数字通常设置为一周。</li><li id="5acc" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated"><code class="fe oc od oe nt b">quorumFraction</code> <em class="of"> </em>已经设置为4%。这意味着至少有4%的投票者必须投<em class="of">是</em>才能通过提案。</li></ol><p id="4cc3" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">请随意试验这些数字，并根据您的使用情况修改它们。</p><p id="72f5" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">再次运行以下命令，确保合同编译正确:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="7ddd" class="nx me jj nt b be ny nz l oa ob">$ truffle compile</span></pre><h1 id="e1ea" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">步骤5:创建主DAO契约</h1><p id="3749" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">我们需要创建的最终契约代表主DAO，并且通常保存DAO的状态和/或资金。这个道通常也是总督契约所拥有的，转移资金或者修改状态的函数都标有<code class="fe oc od oe nt b">onlyOwner</code>。</p><p id="2ef5" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们将通过在我们的DAO契约中只存储一个数字，并编写一个修改其值的函数来简化事情。</p><p id="aa4f" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在<code class="fe oc od oe nt b">contracts</code>文件夹中创建一个名为<code class="fe oc od oe nt b">Dao.sol</code>的新文件，并添加以下代码:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="f7be" class="nx me jj nt b be ny nz l oa ob">// SPDX-License-Identifier: MIT<br/><br/>pragma solidity ^0.8.9;<br/><br/>import "@openzeppelin/contracts/access/Ownable.sol";<br/><br/>contract Dao is Ownable {<br/>  uint public daoVal;<br/><br/>  constructor(address _govContract) {<br/>    transferOwnership(_govContract);<br/>  }<br/><br/>  function updateValue(uint256 _newVal) public onlyOwner {<br/>    daoVal = _newVal;<br/>  }<br/>}</span></pre><p id="ad8c" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">请注意，在部署时，我们将合同的所有权转移给了我们的调控器合同。</p><p id="a99e" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">像往常一样，通过运行以下命令来确保合同正在编译:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="6c92" class="nx me jj nt b be ny nz l oa ob">$ truffle compile</span></pre><h1 id="da8e" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">步骤6:更新Truffle配置文件</h1><p id="8340" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">为了在Ganache上部署和运行我们的合同，我们需要用以下内容更新<code class="fe oc od oe nt b">truffle.config.js</code>文件:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="674d" class="nx me jj nt b be ny nz l oa ob">module.exports = {<br/>  networks: {<br/>    development: {<br/>      host: "127.0.0.1",<br/>      port: 8545,<br/>      network_id: "*"<br/>    },<br/>  },<br/>  compilers: {<br/>    solc: {<br/>      version: "0.8.13",<br/>    }<br/>  }<br/>};</span></pre><h1 id="b216" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">第七步:模拟刀</h1><p id="01a5" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">我们已经准备好部署DAO，并通过它执行提议。</p><p id="f9c1" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">通常情况下，在像Goerli这样的测试网上测试一个DAO是很困难的，因为它的核心功能通常需要多方长期合作。幸运的是，使用Ganache，我们可以通过在本地旋转以太坊实例来模拟时间旅行和多个钱包。</p><p id="531b" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">通过打开一个新的终端并运行以下命令来启动ganache实例:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="d87c" class="nx me jj nt b be ny nz l oa ob">$ ganache</span></pre><p id="9b6c" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在migrations文件夹中，创建一个新文件<code class="fe oc od oe nt b">1_simulation.js</code>。这些是我们将模拟的步骤:</p><ol class=""><li id="6e67" class="na nb jj lj b lk ll ln lo lq nc lu nd ly ne mc nf ng nh ni bi translated">创建三个钱包:所有者、投票者1和投票者2。</li><li id="8429" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">部署ERC-20合同。</li><li id="2332" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">铸造100个代币到三个钱包，并自我委派每个代币的投票权。</li><li id="8309" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">使用ERC-20合约作为投票令牌来部署调控器合约。</li><li id="4165" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">部署DAO协定，将所有权分配给调控器。</li><li id="a90d" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">所有者创建一个建议，将DAO值更改为42。</li><li id="2f05" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">1号选民和2号选民投赞成票。</li><li id="77d1" class="na nb jj lj b lk nj ln nk lq nl lu nm ly nn mc nf ng nh ni bi translated">业主在提案成功后执行提案。</li></ol><p id="18fb" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这里发生了很多事情！将以下代码添加到上述文件中:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="7085" class="nx me jj nt b be ny nz l oa ob">// Import necessary libraries<br/>const ethers = require('ethers');<br/><br/>// Proposal states as defined by OpenZeppelin/Compound<br/>oz_states = ['Pending', 'Active', 'Canceled', 'Defeated',<br/>             'Succeeded', 'Queued', 'Expired', 'Executed'];<br/><br/>// Ganache localhost URL<br/>const url = "http://localhost:8545";<br/>const provider = new ethers.providers.JsonRpcProvider(url);<br/><br/>// Helper function to fast forward blocks<br/>const ff_blocks = async (n) =&gt; {<br/>  for (let i = 0; i &lt; n; i++) {<br/>    await provider.send('evm_mine');<br/>  }<br/>  console.log("\nMoved", n, "blocks\n");<br/>}<br/><br/>// Helper function to get current block<br/>const getBlock = async () =&gt; {<br/>  const blockNum = await provider.getBlockNumber();<br/>  console.log("Block:", blockNum);<br/>  return blockNum;<br/>}<br/><br/>// Helper function to get proposal state<br/>const getProposalState = async (gov, proposalId) =&gt; {<br/>  let propState = await gov.state(proposalId);<br/>  console.log("Proposal State:", oz_states[propState.toNumber()]);<br/>}<br/><br/>// Getting three wallets from Ganache provider<br/>const owner = provider.getSigner(0);<br/>const voter1 = provider.getSigner(1);<br/>const voter2 = provider.getSigner(2);<br/><br/>// Get instances of all three contracts<br/>const tokenContract = artifacts.require("GovToken");<br/>const govContract = artifacts.require("DaoGovernor");<br/>const daoContract = artifacts.require("Dao");<br/><br/>module.exports = async function (deployer) {<br/>  // Deploy the governance token contract<br/>  await deployer.deploy(tokenContract);<br/>  const token = await tokenContract.deployed();<br/>  console.log("Token Contract deployed to:", token.address);<br/><br/>  // Get addresses of all three accounts<br/>  const ow = await owner.getAddress();<br/>  const v1 = await voter1.getAddress();<br/>  const v2 = await voter2.getAddress();<br/><br/>  // Mint 100 tokens to owner, voter1, and voter2<br/>  await token.mint(ow, 100);<br/>  await token.mint(v1, 100);<br/>  await token.mint(v2, 100);<br/>  console.log("Minted 100 tokens to owner, voter1, and voter2", "\n");<br/><br/>  // Delegate voting power to themselves<br/>  await token.delegate(ow, { from: ow });<br/>  await token.delegate(v1, { from: v1 });<br/>  await token.delegate(v2, { from: v2 });<br/>  <br/>  // Deploy the governor contract<br/>  await deployer.deploy(govContract, token.address);<br/>  const gov = await govContract.deployed();<br/>  console.log("Governor contract deployed to:", gov.address, "\n");<br/><br/>  // Deploy the dao contract<br/>  await deployer.deploy(daoContract, gov.address);<br/>  const dao = await daoContract.deployed();<br/>  console.log("DAO contract deployed to:", dao.address, "\n");<br/><br/>  // Owner creates a proposal to change value to 42<br/>  let proposalFunc = dao.contract.methods.updateValue(42).encodeABI();<br/>  let proposalDesc = "Updating DAO value to 42";<br/>  console.log("Proposing:", proposalDesc);<br/>  let proposalTrxn = await gov.propose(<br/>    [dao.address],<br/>    [0],<br/>    [proposalFunc],<br/>    proposalDesc,<br/>  );<br/><br/>  // Move past voting delay<br/>  await ff_blocks(1)<br/>  <br/>  // Get proposal ID and make proposal active<br/>  let proposalId = proposalTrxn.logs[0].args.proposalId;<br/>  console.log("Proposal ID:", proposalId.toString());<br/>  await getProposalState(gov, proposalId);<br/><br/>  // Voter 1 and voter 2 vote in favor<br/>  let vote = await gov.castVote(proposalId, 1, { from: v1 });<br/>  console.log("V1 has voted in favor.")<br/>  vote = await gov.castVote(proposalId, 1, { from: v2 });<br/>  console.log("V2 has voted in favor.")<br/><br/>  // Move 5 blocks<br/>  await ff_blocks(5);<br/><br/>  // Get final result<br/>  console.log("Final Result");<br/>  await getProposalState(gov, proposalId);<br/><br/>  // Execute task<br/>  let desHash = ethers.utils.id(proposalDesc);<br/>  execute = await gov.execute(<br/>    [dao.address],<br/>    [0],<br/>    [proposalFunc],<br/>    desHash<br/>  );<br/>  console.log("\nExecuting proposal on DAO")<br/><br/>  // Check if value on dao has changed<br/>  const daoVal = await dao.daoVal.call();<br/>  console.log("daoVal:", daoVal.toNumber());<br/>};</span></pre><p id="0bbd" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">现在，让我们使用以下命令运行这个模拟:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="fd10" class="nx me jj nt b be ny nz l oa ob">$ truffle migrate --quiet</span></pre><p id="8bb9" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">如果一切顺利，您应该会看到如下所示的输出:</p><pre class="no np nq nr gt ns nt nu bn nv nw bi"><span id="7b19" class="nx me jj nt b be ny nz l og ob">Token Contract deployed to: 0x21d530ED509D0b44F94b5896Fb63BDa2d8943E4e<br/>Minted 100 tokens to owner, voter1, and voter2<br/><br/>Governor contract deployed to: 0x1C63D60Dcb50015d3D9598c45F48C7De16E0f925<br/><br/>DAO contract deployed to: 0xFC952D50576064C882bE9E724C5136F774B8f66e<br/><br/>Proposing: Updating DAO value to 42<br/><br/>Moved 1 blocks<br/><br/>Proposal ID: 89287417867871262838116386769359148381852036852071370084586471483495168348362<br/>Proposal State: Pending<br/>V1 has voted in favor.<br/>V2 has voted in favor.<br/><br/>Moved 5 blocks<br/><br/>Final Result<br/>Proposal State: Succeeded<br/><br/>Executing proposal on DAO<br/>daoVal: 42</span></pre><p id="a503" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">请注意，在成功传递和执行建议后，DAO值更改为42。</p><h1 id="47ec" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">结论</h1><p id="978f" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">Dao是区块链最伟大的创新之一。他们有潜力在塑造未来的工作中发挥巨大的作用。他们能够将陌生人聚集在一起，并为陌生人的贡献支付报酬，而不管他们的地理位置如何，这使他们比传统的同行具有明显的优势。</p><p id="ab6f" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在本教程中，您已经学习了Dao是什么以及它们是如何工作的。然后，您部署了一个全功能的DAO，并执行了提案的整个生命周期。为什么不试着打造自己的？</p></div></div>    
</body>
</html>