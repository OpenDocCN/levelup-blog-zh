<html>
<head>
<title>Using AWS Parameters and Secrets Lambda Extension</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS参数和秘密Lambda扩展</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-aws-parameters-and-secrets-lambda-extension-e61dd6a41110?source=collection_archive---------5-----------------------#2022-10-28">https://levelup.gitconnected.com/using-aws-parameters-and-secrets-lambda-extension-e61dd6a41110?source=collection_archive---------5-----------------------#2022-10-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="de4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将了解如何使用"<a class="ae kl" href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/retrieving-secrets_lambda.html" rel="noopener ugc nofollow" target="_blank"> AWS参数和秘密λ</a>"扩展。这个扩展允许在Lambda函数的生命周期中请求和缓存秘密和参数，而不需要使用SDK，并允许我们自己处理缓存。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/96c50d0a504ae781cb03cc8da591f532.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*JqF5Uxwt-c895JGjALzHcg.png"/></div></figure><p id="3304" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将构建一个引用并使用这个扩展的Lambda示例。在IaC端，我们将使用CloudFormation来使用这个扩展，作为Lambda的一个层添加。</p><h2 id="20b3" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">TL；速度三角形定位法(dead reckoning)</h2><p id="b018" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">你可以在这里找到完整的回购协议👉<a class="ae kl" href="https://github.com/ziedbentahar/aws-parameters-and-secrets-lambda-extension-sample" rel="noopener ugc nofollow" target="_blank">https://github . com/ziedbentahar/AWS-parameters-and-secrets-lambda-extension-sample</a></p><h2 id="ce29" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">关于Lambda扩展</h2><p id="4031" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">Lambda扩展可以和Lambda函数一起运行支持工具。一般来说，这些扩展涵盖了安全性和可观察性等问题。</p><p id="12fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它们在内部作为lambda进程的一部分运行，或者在外部作为执行环境中的另一个进程运行，并且可以访问lambda生命周期事件，从而允许在功能执行的特定点执行动作(<em class="ls">例如</em>在lambda运行时初始化时检索秘密)。</p><p id="8d67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为一个<a class="ae kl" href="https://learn.microsoft.com/en-us/azure/architecture/patterns/sidecar" rel="noopener ugc nofollow" target="_blank">边车</a>，lambda扩展不需要改变你的lambda功能代码。它们以λ层的形式提供。</p><h2 id="fcc2" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">使用扩展</h2><p id="d014" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">AWS参数和秘密扩展公开内部HTTP端点来检索秘密或参数值。</p><p id="ed45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，要获得名为<code class="fe lt lu lv lw b">some-third-party-api-key </code>的秘密的值，我们需要:</p><ul class=""><li id="5c11" class="lx ly iq jp b jq jr ju jv jy lz kc ma kg mb kk mc md me mf bi translated">直接在lambda代码中查询这个端点<code class="fe lt lu lv lw b">GET: http://localhost:2773/secretsmanager/get?secretId=some-third-party-api-key</code>。<code class="fe lt lu lv lw b">2773</code>是扩展本地HTTP服务器的默认端口，这可以通过定义扩展使用的环境变量<code class="fe lt lu lv lw b">PARAMETERS_SECRETS_EXTENSION_HTTP_PORT</code>来更改。当查询这个端点时，我们需要将这个头<code class="fe lt lu lv lw b">X-Aws-Parameters-Secrets-Token</code>设置为<code class="fe lt lu lv lw b">AWS_SESSION_TOKEN</code>环境变量的值。</li><li id="4400" class="lx ly iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">授予lambda执行角色对<code class="fe lt lu lv lw b">some-third-party-api-key</code>机密的<code class="fe lt lu lv lw b">secretsManager:GetSecretValue</code>权限</li></ul><p id="9895" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">缓存机密值已经由该扩展处理。默认缓存TTL值为<code class="fe lt lu lv lw b">300 seconds</code>。通过给<code class="fe lt lu lv lw b">SECRECTS_MANAGER_TTL</code>环境变量设置一个值，可以定义一个自定义的TTL。</p><p id="2311" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以通过<a class="ae kl" href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/retrieving-secrets_lambda.html" rel="noopener ugc nofollow" target="_blank">这个链接</a>获得该扩展支持的参数和环境变量的完整列表。</p><h2 id="8cd8" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">我们要建造什么？</h2><p id="55fe" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">为了演示扩展的用法，我们将构建一个API，提供给定位置(城市名称和国家)的天气预报和空气质量。我们将使用<a class="ae kl" href="https://openweathermap.org/" rel="noopener ugc nofollow" target="_blank"> OpenWeather </a> Api作为地理编码和天气提供者。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/723115d176c65962ed2618cf0bbdf0ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Y0-PGD3P9a3VaBx45aQ4w.png"/></div></div></figure><p id="9022" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个非常基本的架构:一个AWS Lambda，一个API网关和一个包含OpenWeather API的API密钥的秘密。</p><p id="92ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用Lambda代码的节点运行时和类型脚本。</p><h2 id="a134" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">让我们看看代码</h2><p id="0dfc" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">“获取天气和空气质量”lambda非常简单。它从请求上下文中获取城市和国家，并调用<code class="fe lt lu lv lw b">getWeatherAndAirQualityForCity</code></p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="571e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lt lu lv lw b">getWeatherAndAirQualityForCity</code>然后会调用OpenWeather API。它需要秘密中存储的API密钥。</p><p id="3caa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">这里我们如何在Lambda代码中使用AWS参数和秘密扩展</strong>👇</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="aa3b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在这里找到完整的lambda代码<a class="ae kl" href="https://github.com/ziedbentahar/aws-parameters-and-secrets-lambda-extension-sample/tree/main/src/backend/lambdas/get-weather-and-air-quality-by-location" rel="noopener ugc nofollow" target="_blank"/></p><h2 id="7de4" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">创建Lambda资源并使用扩展层</h2><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="056b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">相关位</strong>:</p><p id="c2ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了在Lambda执行环境中使用扩展，我们需要在<code class="fe lt lu lv lw b">Layers</code>列表中添加扩展的ARN。</p><p id="3029" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于每个地区都有不同的ARN，我们将扩展ARNs声明为地区地图:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="4460" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">关于秘密</strong></p><p id="e883" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将把秘密名称作为环境变量<code class="fe lt lu lv lw b">OPEN_WEATHER_API_KEY_SECRET_NAME </code>注入，这个lambda函数需要<code class="fe lt lu lv lw b">allow</code> <code class="fe lt lu lv lw b">secretsManager:GetSecretValue</code>策略才能读取秘密:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="a4bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在这里找到这个lambda函数的完整云模板</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h2 id="63a7" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">包扎</h2><p id="3936" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">AWS parameters and secrets扩展是lambda生态系统的一个很好的补充，但对于基本用例来说可能不需要它(<em class="ls">例如</em>在Lambda启动时简单地调用SDK在一些用例中可能就足够了)</p><p id="23ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">⚠️ <strong class="jp ir">重要提示:</strong>在撰写本文时，该扩展在某些地区不支持ARM架构的Lambda。</p><p id="18a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在这里找到完整的CI/CD Github动作工作流程的完整应用程序👉<a class="ae kl" href="https://github.com/ziedbentahar/aws-parameters-and-secrets-lambda-extension-sample" rel="noopener ugc nofollow" target="_blank">https://github . com/ziedbentahar/AWS-parameters-and-secrets-lambda-extension-sample</a></p><p id="47d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">更新:如果您正在寻找一个dotnet示例，我也创建了一个示例应用程序</strong>:<strong class="jp ir"/><a class="ae kl" href="https://github.com/ziedbentahar/aws-parameters-and-secrets-lambda-extension-dotnet-sample" rel="noopener ugc nofollow" target="_blank">https://github . com/ziedbentahar/AWS-parameters-and-secrets-lambda-extension-dot net-sample</a></p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h2 id="ddb4" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">进一步阅读</h2><div class="mz na gp gr nb nc"><a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/retrieving-secrets_lambda.html" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd ir gy z fp nh fr fs ni fu fw ip bi translated">在AWS Lambda函数中使用AWS机密管理器机密</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">您可以使用AWS参数和Secrets Lambda扩展在Lambda中检索和缓存AWS Secrets Manager机密…</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><div class="mz na gp gr nb nc"><a href="https://docs.aws.amazon.com/lambda/latest/dg/using-extensions.html" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd ir gy z fp nh fr fs ni fu fw ip bi translated">使用Lambda扩展</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">你可以使用Lambda扩展来扩充你的Lambda函数。例如，使用Lambda扩展来集成…</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><div class="mz na gp gr nb nc"><a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd ir gy z fp nh fr fs ni fu fw ip bi translated">Lambda扩展API</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">Lambda函数作者使用扩展将Lambda与他们首选的监控、可观察性…</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">docs.aws.amazon.com</p></div></div><div class="nl l"><div class="nm l nn no np nl nq ks nc"/></div></div></a></div></div></div>    
</body>
</html>