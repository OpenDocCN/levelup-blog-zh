<html>
<head>
<title>Manage your AWS Lambda Layers with IaC</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用IaC管理您的AWS Lambda层</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/manage-your-aws-lambda-layers-with-iac-4094e75f5ae8?source=collection_archive---------1-----------------------#2021-06-03">https://levelup.gitconnected.com/manage-your-aws-lambda-layers-with-iac-4094e75f5ae8?source=collection_archive---------1-----------------------#2021-06-03</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="56aa" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">拯救世界的无服务器框架和平台</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/948a7eeb483538e1129eb327a2d6709c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8HZ1rEshqj1fNE2K"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kz" href="https://unsplash.com/@cruik?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> A Cruikshank </a>拍照</figcaption></figure><p id="d9ba" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在构建应用程序时，我们努力实现运行速度更快的自动化，以便开发人员可以尽快看到他们的更改。使用AWS Lambda可以让开发人员更关注业务逻辑，而不是如何修补服务器。</p><p id="5ee2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">AWS Lambda的一个限制是部署包的大小，目前限制在50MB。如果开发人员正在安装软件包以使他们的代码工作，这可能是一个问题，这正是Lambda层的救援之处。</p><blockquote class="lw lx ly"><p id="d6f9" class="la lb lz lc b ld le jv lf lg lh jy li ma lk ll lm mb lo lp lq mc ls lt lu lv in bi translated"><a class="ae kz" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html" rel="noopener ugc nofollow" target="_blank">Lambda层是一个. zip文件档案，可以包含额外的代码或数据。层可以包含库、自定义运行时、数据或配置文件。层促进代码共享和职责分离，以便您可以更快地迭代编写业务逻辑。</a></p></blockquote><h1 id="4006" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">但是我们如何将Lambda层添加到我们的自动化过程中呢？</h1></div><div class="ab cl mv mw hy mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="in io ip iq ir"><p id="70b7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">通过组合<a class="ae kz" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>和<a class="ae kz" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>，我们可以轻松管理我们的Lambda层，并在此过程中加快我们的部署过程，而不会影响我们开发人员的工作效率。</p><p id="5fdf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="lz">以下假设你了解无服务器框架和Terraform的基础知识。</em></p><p id="4f46" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要使用无服务器框架定义您的层，您需要在您的<code class="fe nc nd ne nf b">serverless.yml</code>文件中添加以下内容:</p><pre class="kk kl km kn gu ng nf nh ni aw nj bi"><span id="1d01" class="nk me iu nf b gz nl nm l nn no">layers:<br/>  myCustomLayer:<br/>    path: layers/my-custom-layer<br/>    name: myCustomLayer<br/>    compatibleRuntimes:<br/>     - nodejs14.x</span></pre><p id="99ce" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="lz">你可以使用</em><a class="ae kz" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html" rel="noopener ugc nofollow" target="_blank"><em class="lz">AWS Lambda</em></a><em class="lz">支持的任何运行时。</em></p><p id="9c90" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以上意味着您的层代码或库应该位于路径<code class="fe nc nd ne nf b">layers/my-custom-layer</code>中，并根据<a class="ae kz" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html" rel="noopener ugc nofollow" target="_blank">选择的运行时</a>遵循正确的文件结构。</p><p id="042d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在你可能会问为什么我们要结合无服务器框架和Terraform。答案是，我发现命令<code class="fe nc nd ne nf b">sls package</code>对于创建我们的Lambda函数/层的包部署非常有用，然后使用Terraform进行部署。</p><p id="d279" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要使用Terraform创建图层，您需要添加以下内容:</p><pre class="kk kl km kn gu ng nf nh ni aw nj bi"><span id="d019" class="nk me iu nf b gz nl nm l nn no">resource "aws_lambda_layer_version" "my_custom_layer" {<br/>  filename   = "path/to/layer/zip/file"<br/>  layer_name = myCustomLayer<br/>  source_code_hash = filebase64sha256("path/to/layer/zip/file")<br/>  compatible_runtimes = ["nodejs14.x"]<br/>}</span></pre><p id="2482" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在Lambda函数中引用:</p><pre class="kk kl km kn gu ng nf nh ni aw nj bi"><span id="d9cc" class="nk me iu nf b gz nl nm l nn no">resource "aws_lambda_function" "my_custom_function" {<br/>  filename = "path/to/lambda/zip/file"<br/>  function_name = "myCustomFunction"<br/>  role = aws_iam_role.role.arn<br/>  handler = "handler"<br/>  source_code_hash = filebase64sha256("path/to/lambda/zip/file")<br/>  layers = [aws_lambda_layer_version.my_custom_layer.arn]<br/>  runtime = "nodejs14.x"<br/>  memory_size = 1024<br/>  timeout = 30<br/>}</span></pre><h1 id="b2e5" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">Lambda层的自动化过程现在已经完成。</h1></div><div class="ab cl mv mw hy mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="in io ip iq ir"><p id="3dbe" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果您进行了部署，但Lambda图层文件夹没有任何更改，Terraform将不会为您的图层创建新版本。如果有变化，它将更新版本，您的Lambda函数将正确引用新版本。</p><p id="96dc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果层的运行时是Node.js，这就是如何用Bash脚本部署您的解决方案:</p><pre class="kk kl km kn gu ng nf nh ni aw nj bi"><span id="d1e8" class="nk me iu nf b gz nl nm l nn no">echo -e "\n--- Install layers packages---\n"<br/>cd layers/myCustomLayer/nodejs<br/>npm install<br/>cd ../../..</span><span id="c6d6" class="nk me iu nf b gz np nm l nn no">echo -e "\n--- Packaging lambda ---\n"<br/>sls package</span><span id="c995" class="nk me iu nf b gz np nm l nn no">echo -e "\n--- Applying terraform ---\n"<br/>cd infrastructure<br/>terraform init -input=false<br/>terraform apply -input=false -auto-approve<br/>cd ../</span></pre><p id="7793" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这里有一个<a class="ae kz" href="https://github.com/jagonzalr/manage-lambda-layers" rel="noopener ugc nofollow" target="_blank">的完整例子</a>。回购的代码创建了一个小API，使用<a class="ae kz" href="https://momentjs.com/" rel="noopener ugc nofollow" target="_blank"> Moment.js </a>返回当前日期和时间。基础设施构建了一个带有API Gateway的端点，一个包含NPM包<code class="fe nc nd ne nf b">moment</code>的Lambda层和一个使用该层并返回日期和时间的Lambda函数。</p><p id="8b42" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">部署解决方案后，您可以在浏览器中使用如下URL调用API:</p><pre class="kk kl km kn gu ng nf nh ni aw nj bi"><span id="418f" class="nk me iu nf b gz nl nm l nn no"><a class="ae kz" href="https://nxdpqb3lcd.execute-api.us-east-1.amazonaws.com/dev/getCurrentDateTime" rel="noopener ugc nofollow" target="_blank">https://[unique-id].execute-api.[aws-region].amazonaws.com/dev/getCurrentDateTime</a></span></pre><p id="1a1b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">响应应该类似于:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nq"><img src="../Images/e70de691c7f592db851bce0608c58d31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cghw9tOxAZI9nuLiIC0_wA.png"/></div></div></figure></div><div class="ab cl mv mw hy mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="in io ip iq ir"><p id="07b5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">希望你喜欢这篇文章，并保持自动化和节省时间🎉</p><div class="nr ns gq gs nt nu"><a href="https://blog.jagonzalr.com/membership" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fp"><div class="nw ab nx cl cj ny"><h2 class="bd iv gz z fq nz fs ft oa fv fx it bi translated">加入我的介绍链接媒体-何塞安东尼奥冈萨雷斯罗德里格斯</h2><div class="ob l"><h3 class="bd b gz z fq nz fs ft oa fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oc l"><p class="bd b dl z fq nz fs ft oa fv fx dk translated">blog.jagonzalr.com</p></div></div><div class="od l"><div class="oe l of og oh od oi kt nu"/></div></div></a></div></div></div>    
</body>
</html>