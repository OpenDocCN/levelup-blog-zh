<html>
<head>
<title>Things to Keep in Mind for Room Database Migrations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">房间数据库迁移需要记住的事项</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/things-to-keep-in-mind-for-room-db-migrations-7edef257ea3?source=collection_archive---------12-----------------------#2020-03-29">https://levelup.gitconnected.com/things-to-keep-in-mind-for-room-db-migrations-7edef257ea3?source=collection_archive---------12-----------------------#2020-03-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/e9c10c078adad7f51b0cecdc134051f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Vu7CYBQ-qZoAU1wvBosMA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://medium.com/@elye.project/android-sqlite-database-migration-b9ad47811d34" rel="noopener">形象信用</a></figcaption></figure><p id="4cf5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我已经看到了大多数的文章/博客解释了房间图书馆如何工作的基础知识。但是，在使用Room时，我意识到没有太多关于Room数据库的高级主题，其中之一就是Room迁移。所以，我在这里，尝试我的第一篇媒体文章。</p><p id="6fdd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于那些不太了解Room的人来说，它是SQLite上的一个包装器，允许流畅的数据库访问，这要方便得多。</p><p id="34f8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Room Library的一个有用特性是易于处理迁移。这意味着您可以轻松地迁移到现有数据库，同时在现有应用程序中添加新功能。</p><p id="ace3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，如果您想向现有数据库中添加一个表，您可以这样做:</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="li lj l"/></div></figure><p id="a7d1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，在迁移数据库时，您还需要记住一些事情，否则事情可能不会像您计划的那样进行。</p><p id="26d9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是其中的一些:</p><h1 id="58b7" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">1.布尔值和长整型值存储为整数</h1><p id="bcbb" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">这是文档中没有写的东西。这是非常合理的，因为SQLite本身不支持Boolean &amp; Long数据类型。</p><p id="40b2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在进行迁移时，您可能会遇到这样一种情况，您希望向现有表中添加一个数据类型为Boolean或Long的列。因此，这类问题的解决方案是在编写迁移查询时使用INTEGER作为数据类型，如下所示:</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="li lj l"/></div></figure><h1 id="8046" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">2.TypeConverters按照我们提供的转换进行存储</h1><p id="b237" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">如果你使用类型转换器，这是非常明显的。如果你不了解TypeConverters，下面我来解释一下。</p><p id="7a7d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有时，您的应用程序需要使用自定义数据类型，您希望将其值存储在单个数据库列中。为了增加对定制类型的支持，我们提供了一个<code class="fe mn mo mp mq b"><a class="ae kf" href="https://developer.android.com/reference/androidx/room/TypeConverter" rel="noopener ugc nofollow" target="_blank">TypeConverter</a></code>，它将一个定制类<strong class="ki iu"> <em class="mr">转换成一个已知的类型</em> </strong>，这样Room就可以持久化。</p><p id="9818" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如上所述，<strong class="ki iu"> <em class="mr">与已知类型</em> </strong>之间的转换非常重要，因为我们作为开发人员负责TypeConverters的转换和逆转换。看一下下面的实现示例:</p><p id="7113" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，如果您想要添加一个名为<strong class="ki iu"> dob </strong>的列来存储用户的出生日期，那么我们就必须编写一个<code class="fe mn mo mp mq b">DateConverter</code>类来将日期转换为Long，反之亦然，如下所示:</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="li lj l"/></div></figure><p id="09f7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，您将<code class="fe mn mo mp mq b"><a class="ae kf" href="https://developer.android.com/reference/androidx/room/TypeConverters" rel="noopener ugc nofollow" target="_blank">@TypeConverters</a></code>注释添加到<code class="fe mn mo mp mq b">AppDatabase</code>类中，这样Room就可以使用您为每个<a class="ae kf" href="https://developer.android.com/training/data-storage/room/defining-data" rel="noopener ugc nofollow" target="_blank">实体</a>和<a class="ae kf" href="https://developer.android.com/training/data-storage/room/accessing-data" rel="noopener ugc nofollow" target="_blank"> DAO </a>在那个<code class="fe mn mo mp mq b">AppDatabase</code>中定义的转换器:</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="li lj l"/></div></figure><p id="7753" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，由于我们要将date转换为Long，反之亦然，而且正如我们之前看到的那样，Long在SQLite中存储为INTEGER，因此我们将在User表中添加一个类型为INTEGER的列。所以，迁移的代码应该是这样的:</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="li lj l"/></div></figure><h1 id="018d" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">3.修改现有表的主键</h1><p id="dd31" class="pw-post-body-paragraph kg kh it ki b kj mi kl km kn mj kp kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">根据我到目前为止所做的研究，如果您想要添加/更新任何现有表的主键，您必须手动迁移该表(就像您在SQLite实现中所做的那样)。你能做的是:</p><ul class=""><li id="e32e" class="ms mt it ki b kj kk kn ko kr mu kv mv kz mw ld mx my mz na bi translated">用修改后的列创建一个新表</li><li id="1df7" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated">将旧表中的所有现有数据复制到新表中</li><li id="bb9c" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated">删除/丢弃旧表</li><li id="3201" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated">将新表重命名为旧表</li></ul><p id="499a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，如果您想在用户表中添加一个名为<strong class="ki iu"> <em class="mr"> mobile_no </em> </strong>的列，该列需要成为它的主键，您可以像这样进行迁移:</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="li lj l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">更改现有表的主键的代码段</figcaption></figure><p id="77d9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">Android(Java)Devs的额外提示:</strong>如果您需要在现有的表中添加一个应该具有NOT NULL属性的列，那么您必须为将在Model/POJO类中定义的字段提供@NonNull注释，否则您的应用程序将在第一次启动时崩溃。</p><h1 id="8883" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">TLDR</h1><blockquote class="ng nh ni"><p id="f4d6" class="kg kh mr ki b kj kk kl km kn ko kp kq nj ks kt ku nk kw kx ky nl la lb lc ld im bi translated">您应该记住，我们在<strong class="ki iu"> migrate() </strong>函数中编写的查询是直接在SQLite上执行的。因此，无论我们将在其中编写什么查询，都必须由SQLite支持，而不是由Room支持。</p></blockquote><p id="3e34" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">房间库中有些东西没有明确地写在任何地方，比如:</p><ol class=""><li id="f2ca" class="ms mt it ki b kj kk kn ko kr mu kv mv kz mw ld nm my mz na bi translated">在SQLite中，Boolean和Long在内部实现为整数。</li><li id="3056" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld nm my mz na bi translated">TypeConverters是按照我们在TypeConverters类中提供的转换实现的，它实际存储在type converters类中。</li><li id="6ec2" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld nm my mz na bi translated">如果您需要修改现有表的主键，没有直接的方法，您需要手动处理迁移。</li></ol><p id="a819" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> PS </strong>:这些是我尝试过的观察和替代方法。我尽力询问我的一些开发伙伴，除了我提到的以外，他们是否还有其他选择。如果有比我列出的更好的选择，建议总是受欢迎的。</p><p id="be4f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">参考资料:</p><div class="nn no gp gr np nq"><a href="https://developer.android.com/training/data-storage/room/referencing-data" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab fo"><div class="ns ab nt cl cj nu"><h2 class="bd iu gy z fp nv fr fs nw fu fw is bi translated">使用Room | Android开发人员引用复杂数据</h2><div class="nx l"><h3 class="bd b gy z fp nv fr fs nw fu fw dk translated">Room提供了在原始类型和装箱类型之间转换的功能，但不允许对象引用…</h3></div><div class="ny l"><p class="bd b dl z fp nv fr fs nw fu fw dk translated">developer.android.com</p></div></div><div class="nz l"><div class="oa l ob oc od nz oe jz nq"/></div></div></a></div><div class="nn no gp gr np nq"><a href="https://developer.android.com/training/data-storage/room/migrating-db-versions" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab fo"><div class="ns ab nt cl cj nu"><h2 class="bd iu gy z fp nv fr fs nw fu fw is bi translated">迁移房间数据库| Android开发人员</h2><div class="nx l"><h3 class="bd b gy z fp nv fr fs nw fu fw dk translated">当您在应用中添加和更改功能时，您需要修改房间实体类来反映这些更改…</h3></div><div class="ny l"><p class="bd b dl z fp nv fr fs nw fu fw dk translated">developer.android.com</p></div></div><div class="nz l"><div class="of l ob oc od nz oe jz nq"/></div></div></a></div></div></div>    
</body>
</html>