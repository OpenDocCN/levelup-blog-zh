<html>
<head>
<title>Thumbnail when Video Progress Bar is Hovered: Create a Video Component</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">视频进度条悬停时的缩略图:创建视频组件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/build-youtube-like-stylish-video-player-with-thumbnail-preview-on-progress-bar-hovered-53b9074acd75?source=collection_archive---------3-----------------------#2021-07-23">https://levelup.gitconnected.com/build-youtube-like-stylish-video-player-with-thumbnail-preview-on-progress-bar-hovered-53b9074acd75?source=collection_archive---------3-----------------------#2021-07-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/35ec64fd9f2d87d2145b211cc99b53ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*9iacAHMLyPypBYzMshcSMg.gif"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">悬浮在进度条上的缩略图预览(SN11启动事件)</figcaption></figure><p id="de48" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">当进度条悬停时显示信息丰富的缩略图预览图像有很多好处，例如帮助用户快速了解视频的大致内容，选择一个有趣的时刻开始，在视频到达该点之前预览关键帧。</p><p id="19ee" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">正如我们所知，原生的<code class="fe ld le lf lg b"><a class="ae lh" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video" rel="noopener ugc nofollow" target="_blank">&lt;video&gt;</a></code>元素没有这样的API供我们直接用来生成某一时刻的视频快照。在这种情况下，<strong class="kh iu">我们需要重写视频控件来获得快照。</strong></p><p id="2296" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">所以让我们把这个任务分成几个部分:</p><p id="9787" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">(1)用自定义进度条重写视频控件</p><p id="c58a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">(2)在鼠标悬停时从进度条获取时间值</p><p id="8d89" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">(3)在某个时间生成快照</p><p id="4783" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在这篇文章中，我们将经历上面列出的三个步骤。源代码可以在我在NPM-<a class="ae lh" href="https://www.npmjs.com/package/ngx-thumbnail-video" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/ngx-thumbnail-video</a>上发布的<code class="fe ld le lf lg b"><a class="ae lh" href="https://www.npmjs.com/package/ngx-thumbnail-video" rel="noopener ugc nofollow" target="_blank">ngx-thumbnail-video</a></code>包中找到。</p></div><div class="ab cl li lj hx lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="im in io ip iq"><h1 id="d1e1" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">1.用自定义进度条重写视频控件</h1><p id="cb93" class="pw-post-body-paragraph kf kg it kh b ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky mr la lb lc im bi translated">首先，生成您的自定义视频播放器组件来保存本地视频元素，例如<code class="fe ld le lf lg b">ngx-thumbnail-video</code>，并在另一个组件中创建您的自定义视频控件，例如<code class="fe ld le lf lg b">ngx-video-controls</code>。您不必将控件分离到不同的组件中，但是为了可重用性和可读性，最好这样做。</p><p id="28b6" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">确保隐藏了<code class="fe ld le lf lg b">&lt;video&gt;</code>元素的本地控件，这可以通过从<code class="fe ld le lf lg b">&lt;video&gt;</code>元素中移除<code class="fe ld le lf lg b">controls</code>属性来实现。下面是视频组件在这个阶段的自定义控件的外观。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">初始阶段自定义视频播放器HTML</figcaption></figure><p id="e6b1" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">之后，在你的视频控件中添加一个进度条，你可以通过添加一个<code class="fe ld le lf lg b">&lt;div&gt;</code>元素来完成，默认情况下这个元素占容器宽度的100%。代码如下所示:</p><pre class="ms mt mu mv gt my lg mz na aw nb bi"><span id="8b37" class="nc lq it lg b gy nd ne l nf ng">&lt;div class="custom-controls"&gt;<br/>    &lt;div class="progress-bar"&gt;<br/>        &lt;div class="bar" [style.width]="barLength"&gt;&lt;/div&gt;<br/>    &lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="a919" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">添加一些CSS以确保:</p><ol class=""><li id="eab9" class="nh ni it kh b ki kj km kn kq nj ku nk ky nl lc nm nn no np bi translated">进度条总是在视频播放器的底部</li><li id="0ea0" class="nh ni it kh b ki nq km nr kq ns ku nt ky nu lc nm nn no np bi translated">进度条有清晰的颜色显示时间流逝</li></ol><p id="8fd2" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这是它在这个阶段的样子，底部的灰色线将是我们的进度条，它占据了视频的整个宽度，便于在稍后阶段计算悬停时间。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nv"><img src="../Images/e6abb1427b14a89525cf00f2f2afb464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6NJuHICSycuG57Arp6x2hg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">自定义视频播放器</figcaption></figure></div><div class="ab cl li lj hx lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="im in io ip iq"><h1 id="1712" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">2.鼠标悬停时从进度条获取时间值</h1><h2 id="e17f" class="nc lq it bd lr nw nx dn lv ny nz dp lz kq oa ob md ku oc od mh ky oe of ml og bi translated"><strong class="ak"> 2.1随着时间推移增加进度条长度</strong></h2><p id="6af9" class="pw-post-body-paragraph kf kg it kh b ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky mr la lb lc im bi translated">在创建自定义控件和一些样式后，我们需要随着时间的推移增加进度条的长度。如何了解视频时间流逝？原生<a class="ae lh" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement/timeupdate_event" rel="noopener ugc nofollow" target="_blank">视频API </a>有答案:</p><blockquote class="oh oi oj"><p id="5fa0" class="kf kg ok kh b ki kj kk kl km kn ko kp ol kr ks kt om kv kw kx on kz la lb lc im bi translated">当由<code class="fe ld le lf lg b">currentTime</code>属性指示的时间被更新时，触发<code class="fe ld le lf lg b">timeupdate</code>事件</p></blockquote><p id="bf47" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因此，我们可以向<code class="fe ld le lf lg b">timeupdate</code>事件添加一个监听器，并获取视频的当前时间。在检索到视频的<code class="fe ld le lf lg b">currentTime</code>之后，我们可以通过计算当前时间和视频持续时间的比率来计算进度条的百分比长度(<code class="fe ld le lf lg b">%</code>)，这是视频元素的固有属性之一。</p><pre class="ms mt mu mv gt my lg mz na aw nb bi"><span id="c2a2" class="nc lq it lg b gy nd ne l nf ng">this.videoPlayer.nativeElement.ontimeupdate = (_: any) =&gt; {<br/>    const video = this.target.nativeElement;<br/>    this.barLength = (video.currentTime / video.duration) * 100 +   '%';<br/>    this.currentTime = this._formatTime(video.currentTime);<br/>};</span></pre><h2 id="4ea9" class="nc lq it bd lr nw nx dn lv ny nz dp lz kq oa ob md ku oc od mh ky oe of ml og bi translated"><strong class="ak"> 2.1计算鼠标在进度条上悬停的位置时间</strong></h2><p id="043b" class="pw-post-body-paragraph kf kg it kh b ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky mr la lb lc im bi translated">要计算鼠标在进度条上停留的时间，你需要知道鼠标指向视频容器左边缘的长度。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oo"><img src="../Images/9806c7122176676a9fc650ea2419decb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iSZQ9zrPY7caqV68XXKUHQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">关键点位置</figcaption></figure><p id="d236" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">要计算鼠标悬停点的时间，您需要执行以下计算:</p><pre class="ms mt mu mv gt my lg mz na aw nb bi"><span id="11fb" class="nc lq it lg b gy nd ne l nf ng">const mouseTime = (mouseX - videoLeft) / videoWidth * videoDuration;</span></pre><p id="9ec7" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">为了获得视频容器的位置，比如左坐标和视频宽度，我们需要使用Web API <code class="fe ld le lf lg b">getBoundingClientRect()</code>。</p><blockquote class="oh oi oj"><p id="726f" class="kf kg ok kh b ki kj kk kl km kn ko kp ol kr ks kt om kv kw kx on kz la lb lc im bi translated"><code class="fe ld le lf lg b">Element.getBoundingClientRect()</code>方法返回元素的大小及其相对于视口的位置。</p></blockquote><pre class="ms mt mu mv gt my lg mz na aw nb bi"><span id="8af2" class="nc lq it lg b gy nd ne l nf ng">const { left, offsetWidth } = this.videoPlayer.nativeElement.getBoundingClientRect();</span></pre><p id="1157" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">为了获得鼠标位置，我们需要在进度条上添加一个<code class="fe ld le lf lg b">mousemove</code>监听器:</p><blockquote class="oh oi oj"><p id="23f5" class="kf kg ok kh b ki kj kk kl km kn ko kp ol kr ks kt om kv kw kx on kz la lb lc im bi translated">当指针设备(通常是鼠标)移动而光标的热点在元素内时，元素触发<code class="fe ld le lf lg b">mousemove</code>事件。</p></blockquote><pre class="ms mt mu mv gt my lg mz na aw nb bi"><span id="1d63" class="nc lq it lg b gy nd ne l nf ng">&lt;div class="progress-bar" (mousemove)="onMouseMove($event)"&gt;&lt;/div&gt;</span></pre><p id="7905" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在准备好所有这些参数之后，我们可以计算时间并把它们放在进度条上。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi op"><img src="../Images/1209a2671f8e972fc67ad54388506d9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4vGlNh1tybTsKCj076RN1Q.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">带时间的进度条</figcaption></figure></div><div class="ab cl li lj hx lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="im in io ip iq"><h1 id="ab41" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">3.在特定时间生成缩略图快照</h1><h2 id="80e6" class="nc lq it bd lr nw nx dn lv ny nz dp lz kq oa ob md ku oc od mh ky oe of ml og bi translated">3.1生成快照</h2><p id="01e2" class="pw-post-body-paragraph kf kg it kh b ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky mr la lb lc im bi translated">现在我们让鼠标停留在进度条上。我们需要得到当时视频的快照。对于一个<code class="fe ld le lf lg b">&lt;video&gt;</code>元素，我们可以做的是将视频的<code class="fe ld le lf lg b">currentTime</code>设置为鼠标悬停的时间。</p><pre class="ms mt mu mv gt my lg mz na aw nb bi"><span id="2b0d" class="nc lq it lg b gy nd ne l nf ng">this.videoPlayer.nativeElement.currentTime = mouseHoverTime;</span></pre><p id="8572" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">之后，我们需要拍摄视频的快照，你可以使用canvas在后端或前端渲染图像。下面是MDN 的<a class="ae lh" href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Manipulating_video_using_canvas#the_javascript_code" rel="noopener ugc nofollow" target="_blank">实现，说明如何在前端使用<code class="fe ld le lf lg b">canvas</code>获取视频快照。</a></p><pre class="ms mt mu mv gt my lg mz na aw nb bi"><span id="319b" class="nc lq it lg b gy nd ne l nf ng">const processor = {};<br/>processor.doLoad = function doLoad() {<br/>    const video = document.getElementById('video');<br/>    this.video = video;</span><span id="995c" class="nc lq it lg b gy oq ne l nf ng">    this.c1 = document.getElementById('c1');<br/>    this.ctx1 = this.c1.getContext('2d');<br/>    <br/>    this.c2 = document.getElementById('c2');<br/>    this.ctx2 = this.c2.getContext('2d');<br/>    <br/>    video.addEventListener('play', () =&gt; {<br/>        this.width = video.videoWidth / 2;<br/>        this.height = video.videoHeight / 2;<br/>        this.timerCallback();<br/>    }, false);<br/>};</span></pre><p id="b743" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们需要在上述实现的基础上再做几个步骤:</p><ol class=""><li id="2744" class="nh ni it kh b ki kj km kn kq nj ku nk ky nl lc nm nn no np bi translated">将其包装到<code class="fe ld le lf lg b">loadeddata</code>监听器的处理函数中。</li><li id="68de" class="nh ni it kh b ki nq km nr kq ns ku nt ky nu lc nm nn no np bi translated">设置好视频的<code class="fe ld le lf lg b">currentTime</code>并可以播放后，获取快照。</li></ol><p id="e193" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">下面是我的<a class="ae lh" href="https://www.npmjs.com/package/ngx-thumbnail-video" rel="noopener ugc nofollow" target="_blank"> ngx-thumbnail-video </a> npm包中关于如何用<code class="fe ld le lf lg b">canvas</code>获得<code class="fe ld le lf lg b">video</code>快照的实现。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><h2 id="a0dd" class="nc lq it bd lr nw nx dn lv ny nz dp lz kq oa ob md ku oc od mh ky oe of ml og bi translated">3.2将生成的快照传送到视频控件</h2><p id="4d10" class="pw-post-body-paragraph kf kg it kh b ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky mr la lb lc im bi translated">获取快照图像的URL后，将其呈现在进度条控件上。</p><pre class="ms mt mu mv gt my lg mz na aw nb bi"><span id="5ee7" class="nc lq it lg b gy nd ne l nf ng">&lt;div [class.active]="onHover" class="tooltip thumb" [style.left]="mouseLeft" [style.display-none]="!onHover"&gt;<br/>    &lt;img *ngIf="thumb &amp;&amp; thumb.url; else loading" [src]="thumb.url"&gt;<br/>&lt;/div&gt;</span></pre><p id="d76d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">为了使它有点花哨，你可以为它添加一些动画，如缩放，滑入和滑出等。此外，您还可以添加一些控制，如音量，静音，播放和暂停控制。下面是我的实现的样子:</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi or"><img src="../Images/8a57ad9a240b57eefe6fb5e23823c467.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*KBD85yMv6pWiaZTqP6bw_A.gif"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">最终缩略图快照视频效果</figcaption></figure></div><div class="ab cl li lj hx lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="im in io ip iq"><h1 id="a828" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">包扎</h1><p id="4e5b" class="pw-post-body-paragraph kf kg it kh b ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky mr la lb lc im bi translated">制作一个具有缩略图预览功能的视频播放器对你的用户来说是非常有益的。为什么不自己做一个，试着融入一些惊人的想法。</p><p id="c1c4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">顺便说一句，你可以对这个<a class="ae lh" href="https://github.com/theideasaler/angular-thumb-video" rel="noopener ugc nofollow" target="_blank">开源包</a>做出贡献，向新特性标签提出一个问题。</p><p id="d5e6" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">其他岗位:</strong></p><ul class=""><li id="9f4b" class="nh ni it kh b ki kj km kn kq nj ku nk ky nl lc os nn no np bi translated"><a class="ae lh" href="https://neowei.medium.com/9-ultimate-tips-to-improve-angular-performance-dbedb0ec4e2d" rel="noopener">优化角度性能的9个终极技巧</a></li><li id="2d10" class="nh ni it kh b ki nq km nr kq ns ku nt ky nu lc os nn no np bi translated"><a class="ae lh" href="https://javascript.plainenglish.io/boost-up-angular-development-with-nx-schematics-generators-50117dc56e38" rel="noopener ugc nofollow" target="_blank">使用Nx原理图/生成器促进角度发展</a></li><li id="d83d" class="nh ni it kh b ki nq km nr kq ns ku nt ky nu lc os nn no np bi translated"><a class="ae lh" href="https://medium.com/swlh/create-a-resizable-and-draggable-angular-component-in-the-easiest-way-bb67031866cb" rel="noopener">创建一个可调整大小和可拖动的角度组件</a></li><li id="e208" class="nh ni it kh b ki nq km nr kq ns ku nt ky nu lc os nn no np bi translated"><a class="ae lh" rel="noopener ugc nofollow" target="_blank" href="/prerender-angular-and-deploy-it-as-a-static-website-on-aws-s3-to-make-it-42-times-faster-115fadcf8614">预呈现Angular作为静态网站，并将其托管在AWS S3与您的自定义域</a></li><li id="ed82" class="nh ni it kh b ki nq km nr kq ns ku nt ky nu lc os nn no np bi translated"><a class="ae lh" rel="noopener ugc nofollow" target="_blank" href="/deploy-your-serverless-server-side-rendering-ssr-angular-app-on-aws-lambda-a01a3aab6ef6">在AWS Lambda上部署无服务器的服务器端渲染Angular。</a></li><li id="223a" class="nh ni it kh b ki nq km nr kq ns ku nt ky nu lc os nn no np bi translated"><a class="ae lh" href="https://medium.com/@neowei/be-careful-of-passing-an-async-function-as-a-parameter-4f421f8e7e9d" rel="noopener">小心将异步函数作为参数传递</a></li></ul></div></div>    
</body>
</html>