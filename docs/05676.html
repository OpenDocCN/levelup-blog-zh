<html>
<head>
<title>Time-Series Data in MongoDB and Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MongoDB和Python中的时序数据</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/time-series-data-in-mongodb-and-python-fccfb6c1a923?source=collection_archive---------4-----------------------#2020-09-21">https://levelup.gitconnected.com/time-series-data-in-mongodb-and-python-fccfb6c1a923?source=collection_archive---------4-----------------------#2020-09-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1d23" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一个提高性能的好模式。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/af6df1f3cfab0c7eec8dae6ba2262463.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RO7ib9mKWEm2ZkbRcfEDpw.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@harishankphotography?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Harishan Kobalasingam </a>在<a class="ae ky" href="https://unsplash.com/s/photos/timelapse?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="8501" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://www.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>是一个文档数据库，可以直接用JSON格式存储数据。使用MongoDB启动和创建应用程序非常简单。然而，它是一个强大的工具。</p><p id="bbb0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以用它来存储时间序列数据。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="846e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">介绍</h1><p id="97a1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">简单来说，时间序列就是一系列按时间顺序排列的数据。它可以是常数，即每个条目之间的间隔相等(秒、分、小时)，也可以有不同的时间间隔。重要的事实是，每个条目都有一个与之关联的有序时间戳。</p><p id="e5ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现实世界中有许多使用时间序列数据的情况:</p><ul class=""><li id="8adf" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">获取湿度、温度和压力数据的气象站。你想知道一个给定的温度是什么时候获得的，所以你预测你是否必须穿夹克出门。</li><li id="4911" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">股票市场分析师，他利用一段时间内的所有股票价格进行分析并识别机会。</li><li id="963e" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">一辆一级方程式赛车，每秒发送遥测信息，如速度、油耗、温度，因此工程师可以计算并告诉车手下一步该做什么。</li></ul><p id="bbad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Mongo数据库中有一些存储它们的方法，我们将逐一介绍。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="83a8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">单一文件</h1><p id="64cf" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">第一种方法是将每个获取的数据作为单个文档存储到数据库中。也就是说，每个时间戳(或时间间隔)将对应于数据库中的一个条目。</p><p id="12d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">想象一下，我们有一个每秒产生传感器数据的天气系统。该示例包含温度、湿度和压力等数据，以及天气id。</p><p id="b09a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每次获取信息时，传感器都会将其发送到数据库，数据库会将其存储为单个文档。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/025964c225895303738ca90c42e73bcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*LTd2YPhXwxi4BwSVjm-3IQ.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片作者。</figcaption></figure><p id="0593" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，有一些重复的或者无用的信息，比如<code class="fe no np nq nr b">_id</code>和<code class="fe no np nq nr b">deviceId</code>。对于每一秒，这两个信息将被存储，一次又一次，增加了集合的大小。</p><p id="642d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于我们的场景，它将在一个小时内创建3600个文档，即每天86400个文档！这将影响性能和磁盘使用。</p><p id="0fe0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用Python插入它很简单:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="65ac" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">时间段文档</h1><p id="2f8b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">由于我们的数据是均匀分布的，我们可以按时间对它们进行分组。在这种情况下，每分钟一个文档。我们有一个包含60个对象的数组，每个对象包含来自传感器的样本。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/7c3be62510d145b9d1b7aecb633d20b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/format:webp/1*CLWaG4xKbLJPTlN-iZYyxw.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片作者。</figcaption></figure><p id="e1a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果与前一个选项相比，我们有更多的字段:</p><ul class=""><li id="f8d2" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><code class="fe no np nq nr b">d</code> : <em class="nv">日期时间</em>获取数据样本的时刻的信息。如果我们愿意，可以是不同的小组时间，如几小时或几天。这将取决于我们的数据或应用程序的频率。</li><li id="c7c6" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe no np nq nr b">nsamples</code>:该分钟采集的样本数。</li><li id="4f01" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe no np nq nr b">samples</code>:包含传感器所有样本的数组。因为我们已经有了时间戳信息，并且数据是均匀分布的，所以我们可以忽略它，只存储实际的传感器数据。</li></ul><p id="79e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些额外的字段帮助我们以后查询数据，并作为一种更好地聚合数据的方式。</p><p id="04cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要用Python插入它，我们必须修改我们的数据:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="a14b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用<code class="fe no np nq nr b">update_one</code>功能，而不是<code class="fe no np nq nr b">insert_one</code>。它将找到具有等于1的<code class="fe no np nq nr b">deviceId</code>和相同的<code class="fe no np nq nr b">minute</code>的文档，并将数据插入到<code class="fe no np nq nr b">samples</code>字段。</p><p id="7098" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果没有找到具有这些特征的文档(即新的一分钟)，将创建一个新文档。</p><blockquote class="nw nx ny"><p id="8403" class="kz la nv lb b lc ld ju le lf lg jx lh nz lj lk ll oa ln lo lp ob lr ls lt lu im bi translated"><strong class="lb iu">注意</strong>:确保将标志<code class="fe no np nq nr b">upsert=True</code>传递给该函数，否则不会创建新文档。</p></blockquote></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="dd5b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">大小-桶文档</h1><p id="1ee8" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">有些数据是以不规则的时间间隔生成的，有些传感器可以提供比其他传感器更多的数据。</p><p id="4d0b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，基于大小的存储桶可能比基于时间的存储桶更好。因此，您根据数组的大小而不是时间来更新并向文档中插入一个新样本。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/1fc51debc4f1396b56421bf09c095a0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*B7F2zlR3-jGRCSEPmEUivQ.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片作者。</figcaption></figure><p id="7b05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的文档中还有两个信息，有助于以后的查询和聚合:</p><ul class=""><li id="acd0" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><code class="fe no np nq nr b">first</code>:插入<code class="fe no np nq nr b">samples</code>字段的第一个数据的时间戳；</li><li id="0b4f" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe no np nq nr b">last</code>:最后插入<code class="fe no np nq nr b">samples</code>字段的数据的时间戳；</li></ul><blockquote class="nw nx ny"><p id="947b" class="kz la nv lb b lc ld ju le lf lg jx lh nz lj lk ll oa ln lo lp ob lr ls lt lu im bi translated"><strong class="lb iu">注</strong>:如果需要，我们可以有其他数据，比如最大值和最小值。</p></blockquote><p id="7848" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">插一句，和我们之前的数据差不多。我们必须进行修改，这样才能计算出我们想要的数据:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="fb93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们再次使用<code class="fe no np nq nr b">update_one</code>函数，但是现在比较将针对<code class="fe no np nq nr b">nsamples</code>字段:它必须小于200(我们的桶大小，您可以选择任何您喜欢的值)并且使用相同的<code class="fe no np nq nr b">deviceId</code>。</p><p id="e8d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用操作符<code class="fe no np nq nr b">$<a class="ae ky" href="https://docs.mongodb.com/manual/reference/operator/aggregation/min/" rel="noopener ugc nofollow" target="_blank">min</a></code>和<code class="fe no np nq nr b">$<a class="ae ky" href="https://docs.mongodb.com/manual/reference/operator/aggregation/max/" rel="noopener ugc nofollow" target="_blank">max</a></code>来自动计算插入的数据时间戳的最小值和最大值。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="dc67" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">最后的想法</h1><p id="ea1c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们来对比一下目前为止我们创作的三个系列。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi od"><img src="../Images/fc8adfd803b23df8a73bb7186a803e58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*6h82zkCQYiaXpYwQt5XOZw.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片作者。</figcaption></figure><p id="1f7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">经过大约一个小时的数据采集，我们有了一些很好的见解:</p><ul class=""><li id="0329" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">藏品<code class="fe no np nq nr b">single</code>比<code class="fe no np nq nr b">time_bucket</code>多65%。如果我们获取更多的数据，可能会有更大的差异。</li><li id="c067" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">由于<code class="fe no np nq nr b">size_bucket</code>集合包含更多信息，因此总大小大于<code class="fe no np nq nr b">time_bucket</code>。但即便如此，也比<code class="fe no np nq nr b">single</code>少了很多。</li><li id="3444" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">对于均匀分布的数据，就像我们的例子一样，<code class="fe no np nq nr b">time_bucket</code>是一个更好的方法，因为它需要保存的信息更少。</li></ul><p id="7c38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您有一个时间序列数据，创建一个基于时间的存储桶，甚至基于大小的存储桶，可以提高磁盘使用率和性能，正如我们在本文中看到的。</p><p id="8e53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用Python，很容易将它们插入数据库，几乎不费吹灰之力。</p><p id="7015" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用nice <a class="ae ky" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"> FastAPI </a>框架创建一个API，正如本文所解释的:</p><div class="oe of gp gr og oh"><a href="https://medium.com/python-in-plain-english/how-to-use-fastapi-with-mongodb-75b43c8e541d" rel="noopener follow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd iu gy z fp om fr fs on fu fw is bi translated">如何在MongoDB中使用FastAPI</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">提供数据库文档的简单方法。</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">medium.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov ks oh"/></div></div></a></div><p id="e31b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">希望你喜欢这篇文章。你可以在这里和Twitter上关注我，了解更多类似的内容。</p></div></div>    
</body>
</html>