<html>
<head>
<title>Location, location, location</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">位置，位置，位置</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/location-location-location-bf4da727f9a5?source=collection_archive---------7-----------------------#2021-03-30">https://levelup.gitconnected.com/location-location-location-bf4da727f9a5?source=collection_archive---------7-----------------------#2021-03-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e6d5" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated"><em class="km">将谷歌地图整合到带有地理定位功能的React表单中</em></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/e7f6ba8c55da9080b12256977f4a551e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QnkeLg2W_m2WzI7edVF9oQ.jpeg"/></div></div></figure><p id="8eb9" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">作为我上一篇关于实现<a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/just-keep-scrolling-scrolling-scrolling-47c3863fe653">无限滚动</a>的文章的后续，在这篇文章中，我将介绍如何将Google Maps API集成到React项目中，以及如何将它用作表单元素。</p><p id="a888" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">我在这个特性背后的动机是添加一个地图形式的响应位置字段，它将集中在用户的当前位置。</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h2 id="ee36" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">建立</h2><p id="b140" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">首先，您需要在应用程序的根目录下运行以下命令来安装Google Maps节点:</p><pre class="ko kp kq kr gt mf mg mh mi aw mj bi"><span id="7a7c" class="lh li iq mg b gy mk ml l mm mn">npm i google-maps-react --s</span></pre><p id="1d61" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">安装好这个包之后，你需要访问<a class="ae kz" href="https://developers.google.com/maps/documentation/" rel="noopener ugc nofollow" target="_blank">https://developers.google.com/maps/documentation/</a>，注册并获得一个API令牌来使用。</p><p id="806e" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">Google需要银行卡凭证来授予API令牌，但是在使用免费试用时不会产生任何费用。</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h2 id="38ee" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">成分</h2><p id="19da" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">要设置第一个嵌入地图，必须从所选组件的包中导入地图组件。在我的情况下，这是上市形式。</p><pre class="ko kp kq kr gt mf mg mh mi aw mj bi"><span id="7acf" class="lh li iq mg b gy mk ml l mm mn">import { Map, GoogleApiWrapper, Marker } from 'google-maps-react'</span></pre><p id="c02e" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">地图组件需要google props，它由GoogleApiWrapper生成。此功能最好通过如下所示的导出语句来实现:</p><pre class="ko kp kq kr gt mf mg mh mi aw mj bi"><span id="1495" class="lh li iq mg b gy mk ml l mm mn">export default GoogleApiWrapper({</span><span id="6185" class="lh li iq mg b gy mo ml l mm mn">    apiKey: process.env.REACT_APP_GOOGLE_MAP</span><span id="b84a" class="lh li iq mg b gy mo ml l mm mn">})(ListingForm)</span></pre><p id="095b" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">这里的<code class="fe mp mq mr mg b">process.env.REACT_APP_GOOGLE_MAP</code>代表google提供给我的API令牌。我已经利用<a class="ae kz" href="https://www.npmjs.com/package/dotenv" rel="noopener ugc nofollow" target="_blank"> dotenv </a>节点来存储我的令牌，因为它是<strong class="jq ir"> <em class="km">不应该</em> </strong>推送到GitHub的东西。</p><p id="017f" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated"><code class="fe mp mq mr mg b">GoogleApiWrapper</code>现在已经提供了插入地图组件所需的道具。首先创建一个<code class="fe mp mq mr mg b">div</code>元素来放置地图，并根据需要设置样式。</p><p id="cc76" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">在其中放置地图组件，将属性<code class="fe mp mq mr mg b">google</code>设置为包装器传递的<code class="fe mp mq mr mg b">props.google</code>(在我的例子中，我使用了函数组件，但是使用类组件也可以获得相同的结果)。</p><pre class="ko kp kq kr gt mf mg mh mi aw mj bi"><span id="0b07" class="lh li iq mg b gy mk ml l mm mn">&lt;div className="map-container" &gt;<br/>    &lt;Map<br/>        google={props.google}<br/>        zoom={14}<br/>        initialCenter={{ lat: 51.501364, lng: -0.141890 }}<br/>    &gt;&lt;/Map&gt;<br/>&lt;/div&gt;</span></pre><p id="e28c" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">有了如上配置的道具，你应该有一张以白金汉宫为中心的地图，如下所示:</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi ms"><img src="../Images/87669cae239b007a87423333bbc4f89b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cHW1vOtBmoJ32ExeqKOwvg.jpeg"/></div></div></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h2 id="be88" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">用别针别住它</h2><p id="8307" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">这看起来有点像平面——不太适合作为表单域。</p><p id="cacf" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">要呈现一个将保留在地图中心的标记，该标记将代表要提交的位置，我们必须将以下内容添加到我们的地图组件中:</p><pre class="ko kp kq kr gt mf mg mh mi aw mj bi"><span id="95fe" class="lh li iq mg b gy mk ml l mm mn">&lt;div className="map-container" &gt;<br/>    &lt;Map<br/>        google={props.google}<br/>        zoom={14}<br/>        initialCenter={listing.latLng}<br/>        ref={refMap}<br/>        onBoundsChanged={<br/>            useCallback(handleBoundsChanged,[handleBoundsChanged])<br/>        }<br/>    &gt;<br/>        &lt;Marker<br/>            position={listing.latLng}<br/>        /&gt;<br/>    &lt;/Map&gt;<br/>&lt;/div&gt;</span></pre><p id="311d" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">此处增加的内容有:</p><ul class=""><li id="e66a" class="mt mu iq jq b jr js jv jw jz mv kd mw kh mx kl my mz na nb bi translated">ref用于表示地图，以便从中检索信息。</li><li id="08f2" class="mt mu iq jq b jr nc jv nd jz ne kd nf kh ng kl my mz na nb bi translated">地图的中心现在由存储在state中的列表对象设置。</li></ul><pre class="ko kp kq kr gt mf mg mh mi aw mj bi"><span id="29c3" class="lh li iq mg b gy mk ml l mm mn">const [listing, setListing] = useState({<br/>    latLng: { lat: 51.501364, lng: -0.141890 }<br/>})</span></pre><ul class=""><li id="cba6" class="mt mu iq jq b jr js jv jw jz mv kd mw kh mx kl my mz na nb bi translated">添加了一个<code class="fe mp mq mr mg b">onBoundsChange</code>事件监听器，每当平移地图时都会调用该监听器。</li></ul><p id="b69b" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated"><code class="fe mp mq mr mg b">handleBoundsChanged</code>回调函数如下所示:</p><pre class="ko kp kq kr gt mf mg mh mi aw mj bi"><span id="7b1e" class="lh li iq mg b gy mk ml l mm mn">const handleBoundsChanged = () =&gt; {<br/>    if (refMap.current) {<br/>        const mapCenter = {<br/>            lat: refMap.current.map.center.lat(),<br/>            lng: refMap.current.map.center.lng()<br/>        }<br/>        setListing({...listing, latLng: mapCenter})<br/>    }<br/>};</span></pre><p id="ab6b" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">现在，在渲染时，会有一个标记留在地图的中心。此外，在列表键下的状态中将存储坐标。这可以与任何其他属性相结合，这些属性可以是受控表单的一部分并提交到您的数据库。</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h2 id="1271" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">地理定位</h2><p id="ab2c" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">现在可能不是每个应用程序的用户都想从白金汉宫提交他们的列表。为了让他们找到自己的地址，他们将不得不缩小和平移，直到他们在地图上找到自己的位置。</p><p id="ad73" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">这当然是除非他们启用共享位置。</p><p id="efa6" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">如果他们这样做了，你将能够通过他们的地理位置获取他们的经度和纬度。</p><p id="3e59" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated"><strong class="jq ir"> <em class="km"> NB </em> </strong> <em class="km">如果你正在使用谷歌chrome进行开发，并且你正在本地主机上访问你的网站，默认情况下，谷歌会将其视为不安全连接，并阻止发送你的地理位置信息。</em></p><p id="a9b0" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated"><em class="km">要启用本地主机，您可以在地址栏中输入</em> <code class="fe mp mq mr mg b"><em class="km">chrome://flags/#allow-insecure-localhost</em></code> <em class="km">并启用不安全的本地主机。</em></p><p id="2969" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">为了更好地利用地理定位，我建议将表单组件包装在一个父组件中，如果位置共享是活动的，父组件将负责将位置作为道具传递，如果不是活动的，则传递默认位置。</p><p id="4f1d" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">为此，您可以添加以下组件:</p><pre class="ko kp kq kr gt mf mg mh mi aw mj bi"><span id="a305" class="lh li iq mg b gy mk ml l mm mn">import { useEffect, useState } from "react"<br/>import ListingForm from '../listings/ListingForm'</span><span id="e636" class="lh li iq mg b gy mo ml l mm mn">const GeoLocator = props =&gt; {</span><span id="5511" class="lh li iq mg b gy mo ml l mm mn">    const [location, setLocation] = useState({ <br/>        lat: 51.501364, <br/>        lng: -0.141890 <br/>    })</span><span id="abcd" class="lh li iq mg b gy mo ml l mm mn">    const success = position =&gt; {<br/>        const coordinates = {<br/>            lat: position.coords.latitude,<br/>            lng: position.coords.longitude<br/>        }<br/>        setLocation(coordinates)<br/>    }</span><span id="bc87" class="lh li iq mg b gy mo ml l mm mn">    useEffect(()=&gt;{<br/>        if (navigator.geolocation) {<br/>            navigator.permissions<br/>            .query({ name: "geolocation" })<br/>            .then(function (result) {<br/>                if (result.state === "granted") {<br/>                   navigator.geolocation.getCurrentPosition(success)<br/>                }<br/>            });<br/>        }<br/>    },[])</span><span id="10d6" class="lh li iq mg b gy mo ml l mm mn">    return (<br/>        &lt;div&gt;<br/>            &lt;div className="container"  style={{maxWidth: "500px"}}&gt;<br/>                &lt;ListingForm location={location} /&gt;<br/>            &lt;/div&gt;<br/>        &lt;/div&gt;<br/>    )<br/>}</span><span id="bc26" class="lh li iq mg b gy mo ml l mm mn">export default GeoLocator</span></pre><p id="5f2a" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">然后在表单组件中，您可以定义<code class="fe mp mq mr mg b">useState</code>来引用传递下来的属性。</p><p id="78e7" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">为了避免当一个新位置作为道具被传递时的错误，我需要平移地图。我使用下面的函数来处理这个问题:</p><pre class="ko kp kq kr gt mf mg mh mi aw mj bi"><span id="0fe5" class="lh li iq mg b gy mk ml l mm mn">useEffect(()=&gt;{</span><span id="db7e" class="lh li iq mg b gy mo ml l mm mn">    refMap.current.map.panTo(props.location)</span><span id="6a32" class="lh li iq mg b gy mo ml l mm mn">},[props.location])</span></pre><p id="75a4" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">再次利用地图的参考。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi nh"><img src="../Images/e660e953cae8d4e75e05445135a9543d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xFmccW1Kk2F4DIfz6uTZAQ.jpeg"/></div></div></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h2 id="2fed" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">包裹</h2><p id="d2b7" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">有了这些功能，您现在应该有一个以用户位置为中心的表单；中间有一个标记作为坐标的占位符，可以作为数据提交给表单。</p><p id="f417" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">现在要做的就是为你的后端编写必要的代码来处理坐标…</p><p id="184f" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">祝你在设置地图组件的过程中玩得开心，如果你在这个过程中遇到了任何巧妙的技巧，请与我分享。</p><p id="54c9" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">这个项目的所有源代码都可以在这里<a class="ae kz" href="https://github.com/Shilcof/osiris-frontend" rel="noopener ugc nofollow" target="_blank">找到</a>如果你想克隆它并亲自看看应用程序的运行。</p></div></div>    
</body>
</html>