<html>
<head>
<title>Create a Video Help Chat With Node.js and Svelte</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js和Svelte创建视频帮助聊天</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/create-a-video-help-chat-with-node-js-and-svelte-8bccf566751e?source=collection_archive---------2-----------------------#2021-01-08">https://levelup.gitconnected.com/create-a-video-help-chat-with-node-js-and-svelte-8bccf566751e?source=collection_archive---------2-----------------------#2021-01-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0700ce08d678e5fe1385f244cb5cf664.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N6MmCiXNdBMGPAOhri5oHg.png"/></div></div></figure><p id="9bf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">像视频帮助聊天这样的网站用例是前端框架的一个很好的论据。也许网站的其余部分与视频聊天无关，或者也许您想在多个地方或多种配置下使用聊天。出于各种原因，这是您可能希望在组件中构建的那种东西。</p><p id="2499" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在前端框架谱的较新一端，Svelte可能是一个更容易接近的选择。如果你还没有致力于一个框架，那么以如此熟悉的方式开始使用HTML、CSS和JavaScript可能会更快。由于制作视频需要各种各样的片段，所以对于这个例子来说，学习更少是一个有用的特性。</p><h1 id="74af" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">先决条件</h1><p id="7b1b" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">为了开始一个新的苗条项目，<a class="ae lz" href="https://svelte.dev/blog/the-easiest-way-to-get-started" rel="noopener ugc nofollow" target="_blank">建议</a>使用<a class="ae lz" href="https://github.com/Rich-Harris/degit" rel="noopener ugc nofollow" target="_blank"> degit </a>，这是一个方便的工具，可以平稳地下载和解压缩应用程序模板。您可以使用<code class="fe ma mb mc md b">npx</code>启动一个新的苗条项目:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="26e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦有了副本，运行<code class="fe ma mb mc md b">npm install</code>来安装依赖项。</p><p id="d926" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在你可以导航到<code class="fe ma mb mc md b">video-help-chat</code>目录，你会看到一个新的苗条项目的脚手架。在进入代码本身之前，您需要一些东西来使视频聊天工作:</p><ul class=""><li id="751d" class="mk ml iq ka b kb kc kf kg kj mm kn mn kr mo kv mp mq mr ms bi translated">一个<a class="ae lz" href="https://tokbox.com/account/#/" rel="noopener ugc nofollow" target="_blank"> Vonage视频API开发者账户</a></li><li id="0794" class="mk ml iq ka b kb mt kf mu kj mv kn mw kr mx kv mp mq mr ms bi translated">快速管理视频会话</li><li id="ae83" class="mk ml iq ka b kb mt kf mu kj mv kn mw kr mx kv mp mq mr ms bi translated">同时运行快速和苗条</li><li id="df92" class="mk ml iq ka b kb mt kf mu kj mv kn mw kr mx kv mp mq mr ms bi translated">Dotenv以便您可以将您的凭证保存在一个<code class="fe ma mb mc md b">.env</code>文件中</li></ul><p id="c0c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你没有Vonage视频API账户，你需要先<a class="ae lz" href="https://tokbox.com/account/user/signup" rel="noopener ugc nofollow" target="_blank">注册试用</a>。创建视频服务器的工具都可以从npm安装:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><h1 id="b2c0" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">苗条和快速，一起</h1><p id="3ab4" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">并发允许你从你的<code class="fe ma mb mc md b">package.json</code>中的一个<code class="fe ma mb mc md b">script</code>一次执行多个命令。你可以用它来启动你的Express服务器，同时运行Rollup来重建Svelte。因为在<code class="fe ma mb mc md b">scripts</code>中已经有了处理Svelte的命令，所以可以对npm脚本进行分层，添加一个运行现有脚本的新脚本:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><h1 id="03bb" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">设置您的凭据</h1><p id="fc31" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">立即为您的API密匙和秘密创建一个安全的家是一个很好的实践。创建一个<code class="fe ma mb mc md b">.env</code>文件来存储这些和任何其他敏感数据。在提交代码之前，确保将文件添加到<code class="fe ma mb mc md b">.gitignore</code>中，这样它就不会被意外签入。如果你以后宿主这段代码，你的宿主可能会有一个安全的方法让你在那里重新填充<code class="fe ma mb mc md b">.env</code>文件。</p><p id="e221" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，你只需要<code class="fe ma mb mc md b">.env</code>中的两个属性:你的Vonage视频API key和secret。两者都应该用引号括起来，没有空格:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><h1 id="cdb4" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">计算机网络服务器</h1><p id="5d86" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">您的服务器将使用您提供的凭据来创建Vonage视频API客户端。</p><blockquote class="my mz na"><p id="0421" class="jy jz nb ka b kb kc kd ke kf kg kh ki nc kk kl km nd ko kp kq ne ks kt ku kv ij bi translated">Vonage视频API以前被称为OpenTok。这个名字仍然在一些代码中使用，我们将在这里继续使用它，这样代码看起来更像我们以前的教程。</p></blockquote><p id="e5db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先导入Express并创建Express应用程序。然后你可以为<code class="fe ma mb mc md b">/chat</code>创建一条路线。您经常看到在Express服务器的顶部附近处理静态页面，但是在这里您将在最后处理它们。这是为了限制我们将多少责任交还给应用程序的瘦端，所以它不会试图处理我们的服务器端点。最后，您可以告诉服务器监听端口5000。</p><p id="823d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ma mb mc md b">/chat</code>终点是有趣的事情发生的地方。该函数将返回在前端创建视频聊天所需的凭证。它还以一种非常基本的方式管理视频聊天会话，返回现有的会话，或者创建一个新的会话(如果没有的话)。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><blockquote class="my mz na"><p id="ad8f" class="jy jz nb ka b kb kc kd ke kf kg kh ki nc kk kl km nd ko kp kq ne ks kt ku kv ij bi translated">要开始将这个例子集成到一个真实的站点中，上面的<code class="fe ma mb mc md b">sessionId</code>变量是你的入口点。您总是可以从<code class="fe ma mb mc md b">/chat</code>端点创建一个新的会话，并将id添加到一个堆栈中，而不是单个变量。然后，负责回复视频聊天的团队可以访问这些会话id来加入等待的呼叫。</p></blockquote><h1 id="6b96" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">客户</h1><p id="619b" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">您的模板应用程序应该在<code class="fe ma mb mc md b">/public/src</code>下包含一个填充的<code class="fe ma mb mc md b">App.svelte</code>文件。现在应该可以通过在您的终端上键入以下命令来运行和测试它:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="06a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你打开浏览器，进入“localhost:5000”，你应该会看到一个简洁的hello world页面。</p><p id="9f32" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当您打开<code class="fe ma mb mc md b">App.svelte</code>时，继续添加对我们接下来将创建的组件的引用。首先，导入组件，我们称之为<code class="fe ma mb mc md b">Chat.svelte</code>:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="b783" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在页面底部的<code class="fe ma mb mc md b">&lt;style&gt;</code>标签上方，添加组件本身:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><h2 id="e709" class="nf kx iq bd ky ng nh dn lc ni nj dp lg kj nk nl lk kn nm nn lo kr no np ls nq bi translated">聊天组件</h2><p id="147d" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">您正在运行的应用程序现在可能会有一些抱怨，所以赶紧将<code class="fe ma mb mc md b">Chat.svelte</code>文件添加到<code class="fe ma mb mc md b">/public/src</code>中。同时，你也可以添加<code class="fe ma mb mc md b">ChatButton.svelte</code>和<code class="fe ma mb mc md b">VideoChat.svelte</code>文件。</p><p id="a12a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">聊天组件只是聊天的一个容器，有两种状态。最初，用户会看到一个链接来启动聊天。一旦他们点击链接，他们将进入视频聊天本身。聊天组件管理两者之间的切换，这将被封装在它们自己的组件中。</p><p id="a47a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你没有使用过很多细长的组件，这是一个很好的最小组件。你可以看到它只是JavaScript、HTML和CSS。它看起来很像一个静态的HTML页面，只是没有内容和元信息:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="349e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为它只是状态的容器，所以组件只有一个属性<code class="fe ma mb mc md b">collapsed</code>是有意义的。它导入另外两个组件，并使用标记中的条件结构确定显示哪个组件。最后，有些CSS把容器贴在右下角。如果聊天是打开的，一个条件CSS类将拉伸容器。</p><h2 id="37bd" class="nf kx iq bd ky ng nh dn lc ni nj dp lg kj nk nl lk kn nm nn lo kr no np ls nq bi translated">聊天按钮功能</h2><p id="3437" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">ChatButton组件的大部分是装饰性的CSS，使它看起来像一个小的语音气球。然而，这也是Svelte如何处理事件和组件间通信的一个例子。</p><p id="5165" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该组件只导出一个属性<code class="fe ma mb mc md b">showButton</code>。这不是在组件中使用，而是在它的父组件中使用。它被绑定到聊天标记中聊天组件的<code class="fe ma mb mc md b">collapsed</code>属性:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="eda7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当点击按钮时，调用<code class="fe ma mb mc md b">openChat</code>函数，将<code class="fe ma mb mc md b">showButton</code>的值翻转为false，从而将父节点中的<code class="fe ma mb mc md b">collapsed</code>设置为false。这将打开聊天界面。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><h2 id="d02d" class="nf kx iq bd ky ng nh dn lc ni nj dp lg kj nk nl lk kn nm nn lo kr no np ls nq bi translated">视频聊天</h2><p id="3b2d" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们把好东西(当然是JavaScript)留到了最后。视频聊天组件中没有多少HTML和CSS。有发布者和订阅者的占位符(您和您聊天的人的视图)，还有容器的更多语音气球样式。剩下的就是JS了。</p><p id="2d57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要创建视频聊天，您需要做几件事:</p><ul class=""><li id="e74d" class="mk ml iq ka b kb kc kf kg kj mm kn mn kr mo kv mp mq mr ms bi translated">从服务器获取会话(新创建的或正在进行的，客户端不关心)</li><li id="857f" class="mk ml iq ka b kb mt kf mu kj mv kn mw kr mx kv mp mq mr ms bi translated">初始化它</li><li id="bcd8" class="mk ml iq ka b kb mt kf mu kj mv kn mw kr mx kv mp mq mr ms bi translated">收听要创建的流，然后订阅它</li><li id="3a46" class="mk ml iq ka b kb mt kf mu kj mv kn mw kr mx kv mp mq mr ms bi translated">倾听会话被断开</li><li id="4ccd" class="mk ml iq ka b kb mt kf mu kj mv kn mw kr mx kv mp mq mr ms bi translated">初始化发布(发送视频和音频)</li><li id="12e8" class="mk ml iq ka b kb mt kf mu kj mv kn mw kr mx kv mp mq mr ms bi translated">连接到会话并向其发布</li></ul><p id="f4b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大部分工作将发生在一个名为<code class="fe ma mb mc md b">initSession</code>的函数中，一旦客户机成功地从服务器获得一个会话，就会调用这个函数。去掉了<code class="fe ma mb mc md b">initSession</code>的肉，组件并不太复杂。它使用<code class="fe ma mb mc md b">fetch</code>来获取会话，并定义一个错误处理程序。然后，它为视频聊天定义标记占位符，并使用CSS对其进行布局:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="6606" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ma mb mc md b">initSession</code>的内容多为回调。首先为<code class="fe ma mb mc md b">streamCreated</code>创建一个监听器，并在其中定义一个选项对象，用它来调用<code class="fe ma mb mc md b">session.subscribe()</code>。您还可以为<code class="fe ma mb mc md b">sessionDisconnected</code>创建一个监听器。目前，这个组件不会向其父组件提供反馈，但是如果它在聊天结束时发出信号，将会更加健壮。<code class="fe ma mb mc md b">sessionDisconnected</code>处理程序将是一个实现这一点的地方。</p><p id="8744" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以创建看起来像您的<code class="fe ma mb mc md b">subscriberOptions</code>一样的<code class="fe ma mb mc md b">publisherOptions</code>，并指示视频元素应该以100%的高度和宽度附加到其容器中。然后，您可以初始化发布者。</p><p id="a9d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，准备好您的发布者，用<code class="fe ma mb mc md b">session.connect()</code>连接到会话。成功连接后，您可以使用<code class="fe ma mb mc md b">session.publish()</code>开始发布。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><h1 id="be63" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">尝试一下</h1><p id="8e48" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">如果您的服务器一直在运行，您应该能够在打开的浏览器选项卡中看到部分或全部代码。不过，您可能需要重启服务器。在您的终端中，按Ctrl+C关闭程序，然后使用<code class="fe ma mb mc md b">npm run serve</code>再次启动Express和Svelte。</p><p id="39a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在浏览器中打开或返回<code class="fe ma mb mc md b">localhost:5000</code>。尝试聊天的最简单方法是打开另一个浏览器，然后进入<code class="fe ma mb mc md b">localhost:5000</code>。这不是很复杂，但是你听到的回声应该可以让你确认聊天正在进行。</p><h1 id="5ce4" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">后续步骤</h1><p id="5026" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">现在你有了一个基本的聊天，你可以用<a class="ae lz" href="https://tokbox.com/developer/" rel="noopener ugc nofollow" target="_blank"> Vonage视频API </a>做更多的事情。或者，您可以选择暂时保留这些功能，并对服务器提供会话的方式进行一些更改，以便用户可以从这个界面“提问”,内部用户可以从另一个界面“回答”。</p><p id="6086" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">他们出色的教程<a class="ae lz" href="https://svelte.dev/tutorial" rel="noopener ugc nofollow" target="_blank">展示了你可以做的更多事情。如果你想在聊天中加入更多功能，比如收集用户的姓名或电子邮件，这些工具会非常方便。</a></p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="2ed0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nb">原载于</em><a class="ae lz" href="https://learn.vonage.com/blog/2020/12/16/create-a-video-help-chat-with-node-js-and-svelte" rel="noopener ugc nofollow" target="_blank"><em class="nb">https://learn . vonage . com/blog/2020/12/16/create-a-video-help-chat-with-node-js-and-svelte</em></a></p></div></div>    
</body>
</html>