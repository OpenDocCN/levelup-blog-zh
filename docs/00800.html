<html>
<head>
<title>Easy data seeding in .NET (Core) applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">轻松植入数据。网络(核心)应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/easy-database-seeding-in-net-core-applications-f8bcc7a15112?source=collection_archive---------1-----------------------#2019-08-04">https://levelup.gitconnected.com/easy-database-seeding-in-net-core-applications-f8bcc7a15112?source=collection_archive---------1-----------------------#2019-08-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/342c44eb30cd866d9a1f882639506a99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wjmBZecQaOds6f_v5KChsw.png"/></div></div></figure><p id="5c29" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">播种数据库可能是一项相当棘手的任务。这里我们将介绍一些简化这一操作的工具。</p><h1 id="e14d" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">问题</h1><p id="bcd0" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">当我们发布一个. NET(核心)项目时，在首次启动应用程序时，创建底层数据库并用一些数据填充它通常是必不可少的。</p><p id="8272" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">例如，让我们想象你有一个演示应用程序的一些图书馆和它的演示，这是必要的，数据库已经有一些数据。<br/>另一个可能的用例:我们应用程序的每个副本都使用它自己的数据库，我们需要在安装期间或第一次启动时用一些初始内容填充它。</p><p id="640e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建数据库不是一个大问题，特别是如果项目使用实体框架(核心)——它可以在一行代码中完成。然而，用数据填充我们的数据库是完全不同的事情，在中没有现成的解决方案来完成这项任务。NET或实体框架。</p><p id="9fc9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此外，当所需的种子数据已经存在于本地计算机的数据库中时，这种情况并不少见，但是您需要一种方法将这些数据包含在项目中，并在应用程序启动时部署它们。</p><h1 id="b8a2" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">解决办法</h1><p id="b6ea" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">当然，有许多不同的方法来解决上述任务。</p><p id="80c7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将在DbTool实用程序和<a class="ae mc" href="https://github.com/kedonec/Korzh.DbUtils" rel="noopener ugc nofollow" target="_blank"> Korzh的帮助下尝试这样做。DbUtils </a>库。这两个都是开源项目，可以在<a class="ae mc" href="https://github.com/kedonec/Korzh.DbUtils" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p><p id="97e4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">DbTool是一个. NET核心全局工具，可以安装在任何装有<a class="ae mc" href="https://dotnet.microsoft.com/download" rel="noopener ugc nofollow" target="_blank">的电脑上。NET Core SDK </a>使用一个简单的控制台命令。使用这个实用程序，我们将把数据库数据导出为某种适合分发的格式(JSON或XML)。</p><p id="19f3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后，我们将在项目中包含结果数据文件，并使用Korzh。DbUtils库在应用程序第一次启动时初始化我们的数据库。</p><h1 id="5c0c" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">步骤1:使用DbTool导出数据库数据</h1><h2 id="6a3d" class="md la it bd lb me mf dn lf mg mh dp lj km mi mj ln kq mk ml lr ku mm mn lv mo bi translated">1.1安装DbTool</h2><p id="67f3" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">我们之前说过，DbTool是一个全局的。NET Core实用工具，可以安装在您的计算机上，然后在您的系统上用作任何其他shell命令。你将需要<a class="ae mc" href="https://dotnet.microsoft.com/download" rel="noopener ugc nofollow" target="_blank">。要安装在您机器上的NET Core SDK </a>版本2.1(或更高版本)。</p><p id="1950" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">安装DbTool很容易。为此，只需打开终端(命令提示符)并运行以下命令:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="ec2d" class="md la it mu b gy my mz l na nb">dotnet tool install -g Korzh.DbTool</span></pre><p id="3a40" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您在那之后立即运行<code class="fe nc nd ne mu b">dbtool</code>命令，您将看到一个非常详细的帮助，其中包含所有可用命令的列表。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nf"><img src="../Images/8995e18b4f93055194cb44e50367ec0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BxlRR__dXa5K7Pj3PJWHzA.png"/></div></div></figure><h2 id="b73c" class="md la it bd lb me mf dn lf mg mh dp lj km mi mj ln kq mk ml lr ku mm mn lv mo bi translated">1.2注册数据库连接</h2><p id="a8fb" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">首先，我们需要添加一个到数据库的连接:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="e5e8" class="md la it mu b gy my mz l na nb">dbtool connections add {YourConnectionId} {DbType} {YourConnectionString}</span></pre><p id="db12" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里:</p><ul class=""><li id="f993" class="ng nh it kd b ke kf ki kj km ni kq nj ku nk ky nl nm nn no bi translated"><code class="fe nc nd ne mu b">{YourConnectionId}</code>只是您要分配给此连接的唯一名称。</li><li id="af6f" class="ng nh it kd b ke np ki nq km nr kq ns ku nt ky nl nm nn no bi translated"><code class="fe nc nd ne mu b">DbType</code> —数据库服务器的类型。目前(1.2.0版本)，DbTool支持SQL Server ( <code class="fe nc nd ne mu b">sqlserver</code>)、MySQL ( <code class="fe nc nd ne mu b">mysql</code>)和PostgreSQL ( <code class="fe nc nd ne mu b">postgre</code>)数据库。</li><li id="dfbc" class="ng nh it kd b ke np ki nq km nr kq ns ku nt ky nl nm nn no bi translated">这个命令的最后一个参数是一个连接字符串。与您已经在项目中使用的连接数据库的相同。</li></ul><p id="4cab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">示例:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/1f87772a600781276d5d56ac8f3f9d8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*FOhajzS_zCl155TkTtIvUg.png"/></div></figure><p id="6761" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">之后，您可以通过键入以下命令来检查所有连接:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="4d1c" class="md la it mu b gy my mz l na nb">dbtool connections list</span></pre><h2 id="e30d" class="md la it bd lb me mf dn lf mg mh dp lj km mi mj ln kq mk ml lr ku mm mn lv mo bi translated">1.3导出数据</h2><p id="8713" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">现在，当我们添加连接时，我们可以使用<code class="fe nc nd ne mu b">export</code>命令导出数据库:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="aa33" class="md la it mu b gy my mz l na nb">dbtool export {ConnectionId} [--format = xml | json] [--output = path] [--zip = filename]</span></pre><p id="7a1a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">上面列出的任何选项都可以省略。例如，以下命令:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="a60e" class="md la it mu b gy my mz l na nb">dbtool export MyDb01 --zip = MyDbData.zip</span></pre><p id="2e7e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将在当前目录下创建一个名为MyDbData.zip的ZIP归档文件，并用一组JSON(默认)格式的数据文件填充它。每个数据库表的内容都存储在一个单独的。json文件。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/4a8c9d9068ddf7614749dd7503d59c9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*fqKmjz3lMVKb22oHYZOouQ.png"/></div></figure><h1 id="274e" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">步骤2:向您的应用程序添加数据播种代码</h1><p id="715a" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">我们将展示如何使用上一步创建的文件来初始化某个ASP.NET核心项目中的数据库。但是，下面描述的过程可以应用于使用。网芯还是。NET Framework 4 . 6 . 1版或更高版本。<br/>我们这里假设我们的项目使用实体框架(核心)，所以数据库本身是用EF手段自动创建的(使用<code class="fe nc nd ne mu b">EnsureCreated</code>或者<code class="fe nc nd ne mu b">Migrate</code>方法)。我们还假设我们的数据库运行在SQL Server(或其本地变体)下。这里列出的说明对于MySQL DB也几乎相同。</p><h2 id="0fb0" class="md la it bd lb me mf dn lf mg mh dp lj km mi mj ln kq mk ml lr ku mm mn lv mo bi translated">2.1将数据文件添加到项目中</h2><p id="9c02" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">首先，我们需要将' MyDbData.zip '文件添加到您的项目中。它的最佳位置是项目文件夹中的“App_Data”文件夹。<br/>请注意，您还需要将该文件手动包含到您的项目中。NET框架项目。</p><h2 id="88d8" class="md la it bd lb me mf dn lf mg mh dp lj km mi mj ln kq mk ml lr ku mm mn lv mo bi translated">2.2.安装Korzh。DbUtils包</h2><p id="29bb" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">对于我们的任务，我们需要以下2个NuGet包:</p><ul class=""><li id="04fc" class="ng nh it kd b ke kf ki kj km ni kq nj ku nk ky nl nm nn no bi translated"><code class="fe nc nd ne mu b">Korzh.DbUtils.Import</code></li><li id="1dbc" class="ng nh it kd b ke np ki nq km nr kq ns ku nt ky nl nm nn no bi translated"><code class="fe nc nd ne mu b">Korzh.DbUtils.SqlServer</code>(使用MySQL数据库时为<code class="fe nc nd ne mu b">Korzh.DbUtils.MySql</code>)</li></ul><p id="7786" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要安装软件包，您可以使用NuGet软件包管理器、NuGet控制台或手动将它们添加到。csproj文件。</p><h2 id="e5c7" class="md la it bd lb me mf dn lf mg mh dp lj km mi mj ln kq mk ml lr ku mm mn lv mo bi translated">2.3.添加初始化代码</h2><p id="3420" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">最后，我们需要创建一个<code class="fe nc nd ne mu b">DbInitializer</code>类的实例，并在第一次启动时调用它的<code class="fe nc nd ne mu b">Seed</code>方法。这个过程的最佳位置是我们的<code class="fe nc nd ne mu b">Startup</code>类的<code class="fe nc nd ne mu b">Configure</code>方法:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="19de" class="md la it mu b gy my mz l na nb">public void Configure(IApplicationBuilder app, IHostingEnvironment env)<br/>{<br/>    .     .     .     .</span><span id="a0e6" class="md la it mu b gy nw mz l na nb">    app.UseMvc();</span><span id="2dbe" class="md la it mu b gy nw mz l na nb">    //add the following piece of code at the end of your Configure method<br/>    using (var scope = app.ApplicationServices.GetRequiredService&lt;IServiceScopeFactory&gt;().CreateScope())<br/>    using (var context = scope.ServiceProvider.GetService&lt;AppDbContext&gt;()) {<br/>        //the next lines will run only if the database was not created previously<br/>        if (context.Database.EnsureCreated()) { <br/>            Korzh.DbUtils.DbInitializer.Create(options =&gt; {<br/>                //set the connection string for our database<br/>                options.UseSqlServer(Configuration.GetConnectionString("MyDemoDb"));<br/>                options.UseZipPacker(System.IO.Path.Combine(env.ContentRootPath, "App_Data", "MyDbData.zip"));<br/>            })<br/>            .Seed();<br/>        }<br/>    }<br/>}</span></pre><p id="136f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您需要在第一次启动时做一些额外的初始化(例如，添加一些默认的用户帐户)，将所有这些初始化代码隐藏到一个单独的类中，并且只向<code class="fe nc nd ne mu b">IApplicationBuilder</code>接口公开一个扩展函数(姑且称之为<code class="fe nc nd ne mu b">EnsureDbInitialized</code>)将是一个好主意。就像我们在EasyQuery库的<a class="ae mc" href="https://github.com/easyquery/AspNetCoreSamples/blob/master/EqAspNetCoreDemo/Data/DbInitializeExtensions.cs" rel="noopener ugc nofollow" target="_blank">示例项目中所做的一样。</a></p><p id="f590" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这种情况下，您只需要在您的<code class="fe nc nd ne mu b">Startup.Configure</code>方法的末尾添加一个调用:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="45c5" class="md la it mu b gy my mz l na nb">public void Configure(IApplicationBuilder app, IHostingEnvironment env)<br/>{<br/>    .  .  .  .<br/>    app.UseMvc();</span><span id="02db" class="md la it mu b gy nw mz l na nb">    //Init demo database (if necessary)<br/>    app.EnsureDbInitialized(Configuration, env);<br/>}</span></pre><p id="14b1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">就是这样。</p><p id="5ce5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我真的希望本文中介绍的解决方案能为您节省一些时间。感谢您的阅读。</p></div><div class="ab cl nx ny hx nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="im in io ip iq"><div class="mp mq mr ms gt oe"><a href="https://gitconnected.com/learn" rel="noopener  ugc nofollow" target="_blank"><div class="of ab fo"><div class="og ab oh cl cj oi"><h2 class="bd iu gy z fp oj fr fs ok fu fw is bi translated">了解如何编码-查找编码教程| gitconnected</h2><div class="ol l"><h3 class="bd b gy z fp oj fr fs ok fu fw dk translated">从开发者提交和排名的教程中学习任何编程语言、框架或库。教程是…</h3></div><div class="om l"><p class="bd b dl z fp oj fr fs ok fu fw dk translated">gitconnected.com</p></div></div><div class="on l"><div class="oo l op oq or on os jz oe"/></div></div></a></div></div></div>    
</body>
</html>