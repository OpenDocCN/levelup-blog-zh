<html>
<head>
<title>Create a Book Rating System with the Goodreads API and Slash GraphQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Goodreads API和Slash GraphQL创建一个图书评级系统</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/create-a-book-rating-system-with-the-goodreads-api-and-slash-graphql-d885b3999673?source=collection_archive---------19-----------------------#2020-12-02">https://levelup.gitconnected.com/create-a-book-rating-system-with-the-goodreads-api-and-slash-graphql-d885b3999673?source=collection_archive---------19-----------------------#2020-12-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="68c9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">GraphQL是一种相对较新的为消费者构建用户界面和API的方法。它本质上是一种由强类型模式支持的查询语言，这使得编写人类可读的请求以准确获得您需要的数据变得容易。REST的响应由服务器决定，相比之下，GraphQL查询将权力完全放在了客户端手中。</p><p id="c942" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，GraphQL实际上只是一个描述API的规范。人们可能期望从API中得到的许多特性，如授权/认证逻辑、双向通信或速率限制，仍然需要实现。最近推出的<a class="ae ko" href="https://dgraph.io/slash-graphql" rel="noopener ugc nofollow" target="_blank"> Slash GraphQL </a>是一个完全托管的GraphQL后端，它负责设置GraphQL API的所有艰苦工作，让您专注于构建您的应用程序。</p><p id="4f9d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我们将构建一个依赖于Slash GraphQL的电子商务书店。为了展示服务的灵活性，我们还将从另一个来源获取数据—<a class="ae ko" href="https://www.goodreads.com/api" rel="noopener ugc nofollow" target="_blank">Goodreads API</a>—并将其集成到我们的响应中。</p><p id="90c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将使用<a class="ae ko" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>构建我们的应用程序，因此您的机器上应该至少安装了版本12。创建一个名为<em class="kp"> slashql_bookstore </em>的目录，并从命令行导航到该目录。</p><h1 id="3b19" class="kq kr it bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">创建GraphQL后端</h1><h2 id="a524" class="lo kr it bd ks lp lq dn kw lr ls dp la kb lt lu le kf lv lw li kj lx ly lm lz bi translated">设置斜线图形QL</h2><p id="1572" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated"><a class="ae ko" href="https://slash.dgraph.io/" rel="noopener ugc nofollow" target="_blank">在Slash GraphQL </a>上设置一个帐户很简单——你可以立即用你的GitHub帐户登录。该平台提供了一个适用于本文的免费试用版(然后移动到9.99美元/月的固定费用，最高5GB的数据)。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mf"><img src="../Images/e87cf615c669c9a244675d04133ac582.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Za80bOsviM7uWSux"/></div></div></figure><p id="6578" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建帐户后，您需要创建一个新的后端:</p><p id="1f1b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">1.点击“启动新的后端”。</p><p id="25a3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.将后端命名为“书店”。</p><p id="4440" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.点击“启动”。</p><p id="8b48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就是这样！现在，您在AWS区域中拥有了一台服务器。</p><h2 id="dd5f" class="lo kr it bd ks lp lq dn kw lr ls dp la kb lt lu le kf lv lw li kj lx ly lm lz bi translated">定义GraphQL模式</h2><p id="e923" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">每个GraphQL服务器都有一个强类型模式，它定义了消费者可用的对象和字段。</p><p id="5326" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">点击“Schema ”,粘贴以下几行:</p><pre class="mg mh mi mj gt mr ms mt mu aw mv bi"><span id="b7a9" class="lo kr it ms b gy mw mx l my mz">type Book {<br/>  id: Int!<br/>  isbn: Int!<br/>  title: String! @search(by: [fulltext])<br/>  author: Author!<br/>}</span><span id="dad4" class="lo kr it ms b gy na mx l my mz">type Author {<br/>  id: Int!<br/>  firstname: String!<br/>  lastname: String!<br/>}</span></pre><p id="f120" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里我们定义了两种类型——“book”和“author”——它们将在我们的API中表示数据。在Slash GraphQL提供的众多优点中，对定制指令的支持是最方便的。例如，在这里，通过用<a class="ae ko" href="https://dgraph.io/docs/graphql/directives/#search" rel="noopener ugc nofollow" target="_blank"> @search </a>注释“title”字段，我们能够提供一个模糊的文本，而不需要额外的工作。</p><p id="d37f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">单击“部署”将此架构发送到生产环境。</p><h2 id="c5d4" class="lo kr it bd ks lp lq dn kw lr ls dp la kb lt lu le kf lv lw li kj lx ly lm lz bi translated">设置数据</h2><p id="9d47" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">让我们继续插入数据。我们不仅可以使用API Explorer添加数据，还可以查询数据。为了填充我们的GraphQL后端，我们将基于我们的模式，通过Slash GraphQL方便地为我们提供的一个变体来定义一个图书及其作者的列表:</p><pre class="mg mh mi mj gt mr ms mt mu aw mv bi"><span id="5f26" class="lo kr it ms b gy mw mx l my mz">mutation AddData {<br/>  addBook(input: [<br/>    {id: 1, title: “The Sound and The Fury”, isbn: 9780394747743, author: {id:1, firstname: “William”, lastname: “Faulkner”}},<br/>    {id: 2, title: “Light in August”, isbn: 9780394711898, author:{id:1, firstname: “William”, lastname: “Faulkner”}},<br/>    {id: 3, title: “Giovanni’s Room”, isbn: 9780141032948, author:{id:2, firstname: “James”, lastname: “Baldwin”}},<br/>    {id: 4, title: “The Fire Next Time”, isbn: 9780140182750, author: {id:2, firstname: “James”, lastname: “Baldwin”}},<br/>    {id: 5, title: “To The Lighthouse”, isbn: 9780140274165, author: {id:3, firstname: “Virginia”, lastname: “Woolf”}},<br/>    {id: 6, title: “Orlando”, isbn: 9780241284643, author: {id:3, firstname: “Virginia”, lastname: “Woolf”}}<br/>    ]) {<br/>  numUids<br/>  }<br/>}</span></pre><p id="5bf3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">单击巨大的播放按钮，将这些数据添加到后端。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi nb"><img src="../Images/76d54155cfc7d5ee55132485954f9785.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YvEL9bMwAvhUbC_J"/></div></div></figure><p id="966d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们运行一个查询来验证该数据是否存在:</p><pre class="mg mh mi mj gt mr ms mt mu aw mv bi"><span id="fe9d" class="lo kr it ms b gy mw mx l my mz">query GetBooks {<br/>  queryBook {<br/>    title<br/>    isbn<br/>    author {<br/>      firstname<br/>      lastname<br/>    }<br/>  }<br/>}</span></pre><p id="6762" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您应该会看到一个响应，显示您之前插入的所有数据。</p><h1 id="0ab4" class="kq kr it bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">构建服务器</h1><p id="d54c" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">我们现在将使用<a class="ae ko" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a>来设置一个基本的API服务器，它将为用户提供对这个斜杠GraphQL源代码的访问。我们的Express服务器就像一个接口，将请求传递给Slash GraphQL。它最重要的几行是:</p><pre class="mg mh mi mj gt mr ms mt mu aw mv bi"><span id="16dc" class="lo kr it ms b gy mw mx l my mz">const BACKEND_URL = “https://rampant-arm.us-west-2.aws.cloud.dgraph.io/graphql"<br/>async function fetchGraphQL(operationsDoc, variables) {<br/>  const result = await axios({<br/>    method: ‘POST’,<br/>    url: BACKEND_URL,<br/>    headers: {<br/>      ‘Content-Type’: ‘application/json’,<br/>    },<br/>    data: JSON.stringify({<br/>      query: operationsDoc,<br/>      variables,<br/>    }),<br/>  })</span><span id="8ad4" class="lo kr it ms b gy na mx l my mz">  return result.data<br/>}</span><span id="eee0" class="lo kr it ms b gy na mx l my mz">const query = `<br/>query {<br/>  queryBook {<br/>    title<br/>    isbn<br/>    author {<br/>      firstname<br/>      lastname<br/>    }<br/>  }<br/>}<br/>`<br/>app.get(‘/’, jsonParser, async (req, res) =&gt; {<br/>  let gqlResponseData = await fetchGraphQL(query, {})<br/>  res.render(‘index’, { books: gqlResponseData.data.queryBook })<br/>})</span></pre><p id="a555" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里，我们定义了一个助手函数fetchGraphQL，它设置必要的头和数据发送到Slash GraphQL。请记住，您需要更改BACKEND_URL来匹配Slash GraphQL提供给您的URL。然后，我们编写一个GraphQL查询来定义我们想要的数据。最后，我们设置了一个获取数据的路径，然后在我们的视图中呈现它:</p><pre class="mg mh mi mj gt mr ms mt mu aw mv bi"><span id="6bb2" class="lo kr it ms b gy mw mx l my mz">&lt;div class=”container”&gt;<br/>  {{#each books}}<br/>  &lt;div class=”row”&gt;<br/>    &lt;div class=”col-md-4"&gt;<br/>      &lt;h2&gt;{{title}}&lt;/h2&gt;<br/>      &lt;h4&gt;{{author.firstname}} {{author.lastname}}&lt;/h4&gt;<br/>      &lt;p&gt;&lt;strong&gt;ISBN:&lt;/strong&gt; {{isbn}}&lt;/p&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>  &lt;hr&gt;<br/>  {{/each}}<br/>&lt;/div&gt;</span></pre><p id="0216" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的视图由<a class="ae ko" href="https://github.com/express-handlebars/express-handlebars" rel="noopener ugc nofollow" target="_blank">手柄</a>支持，这是一个流行的模板库。我们可以将JSON数据放入一个HTML片段中，并遍历键和值，这使得显示信息变得更加容易。这里我们使用#each循环遍历GraphQL API返回的每本书，然后将数据插入HTML标记。您会注意到我们有匹配JSON键名称的占位符；当查看页面时，这些数据将被实际数据替换。</p><p id="fee8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在npm安装完所有依赖项之后，使用node server.js运行服务器。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mf"><img src="../Images/b96989f42412fab10202ee649ef85ad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MZmB3ZxzuPwvsJha"/></div></div></figure><p id="d90d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您应该得到与Slash GraphQL的API Explorer完全相同的响应。</p><h1 id="dcc4" class="kq kr it bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">扩展服务器</h1><p id="f411" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">最后一步，我们想公开一些关于这些书的评论数据。但是我们不想在这里创建虚拟数据；相反，我们将使用<a class="ae ko" href="https://www.goodreads.com/api" rel="noopener ugc nofollow" target="_blank">Goodreads API</a>。在继续之前，请确保您在那里设置了一个帐户并获得了一个API密钥。</p><p id="842e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Slash GraphQL擅长的许多事情之一是将不同的数据源缝合到一个GraphQL接口中的能力。也许您想要调用您控制下的其他API端点。为了支持这一点，Slash GraphQL提供了<a class="ae ko" href="https://dgraph.io/docs/graphql/custom/directive" rel="noopener ugc nofollow" target="_blank"> @custom </a>指令，允许您为GraphQL字段和解析器实现定制行为。</p><p id="f3e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，让我们将评级信息添加到现有模式中:</p><pre class="mg mh mi mj gt mr ms mt mu aw mv bi"><span id="7b1b" class="lo kr it ms b gy mw mx l my mz">type Rating @remote {<br/>  ratings_count: Int!<br/>  average_rating: Float!<br/>}</span></pre><p id="d107" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的评级类型定义了我们期望从book.show_by_isbn API 获得的字段名称。我们不需要定义他们的REST API提供的每一个字段，只需要定义我们感兴趣的字段。Slash GraphQL将知道如何将响应转换成GraphQL响应。</p><p id="f6e4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在字段方面，我们需要指定我们想要调用的URL，以及HTTP方法:</p><pre class="mg mh mi mj gt mr ms mt mu aw mv bi"><span id="2dc5" class="lo kr it ms b gy mw mx l my mz">type Book {<br/>  # …<br/>  rating: Rating @custom(http: {<br/>  url: “https://goodreads-api-munger.glitch.me?isbn=$isbn",<br/>  method: GET<br/>  })<br/>  # …<br/>}</span></pre><p id="06e6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你会注意到这里我们实际上是在召唤<a class="ae ko" href="https://glitch.com/~goodreads-api-munger" rel="noopener ugc nofollow" target="_blank">一个小故障项目</a>。Goodreads API没有以一种漂亮、简洁的格式返回JSON数据。我们将调用一个中间服务器，它将把数据转换成更清晰的格式。这个服务器的细节并不重要(但是如果你想的话，你可以检查一下)。<em class="kp">重要的是</em>注意到这个URL可以代表任何东西，如果你正在与你拥有的数据进行交互，这会非常有帮助。</p><p id="d416" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另一件令人惊奇的事情是，Slash GraphQL将为您替换数据。看到网址上写着$isbn的那部分了吗？根据查询返回的对象，斜杠GraphQL将替换该变量的实字段值。这使您的URL请求灵活且易于管理。</p><p id="6ff4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这就是我们引入一些自定义数据所需要做的全部工作。我们的GraphQL查询现在可以简单地添加这个rating字段来引入外部数据。让我们用这个查询替换server.js中的查询:</p><pre class="mg mh mi mj gt mr ms mt mu aw mv bi"><span id="56c1" class="lo kr it ms b gy mw mx l my mz">const query = `<br/>query {<br/>  queryBook {<br/>    title<br/>    isbn<br/>    rating {<br/>      ratings_count<br/>      average_rating<br/>    }<br/>    author {<br/>      firstname<br/>      lastname<br/>    }<br/>  }<br/>}<br/>`</span></pre><p id="1dc6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们更新视图以显示这些信息:</p><pre class="mg mh mi mj gt mr ms mt mu aw mv bi"><span id="0369" class="lo kr it ms b gy mw mx l my mz">&lt;div class=”container”&gt;<br/>  {{#each books}}<br/>    &lt;div class=”row”&gt;<br/>      &lt;div class=”col-md-4"&gt;<br/>      &lt;h2&gt;{{title}}&lt;/h2&gt;<br/>      &lt;h4&gt;{{author.firstname}} {{author.lastname}}&lt;/h4&gt;<br/>      &lt;p&gt;&lt;strong&gt;ISBN:&lt;/strong&gt; {{isbn}}&lt;/p&gt;<br/>      &lt;p&gt;Rating: {{rating.average_rating}} (out of {{rating.ratings_count}} votes)&lt;/p&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>  &lt;hr&gt;<br/>  {{/each}}<br/>&lt;/div&gt;</span></pre><p id="4860" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您重新启动服务器并返回到localhost:3000，您现在应该也看到填充的评级:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mf"><img src="../Images/df1a265159cd7f45b952ca52e3a0ab8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UqPldtMx_oYmHWCO"/></div></div></figure><h1 id="dcc8" class="kq kr it bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">结论</h1><p id="afac" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">Slash GraphQL使得建立一个生产级的GraphQL API变得非常容易，但是我们仅仅触及了表面。除了能够组合不同的数据位置，它还支持<a class="ae ko" href="https://dgraph.io/docs/graphql/authorization/authorization-overview/" rel="noopener ugc nofollow" target="_blank">授权</a>、<a class="ae ko" href="https://dgraph.io/docs/graphql/subscriptions/" rel="noopener ugc nofollow" target="_blank">订阅</a>，甚至<a class="ae ko" href="https://dgraph.io/docs/enterprise-features/encryption-at-rest/" rel="noopener ugc nofollow" target="_blank">加密</a>。</p><p id="632f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以在GitHub 获得本教程<a class="ae ko" href="https://github.com/gjtorikian/slashql_bookstore" rel="noopener ugc nofollow" target="_blank">的完整源代码。如果你还没有，一定要注册</a><a class="ae ko" href="https://dgraph.io/slash-graphql" rel="noopener ugc nofollow" target="_blank">Slash graph QL</a>——随时与<a class="ae ko" href="https://discuss.dgraph.io/" rel="noopener ugc nofollow" target="_blank"> Dgraph社区的其他人分享你的创作。</a></p></div></div>    
</body>
</html>