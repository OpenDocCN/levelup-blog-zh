<html>
<head>
<title>Using ObjectsComparer to compare objects in .Net</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ObjectsComparer比较中的对象。网</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-objectscomparer-to-compare-objects-in-net-c-2a4faab9630e?source=collection_archive---------1-----------------------#2019-07-18">https://levelup.gitconnected.com/using-objectscomparer-to-compare-objects-in-net-c-2a4faab9630e?source=collection_archive---------1-----------------------#2019-07-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/5b55695209398ae1835415ffd3a0ef51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8qYjIiwfBifUCaAw"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">迪特尔马·贝克尔在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="2b32" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对象比较器框架提供了通过属性递归比较复杂对象的机制(支持数组、列表、不同类型的动态对象等)，允许覆盖特定属性和类型的比较规则。</p><h1 id="4c22" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">介绍</h1><p id="fc24" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">当需要比较复杂的对象时，这是很常见的情况。有时对象可以包含嵌套元素，或者一些成员应该从比较中排除(自动生成的标识符、创建/更新日期等。)，或者某些成员可以有自定义的比较规则(不同格式的相同数据，如电话号码)。这个小框架就是为解决这类问题而开发的。</p><p id="2116" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">简而言之，Objects Comparer是一个对象对对象的比较器，它允许递归地逐个成员地比较对象，并为某些属性、字段或类型定义自定义的比较规则。</p><p id="08ef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对象比较器可用于。净核心项目(。Net标准1.6、2.0或以上)和in。Net项目(4.5版或更高版本)。</p><p id="f2d1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">支持的对象:</p><ul class=""><li id="98f6" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">原始类型</li><li id="9f84" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">类别和结构</li><li id="b3eb" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">可枚举(数组、集合、列表、字典等。)</li><li id="f5e0" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">多维数组</li><li id="71b1" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">列举</li><li id="0cf8" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">旗帜</li><li id="b0e2" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">动态对象(<code class="fe mv mw mx my b">ExpandoObject</code>、<code class="fe mv mw mx my b">DynamicObject</code>和编译器生成的动态对象)。</li></ul><h1 id="19ae" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">装置</h1><p id="b628" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">对象比较器可以作为NuGet包安装。</p><p id="6828" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">安装包对象比较器</p><h1 id="c63a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">源代码</h1><p id="e361" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">源代码可以在<a class="ae kf" href="https://github.com/ValeraT1982/ObjectsComparer" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu"> GitHub </strong> </a>上找到。</p><h1 id="e978" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">基本示例</h1><p id="f15b" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为了展示如何使用对象比较器，让我们创建两个类</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="bea4" class="nh lf it my b gy ni nj l nk nl">public class ClassA<br/>{<br/>    public string StringProperty { get; set; }</span><span id="af1e" class="nh lf it my b gy nm nj l nk nl">public int IntProperty { get; set; }</span><span id="9d0a" class="nh lf it my b gy nm nj l nk nl">public SubClassA SubClass { get; set; }<br/>}</span><span id="2495" class="nh lf it my b gy nm nj l nk nl">public class SubClassA<br/>{<br/>    public bool BoolProperty { get; set; }<br/>}</span></pre><p id="1472" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是一些例子，说明如何使用Objects Comparer来比较这些类的实例。</p><p id="45b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">隐藏复制代码</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="7709" class="nh lf it my b gy ni nj l nk nl"><em class="nn">//Initialize objects and comparer</em><br/>var a1 = new ClassA { StringProperty = "String", IntProperty = 1 };<br/>var a2 = new ClassA { StringProperty = "String", IntProperty = 1 };<br/>var comparer = new Comparer&lt;ClassA&gt;();</span><span id="0eea" class="nh lf it my b gy nm nj l nk nl"><em class="nn">//Compare objects</em><br/>IEnumerable&lt;Difference&gt; differences;<br/>var isEqual = comparer.Compare(a1, a2, out differences);</span><span id="0576" class="nh lf it my b gy nm nj l nk nl"><em class="nn">//Print results</em><br/>Debug.WriteLine(isEqual ? "Objects are equal" : string.Join(Environment.NewLine, differenses));</span></pre><blockquote class="no np nq"><p id="1bea" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Objects are equal</em></code></p></blockquote><p id="62c5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在下面的例子中<strong class="ki iu">比较对象</strong>和<strong class="ki iu">打印结果</strong>为了简洁起见，除了一些情况外，将跳过这些块。</p><p id="d6da" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">隐藏复制代码</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="2c5a" class="nh lf it my b gy ni nj l nk nl">var a1 = new ClassA { StringProperty = "String", IntProperty = 1 };<br/>var a2 = new ClassA { StringProperty = "String", IntProperty = 2 };<br/>var comparer = new Comparer&lt;ClassA&gt;();</span></pre><blockquote class="no np nq"><p id="8763" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='IntProperty', Value1='1', Value2='2'.</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="1a43" class="nh lf it my b gy ni nj l nk nl">var a1 = new ClassA { SubClass = new SubClassA { BoolProperty = true } };<br/>var a2 = new ClassA { SubClass = new SubClassA { BoolProperty = false } };<br/>var comparer = new Comparer&lt;ClassA&gt;();</span></pre><blockquote class="no np nq"><p id="d15a" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='SubClass.BoolProperty', Value1='True', Value2='False'.</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="0c31" class="nh lf it my b gy ni nj l nk nl">var a1 = new StringBuilder("abc");<br/>var a2 = new StringBuilder("abd");<br/>var comparer = new Comparer&lt;StringBuilder&gt;();</span></pre><blockquote class="no np nq"><p id="b367" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='', Value1='abc', Value2='abd'.</em></code></p></blockquote><h1 id="d783" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">可枚举(数组、集合、列表等。)</h1><p id="244d" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在这种情况下，可枚举数可以有不同数量的元素，或者某些元素可以有不同的值。可枚举数可以是泛型或非泛型的。在非泛型可枚举元素的情况下，如果该元素的类型相等，则具有相同索引的元素将被比较，否则与<code class="fe mv mw mx my b">DifferenceType=TypeMismatch</code> <strong class="ki iu"> </strong>的差异将被添加到差异列表中。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="165c" class="nh lf it my b gy ni nj l nk nl">var a1 = new[] { 1, 2, 3 };<br/>var a2 = new[] { 1, 2, 3 };<br/>var comparer = new Comparer&lt;int[]&gt;();</span></pre><blockquote class="no np nq"><p id="ebc2" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Objects are equal</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="2309" class="nh lf it my b gy ni nj l nk nl">var a1 = new[] { 1, 2 };<br/>var a2 = new[] { 1, 2, 3 };<br/>var comparer = new Comparer&lt;int[]&gt;();</span></pre><blockquote class="no np nq"><p id="d757" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Length', Value1='2', Value2='3'.</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="ca93" class="nh lf it my b gy ni nj l nk nl">var a1 = new[] { 1, 2, 3 };<br/>var a2 = new[] { 1, 4, 3 };<br/>var comparer = new Comparer&lt;int[]&gt;();</span></pre><blockquote class="no np nq"><p id="46d1" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='[1]', Value1='2', Value2='4'.</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="cbae" class="nh lf it my b gy ni nj l nk nl">var a1 = new ArrayList { "Str1", "Str2" };<br/>var a2 = new ArrayList { "Str1", 5 };<br/>var comparer = new Comparer&lt;ArrayList&gt;();</span></pre><blockquote class="no np nq"><p id="5792" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=TypeMismatch, MemberPath='[1]', Value1='Str2', Value2='5'.</em></code></p></blockquote><h1 id="f1e2" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">设置</h1><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="5e43" class="nh lf it my b gy ni nj l nk nl">var a1 = new[] { 1, 2, 3 };<br/>var a2 = new[] { 1, 2, 3 };<br/>var comparer = new Comparer&lt;int[]&gt;();</span></pre><blockquote class="no np nq"><p id="7f7e" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Objects are equal</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="df57" class="nh lf it my b gy ni nj l nk nl">var a1 = new HashSet&lt;int&gt; { 1, 2, 3 };<br/>var a2 = new HashSet&lt;int&gt; { 2, 1, 4 };<br/>var comparer = new Comparer&lt;HashSet&lt;int&gt;&gt;();</span></pre><blockquote class="no np nq"><p id="59a0" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=MissedElementInSecondObject, MemberPath='', Value1='3', Value2=''.&lt;br /&gt; Difference: DifferenceType=MissedElementInFirstObject, MemberPath='', Value1='', Value2='4'.</em></code></p></blockquote><h1 id="3657" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">多维数组</h1><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="3187" class="nh lf it my b gy ni nj l nk nl">var a1 = new[] { new[] { 1, 2 } };<br/>var a2 = new[] { new[] { 1, 3 } };<br/>var comparer = new Comparer&lt;int[][]&gt;();</span></pre><blockquote class="no np nq"><p id="3ca9" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='[0][1]', Value1='2', Value2='3'.</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="0e6d" class="nh lf it my b gy ni nj l nk nl">var a1 = new[] { new[] { 1, 2 } };<br/>var a2 = new[] { new[] { 2, 2 }, new[] { 3, 5 } };<br/>var comparer = new Comparer&lt;int[][]&gt;();</span></pre><blockquote class="no np nq"><p id="5a1f" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Length', Value1='1', Value2='2'.</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="c8d4" class="nh lf it my b gy ni nj l nk nl">var a1 = new[] { new[] { 1, 2 }, new[] { 3, 5 } };<br/>var a2 = new[] { new[] { 1, 2 }, new[] { 3, 5, 6 } };<br/>var comparer = new Comparer&lt;int[][]&gt;();</span></pre><blockquote class="no np nq"><p id="a824" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='[1].Length', Value1='2', Value2='3'.</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="0777" class="nh lf it my b gy ni nj l nk nl">var a1 = new[,] { { 1, 2 }, { 1, 3 } };<br/>var a2 = new[,] { { 1, 3, 4 }, { 1, 3, 8 } };<br/>var comparer = new Comparer&lt;int[,]&gt;();</span></pre><blockquote class="no np nq"><p id="0797" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Dimension1', Value1='2', Value2='3'.</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="8b30" class="nh lf it my b gy ni nj l nk nl">var a1 = new[,] { { 1, 2 } };<br/>var a2 = new[,] { { 1, 3 } };<br/>var comparer = new Comparer&lt;int[,]&gt;();</span></pre><blockquote class="no np nq"><p id="cde8" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='[0,1]', Value1='2', Value2='3'.</em></code></p></blockquote><h1 id="70c9" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">动态对象</h1><p id="8985" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">C#支持几种类型的对象，这些对象的成员可以在运行时动态添加和移除。</p><h1 id="2b2d" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">ExpandoObject</h1><p id="897e" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果你不熟悉如何使用<code class="fe mv mw mx my b">ExpandoObject</code> <strong class="ki iu"> </strong>你可以阅读<a class="ae kf" href="https://www.oreilly.com/learning/building-c-objects-dynamically" rel="noopener ugc nofollow" target="_blank">这个</a>或者搜索另一个例子。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="1f26" class="nh lf it my b gy ni nj l nk nl">dynamic a1 = new ExpandoObject();<br/>a1.Field1 = "A";<br/>a1.Field2 = 5;<br/>a1.Field4 = 4;<br/>dynamic a2 = new ExpandoObject();<br/>a2.Field1 = "B";<br/>a2.Field3 = false;<br/>a2.Field4 = "C";<br/>var comparer = new Comparer();</span></pre><blockquote class="no np nq"><p id="9136" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Field1', Value1='A', Value2='B'.</em></code></p><p id="484d" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=MissedMemberInSecondObject, MemberPath='Field2', Value1='5', Value2=''.</em></code></p><p id="a50d" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=TypeMismatch, MemberPath='Field4', Value1='4', Value2='C'.</em></code></p><p id="8b48" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=MissedMemberInFirstObject, MemberPath='Field3', Value1='', Value2='False'.</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="5b6b" class="nh lf it my b gy ni nj l nk nl">dynamic a1 = new ExpandoObject();<br/>a1.Field1 = "A";<br/>a1.Field2 = 5;<br/>dynamic a2 = new ExpandoObject();<br/>a2.Field1 = "B";<br/>a2.Field3 = false;<br/>var comparer = new Comparer();</span></pre><blockquote class="no np nq"><p id="6ace" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Field1', Value1='A', Value2='B'.</em></code></p><p id="15cf" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=MissedMemberInSecondObject, MemberPath='Field2', Value1='5', Value2=''.</em></code></p><p id="6c06" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=MissedMemberInFirstObject, MemberPath='Field3', Value1='', Value2='False'.</em></code></p></blockquote><p id="11c1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果成员不存在，可以通过提供自定义的<code class="fe mv mw mx my b">ComparisonSettings</code>来改变行为(参见下面的比较设置)。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="284e" class="nh lf it my b gy ni nj l nk nl">dynamic a1 = new ExpandoObject();<br/>a1.Field1 = "A";<br/>a1.Field2 = 0;<br/>dynamic a2 = new ExpandoObject();<br/>a2.Field1 = "B";<br/>a2.Field3 = false;<br/>a2.Field4 = "S";<br/>var comparer = new Comparer(new ComparisonSettings { UseDefaultIfMemberNotExist = true });</span></pre><blockquote class="no np nq"><p id="6fc8" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Field1', Value1='A', Value2='B'.</em></code></p><p id="a2af" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Field4', Value1='', Value2='S'.</em></code></p></blockquote><h1 id="1af4" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">动态对象</h1><p id="c2ed" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated"><code class="fe mv mw mx my b">DynamicObject</code>是抽象类，不能直接实例化。让我们假设我们有DynamicObject类的这样一个实现。正确实现方法<code class="fe mv mw mx my b">GetDynamicMemberNames</code>是必要的，否则对象比较器不会以正确的方式工作。</p><p id="e179" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你不熟悉如何使用<code class="fe mv mw mx my b">DynamicObject</code> <strong class="ki iu"> </strong>你可以阅读<a class="ae kf" href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/types/walkthrough-creating-and-using-dynamic-objects" rel="noopener ugc nofollow" target="_blank">这个</a>或者搜索另一个例子。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="b940" class="nh lf it my b gy ni nj l nk nl">private class DynamicDictionary : DynamicObject<br/>{<br/>    public int IntProperty { get; set; }</span><span id="139a" class="nh lf it my b gy nm nj l nk nl">private readonly Dictionary&lt;string, object&gt; _dictionary = new Dictionary&lt;string, object&gt;();</span><span id="fedc" class="nh lf it my b gy nm nj l nk nl">public override bool TryGetMember(GetMemberBinder binder, out object result)<br/>    {<br/>        var name = binder.Name;</span><span id="d204" class="nh lf it my b gy nm nj l nk nl">return _dictionary.TryGetValue(name, out result);<br/>    }</span><span id="3497" class="nh lf it my b gy nm nj l nk nl">public override bool TrySetMember(SetMemberBinder binder, object value)<br/>    {<br/>        _dictionary[binder.Name] = value;</span><span id="6f94" class="nh lf it my b gy nm nj l nk nl">return true;<br/>    }</span><span id="bd12" class="nh lf it my b gy nm nj l nk nl">public override IEnumerable&lt;string&gt; GetDynamicMemberNames()<br/>    {<br/>        return _dictionary.Keys;<br/>    }<br/>}</span><span id="b1a0" class="nh lf it my b gy nm nj l nk nl">dynamic a1 = new DynamicDictionary();<br/>a1.Field1 = "A";<br/>a1.Field3 = true;<br/>dynamic a2 = new DynamicDictionary();<br/>a2.Field1 = "B";<br/>a2.Field2 = 8;<br/>a2.Field3 = 1;<br/>var comparer = new Comparer();</span></pre><blockquote class="no np nq"><p id="500a" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Field1', Value1='A', Value2='B'.</em></code></p><p id="bbfb" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=TypeMismatch, MemberPath='Field3', Value1='True', Value2='1'.</em></code></p><p id="d5fb" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=MissedMemberInFirstObject, MemberPath='Field2', Value1='', Value2='8'.</em></code></p></blockquote><h1 id="426e" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">编译器生成的对象</h1><p id="d930" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">这种类型的动态对象最受欢迎，也最容易创建。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="6a81" class="nh lf it my b gy ni nj l nk nl">dynamic a1 = new<br/>{<br/>    Field1 = "A",<br/>    Field2 = 5,<br/>    Field3 = true<br/>};<br/>dynamic a2 = new<br/>{<br/>    Field1 = "B",<br/>    Field2 = 8<br/>};<br/>var comparer = new Comparer();</span><span id="635c" class="nh lf it my b gy nm nj l nk nl">IEnumerable&lt;Difference&gt; differences;<br/>var isEqual = comparer.Compare((object)a1, (object)a2, out differences);</span></pre><blockquote class="no np nq"><p id="e070" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Field1', Value1='A', Value2='B'.</em></code></p><p id="5692" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=TypeMismatch, MemberPath='Field2', Value1='5', Value2='8'.</em></code></p><p id="c0e3" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=MissedMemberInSecondObject, MemberPath='Field3', Value1='True', Value2=''.</em></code></p></blockquote><p id="584c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个例子需要一些额外的解释。对象a1和a2的类型由编译器生成，并且当且仅当对象<code class="fe mv mw mx my b">a1</code>和<code class="fe mv mw mx my b">a2</code>具有相同的成员集(相同的名称和相同的类型)时被认为是相同的类型。如果跳过对<strong class="ki iu">(对象)</strong>的造型，在不同的成员集合中<code class="fe mv mw mx my b">RuntimeBinderException</code>将被抛出。</p><h1 id="dbfe" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">覆盖比较规则</h1><p id="d0d5" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">有时，一些成员需要自定义比较逻辑。要覆盖比较规则，我们需要创建自定义值比较器或提供函数如何比较对象以及如何将这些对象转换为字符串(可选)和过滤函数(可选)。值比较器应该从<code class="fe mv mw mx my b">AbstractValueComparer</code>继承或者应该实现<code class="fe mv mw mx my b">IValueComparer</code>。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="43b5" class="nh lf it my b gy ni nj l nk nl">public class MyValueComparer: AbstractValueComparer&lt;string&gt;<br/>{<br/>    public override bool Compare(string obj1, string obj2, ComparisonSettings settings)<br/>    {<br/>        return obj1 == obj2; <em class="nn">//Implement comparison logic here</em><br/>    }<br/>}</span></pre><p id="bfdf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">覆盖特定类型对象的比较规则。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="2a60" class="nh lf it my b gy ni nj l nk nl"><em class="nn">//Use MyComparer to compare all members of type string </em><br/>comparer.AddComparerOverride&lt;string&gt;(new MyValueComparer());<br/>comparer.AddComparerOverride(typeof(string), new MyValueComparer());<br/><em class="nn">//Use MyComparer to compare all members of type string except members which name starts with "Xyz"</em><br/>comparer.AddComparerOverride(typeof(string), new MyValueComparer(), member =&gt; !member.Name.StartsWith("Xyz"));<br/>comparer.AddComparerOverride&lt;string&gt;(new MyValueComparer(), member =&gt; !member.Name.StartsWith("Xyz"));</span></pre><p id="614c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">覆盖特定成员(字段或属性)的比较规则。如果没有提供<code class="fe mv mw mx my b">toStringFunction</code>参数，对象将使用<code class="fe mv mw mx my b">ToString()</code>方法转换为字符串。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="69e5" class="nh lf it my b gy ni nj l nk nl"><em class="nn">//Use MyValueComparer to compare StringProperty of ClassA</em><br/>comparer.AddComparerOverride(() =&gt; new ClassA().StringProperty, new MyValueComparer());<br/>comparer.AddComparerOverride(<br/>    typeof(ClassA).GetTypeInfo().GetMember("StringProperty").First(),<br/>    new MyValueComparer());<br/><em class="nn">//Compare StringProperty of ClassA by length. If length equal consider that values are equal</em><br/>comparer.AddComparerOverride(<br/>    () =&gt; new ClassA().StringProperty,<br/>    (s1, s2, parentSettings) =&gt; s1?.Length == s2?.Length,<br/>    s =&gt; s?.ToString());<br/>comparer.AddComparerOverride(<br/>    () =&gt; new ClassA().StringProperty,<br/>    (s1, s2, parentSettings) =&gt; s1?.Length == s2?.Length);</span></pre><p id="9c0f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">按名称覆盖特定成员(字段或属性)的比较规则。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="e5be" class="nh lf it my b gy ni nj l nk nl"><em class="nn">//Use MyValueComparer to compare all members with name equal to "StringProperty"</em><br/>comparer.AddComparerOverride("StringProperty", new MyValueComparer());</span></pre><p id="382d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">按类型覆盖的优先级最高，按成员覆盖和按成员名称覆盖的优先级最低。如果同一类型(按类型/按名称/按成员名称)的多个值比较器可以应用于同一个成员，则在比较期间将引发异常<code class="fe mv mw mx my b">AmbiguousComparerOverrideResolutionException</code>。</p><p id="79bf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">示例:</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="cc82" class="nh lf it my b gy ni nj l nk nl">var a1 = new ClassA();<br/>var a2 = new ClassA();<br/>comparer.AddComparerOverride&lt;string&gt;(valueComparer1, member =&gt; member.Name.StartsWith("String"));<br/>comparer.AddComparerOverride&lt;string&gt;(valueComparer2, member =&gt; member.Name.EndsWith("Property"));</span><span id="9556" class="nh lf it my b gy nm nj l nk nl"><strong class="my iu">var result = comparer.Compare(a1, a2);<em class="nn">//Exception here</em></strong></span></pre><h1 id="2170" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">比较设置</h1><p id="a5e3" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">比较器构造函数有一个可选的<strong class="ki iu">设置</strong>参数来配置比较的某些方面。</p><h1 id="1000" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">递归比较</h1><p id="94d7" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">默认情况下为True。如果为真，所有不是基本类型、没有自定义比较规则和没有实现<code class="fe mv mw mx my b">ICompareble</code>的成员将使用与根对象相同的规则进行比较。</p><h1 id="cbbc" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">EmptyAndNullEnumerablesEqual</h1><p id="454b" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">默认情况下为False。如果为真，则为空的可枚举数(数组、集合、列表等。)和空值将被视为相等的值。</p><h1 id="77da" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">UseDefaultIfMemberNotExist</h1><p id="99b9" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果为true并且成员不存在，对象比较器将认为该成员等于相反成员类型的默认值。仅适用于动态类型比较。默认情况下为False。</p><p id="1646" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">比较设置类允许存储可在自定义比较器中使用的自定义值。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="35a2" class="nh lf it my b gy ni nj l nk nl">SetCustomSetting&lt;T&gt;(T value, string key = null)<br/>GetCustomSetting&lt;T&gt;(string key = null)</span></pre><h1 id="0498" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">工厂</h1><p id="7228" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">工厂提供了一种封装比较器创建和配置的方法。工厂应该实现<code class="fe mv mw mx my b">IComparersFactory</code> <strong class="ki iu"> </strong>或者应该继承<code class="fe mv mw mx my b">ComparersFactory</code>。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="c272" class="nh lf it my b gy ni nj l nk nl">public class MyComparersFactory: ComparersFactory<br/>{<br/>    public override IComparer&lt;T&gt; GetObjectsComparer&lt;T&gt;(ComparisonSettings settings = null, IBaseComparer parentComparer = null)<br/>    {<br/>        if (typeof(T) == typeof(ClassA))<br/>        {<br/>            var comparer = new Comparer&lt;ClassA&gt;(settings, parentComparer, this);<br/>            comparer.AddComparerOverride&lt;Guid&gt;(new MyCustomGuidComparer());</span><span id="3b57" class="nh lf it my b gy nm nj l nk nl">return (IComparer&lt;T&gt;)comparer;<br/>        }</span><span id="478e" class="nh lf it my b gy nm nj l nk nl">return base.GetObjectsComparer&lt;T&gt;(settings, parentComparer);<br/>    }<br/>}</span></pre><h1 id="3403" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">非泛型比较器</h1><p id="6684" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">此比较器为每个比较创建比较器的泛型实现。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="b454" class="nh lf it my b gy ni nj l nk nl">var comparer = new Comparer();<br/>var isEqual = comparer.Compare(a1, a2);</span></pre><h1 id="e257" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">有用值比较器</h1><p id="64e2" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">框架包含几个自定义比较器，在许多情况下都很有用。</p><h1 id="37d8" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">不要比较值比较器</h1><p id="5402" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">允许跳过某些字段/类型。有单体实现(<code class="fe mv mw mx my b">DoNotCompareValueComparer.Instance</code>)。</p><h1 id="abaa" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">动态值比较器</h1><p id="cb4d" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">将比较规则作为函数接收。</p><h1 id="c07a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">nullablestringsvaluecomparer</h1><p id="b7d6" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">Null和空字符串被视为相等的值。有单体实现(<code class="fe mv mw mx my b">NulableStringsValueComparer.Instance</code>)。</p><h1 id="5b7e" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">默认值值比较器</h1><p id="af57" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">允许将指定类型的提供值和默认值视为相等的值(参见下面的示例3)。</p><h1 id="f61f" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">IgnoreCaseStringsValueComparer</h1><p id="6d91" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">允许比较字符串时忽略大小写。有单独的实现(<code class="fe mv mw mx my b">IgnoreCaseStringsValueComparer.Instance</code>)。</p><h1 id="59a2" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">尿液比较仪</h1><p id="8065" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">允许比较Uri对象。</p><h1 id="0927" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">例子</h1><p id="18e4" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">还有一些更复杂的例子来说明如何使用对象比较器。</p><h1 id="3902" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">示例1:预期消息</h1><h2 id="df29" class="nh lf it bd lg nu nv dn lk nw nx dp lo kr ny nz ls kv oa ob lw kz oc od ma oe bi translated">挑战</h2><p id="c48b" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">检查收到的消息是否与预期的消息相同。</p><h2 id="05cf" class="nh lf it bd lg nu nv dn lk nw nx dp lo kr ny nz ls kv oa ob lw kz oc od ma oe bi translated">问题</h2><ul class=""><li id="cc99" class="mh mi it ki b kj mc kn md kr of kv og kz oh ld mm mn mo mp bi translated">需要跳过<code class="fe mv mw mx my b">DateCreated</code>、<code class="fe mv mw mx my b">DateSent</code>和<code class="fe mv mw mx my b">DateReceived</code>属性</li><li id="e746" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">需要跳过自动生成的<code class="fe mv mw mx my b">Id</code>属性</li><li id="9793" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">需要跳过<code class="fe mv mw mx my b">Error</code>类的<code class="fe mv mw mx my b">Message</code>属性</li></ul><h2 id="4f2c" class="nh lf it bd lg nu nv dn lk nw nx dp lo kr ny nz ls kv oa ob lw kz oc od ma oe bi translated">解决办法</h2><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="c6f1" class="nh lf it my b gy ni nj l nk nl">public class Error<br/>{<br/>    public int Id { get; set; }</span><span id="330e" class="nh lf it my b gy nm nj l nk nl">public string Messgae { get; set; }<br/>}</span><span id="df40" class="nh lf it my b gy nm nj l nk nl">public class Message<br/>{<br/>    public string Id { get; set; }</span><span id="0c04" class="nh lf it my b gy nm nj l nk nl">public DateTime DateCreated { get; set; }</span><span id="8134" class="nh lf it my b gy nm nj l nk nl">public DateTime DateSent { get; set; }</span><span id="0ec7" class="nh lf it my b gy nm nj l nk nl">public DateTime DateReceived { get; set; }</span><span id="b32d" class="nh lf it my b gy nm nj l nk nl">public int MessageType { get; set; }</span><span id="e5dd" class="nh lf it my b gy nm nj l nk nl">public int Status { get; set; }</span><span id="97fe" class="nh lf it my b gy nm nj l nk nl">public List&lt;Error&gt; Errors { get; set; }</span><span id="be37" class="nh lf it my b gy nm nj l nk nl">public override string ToString()<br/>    {<br/>        return $"Id:{Id}, Type:{MessageType}, Status:{Status}";<br/>    }<br/>}</span></pre><p id="f4cc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正在配置比较器。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="0c09" class="nh lf it my b gy ni nj l nk nl">_comparer = new Comparer&lt;Message&gt;(<br/>    new ComparisonSettings<br/>    {<br/>        <em class="nn">//Null and empty error lists are equal</em><br/>        EmptyAndNullEnumerablesEqual = true<br/>    });<br/><em class="nn">//Do not compare Dates </em><br/>_comparer.AddComparerOverride&lt;DateTime&gt;(DoNotCompareValueComparer.Instance);<br/><em class="nn">//Do not compare Id</em><br/>_comparer.AddComparerOverride(() =&gt; new Message().Id, DoNotCompareValueComparer.Instance);<br/><em class="nn">//Do not compare Message Text</em><br/>_comparer.AddComparerOverride(() =&gt; new Error().Messgae, DoNotCompareValueComparer.Instance);</span><span id="667e" class="nh lf it my b gy nm nj l nk nl">var expectedMessage = new Message<br/>{<br/>    MessageType = 1,<br/>    Status = 0<br/>};</span><span id="a8b5" class="nh lf it my b gy nm nj l nk nl">var actualMessage = new Message<br/>{<br/>    Id = "M12345",<br/>    DateCreated = DateTime.Now,<br/>    DateSent = DateTime.Now,<br/>    DateReceived = DateTime.Now,<br/>    MessageType = 1,<br/>    Status = 0<br/>};</span><span id="cdf3" class="nh lf it my b gy nm nj l nk nl">IEnumerable&lt;Difference&gt; differences;<br/>var isEqual = _comparer.Compare(expectedMessage, actualMessage, out differences);</span></pre><blockquote class="no np nq"><p id="7d74" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Objects are equal</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="f8d5" class="nh lf it my b gy ni nj l nk nl">var expectedMessage = new Message<br/>{<br/>    MessageType = 1,<br/>    Status = 1,<br/>    Errors = new List&lt;Error&gt;<br/>    {<br/>        new Error { Id = 2 },<br/>        new Error { Id = 7 }<br/>    }<br/>};</span><span id="a8ec" class="nh lf it my b gy nm nj l nk nl">var actualMessage = new Message<br/>{<br/>    Id = "M12345",<br/>    DateCreated = DateTime.Now,<br/>    DateSent = DateTime.Now,<br/>    DateReceived = DateTime.Now,<br/>    MessageType = 1,<br/>    Status = 1,<br/>    Errors = new List&lt;Error&gt;<br/>    {<br/>        new Error { Id = 2, Messgae = "Some error #2" },<br/>        new Error { Id = 7, Messgae = "Some error #7" },<br/>    }<br/>};</span><span id="b734" class="nh lf it my b gy nm nj l nk nl">IEnumerable&lt;Difference&gt; differences;<br/>var isEqual = _comparer.Compare(expectedMessage, actualMessage, out differences);</span></pre><blockquote class="no np nq"><p id="8c9e" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Objects are equal</em></code></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="61ec" class="nh lf it my b gy ni nj l nk nl">var expectedMessage = new Message<br/>{<br/>    MessageType = 1,<br/>    Status = 1,<br/>    Errors = new List&lt;Error&gt;<br/>    {<br/>        new Error { Id = 2, Messgae = "Some error #2" },<br/>        new Error { Id = 8, Messgae = "Some error #8" }<br/>    }<br/>};</span><span id="8cf6" class="nh lf it my b gy nm nj l nk nl">var actualMessage = new Message<br/>{<br/>    Id = "M12345",<br/>    DateCreated = DateTime.Now,<br/>    DateSent = DateTime.Now,<br/>    DateReceived = DateTime.Now,<br/>    MessageType = 1,<br/>    Status = 2,<br/>    Errors = new List&lt;Error&gt;<br/>    {<br/>        new Error { Id = 2, Messgae = "Some error #2" },<br/>        new Error { Id = 7, Messgae = "Some error #7" }<br/>    }<br/>};</span><span id="95f8" class="nh lf it my b gy nm nj l nk nl">IEnumerable&lt;Difference&gt; differences;<br/>var isEqual = _comparer.Compare(expectedMessage, actualMessage, out differences);</span></pre><blockquote class="no np nq"><p id="ee45" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Status', Value1='1', Value2='2'.</em></code></p><p id="7c5c" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Errors[1].Id', Value1='8', Value2='7'.</em></code></p></blockquote><h1 id="ed39" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">示例2:人员比较</h1><h2 id="4a3d" class="nh lf it bd lg nu nv dn lk nw nx dp lo kr ny nz ls kv oa ob lw kz oc od ma oe bi translated">挑战</h2><p id="e79b" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">比较不同来源的人。</p><h2 id="e871" class="nh lf it bd lg nu nv dn lk nw nx dp lo kr ny nz ls kv oa ob lw kz oc od ma oe bi translated">问题</h2><ul class=""><li id="36bc" class="mh mi it ki b kj mc kn md kr of kv og kz oh ld mm mn mo mp bi translated"><code class="fe mv mw mx my b">PhoneNumber</code>格式可以不同。例如:“111-555-8888”和“(111) 555 8888”</li><li id="046f" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><code class="fe mv mw mx my b">MiddleName</code>可以存在于一个源中但不存在于另一个源中。只有当<code class="fe mv mw mx my b">MiddleName</code>在两个源中都有值时，比较它才有意义。</li><li id="df8f" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><code class="fe mv mw mx my b">PersonId</code>需要跳过的属性</li></ul><h2 id="8556" class="nh lf it bd lg nu nv dn lk nw nx dp lo kr ny nz ls kv oa ob lw kz oc od ma oe bi translated">解决办法</h2><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="2c03" class="nh lf it my b gy ni nj l nk nl">public class Person<br/>{<br/>    public Guid PersonId { get; set; }</span><span id="d987" class="nh lf it my b gy nm nj l nk nl">public string FirstName { get; set; }</span><span id="7c59" class="nh lf it my b gy nm nj l nk nl">public string LastName { get; set; }</span><span id="34a9" class="nh lf it my b gy nm nj l nk nl">public string MiddleName { get; set; }</span><span id="a7dd" class="nh lf it my b gy nm nj l nk nl">public string PhoneNumber { get; set; }</span><span id="77e8" class="nh lf it my b gy nm nj l nk nl">public override string ToString()<br/>    {<br/>        return $"{FirstName} {MiddleName} {LastName} ({PhoneNumber})";<br/>    }<br/>}</span></pre><p id="834a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">电话号码可以有不同的格式。我们只比较数字吧。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="63d1" class="nh lf it my b gy ni nj l nk nl">public class PhoneNumberComparer: AbstractValueComparer&lt;string&gt;<br/>{<br/>    public override bool Compare(string obj1, string obj2, ComparisonSettings settings)<br/>    {<br/>        return ExtractDigits(obj1) == ExtractDigits(obj2);<br/>    }</span><span id="44ad" class="nh lf it my b gy nm nj l nk nl">private string ExtractDigits(string str)<br/>    {<br/>        return string.Join(<br/>            string.Empty, <br/>            (str ?? string.Empty)<br/>                .ToCharArray()<br/>                .Where(char.IsDigit));<br/>    }<br/>}</span></pre><p id="88d4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">工厂不允许我们每次需要创建比较器时都配置它。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="0818" class="nh lf it my b gy ni nj l nk nl">public class MyComparersFactory: ComparersFactory<br/>{<br/>    public override IComparer&lt;T&gt; GetObjectsComparer&lt;T&gt;(ComparisonSettings settings = null, IBaseComparer parentComparer = null)<br/>    {<br/>        if (typeof(T) == typeof(Person))<br/>        {<br/>            var comparer = new Comparer&lt;Person&gt;(settings, parentComparer, this);<br/>            <em class="nn">//Do not compare PersonId</em><br/>            comparer.AddComparerOverride&lt;Guid&gt;(DoNotCompareValueComparer.Instance);<br/>            <em class="nn">//Sometimes MiddleName can be skipped. Compare only if property has value.</em><br/>            comparer.AddComparerOverride(<br/>                () =&gt; new Person().MiddleName,<br/>                (s1, s2, parentSettings) =&gt; string.IsNullOrWhiteSpace(s1) || string.IsNullOrWhiteSpace(s2) || s1 == s2);<br/>            comparer.AddComparerOverride(<br/>                () =&gt; new Person().PhoneNumber,<br/>                new PhoneNumberComparer());</span><span id="2ea9" class="nh lf it my b gy nm nj l nk nl">return (IComparer&lt;T&gt;)comparer;<br/>        }</span><span id="4d86" class="nh lf it my b gy nm nj l nk nl">return base.GetObjectsComparer&lt;T&gt;(settings, parentComparer);<br/>    }<br/>}</span></pre><p id="c4d5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正在配置比较器。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="03de" class="nh lf it my b gy ni nj l nk nl">_factory = new MyComparersFactory();<br/>_comparer = _factory.GetObjectsComparer&lt;Person&gt;();</span><span id="e65e" class="nh lf it my b gy nm nj l nk nl">var person1 = new Person<br/>{<br/>    PersonId = Guid.NewGuid(),<br/>    FirstName = "John",<br/>    LastName = "Doe",<br/>    MiddleName = "F",<br/>    PhoneNumber = "111-555-8888"<br/>};<br/>var person2 = new Person<br/>{<br/>    PersonId = Guid.NewGuid(),<br/>    FirstName = "John",<br/>    LastName = "Doe",<br/>    PhoneNumber = "(111) 555 8888"<br/>};</span><span id="5f59" class="nh lf it my b gy nm nj l nk nl">IEnumerable&lt;Difference&gt; differences;<br/>var isEqual = _comparer.Compare(person1, person2, out differences);</span></pre><blockquote class="no np nq"><p id="147a" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><em class="it">对象相等</em></p></blockquote><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="d432" class="nh lf it my b gy ni nj l nk nl">var person1 = new Person<br/>{<br/>    PersonId = Guid.NewGuid(),<br/>    FirstName = "Jack",<br/>    LastName = "Doe",<br/>    MiddleName = "F",<br/>    PhoneNumber = "111-555-8888"<br/>};<br/>var person2 = new Person<br/>{<br/>    PersonId = Guid.NewGuid(),<br/>    FirstName = "John",<br/>    LastName = "Doe",<br/>    MiddleName = "L",<br/>    PhoneNumber = "222-555-9999"<br/>};</span><span id="903e" class="nh lf it my b gy nm nj l nk nl">IEnumerable&lt;Difference&gt; differences;<br/>var isEqual = _comparer.Compare(person1, person2, out differences);</span></pre><blockquote class="no np nq"><p id="9fbc" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><em class="it">差异:差异类型=值不匹配，成员路径= '名字'，值1= '杰克'，值2= '约翰'。</em></p><p id="2072" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><em class="it">差异:差异类型=值不匹配，成员路径= '中间名'，值1='F '，值2='L '。</em></p><p id="6f29" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><em class="it">差异:差异类型=值不匹配，成员路径= '电话号码'，值1 = ' 111–555–8888 '，值2 = ' 222–555–9999 '。</em></p></blockquote><h1 id="e1bd" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">示例3:比较JSON配置文件</h1><h2 id="19bd" class="nh lf it bd lg nu nv dn lk nw nx dp lo kr ny nz ls kv oa ob lw kz oc od ma oe bi translated">挑战</h2><p id="a648" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">需要找到一些具有不同设置的文件。Json.NET用于反序列化JSON数据。</p><h2 id="1cde" class="nh lf it bd lg nu nv dn lk nw nx dp lo kr ny nz ls kv oa ob lw kz oc od ma oe bi translated">问题</h2><ul class=""><li id="8f1f" class="mh mi it ki b kj mc kn md kr of kv og kz oh ld mm mn mo mp bi translated">URL可以有也可以没有http前缀。</li><li id="ea2a" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><strong class="ki iu">数据压缩</strong>默认情况下<strong class="ki iu">关闭</strong></li><li id="94e9" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><strong class="ki iu">智能模式1…3 </strong>默认禁用</li><li id="6044" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><strong class="ki iu">需要跳过ConnectionString </strong>、<strong class="ki iu"> Email </strong>和<strong class="ki iu">通知</strong></li><li id="a338" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">如果<strong class="ki iu"> ProcessTaskTimeout </strong>或<strong class="ki iu"> TotalProcessTimeout </strong>设置被跳过，将使用默认值，因此如果在一个文件中设置不存在，而在另一个文件中该设置有默认值，实际上是相同的。</li></ul><h2 id="e2ed" class="nh lf it bd lg nu nv dn lk nw nx dp lo kr ny nz ls kv oa ob lw kz oc od ma oe bi translated">文件</h2><p id="a65c" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">设置0</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="9235" class="nh lf it my b gy ni nj l nk nl">{<br/>  "ConnectionString": "USER ID=superuser;PASSWORD=superpassword;DATA SOURCE=localhost:1111",<br/>  "Email": {<br/>    "Port": 25,<br/>    "Host": "MyHost.com",<br/>    "EmailAddress": "test@MyHost.com"<br/>  },<br/>  "Settings": {<br/>    "DataCompression": "On",<br/>    "DataSourceType": "MultiDataSource",<br/>    "SomeUrl": "http://MyHost.com/VeryImportantData",<br/>    "SomeOtherUrl": "http://MyHost.com/NotSoImportantData/",<br/>    "CacheMode": "Memory",<br/>    "MaxCacheSize": "1GB",<br/>    "SuperModes": {<br/>      "SmartMode1": "Enabled",<br/>      "SmartMode2": "Disabled",<br/>      "SmartMode3": "Enabled"<br/>    }<br/>  },<br/>  "Timeouts": {<br/>    "TotalProcessTimeout": 500,<br/>    "ProcessTaskTimeout": 100<br/>  },<br/>  "BackupSettings": {<br/>    "BackupIntervalUnit": "Day",<br/>    "BackupInterval": 100<br/>  },<br/>  "Notifications": [<br/>    {<br/>      "Phone": "111-222-3333"<br/>    },<br/>    {<br/>      "Phone": "111-222-4444"<br/>    },<br/>    {<br/>      "EMail": "support@MyHost.com"<br/>    }<br/>  ],<br/>  "Logging": {<br/>    "Enabled": true,<br/>    "Pattern": "Logs\\MyApplication.%data{yyyyMMdd}.log",<br/>    "MaximumFileSize": "20MB",<br/>    "Level": "ALL"<br/>  }<br/>}</span></pre><p id="bd45" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">设置1</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="960c" class="nh lf it my b gy ni nj l nk nl">{<br/>  "ConnectionString": "USER ID=admin;PASSWORD=*****;DATA SOURCE=localhost:22222",<br/>  "Email": {<br/>    "Port": 25,<br/>    "Host": "MyHost.com",<br/>    "EmailAddress": "test@MyHost.com"<br/>  },<br/>  "Settings": {<br/>    "DataCompression": "On",<br/>    "DataSourceType": "MultiDataSource",<br/>    "SomeUrl": "MyHost.com/VeryImportantData",<br/>    "SomeOtherUrl": "MyHost.com/NotSoImportantData/",<br/>    "CacheMode": "Memory",<br/>    "MaxCacheSize": "1GB",<br/>    "SuperModes": {<br/>      "SmartMode1": "enabled",<br/>      "SmartMode3": "enabled"<br/>    }<br/>  },<br/>  "BackupSettings": {<br/>    "BackupIntervalUnit": "Day",<br/>    "BackupInterval": 100<br/>  },<br/>  "Notifications": [<br/>    {<br/>      "Phone": "111-222-3333"<br/>    },<br/>    {<br/>      "EMail": "support@MyHost.com"<br/>    }<br/>  ],<br/>  "Logging": {<br/>    "Enabled": true,<br/>    "Pattern": "Logs\\MyApplication.%data{yyyyMMdd}.log",<br/>    "MaximumFileSize": "20MB",<br/>    "Level": "ALL"<br/>  }<br/>}</span></pre><p id="d449" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">设置2</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="e35a" class="nh lf it my b gy ni nj l nk nl">var settings0Json = LoadJson("Settings0.json");<br/>var settings0 = JsonConvert.DeserializeObject&lt;ExpandoObject&gt;(settings0Json);<br/>var settings2Json = LoadJson("Settings2.json");<br/>var settings2 = JsonConvert.DeserializeObject&lt;ExpandoObject&gt;(settings2Json);</span><span id="8252" class="nh lf it my b gy nm nj l nk nl">IEnumerable&lt;Difference&gt; differences;<br/>var isEqual = _comparer.Compare(settings0, settings2, out differences);</span></pre><blockquote class="no np nq"><p id="733d" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Settings.DataCompression', Value1='On', Value2='Off'.</em></code></p><p id="3c23" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Settings.SuperModes.SmartMode1', Value1='Enabled', Value2='Disabled'.</em></code></p><p id="27cd" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Timeouts.ProcessTaskTimeout', Value1='100', Value2='200'.</em></code></p><p id="a7b2" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='BackupSettings.BackupIntervalUnit', Value1='Day', Value2='Week'.</em></code></p><p id="da58" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='BackupSettings.BackupInterval', Value1='100', Value2='2'.</em></code></p><p id="9654" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Logging.Enabled', Value1='True', Value2='False'.</em></code></p><p id="c155" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Logging.MaximumFileSize', Value1='20MB', Value2='40MB'.</em></code></p><p id="17b3" class="kg kh nn ki b kj kk kl km kn ko kp kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="it">Difference: DifferenceType=ValueMismatch, MemberPath='Logging.Level', Value1='ALL', Value2='ERROR'.</em></code></p></blockquote><p id="a330" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样。享受吧。</p></div></div>    
</body>
</html>