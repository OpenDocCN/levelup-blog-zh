<html>
<head>
<title>Amazon Cognito with SMS user verification</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">亚马逊认知与短信用户验证</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/amazon-cognito-with-sms-user-verification-8c0d90121faa?source=collection_archive---------6-----------------------#2022-06-20">https://levelup.gitconnected.com/amazon-cognito-with-sms-user-verification-8c0d90121faa?source=collection_archive---------6-----------------------#2022-06-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="abd8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">包括一个工作角度温泉样本应用程序</h2></div><p id="0250" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://aws.amazon.com/cognito/" rel="noopener ugc nofollow" target="_blank"> Amazon Cognito </a>是一款安全且可扩展的服务，用于管理移动和网络应用的注册、登录和访问控制。有许多<a class="ae lb" href="https://aws.amazon.com/cognito/details/" rel="noopener ugc nofollow" target="_blank">功能</a>，服务的全部广度可以在<a class="ae lb" href="https://docs.aws.amazon.com/cognito/latest/developerguide/what-is-amazon-cognito.html" rel="noopener ugc nofollow" target="_blank">文档</a>中找到。</p><p id="6698" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将创建一个完整的解决方案，通过一个Angular前端应用程序和一个使用Terraform部署的Cognito用户池后端来演示用户注册和登录。</p><p id="ed08" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">源代码可以在<a class="ae lb" href="https://github.com/oliverschenk/aws-cognito-angular/tree/amazon-cognito-with-sms-user-verification" rel="noopener ugc nofollow" target="_blank"> Github </a>中找到。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/292d6868ebf28177e84d8b1472274121.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*XKC4s2Wh_Bi7k1R7L5EKcw.png"/></div></figure><p id="fb36" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">值得注意的是，Cognito提供了很多功能、灵活性和定制。然而，这也是以复杂性为代价的。</p><p id="7ccc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通常，最好的办法是想一想你想在你的应用中实现什么，然后从那里开始研究，而不是试图钻研每一个可能的功能。考虑业务流程，然后是数据和应用程序需求，最后选择满足这些需求的技术。Cognito当然不是市场上唯一的解决方案——还有<a class="ae lb" href="https://auth0.com/" rel="noopener ugc nofollow" target="_blank"> Auth0 </a>、<a class="ae lb" href="https://www.okta.com/au/" rel="noopener ugc nofollow" target="_blank"> Okta </a>、<a class="ae lb" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase </a>、<a class="ae lb" href="https://azure.microsoft.com/en-au/services/active-directory/" rel="noopener ugc nofollow" target="_blank"> Azure AD </a>等等…</p><p id="bb9e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为一种替代方法，AWS提供了一种名为<a class="ae lb" href="https://aws.amazon.com/amplify/" rel="noopener ugc nofollow" target="_blank"> AWS Amplify </a>的服务，除了一系列常见的应用程序功能，还包括用户管理和认证作为其抽象之一。它旨在隐藏认知的复杂性，促进快速开发风格。</p><p id="5f82" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">酷的是，我们仍然可以利用Amplify库的能力，而实际上不必使用完整的Amplify服务。在本文中，我们将利用AWS Amplify Auth库。</p><h1 id="8e83" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated"><strong class="ak">我们将建造什么</strong></h1><p id="71a6" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">我们希望实现的功能包括:</p><ul class=""><li id="2c3a" class="mh mi iq kh b ki kj kl km ko mj ks mk kw ml la mm mn mo mp bi translated">基于电话号码的自助用户注册</li><li id="a9b6" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">使用短信验证码激活帐户</li><li id="0f6d" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">用户登录和注销</li><li id="3d08" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">自定义用户属性</li><li id="845f" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">查看用户配置文件</li><li id="a1ff" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">密码重置</li></ul><h1 id="3a9f" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">解决方案架构</h1><p id="9c98" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">该解决方案包括两个主要部分。第一个是使用Terraform部署在AWS中的后端Cognito基础设施，第二个是将与Cognito服务交互的前端Angular应用程序。</p><p id="4126" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下图显示了该解决方案将构建的内容以及它将支持的流程。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/49dd62c64057950616f826e3a555395c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*iA8eRF6_kGF9C5V6GpKGjw.png"/></div></figure><h2 id="5a88" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">后端</h2><p id="0183" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">后端的主要组件是一个Cognito用户池和相关的配置，以支持我们上面指定的特性。</p><p id="8b70" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Cognito可以针对许多不同的用例进行配置。任何需要强大但可定制的安全性的技术都不可避免地在概念和实践上具有更高的复杂性。</p><p id="3094" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用以下AWS资源可以实现我们想要的与未经身份验证和经过身份验证的用户管理相关的所有功能:</p><ul class=""><li id="9f00" class="mh mi iq kh b ki kj kl km ko mj ks mk kw ml la mm mn mo mp bi translated"><strong class="kh ir"> Cognito用户池<br/> </strong>这是Cognito中的主要用户目录资源。</li><li id="611b" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated"><strong class="kh ir"> Cognito用户池App客户端<br/> </strong>这是一个客户端应用程序，可以作为未经认证的客户端进行Cognito API调用，如注册、登录和密码重置。在我们的例子中，用户池客户端是Angular前端应用程序。</li><li id="820d" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated"><strong class="kh ir">短信角色<br/> </strong>这是Cognito将承担的通过Amazon SNS发送短信的角色。</li></ul><p id="fee8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将在下面的实现中更详细地讨论上述每一项。</p><h2 id="fc41" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">前端</h2><p id="4013" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">前端代表面向用户的应用程序。在本指南中，创建前端是为了演示与Cognito服务交互相关的特定功能。</p><p id="a749" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本指南中的应用程序是使用Angular编写的，但是同样的原则适用于任何在浏览器或移动应用程序中运行的“公共”客户端。Cognito还支持被视为“机密”的应用客户端，如服务器端呈现的应用程序或后端脚本。</p><p id="fdba" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">应用程序使用定制的UI设计，而不是<a class="ae lb" href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-app-integration.html" rel="noopener ugc nofollow" target="_blank"> Cognito托管的UI </a>。这意味着与Cognito的通信必须手动处理。这是通过使用<a class="ae lb" href="https://www.npmjs.com/package/@aws-amplify/auth" rel="noopener ugc nofollow" target="_blank"> AWS Amplify Auth </a>库实现的，该库在幕后使用了<a class="ae lb" href="https://www.npmjs.com/package/amazon-cognito-identity-js" rel="noopener ugc nofollow" target="_blank">Amazon-cognito-identity-js</a>库。</p><h1 id="9c0b" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">先决条件</h1><ul class=""><li id="a1e0" class="mh mi iq kh b ki mc kl md ko ni ks nj kw nk la mm mn mo mp bi translated"><a class="ae lb" href="https://www.terraform.io/intro" rel="noopener ugc nofollow" target="_blank">地形</a></li><li id="12c7" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated"><a class="ae lb" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank">节点。JS </a></li><li id="a2e8" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">[可选] <a class="ae lb" href="https://github.com/99designs/aws-vault" rel="noopener ugc nofollow" target="_blank"> aws-vault </a>(用于凭证管理)</li><li id="32ab" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">[可选] Redux DevTools Chrome扩展(用于可视化NgRx动作和状态)</li><li id="88bf" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">AWS帐户的SMS沙箱中的一个<a class="ae lb" href="https://docs.aws.amazon.com/sns/latest/dg/sns-sms-sandbox.html" rel="noopener ugc nofollow" target="_blank">已验证的电话号码</a></li></ul><h1 id="4105" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">后端实现</h1><p id="63cd" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">好了，让我们开始用Terraform来建造一些基础设施。本节假设您至少对Terraform以及文件的一般定义和组织方式有所了解。</p><p id="bc76" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在你的repo的根目录下创建<em class="nl">后端</em>文件夹，里面有一些空文件。</p><pre class="ld le lf lg gt nm nn no np aw nq bi"><span id="03ba" class="mw ll iq nn b gy nr ns l nt nu">mkdir backend<br/>cd backend<br/>touch variables.tf main.tf outputs.tf provider.tf</span></pre><p id="646a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，让我们在<code class="fe nv nw nx nn b">provider.tf</code>文件中设置提供者。如果您想从一个特定的概要文件中加载凭证，您可以在<code class="fe nv nw nx nn b">provider</code>块中提供<code class="fe nv nw nx nn b">profile = &lt;credentials_profile&gt;</code>。然而，为了更好的安全性，您可能想要查看类似于<a class="ae lb" href="https://github.com/99designs/aws-vault" rel="noopener ugc nofollow" target="_blank"> aws-vault </a>的东西，并承担角色以访问所需帐户中的资源。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="b053" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在在<code class="fe nv nw nx nn b">variables.tf</code>中定义一些变量。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="db7e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们定义一下我们在<code class="fe nv nw nx nn b">main.tf</code>的主要资源。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="952c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，在<code class="fe nv nw nx nn b">outputs.tf</code>中定义输出，这是配置前端所需要的。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="e28e" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">当地人</h2><p id="36ec" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">在<code class="fe nv nw nx nn b">main.tf</code>文件的<code class="fe nv nw nx nn b">locals</code>部分，我定义了一个<code class="fe nv nw nx nn b">id</code>,用于资源命名。通过调整<code class="fe nv nw nx nn b">project_name</code>和<code class="fe nv nw nx nn b">stage</code>变量，您可以随意命名您的资源。包含一个阶段变量是一个很好的做法，因为它清楚地显示了一个资源是dev还是prod。</p><h2 id="0297" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated"><strong class="ak">认知用户群</strong></h2><p id="b706" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">Cognito中的用户池代表主用户目录。这是创建和管理用户的地方。以下列表强调了配置的重要方面:</p><ul class=""><li id="8bbc" class="mh mi iq kh b ki kj kl km ko mj ks mk kw ml la mm mn mo mp bi translated"><code class="fe nv nw nx nn b">username_attributes</code>属性允许您指定注册时允许将哪些<a class="ae lb" href="https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-attributes.html" rel="noopener ugc nofollow" target="_blank">用户池属性</a>用作用户名。这可以是<code class="fe nv nw nx nn b">email</code>、<code class="fe nv nw nx nn b"> phone_number</code>、两者(意味着两者都可以使用，但是你的应用需要更复杂的验证逻辑)或空(意味着你的用户名由你的用户以字符串的形式明确提供)。在我们的例子中，我们希望用户使用他们的电话号码注册，所以我们将这个设置为<code class="fe nv nw nx nn b">phone_number</code>。</li><li id="9755" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">在用户可以自己注册的应用程序中，电子邮件地址和/或电话号码通常是必填字段，然后进行验证，以帮助减少假冒或虚假账户被激活。在Cognito中，有几种方法可以实现这一点。一种方法是实现一个<a class="ae lb" href="https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-pre-sign-up.html" rel="noopener ugc nofollow" target="_blank">预注册Lambda触发器</a>并编写自己的逻辑来发送和处理用户的验证。另一种方法是使用Cognito的<code class="fe nv nw nx nn b">auto_verified_attributes</code>属性，让Cognito根据是否指定了<code class="fe nv nw nx nn b">email</code>或<code class="fe nv nw nx nn b">phone_number</code>来发送必要的验证邮件或短信。在我们的例子中，我们希望将其设置为<code class="fe nv nw nx nn b">phone_number</code>，以便Cognito创建一个验证码，然后使用SNS向给定的电话号码发送SMS。</li><li id="868b" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">为了确保允许用户自己注册，而不仅仅是通过管理控制台或API，应该将<code class="fe nv nw nx nn b">allow_admin_create_user_only</code>属性设置为<code class="fe nv nw nx nn b">false</code>。</li><li id="9764" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">关于<code class="fe nv nw nx nn b">sms_configuration</code>配置块的解释，参见下面的SNS角色部分。</li><li id="284c" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated"><code class="fe nv nw nx nn b">password_policy</code>配置块定义了密码策略和任何临时密码或代码的生命周期。这是<a class="ae lb" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cognito-userpool-passwordpolicy.html" rel="noopener ugc nofollow" target="_blank">这里记录的</a>。</li><li id="0e47" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated"><code class="fe nv nw nx nn b">account_recovery_setting</code>配置块用于定义密码恢复机制。在我们的例子中,<code class="fe nv nw nx nn b">name</code>属性应该设置为<code class="fe nv nw nx nn b">verified_phone_number</code>,以确保用户可以使用他们验证过的电话号码恢复他们的密码。</li><li id="d443" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated"><code class="fe nv nw nx nn b">schema</code>配置块用于定义用户属性。这包括<a class="ae lb" href="https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-attributes.html" rel="noopener ugc nofollow" target="_blank">标准和定制属性</a>。请注意，在Terraform源代码中，无法区分哪些属性是标准属性，哪些是自定义属性。然而，一旦创建了用户池，定制属性将在Cognito中自动以<code class="fe nv nw nx nn b">custom:</code>为前缀，并且需要在我们的代码中引用。</li></ul><h2 id="9ca4" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated"><strong class="ak"> SNS IAM角色</strong></h2><p id="91d4" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">为了允许Cognito发送SMS消息，必须允许它承担一个角色，包括通过Amazon SNS发布的相关政策。角色的ARN在用户池的<code class="fe nv nw nx nn b">sms_configuration</code>配置块<code class="fe nv nw nx nn b">sns_caller_arn</code>中给出。</p><p id="e86d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了增加安全性，角色配置了一个<code class="fe nv nw nx nn b">sts:ExternalId</code>参数，该参数也通过<code class="fe nv nw nx nn b">external_id</code>参数提供给用户池<code class="fe nv nw nx nn b">sms_configuration</code>对象。这意味着当Cognito承担角色时，它将传递<code class="fe nv nw nx nn b">ExternalID</code>参数，然后根据角色的预期<code class="fe nv nw nx nn b">ExternalID</code>进行验证。在我们的例子中，外部ID是由Terraform使用<code class="fe nv nw nx nn b">random_string</code>资源随机生成的。</p><h2 id="ac0a" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">认知用户池客户端</h2><p id="dd0e" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">Cognito用户池支持各种各样的<a class="ae lb" href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/cognito-idp/index.html#cli-aws-cognito-idp" rel="noopener ugc nofollow" target="_blank"> API调用</a>。这些API调用中的一些可以通过应用程序在未经验证的用户状态下执行。注册、电子邮件/电话号码确认和密码重置就是这种操作的例子。这些调用必须在Cognito用户池客户机的上下文中完成，方法是在API调用中提供客户机ID作为参数。</p><p id="28c6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用户池客户端配置的目的是指定特定客户端允许使用哪些身份验证流、如何管理令牌过期、使用哪些回调URL以及其他与OAuth相关的设置。</p><p id="af41" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个用户池可以连接许多用户池客户端配置。这是因为尽管不同类型的应用程序可能会访问同一个用户池，但它们可能会有不同的身份验证要求，具体取决于应用程序的性质(例如前端或后端、第三方集成等)</p><p id="a9d9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">针对本指南中构建的解决方案，做出了以下选择:</p><ul class=""><li id="1e76" class="mh mi iq kh b ki kj kl km ko mj ks mk kw ml la mm mn mo mp bi translated"><a class="ae lb" href="https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_CreateUserPoolClient.html#CognitoUserPools-CreateUserPoolClient-request-ExplicitAuthFlows" rel="noopener ugc nofollow" target="_blank">显式授权流</a>被设置为<code class="fe nv nw nx nn b">ALLOW_USER_SRP_AUTH</code>和<code class="fe nv nw nx nn b">ALLOW_REFRESH_TOKEN_AUTH</code>。这允许安全的用户名和密码身份验证方法，以及在现有令牌过期时刷新令牌以获取新令牌。</li><li id="2376" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">将参数<code class="fe nv nw nx nn b">enable_token_revocation</code>设置为<code class="fe nv nw nx nn b">true</code>允许通过<a class="ae lb" href="https://docs.aws.amazon.com/cognito/latest/developerguide/token-revocation.html" rel="noopener ugc nofollow" target="_blank">中记载的</a>多种方法撤销令牌。</li><li id="6d3d" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">将参数<code class="fe nv nw nx nn b">prevent_user_existence_errors</code>设置为<code class="fe nv nw nx nn b">ENABLED</code>确保错误消息不会泄露用户不存在的事实。这将在中进一步记录<a class="ae lb" href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pool-managing-errors.html" rel="noopener ugc nofollow" target="_blank">。简单地说“用户名或密码不正确”比说“找不到用户”更安全，因为这样可以发现真实的电话号码。</a></li></ul><h2 id="e1cd" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">测试</h2><p id="a078" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">为了测试Cognito用户池，我们可以使用AWS CLI。我们可以做的第一件事是尝试注册一个新用户。</p><p id="bcbf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nl">注意，我使用aws-vault进行凭证管理。</em></p><pre class="ld le lf lg gt nm nn no np aw nq bi"><span id="4964" class="mw ll iq nn b gy nr ns l nt nu">aws-vault exec OliverSchenk-Admin-Dev -- aws cognito-idp sign-up --client-id 9ocqafeo835vplo3lns7pc7ub --username +61400000000 --password TestPassword1 --user-attributes Name="name",Value="Oliver Schenk" Name="custom:company",Value="ACME" Name="custom:role_name",Value="Inventor"</span></pre><ul class=""><li id="85fe" class="mh mi iq kh b ki kj kl km ko mj ks mk kw ml la mm mn mo mp bi translated">用您自己的客户端ID替换<code class="fe nv nw nx nn b">client-id</code>值</li><li id="9529" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">用您自己的测试电话号码替换<code class="fe nv nw nx nn b">username</code>值</li><li id="f4a9" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">用您想要的密码替换<code class="fe nv nw nx nn b">password</code>值</li><li id="4df2" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">将<code class="fe nv nw nx nn b">name</code>、<code class="fe nv nw nx nn b">custom:company</code>和<code class="fe nv nw nx nn b">custom:role_name</code>的其他值替换为您想要的任何值</li></ul><p id="44da" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这一点上，你应该得到一个短信，你的注册沙盒电话号码包含一个6位数的代码。如果没有，请检查您的电话号码是否包含国家代码，以及您的AWS帐户是否启用了SMS沙箱。</p><p id="699f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您可以通过使用另一个AWS CLI命令提供代码来验证电话号码。</p><pre class="ld le lf lg gt nm nn no np aw nq bi"><span id="4543" class="mw ll iq nn b gy nr ns l nt nu">aws-vault exec OliverSchenk-Admin-Dev -- aws cognito-idp confirm-sign-up --client-id 9ocqafeo835vplo3lns7pc7ub --username +61400000000 --confirmation-code 123456</span></pre><ul class=""><li id="1dc5" class="mh mi iq kh b ki kj kl km ko mj ks mk kw ml la mm mn mo mp bi translated">用您自己的客户端ID替换<code class="fe nv nw nx nn b">client-id</code>值</li><li id="64e0" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">用您自己的电话号码替换<code class="fe nv nw nx nn b">username</code>值</li><li id="fe25" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated">用您在短信中收到的代码替换<code class="fe nv nw nx nn b">confirmation code</code></li></ul><p id="5d62" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此时，用户已经过验证。</p><p id="403d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将无法使用AWS CLI轻松测试身份验证部分，因为配置的身份验证方法使用SRP，如果不使用代码和库，SRP不容易计算。在下一节中，我们将看到如何使用<a class="ae lb" href="https://www.npmjs.com/package/amazon-cognito-identity-js" rel="noopener ugc nofollow" target="_blank">Amazon-cognito-identity-js</a>库与cogn ITO用户池进行交互。</p><h1 id="3f20" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">前端实施</h1><p id="a6ed" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">现在让我们来关注一下前端。为了让事情更有趣一点，我使用了<a class="ae lb" href="https://ionicframework.com/" rel="noopener ugc nofollow" target="_blank"> Ionic </a>框架和<a class="ae lb" href="https://ngrx.io/" rel="noopener ugc nofollow" target="_blank"> NgRx </a>进行反应式应用状态管理。你会在<a class="ae lb" href="https://github.com/oliverschenk/aws-cognito-angular/tree/amazon-cognito-with-sms-user-verification" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中找到完整的源代码。</p><p id="bca1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我不打算将每个源代码文件都粘贴到文章正文中，但是我提供了一些与Cognito实现相关的重要部分，以及我遇到的必须解决的任何其他问题。</p><h2 id="b745" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">认知用户池和认知客户端ID</h2><p id="cd78" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">作为使用Terraform创建的Cognito用户池和用户池客户端资源的输出，您将获得一个Cognito用户池ID和一个Cognito用户池客户端ID。这些应在如下的<code class="fe nv nw nx nn b">environment.ts</code>文件中提供。你应该用你自己的细节来代替这些。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="3860" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你最有可能至少有一个<code class="fe nv nw nx nn b">dev</code>和<code class="fe nv nw nx nn b">prod</code>阶段，因此生产认知id将进入<code class="fe nv nw nx nn b">environment.prod.ts</code>。</p><h2 id="a761" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">运行示例应用程序</h2><p id="a189" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">您可以通过安装Ionic CLI并使用以下命令提供应用程序来运行示例应用程序。</p><pre class="ld le lf lg gt nm nn no np aw nq bi"><span id="6997" class="mw ll iq nn b gy nr ns l nt nu">npm install -g @ionic/cli</span><span id="4d99" class="mw ll iq nn b gy oa ns l nt nu">cd frontend/aws-cognito-angular<br/>ionic serve</span></pre><p id="81c1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最好使用浏览器的开发工具，并在移动应用程序视图大小中运行应用程序，或者调整浏览器窗口的大小。</p><h2 id="935e" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">授权模块</h2><p id="57d7" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">所有与身份验证相关的逻辑和UI都包含在存储在<code class="fe nv nw nx nn b">src\app\core\auth</code>文件夹中的身份验证模块中。这包括以下内容:</p><ul class=""><li id="97f4" class="mh mi iq kh b ki kj kl km ko mj ks mk kw ml la mm mn mo mp bi translated"><strong class="kh ir">组件</strong> —授权页面使用的角度可重用组件。</li><li id="c528" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated"><strong class="kh ir">页面</strong> —代表离子页面的角度组件。</li><li id="444a" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated"><strong class="kh ir">服务</strong> —主要的授权服务和守卫。</li><li id="fe01" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated"><strong class="kh ir">状态</strong> —用于认证动作和页面状态动作的NgRx动作、效果、模型、缩减器和选择器。</li><li id="381b" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated"><strong class="kh ir">验证模块</strong> —验证特征存储和效果的角度模块定义和NgRx导入的根。</li><li id="151c" class="mh mi iq kh b ki mq kl mr ko ms ks mt kw mu la mm mn mo mp bi translated"><strong class="kh ir">授权路由</strong> —页面路由定义。</li></ul><h2 id="1bc2" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">授权服务</h2><p id="b361" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">这个示例应用程序中与Cognito的交互是通过一个服务来处理的，该服务使用了<a class="ae lb" href="https://www.npmjs.com/package/@aws-amplify/auth" rel="noopener ugc nofollow" target="_blank"> @aws-amplify/auth </a>库和<a class="ae lb" href="https://docs.amplify.aws/lib/auth/getting-started/q/platform/js/#option-2-call-authentication-apis-manually" rel="noopener ugc nofollow" target="_blank"> Amplify网站</a>上的文档。</p><p id="c4ef" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该服务提供了统一的身份验证和用户管理API，隐藏了一些Cognito细节和通信。它提供了应用程序应有的所有标准功能，包括注册、登录、注销、密码管理和用户档案管理。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="6806" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">影响和降低因素</h2><p id="14b3" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">虽然auth服务负责提供一个简化的API来与Cognito通信，但是NgRx效果负责处理从UI和其他效果发出的任何动作。</p><p id="825f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，当单击登录按钮时，登录页面会调度一个<code class="fe nv nw nx nn b">signIn</code>动作。这是由<code class="fe nv nw nx nn b">signIn$</code>效应递过来的。这又调用了<code class="fe nv nw nx nn b">authService.signIn</code>方法，如果结果是成功的，则调度<code class="fe nv nw nx nn b">signInSuccessful</code>动作。这反过来由<code class="fe nv nw nx nn b">signInSuccessful$</code>效果处理，它导航到站点的根路径(例如个人资料页面)。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="1805" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当每个动作被分派时，reducers也设置相关的状态。比如<code class="fe nv nw nx nn b">loading</code>、<code class="fe nv nw nx nn b">showError</code>和<code class="fe nv nw nx nn b">isLoggedIn</code>。这些状态然后动态地反映在UI中，因为它们都是可观察的。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="4dfb" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">配置文件模块</h2><p id="2697" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">个人资料模块负责个人资料主页面和个人资料编辑页面。你可以看看源代码来了解这部分app。这个应用程序的安全部分相当简单，因为本文主要关注的是与认知相关的操作。</p><p id="5a36" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加配置文件页面是为了演示一个受保护的页面，使用一个<code class="fe nv nw nx nn b">AuthGuard</code>和当前已验证的用户进行Cognito API调用。概要文件数据本身是使用Cognito API通过概要文件和身份验证服务读取和更新的。</p><h1 id="1643" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">技巧</h1><p id="a7bb" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">以下是我在使用Angular解决方案时遇到的各种问题的提示。</p><h2 id="9110" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">提示1 —修复EsLint错误</h2><p id="b65c" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">为了防止eslint在每个Typescript源代码文件中显示错误，我不得不遵循<a class="ae lb" href="https://stackoverflow.com/questions/64933543/parsing-error-cannot-read-file-tsconfig-json-eslint" rel="noopener ugc nofollow" target="_blank">这个关于堆栈溢出的信息</a>来解决这个问题。我必须将<code class="fe nv nw nx nn b">.eslintrc.json</code>重命名为<code class="fe nv nw nx nn b">.eslintrc.js</code>，然后在该文件中将以下内容添加到<code class="fe nv nw nx nn b">parserOptions</code>配置中:</p><pre class="ld le lf lg gt nm nn no np aw nq bi"><span id="207c" class="mw ll iq nn b gy nr ns l nt nu">“tsconfigRootDir”: __dirname</span></pre><h2 id="ec63" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">提示2-修复“未定义全局”错误</h2><p id="11bf" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">提供ionic项目时，您很可能会在浏览器中看到如下错误:</p><pre class="ld le lf lg gt nm nn no np aw nq bi"><span id="1c02" class="mw ll iq nn b gy nr ns l nt nu">Uncaught ReferenceError: global is not defined</span></pre><p id="13f1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要解决这个问题，在<code class="fe nv nw nx nn b">polyfills.ts</code>文件的末尾添加以下内容:</p><pre class="ld le lf lg gt nm nn no np aw nq bi"><span id="80b0" class="mw ll iq nn b gy nr ns l nt nu">(window as any).global = window;</span></pre><h2 id="7fd8" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">提示3 — CommonJS和AMD构建警告</h2><p id="1c9d" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">在构建或提供Angular SPA时，由于使用了AWS Amplify Auth库，会出现许多警告。这些可以在<code class="fe nv nw nx nn b">angular.json</code>中通过添加以下构建选项来静音:</p><pre class="ld le lf lg gt nm nn no np aw nq bi"><span id="0f64" class="mw ll iq nn b gy nr ns l nt nu">"options": {<br/>  ...<br/>  "allowedCommonJsDependencies": [<br/>    "crypto-js",<br/>    "buffer",<br/>    "isomorphic-unfetch",<br/>    "url",<br/>    "@aws-crypto/sha256-js",<br/>    "@aws-crypto/sha256-browser",<br/>    "uuid"<br/>  ]<br/>}</span></pre><h2 id="c0f6" class="mw ll iq bd lm mx my dn lq mz na dp lu ko nb nc lw ks nd ne ly kw nf ng ma nh bi translated">技巧4— Redux开发工具</h2><p id="192a" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">确保使用Redux DevTools Chrome扩展来查看NgRx存储在执行各种操作时的状态。</p></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><h1 id="c411" class="lk ll iq bd lm ln oi lp lq lr oj lt lu jw ok jx lw jz ol ka ly kc om kd ma mb bi translated">分级编码</h1><p id="96e4" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">感谢您成为我们社区的一员！更多内容请参见<a class="ae lb" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>。<br/>跟随:<a class="ae lb" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank"> Twitter </a>，<a class="ae lb" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>，<a class="ae lb" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">迅</a> <br/> <strong class="kh ir">升一级正在改造理工大招聘➡️ </strong> <a class="ae lb" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir">加入我们的人才集体</strong> </a></p></div></div>    
</body>
</html>