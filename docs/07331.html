<html>
<head>
<title>Unity: How to implement raytracing in a grid</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Unity:如何在网格中实现光线追踪</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/unity-how-to-implement-raytracing-in-a-grid-12fa5896c22d?source=collection_archive---------13-----------------------#2021-02-09">https://levelup.gitconnected.com/unity-how-to-implement-raytracing-in-a-grid-12fa5896c22d?source=collection_archive---------13-----------------------#2021-02-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="29df" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">网格游戏开发日志第10天</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8ae3d0f409bc83b9b7293f4a5400e46a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lHxygdMHwnYZKp2WonKiww.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">描绘战争迷雾的游戏图像</figcaption></figure></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="10ba" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">目标</h1><p id="98d3" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">今天的目标是在我的游戏中制造战争迷雾。我希望角色能够从各个方向看到7个街区。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h2 id="2bfa" class="mt lg it bd lh mu mv dn ll mw mx dp lp mg my mz lr mk na nb lt mo nc nd lv ne bi translated">我该怎么做？</h2><p id="da8c" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">我要用一个叫做光线追踪的概念。</p><p id="8c7c" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">计算机还没有足够快或足够聪明来环顾四周，收集所有现实的数据，并在处理100%的可用数据时模拟像视线这样的东西。所以，几十年来大多数工程师模拟视线的方法是用一种叫做光线追踪的东西。</p><p id="f0ef" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">光线跟踪对于无数的应用程序非常有用，但这可能是主要的经典用例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/7cf7d355443e872b3b96e3ae830a4b08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N45JcsMY0nhKKz7dcQV-nA.jpeg"/></div></div></figure><p id="10ce" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">我们将在角色周围每隔一段时间画一些“光线”。这些光线会刺激视力。某些标记的游戏对象会阻止它们。我的笔记在上面，但我会分解它:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/422a74562f5b44213237145b9c059b25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*z-_1GxjlHRd0FC3XSDVskA.jpeg"/></div></figure><p id="4d7f" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">这是我游戏中视觉的影响范围。这个角色有40个端点。</p><p id="81e5" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">起初，我尝试使用直线算法，但我选择手动绘制直线，因为我只需要定义其中的5条。</p><p id="6f94" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">我只需要定义5的原因是，我可以用一小片圆创建的形状，应用一系列公式，使它围绕原点旋转。</p><p id="92bc" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">每行中每个单元格的象限旋转公式如下所示:</p><h2 id="98b1" class="mt lg it bd lh mu mv dn ll mw mx dp lp mg my mz lr mk na nb lt mo nc nd lv ne bi translated">90度</h2><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="e005" class="mt lg it nn b gy nr ns l nt nu">x = y<br/>y = -x</span></pre><h2 id="7922" class="mt lg it bd lh mu mv dn ll mw mx dp lp mg my mz lr mk na nb lt mo nc nd lv ne bi translated">180度</h2><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="b299" class="mt lg it nn b gy nr ns l nt nu">x = -x<br/>y = -y</span></pre><h2 id="b858" class="mt lg it bd lh mu mv dn ll mw mx dp lp mg my mz lr mk na nb lt mo nc nd lv ne bi translated">270度</h2><pre class="kj kk kl km gt nm nn no np aw nq bi"><span id="91ee" class="mt lg it nn b gy nr ns l nt nu">x = -y<br/>y = x</span></pre><p id="1fe9" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">我将制作5条线，并将每条线的形状绘制到屏幕上。每条线将以硬编码的方式遍历，并在遇到带有“墙”标签的对象时停止追踪。这将模拟视觉障碍。</p><p id="a6dc" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">然后，通过将上述公式应用到每个单元格，在围绕字符位置旋转所有线条后，我将重复这个跟踪过程3次以上。最后，这会在角色周围画一个对称的圆。</p><p id="8979" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">在我的网格生成中，我将为游戏中的每个瓷砖创建一个黑色方块。当角色四处移动时，射线会永久移除黑色方块。当角色离开一个区域时，它会留下显示的单元格。这将创造我的战争迷雾效果。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h2 id="23b9" class="mt lg it bd lh mu mv dn ll mw mx dp lp mg my mz lr mk na nb lt mo nc nd lv ne bi translated">首先，光线追踪的“你好世界”</h2><p id="bea1" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">如果你曾经像我一样感到力不从心或不知所措，最好从尽可能小的一步开始。</p><p id="3820" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">第一步是光线跟踪的概念验证。我在我的角色运动行为脚本中添加了一些方法。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/bf8b164e3984334babdf1fbff8294978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PeC3cKE8nbutgy3CrYFQxQ.jpeg"/></div></div></figure><p id="195f" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">这里没有什么太花哨的东西。我创建了一个匿名类型，用两个数组依次表示我的光线的所有相对x和y位置。</p><p id="be95" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">我还添加了另一个高排序层数的预置，所以它肯定会被涂在任何其他预置的上面。</p><p id="f9de" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">它从角色的位置开始绘制光线，直到遇到墙壁。光线填充的每个位置都被添加到顶级雾列表中，然后在每次新的光线跟踪检查之前清除雾列表。</p><p id="6490" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">结果如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="04de" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">你会注意到，当我在关卡中移动时，它从角色身上画了一条黑线。这条黑线代表投射出的一条光线，作为概念的证明。您还会注意到它被墙和其他带有墙标签的东西挡住了。</p><p id="5433" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">在未来，我将创建一个墙标签的层次结构，以便视觉只阻挡墙，水只阻挡运动而不阻挡视觉，但现在，这正如预期的那样工作。</p><p id="d205" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">下一步是添加其他4条线，并使用上述公式旋转它们。然而，在我围绕原点旋转它们之前，我将在第一象限的轴上翻转它们，以使“形状”占据网格的第一象限。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/861fe238fae42c940a55bcce849dff32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hkDsLdrMsk8Q-O2Lje6ohQ.jpeg"/></div></div></figure><p id="424d" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">在这个模块中，我正在做我上面描述的事情。我明确地定义了一些线，然后用公式将它们绕原点翻转/旋转。</p><p id="0f59" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">这是翻转第一象限对角线上的前5条线，然后将前10条线构成的整个形状旋转到右下象限后的结果。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="79a2" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">现在，我重复完全相同的旋转函数，用各自的公式计算网格的每一个象限，得到我的光线的完整圆，如下图所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="aa6d" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">出于性能原因，我在角色实例化期间调用准备光线跟踪方法。该方法的目的是在应用所有公式后用线条填充光线列表。</p><p id="2b70" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">这样，一旦游戏对用户开始，整个圈的线已经在内存中分配，在游戏过程中不需要重新分配。我不需要计算机一直准备新的数组和列表并进行操作(即使它肯定足够快来处理这些)，它将简单地遍历准备好的行列表并跟踪每个字符动作的行。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h2 id="fd36" class="mt lg it bd lh mu mv dn ll mw mx dp lp mg my mz lr mk na nb lt mo nc nd lv ne bi translated">让整个世界充满黑暗</h2><p id="b74f" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">由于这个功能是为了实现战争迷雾，我将在整个游戏中填充黑色方块，并让我的光线移除它们，而不是绘制它们。</p><p id="b943" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">我在我的网格生成器中用我添加的这个方法做这个，现在每个单元放置都调用这个方法。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/d085c60527884599bac09bb89b9dd92b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XBzpsz42J8835UZbD5iXlQ.jpeg"/></div></div></figure></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h2 id="ed32" class="mt lg it bd lh mu mv dn ll mw mx dp lp mg my mz lr mk na nb lt mo nc nd lv ne bi translated">让脚本在返回之前显示墙的第一层</h2><p id="fe51" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">在上面的视频中，你会注意到光线正好停在障碍物前，但是我想把第一层墙的雾去掉，让玩家看起来能看到他们所在房间的内部。</p><p id="a28c" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">这是一个简单的修复方法。当我找到一个有墙标签的单元格时，我不会返回，而是继续移除雾，然后在雾从第一层墙移除后从循环中返回，就像这样。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/c493def57e35c2cef95201dd09b43a19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B4QmZ979nYaMbAibicqCTA.jpeg"/></div></div></figure></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h2 id="b3b3" class="mt lg it bd lh mu mv dn ll mw mx dp lp mg my mz lr mk na nb lt mo nc nd lv ne bi translated">最后的结果</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="3a09" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">现在我的游戏有战争之雾了！我认为这真的增加了游戏的探索感。我很满意。</p><p id="31ad" class="pw-post-body-paragraph lx ly it lz b ma nf ju mc md ng jx mf mg nh mi mj mk ni mm mn mo nj mq mr ms im bi translated">下次见！</p></div></div>    
</body>
</html>