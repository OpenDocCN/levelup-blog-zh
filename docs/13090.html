<html>
<head>
<title>DataSource in TypeORM, a new way to connect to your database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TypeORM中的DataSource，一种连接数据库的新方法</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/datasource-in-typeorm-a-new-way-to-connect-to-your-database-cdc6622f9bbc?source=collection_archive---------1-----------------------#2022-08-06">https://levelup.gitconnected.com/datasource-in-typeorm-a-new-way-to-connect-to-your-database-cdc6622f9bbc?source=collection_archive---------1-----------------------#2022-08-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/ad0860b5dee8127cf918784067790dc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xQfGySum6kvPzKYq2NsFBg.jpeg"/></div></figure><blockquote class="ju jv jw"><p id="cda0" class="jx jy jz ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">在我们开始之前:</strong>本文将介绍最近对TypeORM进行的一些更改，以建立与数据库的连接。这篇文章是我之前文章的延续。我已经根据需要在本文的必要之处提供了相同内容的链接。</p></blockquote><p id="d9a9" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="jz">第一步</em> : </strong>在开始之前，设置我们的项目环境是很重要的。同样可以参考我的文章<a class="ae kz" href="https://medium.com/geekculture/setting-up-a-node-js-project-environment-with-express-js-and-typescript-best-practices-284cc37c5aa1" rel="noopener"> <strong class="ka ir">在typescript </strong> </a> <strong class="ka ir"> </strong>中设置node.js项目环境。完成设置后，我们将创建一个<strong class="ka ir"> src </strong>文件夹，我们将在其中转移index.ts文件。因为我们现在将index.ts文件放在不同的位置，所以我们将更新package.json。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="4b91" class="lj lk iq lf b gy ll lm l ln lo">"scripts": {<br/>    "start": "nodemon --exec ts-node src/index.ts",<br/>    "build": "tsc"<br/> }</span></pre><p id="4409" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">在本文的后面部分，我们将更深入地研究“src”文件夹，以及我们将index.ts文件转移到其中的原因(参见步骤4)。</p><p id="60ed" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="jz">步骤2: </em> </strong>完成项目设置后，我们将添加我们需要的依赖项，以便用TypeORM初始化我们的项目，type ORM最终将连接到我们的PostgreSQL数据库，从而帮助我们根据需求创建API。我们将在项目中添加typeorm、postgreSQL和dotenv。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="0e59" class="lj lk iq lf b gy ll lm l ln lo">yarn add typeorm<br/>yarn add pg<br/>yarn add dotenv</span></pre><p id="dddd" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">既然我们已经安装了基本的依赖集，我们将返回到<strong class="ka ir"> src </strong>文件夹。在其中，我们将创建另外两个名为<strong class="ka ir">实体</strong>和<strong class="ka ir">路线</strong>的文件夹。现在在根级别，我们将创建一个<strong class="ka ir">。env </strong>文件和一个名为<strong class="ka ir"> config </strong>的文件夹。</p><figure class="la lb lc ld gt jr gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/e39025815c6772f9dc8658315712b141.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*oP9ZUhsRJIUfWd15k9JWBQ.png"/></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">项目结构</figcaption></figure><p id="c35c" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="jz">第三步:设置数据库配置</em> </strong>。在config文件夹中创建一个名为ormconfig.ts的文件。这是我们初始化数据源的地方。你可以参考下面的代码要点来初始化你的数据源。</p><figure class="la lb lc ld gt jr"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="fad6" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">在env文件中添加您的数据库凭证，然后从那里获取它。出于安全原因，我们将数据库凭证隐藏在env文件中。要将您的凭证添加到env文件中，只需在其中添加以下行:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="3b75" class="lj lk iq lf b gy ll lm l ln lo">DATABASE_URI=YOUR_DATABASE_URI</span></pre><p id="dad9" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">现在，您可以根据需要调用connectDB来访问项目结构中的各种文件。比方说，我想对我的index.ts文件调用connectDB，这就是它的实现方式。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="0c5a" class="lj lk iq lf b gy ll lm l ln lo">// Import DB config<br/>import connectDB from "../config/ormconfig";</span><span id="a21d" class="lj lk iq lf b gy lw lm l ln lo">// Create connection with DB<br/>connectDB</span></pre><p id="5262" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">现在，让我们比较一下与我们的数据库初始化连接的旧方法的变化，即<strong class="ka ir"> createConnection </strong>方法。你可以参考下面的代码要点来理解createConnection是如何使用的。</p><figure class="la lb lc ld gt jr"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="c40a" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">比较两者，您会注意到以前createConnection方法使用的键-值对的数量与DataSource使用的键-值对的数量相同。不同之处在于，对于DataSource，我们使用<strong class="ka ir"> connectDB </strong>上的<strong class="ka ir">初始化</strong>函数，然后通过<strong class="ka ir">然后</strong>函数<strong class="ka ir"> </strong>将其推进<strong class="ka ir">，当连接成功建立<strong class="ka ir">时，它基本上在控制台/终端上更新我们。</strong>在出现错误的情况下，例如，如果您提供了不正确的数据库凭证或一些其他不正确的数据，它将在建立连接时抛出一个错误，从而暂停该过程。</strong></p><p id="2470" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated"><strong class="ka ir">注1:</strong>data source方法被引入来代替createConnection，后者已被弃用。本文讨论如何连接到PostgreSQL数据库，但是，您也可以使用相同的DataSource方法连接到其他数据库。</p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><p id="1e10" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="jz">步骤4: </em> </strong>回到步骤2，我们已经在src文件夹中创建了两个文件夹，即实体和路线。我们将创建一个基本的API来理解所有这些东西是如何连接在一起的。</p><p id="0392" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated"><strong class="ka ir">注2: </strong>我之前写过一篇关于<a class="ae kz" href="https://medium.com/geekculture/routing-our-typescript-api-in-express-js-and-using-typeorm-for-connecting-to-our-postgresql-db-bde5132b5102" rel="noopener"> <strong class="ka ir">路由我们node.js项目</strong> </a>的文章，你可以在自己创建API的时候参考一下。首先，我在Entities文件夹中创建了一个名为Footballers.ts的实体。</p><figure class="la lb lc ld gt jr"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="dcdc" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">实体是一个基于类的对象或模型，它将为我们完成所有的SQL操作，如创建表、从表中获取数据、添加数据、更新数据等。通过在后台执行SQL查询(如果您想查看将要运行的SQL查询，可以在ormconfig.ts文件中将<strong class="ka ir">日志设置为true </strong>)。</p><p id="6fdb" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated"><strong class="ka ir">重要提示:</strong>保存实体后，您会在文本编辑器中发现一条警告，内容如下:</p><figure class="la lb lc ld gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi me"><img src="../Images/58c82e0f75553d6d7b361c4f0adfb387.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LL5InCxmmIOC1gceO_LFxA.png"/></div></div></figure><p id="17d0" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">装饰符是一种特殊类型的声明。要解决这个问题，只需删除tsconfig.json文件中以下代码行的注释。</p><figure class="la lb lc ld gt jr gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/30c1f3ae2da369b1e8f8ea3fd2b0ef98.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/1*lWHnQPDMvkBUaieHkyuKlg.png"/></div></figure><p id="5d17" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">现在我们的实体已经准备好了，我们准备为我们的API创建几个路由。为此，我们需要在Routes文件夹中创建一个名为<strong class="ka ir"> footballerRoutes.ts </strong>的文件。我在以前的文章中已经详细介绍了<a class="ae kz" href="https://medium.com/geekculture/routing-our-typescript-api-in-express-js-and-using-typeorm-for-connecting-to-our-postgresql-db-bde5132b5102" rel="noopener">路由，你可以从那里实现它。我还在最后提供了到我的GitHub库的链接，所以您也可以从那里检查和实现它。</a></p><p id="faa9" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">在我们的路由建立之后，我们只需要将它们调入我们的index.ts文件。您可以通过以下方式实现:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="f8a0" class="lj lk iq lf b gy ll lm l ln lo">const app = express();</span><span id="8c51" class="lj lk iq lf b gy lw lm l ln lo">// Import API routes<br/>import footballerRoutes from "./routes/footballerRoutes";</span></pre><p id="d042" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">为了使用这些路由，我们只需要使用express.js提供的<strong class="ka ir"> use </strong>函数，use函数有两个参数，第一个是我们要调用API的API端点，第二个是我们在顶部导入的足球路由。它可以按如下方式实现:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="c508" class="lj lk iq lf b gy ll lm l ln lo">const app = express();</span><span id="5a9b" class="lj lk iq lf b gy lw lm l ln lo">// Fetching APIs from the routes<br/>app.use("/api/footballers", footballerRoutes);</span></pre><p id="0609" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">现在剩下的就是让我们监听我们对某个端口的应用。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="4a7a" class="lj lk iq lf b gy ll lm l ln lo">// Import DB config<br/>import connectDB from "../config/ormconfig";</span><span id="6c24" class="lj lk iq lf b gy lw lm l ln lo">// Use environment variables<br/>import dotenv from "dotenv";<br/>dotenv.config();</span><span id="d3fd" class="lj lk iq lf b gy lw lm l ln lo">const port = process.env.port || process.env.SERVER_PORT;</span><span id="f971" class="lj lk iq lf b gy lw lm l ln lo">app.listen(port, () =&gt; {<br/>    console.log(`Server is running on port ${port}`);<br/>})</span></pre><p id="bd13" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">在你的。env文件您可以为SERVER_PORT设置一个环境变量:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="4b59" class="lj lk iq lf b gy ll lm l ln lo">SERVER_PORT=YOUR_SERVER_PORT_NUMBER</span></pre><p id="4c70" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated"><strong class="ka ir">注3: </strong>我们之所以将index.ts文件和Entities文件夹以及routes文件夹放在src文件夹中，很大程度上是因为更好的项目结构和可访问性。将我们所有的工作文件放在一个地方是一个很好的习惯。比方说，如果我想访问索引文件中的任何路径，我知道它在相同的位置。这有助于保持开发周期的可持续性。</p><p id="2d92" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">现在我们已经设置好了一切，让我们试着运行我们的应用程序并发出一些请求。在终端中运行yarn start，在您的项目目录中，您将看到以下响应:</p><figure class="la lb lc ld gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mk"><img src="../Images/925fd12ebf7838d8da2268deca52feec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ExiioRvrI0WOud_Z4-4BEQ.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">启动服务时的应用程序响应。</figcaption></figure></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><figure class="la lb lc ld gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi ml"><img src="../Images/5d1849367160a70d01725b0811ce2b10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B0yFd-LN_GNjNf2dYBpn3A.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">发布插入足球运动员数据的请求。</figcaption></figure><figure class="la lb lc ld gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi ml"><img src="../Images/e4b599fbe4cf5e4752cceb04eacbd7cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Lr2mOmBofaerWyaYMT4bA.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">获取获取所有玩家数据的请求。</figcaption></figure><p id="41c4" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">到此，我想结束这篇文章，谢谢！</p><p id="092c" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated"><a class="ae kz" href="https://github.com/chinmaykarmokar/node-express-ts-orm" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="jz">链接到资源库</em> </strong> </a></p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><p id="3c06" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated"><strong class="ka ir">更新:</strong>在我的文章<a class="ae kz" href="https://medium.com/@chinmaykarmokar/integrate-apis-in-next-js-with-redux-and-axios-10-step-guide-3d20a2bc9365" rel="noopener">关于在Next.js中使用redux和Axios进行API调用</a>中，我已经通过安装和实现在我的Next.js应用程序中使用的CORS更新了这个应用程序的存储库。要加CORS做什么:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="46a4" class="lj lk iq lf b gy ll lm l ln lo">yarn add cors</span></pre></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="88e1" class="mm lk iq bd mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni bi translated">分级编码</h1><p id="8d59" class="pw-post-body-paragraph jx jy iq ka b kb nj kd ke kf nk kh ki kw nl kl km kx nm kp kq ky nn kt ku kv ij bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="bb3d" class="no np iq ka b kb kc kf kg kw nq kx nr ky ns kv nt nu nv nw bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="3664" class="no np iq ka b kb nx kf ny kw nz kx oa ky ob kv nt nu nv nw bi translated">📰查看<a class="ae kz" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="f695" class="no np iq ka b kb nx kf ny kw nz kx oa ky ob kv nt nu nv nw bi translated">🔔关注我们:<a class="ae kz" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae kz" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae kz" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="79c9" class="pw-post-body-paragraph jx jy iq ka b kb kc kd ke kf kg kh ki kw kk kl km kx ko kp kq ky ks kt ku kv ij bi translated">🚀👉<a class="ae kz" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">加入升级达人集体，找到一份惊艳的工作</strong> </a></p></div></div>    
</body>
</html>