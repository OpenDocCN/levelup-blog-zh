<html>
<head>
<title>How to Decode Ethereum Transactions in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何解码Golang中的以太坊交易</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-decode-ethereum-transactions-in-golang-659de0249a7d?source=collection_archive---------1-----------------------#2022-11-21">https://levelup.gitconnected.com/how-to-decode-ethereum-transactions-in-golang-659de0249a7d?source=collection_archive---------1-----------------------#2022-11-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="1429" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个帖子是关于解码以太坊交易，输入数据，交易收据日志。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/f08f173b5e277872bbe5e4146d2b81d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RwLpp4q845GzmmJu"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">无聊猿游艇俱乐部</figcaption></figure><p id="c398" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">代码是用Golang编写的，可以在<a class="ae le" href="https://gist.github.com/jerryan999/fb784e668e3f140619d22eaa391c3dd5" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="cc93" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">交易</h1><p id="2234" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">交易是从以太坊帐户发送的签名消息。它们用于触发区块链上的状态变化。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mp"><img src="../Images/0bf78584f6fedb615950dd39a7252b89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RNTcbAVlXjb0a4etfTarKA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">交易示例</figcaption></figure><p id="719b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们来看看一个事务的基本结构。</p><h2 id="b39d" class="mq ln it bd lo mr ms dn ls mt mu dp lw kb mv mw ma kf mx my me kj mz na mi nb bi translated"><em class="nc">来自</em></h2><p id="e758" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">发起者的以太坊地址</p><h2 id="f34c" class="mq ln it bd lo mr ms dn ls mt mu dp lw kb mv mw ma kf mx my me kj mz na mi nb bi translated"><em class="nc">收件人</em></h2><p id="dd27" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">目的地以太坊地址</p><h2 id="cc5e" class="mq ln it bd lo mr ms dn ls mt mu dp lw kb mv mw ma kf mx my me kj mz na mi nb bi translated"><em class="nc">值</em></h2><p id="1d62" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">发送到目的地的乙醚量</p><h2 id="cac3" class="mq ln it bd lo mr ms dn ls mt mu dp lw kb mv mw ma kf mx my me kj mz na mi nb bi translated"><em class="nc">数据</em></h2><p id="5c7e" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">可变长度二进制数据有效负载</p><h2 id="0e0d" class="mq ln it bd lo mr ms dn ls mt mu dp lw kb mv mw ma kf mx my me kj mz na mi nb bi translated"><em class="nc">气价</em></h2><p id="ccf6" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">气的价格(以魏为单位)发起人愿意支付。</p><h2 id="1f1c" class="mq ln it bd lo mr ms dn ls mt mu dp lw kb mv mw ma kf mx my me kj mz na mi nb bi translated"><em class="nc">气体极限</em></h2><p id="bb2c" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">发起者愿意为此交易购买的最大天然气量</p><h2 id="2e35" class="mq ln it bd lo mr ms dn ls mt mu dp lw kb mv mw ma kf mx my me kj mz na mi nb bi translated"><em class="nc">随机数</em></h2><p id="6eee" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">由起始地址发布的序列号用于防止消息重放。</p><h1 id="36c6" class="lm ln it bd lo lp nd lr ls lt ne lv lw lx nf lz ma mb ng md me mf nh mh mi mj bi translated">解码交易基础信息</h1><p id="b8d4" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">步骤1:连接以太坊节点</p><pre class="kp kq kr ks gt ni nj nk bn nl nm bi"><span id="3301" class="nn ln it nj b be no np l nq nr">import  (<br/>    ...<br/>    "github.com/ethereum/go-ethereum/ethclient"<br/>)<br/>    <br/>const PROVIDER_URL = "https://ethereum.publicnode.com"<br/><br/><br/>func main() {<br/>    client, err := ethclient.Dial(PROVIDER_URL)<br/>    if err != nil {<br/>        log.Fatal(err)<br/>    }<br/>    //...<br/>}</span></pre><p id="317b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">步骤2:通过散列获取事务</p><pre class="kp kq kr ks gt ni nj nk bn nl nm bi"><span id="7c0e" class="nn ln it nj b be no np l nq nr">import (<br/>   ...<br/>   "github.com/ethereum/go-ethereum/common"<br/>)<br/><br/>func main() {<br/>    // ...<br/>    txHashStr := "0x3e4acda755e036f62c8893ea15d7c587a272252944b0433db4ea5464f235f379"<br/>    txHash := common.HexToHash(txHashStr)<br/>    <br/>    var tx *types.Transaction<br/>    tx, _, err := client.TransactionByHash(context.Background(), txHash)<br/>    if err != nil {<br/>        log.Fatal(err)<br/>    }<br/>    // ...<br/>}</span></pre><p id="59c3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">步骤3:解析交易基础信息</p><pre class="kp kq kr ks gt ni nj nk bn nl nm bi"><span id="1079" class="nn ln it nj b be no np l nq nr">import (<br/>  ...<br/>  "encoding/hex"<br/><br/>   "github.com/ethereum/go-ethereum/core/types"<br/><br/>)<br/><br/>func ParseTransactionBaseInfo(tx *types.Transaction) {<br/>    fmt.Printf("Hash: %s\n", tx.Hash().Hex())<br/>    fmt.Printf("ChainId: %d\n", tx.ChainId())<br/>    fmt.Printf("Value: %s\n", tx.Value().String())<br/>    fmt.Printf("From: %s\n", GetTransactionMessage(tx).From().Hex()) // from field is not inside of transation<br/>    fmt.Printf("To: %s\n", tx.To().Hex())<br/>    fmt.Printf("Gas: %d\n", tx.Gas())<br/>    fmt.Printf("Gas Price: %d\n", tx.GasPrice().Uint64())<br/>    fmt.Printf("Nonce: %d\n", tx.Nonce())<br/>    fmt.Printf("Transaction Data in hex: %s\n", hex.EncodeToString(tx.Data()))<br/>    fmt.Print("\n")<br/>}<br/><br/><br/>func GetTransactionMessage(tx *types.Transaction) types.Message {<br/>   msg, err := tx.AsMessage(types.LatestSignerForChainID(tx.ChainId()), nil)<br/>   if err != nil {<br/>    log.Fatal(err)<br/>   }<br/>   return msg<br/>}<br/><br/>func main() {<br/>    // ...<br/>    <br/>    ParseTransactionBaseInfo(tx)<br/>    // ...<br/>}</span></pre><h1 id="2893" class="lm ln it bd lo lp nd lr ls lt ne lv lw lx nf lz ma mb ng md me mf nh mh mi mj bi translated">解码交易输入数据</h1><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ns"><img src="../Images/7eb6a40a27acf37df0117d722adebd22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jDSdFYPdDVcY3ArkBTVIrQ.png"/></div></div></figure><p id="cda2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">输入数据是事务对象中的数据字段，它是方法名和参数的编码数据。它是交易中最重要的部分，尤其是对于合同交易。</p><p id="075a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一步:构造契约<strong class="js iu"> abi </strong>(契约的接口)</p><pre class="kp kq kr ks gt ni nj nk bn nl nm bi"><span id="d214" class="nn ln it nj b be no np l nq nr">import (<br/>    ...<br/>    "github.com/ethereum/go-ethereum/accounts/abi"<br/>)<br/><br/>func GetLocalABI(path string) string {<br/>   abiFile, err := os.Open(path)<br/>   if err != nil {<br/>      log.Fatal(err)<br/>   }<br/>   defer abiFile.Close()<br/>  <br/>   result, err := io.ReadAll(abiFile)<br/>   if err != nil {<br/>      log.Fatal(err)<br/>   }<br/>   return string(result)<br/>}<br/><br/>func main() {<br/>    // ...<br/>    contractABI, err := abi.JSON(<br/>                          strings.NewReader(GetLocalABI("abis/boredape.json"))<br/>                        )<br/>    if err != nil {<br/>        log.Fatal(err)<br/>    }<br/><br/>}</span></pre><p id="ecf9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">步骤2:解码交易输入数据</p><pre class="kp kq kr ks gt ni nj nk bn nl nm bi"><span id="2ffc" class="nn ln it nj b be no np l nq nr">func DecodeTransactionInputData(contractABI *abi.ABI, data []byte) {<br/>   // The first 4 bytes of the t represent the ID of the method in the ABI<br/>   // https://docs.soliditylang.org/en/v0.5.3/abi-spec.html#function-selector<br/>   methodSigData := data[:4]<br/>   method, err := contractABI.MethodById(methodSigData)<br/>   if err != nil {<br/>      log.Fatal(err)<br/>   }<br/><br/>   inputsSigData := data[4:]<br/>   inputsMap := make(map[string]interface{})<br/>   if err := method.Inputs.UnpackIntoMap(inputsMap, inputsSigData); err != nil {<br/>       log.Fatal(err)<br/>   }<br/> <br/>   fmt.Printf("Method Name: %s\n", method.Name)<br/>   fmt.Printf("Method inputs: %v\n", MapToJson(inputsMap))<br/>}<br/><br/><br/>func main() {<br/>    //...<br/>    DecodeTransactionInputData(&amp;contractABI, tx.Data())<br/>    //...<br/>}</span></pre><h1 id="36a8" class="lm ln it bd lo lp nd lr ls lt ne lv lw lx nf lz ma mb ng md me mf nh mh mi mj bi translated">解码交易收据</h1><p id="484c" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">交易回单是交易执行的结果，包含了合同执行的日志。</p><p id="0da7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一步:获取交易收据</p><pre class="kp kq kr ks gt ni nj nk bn nl nm bi"><span id="984b" class="nn ln it nj b be no np l nq nr"><br/>func GetTransactionReceipt(client *ethclient.Client, txHash common.Hash) *types.Receipt {<br/>   receipt, err := client.TransactionReceipt(context.Background(), txHash)<br/>   if err != nil {<br/>      log.Fatal(err)<br/>   }<br/> <br/>   return receipt<br/>}</span></pre><p id="e4b7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第二步:解码收据</p><pre class="kp kq kr ks gt ni nj nk bn nl nm bi"><span id="b7da" class="nn ln it nj b be no np l nq nr"><br/>func DecodeTransactionLogs(receipt *types.Receipt, contractABI *abi.ABI) {<br/> for _, vLog := range receipt.Logs {<br/>    // topic[0] is the event name<br/>    event, err := contractABI.EventByID(vLog.Topics[0])<br/>    if err != nil {<br/>       log.Fatal(err)<br/>    }<br/>    <br/>    fmt.Printf("Event Name: %s\n", event.Name)<br/>    // topic[1:] is other indexed params in event<br/>    if len(vLog.Topics) &gt; 1 {<br/>       for i, param := range vLog.Topics[1:] {<br/>          fmt.Printf("Indexed params %d in hex: %s\n", i, param)<br/>          fmt.Printf("Indexed params %d decoded %s\n", i, common.HexToAddress(param.Hex()))<br/>     }<br/>    }<br/><br/>    if len(vLog.Data) &gt; 0 {<br/>       fmt.Printf("Log Data in Hex: %s\n", hex.EncodeToString(vLog.Data))<br/>       outputDataMap := make(map[string]interface{})<br/>       err = contractABI.UnpackIntoMap(outputDataMap, event.Name, vLog.Data)<br/>       if err != nil {<br/>          log.Fatal(err)<br/>       }<br/>      fmt.Printf("Event outputs: %v\n", outputDataMap)<br/>    }<br/><br/>   }<br/>}<br/><br/><br/>func main() {<br/>  //...<br/>  DecodeTransactionLogs(receipt, &amp;contractABI)<br/>  //...<br/>}</span></pre></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="8b4c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你喜欢这篇文章，<strong class="js iu">请鼓掌</strong>让其他人也能看到。💚</p></div></div>    
</body>
</html>