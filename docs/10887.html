<html>
<head>
<title>Handling Requests from Google Pub/Sub Push Subscriptions in Spring Boot Cloud Run Applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Spring Boot云运行应用中处理来自Google发布/订阅推送订阅的请求</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/handling-requests-from-google-pub-sub-push-subscriptions-in-spring-boot-cloud-run-applications-d686c36811a1?source=collection_archive---------7-----------------------#2022-01-20">https://levelup.gitconnected.com/handling-requests-from-google-pub-sub-push-subscriptions-in-spring-boot-cloud-run-applications-d686c36811a1?source=collection_archive---------7-----------------------#2022-01-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/0300fa2e63e5d76c49fd82d1c4373047.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*UAC_veT-PYRHQfBI"/></div></figure><p id="493c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="https://cloud.google.com/run/docs" rel="noopener ugc nofollow" target="_blank"> Cloud Run </a>是一个无服务器应用平台，这意味着部署在那里的应用不能一直运行，因此不能使用默认的“拉”订阅类型。</p><p id="015a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">推送订阅调用HTTP端点，这就是云运行服务被触发的方式。在<a class="ae ks" href="https://cloud.google.com/run/docs/triggering/pubsub-push#run_pubsub_handler-java" rel="noopener ugc nofollow" target="_blank">文档</a>中有为此目的构建的端点的例子，但是Java例子是非常基础的。这里有一种体面的方式来编写一个请求处理程序，它将与Spring框架一起工作。</p><p id="00d8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">假设你(在Terraform中)有一个关于广受好评的Showtime show、<a class="ae ks" href="https://www.sho.com/yellowjackets" rel="noopener ugc nofollow" target="_blank"> Yellowjackets </a>中角色生活中的事件的主题，以及一个过滤洛蒂所采取行动的订阅:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="e0a5" class="lc ld iq ky b gy le lf l lg lh">resource "google_pubsub_subscription" "example" {<br/>  name   = "yellowjackets-events---lottie"<br/>  topic  = data.google_pubsub_topic.yellowjackets_events.name<br/>  filter = "attributes.character = \"Lottie\""<br/>  push_config {<br/>    push_endpoint = "${google_cloud_run_service.app.status[0].url}/lottie-events"<br/>    oidc_token {<br/>      service_account_email = data.google_service_account.pubsub_invoker.email<br/>    }<br/>  }<br/>}</span></pre><p id="0f8e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">邮件正文可能如下所示:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="161c" class="lc ld iq ky b gy le lf l lg lh">{<br/>  "date": "1996-10-01",<br/>  "creepyStatement": "We won't be hungry much longer",<br/>  "visionType": "AERIAL_INFERNO"<br/>}</span></pre><p id="1f08" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Spring Boot请求处理程序可以这样写:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="ef97" class="lc ld iq ky b gy le lf l lg lh">@RestController<br/>@Slf4j<br/>public class PubSubPushController {</span><span id="8290" class="lc ld iq ky b gy li lf l lg lh">    @RequestMapping(value = "/lottie-events",<br/>                    method = RequestMethod.<em class="lj">POST</em>,<br/>                    produces = MediaType.<em class="lj">APPLICATION_JSON_VALUE</em>,<br/>                    consumes = MediaType.<em class="lj">APPLICATION_JSON_VALUE</em>)<br/>    public ResponseEntity&lt;?&gt; receiveLottieEvent(<br/>            HttpServletRequest req<br/>    ) throws Exception {<br/>        // (using Jackson)<br/>        JsonNode bodyNode = objectMapper.readTree(req.getReader());<br/>        String base64Data = bodyNode.get("message")<br/>                .get("data").asText();<br/>        byte[] data = Base64.<em class="lj">getDecoder</em>().decode(base64Data);<br/>        LottieEvent event = objectMapper.readValue(<br/>                data, LottieEvent.class);<br/>        log.info(event.getCreepyStatement());</span><span id="d1c6" class="lc ld iq ky b gy li lf l lg lh">        return new ResponseEntity&lt;&gt;(HttpStatus.<em class="lj">OK</em>);<br/>    }<br/>}</span></pre><p id="065e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是我发现对于控制器方法来说有点吵。它必须读取原始的pub/sub消息，获取文本形式的<code class="fe lk ll lm ky b">message.data</code>属性——这是一个Base64编码的字符串，因此您必须对其进行解码，等等。我们可以把它抽象出来，这样我们就可以立即从控制器方法参数中得到我们需要的东西。</p><p id="8bd3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们为方法参数制作一个容器，其中<code class="fe lk ll lm ky b">T</code>可以是一个<code class="fe lk ll lm ky b">LottieEvent</code>:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="e38e" class="lc ld iq ky b gy le lf l lg lh">@Data  // (Lombok)<br/>public class PubSubPushRequest&lt;T&gt; {</span><span id="ac0e" class="lc ld iq ky b gy li lf l lg lh">    private final T body;<br/>    private final Map&lt;String, Object&gt; attributes;<br/>    // you might want headers here too<br/>}</span></pre><p id="3127" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，执行一个<code class="fe lk ll lm ky b"><a class="ae ks" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/method/support/HandlerMethodArgumentResolver.html" rel="noopener ugc nofollow" target="_blank">HandlerMethodArgumentResolver</a></code>:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="870a" class="lc ld iq ky b gy le lf l lg lh">@Component<br/>public class PubSubArgumentResolver<br/>        implements HandlerMethodArgumentResolver {</span><span id="6f1f" class="lc ld iq ky b gy li lf l lg lh">    private final ObjectMapper objectMapper;</span><span id="e38a" class="lc ld iq ky b gy li lf l lg lh">    public PubSubArgumentResolver(ObjectMapper objectMapper) {<br/>        this.objectMapper = objectMapper;<br/>    }</span><span id="2750" class="lc ld iq ky b gy li lf l lg lh">    @Override<br/>    public boolean supportsParameter(MethodParameter parameter) {<br/>        return PubSubPushRequest.class<br/>                .isAssignableFrom(parameter.getParameterType());<br/>    }</span><span id="6ed2" class="lc ld iq ky b gy li lf l lg lh">    @Override<br/>    public Object resolveArgument(<br/>            MethodParameter parameter,<br/>            ModelAndViewContainer mavContainer,<br/>            NativeWebRequest webRequest,<br/>            WebDataBinderFactory binderFactory<br/>    ) throws Exception {<br/>        HttpServletRequest req = webRequest<br/>                .getNativeRequest(HttpServletRequest.class);<br/>        ParameterizedType dataType = (ParameterizedType)<br/>                parameter.getGenericParameterType();<br/>        Class&lt;?&gt; dataClass = (Class&lt;?&gt;)<br/>                dataType.getActualTypeArguments()[0];<br/>        JsonNode bodyNode = objectMapper.readTree(req.getReader());<br/>        String base64Data = bodyNode.get("message").get("data")<br/>                .asText();<br/>        byte[] data = Base64.<em class="lj">getDecoder</em>().decode(base64Data);<br/>        Object dataObj = objectMapper.readValue(data, dataClass);</span><span id="a941" class="lc ld iq ky b gy li lf l lg lh">        Map&lt;String, Object&gt; attributes = objectMapper.convertValue(<br/>                bodyNode.get("message").get("attributes"),<br/>                new TypeReference&lt;Map&lt;String, Object&gt;&gt;() {});</span><span id="21a9" class="lc ld iq ky b gy li lf l lg lh">        return new PubSubPushRequest&lt;&gt;(dataObj, attributes);<br/>    }<br/>}</span></pre><p id="41ce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">…并注册它:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="b3e8" class="lc ld iq ky b gy le lf l lg lh">@Configuration<br/>public class WebMvcConfiguration implements WebMvcConfigurer {</span><span id="3c46" class="lc ld iq ky b gy li lf l lg lh">    private final PubSubArgumentResolver pubSubArgumentResolver;</span><span id="1a27" class="lc ld iq ky b gy li lf l lg lh">    public WebMvcConfiguration(<br/>            PubSubArgumentResolver pubSubArgumentResolver<br/>    ) {<br/>        this.pubSubArgumentResolver = pubSubArgumentResolver;<br/>    }</span><span id="6695" class="lc ld iq ky b gy li lf l lg lh">    @Override<br/>    public void addArgumentResolvers(<br/>            List&lt;HandlerMethodArgumentResolver&gt; resolvers<br/>    ) {<br/>        resolvers.add(pubSubArgumentResolver);<br/>    }<br/>}</span></pre><p id="5c1e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后，我们可以更新控制器方法:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="fe0e" class="lc ld iq ky b gy le lf l lg lh">// ...<br/>public ResponseEntity&lt;?&gt; receiveLottieEvent(<br/>        PubSubPushRequest&lt;LottieEvent&gt; pushRequest<br/>) throws Exception {</span><span id="189e" class="lc ld iq ky b gy li lf l lg lh">    LottieEvent event = pushRequest.getBody();<br/>// ...</span></pre><p id="f880" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好多了！而<code class="fe lk ll lm ky b">PubSubPushRequest</code>可以用于其他订阅的其他事件。也就是说，如果你确定你真的想知道这些女士在做什么。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi ln"><img src="../Images/dc0bb537a9dea645ac457d5d86d1d4b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-iwf7RR2AfBpdTn2.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">到目前为止，哪名大学女子足球队队员成为“鹿角女王”似乎已经很清楚了</figcaption></figure></div></div>    
</body>
</html>