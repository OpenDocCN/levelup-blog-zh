<html>
<head>
<title>Monitor Ansible Playbook Executions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">监控可行的剧本执行</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/monitor-ansible-playbook-executions-bf92ce16d100?source=collection_archive---------19-----------------------#2022-06-19">https://levelup.gitconnected.com/monitor-ansible-playbook-executions-bf92ce16d100?source=collection_archive---------19-----------------------#2022-06-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="841d" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://medium.com/@anasanjaria/list/site-reliability-engineering-fd4dc0eabf12" rel="noopener">现场可靠性工程</a></h2><div class=""/><figure class="gl gn jx jy jz ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/49b1168f23ac8be3ed122484834f1e14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dq-nUQXHtEntjJLy"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">由<a class="ae kl" href="https://unsplash.com/@markuswinkler?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马库斯·温克勒</a>在<a class="ae kl" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="9786" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我计划在生产系统中使用一个配置管理工具。当涉及到生产系统时，了解哪些配置应用成功，哪些没有应用成功是很重要的。</p><p id="6f3a" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在互联网上花了一些时间后，我无法找到一种简单的方法来监控失败的执行。因此我想出了这个解决方案。</p><h1 id="ac0a" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">基本工作流程</h1><ol class=""><li id="7d8c" class="mi mj iq ko b kp mk kt ml kx mm lb mn lf mo lj mp mq mr ms bi translated">使用<a class="ae kl" href="https://docs.ansible.com/ansible/latest/collections/community/general/log_plays_callback.html" rel="noopener ugc nofollow" target="_blank"> log_plays </a>将剧本输出转储到特定于主机的文件中。</li><li id="8ee2" class="mi mj iq ko b kp mt kt mu kx mv lb mw lf mx lj mp mq mr ms bi translated">使用<a class="ae kl" href="https://www.elastic.co/beats/filebeat" rel="noopener ugc nofollow" target="_blank"> filebeat </a>将这些日志发送到elasticsearch。</li><li id="46e2" class="mi mj iq ko b kp mt kt mu kx mv lb mw lf mx lj mp mq mr ms bi translated">最后，使用<a class="ae kl" href="https://www.elastic.co/kibana/" rel="noopener ugc nofollow" target="_blank"> kibana </a>可视化信息。</li></ol><figure class="mz na nb nc gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi my"><img src="../Images/01917b7265b14d1fb1f035f2d1369c20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MXEgabdJb8xmt6V_E6eoeA.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">监控剧本执行的基本工作流程</figcaption></figure><h1 id="2ab1" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">概念证明</h1><p id="82db" class="pw-post-body-paragraph km kn iq ko b kp mk kr ks kt ml kv kw kx nd kz la lb ne ld le lf nf lh li lj ij bi translated">源代码:<a class="ae kl" href="https://github.com/anasanjaria/monitor-ansible-playbook-executions" rel="noopener ugc nofollow" target="_blank">此处</a></p><p id="192b" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">Ansible提供了一个回调函数，通过使用下面的配置将剧本输出写到每个主机的一个文件中。</p><pre class="mz na nb nc gt ng nh ni nj aw nk bi"><span id="0b23" class="nl ll iq nh b gy nm nn l no np">-- ansible.cfg</span><span id="935f" class="nl ll iq nh b gy nq nn l no np">[defaults]   <br/>stdout_callback = log_plays</span></pre><p id="968d" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这将转储以下格式的剧本执行日志。</p><pre class="mz na nb nc gt ng nh ni nj aw nk bi"><span id="0b71" class="nl ll iq nh b gy nm nn l no np">time - path-to-playbook - task-name - task-command - task-status - task-output</span><span id="4849" class="nl ll iq nh b gy nq nn l no np">time - path-to-playbook - task-name - task-command - task-status - task-output</span></pre><p id="7256" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这些日志通过<a class="ae kl" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/dissect-processor.html" rel="noopener ugc nofollow" target="_blank">解析</a>处理器使用filebeat进行解析。由于两个消息之间有一个空行，因此解析是有条件地完成的。</p><pre class="mz na nb nc gt ng nh ni nj aw nk bi"><span id="7699" class="nl ll iq nh b gy nm nn l no np">processors:  <br/>- dissect:  <br/>    when:  <br/>      not:  <br/>        equals:  <br/>          message: ""  <br/>    tokenizer: "%{time} - %{playbook_path} - %{task_name} - %{task_cmd} - %{task_status} - %{task_output}"  <br/>    field: "message"  <br/>    target_prefix: "ansible"</span></pre><p id="f2fa" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">为了用主机信息丰富日志，使用了<a class="ae kl" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/script-processor.html" rel="noopener ugc nofollow" target="_blank">脚本</a>处理器。</p><pre class="mz na nb nc gt ng nh ni nj aw nk bi"><span id="70f4" class="nl ll iq nh b gy nm nn l no np">- script:  <br/>    lang: javascript  <br/>    source: &gt;  <br/>      function process(event) {  <br/>          var ansible_path = event.Get("log.file.path");  <br/>          var host = ansible_path.split("/").pop();  <br/>          event.Put('ansible.host', host)  <br/>      }</span></pre><p id="5044" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">最后，日志被发布到elasticsearch。</p><pre class="mz na nb nc gt ng nh ni nj aw nk bi"><span id="865e" class="nl ll iq nh b gy nm nn l no np">output.elasticsearch:  <br/>  enabled: true  <br/>  hosts: ["elasticsearch-1:9200"]</span></pre><p id="c618" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在，人们可以通过kibana可视化这些信息，并添加观察器，以便在出现故障时通知团队。</p><figure class="mz na nb nc gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi nr"><img src="../Images/c49496f689c801bd3f7ceb1589b6c76d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eMayZXdMF0n040EJh-Cfhg.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">可行的执行状态—成功与失败</figcaption></figure><p id="a400" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">感谢阅读。</p></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><p id="edde" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果你喜欢这篇文章，你可能也会喜欢我的网站可靠性工程系列。</p><div class="nz oa gp gr ob"><div role="button" tabindex="0" class="ab bv gv cb fp oc od bn oe kf ex"><div class="of l"><div class="ab q"><div class="l di"><img alt="Anas Anjaria" class="l de bw og oh fe" src="../Images/89827307249a30f11a5732a9890e912d.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*uUIPYdjxGW5QbiWgjkhyDg.jpeg"/><div class="fb bw l og oh fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated">阿纳斯·安贾里亚</p></div></div><div class="ok ol gw l"><h2 class="bd ja tv mi fp tw fr fs tx fu fw iz bi translated">现场可靠性工程</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi ty au tz ua ub qg uc an eh ei ud ue uf el em eo de bk ep" href="https://medium.com/@anasanjaria/list/site-reliability-engineering-fd4dc0eabf12?source=post_page-----bf92ce16d100--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="ug l fo"><span class="bd b dl z dk">6 stories</span></div></div></div><div class="ox dh oy fp ab oz fo di"><div class="di op bv oq or"><div class="dh l"><img alt="Essential metrics to monitor continuous archiving &amp; point-in-time recovery" class="dh" src="../Images/218297210fc211ae26c0d6cc69260bb0.png" width="194" height="194" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*IE5FIi4NRZ7iIGYk6siJzw.png"/></div></div><div class="di op bv os ot ou"><div class="dh l"><img alt="Monitor Your System — Practical Guide. Site reliability engineering" class="dh" src="../Images/3d271359e6086a41f80bff2b638af676.png" width="194" height="194" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*SOX9hjN4XpoQA8co"/></div></div><div class="di bv ov ow ou"><div class="dh l"><img alt="High level overview of collecting Postgres metrics using custom query" class="dh" src="../Images/d643efa963dab995deed8d0125948586.png" width="194" height="194" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*wGBWHb2-SVt6p9m_GF4XTg.png"/></div></div></div></div></div></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><pre class="mz na nb nc gt ng nh ni nj aw nk bi"><span id="e6e5" class="nl ll iq nh b gy nm nn l no np"><strong class="nh ja">Want to connect?<br/></strong><a class="ae kl" href="http://anasanjaria.bio.link/" rel="noopener ugc nofollow" target="_blank">http://anasanjaria.bio.link/</a></span></pre></div></div>    
</body>
</html>