<html>
<head>
<title>Accessing AWS DynamoDB through Apollo GraphQL Server deployed in AWS Lambda through Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过部署在AWS Lambda中的Apollo GraphQL服务器访问AWS DynamoDB</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/accessing-aws-dynamodb-through-apollo-graphql-server-deployed-in-aws-lambda-through-serverless-e2752c84281c?source=collection_archive---------2-----------------------#2021-01-03">https://levelup.gitconnected.com/accessing-aws-dynamodb-through-apollo-graphql-server-deployed-in-aws-lambda-through-serverless-e2752c84281c?source=collection_archive---------2-----------------------#2021-01-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/072195250a6b1f09966a3b33b5eae108.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zh7m1uPRaQTaTFmllYermg.png"/></div></div></figure><p id="ba40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">目标</strong>:通过GraphQL lambda函数获取DynamoDB表的所有记录。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="d8c2" class="lf lg iq lb b gy lh li l lj lk">Query:</span><span id="1cae" class="lf lg iq lb b gy ll li l lj lk"><strong class="lb ir">query {</strong></span><span id="f1a9" class="lf lg iq lb b gy ll li l lj lk"><strong class="lb ir">quotes {<br/>  id<br/>  value<br/>  source<br/> }</strong></span><span id="2ad4" class="lf lg iq lb b gy ll li l lj lk"><strong class="lb ir">}</strong></span><span id="4783" class="lf lg iq lb b gy ll li l lj lk">Response:</span><span id="0571" class="lf lg iq lb b gy ll li l lj lk"><strong class="lb ir">{<br/>  "data": {<br/>    "quotes": [<br/>      {<br/>        "id": "q2",<br/>        "value": "If you don’t like how things are, change it! You’re not a tree.",<br/>        "source": "Jim Rohn"<br/>      },<br/>      {<br/>        "id": "q1",<br/>        "value": "Start with the end in mind.",<br/>        "source": "Stephen Covey"<br/>      }<br/>    ]<br/>  }<br/>}</strong></span></pre><p id="815f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用的技术:AWS DynamoDB，AWS Lambda，AWS IAM，<a class="ae lm" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank"> Serverless </a>，<a class="ae lm" href="https://www.apollographql.com/docs/apollo-server/" rel="noopener ugc nofollow" target="_blank"> Apollo Graphql </a></p><p id="193e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">先决条件</strong>:AWS基础知识和JavaScript中级知识，以及Apollo服务器。</p><p id="68bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">步骤1 —创建一个DynamoDB表</strong></p><p id="4f1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，用主键<em class="ln"> id在<a class="ae lm" href="https://console.aws.amazon.com/dynamodb/home" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>中创建一个名为<em class="ln"> Quote </em>的表。</em></p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lo"><img src="../Images/accbf78463cdc4276b1998a8a25fbbed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rhxrSaPZV_Y8e7MW9u08RQ.png"/></div></div><figcaption class="lp lq gj gh gi lr ls bd b be z dk translated">创建DynamoBD表</figcaption></figure><p id="c534" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过C <em class="ln">创建项目向表中添加一些条目。</em>您可以使用以下示例JSON文本(而不是下拉菜单上的<em class="ln">树</em>选项)</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lt"><img src="../Images/c42e8a80fedb7c2c5e79b03b759a6a91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k35b7-gzkDeT4gTLQuCOvQ.png"/></div></div></figure><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="1fe5" class="lf lg iq lb b gy lh li l lj lk"><strong class="lb ir">{<br/>    "id": "q1",<br/>    "value": "Start with the end in mind.",<br/>    "source": "Stephen Covey"<br/>}</strong></span></pre><p id="22b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击了解更多关于No SQL和DynamoDB <a class="ae lm" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Introduction.html" rel="noopener ugc nofollow" target="_blank">的信息。</a></p></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><p id="fd39" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">步骤2 —创建AWS IAM用户并配置AWS配置文件</strong></p><p id="63db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要访问任何AWS服务，我们需要一个具有适当访问权限的IAM用户。</p><p id="2688" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到AWS IAM <a class="ae lm" href="https://console.aws.amazon.com/iam/home?region=us-east-1#/users" rel="noopener ugc nofollow" target="_blank">控制台</a>并添加一个名为<em class="ln">无服务器</em>的用户(该用户将被<a class="ae lm" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>用来连接到AWS服务)。</p><p id="c799" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择访问类型为<em class="ln">编程访问</em></p><p id="f170" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在权限上，转到<em class="ln">直接附加现有策略</em>并暂时给予<em class="ln">管理员访问权限</em><em class="ln">。</em></p><blockquote class="mb mc md"><p id="1ad6" class="jy jz ln ka b kb kc kd ke kf kg kh ki me kk kl km mf ko kp kq mg ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="iq"> AdministratorAccess —授予对所有AWS资源的完全访问权限。对于生产应用程序，您应该根据</em> </strong>的要求提供细粒度的控制</p></blockquote><p id="1648" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用默认值继续其他步骤。在最后一步，您将看到访问和密钥。下载。csv文件或复制这些值，因为您以后将无法访问它们。</p><p id="7eb9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在您需要在您的机器中配置这个用户。为此，您需要安装AWS CLI。AWS命令行界面(CLI)是管理AWS服务的统一工具。</p><p id="0cc9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae lm" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank">根据你的操作系统安装CLI </a>。</p><p id="023b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在您的终端上运行<code class="fe mh mi mj lb b">aws configure <strong class="ka ir">--profile serverlessuser</strong></code>。注意，配置文件名与我们在上一步中创建的IAM用户名不同。你可以给它起任何名字，比如<em class="ln"> serverlessprofile。</em></p><p id="a110" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mh mi mj lb b">--profile</code> —名为配置文件的<em class="ln">是可以应用于AWS CLI命令的设置和凭证的集合。当您指定运行命令的配置文件时，将使用设置和凭据来运行该命令。您可以指定一个“默认”的概要文件，并在没有明确引用概要文件时使用。</em></p><p id="31e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">阅读<a class="ae lm" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html" rel="noopener ugc nofollow" target="_blank">此处</a>了解更多详情。</p><p id="2574" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在命令提示符下运行<code class="fe mh mi mj lb b">aws configure --profile serverlessuser</code>，并提供访问权限和密钥以及一些其他细节，如地区(对我来说，我有<em class="ln"> us-east-1 </em></p><p id="b286" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">到现在为止，您的系统中应该有两个概要文件<em class="ln"> default </em>和<em class="ln"> serverlessuser </em>(您可以检查您的[HOMEDIR]/)。aws/)</p><p id="9b86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在将代码部署到AWS之前，让我们首先尝试从本地运行的Apollo服务器获取该表的数据。</p></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><p id="b3f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">步骤3 — Apollo服务器和GraphQL设置</strong></p><p id="8182" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是设置apollo服务器、创建模式和从<em class="ln"> Quote </em>表中获取数据的最少代码。</p><p id="6838" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你是阿波罗服务器的新手，请阅读这个。</p><p id="1fcf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">简单地说，Apollo Server是一个GraphQL兼容的服务器，既可以独立运行，也可以在无服务器环境中运行。在这一步中，我们将把它作为一个独立的服务器运行，稍后我们将创建一个lambda函数在AWS lambda环境中运行。</p><p id="205b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个文件夹，然后粘贴创建一个package.json和server.js文件，如下所示。</p><p id="bce5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用下面的<code class="fe mh mi mj lb b">package.json</code>做<code class="fe mh mi mj lb b">npm install</code>。注意，它有一些额外的节点模块，我们稍后将使用这些模块来创建lambda函数。</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="0c9f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个文件名<code class="fe mh mi mj lb b">server.js</code>并运行<code class="fe mh mi mj lb b">node server.js</code>来启动服务器。</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="b15e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您现在应该能够在<code class="fe mh mi mj lb b">localhost:4000</code>访问GraphQL实例，并且能够查询报价。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="311a" class="lf lg iq lb b gy lh li l lj lk"><strong class="lb ir">query {</strong></span><span id="87f2" class="lf lg iq lb b gy ll li l lj lk"><strong class="lb ir">quotes {<br/>  id<br/>  value<br/>  source<br/> }</strong></span><span id="8ecc" class="lf lg iq lb b gy ll li l lj lk"><strong class="lb ir">}</strong></span></pre><p id="5612" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码非常简单。您为<code class="fe mh mi mj lb b">quotes</code>定义一个模式，解析器调用<code class="fe mh mi mj lb b">getQuotes</code>方法，其中实际的代码是获取数据。</p><p id="5b6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看代码的关键部分。</p><p id="e0db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS为各种语言提供了与AWS服务交互的SDK。为了访问DynamoDB，我们利用了<code class="fe mh mi mj lb b">@aws-sdk/client-dynamodb</code></p><p id="9aad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mh mi mj lb b">const { DynamoDBClient, ScanCommand } = require(“@aws-sdk/client-dynamodb”);</code></p><blockquote class="mb mc md"><p id="1a9f" class="jy jz ln ka b kb kc kd ke kf kg kh ki me kk kl km mf ko kp kq mg ks kt ku kv ij bi translated">默认情况下，<code class="fe mh mi mj lb b">DynamoDBClient</code>将利用默认配置文件来访问AWS服务</p></blockquote><p id="f907" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mh mi mj lb b">const client = new DynamoDBClient({ region: “us-east-1” });</code></p><p id="8c36" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mh mi mj lb b">ScanCommand</code>用于读取表格中的所有记录。<a class="ae lm" href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/dynamodb/index.html" rel="noopener ugc nofollow" target="_blank">这里的</a>是所有命令的完整参考。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="299a" class="lf lg iq lb b gy lh li l lj lk">const results = await client.send(new ScanCommand(params));</span></pre><p id="647e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后一个关键部分是</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="1d78" class="lf lg iq lb b gy lh li l lj lk">quotes.push(<strong class="lb ir">unmarshall</strong>(item));</span></pre><p id="014a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mh mi mj lb b">unmarshall</code>是DynamoDB util，用于将DynamoDB JSON格式转换为普通JSON。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="11e4" class="lf lg iq lb b gy lh li l lj lk">const { unmarshall } = require(“@aws-sdk/util-dynamodb”);</span></pre><p id="3fae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为这篇文章已经很长了，我将在下一篇文章中继续，看看如何通过无服务器将这段代码部署为AWS lambda函数。但是在我们结束之前，让我们看看什么是<em class="ln">编组</em>和<em class="ln">解组</em>？</p><p id="5207" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">DynamoDB将Javascript类型转换为dynamo db<em class="ln">attribute value</em></p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="2686" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那是什么意思？所以在步骤1中，我们添加了JSON文本作为简单的键-值对</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="6fde" class="lf lg iq lb b gy lh li l lj lk"><strong class="lb ir">{<br/>    "id": "q1",<br/>    "value": "Start with the end in mind.",<br/>    "source": "Stephen Covey"<br/>}<br/></strong></span></pre><p id="0d44" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是DynamoDB <strong class="ka ir"> <em class="ln">编组</em> </strong>这些JavaScript对象并引入键来识别数据类型。要查看结果，请在获取结果后执行<code class="fe mh mi mj lb b">console.log(results.Items);</code>。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="54d3" class="lf lg iq lb b gy lh li l lj lk">//output<br/>[{</span><span id="cf85" class="lf lg iq lb b gy ll li l lj lk"><strong class="lb ir">id: { S: "q1" },<br/>value: { S: "Start with the end in mind." },<br/>source: { S: "Stephen Covey" }</strong></span><span id="bf22" class="lf lg iq lb b gy ll li l lj lk">}];</span></pre><p id="9868" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你会注意到键名<code class="fe mh mi mj lb b">S</code>指示<em class="ln">字符串</em>类型数据<strong class="ka ir">被编组</strong>到<strong class="ka ir"> <em class="ln">属性值</em> </strong> s，所以为了<strong class="ka ir">解组</strong>并获得普通JSON，我们使用了util <code class="fe mh mi mj lb b">unmarshall</code>。</p><p id="50e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">希望这能解释。这里可以阅读更多<a class="ae lm" href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/DynamoDB/Converter.html" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><p id="fb3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">更新:</strong>发布了文章的第2部分，以<a class="ae lm" rel="noopener ugc nofollow" target="_blank" href="/deploying-an-apollo-graphql-application-as-an-aws-lambda-function-through-serverless-77fa33612bae">通过无服务器</a>将该应用程序部署为AWS lambda函数</p></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><p id="dd46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">希望我没有错过这里的任何关键步骤，但如果我错过了，请随时留下评论。要在文章的下一部分获得通知，将这段代码部署为AWS lambda函数，请在medium或<a class="ae lm" href="https://twitter.com/cssmiles" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我。</p><p id="f801" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你喜欢这个，请点击👏按钮并分享，帮助其他人找到它！</p></div></div>    
</body>
</html>