<html>
<head>
<title>Deploying multiple Lambda functions in one CloudFormation stack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在一个CloudFormation堆栈中部署多个Lambda函数</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploying-multiple-lambda-functions-in-one-cloudformation-stack-c0f87718f701?source=collection_archive---------1-----------------------#2021-07-29">https://levelup.gitconnected.com/deploying-multiple-lambda-functions-in-one-cloudformation-stack-c0f87718f701?source=collection_archive---------1-----------------------#2021-07-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="ca73" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当用Amplify添加一个新函数时，它会在CloudFormation上创建一个新的栈。如果你的项目或团队变得更大，这可能会导致一个问题，因为CloudFormation允许你为每个AWS账户创建最多<a class="ae ko" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cloudformation-limits.html" rel="noopener ugc nofollow" target="_blank"> 200个栈。</a></p><p id="6998" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">作为一种变通方法，我们可以从一个资源中部署多个功能。这种方法的另一个好处是，如果每个功能在同一个域中，我们可以共享相同的策略/执行角色。</p><p id="c0fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面的数字代表了产量。如你所见，一个单独的云生成堆栈(<code class="fe kp kq kr ks b">amplify-multiplefunction-dev</code>)正在生成两个λ函数(<code class="fe kp kq kr ks b">multiplefunction-functionOne</code>、<code class="fe kp kq kr ks b">multiplefunction-functionTwo</code>)。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/249ab361b3157b9f93d281bd8402eda8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nJHm-F4lrSdCG2TJT2-spQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">云形成堆栈</figcaption></figure><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/8fcaed84097e2ada927e5db5ace9ecf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nH_RfhTZYoXlaW0kli4Drg.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">λ函数</figcaption></figure><p id="45cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们看看如何建造它。如果你想直接进入代码的最终输出，这里有链接。</p><div class="lk ll gp gr lm ln"><a href="https://github.com/tomoima525/amplify-multiple-lambdas-in-one-resource" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab fo"><div class="lp ab lq cl cj lr"><h2 class="bd iu gy z fp ls fr fs lt fu fw is bi translated">GitHub-tomo IMA 525/amplify-multiple-lambdas-in-one-resource:一个repo展示了添加多个…</h2><div class="lu l"><h3 class="bd b gy z fp ls fr fs lt fu fw dk translated">这个repo展示了使用Amplify在一个资源中添加多个lambda函数(team-provider-info.json被屏蔽了…</h3></div><div class="lv l"><p class="bd b dl z fp ls fr fs lt fu fw dk translated">github.com</p></div></div><div class="lw l"><div class="lx l ly lz ma lw mb ld ln"/></div></div></a></div><h1 id="0076" class="mc md it bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">项目架构</h1><p id="0733" class="pw-post-body-paragraph jq jr it js b jt na jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj ne kl km kn im bi translated">项目架构的最终输出如下所示。</p><pre class="ku kv kw kx gt nf ks ng nh aw ni bi"><span id="2bf3" class="nj md it ks b gy nk nl l nm nn">├── function<br/>│   └── multiplefunctionxxxx<br/>│       ├── function-parameters.json<br/>│       ├── multiplefunctionxxxx-cloudformation-template.json<br/>│       └── src<br/>│           ├── functionOne<br/>│           │   ├── event.json<br/>│           │   └── index.js<br/>│           ├── functionTwo<br/>│           │   ├── event.json<br/>│           │   └── index.js<br/>│           ├── package-lock.json<br/>│           └── package.json</span></pre><p id="ff48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">package.json</code>位于<code class="fe kp kq kr ks b">src</code>下而不是每个功能下的原因是当<code class="fe kp kq kr ks b">package.json</code>不在该位置时<code class="fe kp kq kr ks b">amplify push</code>命令失效。似乎Amplify cli在执行命令时找不到npm包。</p><h1 id="ad2d" class="mc md it bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">更新模板</h1><p id="f971" class="pw-post-body-paragraph jq jr it js b jt na jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj ne kl km kn im bi translated">我们先用<code class="fe kp kq kr ks b">amplify add function</code>命令创建一个Lambda函数，命名为<code class="fe kp kq kr ks b">multiplefunction</code>。执行完成后，您将看到<code class="fe kp kq kr ks b">multiplefunction{random_value}</code>项目被创建。</p><p id="4fcf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">之后，让我们在<code class="fe kp kq kr ks b">src</code>目录下创建目录<code class="fe kp kq kr ks b">functionOne</code>和<code class="fe kp kq kr ks b">functionTwo</code>，并将<code class="fe kp kq kr ks b">index.js</code>和<code class="fe kp kq kr ks b">src</code>下的其他文件复制到每个目录中。</p><p id="57aa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后打开<code class="fe kp kq kr ks b">multiplefunction{random_value}-cloudformation-template.json</code>，为第二个lambda函数添加一个资源。</p><pre class="ku kv kw kx gt nf ks ng nh aw ni bi"><span id="12d7" class="nj md it ks b gy nk nl l nm nn">"Resource": {<br/>    "LambdaFunction": {<br/>      ...,<br/>      "Properties": {<br/>        "Handler": "functionOne/index.handler", // Change the directory path<br/>        ...<br/>      },<br/>      ...</span><span id="175e" class="nj md it ks b gy no nl l nm nn">    }<br/>    "LambdaFunctionTwo": {<br/>      "Type": "AWS::Lambda::Function",<br/>      "Metadata": {<br/>        "aws:asset:path": "./src",<br/>        "aws:asset:property": "Code"<br/>      },<br/>      "Properties": {<br/>        "Code": {<br/>          "S3Bucket": {<br/>            "Ref": "deploymentBucketName"<br/>          },<br/>          "S3Key": {<br/>            "Ref": "s3Key"<br/>          }<br/>        },<br/>        "Handler": "functionTwo/index.handler",  // You must set the path to the actual function<br/>        "FunctionName": {<br/>          "Fn::If": [<br/>            "ShouldNotCreateEnvResources",<br/>            "multiplefunctionec0b1d53",<br/>            {<br/>              "Fn::Join": [<br/>                "",<br/>                [<br/>                  "multiplefunctionec0b1d53",<br/>                  "-",<br/>                  "functionTwo-", // function name should be unique<br/>                  {<br/>                    "Ref": "env"<br/>                  }<br/>                ]<br/>              ]<br/>            }<br/>          ]<br/>        },<br/>        "Environment": {<br/>          "Variables": {<br/>            "ENV": {<br/>              "Ref": "env"<br/>            },<br/>            "REGION": {<br/>              "Ref": "AWS::Region"<br/>            }<br/>          }<br/>        },<br/>        "Role": {<br/>          "Fn::GetAtt": [<br/>            "LambdaExecutionRole",<br/>            "Arn"<br/>          ]<br/>        },<br/>        "Runtime": "nodejs14.x",<br/>        "Layers": [],<br/>        "Timeout": "25"<br/>      }<br/>    }<br/>}</span></pre><p id="d26d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里重要的一点是，您需要唯一地命名<code class="fe kp kq kr ks b">Function</code>资源和<code class="fe kp kq kr ks b">FunctionName</code>(在上面的例子中，分别是<code class="fe kp kq kr ks b">LambdaFunctionTwo</code>和<code class="fe kp kq kr ks b">multiplefunctionxxxx-functiontwo-{env}</code>)。</p><p id="ab75" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您需要配置的下一步是日志资源。在<code class="fe kp kq kr ks b">lambdaexecutionPolicy</code>下添加以下设置，并确保其目标为<code class="fe kp kq kr ks b">LambdaFunctionTwo</code></p><pre class="ku kv kw kx gt nf ks ng nh aw ni bi"><span id="2c4e" class="nj md it ks b gy nk nl l nm nn">"lambdaexecutionpolicy": {<br/>  "PolicyDocument": {<br/>    "Resource": [<br/>      {...},<br/>      {<br/>        "Fn::Sub": [<br/>          "arn:aws:logs:${region}:${account}:log-group:/aws/lambda/${lambda}:log-stream:*",<br/>          {<br/>            "region": {<br/>              "Ref": "AWS::Region"<br/>            },<br/>            "account": {<br/>              "Ref": "AWS::AccountId"<br/>            },<br/>            "lambda": {<br/>              "Ref": "LambdaFunctionTwo"  // reference to LambdaFunctionTwo<br/>            }<br/>          }<br/>        ]<br/>      }<br/>    ]</span></pre><p id="c7ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后一步实际上是可选的，添加<code class="fe kp kq kr ks b">Outputs</code>，这样我们就可以引用新添加的函数</p><pre class="ku kv kw kx gt nf ks ng nh aw ni bi"><span id="d138" class="nj md it ks b gy nk nl l nm nn">"Outputs": {<br/>  ...,<br/>  "FunctionTwoName": {<br/>    "Value": {<br/>      "Ref": "LambdaFunctionTwo"<br/>    }<br/>  },<br/>  "FunctionTwoArn": {<br/>    "Value": {<br/>      "Fn::GetAtt": [<br/>        "LambdaFunctionTwo",<br/>        "Arn"<br/>      ]<br/>    }<br/>  },<br/>}</span></pre><p id="e0e6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦一切都更新了，运行<code class="fe kp kq kr ks b">amplify env checkout {your environment}</code>以便<code class="fe kp kq kr ks b">amplify-meta.json</code>(一个写下你的环境的隐藏文件)得到更新。最后，运行<code class="fe kp kq kr ks b">amplify push --y</code>，将你的云信息推送到云端。</p></div><div class="ab cl np nq hx nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="im in io ip iq"><p id="804c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就是这样！感谢您阅读这篇文章。有一点要注意，如果你想从这个堆栈中删除一个函数，只需从cloudformation-template.json中删除即可，不要试图从Lambda UI控制台或CloudFormation UI控制台中删除它，这将导致Amplify环境的严重故障。</p></div></div>    
</body>
</html>