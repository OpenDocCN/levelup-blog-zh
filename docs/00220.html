<html>
<head>
<title>Giving React + GraphQL a Lift with Apollo-Boost</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Apollo-Boost提升React + GraphQL</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/giving-react-a-lift-with-apollo-boost-74c6ff32894d?source=collection_archive---------0-----------------------#2018-10-01">https://levelup.gitconnected.com/giving-react-a-lift-with-apollo-boost-74c6ff32894d?source=collection_archive---------0-----------------------#2018-10-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c0c7aa33ce315abe01fe4f0910789a13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DZzwc1aIYGnMdJJOanpPwg.jpeg"/></div></div></figure><p id="79a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你在项目中使用<a class="ae kw" href="https://graphql.org/" rel="noopener ugc nofollow" target="_blank"> GraphQL <em class="kx"> </em> </a>，你肯定会遇到Apollo和他们的GraphQL支持工具。</p><p id="fc40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Apollo引入的工具集之一是Apollo-Boost(从现在开始我简称它为Boost)。Boost允许在应用程序中使用最少的Apollo客户端配置和样板文件。Apollo Client本身是一个包装类，旨在简化与GraphQL服务器的交互(正如我们将看到的，客户端GraphQL也是如此)。</p><p id="b5d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除此之外，他们还对React框架提供了工具支持。虽然客户端是独立于框架的，但是<a class="ae kw" href="https://github.com/apollographql/react-apollo" rel="noopener ugc nofollow" target="_blank"> react-apollo </a>库具有与apollo客户端无缝集成的组件。</p><h1 id="d298" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">装置</h1><p id="e4d3" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">为了快速启动并运行新的react-apollo客户端，我推荐使用<a class="ae kw" href="https://github.com/facebook/create-react-app" rel="noopener ugc nofollow" target="_blank"> create-react-app </a>:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="5be1" class="mk kz iq mg b gy ml mm l mn mo">npx create-react-app create_react_app</span></pre><p id="ca07" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意是<a class="ae kw" href="https://medium.com/@maybekatz/introducing-npx-an-npm-package-runner-55f7d4bd282b" rel="noopener"> <strong class="ka ir"> npx </strong> </a>，不是<strong class="ka ir">NPM</strong>；<strong class="ka ir"> create_react_app </strong>是我为新项目选择的名字。生成的package.json文件将包含以下内容:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="3d29" class="mk kz iq mg b gy ml mm l mn mo">{<br/>  "name": "create_react_app",<br/>  "version": "0.1.0",<br/>  "private": true,<br/>  "dependencies": {<br/>    "react": "^16.5.2",<br/>    "react-dom": "^16.5.2",<br/>    "react-scripts": "1.1.5"<br/>  },<br/>  "scripts": {<br/>    "start": "react-scripts start",<br/>    "build": "react-scripts build",<br/>    "test": "react-scripts test --env=jsdom",<br/>    "eject": "react-scripts eject"<br/>  }<br/>}</span></pre><p id="d2e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您会注意到提供了几个构建脚本，react-scripts用作应用程序启动器。react-scripts启动器以最小的配置提供了一个精选的依赖项列表。你可以在这里阅读<a class="ae kw" href="https://github.com/facebook/create-react-app#whats-included" rel="noopener ugc nofollow" target="_blank">提供的内容。当执行<code class="fe mp mq mr mg b">npm run start</code>时，它将启动一个hot React服务器(当检测到代码变化时重新启动的服务器),并将在您的浏览器中自动加载一个示例应用程序页面。</a></p><p id="93ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在继续之前，需要安装三个额外的软件包(已经提到过):</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="39ae" class="mk kz iq mg b gy ml mm l mn mo">npm install --save apollo-boost react-apollo graphql</span></pre><h1 id="cb53" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">构建应用程序</h1><p id="9b00" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">Boost提供的主要工具是ApolloClient类。这提供了查询、变异和订阅方法，通过承诺简化了客户端-GraphQL的交互。</p><p id="98ee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一步是配置一个ApolloClient实例。我将使用<a class="ae kw" href="https://www.apollographql.com/docs/react/essentials/get-started.html#installation" rel="noopener ugc nofollow" target="_blank"> Apollo客户端安装说明</a>中提供的GraphQL服务器设置。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="f7d1" class="mk kz iq mg b gy ml mm l mn mo">import ApolloClient from "apollo-boost";<br/><br/>const client = new ApolloClient({<br/>  uri: "https://w5xlvm3vzz.lp.gql.zone/graphql"<br/>});</span></pre><p id="5f31" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该服务器是使用Apollo Launchpad(你应该随身携带的另一个GraphQL工具)构建的，你可以在这里在线访问它。请注意，在撰写本文时，Launchpad中显示的查询是错误的，应该类似于:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="d6b1" class="mk kz iq mg b gy ml mm l mn mo">query rates($currency: String!) {<br/>  rates(currency: $currency) {<br/>    currency<br/>    rate<br/>    name<br/>  }<br/>}</span></pre><p id="8729" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置好客户端后，接下来将ApolloProvider组件插入到应用程序中:</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="e1c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">(我已经从最初生成的应用程序中清理了一点语法。)</p><p id="36a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ApolloProvider是React应用程序和GraphQL客户端之间的连接组件。从提供者内部，我们可以在应用程序中添加查询和变异组件，这些组件根据上下文进行操作。您可以将上下文视为应用程序的状态，但它是通过GraphQL脚本访问的。</p><h1 id="011a" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">使用查询</h1><p id="8597" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">查询组件将GraphQL查询字符串作为属性。该查询字符串在组件呈现时执行，调用一个函数，该函数将<strong class="ka ir">加载</strong>状态、<strong class="ka ir">错误</strong>(如果有)和数据<strong class="ka ir"> <em class="kx">结果</em> </strong>作为参数。通常会发生的是，一旦<strong class="ka ir"> loading </strong>为false(查询数据已加载完毕)，并且没有返回<strong class="ka ir">错误</strong>，那么数据属性将被传递给子组件。</p><p id="d4da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以前面显示的查询为例，我们可以创建一个简单的显示:</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="14d0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，回到主应用程序:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="2da4" class="mk kz iq mg b gy ml mm l mn mo"><strong class="mg ir">import ExchangeRates from './ExchangeRates'</strong></span><span id="5886" class="mk kz iq mg b gy mu mm l mn mo">const client = new ApolloClient({<br/>  uri: "<a class="ae kw" href="https://w5xlvm3vzz.lp.gql.zone/graphql" rel="noopener ugc nofollow" target="_blank">https://w5xlvm3vzz.lp.gql.zone/graphql</a>"<br/>});</span><span id="740a" class="mk kz iq mg b gy mu mm l mn mo">const App = () =&gt; (<br/>  &lt;ApolloProvider client={client}&gt;<br/>    &lt;div className="App"&gt;<br/>      &lt;header className="App-header"&gt;<br/>        &lt;img src={logo} className="App-logo" alt="logo" /&gt;<br/>        &lt;h1 className="App-title"&gt;Welcome to React&lt;/h1&gt;<br/>      &lt;/header&gt;<br/>      <strong class="mg ir">&lt;ExchangeRates/&gt;</strong><br/>    &lt;/div&gt;<br/>  &lt;/ApolloProvider&gt;<br/>)</span></pre><p id="a983" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您会注意到ExchangeRates会进行自己的查询，因此该组件是完全独立的。</p><p id="74ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">生成的页面并不美观，但却很准确:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/faa871be3a1d33e0f21ef5e2a84aa576.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QqZEiEQsP96PlcRUp9An1A.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">相对于美元的部分货币汇率列表(美元)</figcaption></figure><h1 id="653c" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">默认值和客户端上下文</h1><p id="6b76" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">下一步是更好地利用顶部显示React徽标的屏幕空间，将其替换为货币输入，这样用户就不必滚动一大串货币缩写来找到她感兴趣的缩写。</p><h2 id="0557" class="mk kz iq bd la na nb dn le nc nd dp li kj ne nf lm kn ng nh lq kr ni nj lu nk bi translated">设置默认值</h2><p id="4e98" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">添加一个默认值(或多个值)来启动应用程序是对前面显示的ApolloClient配置的一个非常简单的修改:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="dbc8" class="mk kz iq mg b gy ml mm l mn mo">const client = new ApolloClient({<br/>  uri: "<a class="ae kw" href="https://w5xlvm3vzz.lp.gql.zone/graphql" rel="noopener ugc nofollow" target="_blank">https://w5xlvm3vzz.lp.gql.zone/graphql</a>",<br/><strong class="mg ir">  clientState: {<br/>    defaults: {<br/>      currencyOfInterest: 'USD',<br/>    }<br/>  }</strong><br/>})</span></pre><p id="2e8c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> currencyOfInterest </strong>将存储在客户端的本地。我们通过<strong class="ka ir"> @client </strong>指令通知查询位置。我稍微修改了原始组件布局，以便来自服务器的原始查询结果通过props传递给ExchangeSelector。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="6e7c" class="mk kz iq mg b gy ml mm l mn mo">const ExchangeRates = (client) =&gt; (<br/>  &lt;Query<br/>    query={gql`<br/>      {<br/>        rates(currency: "USD") {<br/>          currency<br/>          rate<br/>          name<br/>        }<br/>      }<br/>    `}<br/>  &gt;<br/>    {({ loading, error, data }) =&gt; {<br/>      if (loading) return &lt;p&gt;Loading...&lt;/p&gt;;<br/>      if (error) return &lt;p&gt;Error :(&lt;/p&gt;;</span><span id="01a1" class="mk kz iq mg b gy mu mm l mn mo">return (&lt;div&gt;<br/>        &lt;header className="App-header"&gt;<br/>          <strong class="mg ir">&lt;ExchangeSelector data={data}/&gt;</strong><br/>        &lt;/header&gt;<br/>          &lt;ExchangeList data={data} /&gt;;<br/>        &lt;/div&gt;)<br/>    }}<br/>  &lt;/Query&gt;<br/>);</span></pre><p id="10e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是新的React ExchangeSelector组件:</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="3f4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第6行的<strong class="ka ir"> @client </strong>标识告诉ApolloClient可以在本地缓存中找到该值。通过查询和变异操作，可以访问和写入该值，就像它驻留在服务器上一样。然而，由于这是本地存储的，使用第21行所示的<code class="fe mp mq mr mg b">client.writeData()</code>直接更新客户端缓存通常更方便。</p><p id="ff73" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ExchangeSelector从其父容器中获取利率，当currencyOfInterest的输入发生变化时，所有三个输入元素都会更新(第20–21行)。onChange处理程序直接写入客户端的缓存，这将触发ExchangeSelector本身的重新呈现。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/1804f23052d19079bcd13544ae1d536e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zHJE_d4XsaqRn297rqykFA.png"/></div></div></figure><h1 id="6626" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">包装它</h1><p id="f7c1" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">这个例子的完整代码可以在这里找到<a class="ae kw" href="https://github.com/JeffML/create-react-app" rel="noopener ugc nofollow" target="_blank">。README.md详细介绍了create-react-app(不是我写的，是它写的)。</a></p></div></div>    
</body>
</html>