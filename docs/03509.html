<html>
<head>
<title>Persisting your React application state with Redux and Typescript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Redux和Typescript持久化React应用程序状态</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/persisting-your-react-application-state-with-redux-and-typescript-51e4e66c4e53?source=collection_archive---------2-----------------------#2020-05-13">https://levelup.gitconnected.com/persisting-your-react-application-state-with-redux-and-typescript-51e4e66c4e53?source=collection_archive---------2-----------------------#2020-05-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="91bb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何使用redux-persist管理应用程序状态并将其保存到任何类型的存储中</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3e30bd1d92a324f820cb7e8753c05fe2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8i8jL7s9IgEWfnw0jYCb5A.jpeg"/></div></div></figure><p id="cefa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您曾经开发过React应用程序，并选择使用Redux来维护您的状态，在某些时候，您可能会考虑将它保存在本地存储中，以便您的用户可以在关闭浏览器或离开您的网站之前总是返回到相同的位置。redux-persist 包使这变得非常容易，在本文中我将向您展示如何做到这一点。</p><h1 id="074a" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">要求</h1><p id="f1f8" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">假设你已经<a class="ae ln" href="https://developer.mozilla.org/en-US/docs/Learn/Server-side/Express_Nodejs/development_environment" rel="noopener ugc nofollow" target="_blank">建立了一个节点开发环境</a>，这里列出了你成功完成本教程所需要的一切。</p><h2 id="f431" class="ml lp iq bd lq mm mn dn lu mo mp dp ly la mq mr ma le ms mt mc li mu mv me mw bi translated">用类型脚本反应应用程序</h2><p id="a9a1" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">如果你是React新手，我建议<a class="ae ln" href="https://create-react-app.dev/docs/adding-typescript/" rel="noopener ugc nofollow" target="_blank">看一下文档</a>，在继续之前学习如何用create-react-app创建你的第一个React应用程序。我将在本教程中输入我的组件，所以了解一点Typescript不会有什么坏处。</p><h2 id="7357" class="ml lp iq bd lq mm mn dn lu mo mp dp ly la mq mr ma le ms mt mc li mu mv me mw bi translated">Redux商店</h2><p id="4a28" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">我还假设您已经掌握了一些关于如何使用Redux跟踪应用程序状态的知识。如果您是Redux的新手，首先看看如何创建您的商店并将其连接到您的组件。</p><h2 id="8379" class="ml lp iq bd lq mm mn dn lu mo mp dp ly la mq mr ma le ms mt mc li mu mv me mw bi translated">redux-持久化</h2><p id="0212" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">这是我们将用来为我们做所有存储和检索的包。</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="6dfc" class="ml lp iq my b gy nc nd l ne nf">npm install redux-persist @types/redux-persist --save</span></pre><h1 id="da71" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">国家</h1><p id="b689" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">出于本教程的目的，我们将假设我们的应用程序状态具有由以下接口定义的结构:</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="d688" class="ml lp iq my b gy nc nd l ne nf">export interface <strong class="my ir">IAppState</strong> {<br/>    authentication?: <strong class="my ir">IAuthenticationState</strong>,<br/>    extras: {<br/>        loading: boolean,<br/>    }<br/>}</span><span id="5d0b" class="ml lp iq my b gy ng nd l ne nf">export interface <strong class="my ir">IAuthenticationState</strong> {<br/>    token: string,<br/>    expires: number<br/>    user?: {<br/>        name: string,<br/>        email: string,<br/>    }<br/>}</span></pre><p id="9853" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">身份验证密钥包含用于对我们感兴趣的某种服务进行身份验证的凭证。在持久化我们的状态时，我们将尽量不在本地持久化用户的个人信息，而是在每次状态恢复时获取它。额外的内容只包含不稳定和不相关的信息，我们不想保留这些信息。</p><h1 id="32be" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">持久性还原剂</h1><p id="ccee" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">要将您的状态保存到本地存储器，您必须通过“<em class="nh"> persistReducer </em>”功能运行您的Reducer。除了缩减器本身之外，它只需要一个参数，即定义您希望如何持久化状态以及持久化状态的哪些部分的配置参数。我们的看起来会像这样:</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="25b7" class="ml lp iq my b gy nc nd l ne nf">import <strong class="my ir"><em class="nh">storage </em></strong>from "redux-persist/lib/storage";</span><span id="bcd3" class="ml lp iq my b gy ng nd l ne nf">export const config = {<br/>    <strong class="my ir">key</strong>: 'root',<br/>    <strong class="my ir">storage</strong>: storage,<br/>    <strong class="my ir">blacklist</strong>: ['extras'],<br/>    <strong class="my ir">transforms</strong>: [<em class="nh">TransformCredentials</em>]<br/>};</span></pre><ul class=""><li id="5bb7" class="ni nj iq kt b ku kv kx ky la nk le nl li nm lm nn no np nq bi translated"><strong class="kt ir"> key </strong>:你的状态应该持久化的顶层key。在这种情况下，“根”意味着整个状态被持久化。</li><li id="cbce" class="ni nj iq kt b ku nr kx ns la nt le nu li nv lm nn no np nq bi translated"><strong class="kt ir">存储</strong>:表示使用什么样的存储，有很多选项可供选择，你可以在这里查看<a class="ae ln" href="https://github.com/rt2zz/redux-persist" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="e453" class="ni nj iq kt b ku nr kx ns la nt le nu li nv lm nn no np nq bi translated"><strong class="kt ir">黑名单</strong>:你可以选择跳过你所在州的子树，只需将它们的键添加到黑名单中。在这种情况下，我们选择不存储我们的extras，这意味着它们的初始状态将总是重新开始。白名单功能也是可用的，请务必查看他们的文档。</li><li id="3e70" class="ni nj iq kt b ku nr kx ns la nt le nu li nv lm nn no np nq bi translated"><strong class="kt ir">转换</strong>:您可以将转换函数应用于入站和出站状态，这对于持久化通常不可JSON序列化的类型特别有用。</li></ul><p id="8f90" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们还使用了一个<em class="nh"> TransformCredentials </em>函数来隐藏本地存储中的用户信息，并在每次状态恢复时获取这些信息。使用一对修改给定键的入站和出站状态的函数来创建转换。</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="ab1e" class="ml lp iq my b gy nc nd l ne nf">import {<strong class="my ir">createTransform</strong>} from "redux-persist";</span><span id="d586" class="ml lp iq my b gy ng nd l ne nf">export const <em class="nh">TransformCredentials</em> = <strong class="my ir">createTransform</strong>(<br/>    (<strong class="my ir">inboundState</strong>: IAuthenticationState, key): any =&gt; {<br/>        return {<br/>            ...inboundState,<br/>            user: undefined,<br/>        };<br/>    },<br/>    (<strong class="my ir">outboundState</strong>: any, key) =&gt; {<br/>        return {<br/>            ...outboundState,<br/>            user: fetchUser(outboundState.token)<br/>        };<br/>    },<br/>    {<br/>        <strong class="my ir">whitelist</strong>: ['authentication']<br/>    }<br/>);</span><span id="48b5" class="ml lp iq my b gy ng nd l ne nf">const fetchUser = (token : string) =&gt; {<br/>    // Fetch the user data from some service<br/>    // ...<br/>    return user;<br/>}</span></pre><ul class=""><li id="18e9" class="ni nj iq kt b ku kv kx ky la nk le nl li nm lm nn no np nq bi translated"><strong class="kt ir"> inboundState </strong>:持久化时应用于状态的函数。</li><li id="87ff" class="ni nj iq kt b ku nr kx ns la nt le nu li nv lm nn no np nq bi translated"><strong class="kt ir"> outboundState </strong>:应用于任何对象的函数，当它在返回到你的状态对象的过程中被持久化。</li><li id="ead6" class="ni nj iq kt b ku nr kx ns la nt le nu li nv lm nn no np nq bi translated"><strong class="kt ir">白名单</strong>:应该应用转换的键</li><li id="0776" class="ni nj iq kt b ku nr kx ns la nt le nu li nv lm nn no np nq bi translated"><strong class="kt ir"> createTransform </strong>:用于将转换函数放在一起的函数</li></ul><p id="6e81" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在配置已经就绪，您可以持久化您的应用程序的根缩减器，并使用它的持久化版本创建您的存储:</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="5892" class="ml lp iq my b gy nc nd l ne nf">import {<strong class="my ir">persistReducer</strong>} from "redux-persist";</span><span id="b071" class="ml lp iq my b gy ng nd l ne nf">const rootReducer = combineReducers&lt;IAppState&gt;({<br/>    authentication: myAuthenticationReducer,<br/>    extras: myExtrasReducer<br/>});</span><span id="d2d0" class="ml lp iq my b gy ng nd l ne nf">const persisted = <strong class="my ir">persistReducer</strong>(rootConfig, rootReducer);</span><span id="0b6f" class="ml lp iq my b gy ng nd l ne nf">const<strong class="my ir"> </strong><em class="nh">store = createStore</em>(persisted);</span></pre><h1 id="1ae9" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">持久存储</h1><p id="c1ee" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">既然已经正确配置了持久化缩减器，那么是时候持久化我们刚刚创建的存储了。简单到将它传递给一个“<em class="nh"> persistStore </em>”函数，并将其作为道具提供给一个PersistGate组件，您可以从redux-persist包中使用它。</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="77ed" class="ml lp iq my b gy nc nd l ne nf">import {PersistGate} from "redux-persist/integration/react";<br/>import {persistStore} from "redux-persist";</span><span id="65f2" class="ml lp iq my b gy ng nd l ne nf">//...</span><span id="53af" class="ml lp iq my b gy ng nd l ne nf">const persistor = <strong class="my ir">persistStore</strong>(store);<br/><br/>ReactDOM.<strong class="my ir"><em class="nh">render</em></strong>(<br/>    &lt;React.StrictMode&gt;<br/>        &lt;Provider store={store}&gt;<br/>            &lt;PersistGate loading={null} persistor={persistor}&gt;<br/>                ...<br/>            &lt;/PersistGate&gt;<br/>        &lt;/Provider&gt;<br/>    &lt;/React.StrictMode&gt;,<br/>    <strong class="my ir"><em class="nh">document</em></strong>.getElementById('root'));</span></pre><h1 id="31c2" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">全部完成！</h1><p id="b753" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">好了，现在<em class="nh"> PersistGate </em>中组件发生的所有状态变化都将根据我们提供的配置自动保存到本地存储中。</p><p id="3e89" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">还有许多其他的设置和方法可以定制和微调您的持久性行为。请务必查看完整的文档，看看哪一个更适合您的偏好和要求。</p><h2 id="5d20" class="ml lp iq bd lq mm mn dn lu mo mp dp ly la mq mr ma le ms mt mc li mu mv me mw bi translated">资源</h2><ul class=""><li id="1bc6" class="ni nj iq kt b ku mg kx mh la nw le nx li ny lm nn no np nq bi translated"><a class="ae ln" href="https://redux.js.org/introduction/getting-started" rel="noopener ugc nofollow" target="_blank"> Redux文档</a></li><li id="4e6d" class="ni nj iq kt b ku nr kx ns la nt le nu li nv lm nn no np nq bi translated"><a class="ae ln" href="https://github.com/rt2zz/redux-persist" rel="noopener ugc nofollow" target="_blank"> redux-persist存储库</a></li></ul></div></div>    
</body>
</html>