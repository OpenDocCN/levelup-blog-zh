<html>
<head>
<title>Easy Serverless Deployment Of Your React App Using Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云运行轻松实现React应用的无服务器部署</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/easy-serverless-deployment-of-your-react-app-using-cloud-run-c26aa79af491?source=collection_archive---------5-----------------------#2021-01-26">https://levelup.gitconnected.com/easy-serverless-deployment-of-your-react-app-using-cloud-run-c26aa79af491?source=collection_archive---------5-----------------------#2021-01-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="ab3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用GCP云运行将React应用作为Docker容器部署在无服务器环境中，并使其可在公共互联网上访问。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/8ad7de1cdaa7e70f892097dfa2bb55be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4a9Up0w84-Nfzszy"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">布雷特·乔丹在<a class="ae le" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="0dbb" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">要求</h1><p id="a011" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">开始之前，请确保您准备好以下零件:</p><ul class=""><li id="23c9" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">一个谷歌云平台帐户，为您的(演示)项目启用计费</li><li id="6860" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated"><a class="ae le" href="https://cloud.google.com/cloud-build" rel="noopener ugc nofollow" target="_blank">您的GCP项目启用了云构建</a></li><li id="e75e" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">在您的GCP项目上启用了云运行</li><li id="0b62" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated"><a class="ae le" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank"> GCloud SDK </a>安装在您的本地机器上</li></ul><p id="67f3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除了GCP的这些要求，我们当然还需要一个我们想要托管的容器化的React应用程序。如果你还没有，请参考我的另一篇文章【React Docker图片的简单优化。降到22MB！我将向您展示如何用一行代码创建一个运行中的React应用程序，并提供一些优化的docker文件来将其打包。</p><p id="228b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于本文的下一部分，我假设您已经阅读了我的另一篇文章，因为我不会重复那里已经描述过的部分。</p><h1 id="c5c8" class="lm ln it bd lo lp nd lr ls lt ne lv lw lx nf lz ma mb ng md me mf nh mh mi mj bi translated">本文的预期结果</h1><p id="7aa6" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">完成本文中定义的步骤后，我们将有一个简单且可重复的流程，如何在无服务器环境中构建和部署容器化的React应用程序，并公开发布，如下图所示:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ni"><img src="../Images/224e77497f5dbed66615640e67b98be9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-QfXaeaJVDC9BJVcZp6WRg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">React应用程序在云上运行并公开发布</figcaption></figure><h1 id="b411" class="lm ln it bd lo lp nd lr ls lt ne lv lw lx nf lz ma mb ng md me mf nh mh mi mj bi translated">代码</h1><p id="85e1" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">我准备了一个小的GitHub资源库，您可以将其用作参考，或者直接用来开始使用您的新应用程序。</p><div class="nj nk gp gr nl nm"><a href="https://github.com/Abszissex/medium-react-cloud-run" rel="noopener  ugc nofollow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd iu gy z fp nr fr fs ns fu fw is bi translated">abszisex/中反应云运行</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">安装用于CLI的GCloud SDK需要启用云构建需要启用云运行需要运行所有命令…</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">github.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa ky nm"/></div></div></a></div><h2 id="ae6f" class="ob ln it bd lo oc od dn ls oe of dp lw kb og oh ma kf oi oj me kj ok ol mi om bi translated">准备React应用程序和Docker配置</h2><p id="9e62" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">请参考我的另一篇文章<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/easy-optimization-of-your-react-docker-image-down-to-22mb-9d9e3a06870">轻松优化你的React Docker图片。降到22MB！</a>用于新React应用程序的初始设置和容器化。</p><h2 id="a09c" class="ob ln it bd lo oc od dn ls oe of dp lw kb og oh ma kf oi oj me kj ok ol mi om bi translated">云运行—容器运行时契约</h2><p id="6a2e" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">如果我们简单地将我们的代码和现有的docker文件一起部署到云上运行，这是行不通的，因为有一个特定的<a class="ae le" href="https://cloud.google.com/run/docs/reference/container-contract" rel="noopener ugc nofollow" target="_blank">容器运行时契约</a>必须完成。但我们将确保在接下来的几个步骤中履行这份合同！</p><h2 id="c63f" class="ob ln it bd lo oc od dn ls oe of dp lw kb og oh ma kf oi oj me kj ok ol mi om bi translated">准备NGINX和Dockerfile文件</h2><p id="becf" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">首先，我们创建一个新的<code class="fe on oo op oq b">nginx.conf</code>来配置NGINX服务器，它运行在Docker容器中，为React应用程序提供服务。这里重要的部分是<code class="fe on oo op oq b">$PORT</code>变量，因为<code class="fe on oo op oq b">$PORT</code>变量是Google自动添加到运行容器中的<a class="ae le" href="https://cloud.google.com/run/docs/reference/container-contract#env-vars" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="or os l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">nginx.conf</figcaption></figure><p id="cab3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">其次，我们必须相应地修改docker文件。这里的“新”线是#25和#37到#42。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="or os l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Dockerfile文件</figcaption></figure><p id="9339" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在第25行，我们仅使用<code class="fe on oo op oq b">COPY</code>命令将我们的<code class="fe on oo op oq b">nginx.conf</code>文件复制到NGINX的配置文件夹中，并将其重命名为<code class="fe on oo op oq b">configfile.template</code>，以暗示它是一个可以接收变量的模板。</p><p id="3643" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，在第37行，我们定义了环境变量，这些变量可以在启动容器时设置。</p><ul class=""><li id="0e92" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated"><code class="fe on oo op oq b">PORT</code> —容器运行的端口，默认为<code class="fe on oo op oq b">8080</code></li><li id="b256" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated"><code class="fe on oo op oq b">HOST</code> —容器运行的主机地址，默认为<code class="fe on oo op oq b">0.0.0.0</code>。默认值非常重要，因为<a class="ae le" href="https://cloud.google.com/run/docs/reference/container-contract#port" rel="noopener ugc nofollow" target="_blank">云运行要求主机地址为</a> <code class="fe on oo op oq b"><a class="ae le" href="https://cloud.google.com/run/docs/reference/container-contract#port" rel="noopener ugc nofollow" target="_blank">0.0.0.0</a></code>。</li></ul><p id="3e8d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在第42行，我们最后告诉NGINX，环境变量<code class="fe on oo op oq b">$PORT</code>应该在我们的NGINX-template中替换，并且这个模板应该作为启动服务器时的默认配置。</p><h2 id="fdbb" class="ob ln it bd lo oc od dn ls oe of dp lw kb og oh ma kf oi oj me kj ok ol mi om bi translated">定义GCloud要忽略的文件</h2><p id="dbe4" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">接下来，我们<strong class="js iu">应该</strong>创建<code class="fe on oo op oq b">.gcloudignore</code>文件。即使不是强制性的，拥有一个也是很重要的。与<code class="fe on oo op oq b">.dockerignore</code>类似，它定义了当通过不同命令将文件上传到云时，GCloud应该忽略的文件。在我们的案例中，当我们通过云构建在云上构建Docker映像时，就会发生这种情况。</p><p id="82b6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们不定义它，我们会在每次构建/部署应用程序时将所有文件上传到云中。所以你可能会问自己:“我真的想把所有的<code class="fe on oo op oq b">node_modules</code>和一个填充的<code class="fe on oo op oq b">build</code>上传到我打算进行干净构建的云中吗？？?"。如果你能清楚地回答这个问题，你应该使用一个<code class="fe on oo op oq b">.gcloudignore</code>文件😉</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="or os l"/></div></figure><h2 id="8a90" class="ob ln it bd lo oc od dn ls oe of dp lw kb og oh ma kf oi oj me kj ok ol mi om bi translated">创建构建和部署脚本</h2><p id="cba4" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">最后但同样重要的是，现在是时候创建我们的脚本，使用云构建和云运行来构建和部署我们的应用程序了。作为一个小奖励，我还提供了一个用当前版本(例如<code class="fe on oo op oq b">0.1.0</code>)标记构建的Docker图像的例子，取自您的<code class="fe on oo op oq b">package.json</code>和<code class="fe on oo op oq b">latest</code>。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="or os l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">构建和部署对云运行做出反应的应用程序</figcaption></figure><p id="7a37" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们来看一下不同的脚本部分:</p><p id="1bf4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe on oo op oq b">VARIABLES</code></p><ul class=""><li id="a2a2" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">定义你所有的“硬”变量。</li><li id="106b" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">确保使用您的GCP项目中的正确项目ID</li></ul><p id="7f9c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe on oo op oq b">GENERATED VARIABLES</code></p><ul class=""><li id="a531" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">定义所有自动生成的变量。</li><li id="5683" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">使用<code class="fe on oo op oq b">yarn</code>环境和一些shell命令从<code class="fe on oo op oq b">package.json</code>文件中“神奇地”提取当前版本。</li><li id="4c41" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">为图像名称以及图像名称与当前和<code class="fe on oo op oq b">latest</code>版本的组合创建变量。</li></ul><p id="8fa5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe on oo op oq b">BUILD</code></p><ul class=""><li id="661c" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">将当前文件夹提交给运行Docker文件的云构建，以构建Docker映像。</li><li id="ae93" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">Docker图像被自动标记为在<code class="fe on oo op oq b">GENERATED VARIABLES</code>中构建的版本。</li></ul><p id="19c9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe on oo op oq b">TAGGING</code></p><ul class=""><li id="a7b0" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">标签<code class="fe on oo op oq b">latest</code>正被添加到Docker图像中，该图像具有在<code class="fe on oo op oq b">BUILD</code>中使用的标签。</li><li id="d90a" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated"><code class="fe on oo op oq b">--quiet</code> —禁用所有交互式提示，这在CI/CD管道上运行时尤其必要。</li></ul><p id="39e8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe on oo op oq b">DEPLOYMENT</code></p><ul class=""><li id="7fec" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">将刚刚构建的Docker映像部署为云运行服务</li><li id="d393" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated"><code class="fe on oo op oq b">--allow-unauthenticated</code> —允许任何人访问。这是绝对强制的，因为服务需要被公众访问，所以不允许需要授权。</li></ul><p id="fcb0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们运行这个shell脚本…</p><p id="377d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">脚本完成后，它会打印新的云运行服务的URL，React应用程序现在可以在该服务中访问:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ot"><img src="../Images/a6fe48f00453e75276a61b319742c0a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QFnC75LLzja0_tc_MQTbmw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">成功部署脚本的输出</figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ou"><img src="../Images/5819e062dc0a9691182f74979424a421.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kPb3ITC6CQugK6t7eUmsYg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">带有React应用程序Docker图像的Google容器注册表</figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ov"><img src="../Images/aea538121491a76b61caf5a808439f31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZvMGsyreq7r47gTAOdKpNA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">为React应用服务的云运行服务</figcaption></figure><h1 id="2c82" class="lm ln it bd lo lp nd lr ls lt ne lv lw lx nf lz ma mb ng md me mf nh mh mi mj bi translated">打扫</h1><p id="f9bf" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">教程讲完了，就该做一些清理工作了。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="or os l"/></div></figure><h1 id="63b5" class="lm ln it bd lo lp nd lr ls lt ne lv lw lx nf lz ma mb ng md me mf nh mh mi mj bi translated">结论</h1><p id="e048" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">我希望我能为你提供一个简单易懂的指南，告诉你如何构建React应用程序并将其部署到Google提供的无服务器云运行服务中。</p><p id="e598" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢您花时间阅读我的文章。</p><h2 id="a12f" class="ob ln it bd lo oc od dn ls oe of dp lw kb og oh ma kf oi oj me kj ok ol mi om bi translated">你想联系吗？</h2><p id="6350" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">如果你想联系我，请在LinkedIn上联系我。</p><p id="c598" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另外，可以随意查看<a class="ae le" href="https://medium.com/@mr-pascal/my-book-recommendations-4b9f73bf961b" rel="noopener">我的书籍推荐</a>📚。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><div class="kp kq kr ks gt nm"><a href="https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd iu gy z fp nr fr fs ns fu fw is bi translated">我的书籍推荐</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">在接下来的章节中，你可以找到我对所有日常生活话题的书籍推荐，它们对我帮助很大。</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="nv l"><div class="ow l nx ny nz nv oa ky nm"/></div></div></a></div><div class="nj nk gp gr nl nm"><a href="https://mr-pascal.medium.com/membership" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd iu gy z fp nr fr fs ns fu fw is bi translated">通过我的推荐链接加入Medium—Pascal Zwikirsch</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="nv l"><div class="ox l nx ny nz nv oa ky nm"/></div></div></a></div></div></div>    
</body>
</html>