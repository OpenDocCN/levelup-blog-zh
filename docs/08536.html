<html>
<head>
<title>Managing OS users with Ansible across multiple environments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ansible跨多个环境管理操作系统用户</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/managing-os-users-with-ansible-across-multiple-environments-377c1ef2a1e0?source=collection_archive---------1-----------------------#2021-05-10">https://levelup.gitconnected.com/managing-os-users-with-ansible-across-multiple-environments-377c1ef2a1e0?source=collection_archive---------1-----------------------#2021-05-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2f270e1061d9ccad53ece1b62163b8f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P_mq5zGG07u-CP8RfCS7tA.png"/></div></div></figure><p id="0782" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">过去五年左右，我一直在使用Ansible管理操作系统用户。Ansible内置用户模块非常方便易用。Ansible Galaxy和Github上有许多现成的角色，功能几乎相同。但是Ansible本身意味着一种强制性的做事方式。创建一个用户是一件非常简单的事情，但是在拥有成百上千个服务器的多个环境中管理用户却是一件棘手的事情。也许使用像Puppet或Salt这样的工具来管理具有复杂层次结构的大型企业中的用户听起来是一个更好的主意。但也许这不是必要的，有一种方法可以让我们的角色适应大规模的环境。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h2 id="0e1d" class="ld le iq bd lf lg lh dn li lj lk dp ll kj lm ln lo kn lp lq lr kr ls lt lu lv bi translated">它是如何开始的</h2><p id="549e" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">先来温习一下如何在一个小的初创公司管理用户。我将试着解释一个与我工作过的任何公司都没有直接关系的假设案例。通常有一个包含几个组的用户列表，在非常常见的情况下，用户拥有完全的管理权限—admins；和具有基本系统访问权限的用户—开发人员。此外，提升的特权是通过sudoers管理的，但我还不想触及这个话题。</p><p id="b93c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">示例用户列表应该如下所示:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="7f28" class="ld le iq mh b gy ml mm l mn mo">users:<br/>  - name: 'John D'<br/>    username: 'john'<br/>    groups:<br/>      - 'admin'<br/>  - name: 'Jane D'<br/>    username: 'jane'<br/>    groups:<br/>      - 'developers'</span></pre><p id="62f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好的，我们有一个用户列表和一个包含十几台服务器的主机列表(清单),我们需要做的就是对照清单运行行动手册，就这样。我们不太关心安全性、可观测性等。简单。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="387a" class="ld le iq mh b gy ml mm l mn mo">ansible-playbook -i inventory playbooks/users.yml</span></pre><p id="3c8c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">日常运营流程看起来是这样的:<br/>添加新服务器—更新库存，运行剧本。<br/>添加新用户—更新group_vars/vars，运行剧本。<br/>删除用户账号—更新group_vars/vars，运行剧本。<br/>简单，不复杂，没有问题。</p><p id="5ca4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">随着公司的发展，我们有一堆环境/项目和一个额外的部门，如分析部门。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="664b" class="ld le iq mh b gy ml mm l mn mo">users:<br/>  - name: 'John D'<br/>    username: 'john'<br/>    groups:<br/>      - 'admin'<br/>  - name: 'Dave K'<br/>    username: 'dave'<br/>    groups:<br/>      - 'admin'<br/>  - name: 'Bob O'<br/>    username: 'bob'<br/>    groups:<br/>      - 'admin'<br/>  - name: 'Jane D'<br/>    username: 'jane'<br/>    groups:<br/>      - 'developers'<br/>  - name: 'Mark S'<br/>    username: 'mark'<br/>    groups:<br/>      - 'developers'<br/>  - name: 'Sven J'<br/>    username: 'sven'<br/>    groups:<br/>      - 'developers'<br/>  - name: 'Alice C'<br/>    username: 'alice'<br/>    groups:<br/>      - 'analytics'</span></pre><p id="139b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们做几乎相同的事情:<br/>添加新服务器—更新库存，运行行动手册。<br/>添加新用户—更新group_vars/vars，说三个魔字，跑剧本，一个脏话，再跑剧本。像这样:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="6299" class="ld le iq mh b gy ml mm l mn mo">ansible-playbook -i hosts playbooks/users.yml -l dev -e '@dev.yaml'<br/>ansible-playbook -i hosts playbooks/users.yml -l analytics -e '@analytics.yaml'<br/>ansible-playbook -i hosts playbooks/users.yml -l prod</span></pre><p id="cf0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">删除用户帐户—更新group_vars/vars，…，再次运行行动手册。</p><p id="85fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从技术上讲，有很多方法可以完成这项任务。但无论如何，它将包括几个步骤，如管理用户列表，可能还有几个额外的列表。</p><p id="c5ab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">没有那么复杂，更多的步骤，没有问题，如果过程是有据可查的。</p><h2 id="5daf" class="ld le iq bd lf lg lh dn li lj lk dp ll kj lm ln lo kn lp lq lr kr ls lt lu lv bi translated">下一关</h2><p id="664f" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">在某个时间点，公司发展到一个新的水平，员工增加到十几个部门的一百多名工程师。现在是团队找出如何改进现有工具以满足增长预期或者决定采用一些众所周知的企业级软件的时候了。然而，仍然没有必要为所有用户提供对服务器的访问，所以列表仍然没有那么长，它是可审计的，坚持IaC范例是有意义的。</p><p id="4078" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在此阶段实现哪些目标是有意义的:</p><ul class=""><li id="cc29" class="mp mq iq ka b kb kc kf kg kj mr kn ms kr mt kv mu mv mw mx bi translated">保持简单、可维护——所有环境/站点等的共享用户列表；</li><li id="86d1" class="mp mq iq ka b kb my kf mz kj na kn nb kr nc kv mu mv mw mx bi translated">可视流程—针对所有服务器运行的一个作业，并显示其完成的时间和方式。</li></ul><p id="1be5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果团队想在不增加额外步骤的情况下以更具声明性的方式应用更改，那么区分在哪里创建用户以及如何创建用户是非常重要的。假设团队想要在所有机器上创建<strong class="ka ir">管理员</strong>用户，然后只在开发服务器上创建<strong class="ka ir">开发者</strong>账户，在数据服务器上创建<strong class="ka ir">分析</strong>账户，等等。这里可以为用户添加一个新参数— <strong class="ka ir"> target_hosts </strong>，它是用户所属的主机组的列表。</p><p id="a30e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看起来可能是这样的:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="51e7" class="ld le iq mh b gy ml mm l mn mo">users:<br/>  - name: 'John D'<br/>    username: 'john'<br/>    groups:<br/>      - 'admin'<br/>    # We do not declare target_hosts for admins because we want to have them on all hosts<br/>...<br/>  - name: 'Jane D'<br/>    username: 'jane'<br/>    groups:<br/>      - 'developers'<br/>    # We declaring target_hosts groups list which is an Ansible inventory hosts group where we adding the user<br/>    target_hosts:<br/>      - dev<br/>...<br/>  - name: 'Alice C'<br/>    username: 'alice'<br/>    groups:<br/>      - 'analytics'<br/>    target_hosts:<br/>      - data</span></pre><p id="a11b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样，看起来简单。但是如何实现呢？</p><p id="2e2b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">也许这不是显而易见的，但我们在这里需要做的是在一个剧本的任务集和一个特殊条件集之前增加一个额外的步骤。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="56c8" class="ld le iq mh b gy ml mm l mn mo">- name: "Determine target hosts"<br/>  set_fact:<br/>     do_run: True<br/>  with_subelements:<br/>    - "{{ users }}"<br/>    - target_hosts<br/>    - skip_missing: True<br/>  when:<br/>    - item.1 in group_names</span></pre><p id="4f77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我们迭代target_hosts列表，检查是否至少有一个组在<strong class="ka ir"> group_names </strong>中，该变量是一个包含当前主机所属组列表的可转换的特殊变量。如果条件为真，我们将事实(var) <strong class="ka ir"> do_run </strong>设置为<em class="mb">真。</em></p><p id="b3f5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们在任务内部做额外的检查:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="a779" class="ld le iq mh b gy ml mm l mn mo">- name: "Manage user accounts"<br/>  user:<br/>    name: "{{ item.username }}"<br/>...<br/>    state: "{{ item.state }}"<br/>  loop: "{{ users }}"<br/>  when:<br/>    - users is iterable<br/>    - do_run is defined or item.target_hosts is not defined</span></pre><p id="b71e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我们增加了一个额外的检查:在没有定义的<strong class="ka ir">上<strong class="ka ir"> do_run </strong>是否为真。我们没有为管理员定义<strong class="ka ir"> target_hosts </strong>来确保我们在所有机器上都有他们的帐户，当我们只需要在某一组机器上有这样的帐户时，我们为开发人员和其他帐户类型声明target_hosts。另外，请注意，<strong class="ka ir">状态</strong>参数是必需的，因为我们不想维护像<strong class="ka ir"> users_retired、</strong>这样的额外列表，我们只是显式声明状态<strong class="ka ir"> present </strong>或<strong class="ka ir">exist。</strong></strong></p><p id="a63b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，现在我们可以通过只运行一个自动作业来控制在一个列表中创建用户的位置。Target_host group可以是动态云清单中的一个<strong class="ka ir">标签</strong>，比如AWS/GCP/WhateverCloud、可用性区域、地区、项目。</p><p id="46bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">详情请查看我在Github上的<a class="ae nd" href="https://github.com/1it/ansible-role-users" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">用户</strong> </a>角色。希望能有用。感谢阅读！</p></div></div>    
</body>
</html>