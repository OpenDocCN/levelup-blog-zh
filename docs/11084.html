<html>
<head>
<title>Multi-Thread Your Winform UI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">多线程您的Winform用户界面</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/multi-thread-your-winform-ui-f43dccbf3476?source=collection_archive---------15-----------------------#2022-02-13">https://levelup.gitconnected.com/multi-thread-your-winform-ui-f43dccbf3476?source=collection_archive---------15-----------------------#2022-02-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="368b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我简直不敢相信多线程用户界面会如此简单，而且能如此可靠地完成。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/7c845d7773ed4385f1358979234a2dd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3bOvVZ_sdAeanNE41k1n_w.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">shutterstock/<a class="ae le" href="https://www.shutterstock.com/g/alphaspirit" rel="noopener ugc nofollow" target="_blank">alpha spirit . it</a></figcaption></figure><h2 id="83a8" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">为什么</h2><p id="d6f7" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">我的大部分日常工作都涉及到对我无法控制的桌面应用程序进行修改。这个应用程序允许开发者添加。dll插件，它可以通过它为集成提供的SDK工具读取；众所周知，它在大部分时间里都很缓慢、笨重，并且很难与人互动。据我所知，在整个过程中没有多线程或异步编程，所以当你执行一个任务时，UI是锁定的，直到任务完成。</p><p id="e89d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以使用SDK从外部访问许多功能。我们经常使用许多带有Windows任务调度程序的控制台应用程序，但我也创建了一些利用它提供的API的web应用程序。它在一定程度上可以工作，但是API的功能有限。很多时候，需要深入SDK来完成一项任务。</p><p id="4d36" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我最近的一个自动化工具是一个插件，需要很长时间才能完成。这更适合作为一个独立的可执行文件，但我们暂时把它作为一个插件来测试。当这个执行开始时，UI被锁定—您无法停止它。因此，如果用户没有设置好某些东西，我们就会一直被卡住，直到它完成。退出这个应用程序的唯一方法是用任务管理器直接杀死这个任务。</p><h2 id="d90c" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">输入后台工作人员</h2><p id="f6e0" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">首先，我知道可能会使用其他多线程框架，但这是我用最多的支持和最少的理解开销最快建立并运行的一个。首先，我将向您展示一个非常一般化的没有那个工人的代码段，以及我是如何修复它的。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="bb0e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的代码是由UI触发的，所以它和UI在同一个线程上。当单击下载按钮时，UI被锁定，直到该过程完成。让它进入另一个线程的方法是使用后台工作器。创建一个就像在类体中设置一个私有字段并在构造函数中构建它一样简单。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="cd40" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成后，您可以向其中添加事件处理程序。这三个大问题是:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="bcf9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦有了这些事件处理程序，就可以将长期运行的代码移到Do Work事件处理程序中。您可以通过运行以下命令来执行该事件。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="f32f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你有一个用户界面，你会很快发现你可以移动界面并与之互动，甚至在它施展魔法的时候。这是另外两个很棒的部分。</p><h2 id="dc82" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">取消的能力</h2><p id="a5f1" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">现在你可以有一个取消按钮，每当按下它就取消任务。在“取消”按钮的事件处理程序中，输入以下代码:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="e619" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦就位，就在长期运行的代码中定期检查事件。理想的位置是for循环。在我的例子中，我将<code class="fe mf mg mh mi b">DoWorkEventArgs </code>对象作为参数传递给我的长期运行代码进行更新。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="d6a7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，如果单击Cancel按钮，代码会在下一个项目循环完成后立即检查取消是否挂起。如果是，它会中断循环并退出。</p><h2 id="0aa8" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">报告经过</h2><p id="803d" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">另一个很棒的特性是能够将数据发送回UI线程。现在，记住，那个线程现在不做任何事情，所以它可以相对快速地实时更新标签之类的东西。</p><p id="f24e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">报告进度方法有两个参数。第一个是百分比(你可以创造性地计算或简单地猜测)。我个人很少用百分比参数。第二个参数是一个名为<code class="fe mf mg mh mi b">UserState</code>的通用对象属性。这是你可以获得高度创造力的地方。通过能够传入对象，您可以传入类似自定义类的东西，该类接受消息的标签和字符串。然后，您可以用任何您喜欢的消息实时更新标签。</p><pre class="kp kq kr ks gt mj mi mk ml aw mm bi"><span id="49e7" class="lf lg it mi b gy mn mo l mp mq">_backgroundWorker.ReportProgress(5, $"{item} is done");</span></pre><p id="9264" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在上面的例子中，我只是传入了一个字符串。你可以创建一个对象，然后传入它。可以传入字典值、元组等等。您在<code class="fe mf mg mh mi b">ProgressChanged</code>事件处理程序中处理信息。在该处理程序中，您可以实时更新UI。例如:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="md me l"/></div></figure><h2 id="0dec" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">工作已经结束</h2><p id="9f35" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">当后台工作程序完成时，最后一个事件处理程序处理该事件。这基本上就像是“终于”到了一个<code class="fe mf mg mh mi b">Try-Catch</code>的阻碍。如果你取消一个活动，你可以在这里处理。您还可以添加自定义信息供用户查看(例如，作业结果)。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="md me l"/></div></figure><h2 id="f21f" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">这是如何改变游戏规则的？</h2><p id="5086" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">首先，我必须在事件被触发之前进入一个顺序。然后，大多数时候，我需要做的定制工作发生在订单退出时。我现在可以获得我需要的数据，并在订单关闭后在后台打开订单来执行工作，甚至显示一个对话框，用户可以移动到显示状态的一侧。此时，用户可以打开下面的订单，执行更新，然后以同样的方式退出，显示另一个对话框的信息，而不会妨碍用户。</p><p id="45f5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我已经找到了与主表单的UI事件处理程序进行交互的方法，如果后台工作人员仍在使用<code class="fe mf mg mh mi b">_backgroundWorker.IsBusy</code>属性运行，就可以防止用户关闭桌面应用程序。你可以弹出一条消息来警告用户关闭主应用程序会终止该进程。如果出了问题，这很方便，但不是完全万无一失。</p><h2 id="bdbb" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">不是最好的，但仍然很棒</h2><p id="1b2f" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">和我一起工作的大多数开发人员都没有尝试在桌面客户机上使用这种方法，因为老实说，他们从来没有想过这是可能的。然而，到目前为止，它的工作没有失败。当然有更好的技术可以用来编写这个旧的桌面应用程序，但这不是我能在我工作的地方处理的工作。相反，我们提供定制的解决方案来自动化it的大部分工作。我们不能使用最新的UI工具，但我们可以用一些可用的工具给它注入活力，但最初从未集成。有时候，你必须有创造性才能得到好的结果。</p></div></div>    
</body>
</html>