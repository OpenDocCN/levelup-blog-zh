<html>
<head>
<title>IKS Deployment Patterns #2: Multi-Zone Cluster, App exposed via ALB / Ingress Controller</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">IKS部署模式#2:多区域集群，通过ALB /入口控制器公开应用</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/iks-deployment-patterns-2-multi-zone-cluster-app-exposed-via-alb-ingress-controller-415908418abd?source=collection_archive---------3-----------------------#2018-10-16">https://levelup.gitconnected.com/iks-deployment-patterns-2-multi-zone-cluster-app-exposed-via-alb-ingress-controller-415908418abd?source=collection_archive---------3-----------------------#2018-10-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9909" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我应该如何使用IBM Cloud Kubernetes Service(IKS)ALB在集群中部署我的应用程序？<br/>如何保存通过ALB连接的客户端的源IP地址？</p><h1 id="1619" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">示例部署模式</h1><p id="4417" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在本文中，我们将按照下面的部署模式来完成部署示例应用程序的步骤:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/2e0d37ad4b2d4636bdbcc85fe8a4182f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7jBcmoofF8tmFZInXWsJDQ.png"/></div></div></figure><h1 id="b3bc" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步伐</h1><ol class=""><li id="6e39" class="ma mb iq jp b jq lj ju lk jy mc kc md kg me kk mf mg mh mi bi translated"><a class="ae mj" href="https://console.bluemix.net/registration/premium?" rel="noopener ugc nofollow" target="_blank">注册</a>并使用<a class="ae mj" href="https://console.bluemix.net/" rel="noopener ugc nofollow" target="_blank"> IBM云控制台</a>创建一个<strong class="jp ir">多区域</strong> IKS集群。关于<a class="ae mj" href="https://console.bluemix.net/docs/containers/cs_clusters.html#clusters" rel="noopener ugc nofollow" target="_blank">部署集群</a>以及<a class="ae mj" href="https://console.bluemix.net/docs/containers/cs_clusters_planning.html#multizone" rel="noopener ugc nofollow" target="_blank">多区域集群如何工作</a>的文档。<em class="mk">重要提示:您必须使用付费等级才能使用ALBs。</em></li><li id="4842" class="ma mb iq jp b jq ml ju mm jy mn kc mo kg mp kk mf mg mh mi bi translated">检查是否一切正常，白蛋白是否正常。<a class="ae mj" href="https://medium.com/@ArpadKun/ibm-cloud-kubernetes-service-ingress-alb-cheat-sheet-1-basics-4fbc1c86b886" rel="noopener"> IKS入口/ALB备忘单</a>上的有用命令。</li><li id="0791" class="ma mb iq jp b jq ml ju mm jy mn kc mo kg mp kk mf mg mh mi bi translated">下载、编辑并应用以下<a class="ae mj" href="https://github.com/IBM-Cloud/kube-samples/blob/master/loadbalancer-alb/iks_single_or_multi-zone_cluster_app_via_ALB.yaml" rel="noopener ugc nofollow" target="_blank">示例部署和入口资源yaml </a>，这将通过端口<code class="fe mq mr ms mt b">80(http)</code>和<code class="fe mq mr ms mt b">443(https).</code> <br/> <code class="fe mq mr ms mt b">$ kubectl apply -f <a class="ae mj" href="https://raw.githubusercontent.com/IBM-Cloud/kube-samples/master/loadbalancer-alb/iks_single_or_multi-zone_cluster_app_via_ALB.yaml" rel="noopener ugc nofollow" target="_blank">iks_single_or_multi-zone_cluster_app_via_ALB.yaml</a></code>上的ALB / Ingress控制器公开<code class="fe mq mr ms mt b">echoserver</code>应用程序注意:不要忘记编辑<code class="fe mq mr ms mt b">Host</code>和<code class="fe mq mr ms mt b">secretName</code>部分。</li><li id="b60a" class="ma mb iq jp b jq ml ju mm jy mn kc mo kg mp kk mf mg mh mi bi translated">测试加载您在浏览器中指定的主机或启动<code class="fe mq mr ms mt b">curl</code>命令(像我的例子):<br/> <code class="fe mq mr ms mt b">$ curl https://echoserver.arpad-ipvs-test-aug14.us-south.containers.appdomain.cloud/</code></li><li id="4382" class="ma mb iq jp b jq ml ju mm jy mn kc mo kg mp kk mf mg mh mi bi translated">您将看到如下所示的响应</li></ol><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mu"><img src="../Images/794bcffb3f43d084bbe99f9e301d08df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LgX_5YRbCZofDDOWgMLg3g.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">对通过IKS ALB传送的成功卷曲的响应</figcaption></figure><p id="dd13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，在<code class="fe mq mr ms mt b">x-forwarded-for</code>和<code class="fe mq mr ms mt b"> x-real-ip</code>头中，您可以看到worker节点的IP地址。这是因为<code class="fe mq mr ms mt b">kube-proxy</code>正在Kubernetes集群内进行源NAT，并屏蔽了客户端的原始源IP。</p><p id="3d2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想启用源IP保护，你必须<code class="fe mq mr ms mt b">patch</code>IKS ALB(你可以在这里找到<a class="ae mj" href="https://console.bluemix.net/docs/containers/cs_ingress.html#preserve_source_ip" rel="noopener ugc nofollow" target="_blank">关于这个步骤的更多文档)。要为群集中的所有公共ALB设置源IP保留，请运行以下命令:</a></p><p id="361f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">$ kubectl get svc -n kube-system |grep alb | awk '{print $1}' |grep "^public" |while read alb; do kubectl patch svc $alb -n kube-system -p '{"spec": {"externalTrafficPolicy":"Local"}}'; done</code></p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mz"><img src="../Images/be89e609cebcdfe32c8afa077a0923e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_jmj89UB3TuFpaYFZHQ4TQ.png"/></div></div></figure><p id="cc1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用补丁后，您将看到客户端的原始源IP地址显示在<code class="fe mq mr ms mt b">x-forwarded-for</code>和<code class="fe mq mr ms mt b">x-real-ip</code>标题中:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi na"><img src="../Images/19628235587fcb11d67f5612bf1abb74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vVc1UM0OL_Z92HZqGsyepg.png"/></div></div></figure><h1 id="9851" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">摘要</h1><p id="34e9" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">随着您对工作负载的了解越来越多，您可以根据需要调整甚至切换模式。不同的应用需要不同的模式；请让我们帮助你的模式！要阅读其他模式，请点击链接到IBM Cloud博客(T10)或Medium.com(T12)上的链接。</p><h1 id="250d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">联系我们</h1><p id="76d1" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">如果您有任何问题，请在此注册<a class="ae mj" href="https://bxcs-slack-invite.mybluemix.net/" rel="noopener ugc nofollow" target="_blank">通过Slack加入我们的团队，并在我们的公共IBM Cloud Kubernetes服务Slack上的#general channel </a>中加入讨论。</p></div></div>    
</body>
</html>