<html>
<head>
<title>How To Combine Window Functions in MySQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在MySQL中组合窗口函数</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-combine-window-functions-in-mysql-c4efa608b282?source=collection_archive---------12-----------------------#2022-10-12">https://levelup.gitconnected.com/how-to-combine-window-functions-in-mysql-c4efa608b282?source=collection_archive---------12-----------------------#2022-10-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="8a0a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">窗口函数对多组行进行操作，为组中的每一行返回一个值，这与聚合函数不同，聚合函数将行折叠成一个值。有了这么多不同的窗口功能，你能在同一层次上组合它们吗？在这篇文章中了解更多。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/eb64c0c0c5160471e0eeb81f02a9ae17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/0*qEVJvS714k8B70fn.png"/></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">图片来自<a class="ae la" href="https://pixabay.com//?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=304970" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae la" href="https://pixabay.com/users/clker-free-vector-images-3736/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=304970" rel="noopener ugc nofollow" target="_blank"> Clker-Free-Vector-Images </a></figcaption></figure><h2 id="ce63" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">背景故事和推理</h2><p id="dfae" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">我最近使用Oracle Spatial函数处理了一些查询，以构建地理空间线字符串。作为其中一个函数参数的一部分，我需要在每个坐标间隔从线串上的起始位置(一个坐标)开始计算跑步距离。</p><p id="64fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这听起来像是<em class="lz"> cut-n-dry </em>使用<code class="fe ma mb mc md b">SUM()</code>和<code class="fe ma mb mc md b">OVER()</code>进行滚动求和的用例。你说得对，的确如此。</p><p id="3b5d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">差不多</strong>。</p><h2 id="9b18" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">抽样资料</h2><p id="3f3a" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">为了简单起见，我将放弃在示例中使用任何复杂的北距、东距或线性参考，而是为博客文章选择这个简单的数据集:</p><pre class="kp kq kr ks gt me md mf mg aw mh bi"><span id="b9f1" class="lb lc it md b gy mi mj l mk ml">SELECT * FROM coords_measure;</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/8d1641d22ef7c59f634e17839ab15e92.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/0*aU4Y4s5o4P0z9EXt"/></div></figure><p id="b321" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于我主要在我开发的大多数<a class="ae la" href="https://openlamptech.substack.com/p/openlamptech-report-what-is-the-lamp" rel="noopener ugc nofollow" target="_blank"> LAMP stack </a>应用程序中撰写和使用MySQL或MariaDB，所以我也将使用MySQL作为这些示例(尽管我需要的需求最初是在Oracle SQL中)。</p><p id="b041" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可能会注意到结果集的最后一行对于<code class="fe ma mb mc md b">start_segment</code>、<code class="fe ma mb mc md b">end_segment</code>和<code class="fe ma mb mc md b">segment_length</code>列有<code class="fe ma mb mc md b">NULL</code>值。</p><p id="c42d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是因为该位置是线串上最后一个点(坐标),且没有实际测量长度；基本上就是<em class="lz">‘死胡同’</em>。</p><h2 id="cb7d" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">用MySQL窗口函数滚动求和()</h2><p id="36bb" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">计算滚动和并不困难，因为从MySQL v8开始我们就有了窗口函数。</p><p id="8310" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如该查询所示，简单地将<code class="fe ma mb mc md b">SUM()</code>聚合函数与<code class="fe ma mb mc md b">OVER()</code>子句结合使用，并按照特定的顺序排列，就可以得到以下信息:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mn mo l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/eeb46d8eeff9a4faf751c93fc36b63d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:868/0*Yk_lhHIdb1eSgdWP"/></div></figure><p id="0f95" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虽然我们有一个滚动和计算，但在这种情况下是不正确的。您可以看到最后2行的滚动和值为195.83。</p><p id="cc83" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，对于这个特定的要求，我们真正需要的是最后一行<strong class="js iu"> <em class="lz">只有</em> </strong>有195.83用于滚动和计算，第一行有0。</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="95f1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<strong class="js iu"> <em class="lz"> OpenLampTech </em> </strong>时事通讯中<a class="ae la" href="https://ko-fi.com/s/7dfe9ce108" rel="noopener ugc nofollow" target="_blank">投放可负担得起的分类广告，让您的品牌、产品或服务得到应有的关注。谢谢大家的支持！</a></p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="6ab0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="lz">就好像我们需要将所有的滚动和值下移一行。</em> </strong></p><p id="a5ff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是为什么呢？</p><p id="a9c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于此地理空间要求，在每个坐标点，距离应从起点或起始坐标(第1行)开始计算。</p><p id="bd23" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，行1实际上应该具有测量距离0，因为它是线串的起点(并且没有距离值— <em class="lz">它是起点</em>),而行2将具有在这两个坐标之间测量的距离值，因为这是回到起点(坐标1)的距离。</p><h2 id="91a9" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">MySQL LAG()窗口函数</h2><p id="7552" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated"><code class="fe ma mb mc md b">LAG()</code>窗口功能允许您从当前操作行访问位于结果集之前行的数据。根据<code class="fe ma mb mc md b">LAG()</code>函数调用中提供的第二个参数，您可以访问1行(默认)或更多行。</p><p id="bc68" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我将在查询中使用<code class="fe ma mb mc md b">LAG()</code>,并返回前面每一行的segment_length值:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mn mo l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/9a4afa71d0ee6c756a3c8614b611f4c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:818/0*Klh2daEua3a0xSV-"/></div></figure><p id="2a37" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如查询结果所示，在没有前几行值的情况下，<code class="fe ma mb mc md b">LAG()</code>返回<code class="fe ma mb mc md b">NULL</code>。</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="cf6a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据我的经验，你需要一个<strong class="js iu"> <em class="lz">有意义的指标</em> </strong>，你可以在<code class="fe ma mb mc md b">LAG()</code>的<code class="fe ma mb mc md b">ORDER BY</code>子句中使用它，如果你依赖于一个特定的订单，它会按照你的期望为你工作。</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="dd5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们简单地执行滚动求和，对吗？</p><p id="55a6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">能不能把2个窗口函数合并在同一个级别？</strong></p><p id="d194" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">号码</p><p id="29bd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">执行该查询会返回一个特定的错误，指示此处不允许使用<code class="fe ma mb mc md b">LAG()</code>:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mn mo l"/></div></figure><h2 id="8a11" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">MySQL派生表</h2><p id="166b" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">在MySQL中，在<code class="fe ma mb mc md b">FROM</code>子句中生成表的<code class="fe ma mb mc md b">SELECT</code>查询被称为<a class="ae la" href="https://dev.mysql.com/doc/refman/8.0/en/derived-tables.html" rel="noopener ugc nofollow" target="_blank">派生表</a>。</p><p id="da54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了计算<code class="fe ma mb mc md b">LAG()</code>函数输出的滚动和，我们应该使用派生表将生成的查询放在<code class="fe ma mb mc md b">FROM</code>子句中:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mn mo l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi my"><img src="../Images/01ff81b0aa0154d8674393ca121337c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:828/0*ihwDFHZBdQSU0utd"/></div></figure></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="0d24" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">提示:MySQL派生表应该有别名。然而，<code class="fe ma mb mc md b">AS</code>关键字是可选的。</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="0a49" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">作为一个好的实践，我们应该考虑到在<code class="fe ma mb mc md b">LAG()</code>窗口函数调用中的<code class="fe ma mb mc md b">NULL</code>，以便在执行计算时，我们在<code class="fe ma mb mc md b">SUM() OVER()</code>中的数学是正确的或更安全的。MySQL中的一个简单方法是使用<code class="fe ma mb mc md b">IFNULL()</code>函数。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mn mo l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/130ce18f246f2607a25de7be9e8e619e.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/0*hxhSTYNdDM24yoep"/></div></figure><p id="ba36" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，如查询结果所示，我们有了正确的距离度量，即每个坐标间隔的滚动和。</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="3d38" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">推荐阅读:</strong> <a class="ae la" href="https://openlamptech.substack.com/p/5-sql-books-that-will-make-you-a" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> 5本会让你成为Pro </strong> </a>的SQL书籍。</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="69d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">老实说，绝对可能有其他方法来检索这些查询结果，但这种方法对我来说很适用。在处理这个特定的查询时，我学到了很多关于<code class="fe ma mb mc md b">LAG()</code>和用窗口函数进行滚动求和计算的知识，我希望你也学到了。</p><p id="22c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢你阅读这篇文章。请与同样喜欢它的人分享。</p><p id="1fe9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae la" href="https://ko-fi.com/joshlovescoffee" rel="noopener ugc nofollow" target="_blank">T12】咖啡是我最喜欢的饮料！！！ </a></p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="a3aa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae la" href="https://joshuaotwell.com/about/" rel="noopener ugc nofollow" target="_blank"> Josh Otwell </a>热衷于成为PHP开发人员、SQL专家和技术博客/作家。</p><p id="3d2c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">免责声明:本文中的大多数示例都是在个人发展/学习工作站环境中执行的，<strong class="js iu"> <em class="lz">不应被视为生产质量或就绪</em> </strong>。您的特定目标和需求可能会有所不同。像往常一样，<strong class="js iu">你能做某事并不意味着你应该做。我的观点是我自己的。</strong></p><p id="6c14" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="lz">我能帮助的更多方面</em> </strong></p><ul class=""><li id="a46c" class="na nb it js b jt ju jx jy kb nc kf nd kj ne kn nf ng nh ni bi translated">开博客？我用WordPress写了数字猫头鹰的散文博客。让我们都在提供的计划上省钱。</li><li id="2a01" class="na nb it js b jt nj jx nk kb nl kf nm kj nn kn nf ng nh ni bi translated">在<a class="ae la" href="http://openlamptech.substack.com/" rel="noopener ugc nofollow" target="_blank"><strong class="js iu"><em class="lz">OpenLampTech</em></strong>简讯</a>中投放价格合理的分类广告，让您的品牌、产品或服务得到应有的关注。</li><li id="c395" class="na nb it js b jt nj jx nk kb nl kf nm kj nn kn nf ng nh ni bi translated">需要托管你的下一个网络应用程序或WordPress网站吗？我强烈推荐<a class="ae la" href="https://www.hostg.xyz/aff_c?offer_id=6&amp;aff_id=94641" rel="noopener ugc nofollow" target="_blank"> Hostinger </a>，用它们来托管<a class="ae la" href="http://louisianabassnation.com/" rel="noopener ugc nofollow" target="_blank">我的利基鲈鱼钓鱼网站</a>。该服务是首屈一指的，他们提供免费的SSL。</li><li id="fcbe" class="na nb it js b jt nj jx nk kb nl kf nm kj nn kn nf ng nh ni bi translated"><a class="ae la" href="https://ko-fi.com/post/5-Truths-Ive-Come-To-Realize-As-a-Self-taught-Dev-R5R2BL9J6" rel="noopener ugc nofollow" target="_blank">作为一名自学成才的开发人员，我意识到的5个事实</a></li></ul><p id="1511" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="lz">披露</em> </strong>:本帖中的部分服务和产品链接为附属链接。在没有额外费用给你，你应该通过点击其中一个购买，我会收到佣金。</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="8f79" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当你<a class="ae la" href="http://openlamptech.substack.com" rel="noopener ugc nofollow" target="_blank">订阅<strong class="js iu"><em class="lz">【OpenLampTech】</em></strong>时事通讯</a>时，收到一本我的电子书<em class="lz">《给每个人的10个MySQL技巧】</em><strong class="js iu"><em class="lz">绝对免费</em> </strong>。</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="f512" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过在<strong class="js iu"> <em class="lz"> OpenLampTech </em> </strong>时事通讯中投放价格合理的分类广告，让您的品牌、产品或服务得到应有的关注<a class="ae la" href="https://ko-fi.com/s/7dfe9ce108" rel="noopener ugc nofollow" target="_blank">。谢谢大家的支持！</a></p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="e301" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lz">原载于2022年10月12日https://joshuaotwell.com</em><em class="lz"/><a class="ae la" href="https://joshuaotwell.com/how-to-combine-window-functions-in-mysql/" rel="noopener ugc nofollow" target="_blank"><em class="lz">。</em></a></p></div></div>    
</body>
</html>