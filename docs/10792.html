<html>
<head>
<title>All You Need to Know about Environment Variables in TypeScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于TypeScript中的环境变量，您只需要知道</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/all-you-need-to-know-about-environment-variables-in-typescript-2e7042edfac7?source=collection_archive---------0-----------------------#2022-01-12">https://levelup.gitconnected.com/all-you-need-to-know-about-environment-variables-in-typescript-2e7042edfac7?source=collection_archive---------0-----------------------#2022-01-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="cb5d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">环境变量是在软件项目中传递配置的一种便捷方式。我们能利用类型系统有效地使用这些变量吗？请阅读我的文章，了解这个问题的答案和更多！</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/394ece2ebc7bca26c5b6fe8106ebe8d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hue0ki46LheZNrTF"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">照片由<a class="ae le" href="https://unsplash.com/@mr_vero?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">欧文·史密斯</a>在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><h1 id="39d5" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">什么是环境变量？</h1><p id="d648" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">大多数开发人员考虑将环境变量<em class="mi">键值对</em>传递给特定的程序。</p><p id="3a72" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于每一对，键和值总是字符序列。或者你可以称之为字符串。在后端项目中，您将把这些对传递给服务器应用程序。</p><p id="167e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，对于前端项目来说，这并不是那么简单。当浏览器执行它们的代码时，它们不支持环境变量<em class="mi">本身</em>。开发人员通常利用额外的库(插件)来用预定义的常量替换这些变量的用法。通常，这种绑定发生在项目构建期间。</p><p id="5796" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用环境变量的原因是将配置与代码分开。现代产品使用<em class="mi">基础设施即代码</em>模型来管理基础设施，并将这些变量定义为所述模型的不可分割的元素。为什么它比将配置保存在项目的JSON文件中要好？</p><p id="b2dc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，JSON格式允许嵌套对象。我努力使配置尽可能简洁——我发现实际上不需要嵌套信息。其次，我不希望在项目存储库中明确保留凭证。最后，我希望可以自由地将什么配置传递给程序。</p><h1 id="d5c8" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">Node.js中的环境变量</h1><p id="2435" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">要在TypeScript Node.js项目中使用环境变量，我们需要添加<code class="fe mj mk ml mm b">@types/node</code>作为开发依赖项。您可以使用<code class="fe mj mk ml mm b">process.env</code>对象访问变量。这个对象是一个简单的字典，有字符串键和可选的字符串值。就类型而言，它使用了<code class="fe mj mk ml mm b">ProcessEnv</code>接口。</p><p id="1daf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">即使你可以扩展<code class="fe mj mk ml mm b">ProcessEnv</code>接口，我相信你不应该这样做。编译时类型的系统不可能预测运行时变量。我们有责任验证哪些键出现在运行时。</p><h1 id="e686" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">建筑模式</h1><p id="98fe" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">到目前为止，我在处理环境变量时观察到了两种架构模式:</p><ul class=""><li id="4e3b" class="mn mo it js b jt ju jx jy kb mp kf mq kj mr kn ms mt mu mv bi translated">在一个地方提取所有这些变量，</li><li id="5e4c" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated">需要时提取变量。</li></ul><p id="2d2c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将所有的环境变量放在一个文件中可以告诉我们需要将什么传递给可执行文件。它促进了依赖注入，因为我们需要将值显式地传输给需要它们的类和函数。有些人认为将环境变量从依赖代码中分离出来是一个很大的缺点——大多数开发人员不会测试提取功能。</p><p id="2148" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您在需要时检索环境变量时，它将本地代码与特定的变量绑定在一起。与前面的模式不同，它强制执行自顶向下的服务测试。为什么？如果不传递环境变量，就无法可靠地测试代码。</p><h1 id="8fd2" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">默认值</h1><p id="1d84" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">让我们假设你期望一个特定的变量出现。如果它不存在，你该怎么办？</p><p id="e8d0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我认为你应该突然停止这个项目。</p><p id="4c46" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据我的经验，默认值是开发中几乎所有罪恶的根源。如果你提供默认值，你对外界依赖什么信息？是<em class="mi">在意</em>还是<em class="mi">大意</em>的信息？</p><p id="09e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这意味着你不在乎提供的值，因为你可以在任何时候用别的东西来代替它。</p><p id="5606" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另外，我总是将配置从代码中分离出来。</p><p id="7c19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">确保环境变量保存有意义的值的一种优雅的方法是使用TypeScript断言，如下面的代码片段所示。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">断言不可空变量的代码段。</figcaption></figure><p id="f518" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们也可以使用提取函数，如下所示。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">从特定的环境变量中提取字符串值。</figcaption></figure><p id="e2a9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你也可以访问这个<a class="ae le" href="https://github.com/grzpab/ts-envvar" rel="noopener ugc nofollow" target="_blank">链接</a>来访问上面定义的作为我的库的一部分的函数。</p><h1 id="a146" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">数值</h1><p id="4227" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">因为环境变量包含字符序列，所以我们不能显式地使用数值。我们必须将数字编码为字符串，将它们传递给可执行文件，然后在我们的应用程序中对它们进行解码。</p><p id="f1fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以解码实数或整数。在我的记忆中，我从来不需要使用实数。请注意，虽然这样的选择仍然可用。</p><p id="8c6f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以下代码片段显示了如何实现从特定环境变量中提取数值。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">从特定的环境变量中提取一个数值。</figcaption></figure><p id="e564" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你也可以访问这个<a class="ae le" href="https://github.com/grzpab/ts-envvar" rel="noopener ugc nofollow" target="_blank">链接</a>来访问上面定义的作为我的库的一部分的函数。</p><h1 id="8b8d" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">布尔值</h1><p id="232e" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">同样，由于环境变量保存字符串，我们不能使用布尔值。我们能做的是在两个场景中选择:</p><ul class=""><li id="f693" class="mn mo it js b jt ju jx jy kb mp kf mq kj mr kn ms mt mu mv bi translated">运行时将<code class="fe mj mk ml mm b">true</code>和<code class="fe mj mk ml mm b">false</code>字符串映射成布尔值，</li><li id="6f2c" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated">在运行时将<code class="fe mj mk ml mm b">1</code>和<code class="fe mj mk ml mm b">0</code>映射成布尔值。</li></ul><p id="8b87" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我更喜欢用个位数的字符串。它们明显比其他选项短。</p><p id="21fd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面的代码片段展示了如何实现从特定环境变量中提取布尔值。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">从特定环境变量中提取布尔值。</figcaption></figure><p id="884a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如前所述，您可以访问这个<a class="ae le" href="https://github.com/grzpab/ts-envvar" rel="noopener ugc nofollow" target="_blank">链接</a>来查看上面定义的作为我的库的一部分的函数。</p><h1 id="082b" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">解码所有变量</h1><p id="b5f9" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">如果您碰巧使用了<code class="fe mj mk ml mm b">io-ts</code>库来解码信息，您可能会利用它从运行时可用的环境变量中提取数据。</p><p id="a3d4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在此之前，我们需要安装一个名为<code class="fe mj mk ml mm b">io-ts-types</code>的依赖项。如果你是<code class="fe mj mk ml mm b">io-ts</code>的狂热用户，你一定以前用过它。如果没有，这个库为开发人员提供了更高级的编解码器，包括一些隐式类型转换。</p><p id="c572" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们对哪些编解码器感兴趣？这些是:</p><ul class=""><li id="732a" class="mn mo it js b jt ju jx jy kb mp kf mq kj mr kn ms mt mu mv bi translated"><code class="fe mj mk ml mm b">BooleanFromString</code>，</li><li id="2b78" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated"><code class="fe mj mk ml mm b">IntFromString</code>，</li><li id="77be" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated"><code class="fe mj mk ml mm b">NumberFromString</code>。</li></ul><p id="9087" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦安装了依赖项，我们就可以构建一个接受<code class="fe mj mk ml mm b">process.env</code>对象并解码其中存储的信息的编解码器，就像我在下面的例子中所做的那样。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">用于解码环境变量的示例性编解码器。</figcaption></figure><p id="bae9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了获得足够的错误报告，您可以使用<code class="fe mj mk ml mm b">io-ts-reporters</code>库。</p><h1 id="29b3" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">测试提取</h1><p id="9001" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">由于<code class="fe mj mk ml mm b">process.env</code>是一个对象，我们可以毫不费力地添加和删除它的属性。尽管我绝不会在产品代码中这样做，但在测试中这是可以接受的。</p><p id="5995" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您使用Mocha.js，您可能会在以下地方修改<code class="fe mj mk ml mm b">process.env</code>对象:</p><ul class=""><li id="c9ba" class="mn mo it js b jt ju jx jy kb mp kf mq kj mr kn ms mt mu mv bi translated">摩卡根钩，</li><li id="9b25" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated">摩卡挂钩。</li></ul><p id="3eec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以在测试用例中直接修改该对象。然而，如果您忘记恢复环境变量的原始状态，您可能会无意中污染其他测试的程序状态。</p><p id="6635" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是在Mocha.js中使用环境变量的例子:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">在Mocha.js中管理示例性环境变量</figcaption></figure><p id="6e67" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您在测试中修改环境变量，您可能会失去并行运行测试的能力。要恢复它，您可能需要执行以下操作:</p><ul class=""><li id="abc3" class="mn mo it js b jt ju jx jy kb mp kf mq kj mr kn ms mt mu mv bi translated">将测试分为依赖这些变量的测试和依赖这些变量的测试，</li><li id="327c" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated">一个一个地运行依赖它们的程序，</li><li id="4513" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated">并行运行其他程序。</li></ul><p id="4e94" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据您的设置、时间和技能，您还可以考虑使用不同的Node.js流程运行特定的测试用例。</p><h1 id="3af3" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">摘要</h1><p id="85c9" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">如上面的多个例子所示，在Node.js中处理环境变量并不简单。我们对这个话题了解得越多，我们发现的琐事就越多。因为我们使用了TypeScript，所以在数据提取和转换过程中，我们必须小心谨慎。最后，类型系统允许我们构建对运行时条件有弹性的代码。</p><p id="0712" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">欢迎你在评论区留下你的评论。这是我2022年的第一篇文章，在2021年我的写作生涯成功启动后，我希望今年能让我联系到更多的人！</p></div></div>    
</body>
</html>