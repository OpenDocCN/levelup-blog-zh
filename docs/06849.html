<html>
<head>
<title>Use your Raspberry Pi as a Docker server with docker-machine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用您的Raspberry Pi作为docker-machine的Docker服务器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/use-your-raspberry-pi-as-a-docker-server-with-docker-machine-b2dd8ac776d3?source=collection_archive---------13-----------------------#2021-01-07">https://levelup.gitconnected.com/use-your-raspberry-pi-as-a-docker-server-with-docker-machine-b2dd8ac776d3?source=collection_archive---------13-----------------------#2021-01-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bbf02c31b2d4883c22481734df490a41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dAnwRpOIU9fHvckg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@exdigy?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">张秀坤·吕克曼</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="d7fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你的电脑速度很慢，或者你无法使用官方的Docker桌面安装程序安装Docker，你可以使用你的Raspberry Pi(或者任何其他服务器)作为你的专用Docker服务器。</p><p id="e2fe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最近，我遇到了一个问题，我无法在我的虚拟机上安装Docker Desktop，该虚拟机运行在我的<a class="ae kc" href="https://www.unraid.net/" rel="noopener ugc nofollow" target="_blank"> Unraid </a>服务器上。问题是在锐龙CPU上，我使用的操作系统(还)不支持嵌套虚拟化。<a class="ae kc" href="https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/user-guide/nested-virtualization" rel="noopener ugc nofollow" target="_blank">嵌套虚拟化</a>意味着你可以在一个虚拟机内部运行一个虚拟机。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/ea0a6e6a243a82a1743f329c2d0dcb9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s6onGM5y0BON6B0z.jpg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">还记得古老的迷因吗？</figcaption></figure><p id="c716" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我不能使用官方的Docker for Mac安装程序来安装Docker，我必须找到另一种方法。</p><p id="158c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个问题的答案是<code class="fe lg lh li lj b">docker-machine</code>。</p><h1 id="aea5" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">什么是docker-machine？</h1><p id="3a6d" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated"><code class="fe lg lh li lj b">docker-machine</code>是Docker的一个CLI程序，它允许你像平常一样使用<code class="fe lg lh li lj b">docker</code>，但是在服务器上执行命令。如果您有多个运行docker的服务器，并且您可以通过使用一个命令<code class="fe lg lh li lj b">docker-machine env YOUR_ENV</code>改变docker环境来控制它们，那么这是非常有用的。</p><p id="5253" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你没有安装<code class="fe lg lh li lj b">docker-machine</code>，试着用你的OSs包管理器安装或者从<a class="ae kc" href="https://github.com/docker/machine/releases" rel="noopener ugc nofollow" target="_blank"> GitHub </a>下载。</p><p id="4a1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在macOS上，您可以像这样从brew安装它:</p><pre class="lc ld le lf gt mn lj mo mp aw mq bi"><span id="f894" class="mr ll iq lj b gy ms mt l mu mv">brew install docker-machine</span></pre><p id="7944" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">即使你不能安装Docker桌面，你也应该可以下载<code class="fe lg lh li lj b">docker</code> CLI，你会需要它的。</p><h1 id="2eaf" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">准备我们的服务器</h1><p id="2169" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">在我们使用<code class="fe lg lh li lj b">docker-machine</code>之前，我们需要先在服务器上做一些配置。</p><p id="7a81" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我建议创建一个新用户，用于使用<code class="fe lg lh li lj b">docker-machine</code>登录。</p><pre class="lc ld le lf gt mn lj mo mp aw mq bi"><span id="e33b" class="mr ll iq lj b gy ms mt l mu mv">adduser docker-machine</span></pre><p id="db53" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们需要允许新用户使用<code class="fe lg lh li lj b">sudo</code>执行命令，但是用户可以在不输入密码的情况下使用它。这可能是一个安全风险，所以请确保<code class="fe lg lh li lj b">docker-machine</code>用户的密码是强密码，并且您的服务器得到了适当的加固。</p><p id="3986" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过将<code class="fe lg lh li lj b">visudo</code>写入您的终端来编辑<code class="fe lg lh li lj b">sudoers</code>文件，并在<code class="fe lg lh li lj b">root</code>条目后添加一个新行。</p><pre class="lc ld le lf gt mn lj mo mp aw mq bi"><span id="aeae" class="mr ll iq lj b gy ms mt l mu mv">docker-machine ALL=(ALL) NOPASSWD: ALL</span></pre><p id="0ccf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">保存并退出编辑器。</p><p id="e39a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lg lh li lj b">docker-machine</code>通用驱动程序不能识别<code class="fe lg lh li lj b">raspbian</code>操作系统，所以我们需要欺骗它，将<code class="fe lg lh li lj b">/etc/os-release</code>中的<code class="fe lg lh li lj b">ID</code>字段临时改为<code class="fe lg lh li lj b">debian</code>。</p><pre class="lc ld le lf gt mn lj mo mp aw mq bi"><span id="8cd4" class="mr ll iq lj b gy ms mt l mu mv">#/etc/os-release<br/>PRETTY_NAME="Raspbian GNU/Linux 10 (buster)"<br/>NAME="Raspbian GNU/Linux"<br/>VERSION_ID="10"<br/>VERSION="10 (buster)"<br/>VERSION_CODENAME=buster<br/>ID=debian<br/>ID_LIKE=debian<br/>HOME_URL="<a class="ae kc" href="http://www.raspbian.org/" rel="noopener ugc nofollow" target="_blank">http://www.raspbian.org/</a>"<br/>SUPPORT_URL="<a class="ae kc" href="http://www.raspbian.org/RaspbianForums" rel="noopener ugc nofollow" target="_blank">http://www.raspbian.org/RaspbianForums</a>"<br/>BUG_REPORT_URL="<a class="ae kc" href="http://www.raspbian.org/RaspbianBugs" rel="noopener ugc nofollow" target="_blank">http://www.raspbian.org/RaspbianBugs</a>"</span></pre><p id="9385" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，您需要在您的服务器上使用<code class="fe lg lh li lj b">docker-machine</code>用户设置公钥认证。我在另一篇文章中记录了如何做到这一点的过程。向下滚动到<strong class="kf ir">“使用公钥认证跳过密码”</strong>部分，并按照步骤进行设置。</p><p id="350a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在您的服务器应该准备好使用<code class="fe lg lh li lj b">docker-machine</code>安装docker了。</p><h1 id="7670" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">用docker-machine在你的服务器上安装docker</h1><p id="a8db" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">现在您的机器上已经安装了docker-machine CLI，我们可以使用它在服务器上安装docker，只需一个命令。</p><pre class="lc ld le lf gt mn lj mo mp aw mq bi"><span id="40c7" class="mr ll iq lj b gy ms mt l mu mv">docker-machine create \<br/>  --driver generic \<br/>  --generic-ip-address=192.168.1.13 \<br/>  --generic-ssh-user=docker-machine \<br/>  --generic-ssh-key ~/.ssh/id_rsa \<br/>  rpi</span><span id="8a3f" class="mr ll iq lj b gy mw mt l mu mv">Running pre-create checks...<br/>Creating machine...<br/>(rpi) Importing SSH key...<br/>Waiting for machine to be running, this may take a few minutes...<br/>Detecting operating system of created instance...<br/>Waiting for SSH to be available...<br/>Detecting the provisioner...<br/>Provisioning with debian...<br/>Copying certs to the local machine directory...<br/>Copying certs to the remote machine...<br/>Setting Docker configuration on the remote daemon...<br/>Checking connection to Docker...<br/>Docker is up and running!<br/>To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env rpi</span></pre><p id="7353" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就这样，现在你应该已经在你的服务器上安装了docker！</p><h1 id="8e90" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">用docker-machine改变你的docker环境</h1><p id="9343" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">现在，如果您想在服务器上执行docker命令，您只需使用以下命令更改docker环境:</p><pre class="lc ld le lf gt mn lj mo mp aw mq bi"><span id="cd37" class="mr ll iq lj b gy ms mt l mu mv">eval $(docker-machine env rpi)</span></pre><p id="8b50" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您总是想使用服务器环境，请将该行放入您的<code class="fe lg lh li lj b">.bashrc</code>或<code class="fe lg lh li lj b">.zshrc</code>文件中。</p><h1 id="534a" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">开始使用Docker</h1><p id="7252" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">用<code class="fe lg lh li lj b">docker-machine</code>改变环境后，你可以像平常一样使用<code class="fe lg lh li lj b">docker</code>！</p><pre class="lc ld le lf gt mn lj mo mp aw mq bi"><span id="0879" class="mr ll iq lj b gy ms mt l mu mv">docker ps<br/>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span></pre><h1 id="8710" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">有用的docker-machine命令</h1><ul class=""><li id="a55a" class="mx my iq kf b kg mi kk mj ko mz ks na kw nb la nc nd ne nf bi translated"><code class="fe lg lh li lj b">docker-machine ls</code> -列出所有环境</li><li id="a602" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lg lh li lj b">docker-machine rm ENV</code> -删除现有环境</li><li id="0e78" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lg lh li lj b">docker-machine ip ENV</code> -获取服务器的IP地址</li><li id="cf92" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lg lh li lj b">docker-machine ssh ENV</code> -打开与服务器的SSH连接</li></ul><h1 id="af0f" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">结论</h1><p id="19ff" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated"><code class="fe lg lh li lj b">docker-machine</code>是一个很酷的工具，非常容易设置和使用。我发现这种方法非常有趣。目前，设置工作得很好，我没有看到任何缺点。</p><p id="9646" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">唯一不同的是，如果我想访问docker上运行的服务，我将不得不使用我的服务器的IP而不是<code class="fe lg lh li lj b">localhost</code>。</p></div><div class="ab cl nl nm hu nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ij ik il im in"><p id="f5dd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ns">原载于2021年1月7日</em><a class="ae kc" href="https://phiilu.com/docker-machine-generic-server-raspberry-pi" rel="noopener ugc nofollow" target="_blank"><em class="ns">【https://phiilu.com】</em></a><em class="ns">。</em></p></div></div>    
</body>
</html>