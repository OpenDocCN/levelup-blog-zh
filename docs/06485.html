<html>
<head>
<title>Multiplex TLS Traffic with SNI Routing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SNI路由复用TLS流量</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/multiplex-tls-traffic-with-sni-routing-ece1e4e43e56?source=collection_archive---------4-----------------------#2020-11-30">https://levelup.gitconnected.com/multiplex-tls-traffic-with-sni-routing-ece1e4e43e56?source=collection_archive---------4-----------------------#2020-11-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9874" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Nginx配置和HTTP/2合并</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/14e6b0ba3011422dda5eddbdbbd3ba40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NmV2LDJwD3UOQQSd"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kv" href="https://unsplash.com/@genefoto?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">吉恩·加林</a>的照片</figcaption></figure><p id="056d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">服务器名称指示或SNI是一种TLS扩展，最初是为单个web服务器设计的，为配置了不同TLS证书的多个HTTPS站点提供服务。例如，当www.example.com的<em class="ls">使用TLS证书-A，而www.example.net<em class="ls">的</em>使用不同的TLS证书-B时，web服务器可以在SNI的帮助下识别该域，并使用正确的证书建立TLS会话，以服务于相应的网站。</em></p><p id="2d66" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为服务器名是明文的，即。未加密，web服务器能够选择TLS证书来建立安全会话。有趣的是，明文服务器名称有多种使用情形，比如在中间有一个设备用于流量过滤。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="f628" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">SNI路由</h1><p id="7ac7" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">SNI的另一个用例是识别服务器名称并将流量路由到不同的源服务器。这允许单个IP和端口接收几个网站、应用的流量，并智能地将它们路由到它们相应的源服务器。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/25de929d799750d9e30c7c1346c0c6d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oqhbcv2rdgiAosKczbV5LQ.png"/></div></div></figure><p id="75cc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上图给出了一个例子，nginx服务器作为SNI路由器，接受c.application.org<em class="ls">、a.example.com</em>和b.for-example.net的TLS连接请求。nginx服务器可以检查这些请求中的服务器名称，并在原始映射的帮助下，启动到原始服务器的连接并代理数据。</p><p id="6904" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这允许源服务器使用它们自己的TLS证书与客户端建立安全的TLS会话。而且，这些源服务器可以位于专用网络内部，没有任何公共接口，而SNI路由器可以位于边缘。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h2 id="0c7d" class="my mb iq bd mc mz na dn mg nb nc dp mk lf nd ne mm lj nf ng mo ln nh ni mq nj bi translated">nginx配置</h2><p id="8e12" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">nginx中的<a class="ae kv" href="https://nginx.org/en/docs/stream/ngx_stream_ssl_preread_module.html" rel="noopener ugc nofollow" target="_blank">stream _ SSL _ preread _ module</a>用于SNI路由器。运行<strong class="ky ir"> nginx -V </strong>以获取配置参数列表，并确保它包含以下内容:</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="5851" class="my mb iq nl b gy np nq l nr ns">--with-stream_ssl_preread_module</span></pre><p id="867d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面的示例配置在端口443上创建了一个流侦听器，并基于服务器名称到IP地址的静态映射代理到源服务器的TLS连接。</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="fcb5" class="my mb iq nl b gy np nq l nr ns">stream {<br/>  map $ssl_preread_server_name $origin_https {<br/>    hostnames;<br/>    default           p8;<br/>    a.example.com     p1;<br/>    b.for-example.net p2;<br/>    c.application.org p3;<br/>  }</span><span id="84b1" class="my mb iq nl b gy nt nq l nr ns">  upstream p8 {<br/>    server 10.0.3.8:443;<br/>  }</span><span id="b759" class="my mb iq nl b gy nt nq l nr ns">  upstream p1 {<br/>    server 10.0.3.1:443;<br/>  }</span><span id="d6e9" class="my mb iq nl b gy nt nq l nr ns">  upstream p2 {<br/>    server 10.0.3.2:443;<br/>  }</span><span id="80c7" class="my mb iq nl b gy nt nq l nr ns">  upstream p3 {<br/>    server 10.0.3.3:443;<br/>  }</span><span id="5126" class="my mb iq nl b gy nt nq l nr ns">  server {<br/>    listen 443;<br/>    proxy_pass $origin_https;<br/>    ssl_preread on;<br/>  }<br/>}</span></pre><p id="55b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，这种方法有一个缺点，源服务器看不到客户端的公共IP地址，而是nginx服务器的私有IP地址。为了避免这种情况，需要一种不同的多路传输TLS流量的方法，该方法使用深度数据包检测(DPI)和目的网络地址转换(DNAT)。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="4850" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">HTTP/2合并</h1><p id="82b4" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">由于<a class="ae kv" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1363451" rel="noopener ugc nofollow" target="_blank"> HTTP/2客户端重用连接</a>的方式，如果TLS源服务器证书中的服务器名称(公用名和主题备用名)重叠，SNI路由可能会出现问题。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/82ec371987be017647ee6480c006bd61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fk8pDKD0O760WuDqM4ysyA.png"/></div></div></figure><p id="ae5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的例子中，由于源服务器10.0.3.2使用的TLS证书有通配符名称<em class="ls"> *.example.com </em>，Web浏览器可以与服务器名称【b.example.com】建立TLS连接，并使用<strong class="ky ir">相同的连接</strong>用于<strong class="ky ir"> HTTP/2请求</strong>到<em class="ls">a.example.com</em>。这可能会导致网站和应用程序中出现未定义的行为。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="e7ea" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">加密SNI</h1><p id="f10e" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">由于服务器名称没有加密，SNI有很大的隐私问题和审查问题。加密SNI (ESNI)试图通过加密服务器名称来解决这些问题。虽然仅仅加密服务器名称不足以解决所有隐私问题，但它可以解决一些其他问题。请注意，这些问题还有其他解决方案。</p><p id="e668" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果没有替代品，依赖SNI的企业产品可能无法完全发挥作用。因此，ESNI是否会被广泛使用还有待观察。然而，无论如何，这些问题在将来都会有解决的办法。在第0根，我们继续遵循这样的解决方案，并采用它们来提高我们产品的安全性。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><p id="752d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">我们的产品</em> <a class="ae kv" href="https://www.0snet.com/" rel="noopener ugc nofollow" target="_blank"> <em class="ls">第0根安全网络— 0SNet </em> </a> <em class="ls">使用TLS客户端证书保护组织的内部web应用。它易于部署，也可作为映像在</em><a class="ae kv" href="https://0snet.info/#install.aws" rel="noopener ugc nofollow" target="_blank"><em class="ls">AWS</em></a><em class="ls">、</em><a class="ae kv" href="https://0snet.info/#install.gcp" rel="noopener ugc nofollow" target="_blank"><em class="ls">GCP</em></a><em class="ls">和</em><a class="ae kv" href="https://0snet.info/#install.azu" rel="noopener ugc nofollow" target="_blank"><em class="ls">Azure</em></a><em class="ls">上使用。今天就尝试一下吧！</em></p></div></div>    
</body>
</html>