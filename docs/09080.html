<html>
<head>
<title>How to Send Web Push Notifications for Free with AWS and without Firebase</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用AWS和不用Firebase免费发送网页推送通知</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-send-web-push-notifications-for-free-with-aws-and-without-firebase-19d02eadf1f7?source=collection_archive---------2-----------------------#2021-07-05">https://levelup.gitconnected.com/how-to-send-web-push-notifications-for-free-with-aws-and-without-firebase-19d02eadf1f7?source=collection_archive---------2-----------------------#2021-07-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e620" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AppSync等AWS服务支持通过WebSockets向客户端推送数据的托管方式，当用户打开您的web应用程序时，这种方法非常有效。它是无服务器的，快速，可靠，非常容易设置。但是，如果你需要向不再打开你的应用程序标签的用户发送通知呢？这就是<a class="ae kl" href="https://developer.mozilla.org/en-US/docs/Web/API/Push_API" rel="noopener ugc nofollow" target="_blank">网络推送通知</a>派上用场的地方。</p><p id="3b78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本指南中，我将展示如何通过SNS消息从AWS后端触发web推送通知。最终结果将如下所示:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/a4514126d687ec3f4ab115046e48a9ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/1*7EKVof0VYz8bamhXz6D6ew.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">示例推送通知</figcaption></figure><h1 id="fb7a" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">网络推送通知的工作原理</h1><p id="5368" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">事实上非常简单:当用户选择允许来自你网站的浏览器通知时——微软/Mozilla/谷歌在他们的云中的某个地方创建一个REST端点。您只需要向该端点发出一个带有特定有效负载的签名POST请求，就可以将通知推送到用户的浏览器。你可以发送任意多的请求，而且完全免费。</p><p id="7d48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">许多开发人员对此感到困惑，因为大量误导性的文章仍然建议您需要创建一个Firebase项目，并使用Google FCM服务作为适配器来支持不同的浏览器。事实上，自从<a class="ae kl" href="https://developers.google.com/web/fundamentals/push-notifications/web-push-protocol" rel="noopener ugc nofollow" target="_blank">网络推送协议</a>在2016年被标准化后，它就被<a class="ae kl" href="https://caniuse.com/push-api" rel="noopener ugc nofollow" target="_blank">所有主流浏览器</a>直接支持，完全不需要Firebase。我并不是反对Firebase，只是我们在eatella的堆栈100%都是AWS，我正在展示我们真实的生产实现。</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="efed" class="ky kz iq bd la lb mi ld le lf mj lh li lj mk ll lm ln ml lp lq lr mm lt lu lv bi translated">第一步。准备</h1><p id="f7c9" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">为了加密你的通知，你需要一对“乏味”的密钥。你可以使用<a class="ae kl" href="https://www.npmjs.com/package/web-push" rel="noopener ugc nofollow" target="_blank"> web-push JavaScript包</a>或者仅仅使用一个<a class="ae kl" href="https://www.google.com/search?q=vapid+keys+online+generator&amp;sxsrf=ALeKk00WUjMn1qlashar5uM7r-Fwp03RKQ%3A1625391480547&amp;ei=eIHhYPD4IMaK8gLHyamoCA&amp;oq=vapid+keys+&amp;gs_lcp=Cgdnd3Mtd2l6EAEYADICCAAyBAgAEAoyBAgAEAoyBggAEBYQHjIGCAAQFhAeMgYIABAKEEMyBggAEBYQHjIGCAAQFhAeMgYIABAWEB4yBggAEBYQHjoHCAAQRxCwAzoRCAAQsAMQigMQtwMQ1AMQ5QJKBAhBGABQq0RYq0RgkUtoAXACeACAAZMBiAHRAZIBAzEuMZgBAKABAaoBB2d3cy13aXrIAQrAAQE&amp;sclient=gws-wiz" rel="noopener ugc nofollow" target="_blank">在线服务</a>来生成它们。把钥匙放在安全的地方，尤其是私人的。JavaScript部分和后端都需要它们。</p><h1 id="1144" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">第二步。在您的客户端JavaScript中订阅Web推送</h1><p id="0a58" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">为了让你的应用程序监听网络推送通知，你需要注册一个<a class="ae kl" href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API" rel="noopener ugc nofollow" target="_blank">服务人员</a>。在项目中可以被URL引用的地方创建新的sw.js文件。给它加上这几行:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="5a00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个代码片段负责处理后台推送事件，并显示一个带有标题和文本的最基本的通知。点击<a class="ae kl" href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/showNotification" rel="noopener ugc nofollow" target="_blank">此处</a>查看通知选项的完整列表。</p><p id="80de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，将这段代码添加到应用程序本身的代码中。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="fca7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您在浏览器中运行此代码时，它会要求您允许web推送通知，如果允许，它将创建订阅:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/8049b6da98a555de5a3b9da728c81437.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*yykL9sIwSG6p-G053aVTPw.png"/></div></figure><h1 id="d617" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">第三步。调配您的AWS后端</h1><p id="18b8" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">要从后端发送web推送通知，您需要将每个用户的订阅数据保存在服务器端的某个地方。<br/>在我看来，完成这项任务最简单的方法是<a class="ae kl" href="https://aws.amazon.com/appsync/" rel="noopener ugc nofollow" target="_blank"> AppSync </a> + <a class="ae kl" href="https://aws.amazon.com/dynamodb/" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>。客户端JavaScript将需要发布一个GraphQL变体(我们将在下一步添加该代码)。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mq"><img src="../Images/8970cdc99b50db8e1f88ed90a98f9853.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fbeS4deQVfDbovdPCc2Tfw.png"/></div></div></figure><p id="46c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过单击下面的按钮，您可以在AWS帐户中创建所有必要的资源:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=WebPush&amp;templateURL=https://s3.amazonaws.com/medium-templates/WebPush.yaml"><div class="gh gi mv"><img src="../Images/b287be6c3fe2b14ebeaba5c97ae38fca.png" data-original-src="https://miro.medium.com/v2/resize:fit:288/format:webp/1*diPbAAquQBq8zDQfpCvtEQ.png"/></div></a><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">AWS Cloudformation堆栈，用于从SNS发送Web推送通知</figcaption></figure><p id="5908" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您需要输入您的VAPID数据作为云形成堆栈参数:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mw"><img src="../Images/542ad05aafa7810194a39470e43c721e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qCejE6zyfbWGx_aXqUCNMg.png"/></div></div></figure><p id="4740" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该堆栈还包括SNS主题和Lambda函数，该函数执行实际的Web推送通知发送:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/0558667109d2661b858bdc51b471720f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1042/format:webp/1*I-gGQLh1fVKPdWptxHoLEw.png"/></div></figure><p id="0383" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">lambda函数是NodeJS中的几行JavaScript。它从DynamoDB加载订阅者列表，并使用我们前面提到的<a class="ae kl" href="https://www.npmjs.com/package/web-push" rel="noopener ugc nofollow" target="_blank"> web-push npm包</a>向每个订阅者发送通知:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><h1 id="c6bc" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">第四步。将订阅数据从客户端发送到AppSync</h1><p id="7d5c" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">最后，我们需要扩展应用程序的JavaScript代码，将订阅数据作为GraphQL变体发送到服务器端。这是最后的结果:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="208f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在AWS控制台中找到AppSync Url和Api密钥:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi my"><img src="../Images/c1abbb809fba2c0db81ffd077e2b6004.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n6pEpAeBJo-MpPbf2FVLkg.png"/></div></div></figure></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="fee3" class="ky kz iq bd la lb mi ld le lf mj lh li lj mk ll lm ln ml lp lq lr mm lt lu lv bi translated">测试</h1><p id="b23e" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">恭喜你！如果你做到了这一步，你可以测试一切，并在你自己的浏览器中看到网页推送通知。<br/>转到SNS控制台，找到我们的主题并发布一条测试消息:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mz"><img src="../Images/a9862f6ff1b3dd9954a0f5b95ea46610.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3rqw276J5nfcryv-yKdK6Q.png"/></div></div></figure><p id="3a48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样。不到一秒钟后，您应该会看到通知！</p><h1 id="5080" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">真的免费吗？</h1><p id="0235" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">是的，发送网络推送通知是免费的。我们用于后端的AWS服务都是<a class="ae kl" href="https://aws.amazon.com/free" rel="noopener ugc nofollow" target="_blank">慷慨的免费层</a>的一部分。然而，如果你计划触发数百万条消息，你很可能会超过它。务必检查<a class="ae kl" href="https://aws.amazon.com/lambda/pricing/" rel="noopener ugc nofollow" target="_blank"> Lambda </a>、<a class="ae kl" href="https://aws.amazon.com/dynamodb/pricing/" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>、<a class="ae kl" href="https://aws.amazon.com/appsync/pricing/" rel="noopener ugc nofollow" target="_blank"> AppSync </a>和<a class="ae kl" href="https://aws.amazon.com/sns/pricing/" rel="noopener ugc nofollow" target="_blank"> SNS </a>的定价。</p><p id="ad77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">祝你好运，免费建造一些好东西并通知客户。</p></div></div>    
</body>
</html>