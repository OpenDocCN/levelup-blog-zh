<html>
<head>
<title>Unit Testing Your Airflow Data Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">单元测试您的气流数据管道</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/airflow-unit-testing-for-bug-free-data-pipeline-d96f87a3cc8f?source=collection_archive---------4-----------------------#2021-09-07">https://levelup.gitconnected.com/airflow-unit-testing-for-bug-free-data-pipeline-d96f87a3cc8f?source=collection_archive---------4-----------------------#2021-09-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="cdcc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">单元测试你的气流管道，以防止不正确的代码和意外的运行时间</h2></div><p id="b7cb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">想象一下这样一个场景，您必须运行多个日常作业来从数据湖中提取数据，对它们进行预处理，并将清理后的数据集存储到专用数据库中。如果我们必须每天运行管道，不断检查可能的错误，那将是非常乏味的。这就是Airflow派上用场的地方:它为您提供了自动构建和监控多个数据管道的所有工具。然而，随着您的数据管道变得更大更复杂，您必须通过执行健壮的<strong class="kk iu">单元测试</strong>来确保管道没有泄漏。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/ed3c2203e559a9a760a8776da042de97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GAIrBLFcxhAO94FD"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated"><a class="ae lu" href="https://unsplash.com/@homajob?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">斯科特·格雷厄姆</a>在<a class="ae lu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="b585" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇文章是我最近开始的与气流相关的持续系列的一部分(不知何故我正在深入这个兔子洞):</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="c7df" class="ma mb it lw b gy mc md l me mf">1. <a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/airflow-for-data-pipeline-101-7a42cc28cf3a">Airflow for Data Pipeline 101</a><br/>2. <a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/airflow-decorators-for-a-clean-data-pipeline-48ebdf12e9b0">Airflow: Decorators for a Clean Data Pipeline</a><br/>3. <strong class="lw iu">Unit Testing Your Airflow Data Pipeline</strong><br/>4. <em class="mg">TBD...</em></span></pre><p id="9307" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，我将带你通过气流中的单元测试。这些测试非常重要，因为它们可以在数据管道部署到实际环境之前，尽早发现错误并捕获bug。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="01c6" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">Table of Content:<br/></strong>1. Problem Statement<br/>2. Unit test: DAG<br/>3. Unit test: Structure</span></pre><p id="fc5c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">事不宜迟，让我们直接进入主题吧！</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="8d0d" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">问题陈述</h1><p id="2f9e" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">在我们开始之前，请确保您的机器中的气流设置正确，并且您对气流的工作原理有一个基本的了解。本系列的第一篇文章<a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/airflow-for-data-pipeline-101-7a42cc28cf3a">将指导您完成安装和设置过程。</a></p><p id="46a9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正确设置后，您将能够查看Airflow web GUI，如下图所示。该页面将突出显示您的所有管道、它们的所有者、时间表以及用于监控系统健康状况的相关诊断。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nk"><img src="../Images/53dddb9a7468b32eaebf5b32b17eec57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e5_BQ10jLCcGxxyWv0pOaQ.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">气流网络用户界面(图片由作者提供)</figcaption></figure><p id="f60b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们回顾一下我们之前创建的一个简单任务。首先，我们在代码中导入所有必要的库</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="d2d5" class="ma mb it lw b gy mc md l me mf">import datetime as dt<br/>from airflow import DAG<br/>from airflow.operators.bash import BashOperator</span></pre><p id="1a42" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">之后，我们将为我们的任务定义一个简单的默认参数。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="85e2" class="ma mb it lw b gy mc md l me mf">default_args = {<br/>    'owner': 'me',<br/>    'start_date': dt.datetime(2021, 9, 4)<br/>}</span></pre><p id="fd48" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们将制定一个简单的<code class="fe nl nm nn lw b">hello_world</code>任务，将它、<code class="fe nl nm nn lw b">hello world</code>打印到终端上。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="9c05" class="ma mb it lw b gy mc md l me mf">with DAG('airflow_tutorial_v01', default_args) as dag:</span><span id="5faa" class="ma mb it lw b gy no md l me mf">    print_hello = BashOperator(task_id='print_hello',<br/>        bash_command='echo hello')</span><span id="9d7e" class="ma mb it lw b gy no md l me mf">    print_world = BashOperator(task_id='print_world',<br/>        bash_command='echo world')</span></pre><p id="e6bc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们将构建DAG的结构。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="0c10" class="ma mb it lw b gy mc md l me mf">print_hello &gt;&gt; print_world</span></pre><p id="a54c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在之前的文章中，我们已经学习了如何使用下面的格式对整个任务进行测试。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="f946" class="ma mb it lw b gy mc md l me mf">airflow dags test &lt;DAG_ID&gt; &lt;EXECUTION_DATE&gt;</span></pre><p id="2f5d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们的例子中，情况是这样的:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="292a" class="ma mb it lw b gy mc md l me mf">airflow dags test airflow_tutorial_v01 2021-09-04</span></pre><p id="e858" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行上面的脚本后，调试终端将弹出并显示任务是否已经完成，或者是否有任何警告/错误需要纠正。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi np"><img src="../Images/2e305eabd781ef95614780940c4c2a49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ibrLHdWU43IQFH_Z2tY3fg.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">调试气流管道(图片由作者提供)</figcaption></figure><p id="6ab9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然而，如果我们的任务变得巨大/复杂，并且我们有复杂的功能，该怎么办？在接下来的章节中，我们将学习一些在气流中执行单元测试的基本技术。</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="0717" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">单元测试:DAG</h1><p id="2f2a" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated"><strong class="kk iu"> <em class="mg">注意:</em> </strong> <em class="mg">将测试脚本放在别处(不在~/airflow/dags中)</em></p><p id="4ea7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们确保我们的DAG已正确加载，并且没有引发任何错误。在<code class="fe nl nm nn lw b">airflow_test.py</code>文件中，我们首先导入依赖项。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="9ac3" class="ma mb it lw b gy mc md l me mf">from airflow.models import DagBag</span></pre><p id="5356" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nl nm nn lw b">DagBag</code>是一个将导入我们所有Dag和任务的类。接下来，我们将定义一个简单的单元测试函数。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="4436" class="ma mb it lw b gy mc md l me mf">def test_no_import_errors():<br/>    dag_bag = DagBag()<br/>    dag = dag_bag.get_dag(dag_id='airflow_tutorial_v01')</span><span id="e44e" class="ma mb it lw b gy no md l me mf">    assert len(dag_bag.import_errors) == 0, "No Import Failures"<br/>    assert dag is not None</span></pre><p id="265b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个函数确保我们的<code class="fe nl nm nn lw b">hello world</code> DAG被正确加载。然后我们调用函数。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="3cf8" class="ma mb it lw b gy mc md l me mf">test_no_import_errors()</span></pre><p id="1994" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并运行Python脚本。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="ed58" class="ma mb it lw b gy mc md l me mf">python airflow_test.py</span></pre><p id="9df7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果一切顺利，你就可以走了！</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="7215" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">单元测试:结构</h1><p id="8d12" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">现在，我们想检查我们的任务结构是否正确。通过在Python解释器中运行以下代码，我们可以快速检查任务的结构。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="e43d" class="ma mb it lw b gy mc md l me mf">python</span><span id="cf86" class="ma mb it lw b gy no md l me mf">&gt;&gt;&gt; from airflow.models import DagBag<br/>&gt;&gt;&gt; dag_bag = DagBag()<br/>&gt;&gt;&gt; dag = dag_bag.get_dag(dag_id='airflow_tutorial_v01')<br/>&gt;&gt;&gt; print(dag)</span></pre><p id="e64e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">打印输出将显示如下内容:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="5dc2" class="ma mb it lw b gy mc md l me mf">dict_keys(['print_hello', 'print_world'])</span></pre><p id="8ba1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">太好了！让我们从在<code class="fe nl nm nn lw b">airflow_test.py</code>文件中定义另一个函数开始。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="5fb1" class="ma mb it lw b gy mc md l me mf">def test_dag_structure():<br/>    dag_bag = DagBag()<br/>    dag = dag_bag.get_dag(dag_id='airflow_tutorial_v01')<br/>    <br/>    target_keys = {'print_hello', 'print_world'}<br/>    assert dag.task_dict.keys() == target_keys</span></pre><p id="fc70" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里我们断言我们的任务与我们定义的目标相匹配。如果一切正常，那么您的DAG已经过验证，您可以开始了！</p><h1 id="f394" class="mo mb it bd mp mq nq ms mt mu nr mw mx jz ns ka mz kc nt kd nb kf nu kg nd ne bi translated">结论</h1><p id="d116" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">我们已经成功地执行了单元测试，以确保气流中数据管道的完整性。单元测试允许我们确保我们的DAG任务已经被正确加载，并且它的结构是一致的。更高级的概念是对气流中的定制操作执行单元测试(例如，确保S3桶中的数据完整性等)。但这将是下一篇文章的主题，敬请关注！</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><p id="f131" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mg">如果你喜欢这种帖子，请考虑订阅我的</em> <a class="ae lu" href="https://tinyurl.com/2npw2fnz" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu"> <em class="mg">电子邮件简讯</em> </strong> </a> <em class="mg">，在那里我会定期用简单的英语和漂亮的可视化语言总结编程技巧和人工智能研究论文。</em></p></div></div>    
</body>
</html>