<html>
<head>
<title>Four Alternative Methods to Get User Identity and Claims in a .NET Azure Functions App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在. NET Azure Functions应用程序中获取用户身份和声明的四种替代方法</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/four-alternative-methods-to-get-user-identity-and-claims-in-a-net-azure-functions-app-df98c40424bb?source=collection_archive---------0-----------------------#2021-03-19">https://levelup.gitconnected.com/four-alternative-methods-to-get-user-identity-and-claims-in-a-net-azure-functions-app-df98c40424bb?source=collection_archive---------0-----------------------#2021-03-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0fa6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于如何在. NET Core Azure Functions应用程序中获取用户身份和身份验证声明的全面指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2b182de482174df9f762854b4b3ec400.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JBEB3sxto1jMSaevt3z_lQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@agk42?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">亚历山大·奈特</a>在<a class="ae ky" href="/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="5add" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Azure App Service提供内置的身份和认证支持，使用户识别和认证成为一项轻松的任务。</p><p id="c0dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于ASP.NET 4.6(及更高版本)应用程序，<code class="fe lv lw lx ly b">ClaimsPrincipal.Current</code>由经过认证的用户的身份和声明填充，使开发者能够遵循该标准。NET代码模式。然而，在。基于. NET Core的Azure函数，<code class="fe lv lw lx ly b">ClaimsPrincipal.Current</code>不会自动填充，<code class="fe lv lw lx ly b">Claims</code>必须通过不同的方式获得。</p><p id="0bdf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文将介绍四种方法来访问。NET Core (C#)代码。</p><p id="0d1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong> <em class="lz"> Microsoft Azure是一项付费服务，遵循本文可能会导致您或您的组织承担财务责任。</em></p><p id="e358" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lz">在继续阅读本文之前，请阅读我们的使用条款:</em><a class="ae ky" href="https://dhyanintech.medium.com/disclaimer-disclosure-terms-of-use-fb3bfbd1e0e5" rel="noopener"><em class="lz">https://dhyanintech . medium . com/disclaimer-disclosure-disclosure-terms-of-use-fb3 BF BD 1e 0e 5</em></a></p><h1 id="7d73" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">先决条件</h1><ol class=""><li id="520b" class="ms mt it lb b lc mu lf mv li mw lm mx lq my lu mz na nb nc bi translated">有效的Microsoft Azure订阅</li><li id="90f7" class="ms mt it lb b lc nd lf ne li nf lm ng lq nh lu mz na nb nc bi translated">Azure功能应用</li></ol></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><p id="8777" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">启用应用程序服务身份验证时，每个传入的HTTP请求在被应用程序代码处理之前都要通过身份提供者的身份验证和授权模块。关于经过身份验证的客户端的信息可以作为一个<em class="lz"> ClaimsPrincipal </em>对象和在特殊的头中获得。</p><p id="55ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lz">嗯……我如何启用应用服务认证？</em></p><div class="np nq gp gr nr ns"><a href="https://medium.com/geekculture/easyauth-in-functions-app-with-azure-active-directory-29c01cad8477" rel="noopener follow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd iu gy z fp nx fr fs ny fu fw is bi translated">Azure Active Directory功能应用中的“EasyAuth”</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">使用Azure AD在Azure功能应用程序中配置身份和身份验证</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">medium.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og ks ns"/></div></div></a></div><h1 id="c117" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">将Principal声明为绑定参数</h1><p id="f735" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">最直接的方法是从函数的绑定参数中获取<code class="fe lv lw lx ly b">ClaimsPrincipal</code>对象。将<code class="fe lv lw lx ly b">ClaimsPrincipal</code>作为附加参数包含在函数签名中。对象将被自动注入，类似于ILogger的注入方式。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">获取ClaimsPrincipal作为绑定参数(C#)</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/4974097250ce4a4dc4642666af4005ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1SI5cb8E0YVyxM-7zxBaSA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">ClaimsPrincipal:用户身份和声明(图片由作者提供)</figcaption></figure><h1 id="bca1" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">从请求上下文中声明Principal</h1><p id="3c01" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated"><code class="fe lv lw lx ly b">ClaimsPrincipal</code>对象也是请求上下文的一部分，可以从<code class="fe lv lw lx ly b">HttpRequest.HttpContext</code>中提取。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">从请求上下文中获取ClaimsPrincipal)</figcaption></figure><p id="2e04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">ClaimsPrincipal</code>的优点是易于引用和处理身份所代表的个人声明，允许快速验证或设计/决策逻辑实现。</p><h1 id="2f30" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">来自请求标头的用户声明</h1><p id="43b1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">应用服务通过使用特殊的请求头将用户声明传递给应用。不允许外部请求设置这些头，因此它们只有在由应用服务设置时才会出现。几个示例标题:</p><pre class="kj kk kl km gt on ly oo op aw oq bi"><span id="ccc7" class="or mb it ly b gy os ot l ou ov">X-MS-CLIENT-PRINCIPAL-ID --User ID<br/>X-MS-CLIENT-PRINCIPAL-NAME --User Name<br/>X-MS-CLIENT-PRINCIPAL-IDP --Identity Provider's ID<br/>X-MS-CLIENT-PRINCIPAL --Claims</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">从请求头获取用户声明(C#)</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/516e250bf47b3a1e91e966c6c2234d42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5CQ_9_He9WpVgXljXSa5qw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来自请求标头的声明(图片由作者提供)</figcaption></figure><h1 id="409b" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">来自身份验证令牌的用户声明</h1><p id="1a49" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">身份验证服务器将特定于提供者的令牌注入到请求头中，请求头包含经过身份验证的用户的详细信息和声明。这些令牌还可以用来访问用户信息和代码中的声明。</p><blockquote class="ox"><p id="e767" class="oy oz it bd pa pb pc pd pe pf pg lu dk translated">令牌头是JSON web令牌(jwt)。jwt是加密的，在引用之前必须解密。</p></blockquote><p id="f424" class="pw-post-body-paragraph kz la it lb b lc ph ju le lf pi jx lh li pj lk ll lm pk lo lp lq pl ls lt lu im bi translated">在我们的演示代码中，我们将从Azure AD ID令牌头获取声明:<code class="fe lv lw lx ly b">X-MS-TOKEN-AAD-ID-TOKEN</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">从身份验证令牌获取用户声明(C#)</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pm"><img src="../Images/8252a2d32a7008bacaeb62028c9548fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xEqJpuIPJ5P019hBgchCng.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来自认证令牌的声明(图片由作者提供)</figcaption></figure><p id="ce0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lz">那么来自其他提供商的令牌头呢？</em></p><div class="np nq gp gr nr ns"><a href="https://docs.microsoft.com/en-us/azure/app-service/app-service-authentication-how-to#retrieve-tokens-in-app-code" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd iu gy z fp nx fr fs ny fu fw is bi translated">AuthN/AuthZ - Azure应用服务的高级用法</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">本文向您展示了如何在App Service中定制内置的身份验证和授权，以及如何管理…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">docs.microsoft.com</p></div></div><div class="ob l"><div class="pn l od oe of ob og ks ns"/></div></div></a></div><p id="8595" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">想要在没有任何代码的情况下窥视你的JWT内部吗？</p><p id="4a8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://jwt.ms/" rel="noopener ugc nofollow" target="_blank">https://jwt.ms/</a></p><h2 id="4e60" class="or mb it bd mc po pp dn mg pq pr dp mk li ps pt mm lm pu pv mo lq pw px mq py bi translated">亲tip</h2><p id="c2bf" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">如果遇到<em class="lz">令牌不能为空</em>错误，请确保在应用程序的<strong class="lb iu">身份验证/授权</strong>设置中将<strong class="lb iu">令牌存储</strong>设置为上的<strong class="lb iu">。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pz"><img src="../Images/f646a19eded262da51586190b2e86d7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vNEE3IeuNcDDR-61dhrfcg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">令牌为空:必须启用令牌存储(图片由作者提供)</figcaption></figure><h1 id="79bc" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">第三方</h1><p id="1787" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">只是为了完成对话，有一些第三方开源中间件组件可以让事情变得简单。</p><p id="8461" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们配备了适合这项工作的工具。</p><h1 id="9541" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">结论</h1><p id="d9b5" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">我们探讨了在. NET核心应用程序中获取用户身份和声明的不同方法。我们用演示程序展示了处理索赔的简易性和复杂性。</p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h2 id="24c8" class="or mb it bd mc po pp dn mg pq pr dp mk li ps pt mm lm pu pv mo lq pw px mq py bi translated">喜欢这个帖子？与Dhyan联系</h2><p id="b496" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">让我们做朋友吧！你可以在<a class="ae ky" href="https://www.linkedin.com/in/dhyans/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上找到我或者在<a class="ae ky" href="https://dhyanintech.medium.com/membership" rel="noopener"> Medium </a>上<strong class="lb iu">加入</strong>我。</p></div></div>    
</body>
</html>