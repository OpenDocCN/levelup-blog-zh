<html>
<head>
<title>Saving UIColor and Array in CoreData Using Transformable</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Transformable在CoreData中保存UIColor和Array</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/saving-uicolor-and-array-in-coredata-using-transformable-4fb906d0a553?source=collection_archive---------7-----------------------#2020-06-29">https://levelup.gitconnected.com/saving-uicolor-and-array-in-coredata-using-transformable-4fb906d0a553?source=collection_archive---------7-----------------------#2020-06-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="412c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">哦，那么你已经在Swift中编写代码有一段时间了，你觉得自己就像拥有所有知识的绿巨人？您可能有过使用UserDefaults、Keychain或flex worthy持久存储(如文件系统)来持久存储数据的经验。然后你开始拿起CoreData，应该很容易吧？然后你发现你是绿巨人试图捡起雷神之锤。</p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="kt ku l"/></div></figure><p id="7890" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">关于漫威的介绍已经够多了，让我们开始吧。</p><h1 id="043e" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">入门指南</h1><p id="835b" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">首先创建一个项目。完整的源代码请点击<a class="ae ly" href="https://github.com/SamuelFolledo/CoreData-Transformable" rel="noopener ugc nofollow" target="_blank">这里</a></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi lz"><img src="../Images/04b61ce9b81130905989e89cc9c669ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b6T5JjNDr03tgnyRc6LSSg.png"/></div></div></figure><h2 id="c87f" class="mg kw it bd kx mh mi dn lb mj mk dp lf kb ml mm lj kf mn mo ln kj mp mq lr mr bi translated">xcdatamodeld</h2><p id="0088" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">Xcode为我们名为<code class="fe ms mt mu mv b">xcodeProjectName.xcdatamodeld</code>的CoreData文件提供了一个漂亮的可视化效果。现在让我们通过点击<code class="fe ms mt mu mv b">+</code>来添加一个人实体，并添加如下所示的属性。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi mw"><img src="../Images/462ca1c5dbed574fcf1e55e91cd9dcb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l3TxjhKVDc7vvUAWRCXxHw.png"/></div></div></figure><p id="3573" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">同样，点击人员实体→数据模型检查器→ Codegen，更改为<strong class="js iu">手动/无</strong>。因为我们将自己定制这是一个非常常见的做法。</p><h1 id="7ad6" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">可变形的</h1><p id="27b2" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">核心数据允许我们存储整数、布尔值、字符串、UUID、日期等。但有时我们希望存储特定的数据类型，如UIColor、UIImage、我们自己的类、struct或enum，甚至数组，但这根本不是属性类型中的选项。</p><p id="2c77" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">向<strong class="js iu">可转换的</strong>属性类型问好，它允许我们将自定义数据类型存储为实体记录的声明属性的对象。唯一的要求是我们的自定义类型应该符合<strong class="js iu"> NSCoding </strong>或者我们需要提供一个<strong class="js iu">自定义值转换器</strong>。</p><blockquote class="mx my mz"><p id="5114" class="jq jr na js b jt ju jv jw jx jy jz ka nb kc kd ke nc kg kh ki nd kk kl km kn im bi translated"><a class="ae ly" href="https://www.kairadiagne.com/2020/01/13/nssecurecoding-and-transformable-properties-in-core-data.html#:~:text=and%20object%20serialization.-,Transformable%20properties,by%20creating%20a%20Transformable%20property." rel="noopener ugc nofollow" target="_blank">当您将一个属性声明为</a> <code class="fe ms mt mu mv b"><a class="ae ly" href="https://www.kairadiagne.com/2020/01/13/nssecurecoding-and-transformable-properties-in-core-data.html#:~:text=and%20object%20serialization.-,Transformable%20properties,by%20creating%20a%20Transformable%20property." rel="noopener ugc nofollow" target="_blank">Transformable</a></code> <a class="ae ly" href="https://www.kairadiagne.com/2020/01/13/nssecurecoding-and-transformable-properties-in-core-data.html#:~:text=and%20object%20serialization.-,Transformable%20properties,by%20creating%20a%20Transformable%20property." rel="noopener ugc nofollow" target="_blank">时，核心数据会将您的自定义数据类型转换为二进制</a> <code class="fe ms mt mu mv b"><a class="ae ly" href="https://www.kairadiagne.com/2020/01/13/nssecurecoding-and-transformable-properties-in-core-data.html#:~:text=and%20object%20serialization.-,Transformable%20properties,by%20creating%20a%20Transformable%20property." rel="noopener ugc nofollow" target="_blank">Data</a></code> <a class="ae ly" href="https://www.kairadiagne.com/2020/01/13/nssecurecoding-and-transformable-properties-in-core-data.html#:~:text=and%20object%20serialization.-,Transformable%20properties,by%20creating%20a%20Transformable%20property." rel="noopener ugc nofollow" target="_blank">，并在保存到持久存储时将其转换回您的自定义数据类型。它通过一个价值转换器来实现这一点。</a></p></blockquote><p id="0aec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是一个非常有用的特性，但是我们必须小心使用它，特别是当我们使用可变类型作为可转换属性的值时。欲了解更多信息，请阅读这篇<a class="ae ly" href="https://medium.com/@rohanbhale/hazards-of-using-mutable-types-as-transformable-attributes-in-core-data-2c95cdc27088" rel="noopener">文章</a>。</p><p id="0e4d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以选择在这里指定您的属性的<code class="fe ms mt mu mv b">Custom Class</code>，或者它将默认为NSObject，当然，一旦我们创建了自己的NSManagedObject，我们就可以更改它。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi ne"><img src="../Images/c0a3844b197c98a5da59d38f5e9c55d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2zCjOe5VXzWYdMVIMNk3zQ.png"/></div></div></figure><h1 id="8a4b" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">正在创建NSManagedObject</h1><p id="2367" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">让我们通过单击选项卡编辑器→创建NSManagedObject子类来创建我们的NSManagedObject…</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi nf"><img src="../Images/04ec5457d85789bf69e31aa8e6c4399b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O-mqHPLeoV8F1zaeRA0CoQ.png"/></div></div></figure><p id="5911" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">确保选择了我们的数据模型并单击Next，然后确保选择了我们的Person实体并单击Next。指定要存储这些新文件的组目录，然后单击创建。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi ng"><img src="../Images/e6c3250f1e375126099a084912b53aab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x0ArT9eC7x-Ec8dVLRlw2Q.png"/></div></div></figure><p id="7453" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将为我们创建两个文件<code class="fe ms mt mu mv b">Person+CoreDataClass.swift</code>和<code class="fe ms mt mu mv b">Person+CoreDataProperties.swift</code>。现在转到<code class="fe ms mt mu mv b">Person+CoreDataProperties.swift</code>文件，你会看到favoriteColor是UIColor类型，因为我们指定了它，但是colors是NSObject类型。确保您的<code class="fe ms mt mu mv b">Person+CoreDataProperties.swift</code>文件看起来像这样…</p><pre class="ko kp kq kr gt nh mv ni nj aw nk bi"><span id="29ac" class="mg kw it mv b gy nl nm l nn no"><strong class="mv iu">import</strong> Foundation<br/><strong class="mv iu">import</strong> CoreData<br/><strong class="mv iu">import</strong> UIKit.UIColor //add this</span><span id="9b9d" class="mg kw it mv b gy np nm l nn no"><strong class="mv iu">extension</strong> Person {<br/>   <strong class="mv iu">@nonobjc</strong> <strong class="mv iu">public</strong> <strong class="mv iu">class</strong> <strong class="mv iu">func</strong> fetchRequest() -&gt; NSFetchRequest&lt;Person&gt; {<br/>      <strong class="mv iu">return</strong> NSFetchRequest&lt;Person&gt;(entityName: “Person”)<br/>   }<br/>   <strong class="mv iu">@NSManaged</strong> <strong class="mv iu">public</strong> <strong class="mv iu">var</strong> colors: [UIColor]? //update NSObject? to [UIColor]?<br/>   <strong class="mv iu">@NSManaged</strong> <strong class="mv iu">public</strong> <strong class="mv iu">var</strong> favoriteColor: UIColor?<br/>   <strong class="mv iu">@NSManaged</strong> <strong class="mv iu">public</strong> <strong class="mv iu">var</strong> name: String?<br/>}</span></pre><p id="3fd5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就像我之前提到的，我们可以通过将<code class="fe ms mt mu mv b">color</code>的数据类型改为【UIColor】来更新这些，并且不要忘记导入UIKit的UIColor。</p><h2 id="482e" class="mg kw it bd kx mh mi dn lb mj mk dp lf kb ml mm lj kf mn mo ln kj mp mq lr mr bi translated">CoreDataStack</h2><p id="f03e" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">复制这个简单的CoreDataStack</p><pre class="ko kp kq kr gt nh mv ni nj aw nk bi"><span id="5730" class="mg kw it mv b gy nl nm l nn no"><strong class="mv iu">import</strong> Foundation<br/><strong class="mv iu">import</strong> CoreData</span><span id="c174" class="mg kw it mv b gy np nm l nn no"><strong class="mv iu">class</strong> CoreDataStack {<br/>   <strong class="mv iu">private</strong> <strong class="mv iu">let</strong> modelName: String<br/>   <strong class="mv iu">init</strong>(modelName: String) {<br/>      <strong class="mv iu">self</strong>.modelName = modelName<br/>   }</span><span id="578e" class="mg kw it mv b gy np nm l nn no">   <strong class="mv iu">lazy</strong> <strong class="mv iu">var</strong> mainContext: NSManagedObjectContext = {<br/>      <strong class="mv iu">return</strong> <strong class="mv iu">self</strong>.storeContainer.viewContext<br/>   }()<br/>   <strong class="mv iu">private</strong> <strong class="mv iu">lazy</strong> <strong class="mv iu">var</strong> storeContainer: NSPersistentContainer = {<br/>      <strong class="mv iu">let</strong> container = NSPersistentContainer(name: <strong class="mv iu">self</strong>.modelName)<br/>      container.loadPersistentStores { (storeDescription, error) <strong class="mv iu">in<br/>         if</strong> <strong class="mv iu">let</strong> error = error <strong class="mv iu">as</strong> NSError? {<br/>            print("Unresolved error \(error), \(error.userInfo)")<br/>         }<br/>      }<br/>      <strong class="mv iu">return</strong> container<br/>   }()<br/>}</span><span id="2d06" class="mg kw it mv b gy np nm l nn no">// MARK:<strong class="mv iu"> Internal<br/>extension</strong> CoreDataStack {<br/>   <strong class="mv iu">func</strong> saveContext () {<br/>      <strong class="mv iu">guard</strong> mainContext.hasChanges <strong class="mv iu">else</strong> { <strong class="mv iu">return</strong> }<br/>      <strong class="mv iu">do</strong> {<br/>         <strong class="mv iu">try</strong> mainContext.save()<br/>      } <strong class="mv iu">catch</strong> <strong class="mv iu">let</strong> nserror <strong class="mv iu">as</strong> NSError {<br/>         fatalError("Unresolved error \(nserror), \(nserror.userInfo)")<br/>      }<br/>   }<br/>}</span></pre><p id="b7e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，像平常一样加载和保存…</p><pre class="ko kp kq kr gt nh mv ni nj aw nk bi"><span id="7d80" class="mg kw it mv b gy nl nm l nn no"><strong class="mv iu">func</strong> loadPerson() {<br/>   <strong class="mv iu">let</strong> personFetchRequest: NSFetchRequest&lt;Person&gt; = Person.fetchRequest() //make a Person Entity fetch request<br/>   <strong class="mv iu">do</strong> {<br/>      <strong class="mv iu">let</strong> results = <strong class="mv iu">try </strong>coreDataStack.mainContext.fetch(personFetchRequest)<br/>      <strong class="mv iu">if</strong> results.count &gt; 0 { //found a person<br/>         person = results.first<br/>      } <strong class="mv iu">else</strong> { //no person found<br/>         person = Person(context: coreDataStack.mainContext)<br/>         coreDataStack.saveContext()<br/>      }<br/>   } <strong class="mv iu">catch</strong> <strong class="mv iu">let</strong> error <strong class="mv iu">as</strong> NSError {<br/>   print("Error: \(error) description: \(error.userInfo)")<br/>   }<br/>}</span><span id="efe7" class="mg kw it mv b gy np nm l nn no"><strong class="mv iu">func</strong> handleSavePerson() {<br/>   <strong class="mv iu">guard</strong> <strong class="mv iu">let</strong> name = nameTextField.text, !name.isEmpty <strong class="mv iu">else</strong> { <strong class="mv iu">return</strong> }<br/>   person!.name = name<br/>   person!.colors = [.red, .orange, .yellow, .green, .blue, .purple]<br/>   person!.favoriteColor = person!.favoriteColor<br/>   //save the managed object context<br/>   <strong class="mv iu">do</strong> {<br/>      <strong class="mv iu">try</strong> coreDataStack.mainContext.save()<br/>   } <strong class="mv iu">catch</strong> <strong class="mv iu">let</strong> error <strong class="mv iu">as</strong> NSError {<br/>      print("Error: \(error), description: \(error.userInfo)")<br/>   }<br/>}</span></pre><p id="f6af" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就是这样！背景应该是白色的第一次运行应用程序。此外，输入姓名、选择颜色并单击保存将会更新CoreData中此人的属性。重新运行应用程序，你会在文本栏上看到你的名字，背景颜色也不会改变。</p><div class="ko kp kq kr gt ab cb"><figure class="nq ks nr ns nt nu nv paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><img src="../Images/9457eb4bd42aff9b73975b67a83239c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*HJ70uoFDA1f-kyHnsFp5Nw.png"/></div></figure><figure class="nq ks nw ns nt nu nv paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><img src="../Images/8d6a32d5e0d6421c630d73375a37aa5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*OWIzQ8OZazgjv0mtPTk1xg.png"/></div></figure></div><p id="0f9f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">作为一个额外的挑战，尝试在CoreData中存储一个UIImage，当然是可转换的。您可以在这里找到源代码。</p><p id="5a4b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">享受编码！😁</p><p id="b191" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">外部链接</p><ul class=""><li id="1d0d" class="nx ny it js b jt ju jx jy kb nz kf oa kj ob kn oc od oe of bi translated"><a class="ae ly" href="https://www.kairadiagne.com/2020/01/13/nssecurecoding-and-transformable-properties-in-core-data.html#:~:text=and%20object%20serialization.-,Transformable%20properties,by%20creating%20a%20Transformable%20property." rel="noopener ugc nofollow" target="_blank">核心数据中的NSSecureCoding和transformable属性</a></li><li id="9a56" class="nx ny it js b jt og jx oh kb oi kf oj kj ok kn oc od oe of bi translated"><a class="ae ly" href="https://medium.com/@rohanbhale/hazards-of-using-mutable-types-as-transformable-attributes-in-core-data-2c95cdc27088" rel="noopener">在核心数据中使用可变类型作为可转换属性的危害</a></li><li id="795c" class="nx ny it js b jt og jx oh kb oi kf oj kj ok kn oc od oe of bi translated"><a class="ae ly" href="https://github.com/SamuelFolledo/CoreData-Transformable" rel="noopener ugc nofollow" target="_blank">完整源代码</a></li><li id="98a6" class="nx ny it js b jt og jx oh kb oi kf oj kj ok kn oc od oe of bi translated"><a class="ae ly" href="https://www.makeschool.com/portfolio/samuelfolledo" rel="noopener ugc nofollow" target="_blank">我的制作学校作品集</a></li></ul></div></div>    
</body>
</html>