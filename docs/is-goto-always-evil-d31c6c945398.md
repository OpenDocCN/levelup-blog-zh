# 后藤一直是邪恶的吗？

> 原文：<https://levelup.gitconnected.com/is-goto-always-evil-d31c6c945398>

## c 程序设计

## 标记分支使 C 代码更好的情况

![](img/ccfe6dcd71c7138abbc4cc04777b4290.png)

特雷弗·科尔在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

1968 年，Edgar Dijkstra 写了一篇有影响力的文章[去声明被认为是有害的。他认为无条件分支的使用，也就是通常所说的`goto`语句，应该从高级编程语言中废除。](https://homepages.cwi.nl/~storm/teaching/reader/Dijkstra68.pdf)

对`goto`声明的敌意是理所应当的。每一个用 FORTRAN 的基本或更老的方言编程的人都在纠结于错综复杂的逻辑。充斥着交织在一起的`goto`语句网络的密集语句序列很难理解，甚至更难维护。

大多数时候，使用块结构编程更优雅。像`if`、`while`和`switch`这样的构造使你的代码意图清晰。

然而，在 Dijkstra 的废奴宣言发表 50 多年后，C 和其他语言仍然包含一个`goto`语句。虽然`goto`仍然是禁忌，但它的使用仍然是可能的。`goto`有过正当理由吗？它应该从地球上彻底消失吗？

我认为在 C 程序中有些情况下`goto`是有帮助的。

无条件分支是一种工具。有些工具，如链锯，是危险的。我们不希望人们到处乱跑，肆无忌惮地挥舞电锯。这并不意味着链锯应该被禁止。有些情况下，谨慎使用电锯是最好的选择。

`goto`什么时候是明智的选择？这里有两个它有价值的场景。

## 退出多个嵌套循环

c 和其他编程语言认识到尽早离开循环的普遍需要。c 为此提供了`break`语句。`break`语句是`goto`的变体。它是一个无条件的分支，从其包含的`for`、`while`或`switch`中跳出，而不是跳到一个显式标签。

有时我们想跳出不止一个嵌套循环。假设我们继承了一些打印 3 乘 3 整数数组内容的代码:

现在假设我们有了一个新的要求，如果任何数组元素是负的，我们必须立即停止打印任何东西。我们想打破两个循环。

可以使用一个标志来避免`goto`，就像这样:

但是处理这种情况更好的方法是使用一个退出两个循环的`goto`:

这比之前版本的代码更简洁，也更容易理解。它说明了它的含义。它用较少的概念开销来表达思想。

## 统一清理逻辑

c 程序必须检测和处理错误。当错误发生时，重要的是在清理任何悬空资源的同时退出。代码应该关闭所有打开的文件并释放所有分配的内存。

假设你的任务是编写一个从文件中读取文本行的 C 程序。每一行应该包含三个浮点数。该程序必须乘以每行的三个数字，并打印所有产品的总和，使用格式`SUM=*sum*`。

还假设您的程序需要打印`BAD INPUT`,如果任何输入行不包含三个有效的浮点数，则中止。不管怎样，你的程序应该总是通过释放内存和关闭输入文件来进行清理。

这里显示了实现该程序的一种方法。这是一个符合所有要求的正确实现。

这段代码有些令人不快。它重复清理逻辑:三个位置的空闲内存分配给`line`，两个位置关闭`infile`。这些冗余违反了 DRY 原则— [不要重复自己](https://en.wikipedia.org/wiki/Don%27t_repeat_yourself)。

假设有一天，您添加了另一个需要在每个停止点清理的资源:可能是一个要关闭的输出文件，或者是另一个要释放的内存块。您必须研究代码，找到所有的错误案例，并在每个案例中插入清理逻辑。

有更好的方法。你猜对了——这涉及到`goto`。这不仅仅是我的观点。这种方法是 Linux 内核编码风格指南推荐的。这个想法是让一个函数有一个单一的出口点，位于末端，所有的清理都在一个地方。以下是以这种方式编写的相同程序的外观。

这段代码更容易审查。很明显，无论如何，`line`都将被释放，`infile`将被关闭。错误处理模式确保`line`和`infile`总是有定义的值:或者是`NULL`或者是一个有效的指针。清理代码只有在`infile`打开时才会关闭。也是利用了`free(NULL)`是安全的，没有效果。

同样，假设您想要添加另一个必须清理的资源。这一次，你的任务会更简单。您将资源初始化为一个安全值，然后尝试打开/分配它，如果尝试失败，添加一个`goto fail`，并在函数底部插入清理逻辑。无论函数成功还是发生任何错误，您都可以高枕无忧，因为您知道将会执行额外的资源清理。

## 经验法则

一般来说，在大多数情况下避免使用`goto`是个好主意。在 C 程序中使用`goto`之前，问自己几个问题。

这种用法可能会产生意外的循环吗？一般来说，在代码中只使用`goto`向下跳转。避免用`goto`向后跳。这样做是朝着意大利面条逻辑的方向前进。如果需要迭代，尽量使用`while`或者`for`。

永远不要从外部代码块跳到代码块的中间。例如，下面的代码很难理解。它只是要求随着时间的推移，随着更改的进行，错误会慢慢出现。不要这样！

一般来说，在使用`goto`之前，考虑是否是时候重构你的代码了。如果你有嵌套循环，有时你需要打破，你能把它们提取到自己的函数中吗？如果是这样的话，你可以早点从那个函数返回，而不是跳出循环。

我的总体观点是，我见过一些人为了避免`goto`而走极端，在这个过程中创造了更丑陋、更复杂的代码。编程是工程，不是宗教。使用`goto`并不“脏”是的，它是一个潜在的危险工具。经验表明，轻率地使用这一工具会导致灾难。

但偶尔，`goto`是解决问题最优雅的方式。相信你的判断。使用合适的工具完成工作。尽一切努力让你的代码尽可能清晰优雅，然后昂首挺胸。