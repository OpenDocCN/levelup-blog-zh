<html>
<head>
<title>How to Wrap a Browser Game in a Firefox Extension</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Firefox扩展中包装浏览器游戏</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-wrap-a-browser-game-in-a-firefox-extension-360e3692c5c9?source=collection_archive---------17-----------------------#2022-08-16">https://levelup.gitconnected.com/how-to-wrap-a-browser-game-in-a-firefox-extension-360e3692c5c9?source=collection_archive---------17-----------------------#2022-08-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="dde4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在一个插件中构建一个HTML5游戏，将数据保存到玩家的浏览器中</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8ad7fd31938bd2c55fc0951e44bb7906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l2sFlzZrs_b5XYlBWABXwQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">血细胞游戏截图，图片作者</figcaption></figure><p id="18ff" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当构建简单的游戏时，使用JavaScript和HTML5允许我们利用web浏览器的能力和多功能性来做许多繁重的工作，包括制作游戏动画和在不同的操作系统之间分发游戏。然而，如果我们想在会话之间保存玩家的游戏数据(例如，高分或游戏进度)，浏览器游戏会出现一个两难的问题:如果我们不想要维护后端web服务器的麻烦和费用，我们应该在哪里存储数据？</p><p id="2ba7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">令人高兴的是，浏览器扩展提供了一个解决方案，因为在扩展中包装游戏允许我们方便地访问用户的本地浏览器存储，以保存他们的个人游戏数据。这样，我们不需要承担收集和安全存储用户数据的工作和责任，也不需要担心数据在会话之间从他们的浏览器缓存中删除。</p><p id="9627" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">本教程将特别关注构建一个Firefox浏览器扩展，其中包含一个将游戏结果数据保存到本地存储的简单游戏，以我的血细胞游戏为例。作为参考，这款游戏的完整源代码可以在GitLab <a class="ae lr" href="https://gitlab.com/karldeve/bloodcellgame" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="2817" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请注意，本教程不会涵盖HTML5浏览器游戏开发的基础知识，但是Mozilla开发者网络提供了该主题的介绍<a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Games/Tutorials/2D_Breakout_game_pure_JavaScript" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="1ef1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">概述</strong></p><p id="028e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们的示例扩展将在浏览器的工具栏上添加一个按钮，单击该按钮将在新标签页中启动一个游戏。该扩展名由几个不同的文件组成:</p><ol class=""><li id="38ca" class="ls lt iq kx b ky kz lb lc le lu li lv lm lw lq lx ly lz ma bi translated"><code class="fe mb mc md me b">manifest.json</code>:这个文件提供了扩展使用的元数据，包括需要的权限，后台运行的脚本，启动游戏的按钮定义。</li><li id="f740" class="ls lt iq kx b ky mf lb mg le mh li mi lm mj lq lx ly lz ma bi translated"><code class="fe mb mc md me b">launch_blood_cell.js</code>:这个脚本监听游戏工具栏上的按钮被按下的情况，并在按钮被按下时启动游戏。</li><li id="0f68" class="ls lt iq kx b ky mf lb mg le mh li mi lm mj lq lx ly lz ma bi translated"><code class="fe mb mc md me b">bloodcell.html</code>:这个文件定义了包含游戏的网页。</li><li id="6638" class="ls lt iq kx b ky mf lb mg le mh li mi lm mj lq lx ly lz ma bi translated"><code class="fe mb mc md me b">bloodcell.js</code>:这个脚本包含游戏逻辑，包括从本地存储器读取和写入的代码。</li></ol><p id="7e82" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">货单</strong></p><p id="db88" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在<code class="fe mb mc md me b">manifest.json</code>文件中，我们需要填写几个关键字段:</p><ol class=""><li id="7e93" class="ls lt iq kx b ky kz lb lc le lu li lv lm lw lq lx ly lz ma bi translated">这个字段将定义启动游戏的按钮，通过指定添加它的位置(tabstrip)，使用什么图标，以及当我们悬停在它上面时应该出现什么标题</li><li id="dd4e" class="ls lt iq kx b ky mf lb mg le mh li mi lm mj lq lx ly lz ma bi translated"><code class="fe mb mc md me b">permissions</code>:该字段指定扩展需要什么特殊权限。在这种情况下，我们需要<code class="fe mb mc md me b">storage</code>权限才能写入本地存储。</li><li id="d85b" class="ls lt iq kx b ky mf lb mg le mh li mi lm mj lq lx ly lz ma bi translated"><code class="fe mb mc md me b">background</code>:该字段指定该浏览器将在后台运行哪些脚本。在我们的例子中，我们需要在后台运行我们的<code class="fe mb mc md me b">launch_blood_cell.js</code>脚本来观察按钮点击。</li></ol><p id="67a0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下是完整清单文件的示例，包括上述字段:</p><pre class="kg kh ki kj gt mk me ml mm aw mn bi"><span id="b7bc" class="mo mp iq me b gy mq mr l ms mt">{<br/>  "manifest_version": 2,<br/>  "name": "Blood Cell Game",<br/>  "version": "1.0",</span><span id="07af" class="mo mp iq me b gy mu mr l ms mt">"description": "A browser game in which you are a white blood cell hunting for the one infected red blood cell. The infected cell uses an evolutionary algorithm to gradually adopt strategies that work best against you, so the game gets harder as you get better.",<br/> "icons": {<br/>  "48": "icons/BloodCellLogo-48.png"<br/> },</span><span id="5be9" class="mo mp iq me b gy mu mr l ms mt">"browser_action": {<br/>  "default_area": "tabstrip",<br/>  "default_icon": "icons/BloodCellLogo-32.png",<br/>  "default_title": "Blood Cell"<br/> },</span><span id="90bb" class="mo mp iq me b gy mu mr l ms mt">"background": {<br/>  "scripts": ["launch_blood_cell.js"]<br/> },</span><span id="e352" class="mo mp iq me b gy mu mr l ms mt">"permissions": [<br/>  "storage"<br/> ]</span><span id="44b2" class="mo mp iq me b gy mu mr l ms mt">}</span></pre><p id="b295" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">启动游戏</strong></p><p id="8f21" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我们的<code class="fe mb mc md me b">launch_blood_cell.js</code>文件中，我们需要观察扩展的按钮何时被点击，这可以使用<code class="fe mb mc md me b"><a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/browserAction/onClicked" rel="noopener ugc nofollow" target="_blank">browser.browserAction.onClicked.addListener</a></code> <a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/browserAction/onClicked" rel="noopener ugc nofollow" target="_blank">方法</a>来完成。我们可以为这个方法提供一个函数，当按钮被点击时，这个函数将被调用。在我们的例子中，我们将提供<code class="fe mb mc md me b">launchGame</code>函数，它将创建一个新的选项卡，指向扩展中的<code class="fe mb mc md me b">bloodcell.html</code>文件。</p><p id="2a6b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，在启动新标签页后，我们的<code class="fe mb mc md me b">launchGame</code>函数可以调用我们的<code class="fe mb mc md me b">onCreated</code>函数，这将在新标签页中执行我们的<code class="fe mb mc md me b">bloodcell.js</code>游戏逻辑脚本。注意，出于安全考虑，Firefox不允许在我们的<code class="fe mb mc md me b">bloodcell.html</code>文件中直接嵌入JavaScript，但是使用<code class="fe mb mc md me b"><a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript" rel="noopener ugc nofollow" target="_blank">browser.tabs.executeScript</a></code> <a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript" rel="noopener ugc nofollow" target="_blank">方法</a>允许我们触发指定选项卡的脚本。</p><pre class="kg kh ki kj gt mk me ml mm aw mn bi"><span id="1f83" class="mo mp iq me b gy mq mr l ms mt">/**<br/> * Run game code in new tab<br/> */<br/>function onCreated(tab) {<br/>  console.log(`Launching Blood Cell browser game in tab ${tab.id}...`);<br/>  browser.tabs.executeScript(tab.id, {file: "bloodcell.js"})<br/>}</span><span id="e5b4" class="mo mp iq me b gy mu mr l ms mt">/**<br/> * Log error to the console.<br/> */<br/>function onError(error) {<br/>  console.log(`Error: ${error}`);<br/>}</span><span id="a177" class="mo mp iq me b gy mu mr l ms mt">/**<br/> * Opens a new tab to play Blood Cell game.<br/> */<br/>function launchGame() {<br/>  var creating = browser.tabs.create({url:"/bloodcell.html"});<br/>  creating.then(onCreated, onError);<br/>}</span><span id="e2f1" class="mo mp iq me b gy mu mr l ms mt">/**<br/> * Listen for extension button clicks<br/> */<br/>browser.browserAction.onClicked.addListener(launchGame);</span></pre><p id="cd13" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">此时，假设我们的<code class="fe mb mc md me b">bloodcell.html</code>文件包含一个<a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/canvas" rel="noopener ugc nofollow" target="_blank"> HTML画布</a>并且我们的<code class="fe mb mc md me b">bloodcell.js</code>脚本包含相关的游戏逻辑，我们可以在浏览器扩展中启动并玩游戏。</p><p id="9f6c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">如何从浏览器扩展访问本地存储器</strong></p><p id="e45c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于我的血细胞游戏，我使用一个简单的进化算法，让游戏随着时间的推移变得更难。不过，要做到这一点，我需要将游戏结果和策略保存到本地存储，并在新游戏启动时检索这些值。我们可以使用<a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage/local" rel="noopener ugc nofollow" target="_blank">本地存储API </a>来实现这一点。</p><p id="b1c6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，在包含游戏逻辑的<code class="fe mb mc md me b">bloodcell.js</code>脚本中，我们将使用<code class="fe mb mc md me b"><a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage/StorageArea/get" rel="noopener ugc nofollow" target="_blank">local.get</a></code> <a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage/StorageArea/get" rel="noopener ugc nofollow" target="_blank">方法</a>检索已经存在于我们的扩展存储中的内容(第一次运行游戏时，这将是空的，但之后我们应该保存策略值和结果)。如果我们只想从存储中获取某些项目，这个方法接受键作为输入，但是在我们的例子中，我们想要所有的东西，所以我们可以在没有输入的情况下调用这个方法。</p><pre class="kg kh ki kj gt mk me ml mm aw mn bi"><span id="6689" class="mo mp iq me b gy mq mr l ms mt">const gettingStoredGeneration = browser.storage.local.get();<br/>gettingStoredGeneration.then(opponentInit, onError);</span></pre><p id="8c78" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦我们从存储器中读取数据，我们就调用我们的<code class="fe mb mc md me b">opponentInit</code>函数，它将处理我们获取的内容(如果有的话)。</p><p id="5564" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，我们将检查是否从存储中取出了我们想要的对象。如果不是(即如果<code class="fe mb mc md me b">!storedGeneration.strat</code>，那么我们将假设这是第一次启动游戏，并使用预设值和<a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage/StorageArea/set" rel="noopener ugc nofollow" target="_blank"> local.set方法</a>初始化存储。如果已经有数据存在，那么我们可以用它来设置我们当前游戏的最新策略。</p><pre class="kg kh ki kj gt mk me ml mm aw mn bi"><span id="17d4" class="mo mp iq me b gy mq mr l ms mt">// set initial strategies for first time game is launched<br/>var strat = {<br/> changeProb: [0.02, 0.005, 0.005, 0.005, 0.005, 0.005, 0.005, 0.005, 0.005, 0.005],<br/> frontProb: [0.9, 0.9, 0.9, 0.75, 0.5, 0.5, 0.5, 0.25, 0.5, 0.5], <br/> closenessfactor: [0.1, 0.1, 0.1, 0.15, 0.15, 0.25, 0.5, 0.1, 0.75, 0.9],<br/> distAttack: [2, 2, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5],<br/> distAttackExtended: [5, 5, 2, 2, 2, 2, 2, 2, 2, 3],<br/> outcome: [-1, -1, -1, -1, -1, -1, -1, -1, -1, -1]<br/>};</span><span id="846d" class="mo mp iq me b gy mu mr l ms mt">/*<br/> Load 'strategy' variables for infected RBC from storage, or load initial values if first time game being played<br/>*/<br/>function opponentInit(storedGeneration) {<br/>  if (!storedGeneration.strat) {<br/>   // init strategy in storage if doesn't exist<br/>    browser.storage.local.set({strat});<br/>    stratNum = 0;<br/>  }<br/>  else {<br/>   // otherwise grab first strategy that hasn't been played, if exists<br/>   strat = storedGeneration.strat;<br/>   for(var i = 0; i &lt; numPerGen; i++) {<br/>    if(strat.outcome[i] == -1) {<br/>     stratNum = i;<br/>     break;<br/>    }<br/>   }<br/>   if(stratNum == -1) {<br/>    // if all existing strategies have been played, generate next set of strategies<br/>    nextGen();<br/>   }<br/>  }<br/>  setStratVars();<br/>}</span></pre><p id="6008" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当我们的游戏结束并且我们准备好存储结果时，或者如果我们用我们的进化算法生成一组新的策略，我们可以使用用于存储上述初始策略集的相同的<a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage/StorageArea/set" rel="noopener ugc nofollow" target="_blank"> local.set方法</a>将这些值保存回本地存储。</p><p id="10b9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">结论</strong></p><p id="92ce" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">通过本地存储API，Firefox浏览器扩展提供了一种构建和分发免费浏览器游戏的便捷方式，这种游戏可以在会话之间保存数据，而不会让游戏开发爱好者觉得这是第二份工作。游戏开始。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/5b5d187d6e366dd6776d6402c860527b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gCadhtbIGlVfS2-oxC16UA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</figcaption></figure><p id="8fbe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">资源</strong></p><p id="e7b3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">血细胞浏览器扩展源代码:【https://gitlab.com/karldeve/bloodcellgame T4】</p><p id="0cd7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">MDN HTML5/JavaScript游戏教程:<a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Games/Tutorials/2D_Breakout_game_pure_JavaScript" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Games/Tutorials/2D _ Breakout _ game _ pure _ JavaScript</a></p><p id="00a5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">MDN浏览器扩展教程:<a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Your_first_WebExtension" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Mozilla/Add-ons/web extensions/Your _ first _ web extension</a></p><p id="14d7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">本地存储API文档:<a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage/local" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Mozilla/Add-ons/web extensions/API/storage/local</a></p></div><div class="ab cl mw mx hu my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ij ik il im in"><h1 id="7a53" class="nd mp iq bd ne nf ng nh ni nj nk nl nm jw nn jx no jz np ka nq kc nr kd ns nt bi translated">分级编码</h1><p id="6ac2" class="pw-post-body-paragraph kv kw iq kx b ky nu jr la lb nv ju ld le nw lg lh li nx lk ll lm ny lo lp lq ij bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="b815" class="ls lt iq kx b ky kz lb lc le lu li lv lm lw lq nz ly lz ma bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="ac1e" class="ls lt iq kx b ky mf lb mg le mh li mi lm mj lq nz ly lz ma bi translated">📰查看<a class="ae lr" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="4a2b" class="ls lt iq kx b ky mf lb mg le mh li mi lm mj lq nz ly lz ma bi translated">🔔关注我们:<a class="ae lr" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae lr" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae lr" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="6f60" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">🚀👉<a class="ae lr" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kx ir">加入人才集体，找到一份令人惊喜的工作</strong> </a></p></div></div>    
</body>
</html>