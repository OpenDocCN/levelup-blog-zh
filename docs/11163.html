<html>
<head>
<title>CI/CD practices in crypto trading (part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">加密交易中的CI/CD实践(下)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/ci-cd-practices-in-crypto-trading-part-2-1b504c620d45?source=collection_archive---------12-----------------------#2022-02-21">https://levelup.gitconnected.com/ci-cd-practices-in-crypto-trading-part-2-1b504c620d45?source=collection_archive---------12-----------------------#2022-02-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c71f94254f51c61792e80a2a34b735d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wB-PPrYtIiHt4j8y"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Pierre Borthiry 在<a class="ae kc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="164d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://medium.com/@vadim.barilo/ci-cd-practices-in-crypto-trading-part-1-7bee5dac75e1" rel="noopener">在本次旅程的第一部分</a>，我们设计了战略验证管道的初始阶段，重点是内部行为检查和整体真空战略盈利能力衡量。</p><p id="2665" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中包括:</p><ul class=""><li id="89ca" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">策略类定义与开发团队(林挺)定义的代码质量规则相匹配</li><li id="f546" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">策略行为特征匹配预定义的用例(单元测试)</li><li id="cae6" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">基于历史数据的战略执行符合定义的盈利能力阈值</li></ul><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/2ea25ed7bbddb9bb6f0162107bd0bb0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ScGXmCn7HplhZf6c.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">持续集成管道</figcaption></figure><p id="a839" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是提醒一下——如果我们可以开始交易并看到战略盈利能力，我们为什么要做这些？正是因为相反的原因——避免使用低效的算法进行交易。这里的“低效”是指算法没有通过利益相关者和主题专家的检查，并且显示的结果低于定义的阈值。</p><p id="04a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦特性提案被接受，下一步就是使用一个发布系列将它提升到一个类似prod的环境中，以进行更健壮的验证。需要它来确保“真空”验证满足现实世界的挑战。</p><h2 id="f134" class="lu lv iq bd lw lx ly dn lz ma mb dp mc ko md me mf ks mg mh mi kw mj mk ml mm bi translated">释放列车</h2><p id="e477" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">release train的必要性是以最小的开发和跨团队协议成本，自动将代码从多个分布式团队提升到定义的环境。在我们的例子中，“代码”可以理解为“策略”。</p><p id="71af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，主题敏感性需要一个避免敏感数据暴露和错误配置的人工无误的提升过程。</p><p id="601a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要至少3个环境来让一个新策略被完全采纳。这里的“采纳”是指我们可以长期信赖的战略设计。</p><p id="312b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些环境是:</p><ul class=""><li id="b849" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><em class="ms">测试</em>:策略以“模拟”模式运行，没有连接实际投资组合</li><li id="b755" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><em class="ms">沙盒</em>:策略以“实时”模式运行，投资组合权重显著降低(更小的持股量和更小的未平仓交易限额)</li><li id="4c99" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><em class="ms"> Prod </em>:战略以“实时”模式运行，在更加稳定和高度安全的环境中具有所需的投资组合权重(增加的资源和更好的云可用性特征、基于角色的访问受限的专用虚拟网络，以及零信任架构)。</li></ul><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/b3a045adc2e6b208bcd37f50165b3e22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ECMAo5vixS9TGkEkTQgxeg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">连续输送管道</figcaption></figure><p id="3940" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">显然，我们的最终目标是将一个策略提升到PROD环境中进行长期执行。这可以自动发生(通过在指定的时间范围内监控实际执行)或手动发生。</p><p id="f8ce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每个环境监控策略的有效性，并使用这个统计数据来决定它的命运——是进一步提升还是回退。</p><h2 id="2508" class="lu lv iq bd lw lx ly dn lz ma mb dp mc ko md me mf ks mg mh mi kw mj mk ml mm bi translated"><strong class="ak">提升到测试环境</strong></h2><p id="a6c8" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">一旦新的策略提案符合所有质量要求，创建的拉动式请求就可以在主分支中进行合并，并且“合并”按钮被激活。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="ab gu cl mu"><img src="../Images/825684a185c6ff912492345184f38aaf.png" data-original-src="https://miro.medium.com/v2/format:webp/1*DUSMrkkDSY1e3M3yrA1xpw.png"/></div></figure><p id="78d5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们进行一次合并，这将触发CD管道中下一阶段的开始—部署到测试环境。</p><p id="71d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接受这个话题的敏感性和违反安全需求的严重后果(可能的金钱损失)——我们将避免使用公共云基础设施来引导测试平台。让我们在下一篇文章中为数字资产交易设计一个零信任网络的解决方案，但现在保持它与外部访问完全隔离。</p><p id="93d7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">幸运的是，<a class="ae kc" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> github actions </a>可以通过提供对内部平台的支持来帮助解决这个问题。我们可以在私有基础设施中注册自己的运行器，一旦触发了适当的存储库事件，它将接收执行请求(在我们的例子中，将代码合并到主生产分支)。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/83f4dfeb1513dd0bb5190ea1e3b521a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7BmlUdQguGQse-whhz6B4g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">定制滑槽</figcaption></figure><p id="c0bb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将使用我的<strong class="kf ir"> RaspberryPi </strong>设备，上面有docker引导程序。此外，需要按照<a class="ae kc" href="https://docs.github.com/en/actions/hosting-your-own-runners/adding-self-hosted-runners" rel="noopener ugc nofollow" target="_blank">详细说明</a>安装作业滑槽。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/10b2bb480eac48243ba04988aa3d0556.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N07pJarT_5_3kwZi37HxyQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">把一个策略提升到覆盆子并运行</figcaption></figure><p id="7d23" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是如何区分——特定的运行环境将使用什么样的特定策略配置。我们最不希望的就是硬编码特定于环境的配置并将其存储在存储库中——这至少是不安全的。</p><p id="7bc3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们遵循<a class="ae kc" href="https://12factor.net/" rel="noopener ugc nofollow" target="_blank"> 12因素方法</a>并使用针对每个环境的单独配置，为所有环境部署一个免配置代码库。Github可以通过使用<a class="ae kc" href="https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment" rel="noopener ugc nofollow" target="_blank">环境支持</a>公共(或付费私有)存储库来帮助满足这个需求。</p><p id="b9b5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在创建测试环境之后，我们可以声明特定于环境的配置选项，这些选项将通过环境变量在定制的运行器上被访问。我们至少需要最少的配置选项:</p><ul class=""><li id="27a0" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><em class="ms">模拟运行</em> —运行模式，TRUE表示策略连接到虚拟化产品组合(不使用实际用户帐户)</li><li id="77bd" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><em class="ms">交换访问密钥</em> —用户投资组合访问密钥</li><li id="bbc2" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><em class="ms">交换访问密码</em> —用户投资组合访问密码</li><li id="b029" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><em class="ms">交换名称</em> —不言自明</li></ul><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/57edf1856d244e9bc2729eb733e7b394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I7m_2xdy8BqEa16dk2rP4w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">配置环境</figcaption></figure><h2 id="b363" class="lu lv iq bd lw lx ly dn lz ma mb dp mc ko md me mf ks mg mh mi kw mj mk ml mm bi translated">提升到沙盒环境</h2><p id="6835" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">到目前为止一切顺利。我们有一个部署到测试环境中的策略，该测试环境一直在模拟运行模式下运行，以收集其自身的盈利能力指标。另一个“好”——环境之间的所有差异都在于它们的配置，而不在于特定于环境的策略设计。</p><p id="10dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在可以检查运行的统计数据，以决定在发布系列中进一步提升它，或者回滚到审查和改进。</p><p id="13ec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于沙盒环境已经是一个您可能会失去金钱的地方，因为它需要一些投资组合来连接，所以首选的方法是避免自动提升，而是将此决策的责任交给产品所有者。以后的任何时候促销程序都可以完全自动化。</p><p id="6033" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么什么是开始推广的好事件呢？我会选择“release tag created”作为要响应的事件。它还有以下好处:</p><ul class=""><li id="f312" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">新的发布标签表明解决方案通过了所有的需求检查</li><li id="b1ce" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">可以仅对特定角色(例如，仅“项目管理员”中的用户)进行保护，以将责任仅赋予特定的一组人。</li><li id="5671" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">因为它需要手动操作，所以它基于其他观察来指示交付的代码增量的某种信任状态</li></ul><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/fed11f97b5792129292ed0a27386a283.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cpdL7xe3xRANckwRX-i9Fw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">创建发布标签</figcaption></figure><p id="4fc4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">发布创建事件将触发一个提升管道，该管道将使用当前工件作为沙盒环境中strategy runner的源。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/b9342dd1a7b5940689721f6a13395e16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ul53XdhmSBgxz6uavMgb0w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">释放到沙盒</figcaption></figure><p id="67f8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用同一个runner，这是唯一应用的另一个配置:使用有效的用户凭证访问exchange API的实时运行。</p><p id="8330" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">瞧，在类似生产的环境中，策略会在一段时间内启动，并在电报中发出关于其健康状态的信号。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/8f5534493591b7c8fb28947436fcd230.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SriXw661tNLRQs2ud1ay1Q.png"/></div></div></figure><h2 id="77a0" class="lu lv iq bd lw lx ly dn lz ma mb dp mc ko md me mf ks mg mh mi kw mj mk ml mm bi translated">工具集:</h2><ul class=""><li id="058c" class="lb lc iq kf b kg mn kk mo ko nb ks nc kw nd la lg lh li lj bi translated"><a class="ae kc" href="https://www.freqtrade.io/en/stable/docker_quickstart/" rel="noopener ugc nofollow" target="_blank"> Freqtrade在docker </a>进行战略执行</li><li id="6d1a" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">https://github.com/features/actions的<a class="ae kc" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank">自动送货</a></li><li id="ab77" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><a class="ae kc" href="https://github.com" rel="noopener ugc nofollow" target="_blank">https://github.com</a>为协同开发模式</li><li id="5d54" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">安装了<a class="ae kc" href="https://docs.docker.com/engine/install/debian/" rel="noopener ugc nofollow" target="_blank">对接引擎</a>的RaspberryPI</li><li id="f39a" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">电报机器人与策略运行时通信</li></ul><h2 id="a8db" class="lu lv iq bd lw lx ly dn lz ma mb dp mc ko md me mf ks mg mh mi kw mj mk ml mm bi translated">步骤5:可观察性(监控和警报)</h2><p id="a143" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我们已经可以放松下来，观察战略执行了。它需要一些时间来收集历史数据，以证明或反对其效率。</p><p id="9247" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，如何自动收集这些数据作为数据点，然后将它们聚合起来，在某个监控工具中可视化策略效率呢？</p><p id="d963" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它的有效性可以作为时间的函数来衡量。如果我们可以定义它(例如，一段时间内的平衡、一段时间内的胜率等。)，然后我们可以收集数据点，计算结果，并将其盈利能力可视化为该数据的函数。</p><p id="4189" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，定义的业务指标有助于做出在环境堆栈中向前或向后移动策略的决策(例如，如果结果在指定的时间范围内稳定，则从“SAND”移动到“PROD”)。多功能监控和改进的健康检查也是保持strategy runner处于健康状态的先决条件。</p><p id="c282" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是让我们在这里暂停一下，因为这个帖子变得太大了，并且在另一个方面过饱和了。</p></div></div>    
</body>
</html>