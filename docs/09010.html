<html>
<head>
<title>A reason why custom notification sound might not work on Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自定义通知声音无法在Android上运行的原因</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-reason-why-custom-notification-sound-might-not-work-on-android-4aea06b8c7c4?source=collection_archive---------0-----------------------#2021-06-28">https://levelup.gitconnected.com/a-reason-why-custom-notification-sound-might-not-work-on-android-4aea06b8c7c4?source=collection_archive---------0-----------------------#2021-06-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/84e0405686a2209366f687948703e12f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6B-CNhLrYrlXGFNqahuyBA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://unsplash.com/@htroupe?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">汉娜剧团</a>在<a class="ae kc" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="c80a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我们为通知通道使用自定义声音时，我们可能会观察到系统显示没有声音的通知。播放自定义声音可能对您的应用程序至关重要，让我们来看看为什么会这样。</p><h2 id="5d13" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">开始</h2><p id="d24a" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我遇到了一个问题，用户听不到某些通知的声音。于是我开始调查原因。我分析了该版本的一个变更日志，没有发现任何明显的问题。之后我才知道，只有安卓8.0+(API 26+)的用户才面临这个问题。这让我想到这个问题可能与<a class="ae kc" href="https://developer.android.com/training/notify-user/channels" rel="noopener ugc nofollow" target="_blank">的通知渠道有关。</a></p><h2 id="a99c" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">Android通知渠道</h2><p id="8944" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">根据文件:</p><blockquote class="lz ma mb"><p id="7ac4" class="kd ke mc kf b kg kh ki kj kk kl km kn md kp kq kr me kt ku kv mf kx ky kz la ij bi translated">从Android 8.0 (API级别26)开始，所有通知都必须分配到一个通道。对于每个通道，您可以设置应用于该通道中所有通知的视觉和听觉行为。然后，用户可以更改这些设置，并决定应用程序中的哪些通知通道应该是干扰性的或可见的。</p></blockquote><p id="2621" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设我们使用以下代码块来创建和配置通道:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="f6fa" class="lb lc iq ml b gy mp mq l mr ms"><strong class="ml ir">private fun </strong>initNotificationChannel() {<br/>    <strong class="ml ir">if </strong>(Build.VERSION.<em class="mc">SDK_INT </em>&lt; Build.VERSION_CODES.<em class="mc">O</em>) <strong class="ml ir">return<br/>    val </strong>channelName = ...<br/>    <strong class="ml ir">val </strong>channelDescription = ...<br/>    <strong class="ml ir">val </strong>importance = NotificationManagerCompat.<em class="mc">IMPORTANCE_HIGH<br/>    </em><strong class="ml ir">val </strong>channel = NotificationChannelCompat.Builder(<strong class="ml ir">CHANNEL_ID</strong>, importance).<em class="mc">apply </em><strong class="ml ir">{<br/>        </strong>setName(channelName)<br/>        setDescription(channelDescription)<br/>        setSound(<br/>Uri.parse(<strong class="ml ir">"${</strong>ContentResolver.<em class="mc">SCHEME_ANDROID_RESOURCE</em><strong class="ml ir">}://${</strong>requireContext().<em class="mc">packageName</em><strong class="ml ir">}/${</strong>R.raw.<em class="mc">iphone_ringtone</em><strong class="ml ir">}"</strong>),<br/>            Notification.<em class="mc">AUDIO_ATTRIBUTES_DEFAULT<br/>        </em>)<br/>    <strong class="ml ir">}<br/>    </strong>NotificationManagerCompat.from(requireContext()).createNotificationChannel(channel.build())<br/>}</span></pre><p id="29af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以在文档中找到创建和配置通道的常用方法。然而，我们正在设置一个存储在<strong class="kf ir"> raw </strong>文件夹中的自定义声音。<br/>第一眼看上去，一切都很好，这段代码非常棒。但从长远来看，它会造成一个问题。我们将在几分钟内看到它。</p><h2 id="1fb7" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">渠道细节</h2><p id="ce1c" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">根据文档，一旦开发人员创建了通知通道，开发人员只能修改一些东西。</p><blockquote class="lz ma mb"><p id="dba1" class="kd ke mc kf b kg kh ki kj kk kl km kn md kp kq kr me kt ku kv mf kx ky kz la ij bi translated">创建通知通道后，您将无法更改通知行为，因为此时用户拥有完全的控制权。尽管您仍然可以更改频道的名称和描述。</p></blockquote><p id="4ef4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事实上，如果我们创建一个ID为“A”的通道，删除它，并创建一个ID为“A”的新通道，框架将恢复之前删除的ID为“A”的通道。你可以在文档<a class="ae kc" href="https://developer.android.com/reference/android/app/NotificationManager#deleteNotificationChannel(java.lang.String)" rel="noopener ugc nofollow" target="_blank">这里</a>找到更多。</p><h2 id="8bb9" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">发现问题的第二次机会</h2><p id="9856" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">看看下面的代码，试着理解在更新到下一个版本的应用程序后，什么会导致错过通知声音。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/464ef69b52606cec85d3b07e6003ed98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DE4OKftejT2G9Y8QpEfiLA.png"/></div></div></figure><p id="7742" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你没看到，那就不是问题。无论如何，我马上会给你看。</p><h2 id="eb4e" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">问题是</h2><p id="4262" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我用一个自定义的声音URI创建了通知通道，它指向了<strong class="kf ir"> R </strong>文件中的一个特定ID。但是，R文件中的id在重建后可能会改变。不常发生。我复制了以下步骤:</p><ol class=""><li id="d51a" class="mu mv iq kf b kg kh kk kl ko mw ks mx kw my la mz na nb nc bi translated">添加\删除应用程序资源中的文件夹，或者在目标文件夹之前添加同一文件夹中的文件</li><li id="3bea" class="mu mv iq kf b kg nd kk ne ko nf ks ng kw nh la mz na nb nc bi translated">清除梯度缓存</li><li id="fd4f" class="mu mv iq kf b kg nd kk ne ko nf ks ng kw nh la mz na nb nc bi translated">构建并运行应用程序</li></ol><p id="61d6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它导致IDs重新生成，并且通知通道指向旧的ID。就是这样:)</p><h2 id="bfa5" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">如何修复</h2><p id="b8a6" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">首先，我们应该删除通知通道，并使用新的通知通道id创建一个新的通知通道。<br/>其次，我们应该修改一个声音URI，并按其名称使用原始文件。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/916e402433816fea7b68291fe67fbd98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yuQNR-ZD4XqIluRNyH_YVg.png"/></div></div></figure><h2 id="a538" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">结论</h2><p id="6c56" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我花了几天时间来确定这个问题，希望它会对某人有用。但是，错过通知声音可能是由于:将通知/频道的优先级/重要性级别设置得较低；用户使通知频道静音；被另一个通知声音打断等。</p><p id="06dd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这种解决方案适用于模糊代码。顺便说一下，要确保你的文件不会因为资源减少而损坏。在这个例子中，我使用声音文件的ID为Android pre 8.0上的用户创建通知声音。在这种情况下，该文件是从代码中使用的，因此不会被删除。</p><p id="f492" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你喜欢这篇文章，请在推特上关注我</p><p id="564a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">项目样本可以在<a class="ae kc" href="https://github.com/Y-Datsenko/FixMissingNotificationSound" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。看一下提交，它们将提供关于声音何时被破坏以及何时被修复的附加信息。</p></div></div>    
</body>
</html>