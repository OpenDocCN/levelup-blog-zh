<html>
<head>
<title>Custom Image Classification Model Using TensorFlow Lite Model Maker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用TensorFlow Lite Model Maker定制图像分类模型</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/custom-image-classification-model-using-tensorflow-lite-model-maker-68ee4514cd45?source=collection_archive---------4-----------------------#2021-12-28">https://levelup.gitconnected.com/custom-image-classification-model-using-tensorflow-lite-model-maker-68ee4514cd45?source=collection_archive---------4-----------------------#2021-12-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="599c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，您将学习如何获取自定义图像数据集并训练分类模型。然后，您将把您的模型导出为一个TFLite模型，并运行推理。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/11bdb3d5983605b9bfbd8623b8f75f27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_ADxqT5UtflD8GjqvcONsg.jpeg"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">由<a class="ae lf" href="https://unsplash.com/@amandadalbjorn?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">阿曼达·达尔比约恩</a>在<a class="ae lf" href="https://unsplash.com/s/photos/artificial-intelligence?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="d8d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于那些希望涉足深度学习世界的人，或者那些只将机器学习视为达到目的的手段的人，TensorFlow Lite Model Maker可能正是你正在寻找的。它的设置很快，学习曲线比完全成熟的TensorFlow甚至Keras API都要平缓得多。然而，对于Model Maker提供的简单性，您确实需要进行大量的定制。在本文中，我们将使用TensorFlow Lite Model Maker创建一个深度学习模型，该模型可以对16种不同的鸟类进行分类。</p><h2 id="c849" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">先决条件</h2><p id="b74b" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated"><a class="ae lf" href="https://medium.com/codex/collecting-image-data-for-machine-learning-in-python-6334474d0e23" rel="noopener">用Python为机器学习收集图像数据</a></p><h2 id="0f56" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">必需的库</h2><p id="57fa" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">如果尚未安装，请在您的终端上安装必要的库</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="b957" class="lg lh it mf b gy mj mk l ml mm">pip install tflite_model_maker<br/>pip install os<br/>pip install numpy<br/>pip install tensorflow<br/></span></pre><p id="1b58" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后导入所需的库</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="2a42" class="lg lh it mf b gy mj mk l ml mm">import os<br/>import numpy as np<br/>import tensorflow as tf<br/>assert tf.__version__.startswith('2')<br/>from tflite_model_maker import model_spec<br/>from tflite_model_maker import image_classifier<br/>from tflite_model_maker.config import ExportFormat<br/>from tflite_model_maker.config import QuantizationConfig<br/>from tflite_model_maker.image_classifier import DataLoader<br/>import matplotlib.pyplot as plt</span></pre><h2 id="a295" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">图像数据</h2><p id="6c69" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">定义图像数据的路径。如果您还没有浏览过关于为Python中的机器学习收集图像数据的必备文章，那么现在是时候停下来看看了。</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="c759" class="lg lh it mf b gy mj mk l ml mm">image_path = '/content/drive/MyDrive/Colab Notebooks/Bird_Classification/BIRDS/train'</span></pre><p id="37de" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意:如果你很细心，你会注意到我的图像路径只指向我的“火车”文件夹。我的前一篇文章，在Python中为机器学习收集图像数据，旨在使用Keras的image_dataset_from_directory函数来组织数据，该函数需要单独的“测试”和“训练”文件夹。Model Maker将为您创建该分割，因此在本例中，我仅使用我的培训文件夹。</p><h2 id="570f" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">列车测试分离</h2><p id="57f4" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">在训练数据和剩余数据之间进行第一次80/20分割</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="3bc1" class="lg lh it mf b gy mj mk l ml mm">data = DataLoader.from_folder(image_path)</span><span id="e06f" class="lg lh it mf b gy mn mk l ml mm">train_data, rest_data = data.split(0.8)</span></pre><p id="7204" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将“rest_data”再对半分成“test_data”和“validation_data”</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="e25c" class="lg lh it mf b gy mj mk l ml mm">validation_data, test_data = rest_data.split(0.5)</span></pre><h2 id="c1cd" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">创建模型</h2><p id="5af5" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">现在创建模型。通过:</p><ul class=""><li id="a655" class="mo mp it js b jt ju jx jy kb mq kf mr kj ms kn mt mu mv mw bi translated">将用于实际训练模型的训练数据</li><li id="6f9c" class="mo mp it js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated">验证数据将用于查看您的模型在每个时期后的性能如何</li><li id="3d8b" class="mo mp it js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated">时代的数量定义了你想要你的模型经历多少轮训练(时代越多，你的模型训练的时间就越长)</li><li id="e884" class="mo mp it js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated">模型规范是一种通用的预训练图像模型，您可以将其用作自己数据集的基础。有几个选项可以在准确性和文件大小之间进行不同的权衡。你可以在这里阅读更多关于不同模型的信息:<a class="ae lf" href="https://blog.tensorflow.org/2020/03/higher-accuracy-on-vision-models-with-efficientnet-lite.html" rel="noopener ugc nofollow" target="_blank">https://blog . tensor flow . org/2020/03/higher-accuracy-on-vision-models-with-efficient net-lite . html</a></li></ul><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="b480" class="lg lh it mf b gy mj mk l ml mm">model = image_classifier.create(train_data, model_spec=model_spec.get('efficientnet_lite0'), validation_data=validation_data, epochs = 20)</span></pre><h2 id="f081" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">评估模型</h2><p id="6be5" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">一旦您的模型完成运行，您就可以根据它从未见过的“test_data”对它进行评估。这将让您清楚地了解您的模型是否过度适合训练/验证数据。</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="8bdb" class="lg lh it mf b gy mj mk l ml mm">loss, accuracy = model.evaluate(test_data)</span></pre><h2 id="d37c" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">导出您的模型</h2><p id="2512" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">一旦您对您的模型的性能感到满意，将您的模型导出到您以后可以再次找到的任何目录。这会将您的模型导出为一个TFLite模型。</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="5162" class="lg lh it mf b gy mj mk l ml mm">model.export(export_dir='.')</span></pre><h2 id="4f1d" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">运行TFLite模型</h2><p id="d732" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">首先，加载你的模型并分配张量</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="7929" class="lg lh it mf b gy mj mk l ml mm">import tensorflow.lite as tflite</span><span id="23a7" class="lg lh it mf b gy mn mk l ml mm"># Load TFLite model and allocate tensors.</span><span id="f736" class="lg lh it mf b gy mn mk l ml mm">interpreter = tflite.Interpreter(model_path='Your_Path_Here/model.tflite')</span><span id="0480" class="lg lh it mf b gy mn mk l ml mm">#allocate the tensors<br/>interpreter.allocate_tensors()</span></pre><p id="f69a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">得到输入和输出张量</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="b261" class="lg lh it mf b gy mj mk l ml mm">input_details = interpreter.get_input_details()<br/>output_details = interpreter.get_output_details()</span></pre><p id="8f8a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">读入一个你希望模型预测并解码成张量的样本图像</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="7402" class="lg lh it mf b gy mj mk l ml mm">import cv2<br/>import numpy as np</span><span id="469e" class="lg lh it mf b gy mn mk l ml mm">image_path='/content/drive/MyDrive/Colab Notebooks/Bird_Classification/BIRDS/validate/Blue Jay/13.jpg'</span><span id="42c5" class="lg lh it mf b gy mn mk l ml mm">img = cv2.imread(image_path)<br/>img = cv2.resize(img,(300,300))</span><span id="c5a0" class="lg lh it mf b gy mn mk l ml mm">#Preprocess the image to required size and cast</span><span id="8498" class="lg lh it mf b gy mn mk l ml mm">input_shape = input_details[0]['shape']<br/>input_tensor= np.array(np.expand_dims(img,0))</span></pre><p id="4e51" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将张量设置为指向要推理的输入数据，然后运行推理</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="7c0d" class="lg lh it mf b gy mj mk l ml mm">input_index = interpreter.get_input_details()[0]["index"]<br/>interpreter.set_tensor(input_index, input_tensor)<br/>interpreter.invoke()<br/>output_details = interpreter.get_output_details()</span></pre><p id="7af7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">做出预测</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="d1ed" class="lg lh it mf b gy mj mk l ml mm">output_data = interpreter.get_tensor(output_details[0]['index'])<br/>pred = np.squeeze(output_data)</span></pre><p id="8a74" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您打印“pred ”,您将得到一个uint 8(0–255)值的数组。这些对应于每个类的置信度。在我的例子中，这是我们在<a class="ae lf" href="https://medium.com/codex/collecting-image-data-for-machine-learning-in-python-6334474d0e23" rel="noopener">为Python中的机器学习收集图像数据</a>教程中指定的16种鸟类。</p><p id="4b99" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要获得更人性化的预测，请指定下面的类别索引。</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="bfe8" class="lg lh it mf b gy mj mk l ml mm">class_ind = {<br/>0 :'American Crow',<br/>1:'American Robin',<br/>2: 'Black-crested Titmouse',<br/>3: 'Blue Jay',<br/>4:'Carolina Chickadee',<br/>5: 'Common Grackle',<br/>6: 'Eastern Phoebe',<br/>7: 'House Wren',<br/>8: 'Ladder-backed woodpecker',<br/>9: 'Northern Cardinal',<br/>10: 'Northern Flicker',<br/>11: 'Northern Mockingbird',<br/>12: 'Squirrel',<br/>13: 'Tufted Titmouse',<br/>14: 'White-crowned Sparrow',<br/>15: 'White-winged Dove'}</span></pre><p id="aed4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为“pred”对应于每个鸟类的置信度，所以我们的预测应该是数组中的最高值。抓取最高预测位置。</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="4663" class="lg lh it mf b gy mj mk l ml mm">highest_pred_loc = np.argmax(pred)</span></pre><p id="5df3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用“highest_pred_loc”在“class_ind”字典中搜索实际的鸟名。把预测打印出来就大功告成了！</p><pre class="kq kr ks kt gt me mf mg mh aw mi bi"><span id="40f8" class="lg lh it mf b gy mj mk l ml mm">bird_name = class_ind[highest_pred_loc]<br/>print(f"It's a wild {bird_name}! So cute.")</span></pre><h2 id="201f" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">结论</h2><p id="384b" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">我个人发现TensorFlow Lite Model Maker是让你的深度学习模型启动并运行的最简单的方法，值得在准确性和定制化方面稍作权衡。如果你对鸟类不感兴趣，那么<a class="ae lf" href="https://medium.com/codex/collecting-image-data-for-machine-learning-in-python-6334474d0e23" rel="noopener">中用Python </a>为机器学习收集图像数据的步骤和本文都应该很简单，适合你自己的项目。</p></div></div>    
</body>
</html>