<html>
<head>
<title>Django SQL Debugging with an SQL log middleware - Optimising Django: Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用SQL日志中间件调试Django SQL优化Django:第1部分</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/django-sql-debugging-with-an-sql-log-middleware-optimising-django-part-1-ca3b5c20d892?source=collection_archive---------12-----------------------#2020-07-27">https://levelup.gitconnected.com/django-sql-debugging-with-an-sql-log-middleware-optimising-django-part-1-ca3b5c20d892?source=collection_archive---------12-----------------------#2020-07-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7c7f7c00baa8fda806509e4a6d2ddd3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wj6DLu4WRNzHfRrSHOnWEQ.png"/></div></div></figure><p id="c72b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您对web开发感兴趣，或者只是对一般的软件工程感兴趣，您可能会遇到Django-REST。Django-REST已经成为想要构建2010年典型web服务器的开发人员的黄金标准:开源、REST协议、MVS设计模式，以及Python。</p><p id="8cd7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然Django很好地将大多数肮脏的SQL隐藏在其模型和查询集的外表下，但在某些情况下，我们希望能够优化昂贵的数据库查询，无论是减少RTT还是避免浪费宝贵的服务器时间。如果你正在读这篇文章，我会认为你已经在优化你的Django查询了，所以至少，让我们确保你的优化已经通过测量得到了验证。</p><p id="03d0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个小系列中，我将介绍各种技巧，您可以用它们来帮助减少查询中大量浪费的服务器处理时间。</p><h1 id="4ea7" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">在我们开始之前，有几件关于设置的事情。</h1><p id="ed4c" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我在这个系列中使用了以下内容:</p><p id="2c97" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">IDE — Pycharm <br/> Python 3 <br/>最新Django 1。Django 1支持2020年结束，建议使用Django 3。幸运的是，<strong class="ka ir">这个系列的大部分内容应该同样适用于Django 2和3。</strong></p><p id="643b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">我还假设你对Django </strong>有中级水平的了解，所以我可以跳过一些典型的Django配置。</p><p id="efc7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">说完了，让我们开始吧。</p><h1 id="41e9" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">这一集:获得一个SQL调试中间件。</h1><p id="8f96" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">如果你不熟悉中间件，基本上你的请求会被一大堆中间件过滤掉。一些执行认证，而另一些处理CSRF令牌。欲了解更多信息，<a class="ae lz" href="https://docs.djangoproject.com/en/3.0/topics/http/middleware/" rel="noopener ugc nofollow" target="_blank"> Django有一篇关于这个的文章</a>。</p><p id="b731" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Django还允许您创建自己的中间件，我们将在这里充分利用它来打印出服务器收到的每个请求所执行的SQL查询。</p><p id="ad8c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Github用户<a class="ae lz" href="https://gist.github.com/vstoykov" rel="noopener ugc nofollow" target="_blank"> vstoykov </a>发布了一个非常有用的中间件片段，我在自己的开发中也使用了它(做了一些修改),效果很好。收到请求后，该中间件基本上:</p><ol class=""><li id="46f2" class="ma mb iq ka b kb kc kf kg kj mc kn md kr me kv mf mg mh mi bi translated">读取所有通过django.db.connection进行的查询，</li><li id="c3ab" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">打印出每个查询的SQL，更重要的是，打印出每个SQL查询执行的时间。</li></ol><h1 id="e880" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">现在来看一些代码！</h1><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="e9d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当你有了这样一个中间件，你可以把它添加到你的Django项目中的settings.py文件中，就像这样:</p><pre class="mo mp mq mr gt mu mv mw mx aw my bi"><span id="54de" class="mz kx iq mv b gy na nb l nc nd">import os</span><span id="cb05" class="mz kx iq mv b gy ne nb l nc nd">... Doing your settings file stuff ...</span><span id="3a04" class="mz kx iq mv b gy ne nb l nc nd"><br/># If you want, you can lock the middleware behind an env var.</span><span id="4389" class="mz kx iq mv b gy ne nb l nc nd">if os.environ.get('SQL_DEBUG', False):<br/>    MIDDLEWARE += ('sql_middleware.SqlPrintingMiddleware',)<br/></span><span id="c2c7" class="mz kx iq mv b gy ne nb l nc nd">... Continue with your settings file stuff ...</span></pre><h1 id="72f9" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">接下来，让我们测试我们的新中间件。</h1><p id="ae07" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">继续用一个基本的Django admin运行一个示例Django服务器实例。可以肯定的是，您应该能够看到如下所示的服务器日志:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/7ab59343210ab220d4ddce26e6a611dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IQlngk6ZFoN_yCKTtMH1zA.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk translated">Django服务器日志</figcaption></figure><p id="7b67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在使用web浏览器登录Django admin，相应的服务器日志应该如下所示。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/ebf8c39ec7b45b5dcbe890640b932ace.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hk3wWj-5DlOyoN6dl1K_Gg.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk translated">Django服务器登录到管理页面后的日志</figcaption></figure><p id="13dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如您所看到的，SQL日志在每次HTTP调用后都被打印出来，SQL是根据执行每次调用所花费的时间打印出来的。</p><h1 id="f2b7" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">总结一下…</h1><p id="d095" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">可以想象，拥有一个基于视图的SQL日志记录器对于SQL调试非常有用。我们将在本系列的剩余部分中使用这个日志记录器来帮助我们优化Django中的SQL查询，减少我们在不同地方的SQL内存占用，同时使用这个日志记录器来确认我们的优化实际上正在按预期工作。</p><p id="7b57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但同时，希望这篇文章对你有很大的帮助。即使如此，它也可以提供对应用程序中耗时的查询种类的深刻见解，允许您决定处理哪些查询。</p><p id="582c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编辑:<a class="ae lz" rel="noopener ugc nofollow" target="_blank" href="/speed-up-your-django-admin-by-removing-sql-counts-optimizing-django-part-2-f5e09da667c">点击这里查看第2部分</a>，在这里我们将进入Django admin中的第一次SQL优化！</p></div></div>    
</body>
</html>