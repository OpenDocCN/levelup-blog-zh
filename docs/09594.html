<html>
<head>
<title>Building a React Native Live Video Broadcasting App using Agora</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Agora构建React本地视频直播应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/building-a-react-native-live-video-broadcasting-app-using-agora-6ae5643ae202?source=collection_archive---------14-----------------------#2021-08-24">https://levelup.gitconnected.com/building-a-react-native-live-video-broadcasting-app-using-agora-6ae5643ae202?source=collection_archive---------14-----------------------#2021-08-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/803ad45bf2bc57c01a29b97324af54f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gBxcS9HNsaEJjoOocGm2xA.png"/></div></div></figure><p id="2e4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">视频直播已经有了广泛的用途，从现场购物到现场音乐会。构建一个可扩展的、高质量的直播视频流应用程序有很多方面。例如，在维护跨平台兼容性的同时，维护低延迟、负载平衡和管理成千上万的用户可能会很有压力。</p><p id="2914" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用Agora React Native SDK有一种非常简单的方法来实现这一点。在本文中，我们将通过使用Agora Video SDK的魔力来构建一个直播应用程序，该应用程序可以拥有多个广播公司并托管数千个用户。在深入了解应用程序的工作原理之前，我们将检查它的结构、设置和执行。你可以通过几个简单的步骤在几分钟内进行现场直播。</p><p id="d220" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在下面的例子中，我们将使用<a class="ae kw" href="https://www.npmjs.com/package/react-native-agora/" rel="noopener ugc nofollow" target="_blank">Agora RTC SDK for React Native</a>。我在写的时候用的是v3.4.6。</p><h1 id="db0f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建Agora帐户</h1><p id="1ce1" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><a class="ae kw" href="https://sso.agora.io/en/signup?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=building-a-react-native-live-video-broadcasting-app-using-agora" rel="noopener ugc nofollow" target="_blank">注册</a>并登录仪表板。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/ddaddc144e9fc8bf486503dd69d7e22d.png" data-original-src="https://miro.medium.com/v2/resize:fit:674/format:webp/1*pAkpJsnCJZx1VVzFw2TFiw.png"/></div></figure><p id="ab56" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">导航到“项目管理”选项卡下的“项目列表”选项卡，并通过单击蓝色的“创建”按钮创建一个新项目。</p><p id="af89" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新项目并检索应用程序ID。如果您选择带有令牌的应用程序ID，请为您的项目获取一个临时令牌。您可以在编辑页面上找到生成临时令牌的链接。在开发应用程序时，临时令牌将用于授权您的请求。</p><blockquote class="mf mg mh"><p id="057d" class="jy jz mi ka b kb kc kd ke kf kg kh ki mj kk kl km mk ko kp kq ml ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="iq">注意:</em> </strong>建议对生产环境中运行的所有RTE应用进行令牌认证。有关Agora平台中基于令牌的认证的更多信息，请参见本指南:<a class="ae kw" href="https://docs.agora.io/en/Video/token?platform=All%20Platforms" rel="noopener ugc nofollow" target="_blank">https://docs.agora.io/en/Video/token?平台=所有% 20个平台</a></p></blockquote><h1 id="1b22" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">我们示例的结构</h1><p id="c64e" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这是我们应用程序的结构:</p><pre class="mb mc md me gt mm mn mo mp aw mq bi"><span id="3631" class="mr ky iq mn b gy ms mt l mu mv"><strong class="mn ir">.</strong><br/>├── android<br/>├── components<br/>│ └── <strong class="mn ir">Permission.ts<br/></strong>│ └── <strong class="mn ir">Style.ts<br/></strong>├── ios<strong class="mn ir"><br/></strong>├── <strong class="mn ir">App.tsx</strong><br/>├── index.js<strong class="mn ir"><br/>.</strong></span></pre><h1 id="df90" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">让我们运行应用程序</h1><p id="d0b3" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">你需要安装LTS版本的Node.js和NPM。</p><ul class=""><li id="245d" class="mw mx iq ka b kb kc kf kg kj my kn mz kr na kv nb nc nd ne bi translated">确保您已经注册了Agora帐户，设置了项目，并生成了应用ID(和临时令牌)。</li><li id="8a4d" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">从<a class="ae kw" href="https://github.com/EkaanshArora/Agora-RN-Broadcast-Quickstart" rel="noopener ugc nofollow" target="_blank">主分支</a>下载并解压ZIP文件。</li><li id="1357" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">运行<code class="fe nk nl nm mn b">npm install</code>在解压后的目录中安装应用依赖项。</li><li id="5e89" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">导航到<code class="fe nk nl nm mn b">./App.tsx</code>并输入我们从Agora控制台(<code class="fe nk nl nm mn b">appId: ‘&lt;YourAppIDHere&gt;’</code>)获得的应用ID。如果您使用令牌，请输入您的令牌和频道名称。</li><li id="3941" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">如果你是为iOS开发的，打开一个终端，执行<code class="fe nk nl nm mn b">cd ios &amp;&amp; pod install</code>。然后，您可以打开<code class="fe nk nl nm mn b">ios/&lt;projectName&gt;.xcworkspace</code>文件，在XCode中打开您的项目并构建应用程序。(iOS模拟器不支持摄像头。请改用物理设备。)</li><li id="a9dd" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">如果你正在为Android开发，连接你的设备并执行<code class="fe nk nl nm mn b">npm run android</code>来启动应用程序。等待几分钟，让应用程序构建完成。</li><li id="387b" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">在手机或模拟器上看到主屏幕后，单击设备上的开始通话按钮。</li></ul><p id="bbef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样。您应该可以在两台设备之间进行视频通话。app使用<code class="fe nk nl nm mn b">test</code>作为频道名称。</p><h1 id="7ab9" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">了解它的工作原理</h1><h2 id="638e" class="mr ky iq bd kz nn no dn ld np nq dp lh kj nr ns ll kn nt nu lp kr nv nw lt nx bi translated">Permission.ts</h2><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="b908" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们正在导出一个从Android操作系统请求摄像头和麦克风权限的函数。</p><h2 id="a364" class="mr ky iq bd kz nn no dn ld np nq dp lh kj nr ns ll kn nt nu lp kr nv nw lt nx bi translated">App.tsx</h2><p id="8943" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><code class="fe nk nl nm mn b">App.tsx</code>文件包含了我们视频通话的核心逻辑。</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="cf40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们从编写导入语句开始。接下来，我们有一些应用ID、令牌和频道名称的常量。</p><p id="5853" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们为应用程序状态定义了一个包含<code class="fe nk nl nm mn b">isHost</code>(一个布尔值，用于在观众和广播公司之间切换；主机可以发送和接收流，而观众只能接收流)，<code class="fe nk nl nm mn b">joinSucceed</code>(一个布尔值，用于存储我们是否成功连接)，以及<code class="fe nk nl nm mn b">peerIds</code>(一个数组，用于存储通道中其他用户的uid)。</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="3ae2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们定义了一个基于类的组件，<code class="fe nk nl nm mn b">_engine </code>变量，它将存储<code class="fe nk nl nm mn b">RtcEngine</code>类的实例，该类提供了一些方法，应用程序可以调用这些方法来管理实时流。</p><p id="7d15" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在构造函数中，我们设置状态变量，并请求Android上的摄像头和麦克风的权限。当组件被挂载时，我们调用<code class="fe nk nl nm mn b">init</code>函数，该函数使用App ID初始化RTC引擎。它还通过在我们的引擎实例上调用<code class="fe nk nl nm mn b">enableVideo</code>方法来启用视频。</p><p id="8b0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们根据我们的<code class="fe nk nl nm mn b">isHost</code>状态变量值将<code class="fe nk nl nm mn b">channelProfile</code>设置为直播，将<code class="fe nk nl nm mn b">clientRole</code>设置为直播。</p><p id="6dc7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nk nl nm mn b">init</code>函数还为直播中的各种事件添加事件监听器。例如，当用户加入频道时，<code class="fe nk nl nm mn b">UserJoined</code>事件给我们一个用户的UID。我们将这个UID存储在我们的州中。</p><p id="84cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">(如果在我们加入之前有用户连接到频道，那么在他们成功加入频道后，将为每个用户触发一个<code class="fe nk nl nm mn b">UserJoined</code>事件。)</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="dfb1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们有功能<code class="fe nk nl nm mn b">toggleRole</code>，它在观众和广播员之间转换角色。我们有<code class="fe nk nl nm mn b">startCall</code>和<code class="fe nk nl nm mn b">endCall</code>来开始和结束通话。<code class="fe nk nl nm mn b">toggleRole</code>函数更新状态，并根据状态调用带有角色参数的<code class="fe nk nl nm mn b">setClientRole</code>函数。<code class="fe nk nl nm mn b">joinChannel</code>方法接受一个令牌、通道名、可选信息和可选UID。(如果将UID设置为0，SDK会自动分配一个UID。)</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="dfac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们定义了render函数，用于显示开始和结束呼叫的按钮，以及显示本地视频源和远程用户的视频源。我们定义了<code class="fe nk nl nm mn b">_renderVideos</code>函数，它呈现我们的视频提要。</p><p id="e438" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了显示本地用户的视频提要，我们使用了<code class="fe nk nl nm mn b">&lt;RtcLocalView.SurfaceView&gt;</code>组件，该组件接受<code class="fe nk nl nm mn b">channelId </code>和<code class="fe nk nl nm mn b">renderMode </code>(可用于将视频放入视图或缩放以填充视图)作为道具。为了显示远程用户的视频提要，我们使用SDK中的<code class="fe nk nl nm mn b">&lt;RtcLocalView.SurfaceView&gt;</code>组件，它接收远程用户的UID以及<code class="fe nk nl nm mn b">channelId </code>和<code class="fe nk nl nm mn b">renderMode</code>。我们映射远程用户的uid，使用<code class="fe nk nl nm mn b">peerIDs</code>数组显示每个用户的视频。</p><h2 id="1852" class="mr ky iq bd kz nn no dn ld np nq dp lh kj nr ns ll kn nt nu lp kr nv nw lt nx bi translated">Style.ts</h2><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="b36b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nk nl nm mn b">Style.ts</code>文件包含组件的样式。</p></div><div class="ab cl oa ob hu oc" role="separator"><span class="od bw bk oe of og"/><span class="od bw bk oe of og"/><span class="od bw bk oe of"/></div><div class="ij ik il im in"><h1 id="16ce" class="kx ky iq bd kz la oh lc ld le oi lg lh li oj lk ll lm ok lo lp lq ol ls lt lu bi translated">结论</h1><p id="e696" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">构建一个视频直播app就是这么简单。您可以参考<a class="ae kw" href="https://docs.agora.io/en/Video/API%20Reference/react_native/index.html" rel="noopener ugc nofollow" target="_blank"> Agora React Native API参考</a>来查看可以帮助您快速添加功能的方法，如静音摄像头和麦克风、设置视频配置文件、音频混合等等。</p><p id="4e21" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你正在将你的应用程序部署到产品中，你可以在<a class="ae kw" href="https://www.agora.io/en/blog/connecting-to-agora-with-tokens-react-native/" rel="noopener ugc nofollow" target="_blank">博客</a>中阅读更多关于如何使用令牌的内容。</p><p id="bd79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我邀请你加入<a class="ae kw" href="https://www.agora.io/en/join-slack/" rel="noopener ugc nofollow" target="_blank"> Agora开发者松弛社区</a>。欢迎在<code class="fe nk nl nm mn b">#react-native-help-me</code>频道提出任何React Native问题。</p></div></div>    
</body>
</html>