<html>
<head>
<title>5 Steps to an Authenticated API with Serverless Framework, Auth0, and Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用无服务器框架认证API的5个步骤，Auth0和Go</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/sls-auth0-go-34dfe5fab0b?source=collection_archive---------4-----------------------#2022-05-15">https://levelup.gitconnected.com/sls-auth0-go-34dfe5fab0b?source=collection_archive---------4-----------------------#2022-05-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/56447dc2dddf7e1abc391b6e95df7e3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*betyOmRs6f7AUBNu.jpg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://go.dev/blog/go-brand" rel="noopener ugc nofollow" target="_blank">https://go.dev/blog/go-brand</a></figcaption></figure><p id="e054" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您是否对无服务器感兴趣，但尚未解决身份验证问题？本指南可能会有所帮助，因为它提供了在无服务器框架和Auth0的帮助下从零到认证API的逐步演示。</p><h1 id="a2ed" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">步骤0:安装和先决条件</h1><p id="014a" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">按照步骤，安装<a class="ae kf" href="https://serverless.readme.io/docs/configuring-aws" rel="noopener ugc nofollow" target="_blank">无服务器框架CLI </a>以及<a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>。您的计算机应该配置有IAM角色或有权创建AWS Lambda和API网关资源的用户。</p><p id="1ac6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是验证安装的几个命令:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="0d94" class="mq lf it mm b gy mr ms l mt mu"># Verify SLS<br/>$ sls --version<br/>Framework Core: 2.29.0<br/>Plugin: 4.5.0<br/>SDK: 4.2.0<br/>Components: 3.7.3</span><span id="dd57" class="mq lf it mm b gy mv ms l mt mu"># Verivy AWS CLI<br/>$ aws sts get-caller-identity<br/>{<br/>"UserId": "SOMEUSERID",<br/>"Account": "0123456789012",<br/>"Arn": "arn:aws:iam::0123456789012:user/garrett"<br/>}</span></pre><h1 id="0bc8" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">步骤1:项目搭建</h1><p id="cb40" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">第一步是为您的项目创建一个文件夹，将目录更改为新创建的文件夹，并使用<code class="fe mw mx my mm b">create</code>命令和<code class="fe mw mx my mm b">aws-go</code>模板为我们提供一个启动项目。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="958a" class="mq lf it mm b gy mr ms l mt mu">mkdir aws-golang-auth0-custom-authorizer<br/>cd aws-golang-auth0-custom-authorizer<br/>sls create --template aws-go</span></pre><p id="cbf5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是几行预期的输出，显示项目已成功生成。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="3d7a" class="mq lf it mm b gy mr ms l mt mu">Serverless: Generating boilerplate...</span><span id="21b2" class="mq lf it mm b gy mv ms l mt mu">Serverless: Successfully generated boilerplate for template: "aws-go"</span><span id="7bc0" class="mq lf it mm b gy mv ms l mt mu">Serverless: NOTE: Please update the "service" property in serverless.yml with your service name</span></pre><p id="a26b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，您可以使用<code class="fe mw mx my mm b">tree</code>来检查新创建的项目结构:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="ec58" class="mq lf it mm b gy mr ms l mt mu">[Sat May 14 18:40:20 EDT 2022] tree<br/>.<br/>├── Makefile<br/>├── go.mod<br/>├── hello<br/>│   └── main.go<br/>├── serverless.yml<br/>└── world<br/>    └── main.go</span></pre><h1 id="0c91" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">步骤2:创建一个Auth0帐户和API</h1><p id="f4f6" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">使用Auth0创建一个免费帐户，然后前往<a class="ae kf" href="https://manage.auth0.com/dashboard/" rel="noopener ugc nofollow" target="_blank">仪表盘</a>。</p><p id="72db" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从那里，在左边面板的<code class="fe mw mx my mm b">Applications</code>下面是一个<code class="fe mw mx my mm b">APIs</code>部分。点击<code class="fe mw mx my mm b">Create API</code>按钮:</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/be6c0f327412df8f4fb91bf7a2726b93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RZ3ycWkowxlEsLlIMyzGmA.png"/></div></div></figure><p id="6215" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用您喜欢的任何名称和标识符填充这个模型。对我来说，我把它命名为类似于这个项目的名字:</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/58465ddbc2e1dc04ce907e83f3e54293.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Boq_me_GOTAHBxQ3GvRspA.png"/></div></div></figure><p id="7c8f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，从API中收集以下信息:</p><ul class=""><li id="0caa" class="nb nc it ki b kj kk kn ko kr nd kv ne kz nf ld ng nh ni nj bi translated">权威URL。示例:` https://dev-ABCD 1234 . us . auth 0 . com/'</li><li id="a243" class="nb nc it ki b kj nk kn nl kr nm kv nn kz no ld ng nh ni nj bi translated">标识符。示例:` AWS-golang-auth 0-custom-authorizer '</li></ul><h1 id="bec6" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">步骤3:创建和配置授权者Lambda</h1><p id="150a" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为函数创建一个新文件夹<code class="fe mw mx my mm b">auth</code>和文件<code class="fe mw mx my mm b">main.go</code>:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="8c4a" class="mq lf it mm b gy mr ms l mt mu">mkdir auth &amp;&amp; touch auth/main.go</span></pre><p id="76a1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe mw mx my mm b">serverless.yaml</code>文件中定义新的Auth lambda以及另外两个函数<code class="fe mw mx my mm b">hello</code>和<code class="fe mw mx my mm b">world</code>:</p><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="ce4e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在Makefile中添加一行代码来构建和打包新的<code class="fe mw mx my mm b">auth</code> lambda以及<code class="fe mw mx my mm b">hello</code>和<code class="fe mw mx my mm b">world</code>lambda。</p><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="9a04" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，授权人代码为<code class="fe mw mx my mm b">auth/main.go</code>(要点如下)。</p><p id="5327" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每个逻辑代码块上面都有注释，但本质上我们有一个函数接受类型为<code class="fe mw mx my mm b">APIGatewayCustomAuthorizerRequest</code>的参数，这与其他Lambdas不同。由于这个Lambda是一个API网关授权器，我们希望传递的对象有一个我们可以访问的<code class="fe mw mx my mm b">AuthorizationToken</code>。在那里，我们使用<code class="fe mw mx my mm b">auth0</code>模块从我们的观众创建一个<code class="fe mw mx my mm b">validator</code>，它将用于验证传递的令牌。</p><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="e739" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，在<code class="fe mw mx my mm b">serverless.yaml</code>中添加从<code class="fe mw mx my mm b">auth/main.go</code>代码中访问的环境变量。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="152a" class="mq lf it mm b gy mr ms l mt mu">environment:<br/>  AUTH0_DOMAIN: "&lt;yourdomain&gt;.us.auth0.com"<br/>  AUTH0_AUDIENCE: "https://&lt;some-identifier&gt;"</span></pre><p id="23f9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，注意这个例子将使用API网关的<code class="fe mw mx my mm b">REST API</code>而不是<code class="fe mw mx my mm b">HTTP API</code>，所以将<code class="fe mw mx my mm b">serverless.yaml</code>中的<code class="fe mw mx my mm b">httpApi</code>引用改回<code class="fe mw mx my mm b">http</code>。</p><h1 id="844f" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">步骤4:部署和测试，无需身份验证</h1><p id="5145" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们几乎准备好添加身份验证了！但首先，让我们部署并确保我们的终端按预期工作。</p><p id="3fe0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先运行部署命令:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="7093" class="mq lf it mm b gy mr ms l mt mu">make deploy</span></pre><p id="a184" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果成功，这将为我们的功能提供一些端点:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="8838" class="mq lf it mm b gy mr ms l mt mu">...<br/>endpoints:<br/>  GET - <a class="ae kf" href="https://qgr0ggi8c9.execute-api.us-east-1.amazonaws.com/dev/hello" rel="noopener ugc nofollow" target="_blank">https://qgr0ggi8c9.execute-api.us-east-1.amazonaws.com/dev/hello</a><br/>  GET - <a class="ae kf" href="https://qgr0ggi8c9.execute-api.us-east-1.amazonaws.com/dev/world" rel="noopener ugc nofollow" target="_blank">https://qgr0ggi8c9.execute-api.us-east-1.amazonaws.com/dev/world</a><br/>...</span></pre><p id="fa02" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用<code class="fe mw mx my mm b">curl</code>命令测试它们:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="4c8e" class="mq lf it mm b gy mr ms l mt mu">$ curl --request GET \<br/>&gt;   --url <a class="ae kf" href="https://qgr0ggi8c9.execute-api.us-east-1.amazonaws.com/dev/hello" rel="noopener ugc nofollow" target="_blank">https://qgr0ggi8c9.execute-api.us-east-1.amazonaws.com/dev/hello</a></span><span id="baf5" class="mq lf it mm b gy mv ms l mt mu">{"message":"Go Serverless v1.0! Your function executed successfully!"}</span></pre><h1 id="b254" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">步骤5:要求认证</h1><p id="e154" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为<code class="fe mw mx my mm b">hello</code>端点添加一个值为<code class="fe mw mx my mm b">auth</code>(或函数)的<code class="fe mw mx my mm b">authorizer</code></p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="a073" class="mq lf it mm b gy mr ms l mt mu">authorizer: auth</span></pre><p id="80b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后重新部署</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="1754" class="mq lf it mm b gy mr ms l mt mu">make deploy</span></pre><p id="2e7d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在确保API现在返回<code class="fe mw mx my mm b">Unauthenticated</code></p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="7a2c" class="mq lf it mm b gy mr ms l mt mu">$ curl --request GET \<br/>&gt;   --url https://qgr0ggi8c9.execute-api.us-east-1.amazonaws.com/dev/hello</span><span id="adc1" class="mq lf it mm b gy mv ms l mt mu">{"message":"Unauthorized"}</span></pre><p id="443f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，在<code class="fe mw mx my mm b">Authorization</code>头中生成一个令牌传递给API。下图是样本<code class="fe mw mx my mm b">curl</code>，不过你可以直接从Auth0复制自己的！只需导航到仪表板，点击您的API，并继续到<code class="fe mw mx my mm b">test</code>选项卡，命令应该准备好复制:</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nr"><img src="../Images/456b6b7b9c92d6a6c681b7a6b6202fb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OCr2sAAyE55DYQUMbSKoRQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">复制curl命令以检索令牌</figcaption></figure><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="643d" class="mq lf it mm b gy mr ms l mt mu">curl --request POST \<br/>  --url https://dev-abcd1234.us.auth0.com/oauth/token \<br/>  --header 'content-type: application/json' \<br/>  --data '{<br/>    "client_id":"$CLIENT_ID",<br/>    "client_secret":"$CLIENT_secret",<br/>    "audience":"$AUDIENCE",<br/>    "grant_type":"client_credentials"<br/>}'</span></pre><p id="c7f9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它应该会产生如下所示的令牌:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="eda6" class="mq lf it mm b gy mr ms l mt mu">{"access_token":"someLongAccessToken","expires_in":86400,"token_type":"Bearer"}</span></pre><p id="5e9f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在在<code class="fe mw mx my mm b">Authentication</code>头中传递<code class="fe mw mx my mm b">access_token</code>值:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="cbe6" class="mq lf it mm b gy mr ms l mt mu">curl --request GET \<br/>  --url <a class="ae kf" href="https://qgr0ggi8c9.execute-api.us-east-1.amazonaws.com/dev/hello" rel="noopener ugc nofollow" target="_blank">https://qgr0ggi8c9.execute-api.us-east-1.amazonaws.com/dev/hello</a> \<br/>  --header 'Authorization: someLongAccessToken'</span><span id="73af" class="mq lf it mm b gy mv ms l mt mu">{"message":"Go Serverless v1.0! Your function executed successfully!"}</span></pre><p id="bc2f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它返回一个成功的响应！</p><h1 id="1cee" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">Github上的代码</h1><p id="52c4" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">作为参考，这个例子中的代码可以在GitHub上找到:</p><div class="ns nt gp gr nu nv"><a href="https://github.com/gsweene2/aws-golang-auth0-custom-authorizer" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">GitHub-gsweene 2/AWS-golang-auth 0-自定义-授权者</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj jz nv"/></div></div></a></div><p id="cdd9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本文中提到的更改也被浓缩为一个单独的PR:</p><div class="ns nt gp gr nu nv"><a href="https://github.com/gsweene2/aws-golang-auth0-custom-authorizer/pull/2" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">gsweene2拉请求#2对授权的“Hello”端点的更改…</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">将此建议添加到可以作为单次提交应用的批处理中。此建议无效，因为没有更改…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="ok l og oh oi oe oj jz nv"/></div></div></a></div></div></div>    
</body>
</html>