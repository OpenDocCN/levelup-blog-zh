<html>
<head>
<title>Create a new NextJS site with Typescript, Material-UI, and Cypress</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Typescript、Material-UI和Cypress创建一个新的NextJS站点</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/create-a-new-nextjs-site-with-typescript-material-ui-and-cypress-de92304fc0?source=collection_archive---------2-----------------------#2022-05-08">https://levelup.gitconnected.com/create-a-new-nextjs-site-with-typescript-material-ui-and-cypress-de92304fc0?source=collection_archive---------2-----------------------#2022-05-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8da0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">NextJS 是一个非常适合静态站点生成的React框架，因为它具有预先呈现页面、提供路由和与webpack捆绑以支持类型脚本等的结构。为了确保用户界面的一致性和标准化，建议使用带有内置组件的设计系统，这样我们就可以用最少的代码启动并运行复杂的用户界面。所以我在这里使用<a class="ae kl" href="https://material-ui.com/" rel="noopener ugc nofollow" target="_blank"> Material-UI </a>，因为它是免费的，并且附带了相当多有用的组件。<a class="ae kl" href="https://www.cypress.io/" rel="noopener ugc nofollow" target="_blank"> Cypress </a>确实是测试web应用程序的首选平台，它建立了一个平台，真正简化了您在各种浏览器上的测试，并通过一个用于调试的强大UI自动化了测试过程。</p><p id="8c28" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，在您想要的项目位置运行下面的命令来创建一个NextJS项目。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="23b1" class="kv kw iq kr b gy kx ky l kz la">npx create-next-app</span></pre><p id="b914" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，在项目根目录中添加一个名为<code class="fe lb lc ld kr b">tsconfig.json</code>的空文件。在终端中，运行下一个命令<code class="fe lb lc ld kr b">npm run dev</code>，您将被引导(如下)安装所需的包来设置typescript。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="587f" class="kv kw iq kr b gy kx ky l kz la">ready - started server on 0.0.0.0:3000, url: http://localhost:3000<br/>info  - Using webpack 5. Reason: no next.config.js https://nextjs.org/docs/messages/webpack5<br/>It looks like you're trying to use TypeScript but do not have the required package(s) installed.</span><span id="7760" class="kv kw iq kr b gy le ky l kz la">Please install typescript and @types/react by running:</span><span id="4c3f" class="kv kw iq kr b gy le ky l kz la">	npm install --save-dev typescript @types/react</span><span id="54ab" class="kv kw iq kr b gy le ky l kz la">If you are not trying to use TypeScript, please remove the tsconfig.json file from your package root (and any TypeScript files in your pages directory).</span></pre><p id="a2fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按照说明，运行以下命令来安装@types/react和typescript</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="da2c" class="kv kw iq kr b gy kx ky l kz la">npm install --save-dev typescript @types/react</span></pre><p id="b224" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然项目与typescript兼容，我们可以重命名当前文件(index.js和_app.js)的扩展名以使用<code class="fe lb lc ld kr b">.tsx</code>扩展名</p><p id="0150" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了确保它正常工作，运行<code class="fe lb lc ld kr b">npm run dev</code>并访问<code class="fe lb lc ld kr b">http://localhost:3000</code>以确保它正常工作。一旦你确认一切正常，在你的终端上点击<code class="fe lb lc ld kr b">CTRL+C</code>来停止服务器，因为我们还有其他的包要安装。</p><p id="9165" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要安装material-ui，请运行以下命令</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="4c96" class="kv kw iq kr b gy kx ky l kz la">npm install @material-ui/core @material-ui/icons</span></pre><p id="203c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，运行<code class="fe lb lc ld kr b">npm install cypress --save-dev</code>来安装测试框架。尽可能频繁地进行测试总是一个好习惯和最佳实践，这样我们可以确保我们的应用程序总是经过良好的测试，并且没有技术债务。</p><p id="4725" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">cypress安装完成后，运行<code class="fe lb lc ld kr b">npx cypress open</code>来运行它。一个新的cypress窗口(截图如下)将会出现，向您显示它已经在您的项目中创建了一个新的<code class="fe lb lc ld kr b">cypress</code>文件夹，并创建了各种示例来帮助您开始。您可以安全地删除example文件夹，因为所有的测试用例都引用https://example.cypress.io，并且与当前项目无关。</p><figure class="km kn ko kp gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lf"><img src="../Images/825dae086c8b515833982dccd680930d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ysl_mMl_awrejrzv.png"/></div></div></figure><p id="81ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是安装过程。</p><p id="43a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们来设置cypress配置，让它变得简单一些。打开<code class="fe lb lc ld kr b">cypress.json</code>文件，将内容替换为以下内容</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="4e92" class="kv kw iq kr b gy kx ky l kz la">{<br/>  "baseUrl": "http://localhost:3000",<br/>  "nodeVersion": "system"<br/>}</span></pre><p id="8e3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lb lc ld kr b">baseUrl</code>的设置将允许我们在测试用例中引用相对路径(例如<code class="fe lb lc ld kr b">/</code>而不是<code class="fe lb lc ld kr b">http://localhost:3000/</code>)，这样当我们部署后域发生变化时，我们就不必手动更新所有的测试用例。</p><p id="b4b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe lb lc ld kr b">nodeVersion</code>设置为<code class="fe lb lc ld kr b">system</code>将使cypress使用项目的节点版本，而不是cypress自带的节点版本。这适用于在比cypress版本更高的node版本中使用新函数的情况。</p><p id="63a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们希望开始测试，所以现在让我们将index.tsx中返回的内容删除为一个简单的<code class="fe lb lc ld kr b">Hello World</code>。将index.tsx中的导出默认函数替换为以下内容。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="8cfd" class="kv kw iq kr b gy kx ky l kz la">export default function Home() {<br/>  return (<br/>    &lt;h1&gt;Hello World!&lt;/h1&gt;<br/>  )<br/>}</span></pre><p id="3543" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们在<code class="fe lb lc ld kr b">cypress/integration</code>文件夹下创建一个新的规范文件<code class="fe lb lc ld kr b">index.spec.js</code>，内容如下。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="59a7" class="kv kw iq kr b gy kx ky l kz la">describe('Home page', () =&gt; {<br/>  it('Should display without error', () =&gt; {<br/>    cy.visit('/')<br/>  })<br/>})</span></pre><p id="3bad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lb lc ld kr b">cy.visit()</code>是指示cypress导航到我们主页的功能。由于上面提到的<code class="fe lb lc ld kr b">baseUrl</code>配置，我们可以使用<code class="fe lb lc ld kr b">/</code>。</p><p id="7356" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">新的<code class="fe lb lc ld kr b">index.spec.js</code>应该会自动显示在cypress窗口中。</p><figure class="km kn ko kp gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ln"><img src="../Images/c612b2d9434864d96dbfe17268e173d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*t9j7CeMxp89c-XRv.png"/></div></div></figure><p id="64bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<code class="fe lb lc ld kr b">index.spec.js</code>，一个新的浏览器窗口将会打开，文件中有测试用例。它应该显示测试用例运行成功。</p><figure class="km kn ko kp gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lo"><img src="../Images/5d2f03157254b6e05a1d0a0c505506f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*z7t7RAHvmG6-fPDO.png"/></div></div></figure><p id="bacd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然我们没有指定任何断言，但是测试仍然成功，因为cypress内置了默认断言，因此某些命令不需要显式操作。如果命令没有完成，它们也会失败。因此，如果我们停止nextjs服务器，并再次运行测试，您可以看到测试将失败，因为它无法到达索引页面。</p><p id="acff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在开始添加material-ui组件之前，请注意，根据https://material-ui.com/guides/server-rendering/<a class="ae kl" href="https://material-ui.com/guides/server-rendering/" rel="noopener ugc nofollow" target="_blank">的说法，material-ui不是为在服务器上渲染而设计的，而这正是nextjs的意义所在。当我们在nextjs页面中使用material ui时，默认情况下，material ui样式是在服务器端生成的，因为nextjs是一个静态站点生成器，所以页面是预先生成的，随之而来的material ui也是如此。如果什么都不做，浏览器控制台日志中会有一个警告，比如“Prop <code class="fe lb lc ld kr b">classname</code>不匹配。服务器:“makeStyles-main-3”客户端:“makeStyles-main-1”。</a></p><p id="9a02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了让它工作，服务器端生成的css需要被移除，并注入到客户端。对于nextjs，我们可以通过从<a class="ae kl" href="https://nextjs.org/docs/advanced-features/custom-app" rel="noopener ugc nofollow" target="_blank">自定义应用</a>中移除服务器端注入的css，并将其注入到<a class="ae kl" href="https://nextjs.org/docs/advanced-features/custom-document" rel="noopener ugc nofollow" target="_blank">自定义文档</a>中来实现这一点。</p><p id="cbd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要从自定义应用(_app.tsx)中移除服务器端注入的css，用下面的代码替换<code class="fe lb lc ld kr b">_app.tsx</code>中的函数。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="8a06" class="kv kw iq kr b gy kx ky l kz la">function MyApp({ Component, pageProps }) {<br/>  React.useEffect(() =&gt; {<br/>    // Remove the server-side injected CSS.<br/>    const jssStyles = document.querySelector('#jss-server-side');<br/>    if(jssStyles){<br/>      jssStyles.parentElement!.removeChild(jssStyles);<br/>    }<br/>  }, []);<br/>  return &lt;Component {...pageProps} /&gt;<br/>}</span></pre><p id="41b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后在<code class="fe lb lc ld kr b">pages</code>文件夹下直接创建一个<code class="fe lb lc ld kr b">_document.tsx</code>，内容如下。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="8123" class="kv kw iq kr b gy kx ky l kz la">import React from 'react';<br/>import Document, {Html, Head, Main, NextScript} from "next/document";<br/>import {ServerStyleSheets} from "@material-ui/core";</span><span id="177b" class="kv kw iq kr b gy le ky l kz la">export default class MyDocument extends Document {<br/>    render(){<br/>        return (<br/>            &lt;Html lang="en"&gt;<br/>                &lt;Head&gt;<br/>                    &lt;link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&amp;display=swap" /&gt;<br/>                &lt;/Head&gt;<br/>                &lt;body&gt;<br/>                &lt;Main /&gt;<br/>                &lt;NextScript /&gt;<br/>                &lt;/body&gt;<br/>            &lt;/Html&gt;<br/>        );<br/>    }<br/>}</span><span id="ec87" class="kv kw iq kr b gy le ky l kz la">// `getInitialProps` belongs to `_document` (instead of `_app`),<br/>// it's compatible with server-side generation (SSG).<br/>MyDocument.getInitialProps = async (ctx) =&gt; {</span><span id="1f0f" class="kv kw iq kr b gy le ky l kz la">    // Render app and page and get the context of the page with collected side effects.<br/>    const sheets = new ServerStyleSheets();<br/>    const originalRenderPage = ctx.renderPage;</span><span id="0978" class="kv kw iq kr b gy le ky l kz la">    ctx.renderPage = () =&gt;<br/>        originalRenderPage({<br/>            enhanceApp: (App) =&gt; (props) =&gt; sheets.collect(&lt;App {...props} /&gt;),<br/>        });</span><span id="bbe2" class="kv kw iq kr b gy le ky l kz la">    const initialProps = await Document.getInitialProps(ctx);</span><span id="eedf" class="kv kw iq kr b gy le ky l kz la">    return {<br/>        ...initialProps,<br/>        // Styles fragment is rendered after the app and page rendering finish.<br/>        styles: [...React.Children.toArray(initialProps.styles), sheets.getStyleElement()],<br/>    };<br/>};</span></pre><p id="ab3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以上代码来自<a class="ae kl" href="https://github.com/mui-org/material-ui/blob/master/examples/nextjs/pages/_document.js" rel="noopener ugc nofollow" target="_blank">https://github . com/mui-org/material-ui/blob/master/examples/nextjs/pages/_ document . js</a>。</p><p id="2e65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成以上步骤后，重启nextjs服务器，控制台警告就没了。</p><p id="57e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的结果发布在github-&gt;<a class="ae kl" href="https://github.com/thecodinganalyst/next-sample" rel="noopener ugc nofollow" target="_blank">https://github.com/thecodinganalyst/next-sample</a>上，带有来自material ui的工具栏和抽屉，以及动态路由如何在nextjs中工作的演示。</p><p id="966e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，也许material ui真的不适合与next js一起使用，我发现在开发模式下页面的加载似乎非常慢。尽管如此，当我在生产环境中运行它时，它还是可以的，因为页面是在构建时生成的。</p></div></div>    
</body>
</html>