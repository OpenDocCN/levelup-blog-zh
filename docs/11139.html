<html>
<head>
<title>Data Analysis with Google Cloud BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Cloud BigQuery进行数据分析</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/data-analysis-with-google-cloud-bigquery-197e3c4caba1?source=collection_archive---------7-----------------------#2022-02-18">https://levelup.gitconnected.com/data-analysis-with-google-cloud-bigquery-197e3c4caba1?source=collection_archive---------7-----------------------#2022-02-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d9b2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">案例研究:新冠肺炎社区流动性报告</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9796d0686ebf439a7979f9cabdf712a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ckS-fau0MOeJ63Ol_YZ-g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd ky">作者图片</strong></figcaption></figure><p id="17f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Google BigQuery已经为您提供了公共数据集来访问和集成到应用程序中。大多数时候，研究人员将大部分时间和资源浪费在数据收集和存储、数据清理和数据处理上。</p><h2 id="f622" class="lv lw it bd ky lx ly dn lz ma mb dp mc li md me mf lm mg mh mi lq mj mk ml mm bi translated">从BigQuery中释放数据集</h2><p id="ee40" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">你可以在这里获得几个免费的数据集，如谷歌社区移动报告、新冠肺炎事件、疫苗接种统计、犯罪统计等等。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/718aa50b28c05e8c1b34165b9704f848.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uC-74gZTBZSuTdkDZRaqzQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</figcaption></figure><p id="0b08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇短文将展示Google BigQuery如何通过新冠肺炎社区移动性报告的用例来帮助您轻松获得所需的最终数据。</p><h2 id="450e" class="lv lw it bd ky lx ly dn lz ma mb dp mc li md me mf lm mg mh mi lq mj mk ml mm bi translated">要求</h2><ul class=""><li id="8e56" class="mu mv it lb b lc mn lf mo li mw lm mx lq my lu mz na nb nc bi translated">Google Cloud <a class="ae ms" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">账号</a> = &gt;使用Google BigQuery</li><li id="1a27" class="mu mv it lb b lc nd lf ne li nf lm ng lq nh lu mz na nb nc bi translated">SQL基础知识= &gt;查询数据集</li><li id="376b" class="mu mv it lb b lc nd lf ne li nf lm ng lq nh lu mz na nb nc bi translated">Python知识(可选)= &gt;可视化数据</li></ul><h2 id="7fa4" class="lv lw it bd ky lx ly dn lz ma mb dp mc li md me mf lm mg mh mi lq mj mk ml mm bi translated">示例:使用BigQuery获取新冠肺炎社区移动性报告</h2><p id="df39" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">首先，登录你的谷歌云控制台，打开BigQuery。https://console.cloud.google.com/bigquery。然后，选择您想要的数据集。在这种情况下，我选择了<code class="fe ni nj nk nl b"><strong class="lb iu">covid19_google_mobility_eu</strong></code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/a65ef96c67821edcccac14c1f646e251.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ROGZRpQb-gNo7ne5mmS9Zw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd ky">在BigQuery上选择数据</strong>(作者)</figcaption></figure><p id="3111" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过单击“预览”选项卡快速浏览所选数据集。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/b12025bb4ebe6d0f94d345358edd32d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Z1Qj44pB4yiU7ZqJGJcrQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><code class="fe ni nj nk nl b"><strong class="bd ky">Preview of covid19_google_mobility_eu dataset </strong>(</code>作者<code class="fe ni nj nk nl b">)</code></figcaption></figure><p id="a7b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以通过点击“查询”按钮来尝试一些查询。</p><h2 id="836f" class="lv lw it bd ky lx ly dn lz ma mb dp mc li md me mf lm mg mh mi lq mj mk ml mm bi translated"><strong class="ak">示例问题</strong>:在德国，每个地区去公园和工作场所的流动率变化百分比是多少？</h2><p id="c1b8" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated"><strong class="lb iu">查询:</strong></p><pre class="kj kk kl km gt no nl np nq aw nr bi"><span id="63ba" class="lv lw it nl b gy ns nt l nu nv"><strong class="nl iu">SELECT</strong><br/>   country_region,<br/>   sub_region_1,<br/>   parks_percent_change_from_baseline,<br/>   workplaces_percent_change_from_baseline<br/><strong class="nl iu">FROM</strong><br/>   `bigquery-public-data.covid19_google_mobility_eu.mobility_report`<br/><strong class="nl iu">WHERE</strong><br/>   country_region = "Germany"<br/><strong class="nl iu">LIMIT</strong><br/>   1000;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/26e06d84619d61e46a268dedafddf236.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-jLYlajJtdOIMNiwW9YR9w.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><code class="fe ni nj nk nl b"><strong class="bd ky">Query result from Covid19_google_mobility_eu dataset </strong>(</code>作者<code class="fe ni nj nk nl b">)</code></figcaption></figure><p id="09dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">结果:</strong>差不多了，但是我们得到了几个重复的<code class="fe ni nj nk nl b">sub_region_1</code>行，所以我们需要使用SQL聚合函数将重复的<code class="fe ni nj nk nl b">sub_region_1</code>分组在一起。所以，让我们再试一次！</p><p id="a92a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">查询:</strong></p><pre class="kj kk kl km gt no nl np nq aw nr bi"><span id="d464" class="lv lw it nl b gy ns nt l nu nv"><strong class="nl iu">SELECT<br/>   </strong>sub_region_1,<br/>   AVG(parks_percent_change_from_baseline)  parks_percent_change,<br/>   AVG(workplaces_percent_change_from_baseline) work_percent_change,<br/><strong class="nl iu">FROM</strong> <br/>   `bigquery-public-data.covid19_google_mobility_eu.mobility_report`<br/><strong class="nl iu">WHERE<br/>   </strong>country_region = "Germany"<br/><strong class="nl iu">GROUP BY</strong><br/>   sub_region_1<br/><strong class="nl iu">LIMIT</strong> <br/>   1000;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/009b1edf6e2fba45876a3bcd705f1443.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w2dN5WlhUeQR2Sa6Umq4Zw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><code class="fe ni nj nk nl b"><strong class="bd ky">Query result from Covid19_google_mobility_eu dataset </strong>(</code>作者<code class="fe ni nj nk nl b">)</code></figcaption></figure><h2 id="6b6b" class="lv lw it bd ky lx ly dn lz ma mb dp mc li md me mf lm mg mh mi lq mj mk ml mm bi translated">导出结果</h2><p id="d9cd" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">现在，我们可以以我们需要的格式导出这些数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/ac3012ef9754a3c2392a2cfb2f0d7af5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tnt-7OT8h-tBylyVQKQm5Q.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><code class="fe ni nj nk nl b"><strong class="bd ky">Export Query result from Covid19_google_mobility_eu dataset </strong>(</code>作者<code class="fe ni nj nk nl b">)</code></figcaption></figure><h2 id="c460" class="lv lw it bd ky lx ly dn lz ma mb dp mc li md me mf lm mg mh mi lq mj mk ml mm bi translated">探索结果可视化</h2><p id="a34e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们可以使用任何工具进行简单的可视化，例如Google Data Studio、Excel或任何软件。在本文中，我将使用Python和matplotlib，因为它们是我最喜欢的工具。您可以使用任何Python idle/ Jupyter笔记本来遵循这个示例。</p><pre class="kj kk kl km gt no nl np nq aw nr bi"><span id="7d16" class="lv lw it nl b gy ns nt l nu nv"># import modules<strong class="nl iu"><br/>import pandas as pd<br/>import matplotlib.pyplot as plt</strong></span><span id="d50b" class="lv lw it nl b gy nz nt l nu nv"># load query result<strong class="nl iu"><br/>query_data = pd.read_csv("/content/drive/MyDrive/bq-results-20220218-140017-rcae0my456p2/bq-results-update.csv")</strong></span><span id="91fd" class="lv lw it nl b gy nz nt l nu nv"># Plot<strong class="nl iu"><br/>fig, ax = plt.subplots(1, 1, figsize=(10,10))<br/>query_data.plot.bar(x="sub_region_1", ax=ax)</strong></span><span id="1d0f" class="lv lw it nl b gy nz nt l nu nv"># Some plot decoration<br/><strong class="nl iu">ax.spines['top'].set_visible(False)<br/>ax.spines['right'].set_visible(False)<br/>ax.spines['left'].set_visible(False)<br/>ax.spines['bottom'].set_color('#DDDDDD')<br/>ax.set_axisbelow(True)<br/>ax.yaxis.grid(True, color='#EEEEEE')<br/>ax.xaxis.grid(False)</strong></span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/24da7cab0a9fe3678d669e21c3b6eb60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DCNCN7m64CyZkso62GhL_w.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd ky">德国各分区参观公园/工作场所的人数百分比变化</strong>(作者)</figcaption></figure><p id="a84e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了更好地可视化，我们可以在GeoPandas模块的帮助下使用地图来说明该数据集。首先，我们需要地图数据。在这种情况下，我们可以从这个<a class="ae ms" href="https://github.com/isellsoap/deutschlandGeoJSON" rel="noopener ugc nofollow" target="_blank">回购</a>中获得德国GeoJSON数据。然后，我们可以做一个简单的连接(左连接)来</p><pre class="kj kk kl km gt no nl np nq aw nr bi"><span id="967b" class="lv lw it nl b gy ns nt l nu nv"><strong class="nl iu">import pandas as pd<br/>import numpy as np<br/>import geopandas as gpd<br/>import matplotlib<br/>import matplotlib.pyplot as plt</strong></span><span id="d06b" class="lv lw it nl b gy nz nt l nu nv">## Load Germany Map Data<br/><strong class="nl iu">germany = gpd.read_file("https://raw.githubusercontent.com/isellsoap/deutschlandGeoJSON/main/2_bundeslaender/2_hoch.geo.json") </strong></span><span id="6348" class="lv lw it nl b gy nz nt l nu nv">## Load Query Result<br/><strong class="nl iu">query_data = pd.read_csv("/content/drive/MyDrive/bq-results-20220218-140017-rcae0my456p2/bq-results-update.csv")</strong></span><span id="ad5a" class="lv lw it nl b gy nz nt l nu nv">## Merge Query result to the map data</span><span id="19cb" class="lv lw it nl b gy nz nt l nu nv"><strong class="nl iu">df_merge = pd.merge(germany, query_data, how="left", left_on='name', right_on='sub_region_1')</strong></span><span id="80e9" class="lv lw it nl b gy nz nt l nu nv">## Draw MAP<br/><strong class="nl iu">fig, ax = plt.subplots(1, 1, figsize=(12,12))<br/>df_merge.plot(ax=ax,<br/>              column='parks_percent_change_from_baseline_avg',<br/>              cmap='OrRd',<br/>              scheme='quantiles',<br/>              legend=True,<br/>              linewidth=1.5,);</strong></span></pre><p id="8fbf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行脚本后，我们得到地图可视化，以查看德国公园游客的平均百分比变化。从可视化中，我们可以发现，来自北方的人比其他州的人更倾向于外出。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/8125700ce2a04ea16d3c7a7198059dbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mvUgaypxNJ3Sspjl1H-4LA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">疫情2008年9月19日之后，参观公园的人的百分比变化</figcaption></figure><p id="cac8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是另一个结果——人们去工作场所的百分比变化。我们可以清楚地看到，来自南德国的人倾向于更多地呆在家庭办公室。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/e98e63ff2ade73232017a0b7ff74ea1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H4458BhaUqRaZ8DASzJSRw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd ky">疫情2019年奥运会后，参观公园的游客比例变化</strong>(作者)</figcaption></figure><h1 id="ef8c" class="od lw it bd ky oe of og lz oh oi oj mc jz ok ka mf kc ol kd mi kf om kg ml on bi translated">结论</h1><p id="ce50" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">本文提供了从BigQuery获取访问和查询数据的分步教程，随后是一些使用条形图和choropleth图的数据可视化技术的示例。我希望这篇文章对您有所帮助，并且能够将这种技术应用到您的项目中。</p><p id="eca5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">平安健康！</strong></p></div></div>    
</body>
</html>