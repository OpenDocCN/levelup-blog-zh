<html>
<head>
<title>Salesforce Functions with Heroku Postgres</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Heroku Postgres的Salesforce功能</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/salesforce-functions-with-heroku-postgres-c79acaeb8c41?source=collection_archive---------17-----------------------#2022-12-28">https://levelup.gitconnected.com/salesforce-functions-with-heroku-postgres-c79acaeb8c41?source=collection_archive---------17-----------------------#2022-12-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><h1 id="93bc" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">Salesforce函数和Heroku数据系列:三部分之一</h1><p id="c3ff" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">本文是关于在<a class="ae lm" href="https://developer.salesforce.com/docs/platform/functions/overview" rel="noopener ugc nofollow" target="_blank"> Salesforce功能</a>内利用<a class="ae lm" href="https://www.heroku.com/managed-data-services" rel="noopener ugc nofollow" target="_blank"> Heroku托管数据</a>产品的三部分系列文章的第一部分。在本文中，我们将关注<a class="ae lm" href="https://www.heroku.com/postgres" rel="noopener ugc nofollow" target="_blank"> Heroku Postgres </a>的用例。在第二和第三部分中，我们将讨论创建Salesforce函数，这些函数使用Heroku上的Redis 和Apache Kafka<a class="ae lm" href="https://www.heroku.com/kafka" rel="noopener ugc nofollow" target="_blank">的Heroku数据。</a></p><h1 id="91d6" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">核心概念介绍</h1><h1 id="5859" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">什么是Salesforce功能？</h1><p id="beff" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">Salesforce功能是一段自定义代码，用于扩展您的Salesforce应用程序或流程。自定义代码可以利用您在Salesforce实例的安全环境中运行时选择的语言和库。</p><p id="b91a" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">例如，您可以利用JavaScript库根据Salesforce中的触发流程更新Heroku Postgres数据库。如果您不熟悉Salesforce函数，那么“T10了解Salesforce函数T11”是了解Salesforce函数及其工作原理的好地方。</p><h1 id="c6e3" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">什么是Heroku Postgres？</h1><p id="cc89" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><a class="ae lm" href="https://www.heroku.com/postgres" rel="noopener ugc nofollow" target="_blank"> Heroku Postgres </a>是Heroku为您管理的一个<a class="ae lm" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> Postgres </a>数据库。这意味着Heroku负责安全、备份和维护等工作。你所要做的就是使用它。了解Heroku Postgres细节的最佳途径是在Heroku Devcenter文档中。</p><h1 id="596f" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">Salesforce函数+ Heroku Postgres的示例</h1><p id="1912" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在我们对函数和Heroku Postgres有了更多的了解，我们可以一起用它们做什么呢？有几种方式来思考功能，但是最有用的一种方式是将它们视为<strong class="kq iu">帮助整合或扩展你的组织</strong>。例如，当Salesforce发生一些事情时，<em class="ls">做一些其他的任务</em>。</p><p id="b161" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">总体而言，如果您有以下情况，您可能希望将Heroku Postgres与您的Salesforce功能结合使用:</p><ol class=""><li id="865f" class="lt lu it kq b kr ln kv lo kz lv ld lw lh lx ll ly lz ma mb bi translated">需要访问关系数据库作为函数操作的一部分</li><li id="71d9" class="lt lu it kq b kr mc kv md kz me ld mf lh mg ll ly lz ma mb bi translated">需要与作为另一个系统一部分的Heroku Postgres实例集成</li><li id="fc78" class="lt lu it kq b kr mc kv md kz me ld mf lh mg ll ly lz ma mb bi translated">需要从您的Salesforce组织中卸载“繁重”的任务并存储关系数据来实现它</li></ol><p id="2649" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">以上模式不是唯一的，但它们可能是最常见的。下面的用例是这些模式运行的例子。</p><h1 id="3377" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用案例#1:对多个Salesforce组织的帐户记录进行重复数据删除</h1><p id="87c9" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">成长型公司中的一个常见问题是拥有多个Salesforce组织，客户在它们之间重复。有时，这是因为公司收购了另一家公司，两家公司共享客户。</p><p id="4735" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">在其他情况下，公司只是有不同的业务线，而客户是两者的一部分。在现实中，如果我们知道两个客户确实是同一个客户，那么我们希望将他们视为一个客户。合并这些组织数据通常需要很长时间，那么我们该怎么办呢？</p><p id="6bfa" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">一种方法是通过<a class="ae lm" href="https://devcenter.heroku.com/articles/heroku-connect" rel="noopener ugc nofollow" target="_blank"> Heroku Connect </a>将来自两个组织的账户信息同步到<a class="ae lm" href="https://devcenter.heroku.com/categories/heroku-postgres" rel="noopener ugc nofollow" target="_blank"> Heroku Postgres </a>中，并触发可以寻找重复的Salesforce功能。我们可以根据需要为某些活动运行此功能，或者将其设置为在创建新帐户后运行。例如，每当系统遇到“客户的电子邮件已经存在于[母公司]”时。下图说明了这种使用情况:</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mh"><img src="../Images/53c20c7de5273baf3564c92178bf040b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Zyd4YI7SbTEYrRor.png"/></div></div></figure><h1 id="cb12" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">用例2:添加新库存时更新面向客户的网站</h1><p id="9790" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">许多公司使用Salesforce作为关键信息的“真实来源”，但他们在Heroku上有一个面向客户的网站。在此用例中，当在Salesforce中更新一个项目(如库存编号)时，会触发Salesforce函数来更新Heroku Postgres，该函数支持向客户显示此信息的网站。</p><p id="b667" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">这种模式可以扩展到做其他事情，比如获取额外的信息与Heroku Postgres中的记录一起存储，或者清除缓存。当网站需要该信息，但您不需要将其存储在Salesforce中时，这可能很有用。</p><h1 id="bb00" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">用例3:为大型数据集生成报告</h1><p id="de56" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在大量使用Salesforce的大型组织中，许多用户可能会有重叠的任务。通常，最终用户意识不到他们对共享系统的影响。将繁重的操作或报告移出组织可以让其他操作执行得更好。一种简单的方法是通过Heroku Connect将所需数据同步到Heroku Postgres，并通过Salesforce函数执行操作。这为优化和利用开源工具和库来处理数据提供了选择。</p><p id="88a7" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">如果需要将结果写回Salesforce，这种模式也很适用。例如，如果您需要计算销售区域，但将结果存储回Salesforce组织。</p><p id="da27" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">Salesforce功能是Salesforce生态系统中一项强大的新功能。Heroku Postgres是托管Postgres领域久经考验的市场领导者。它们一起打开了许多用例。结合Heroku提供的额外服务，有许多选项可以充分利用您的Salesforce数据。在下一节中，我们将简要地研究如何开始使用您自己的用例。</p><h1 id="5a6b" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">我如何开始？</h1><p id="0191" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">您将需要一些东西—一些在Salesforce功能方面，一些在Heroku方面。这些资源会给你指明正确的方向。</p><p id="2941" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated"><strong class="kq iu">先决条件:</strong></p><ul class=""><li id="dfcc" class="lt lu it kq b kr ln kv lo kz lv ld lw lh lx ll mt lz ma mb bi translated"><a class="ae lm" href="https://developer.salesforce.com/docs/platform/functions/overview" rel="noopener ugc nofollow" target="_blank">访问Salesforce功能</a></li><li id="5a5d" class="lt lu it kq b kr mc kv md kz me ld mf lh mg ll mt lz ma mb bi translated"><a class="ae lm" href="https://signup.heroku.com/" rel="noopener ugc nofollow" target="_blank">访问Heroku数据服务</a></li></ul><p id="665f" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">【Salesforce功能入门</p><ul class=""><li id="038d" class="lt lu it kq b kr ln kv lo kz lv ld lw lh lx ll mt lz ma mb bi translated"><a class="ae lm" href="https://developer.salesforce.com/docs/platform/functions/guide/index.html" rel="noopener ugc nofollow" target="_blank">入门</a></li></ul><h1 id="63f3" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">从Salesforce函数访问Heroku Postgres</h1><p id="4e4e" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">一旦您了解了先决条件并创建了项目，您就可以运行以下命令来创建一个具有Heroku Postgres access的函数。</p><p id="902f" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">要创建新的JavaScript函数，请运行以下命令:</p><pre class="mi mj mk ml gt mu mv mw bn mx my bi"><span id="cefc" class="mz jr it mv b be na nb l nc nd">$ sf generate function -n yourfunction -l javascript</span></pre><p id="30a7" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">这将为您提供一个包含Node.js应用程序模板的<code class="fe ne nf ng mv b">/functions</code>文件夹。</p><h2 id="92eb" class="nh jr it bd js ni nj dn jw nk nl dp ka kz nm nn ke ld no np ki lh nq nr km ns bi translated">连接到您的数据库</h2><p id="1d85" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">当然，您的Salesforce功能代码将需要包括一些特定的部分，以确保与数据库的正确连接。最简单的方法是包含用于将数据库URL指定为环境变量的<a class="ae lm" href="https://www.npmjs.com/package/dotenv" rel="noopener ugc nofollow" target="_blank"> dotenv </a>包和作为Postgres客户端的<a class="ae lm" href="https://www.npmjs.com/package/pg" rel="noopener ugc nofollow" target="_blank"> pg </a>包。</p><pre class="mi mj mk ml gt mu mv mw bn mx my bi"><span id="f20e" class="mz jr it mv b be na nb l nc nd">import "dotenv/config";<br/>import pg from "pg";<br/>const { Client } = pg;</span></pre><p id="1276" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">在函数代码中，您需要连接到Postgres数据库。下面是一个连接助手函数的示例:</p><pre class="mi mj mk ml gt mu mv mw bn mx my bi"><span id="2d70" class="mz jr it mv b be na nb l nc nd">async function pgConnect() {<br/>  const client = new Client({<br/>    connectionString: process.env.DATABASE_URL,<br/>    ssl: {<br/>      rejectUnauthorized: false<br/>    }<br/>  });<br/>  await client.connect();<br/>  return client;<br/>}</span></pre><p id="d155" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">这假设您有一个指定您的<code class="fe ne nf ng mv b">DATABASE_URL</code>的<code class="fe ne nf ng mv b">.env</code>文件。</p><h2 id="5bf7" class="nh jr it bd js ni nj dn jw nk nl dp ka kz nm nn ke ld no np ki lh nq nr km ns bi translated">查询和存储</h2><p id="01a8" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在下面的示例函数中，我们从Salesforce Org中检索一些数据，然后将其存储在Postgres中。</p><pre class="mi mj mk ml gt mu mv mw bn mx my bi"><span id="fe58" class="mz jr it mv b be na nb l nc nd">export default async function (event, context, logger) {<br/>  // Send request to Salesforce data API to retrieve data<br/>  const sfid = await context.org.dataApi.query(<br/>    `SELECT Id FROM Account WHERE Name = 'Example Company'`<br/>  );<br/>  // Connect to postgres<br/>  const pg = await pgConnect();<br/>  // Store data result in postgres<br/>  client.query(`INSERT INTO companies (sfid) VALUES ($1)`, [sfid]);<br/>  // Close connection<br/>  pg.end()<br/>}</span></pre><h1 id="e3c6" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">在本地测试您的Salesforce功能</h1><p id="4e9e" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">要在本地测试您的函数，首先运行以下命令:</p><pre class="mi mj mk ml gt mu mv mw bn mx my bi"><span id="cc85" class="mz jr it mv b be na nb l nc nd">$ sf run function start</span></pre><p id="a83a" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">然后，您可以从另一个终端调用带有有效负载的函数:</p><pre class="mi mj mk ml gt mu mv mw bn mx my bi"><span id="f405" class="mz jr it mv b be na nb l nc nd">$ sf run function -l http://localhost:8080 -p '{"payloadID": "info"}'</span></pre><p id="b8c7" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">有关本地运行功能的更多信息，请参见本指南。</p><h1 id="30ed" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">关联您的Salesforce功能和Heroku环境</h1><p id="77c9" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在一切都按预期运行，让我们将该功能与计算环境关联起来。(有关如何创建计算环境和部署功能的更多信息，请查看<a class="ae lm" href="https://developer.salesforce.com/docs/platform/functions/guide/deploy.html" rel="noopener ugc nofollow" target="_blank">文档</a>。)</p><p id="a558" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">通过将Heroku用户作为协作者添加到您的职能计算环境，您可以关联您的Salesforce职能和Heroku环境:</p><pre class="mi mj mk ml gt mu mv mw bn mx my bi"><span id="fefa" class="mz jr it mv b be na nb l nc nd">$ sf env compute collaborator add --heroku-user username@example.com</span></pre><p id="3188" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">这些环境现在可以共享Heroku数据。</p><p id="94d1" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">接下来，您将需要计算环境的名称，以便可以将数据存储附加到它。</p><pre class="mi mj mk ml gt mu mv mw bn mx my bi"><span id="9dc0" class="mz jr it mv b be na nb l nc nd">$ sf env list</span></pre><p id="59f4" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">最后，您可以连接数据存储。</p><pre class="mi mj mk ml gt mu mv mw bn mx my bi"><span id="0fce" class="mz jr it mv b be na nb l nc nd">$ heroku addons:attach &lt;your-heroku-postgres-database&gt; --app &lt;your-compute-environment-name&gt;</span></pre><p id="dfb2" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">在您开始实施Salesforce职能和访问Heroku Postgres时，以下是一些可能对您有所帮助的其他资源:</p><ul class=""><li id="c30d" class="lt lu it kq b kr ln kv lo kz lv ld lw lh lx ll mt lz ma mb bi translated"><a class="ae lm" href="https://github.com/trailheadapps/functions-recipes/tree/main/functions/03_Context_UnitOfWork_JS" rel="noopener ugc nofollow" target="_blank"> JavaScript工作单元示例</a></li><li id="a5e8" class="lt lu it kq b kr mc kv md kz me ld mf lh mg ll mt lz ma mb bi translated"><a class="ae lm" href="https://devcenter.heroku.com/articles/connecting-heroku-postgres#connecting-in-node-js" rel="noopener ugc nofollow" target="_blank">从JavaScript连接到Heroku Postgres】</a></li></ul><p id="f9b1" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">现在，你要去比赛了！</p><h1 id="2f22" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">结论</h1><p id="9b0d" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">Salesforce功能为在您的Salesforce应用程序中访问和操作Heroku数据提供了多种可能性。在本系列的第一部分中，我们已经介绍了如何使用Salesforce函数来处理Heroku Postgres。在本系列的下一部分，我们将把Salesforce函数与Redis的Heroku数据集成在一起。然后，在这个系列的最后一篇文章中，我们将在Heroku上集成Apache Kafka。敬请期待！</p></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><h1 id="7317" class="jq jr it bd js jt oa jv jw jx ob jz ka kb oc kd ke kf od kh ki kj oe kl km kn bi translated">分级编码</h1><p id="19b8" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="7ce1" class="lt lu it kq b kr ln kv lo kz lv ld lw lh lx ll mt lz ma mb bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="5b98" class="lt lu it kq b kr mc kv md kz me ld mf lh mg ll mt lz ma mb bi translated">📰查看<a class="ae lm" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="c1b3" class="lt lu it kq b kr mc kv md kz me ld mf lh mg ll mt lz ma mb bi translated">🔔关注我们:<a class="ae lm" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae lm" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae lm" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="8566" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">🚀👉<a class="ae lm" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>