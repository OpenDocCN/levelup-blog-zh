<html>
<head>
<title>Obtain access token via authorization code grant with PKCE in angular using oidc-client-js and Microsoft Identity Platform.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用oidc-client-js和Microsoft Identity Platform，通过angular中PKCE的授权码授权获得访问令牌。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/obtain-access-token-via-authorization-code-grant-with-pkce-in-angular-using-oidc-client-js-and-d481873b5a8a?source=collection_archive---------7-----------------------#2020-04-13">https://levelup.gitconnected.com/obtain-access-token-via-authorization-code-grant-with-pkce-in-angular-using-oidc-client-js-and-d481873b5a8a?source=collection_archive---------7-----------------------#2020-04-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/7ecc79fa267fac3e80e69111cb54a519.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ChyDd7P3D1ZA5k7OiYBwZw.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Ashwini Chaudhary 在<a class="ae kf" href="https://unsplash.com/s/photos/authorized?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="76fb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最近，我了解到为什么<a class="ae kf" href="https://www.taithienbo.com/why-the-implicit-flow-is-no-longer-recommended-for-protecting-a-public-client/" rel="noopener ugc nofollow" target="_blank">隐式流不安全，因为在浏览器</a>中暴露了访问令牌。使用PKCE的授权码授予更安全，并且应该优先于隐式流来保护不能保证客户端秘密安全的公共应用。好消息是，如果你已经使用了oidc-client-js，并通过隐式流从azure ad获得令牌，那么在PKCE中使用授权代码流所做的更改是最小的。在这篇文章中，我展示了你需要改变什么来使用授权码授予PKCE。</p><p id="9a47" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有关代码参考，请在这里查看示例项目<a class="ae kf" href="https://github.com/taithienbo/oidc-client-js-azure-integration-ex/tree/feature/authorization-pkce-azuread" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="eebb" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">应用程序的变化</h1><ul class=""><li id="38b7" class="mc md it ki b kj me kn mf kr mg kv mh kz mi ld mj mk ml mm bi translated">在您的angular应用程序中，将oidc-client-js的response_type设置为“code”。</li></ul><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="3033" class="mw lf it ms b gy mx my l mz na">{</span><span id="1140" class="mw lf it ms b gy nb my l mz na">"client_id":"{replace with client id you register for your angular app in azure ad}",<br/>   "authority":"https://login.microsoftonline.com/{replace with your tenant id}/v2.0/",<br/>   "response_type":"code",<br/>   "post_logout_redirect_uri":"http://localhost:4200/",<br/>   "loadUserInfo":false,<br/>   "redirect_uri":"http://localhost:4200/",<br/>   "silent_redirect_uri":"http://localhost:4200/",<br/>   "scope":"{replace with the scope you define in Expose API section of the app registration for your api in azure ad} openid profile"</span><span id="6358" class="mw lf it ms b gy nb my l mz na">}</span></pre><h1 id="f364" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">azure应用注册的变化</h1><ul class=""><li id="7f0f" class="mc md it ki b kj me kn mf kr mg kv mh kz mi ld mj mk ml mm bi translated">在您的angular应用程序注册清单中，将<strong class="ki iu"> allowPublicClient </strong>设置为<strong class="ki iu"> true </strong>，并将<strong class="ki iu"> replyUrlsWithType </strong>部分下的<strong class="ki iu"> type </strong>设置为<strong class="ki iu"> Spa </strong>。</li></ul><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="244e" class="mw lf it ms b gy mx my l mz na">{<br/>  "id": "...",<br/>  "allowPublicClient": true,<br/>  // ....</span><span id="5066" class="mw lf it ms b gy nb my l mz na">  "replyUrlsWithType": [<br/>    {<br/>      "url": "<a class="ae kf" href="http://localhost:4200" rel="noopener ugc nofollow" target="_blank">http://localhost:4200</a>",<br/>      "type": "Spa"<br/>    }<br/>  ]<br/>}</span></pre><ul class=""><li id="bb1e" class="mc md it ki b kj kk kn ko kr nc kv nd kz ne ld mj mk ml mm bi translated">在<strong class="ki iu">认证</strong>下，<strong class="ki iu">高级设置</strong>，设置<br/> <strong class="ki iu">将应用程序视为公共客户端</strong>为<strong class="ki iu">是</strong>。</li></ul><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nf"><img src="../Images/552f444a194038580ee99d06ade8244b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Vj2JuP4yxMtfeoKE"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">将应用程序设置为公共客户端，以通过PKCE使用授权码</figcaption></figure><p id="fe00" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样。虽然变化很小，但我花了几个小时才意识到需要在清单文件中进行更改以启用授权。这可能是因为PKCE对授权流的支持还是新生事物。事实上，在撰写本文时，MSAL JavaScript库刚刚发布了一个支持PKCE授权代码的alpha版本。</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ng"><img src="../Images/d49439e936164148cd1f283b1928b482.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0Qd5ZHuhw0VleTwC"/></div></div></figure><h1 id="c885" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">参考</h1><p id="40d8" class="pw-post-body-paragraph kg kh it ki b kj me kl km kn mf kp kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated"><a class="ae kf" href="https://www.scottbrady91.com/Angular/Migrating-oidc-client-js-to-use-the-OpenID-Connect-Authorization-Code-Flow-and-PKCE" rel="noopener ugc nofollow" target="_blank">迁移oidc-client-js以使用OpenID连接授权代码流和PKCE </a></p><p id="dbef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://developer.okta.com/blog/2019/08/22/okta-authjs-pkce" rel="noopener ugc nofollow" target="_blank">用PKCE流程实现OAuth 2.0授权码</a></p><p id="7d5e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://tools.ietf.org/html/draft-ietf-oauth-browser-based-apps-04#section-9.8.6" rel="noopener ugc nofollow" target="_blank">隐性流量的弊端</a> <a class="ae kf" href="https://github.com/AzureAD/microsoft-authentication-library-for-js/tree/dev/lib/msal-browser#releases" rel="noopener ugc nofollow" target="_blank"> Msal-browser发布</a></p></div><div class="ab cl nk nl hx nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="im in io ip iq"><p id="28fa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nr">原载于2020年4月13日https://www.taithienbo.com</em><em class="nr"/><a class="ae kf" href="https://www.taithienbo.com/obtain-access-token-via-authorization-code-grant-with-pkce-in-angular-using-oidc-client-js-and-microsoft-identity-platform/" rel="noopener ugc nofollow" target="_blank"><em class="nr">。</em></a></p></div></div>    
</body>
</html>