<html>
<head>
<title>Bring your code to the Edge fast and securely with Lambda@Edge, CloudFront, and S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助Lambda@Edge、CloudFront和S3，快速安全地将您的代码带到边缘</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/bring-your-code-to-the-edge-fast-and-securely-5112a76bead9?source=collection_archive---------2-----------------------#2018-11-19">https://levelup.gitconnected.com/bring-your-code-to-the-edge-fast-and-securely-5112a76bead9?source=collection_archive---------2-----------------------#2018-11-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3a48d0243b4a7845557e9b2137e5a9df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SAQADCQO8_I3XxAx3soW7A.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">詹妮弗·卡佩尔在<a class="ae kc" href="https://unsplash.com/search/photos/edge?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="5eac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在你开始阅读这篇文章之前，我建议你先熟悉一下<a class="ae kc" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-edge.html" rel="noopener ugc nofollow" target="_blank"> Lambda@Edge </a>、<a class="ae kc" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Introduction.html" rel="noopener ugc nofollow" target="_blank"> CloudFront </a>和<a class="ae kc" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> S3 </a>。</p><p id="f843" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最近，我的团队决定将其前端架构从使用<a class="ae kc" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> Nginx </a>改为AWS Lambda@Edge。我们使用Nginx的目的是为了给我们的文件添加安全头，但是现在<a class="ae kc" href="https://aws.amazon.com/compliance/services-in-scope" rel="noopener ugc nofollow" target="_blank"> AWS Lambda@Edge是SOC2 </a> complaint，没有理由再使用Nginx了。此外，我们可以借此机会构建一个无服务器应用程序。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/97d0ebbbeaf602a87f8fbdd69faf4a13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*6zRzfnlkzgvSQv--3v1jXg.jpeg"/></div></figure><p id="a8da" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，我们将展示如何在一个使用亚马逊S3托管文件的应用程序中实现额外的安全响应头。我们还将回顾如何使用Lambda@Edge来提供来自S3的压缩文件<strong class="kf ir">，而不使用CloudFront中的<a class="ae kc" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/ServingCompressedFiles.html" rel="noopener ugc nofollow" target="_blank">自动压缩功能</a>。</strong></p><p id="ce08" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们开始之前，让我们快速了解一下Lambda@Edge:</p><p id="0c03" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">λ@边缘概述</strong></p><p id="5371" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Lambda@Edge提供了在Amazon CloudFront Edge位置执行Lambda函数的能力。此功能支持在靠近客户的位置智能处理HTTP请求(就延迟而言)。为什么这很重要？例如，我们应用的Nginx位置在美国，而我们客户的边缘位置在中国，正如你所想象的，这可能会对延迟产生负面影响。此外，另一个优势是我们不必一直维护服务器，我们可以让AWS为我们扩展。</p><blockquote class="lg lh li"><p id="f4a0" class="kd ke lj kf b kg kh ki kj kk kl km kn lk kp kq kr ll kt ku kv lm kx ky kz la ij bi translated">Lambda@Edge是AWS Lambda的扩展，它允许您在全局AWS位置运行Node.js代码</p><p id="79a9" class="kd ke lj kf b kg kh ki kj kk kl km kn lk kp kq kr ll kt ku kv lm kx ky kz la ij bi translated">将您自己的代码带到边缘，并定制非常贴近您的用户的内容，从而改善最终用户体验</p></blockquote><p id="9520" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当使用CloudFront和Lambda@Edge时，可以使用CloudFront的事件来调用Lambda@Edge函数。您可以运行Lambda@Edge函数来响应四个不同的CloudFront事件:查看器请求、源请求、源响应和查看器响应。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/30e6433dd21c467f4f02db685754dc77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*ZitRPstFKx3016JsykcjXA.png"/></div></figure><p id="5f16" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们的例子中，lambda函数由以下两个事件调用:</p><p id="afa9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">原点请求</strong> —该事件在CloudFront向原点(S3)请求对象后触发。它可以访问来自CloudFront的请求。</p><p id="080c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">原点响应</strong> —原点(S3)对请求返回响应后触发此事件。它可以访问来自源的响应。</p><p id="f52a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请记住，您希望尽可能避免<strong class="kf ir">查看器请求</strong>事件，因为它会在每次客户端发送请求时运行，并且会增加延迟和使用Lambda@Edge的月费用。</p><p id="f5ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下图说明了触发Lambda@Edge功能的事件顺序:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lo"><img src="../Images/687e2b45d7e8d108ecabcb298952fdb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V8cK0PdTzvCkpPhEl1l7pA.png"/></div></div></figure><p id="53c3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">流程是这样的:</strong></p><ol class=""><li id="655f" class="lp lq iq kf b kg kh kk kl ko lr ks ls kw lt la lu lv lw lx bi translated">观众请求网站<a class="ae kc" href="http://www.example.com." rel="noopener ugc nofollow" target="_blank">www.example.com。</a></li><li id="6235" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">如果该对象已经被缓存，则转到步骤7，否则转到步骤3。</li><li id="8eae" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">CloudFront从起点请求对象，在本例中是一个S3桶，这又导致CloudFront触发起点请求事件。</li><li id="262b" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">我们需要触发一个“原始请求”Lambda函数，它将请求转发给S3 bucket，只请求一个gzipped对象。</li><li id="33c0" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">S3返回对象，这又导致CloudFront触发源响应事件。</li><li id="545b" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">“源响应”Lambda函数被触发，它添加安全响应头，结果输出由CloudFront缓存和提供。</li><li id="e82a" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">CloudFront将对象从缓存返回给查看器。</li></ol><p id="25d3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">下面是压缩过程的工作原理:</strong></p><ol class=""><li id="56f3" class="lp lq iq kf b kg kh kk kl ko lr ks ls kw lt la lu lv lw lx bi translated">使用Gzip算法压缩文件。</li><li id="5880" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">上传压缩文件到S3。</li><li id="649f" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">将“Content-Length”报头作为允许的报头添加到您的S3存储桶的<a class="ae kc" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/cors.html" rel="noopener ugc nofollow" target="_blank"> CORS配置</a>中，浏览器使用该报头来确定何时可以重用连接。</li><li id="cc9b" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">禁用CloudFront中的自动压缩功能。</li><li id="1a8c" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">使用Lambda@Edge将请求URI更改为仅请求gzipped文件，并在响应中返回“content-encoding”标头。</li></ol><p id="319e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">这里是lambda函数的一个例子:</strong></p><p id="a829" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">原点请求</strong>λ函数:</p><pre class="lc ld le lf gt md me mf mg aw mh bi"><span id="22e0" class="mi mj iq me b gy mk ml l mm mn"><em class="lj">/**<br/> * Function registered on 'Origin Request' CloudFront Event<br/> */<br/></em>exports.handler = (event, context, callback) =&gt; {<br/>  <strong class="me ir">const </strong>request = event.Records[0].cf.request;<br/>  <strong class="me ir">try </strong>{<br/>    <strong class="me ir">if </strong>(request.uri) {<br/>      // Change URI to always use gzipped resources.<br/>      request.uri = request.uri + '.gz';<br/>    }<br/>  } <strong class="me ir">catch </strong>(e) {<br/>    console.log('origin request handler - an error occurred: ', e);<br/>  } <strong class="me ir">finally </strong>{<br/>    callback(<strong class="me ir">null</strong>, request);<br/>  }<br/>};</span></pre><p id="1e83" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">原点响应</strong>λ函数:</p><pre class="lc ld le lf gt md me mf mg aw mh bi"><span id="6944" class="mi mj iq me b gy mk ml l mm mn"><em class="lj">/**<br/> * Function registered on 'Origin Response' CloudFront Event<br/> */<br/></em>exports.handler = (event, context, callback) =&gt; {<br/>  <strong class="me ir">const </strong>response = event.Records[0].cf.response;<br/>  <strong class="me ir">try </strong>{<br/>    <strong class="me ir">const </strong>requestUri = event.Records[0].cf.request.uri;<br/>   <br/>    // Check if the request uri has extension of a compressed file,<br/>    // if so - add the corresponding header<br/>    // The keys in the headers object are lowercase versions of the<br/>    // header names in the HTTP request.<br/>    <strong class="me ir">if </strong>(requestUri.endsWith('.gz')) {<br/>      response.headers['content-encoding'] = [{<br/>        key: 'Content-Encoding',<br/>        value: 'gzip'<br/>      }];<br/>    }</span><span id="89ea" class="mi mj iq me b gy mo ml l mm mn">    // here you can add the security headers you wish to add the<br/>    // response<br/>    response.headers['strict-transport-security'] = [{<br/>      key: 'Strict-Transport-Security',<br/>      value: 'max-age=31536000; includeSubdomains'<br/>    }];<br/>    response.headers['x-content-type-options'] = [{<br/>      key: 'X-Content-Type-Options',<br/>      value: 'nosniff'<br/>    }];<br/>    response.headers['x-frame-options'] = [{<br/>      key: 'X-Frame-Options',<br/>      value: "SAMEORIGIN"<br/>    }];<br/>    response.headers['referrer-policy'] = [{<br/>      key: 'Referrer-Policy',<br/>      value: "same-origin"<br/>    }];<br/>    response.headers['x-xss-protection'] = [{<br/>      key: 'X-XSS-Protection',<br/>      value: "1; mode=block"<br/>    }];<br/>    response.headers['accept-ranges'] = [{<br/>      key: 'Accept-Ranges',<br/>      value: "bytes"<br/>    }];<br/>    response.headers['content-security-policy'] = [{<br/>      key: 'Content-Security-Policy',<br/>      value: "frame-ancestors 'self'"<br/>    }];<br/>  } <strong class="me ir">catch </strong>(e) {<br/>    console.log('origin response handler - an error occurred: ', e);<br/>  } <strong class="me ir">finally </strong>{<br/>    callback(<strong class="me ir">null</strong>, response);<br/>  }<br/>};</span></pre><p id="be5a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在这里阅读更多关于安全标题的信息。</p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><p id="3951" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，你可能会问为什么不在CloudFront中使用自动压缩特性？</p><p id="be3a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看看你不这样做能得到什么:</p><ol class=""><li id="3f56" class="lp lq iq kf b kg kh kk kl ko lr ks ls kw lt la lu lv lw lx bi translated">在您的S3文件中的每次更改之后，对这些文件的第一个web请求将会导致网络延迟，因为CloudFront必须将它们从源位置提取到缓存中。通过启用自动压缩，我们在缓存文件之前压缩文件会增加额外的延迟。因此，如果您提前压缩文件，您的用户就不会经历这种延迟。尽管它只会发生在第一个请求这些文件的用户身上，但它仍然会发生在每个CloudFront Edge位置。因此，每次您部署时，都会有一群用户体验到延迟，这不是您希望您的用户体验到的。</li><li id="6d09" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">你也可以使用另一种算法进行压缩，比如<a class="ae kc" href="https://github.com/google/brotli" rel="noopener ugc nofollow" target="_blank">布罗特利</a>。用Brotli压缩的Javascript文件比用Gzip压缩的小14%<strong class="kf ir"/>。因为不是所有的浏览器都支持Brotli，所以您可以将Gzip和Brotli文件上传到S3，并使用<a class="ae kc" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesForwardHeaders" rel="noopener ugc nofollow" target="_blank">白名单头</a>选择<code class="fe mw mx my me b">Accept-Encoding</code>请求头作为您希望CloudFront<a class="ae kc" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/header-caching.html#header-caching-web-compressed" rel="noopener ugc nofollow" target="_blank">基于</a>进行缓存的头。</li><li id="4838" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated">你在S3上使用的空间更少，这意味着花的钱更少。</li></ol></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><p id="317c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">总而言之，我们看到了如何使用Lambda@Edge、CloudFront和S3来定制我们的响应头并提供压缩文件，我们获得了改善延迟和添加安全头的强大优势。</p><p id="873f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用Lambda@Edge，自定义标题和更改URIs并不是唯一可以做的事情。你也可以实现<a class="ae kc" href="https://aws.amazon.com/blogs/networking-and-content-delivery/authorizationedge-how-to-use-lambdaedge-and-json-web-tokens-to-enhance-web-application-security/" rel="noopener ugc nofollow" target="_blank">无服务器授权</a>，运行A/B测试等等，你可以在这里查看一些例子<a class="ae kc" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-examples.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="c39e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有用的链接:</p><ol class=""><li id="6da9" class="lp lq iq kf b kg kh kk kl ko lr ks ls kw lt la lu lv lw lx bi translated"><a class="ae kc" href="https://www.slideshare.net/AmazonWebServices/building-serverless-websites-with-lambdaedge-aws-online-tech-talks" rel="noopener ugc nofollow" target="_blank">用lambda@edge构建无服务器网站</a></li><li id="d391" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated"><a class="ae kc" href="https://github.com/aws-samples/aws-lambda-edge-workshops" rel="noopener ugc nofollow" target="_blank"> AWS Lambda@Edge车间</a></li><li id="214d" class="lp lq iq kf b kg ly kk lz ko ma ks mb kw mc la lu lv lw lx bi translated"><a class="ae kc" href="https://medium.com/buildit/a-b-testing-on-aws-cloudfront-with-lambda-edge-a22dd82e9d12" rel="noopener">在AWS CloudFront上使用Lambda@Edge进行A/B测试</a></li></ol></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><figure class="lc ld le lf gt jr gh gi paragraph-image"><a href="https://levelup.gitconnected.com"><div class="gh gi mz"><img src="../Images/ff5028ba5a0041d2d76d2a155f00f05e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JaoZbi7tTKJ5vL7i2OAYMQ.png"/></div></a></figure><div class="na nb gp gr nc nd"><a href="https://gitconnected.com/learn/amazon-web-services-aws" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd ir gy z fp ni fr fs nj fu fw ip bi translated">学习AWS -最佳AWS教程(2019) | gitconnected</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">16大AWS教程。课程由开发人员提交并投票，使您能够找到最好的AWS课程…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">gitconnected.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr jw nd"/></div></div></a></div></div></div>    
</body>
</html>