<html>
<head>
<title>Keep API keys out of Git repositories: a few concrete examples</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将API密钥放在Git存储库之外:几个具体的例子</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/keep-api-keys-out-of-git-repositories-a-few-concrete-examples-80f2544789aa?source=collection_archive---------6-----------------------#2021-03-25">https://levelup.gitconnected.com/keep-api-keys-out-of-git-repositories-a-few-concrete-examples-80f2544789aa?source=collection_archive---------6-----------------------#2021-03-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/08fe664e162623dd7322208a125e621d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4Z-EptvEyAVvxZkk"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@tjevans?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">蒂姆·埃文斯</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="9619" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以在网上找到很多关于如何将API密匙和密码之类的“秘密”排除在Git库之外的建议，但是我还没有找到Java程序的具体例子。本文将详细介绍这些具体的例子。</p><p id="1011" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有很多不同的方法可以将API密匙放在Git仓库之外，每种方法都有自己的优缺点。一些文章解释了利弊，但是没有例子，很难评估哪种方法是你的特定项目的最佳方法。</p><p id="5a6e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">希望我在这里展示的这些例子能够帮助您找出哪种将API键放在您自己的Java Git库之外的方法对您自己的项目最有意义。</p><p id="50a8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于本文的例子，我将使用<code class="fe le lf lg lh b">CurrencyConverter</code>类，它只有一个函数，静态的<code class="fe le lf lg lh b">convert()</code>函数。那个函数有一个<code class="fe le lf lg lh b">CurrencyAmount</code>对象和一个<code class="fe le lf lg lh b">Currency</code>对象(后者来自<code class="fe le lf lg lh b">java.util</code>包，前者是我一直在做的)。</p><p id="6a69" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">convert()</code>函数查询一个在线API，如果一切顺利，返回一个新的<code class="fe le lf lg lh b">CurrencyAmount</code>对象，该对象对应于转换为指定<code class="fe le lf lg lh b">Currency</code>的原始<code class="fe le lf lg lh b">CurrencyAmount</code>对象。</p><p id="8e21" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果这个函数接收到一个对应于$100.00和<code class="fe le lf lg lh b">Currency.getInstance(Locale.JAPAN)</code>的<code class="fe le lf lg lh b">CurrencyAmount</code>对象，它应该返回一个对应于10901的新的<code class="fe le lf lg lh b">CurrencyAmount</code>对象，上下相差几日元。</p><p id="c31f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以使用一些不同的API来实现这个目的。有些是免费的，不需要API密钥，但它们的货币很少，数据可能长达一周。</p><p id="27c8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一些更好的API，有更多最新的信息和更广泛的货币选择，也是免费的，但它们需要一个API密钥(如果你找到一个免费的、拥有世界上大多数货币、相当最新且不需要API密钥的好API，请在评论中告诉我)。</p><p id="609b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Manny的转换API有几个付费层，<a class="ae kf" href="https://free.currencyconverterapi.com/" rel="noopener ugc nofollow" target="_blank">一个免费层</a>对我来说非常好。据我所知，它包括今天使用的每一种政府发行的货币，贵金属，甚至一些记账单位(我没有测试过历史货币，像旧的俄罗斯卢布)。</p><p id="fde1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">即使我没有为我的API密匙付费，我仍然被期望保守这个秘密。我应该这么做，因为如果有人滥用我的API密匙，它将被撤销，我也不会得到一个新的。</p><p id="8b06" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，在本文中，我将使用“EXAMPLE0000-0001”作为虚构的示例API键。这是一个<em class="li">不</em>做什么的例子:</p><figure class="lj lk ll lm gt ju"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="fbce" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不管Git存储库是私有的还是要点是秘密的，API密匙仍然可能泄漏。如果你在公共知识库上发布这样的东西，你也可以在社交媒体上发布。</p><p id="4863" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">记住:API密匙的发行者可能会因为任何原因在任何时候撤销它。API密钥公开无疑是撤销密钥的好理由。</p><p id="6b32" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将密钥放在存储库之外的一个好方法是在项目中创建一个<code class="fe le lf lg lh b">secrets</code>包，并将整个包添加到项目的Git Ignore文件中。</p><pre class="lj lk ll lm gt lp lh lq lr aw ls bi"><span id="ab34" class="lt lu it lh b gy lv lw l lx ly"># Files and directories with API keys, IAM usernames and passwords, # etc.<br/>src/secrets<br/>test/secrets</span></pre><p id="2c8c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，在<code class="fe le lf lg lh b">src/secrets</code>中，我们创建了<code class="fe le lf lg lh b">APIKeyStore</code>类。</p><figure class="lj lk ll lm gt ju"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="1770" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并从我们的<code class="fe le lf lg lh b">CurrencyConverter</code>存根引用它:</p><figure class="lj lk ll lm gt ju"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="b884" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行<code class="fe le lf lg lh b">git status</code>命令以确定<code class="fe le lf lg lh b">CurrencyConverter</code>是否列在可通过<code class="fe le lf lg lh b">git add</code>命令添加的已跟踪变更或未跟踪文件中，并确认<code class="fe le lf lg lh b">APIKeyStore</code>未被列出。</p><p id="0306" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用户名、密码和其他凭证也可以存储在<code class="fe le lf lg lh b">secrets</code>包中。</p><p id="f84d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">API密匙可能以某种方式泄露出去的风险仍然存在，但在我看来这不太可能。一个更严重的问题等待着那些分叉这个存储库的人。</p><p id="0d08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">即使在他们将JDK和JUnit库连接到他们的本地机器上之后，仍然会有问题，即<code class="fe le lf lg lh b">APIKeyStore</code>无处可寻，并且他们必须想出如何编写它(如果他们不放弃整个努力的话)。</p><p id="f9d8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我看来，更好的选择是将API键放在本地环境变量中。我在几个地方看到过这个建议，但是没有给出任何例子。所以我必须弄清楚。</p><p id="3488" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">局部环境变量的一个问题是它们依赖于平台。在我们从Java访问它们之前，这个例子必须是特定于Windows 10的。</p><p id="5c50" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在Windows 10任务栏的搜索栏中，键入“环境变量”即使只有“env”可能也足以让操作系统将控制面板显示为“最佳匹配”</p><p id="ad16" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">点击它，打开系统属性对话框，前面有高级标签。在对话框的底部附近，您应该会看到一个标有“环境变量…”的按钮</p><p id="3163" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将打开另一个对话框，显示当前用户的环境变量和系统环境变量。如果您的计算机上只有一个用户帐户，用户和系统之间的区别可能无关紧要。这对Java运行时来说似乎无关紧要。</p><p id="2919" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据您的选择，单击用户环境变量或系统环境变量下的“新建…”按钮。这将打开“新建用户变量”对话框。我在变量名字段中输入了“FOREX_API_KEY”。</p><figure class="lj lk ll lm gt ju gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/2e026b6dc5afa96232f2140f4b98568e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*fXIecZ51euEpK2LUIRgQnQ.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Windows 10中的新用户变量对话框。</figcaption></figure><p id="3560" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我输入了Manny免费转换API的实际API密钥。我没有截图，原因很明显。</p><p id="48f7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">浏览目录…和浏览文件…按钮用于选择变量值的路径名(如path)，它们不用于从*加载名称和值对。环境文件。</p><p id="07dd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要从Java访问本地环境变量，使用<code class="fe le lf lg lh b">System.getenv()</code>函数。如果没有参数，它将返回一个带有名称和值对的<code class="fe le lf lg lh b">Map&lt;String, String&gt;</code>。</p><p id="ed3c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过一个<code class="fe le lf lg lh b">String</code>参数，比如“OS”或“FOREX_API_KEY”，它返回对应于变量名的变量值。但是要注意:如果没有指定名称的变量，函数将返回null。</p><p id="a188" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们的用例中，我们使用API键<code class="fe le lf lg lh b">String</code>构建URL，如果没有具有预期名称的环境变量，可能不会导致可怕的<code class="fe le lf lg lh b">NullPointerException</code>。</p><p id="454a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那是因为一个null变成了被胁迫成实际的<code class="fe le lf lg lh b">String</code>“null”。我们可能没有意识到发生了什么，直到我们检查一个失败的API请求，看到URL以“&amp; apiKey=null”结尾。</p><p id="bf6a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，为了空安全和更容易发现问题，我写了一个类，它本质上包装了<code class="fe le lf lg lh b">getenv()</code>函数，这样缺少的变量会导致带有缺少的变量名的<code class="fe le lf lg lh b">NoSuchElementException</code>。</p><figure class="lj lk ll lm gt ju"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="91fb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，我没有将这个放在<code class="fe le lf lg lh b">secrets</code>包装中。</p><p id="7c05" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我将我的<code class="fe le lf lg lh b">CurrencyConverter</code>草稿改为使用<code class="fe le lf lg lh b">EnvironmentVariableStore</code>而不是<code class="fe le lf lg lh b">APIKeyStore</code>。</p><figure class="lj lk ll lm gt ju"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="ee85" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我在这里使用了通配符导入来保持要点简短。</p><p id="1169" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这仍然没有完全消除API密钥泄漏到存储库中的风险。这里有一个API密匙泄漏的牵强方法:通过测试结果。但是，请不要在这些问题上失去想象力。</p><p id="6810" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，IntelliJ报告了一个函数的测试结果，该函数为一个API请求构建了欧元对美元汇率的URL:</p><figure class="lj lk ll lm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ma"><img src="../Images/9d33e5152b3344da0e5a7b5a9aeab4ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eSf_98aR5Zr0hnqUf6hOJA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">IntelliJ展示了JUnit测试中预期URL和实际URL之间的差异。</figcaption></figure><p id="cbbc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当然，我截取了截图，省略了API键。此外，测试类访问API键的方式与被测试类相同:通过<code class="fe le lf lg lh b">EnvironmentVariableStore</code>的查找。</p><p id="5ab8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为我想让测试第一次失败，所以我编写了忽略其参数的函数，并总是返回一个到<a class="ae kf" href="https://example.org/" rel="noopener ugc nofollow" target="_blank">example.org</a>的链接。</p><p id="d536" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">IntelliJ在哪里存储测试结果？我不知道。但是，查看Git状态让我确信，没有准备提交的更改和适合准备提交的未跟踪文件都是我所知道的文件。</p><p id="12cb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我再次向您保证，API键不在测试中，它是通过<code class="fe le lf lg lh b">EnvironmentVariableStore</code>加载到测试类的私有常量中的，也叫做<code class="fe le lf lg lh b">API_KEY</code>。</p><figure class="lj lk ll lm gt ju"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="8837" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于单一责任原则，我决定将在线API调用转移到一个单独的类中，<code class="fe le lf lg lh b">ExchangeRateProvider</code>。这意味着切断这条线</p><pre class="lj lk ll lm gt lp lh lq lr aw ls bi"><span id="1caa" class="lt lu it lh b gy lv lw l lx ly">private static final String API_KEY<br/>        = EnvironmentVariableStore.getVariable("FOREX_API_KEY");</span></pre><p id="7e94" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">来自<code class="fe le lf lg lh b">CurrencyConverter</code>并粘贴在<code class="fe le lf lg lh b">ExchangeRateProvider</code>上。</p><p id="8c89" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这种使用环境变量的方法比将实际的API键放在源文件中更可取，即使它是一个像<code class="fe le lf lg lh b">secrets</code>包中那样被忽略的文件。</p><p id="dbdf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">像IntelliJ这样的集成开发环境(IDE)使得从一个文件复制和粘贴到另一个文件变得非常容易。存在API密钥可能从被忽略的文件复制到被跟踪的文件的风险。</p><p id="2a19" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">API键从环境变量复制到被跟踪文件的风险要低得多，但也不是零。</p><p id="277a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我的用例中，使用环境变量非常有效，这是为了提供一个用于教育目的的具体例子。对于一个需要在遍布一个国家或世界各地的几个团队之间协调非常有价值的API键的项目来说，这可能不太好。</p><p id="1f64" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这样的团队可能需要一个更健壮的解决方案，比如一个专门的程序来扫描存储库中的API密钥和其他凭证，甚至可能提供一种安全的方法来同步可信团队成员之间的凭证。以后我可能会写一篇关于这些的文章。</p><p id="9e72" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个问题没有完美的解决方案，但是仅仅意识到这个问题就有很大的帮助。</p><h1 id="b976" class="mb lu it bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">资源</h1><ul class=""><li id="0d95" class="my mz it ki b kj na kn nb kr nc kv nd kz ne ld nf ng nh ni bi translated">MacKenzie Jackson，<a class="ae kf" href="https://blog.gitguardian.com/secrets-api-management/" rel="noopener ugc nofollow" target="_blank">“管理和存储包括API密钥和其他凭证在内的秘密的最佳实践[2020]，</a>发表于2020年6月12日GitGuardian博客。权衡几种安全方法及其优缺点。不过，没有例子。</li><li id="ceaa" class="my mz it ki b kj nj kn nk kr nl kv nm kz nn ld nf ng nh ni bi translated">我的<a class="ae kf" href="https://github.com/Alonso-del-Arte/toy-examples" rel="noopener ugc nofollow" target="_blank">玩具示例</a> GitHub仓库。特别是，看看Git Ignore，以及<code class="fe le lf lg lh b">currency</code>和<code class="fe le lf lg lh b">sysops</code>包。</li></ul></div></div>    
</body>
</html>