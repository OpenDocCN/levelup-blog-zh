<html>
<head>
<title>Go Panic and Recovery: Meet the Edge Case</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">去恐慌和恢复:满足边缘情况</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/go-panic-and-recovery-meet-the-edge-case-71054747a5da?source=collection_archive---------20-----------------------#2022-07-03">https://levelup.gitconnected.com/go-panic-and-recovery-meet-the-edge-case-71054747a5da?source=collection_archive---------20-----------------------#2022-07-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/b63d794bc18f40b98d263fcd5a68aa2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*FNdQJzgcFAToU17556SxJQ.png"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">Golang标志</figcaption></figure><p id="cdef" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">惯用的Go通常使用以下模式处理错误情况:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="ld le l"/></div></figure><p id="594a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">但是还有一种更极端的错误反应，那就是<a class="ae lf" href="https://gobyexample.com/panic" rel="noopener ugc nofollow" target="_blank"><em class="lg"/></a>。使用<em class="lg"> panic() </em>函数通常表示无法恢复的意外错误。调用<em class="lg"> panic </em>用一个非零值和一个错误信息退出你的程序。<strong class="kd iu">嘭！</strong>有办法让<em class="lg">从<em class="lg">恐慌中恢复</em>，</em>不过。如果你不能想象为什么你想要从恐慌中恢复过来，考虑一下Go在算术上被零除的恐慌，那么简单的数学会意外地导致恐慌！</p><p id="2d4c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">好吧，那么我们如何从恐慌中恢复过来呢？这里有一个函数:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="ld le l"/></div></figure><p id="3817" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在你渐渐发现，在一些不可避免的场景中，<em class="lg">这里的魔法</em>被零除，恐慌了。你想要的是它返回一个普通的错误，而不是惊慌失措。有一个解决方案:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="ld le l"/></div></figure><p id="5ef3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以在<em class="lg">延迟</em>函数中使用<em class="lg"> recover() </em>来从死机中恢复。这几乎就是我们想要的，如果在<em class="lg">计算某些东西</em>而不是退出的过程中出现死机，它会恢复并设置<code class="fe lh li lj lk b">err</code>为死机消息。</p><h2 id="1d70" class="ll lm it bd ln lo lp dn lq lr ls dp lt km lu lv lw kq lx ly lz ku ma mb mc md bi translated">遇到边缘情况</h2><pre class="kz la lb lc gt me lk mf mg aw mh bi"><span id="3bb6" class="ll lm it lk b gy mi mj l mk ml">panic(nil)</span></pre><p id="9624" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当用参数<code class="fe lh li lj lk b">nil</code>调用panic时会发生什么？荒谬但有可能。由于<em class="lg"> recover </em>返回传递给<em class="lg"> panic </em>的参数，我们第5到7行的逻辑有问题:</p><pre class="kz la lb lc gt me lk mf mg aw mh bi"><span id="8720" class="ll lm it lk b gy mi mj l mk ml">if r := recover(); r != nil {<br/>   err = fmt.Errorf("panic: %+v", r)<br/>}</span></pre><p id="f7ca" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">值或<code class="fe lh li lj lk b">r</code>将是<code class="fe lh li lj lk b">nil</code>，因此<code class="fe lh li lj lk b">err</code>不会被设置。好吧，那么:</p><pre class="kz la lb lc gt me lk mf mg aw mh bi"><span id="f387" class="ll lm it lk b gy mi mj l mk ml">r := recover()<br/>err = fmt.Errorf("panic: %+v", r)</span></pre><p id="3601" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">失败，现在<code class="fe lh li lj lk b">err</code>被设置<strong class="kd iu"> <em class="lg">每</em> </strong>调用一次就算健康完成。</p><h2 id="f0b6" class="ll lm it bd ln lo lp dn lq lr ls dp lt km lu lv lw kq lx ly lz ku ma mb mc md bi translated">解决方案</h2><p id="b100" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">我不知道一个真正优雅的解决方案。你绝对需要调用<em class="lg">恢复</em>来短路<em class="lg">死机</em>，<strong class="kd iu">，但是</strong>如何使用它的返回值可能视情况而定。</p><p id="69b3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">其中<em class="lg">粗</em>的解决方案是:</p><figure class="kz la lb lc gt ju"><div class="bz fp l di"><div class="ld le l"/></div></figure><p id="aaaa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您没有到达<code class="fe lh li lj lk b">done = true,</code>，这将恢复并设置<code class="fe lh li lj lk b">err</code>。它并不优雅，但很有效。</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="c365" class="my lm it bd ln mz na nb lq nc nd ne lt nf ng nh lw ni nj nk lz nl nm nn mc no bi translated">分级编码</h1><p id="8aa4" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">感谢您成为我们社区的一员！更多内容见<a class="ae lf" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">级编码出版物</a>。<br/>跟随:<a class="ae lf" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a>，<a class="ae lf" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">领英</a>，<a class="ae lf" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">通迅</a> <br/> <strong class="kd iu">升一级正在改造理工大招聘➡️ </strong> <a class="ae lf" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kd iu">加入我们的人才集体</strong> </a></p></div></div>    
</body>
</html>