<html>
<head>
<title>Publishing Your Python Package on conda and conda-forge</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在conda和conda-forge上发布您的Python包</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/publishing-your-python-package-on-conda-and-conda-forge-309a405740cf?source=collection_archive---------1-----------------------#2021-02-10">https://levelup.gitconnected.com/publishing-your-python-package-on-conda-and-conda-forge-309a405740cf?source=collection_archive---------1-----------------------#2021-02-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="5baa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">值得在conda和conda-forge上发布您的python包</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/9e59445e74b681b050fbc058277ce6db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CHTp5HMlF2yriFcTYBq5GQ.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@davidclode?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">大卫·克劳德</a>在<a class="ae le" href="https://unsplash.com/s/photos/anaconda?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="5ac9" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">为什么用康达？</h1><p id="cc2e" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">我最近<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/turn-your-python-code-into-a-pip-package-in-minutes-433ae669657f">写了一篇文章</a>指导用户将他们的python包发布到PyPI以通过pip安装的过程。然而，许多用户更喜欢使用康达。我喜欢让我的包在conda上可用，因为它可以很好地处理具有外部依赖性的包。有时一个包也只能在conda通道上使用，为了避免依赖性问题，最好避免在一个环境中混合pip和conda安装。</p><blockquote class="mi mj mk"><p id="a623" class="jq jr ml js b jt ju jv jw jx jy jz ka mm kc kd ke mn kg kh ki mo kk kl km kn im bi translated"><strong class="js iu">注意</strong>:如果你还没有在PyPI上发布你的包，请确保在我的另一篇文章中看到初始步骤I布局<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/turn-your-python-code-into-a-pip-package-in-minutes-433ae669657f">。您需要有正确的文件层次结构、<code class="fe mp mq mr ms b">__init__.py</code>文件和许可证。参见我的</a><a class="ae le" href="https://github.com/wino6687/pip_conda_demo" rel="noopener ugc nofollow" target="_blank">示例Github repo </a>获取正确文件层次的示例。</p></blockquote><h2 id="f456" class="mt lg it bd lh mu mv dn ll mw mx dp lp kb my mz lt kf na nb lx kj nc nd mb ne bi translated">康达频道</h2><p id="4b0d" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">通道只是存储包的位置。一些非常受欢迎的包存储在默认的conda通道中，许多较小的包存储在个人用户自己的通道中，或者有像conda-forge这样的社区通道。</p><p id="3dc6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以在命令行中指定安装软件包时要使用的通道。或者您可以创建一个<a class="ae le" href="https://docs.conda.io/projects/conda/en/latest/user-guide/configuration/use-condarc.html" rel="noopener ugc nofollow" target="_blank"> conda配置文件</a> ( <code class="fe mp mq mr ms b">.condarc</code>)，它允许您按优先级顺序列出通道。</p><pre class="kp kq kr ks gt nf ms ng nh aw ni bi"><span id="d742" class="mt lg it ms b gy nj nk l nl nm">conda install swepy --channel conda-forge</span></pre><p id="f4f1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里，我指定我想从conda-forge频道下载python包<code class="fe mp mq mr ms b">swepy</code>。<a class="ae le" href="https://conda-forge.org/" rel="noopener ugc nofollow" target="_blank">康达锻造</a>是一个由成千上万贡献者组成的频道；它像PyPI一样作为许多人的包的中央存储库。但是它的与众不同之处在于，conda-forge上的每个包都必须依赖于conda-forge。这意味着你可以在你的整个环境中使用conda-forge，避免讨厌的依赖问题！</p><p id="1e1e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇文章中，我将向你展示如何在你的个人conda频道上发布你的包，然后我将介绍在conda-forge频道上发布包所需的步骤。</p><h1 id="3931" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">发布Conda包</h1><ol class=""><li id="be91" class="nn no it js b jt md jx me kb np kf nq kj nr kn ns nt nu nv bi translated">创建一个<code class="fe mp mq mr ms b">meta.yaml</code>文件</li><li id="48d1" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">创建您的<code class="fe mp mq mr ms b">build.sh</code>和/或<code class="fe mp mq mr ms b">bld.bat</code>文件</li></ol><h2 id="0276" class="mt lg it bd lh mu mv dn ll mw mx dp lp kb my mz lt kf na nb lx kj nc nd mb ne bi translated">创建meta.yaml文件</h2><p id="2d30" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">你的<code class="fe mp mq mr ms b">meta.yaml</code>文件是告诉康达如何建立你的图书馆的配方。它类似于用于为pip创建库的<code class="fe mp mq mr ms b">setup.py</code>。</p><p id="aef4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里有一个来自我早期的一个库swepy的例子:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="00fd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">可以看到我先列出了包信息，然后conda在哪里可以找到源代码。在<code class="fe mp mq mr ms b">requirements</code>部分中，<code class="fe mp mq mr ms b">run:</code>下的列表包含了您的库需要的所有依赖项。最后，<code class="fe mp mq mr ms b">about</code>部分包含基本信息，如许可证和简要总结。</p><h2 id="df01" class="mt lg it bd lh mu mv dn ll mw mx dp lp kb my mz lt kf na nb lx kj nc nd mb ne bi translated">创建build.sh和/或bld.bat文件</h2><ul class=""><li id="40a8" class="nn no it js b jt md jx me kb np kf nq kj nr kn od nt nu nv bi translated"><code class="fe mp mq mr ms b">build.sh</code>是macOS和linux的shell脚本</li><li id="4668" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn od nt nu nv bi translated"><code class="fe mp mq mr ms b">bld.bat</code>是用于windows的批处理文件</li></ul><p id="2387" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些文件非常简单，应该完全如下所示:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ob oc l"/></div></figure><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="5d87" class="mt lg it bd lh mu mv dn ll mw mx dp lp kb my mz lt kf na nb lx kj nc nd mb ne bi translated">构建您的包</h2><p id="c3c2" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">现在，在包的根目录中，运行以下命令:</p><pre class="kp kq kr ks gt nf ms ng nh aw ni bi"><span id="3d79" class="mt lg it ms b gy nj nk l nl nm">conda build .</span></pre><p id="7f23" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦完成，它将显示构建文件的路径。它应该是这样的:</p><pre class="kp kq kr ks gt nf ms ng nh aw ni bi"><span id="9cd2" class="mt lg it ms b gy nj nk l nl nm">~/anaconda/conda-bld/linux-64/packagename-py37_0.tar.bz2</span></pre><h2 id="bb27" class="mt lg it bd lh mu mv dn ll mw mx dp lp kb my mz lt kf na nb lx kj nc nd mb ne bi translated">将您的包上传到Anaconda</h2><ol class=""><li id="e610" class="nn no it js b jt md jx me kb np kf nq kj nr kn ns nt nu nv bi translated"><a class="ae le" href="http://Anaconda.org" rel="noopener ugc nofollow" target="_blank">用Anaconda创建一个账户</a></li><li id="80be" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">安装Anaconda客户端<code class="fe mp mq mr ms b">conda install anaconda-client</code></li><li id="7cbf" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">使用<code class="fe mp mq mr ms b">anaconda login</code>登录您的Anaconda帐户</li><li id="6594" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">使用之前的文件路径上传您的包</li></ol><pre class="kp kq kr ks gt nf ms ng nh aw ni bi"><span id="5f37" class="mt lg it ms b gy nj nk l nl nm">anaconda upload ~/anaconda/conda-bld/linux-64/packagename-py37_0.tar.bz2</span></pre><p id="75b5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">恭喜你。您的软件包现在可以在您的个人频道上获得，并且可以通过conda而不是pip进行安装。安装时，您需要指定您的个人频道:</p><pre class="kp kq kr ks gt nf ms ng nh aw ni bi"><span id="dec0" class="mt lg it ms b gy nj nk l nl nm">conda install mypackage --channel &lt;username&gt;</span></pre><p id="d589" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">或者将其添加到您的<code class="fe mp mq mr ms b">.condarc</code>文件中:</p><pre class="kp kq kr ks gt nf ms ng nh aw ni bi"><span id="1561" class="mt lg it ms b gy nj nk l nl nm">conda config --add channels &lt;username&gt; </span><span id="aef1" class="mt lg it ms b gy oe nk l nl nm">conda install mypackage</span></pre></div><div class="ab cl of og hx oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="im in io ip iq"><h1 id="0b84" class="lf lg it bd lh li om lk ll lm on lo lp lq oo ls lt lu op lw lx ly oq ma mb mc bi translated">康达-福吉</h1><p id="4f93" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">Conda-forge是迄今为止我最喜欢的发布python包的地方。在conda-forge上发布一个包之前，它必须通过一个简短的审查过程，并且它的所有依赖项必须已经可以通过conda-forge安装。对所有的包使用conda-forge可以避免由于混合通道或安装程序而产生的依赖性问题，从而为您省去一些麻烦。</p><h2 id="2118" class="mt lg it bd lh mu mv dn ll mw mx dp lp kb my mz lt kf na nb lx kj nc nd mb ne bi translated">提交给康达锻造公司之前要采取的步骤</h2><ol class=""><li id="58d5" class="nn no it js b jt md jx me kb np kf nq kj nr kn ns nt nu nv bi translated">编写单元测试(我喜欢使用<a class="ae le" href="https://docs.pytest.org/en/stable/" rel="noopener ugc nofollow" target="_blank"> pytest </a></li><li id="440d" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">确保conda-forge上已经发布了所有依赖项</li><li id="ffa5" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">至少为您的软件包编写基本的文档</li></ol><p id="be82" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">理想的情况是，您已经为您的包编写了一些单元测试，以便它们可以在更新conda-forge原料时运行。你也应该把你的代码文档化，这样用户就能知道如何使用它。</p><h2 id="b83f" class="mt lg it bd lh mu mv dn ll mw mx dp lp kb my mz lt kf na nb lx kj nc nd mb ne bi translated">添加您的康达锻造配方</h2><ol class=""><li id="d660" class="nn no it js b jt md jx me kb np kf nq kj nr kn ns nt nu nv bi translated">叉子<a class="ae le" href="https://github.com/conda-forge/staged-recipes" rel="noopener ugc nofollow" target="_blank">康达锻造/分阶段配方</a></li><li id="3b4f" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">从分段配方主分支创建一个新分支</li><li id="c4b5" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">在“recipes/ &lt; mypackagename &gt; /目录中添加一个新配方(<code class="fe mp mq mr ms b">meta.yaml</code>)</li><li id="ef19" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">将这些更改作为“拉”请求提交(这将触发对所有操作系统的测试)</li><li id="ea84" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">一旦合并，您将获得一个新的原料库，您的包将在这里建立并上传到康达锻造！</li></ol><p id="0524" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在所有这些步骤中，唯一有点混乱的部分是创建你的食谱。您应该在分叉的“分段配方”存储库中创建的文件层次结构如下所示:</p><pre class="kp kq kr ks gt nf ms ng nh aw ni bi"><span id="9da3" class="mt lg it ms b gy nj nk l nl nm">/recipes<br/>    /&lt;packagename&gt;<br/>        meta.yaml<!-- --> </span></pre><p id="83e2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是我用来制作我的一个图书馆SWEpy的食谱。菜谱是一个<code class="fe mp mq mr ms b">meta.yaml</code>文件，很像你的基本conda包所用的文件，但需要更多的细节。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="8f3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有几件事需要注意:</p><ul class=""><li id="9120" class="nn no it js b jt ju jx jy kb or kf os kj ot kn od nt nu nv bi translated">我使用我的PyPI包作为源代码。这样，当我用CI服务更新我的PyPI包时，我的conda-forge包也会自动更新。</li><li id="cc61" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn od nt nu nv bi translated">我为conda-forge设置了一个更复杂的测试套件，包括模仿一个服务器和提供两个小文件，以便在不需要访问web的情况下测试文件抓取。</li><li id="1e3e" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn od nt nu nv bi translated">配方可能比这复杂得多，并且涉及到在Python之外安装依赖项。参考<a class="ae le" href="https://conda-forge.org/docs/maintainer/adding_pkgs.html#the-recipe-meta-yaml" rel="noopener ugc nofollow" target="_blank">康达锻造文档</a>了解如何制作更复杂的配方。</li></ul><p id="7636" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦您提交了拉动请求，conda-forge的人员将会评论在合并到自己的原料之前是否需要进行任何更改。在它被合并到自己的原料中之后，它将被构建，然后被部署，以便可以通过conda-forge频道下载！</p><h1 id="287e" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">包扎</h1><p id="c4cf" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">您现在知道如何在conda和conda-forge上发布您的Python库了！但是没有什么比在多个地方手动维护您的包更烦人的了。</p><p id="8653" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我通过设置与Travis-CI的持续集成解决了这个问题，Travis-CI会自动将我的代码的任何新版本部署到PyPI，然后将新版本从PyPI部署到我的conda-forge原料。</p><p id="2746" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/tools-for-writing-effective-and-robust-python-libraries-28bfd4c018c1">阅读我的另一篇文章</a>关于我如何设置我的工作流程以使Python库更加健壮。在更新库的时候，持续集成是你最好的朋友；Travis将运行您的单元测试，如果通过，就部署它们以保持您的包是最新的。这样你就再也不用手动上传新版本了。</p><h1 id="99b0" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">链接和文档</h1><ul class=""><li id="8625" class="nn no it js b jt md jx me kb np kf nq kj nr kn od nt nu nv bi translated"><a class="ae le" href="https://github.com/wino6687/pip_conda_demo" rel="noopener ugc nofollow" target="_blank">Github回购示例</a></li><li id="c768" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn od nt nu nv bi translated"><a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/tools-for-writing-effective-and-robust-python-libraries-28bfd4c018c1">我的构建健壮Python库指南</a></li><li id="45d0" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn od nt nu nv bi translated"><a class="ae le" href="https://conda.io/projects/conda-build/en/latest/user-guide/tutorials/build-pkgs.html" rel="noopener ugc nofollow" target="_blank">康达包装文件</a></li><li id="5581" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn od nt nu nv bi translated"><a class="ae le" href="https://conda-forge.org/#add_recipe" rel="noopener ugc nofollow" target="_blank">康达锻造公司添加配方指南</a></li></ul></div></div>    
</body>
</html>