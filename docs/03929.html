<html>
<head>
<title>Deno: Create a Rest API using JWT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Deno:使用JWT创建一个Rest API</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deno-create-a-rest-api-using-jwt-5141fd5b1066?source=collection_archive---------8-----------------------#2020-06-02">https://levelup.gitconnected.com/deno-create-a-rest-api-using-jwt-5141fd5b1066?source=collection_archive---------8-----------------------#2020-06-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e2f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自从V1诞生以来，Deno已经成为Javascript/Typescript/Node开发人员的时髦词汇<em class="kl">。让我们通过使用JWT创建一个安全的Rest API来深入了解这项技术。</em></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/95759578aafb7ffd6b975e0e5e6a073b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W0zpCeQuZEdhjkZd.jpg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">【https://deno.land/v1 T4】</figcaption></figure><p id="2cdc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl"> ⚠️最好是已经有一些关于节点及其生态系统(Express、Nodemon、Sequelize等)的基础知识来学习本教程。</em></p><h1 id="980f" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">🦕什么是德诺？</h1><blockquote class="mb mc md"><p id="d68e" class="jn jo kl jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">Deno是一个简单、现代和安全的JavaScript和TypeScript运行时，它使用V8并内置于Rust中。</p></blockquote><p id="dc1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">已经有很多文章详细介绍了这个主题，所以我就不赘述了。我可以推荐这个<a class="ae lc" href="https://blog.bitsrc.io/what-is-deno-and-will-it-replace-nodejs-a13aa1734a74" rel="noopener ugc nofollow" target="_blank">一个</a>。</p><h1 id="163d" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">🚀介绍</h1><p id="2c21" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">自从其<a class="ae lc" href="https://deno.land/v1" rel="noopener ugc nofollow" target="_blank"> V1 </a>正式发布以来，deno已经成为其最近几周的“流行语”(只是为了好玩，这是在谷歌上搜索“Deno”的流行曲线)</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mm"><img src="../Images/9d14de2947441fa1bd98648940ebbdd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vRY2DVVX4p0z0DMcD8_HsA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><a class="ae lc" href="https://trends.google.com/trends/explore?geo=US&amp;q=deno" rel="noopener ugc nofollow" target="_blank">谷歌趋势</a></figcaption></figure><p id="487d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是用这个“类型脚本和Javascript的安全运行时”能做什么呢？</p><p id="7364" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了更好地理解这个不断发展的项目并给出我的意见，我决定与JWT一起创建一个安全的REST API，并与大家分享我的感受。</p><p id="3219" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我习惯用Node.js和<a class="ae lc" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a>工作。</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="c3c0" class="ld le iq bd lf lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma bi translated">🎯目标</h1><p id="df13" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">本教程的目标是重新创建一个安全的REST API，这意味着:</p><ul class=""><li id="8727" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">设置服务器</li><li id="ca9c" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">使用ORM和数据库创建模型</li><li id="ed69" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">CRUD用户</li><li id="b6db" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">实施与JWT的安全路线</li></ul><h1 id="b2b5" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">🧰先决条件</h1><p id="04a2" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">为了用JWT创建我们的API Rest secure，我将使用:</p><ul class=""><li id="98da" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">Deno(我推荐安装它的官方文档:<a class="ae lc" href="https://deno.land/#installation" rel="noopener ugc nofollow" target="_blank">这里</a>)</li><li id="831b" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">VSCode和Deno支持插件，此处提供<a class="ae lc" href="https://marketplace.visualstudio.com/items?itemName=denoland.vscode-deno" rel="noopener ugc nofollow" target="_blank"/></li></ul><p id="dbcc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以及下面的包，(我将在整个教程中回到这一点) :</p><ul class=""><li id="a68d" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated"><a class="ae lc" href="https://deno.land/x/denon" rel="noopener ugc nofollow" target="_blank">天龙</a></li><li id="718c" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated"><a class="ae lc" href="https://deno.land/x/oak" rel="noopener ugc nofollow" target="_blank">橡木</a></li><li id="64e4" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated"><a class="ae lc" href="https://deno.land/x/djwt" rel="noopener ugc nofollow" target="_blank"> Djwt </a></li><li id="b731" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated"><a class="ae lc" href="https://deno.land/x/denodb" rel="noopener ugc nofollow" target="_blank"> Denodb </a></li><li id="29dd" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">Bcrypt </li></ul></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="d651" class="ld le iq bd lf lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma bi translated">⚙️设置</h1><p id="58df" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">首先，让我们建立文件架构，以保持一个清晰的和“生产就绪”的项目的指导方针。</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="be85" class="ns le iq no b gy nt nu l nv nw">|-- DenoRestJwt<br/>    |-- controllers/<br/>    |   |-- database/<br/>    |   |-- models/<br/>    |-- helpers/<br/>    |-- middlewares/<br/>    |-- routers/<br/>    |-- app.ts</span></pre><p id="f2f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们开发的是Node + Express应用程序，我会使用Nodemon在代码更改后自动重启我的服务器来促进开发。</p><blockquote class="mb mc md"><p id="c426" class="jn jo kl jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated"><a class="ae lc" href="https://www.npmjs.com/package/nodemon" rel="noopener ugc nofollow" target="_blank"> Nodemon </a>是一个工具，通过在检测到目录中的文件更改时自动重启节点应用程序，帮助开发基于node.js的应用程序。</p></blockquote><p id="b6bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了保持同样的“开发舒适度”，我决定使用<a class="ae lc" href="https://deno.land/x/denon/" rel="noopener ugc nofollow" target="_blank"> Denon </a>，它与Deno同名。</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="e459" class="ns le iq no b gy nt nu l nv nw">deno install --allow-read --allow-run --allow-write -f --unstable <a class="ae lc" href="https://deno.land/x/denon/denon.ts" rel="noopener ugc nofollow" target="_blank">https://deno.land/x/denon/denon.ts</a></span></pre><p id="c4e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们稍微定制一下Denon的配置。这在以后会很有用(特别是对于管理环境变量)。</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="e2c2" class="ns le iq no b gy nt nu l nv nw">// into denon.json<br/>{<br/>  "$schema": "https://deno.land/x/denon/schema.json",<br/>  "env": {},<br/>  "scripts": {<br/>    "start": {<br/>      "cmd": "deno run app.ts"<br/>    }<br/>  }<br/>}</span></pre><p id="955b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在准备在良好的条件下开始编码！要启动Denon，只需在终端中键入<code class="fe nx ny nz no b">denon start</code>:</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="00e2" class="ns le iq no b gy nt nu l nv nw">➜ denon start<br/>[denon] v2.0.2<br/>[denon] watching path(s): *.*<br/>[denon] watching extensions: ts,js,json<br/>[denon] starting `deno run app.ts`<br/>Compile file:///deno-crashtest/app.ts<br/>[denon] clean exit - waiting for changes before restart</span></pre><p id="b04d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以看到我们的服务器正在运行…但它崩溃了！很正常，它在<code class="fe nx ny nz no b">app.ts</code>里没有代码可执行。</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="e45d" class="ld le iq bd lf lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma bi translated">🖋:让我们初始化我们的服务器</h1><p id="3e8d" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我决定使用框架<a class="ae lc" href="https://deno.land/x/oak" rel="noopener ugc nofollow" target="_blank"> Oak </a>。</p><blockquote class="mb mc md"><p id="88e8" class="jn jo kl jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">Oak是Deno的http服务器的中间件框架，包括一个路由器中间件。这个中间件框架的灵感来源于Koa，中间件路由器的灵感来源于@koa/router。</p></blockquote><p id="a0bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们用Oak初始化我们的服务器:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="f294" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在如果我们用<code class="fe nx ny nz no b">denon start</code>运行我们的服务器</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="b72c" class="ns le iq no b gy nt nu l nv nw">error: Uncaught PermissionDenied: network access to "0.0.0.0:3001", run again with the --allow-net flag</span></pre><p id="803c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是Deno和Node的最大区别之一:Deno在默认情况下是安全的，不能访问<code class="fe nx ny nz no b">network</code>。你必须授权它:</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="3507" class="ns le iq no b gy nt nu l nv nw">// into denon.json<br/>"scripts": {<br/>    "start": {<br/>      // add --allow-net<br/>      "cmd": "deno run --allow-net app.ts"<br/>    }<br/>  }</span></pre><p id="3116" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你现在可以从你的浏览器访问(尽管我建议你使用<a class="ae lc" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank">邮递员</a>)到<code class="fe nx ny nz no b"><a class="ae lc" href="http://localhost:3001" rel="noopener ugc nofollow" target="_blank">localhost:3001</a></code>:</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="fdfb" class="ns le iq no b gy nt nu l nv nw">{<br/>    "message": "It's work !"<br/>}</span></pre></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="d80b" class="ld le iq bd lf lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma bi translated">👥设置数据库</h1><p id="dbc7" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我将使用<a class="ae lc" href="https://github.com/eveningkid/denodb" rel="noopener ugc nofollow" target="_blank"> DenoDB </a>作为ORM(特别是因为它支持Sqlite3)。更重要的是，它看起来非常像<a class="ae lc" href="https://sequelize.org/" rel="noopener ugc nofollow" target="_blank">续集</a>(我习惯使用)。</p><p id="a4db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们添加第一个控制器<code class="fe nx ny nz no b">Database</code>和Sqlite3文件。</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="2f9a" class="ns le iq no b gy nt nu l nv nw">|-- DenoRestJwt<br/>    |-- controllers/<br/>	|   |-- Database.ts<br/>        |   |-- database/<br/>	|   |   |-- db.sqlite<br/>    |   |-- models/<br/>    |-- app.ts</span></pre><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="9275" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的ORM已经初始化。你可能注意到我使用了需要进一步许可的<code class="fe nx ny nz no b">realPathSync</code>。让我们在我们的<code class="fe nx ny nz no b">denon.json</code>中添加<code class="fe nx ny nz no b">--allow-read</code>和<code class="fe nx ny nz no b">--allow-write</code>:</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="5eea" class="ns le iq no b gy nt nu l nv nw">"scripts": {<br/>    "start": {<br/>      "cmd": "deno run --allow-write --allow-read --allow-net app.ts"<br/>    }<br/>  }</span></pre><p id="8611" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">剩下要做的就是通过我们的ORM创建用户模型:</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="e9a8" class="ns le iq no b gy nt nu l nv nw">|-- DenoRestJwt<br/>    |-- controllers/<br/>    |   |-- models/<br/>    |       |-- User.ts<br/>    |-- app.ts</span></pre><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="1b4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里没有什么新的东西，所以我不会详述。(ps:我用<code class="fe nx ny nz no b">nanoid</code>来管理我的UUID，我让你读了这篇关于它的非常有趣的文章)</p><div class="oc od gp gr oe of"><a href="https://medium.com/javascript-in-plain-english/you-might-not-need-uuid-v4-for-generating-random-identifiers-89e8a28a7d77" rel="noopener follow" target="_blank"><div class="og ab fo"><div class="oh ab oi cl cj oj"><h2 class="bd ir gy z fp ok fr fs ol fu fw ip bi translated">您可能不需要UUID版本4来生成随机标识符</h2><div class="om l"><h3 class="bd b gy z fp ok fr fs ol fu fw dk translated">对于每一个决定，一定要理解你为什么要做这个决定，因为你可能有另一个聪明的方法来达到同样的目的…</h3></div><div class="on l"><p class="bd b dl z fp ok fr fs ol fu fw dk translated">medium.com</p></div></div><div class="oo l"><div class="op l oq or os oo ot kw of"/></div></div></a></div><p id="8c4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我借此机会添加一个以后会有用的函数:密码哈希。我使用<a class="ae lc" href="https://deno.land/x/bcrypt" rel="noopener ugc nofollow" target="_blank"> Bcrypt </a>来做这件事:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="763d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，让我们将模型链接到ORM:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="4ba3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很好！现在我们的服务器和数据库已经就绪，是时候初始化帐户创建路径了…</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="3ce1" class="ld le iq bd lf lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma bi translated">📙用户控制器</h1><p id="526c" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">没有比好的CRUD更基本的了:</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="ca14" class="ns le iq no b gy nt nu l nv nw">|-- DenoRestJwt<br/>    |-- controllers/<br/>    |   |-- Database.ts<br/>    |   |-- UserController.ts</span></pre><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="de89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我只是使用ORM提供的方法。我们现在只需要管理JWT一代。</p><h1 id="00e9" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">🛣设置路由器</h1><p id="7caf" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">现在是时候创建我们不同的路线并调用我们新编码的控制器了。</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="f6eb" class="ns le iq no b gy nt nu l nv nw">|-- DenoRestJwt<br/>    |-- routers<br/>        |-- UserRoute.ts</span></pre><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="4b33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们所要做的就是从控制器中调用我们的逻辑。我使用<a class="ae lc" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods" rel="noopener ugc nofollow" target="_blank"> HTTP方法</a>来清楚地定义我的路线。我还创建了助手来管理我的错误返回。我邀请你直接从项目<a class="ae lc" href="https://github.com/Trobyss/deno-api-rest-jwt" rel="noopener ugc nofollow" target="_blank"> GitHub </a>获得它们！我们所要做的就是在应用程序中调用路由器:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h1 id="ae95" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">🛡安全和智威汤逊</h1><p id="b7ca" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">现在是时候给这个项目增加一些安全性了！我将使用<a class="ae lc" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JWT </a>来做到这一点。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/aae55f00ccd2b80fd8f38cfe284458a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*x8jcs8VJuKWnMT4r"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><a class="ae lc" href="https://auth0.com/learn/json-web-tokens/" rel="noopener ugc nofollow" target="_blank">原版</a></figcaption></figure><h2 id="3008" class="ns le iq bd lf ou ov dn lj ow ox dp ln jy oy oz lr kc pa pb lv kg pc pd lz pe bi translated">1.创建一条安全路线</h2><p id="9fd8" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">首先，我们将建立一个安全中间件，它:</p><ul class=""><li id="c401" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">检查查询中是否存在“授权”标头</li><li id="1e4c" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">拿回来</li><li id="9192" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">检查其有效性</li><li id="9da9" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">返回错误/接受请求并调用私有路由</li></ul><p id="98d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我会用库<a class="ae lc" href="https://deno.land/x/djwt" rel="noopener ugc nofollow" target="_blank"> Djwt </a>。</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="3eb8" class="ns le iq no b gy nt nu l nv nw">|-- DenoRestJwt<br/>    |-- middlewares/<br/>    |   |-- jwt.ts</span></pre><p id="52ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的函数必须接受查询上下文的参数，从消息头中提取令牌，检查其有效性，并采取相应的行动。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="8144" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，我们需要一个密钥来加密我们的令牌。为此我使用了Deno环境变量。因此，我们需要对Denon配置进行一些更改:添加变量并允许Deno检索环境变量。</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="17ea" class="ns le iq no b gy nt nu l nv nw">{<br/>  "$schema": "&lt;https://deno.land/x/denon/schema.json&gt;",<br/>  // Add env variable<br/>  "env": {<br/>    "SECRET": "ADRIEN_IS_THE_BEST_AUTHOR_ON_MEDIUM"<br/>  },<br/>  "scripts": {<br/>    "start": {<br/>      // add the permission with --allow-env<br/>      "cmd": "deno run --allow-env --allow-read --allow-net app.ts"<br/>    }<br/>  }<br/>}</span></pre><p id="dc99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(ps:如果你想保护你的环境变量，我推荐这个教程)</p><div class="oc od gp gr oe of"><a href="https://medium.com/javascript-in-plain-english/im-now-versioning-my-app-secrets-in-git-here-is-why-you-should-do-the-same-2a72c1a49039" rel="noopener follow" target="_blank"><div class="og ab fo"><div class="oh ab oi cl cj oj"><h2 class="bd ir gy z fp ok fr fs ol fu fw ip bi translated">我现在在Git中对我的应用程序秘密进行版本控制，这就是为什么你应该做同样的事情。</h2><div class="om l"><h3 class="bd b gy z fp ok fr fs ol fu fw dk translated">这应该是一个不好的做法，但是当你有很多配置和管理秘密的时候，你可能需要它…</h3></div><div class="on l"><p class="bd b dl z fp ok fr fs ol fu fw dk translated">medium.com</p></div></div><div class="oo l"><div class="pf l oq or os oo ot kw of"/></div></div></a></div><p id="a2a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后让我们创建我们的私人路线。</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="43ee" class="ns le iq no b gy nt nu l nv nw">|-- DenoRestJwt<br/>    |-- routers<br/>        |-- UserRoute.ts<br/>        |-- PrivateRoute.ts</span></pre><p id="f48c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在调用我们的路线之前，只需调用我们的方法:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="4337" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不要忘记将其添加到我们的应用程序中:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="2c63" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们尝试在<code class="fe nx ny nz no b">/private </code>上调用我们的API，我们会得到很好的响应:</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="44c3" class="ns le iq no b gy nt nu l nv nw">{<br/>    "message": "Unauthorized"<br/>}</span></pre><h2 id="a02b" class="ns le iq bd lf ou ov dn lj ow ox dp ln jy oy oz lr kc pa pb lv kg pc pd lz pe bi translated">2.JWT一代</h2><p id="9278" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">现在是时候在用户登录时设置令牌生成了。请记住，我们在控制器中留了一个<code class="fe nx ny nz no b">// TODO generate JWT</code>。在完成之前，我们将首先向我们的用户模型添加一个静态方法来生成一个令牌。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="8ad0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们在控制器中调用这个方法:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="634c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，让我们将这个逻辑添加到路由器中:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="887e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，如果我们尝试连接，我们有:</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="933e" class="ns le iq no b gy nt nu l nv nw">// localhost:3001/login<br/>{<br/>    "jwt": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IlEyY0ZZcUxKWk5Hc0toN0FWV0hzUiIsImV4cCI6MTU5MDg0NDU2MDM5MH0.drQ3ay5_DYuXEOnH2Z0RKbhq9nZElWCMvmypjI4BjIk"<br/>}</span></pre><p id="277c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">(之前别忘了创建账号；))</em></p><p id="eba0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们将这个令牌添加到我们的<code class="fe nx ny nz no b">Authorization</code>头中，并再次调用我们的私有路由:</p><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="574e" class="ns le iq no b gy nt nu l nv nw">// localhost:3001/private with token in headers<br/>{<br/>    "message": "Connected !"<br/>}</span></pre><p id="635e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太好了！我们的安全API已经就位👏</p><p id="fdbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在我的Github上找到这个项目:<a class="ae lc" href="https://github.com/Trobyss/deno-api-rest-jwt" rel="noopener ugc nofollow" target="_blank">这里</a>(我加邮差集合做请求)。</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="0fbc" class="ld le iq bd lf lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma bi translated">💭我对德诺的感觉</h1><p id="bb26" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我决定与你分享我对Deno的感受，它可能会给你第一印象:</p><ul class=""><li id="134c" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">通过URL导入模块在开始时有点反直觉:您总是想创建一个<code class="fe nx ny nz no b">npm i</code>或<code class="fe nx ny nz no b">yarn add</code>。此外，我们必须运行deno来缓存我们的导入，只有这样我们才能访问自动完成。</li></ul><pre class="kn ko kp kq gt nn no np nq aw nr bi"><span id="547a" class="ns le iq no b gy nt nu l nv nw">The remote module XXX has not been cached</span></pre><ul class=""><li id="9d89" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">我总是在我的Javascript项目上使用TypeScript，所以一开始我一点也没有迷失。相反，我很熟悉它。</li><li id="f5df" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">有趣的一点:权限。我认为这是一件好事，例如Deno需要权限才能访问网络。作为开发人员，它迫使我们意识到程序的访问和权利。(更安全)</li><li id="4e29" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">我们一开始有点困惑去哪里找包(<a class="ae lc" href="https://deno.land/x" rel="noopener ugc nofollow" target="_blank">https://deno.land/x</a>→460包和NPM →+ 100万)</li><li id="6f25" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">你永远无法确定一个包是否也能在Deno上工作。你总想更接近你所知道的，用on Node把它转移到Deno。不知道是好事还是坏事，还是javascript…</li></ul><p id="7085" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">感谢</em><a class="ae lc" href="https://github.com/Aschen" rel="noopener ugc nofollow" target="_blank"><em class="kl">@ Aschen</em></a><em class="kl">对Github的挑剔反馈</em></p></div></div>    
</body>
</html>