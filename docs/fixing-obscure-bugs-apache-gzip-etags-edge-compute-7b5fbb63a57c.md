# ä¿®å¤æ¨¡ç³Šé”™è¯¯:Apacheã€GZipã€ETags å’Œ Edge Compute

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/fixing-obscure-bugs-apache-gzip-etags-edge-compute-7b5fbb63a57c>

![](img/5394b86f896794874f23ebe75b49917a.png)

æœ€è¿‘æœ‰äººå‘æˆ‘ä»‹ç»äº† Apache çš„ GZip æ¨¡å—çš„ä¸€ä¸ªæ¨¡ç³Šçš„æ€§èƒ½é”™è¯¯ï¼Œä»¥åŠä¸€ä¸ªä½¿ç”¨ [EdgeWorkers](https://www.akamai.com/solutions/edge?utm_source=austingil.com&utm_medium=blog&utm_campaign=austin-gil) çš„å·§å¦™è§£å†³æ–¹æ¡ˆã€‚æ‰€ä»¥æˆ‘åšäº†ä¸€ä¸ªè§†é¢‘ï¼Œè¿˜å‘äº†ä¸€ä¸ªå°åšæ–‡æ¥ä»‹ç»å®ƒ:

æˆ‘å–œæ¬¢æˆ‘çš„å·¥ä½œçš„ä¸€ç‚¹æ˜¯ï¼Œå½“æˆ‘å’Œæ¯”æˆ‘èªæ˜å¾—å¤šçš„äººä¸€èµ·å·¥ä½œæ—¶ï¼Œæˆ‘ä»æ¥æ²¡æœ‰å…´è¶£æˆ–æœºä¼šå»åšçš„äº‹æƒ…ã€‚

ä¾‹å¦‚ï¼Œè™½ç„¶ [Apache](https://httpd.apache.org/docs/) å¯ä»¥è¯´æ˜¯è¿™ä¸ªæ˜Ÿçƒä¸Šæœ€æµè¡Œçš„ HTTP æœåŠ¡å™¨æŠ€æœ¯ï¼Œä½†å®ƒä¹Ÿä¸æ˜¯æ²¡æœ‰ç¼ºé™·ã€‚å¦‚æœä½ å›é¡¾ä¸€ä¸‹[é”™è¯¯æŠ¥å‘Š](https://bz.apache.org/bugzilla/)ï¼Œä½ å¯èƒ½ä¼šå‘ç°ä¸€ä¸ªå«åšâ€œgzip:ed content ä¸Š[é”™è¯¯çš„ ETagâ€çš„é”™è¯¯æŠ¥å‘Šï¼Œè¿™æ˜¯äº¨å¾·é‡Œå…‹Â·è¯ºå¾·æ–¯ç‰¹é¾™åœ¨ 2006 å¹´æŠ¥å‘Šçš„ã€‚](https://bz.apache.org/bugzilla/show_bug.cgi?id=39727)

äº¨å¾·é‡Œå…‹æ³¨æ„åˆ°ï¼Œä½¿ç”¨`[mod_deflate](https://httpd.apache.org/docs/current/mod/mod_deflate.html)`æ¨¡å—å‹ç¼©çš„å®ä½“ä»ç„¶æºå¸¦ä¸æ™®é€šå®ä½“ç›¸åŒçš„ [ETag](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag) ï¼Œè¿™å¯¼è‡´äº†ä¸ ETag æ„ŸçŸ¥ä»£ç†ç¼“å­˜çš„æŸç§ä¸ä¸€è‡´ã€‚

å¦‚æœæ‚¨ä¸ç†Ÿæ‚‰çš„è¯ï¼ŒETags æ˜¯ HTTP å“åº”å¤´ï¼Œä¸»è¦ç”¨äºæ ‡è¯†èµ„æºçš„ç‰¹å®šç‰ˆæœ¬ã€‚ETag çš„å€¼é€šå¸¸æ˜¯ä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œç”±æ–‡ä»¶å†…å®¹æˆ–ä¿®æ”¹æ—¥æœŸæˆ–è€…ä¸¤è€…çš„ç»„åˆç”Ÿæˆã€‚

å®ƒå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·:

```
ETag: 27dc5-556d73fd7fa43
```

å¦‚æœä¸€ä¸ª HTTP è¯·æ±‚åŒ…å«ä¸€ä¸ªä¸ç°æœ‰ ETag å“åº”å¤´åŒ¹é…çš„`[If-None-Match](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-None-Match)`å¤´ï¼Œä»£ç†ç¼“å­˜(å¦‚ CDN)å¯ä»¥è®¤ä¸ºæ–‡ä»¶å·²ç»æ›´æ”¹ä½†æœªè¢«ä¿®æ”¹ï¼Œå¹¶å¯èƒ½ä»¥ 304â€œæœªä¿®æ”¹â€çŠ¶æ€å“åº”ã€‚

ç†è®ºä¸Šï¼Œè¿™æ ·ä¼šæ›´å¿«å¹¶èŠ‚çœå¸¦å®½ã€‚

å½“æ‚¨åœ¨ Apache ä¸­å¯ç”¨ GZip å‹ç¼©æ¨¡å—æ—¶ï¼Œå®ƒå®é™…ä¸Šä¼šåœ¨è¿™äº›ä¸º ETags ç”Ÿæˆçš„å“ˆå¸Œå€¼çš„æœ«å°¾é™„åŠ ä¸€ä¸ªå°å°çš„â€œ-gzipâ€åç¼€ã€‚

ä¸å¹¸çš„æ˜¯ï¼Œå½“ Apache å»æ¯”è¾ƒ`If-None-Match`å¤´(" 27dc5-556d73fd7fa43-gzip ")å’Œ ETag å€¼(" 27dc5-556d73fd7fa43 ")æ—¶ï¼Œå®ƒæ²¡æœ‰è€ƒè™‘åç¼€ã€‚

å› æ­¤ï¼Œå®ƒæ€»æ˜¯è¦æœåŠ¡äºæ•´ä¸ªèµ„æºè´Ÿè½½ï¼Œè¿™æ˜¯å…·æœ‰è®½åˆºæ„å‘³çš„ï¼Œå› ä¸ºç†è®ºä¸Š ETags å’Œ GZip éƒ½æ˜¯èŠ‚çœå¸¦å®½çš„æ–¹æ³•ã€‚

æˆ‘å¸Œæœ›æˆ‘èƒ½å¤Ÿæ¸…æ¥šåœ°è§£é‡Šè¿™ä¸ªé—®é¢˜ï¼Œä½†å¦‚æœæˆ‘æ²¡æœ‰ï¼Œåœ¨ [Flameeyes çš„åšå®¢](https://flameeyes.blog/)ä¸Šæœ‰ä¸€ç¯‡é¢˜ä¸ºâ€œ [Apacheï¼ŒETag å’Œâ€˜æœªä¿®æ”¹â€™](https://flameeyes.blog/2017/08/22/apache-etag-and-not-modified/)â€çš„ç²¾å½©åšæ–‡ã€‚å®ƒç”šè‡³æä¾›äº†è§£å†³æ–¹æ¡ˆã€‚

é‚£ä¹ˆï¼Œå¦‚æœé—®é¢˜å·²ç»è§£å†³äº†ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»Šå¤©è¦è°ˆè¿™ä¸ªï¼Ÿ

è¿™ä¸ªè§£å†³æ–¹æ¡ˆè¦æ±‚æ‚¨ä¿®æ”¹ Apache é…ç½®ã€‚ä½†æ˜¯ä½œä¸ºç°åœ¨çš„å¼€å‘äººå‘˜ï¼Œæˆ‘éå¸¸æ¸…æ¥šåœ¨å¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬è‡ªå·±æ— æ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚æˆ‘å¯èƒ½æ²¡æœ‰æƒé™ï¼Œæˆ–è€…æˆ‘å¯èƒ½æ­£åœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ã€‚

æœ‰è¶£çš„è§£å†³æ–¹æ¡ˆå‡ºç°äº†ã€‚

[Akamai](https://www.akamai.com/) æœ‰ä¸€æ¬¾äº§å“å«åš [EdgeWorkers](https://www.akamai.com/solutions/edge) ï¼Œå®ƒåŸºæœ¬ä¸Šå¯ä»¥ååœ¨å®¢æˆ·ç«¯å’ŒæºæœåŠ¡å™¨ä¹‹é—´ï¼Œè¿è¡Œ [JavaScript](https://austingil.com/category/javascript/) é€»è¾‘ã€‚

å› æ­¤ï¼Œå½“å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚æ—¶ï¼ŒEdgeWorker å¯ä»¥æ‹¦æˆªè¯·æ±‚ï¼Œå¹¶åœ¨è¯·æ±‚åˆ°è¾¾æºæœåŠ¡å™¨çš„é€”ä¸­å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚æˆ–è€…å½“æºæœåŠ¡å™¨åšå‡ºå“åº”æ—¶ï¼ŒAkamai EdgeWorker å¯ä»¥æ‹¦æˆªè¯¥å“åº”ï¼Œå¹¶åœ¨å®ƒè¢«ä¼ å›å®¢æˆ·ç«¯ä¹‹å‰å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚

ç†è®ºä¸Šï¼Œä¸èƒ½è®¿é—® Apache é…ç½®çš„å¼€å‘äººå‘˜ä»ç„¶å¯ä»¥æ‰“ä¸´æ—¶è¡¥ä¸ï¼Œç›´åˆ°è§£å†³æ–¹æ¡ˆåœ¨ Apache é…ç½®çº§åˆ«å¾—åˆ°è§£å†³ã€‚

å®ƒå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·:

```
// Modify origin responses
export function onOriginResponse(request, response) {
  // Grab the server name
  const serverName = response.getHeader('Server')[0];
  // Grab the ETag header
  const etag1 = response.getHeader('ETag')[0];
  // Check if it's an Apache server and the ETag ends with '-gzip'
  if (serverName.startsWith('Apache') && etag1.endsWith('-gzip')) {
    // If so, strip out the '-gzip' suffix
    response.setHeader('ETag', etag1.replace('-gzip', ''));
  }
}
```

æˆ‘æ„è¯†åˆ°è¿™å¯èƒ½å®é™…ä¸Šä¸é€‚ç”¨äºå¾ˆå¤šäººï¼Œä½†æˆ‘æƒ³åˆ†äº«å®ƒï¼Œå› ä¸ºå®ƒåœ¨æ¨¡ç³Šçš„é”™è¯¯ã€æ·±åšçš„æŠ€æœ¯çŸ¥è¯†å’Œéœ€è¦ä¿®å¤çš„å‡ è¡Œä»£ç ä¹‹é—´å–å¾—äº†è‰¯å¥½çš„å¹³è¡¡ã€‚ç‰¹åˆ«æ˜¯å½“ä½ åŒ…æ‹¬ Akamai EdgeWorkers éƒ¨åˆ†æ—¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªæˆ‘ä»¥å‰ä»æœªæƒ³åˆ°è¿‡çš„å¾ˆé…·ã€å¾ˆä¼˜é›…çš„æ–¹æ³•ã€‚

æ‰€ä»¥å¸Œæœ›ä½ ä¹Ÿè§‰å¾—å®ƒæœ‰è¶£ï¼Œå³ä½¿å®ƒä¸ä½ ä»Šå¤©æ²¡æœ‰ç›´æ¥å…³ç³»ã€‚

éå¸¸æ„Ÿè°¢æ‚¨çš„é˜…è¯»ã€‚å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·[åˆ†äº«å®ƒ](https://twitter.com/share?via=heyAustinGil)ã€‚è¿™æ˜¯æ”¯æŒæˆ‘çš„æœ€å¥½æ–¹å¼ä¹‹ä¸€ã€‚ä½ ä¹Ÿå¯ä»¥[æ³¨å†Œæˆ‘çš„æ—¶äº‹é€šè®¯](https://austingil.com/newsletter/)æˆ–è€…[åœ¨ Twitter ä¸Šå…³æ³¨æˆ‘](https://twitter.com/heyAustinGil)å¦‚æœä½ æƒ³çŸ¥é“ä»€ä¹ˆæ—¶å€™æœ‰æ–°æ–‡ç« å‘è¡¨ã€‚

*åŸè½½äº*[](https://austingil.com/apache-gzip-etags-edge-compute/)**ã€‚**

# *åˆ†çº§ç¼–ç *

*æ„Ÿè°¢æ‚¨æˆä¸ºæˆ‘ä»¬ç¤¾åŒºçš„ä¸€å‘˜ï¼åœ¨ä½ ç¦»å¼€ä¹‹å‰:*

*   *ğŸ‘ä¸ºæ•…äº‹é¼“æŒï¼Œè·Ÿç€ä½œè€…èµ°ğŸ‘‰*
*   *ğŸ“°æŸ¥çœ‹[çº§ç¼–ç å‡ºç‰ˆç‰©](https://levelup.gitconnected.com/?utm_source=pub&utm_medium=post)ä¸­çš„æ›´å¤šå†…å®¹*
*   *ğŸ””å…³æ³¨æˆ‘ä»¬:[æ¨ç‰¹](https://twitter.com/gitconnected) | [LinkedIn](https://www.linkedin.com/company/gitconnected) | [æ—¶äº‹é€šè®¯](https://newsletter.levelup.dev)*

*ğŸš€ğŸ‘‰ [**å°†åƒä½ è¿™æ ·çš„å¼€å‘äººå‘˜å®‰ç½®åœ¨é¡¶çº§åˆ›ä¸šå…¬å¸å’Œç§‘æŠ€å…¬å¸**](https://jobs.levelup.dev/talent/welcome?referral=true)*