<html>
<head>
<title>Spotify Codes and How They Work</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spotify代码及其工作原理</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/spotify-codes-and-how-they-work-664f4e4b8489?source=collection_archive---------5-----------------------#2021-04-15">https://levelup.gitconnected.com/spotify-codes-and-how-they-work-664f4e4b8489?source=collection_archive---------5-----------------------#2021-04-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f5ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Spotify为每首歌曲、专辑、艺术家和播放列表创建唯一的条形码和专辑封面图像。用户可以使用这些可扫描的代码来快速分享或访问Spotify中的内容。但我更感兴趣的是这些代码是如何工作的，Spotify会不会用光其媒体内容的“唯一”代码？</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/33bc433d800ccc4c8446613dfae7df0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KwX46yLt6Fcekj4Tc4Rq6Q.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">通往地狱之路的Spotify代码</figcaption></figure><p id="afa3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">典型的Spotify代码包含23个小节，每个代码都以Spotify徽标开始。根据Spotify Codes网站的说法，Spotify代码需要在前面有Spotify标志，这样扫描仪才能读取它们。这意味着Spotify标志有助于识别图像中具有机器可读代码的区域。</p><p id="eb41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">代码还定义了开始和结束标记，以定义代码的开始和结束。扫描方法识别该起点和终点、它们之间的轴以及指示最大偏移的参考标记。对于可能的长度值，偏移量除以步长，在本例中为7。代码中的每个条的长度是从轴点到条的光学标记的末端测量的，四舍五入到最接近的步长。因此，该算法可以将该条的长度转换成相应的<em class="lc">格雷码。</em></p><h2 id="0958" class="ld le iq bd lf lg lh dn li lj lk dp ll jy lm ln lo kc lp lq lr kg ls lt lu lv bi translated">格雷码</h2><p id="fba7" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated"><a class="ae lb" href="https://www.tutorialspoint.com/what-is-gray-code" rel="noopener ugc nofollow" target="_blank">格雷码</a>是二进制数字系统的排序，使得两个连续值仅相差一位。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/6dba4612b460e09e7e2b97822f33de52.png" data-original-src="https://miro.medium.com/v2/resize:fit:718/format:webp/0*jXbtlZ4dbKQLrjda.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">八种可能长度的格雷码编码</figcaption></figure><p id="bf49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是为什么使用格雷码而不是二进制编码呢？在读取机器可读代码时，可能会出现错误。该代码可以测量距离3和4之间的光条。只有一位是不确定的；编码位可以是010或110(格雷码代表3和4)。如果我们使用二进制编码，所有三位都是不确定的(可能的位是011或100)。<em class="lc">因此，每个测量的距离生成3个比特，其中一个比特可能具有小于100%的确定性。</em></p><p id="2ad3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来看看“通往地狱的高速公路”Spotify代码，并将条形转换为格雷码，好吗？</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/93dcebc280f675fa92e86bd22d6769ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:546/format:webp/1*cWMYk14Is57OYMNJ0qgQAA.jpeg"/></div></figure><p id="f469" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要对我们的图像进行一些图像增强，以使结果更适合于进一步的分析。我们将使用<a class="ae lb" href="https://scikit-image.org/" rel="noopener ugc nofollow" target="_blank"> Skimage </a>加载图像，将其转换为灰度，然后转换为二进制。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="289e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们需要检测图像中的条形。首先，我们需要标记图像，然后使用<a class="ae lb" href="https://scikit-image.org/docs/dev/api/skimage.measure.html#skimage.measure.regionprops" rel="noopener ugc nofollow" target="_blank"> regionprops </a>测量标记图像区域的属性。维度的每个元素都是一个元组，表示(最小行，最小列，最大行，最大列)。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="db08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要最大高度作为参考来计算所有条的步长。</p><p id="676c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://scikit-image.org/docs/dev/api/skimage.measure.html#skimage.measure.label" rel="noopener ugc nofollow" target="_blank">标签</a>返回dtype int的ndarray。我们需要保留标签的顺序。因此，我们需要按min_col对维度进行排序。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="1160" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">光学棒的步长可以在0和7之间变化；因此，可能有八个可能的值。正如我之前提到的，第一个和最后一个小节作为开始和结束标记，而中间的小节是其他小节的参考。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="71d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该顺序为我们提供了图像中每个条形的步长。</p><pre class="km kn ko kp gt mf mg mh mi aw mj bi"><span id="5065" class="ld le iq mg b gy mk ml l mm mn">[0, 5, 3, 2, 4, 6, 3, 3, 4, 2, 1, 7, 5, 4, 3, 6, 4, 7, 7, 6, 4, 2, 0]</span></pre><p id="34a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们想象一下。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mo"><img src="../Images/323e24ff00b216fd373fbd8797f8d321.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qz2Ao2iaXAcKdWus7Padww.png"/></div></div></figure><p id="49fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我实现这一点的代码。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="a0c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据<a class="ae lb" href="https://data.epo.org/publication-server/pdf-document/EP18199246NWA1.pdf?PN=EP3444755%20EP%203444755&amp;iDocId=5852402&amp;iepatch=.pdf" rel="noopener ugc nofollow" target="_blank"> Spotify的专利</a> <em class="lc">，除了起止标记的固定长度和参考标记，每段距离编码3位</em>。所以总共有60位。</p><pre class="km kn ko kp gt mf mg mh mi aw mj bi"><span id="2eae" class="ld le iq mg b gy mk ml l mm mn">110010011110101010010110011001110110010101110100100101110011</span></pre><p id="366f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">比特被打乱以分散错误。在码字中，丢失的比特不是连续的，而是不连续的。当丢失了整个条/距离时，这提高了前向纠错的机会。</p><h2 id="8d6e" class="ld le iq bd lf lg lh dn li lj lk dp ll jy lm ln lo kc lp lq lr kg ls lt lu lv bi translated">解码</h2><p id="be2e" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">然后发送新的有序比特进行解码。该专利表明，他们可能使用卷积码进行前向纠错(FEC)和维特比解码器，该解码器对前向纠错码进行最大似然解码，提取纠错后的45位(37位用于媒体参考，8位用于校验和)。</p><p id="fccd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们不会深入研究解码的算法。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mp"><img src="../Images/06791c593af3470e87c0fc045faa7e24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rkf5cfl_Ft95T3Z8ExW5GQ.png"/></div></div></figure><p id="0378" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">校验和得到验证，37位参考被发送到服务器。</p><p id="e9e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建媒体引用时，可能已经在服务器上分配了一个随机数，并存储在链接媒体URI的表中。例如，歌曲或播放列表。然后，服务器将相应的媒体返回给扫描图像的设备。</p><p id="38a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">生成媒体引用、将其转换为Spotify代码、然后读取这些代码以提取媒体引用的整个过程相当复杂。不过，我喜欢让代码看起来像声波的想法。</p><h2 id="4818" class="ld le iq bd lf lg lh dn li lj lk dp ll jy lm ln lo kc lp lq lr kg ls lt lu lv bi translated">Spotify会用完这些独特的代码吗？</h2><p id="5010" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">答案是否定的。如果你看看Spotify的媒体URI，它遵循以下格式。</p><pre class="km kn ko kp gt mf mg mh mi aw mj bi"><span id="7b54" class="ld le iq mg b gy mk ml l mm mn">spotify:&lt;type of media&gt;:&lt;media reference&gt;<br/>spotify:track:3Dv1eDb0MEgF93GpLXlucZ</span></pre><p id="d2cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">媒体引用是由字母和数字a-z、A-Z以及0–9(26+26+10 = 62)组成的22个字符</p><p id="930e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可能的组合总数是62 = 2.7078036478026614e+39(很多)。可以说，Spotify不会很快用完它。</p><h2 id="3073" class="ld le iq bd lf lg lh dn li lj lk dp ll jy lm ln lo kc lp lq lr kg ls lt lu lv bi translated">谷歌的现货代码</h2><p id="2199" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">Google pay有一个对每个用户都是独一无二的现货代码。Spot Code是一种谷歌品牌的视觉代码，其工作原理类似于QR码，但它是Google Pay India独有的。你可以分享和扫描一个点代码来找到一个对等点或一个点。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mq"><img src="../Images/d562e5eefe2d6b45522423b895809c8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JmlDEO9qmBzVe2q5.jpg"/></div></div></figure></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><p id="fdcf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些代码比标准的二维码或条形码领先一步。它展示了图像处理带来的创造力的范围。Spotify的专利有足够的洞察力来理解这一切背后的基本处理过程，尽管我在谷歌的spot代码中找不到同样的东西。</p><p id="dda6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章花了很长时间来写，主要是因为我没有图像处理的经验，但是<a class="ae lb" href="https://scikit-image.org/docs/stable/" rel="noopener ugc nofollow" target="_blank"> Skimage </a>有足够的演示和教程来开始。如果你有任何问题或反馈，请在评论中告诉我。如果你觉得它有帮助，请与他人分享！</p><p id="d23d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lc">查看这篇由</em> <a class="ae lb" href="https://boonepeter.github.io/posts/2020-11-10-spotify-codes/" rel="noopener ugc nofollow" target="_blank"> <em class="lc">彼得·布恩</em> </a> <em class="lc">撰写的文章，获得关于Spotify代码工作的更多见解。</em></p></div></div>    
</body>
</html>