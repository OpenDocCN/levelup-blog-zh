<html>
<head>
<title>Ruby on Rails 6 with Google Analytics, Turbolinks, and a Content Security Policy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ruby on Rails 6，带有Google Analytics、Turbolinks和内容安全策略</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/ruby-on-rails-6-with-google-analytics-turbolinks-and-a-content-security-policy-c4e078df8530?source=collection_archive---------6-----------------------#2020-05-26">https://levelup.gitconnected.com/ruby-on-rails-6-with-google-analytics-turbolinks-and-a-content-security-policy-c4e078df8530?source=collection_archive---------6-----------------------#2020-05-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f16d85f9131f5e0ad43bfd06c8db5b0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l4RoG8mpEJSmuW9_md4M1g.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">谷歌分析显示3个实时访客登录</figcaption></figure><p id="17b6" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在过去的几年里，我没有在Ruby on Rails网站上添加Google Analytics，但当我发现对它的“开箱即用”支持如此之少时，我感到震惊。如果你按照Google Analytics的设置，将他们的脚本复制并粘贴到HTML的<code class="fe ld le lf lg b">head</code>中，你可能会遇到很多冲突。其中主要是内容安全政策(CSP)和Turbolinks。对于一个想要安全和快速的现代网站来说，这两者都是必不可少的。</p><p id="3fb7" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">特别是CSP保护您和您的用户免受<a class="ae lh" href="https://owasp.org/www-community/xss-filter-evasion-cheatsheet" rel="noopener ugc nofollow" target="_blank">一系列跨站点脚本(XSS)攻击</a>。虽然这可能会很复杂和繁琐，但是您应该启用它，就像您使用<code class="fe ld le lf lg b">config.force_ssl = true</code>实施https一样。</p><p id="601b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因此，在保留CSP和Turbolinks的同时，安全地将Google Analytics添加到您的Rails网站中是非常重要的。</p><p id="3697" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">首先在<code class="fe ld le lf lg b">config/initializers/content_security_policy.rb</code>启用CSP。您会注意到Rails默认为<code class="fe ld le lf lg b">policy.script_src :self, :https</code>，它允许您的站点脚本和来自任何https源的任何脚本。坏人也使用https，所以这似乎是不明智的。而是指定您想要允许的确切外部来源。</p><figure class="li lj lk ll gt ju"><div class="bz fp l di"><div class="lm ln l"/></div></figure><p id="1cc6" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">您需要两个Google域，因为来自第一个域的脚本与第二个域交互。</p><p id="3e08" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果你忽略了谷歌资源，保留了<code class="fe ld le lf lg b">:self</code>，那么你就是在告诉浏览器，你只希望允许与你的网站在同一个域的脚本。如果你试图加载谷歌分析，那么你的浏览器会显示这样的错误。</p><figure class="li lj lk ll gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lo"><img src="../Images/c1788605d1439d01d2a136e77da5d5ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Q0EWththpWh_NUw5EVhiA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">浏览器中的内容安全策略源错误</figcaption></figure><p id="eda9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果你包含了Google sources，但是按照Google Analytics的建议在你的<code class="fe ld le lf lg b">application.html.erb</code>中放了一个脚本块，那么你就会遇到这个CSP错误。</p><figure class="li lj lk ll gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lp"><img src="../Images/decefadcc0e516b79225571b19730c27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7HEuKLl94qcLtWc7A3csRw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">浏览器中的内容安全策略内联脚本错误</figcaption></figure><p id="b3e3" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">您可以使用<code class="fe ld le lf lg b">policy.script_src :self, :unsafe_inline…</code>来实现这一点，但是顾名思义，这是不安全的。或者，您可以在脚本块中添加一个nonce，向浏览器和服务器证明脚本块是安全的。为此，您需要为Rails CSP配置一个随机数生成器:</p><pre class="li lj lk ll gt lq lg lr ls aw lt bi"><span id="4555" class="lu lv it lg b gy lw lx l ly lz">Rails.application.config.content_security_policy_nonce_generator = -&gt;(_request) { SecureRandom.base64(16) }</span></pre><p id="291d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">然后你可以使用<code class="fe ld le lf lg b">&lt;%= javascript_tag nonce: true do %&gt;</code>助手。这种方法可以工作，但是您需要通过所有的Turbolinks XHR调用来传输随机数，并修改Rails CSP随机数生成器，以便为一个会话使用一个随机数。这很复杂，复杂会导致您的安全漏洞和分析失误。</p><p id="24c9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">不如忘记脚本块，将Google Analytics代码包含在您自己的Javascript文件中。因为您已经说过<code class="fe ld le lf lg b">policy.script_src :self</code>脚本将被允许，并且不需要随机数。</p><p id="fafc" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在你的<code class="fe ld le lf lg b">application.html.erb</code>中包含谷歌脚本和你自己的<code class="fe ld le lf lg b">analytics.js</code></p><figure class="li lj lk ll gt ju"><div class="bz fp l di"><div class="lm ln l"/></div></figure><figure class="li lj lk ll gt ju"><div class="bz fp l di"><div class="lm ln l"/></div></figure><p id="4915" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">重要的一点是不要让Webpack编译<code class="fe ld le lf lg b">analytics.js</code>或者把它和你的其他Javascript一起包含在一个包中。Webpack将Javascript包在几层中，这似乎阻碍了Google Analytics的工作。你可以把<code class="fe ld le lf lg b">analytics.js</code>放在<code class="fe ld le lf lg b">app/assets/javascript</code>而不是<code class="fe ld le lf lg b">app/javascripts</code>。您还需要更新<code class="fe ld le lf lg b">manifest.js</code>以包含<code class="fe ld le lf lg b">//= link analytics.js</code>。</p><p id="33cc" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在这一点上，你将有工作和安全的首页访问跟踪。然而，由于Turbolinks通过XHR加载页面，后续的访问将不会被发送到谷歌分析。您需要像这样利用<code class="fe ld le lf lg b">turbolinks:load</code>事件:</p><figure class="li lj lk ll gt ju"><div class="bz fp l di"><div class="lm ln l"/></div></figure><p id="d56d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">您可能会注意到可选的<code class="fe ld le lf lg b">cookie_flags</code>，它在<code class="fe ld le lf lg b">samesite</code>cookie上设置了<code class="fe ld le lf lg b">secure</code>选项。这是向浏览器推出的额外安全性，通常会导致警告，但很快就会变成错误:</p><figure class="li lj lk ll gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lp"><img src="../Images/4047197f0cd793ed575ec75bcb382c49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LsvELoWhUnviG8F_Ve7JBA.png"/></div></div></figure><p id="3576" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">现在你知道了，为了确保你可以在你的Ruby on Rails 6应用中安全可靠地使用谷歌分析，你跳了很多次。</p><figure class="li lj lk ll gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ma"><img src="../Images/9b164b5400dc3c1ae657ada81ca0591d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qKfY7Va5g1EoUguPlg8AlQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">显示谷歌分析XHR跟踪的浏览器控制台</figcaption></figure><p id="3533" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">一个演示应用的源代码可以在<a class="ae lh" href="https://github.com/paulmwatson/rails-google-analytics-csp-turbolinks" rel="noopener ugc nofollow" target="_blank">https://github . com/paulmwatson/rails-Google-analytics-CSP-turbo links</a>上找到。</p><p id="1383" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">关键文件是:</p><ul class=""><li id="7cee" class="mb mc it kh b ki kj km kn kq md ku me ky mf lc mg mh mi mj bi translated"><a class="ae lh" href="https://github.com/paulmwatson/rails-google-analytics-csp-turbolinks/blob/master/config/initializers/content_security_policy.rb" rel="noopener ugc nofollow" target="_blank">content _ security _ policy . Rb</a></li><li id="1d22" class="mb mc it kh b ki mk km ml kq mm ku mn ky mo lc mg mh mi mj bi translated"><a class="ae lh" href="https://github.com/paulmwatson/rails-google-analytics-csp-turbolinks/blob/master/app/views/layouts/application.html.erb" rel="noopener ugc nofollow" target="_blank"> application.html.erb </a></li><li id="b4a3" class="mb mc it kh b ki mk km ml kq mm ku mn ky mo lc mg mh mi mj bi translated"><a class="ae lh" href="https://github.com/paulmwatson/rails-google-analytics-csp-turbolinks/blob/master/app/assets/javascript/analytics.js" rel="noopener ugc nofollow" target="_blank"> analytics.js </a></li></ul></div></div>    
</body>
</html>