<html>
<head>
<title>Building a Flutter Computer Vision App Using Dart:ffi, OpenCV, and Tensorflow (Part 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dart构建颤振计算机视觉应用程序:ffi、OpenCV和Tensorflow(第3部分)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/building-a-flutter-computer-vision-app-using-dart-ffi-opencv-and-tensorflow-part-3-8e3a1182250b?source=collection_archive---------2-----------------------#2022-03-06">https://levelup.gitconnected.com/building-a-flutter-computer-vision-app-using-dart-ffi-opencv-and-tensorflow-part-3-8e3a1182250b?source=collection_archive---------2-----------------------#2022-03-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="30bd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">这是解释如何使用dart:ffi、OpenCV和Tensorflow在Flutter中编写计算机视觉应用程序的三部分系列的最后一部分。</h2></div><p id="82e0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://medium.com/@jeffrey.wolberg/building-a-flutter-computer-vision-app-using-dart-ffi-opencv-and-tensorflow-part-1-513dac9325ab" rel="noopener"> <strong class="kh ir">第一部分</strong> </a> <strong class="kh ir">讨论了如何正确配置OpenCV库和我们的自定义C++文件以在Flutter应用程序中工作，以及如何通过dart:ffi从Dart访问这些C++文件。</strong></p><p id="5415" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://medium.com/@jeffrey.wolberg/building-a-flutter-computer-vision-app-using-dart-ffi-opencv-and-tensorflow-part-2-81472b4ac380" rel="noopener"> <strong class="kh ir">第二部分</strong> </a> <strong class="kh ir">讨论如何使用dart:ffi库使用指针在Dart和C++之间传递数据。这对于将图像数据传输到C++来说尤其重要，这样它就可以被OpenCV操作并返回到Dart。</strong></p><p id="6920" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">第三部分讨论了如何使用tflite_flutter插件在Flutter应用程序中使用TensorFlow。我们将通过适当的配置，常见的错误，以及如何在我们的设备上运行推理。(即将推出！)</strong></p><p id="4840" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意:本教程只包括iOS的配置，并且已经在M1 mac上测试过。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/f6021a5355d99ea7a8abf5a7ff3af46d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z-ao-EkG3iq5e2M1eZ0SHw.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Sudoku Cam，一个用C++实现的使用OpenCV的计算机视觉颤振app</figcaption></figure><p id="8b65" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<a class="ae lb" href="https://medium.com/@jeffrey.wolberg/building-a-flutter-computer-vision-app-using-dart-ffi-opencv-and-tensorflow-part-1-513dac9325ab" rel="noopener">之前的</a> <a class="ae lb" href="https://medium.com/@jeffrey.wolberg/building-a-flutter-computer-vision-app-using-dart-ffi-opencv-and-tensorflow-part-2-81472b4ac380" rel="noopener">教程</a>中，我们看到了如何使用dart:ffi库在C++中访问OpenCV，以及如何在dart中来回发送图像数据。我们经常需要使用OpenCV对图像进行一些处理，然后将其发送到神经网络，该网络将为我们执行一些任务，如分类。让我们来学习如何使用<strong class="kh ir"> tflite_flutter </strong>包如何运行设备上的推断！注意:我将使用<em class="ls"> tflite_flutter </em>包，而不是<em class="ls"> tflite </em>包，因为前者提供了调整列表大小和运行多输入推理的便捷方法。这将在本教程的后面演示。</p><p id="390e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是tflite_flutter包的官方文档，它们给出了更全面的概述。</p><h2 id="83b8" class="lt lu iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated">库的配置</h2><p id="fd04" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">像OpenCV一样，我们必须为它提供一个. framework文件，这是一个包含库的头文件和静态链接的二进制文件的包:在这种情况下，我们将需要<strong class="kh ir"> TensorFlowLiteC.framework，</strong>你可以通过点击<a class="ae lb" href="https://github.com/am15h/tflite_flutter_plugin/releases/download/v0.5.0/TensorFlowLiteC.framework.zip" rel="noopener ugc nofollow" target="_blank">这个链接</a>来下载。下载后，将文件粘贴到<strong class="kh ir"> ~/中。pub-cache/hosted/pub . dartlang . org/TF lite _ flutter&lt;版本&gt; /ios </strong></p><p id="6900" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我会推荐尝试导入如下的包来测试你的app是否能够访问tflite_flutter。</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="a5c5" class="lt lu iq ms b gy mw mx l my mz">import 'package:tflite_flutter/tflite_flutter.dart';</span></pre><p id="18cc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您的应用程序构建成功，那太好了，您可以跳到下一部分。如果出现链接错误，请继续阅读。在某些情况下<strong class="kh ir">。Flutter用于其包的pub-cache </strong>文件夹不在上面提供的位置，而是可以在Flutter目录中找到。在这种情况下，导航到<strong class="kh ir"> &lt;颤振方向&gt; /。pub-cache/hosted/pub . dartlang . org/TF lite _ flutter&lt;VERSION&gt;/IOs</strong>并将文件粘贴到那里。正确的位置也可以通过如下符号链接访问:<strong class="kh ir"> &lt; PROJECT-DIR &gt; /ios/。symlinks/plugins/TF lite _ flutter/IOs/</strong></p><p id="625e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，Flutter-DIR指的是下载FLUTTER的目录，而PROJECT-DIR指的是编写FLUTTER应用的文件夹。</p><h2 id="4582" class="lt lu iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated">在设备上运行推理</h2><p id="40d2" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">因为机器学习任务通常需要大量计算，所以<strong class="kh ir">。tflite </strong>文件的发明是为了让边缘设备(比如手机)尽可能高效快速地运行推理。您可以通过此处提供的说明<a class="ae lb" href="https://www.tensorflow.org/lite/convert" rel="noopener ugc nofollow" target="_blank">将您的训练模型转换为. tflite文件。</a></p><p id="bfec" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦你有了这些，让我们在我们的设备上的Flutter应用程序中设置我们的模型。</p><p id="7675" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用以下函数加载我们的模型:</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="ac3b" class="lt lu iq ms b gy mw mx l my mz">import 'package:tflite_flutter/tflite_flutter.dart';<br/>Interpreter model = await Interpreter.fromAsset("modelName.tflite");</span></pre><p id="0e71" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">确保在pubspec.yaml文件的assets部分提供模型路径，如下所示:</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="bdb3" class="lt lu iq ms b gy mw mx l my mz">assets:<br/>  - assets/modelName.tflite</span></pre><p id="7e00" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">加载模型后，由您来配置输入数据，以匹配创建模型时指定的尺寸。</p><p id="8278" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，让我们假设我们正在对81个34x34灰度图像(81，34，34，1)进行推理，以从十个可能的类别(81，10)中对每个图像进行分类。</p><p id="58e1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的Dart代码如下所示:</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="607d" class="lt lu iq ms b gy mw mx l my mz">// create a list of 81 empty lists<br/>List&lt;Object&gt; inputs = List&lt;Object&gt;.generate(81, (index) =&gt; []); </span><span id="4c56" class="lt lu iq ms b gy na mx l my mz">// fill in our pixel values and ensure that they're the right size <br/>for (int i=0; i&lt;81; i++)<br/>    inputs[i] = images[i].reshape([34, 34, 1]);</span><span id="1a4e" class="lt lu iq ms b gy na mx l my mz">// initialize our outputs to 0<br/>Map&lt;int, Object&gt; outputs = <br/>{ 0: List&lt;double&gt;.filled(81 * 10, 0).reshape([81, 10]) };</span><span id="29b8" class="lt lu iq ms b gy na mx l my mz">// run our model! The results will be written into 'outputs'<br/>model.runForMultipleInputs(inputs, outputs);</span></pre><p id="e646" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果TensorFlow模型预期的尺寸与Dart代码输入的尺寸不匹配，请确保尺寸完全匹配。这包括尺寸为1的情况(例如(81，34，34，<strong class="kh ir"> <em class="ls"> 1 </em> </strong>))</p><p id="a667" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Dart提供了许多方便的列表操作，可用于获得每个输出数组的最大置信度得分和索引。</p><pre class="ld le lf lg gt mr ms mt mu aw mv bi"><span id="957d" class="lt lu iq ms b gy mw mx l my mz">import 'dart:math' as math;</span><span id="f594" class="lt lu iq ms b gy na mx l my mz">List&lt;List&lt;dynamic&gt;&gt; outValues = List&lt;List&lt;dynamic&gt;&gt;.from(output[0]);</span><span id="498f" class="lt lu iq ms b gy na mx l my mz">for (int i=0; i&lt;outValues.length; i++) {<br/>    // obtain maximum value in the currOutput<br/>    List&lt;double&gt; currOutput = List&lt;double&gt;.from(outValues[i]);<br/>    double maxVal = currOutput.reduce(math.max);</span><span id="bdb5" class="lt lu iq ms b gy na mx l my mz">    // obtains the first idx where maxVal occurs<br/>    int maxIdx = currOutput.indexWhere((el) =&gt; el == maxVal);<br/>    // MORE CODE HERE...</span><span id="ee46" class="lt lu iq ms b gy na mx l my mz">}</span></pre><p id="6acd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您可以将自定义的机器学习模型插入到Flutter应用程序中，并在设备上运行推理。我们之前学习了如何在C++中的OpenCV中运行图像处理，以及如何在Dart和T2之间传递数据。本教程总结了流水线的最后一个阶段，即对我们处理过的图像运行设备上的推理。希望你喜欢！</p></div></div>    
</body>
</html>