<html>
<head>
<title>Replicate encrypted S3 Objects to another AWS Account</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将加密的S3对象复制到另一个AWS帐户</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/replicate-encrypted-s3-objects-to-another-aws-account-8a3065d83cf6?source=collection_archive---------6-----------------------#2022-08-29">https://levelup.gitconnected.com/replicate-encrypted-s3-objects-to-another-aws-account-8a3065d83cf6?source=collection_archive---------6-----------------------#2022-08-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="d16e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ko">您是否希望将AWS S3(简单存储服务)中的对象安全地备份到不同的AWS S3存储桶中，以用于合规、审计或灾难恢复目的？</em></p><p id="6210" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我们将看到如何将所有加密的对象从一个S3桶(我们称之为<em class="ko">源桶</em>)复制到不同AWS帐户中的另一个S3桶(作为<em class="ko">目的桶</em>)。</p><p id="dc19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">AWS S3复制支持相同或不同AWS帐户中对象的跨区域、同区域复制。它还支持除AWS S3 SSE-C(服务器端加密—客户提供)之外的加密对象的复制。</p><h2 id="52c8" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">以下是加密对象的S3交叉帐户/相同区域复制的架构:-</h2><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi li"><img src="../Images/b29f5a11103d54f4dae8bf0d7150e1e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uhNWy3ndpoHfkCXCwH5p7g.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">AWS S3将加密对象复制到不同AWS帐户中的另一个存储桶</figcaption></figure><p id="1f80" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">关于S3复制的几件事:- </strong></p><ol class=""><li id="7ae2" class="ly lz it js b jt ju jx jy kb ma kf mb kj mc kn md me mf mg bi translated">复制不可追溯-这意味着默认情况下，S3对象中的现有对象不会复制到其目标存储桶(在不同的AWS帐户中)</li><li id="d32f" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">复制仅是单向的—这意味着它始终遵循从源到目标存储区的复制更改效果，而不是相反。例如，如果您删除目标存储桶中的任何复制对象，则该更改不会反映到源存储桶中。</li><li id="c488" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">除了在S3使用客户提供的密钥进行服务器端加密之外，加密对象可以被复制</li><li id="2608" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">支持RTC(复制时间控制), SLA为15分钟，用于目标存储区中的复制</li><li id="1139" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">还支持复制已删除的对象</li></ol><h2 id="904f" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">步骤:-</h2><ol class=""><li id="5f2f" class="ly lz it js b jt mm jx mn kb mo kf mp kj mq kn md me mf mg bi translated">在AWS帐户1中创建KMS键</li></ol><p id="a05d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">转到KMS服务，点击创建按钮，并提供以下输入</p><pre class="lj lk ll lm gt mr ms mt mu aw mv bi"><span id="7f70" class="kp kq it ms b gy mw mx l my mz">Key Type — Symmetric<br/>Key Usage — Encrypt and Decrypt<br/>Key Material Origin - KMS<br/>Regionality - Single Region Key<br/>Alias - &lt;provide alias name&gt;<br/>Description (optional) - &lt;provide relevant description of the key&gt;<br/>Tags (optional) - &lt;provide relevant tags&gt;</span></pre><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi na"><img src="../Images/db531ee65f68e18a5f9131fb1d0e61bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JR5ooRI-Ja7w_0PVfrUtig.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">KMS对称密钥</figcaption></figure><p id="5e4f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在此选择相关的<strong class="js iu">密钥管理员</strong>和<strong class="js iu">密钥用法</strong>。KMS支持单独的角色策略(资源策略)。<strong class="js iu">密钥管理员</strong>告知所有人(IAM用户/角色)可以管理该KMS密钥，包括其轮换，而<strong class="js iu">密钥使用</strong>告知所有人(IAM用户/角色)可以使用这些密钥执行实际的加密操作(加密/解密)。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nb"><img src="../Images/54e19ecd7b600bd5b95ccbfa559e1ba4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SRtaxT-4wQCmMfcrNt9iQQ.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">KMS密钥—对称</figcaption></figure><p id="fe05" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.在两个AWS帐户中创建S3时段(源和目标),并在两个帐户中启用版本控制。创建时，选择默认加密，并将加密密钥类型选择为“<strong class="js iu"> AWS密钥管理服务密钥(SSE-KMS) </strong>”，然后选择KMS密钥(在上述步骤1中创建)。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nc"><img src="../Images/36a46f33ea41c91a0d51f862e7bb40cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xl1wr_QhvGvdiwttIs_gZg.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">S3 KMS加密</figcaption></figure><p id="c7bf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将确保在默认情况下，所有上传的对象将由您创建的KMS密钥加密。</p><p id="cadd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.使用以下内联策略在帐户1中创建IAM角色</p><pre class="lj lk ll lm gt mr ms mt mu aw mv bi"><span id="b205" class="kp kq it ms b gy mw mx l my mz">{<br/> “Version”: “2012–10–17”,<br/> “Statement”: [<br/> {<br/> “Effect”: “Allow”,<br/> “Action”: [<br/> “s3:GetObjectVersionForReplication”,<br/> “s3:GetObjectVersionAcl”<br/> ],<br/> “Resource”: [<br/> “arn:aws:s3:::&lt;source bucket name&gt;/*”<br/> ]<br/> },<br/> {<br/> “Effect”: “Allow”,<br/> “Action”: [<br/> “s3:ListBucket”,<br/> “s3:GetReplicationConfiguration”<br/> ],<br/> “Resource”: [<br/> “arn:aws:s3:::&lt;source bucket name&gt;”<br/> ]<br/> },<br/> {<br/> “Effect”: “Allow”,<br/> “Action”: [<br/> “s3:ReplicateObject”,<br/> “s3:ReplicateDelete”,<br/> “s3:ReplicateTags”,<br/> “s3:GetObjectVersionTagging”,<br/> “s3:ObjectOwnerOverrideToBucketOwner”<br/> ],<br/> “Resource”: “arn:aws:s3:::&lt;destination bucket name&gt;/*”<br/> }<br/> ]<br/>}</span></pre><p id="b8ba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(<em class="ko">请注意，您需要在给定的占位符</em>中使用您的来源和目标S3存储桶的实际名称来更新上述内联策略)</p><p id="ce04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.在AWS帐户2的目标S3时段中添加以下时段策略</p><pre class="lj lk ll lm gt mr ms mt mu aw mv bi"><span id="bcf1" class="kp kq it ms b gy mw mx l my mz">{<br/> “Version”: “2008–10–17”,<br/> “Id”: “”,<br/> “Statement”: [<br/> {<br/> “Sid”: “1”,<br/> “Effect”: “Allow”,<br/> “Principal”: {<br/> “AWS”: “arn:aws:iam::&lt;Number of aws account 1&gt;:role/&lt;source IAM role name&gt;”<br/> },<br/> “Action”: [<br/> “s3:ReplicateObject”,<br/> “s3:ReplicateDelete”<br/> ],<br/> “Resource”: “arn:aws:s3:::&lt;destionation bucket&gt;/*”<br/> },<br/> {<br/> “Sid”: “2”,<br/> “Effect”: “Allow”,<br/> “Principal”: {<br/> “AWS”: “arn:aws:iam::&lt;Number of aws account 1&gt;:root”<br/> },<br/> “Action”: “s3:ObjectOwnerOverrideToBucketOwner”,<br/> “Resource”: “arn:aws:s3:::&lt;destionation bucket&gt;/*”<br/> },<br/> {<br/> “Sid”: “3”,<br/> “Effect”: “Allow”,<br/> “Principal”: {<br/> “AWS”: “arn:aws:iam::&lt;Number of aws account 1&gt;:role/&lt;source IAM role name&gt;”<br/> },<br/> “Action”: [<br/> “s3:GetBucketVersioning”,<br/> “s3:PutBucketVersioning”<br/> ],<br/> “Resource”: “arn:aws:s3:::&lt;destionation bucket&gt;”<br/> }<br/> ]<br/>}</span></pre><p id="8b6a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意，<strong class="js iu"> <em class="ko">默认情况下，复制的对象只拥有源桶标识</em> </strong>的所有权，但这可以通过在上述策略中添加动作<strong class="js iu"><em class="ko">objectowneroverridepocketowner</em></strong>来修改为目标桶标识。</p><p id="9f33" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.在源存储桶中创建复制配置规则—给定复制名称、启用状态、规则(如果需要使用前缀在所有或特定对象集中完成复制)，提供目标帐户id、目标存储桶名称、IAM角色(在上述步骤3中创建)，选择使用KMS密钥ARN加密(在上述步骤1中创建)，选择RTC(复制时间控制)和删除标记复制(也将删除的对象复制到目标存储桶)。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nd"><img src="../Images/e97dd920cea5684265b052e1fb0804ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ulz5QjW6bq2FGWlMpzZvLg.png"/></div></div></figure><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi ne"><img src="../Images/afe0ad2962a2bc89f75b4b90c873501c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ymlcVrMIY2KoTnjf8Wm50w.png"/></div></div></figure><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nf"><img src="../Images/98b13a3e359950143417532653919889.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LGi073zfjG329UsTN5zh6Q.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">S3–复制配置规则</figcaption></figure><p id="38f1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">瞧啊。！！都搞定了:-)</p><p id="c693" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在源桶中添加一些使用我们创建的KMS密钥加密的对象，并在检入目标桶之前等待一段时间。您将看到加密的对象被复制到目标存储桶中。</p><p id="4457" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">a)在帐户1的源存储桶中上传了对象，该对象被复制到帐户2的目标存储桶中</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi ng"><img src="../Images/87d1be95acd00b253f1455b7fedc0e69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HTTBT8-ONBlfFrITFAaFeQ.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">AWS S3-来源时段</figcaption></figure><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nh"><img src="../Images/4d811048658a5d1a96afd2ad0e706b1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SAYpAqdFUWjPCO40jdL24w.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">AWS S3-目的地时段</figcaption></figure><p id="58c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">b)删除了在目标存储桶中复制的源存储桶中的现有对象</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi ni"><img src="../Images/e0d7cd0b2d6a76306ff975c279319012.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fH8EgaALLlkpZWWV5kn5gw.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">S3-源存储桶中的对象删除</figcaption></figure><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nj"><img src="../Images/2928e4f1f6359ecd534b623c3c4af245.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bmTmfbaH6yZuuRO1spWVpQ.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">S3-源存储桶中的对象删除</figcaption></figure><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nk"><img src="../Images/76094ac9390758ddb73e20c835cdeee8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IMrqYQpTa1yWiQ7UWxWhJQ.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">S3 —在目标存储桶中被删除</figcaption></figure><h1 id="17f2" class="nl kq it bd kr nm nn no ku np nq nr kx ns nt nu la nv nw nx ld ny nz oa lg ob bi translated">摘要:-</h1><p id="6c10" class="pw-post-body-paragraph jq jr it js b jt mm jv jw jx mn jz ka kb oc kd ke kf od kh ki kj oe kl km kn im bi translated">在本文中，我们看到了如何使用S3复制配置将对象(包括已删除的对象)复制到同一地区不同AWS帐户中的目标bucket。在遵循法规遵从性方面，复制起着至关重要的作用，即在任何灾难恢复或审计目的的情况下保持数据备份的安全性和持久性。</p></div></div>    
</body>
</html>