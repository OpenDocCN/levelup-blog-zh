<html>
<head>
<title>Benchmarking using Apache Bench.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Apache Bench进行基准测试。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/benchmarking-using-apache-bench-1daa7707fa63?source=collection_archive---------19-----------------------#2022-08-18">https://levelup.gitconnected.com/benchmarking-using-apache-bench-1daa7707fa63?source=collection_archive---------19-----------------------#2022-08-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="6c2a" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">想知道您的应用程序的性能如何吗？</h2><div class=""/><div class=""><h2 id="4d9b" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">熟悉绩效评估的流程。</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/294490716fcc837194bca6bb1c25c627.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OuiuwR3AeRVNV7Wz69glYg.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated"><a class="ae le" href="https://www.pexels.com/photo/fully-loaded-cargo-ship-sailing-on-sea-12530465/" rel="noopener ugc nofollow" target="_blank">凯利拍摄的照片</a></figcaption></figure><p id="f517" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">最近，我在咨询一个正在创建一组公共API的产品。这就要求API应该是<a class="ae le" href="https://medium.com/technogise/journey-of-a-quality-analyst-part-ii-9c6271748153" rel="noopener">高性能的</a>等等。我们还没有上线，我们的理论是，这是业务的核心产品之一，它将有很高的使用率。因此，我提议在管道中进行性能测试，这个提议很受欢迎。</p><p id="5f10" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在SDLC早期，我们需要将我们的系统与性能标准进行比较。我们还需要一个参考点(基准)——从一开始就能看出我们的系统性能如何。</p><p id="a9e6" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在团队内部讨论了我们的目标之后，我想出了一些工具。我们讨论了这些选项，并同意从<a class="ae le" href="https://httpd.apache.org/docs/2.4/programs/ab.html" rel="noopener ugc nofollow" target="_blank"> Apache Bench </a> (AB)和Ruby &amp; Shell脚本开始。</p><h2 id="06ec" class="mb mc iq bd md me mf dn mg mh mi dp mj lo mk ml mm ls mn mo mp lw mq mr ms iw bi translated">应用架构:</h2><ul class=""><li id="1976" class="mt mu iq lh b li mv ll mw lo mx ls my lw mz ma na nb nc nd bi translated">我们的是基于微服务的架构，使用包括Lambda在内的AWS基础设施。随之而来的是通常需要考虑的问题，如控制冷启动时间、配置合适的内存、提供并发性(PC)等。</li><li id="2bcc" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">我们的服务与其他一些内部服务进行通信(通过API调用),我们还必须忍受它们的冷启动时间。</li><li id="fa98" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">我们的申请是针对美国公民的，因此基础设施在美国。</li></ul><h2 id="090e" class="mb mc iq bd md me mf dn mg mh mi dp mj lo mk ml mm ls mn mo mp lw mq mr ms iw bi translated">测试的设计:</h2><ul class=""><li id="d3dc" class="mt mu iq lh b li mv ll mw lo mx ls my lw mz ma na nb nc nd bi translated">我们调用APIs 50次，并发数为5。这样做了3次，这样我们就能了解当天的表现。</li><li id="0492" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">正在分析我们所有的GET &amp; POST端点。我们没有分析补丁(AB缺乏对它的支持)和删除终点。</li><li id="4e5c" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">我们在美国地区运行测试Github Actions(我们的管道)的虚拟机通过Azure托管在美国。</li><li id="6dce" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">在测试运行之前，我们确保所有的Lambdas(包括我们的依赖项)都是热的。我们确实对cold Lambdas进行了单独的测试，并通过从我们以外的地区访问服务器来进行更深入的分析。</li><li id="69d0" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">我们断言应该有0个非2XX响应。在失败的情况下，我们在空闲信道中得到一个警报。在这种情况下，我们通常会检查AWS日志、AWS insights、AWS X射线，以便更好地了解问题。</li><li id="a859" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">我们最初的目标是在不提供并发性的情况下观察我们的应用程序的行为。因此，我们在没有配置PC的较低环境中运行它。</li><li id="3f2f" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">在插入资源时，我将填充有效载荷中的所有属性。在获取资源时，我会确保获取最大的资源。最初，我没有删除测试过程中创建的测试数据，除非它因为任何原因被破坏。</li></ul><p id="c77a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们的第一个请求是获取所有端点的身份验证令牌。然后存储响应中的令牌以备将来使用。如果我们因为任何原因没有成功，测试会因失败而中止。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated"><strong class="ak">获取要存储的身份验证令牌。</strong></figcaption></figure><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated"><strong class="ak">对我们终点的考验。</strong></figcaption></figure><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated"><strong class="ak">断言请求没有失败。</strong></figcaption></figure><p id="eaf5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">调用以下shell脚本来启动上述测试:</p><pre class="kp kq kr ks gt nl nm nn no aw np bi"><span id="8024" class="mb mc iq nm b gy nq nr l ns nt">ruby tests/generate-auth-token.rb<br/>sh tests/test.sh<br/>ruby verifier/check-failed-requests.rb</span></pre><h2 id="66d1" class="mb mc iq bd md me mf dn mg mh mi dp mj lo mk ml mm ls mn mo mp lw mq mr ms iw bi translated">运行频率:</h2><p id="550d" class="pw-post-body-paragraph lf lg iq lh b li mv ka lk ll mw kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">我们使用Github动作来运行测试。最终产品可供下载和分析90天。</p><p id="a77f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">最初，我们每天运行测试来观察我们的集成系统。后来，我们选择了每周运行，因为我们的迭代每周结束。这个想法是我们在每次迭代结束时分析我们的应用程序的行为。</p><h2 id="dca8" class="mb mc iq bd md me mf dn mg mh mi dp mj lo mk ml mm ls mn mo mp lw mq mr ms iw bi translated">该报告:</h2><p id="27fd" class="pw-post-body-paragraph lf lg iq lh b li mv ka lk ll mw kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated"><a class="ae le" href="https://www.tutorialspoint.com/apache_bench/apache_bench_quick_guide.htm" rel="noopener ugc nofollow" target="_blank"> AB报告</a>有几个关键要素有助于理解系统的性能:</p><ul class=""><li id="2161" class="mt mu iq lh b li lj ll lm lo nx ls ny lw nz ma na nb nc nd bi translated">连接时间的标准偏差。</li><li id="faad" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">平均每秒处理的请求数。</li><li id="db30" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">99%请求的解决时间。</li></ul><h2 id="d8f0" class="mb mc iq bd md me mf dn mg mh mi dp mj lo mk ml mm ls mn mo mp lw mq mr ms iw bi translated">我们拥有的优势:</h2><p id="cd1b" class="pw-post-body-paragraph lf lg iq lh b li mv ka lk ll mw kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">甚至在我们的报告出来之前，我们就开始想办法优化我们的冷启动时间。团队还启用了分布式跟踪(AWS X射线)。此外，我们遇到了一个问题(如下所述)。</p><p id="c348" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">经过几天的测试，我们发现了系统中的一个瓶颈。</p><p id="6353" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">为了读取特定的资源，一个端点会超时。</p><p id="7f1f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">为了在该资源内创建子资源，另一个端点将抛出内部服务器错误。</p><p id="0cd3" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在进一步调查后，我们意识到测试产生了非常大的数据(不删除测试数据有助于突出这种行为)。</p><p id="76f9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">解决这个问题的一个方法是调试并找出是哪部分代码造成了这个问题。另一种方法是了解业务。后者是一个更好的方法——我们同意子资源创建应该有一个5的限制。</p><p id="1e9e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这有助于我们使我们的系统变得健壮——甚至在我们上线之前——防止我们的端点被潜在误用和/或滥用。</p><p id="ff4b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">看到这一切，所有其他项目也开始努力测试他们的微服务的性能！</p><h2 id="7d6f" class="mb mc iq bd md me mf dn mg mh mi dp mj lo mk ml mm ls mn mo mp lw mq mr ms iw bi translated">所用工具背后的推理:</h2><p id="cca8" class="pw-post-body-paragraph lf lg iq lh b li mv ka lk ll mw kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">我们想要:</p><ul class=""><li id="c970" class="mt mu iq lh b li lj ll lm lo nx ls ny lw nz ma na nb nc nd bi translated">一个轻量级的开源工具。</li><li id="b1e1" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">整个过程几乎零成本。</li><li id="f0e7" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">很容易在团队中采用。团队应该能够在本地或任何其他环境中运行它。</li><li id="1e95" class="mt mu iq lh b li ne ll nf lo ng ls nh lw ni ma na nb nc nd bi translated">设置需要的投资可以忽略不计。</li></ul><p id="a3c6" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">对我们来说，Apache Bench和Ruby正符合要求。<br/>随着用例的发展，我们对将来迁移到不同工具的可能性持开放态度。</p><h2 id="d067" class="mb mc iq bd md me mf dn mg mh mi dp mj lo mk ml mm ls mn mo mp lw mq mr ms iw bi translated">未来计划:</h2><p id="3383" class="pw-post-body-paragraph lf lg iq lh b li mv ka lk ll mw kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">我计划对所有涉及的微服务使用不同的供应并发性(PC)来运行测试。这将有助于了解所需电脑的正确数量。</p><p id="bbce" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我的另一个目的是验证分配给lambda的2048内存是否足够。我们还使用了DynamoDB，所以我想验证5的读/写容量是否足够。</p><p id="86e4" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">希望这有助于您对所有微服务进行定期性能测试！</p></div></div>    
</body>
</html>