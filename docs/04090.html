<html>
<head>
<title>Serverless cloud API using AWS, Pulumi and .NET core</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS，Pulumi和。网络核心</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/serverless-cloud-api-using-aws-pulumi-and-net-core-83e2e55397b3?source=collection_archive---------33-----------------------#2020-06-08">https://levelup.gitconnected.com/serverless-cloud-api-using-aws-pulumi-and-net-core-83e2e55397b3?source=collection_archive---------33-----------------------#2020-06-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/aa1932fefd1929580c1674ba3dbbe2af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pcbCrvVH_NymggPp"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">由<a class="ae jd" href="https://unsplash.com/@kaushikpanchal?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Kaushik Panchal </a>在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><div class=""/><p id="bd21" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">设置API是提供服务所需的基本工具之一。如果你没有选择或者不想维护硬件，无服务器后端似乎是一个不错的选择，所有主要的云提供商都有自己的解决方案。</p><p id="9be9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">习惯在云中工作意味着学习一些新概念，比如如何为云提供商定义基础设施。大多数云提供商提供了通过YAML或JSON模板定义基础设施的选项，但这种解决方案有很多限制，例如缺乏自动完成功能和将代码分成单独组件的能力。基本上，在几乎所有的编程语言中，很多我们认为理所当然的东西。</p><p id="c9a1" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">理想的选择是用真正的编程语言定义您的代码，并能够以可复制的方式将其部署到云中。AWS一直在开发云开发工具包，它允许用多种编程语言编写基础设施(最终会翻译成JSON模板进行部署)。老实说，CDK确实工作得很好，但它当然仅限于AWS。</p><p id="df00" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在云不可知的类别中，我们找到了Pulumi。这是一个相当新的开源项目，旨在允许以Typescript、Python、Go和C#为许多云提供商编写云基础设施代码。这里的主要优势是能够与几个云提供商交互，而不是被一个提供商所束缚。我喜欢的另一个选择是构建一个混合云系统，将来自2个或更多云提供商的资源整合到一个系统中。除非你真的需要，否则不要这样做(事情可能会变得比必要的更复杂)，但是有这个选择是很好的。</p><p id="4cfa" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我将介绍如何使用API Gateway和Lambda在AWS中设置一个基本的API。我将使用Pulumi并使用C#编写lambda函数和云基础设施的代码，因为我喜欢C#的类型安全性，并且Pulumi最近在2.0版本中推出了对C#的支持。然而，用C#制作无服务器函数也稍微复杂一些，因为代码必须在部署前编译和打包。</p><p id="8ebd" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">先决条件:</p><ul class=""><li id="e45a" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><a class="ae jd" href="https://www.pulumi.com/docs/get-started/install/" rel="noopener ugc nofollow" target="_blank">普鲁米CLI </a></li><li id="27ac" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><a class="ae jd" href="https://dotnet.microsoft.com/download" rel="noopener ugc nofollow" target="_blank">。NET SDK </a></li><li id="7423" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">dotnet lambda工具(运行<code class="fe lp lq lr ls b">dotnet tool install -g Amazon.Lambda.Tools</code></li><li id="1b2e" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">AWS帐户</li><li id="f086" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">AWS CLI -配置了对帐户的访问权限</li></ul></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="1b55" class="ma mb jg bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">制作你的lambda代码</h1><p id="7a2f" class="pw-post-body-paragraph kd ke jg kf b kg my ki kj kk mz km kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">第一件事是启动你的C# lambda项目。对于这个例子，我们将只设置一个基本模板，这将足以进行演示。如果您还没有安装dotnet lambda模板，请运行<code class="fe lp lq lr ls b">dotnet new -i Amazon.Lambda.Templates</code>进行安装。之后，当运行<code class="fe lp lq lr ls b">dotnet new</code>时，模板应该是可见的。</p><p id="e28d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过运行<code class="fe lp lq lr ls b">dotnet new serverless.AspNetCoreWebAPI</code>启动你的项目。这将为您创建web API所需的各种文件。API将开箱即用，并且提供了几个示例控制器。如果您查看一下<em class="nd"> ValuesController.cs </em>文件，您会看到HTTP GET请求将返回一个字符串数组。我们稍后将使用它进行测试。</p><figure class="ne nf ng nh gt is"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">我们的控制器中用于测试的HTTP GET方法</figcaption></figure><h1 id="0d3c" class="ma mb jg bd mc md nk mf mg mh nl mj mk ml nm mn mo mp nn mr ms mt no mv mw mx bi translated">用于部署的包lambda</h1><p id="c972" class="pw-post-body-paragraph kd ke jg kf b kg my ki kj kk mz km kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">因为我们的lambda函数代码基本上已经准备好了，我们现在需要打包它。这意味着编译代码并把它收集到zip存档中，然后部署到云中的实际lambda上。幸运的是，使用dotnet lambda工具，这个过程非常简单(参见先决条件)。只需在包含您的。csproj文件。您应该会看到类似如下的输出:</p><figure class="ne nf ng nh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi np"><img src="../Images/e23ff8d648ce4c3dddf3940ce69ae444.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Id6w0z5-oBCnf3fRcu6fxg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">打包lambda代码的控制台输出</figcaption></figure><p id="5e02" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">记下zip存档的位置(输出的最后一行)。我们将需要它来定义Pulumi中的代码。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="baa5" class="ma mb jg bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">使用Pulumi将lambda函数定义为代码</h1><p id="d741" class="pw-post-body-paragraph kd ke jg kf b kg my ki kj kk mz km kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">现在我们已经有了lambda函数的部署包，我们应该使用Pulumi将云基础设施定义为代码。通过运行<code class="fe lp lq lr ls b">pulumi new aws-csharp</code>在Pulumi中创建一个新的C#项目，并遵循CLI的指示(给出项目名称、描述、堆栈名称并选择AWS区域)。通过运行<code class="fe lp lq lr ls b">dotnet add package Pulumi.Aws</code>为AWS安装Pulumi nuget包。</p><p id="67b7" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看看MyStack.cs，你现在已经有了一个基本的AWS云基础设施，其中只包括一个S3桶。您可以删除bucket和使用bucket的输出，因为在这个例子中我们不需要它。现在我们应该开始定义我们的lambda，为此我们需要两样东西:角色(定义lambda的权限)和lambda函数本身。让我们首先创建角色。</p><p id="e93d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个角色本身是非常基本的。它所做的只是说lambda函数被允许承担这个角色。不需要进一步的策略，因为lambda函数不需要访问任何其他资源。</p><figure class="ne nf ng nh gt is"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">基本IAM角色，可由AWS Lambda承担</figcaption></figure><p id="a4e0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来是lambda函数本身。这里还有更多的内容，让我们来看一下。lambda函数被定义为一个“函数”类对象，位于<em class="nd"> Pulumi下。Aws.Lambda </em>命名空间。正确设置lambda需要几个属性:</p><ol class=""><li id="d4b2" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la nq lh li lj bi translated">运行时:定义运行时，因为我们使用的是dotnet core 3.1，所以将它作为值提供，尽管如果您想尝试，dotnetcore 2.1也是可用的。</li><li id="8040" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la nq lh li lj bi translated">handler:assembly::TYPE::METHOD格式的处理程序路径。更多信息<a class="ae jd" href="https://docs.aws.amazon.com/lambda/latest/dg/csharp-handler.html" rel="noopener ugc nofollow" target="_blank">这里</a>。</li><li id="d1a2" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la nq lh li lj bi translated">超时:以秒为单位。默认值是3秒，这对于C# lambda的冷启动(第一次启动lambda)来说是不够的。所以<strong class="kf jh"> <em class="nd">真的</em> </strong>增加一点这个限制很重要。否则你的lambda函数总是会超时。</li><li id="2e31" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la nq lh li lj bi translated">代码:要部署的代码。所以这里我们提供了一个FileArchive类，指向我们之前制作的部署包。在此提供您自己的部署包的路径。</li><li id="043d" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la nq lh li lj bi translated">角色:我们刚刚在上面定义的角色的ARN。</li></ol><figure class="ne nf ng nh gt is"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">制作lambda函数的Pulumi代码</figcaption></figure><p id="ac66" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们已经定义了lambda函数，让我们试着部署它来验证一切正常。导航到Pulumi项目的目录并运行<code class="fe lp lq lr ls b">pulumi up</code>。您应该会在终端中看到类似如下的输出:</p><figure class="ne nf ng nh gt is gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/aa2453fc9f3177d72f9595ccb83b67e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*n-tQeAjCji-LmxnHxqXrjQ.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">部署我们的lambda的输出</figcaption></figure><p id="f304" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您导航到AWS控制台，lambda现在应该也在那里。但是一个无法触发的lambda有什么用呢？接下来，我们将通过一个API来访问它！</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="7468" class="ma mb jg bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">定义代理API</h1><p id="0f1c" class="pw-post-body-paragraph kd ke jg kf b kg my ki kj kk mz km kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">我们将在API Gateway中设置我们的API，作为一个简单的代理API，它将把所有流量转发给我们之前的lambda函数。API Gateway实际上有许多组件需要设置来完成这个单一的目标，这在您第一次设置它时会非常麻烦。AWS CDK已经有一个资源可以轻松地设置所有这些(称为LambdaRestApi)，但不幸的是Pulumi没有这个(还没有)。幸运的是，Pulumi使得在未来的项目中设置和重用API代码变得很容易，所以让我们致力于将API资源与项目的其余部分分开。</p><p id="5847" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Pulumi项目中创建一个名为ProxyApi.cs的新文件。在这个文件中，我们需要设置几个云资源:</p><ul class=""><li id="a31f" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">API:整个REST Api</li><li id="d6a6" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">资源:API内部的特定资源。我们将使其成为代理资源，这意味着所有路由都将被转发。</li><li id="6cb6" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">方法:HTTP方法以及是否使用API密钥/授权来保护它</li><li id="0e15" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">集成:API和lambda函数之间的集成，指定如何为传入的请求调用lambda</li><li id="7181" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">部署:在API可访问之前，需要使用部署资源对其进行部署</li><li id="5941" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">阶段:API将被部署到部署资源中的特定阶段</li><li id="613b" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">权限:定义lambda允许从API执行</li></ul><p id="f630" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仅仅为了支持调用lambda函数，这可能看起来有点复杂，但是请记住，API Gateway要复杂得多，并且支持许多用例，这在本例中是不需要的。好的方面是，一旦我们使用Pulumi代码定义了API，我们就可以在将来自由地重用它，而不必担心API的内部资源。</p><figure class="ne nf ng nh gt is"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">定义代理API的自定义对象</figcaption></figure><p id="0f7d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，这是相当多的代码，我认为如果我一行一行地看，它会变得太详细。但是请注意，我已经为我的<em class="nd">部署</em>资源添加了一个“DependsOn”到<em class="nd">资源</em>、<em class="nd">方法</em>和<em class="nd">集成</em>，因为它们需要先被创建，而Pulumi并没有自己弄清楚。集成也是如此，如果没有首先创建方法，集成偶尔会失败。</p><p id="16f0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我还使用了<code class="fe lp lq lr ls b">Output.format</code>方法为lambda权限格式化来自不同Pulumi资源的输出，这是必需的，因为Pulumi需要在属性可用之前创建这些资源(在Pulumi <a class="ae jd" href="https://www.pulumi.com/docs/intro/concepts/programming-model/#outputs" rel="noopener ugc nofollow" target="_blank">中阅读更多关于输入和输出的信息，请点击</a>)。</p><p id="8888" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从我们的主堆栈中，我们现在可以通过调用<code class="fe lp lq lr ls b">var api = new ProxyApi(apiLambda);</code>来创建一个指向lambda函数的完整代理API。我还为API url添加了一个堆栈输出(由AWS自动生成)，这样一旦部署了API，我们就可以轻松地对其进行测试。再次运行<code class="fe lp lq lr ls b">pulumi up</code>来部署所有的新资源。</p><figure class="ne nf ng nh gt is gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/34e6133c6acccbb801c0dd5220e02d27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*8CxZPSqre2ZBsLocwtRjtg.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">部署API的控制台输出</figcaption></figure><p id="643b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们通过在url上使用<a class="ae jd" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>来确认API正在工作。请记住，API的完整路径由Pulumi堆栈输出的API url和控制器中定义的路由组成。</p><figure class="ne nf ng nh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nt"><img src="../Images/a15b04fa65285df80b7893666ed549b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ICqKTquhpYBKRrXIcYQHxg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">邮递员中的测试结果</figcaption></figure><p id="0e24" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在有了一个通向lambda的洞，我们可以开始向API lambda控制器添加实际的应用程序逻辑了。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="8805" class="ma mb jg bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">舍入</h1><p id="7c83" class="pw-post-body-paragraph kd ke jg kf b kg my ki kj kk mz km kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">我们现在已经看到了使用Pulumi建立一个基本的无服务器API和定义基础设施代码是多么简单。这种API的设置和开发速度很快。如果你的应用程序有很大的流量，它将能够很容易地伸缩。对于较小的个人项目，这也可以是为您的项目运行云API的完全免费的方式，而不必担心基础设施，这要感谢<a class="ae jd" href="https://aws.amazon.com/free" rel="noopener ugc nofollow" target="_blank"> AWS免费层</a>。</p><p id="7daa" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将您的基础设施设置为代码确保了可重复的部署，这对于设置集成测试的CI/CD管道来说是非常棒的(我将在后面的帖子中对此进行更深入的讨论)。</p><p id="be56" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">希望这对你有用。查看<a class="ae jd" href="https://github.com/Mikkel-Gram/pulumi-aws-serverlessapiexample" rel="noopener ugc nofollow" target="_blank"> Github repo </a>获取示例代码。</p></div></div>    
</body>
</html>