<html>
<head>
<title>Deploying an Asynchronous FastAPI on NGINX Unit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在NGINX单元上部署异步FastAPI</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploying-an-asynchronous-fastapi-on-nginx-unit-b038288bec5?source=collection_archive---------1-----------------------#2021-03-08">https://levelup.gitconnected.com/deploying-an-asynchronous-fastapi-on-nginx-unit-b038288bec5?source=collection_archive---------1-----------------------#2021-03-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1d89344ae1cc287e9d76d71442aaa994.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2WgYe2hF-6ssnACKM6o0bA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">NGINX单元上的FastAPI</figcaption></figure><p id="131b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">FastAPI是一个现代、快速(高性能)的web框架，用于在python中构建API，这是一个快速编码、异步、可用于生产的框架。一般来说，FastAPI是使用uvicorn部署的，uvicorn是一种速度极快的ASGI服务器实现。</p><p id="b6ba" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">另一种部署方式是使用NGINX Unit，这是一种轻量级的开源应用服务器，专为当今的动态和分布式应用而设计。</p><p id="9cea" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">什么是NGINX单元？</strong></p><figure class="la lb lc ld gt jr"><div class="bz fp l di"><div class="le lf l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae lg" href="https://www.nginx.com/products/nginx-unit/" rel="noopener ugc nofollow" target="_blank"> NGINX单元</a></figcaption></figure><p id="b1ac" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">为什么我们应该选择NGINX单元？</strong></p><p id="b547" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">传统的部署方法使用反向代理服务器后面的web服务器，因此增加了路由过程。Nginx单元是一个应用服务器，可以直接将HTTP请求翻译成应用程序使用的协议，就像ASGI for FastAPI (python)一样。此外，配置服务器也很容易，只需使用config.json就可以在服务器上进行更改，而无需重新加载服务器。</p></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><p id="76f2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在本教程中，我们将在python上部署一个简单的<strong class="ke ir"> Hello World API </strong>。在此之前，我们需要安装Nginx单元。官方网站有很好的关于安装的文档。下面是<a class="ae lg" href="https://unit.nginx.org/installation/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir">安装</strong> </a>的链接。或者，您也可以安装<a class="ae lg" href="https://hub.docker.com/r/nginx/unit" rel="noopener ugc nofollow" target="_blank"> docker </a>。</p><p id="c70c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用下面的代码在项目目录中创建<code class="fe lo lp lq lr b"><strong class="ke ir">asgi.py</strong></code>文件。</p><figure class="la lb lc ld gt jr"><div class="bz fp l di"><div class="ls lf l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">FastAPI上的hello world应用程序</figcaption></figure><p id="0fb6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于NGINX单元需要一个JSON配置文件，让我们为我们的应用程序创建一个。</p><blockquote class="lt lu lv"><p id="9058" class="kc kd lw ke b kf kg kh ki kj kk kl km lx ko kp kq ly ks kt ku lz kw kx ky kz ij bi translated">下面的配置文件是为运行在docker中的nginx单元创建的，如果直接从终端运行服务器，路径可能会有所不同。</p></blockquote><figure class="la lb lc ld gt jr"><div class="bz fp l di"><div class="ls lf l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">易于配置</figcaption></figure><p id="a353" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> Listeners </strong>:用于设置接受传入请求的主机/端口。在这里，我们设置了侦听器来接受端口80 (HTTP端口)上的传入请求，并将其直接传递给应用程序。</p><p id="ac23" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">应用程序</strong>:包含关于应用程序的信息。</p><ol class=""><li id="539c" class="ma mb iq ke b kf kg kj kk kn mc kr md kv me kz mf mg mh mi bi translated"><strong class="ke ir">类型</strong>——应用类型ex python、php等。</li><li id="4bc0" class="ma mb iq ke b kf mj kj mk kn ml kr mm kv mn kz mf mg mh mi bi translated"><strong class="ke ir">路径</strong> -项目目录的路径。</li><li id="8ac5" class="ma mb iq ke b kf mj kj mk kn ml kr mm kv mn kz mf mg mh mi bi translated"><strong class="ke ir">home</strong>-python解释器的位置，包含python解释器的<code class="fe lo lp lq lr b">bin</code>文件夹的绝对路径。</li><li id="a4ed" class="ma mb iq ke b kf mj kj mk kn ml kr mm kv mn kz mf mg mh mi bi translated"><strong class="ke ir">模块</strong>——在我们的例子中要调用的文件的名称<code class="fe lo lp lq lr b">asgi.py</code>。</li><li id="c846" class="ma mb iq ke b kf mj kj mk kn ml kr mm kv mn kz mf mg mh mi bi translated"><strong class="ke ir">可调用</strong> -初始化FastAPI对象的变量名。</li></ol><blockquote class="lt lu lv"><p id="6f2f" class="kc kd lw ke b kf kg kh ki kj kk kl km lx ko kp kq ly ks kt ku lz kw kx ky kz ij bi translated"><strong class="ke ir">确保您设置了正确的路径，否则服务器不会启动。</strong></p></blockquote><p id="c3af" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最后，运行服务器。</p><p id="e62b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">对于终端</strong>:用<code class="fe lo lp lq lr b"><strong class="ke ir">unitd</strong></code>命令启动服务器，然后用下面的命令推送config.json。</p><pre class="la lb lc ld gt mo lr mp mq aw mr bi"><span id="b0bf" class="ms mt iq lr b gy mu mv l mw mx">sudo curl -X PUT --data-binary @config.json --unix-socket \        /path/to/control.unit.sock http://localhost/config/</span></pre><blockquote class="lt lu lv"><p id="0e98" class="kc kd lw ke b kf kg kh ki kj kk kl km lx ko kp kq ly ks kt ku lz kw kx ky kz ij bi translated">套接字路径可能会有所不同，请使用virtualenv来避免冲突和依赖性问题。</p></blockquote><p id="790c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">对于Docker </strong>:我的首选方式。</p><figure class="la lb lc ld gt jr"><div class="bz fp l di"><div class="ls lf l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Dockerfile文件</figcaption></figure><p id="ffa8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">之后，只需构建容器并运行，就这样。</p><p id="2960" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">打造</strong></p><pre class="la lb lc ld gt mo lr mp mq aw mr bi"><span id="e555" class="ms mt iq lr b gy mu mv l mw mx">docker build -t nginx-unit-fastapi .</span></pre><p id="0dba" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">运行</strong></p><pre class="la lb lc ld gt mo lr mp mq aw mr bi"><span id="0a5b" class="ms mt iq lr b gy mu mv l mw mx">docker run -p 80:80 nginx-unit-fastapi</span></pre><p id="4adb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果服务器已经成功启动，您应该能够看到以下输出。</p><figure class="la lb lc ld gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/2b6e7b113f62af847e2d9dbcf6d0f7e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*01ORtyZMfT_g2NaC8aaYiA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">使用ASGI在Nginx单元上运行FastAPI</figcaption></figure><p id="2e95" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以通过调用API来检查输出。</p><pre class="la lb lc ld gt mo lr mp mq aw mr bi"><span id="6af3" class="ms mt iq lr b gy mu mv l mw mx">curl http://localhost/</span></pre><h1 id="b56d" class="mz mt iq bd na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv bi translated">代码库</h1><div class="nw nx gp gr ny nz"><a href="https://github.com/novasush/fastapi-nginx-unit" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd ir gy z fp oe fr fs of fu fw ip bi translated">novasush/fastapi-nginx-unit</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">在NGINX单元上部署异步FastAPI。</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">github.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on jw nz"/></div></div></a></div><h2 id="cfc8" class="ms mt iq bd na oo op dn ne oq or dp ni kn os ot nm kr ou ov nq kv ow ox nu oy bi translated">参考</h2><p id="4a5c" class="pw-post-body-paragraph kc kd iq ke b kf oz kh ki kj pa kl km kn pb kp kq kr pc kt ku kv pd kx ky kz ij bi translated">[1]<a class="ae lg" href="https://fastapi.tiangolo.com/tutorial/first-steps/" rel="noopener ugc nofollow" target="_blank">https://fastapi.tiangolo.com/tutorial/first-steps/</a></p><p id="1c72" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">[2]<a class="ae lg" href="https://unit.nginx.org/howto/fastapi/" rel="noopener ugc nofollow" target="_blank">https://unit.nginx.org/howto/fastapi/</a></p><p id="add1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">就是这样，我们只是通过ASGI在Nginx单元上部署了一个异步FastAPI，并且它非常容易配置。</p></div></div>    
</body>
</html>