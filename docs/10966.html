<html>
<head>
<title>Writing Clean and Consistent Code with Static Analysis using PMD and Apex</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用PMD和Apex通过静态分析编写干净一致的代码</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/writing-clean-and-consistent-code-with-static-analysis-using-pmd-and-apex-9c18863a9f68?source=collection_archive---------17-----------------------#2022-01-31">https://levelup.gitconnected.com/writing-clean-and-consistent-code-with-static-analysis-using-pmd-and-apex-9c18863a9f68?source=collection_archive---------17-----------------------#2022-01-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="66f3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">开发好的、可维护的软件的关键要求之一是确保它能在各种条件下工作。这通常是通过对应用程序可能采用的各种特性和代码路径进行一系列自动化测试来实现的。虽然单元测试对于确保您的应用程序在技术上运行是非常好的，但是还有另一类验证可以确保您的应用程序没有其他可检测的问题:静态分析。</p><p id="2eb6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">静态分析是一种不需要执行就能分析你的代码<em class="ko">的方法。如果你曾经使用过像Kotlin这样的编译语言，编译器通过确保你的程序符合语言的语法规则来实现一种形式的静态分析。例如，如果您调用了一个函数，但忘记了传入必需的参数，静态分析器会在您编译应用程序之前提醒您出现此错误。这与解释型语言(如JavaScript)形成对比，在解释型语言中，错误会在执行代码时发生，因为没有编译器来预测问题。</em></p><p id="39ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(准确地说，静态分析器<em class="ko">可以</em>应用于解释语言，如JavaScript、Ruby或Python，确保代码格式良好，没有逻辑缺失。)</p><h1 id="5e66" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">静态分析的好处</h1><p id="4293" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">虽然一个写得很好的测试套件可能会覆盖这样的代码路径，但是静态分析可以做得更多。静态分析器可以减少出现错误的可能性，比如当您意外地用另一个值覆盖了一个变量时。它还可以实现林挺和格式规则，这使得您的代码库一致且更容易审查。一些静态分析器甚至通过建议重写循环或其他函数调用的方式来带来性能优势。</p><p id="1083" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">几乎每种编程语言都有自己的静态分析器。例如，golang有<a class="ae ls" href="https://pkg.go.dev/cmd/gofmt" rel="noopener ugc nofollow" target="_blank"> gofmt </a>，它被烘焙到标准工具中，而Ruby有<a class="ae ls" href="https://rubocop.org/" rel="noopener ugc nofollow" target="_blank"> Rubocop </a>，这是一个社区主导的项目。甚至像C这样的编译语言也通过<a class="ae ls" href="http://astyle.sourceforge.net/astyle.html" rel="noopener ugc nofollow" target="_blank">as style</a>拥有自己的静态分析器。然而，在多语言项目中运行几个分析器是很困难的(也是乏味的)。幸运的是，这正是像PMD这样的项目能有所帮助的地方。PMD是一个静态分析器，它允许你定义一套可以应用于多种语言的标准规则。</p><p id="9616" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇文章中，我们将仔细研究PMD，并学习如何在Apex代码上运行它。我们的Apex项目将有几个PMD可以报告和采取行动的问题。我们还将把PMD集成到您的编辑器以及您的CI环境中，以确保如果静态分析检测到任何问题，您的构建将会失败。</p><h1 id="7ded" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">先决条件</h1><p id="34b2" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">在开始之前，您应该对<a class="ae ls" href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_intro_what_is_apex.htm#!" rel="noopener ugc nofollow" target="_blank"> Apex </a>有所了解，这是Salesforce的编程语言，为您的组织开启了新的可能性。我们将使用<a class="ae ls" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> VS代码</a>以及<a class="ae ls" href="https://marketplace.visualstudio.com/items?itemName=salesforce.salesforcedx-vscode" rel="noopener ugc nofollow" target="_blank">Apex插件</a>。您还需要<a class="ae ls" href="https://developer.salesforce.com/tools/sfdxcli" rel="noopener ugc nofollow" target="_blank"> Salesforce CLI </a>，这是一款由Salesforce设计的工具，用于简化与平台的交互。</p><p id="12bf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，继续按照PMD 的<a class="ae ls" href="https://pmd.github.io/pmd-6.40.0/pmd_userdocs_installation.html#how-to-install-pmd-and-cpd" rel="noopener ugc nofollow" target="_blank">安装说明进行操作。</a></p><p id="e44e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，在这个Git存储库中克隆我们的示例Apex项目:<a class="ae ls" href="https://github.com/gjtorikian/sfdc-linting.git" rel="noopener ugc nofollow" target="_blank">https://github.com/gjtorikian/sfdc-linting.git</a></p><p id="820c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个库是<a class="ae ls" href="https://github.com/trailheadapps/dreamhouse-lwc" rel="noopener ugc nofollow" target="_blank"> dreamhouse-lwc项目</a>的分叉副本，除了它已经(有意地)引入了一些错误。我们将用它来演示PMD是如何工作的。</p><h1 id="1acf" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">整合PMD</h1><p id="1c70" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">首先，<a class="ae ls" href="https://developer.salesforce.com/docs/atlas.en-us.sfdx_dev.meta/sfdx_dev/sfdx_setup_enable_devhub.htm" rel="noopener ugc nofollow" target="_blank">为您的Salesforce组织启用开发中心</a>。如果您没有Salesforce实例，不用担心。您可以<a class="ae ls" href="https://developer.salesforce.com/docs/atlas.en-us.sfdx_dev.meta/sfdx_dev/sfdx_dev_scratch_orgs_create.htm" rel="noopener ugc nofollow" target="_blank">创建一个临时组织</a>，它类似于一个临时的Salesforce组织。您可以使用scratch org来测试在Salesforce平台上开发是什么样子的。</p><p id="201d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">无论您使用的是临时组织还是您自己的组织，您都需要通过登录将sfdx与该组织相关联。为此，请运行以下命令:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="c874" class="mc kq it ly b gy md me l mf mg">sfdx auth:web:login</span></pre><p id="f99b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将打开一个新的浏览器窗口，要求您提供Salesforce凭据。完成后，Salesforce CLI将在身份验证完成时通知您。</p><p id="5c3f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们看看当我们试图将克隆的项目上传到我们的组织时会发生什么。导航到您克隆了<code class="fe mh mi mj ly b">dreamhouse-sfdx</code>项目的目录，并运行以下命令:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="db62" class="mc kq it ly b gy md me l mf mg">sfdx force:source:push -u &lt;admin_email_address&gt;</span></pre><p id="c095" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您应该会看到以下输出:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="1747" class="mc kq it ly b gy md me l mf mg">*** Deploying with SOAP ***<br/>Job ID | 0AfR000001XgjR1KAJ<br/>SOURCE PROGRESS | ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ | 0/2 Components<br/>TYPE   PROJECT PATH                                      PROBLEM<br/>─────  ────────────────────────────────────────────────  ──────────────────────────────────────────────<br/>Error  force-app/main/default/classes/PagedResult.cls  Unexpected token '}'. (12:40)<br/>Error  force-app/main/default/classes/PagedResult.cls  Unexpected token 'set'. (6:37)<br/>ERROR running force:source:push:  Push failed.</span></pre><p id="16a9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">啊哦！看起来这个文件中有几个问题，都是由于缺少分号引起的。(这是如何通过代码审查的？)</p><p id="a6ac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在VS代码中打开<code class="fe mh mi mj ly b">force-app/main/default/classes/PagedResult.cls</code>，在第6行和第12行的语句末尾添加一个分号。这应该能解决问题，对吧？</p><p id="db13" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">嗯……也许不是。虽然我们的代码可以编译并且没有构建错误，但是我们的项目可能有一些我们不知道的其他问题。在命令行上，键入以下命令:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="50f0" class="mc kq it ly b gy md me l mf mg">pmd -d . -R config/ruleset.xml</span></pre><p id="d2bc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里，我们在当前目录(<code class="fe mh mi mj ly b">-d .</code>)上运行PMD，并应用位于<code class="fe mh mi mj ly b">config/ruleset.xml</code>的规则集。当您执行这个命令时，您会看到几十行如下所示:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="4446" class="mc kq it ly b gy md me l mf mg">main/default/classes/PostPriceChangeToSlackTest.cls:11: DebugsShouldUseLoggingLevel:    Calls to System.debug should specify a logging level.<br/>main/default/classes/PropertyController.cls:1:  AvoidGlobalModifier:    Avoid using global modifier<br/>main/default/classes/SampleDataController.cls:20:   UnusedLocalVariable:    Variable 'brokersJSON' defined but not used</span></pre><p id="0f10" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这就是PMD的力量。根据我们的规则集，PMD确定了我们项目中的几个问题:</p><ul class=""><li id="3ed1" class="mk ml it js b jt ju jx jy kb mm kf mn kj mo kn mp mq mr ms bi translated">我们遗漏了日志严重性级别。</li><li id="a498" class="mk ml it js b jt mt jx mu kb mv kf mw kj mx kn mp mq mr ms bi translated">我们使用了全局修改器，这可能会产生不必要的副作用。</li><li id="12bb" class="mk ml it js b jt mt jx mu kb mv kf mw kj mx kn mp mq mr ms bi translated">我们正在创建未使用的局部变量，这是对内存和时间的浪费。</li></ul><p id="ca56" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">打开<code class="fe mh mi mj ly b">config/ruleset.xml</code>文件，您会发现一个列出了几个<code class="fe mh mi mj ly b">rules</code>的XML文档。这些规则对应于PMD将报告的问题。信不信由你，Apex规则有<em class="ko">上百</em>，你可以在<a class="ae ls" href="https://github.com/pmd/pmd/blob/eb1f30cd660e02bed7079d26b30fb76ca6ed6026/pmd-apex/src/main/resources/rulesets/apex/quickstart.xml" rel="noopener ugc nofollow" target="_blank"> PMD回购</a>找到全套。您可以完全控制要启用的规则。通常情况下，你会通过与队友就最重要的问题达成一致来确定哪些是重要的。毕竟，他们的代码也会被静态分析！</p><h1 id="ce5b" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">在VS代码中集成PMD</h1><p id="2113" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">切换到命令行来静态分析您的代码可能会变得有点乏味，如果不会彻底中断您的工作流的话。因为静态分析查看代码的结构而不编译它，所以你可以将像PMD这样的工具直接集成到你的编辑器中。这意味着您可以在编写代码时获得反馈。</p><p id="d4b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">幸运的是，有几个插件允许你将PMD集成到VS代码中。让我们安装一个，看看这个过程是什么样子的。访问VS代码市场上的<a class="ae ls" href="https://marketplace.visualstudio.com/items?itemName=chuckjonas.apex-pmd" rel="noopener ugc nofollow" target="_blank"> Apex PMD扩展主页</a>并点击<strong class="js iu">安装</strong>。这会下载插件并将其安装到您的编辑器中——但是我们还没有完成。</p><p id="33b8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Apex PMD扩展有自己的规则集，虽然方便，但可能与您为项目建立的规则不同。我们需要配置该工具来指向我们预先确定的规则集。</p><p id="791e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">打开VS代码设置页面(可以在菜单栏中的<strong class="js iu">代码&gt;首选项&gt;设置</strong>下找到)，键入<code class="fe mh mi mj ly b">pmd</code>将设置过滤到该扩展名。然后，在<strong class="js iu"> Rulesets </strong>部分，设置我们在这个项目中创建的<code class="fe mh mi mj ly b">ruleset.xml</code>文件的路径。</p><figure class="lt lu lv lw gt mz gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi my"><img src="../Images/958d445f4ef97a518a5255e0ba3374cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VejCNPOv_Qr015M2.png"/></div></div></figure><p id="0546" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，导航到项目中的任何<code class="fe mh mi mj ly b">.cls</code>文件。你会看到不同的曲线表明PMD发现的问题。将鼠标悬停在这些行上还会出现一个对话框，指示问题是什么，以及哪个规则触发了它。</p><figure class="lt lu lv lw gt mz gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi my"><img src="../Images/0a270e8038d418e9e3cc0fe2a7ae84d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jJqhHuL2UkMOClYT.png"/></div></div></figure><h1 id="20f7" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">将PMD融入CI</h1><p id="94f1" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">让PMD在编写代码的同时运行，是在问题进入生产之前捕捉到它们的一个很好的步骤。然而，最好的方法是将PMD分析作为CI/CD管道中测试套件的一部分。</p><p id="3bd9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一步是在您的CI服务器上安装PMD。你可以通过抓取程序的容器化版本来实现，或者通过下载wget的包并解压。</p><p id="c3db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你正在使用GitHub Actions，你可以集成<a class="ae ls" href="https://github.com/rody/pmd-github-action" rel="noopener ugc nofollow" target="_blank">一个像这样的动作</a>，它会为你完成所有的安装和配置。如果不是，您只需像在CLI上一样，在脚本中运行PMD即可:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="df48" class="mc kq it ly b gy md me l mf mg">#!/bin/sh</span><span id="7217" class="mc kq it ly b gy ng me l mf mg">set -e</span><span id="d10f" class="mc kq it ly b gy ng me l mf mg">pmd -d . -R config/ruleset.xml</span></pre><p id="36ac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于PMD以非零状态失败，如果有任何问题，运行此脚本也会将您的配置项标记为失败。</p><h1 id="d1fa" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">结论</h1><p id="55f9" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">静态分析不仅有助于保持代码的一致性和整洁，还可以通过指出可能导致更大问题的小的不一致来提高效率。它应该是你工具箱里的一个重要工具。此外，通过将静态分析与您的CI测试相集成，您可以放心，一旦您的代码被修复，它将保持不变。</p><p id="67f5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了了解如何编写更好的Apex代码，Salesforce提供了一些带有一些高级主题的<a class="ae ls" href="https://trailhead.salesforce.com/en/content/learn/modules/asynchronous_apex" rel="noopener ugc nofollow" target="_blank"> Trailhead徽章</a>。<a class="ae ls" href="https://pmd.github.io/latest/pmd_rules_apex.html" rel="noopener ugc nofollow" target="_blank">PMD文档</a>还详细介绍了您可以使用的所有Apex规则。Salesforce还有<a class="ae ls" href="https://marketplace.visualstudio.com/items?itemName=salesforce.salesforcedx-vscode" rel="noopener ugc nofollow" target="_blank">一整套工具</a>，可以作为插件安装，让编写代码变得更加容易！</p></div></div>    
</body>
</html>