<html>
<head>
<title>Transforming remote JSON into Prometheus metrics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将远程JSON转换为普罗米修斯指标</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/transforming-remote-json-into-prometheus-metrics-334d772df38a?source=collection_archive---------0-----------------------#2022-02-24">https://levelup.gitconnected.com/transforming-remote-json-into-prometheus-metrics-334d772df38a?source=collection_archive---------0-----------------------#2022-02-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/434d4b9c986b14059325639a3862efb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HrBvLDs9JRhAgQObiR0XNA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图片由Hayk Davtyan(作者)提供</figcaption></figure><h2 id="1281" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">引言。</h2><p id="b7ec" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">有没有想过把JSON对象变成普罗米修斯格式的度量？这一点可以通过<a class="ae lt" href="https://github.com/prometheus-community/json_exporter#json_exporter" rel="noopener ugc nofollow" target="_blank"> prometheus-json-exporter来实现。</a>通过<a class="ae lt" href="https://kubernetes.io/docs/reference/kubectl/jsonpath/" rel="noopener ugc nofollow" target="_blank"> JSONPath </a>抓取远程JSON。</p><h2 id="deb4" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">关于这个教程。</h2><p id="f408" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">在本教程中，我们将学习如何为公共json端点部署和配置json_exporter，并在Prometheus中使用它。我们将使用的部署方法是<a class="ae lt" href="https://docs.docker.com/compose/" rel="noopener ugc nofollow" target="_blank"> Docker compose </a>，尽管它也可以在Kubernetes环境中完成。</p><p id="faa6" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">作为JSON端点，我们将使用由<a class="ae lt" href="https://coinstats.app/" rel="noopener ugc nofollow" target="_blank"> CoinStats </a>提供的公共API。正如你已经猜到的，这将是关于加密货币。很酷，是吗？这意味着我们将把cryptos的实时信息转化为基于Prometheus的指标，这将允许存储历史数据。让我们建造它！</p><h2 id="919e" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated"><strong class="ak">为本教程创建工作目录和配置文件。</strong></h2><p id="833f" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">我将为这个项目使用<code class="fe lz ma mb mc b">/tmp</code>目录，请使用另一个目录以避免在重启系统的情况下丢失文件。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="f635" class="kc kd iq mc b gy ml mm l mn mo">$ mkdir -p /tmp/json_exporter_tutorial/examples</span></pre><p id="1eb5" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">在为服务创建rest配置文件之前，让我们看看单个JSON对象是怎样的:<a class="ae lt" href="https://api.coinstats.app/public/v1/coins" rel="noopener ugc nofollow" target="_blank"><em class="mp">api.coinstats.app/public/v1/coins</em></a>API。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="36d4" class="kc kd iq mc b gy ml mm l mn mo">{<br/>  "coins": [<br/>    {<br/>      "id": "bitcoin",<br/>      "icon": "<a class="ae lt" href="https://static.coinstats.app/coins/Bitcoin6l39t.png" rel="noopener ugc nofollow" target="_blank">https://static.coinstats.app/coins/Bitcoin6l39t.png</a>",<br/>      "name": "Bitcoin",<br/>      "symbol": "BTC",<br/>      "rank": 1,<br/>      "price": 40224.98822527244,<br/>      "priceBtc": 1,<br/>      "volume": 396892467427897.7,<br/>      "marketCap": 762621770614.047,<br/>      "availableSupply": 18958906,<br/>      "totalSupply": 21000000,<br/>      "priceChange1h": 0.58,<br/>      "priceChange1d": 0,<br/>      "priceChange1w": -4.52,<br/>      "websiteUrl": "<a class="ae lt" href="http://www.bitcoin.org" rel="noopener ugc nofollow" target="_blank">http://www.bitcoin.org</a>",<br/>      "twitterUrl": "<a class="ae lt" href="https://twitter.com/bitcoin" rel="noopener ugc nofollow" target="_blank">https://twitter.com/bitcoin</a>",<br/>      "exp": [<br/>        "<a class="ae lt" href="https://blockchair.com/bitcoin/" rel="noopener ugc nofollow" target="_blank">https://blockchair.com/bitcoin/</a>",<br/>        "<a class="ae lt" href="https://btc.com/" rel="noopener ugc nofollow" target="_blank">https://btc.com/</a>",<br/>        "<a class="ae lt" href="https://btc.tokenview.com/" rel="noopener ugc nofollow" target="_blank">https://btc.tokenview.com/</a>"<br/>      ]<br/>    }<br/>  ]<br/>}</span></pre><p id="c9c5" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">因为我们已经知道了JSON对象的结构，所以我们可以告诉exporter它应该如何解析整个对象并将它们转换成Prometheus时间序列。</p><p id="c5f5" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">定义指标名称和标签。</p><p id="478e" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">根据JSON对象的不同，每个时间序列中存在的强制标签有:<code class="fe lz ma mb mc b">id</code>、<code class="fe lz ma mb mc b">name</code>和<code class="fe lz ma mb mc b">symbol</code>。这些度量将表示以下关键字的相应值:<code class="fe lz ma mb mc b">rank, price, priceBtc, volume, marketCap, availableSupply, totalSupply, priceChange[1h,1d,1w]</code>。</p><p id="87f2" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">因此，我们要创建的指标名称将是:</p><ul class=""><li id="d367" class="mq mr iq la b lb lu lf lv kl ms kp mt kt mu ls mv mw mx my bi translated">加密货币_排名</li><li id="b604" class="mq mr iq la b lb mz lf na kl nb kp nc kt nd ls mv mw mx my bi translated">加密货币_价格</li><li id="b703" class="mq mr iq la b lb mz lf na kl nb kp nc kt nd ls mv mw mx my bi translated">加密货币_价格_as_btc</li><li id="0862" class="mq mr iq la b lb mz lf na kl nb kp nc kt nd ls mv mw mx my bi translated">加密货币_卷</li><li id="da31" class="mq mr iq la b lb mz lf na kl nb kp nc kt nd ls mv mw mx my bi translated">加密货币_市场_资本</li><li id="0866" class="mq mr iq la b lb mz lf na kl nb kp nc kt nd ls mv mw mx my bi translated">加密货币_可用_供应</li><li id="e850" class="mq mr iq la b lb mz lf na kl nb kp nc kt nd ls mv mw mx my bi translated">加密货币_合计_供应</li><li id="f4e5" class="mq mr iq la b lb mz lf na kl nb kp nc kt nd ls mv mw mx my bi translated">加密货币_价格_变化1h</li><li id="6168" class="mq mr iq la b lb mz lf na kl nb kp nc kt nd ls mv mw mx my bi translated">加密货币_价格_变化1d</li><li id="3457" class="mq mr iq la b lb mz lf na kl nb kp nc kt nd ls mv mw mx my bi translated">加密货币_价格_变化1w</li></ul><p id="04e6" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">使用以下内容为json_exporter创建配置文件。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="b5a2" class="kc kd iq mc b gy ml mm l mn mo">$ touch /tmp/json_exporter_tutorial/examples/config.yml</span></pre><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">json_exporter的配置文件</figcaption></figure><p id="3304" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">下面的配置描述了用<a class="ae lt" href="https://kubernetes.io/docs/reference/kubectl/jsonpath/" rel="noopener ugc nofollow" target="_blank"> JSONPath </a>解析JSON对象的步骤。</p><p id="1e74" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">使用以下内容为Prometheus创建一个配置文件。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="fe91" class="kc kd iq mc b gy ml mm l mn mo">$ touch /tmp/json_exporter_tutorial/examples/prometheus.yml</span></pre><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Prometheus . yml-Prometheus JSON _ exporter的作业</figcaption></figure><p id="a440" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">正如您所注意到的，我们将使用三个不同于<code class="fe lz ma mb mc b">?currency</code>查询参数的目标。在上述参数的帮助下，响应将适合于该货币，因此在这种情况下，我们将有三种不同类型货币的时间序列<code class="fe lz ma mb mc b">USD</code>、<code class="fe lz ma mb mc b">EUR</code>和<code class="fe lz ma mb mc b">AMD</code>。下面的<code class="fe lz ma mb mc b">relabel_configs</code>部分将创建对应于<code class="fe lz ma mb mc b">?currency</code> HTTP查询参数值的<code class="fe lz ma mb mc b">currency</code>标签。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="69e1" class="kc kd iq mc b gy ml mm l mn mo">- source_labels: [__address__]<br/>  regex: ^http.+currency=([A-Z]{3})<br/>  action: replace<br/>  target_label: currency<br/>  replacement: ${1}</span></pre><p id="89f5" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">我们需要创建的最后一个文件是<code class="fe lz ma mb mc b">docker-compose.yml</code>。用下面描述的内容创建它。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="6760" class="kc kd iq mc b gy ml mm l mn mo">$ touch /tmp/json_exporter_tutorial/docker-compose.yml</span></pre><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">docker-compose.yml</figcaption></figure><p id="3f85" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">最后，是时候用Docker compose启动服务了。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="f20e" class="kc kd iq mc b gy ml mm l mn mo">$ cd /tmp/json_exporter_tutorial<br/>$ docker-compose up -d</span></pre><p id="9091" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">由于服务已经成功启动，让我们打开Prometheus web接口<a class="ae lt" href="http://localhost:9090/targets" rel="noopener ugc nofollow" target="_blank">http://localhost:9090/targets</a>并检查目标的状态。三个目标都实现了，这意味着一切都做对了。</p><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/f8c31a42b29d44c972d543cac536efc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tAQfwYBNVO5e5h6HgJXZMQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Img。1普罗米修斯目标</figcaption></figure><h2 id="b7d1" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">做一些查询。</h2><p id="42e6" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">既然普罗米修斯号成功地从目标上擦过，让我们看看时间序列是什么样的。</p><ul class=""><li id="1bfa" class="mq mr iq la b lb lu lf lv kl ms kp mt kt mu ls mv mw mx my bi translated"><code class="fe lz ma mb mc b">bottomk(10, avg by (name) (cryptocurrency_rank))</code> -按排名返回前10种加密货币。</li></ul><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/db77e04a1ed76ce7d778bd98c7c18c2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m7XZ_xUgymAQmvyDHMwY2g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Img。2十大加密货币</figcaption></figure><ul class=""><li id="9b7c" class="mq mr iq la b lb lu lf lv kl ms kp mt kt mu ls mv mw mx my bi translated"><code class="fe lz ma mb mc b">sum by (currency,name) (cryptocurrency_price{symbol="ETH"})</code> -返回每种货币的当前ETH价格。</li></ul><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/45f58b54b28aeefa18dd4cb1b8bd05ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k14ya-JUOxcEAynB1r7jaA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Img。每种货币的当前价格</figcaption></figure><h2 id="adc0" class="kc kd iq bd ke kf kg dn kh ki kj dp kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated"><strong class="ak">结论</strong>。</h2><p id="0cb6" class="pw-post-body-paragraph ky kz iq la b lb lc ld le lf lg lh li kl lj lk ll kp lm ln lo kt lp lq lr ls ij bi translated">毫无疑问，我们可以说json_exporter是一个非常有用的工具，它很容易配置和集成Prometheus栈。感谢这个导出器的创作者和维护者。</p><p id="59c5" class="pw-post-body-paragraph ky kz iq la b lb lu ld le lf lv lh li kl lw lk ll kp lx ln lo kt ly lq lr ls ij bi translated">感谢阅读。我希望这个故事是有帮助的。如果你有兴趣，可以看看<a class="ae lt" href="https://hayk96.medium.com/" rel="noopener">我的其他媒体文章</a>。</p></div></div>    
</body>
</html>