# 使用 GitHub 为 CI/ CB 配置 OnPremises Azure DevOps 2020 服务器

> 原文：<https://levelup.gitconnected.com/configuring-onpremises-azure-devops-2020-server-with-github-for-ci-cb-146ab7758e53>

![](img/1842516f559996a8d5d28d546f86c076.png)

我已经用 TFS 十多年了。我们在办公室使用一台服务器，它随着时间的推移慢慢从 TFS 升级到 Azure DevOps 服务器。它现在有 2020 版本，带有最新的补丁。作为参考，我将它与 Windows Server 2019 和 SQL Server 2019 配合使用(操作系统和服务器都已升级)。

这样做的最初原因是，即使我们使用 GitHub 来存储代码，我们仍然需要一些东西来编写我们的测试用例。TFS 附带了一个测试管理工具。

在过去的一周里，我不得不开始在这台服务器上使用构建和发布管道，因为我需要 CI/ CB 用于一些需要作为发布的一部分进行部署的本地应用程序。

> 当您有 3 个应用程序需要在总共 6 种不同的配置中部署时，手动部署不是一个选项&手动部署需要一些时间。

# 酒店内的 Azure DevOps

## 障碍 1: GitHub 集成

这很奇怪，但是当你设置一个构建管道时，云版本的 GitHub 并不作为一个选项被本地支持。

*   你必须选择“其他”
*   输入您的回购的 URL
*   输入您的用户名
*   输入您的“令牌”作为密码，而不是真正的密码。

如果您在创建构建管道时这样做，您将不知道如何获得这个“令牌”。

学习如何做到这一点的最好方法是从左下角进入项目设置，并尝试设置一个“连接”。在那里你看到 GitHub 是一个选项。当您尝试进行此配置时:

*   它告诉你在 github.com 上的网址，你可以从那里得到你的令牌(纯文本)。

[https://dev.azure.com/](https://dev.azure.com/)<orgname>/_ 用户设置/令牌

*   它告诉你令牌需要有什么权限(非常非常难看到，细文本)。

本文将告诉您如何获取个人访问令牌，以便在您将部署到的 OnPremises 服务器上进行身份验证:

[使用个人访问令牌进行身份验证— Azure DevOps | Microsoft Docs](https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops&tabs=preview-page)

请注意，如果您没有选择所有推荐的权限，验证将会失败。因此，请确保选择正确的权限，然后获得令牌。

> 您在项目设置中创建的 GitHub 连接不会出现在构建管道中！

这只是一个学习如何获得令牌的好方法。只需返回到构建管道并重用您在上述步骤中创建的令牌。

**这很难相信，但是构建管道现在可以获得你的代码并开始构建了！**

## 障碍 2: nuget restore 失败，出现关于未指定文件夹路径的神秘错误

我花了一天的时间来确保构建代理得到更新，并安装了最新的 VS 2019。我怀疑这是奇怪错误的根本原因——构建代理是不久前设置的，并且状态不佳。

服务器硬件陈旧，速度很慢。加载页面的时间太长了。目前，我打算“顺其自然”,明天继续尝试完成构建管道。

通过在 nuget restore 任务的高级设置中指定输出文件夹，我能够克服这个错误。这基本上设置为:“SolutionFolder/packages”(我就是这么做的)。

## 障碍 3:我的服务器太旧了

即使我设法让我的构建工作，我注意到整个网站将在构建成功后挂起。在尝试了一整天之后，我最终决定转向 Azure 云

# 云上的 Azure DevOps

这里，最大的障碍是我需要部署到 OnPremises。幸运的是，它已经为我们的办公室设置了一个 VPN，我已经用它将 Azure 虚拟机连接到我们的办公室。

我还必须提到，我已经在云上有了一个构建系统，但是它只能部署到云上。我不得不设置一个定制的构建 VM Scaleset，因为常规的托管 Azure 解决方案没有足够的磁盘空间来处理我的源代码。

> 可以使用 Azure CLI 命令增加检索文件的驱动器的磁盘大小，但这涉及到停止虚拟机规模集。当您这样做时，DevOps 管道池会发现虚拟机已关闭，因此它会删除并重新创建虚拟机。所以，我仍然在等待一个支持票来解决这个问题。目前，我已经通过从 VS 2019 安装程序中卸载所有我不需要的东西来管理。

## 虚拟机规模集与开发运维管道的噩梦

请注意，在撰写本文时，如果您试图在创建虚拟机规模集时进行任何定制，DevOps 将无法很好地处理它，并且它将进入一个可怕的循环，在这个循环中，它将尝试设置虚拟机、失败、删除、重新创建…直到永远。

因此，在创建 VM scaleset 时，不要打开任何时髦的新定制设置。我花了一天多的时间来学习这个，希望这能节省你一些时间。

## YAML 疯狂

当我在费力地完成了确保这一点的整个过程之后，试图设置构建管道时。NET 4.8，。NET Core 等都在新构建的虚拟机上，它把我带到了对我来说毫无意义的可怕的 YAML 界面。

您必须眯着眼睛才能看到用“经典方式”创建构建管道的选项。令人惊讶的是，Azure 是如何设法让“易用的东西”变得“经典”的。

## nuget restore 仍然是一个问题

当我选择 ASP.NET 构建管道时，nuget restore 给了我同样的错误，原因和我在问题上注意到的一样。

显然，nuget restore 对于云应用和常规 ASP.NET 应用的工作方式不同，或者模板已经过时。

我今天设法让构建工作，让我们看看我是否能在下周让部署工作！

## 调试模式是关键

我花了很多时间试图让部署工作。不管怎样，它都不会起作用。最终，我不得不启用调试模式来尝试理解错误。但是，部署没有调试错误，而是开始工作了！

**未完待续……**