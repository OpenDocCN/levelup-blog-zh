<html>
<head>
<title>Developing DAPPs with Svelte and Web3/Ethers, using Polygon MATIC — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Polygon MATIC开发具有Svelte和Web3/Ethers的DAPPs第2部分</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/developing-dapps-with-svelte-and-web3-ethers-using-polygon-matic-part-2-7a17af83ee6d?source=collection_archive---------4-----------------------#2022-11-12">https://levelup.gitconnected.com/developing-dapps-with-svelte-and-web3-ethers-using-polygon-matic-part-2-7a17af83ee6d?source=collection_archive---------4-----------------------#2022-11-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f7d6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何开始使用Polygon的孟买测试网</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c74d197d4bcee957288ad313138f2cc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4faMpI2Y9ytGx5zYVdDPNQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来自Adobe Stock的许可图像</figcaption></figure><p id="987b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在上一篇文章中，我向您展示了如何在浏览器中设置MetaMask，在Polygon Mumbai Testnet上创建一个帐户，用MATIC为该帐户提供资金，甚至创建自己的ERC-20令牌(加密货币)。</p><div class="lu lv gp gr lw lx"><a href="https://medium.com/coinmonks/developing-dapps-with-svelte-and-web3-using-polygon-matic-part-1-c3cc13adc4e4" rel="noopener follow" target="_blank"><div class="ly ab fo"><div class="lz ab ma cl cj mb"><h2 class="bd iu gy z fp mc fr fs md fu fw is bi translated">使用Polygon MATIC用Svelte和Web3开发DAPPs第1部分</h2><div class="me l"><h3 class="bd b gy z fp mc fr fs md fu fw dk translated">如何开始使用Polygon的孟买测试网</h3></div><div class="mf l"><p class="bd b dl z fp mc fr fs md fu fw dk translated">medium.com</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml ks lx"/></div></div></a></div><p id="dd58" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇文章中，我将介绍如何用Svelte(react . js、Angular、Vue等的替代品)创建一个简单的web应用程序。)，使用Ethers.js将其与MetaMask集成，并与Polygon Mumbai Testnet区块链进行通信。</p><p id="7c69" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果对第三篇文章感兴趣，我将演示如何将智能契约部署到Polygon Mumbai Testnet中，并使用我们的web应用程序与之交互。如果这是你想看到的，请考虑为这两篇文章鼓掌。</p><h2 id="41e8" class="mm mn it bd mo mp mq dn mr ms mt dp mu lh mv mw mx ll my mz na lp nb nc nd ne bi translated">先决条件</h2><p id="3360" class="pw-post-body-paragraph ky kz it la b lb nf ju ld le ng jx lg lh nh lj lk ll ni ln lo lp nj lr ls lt im bi translated">为了创建我们苗条的web应用程序，我们将需要使用<a class="ae nk" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank">节点包管理器</a> ( <a class="ae nk" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank"> NPM </a>)。这总是教程中棘手的部分，因为读者可能使用微软、OSX或Linux系统。根据您的平台，安装会有所不同。我用的是苹果电脑，所以我只是用<a class="ae nk" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank">自制软件</a>来安装我的。例如“<strong class="la iu"> brew更新</strong>”，然后“<strong class="la iu"> brew安装节点</strong>”。如果一切按计划进行，它应该是这样的(版本可能会有所不同)。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="3f46" class="nq mn it nm b be nr ns l nt nu">% <strong class="nm iu">npm --version</strong><br/>8.3.1<br/><br/>% <strong class="nm iu">node --version</strong><br/>v17.4.0<br/><br/>% <strong class="nm iu">npx --version</strong><br/>8.3.1</span></pre><h2 id="ab43" class="mm mn it bd mo mp mq dn mr ms mt dp mu lh mv mw mx ll my mz na lp nb nc nd ne bi translated">苗条入门应用</h2><p id="f1ab" class="pw-post-body-paragraph ky kz it la b lb nf ju ld le ng jx lg lh nh lj lk ll ni ln lo lp nj lr ls lt im bi translated">为了开始使用Svelte，我建议使用模板创建您的初始项目。我将把我的命名为“<strong class="la iu">中型dapp </strong>”。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="e1fc" class="nq mn it nm b be nr ns l nt nu">% <strong class="nm iu">npx degit sveltejs/template medium-dapp</strong><br/>Need to install the following packages:<br/>  degit<br/>Ok to proceed? (y) y<br/>&gt; cloned sveltejs/template#HEAD to medium-dapp</span></pre><p id="543b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">完成后，将创建一个名为“<strong class="la iu"> medium-dapp </strong>的新目录，其文件结构如下所示。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="dd03" class="nq mn it nm b be nr ns l nv nu">% cd medium-dapp<br/>medium-dapp % tree .<br/><br/>.<br/>|____README.md<br/>|____rollup.config.js<br/>|____public<br/>| |____index.html<br/>| |____global.css<br/>| |____favicon.png<br/>|____.gitignore<br/>|____package.json<br/>|____scripts<br/>| |____setupTypeScript.js<br/>|____src<br/>| |____App.svelte<br/>| |____main.js</span></pre><p id="97a7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在一个完全不相关的问题上——“<strong class="la iu">tree</strong>”在Linux上是一个非常有用的命令，但是它不包含在OSX上。作为一种方便的解决方法，您可以创建一个别名，如下所示(产生上面的输出)。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="0f3a" class="nq mn it nm b be nr ns l nv nu">alias tree="find . -print | sed -e 's;[^/]*/;|____;g;s;____|; |;g'"</span></pre><p id="ac33" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Svelte的库需求将包含在<strong class="la iu"> package.json </strong>文件中。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="6a64" class="nq mn it nm b be nr ns l nv nu">{<br/>  "name": "svelte-app",<br/>  "version": "1.0.0",<br/>  "private": true,<br/>  "scripts": {<br/>    "build": "rollup -c",<br/>    "dev": "rollup -c -w",<br/>    "start": "sirv public --no-clear"<br/>  },<br/>  "devDependencies": {<br/>    "@rollup/plugin-commonjs": "^17.0.0",<br/>    "@rollup/plugin-node-resolve": "^11.0.0",<br/>    "rollup": "^2.3.4",<br/>    "rollup-plugin-css-only": "^3.1.0",<br/>    "rollup-plugin-livereload": "^2.0.0",<br/>    "rollup-plugin-svelte": "^7.0.0",<br/>    "rollup-plugin-terser": "^7.0.0",<br/>    "svelte": "^3.0.0"<br/>  },<br/>  "dependencies": {<br/>    "sirv-cli": "^2.0.0"<br/>  }<br/>}</span></pre><p id="26b0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在“<strong class="la iu"> medium-dapp </strong>”目录下，您可以运行“<strong class="la iu"> yarn </strong>”或“<strong class="la iu"> npm </strong>”来安装依赖项。我更喜欢用“<strong class="la iu">纱</strong>”但这取决于你。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="9036" class="nq mn it nm b be nr ns l nt nu">medium-dapp % <strong class="nm iu">yarn </strong><br/>yarn install v1.22.17<br/>info No lockfile found.<br/>[1/4] 🔍  Resolving packages...<br/>[2/4] 🚚  Fetching packages...<br/>[3/4] 🔗  Linking dependencies...<br/>[4/4] 🔨  Building fresh packages...<br/>success Saved lockfile.<br/>warning Your current version of Yarn is out of date. The latest version is "1.22.19", while you're on "1.22.17".<br/>info To upgrade, run the following command:<br/>$ brew upgrade yarn<br/>✨  Done in 13.14s.</span></pre><p id="5147" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果一切都按计划进行，您应该能够启动“<strong class="la iu"> hello world </strong>”网站，如下所示。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="c495" class="nq mn it nm b be nr ns l nt nu">medium-dapp % <strong class="nm iu">npm run dev</strong><br/><br/>&gt; svelte-app@1.0.0 dev<br/>&gt; rollup -c -w<br/><br/>rollup v2.79.1<br/>bundles src/main.js → public/build/bundle.js...<br/>LiveReload enabled<br/>created public/build/bundle.js in 202ms<br/><br/>[2022-11-12 09:48:50] waiting for changes...<br/><br/>&gt; svelte-app@1.0.0 start<br/>&gt; sirv public --no-clear "--dev"<br/><br/><br/>  Your application is ready~! 🚀<br/><br/>  - Local:      http://localhost:8080<br/>  - Network:    Add `--host` to expose<br/><br/>────────────────── LOGS ──────────────────</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/2a9681a133953d914d35168d301ee31f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G2GxRaH6PcWvprDHT8KcaQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</figcaption></figure><p id="01f2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在开发者模式下运行它的好处是，任何代码更新都将自动在浏览器中重新加载，而无需重启站点。</p><p id="0a3a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">例如，我让现有的“<strong class="la iu"> npm run dev </strong>”终端运行。我打开一个新的终端，并在我的IDE中打开目录，这是<a class="ae nk" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio代码</a>。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="c600" class="nq mn it nm b be nr ns l nt nu">medium-dapp % code .<br/>medium-dapp % </span></pre><p id="002e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将“<strong class="la iu"> HELLO WORLD </strong>”的颜色从红色改为蓝色，并保存了文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/950e9d915d4590262e683b52caace3ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5wBdDTFfXkdtMI0DFBFMjg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</figcaption></figure><p id="54ad" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这些变化马上就反映出来了。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="90f2" class="nq mn it nm b be nr ns l nv nu">bundles src/main.js → public/build/bundle.js...<br/>created public/build/bundle.js in 99ms<br/><br/>[2022-11-12 09:54:16] waiting for changes...<br/>  [09:54:57] 200 ─ 4.54ms ─ /<br/>  [09:54:57] 200 ─ 3.66ms ─ /global.css<br/>  [09:54:57] 200 ─ 4.48ms ─ /build/bundle.css<br/>  [09:54:57] 200 ─ 0.97ms ─ /build/bundle.js<br/>  [09:54:57] 200 ─ 0.96ms ─ /favicon.png<br/>  [09:55:27] 200 ─ 0.58ms ─ /<br/>  [09:55:27] 200 ─ 5.08ms ─ /global.css<br/>  [09:55:27] 200 ─ 5.96ms ─ /build/bundle.css<br/>  [09:55:27] 200 ─ 2.19ms ─ /build/bundle.js<br/>  [09:55:27] 200 ─ 0.80ms ─ /favicon.png</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/b576bc907b8029b3459b3b724289feef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y-IXT8EYI3Vc56nclstvZA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</figcaption></figure><p id="15a0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们现在有一个基本的苗条的应用程序启动和运行。下一步将开始将它与元掩码集成。</p><h2 id="5eb8" class="mm mn it bd mo mp mq dn mr ms mt dp mu lh mv mw mx ll my mz na lp nb nc nd ne bi translated">Web3与以太网</h2><p id="2dc0" class="pw-post-body-paragraph ky kz it la b lb nf ju ld le ng jx lg lh nh lj lk ll ni ln lo lp nj lr ls lt im bi translated">这两个Javascript库的语法略有不同，但它们本质上做的是相同的事情。它们都是"<strong class="la iu">同样受欢迎的</strong>"，但是就我所见"<strong class="la iu">醚类</strong>"似乎是现在大多数开发人员的首选(至少在我从事的项目中)。Web3似乎是"<strong class="la iu">营销名称</strong>"你听到的很多可能更多的是指它执行的功能，而不是它实际上是什么。归根结底，选择权在你。它们各有利弊，但大多是装饰性的。这篇文章不打算权衡利弊，但我仍然想提供更多的信息。我发现了这个YouTube视频，这个人解释得很好，所以我不打算重新发明轮子。我比其他人更喜欢这个解释的原因是，他在他的Github repo中也提供了类似的例子，所以你可以进行比较。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nz oa l"/></div></figure><h2 id="b866" class="mm mn it bd mo mp mq dn mr ms mt dp mu lh mv mw mx ll my mz na lp nb nc nd ne bi translated">使用醚与超薄超屏蔽通信</h2><p id="d946" class="pw-post-body-paragraph ky kz it la b lb nf ju ld le ng jx lg lh nh lj lk ll ni ln lo lp nj lr ls lt im bi translated">是的，“<strong class="la iu">醚类</strong>”…我喜欢“<strong class="la iu">醚类</strong>”，我在Svelte中做的整合将使用这个库。如果你对使用“<strong class="la iu"> web3 </strong>”有强烈的感觉，相反它非常相似，所以转换应该很容易。</p><p id="3553" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你需要在你的项目中安装<strong class="la iu"> ethers </strong>。如果网站还在运行，停止网站，运行“<strong class="la iu">纱线添加醚</strong>”或“<strong class="la iu"> npm安装醚</strong>”，随你喜欢。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="84b3" class="nq mn it nm b be nr ns l nt nu">medium-dapp % <strong class="nm iu">yarn add ethers</strong><br/>yarn add v1.22.17<br/>[1/4] 🔍  Resolving packages...<br/>[2/4] 🚚  Fetching packages...<br/>[3/4] 🔗  Linking dependencies...<br/>[4/4] 🔨  Building fresh packages...<br/><br/>success Saved lockfile.<br/>success Saved 18 new dependencies.<br/>info Direct dependencies<br/>└─ ethers@5.7.2<br/>info All dependencies<br/>├─ @ethersproject/abi@5.7.0<br/>├─ @ethersproject/contracts@5.7.0<br/>├─ @ethersproject/json-wallets@5.7.0<br/>├─ @ethersproject/providers@5.7.2<br/>├─ @ethersproject/solidity@5.7.0<br/>├─ @ethersproject/units@5.7.0<br/>├─ @ethersproject/wallet@5.7.0<br/>├─ aes-js@3.0.0<br/>├─ bech32@1.1.4<br/>├─ brorand@1.1.0<br/>├─ elliptic@6.5.4<br/>├─ ethers@5.7.2<br/>├─ hash.js@1.1.7<br/>├─ hmac-drbg@1.0.1<br/>├─ js-sha3@0.8.0<br/>├─ minimalistic-assert@1.0.1<br/>├─ scrypt-js@3.0.1<br/>└─ ws@7.4.6<br/>✨  Done in 8.30s.</span></pre><p id="ca55" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">再次启动您的web服务器，“npm run dev ”，并打开一个单独的窗口来编辑代码。</p><p id="d3ba" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了节省时间，我将重复使用上面提到的启动代码。我将只在src/App.svelte文件中工作。</p><p id="ceda" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们的最终结果将是这样的…</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/76ec3bcb0445747824f5a8af3fa9f0c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3yaYg2RSFwl63DdRU3s1uw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</figcaption></figure><ul class=""><li id="7bd1" class="ob oc it la b lb lc le lf lh od ll oe lp of lt og oh oi oj bi translated">加载页面时，元掩码将自动连接</li><li id="d97d" class="ob oc it la b lb ok le ol lh om ll on lp oo lt og oh oi oj bi translated">如果元掩码已安装、解锁并连接，它将返回(每3秒检查一次)</li><li id="3d12" class="ob oc it la b lb ok le ol lh om ll on lp oo lt og oh oi oj bi translated">如果元掩码中的账户发生变化，则“<strong class="la iu">关联账户</strong>将立即更新</li><li id="8456" class="ob oc it la b lb ok le ol lh om ll on lp oo lt og oh oi oj bi translated">将显示当前MetaMask钱包中的“<strong class="la iu">自动余额</strong>”(每3秒检查一次)</li><li id="23d7" class="ob oc it la b lb ok le ol lh om ll on lp oo lt og oh oi oj bi translated">将对照我们在上一篇文章中创建的ERC-20令牌契约来检查“<strong class="la iu">惠特尔余额</strong>”(每3秒检查一次)</li></ul><p id="009f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我故意试着不要让它变得太复杂，所以它很容易理解。你可以做很多事情来改善这一点，比如使用苗条商店。它有点像React.js的翻版，但是更加简单明了。它基本上是应用程序变量的中央存储。</p><p id="1333" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">让我们深入研究代码……</strong></p><p id="9c98" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，我们将从<strong class="la iu"> &lt;脚本&gt;…&lt;/脚本&gt; </strong>标签内的代码开始。这是您的Javascript将要去的地方。</p><p id="2ff4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将Ethers.js导入到您的项目中，我们之前已经安装了它。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="fd04" class="nq mn it nm b be nr ns l nv nu">import { ethers } from "ethers";</span></pre><p id="b744" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">配置您的常数。我使用了ERC 20令牌ABI的一个子集。通常您会从separe ERC20.json文件导入整个ABI。出于本文的目的，我只是添加了我们现在需要的内容。我还包含了“<strong class="la iu"> tokenAddress </strong>”，这是我的WHITTLE令牌部署在区块链上的合同地址。<a class="ae nk" href="https://medium.com/coinmonks/developing-dapps-with-svelte-and-web3-using-polygon-matic-part-1-c3cc13adc4e4" rel="noopener">更多信息请参考上一篇文章</a>。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="00d2" class="nq mn it nm b be nr ns l nv nu">const ERC20_ABI = [<br/>  {<br/>    constant: true,<br/>    inputs: [<br/>      {<br/>        name: "_owner",<br/>        type: "address",<br/>      },<br/>    ],<br/>    name: "balanceOf",<br/>    outputs: [<br/>      {<br/>        name: "balance",<br/>        type: "uint256",<br/>      },<br/>    ],<br/>    payable: false,<br/>    type: "function",<br/>  },<br/>];<br/><br/>const tokenAddress = "0x348B9EaA3350EC3EfDB731FAc13EA1De234d2DE6";</span></pre><p id="2cc1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后我们定义全局变量。希望它们是不言自明的，不需要解释。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="3464" class="nq mn it nm b be nr ns l nv nu">let provider;<br/>let signer;<br/>let signerAddress;<br/>let tokenContract;<br/>let tokenBalance = 0;<br/>let accountBalance = 0;<br/>let isConnected = false;<br/>let isUnlocked = false;<br/>let initialized = false;<br/>let isPermanentlyDisconnected = false;<br/>let metamaskStatus = "...";</span></pre><p id="b41a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后我创建了一个名为“<strong class="la iu"> connectWallet </strong>”的异步函数。我在页面加载时自动运行这个，但是你可以很容易地将它附加到一个按钮上。这个函数有一些基本的元掩码错误处理来检测状态。我见过太多这方面做得不好的地方。元掩码可以安装或不存在、锁定或解锁、连接或不连接等。也有可能在调用"<strong class="la iu"> connectWallet </strong>"之后这种情况会发生变化，所以只检查一次是不够的。在这个函数中，我检索重要的信息，比如元掩码中活动帐户的地址、元掩码中的帐户余额以及元掩码中活动帐户的令牌余额。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="54b0" class="nq mn it nm b be nr ns l nv nu">async function connectWallet() {<br/>  const { ethereum } = window;<br/><br/>  if (typeof window.ethereum !== "undefined") {<br/>    // connect<br/>    await ethereum.request({ method: "eth_requestAccounts" }).catch((err) =&gt; {<br/>      if (err.code === 4001) {<br/>        // EIP-1193 userRejectedRequest<br/>        alert("You need to install MetaMask");<br/>      } else {<br/>        console.error(err);<br/>      }<br/>    });<br/><br/>    // get provider<br/>    provider = new ethers.providers.Web3Provider(ethereum);<br/><br/>    // get signer<br/>    signer = provider.getSigner();<br/><br/>    // get connected wallet address<br/>    signerAddress = await signer.getAddress();<br/><br/>    // get account balance<br/>    accountBalance = await provider.getBalance(signerAddress);<br/><br/>    // erc-20 token<br/>    tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);<br/>    tokenBalance = await tokenContract.balanceOf(signerAddress);<br/><br/>    // update on account change<br/>    ethereum.on("accountsChanged", function (accounts) {<br/>      signerAddress = accounts[0];<br/>    });<br/>  } else {<br/>    alert("MetaMask has not been detected in your browser!");<br/>    console.err("MetaMask has not been detected in your browser!");<br/>  }<br/>}</span></pre><p id="c009" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如我上面提到的，在最初的连接之后，很多事情都会改变。不仅是连接状态，还有帐户余额。例如，如果在MetaMask的账户中进行了转账，但web应用程序没有更新显示的余额，这就不好了。该预定功能每3秒运行一次。它确保余额得到更新，并显示正确的状态。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="e5b5" class="nq mn it nm b be nr ns l nv nu">var accountInterval = setInterval(function () {<br/>  if (provider) {<br/>    ({ isConnected, isUnlocked, initialized, isPermanentlyDisconnected } =<br/>      window.ethereum._state);<br/><br/>    if (isConnected &amp;&amp; !isPermanentlyDisconnected &amp;&amp; initialized) {<br/>      if (isUnlocked) {<br/>        metamaskStatus = `&lt;span style="color: green;"&gt;MetaMask has been successfully detected in your browser, with external connectivity, and is unlocked.&lt;/span&gt;`;<br/><br/>        // get account balance<br/>        provider.getBalance(signerAddress).then((_accountBalance) =&gt; {<br/>          accountBalance = _accountBalance;<br/>        });<br/><br/>        // erc-20 token balance<br/>        tokenContract.balanceOf(signerAddress).then((_tokenBalance) =&gt; {<br/>          tokenBalance = _tokenBalance;<br/>        });<br/>      } else {<br/>        metamaskStatus = `&lt;span style="color: red;"&gt;Please unlock your MetaMask and reload.&lt;/span&gt;`;<br/>      }<br/>    } else {<br/>      if (isUnlocked) {<br/>        metamaskStatus = `&lt;span style="color: red;"&gt;MetaMask has been successfully detected in your browser, but without external connectivity.&lt;/span&gt;`;<br/>      } else {<br/>        metamaskStatus = `&lt;span style="color: red;"&gt;Please unlock your MetaMask and reload.&lt;/span&gt;`;<br/>      }<br/>    }<br/>  }<br/>}, 3000);</span></pre><p id="cc21" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您会注意到，我对变量“<strong class="la iu"> metamaskStatus </strong>”使用了反斜杠。我想包括HTML，这将根据状态类型切换颜色。</p><p id="ba02" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后一行只是运行，“<strong class="la iu"> connectWallet </strong>”。正如我上面提到的，当页面加载时我会自动运行它，但是你也可以很容易地将它绑定到一个按钮上。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="898d" class="nq mn it nm b be nr ns l nv nu">connectWallet();</span></pre><p id="9a27" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来的部分是<strong class="la iu"> &lt;主&gt;…&lt;/主&gt; </strong>标签。我用这个替换了初始模板中的内容。</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="3c02" class="nq mn it nm b be nr ns l nv nu">&lt;main&gt;<br/>  &lt;h1&gt;MetaMask Integration&lt;/h1&gt;<br/>  &lt;p&gt;&lt;b&gt;Connected Account&lt;/b&gt;: {signerAddress}&lt;/p&gt;<br/>  &lt;p&gt;&lt;b&gt;MATIC Balance&lt;/b&gt;: {ethers.utils.formatEther(accountBalance)}&lt;/p&gt;<br/>  &lt;p&gt;&lt;b&gt;WHITTLE Balance&lt;/b&gt;: {ethers.utils.formatEther(tokenBalance)}&lt;/p&gt;<br/><br/>  &lt;br /&gt;<br/>  &lt;p&gt;{@html metamaskStatus}&lt;/p&gt;<br/>&lt;/main&gt;</span></pre><p id="8533" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里要注意的要点是，我将余额从一个“<strong class="la iu">大数字</strong>”格式化成可读的东西。您还会注意到，我对变量“<strong class="la iu"> metamaskStatus </strong>”的显示做了一些特殊的处理。如果之前没有包含html标签，那么“<strong class="la iu"> metamaskStatus </strong>”的内容将被准确返回。我们实际上希望解释变量字符串中的HTML。</p><p id="6d9f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我没有从模板中修改<strong class="la iu"> &lt;样式&gt;…&lt;/样式&gt; </strong>标签。</p><p id="6fba" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">完整的代码如下所示…</p><pre class="kj kk kl km gt nl nm nn bn no np bi"><span id="6c84" class="nq mn it nm b be nr ns l nv nu">&lt;script&gt;<br/>  import { ethers } from "ethers";<br/><br/>  const ERC20_ABI = [<br/>    {<br/>      constant: true,<br/>      inputs: [<br/>        {<br/>          name: "_owner",<br/>          type: "address",<br/>        },<br/>      ],<br/>      name: "balanceOf",<br/>      outputs: [<br/>        {<br/>          name: "balance",<br/>          type: "uint256",<br/>        },<br/>      ],<br/>      payable: false,<br/>      type: "function",<br/>    },<br/>  ];<br/><br/>  const tokenAddress = "0x348B9EaA3350EC3EfDB731FAc13EA1De234d2DE6";<br/><br/>  let provider;<br/>  let signer;<br/>  let signerAddress;<br/>  let tokenContract;<br/>  let tokenBalance = 0;<br/>  let accountBalance = 0;<br/>  let isConnected = false;<br/>  let isUnlocked = false;<br/>  let initialized = false;<br/>  let isPermanentlyDisconnected = false;<br/>  let metamaskStatus = "...";<br/><br/>  async function connectWallet() {<br/>    const { ethereum } = window;<br/><br/>    if (typeof window.ethereum !== "undefined") {<br/>      // connect<br/>      await ethereum.request({ method: "eth_requestAccounts" }).catch((err) =&gt; {<br/>        if (err.code === 4001) {<br/>          // EIP-1193 userRejectedRequest<br/>          alert("You need to install MetaMask");<br/>        } else {<br/>          console.error(err);<br/>        }<br/>      });<br/><br/>      // get provider<br/>      provider = new ethers.providers.Web3Provider(ethereum);<br/><br/>      // get signer<br/>      signer = provider.getSigner();<br/><br/>      // get connected wallet address<br/>      signerAddress = await signer.getAddress();<br/><br/>      // get account balance<br/>      accountBalance = await provider.getBalance(signerAddress);<br/><br/>      // erc-20 token<br/>      tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);<br/>      tokenBalance = await tokenContract.balanceOf(signerAddress);<br/><br/>      // update on account change<br/>      ethereum.on("accountsChanged", function (accounts) {<br/>        signerAddress = accounts[0];<br/>      });<br/>    } else {<br/>      alert("MetaMask has not been detected in your browser!");<br/>      console.err("MetaMask has not been detected in your browser!");<br/>    }<br/>  }<br/><br/>  var accountInterval = setInterval(function () {<br/>    if (provider) {<br/>      ({ isConnected, isUnlocked, initialized, isPermanentlyDisconnected } =<br/>        window.ethereum._state);<br/><br/>      if (isConnected &amp;&amp; !isPermanentlyDisconnected &amp;&amp; initialized) {<br/>        if (isUnlocked) {<br/>          metamaskStatus = `&lt;span style="color: green;"&gt;MetaMask has been successfully detected in your browser, with external connectivity, and is unlocked.&lt;/span&gt;`;<br/><br/>          // get account balance<br/>          provider.getBalance(signerAddress).then((_accountBalance) =&gt; {<br/>            accountBalance = _accountBalance;<br/>          });<br/><br/>          // erc-20 token balance<br/>          tokenContract.balanceOf(signerAddress).then((_tokenBalance) =&gt; {<br/>            tokenBalance = _tokenBalance;<br/>          });<br/>        } else {<br/>          metamaskStatus = `&lt;span style="color: red;"&gt;Please unlock your MetaMask and reload.&lt;/span&gt;`;<br/>        }<br/>      } else {<br/>        if (isUnlocked) {<br/>          metamaskStatus = `&lt;span style="color: red;"&gt;MetaMask has been successfully detected in your browser, but without external connectivity.&lt;/span&gt;`;<br/>        } else {<br/>          metamaskStatus = `&lt;span style="color: red;"&gt;Please unlock your MetaMask and reload.&lt;/span&gt;`;<br/>        }<br/>      }<br/>    }<br/>  }, 3000);<br/><br/>  connectWallet();<br/>&lt;/script&gt;<br/><br/>&lt;main&gt;<br/>  &lt;h1&gt;MetaMask Integration&lt;/h1&gt;<br/>  &lt;p&gt;&lt;b&gt;Connected Account&lt;/b&gt;: {signerAddress}&lt;/p&gt;<br/>  &lt;p&gt;&lt;b&gt;MATIC Balance&lt;/b&gt;: {ethers.utils.formatEther(accountBalance)}&lt;/p&gt;<br/>  &lt;p&gt;&lt;b&gt;WHITTLE Balance&lt;/b&gt;: {ethers.utils.formatEther(tokenBalance)}&lt;/p&gt;<br/><br/>  &lt;br /&gt;<br/>  &lt;p&gt;{@html metamaskStatus}&lt;/p&gt;<br/>&lt;/main&gt;<br/><br/>&lt;style&gt;<br/>  main {<br/>    text-align: center;<br/>    padding: 1em;<br/>    max-width: 240px;<br/>    margin: 0 auto;<br/>  }<br/><br/>  h1 {<br/>    color: red;<br/>    text-transform: uppercase;<br/>    font-size: 4em;<br/>    font-weight: 100;<br/>  }<br/><br/>  @media (min-width: 640px) {<br/>    main {<br/>      max-width: none;<br/>    }<br/>  }<br/>&lt;/style&gt;</span></pre><p id="41bf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你想让我继续学习这篇教程，请不要忘记为文章鼓掌。如果你想让我向你展示如何部署一个智能联系人并与之互动，或者告诉我苗条商店是如何工作的，请在评论中告诉我。如果你还有什么想看的或者已经解释过的，请告诉我。</p><p id="f8e9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我希望你觉得这篇文章有趣并且有用。如果您想随时了解情况，请不要忘记关注我，注册我的<a class="ae nk" href="https://whittle.medium.com/subscribe" rel="noopener">电子邮件通知</a>。</p><h1 id="8f69" class="op mn it bd mo oq or os mr ot ou ov mu jz ow ka mx kc ox kd na kf oy kg nd oz bi translated">迈克尔·惠特尔</h1><ul class=""><li id="37ff" class="ob oc it la b lb nf le ng lh pa ll pb lp pc lt og oh oi oj bi translated"><strong class="la iu"> <em class="pd">如果你喜欢这个，请</em> </strong> <a class="ae nk" href="https://whittle.medium.com/" rel="noopener"> <strong class="la iu"> <em class="pd">跟我上媒</em> </strong> </a></li><li id="4586" class="ob oc it la b lb ok le ol lh om ll on lp oo lt og oh oi oj bi translated"><strong class="la iu"> <em class="pd">更多有趣的文章，请</em> </strong> <a class="ae nk" href="https://medium.com/trading-data-analysis" rel="noopener"> <strong class="la iu"> <em class="pd">关注我的刊物</em> </strong> </a></li><li id="8aea" class="ob oc it la b lb ok le ol lh om ll on lp oo lt og oh oi oj bi translated"><strong class="la iu"> <em class="pd">有兴趣合作吗？</em> </strong> <a class="ae nk" href="https://www.linkedin.com/in/miwhittle/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu"> <em class="pd">我们上领英</em> </strong> </a>连线一下</li><li id="1150" class="ob oc it la b lb ok le ol lh om ll on lp oo lt og oh oi oj bi translated"><strong class="la iu"> <em class="pd">支持我和其他媒体作者</em> </strong> <a class="ae nk" href="https://whittle.medium.com/membership" rel="noopener"> <strong class="la iu"> <em class="pd">在此报名</em> </strong> </a></li><li id="8f99" class="ob oc it la b lb ok le ol lh om ll on lp oo lt og oh oi oj bi translated"><strong class="la iu"> <em class="pd">请别忘了为文章鼓掌:)←谢谢！</em>T57】</strong></li></ul></div></div>    
</body>
</html>