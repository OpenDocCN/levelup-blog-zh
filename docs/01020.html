<html>
<head>
<title>Adobe Experience Manager: Forcing the use of the DAM for images by closing loopholes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Adobe Experience Manager:通过堵塞漏洞强制对图像使用DAM</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/aem-forcing-the-use-of-the-dam-for-images-by-closing-loopholes-b102d944cad2?source=collection_archive---------2-----------------------#2019-10-20">https://levelup.gitconnected.com/aem-forcing-the-use-of-the-dam-for-images-by-closing-loopholes-b102d944cad2?source=collection_archive---------2-----------------------#2019-10-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b9d8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何防止用户不经过大坝上传图片到AEM？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/80e0e5825e4913312f4cf090f7dff930.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q045pR06seQsRM6D1uGsMw.png"/></div></div></figure><p id="6d53" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">DAM(数字资产管理器)是AEM的资产管理系统，应该是所有资产进入AEM平台的单一入口，也是在内容中使用这些资产的一站式商店。</p><p id="4d6f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">DAM不仅仅是存储资产，它还提供有用的功能，如资产验证、许可证管理、标记和分析等。即使您不使用这些功能，也有很多原因让您希望确保所有资产都在同一个地方，在同一个管理系统下:</p><ol class=""><li id="8ed5" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">资产很容易找到，特别是如果你有一个常识性的目录结构或者使用<a class="ae lw" href="https://helpx.adobe.com/gr_en/experience-manager/6-5/assets/using/managing-collections-touch-ui.html" rel="noopener ugc nofollow" target="_blank">集合特性</a>。</li><li id="dfdc" class="ln lo iq kt b ku lx kx ly la lz le ma li mb lm ls lt lu lv bi translated">如果您想要运行工作流(如内容验证)或对新资产进行任何类型的处理，这可以在创建DAM资产时完成。</li><li id="6028" class="ln lo iq kt b ku lx kx ly la lz le ma li mb lm ls lt lu lv bi translated">如果您需要将资产从另一个平台转移到另一个平台，集成会变得很容易。</li></ol><p id="c66e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然而，用户可以通过使用我认为是OOTB组件中的“漏洞”来绕过DAM，直接从他们的机器上传文件(通常是图像)到JCR中的特定位置，而不必将该文件放在DAM中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mc"><img src="../Images/727089eb93746df621a4e77cb2d374b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0uqaoRnAlVYX-R6vn97xhQ.jpeg"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">漏洞:照片由<a class="ae lw" href="https://unsplash.com/@picoftasty?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">梅姆</a>在<a class="ae lw" href="https://unsplash.com/s/photos/rope?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="620b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果上面的环的图像让你想起了刽子手的绳子，那不是巧合！让这些漏洞存在会导致包含“浮动资产”的被污染的JCR，这对于任何类型的批处理作业都是一个巨大的痛苦，并且从长远来看会对JCR的大小产生毁灭性的影响。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="3eaf" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">AEM站点图像组件</h1><p id="607f" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">我们先来看看最明目张胆的漏洞:图片组件的<em class="nl">浏览</em>选项。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/0d6b299df715df2f28db123429825536.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qU4Uf2W9QscSJH3TQbLk1g.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">浏览按钮</figcaption></figure><p id="0960" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您使用“上传”按钮来提供图像，会发生以下情况:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/c2b3b659da44b61737be251bccc8d9be.png" data-original-src="https://miro.medium.com/v2/resize:fit:532/format:webp/1*mocS-_TdFSWTknHftZHryQ.png"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">存储在页面级别的图像</figcaption></figure><p id="4e18" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">图像保存在页面级别，而不是DAM，这使得将来很难找到它。现在想象一下，同一个高分辨率图像在10个地方使用，并且每次用户都从他们的系统上传:你现在储存了10个图像，而不是在DAM中保存一次并引用10次。</p><p id="536a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">上面的CRXDE截图中的页面大小是7.3MB(参考大坝)和3.1MB(上传图像)(增加了424倍)！</p><p id="4175" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这种提供图像的方法也存在潜在的安全风险。拥有机密信息访问权限和芯片的用户可以使用<em class="nl">浏览</em>功能上传一个隐藏为JPEG格式的文本文件，该文件发布后，外界可以访问。我在下面的GIF中演示了这个场景:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/ae41c4a650b544afc438d4a90bcd53b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Bg-KkpdTq6qQ1E-gvvbIbA.gif"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">使用图像组件暴露机密信息</figcaption></figure><p id="003d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当然，您可以采取许多安全措施来防止这种滥用，但是删除<em class="nl">浏览</em>选项是一个好的开始。</p><p id="91db" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">相信了吗？让我们来看看如何“停用”这个特性。</p><h2 id="1713" class="np mp iq bd mq nq nr dn mu ns nt dp my la nu nv na le nw nx nc li ny nz ne oa bi translated">选项1:对于特定组件</h2><p id="9c63" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">“最干净”的方法是使用Image组件的<code class="fe ob oc od oe b">/libs/cq/gui/components/authoring/dialog/fileupload</code>组件的<code class="fe ob oc od oe b">allowUpload</code>属性。将该属性设置为<code class="fe ob oc od oe b">false</code>将会移除<em class="nl">浏览</em>按钮。</p><p id="142c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您正在使用AEM核心组件，那么您可以通过将<code class="fe ob oc od oe b">/apps/core/wcm/components/image/v2/image/cq:dialog/content/items/tabs/items/asset/items/columns/items/column/items/file</code>处的节点复制到您的映像组件中，并简单地向其添加以下属性来实现这一点:</p><pre class="kg kh ki kj gt of oe og oh aw oi bi"><span id="19cc" class="np mp iq oe b gy oj ok l ol om">allowUpload  -  Boolean  -  false</span></pre><h2 id="4f3e" class="np mp iq bd mq nq nr dn mu ns nt dp my la nu nv na le nw nx nc li ny nz ne oa bi translated">选项2:全球</h2><p id="53e7" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">如果你想完全删除这个功能，你可以通过在<code class="fe ob oc od oe b">/libs/cq/gui/components/authoring/dialog/fileupload/render.jsp</code>覆盖JSP，简单地删除读取<code class="fe ob oc od oe b">allowUpload</code>属性和呈现<em class="nl">浏览</em>按钮的代码。</p><p id="ba3a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下面是一个示例，但是请查看GitHub repo以了解JSP的完整重构:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/9709b1effa0fc31276ed12b46200b6b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iB8piS10B_v6crSvlqB7ZA.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">从JSP中删除<em class="oo">浏览按钮</em></figcaption></figure></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="63cd" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">AEM形成图像和图像选择组件</h1><p id="617c" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">AEM表单组件图像和图像选择也存在同样的问题:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a362daa0ff2cc25d49c9cf3ee7891c3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MnGnRcrw3JRjT8Uehab5ag.png"/></div></div></figure><p id="6cc0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然而，一般来说，AEM表单的定制友好性比AEM网站差得多，所以我们需要采用一种变通方法来使这个按钮消失。</p><p id="ac84" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">两个组件的<code class="fe ob oc od oe b">cq:dialog</code>节点树的大部分都标有<code class="fe ob oc od oe b">granite:InternalArea</code> mixin，表示<a class="ae lw" href="https://docs.adobe.com/content/help/en/experience-manager-64/deploying/upgrading/sustainable-upgrades.html" rel="noopener ugc nofollow" target="_blank">它们不可扩展，也不能被覆盖</a>。这也使得它们在CRXDE中显示为灰色:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi op"><img src="../Images/0cfe507b43d4deb01fead7d6c0059cd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*jbWTjV-nIw3K8NiIcyIuHQ.png"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">标有花岗岩的节点:内部混合</figcaption></figure><p id="51da" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">由于我们不能直接修改这些节点，我们将创建一个CSS clientlib来阻止按钮的呈现。</p><p id="218b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">创建类似于以下内容的节点结构:</p><pre class="kg kh ki kj gt of oe og oh aw oi bi"><span id="122d" class="np mp iq oe b gy oj ok l ol om"><strong class="oe ir">apps</strong><br/> \ — <strong class="oe ir">customization</strong> (nt:folder)<br/>     \ — <strong class="oe ir">clientlibs</strong> (nt:folder)<br/>         \ — <strong class="oe ir">restrict-asset-upload</strong> (cq:ClientLibraryFolder)<br/>             \ — <strong class="oe ir">css.txt</strong> (nt:file)<br/>             \ — <strong class="oe ir">css</strong> (nt:folder)<br/>                 \ — <strong class="oe ir">restrictAssetUpload.css</strong> (nt:file)</span></pre><p id="16c4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">将以下内容添加到<code class="fe ob oc od oe b">css.txt</code>:</p><pre class="kg kh ki kj gt of oe og oh aw oi bi"><span id="af8d" class="np mp iq oe b gy oj ok l ol om">#base=css</span><span id="1b87" class="np mp iq oe b gy oq ok l ol om">restrictAssetUpload.css</span></pre><p id="d5dd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以修改<code class="fe ob oc od oe b">restrictAssetUpload.css</code>的内容来实现我们的特性。下面的CSS将隐藏<em class="nl">上传</em>按钮:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="8b57" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，我们必须确保这个CSS加载了与表单编辑器相关联的其余clientlibs。</p><p id="ab03" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这两个组件的现有样式在<code class="fe ob oc od oe b">/libs/fd/af/authoring/clientlibs/granite/components/imageUploadStyles</code> clientlib中，clientlib属于<code class="fe ob oc od oe b">imageUpload</code>类别。为了同时加载我们的CSS，我们将把它放在同一个类别中，这样它就可以被AEM选中并与其他的stlyes合并。将以下属性添加到<code class="fe ob oc od oe b">restrict-asset-upload</code>节点:</p><pre class="kg kh ki kj gt of oe og oh aw oi bi"><span id="fab5" class="np mp iq oe b gy oj ok l ol om">categories — String[] — imageUpload</span></pre><p id="59f6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在重新加载您的AEM表单编辑器，并打开一个图像组件的配置侧面板，您应该会看到Upload按钮消失了。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/8b7ec18d142ab04a48330b41217d233c.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*qKBNoVwpL0_O9DobPTuarQ.png"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">不再上传按钮</figcaption></figure><p id="56f1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你会看到同样的图像选择。</p><p id="36b3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当然，这并不能阻止精通技术的用户在浏览器中检查DOM，删除<code class="fe ob oc od oe b">display: none;</code> CSS属性并点击上传按钮，但这是一个好的开始。如果您想更进一步，过程是一样的，只是您将创建一个JS clientlib，从DOM中删除Upload按钮。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="e213" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">AEM网站页面缩略图</h1><p id="fc59" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">允许用户从他们的机器上传文件的另一个时间是当他们为页面设置缩略图时。这不太引人注目，因为缩略图供内部使用，网站访问者通常无法访问。此外，页面继承其模板的缩略图，因此用户很少需要手动设置缩略图。</p><p id="dd09" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但是，如果您想删除该功能，可以按如下方式操作。</p><h2 id="439a" class="np mp iq bd mq nq nr dn mu ns nt dp my la nu nv na le nw nx nc li ny nz ne oa bi translated">选项1:对于特定的页面组件</h2><p id="b96f" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">在页面组件下创建以下节点结构:</p><p id="d25c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe ob oc od oe b"><strong class="kt ir">your-page-component</strong>/tabs/thumbnail/items/column/items/thumbnail</code></p><p id="84b4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后在该目录下，创建一个名为<code class="fe ob oc od oe b">upload</code>的<code class="fe ob oc od oe b">nt:unstructured</code>类型的节点，并赋予它以下属性:</p><pre class="kg kh ki kj gt of oe og oh aw oi bi"><span id="4d3a" class="np mp iq oe b gy oj ok l ol om">sling:hideResource  -  Boolean  -  true</span></pre><h2 id="5839" class="np mp iq bd mq nq nr dn mu ns nt dp my la nu nv na le nw nx nc li ny nz ne oa bi translated">选项2:全球</h2><p id="4b00" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">如果您更喜欢从所有页面中移除缩略图上传，而不管它们的页面类型或模板，您可以通过在<code class="fe ob oc od oe b">/apps/cq/gui/components/common/wcm/pagethumbnail/pagethumbnail.jsp</code>处覆盖文件并进行以下更改来移除按钮(代码请参见本文底部的GitHub repo):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/6d71e6a2037d4f9709b32ea3bec5de0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_rs3mDXI2GsxegDeBlo9mw.png"/></div></div></figure></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="ac92" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这就对了，您的JCR现在受到保护，不会受到“浮动”资产的影响！</p><p id="479e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要查看JSP修改的源代码，请前往本教程的GitHub repo。</p><p id="4c04" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你能想到任何其他用户不使用DAM就能上传图片(或任何资产)的例子，请在下面评论，我会在这篇文章中添加一个补丁:)</p></div></div>    
</body>
</html>