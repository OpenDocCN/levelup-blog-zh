<html>
<head>
<title>Fullstack Kafka</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">全栈卡夫卡</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/fullstack-kafka-e735054adcd6?source=collection_archive---------1-----------------------#2020-05-12">https://levelup.gitconnected.com/fullstack-kafka-e735054adcd6?source=collection_archive---------1-----------------------#2020-05-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/afef6796ce376f155c05f0403f5df82e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UzAvCpfSG3LN_2gztK79Sg.jpeg"/></div></div></figure><div class=""/><p id="0ee0" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用React、Websocket、Play for Scala、Kafka Streaming Platform和Cassandra构建一个完整的实时微服务应用</p><p id="1bce" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这篇文章是关于使用<a class="ae kz" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank"> React </a>、<a class="ae kz" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API" rel="noopener ugc nofollow" target="_blank"> Websocket </a>、<a class="ae kz" href="https://www.playframework.com/documentation/2.8.x/ScalaHome" rel="noopener ugc nofollow" target="_blank"> Play for Scala </a>、<a class="ae kz" href="https://akka.io/" rel="noopener ugc nofollow" target="_blank"> Akka </a>、<a class="ae kz" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Kafka </a>、<a class="ae kz" href="https://doc.akka.io/docs/alpakka-kafka/current/home.html" rel="noopener ugc nofollow" target="_blank"> Alpakka Kafka </a>和<a class="ae kz" href="https://cassandra.apache.org/" rel="noopener ugc nofollow" target="_blank"> Cassandra </a>等构建一个示例应用程序。</p><p id="a964" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将建立<strong class="kd jf">产品评论</strong>基于微服务的应用程序，这是电子商务业务的一小部分，人们可以对特定产品进行评论。我们的重点是评论，而不是产品或其他任何东西，所以我们的系统中只有一个产品，所有的评论都是针对这个产品的。</p><p id="20a0" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌By最后，在设计你的下一个基于Kafka的实时应用时，你至少应该有更多的想法或选择。</p><p id="1ffe" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌Let's首先看看应用程序是什么样子的…</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="fc40" class="lh li je bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">查看运行中的示例应用程序</h1><p id="732a" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">下面，您可以看到一个示例应用程序的视频。</p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="a901" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有问题的产品是科比·布莱恩特洛杉矶球衣。您可以查看当前的评论，并发布您的评论。在产品图片下有评论统计。</p><p id="fc53" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌This应用程序几乎是实时的。当您发布新的评论时，所有连接的用户都可以看到它以及更新的统计数据。</p><p id="e4ff" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它的工作方式很简单。你只需要填写你的名字和电子邮件，你选择一个评级，你说点什么，然后你就可以发表了。</p><p id="69a2" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果名称为空，将使用'<em class="mq"> Tom Dollars </em>'。</p><p id="4dde" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果电子邮件为空，将使用tomdollars@example.com的<em class="mq"/>。</p><p id="0719" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果内容为空，将使用<em class="mq">(无内容)</em>。</p><p id="df8f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你写了一个无效的电子邮件地址，安全检查将拒绝你的审查。</p><p id="29f4" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">就是这样！</p><p id="13e5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">代码由两部分托管在Github上:后端部分和前端部分。后端部分的<code class="fe mr ms mt mu b">README</code>将向您展示部署应用程序需要做的所有工作。如果需要，不要犹豫提出问题。</p><p id="5fd9" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">既然您已经知道了我们要构建什么，让我们从绘制解决方案的大图开始，这样我们就可以对正在发生的事情有一个更好的共同理解。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="f4ba" class="lh li je bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">整体情况</h1><p id="015b" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">下图显示了我们的工具如何组合在一起形成我们的架构:</p><figure class="mk ml mm mn gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mv"><img src="../Images/155de97a7a5efb5d468893fcaff324fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_B4EluZPaGpxp_ui7QRIzA.png"/></div></div></figure><p id="f252" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面的另一张图显示了消息如何驱动我们的系统:</p><figure class="mk ml mm mn gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mw"><img src="../Images/02bcef9bb67d7cd28ed7a19605ec26a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yj31UX5njs7RKg72IrAT6w.png"/></div></div></figure><p id="7b55" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">好吧，让我们来解释这一切。‌The系统的工作方式非常简单明了。</p><p id="ccc9" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当用户发布新的<code class="fe mr ms mt mu b">Review</code>，<code class="fe mr ms mt mu b">Webserver</code>通过其<code class="fe mr ms mt mu b">Kafka Producer</code>向卡夫卡发布两条消息:一条新的<code class="fe mr ms mt mu b">Task</code>消息和一条<code class="fe mr ms mt mu b">SecurityCheckRequested</code>消息。在这种情况下，安全检查是对电子邮件地址格式的简单验证。任务对象会有一个类似于<code class="fe mr ms mt mu b">PROCESSING</code>的状态，并通过一个<code class="fe mr ms mt mu b">Connector</code>存储在Cassandra中，这样前端就可以查询它，知道已经处理的评论创建是否完成。</p><p id="2b36" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌The <code class="fe mr ms mt mu b">Security</code>服务消费<code class="fe mr ms mt mu b">SecurityCheckRequested</code>消息并进行检查，然后发布<code class="fe mr ms mt mu b">SecurityCheckProcessed</code>消息。</p><p id="126f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌Note表示，<code class="fe mr ms mt mu b">Security</code>服务不会更新<code class="fe mr ms mt mu b">Review</code>对象，也不会发布关于<code class="fe mr ms mt mu b">reviews</code>主题的消息，它只会发布检查结果，并让正确的服务改变<code class="fe mr ms mt mu b">Review</code>对象。我们遵循<a class="ae kz" href="https://www.confluent.io/blog/build-services-backbone-events/" rel="noopener ugc nofollow" target="_blank">单作者原则</a>，该原则规定只有一个服务应该改变给定实体的状态，并且只有一个服务应该发布给定类型的消息。在我们的例子中，只有<code class="fe mr ms mt mu b">Reviews</code>服务可以更新<code class="fe mr ms mt mu b">Review</code>对象。</p><p id="1aa7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌The <code class="fe mr ms mt mu b">Reviews</code>服务消费<code class="fe mr ms mt mu b">SecurityCheckProcessed</code>消息。每个<code class="fe mr ms mt mu b">Review</code>都有一个<code class="fe mr ms mt mu b">status</code>场，可以是<code class="fe mr ms mt mu b">APPROVED</code>也可以是<code class="fe mr ms mt mu b">REJECTED</code>。<code class="fe mr ms mt mu b">Reviews</code>服务将根据安全检查结果更新<code class="fe mr ms mt mu b">Review</code>对象<code class="fe mr ms mt mu b">status</code>。然后<code class="fe mr ms mt mu b">Reviews</code>服务将再次根据安全检查结果向<code class="fe mr ms mt mu b">reviews-eventsource</code>主题发布<code class="fe mr ms mt mu b">ReviewApproved</code>或<code class="fe mr ms mt mu b">ReviewRejected</code>消息。</p><p id="3c15" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌The <code class="fe mr ms mt mu b">Reviews</code>服务消费来自<code class="fe mr ms mt mu b">reviews-eventsource</code>主题的<code class="fe mr ms mt mu b">ReviewApproved</code>和<code class="fe mr ms mt mu b">ReviewRejected</code>消息，然后将引用的<code class="fe mr ms mt mu b">Review</code>发布到<code class="fe mr ms mt mu b">reviews-changelog</code>主题，由<code class="fe mr ms mt mu b">Connector</code>消费并存储在<code class="fe mr ms mt mu b">Cassandra</code>中。注意，<code class="fe mr ms mt mu b">reviews-changelog</code>将存储<code class="fe mr ms mt mu b">APPROVED</code>和<code class="fe mr ms mt mu b">REJECTED</code>评论。没有人知道商业价值从何而来，所以最好保留一切。</p><p id="19ec" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后，‌The <code class="fe mr ms mt mu b">Reviews</code>服务会将从头创建的任务更新为<code class="fe mr ms mt mu b">DONE</code>，因此前端可以继续从<code class="fe mr ms mt mu b">Cassandra</code>检索结果。</p><p id="6ddf" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌The <code class="fe mr ms mt mu b">Statistics</code>服务消费<code class="fe mr ms mt mu b">ReviewApproved</code>消息，并将相应产品的<code class="fe mr ms mt mu b">ProductStatistic</code>更新发布到<code class="fe mr ms mt mu b">stats-changelog</code>主题。</p><p id="a4fa" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌whenever:<code class="fe mr ms mt mu b">tasks-changelog</code>、<code class="fe mr ms mt mu b">reviews-changelog</code>、<code class="fe mr ms mt mu b">stats-changelog</code>主题有更新，<code class="fe mr ms mt mu b">Datastax Sink Connector</code>会更新<code class="fe mr ms mt mu b">Cassandra</code>中相应的表格。</p><p id="dcae" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌When你在浏览器中启动应用程序，前端将通过<code class="fe mr ms mt mu b">Webserver</code>从Cassandra获取当前评论和当前统计数据。</p><p id="70f7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌There还剩下一个组件，我称之为<code class="fe mr ms mt mu b">The Killer</code>组件，它是<code class="fe mr ms mt mu b">Alpakka Kafka Connector</code>。它是<code class="fe mr ms mt mu b">Kafka</code>和<code class="fe mr ms mt mu b">Akka Streams</code>之间的桥梁。基本上，它允许您创建一个<code class="fe mr ms mt mu b">Akka Streams Source</code>，其中产生的价值实际上是从一个<code class="fe mr ms mt mu b">Kafka</code>主题中消费的。</p><p id="4f68" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当您在浏览器上启动应用程序时，将建立到<code class="fe mr ms mt mu b">Webserver</code>的两个<code class="fe mr ms mt mu b">Websocket</code>连接，一个用于获取新评论，另一个用于获取统计数据更新。在<code class="fe mr ms mt mu b">webserver</code>端，套接字处理程序将转发来自这些特殊源的所有消息，这正是使该应用程序实时的原因。消息一发布到<code class="fe mr ms mt mu b">reviews-changelog</code>和<code class="fe mr ms mt mu b">stats-changelog</code>主题，<code class="fe mr ms mt mu b">Socket</code>处理程序就会通过<code class="fe mr ms mt mu b">Alpakka Kafka</code>获取消息，并发送到前端显示。酷！</p><p id="9c97" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌That基本上就是应用程序的工作方式。如果你心中有疑问，你应该在文章的剩余部分或者在<a class="ae kz" href="https://github.com/acmoune/product-reviewer" rel="noopener ugc nofollow" target="_blank">代码库中</a>找到答案。</p><p id="d982" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌In:顶部的架构图，蓝色部分不是我们代码的一部分，我称之为基础设施。我们将从设置基础设施开始，即<code class="fe mr ms mt mu b">Kafka</code>和<code class="fe mr ms mt mu b">Cassandra</code>，这样我们就可以开始编写代码了。我们开始吧！</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="5cc9" class="lh li je bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">设置基础设施</h1><p id="a3a7" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">在本节中，我们将为我们的示例应用程序准备好Kafka和Cassandra。我们将假设您已经安装了这两个程序，并直接为我们的示例应用程序安装它们。我们个人在Kafka流媒体平台上使用了Ubuntu的<a class="ae kz" href="https://docs.confluent.io/current/installation/installing_cp/deb-ubuntu.html" rel="noopener ugc nofollow" target="_blank"> Confluent社区版，在Cassandra上使用了</a><a class="ae kz" href="https://hub.docker.com/_/cassandra" rel="noopener ugc nofollow" target="_blank">官方Cassandra Docker图片</a>，但也有其他选项。只看你觉得更舒服的那个。</p><h2 id="c844" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">卡夫卡</h2><p id="4a56" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">我们的应用程序将使用五个主题。您必须从<code class="fe mr ms mt mu b">KAFKA_HOME</code>运行以下所有命令。</p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><h2 id="2cdc" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">卡桑德拉</h2><p id="210c" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">设置很简单，只需运行下面的脚本。这将创建<code class="fe mr ms mt mu b">proreviewer</code> <code class="fe mr ms mt mu b">Keyspace</code>，并添加表<code class="fe mr ms mt mu b">reviews_by_product</code>、<code class="fe mr ms mt mu b">stats</code>和<code class="fe mr ms mt mu b">tasks</code>，并创建物化视图<code class="fe mr ms mt mu b">reviews</code>。</p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><h2 id="9ba2" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">数据接收连接器</h2><p id="12a4" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">请注意，该步骤应在设置<code class="fe mr ms mt mu b">Cassandra</code>后执行，因为<code class="fe mr ms mt mu b">Connector</code>将在其注册期间连接到<code class="fe mr ms mt mu b">Cassandra</code>。</p><p id="6d45" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们在分布式模式下使用Kafka Connect，但是您可以轻松地为独立模式调整配置。</p><p id="f0b8" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们的正文是‌below<code class="fe mr ms mt mu b">POST</code>请求:</p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="f8fa" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">调整这些值以匹配您的环境。</p><p id="4e85" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌Just把它发布到<code class="fe mr ms mt mu b">http://localhost:8083</code>(你的Kafka Connect API接口)，你就一切就绪了。在此之后，所有发布到观察主题的消息将触发Cassandra中映射表的插入或更新，一切都为您处理好了。</p><p id="f4fa" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌Now:我们的基础设施都准备好了，我们可以开始写代码了，我们将从我们的<code class="fe mr ms mt mu b">Microservices</code>开始。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="fbe1" class="lh li je bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">构建微服务</h1><p id="6866" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">我们将从安装所有依赖项开始。</p><h2 id="9574" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">安装所有依赖项</h2><p id="e48d" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">我们所有的<code class="fe mr ms mt mu b">Microservices</code>都是在<a class="ae kz" href="https://www.scala-lang.org/" rel="noopener ugc nofollow" target="_blank"> Scala </a>中开发的，我们使用<a class="ae kz" href="https://www.scala-sbt.org/" rel="noopener ugc nofollow" target="_blank"> sbt </a>来管理项目。</p><p id="a7f4" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/build.sbt</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="0837" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌ <code class="fe mr ms mt mu b">product-reviewer/project/plugins.sbt</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="f6d9" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这定义了五个项目:</p><ul class=""><li id="7fb8" class="nk nl je kd b ke kf ki kj km nm kq nn ku no ky np nq nr ns bi translated">公共(用于公共库)</li><li id="713f" class="nk nl je kd b ke nt ki nu km nv kq nw ku nx ky np nq nr ns bi translated">网络服务器</li><li id="66ec" class="nk nl je kd b ke nt ki nu km nv kq nw ku nx ky np nq nr ns bi translated">复习</li><li id="b62a" class="nk nl je kd b ke nt ki nu km nv kq nw ku nx ky np nq nr ns bi translated">安全</li><li id="645d" class="nk nl je kd b ke nt ki nu km nv kq nw ku nx ky np nq nr ns bi translated">统计数字</li></ul><p id="6539" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">除了普通项目，其他都映射到我们的<code class="fe mr ms mt mu b">Microservices</code>。</p><p id="ce66" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们的项目目录已经创建，所有的依赖项都已经下载，让我们开始编写实际的代码。‌</p><p id="9b65" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里不可能详细说明每个步骤，所以我会尽量展示重要的代码片段，希望它们能说服您查看<a class="ae kz" href="https://github.com/acmoune/product-reviewer" rel="noopener ugc nofollow" target="_blank"> Github库</a>上的完整代码。让我们从公共库开始。</p><h2 id="a786" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">公共图书馆</h2><p id="99cc" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">公共库中有两个重要的东西:Avro数据模型和接口的抽象实现。</p><p id="b345" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf"> Avro数据模型</strong></p><p id="c7f7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我选择在公共项目中创建Avro数据模型，这样所有的服务都可以使用它们。通过使它们成为一个共同的关注点，每一个模式变更都应该被所有团队批准或者至少注意到。如果你查看<code class="fe mr ms mt mu b">product-reviewer/common/src/main/avro/</code>，你会看到所有的Avro模式文件:</p><p id="349f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌ <code class="fe mr ms mt mu b">./task.avsc</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="13a8" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">./reviews/entities.Review.avsc</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="7087" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">./reviews/events/ReviewApproved.avsc</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="19d1" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">./reviews/events/ReviewRejected.avsc</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="9df8" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">./security/events/SecurityCheckRequested.avsc</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="ea3c" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">./security/events/SecurityCheckProcessed.avsc</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="8897" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">./statistics/entities/ProductStatistic.avsc</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="e107" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以使用<a class="ae kz" href="https://github.com/sbt/sbt-avro" rel="noopener ugc nofollow" target="_blank"> sbt-avro </a>插件来生成<code class="fe mr ms mt mu b">Avro</code>特定记录的Java类。</p><p id="b328" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌ <strong class="kd jf">后台程序接口</strong></p><p id="d50a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在公共项目中，您还会发现<code class="fe mr ms mt mu b">org.apache.commons.daemon.Daemon</code>接口的抽象实现。我们所有的<code class="fe mr ms mt mu b">Kafka Streams</code>应用程序都将扩展那个抽象实现，所以如果你想的话，它们可以作为守护进程运行，使用<a class="ae kz" href="http://commons.apache.org/proper/commons-daemon/jsvc.html" rel="noopener ugc nofollow" target="_blank"> jsvc </a>，但是为了简单起见，当<code class="fe mr ms mt mu b">Dockerizing</code>我们的示例应用程序时，我们将不使用<code class="fe mr ms mt mu b">jsvc</code>。</p><p id="03dd" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌Let's移动到我们的流处理服务:<code class="fe mr ms mt mu b">Security</code>、<code class="fe mr ms mt mu b">Reviews</code>和<code class="fe mr ms mt mu b">Statistics</code>服务。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="35e3" class="lh li je bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">流处理服务</h1><p id="c42b" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated"><code class="fe mr ms mt mu b">Security</code>、<code class="fe mr ms mt mu b">Reviews</code>和<code class="fe mr ms mt mu b">Statistics</code>服务是<code class="fe mr ms mt mu b">Kafka Streams</code>应用。因此，我将只向您展示他们的流拓扑代码。你可以在<a class="ae kz" href="https://github.com/acmoune/product-reviewer" rel="noopener ugc nofollow" target="_blank">代码库</a>上看到他们的完整代码。</p><h2 id="53d5" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">安全服务流拓扑</h2><p id="f826" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/security/src/main/scala/SecurityApp.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="f2ad" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">应用程序简单地使用来自<code class="fe mr ms mt mu b">security-eventsource</code>主题的所有<code class="fe mr ms mt mu b">SecurityCheckRequested</code>事件，执行检查，然后发布一个仍然在<code class="fe mr ms mt mu b">security-eventsource</code>主题中的<code class="fe mr ms mt mu b">SecurityCheckProcessed</code>事件。</p><p id="7848" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌Let's搬到了<code class="fe mr ms mt mu b">Reviews</code>服务区。</p><h2 id="c185" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">‌Reviews服务流拓扑</h2><p id="93cd" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/reviews/src/main/scala/ReviewsApp.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="13c2" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">应用程序首先使用来自<code class="fe mr ms mt mu b">security-eventsource</code>主题的所有<code class="fe mr ms mt mu b">SecurityCheckProcessed</code>事件，并使用<code class="fe mr ms mt mu b">branch</code>处理器，创建两个<code class="fe mr ms mt mu b">KStream</code>，一个用于<code class="fe mr ms mt mu b">VALID</code>评论，另一个用于<code class="fe mr ms mt mu b">INVALID</code>评论。</p><p id="e12d" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌On的<code class="fe mr ms mt mu b">VALID</code>分支，将<code class="fe mr ms mt mu b">SecurituCheckProcessed</code>数据模型映射到<code class="fe mr ms mt mu b">ReviewApproved</code>数据模型，并发布到<code class="fe mr ms mt mu b">reviews-eventsource</code>主题。</p><p id="e33e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌On的<code class="fe mr ms mt mu b">INVALID</code>分支，将<code class="fe mr ms mt mu b">SecurituCheckProcessed</code>数据模型映射到<code class="fe mr ms mt mu b">ReviewRejected</code>数据模型，并发布到r <code class="fe mr ms mt mu b">eviews-eventsource</code>主题。</p><p id="5139" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">应用程序还使用来自<code class="fe mr ms mt mu b">reviews-eventsource </code>主题的所有<code class="fe mr ms mt mu b">ReviewRejected</code>和<code class="fe mr ms mt mu b">ReviewApproved</code>事件，将它们映射到一个<code class="fe mr ms mt mu b">Review</code>实体，并将该实体发布到<code class="fe mr ms mt mu b">reviews-changelog</code>主题。</p><p id="3ba6" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌The应用程序也消耗了<code class="fe mr ms mt mu b">tasks-changelog</code>主题作为<code class="fe mr ms mt mu b">table</code>，并在<code class="fe mr ms mt mu b">SecurityCheckProcessed</code> <code class="fe mr ms mt mu b">KStream</code>和<code class="fe mr ms mt mu b">Task</code> <code class="fe mr ms mt mu b">KTable</code>之间执行一个<code class="fe mr ms mt mu b">KStream to KTable join</code>，然后使用我们的<code class="fe mr ms mt mu b">taskJoiner</code>，它将<code class="fe mr ms mt mu b">SecurityCheckProcessed's</code>对应的<code class="fe mr ms mt mu b">Task</code>设置为<code class="fe mr ms mt mu b">DONE</code>，并将更新后的<code class="fe mr ms mt mu b">Task</code>发布到<code class="fe mr ms mt mu b">tasks-changelog</code>主题。</p><p id="11ef" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌That基本上就是了。让我们转到<code class="fe mr ms mt mu b">Statistics</code>服务。</p><h2 id="2923" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">‌Statistics服务流拓扑</h2><p id="9930" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/statistics/src/main/scala/StatisticsApp.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="42ca" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该应用程序简单地使用来自<code class="fe mr ms mt mu b">reviews-eventsource</code>主题的<code class="fe mr ms mt mu b">ReviewApproved</code>事件，然后将<code class="fe mr ms mt mu b">key</code>设置为<code class="fe mr ms mt mu b">product_id</code>，因此给定产品的所有评论都将是同一个分区，然后通过新的<code class="fe mr ms mt mu b">product_id</code>键聚集评论。</p><p id="4781" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌ <code class="fe mr ms mt mu b">aggregate</code>是一个全状态处理器，它使用一个<code class="fe mr ms mt mu b">state store</code>，由一个<code class="fe mr ms mt mu b">Kafka topic</code>支持，来保存之前的聚合值。</p><p id="864e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌Our <code class="fe mr ms mt mu b">Aggregator</code> simple基于之前的统计数据和<code class="fe mr ms mt mu b">ReviewApproved</code>数据模型生成一个新的<code class="fe mr ms mt mu b">ProductStatistic</code>数据模型，并将其发布为对<code class="fe mr ms mt mu b">stats-changelog</code>主题的更新。</p><p id="3494" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌Let's移动到我们的最后一个发球点<code class="fe mr ms mt mu b">Web Server</code></p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="254f" class="lh li je bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">Web服务器服务</h1><p id="aba2" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">网络服务器服务是一个<code class="fe mr ms mt mu b">Play for Scala</code>应用程序。它包含<code class="fe mr ms mt mu b">Models</code>、<code class="fe mr ms mt mu b">Controllers</code>、<code class="fe mr ms mt mu b">Repositories</code>、<code class="fe mr ms mt mu b">Services</code>和<code class="fe mr ms mt mu b">Sources</code>。让我们从模型开始，因为它们在任何地方都被使用。</p><h2 id="aac4" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">‌Models</h2><p id="893a" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">我们之前描述的<code class="fe mr ms mt mu b">Avro</code>数据模型被创建为<code class="fe mr ms mt mu b">Avro</code>进行序列化和反序列化。本节中的模型用于以<code class="fe mr ms mt mu b">JSON</code>格式向<code class="fe mr ms mt mu b">Frontend</code>发送数据。我们可能很难直接使用<code class="fe mr ms mt mu b">Avro</code>数据模型，但是使用本节中的模型更方便，特别是在<code class="fe mr ms mt mu b">Scala</code>透视图中。</p><p id="df17" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">那些模型的‌Some扩展了<code class="fe mr ms mt mu b">DomainModel</code>特征，它简单地定义了一个<code class="fe mr ms mt mu b">toDataModel</code>方法。</p><p id="db22" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌ <strong class="kd jf">任务</strong></p><p id="58a7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/webserver/app/models/data/Task.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="44f9" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">回顾</strong></p><p id="cd59" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/webserver/app/models/data/Review.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="6ab0" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">产品统计</strong></p><p id="6f02" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/webserver/app/models/data/ProductStatistic.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="25ee" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">作为模型的一部分，我们还定义了消息协议，即服务接收的事件和查询。</p><p id="0a0f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf"> ‌Messages议定书</strong></p><p id="c207" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/webserver/app/models/protocol/Messages.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="8a5b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在让我们转到我们的单一存储库:<code class="fe mr ms mt mu b">ReviewRepo</code></p><h2 id="2855" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">‌Repositories</h2><p id="374d" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated"><strong class="kd jf">评论库</strong></p><p id="be00" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">那个存储库是我们的数据访问对象，从<code class="fe mr ms mt mu b">Cassandra</code>获取我们需要的一切，它是一个<code class="fe mr ms mt mu b">Akka Actor.</code></p><p id="5779" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌ <code class="fe mr ms mt mu b">product-reviewer/webserver/app/repositories/ReviewRepo.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="543a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们转到我们的单一服务，即<code class="fe mr ms mt mu b">ReviewManager</code></p><h2 id="80a4" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">服务</h2><p id="1123" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated"><strong class="kd jf">审查经理</strong></p><p id="2cc4" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">也是Akka演员。</p><p id="5894" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌ <code class="fe mr ms mt mu b">product-reviewer/webserver/app/services/ReviewManager.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="95af" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">基本上，当它接收到来自我们<code class="fe mr ms mt mu b">Messages</code>协议的<code class="fe mr ms mt mu b">SecurityCheckRequested</code>消息时，它向<code class="fe mr ms mt mu b">security-eventsource</code>主题发布一个<code class="fe mr ms mt mu b">Avro</code> <code class="fe mr ms mt mu b">SecurityCheckResquested</code>数据模型，向<code class="fe mr ms mt mu b">tasks-changelog</code>主题发布一个具有<code class="fe mr ms mt mu b">PROCESSING</code>状态的<code class="fe mr ms mt mu b">Avro</code> <code class="fe mr ms mt mu b">Task</code>实体，然后它将任务返回给<code class="fe mr ms mt mu b">Frontend</code>，因此它可以跟踪Cassandra上的任务状态。</p><p id="bcc0" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌It还会将所有问题转发给<code class="fe mr ms mt mu b">ReviewRepo</code>演员。</p><p id="be26" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们转到我们的来源。</p><h2 id="d5e0" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">来源</h2><p id="c0c7" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">你应该想知道我所谓的来源。如果你还记得我们关于<code class="fe mr ms mt mu b">Alpakka Kafka</code>讨论，这里的一个来源是从一个卡夫卡主题生成信息的特殊<code class="fe mr ms mt mu b">Akka Streams Source</code>。我在我们的游戏应用程序中让他们成为一等公民，就像模型或控制器一样。我们将有两个来源，一个用于评论，一个用于产品统计。</p><p id="a12c" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">评论来源</strong></p><p id="2645" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/webserver/app/sources/ReviewsSource.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="0d21" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">产品统计数据来源</strong></p><p id="9454" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/webserver/app/sources/ProductStatsSource.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="5a7d" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这些资源将在套接字处理程序中使用，以便向<code class="fe mr ms mt mu b">Frontend</code>发送可用的评论和统计数据，从而使我们的应用程序成为实时应用程序。</p><h2 id="7501" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">‌Controllers</h2><p id="cb14" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated"><strong class="kd jf">查看控制器</strong></p><p id="5189" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/webserver/app/controllers/ReviewController.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="8ec5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">任务控制器</strong></p><p id="8aec" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer/webserver/app/controllers/TaskController.scala</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><h2 id="0f26" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">路线</h2><p id="51a1" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">我们最后来看一下<code class="fe mr ms mt mu b">routes</code>文件</p><p id="76d6" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌ <code class="fe mr ms mt mu b">product-reviewer/webserver/conf/routes</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="c59a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们已经涵盖了来自<code class="fe mr ms mt mu b">webserver</code>服务的所有主要代码，这就结束了我们对<code class="fe mr ms mt mu b">Microservices</code>的覆盖。让我们转移到<code class="fe mr ms mt mu b">Frontend</code>。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="8d90" class="lh li je bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">前端应用程序</h1><p id="5ed6" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">我们的<code class="fe mr ms mt mu b">frontend</code>以<code class="fe mr ms mt mu b">React</code>、<code class="fe mr ms mt mu b">TypeScript</code>、<code class="fe mr ms mt mu b">NodeJS</code>、<code class="fe mr ms mt mu b">NextJS</code>为基础，使用<code class="fe mr ms mt mu b">React Context</code>进行状态管理。我们的<code class="fe mr ms mt mu b">frontend</code>最重要的方面是数据或状态管理。您可以在我们的示例应用程序的<a class="ae kz" href="https://github.com/acmoune/product-reviewer-client" rel="noopener ugc nofollow" target="_blank">前端</a>存储库中看到完整的代码。我们先来看看发布新评论是如何处理的。</p><h2 id="d909" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">发布新评论</h2><p id="5c31" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer-client/components/ReviewForm.tsx</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="eb15" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在第17行，我们执行实际的<code class="fe mr ms mt mu b">POST</code>，并从我们的<code class="fe mr ms mt mu b">webserver</code> <code class="fe mr ms mt mu b">Microservice</code>接收由<code class="fe mr ms mt mu b">ReviewManager</code>创建的<code class="fe mr ms mt mu b">Task</code>。</p><p id="94af" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌The <code class="fe mr ms mt mu b">pollUntilTaskFinished</code>函数(如下图所示)将尝试从<code class="fe mr ms mt mu b">Cassandra</code>获取每个<code class="fe mr ms mt mu b">500ms</code>的任务，并检查是<code class="fe mr ms mt mu b">DONE</code>还是静止的<code class="fe mr ms mt mu b">PROCESSING</code>，最多尝试60次。</p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="a082" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">60 * 500ms = 30 seconds</code>。因此，我们基本上给我们的<code class="fe mr ms mt mu b">backend</code>基础设施30秒来完成这个过程，之后我们将发出一个超时错误。</p><p id="9433" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们的<code class="fe mr ms mt mu b">POST</code>返回的‌The任务包含一个<code class="fe mr ms mt mu b">resourceId</code>，它是我们新创建的评论的ID。我们在回调中使用该ID从Cassandra获取评论，并将其提供给<code class="fe mr ms mt mu b">frontend</code>。</p><p id="03d0" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌Now:让我们看看评论和统计数据更新是如何获取的。</p><h2 id="24c3" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">评论和统计数据更新的初始加载</h2><p id="5bee" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated"><strong class="kd jf">数据提供器组件</strong></p><p id="4af8" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们定义了一个包装了一个<code class="fe mr ms mt mu b">DataContext</code>的<code class="fe mr ms mt mu b">DataProvider</code>组件来保存我们的评论和统计数据:</p><p id="c989" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer-client/data/DataProdiver.tsx</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="0155" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">索引页</strong></p><p id="d699" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面你可以看到当我们的索引页面加载时数据是如何获取的</p><p id="8c9b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer-client/pages/index.tsx</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="7380" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">fetchReviews</code>和<code class="fe mr ms mt mu b">fetchStats</code>方法获取所有数据并更新上下文。</p><p id="0241" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌Still:在索引页面上，你可以看到<code class="fe mr ms mt mu b">SocketProvider</code>，用于获取新的评论和产品统计数据更新。我们来看看。</p><h2 id="bf9c" class="mx li je bd lj my mz dn ln na nb dp lr km nc nd lv kq ne nf lz ku ng nh md ni bi translated">实时评论和产品统计数据更新负载</h2><p id="9167" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">我们定义了一个包装了一个<code class="fe mr ms mt mu b">SocketContext</code>的<code class="fe mr ms mt mu b">SocketProvider</code>，以使套接字连接对需要它的组件可用。</p><p id="9544" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">socket provider组件</strong></p><p id="e118" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer-client/data/SocketProvider.tsx</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="8c85" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果连接关闭，该组件将自动尝试重新连接多达10次，使其永久。</p><p id="6a0d" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">实时评论</strong></p><p id="3b03" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">就像您在<code class="fe mr ms mt mu b">IndexPage</code>中看到的那样，<code class="fe mr ms mt mu b">ReviewsList</code>组件使用套接字连接来实时检索评论，并将它们添加到<code class="fe mr ms mt mu b">DataContext</code>:</p><p id="724b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer-client/pages/index.tsx</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="228f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer-client/components/ReviewsList.tsx</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="1dff" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">实时产品统计数据更新</strong></p><p id="56af" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe mr ms mt mu b">Product</code>组件中，您还可以看到为<code class="fe mr ms mt mu b">Stats</code>组件提供了一个套接字连接来实时获取产品统计数据更新:</p><p id="dc0f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer-client/components/Product.tsx</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="c2b0" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">product-reviewer-client/components/Stats.tsx</code></p><figure class="mk ml mm mn gt iv"><div class="bz fp l di"><div class="nj mp l"/></div></figure><p id="83bc" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌We在我们的<code class="fe mr ms mt mu b">frontend</code>中介绍了数据管理的所有重要方面，这也结束了我们对<code class="fe mr ms mt mu b">Frontend</code>应用程序的介绍。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="503a" class="lh li je bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">部署</h1><p id="a41d" class="pw-post-body-paragraph kb kc je kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">我们的示例应用程序是使用Docker部署的。您将在<a class="ae kz" href="https://github.com/acmoune/product-reviewer" rel="noopener ugc nofollow" target="_blank">代码库</a>自述文件中找到所有说明。</p><p id="c7a5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">‌I希望你喜欢这个职位。</p></div></div>    
</body>
</html>