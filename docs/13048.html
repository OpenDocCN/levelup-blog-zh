<html>
<head>
<title>Implementing JSON-RPC in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python实现JSON-RPC</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/implementing-json-rpc-in-python-6ff3ff84cb45?source=collection_archive---------3-----------------------#2022-08-03">https://levelup.gitconnected.com/implementing-json-rpc-in-python-6ff3ff84cb45?source=collection_archive---------3-----------------------#2022-08-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="3d63" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">了解如何使用HTTP和WebSockets实现JSON-RPC</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/f32e742a238a9bf8adb39798049d5f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g-p1KH74IH0w_0AJ"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">照片由<a class="ae le" href="https://unsplash.com/@hishahadat?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">沙哈达特·拉赫曼</a>在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="833e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">大多数全栈开发人员都熟悉web服务的概念及其架构风格，尤其是REST APIs。除了REST APIs，另一种同样常见的架构风格是JSON-RPC。</p><p id="ffeb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我将解释JSON-RPC是什么，它与REST相比如何，更重要的是，如何使用Python实现它。我将向您展示JSON-RPC的两个特定实现——第一个使用HTTP实现，第二个使用WebSockets实现。</p><h1 id="517f" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">什么是JSON-RPC</h1><p id="3dd8" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated"><strong class="js iu"> JSON-RPC </strong>是一个使用JSON进行编码的远程过程协议。如果您熟悉REST APIs，您会知道为了让客户机与服务器通信，它使用HTTP动词来表明其意图:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mi"><img src="../Images/1ade89b690e31e7f34890ce81e700831.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ANdkfXweavbBkKn7e5JoPA.png"/></div></div></figure><p id="b8f1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，您想通过REST API向服务器添加一个新项目。在这种情况下，您可以使用PUT或POST动词来指示此操作。同样，如果您想从服务器检索一些值，您可以使用GET动词。作为回报，REST API将以JSON或XML字符串的形式返回结果。</p><p id="44d4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">JSON-RPC的工作方式与REST APIs非常相似——JSON-RPC可以使用HTTP或WebSockets来实现。但是在JSON-RPC中，您不必使用HTTP动词来指示您想要的动作。相反，您只需在服务器端调用您想要调用的函数:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mj"><img src="../Images/e10ad76362d437e853331571dea01b9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w6NQUXL3Q5kiQcbCz1PpOg.png"/></div></div></figure><p id="6ba5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">向JSON-RPC服务器发出的请求由三个成员组成:</p><ul class=""><li id="2a6c" class="mk ml it js b jt ju jx jy kb mm kf mn kj mo kn mp mq mr ms bi translated"><code class="fe mt mu mv mw b"><strong class="js iu">method</strong></code> —要在服务器上调用的函数的名称</li><li id="e8bd" class="mk ml it js b jt mx jx my kb mz kf na kj nb kn mp mq mr ms bi translated"><code class="fe mt mu mv mw b"><strong class="js iu">params</strong></code> <strong class="js iu"> </strong> —要传递给正在调用的函数中的参数的自变量</li><li id="e3a7" class="mk ml it js b jt mx jx my kb mz kf na kj nb kn mp mq mr ms bi translated"><code class="fe mt mu mv mw b"><strong class="js iu">id</strong></code> —服务器回复时参考的字符串或数字</li></ul><p id="e2c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">服务器在调用被调用的函数时，将在JSON中返回包含以下内容的结果:</p><ul class=""><li id="3756" class="mk ml it js b jt ju jx jy kb mm kf mn kj mo kn mp mq mr ms bi translated"><code class="fe mt mu mv mw b"><strong class="js iu">result</strong></code> <strong class="js iu"> / </strong> <code class="fe mt mu mv mw b"><strong class="js iu">error</strong></code> —要么是方法执行的结果，要么是调用函数出错时的错误</li><li id="1302" class="mk ml it js b jt mx jx my kb mz kf na kj nb kn mp mq mr ms bi translated"><code class="fe mt mu mv mw b"><strong class="js iu">id</strong></code> —对应于服务器正在响应的请求的字符串或数字</li></ul><p id="7e49" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下图总结了上述组件:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nc"><img src="../Images/00f5b6e6e7d547d952ac88443364e3f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dsuldZp-oVJVVyaq0r07mQ.png"/></div></div></figure><p id="086c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，在有些情况下，客户端只是想向服务器发送消息，而不要求服务器返回结果。这被称为<em class="nd">通知</em>。在通知的情况下，<strong class="js iu"> id </strong>组件不需要出现。</p><p id="53e1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有关JSON-RPC的更多细节，请查看最新的2.0规范:</p><div class="ne nf gp gr ng nh"><a href="https://www.jsonrpc.org/specification" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd iu gy z fp nm fr fs nn fu fw is bi translated">JSON-RPC 2.0规范</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">起源日期:2010–03–26(基于2009–05–24版本)JSON-RPC是一个无状态的轻量级远程过程调用…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">www.jsonrpc.org</p></div></div></div></a></div><h1 id="c038" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">使用HTTP实现JSON-RPC</h1><p id="0b42" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">既然您已经对什么是JSON-RPC有了更清晰的概念，那么现在是时候自己实现一个JSON-RPC了。我们将首先使用HTTP实现一个。</p><h2 id="59a7" class="nq lg it bd lh nr ns dn ll nt nu dp lp kb nv nw lt kf nx ny lx kj nz oa mb ob bi translated">使用jsonrpcserver实现服务器</h2><p id="d7a7" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">为了帮助我们实现JSON-RPC服务，我们将使用<strong class="js iu"> jsonrpcserver </strong>模块:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="6137" class="nq lg it mw b gy og oh l oi oj">$ pip install jsonrpcserver</span></pre><p id="75f2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个名为<strong class="js iu"> server.py </strong>的新文件，并用以下内容填充它:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="d57a" class="nq lg it mw b gy og oh l oi oj">from jsonrpcserver import Success, method, serve, <br/>    InvalidParams, Result, Error<br/>import re</span><span id="9204" class="nq lg it mw b gy ok oh l oi oj">@method<a class="ae le" href="http://twitter.com/method" rel="noopener ugc nofollow" target="_blank"><br/></a>def validEmail(email) -&gt; Result:    <br/>    if email == "":<br/>        return Error(code=123, message="Empty email provided")<br/>    if re.match("^[a-zA-Z0-9-_]+@[a-zA-Z0-9]+\.[a-z]{1,3}$", email):    <br/>        return Success(True)<br/>    else:<br/>        return Success(False)</span><span id="c127" class="nq lg it mw b gy ok oh l oi oj">@method<br/>def validZipCode(zip) -&gt; Result: <br/>    if zip == "":<br/>        return InvalidParams("Null value")<br/>    if re.match("^[0-9]{5}(?:-[0-9]{4})?$", zip):<br/>        result = { "zip": zip, "result" : "Valid Zipcode" }<br/>    else:<br/>        result = { "zip": zip, "result" : "Invalid Zipcode" }<br/>    return Success(result)</span><span id="686f" class="nq lg it mw b gy ok oh l oi oj">if __name__ == "__main__":<br/>    serve('localhost', 5001)</span></pre><p id="d796" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在上面的代码片段中，我:</p><ul class=""><li id="f881" class="mk ml it js b jt ju jx jy kb mm kf mn kj mo kn mp mq mr ms bi translated">实现了两个函数(在JSON-RPC中称为<em class="nd">过程</em>)—<code class="fe mt mu mv mw b">validEmail()</code>和<code class="fe mt mu mv mw b">validZipCode()</code>。</li><li id="6492" class="mk ml it js b jt mx jx my kb mz kf na kj nb kn mp mq mr ms bi translated">这些函数中的每一个都接受一个参数(如果需要，可以接受多个参数)并产生一个<code class="fe mt mu mv mw b">Result</code>对象。</li><li id="ec20" class="mk ml it js b jt mx jx my kb mz kf na kj nb kn mp mq mr ms bi translated">这两个函数使用正则表达式来验证电子邮件和邮政编码。</li><li id="0cd6" class="mk ml it js b jt mx jx my kb mz kf na kj nb kn mp mq mr ms bi translated">为了将结果返回给客户端，函数可以返回一个<code class="fe mt mu mv mw b">Success</code>、<code class="fe mt mu mv mw b">Error</code>或<code class="fe mt mu mv mw b">InvalidParams</code>对象。<code class="fe mt mu mv mw b">Error</code>对象允许您指定自己的应用程序定义的错误代码和消息。<code class="fe mt mu mv mw b">InvalidParams</code>对象是<code class="fe mt mu mv mw b">Error</code>对象的快捷方式，通常在您想要通知客户端发送的参数无效(例如超出范围)时使用。例如，如果<code class="fe mt mu mv mw b">validZipCode()</code>函数收到一个空的邮政编码，而不是说:</li></ul><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="3a3f" class="nq lg it mw b gy og oh l oi oj">return Error(-32602, "Invalid params", "Null value")</span></pre><p id="0697" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以简单地使用<code class="fe mt mu mv mw b">InvalidParams</code>对象:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="5544" class="nq lg it mw b gy og oh l oi oj">return InvalidParams("Null value")</span></pre><blockquote class="ol om on"><p id="5d58" class="jq jr nd js b jt ju jv jw jx jy jz ka oo kc kd ke op kg kh ki oq kk kl km kn im bi translated">推荐的JSON-RPC错误代码列表可以从<a class="ae le" href="https://www.jsonrpc.org/specification" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> JSON-RPC 2.0规范</strong> </a> <strong class="js iu">中找到。</strong></p></blockquote><ul class=""><li id="7b83" class="mk ml it js b jt ju jx jy kb mm kf mn kj mo kn mp mq mr ms bi translated">函数返回的结果使用JSON自动编码。</li><li id="3fa3" class="mk ml it js b jt mx jx my kb mz kf na kj nb kn mp mq mr ms bi translated">最后，该服务侦听本地计算机上的端口5001。</li></ul><h2 id="72d2" class="nq lg it bd lh nr ns dn ll nt nu dp lp kb nv nw lt kf nx ny lx kj nz oa mb ob bi translated">测试服务器</h2><p id="35e9" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">要测试服务器，请在终端中运行应用程序:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="6d72" class="nq lg it mw b gy og oh l oi oj">$ <strong class="mw iu">python server.py</strong></span></pre><p id="9d91" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">测试服务最直接的方法是使用<strong class="js iu"> curl </strong>:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="a8e7" class="nq lg it mw b gy og oh l oi oj">$ <strong class="mw iu">curl -X POST http://localhost:5001 -d '{"jsonrpc": "2.0", "method": "validEmail", "params": {"email": ""}, "id": 1}'</strong></span></pre><p id="1a1f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的命令调用<code class="fe mt mu mv mw b">validEmail()</code>函数，并为<code class="fe mt mu mv mw b">email</code>参数传递一个空字符串。服务器的响应是:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="6e78" class="nq lg it mw b gy og oh l oi oj">{"jsonrpc": "2.0", "error": {"code": 123, "message": "Empty email provided"}, "id": 1}</span></pre><p id="2643" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在让我们尝试发送一封有效的电子邮件:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="f058" class="nq lg it mw b gy og oh l oi oj">$ curl -X POST http://localhost:5001 -d '{"jsonrpc": "2.0", "method": "validEmail", "params": <strong class="mw iu">{"email": "weimenglee@gmail.com"}</strong>, "id": 1}'</span></pre><p id="2e5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">回应是:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="f57c" class="nq lg it mw b gy og oh l oi oj">{"jsonrpc": "2.0", "result": true, "id": 1}</span></pre><p id="cc26" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你试图用错误的参数名调用<code class="fe mt mu mv mw b">validEmail()</code>函数:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="22f4" class="nq lg it mw b gy og oh l oi oj">curl -X POST http://localhost:5001 -d '{"jsonrpc": "2.0", "method": "<strong class="mw iu">validEmail</strong>", "params": {"<strong class="mw iu">zip</strong>": "weimenglee@gmail"}, "id": 1}'</span></pre><p id="2f9c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您将得到<em class="nd">无效参数</em>错误:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="07e1" class="nq lg it mw b gy og oh l oi oj">{"jsonrpc": "2.0", "error": {"code": -32602, "message": "Invalid params", "data": "missing a required argument: 'email'"}, "id": 1}</span></pre><p id="cdda" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">同样，如果您调用<code class="fe mt mu mv mw b">validZipCode()</code>函数并为<code class="fe mt mu mv mw b">zip</code>参数发送一个空值:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="2ca5" class="nq lg it mw b gy og oh l oi oj">curl -X POST http://localhost:5001 -d '{"jsonrpc": "2.0", "method": "validZipCode", "params": {"zip": ""}, "id": 1}'</span></pre><p id="d644" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您将得到<em class="nd">无效参数</em>错误，但是在<code class="fe mt mu mv mw b">data</code>中有自定义错误消息:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="4cd0" class="nq lg it mw b gy og oh l oi oj">{"jsonrpc": "2.0", "error": {"code": -32602, "message": "Invalid params", <strong class="mw iu">"data": "Null value"</strong>}, "id": 1}</span></pre><h2 id="12d2" class="nq lg it bd lh nr ns dn ll nt nu dp lp kb nv nw lt kf nx ny lx kj nz oa mb ob bi translated">使用jsonrpclib实现客户端</h2><p id="12b1" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">显然，使用<em class="nd"> curl </em>进行测试仅用于开发阶段。在生产中，您需要编写一个客户端应用程序来调用服务器中的函数。为此，您可以使用<strong class="js iu"> jsonrpclib </strong>模块:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="f1b3" class="nq lg it mw b gy og oh l oi oj">$ pip install jsonrpclib</span></pre><p id="50c8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦模块安装完毕，创建一个名为<strong class="js iu"> client.py </strong>的新文件，并在其中填入以下内容:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="f27d" class="nq lg it mw b gy og oh l oi oj">from jsonrpclib import Server<br/>import sys</span><span id="4377" class="nq lg it mw b gy ok oh l oi oj">def main():<br/>    server = Server('<a class="ae le" href="http://localhost:5001'" rel="noopener ugc nofollow" target="_blank">http://localhost:5001'</a>)<br/>    try:<br/>        print(server.validEmail("<a class="ae le" href="mailto:weimenglee@gmail.com" rel="noopener ugc nofollow" target="_blank">weimenglee@gmail.com</a>"))<br/>        print(server.validZipCode("12345"))<br/>    except:<br/>        print("Error: ", sys.exc_info())</span><span id="3482" class="nq lg it mw b gy ok oh l oi oj">if __name__ == '__main__':<br/>    main()</span></pre><p id="4cbe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的代码连接到服务器的端口5001。然后它远程调用<code class="fe mt mu mv mw b">validEmail()</code>和<code class="fe mt mu mv mw b">validZipCode()</code>函数。</p><p id="5dae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要运行客户端，请在终端中键入以下命令:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="a8c6" class="nq lg it mw b gy og oh l oi oj">$ <strong class="mw iu">python client.py</strong></span></pre><p id="b3fc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您应该会看到以下输出:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="43ca" class="nq lg it mw b gy og oh l oi oj">True<br/>{'zip': '12345', 'result': 'Valid Zipcode'}</span></pre><h1 id="3901" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">使用WebSockets实现JSON-RPC</h1><p id="21b7" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">现在我们已经使用HTTP实现了一个JSON-RPC服务，是时候看看如何使用<strong class="js iu"> WebSockets </strong>实现它了。</p><blockquote class="ol om on"><p id="15c6" class="jq jr nd js b jt ju jv jw jx jy jz ka oo kc kd ke op kg kh ki oq kk kl km kn im bi translated">WebSocket是一种通信协议，通过单一TCP连接提供全双工通信通道。</p></blockquote><h2 id="d18e" class="nq lg it bd lh nr ns dn ll nt nu dp lp kb nv nw lt kf nx ny lx kj nz oa mb ob bi translated">使用jsonrpcserver实现服务器</h2><p id="0f8d" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">我们将使用与我们之前在当前WebSockets实现中使用的相同的<strong class="js iu"> jsonrpcserver </strong>模块。</p><p id="5911" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个名为<strong class="js iu"> server_ws.py </strong>的文件，并用以下内容填充它:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="9e21" class="nq lg it mw b gy og oh l oi oj">from jsonrpcserver import method, Success, Result, Error, <br/>    InvalidParams, async_dispatch<br/>import websockets<br/>import asyncio<br/>import re</span><span id="f7e8" class="nq lg it mw b gy ok oh l oi oj">@method<br/>async def validEmail(email) -&gt; Result:<br/>    if email == "":        <br/>        return Error(code=123, message="Empty email provided")<br/>    if re.match("^[a-zA-Z0-9-_]+@[a-zA-Z0-9]+\.[a-z]{1,3}$", email):    <br/>        return Success("Valid Email")<br/>    else:<br/>        return Success("Invalid Email")</span><span id="6c2e" class="nq lg it mw b gy ok oh l oi oj">@method<br/>async def validZipCode(zip) -&gt; Result:<br/>    if zip == "":<br/>        return InvalidParams("Null value")<br/>    if re.match("^[0-9]{5}(?:-[0-9]{4})?$", zip):<br/>        result = { "zip": zip, "result" : "Valid Zipcode" }<br/>    else:<br/>        result = { "zip": zip, "result" : "Invalid Zipcode" }<br/>    return Success(result)</span><span id="6d56" class="nq lg it mw b gy ok oh l oi oj">async def main(websocket, path):<br/>    if response := await async_dispatch(await websocket.recv()):<br/>        await websocket.send(response)</span><span id="e405" class="nq lg it mw b gy ok oh l oi oj">start_server = websockets.serve(main, "localhost", 5002)<br/>asyncio.get_event_loop().run_until_complete(start_server)<br/>asyncio.get_event_loop().run_forever()</span></pre><p id="4a8b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在很大程度上，JSON-RPC部分类似于使用HTTP的部分。值得注意的变化是使用WebSockets异步监听传入连接的部分。</p><p id="6398" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要运行服务器，请在终端中键入以下命令:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="de88" class="nq lg it mw b gy og oh l oi oj">$ <strong class="mw iu">python server_ws.py</strong></span></pre><h2 id="5ab9" class="nq lg it bd lh nr ns dn ll nt nu dp lp kb nv nw lt kf nx ny lx kj nz oa mb ob bi translated">使用jsonrpcclient实现客户端</h2><p id="8059" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">为了使用在WebSockets中实现的JSON-RPC，我们将使用<strong class="js iu"> jsonrpcclient </strong>模块:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="725b" class="nq lg it mw b gy og oh l oi oj">$ pip install jsonrpcclient</span></pre><blockquote class="ol om on"><p id="f7ea" class="jq jr nd js b jt ju jv jw jx jy jz ka oo kc kd ke op kg kh ki oq kk kl km kn im bi translated">jsonrpcclient模块包含帮助函数，可以帮助您将函数参数转换成JSON-RPC兼容的JSON字符串。它还帮助您解码JSON-RPC函数返回的响应。</p></blockquote><p id="ebe8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个名为<strong class="js iu"> client_ws.py </strong>的文件，并用以下内容填充它(我用粗体显示了发送到服务器的JSON和服务器返回的响应):</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="c938" class="nq lg it mw b gy og oh l oi oj">import asyncio<br/>import logging</span><span id="2ebc" class="nq lg it mw b gy ok oh l oi oj">from jsonrpcclient import Ok, parse_json, request_json<br/>import websockets</span><span id="079d" class="nq lg it mw b gy ok oh l oi oj">async def main():<br/>    async with websockets.connect("ws://localhost:5002") as ws:        <br/>        req = request_json("validZipCode", {"zip":"12345"})<br/><strong class="mw iu">        print(req) </strong><br/>        await ws.send(req)<br/>        result = await ws.recv()<br/><strong class="mw iu">        print(result)</strong>  <br/>        response = parse_json(result)</span><span id="c4ab" class="nq lg it mw b gy ok oh l oi oj">    if isinstance(response, Ok):<br/>        print(response.result)<br/>    else:        <br/>        logging.error(response.message)</span><span id="27c3" class="nq lg it mw b gy ok oh l oi oj">asyncio.get_event_loop().run_until_complete(main())</span></pre><p id="3c0e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要运行客户端，请在终端中键入以下内容:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="cc83" class="nq lg it mw b gy og oh l oi oj">$ <strong class="mw iu">python client_ws.py</strong></span></pre><p id="918b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，您将看到由<code class="fe mt mu mv mw b">request_json()</code>函数生成的JSON字符串(来自<strong class="js iu"> jsonrpcclient </strong>模块):</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="e58c" class="nq lg it mw b gy og oh l oi oj">{"jsonrpc": "2.0", "method": "validZipCode", "params": {"zip": "12345"}, "id": 1}</span></pre><p id="2b4b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，您将看到服务器返回的结果:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="8d6a" class="nq lg it mw b gy og oh l oi oj">{"jsonrpc": "2.0", "result": {"zip": "12345", "result": "Valid Zipcode"}, "id": 1}</span></pre><p id="a471" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，客户机将打印出<code class="fe mt mu mv mw b">result</code>键的值:</p><pre class="kp kq kr ks gt oc mw od oe aw of bi"><span id="74bf" class="nq lg it mw b gy og oh l oi oj">{'zip': '12345', 'result': 'Valid Zipcode'}</span></pre><div class="ne nf gp gr ng nh"><a href="https://weimenglee.medium.com/membership" rel="noopener follow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd iu gy z fp nm fr fs nn fu fw is bi translated">加入媒介与我的介绍链接-李伟孟</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">阅读李维孟(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接支持…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">weimenglee.medium.com</p></div></div><div class="or l"><div class="os l ot ou ov or ow ky nh"/></div></div></a></div><h1 id="1969" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">总结</strong></h1><p id="c543" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">我希望这篇文章已经清楚地解释了什么是JSON-RPC服务，以及如何使用HTTP或WebSockets实现它。如果您目前在项目中使用JSON-RPC，请在评论中告诉我。</p></div><div class="ab cl ox oy hx oz" role="separator"><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc"/></div><div class="im in io ip iq"><p id="aa14" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="c3ca" class="mk ml it js b jt ju jx jy kb mm kf mn kj mo kn mp mq mr ms bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="06a6" class="mk ml it js b jt mx jx my kb mz kf na kj nb kn mp mq mr ms bi translated">📰查看<a class="ae le" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="8257" class="mk ml it js b jt mx jx my kb mz kf na kj nb kn mp mq mr ms bi translated">🔔关注我们:<a class="ae le" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae le" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae le" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="4e88" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">🚀👉<a class="ae le" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>