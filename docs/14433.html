<html>
<head>
<title>Baseline Profiles &amp; GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基线配置文件和GitHub操作</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/baseline-profiles-github-actions-ce8bc6858bb3?source=collection_archive---------9-----------------------#2022-11-28">https://levelup.gitconnected.com/baseline-profiles-github-actions-ce8bc6858bb3?source=collection_archive---------9-----------------------#2022-11-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3e80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自动生成规则的最简单指南</p><p id="c56f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文旨在讨论宏基准、基线概要和GitHub动作。这些科目的基础知识是需要提前掌握的。<strong class="jp ir">请记住，这里学到的与GitHub行动相关的经验可以移植到任何其他类型的项目中。</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/e56347abd8859116fb42edd1f72149aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L3MuR2I2IBpUrmcT6WxUww.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图标由<a class="ae lb" href="https://www.flaticon.com/authors/ruslan-babkin" rel="noopener ugc nofollow" target="_blank">鲁斯兰·巴布金</a></figcaption></figure><p id="58f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在过去的几年里，谷歌一直致力于许多关于性能改进的更新。Baseline Profiles是该公司发布的最新工具之一，他们声称它可以将Android应用程序的启动时间缩短40%。如果您曾经尝试过基线概要文件，您可能会意识到，即使使用Macrobenchmark库，生成规则也可能是非常痛苦的。本文提供了一种自动生成这些规则的简单方法，不管你的项目有多大，只要它在GitHub上有版本。</p><blockquote class="lc"><p id="5050" class="ld le iq bd lf lg lh li lj lk ll kk dk translated">无论是否选择开始新项目，你的都要设置<code class="fe lm ln lo lp b">compileSdk 32</code>或更高，支持Android Gradle Plugin 7.3.0或更高。</p></blockquote><p id="16c9" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated"><em class="lv">注:以下脚本的Gradle Kotlin DSL在</em> <a class="ae lb" href="https://gist.github.com/roliveiravictor/48af9b7ebda04dca805b3a7ff6e0f3b4" rel="noopener ugc nofollow" target="_blank"> <em class="lv">这里</em> </a> <em class="lv">可用。</em></p><pre class="km kn ko kp gt lw lp lx bn ly lz bi"><span id="fe6b" class="ma mb iq lp b be mc md l me mf">/**<br/>*<br/>*  :app Gradle file<br/>*<br/>**/<br/>android {<br/>  compileSdk 33<br/>}<br/><br/>/**<br/>*<br/>*  Top-level Gradle file<br/>*<br/>**/<br/>plugins {<br/>  id 'com.android.application' version '7.3.0' apply false<br/>  id 'com.android.library' version '7.3.0' apply false<br/>  id 'com.android.test' version '7.3.0' apply false<br/>}</span></pre><p id="0014" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://github.com/roliveiravictor/baseline-profiles-with-github-actions/pull/1" rel="noopener ugc nofollow" target="_blank"> #1 </a> — <strong class="jp ir">(可选)</strong>创建一个空的Android项目</p><p id="6efc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://github.com/roliveiravictor/baseline-profiles-with-github-actions/pull/2" rel="noopener ugc nofollow" target="_blank"> #2 </a> —向您的项目添加宏基准库</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mg"><img src="../Images/5fc78caf7623ddfe9c27e45c76c337c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_FEob826l3AuNaYZPeFnCQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">宏基准库。模块添加用户界面。</figcaption></figure><p id="a7c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://github.com/roliveiravictor/baseline-profiles-with-github-actions/pull/3" rel="noopener ugc nofollow" target="_blank"> #3 </a> —在<code class="fe lm ln lo lp b">app</code>目录下创建一个<code class="fe lm ln lo lp b">benchmark-rules.pro</code>文件，以确保Proguard不会混淆基准构建变体，并将其设置为<code class="fe lm ln lo lp b">benchmark</code>构建类型上的Proguard文件</p><pre class="km kn ko kp gt lw lp lx bn ly lz bi"><span id="245f" class="ma mb iq lp b be mc md l me mf"># Benchmark-rules.pro<br/># Disables obfuscation for benchmark builds.<br/>-dontobfuscate</span></pre><pre class="mh lw lp lx bn ly lz bi"><span id="4a10" class="ma mb iq lp b be mc md l me mf">/**<br/>*<br/>* :app Gradle file<br/>*<br/>**/<br/>android {<br/>  buildTypes {<br/>        benchmark {<br/>            signingConfig signingConfigs.debug<br/>            proguardFiles("benchmark-rules.pro")<br/>            matchingFallbacks = ['release']<br/>            debuggable false<br/>        }<br/>    }<br/>}</span></pre><p id="8366" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://github.com/roliveiravictor/baseline-profiles-with-github-actions/pull/4" rel="noopener ugc nofollow" target="_blank"> #4 </a> —添加<strong class="jp ir">至少一个</strong>被管理设备</p><pre class="km kn ko kp gt lw lp lx bn ly lz bi"><span id="5f08" class="ma mb iq lp b be mc md l me mf"><br/>import com.android.build.api.dsl.ManagedVirtualDevice<br/><br/>/**<br/>*<br/>*  :benchmark Gradle file<br/>*<br/>**/<br/>android {<br/>  testOptions {<br/>    managedDevices {<br/>      devices {<br/>        pixel2Api31(ManagedVirtualDevice) {<br/>          device = "Pixel 2"<br/>          apiLevel = 31<br/>          systemImageSource = "aosp"<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="c7a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://github.com/roliveiravictor/baseline-profiles-with-github-actions/pull/5" rel="noopener ugc nofollow" target="_blank"> #5 </a> —增加<strong class="jp ir">至少一个</strong>收集基线剖面</p><pre class="km kn ko kp gt lw lp lx bn ly lz bi"><span id="0ed6" class="ma mb iq lp b be mc md l me mf">/**<br/>*<br/>*  :benchmark module<br/>*<br/>**/<br/><br/>package com.example.benchmark<br/><br/>import androidx.benchmark.macro.ExperimentalBaselineProfilesApi<br/>import androidx.benchmark.macro.junit4.BaselineProfileRule<br/>import androidx.test.ext.junit.runners.AndroidJUnit4<br/>import org.junit.Rule<br/>import org.junit.Test<br/>import org.junit.runner.RunWith<br/><br/>/**<br/>*<br/>*  ExperimentalBaselineProfilesApi is required so that<br/>*  macrobenchmark tests can be skipped when running <br/>*  the :benchmark:pixel2Api31BenchmarkAndroidTest task with<br/>*  androidx.benchmark.enabledRules=BaselineProfile<br/>*  as an argument. Check out actions.yml file.<br/>*<br/>**/<br/>@OptIn(ExperimentalBaselineProfilesApi::class)<br/>class BaselineProfileGenerator {<br/><br/>    @get:Rule<br/>    val baselineProfileRule = BaselineProfileRule()<br/><br/>    /**<br/>    *<br/>    *  @packageName Same as your applicationId (:app Gradle file)<br/>    *<br/>    **/<br/>    @Test<br/>    fun startup() =<br/>        baselineProfileRule.collectBaselineProfile(<br/>            packageName = "com.example.myapplication",<br/>            profileBlock = {<br/>                startActivityAndWait()<br/>            }<br/>        )<br/>}</span></pre><p id="c95a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://github.com/roliveiravictor/baseline-profiles-with-github-actions/pull/6" rel="noopener ugc nofollow" target="_blank"> #6 </a> —添加GitHub动作脚本</p><pre class="km kn ko kp gt lw lp lx bn ly lz bi"><span id="6f88" class="ma mb iq lp b be mc md l me mf"># Workflow name<br/>name: baseline-profiles<br/><br/># Workflow title<br/>run-name: ${{ github.actor }} requested a workflow<br/><br/># Event trigger so this actions gets executed every time a push is made on the main branch<br/># Change this event to what suits your project best.<br/># Read more at https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows<br/>on:<br/>  push:<br/>    branches:<br/>      - main<br/><br/># Environment variables (Optional)<br/># Small projects might have signingConfigs locally. This could lead to failures on GitHub Actions.<br/># If that's the case, upload your properties defined locally to GitHub Secrets.<br/><br/># On your signingConfigs, you can recover GitHub Secrets using: variable = System.getenv("VARIABLE")<br/><br/># Then uncomment this block properly defining your uploaded variables<br/># env:<br/>#  VARIABLE: ${{ secrets.VARIABLE }}<br/><br/># Read more at https://docs.github.com/en/actions/security-guides/encrypted-secrets<br/><br/># Jobs to executed on GitHub machines<br/>jobs:<br/><br/>    # Job name<br/>    generate-baseline-profiles:<br/><br/>      # Operating system where the job gets to be executed<br/>      runs-on: macos-latest<br/><br/>      # Job steps<br/>      steps:<br/><br/>        # Checks your code out on the machine<br/>        - uses: actions/checkout@v3<br/><br/>        # Sets java up<br/>        - uses: actions/setup-java@v3<br/>          with:<br/>            distribution: temurin<br/>            java-version: 11<br/><br/>        # Sets gradle up<br/>        - name: Setup Gradle<br/>          uses: gradle/gradle-build-action@v2<br/><br/>        # Grants execute permission to gradle (safety step)<br/>        - name: Grant Permissions to gradlew<br/>          run: chmod +x gradlew<br/><br/>        # Cleans managed device if previously settle and space currently is not available<br/>        - name: Clean Managed Devices<br/>          run: ./gradlew cleanManagedDevices --unused-only<br/><br/>        # Generates Baseline Profile<br/>        - name: Generate Baseline Profile<br/><br/>          ## swiftshader_indirect: <br/>          ## Required to use software acceleration on machines that can't use hardware acceleration<br/><br/>          ## enabledRules=BaselineProfile:<br/>          ## Required to skip macrobenchmark tests. <br/>          ## Read more at https://developer.android.com/topic/performance/benchmarking/benchmarking-in-ci#real-devices<br/>          ## Read more at https://developer.android.com/topic/performance/benchmarking/macrobenchmark-overview#configuration-errors<br/>          <br/>          ## gradle.workers.max: <br/>          ## Required to avoid running multiple managed device tests concurrently. Read more at https://issuetracker.google.com/issues/193118030<br/>          <br/>          run: ./gradlew :benchmark:pixel2Api31BenchmarkAndroidTest -Pandroid.testoptions.manageddevices.emulator.gpu="swiftshader_indirect" -Pandroid.testInstrumentationRunnerArguments.androidx.benchmark.enabledRules=BaselineProfile -Dorg.gradle.workers.max=4<br/><br/>        # Sets the Baseline Profile on its proper place so it gets correctly bundled into Play Store<br/>        - name: Move &amp; Rename Baseline Profiles<br/>          run:  |<br/>            mv -f benchmark/build/outputs/managed_device_android_test_additional_output/pixel2Api31/BaselineProfileGenerator_startup-baseline-prof.txt app/src/main/baseline-prof.txt<br/><br/>        # Commits the generated Baseline Profile to your origin/remote<br/>        - name: Commit Baseline Profiles<br/>          run: |<br/>            git config --global user.name 'Baseline Profiles - GitHub Actions'<br/>            git config --global user.email 'github@actions'<br/>            git add app/src/main/baseline-prof.txt<br/>            git commit -m "Generate baseline profiles"<br/>            git push</span></pre><p id="6d22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://github.com/roliveiravictor/baseline-profiles-with-github-actions/pull/7" rel="noopener ugc nofollow" target="_blank"> #7 </a> —将所有变更合并到<code class="fe lm ln lo lp b">main</code>分支中</p><p id="cffc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://github.com/roliveiravictor/baseline-profiles-with-github-actions/actions/runs/3424775794" rel="noopener ugc nofollow" target="_blank"> EOF </a> —大约10分钟后，Actions选项卡上会出现一个成功的作业，最后，存储库中的最后一次提交会显示最近添加的<code class="fe lm ln lo lp b">baseline-prof.txt</code>文件的更改。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mi"><img src="../Images/60e2efd0e160152b539952bc72d3d531.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4STAXTAowPpnvCaXeOznJA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">由GitHub在主分支上提交的操作生成的基线配置文件规则</figcaption></figure><p id="f112" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">GitHub Actions是一个非常强大的工具，可以以可伸缩的方式生成基线配置文件规则。通过适当地调用其他的<code class="fe lm ln lo lp b">actions/*</code>并替换<code class="fe lm ln lo lp b">*.yml</code>文件上的<code class="fe lm ln lo lp b">run</code>命令，可以创建许多其他的工作流。GitHub Actions是最适合您项目的自动化工作流程的最佳方式之一。</p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="e661" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lv">现在，告诉我，你认为基线配置文件或GitHub操作如何派上用场？在评论中告诉我更多关于你的观点。如果你喜欢的话，谢谢你的掌声&amp;分享，别忘了关注我，关注即将到来的文章！=} </em></p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="deac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="lv">参考文献</em> </strong></p><ol class=""><li id="b72a" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated"><a class="ae lb" href="https://developer.android.com/topic/performance/benchmarking/benchmarking-overview#macrobenchmark" rel="noopener ugc nofollow" target="_blank"> <em class="lv">宏基准</em> </a></li><li id="380c" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://developer.android.com/topic/performance/baselineprofiles/overview" rel="noopener ugc nofollow" target="_blank"> <em class="lv">基线剖面图</em> </a></li><li id="ff54" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> <em class="lv"> GitHub动作</em> </a></li><li id="520d" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://developer.android.com/topic/performance/improving-overview" rel="noopener ugc nofollow" target="_blank"> <em class="lv">性能提升概述</em> </a></li><li id="4a47" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://www.youtube.com/watch?v=6R0jrJp1Uwg&amp;list=PLWz5rJ2EKKc9T9fxvsrbzg_mflg2EYLZk" rel="noopener ugc nofollow" target="_blank"> <em class="lv">性能介绍— MAD技巧</em> </a></li><li id="ac7e" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://android-developers.googleblog.com/2022/01/improving-app-performance-with-baseline.html" rel="noopener ugc nofollow" target="_blank"> <em class="lv">使用基准配置文件提高应用性能</em> </a></li><li id="2fb3" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://developer.android.com/topic/performance/baselineprofiles/manually-create-measure" rel="noopener ugc nofollow" target="_blank"> <em class="lv">手动创建基线剖面图</em> </a></li><li id="b3ca" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://developer.android.com/about/versions/12/setup-sdk" rel="noopener ugc nofollow" target="_blank">T5】安装Android 12 SDKT7】</a></li><li id="c76d" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://developer.android.com/studio/releases/gradle-plugin?gclid=CjwKCAjwv4SaBhBPEiwA9YzZvAYWtMHYLjoI6136i6xmGl3m9IFV1qG4GMJdTM46ZVqsePrYt_yCehoCRNEQAvD_BwE&amp;gclsrc=aw.ds#7-3-0" rel="noopener ugc nofollow" target="_blank"> <em class="lv">安卓Gradle插件7.3.0 </em> </a></li><li id="b5b3" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://developer.android.com/topic/performance/benchmarking/macrobenchmark-overview" rel="noopener ugc nofollow" target="_blank"> <em class="lv">编写宏基准</em> </a></li><li id="05f8" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://cs.android.com/androidx/platform/frameworks/support/+/androidx-main:benchmark/integration-tests/macrobenchmark/src/androidTest/java/androidx/benchmark/integration/macrobenchmark/GithubBrowserBaselineProfile.kt" rel="noopener ugc nofollow" target="_blank"> <em class="lv">安卓代码搜索—简介示例</em> </a></li><li id="fe5e" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://developer.android.com/topic/performance/benchmarking/macrobenchmark-overview#configuration-errors" rel="noopener ugc nofollow" target="_blank"> <em class="lv">宏基准—配置错误</em> </a></li><li id="919b" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><a class="ae lb" href="https://developer.android.com/topic/performance/baselineprofiles/overview#known-issues" rel="noopener ugc nofollow" target="_blank"> <em class="lv">基准配置文件—已知问题</em> </a></li></ol></div></div>    
</body>
</html>