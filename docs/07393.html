<html>
<head>
<title>How To Use MQTT With Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Go中使用MQTT</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-use-mqtt-with-go-89c617915774?source=collection_archive---------4-----------------------#2021-02-15">https://levelup.gitconnected.com/how-to-use-mqtt-with-go-89c617915774?source=collection_archive---------4-----------------------#2021-02-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="62b9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用较差的网络连接任何类型的设备。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3b9a69cd215226e02399b8995c6aed2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cmBX1Jbcr-KlEPg7OPko1A.png"/></div></div></figure><p id="b21a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您以前使用过IoT，那么您可能听说过或者甚至使用过MQTT。当我们谈论远程设备之间交换消息时，它是首先想到的协议之一。</p><p id="35ab" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">该协议由安迪·史丹福-克拉克和阿尔伦·尼珀于1999年发明，通过卫星连接石油管道。由于远程网络的带宽可能没有那么好(特别是那些时候)，所以需要一个轻量级的、最小开销的协议。</p><p id="d9d0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">根据<a class="ae lq" href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html" rel="noopener ugc nofollow" target="_blank"> MQTT规范</a>:</p><blockquote class="lr"><p id="bb11" class="ls lt it bd lu lv lw lx ly lz ma lp dk translated">MQTT是一个客户端服务器发布/订阅消息传输协议。它重量轻、开放、简单，并且被设计成易于实现。这些特性使它非常适合在许多情况下使用，包括受限环境，如机器对机器(M2M)和物联网(IoT)环境中的通信，在这些环境中需要少量代码和/或网络带宽非常宝贵。</p></blockquote><p id="e84f" class="pw-post-body-paragraph ku kv it kw b kx mb ju kz la mc jx lc ld md lf lg lh me lj lk ll mf ln lo lp im bi translated">MQTT协议旨在实现这些目标:</p><ul class=""><li id="6972" class="mg mh it kw b kx ky la lb ld mi lh mj ll mk lp ml mm mn mo bi translated"><strong class="kw iu">效率</strong>:客户通常很小，没有多少资源。</li><li id="02d7" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated">轻量级:消息头很小，以优化网络带宽。</li><li id="8abb" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated"><strong class="kw iu">可靠传递</strong>:对于设备来说，确保消息被传递是很重要的。</li><li id="fcaa" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated"><strong class="kw iu">双向</strong>:客户端和服务器都可以发送消息。</li><li id="9a6a" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated"><strong class="kw iu">数据不可知</strong>:发送的消息格式无关紧要。</li><li id="9247" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated"><strong class="kw iu">会话</strong>:许多物联网设备通过不可靠的网络连接，因此减少重新连接客户端的时间非常重要。</li><li id="bf9d" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated"><strong class="kw iu">安全性</strong>:使用TLS加密消息很容易。</li></ul></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="e7e9" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">体系结构</h1><p id="1127" class="pw-post-body-paragraph ku kv it kw b kx nt ju kz la nu jx lc ld nv lf lg lh nw lj lk ll nx ln lo lp im bi translated">MQTT是一个<a class="ae lq" href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern" rel="noopener ugc nofollow" target="_blank">发布-订阅</a>协议。也就是说，客户端发送消息(或发布它)而不直接知道谁将接收该消息，如果有人接收的话。同样，另一个客户端可以接收(或订阅)消息，而不知道是哪个设备发送的。</p><p id="1d28" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为此，必须存在一个服务器(或代理)来管理所有的连接以及将哪个消息发送给每个订阅者。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/2fcd23b616c17d244f2f850e7b896cc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0YLH50OgUu-PsVjh.png"/></div></div><figcaption class="nz oa gj gh gi ob oc bd b be z dk translated">来源:<a class="ae lq" href="https://mqtt.org/" rel="noopener ugc nofollow" target="_blank">mqtt.org</a></figcaption></figure><p id="bd36" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这样，为了发送或接收消息，发布者和订阅者只需要知道代理地址。另一个优点是，代理可以为发布时不在线的客户端传递消息。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="ce58" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">转到客户端</h1><p id="d33d" class="pw-post-body-paragraph ku kv it kw b kx nt ju kz la nu jx lc ld nv lf lg lh nw lj lk ll nx ln lo lp im bi translated">让我们在Go中创建一个简单的应用程序，使用MQTT发送和接收消息。</p><blockquote class="od oe of"><p id="342f" class="ku kv og kw b kx ky ju kz la lb jx lc oh le lf lg oi li lj lk oj lm ln lo lp im bi translated"><strong class="kw iu">注</strong>:本教程使用的Go版本为1.15.8 linux/amd64。</p></blockquote><p id="c10f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">它使用<code class="fe ok ol om on b"><a class="ae lq" href="https://github.com/eclipse/paho.mqtt.golang" rel="noopener ugc nofollow" target="_blank">paho.mqtt.golang</a></code>作为MQTT客户端库，所以安装它:</p><pre class="kj kk kl km gt oo on op oq aw or bi"><span id="e310" class="os nc it on b gy ot ou l ov ow">go get github.com/eclipse/paho.mqtt.golang</span></pre><p id="8ff4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了测试我们的应用程序，我们需要一台服务器。你有两个选择:</p><ul class=""><li id="a055" class="mg mh it kw b kx ky la lb ld mi lh mj ll mk lp ml mm mn mo bi translated">安装您自己的，例如使用<a class="ae lq" href="https://mosquitto.org/" rel="noopener ugc nofollow" target="_blank"> Mosquitto </a>。</li><li id="01bc" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated">或者使用公共服务器。你可以在这里找到可用公共服务器的列表<a class="ae lq" href="https://github.com/mqtt/mqtt.org/wiki/public_brokers" rel="noopener ugc nofollow" target="_blank">。如果您使用公共服务器，请记住不要发送任何敏感数据。</a></li></ul><blockquote class="od oe of"><p id="bfe5" class="ku kv og kw b kx ky ju kz la lb jx lc oh le lf lg oi li lj lk oj lm ln lo lp im bi translated"><strong class="kw iu">注意</strong>:对于这个教程，我使用的是公共服务器<code class="fe ok ol om on b"><a class="ae lq" href="http://test.mosquitto.org/" rel="noopener ugc nofollow" target="_blank">test.mosquitto</a></code>。</p></blockquote><p id="981d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">第一步是定义客户机选项，如代理、端口、客户机id、用户名等。这是通过<code class="fe ok ol om on b">mqtt.NewClientOptions</code>完成的。所有需要的选项将取决于您使用的代理。</p><p id="dd6e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这种情况下，您还可以设置想要处理的回调。我们将设置三个回调:</p><ol class=""><li id="1b5d" class="mg mh it kw b kx ky la lb ld mi lh mj ll mk lp ox mm mn mo bi translated"><code class="fe ok ol om on b">OnConnect</code>:客户端连接到服务器时。</li><li id="a6b8" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ox mm mn mo bi translated"><code class="fe ok ol om on b">OnConnectionLost</code>:客户端与服务器断开连接时。</li><li id="f0cb" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ox mm mn mo bi translated"><code class="fe ok ol om on b">MessageHandler</code>:从服务器接收到消息时。</li></ol><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div></figure><p id="7e82" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在所有的配置都设置好之后，我们调用<code class="fe ok ol om on b">mqtt.NewClient</code>来创建选项。</p><p id="02fb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要连接，只需调用<code class="fe ok ol om on b">client.Connect()</code>。连接过程是在后台完成的，所以我们必须等待并确保不存在错误。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div></figure><h2 id="3331" class="os nc it bd nd pa pb dn nh pc pd dp nl ld pe pf nn lh pg ph np ll pi pj nr pk bi translated">签署</h2><p id="aae6" class="pw-post-body-paragraph ku kv it kw b kx nt ju kz la nu jx lc ld nv lf lg lh nw lj lk ll nx ln lo lp im bi translated">客户端可以订阅代理中的主题。客户端将只接收发送到该主题的消息。</p><p id="e7dc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要订阅，调用带有三个参数的方法<code class="fe ok ol om on b">client.Subscribe</code>:</p><ul class=""><li id="03fa" class="mg mh it kw b kx ky la lb ld mi lh mj ll mk lp ml mm mn mo bi translated"><code class="fe ok ol om on b">topic</code>:带有要订阅主题的字符串。</li><li id="73fe" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated"><code class="fe ok ol om on b">qos</code>:服务质量。它必须是0(最多一次)、1(至少一次)或2(恰好一次)。</li><li id="27af" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated"><code class="fe ok ol om on b">callback</code>:接收到本主题消息时调用的函数。它可以是<code class="fe ok ol om on b">nil</code>,所以只调用默认的处理程序。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div></figure><h2 id="28d5" class="os nc it bd nd pa pb dn nh pc pd dp nl ld pe pf nn lh pg ph np ll pi pj nr pk bi translated">出版</h2><p id="3cde" class="pw-post-body-paragraph ku kv it kw b kx nt ju kz la nu jx lc ld nv lf lg lh nw lj lk ll nx ln lo lp im bi translated">要发送消息(发布)，我们需要使用方法<code class="fe ok ol om on b">client.Publish</code>。它接收四个参数:</p><ul class=""><li id="c81d" class="mg mh it kw b kx ky la lb ld mi lh mj ll mk lp ml mm mn mo bi translated"><code class="fe ok ol om on b">topic</code>:要发布主题的字符串。</li><li id="819b" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated"><code class="fe ok ol om on b">qos</code>:服务质量(与<code class="fe ok ol om on b">Subscribe</code>相同的值)。</li><li id="ab78" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated"><code class="fe ok ol om on b">retained</code>:布尔值，表示消息是否必须由服务器保留。It <code class="fe ok ol om on b">true</code>，主题的最后一条消息将发送给每一个新订阅者。</li><li id="dce6" class="mg mh it kw b kx mp la mq ld mr lh ms ll mt lp ml mm mn mo bi translated"><code class="fe ok ol om on b">payload</code>:实际消息。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div></figure><p id="fe24" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是一个完整的代码，可以订阅一个主题并发布10条消息。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div></figure><p id="6773" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">运行之后，您应该会得到如下输出。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pl"><img src="../Images/11e209e5bc4bebacf63d72af6ac89bda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FlydnJQdiLbdq08YWYY6pQ.png"/></div></div><figcaption class="nz oa gj gh gi ob oc bd b be z dk translated">图片作者。</figcaption></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="a8c4" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">加密</h1><p id="0c0d" class="pw-post-body-paragraph ku kv it kw b kx nt ju kz la nu jx lc ld nv lf lg lh nw lj lk ll nx ln lo lp im bi translated">一些经纪人使用TLS来增加安全性。我们需要用服务器要求的证书创建一个<code class="fe ok ol om on b">tls.Config</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div></figure><p id="75c7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">并通过方法<code class="fe ok ol om on b">SetTLSConfig</code>将该配置添加到选项中。完整的代码如下。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div></figure><blockquote class="od oe of"><p id="fe28" class="ku kv og kw b kx ky ju kz la lb jx lc oh le lf lg oi li lj lk oj lm ln lo lp im bi translated"><strong class="kw iu">注意</strong>:对于mosquitto测试服务器，我们需要他们的证书才能连接到服务器。这里可以下载<a class="ae lq" href="http://test.mosquitto.org/ssl/mosquitto.org.crt" rel="noopener ugc nofollow" target="_blank">。</a></p></blockquote></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="6298" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">结论</h1><p id="a0b2" class="pw-post-body-paragraph ku kv it kw b kx nt ju kz la nu jx lc ld nv lf lg lh nw lj lk ll nx ln lo lp im bi translated">MQTT协议非常简单，但是功能强大。只需几行代码，您就可以实现一个客户端并开始使用它。</p><p id="5204" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您需要向资源有限的设备发送数据，MQTT是一个完美的协议。</p></div></div>    
</body>
</html>