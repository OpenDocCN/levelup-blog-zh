<html>
<head>
<title>Using Github Actions to Deploy a React App and Express API Over SSH in 15 seconds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Github操作在15秒内通过SSH部署React应用程序和Express API</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-github-actions-to-deploy-a-react-app-and-express-api-over-ssh-in-15-seconds-6c7d9fb6bca3?source=collection_archive---------0-----------------------#2021-12-10">https://levelup.gitconnected.com/using-github-actions-to-deploy-a-react-app-and-express-api-over-ssh-in-15-seconds-6c7d9fb6bca3?source=collection_archive---------0-----------------------#2021-12-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/d8ed2acb7b8b4bb79bd13b71fd898bdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OFY9m34ndUM4yA0i.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">15秒内0-100英里/小时</figcaption></figure><h1 id="932a" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">动机</h1><p id="5596" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">我一直在寻求改进我正在从事的几个项目的部署过程，并开始朝着我喜欢的部署方法进行构建。</p><p id="daae" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">我最大的要求是<strong class="lf iu">简单</strong>和<strong class="lf iu">速度</strong>。我过去使用过<a class="ae mg" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>、<a class="ae mg" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>、<a class="ae mg" href="https://docs.docker.com/engine/swarm/" rel="noopener ugc nofollow" target="_blank"> Docker Swarm </a>以及其他各种部署方法。我认识到这些工具有它们的优点，但是我发现对于中小型项目来说，它们比它们值得维护的工作量要大。</p><p id="d41c" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">一天结束时，我需要做的就是构建代码，并将构建的文件复制到服务器。在开始这个项目之前，我告诉自己要在一分钟之内完成，但是我很高兴地告诉大家，Github Actions的启动速度比Travis CI快得多，部署React前端和express.js后端只需要<strong class="lf iu"> 15秒。</strong></p><p id="2574" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">我已经提供了如何重新创建整个项目的完整说明，但是如果你只是对工作流部分感兴趣，请跳到<a class="ae mg" href="https://devtails.xyz/using-github-actions-to-deploy-a-react-app-and-express-api-over-ssh-in-15-seconds#my-workflow" rel="noopener ugc nofollow" target="_blank">我的工作流</a>部分。</p><h1 id="c9d7" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">创建一个简单的应用程序来演示</h1><p id="aa4d" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">在我演示工作流之前，我们需要部署一些东西。下面是如何构建简单应用程序的说明。你们中的大多数人可能已经习惯了由<a class="ae mg" href="https://reactjs.org/docs/create-a-new-react-app.html" rel="noopener ugc nofollow" target="_blank"> Create React App </a>提供的模板，但是在这里，我提供了一些关于如何构建应用程序的自以为是的备选方案。同样的原则应该可以转移到任何现有的设置。</p><h1 id="d151" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">创建基本的React应用程序</h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="c44f" class="mq kg it mm b gy mr ms l mt mu">mkdir github-actions-tutorial<br/>cd github-actions-tutorial<br/>yarn init<br/>yarn add react react-dom<br/>yarn add --dev <a class="ae mg" href="http://twitter.com/types/react" rel="noopener ugc nofollow" target="_blank">@types/react</a> <a class="ae mg" href="http://twitter.com/types/react-dom" rel="noopener ugc nofollow" target="_blank">@types/react-dom</a><br/>mkdir -p client/src</span></pre><h2 id="6de6" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">创建index.tsx</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="17f6" class="mq kg it mm b gy mr ms l mt mu">// client/src/index.tsx<br/>import React from "react";<br/>import ReactDom from "react-dom";<br/>import { App } from "./App";</span><span id="42a9" class="mq kg it mm b gy ng ms l mt mu">ReactDom.render(&lt;App /&gt;, document.getElementById("root"));</span></pre><h2 id="562d" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">创建App.tsx</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="0654" class="mq kg it mm b gy mr ms l mt mu">// client/src/App.tsx<br/>import React, { useEffect, useState } from "react";</span><span id="efa5" class="mq kg it mm b gy ng ms l mt mu">export const App: React.FC = () =&gt; {<br/>  return (<br/>    &lt;&gt;<br/>      &lt;div&gt;Hello Github Actions!&lt;/div&gt;<br/>    &lt;/&gt;<br/>  );<br/>};</span></pre><h1 id="83ab" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">使用esbuild构建React应用程序</h1><p id="844a" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">现在我们有了一个简单的React应用程序，我们将使用<a class="ae mg" href="https://esbuild.github.io/" rel="noopener ugc nofollow" target="_blank"> esbuild </a>输出一个缩小的生产版本。</p><h2 id="3144" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">安装esbuild</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="30b7" class="mq kg it mm b gy mr ms l mt mu">yarn add --dev esbuild</span></pre><h2 id="2543" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">将客户端:构建脚本添加到package.json</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="b78b" class="mq kg it mm b gy mr ms l mt mu">// package.json<br/>{<br/>  "name": "github-actions-tutorial",<br/>  "version": "1.0.0",<br/>  "main": "index.js",<br/>  "repository": "<a class="ae mg" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:adamjberg/github-actions-tutorial.git",<br/>  "author": "Adam Berg &lt;<a class="ae mg" href="mailto:adam@xyzdigital.com" rel="noopener ugc nofollow" target="_blank">adam@xyzdigital.com</a>&gt;",<br/>  "license": "MIT",<br/>  "scripts": {<br/>    "client:build": "esbuild client/src/index.tsx --bundle --minify --outfile=built/app.js",<br/>  },<br/>  "dependencies": {<br/>    "react": "^17.0.2",<br/>    "react-dom": "^17.0.2"<br/>  },<br/>  "devDependencies": {<br/>    "<a class="ae mg" href="http://twitter.com/types/react" rel="noopener ugc nofollow" target="_blank">@types/react</a>": "^17.0.37",<br/>    "<a class="ae mg" href="http://twitter.com/types/react-dom" rel="noopener ugc nofollow" target="_blank">@types/react-dom</a>": "^17.0.11",<br/>    "esbuild": "^0.14.1"<br/>  }<br/>}</span></pre><p id="8552" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">您可以通过运行<code class="fe nh ni nj mm b">yarn client:build</code>来测试这是否正常工作，您应该会在文件夹树中看到一个带有缩小输出的<code class="fe nh ni nj mm b">built/app.js</code>文件。</p><p id="b944" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">你可能也习惯有一个<code class="fe nh ni nj mm b">yarn start</code>脚本，但是为了本教程的目的，我们将跳过它，直接在“产品”中测试。</p><h2 id="b91c" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">创建<code class="fe nh ni nj mm b">public/index.html</code></h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="4b5e" class="mq kg it mm b gy mr ms l mt mu">&lt;html&gt;</span><span id="f247" class="mq kg it mm b gy ng ms l mt mu">&lt;head&gt;<br/>  &lt;script src="/js/app.js" defer async&gt;&lt;/script&gt;<br/>&lt;/head&gt;</span><span id="922e" class="mq kg it mm b gy ng ms l mt mu">&lt;body&gt;<br/>  &lt;div id="root"&gt;&lt;/div&gt;<br/>&lt;/body&gt;</span><span id="ca09" class="mq kg it mm b gy ng ms l mt mu">&lt;/html&gt;</span></pre><p id="c6d3" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">当客户端点击<code class="fe nh ni nj mm b">http://github-actions-tutorial.devtails.xyz</code> URL时，这个文件将由nginx静态文件服务器提供服务。</p><h1 id="4ddb" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">准备服务器</h1><p id="02bb" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">我假设读者对如何注册域名和在某个托管平台上创建服务器有所了解。我已经有了一个名为<a class="ae mg" href="https://namecheap.pxf.io/GjgG5V" rel="noopener ugc nofollow" target="_blank">的域名<code class="fe nh ni nj mm b">devtails.xyz</code>和一个名为</a>的<a class="ae mg" href="https://m.do.co/c/4d01489e4069" rel="noopener ugc nofollow" target="_blank">数字海洋</a>的域名。</p><p id="2a84" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">在下面的例子中，我已经将<code class="fe nh ni nj mm b">github-actions-tutorial.devtails.xyz</code>映射到我的数字海洋IP: <code class="fe nh ni nj mm b">143.198.32.125</code></p><p id="9590" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">只要您能够ssh到您的服务器，不管您的主机平台如何，以下说明就足够了。</p><h2 id="4532" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">SSH进入服务器</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="6095" class="mq kg it mm b gy mr ms l mt mu">ssh root@143.198.32.125</span></pre><h2 id="8f5a" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">创建github-操作-教程用户</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="f468" class="mq kg it mm b gy mr ms l mt mu">useradd -s /bin/bash -d /home/github-actions-tutorial -m github-actions-tutorial</span></pre><p id="5d1c" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">为了防止我们的Github操作获得对我们服务器的root访问权限，我们将创建一个名为<code class="fe nh ni nj mm b">github-actions-tutorial</code>的子用户</p><h2 id="0a2f" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">安装nginx</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="855d" class="mq kg it mm b gy mr ms l mt mu">apt-get install nginx</span></pre><h2 id="d3a6" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">创建虚拟主机文件</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="b75e" class="mq kg it mm b gy mr ms l mt mu"># /etc/nginx/sites-available<br/>server {<br/>  listen 80;<br/>  server_name github-actions-tutorial.devtails.xyz;</span><span id="cd8e" class="mq kg it mm b gy ng ms l mt mu">location / {<br/>    root /home/github-actions-tutorial/static;<br/>  }<br/>}</span></pre><p id="d998" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">这告诉nginx将对<code class="fe nh ni nj mm b">github-actions-tutorial.devtails.xyz</code>子域的请求路由到我们的<code class="fe nh ni nj mm b">github-actions-tutorial</code>用户下的<code class="fe nh ni nj mm b">static</code>文件夹。</p><h2 id="99ef" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">在<code class="fe nh ni nj mm b">github-actions-tutorial</code>用户上创建<code class="fe nh ni nj mm b">static</code>文件夹</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="3b1a" class="mq kg it mm b gy mr ms l mt mu">su github-actions-tutorial<br/>mkdir static</span></pre><p id="23ed" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">这允许我们避免让Github操作ssh进入服务器来创建这个文件夹。该文件夹将存放<code class="fe nh ni nj mm b">js/app.js</code>和<code class="fe nh ni nj mm b">index.html</code>。之前设置的虚拟主机文件告诉nginx提供来自<code class="fe nh ni nj mm b">static</code>文件夹的文件。</p><h1 id="5577" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">创建基本的Express REST API</h1><h2 id="1139" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">安装快速</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="6178" class="mq kg it mm b gy mr ms l mt mu">yarn add express<br/>yarn add <a class="ae mg" href="http://twitter.com/types/express" rel="noopener ugc nofollow" target="_blank">@types/express</a></span></pre><h2 id="86d8" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">创建<code class="fe nh ni nj mm b">server/src/server.tsx</code></h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="bec8" class="mq kg it mm b gy mr ms l mt mu">// server/src/server.tsx<br/>import express from "express";</span><span id="c45e" class="mq kg it mm b gy ng ms l mt mu">const app = express();</span><span id="507c" class="mq kg it mm b gy ng ms l mt mu">app.get("/api/message", (_, res) =&gt; {<br/>  return res.json({<br/>    data: "Hello from the server!",<br/>  });<br/>});</span><span id="7760" class="mq kg it mm b gy ng ms l mt mu">app.listen(8080);</span></pre><p id="49f1" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">这创建了一个带有单个<code class="fe nh ni nj mm b">/api/message</code>路由的基本REST API，我们将使用它来证明它正在正确运行。</p><h2 id="e751" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">向package.json添加服务器:构建脚本</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="0a2e" class="mq kg it mm b gy mr ms l mt mu">"server:build": "esbuild server/src/server.ts --bundle --minify --outfile=built/server.js --platform=node"</span></pre><p id="f3d9" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">我们将重用esbuild包来为我们的服务器代码构建一个包。有关这种方法的更多详情，请参见<a class="ae mg" href="https://devtails.xyz/bundling-your-node-js-express-app-with-esbuild" rel="noopener ugc nofollow" target="_blank">这篇文章</a>。</p><p id="1814" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">将它添加到<code class="fe nh ni nj mm b">client:build</code>脚本的正下方。然后您可以使用<code class="fe nh ni nj mm b">yarn server:build</code>运行它以确认工作正常。它应该输出一个捆绑文件到<code class="fe nh ni nj mm b">built/server.js</code>。</p><h2 id="fd18" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">添加运行客户端和服务器构建的构建脚本</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="2b2d" class="mq kg it mm b gy mr ms l mt mu">"build": "yarn client:build &amp;&amp; yarn server:build"</span></pre><h1 id="2ebf" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">准备运行API的服务器</h1><p id="dbe0" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">为了让我们的服务器做好部署准备，需要应用一些一次性配置。</p><h2 id="a1ba" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">切换到github-动作-教程用户</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="06c0" class="mq kg it mm b gy mr ms l mt mu">su github-actions-tutorial</span></pre><h2 id="e054" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">安装NVM</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="64f7" class="mq kg it mm b gy mr ms l mt mu">curl -o- <a class="ae mg" href="https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh</a> | bash</span></pre><h2 id="0fa3" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">安装节点</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="3f3d" class="mq kg it mm b gy mr ms l mt mu">nvm install 16</span></pre><h2 id="6818" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">安装<a class="ae mg" href="https://pm2.keymetrics.io/" rel="noopener ugc nofollow" target="_blank"> pm2 </a></h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="4209" class="mq kg it mm b gy mr ms l mt mu">npm i -g pm2</span></pre><h2 id="c3af" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">更新虚拟主机文件以路由到API</h2><p id="f9f3" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">再次ssh到<code class="fe nh ni nj mm b">root</code>用户并更新<code class="fe nh ni nj mm b">/etc/nginx/sites-available/github-actions-tutorial.devtails.xyz</code>文件</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="0b8a" class="mq kg it mm b gy mr ms l mt mu"># /etc/nginx/sites-available/github-actions-tutorial.devtails.xyz<br/>upstream github-actions-tutorial-api {<br/>  server localhost:8080;<br/>}</span><span id="bd2b" class="mq kg it mm b gy ng ms l mt mu">server {<br/>  listen 80;<br/>  server_name github-actions-tutorial.devtails.xyz;</span><span id="8722" class="mq kg it mm b gy ng ms l mt mu">location /api {<br/>    proxy_pass <a class="ae mg" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a>;<br/>  }</span><span id="bc78" class="mq kg it mm b gy ng ms l mt mu">location / {<br/>    root /home/github-actions-tutorial/static;<br/>  }<br/>}</span></pre><p id="291f" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">这告诉nginx将任何以<code class="fe nh ni nj mm b">/api</code>开头的URL路由到我们添加的express应用程序。</p><h2 id="8125" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">启动pm2流程</h2><p id="34a0" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">在最后一步<code class="fe nh ni nj mm b">- run: ssh github-actions-tutorial "pm2 reload all"</code>可以运行之前，您必须首先用pm2手动启动您的服务器。</p><p id="4d05" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">在第一次运行Github动作后，它应该已经将构建好的<code class="fe nh ni nj mm b">server.js</code>文件复制到了<code class="fe nh ni nj mm b">~/api/server.js</code>。然后，您可以使用<code class="fe nh ni nj mm b">pm2 start api/server.js</code>开始这个过程。</p><p id="c7d9" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">现在它正在运行，<code class="fe nh ni nj mm b">pm2 reload all</code>命令将重新加载这个服务器进程，这样它就可以获取服务器代码中的更改。</p><h1 id="11a3" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">我的工作流程</h1><p id="44b0" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">唷，所有的设置都完成了，我们现在可以看看我们的<code class="fe nh ni nj mm b">Deploy</code>工作流做了什么。</p><p id="22e2" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">下面我将一节一节地分解它</p><h1 id="71f5" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">定义工作流名称和触发器</h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="2ed0" class="mq kg it mm b gy mr ms l mt mu">name: Deploy</span><span id="9622" class="mq kg it mm b gy ng ms l mt mu">on:<br/>  push:<br/>    branches: [ main ]</span></pre><p id="1e31" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">这将创建一个名为“Deploy”的工作流，每当对<code class="fe nh ni nj mm b">main</code>分支进行推送时都会运行该工作流。</p><h1 id="c4a7" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">定义构建和部署作业</h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="9abc" class="mq kg it mm b gy mr ms l mt mu">jobs:<br/>  build-and-deploy:<br/>    runs-on: ubuntu-latest</span></pre><p id="94a2" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">这创建了一个名为<code class="fe nh ni nj mm b">build-and-deploy</code>的作业，它将运行最新的ubuntu发行版。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="b768" class="mq kg it mm b gy mr ms l mt mu">env:<br/>  SSH_KEY: ${{secrets.SSH_KEY}}</span></pre><p id="bb5b" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">这给环境增加了一个Github秘密。我们将在后面的步骤中使用它来允许我们与指定的服务器进行同步。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="0bb4" class="mq kg it mm b gy mr ms l mt mu">steps:<br/>  - uses: actions/checkout@v2</span></pre><p id="5d11" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">这将检查当前提交的代码。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="bd68" class="mq kg it mm b gy mr ms l mt mu">- name: Use Node.js 16<br/>  uses: actions/setup-node@v2<br/>  with:<br/>    node-version: 16<br/>    cache: 'yarn'</span></pre><p id="257a" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">这将安装节点16，并指定工作流应该为yarn缓存文件。这个缓存确保了如果没有添加或删除包，<code class="fe nh ni nj mm b">yarn install</code>不必做任何事情。这节省了大量时间。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="05b7" class="mq kg it mm b gy mr ms l mt mu">- run: yarn install<br/>- run: yarn build</span></pre><p id="0e9c" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">这些行运行安装和构建，最终输出我们想要部署的所有文件。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="0fb9" class="mq kg it mm b gy mr ms l mt mu">- run: mkdir ~/.ssh<br/>- run: 'echo "$SSH_KEY" &gt;&gt; ~/.ssh/github-action'<br/>- run: chmod 400 ~/.ssh/github-action<br/>- run: echo -e "Host static\n\tUser github-actions-tutorial\n\tHostname 143.198.32.125\n\tIdentityFile ~/.ssh/github-action\n\tStrictHostKeyChecking No" &gt;&gt; ~/.ssh/config</span></pre><p id="d747" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">这是最复杂的部分。这里发生的事情是我们正在将<code class="fe nh ni nj mm b">SSH_KEY</code>秘密添加到<code class="fe nh ni nj mm b">~/.ssh/github-action</code>文件中。最后一行创建一个类似如下的<code class="fe nh ni nj mm b">~/.ssh/config</code>文件:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="b58d" class="mq kg it mm b gy mr ms l mt mu">Host static<br/>  User github-actions-tutorial<br/>  IdentityFile ~/.ssh/github-action<br/>  StrictHostKeyChecking No</span></pre><p id="88f8" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">设置完成后，rsync命令看起来非常简单:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="125f" class="mq kg it mm b gy mr ms l mt mu">- run: rsync -e ssh public static:~/static<br/>- run: rsync -e ssh built/app.js static:~/static/js/app.js<br/>- run: rsync -e ssh built/server.js static:~/api/server.js</span></pre><p id="7f8e" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated"><code class="fe nh ni nj mm b">-e ssh</code>指定在ssh上使用rsync。我们从<code class="fe nh ni nj mm b">public</code>文件夹中复制所有文件。然后我们将<code class="fe nh ni nj mm b">built/app.js</code>复制到<code class="fe nh ni nj mm b">~/static/js/app.js</code>。最后我们将<code class="fe nh ni nj mm b">built/server.js</code>复制到<code class="fe nh ni nj mm b">~/api/server.js</code>。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="bcad" class="mq kg it mm b gy mr ms l mt mu">- run: ssh github-actions-tutorial "pm2 reload all"</span></pre><p id="8e1c" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">最后一行代码使用pm2(我们之前安装的)来重新加载服务器进程。</p><h1 id="b67c" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">结论</h1><p id="395d" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">虽然我可以通过在我的本地机器上运行它来获得更快的部署，但是让它作为Github动作运行为我的开源项目提供了很大的好处。为了部署贡献者的更改，我可以简单地将他们的拉请求合并到主分支中，而不必将直接的服务器访问权交给其他任何人。</p><p id="7b38" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">还有很多可以整理或改进的地方，但是本着黑客马拉松的精神，我现在称之为“完成”。我现在有了一个基线，我预计使用Github Actions构建和部署一个应用程序需要多长时间。</p><h2 id="cb31" class="mq kg it bd kh mv mw dn kl mx my dp kp lo mz na kt ls nb nc kx lw nd ne lb nf bi translated">工作流Yaml文件</h2><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="c9b7" class="mq kg it mm b gy mr ms l mt mu">name: Deploy</span><span id="c686" class="mq kg it mm b gy ng ms l mt mu">on:<br/>  push:<br/>    branches: [ main ]</span><span id="77f9" class="mq kg it mm b gy ng ms l mt mu">jobs:<br/>  build-and-deploy:</span><span id="ac07" class="mq kg it mm b gy ng ms l mt mu">runs-on: ubuntu-latest</span><span id="6a1c" class="mq kg it mm b gy ng ms l mt mu">env:<br/>      SSH_KEY: ${{secrets.SSH_KEY}}</span><span id="c753" class="mq kg it mm b gy ng ms l mt mu">steps:<br/>    - uses: actions/checkout@v2<br/>    - name: Use Node.js 16<br/>      uses: actions/setup-node@v2<br/>      with:<br/>        node-version: 16<br/>        cache: 'yarn'<br/>    - run: yarn install<br/>    - run: yarn build<br/>    - run: mkdir ~/.ssh<br/>    - run: 'echo "$SSH_KEY" &gt;&gt; ~/.ssh/github-action'<br/>    - run: chmod 400 ~/.ssh/github-action<br/>    - run: echo -e "Host github-actions-tutorial\n\tUser github-actions-tutorial\n\tHostname 143.198.32.125\n\tIdentityFile ~/.ssh/github-action\n\tStrictHostKeyChecking No" &gt;&gt; ~/.ssh/config<br/>    - run: rsync -e ssh public github-actions-tutorial:~/static<br/>    - run: rsync -e ssh built/app.js github-actions-tutorial:~/static/js/app.js<br/>    - run: rsync -e ssh built/server.js github-actions-tutorial:~/api/server.js<br/>    - run: ssh github-actions-tutorial "pm2 reload all"</span></pre><h1 id="c446" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">其他资源/信息</h1><p id="0013" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">本教程的完整代码可以在<a class="ae mg" href="https://github.com/adamjberg/github-actions-tutorial" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到</p><p id="cb59" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated">engram 是一个开源项目，在那里我第一次原型化了这种风格的部署。目前部署需要3-4分钟，这就是为什么我将切换到更接近这里提供的工作流。</p></div><div class="ab cl nk nl hx nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="im in io ip iq"><p id="61d9" class="pw-post-body-paragraph ld le it lf b lg mb li lj lk mc lm ln lo md lq lr ls me lu lv lw mf ly lz ma im bi translated"><em class="nr">最初发布于2021年12月7日</em><a class="ae mg" href="https://devtails.xyz/using-github-actions-to-deploy-a-react-app-and-express-api-over-ssh-in-15-seconds" rel="noopener ugc nofollow" target="_blank"><em class="nr">https://devtails . XYZ</em></a><em class="nr">。</em></p></div></div>    
</body>
</html>