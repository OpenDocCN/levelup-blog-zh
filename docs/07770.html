<html>
<head>
<title>Infrastructure As Code With Terraform and AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform和AWS将基础设施作为代码</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/infrastructure-as-code-with-terraform-and-aws-6c24866a56d9?source=collection_archive---------11-----------------------#2021-03-08">https://levelup.gitconnected.com/infrastructure-as-code-with-terraform-and-aws-6c24866a56d9?source=collection_archive---------11-----------------------#2021-03-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="51dd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在AWS中运行Linux服务器的简单Terraform指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/10f8286d780bb59f3ce5c1cec1109d61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JPoEFqmHdt-G4D-MefftRQ.png"/></div></div></figure><p id="5d53" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我想到这篇文章是因为我想开始使用Terraform(来自<a class="ae lq" href="https://www.google.com/search?q=HashiCorp" rel="noopener ugc nofollow" target="_blank"> HashiCorp </a>)作为一种工具来处理代码形式的基础设施，所以我决定编写一个简单的入门指南/教程，以使用AWS (Amazon Web Services)作为云提供商来设置Terraform项目。</p><p id="fce2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在基础设施建立并运行之后，我们将使用Terraform和Graphviz来实现基础设施的图形化可视化。</p><p id="4b0a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们先来了解一下Terraform的背景。</p><h1 id="3c16" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">关于地形的基础知识</h1><p id="3e5b" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">Terraform是一个工具，它允许您将基础设施视为代码。这意味着您可以创建一组定义文件来描述管理基础设施的过程，将它们存储在版本控制存储库中，并以与应用程序代码相同的方式发展您的基础设施。</p><blockquote class="mo mp mq"><p id="5c8e" class="ku kv mr kw b kx ky ju kz la lb jx lc ms le lf lg mt li lj lk mu lm ln lo lp im bi translated">Terraform是一个安全有效地构建、更改和版本控制基础设施的工具。Terraform可以管理现有的和受欢迎的服务提供商以及定制的内部解决方案。</p><p id="2672" class="ku kv mr kw b kx ky ju kz la lb jx lc ms le lf lg mt li lj lk mu lm ln lo lp im bi translated">来源:Terraform网站</p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5a9bf4ebb9036198c960e5bd5fe77907.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wsJUlDmnLqAFbh0IkH8cqg.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">地形循环</figcaption></figure><p id="0257" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要开始使用Terraform，首先需要创建一个文件，其中包含定义基础设施的资源，我们称之为<code class="fe mz na nb nc b">terraform.tf</code>。</p><p id="a6b4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当您考虑拥有基础设施的第一个版本时，您可以运行命令<code class="fe mz na nb nc b">terraform init</code>，Terraform将创建在创建基础设施时应用的初始计划。</p><p id="4fc7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有了合适的计划，你就知道哪些资源将被创建，在确认一切看起来像你所期望的之后，你就可以运行<code class="fe mz na nb nc b">terraform apply</code>。这将创建实际的基础设施。</p><p id="e02b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">基础设施就绪后，您需要通过添加新资源或更新任何现有资源来改进它。这样做之后，你就可以运行<code class="fe mz na nb nc b">terraform refresh</code>了，一个新的计划就创建好了。在验证了新计划中的更改后，您可以再次运行<code class="fe mz na nb nc b">terraform apply</code>，实际的基础设施将会更新。</p><p id="f7d5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后，如果您不再需要基础设施，您可以运行<code class="fe mz na nb nc b">terraform destroy</code>，实际的基础设施将被终止。</p><p id="b4ee" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们已经了解了Terraform的基础知识，让我们为基础设施的设置做准备，以便在AWS上运行Linux服务器。</p><h1 id="9dd4" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">安装和设置</h1><p id="5a81" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">除了安装Terraform之外，要创建基础设施，您还需要一个AWS帐户和AWS CLI(命令行界面)。本指南将使用AWS的免费资源。</p><p id="7f46" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们先在AWS <a class="ae lq" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank">官网</a>上创建一个账号。</p><p id="6913" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">创建帐户后，让我们安装AWS CLI并通过运行以下命令进行配置</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="35bc" class="nh ls it nc b gy ni nj l nk nl">aws configure</span></pre><p id="524f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您需要添加您的AWS访问密钥ID和秘密访问密钥的值，您可以在<a class="ae lq" href="https://console.aws.amazon.com/iam/home#/security_credentials$access_key" rel="noopener ugc nofollow" target="_blank"> IAM </a>服务部分找到它们。</p><p id="36e0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们已经有了一个帐户和CLI，让我们创建一个名为<code class="fe mz na nb nc b">terraform.tf</code>的文件，并将下面的内容放入文件中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">地形文件</figcaption></figure><p id="1b8d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">上面的文件将包含在AWS上运行一个Linux服务器实例所需的资源。</p><p id="5919" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，我们需要告诉Terraform，我们希望使用AWS作为我们的云提供商，我们在<code class="fe mz na nb nc b">required_providers</code>元素下添加了一个名为<code class="fe mz na nb nc b">aws</code>的配置。</p><p id="4f7d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们需要配置我们的提供商，为此我们创建了一个名为<code class="fe mz na nb nc b">aws</code>的<code class="fe mz na nb nc b">provider</code>，在里面我们描述了将被使用的AWS帐户的配置文件，以及我们希望在哪个区域创建我们的资源。</p><p id="df5d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后但同样重要的是，我们添加一个类型为<code class="fe mz na nb nc b">aws_instance</code>的<code class="fe mz na nb nc b">resource</code>，并传递与我们想要运行的Linux服务器相匹配的配置。</p><p id="9b2e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">好了，现在让我们转到AWS帐户，开始将上面文件中的概念与实际资源对应起来。</p><p id="d5e5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，进入“服务”，搜索EC2(弹性计算云)，点击它。您将进入一个页面，该页面将显示与您的帐户相关的EC2资源。搜索“启动实例”按钮并按下它。现在，您将看到AMI(Amazon机器映像)列表，检查过滤器“Free Tier ”,并复制Linux服务器名称下的AMI值。在<code class="fe mz na nb nc b">ami</code>属性中使用<code class="fe mz na nb nc b">terraform.tf</code>文件中的值。</p><p id="312c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下一步是按下“选择”按钮，选择您之前必须选择的AMI。您将看到可用实例类型的列表，从空闲层中选择一个，并将列“Type”上的值复制到<code class="fe mz na nb nc b">terraform.tf</code>文件，粘贴到<code class="fe mz na nb nc b">instance_type</code>属性中。</p><p id="bf9e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在tags部分，您可以指定将要创建的EC2实例的名称。然后，这个名称将用于AWS帐户内EC2实例表的“名称”列中。</p><p id="8294" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你现在应该可以安全地使用免费层，不需要花任何钱。</p><p id="a8f4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">⚠️ <em class="mr">始终关注你正在设置的AWS配置，并始终选择免费层，否则你可能会被收费。如果你没有任何自由层选项，并决定继续试验，我不会对你可能产生的任何费用负责。</em></p><p id="51a9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，让我们使用Terraform在AWS帐户内部创建基础设施。</p><h1 id="9606" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">初始化并运行</h1><p id="cd2a" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">现在我们已经有了Terraform文件，我们可以通过运行</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="e467" class="nh ls it nc b gy ni nj l nk nl">terraform init</span></pre><p id="6ee0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，Terraform已经下载了AWS提供者插件，并将提供者配置存储在一个名为<code class="fe mz na nb nc b">.terraform.lock.hcl</code>的文件中。</p><p id="04c7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">安装了提供者插件后，我们可以通过运行以下命令来应用Terraform配置</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="60d7" class="nh ls it nc b gy ni nj l nk nl">terraform apply</span></pre><p id="1158" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，您可以看到Terraform倾向于执行的计划，它显示了在控制台终端中输入值“yes”后将执行的操作。</p><p id="cab4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，您将在控制台输出中看到正在创建的资源，最后是Terraform添加、更改和销毁的资源的恢复。</p><p id="5a5d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你进入你的AWS账户并选择EC2，你会看到一个名为“我的Linux服务器”的实例，这就是你的Linux服务器。</p><p id="dc60" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，转到文件<code class="fe mz na nb nc b">terraform.tf</code>，在标记部分中更改实例的名称并运行</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="b5af" class="nh ls it nc b gy ni nj l nk nl">terraform refresh</span></pre><p id="9733" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这将生成一个具有新实例名称的新计划，再次运行apply命令，并在AWS帐户的EC2部分检查新名称。</p><p id="ef49" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后，我们将通过运行以下命令来终止EC2实例</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="bcd4" class="nh ls it nc b gy ni nj l nk nl">terraform destroy</span></pre><p id="efa6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，您可以在控制台终端中看到一个计划，通过写入值“yes”进行确认后，销毁资源并终止EC2实例。如果您转到您的AWS帐户并选择EC2，您将看到该实例处于“终止”状态。</p><h1 id="7f1e" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">可视化地形图</h1><p id="fc1f" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">准备好基础设施的结构后，让我们看看代表当前地形状态的图表。</p><p id="82b9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">地形命令<code class="fe mz na nb nc b">terraform graph</code>将基于文件<code class="fe mz na nb nc b">terraform.tfstate</code>生成一个图形。图形以<code class="fe mz na nb nc b">dot</code>格式生成，为了可视化，我们可以安装<a class="ae lq" href="https://graphviz.org/download/" rel="noopener ugc nofollow" target="_blank"> Graphviz </a>并通过运行以下命令使用它来生成图形的图像。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="6b61" class="nh ls it nc b gy ni nj l nk nl">terraform graph | dot -Tsvg <strong class="nc iu">&gt;</strong> graph.svg</span></pre><p id="bf62" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">生成的图表如下所示。根元素是Terraform的核心元素，其余两个节点对应于AWS provider资源和Linux服务器实例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/e1f853c661e6ebe7cf7cc86736af5d3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FStHnVPCpdrJzI_qjgmWyA.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">地形图</figcaption></figure><h2 id="7b36" class="nh ls it bd lt np nq dn lx nr ns dp mb ld nt nu md lh nv nw mf ll nx ny mh nz bi translated">包扎</h2><p id="a1fc" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">在尝试了Terraform之后，这里有一些值得一提的地方:</p><ul class=""><li id="38e7" class="oa ob it kw b kx ky la lb ld oc lh od ll oe lp of og oh oi bi translated">使用Terraform cycle并将基础设施增量更改存储在版本控制存储库中是跟踪基础设施发展和回滚的好方法，以防出现问题。</li><li id="2cea" class="oa ob it kw b kx oj la ok ld ol lh om ll on lp of og oh oi bi translated">Terraform支持多个云提供商。</li><li id="3309" class="oa ob it kw b kx oj la ok ld ol lh om ll on lp of og oh oi bi translated">“导出到图形”功能生成的图形并不是您会发现的最用户友好/人类可读的图形，尽管如此，它还是提供了一种基础设施的可视化方式。随着基础架构变得越来越复杂，分析也变得越来越复杂。</li></ul><p id="63c9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有关本文主题的更多详细信息，请查阅以下书籍:</p><ul class=""><li id="fcef" class="oa ob it kw b kx ky la lb ld oc lh od ll oe lp of og oh oi bi translated"><a class="ae lq" href="https://amzn.to/3bsICQt" rel="noopener ugc nofollow" target="_blank">devo PS手册:如何在技术组织中创造世界级的灵活性、可靠性和安全性</a></li><li id="3256" class="oa ob it kw b kx oj la ok ld ol lh om ll on lp of og oh oi bi translated"><a class="ae lq" href="https://amzn.to/2N1yC7s" rel="noopener ugc nofollow" target="_blank"> Terraform: Up &amp;运行:将基础设施写成代码</a></li><li id="b9b3" class="oa ob it kw b kx oj la ok ld ol lh om ll on lp of og oh oi bi translated"><a class="ae lq" href="https://amzn.to/3bnKgCR" rel="noopener ugc nofollow" target="_blank"> Terraform Cookbook:跨各种云平台以代码形式高效定义、启动和管理基础设施</a></li></ul><p id="aa4f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你是一个有声读物爱好者，检查一下<a class="ae lq" href="https://www.amazon.co.uk/Audible-Membership/dp/B00OPA2XFG?actionCode=AMN30DFT1Bk06604291990WX&amp;tag=20200becb-21" rel="noopener ugc nofollow" target="_blank"> Audible🎧</a>。</p><p id="6f2f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你有任何建议或贡献，欢迎在下面评论。编码快乐！</p><p id="eac2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><em class="mr">本文是使用以下参考资料构建的:</em></p><ul class=""><li id="1335" class="oa ob it kw b kx ky la lb ld oc lh od ll oe lp of og oh oi bi translated"><a class="ae lq" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> <em class="mr"> Terraform网站</em> </a></li><li id="0874" class="oa ob it kw b kx oj la ok ld ol lh om ll on lp of og oh oi bi translated"><a class="ae lq" href="https://graphviz.org/" rel="noopener ugc nofollow" target="_blank"> <em class="mr"> Graphviz网站</em> </a></li><li id="320d" class="oa ob it kw b kx oj la ok ld ol lh om ll on lp of og oh oi bi translated"><a class="ae lq" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> <em class="mr">亚马逊网络服务网站</em> </a></li></ul></div></div>    
</body>
</html>