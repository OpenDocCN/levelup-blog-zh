<html>
<head>
<title>Observability of SpringBoot Services in K8s with Prometheus and Grafana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Prometheus和Grafana对K8s中跳羚服务的可观测性</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/observability-of-springboot-services-in-k8s-with-prometheus-and-grafana-61c4e7a9d814?source=collection_archive---------5-----------------------#2020-07-01">https://levelup.gitconnected.com/observability-of-springboot-services-in-k8s-with-prometheus-and-grafana-61c4e7a9d814?source=collection_archive---------5-----------------------#2020-07-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6a4e83a61e9dfcb2278d2f9dd4fbeaf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*f6BxR2l_1rcJJj_d.png"/></div></div></figure><p id="fae6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在kubernetes (k8s)中，我们可以与Prometheus和Grafana一起监控我们的春装服务并获得关于它的见解。</p><p id="8b24" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">继续我们之前的帖子，<a class="ae kw" href="https://medium.com/@lightphos/spring-data-rest-service-on-kubernetes-675dcbbdffc6" rel="noopener">春季数据来自Kubernetes </a>。我们向<strong class="ka ir"> vadal-data-rest </strong>服务pom.xml添加以下依赖项</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="4403" class="lg lh iq lc b gy li lj l lk ll">&lt;!-- Micrometer Prometheus registry  --&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;io.micrometer&lt;/groupId&gt;<br/>    &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;<br/>&lt;/dependency&gt;</span></pre><p id="45b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">构建映像并部署到k8s </strong></p><blockquote class="lm ln lo"><p id="4a7f" class="jy jz lp ka b kb kc kd ke kf kg kh ki lq kk kl km lr ko kp kq ls ks kt ku kv ij bi translated">mvn spring-boot:构建映像</p></blockquote><p id="4426" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">docker图像应该有一个更新</p><blockquote class="lm ln lo"><p id="cb8d" class="jy jz lp ka b kb kc kd ke kf kg kh ki lq kk kl km lr ko kp kq ls ks kt ku kv ij bi translated"><em class="iq">docker images<br/>vadal-data-rest 0 . 0 . 1-SNAPSHOT</em></p></blockquote><p id="7f21" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">告诉k8s更新吊舱中的图像:</p><blockquote class="lm ln lo"><p id="b478" class="jy jz lp ka b kb kc kd ke kf kg kh ki lq kk kl km lr ko kp kq ls ks kt ku kv ij bi translated"><em class="iq"> kubectl补丁部署vadal-data-rest-p ' { " spec ":{ " template ":{ " spec ":{ " terminationgraceperiodes ":29 } } } '</em></p></blockquote><h1 id="85bc" class="lt lh iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">普罗米修斯</h1><p id="cabd" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">删除任何旧的安装。</p><blockquote class="lm ln lo"><p id="f744" class="jy jz lp ka b kb kc kd ke kf kg kh ki lq kk kl km lr ko kp kq ls ks kt ku kv ij bi translated"><em class="iq">圣盔德尔——清洗普罗米修斯</em></p></blockquote><p id="8975" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装它。</p><blockquote class="lm ln lo"><p id="93b2" class="jy jz lp ka b kb kc kd ke kf kg kh ki lq kk kl km lr ko kp kq ls ks kt ku kv ij bi translated"><em class="iq">舵安装—等待—命名普罗米修斯—设置service.type=NodePort，service . node port = 9090 stable/普罗米修斯</em></p></blockquote><p id="d320" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意本地集群url，<strong class="ka ir">Prometheus-server . default . SVC . cluster . local，</strong>我们将需要它来连接grafana。</p><p id="5aaa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使其在端口30001上可用</p><blockquote class="lm ln lo"><p id="af07" class="jy jz lp ka b kb kc kd ke kf kg kh ki lq kk kl km lr ko kp kq ls ks kt ku kv ij bi translated"><em class="iq"> kubectl编辑svc/prometheus-server </em></p></blockquote><p id="8be3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并将节点端口更改为30001</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="3b7b" class="lg lh iq lc b gy li lj l lk ll">ports:<br/>  - name: http<br/>    nodePort: 30001<br/>    port: 80<br/>    protocol: TCP<br/>    targetPort: 9090<br/>  selector:<br/>    app: prometheus<br/>    component: server<br/>    release: prometheus<br/>  sessionAffinity: None<br/>  type: NodePort</span></pre><p id="14be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">导航到</p><p id="ec84" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="http://localhost:30001/graph" rel="noopener ugc nofollow" target="_blank">http://localhost:30001/</a></p><p id="3a34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你应该看看普罗米修斯仪表盘。增加prometheus与vadal-data-rest服务的连接:</p><blockquote class="lm ln lo"><p id="64b6" class="jy jz lp ka b kb kc kd ke kf kg kh ki lq kk kl km lr ko kp kq ls ks kt ku kv ij bi translated"><em class="iq"> kubectl编辑svc/vadal-data-rest </em></p></blockquote><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="984a" class="lg lh iq lc b gy li lj l lk ll">apiVersion: v1<br/> kind: Service<br/> metadata:<br/>   annotations:<br/>      prometheus.io/path: /actuator/prometheus<br/>      prometheus.io/port: "7777"<br/>      prometheus.io/scrape: "true"<br/>   name: vadal-data-rest</span></pre><p id="2bf5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">导航到普罗米修斯状态&gt;目标，vadal-data-rest应该显示为一个端点。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/d51627e44412a03ced84ff6aeb51319b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gn6RVwGs5bvEIaFD.png"/></div></div></figure><p id="94ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意:prometheus默认每15秒抓取一次数据。</p><h2 id="09df" class="lg lh iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">格拉夫纳</h2><p id="708d" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">添加grafana为您提供了一个很好的仪表盘来观察您的服务。</p><p id="6f3d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">安装</strong></p><blockquote class="lm ln lo"><p id="ce69" class="jy jz lp ka b kb kc kd ke kf kg kh ki lq kk kl km lr ko kp kq ls ks kt ku kv ij bi translated"><em class="iq">舵安装——名称grafana stable/grafana </em></p></blockquote><p id="85c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使其在端口30002上可用</p><blockquote class="lm ln lo"><p id="bcad" class="jy jz lp ka b kb kc kd ke kf kg kh ki lq kk kl km lr ko kp kq ls ks kt ku kv ij bi translated"><em class="iq"> kubectl编辑svc/grafana </em></p></blockquote><p id="1462" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并将节点端口更改为30002</p><p id="0e89" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">登录<a class="ae kw" href="http://localhost:30002/?orgId=1" rel="noopener ugc nofollow" target="_blank">http://localhost:30002/</a></p><p id="c07d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用户名是admin</p><p id="413a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于密码:</p><blockquote class="lm ln lo"><p id="7c1f" class="jy jz lp ka b kb kc kd ke kf kg kh ki lq kk kl km lr ko kp kq ls ks kt ku kv ij bi translated"><em class="iq"> kubectl get secret —名称空间默认graf ana-o JSON path = " { . data . admin-password } " | base64—decode</em></p></blockquote><p id="dd78" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将grafana连接到普罗米修斯作为数据源。配置数据源为服务器，url为<strong class="ka ir">prometheus-server . default . SVC . cluster . local</strong>(安装Prometheus时会输出)。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/ddf2242144dd31d436228efc0255d91c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*l_uB_ukkNl4pozoA.png"/></div></div></figure><p id="7526" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用id <strong class="ka ir"> 10280 </strong>导入弹簧靴2.1仪表板:</p><p id="694e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您应该会得到与此类似的结果:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/e157aabc4795d48717fe19f9d5a2e82e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gJtkw3d-JoDw3fS3.png"/></div></div></figure><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/db78d602caf368e90cda4220d2e3f99f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Qk4GZ5nsYq9QBLJ7.png"/></div></div></figure><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/4b94d61d5ca505e3d6baade807b48791.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wBOLEj8lqDXt2T0e.png"/></div></div></figure><h1 id="72de" class="lt lh iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">结论</h1><p id="4ca1" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">对于spring boot服务监控，所需要的只是micrometer-registry-prometheus依赖关系。有了头盔，安装普罗米修斯和格拉夫纳都很简单。一个额外的步骤是将rest服务指向prometheus，这也可以用一个服务yml文件来完成。使用grafana，您可以查看所有公开的spring指标。</p><p id="9b48" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下一步<a class="ae kw" href="https://medium.com/@lightphos/logs-from-k8s-with-kibana-elasticsearch-and-fluentd-337224e46397" rel="noopener">记录</a>。</p><p id="b425" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lp">参见:</em></p><p id="2384" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://developer.ibm.com/technologies/containers/tutorials/monitoring-kubernetes-prometheus/" rel="noopener ugc nofollow" target="_blank">https://developer . IBM . com/technologies/containers/tutorials/monitoring-kubernetes-Prometheus/</a></p></div><div class="ab cl nl nm hu nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ij ik il im in"><p id="9ebf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lp">原载于2020年7月1日</em><a class="ae kw" href="https://blog.ramjee.uk/observability-in-k8s/" rel="noopener ugc nofollow" target="_blank"><em class="lp">https://blog . ram JEE . uk</em></a><em class="lp">。</em></p></div></div>    
</body>
</html>