<html>
<head>
<title>Tracking Service with Go and Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Go和Redis跟踪服务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/tracking-service-with-go-and-redis-efa9f3c1d130?source=collection_archive---------0-----------------------#2018-08-09">https://levelup.gitconnected.com/tracking-service-with-go-and-redis-efa9f3c1d130?source=collection_archive---------0-----------------------#2018-08-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f07c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://medium.com/@douglasmakey/tracking-service-with-go-and-redis-v2-8701026e0e23" rel="noopener">第二部分:Go和Redis V2公司的跟踪服务</a></p><p id="9f26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">想象一下，我们在像优步这样的初创公司工作，我们需要创建一个新的服务，在每个给定的时间保存司机的位置并处理它。这样，当有人需要司机时，我们可以找到离我们的上车点最近的司机。</p><p id="d813" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我们服务的核心。保存位置并搜索附近的司机。对于这项服务，我们使用Go和Redis。</p><h1 id="1bca" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">雷迪斯</h1><p id="a094" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated"><a class="ae kl" href="http://redis.io/" rel="noopener ugc nofollow" target="_blank"> Redis </a>是一个开源的(BSD许可的)、内存中的数据结构存储，用作数据库、缓存和消息代理。它支持数据结构，如字符串、哈希、列表、集合、带有范围查询的排序集合、位图、超级日志和带有radius查询的地理空间索引。</p><p id="48de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Redis有多种功能，但是对于本服务的目的，我们将重点关注它的地理空间功能。</p><p id="0067" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先我们需要安装Redis。我推荐使用Docker运行带有Redis的容器。通过简单地执行这个命令，我们将在我们的机器上拥有一个运行Redis的容器。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="2829" class="ly kn iq lu b gy lz ma l mb mc">docker run -d -p 6379:6379 redis</span></pre><h1 id="9c3e" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">让我们开始编码吧</h1><p id="1b94" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我们将为这个服务编写一个基本的实现，因为我想写一些关于如何改进这个服务的文章。我将把这段代码作为我下一篇文章的基础。</p><p id="0c2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于这个服务，我们需要使用为Golang提供redis客户端的包“github.com/go-redis/redis”。</p><p id="cb42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在您的工作目录中创建新项目(文件夹)。在我的例子中，我称之为“跟踪”。首先我们需要安装软件包。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="c31f" class="ly kn iq lu b gy lz ma l mb mc">go get -u github.com/go-redis/redis</span></pre><p id="ede4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们创建文件“storages/redis.go ”,其中包含的实现将帮助我们获得一个redis客户端和一些功能来处理地理空间。</p><p id="0fcb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在创建一个包含指向redis客户机的指针的结构。这个指针将具有帮助我们使用这个服务的函数，我们还为redis中的集合创建一个带有键名的常量。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="f8e2" class="ly kn iq lu b gy lz ma l mb mc">type RedisClient struct { *redis.Client }<br/>const key = "drivers"</span></pre><p id="77a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于获取Redis客户端的函数，我们将在sync包及其Once的帮助下使用singleton模式。做功能。</p><p id="6167" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在软件工程中，单例模式是一种软件设计模式，它将一个类的实例化限制在一个对象上。当只需要一个对象来协调整个系统的动作时，这很有用。如果你想了解更多关于<a class="ae kl" href="https://en.wikipedia.org/wiki/Singleton_pattern" rel="noopener ugc nofollow" target="_blank">单身模式</a>的信息。</p><p id="2bb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是<code class="fe md me mf lu b">once.Do</code>是如何工作的呢？struct <code class="fe md me mf lu b">sync.Once</code>有一个原子计数器，当函数被调用时，它使用<code class="fe md me mf lu b">atomic.StoreUint32</code>将值设置为1，然后使用<code class="fe md me mf lu b">atomic.LoadUint32</code>查看是否需要再次调用。对于这个基本实现，将从两个端点调用GetRedisClient，但我们只想获得一个实例。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="1737" class="ly kn iq lu b gy lz ma l mb mc">var once sync.Once<br/>var redisClient *RedisClient</span><span id="9a94" class="ly kn iq lu b gy mg ma l mb mc">func GetRedisClient() *RedisClient {<br/>    once.Do(func() {<br/>        client := redis.NewClient(&amp;redis.Options{<br/>            Addr:     "localhost:6379",<br/>            Password: "", // no password set<br/>            DB:       0,  // use default DB<br/>        })</span><span id="0aa9" class="ly kn iq lu b gy mg ma l mb mc">        redisClient = &amp;RedisClient{client}<br/>    })</span><span id="fa8d" class="ly kn iq lu b gy mg ma l mb mc">    _, err := redisClient.Ping().Result()<br/>    if err != nil {<br/>        log.Fatalf("Could not connect to redis %v", err)<br/>    }</span><span id="f540" class="ly kn iq lu b gy mg ma l mb mc">    return redisClient<br/>}</span></pre><p id="c761" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们为RedisClient创建三个函数。</p><p id="7dcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AddDriverLocation:将指定的地理空间项目(纬度、经度、名称“在这种情况下，名称是驱动程序id”)添加到指定的键，还记得我们在Redis中为我们的集合在开始时定义的键吗？这就是了。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="9c31" class="ly kn iq lu b gy lz ma l mb mc">func (c *RedisClient) AddDriverLocation(lng, lat float64, id string) {<br/>    c.GeoAdd(<br/>        key,<br/>        &amp;redis.GeoLocation{Longitude: lng, Latitude: lat, Name: id},<br/>    )<br/>}</span></pre><p id="1514" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">RemoveDriverLocation:客户端redis没有函数GEODEL，因为GeoDel命令不存在，所以我们可以使用ZREM来删除元素。地理索引结构只是一个有序的集合。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="d859" class="ly kn iq lu b gy lz ma l mb mc">func (c *RedisClient) RemoveDriverLocation(id string) {<br/>    c.ZRem(key, id)<br/>}</span></pre><p id="23cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SearchDrivers:函数GEORADIUS实现了命令GeoRadius，该命令返回使用GEOADD填充了地理空间信息的排序集的成员，这些成员位于由中心位置和距中心的最大距离(半径)指定的区域的边界内。如果你想了解更多这方面的知识，去<a class="ae kl" href="https://redis.io/commands/georadius" rel="noopener ugc nofollow" target="_blank"> GEORADIUS </a></p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="3232" class="ly kn iq lu b gy lz ma l mb mc">func (c *RedisClient) SearchDrivers(limit int, lat, lng, r float64) []redis.GeoLocation {<br/>    /*</span><span id="f7b7" class="ly kn iq lu b gy mg ma l mb mc">WITHDIST: Also return the distance of the returned items from    the specified center. The distance is returned in the same unit as the unit specified as the radius argument of the command.<br/>    <br/>WITHCOORD: Also return the longitude,latitude coordinates of the  matching items.<br/>    <br/>WITHHASH: Also return the raw geohash-encoded sorted set score of the item, in the form of a 52 bit unsigned integer. This is only useful for low level hacks or debugging and is otherwise of little interest for the general user.</span><span id="2fdb" class="ly kn iq lu b gy mg ma l mb mc">     */</span><span id="25ee" class="ly kn iq lu b gy mg ma l mb mc">    res, _ := c.GeoRadius(key, lng, lat, &amp;redis.GeoRadiusQuery{<br/>        Radius:      r,<br/>        Unit:        "km",<br/>        WithGeoHash: true,<br/>        WithCoord:   true,<br/>        WithDist:    true,<br/>        Count:       limit,<br/>        Sort:        "ASC",<br/>    }).Result()</span><span id="4829" class="ly kn iq lu b gy mg ma l mb mc">    return res<br/>}</span></pre><p id="b440" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，创建一个main.go</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="e298" class="ly kn iq lu b gy lz ma l mb mc">package main</span><span id="f26a" class="ly kn iq lu b gy mg ma l mb mc">import (<br/>    "net/http"<br/>    "fmt"<br/>    "log"<br/>)</span><span id="2957" class="ly kn iq lu b gy mg ma l mb mc">func main() {<br/>    // We create a simple httpserver<br/>    server := http.Server{<br/>        Addr:    fmt.Sprint(":8000"),<br/>        Handler: NewHandler(),<br/>    }</span><span id="84e9" class="ly kn iq lu b gy mg ma l mb mc">    // Run server<br/>    log.Printf("Starting HTTP Server. Listening at %q", server.Addr)<br/>    if err := server.ListenAndServe(); err != nil {<br/>        log.Printf("%v", err)<br/>    } else {<br/>        log.Println("Server closed ! ")<br/>    }</span><span id="8e57" class="ly kn iq lu b gy mg ma l mb mc">}</span></pre><p id="bc1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用http.Server创建了一个简单的服务器。</p><p id="d2fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们创建包含应用程序端点的文件“handler/handler.go”。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="5af8" class="ly kn iq lu b gy lz ma l mb mc">func NewHandler() *http.ServeMux {<br/>    mux := http.NewServeMux()<br/>    mux.HandleFunc("tracking", tracking)<br/>    mux.HandleFunc("search", search)<br/>    return mux<br/>}</span></pre><p id="87d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们用http。为了处理端点，我们为服务创建了两个端点。</p><p id="8b20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一个端点“跟踪”让我们保存从驱动程序发送的最后一个位置，在这种情况下，我们只想保存最后一个位置。我们可以修改这个端点，以便将以前的位置保存在另一个数据库中</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="fe6c" class="ly kn iq lu b gy lz ma l mb mc">func tracking(w http.ResponseWriter, r *http.Request) {<br/>    // crate an anonymous struct for driver data.<br/>    var driver = struct {<br/>        ID string `json:"id"`<br/>        Lat float64 `json:"lat"`<br/>        Lng float64 `json:"lng"`<br/>    }{}</span><span id="ee81" class="ly kn iq lu b gy mg ma l mb mc">    rClient := storages.GetRedisClient()</span><span id="c59a" class="ly kn iq lu b gy mg ma l mb mc">    if err := json.NewDecoder(r.Body).Decode(&amp;driver); err != nil {<br/>        log.Printf("could not decode request: %v", err)<br/>        http.Error(w, "could not decode request", http.StatusInternalServerError)<br/>        return<br/>    }</span><span id="6112" class="ly kn iq lu b gy mg ma l mb mc">    // Add new location<br/>    // You can save locations in another db<br/>    rClient.AddDriverLocation(driver.Lng, driver.Lat, driver.ID)</span><span id="f966" class="ly kn iq lu b gy mg ma l mb mc">    w.WriteHeader(http.StatusOK)<br/>    return<br/>}</span></pre><p id="526f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二个端点是“搜索”,利用这个端点，我们可以找到给定点附近的所有驾驶员，</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="e7f7" class="ly kn iq lu b gy lz ma l mb mc">// search receives lat and lng of the picking point and searches drivers about this point.<br/>func search(w http.ResponseWriter, r *http.Request) {<br/>    rClient := storages.GetRedisClient()</span><span id="8273" class="ly kn iq lu b gy mg ma l mb mc">    body := struct {<br/>        Lat float64 `json:"lat"`<br/>        Lng float64 `json:"lng"`<br/>        Limit int `json:"limit"`<br/>    }{}</span><span id="79bb" class="ly kn iq lu b gy mg ma l mb mc">    if err := json.NewDecoder(r.Body).Decode(&amp;body); err != nil {<br/>        log.Printf("could not decode request: %v", err)<br/>        http.Error(w, "could not decode request", http.StatusInternalServerError)<br/>        return<br/>    }</span><span id="f64d" class="ly kn iq lu b gy mg ma l mb mc">    drivers := rClient.SearchDrivers(body.Limit, body.Lat, body.Lng, 15)<br/>    data, err := json.Marshal(drivers)<br/>    if err != nil {<br/>        http.Error(w, err.Error(), http.StatusInternalServerError)<br/>        return<br/>    }</span><span id="7066" class="ly kn iq lu b gy mg ma l mb mc">    w.Header().Set("Content-Type", "application/json")<br/>    w.WriteHeader(http.StatusOK)<br/>    w.Write(data)<br/>    return<br/>}</span></pre><h1 id="841b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">让我们测试一下服务</h1><p id="3ebf" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">首先，运行服务器。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="05df" class="ly kn iq lu b gy lz ma l mb mc">go run main.go</span></pre><p id="81aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们需要添加四个驱动程序位置。</p><figure class="lp lq lr ls gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mh"><img src="../Images/5bcadb8502a40fe2cf67d503380256af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3tDw5iOrNbrGf8yD"/></div></div></figure><p id="fb5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在地图上添加了四个司机，绿色的线显示了提货点和司机之间的距离。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="3fb1" class="ly kn iq lu b gy lz ma l mb mc">curl -i --header "Content-Type: application/json" --data '{"id": "1", "lat": -33.44091, "lng": -70.6301}' http://localhost:8000/tracking</span><span id="7ec1" class="ly kn iq lu b gy mg ma l mb mc">curl -i --header "Content-Type: application/json" --data '{"id": "2", "lat": -33.44005, "lng": -70.63279}' http://localhost:8000/tracking</span><span id="28d4" class="ly kn iq lu b gy mg ma l mb mc">curl -i --header "Content-Type: application/json" --data '{"id": "3", "lat": -33.44338, "lng": -70.63335}' http://localhost:8000/tracking</span><span id="f9ea" class="ly kn iq lu b gy mg ma l mb mc">curl -i --header "Content-Type: application/json" --data '{"id": "4", "lat": -33.44186, "lng": -70.62653}' <a class="ae kl" href="http://localhost:8000/tracking" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/tracking</a></span></pre><p id="0543" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然我们现在有了司机的位置，我们可以进行空间搜索。</p><p id="7e47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将寻找附近的4名司机</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="865d" class="ly kn iq lu b gy lz ma l mb mc">curl -i --header "Content-Type: application/json" --data '{"lat": -33.44262, "lng": -70.63054, "limit": 5}' <a class="ae kl" href="http://localhost:8000/search" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/search</a></span></pre><p id="6618" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于您将看到结果与地图匹配，请查看地图中的绿色线条。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="eaae" class="ly kn iq lu b gy lz ma l mb mc">HTTP/1.1 200 OK<br/>Content-Type: application/json<br/>Date: Wed, 08 Aug 2018 05:07:57 GMT<br/>Content-Length: 456</span><span id="0491" class="ly kn iq lu b gy mg ma l mb mc">[<br/>    {<br/>        "Name": "1",<br/>        "Longitude": -70.63009768724442,<br/>        "Latitude": -33.44090957099124,<br/>        "Dist": 0.1946,<br/>        "GeoHash": 861185092131738<br/>    },<br/>    {<br/>        "Name": "3",<br/>        "Longitude": -70.63334852457047,<br/>        "Latitude": -33.44338092412159,<br/>        "Dist": 0.2741,<br/>        "GeoHash": 861185074815667<br/>    },<br/>    {<br/>        "Name": "2",<br/>        "Longitude": -70.63279062509537,<br/>        "Latitude": -33.44005030051822,<br/>        "Dist": 0.354,<br/>        "GeoHash": 861185086448695<br/>    },<br/>    {<br/>        "Name": "4",<br/>        "Longitude": -70.62653034925461,<br/>        "Latitude": -33.44186009142599,<br/>        "Dist": 0.3816,<br/>        "GeoHash": 861185081504625<br/>    }<br/>]</span></pre><p id="1cd3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查找最近的司机</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="93a8" class="ly kn iq lu b gy lz ma l mb mc">curl -i --header "Content-Type: application/json" --data '{"lat": -33.44262, "lng": -70.63054, "limit": 1}' <a class="ae kl" href="http://localhost:8000/search" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/search</a></span></pre><p id="3533" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="1ec2" class="ly kn iq lu b gy lz ma l mb mc">HTTP/1.1 200 OK<br/>Content-Type: application/json<br/>Date: Wed, 08 Aug 2018 05:12:24 GMT<br/>Content-Length: 115</span><span id="c03b" class="ly kn iq lu b gy mg ma l mb mc">[{"Name":"1","Longitude":-70.63009768724442,"Latitude":-33.44090957099124,"Dist":0.1946,"GeoHash":861185092131738}]</span></pre><p id="ee31" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/douglasmakey/tracking" rel="noopener ugc nofollow" target="_blank"> Github回购</a></p></div></div>    
</body>
</html>