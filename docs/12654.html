<html>
<head>
<title>How to Set Up Your Local Environment to Work With GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何设置您的本地环境以便与GCP一起工作</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-set-up-your-local-environment-to-work-with-gcp-4ed0a11421ef?source=collection_archive---------4-----------------------#2022-06-27">https://levelup.gitconnected.com/how-to-set-up-your-local-environment-to-work-with-gcp-4ed0a11421ef?source=collection_archive---------4-----------------------#2022-06-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="674b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">学会在几分钟内处理GCP本地认证</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1f514f53ceef5306903e5a8192f91b60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HekmzhVB73w2rrth.jpg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://pixabay.com/illustrations/cloud-computer-backup-technology-3998880/" rel="noopener ugc nofollow" target="_blank">凯蒂尔怀特91 </a>在皮克斯拜拍摄</figcaption></figure><p id="59c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你在谷歌云平台(GCP)上工作，适当地设置你的本地环境可以让你的生活更容易。处理所有本质的认证问题可能会很头疼，尤其是当你刚刚开始与GCP合作的时候。不要担心，在这篇文章中，我们将介绍gcloud CLI、Google客户端库和Docker的常用设置，这些设置对于您的日常开发工作至关重要。我们还将介绍如何在本地使用服务帐户。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="9ece" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">安装谷歌云SDK</h2><p id="83b3" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">请按照<a class="ae ky" href="https://cloud.google.com/sdk/docs/install-sdk#deb" rel="noopener ugc nofollow" target="_blank">这个官方链接</a>安装Google Cloud SDK，它提供了不同操作系统的分步说明。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="bbe0" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">验证Google Cloud SDK</h2><p id="4a2d" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果是第一次使用Google Cloud SDK，需要初始化gcloud CLI:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="7df5" class="mc md it nb b gy nf ng l nh ni">$ gcloud init</span></pre><p id="0f78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按照控制台上的说明创建新配置。如果您已经为某个帐户创建了配置，但需要以另一个帐户的身份登录，您可以运行以下命令以另一个帐户的身份登录:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="7872" class="mc md it nb b gy nf ng l nh ni">$ gcloud auth login</span></pre><p id="4173" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">浏览器将为这两个命令打开，你将被要求登录到与GCP项目相关的谷歌帐户。</p><p id="bd86" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">登录后，您可以使用以下命令检查您的身份验证:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="2b36" class="mc md it nb b gy nf ng l nh ni">$ gcloud auth list</span></pre><p id="0253" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您应该能够查看关于GCP的资源了。例如，您可以使用<code class="fe nj nk nl nb b"><a class="ae ky" href="https://lynn-kwong.medium.com/how-to-use-gsutil-and-python-to-deal-with-files-in-google-cloud-storage-fc4f430b3b28" rel="noopener">gsutil</a></code>命令检查Google存储桶:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="c5ce" class="mc md it nb b gy nf ng l nh ni">$ gsutil ls</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="a7ce" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">验证Google客户端库</h2><p id="c7d3" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">以上认证方式只认证gcloud CLI，不认证Google客户端库。我们还需要验证需要与Google APIs交互的应用程序。为此，我们需要运行<a class="ae ky" href="https://cloud.google.com/sdk/gcloud/reference/auth/application-default/login" rel="noopener ugc nofollow" target="_blank">这个命令</a>:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="7b20" class="mc md it nb b gy nf ng l nh ni">$ gcloud auth application-default login</span></pre><p id="724c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">浏览器将再次打开，您需要选择Google帐户进行身份验证。注意，该命令独立于上面的<code class="fe nj nk nl nb b">gcloud auth</code>或<code class="fe nj nk nl nb b">gcloud auth login</code>命令。在对gcloud CLI进行身份验证后，您始终需要显式运行此命令。</p><p id="7750" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在使用上面的命令对应用程序进行身份验证之后，您应该能够使用Google客户端库访问您的资源。例如，让我们用Python列出所有的Google存储桶:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="a9a2" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">鉴定码头工人</h2><p id="9011" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">到目前为止，如果你试图从Google Artifact/Container注册表中拉出一些图像，你会有权限问题，因为你需要显式地认证Docker，默认认证和默认应用程序认证都不会起作用。</p><p id="d36a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们开始之前，知道在Linux上安装了<a class="ae ky" href="https://en.wikipedia.org/wiki/Snap_(software)" rel="noopener ugc nofollow" target="_blank"> Snap </a>的Docker可能无法使用下面显示的命令正常工作是非常重要的。最好从<a class="ae ky" href="https://docs.docker.com/engine/install/ubuntu/" rel="noopener ugc nofollow" target="_blank">官方网站</a>安装Docker，而不是用Snap甚至“handy”<code class="fe nj nk nl nb b"><a class="ae ky" href="https://get.docker.com/" rel="noopener ugc nofollow" target="_blank">get_docker</a></code><a class="ae ky" href="https://get.docker.com/" rel="noopener ugc nofollow" target="_blank">脚本</a>。</p><p id="2470" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">验证Docker的命令是:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="bf4f" class="mc md it nb b gy nf ng l nh ni">$ gcloud auth configure-docker eu.gcr.io</span></pre><p id="2568" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意最好也指定区域注册中心，否则，<code class="fe nj nk nl nb b">docker build</code>会很慢，因为您需要处理所有可用的注册中心，即使它们没有被使用。</p><p id="59fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，如果您被授予了这样做的权限，您将能够从工件/容器注册表中拉出/推入。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="e956" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">使用服务帐户</h2><p id="f8a3" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果您需要手动检查或更改一些资源，您应该使用您的个人谷歌帐户，该帐户已添加到您自己或您的小组的GCP项目中。然而，如果您需要在代码中以编程方式做一些事情，这通常意味着使用Google APIs，如<a class="ae ky" href="https://lynn-kwong.medium.com/how-to-use-gsutil-and-python-to-deal-with-files-in-google-cloud-storage-fc4f430b3b28" rel="noopener">存储</a>、<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-google-pub-sub-to-build-an-asynchronous-messaging-system-in-python-3b43094627dc">发布/订阅</a>、<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-write-logs-to-google-cloud-logging-in-python-46e7b514c60b">日志</a>等，最好使用通常具有有限和专用权限/角色的服务帐户。</p><p id="1720" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的应用程序托管在计算引擎、应用引擎、云运行等GCP资源上。您可以将具有特定角色的服务帐户附加到您的目标服务，而不需要担心其他任何事情。</p><p id="6eb6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，当您在本地开发代码时，使用服务帐户就不那么简单了。如果你的个人Google账户有足够的权限来执行编程动作，你可以运行如上所示的<code class="fe nj nk nl nb b">gcloud auth application-default login</code>来验证你的应用程序，然后可以直接在你的代码中使用Google APIs。</p><p id="26bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，如果你的个人谷歌帐户权限有限，你必须使用一个<a class="ae ky" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">服务帐户</a>，你可以下载(或要求…)服务帐户的JSON密钥，并使用它在你的应用程序中认证谷歌客户端库。尽管如果您的应用程序没有托管在GCP基础设施上，建议使用"<a class="ae ky" href="https://cloud.google.com/iam/docs/workload-identity-federation?_ga=2.115992518.-1545168142.1635322660" rel="noopener ugc nofollow" target="_blank">Workload Identity Federation</a>"来验证您的应用程序，但使用JSON密钥仍然很常见，因为它们更方便。但是，您必须非常小心您的JSON键，不要意外地暴露它们。最重要的是，永远不要将它们添加到您的公共存储库中。这是因为拥有这些JSON密钥的任何人都可以直接访问和操纵您的GCP资源！</p><p id="1daf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">服务帐户的JSON键的一个实际用例是用于一些第三方CI/CD管道，如GitLab，其中您需要构建一个Docker映像并将其推送到GCP工件/容器注册表，这将在后面的帖子中介绍。</p><p id="a7be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要使用服务帐户对您的应用程序进行身份验证，您需要运行以下命令，将JSON键的路径设置为预定义的环境变量<code class="fe nj nk nl nb b">GOOGLE_APPLICATION_CREDENTIALS</code>:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="31bb" class="mc md it nb b gy nf ng l nh ni">$ export <strong class="nb iu">GOOGLE_APPLICATION_CREDENTIALS</strong>=path/to/JSON_key.json</span></pre><p id="9b4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，环境变量的名称必须与此处显示的名称完全一致。它将被谷歌客户端库自动使用。此外，需要注意的是，该环境变量的优先级高于由<code class="fe nj nk nl nb b">gcloud auth application-default login</code>设置的凭证，这意味着您可以使用自己的Google帐户进行默认应用程序认证，并在需要时为不同的应用程序使用不同的服务帐户。</p><p id="a275" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了这个环境变量集，您不再需要在代码中显式地处理服务帐户。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="b3bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本帖中，我们介绍了一些常见的设置，这些设置对于设置您的本地环境以使用GCP非常重要。如果你的开发者的Google帐户有足够的权限，通常就是这样，那么设置应该相当简单，你不需要为服务帐户费心。尽管如此，当真正需要一个服务帐户时，您只需下载它的JSON密钥，并将本地路径设置为环境变量<code class="fe nj nk nl nb b">GOOGLE_APPLICATION_CREDENTIALS</code>，然后一切都会如预期的那样工作。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="cdba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相关文章:</p><ul class=""><li id="e3bb" class="no np it lb b lc ld lf lg li nq lm nr lq ns lu nt nu nv nw bi translated"><a class="ae ky" href="https://lynn-kwong.medium.com/how-to-use-gsutil-and-python-to-deal-with-files-in-google-cloud-storage-fc4f430b3b28" rel="noopener">如何使用gsutil和Python处理Google云存储中的文件</a></li><li id="e196" class="no np it lb b lc nx lf ny li nz lm oa lq ob lu nt nu nv nw bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-write-logs-to-google-cloud-logging-in-python-46e7b514c60b">如何用Python写日志到Google云日志</a></li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c4f3" class="oc md it bd me od oe of mh og oh oi mk jz oj ka mn kc ok kd mq kf ol kg mt om bi translated">分级编码</h1><p id="91d5" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">感谢您成为我们社区的一员！更多内容请参见<a class="ae ky" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>。<br/>跟随:<a class="ae ky" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a>，<a class="ae ky" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">领英</a>，<a class="ae ky" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">通迅</a> <br/> <strong class="lb iu">升一级正在改造理工大招聘➡️ </strong> <a class="ae ky" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">加入我们的人才集体</strong> </a></p></div></div>    
</body>
</html>