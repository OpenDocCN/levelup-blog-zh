<html>
<head>
<title>Reduce Azure Pipelines Xcode Build Time by 80% Through CocoaPods Caching</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过CocoaPods缓存将Azure Pipelines Xcode构建时间减少80%</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/reduce-azure-pipelines-xcode-build-time-by-80-through-cocoapods-caching-5c2de0f657df?source=collection_archive---------4-----------------------#2020-08-24">https://levelup.gitconnected.com/reduce-azure-pipelines-xcode-build-time-by-80-through-cocoapods-caching-5c2de0f657df?source=collection_archive---------4-----------------------#2020-08-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="68b9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你曾经在一个<a class="ae ko" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/get-started/what-is-azure-pipelines?view=azure-devops" rel="noopener ugc nofollow" target="_blank"> Azure管道</a>中使用<a class="ae ko" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/xcode?view=azure-devops" rel="noopener ugc nofollow" target="_blank"> Xcode构建和发布任务</a>用CocoaPods构建过一个iOS应用，你就会知道这需要很长时间。你添加的每一个额外的pod似乎都增加了构建任务的时间，在你知道它之前，你的iOS应用需要30分钟到一个小时以上的时间来构建。当您试图快速地推动和测试变更时，这既是一个不便，也是使用更多pod的巨大障碍。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/97bed5a6be7e858c1157cb38b17136f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OspTeom-MOe2XL_rWPp-ow.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">我们的平均iOS应用构建时间</figcaption></figure></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="5c1b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">构建Azure Pipeline的基本iOS应用程序可能会做这样的事情:</p><ol class=""><li id="5c63" class="lm ln it js b jt ju jx jy kb lo kf lp kj lq kn lr ls lt lu bi translated">从<code class="fe lv lw lx ly b">main</code>提取代码</li><li id="d6ac" class="lm ln it js b jt lz jx ma kb mb kf mc kj md kn lr ls lt lu bi translated">安装证书和预置描述文件</li><li id="1d88" class="lm ln it js b jt lz jx ma kb mb kf mc kj md kn lr ls lt lu bi translated">更新<code class="fe lv lw lx ly b">info.plist</code>以包含我们的管道变量(例如，包名、版本等。)</li><li id="b0d3" class="lm ln it js b jt lz jx ma kb mb kf mc kj md kn lr ls lt lu bi translated">安装cocoa pods——从各自的远程Git存储库中下载所有的pod源文件，并集成到我们的项目中</li><li id="b9e1" class="lm ln it js b jt lz jx ma kb mb kf mc kj md kn lr ls lt lu bi translated">构建和归档应用程序</li><li id="811f" class="lm ln it js b jt lz jx ma kb mb kf mc kj md kn lr ls lt lu bi translated">上传<code class="fe lv lw lx ly b">*.ipa</code>文件为神器</li></ol></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="60f2" class="me mf it bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">1.缓存盒安装</h1><p id="870b" class="pw-post-body-paragraph jq jr it js b jt nc jv jw jx nd jz ka kb ne kd ke kf nf kh ki kj ng kl km kn im bi translated">我们的第一个优化是使用<a class="ae ko" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/cache?view=azure-devops" rel="noopener ugc nofollow" target="_blank">缓存任务</a>来保存我们的pod。我遵循了Zaheer Moola的指南。我不会在这里复制他们的代码，但本质上你想做的是保存pods文件夹，它在<code class="fe lv lw lx ly b">pod install</code>之后包含所有的pods源文件。我们只在添加、删除或更新pod时再次运行<code class="fe lv lw lx ly b">pod install</code>。</p><p id="276c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这花费了我们几分钟的构建时间，但是我知道我们可以做得更好。</p><h1 id="a3d4" class="me mf it bd mg mh nh mj mk ml ni mn mo mp nj mr ms mt nk mv mw mx nl mz na nb bi translated">2.缓存窗格编译</h1><p id="f07c" class="pw-post-body-paragraph jq jr it js b jt nc jv jw jx nd jz ka kb ne kd ke kf nf kh ki kj ng kl km kn im bi translated">在故事的早期，我们看到构建平均需要34分钟，其中90%是Xcode构建。所以我查看了日志，意识到Xcode必须构建所有的CocoaPods，以及每个pod的所有依赖项。因为我们在项目中使用了<a class="ae ko" href="https://firebase.google.com/docs/ios/setup#available-pods" rel="noopener ugc nofollow" target="_blank"> Firebase SDK </a>,所以我们有很多pod。每一个都需要几个其他的pod，它们也构建在我们的Azure管道中。</p><p id="a4cc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我认为，在我们项目的每个新构建中，我们最多接触十几个文件。考虑到我的更改可能实际上是在修复一个打字错误，为什么我们需要重建每个pod的每个源文件呢？</p><p id="859f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以，我谷歌了一下“CocoaPods构建缓存”,发现了<a class="ae ko" href="https://blog.takescoop.com/improve-ios-ci-build-time-with-cocoapods-caching-4a049ee45e63?gi=b939eac3ea19" rel="noopener ugc nofollow" target="_blank">一个看起来像我想要做的结果</a>——CI/CD构建CocoaPods的缓存。不幸的是，本文没有使用Azure管道。我花了一点时间试图理解他们提到的构建系统，并将其转换为Azure Pipelines land，但后来我意识到这篇文章来自2018年初，我的文件看起来不像他们的。</p><p id="6bcc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">回到绘图板。后来又一次谷歌搜索，我偶然发现了官方CocoaPods网站上的<a class="ae ko" href="https://guides.cocoapods.org/plugins/pre-compiling-dependencies.html" rel="noopener ugc nofollow" target="_blank">预编译依赖项</a>。这是CocoaPods的一个插件，我将介绍它的功能:</p><blockquote class="nm nn no"><p id="422a" class="jq jr np js b jt ju jv jw jx jy jz ka nq kc kd ke nr kg kh ki ns kk kl km kn im bi translated">CocoaPods二进制文件通过添加预安装阶段来工作，该阶段:</p><p id="0adb" class="jq jr np js b jt ju jv jw jx jy jz ka nq kc kd ke nr kg kh ki ns kk kl km kn im bi translated">-取出您指定要预编译的pods<br/>-编译这些pods <br/> -切换用于引用源代码的pods规格，以引用新编译的框架</p></blockquote><p id="bcbe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完美。这应该预先构建我们的pod，并切换现有的podspecs，这样我就不需要更改我们现有的缓存任务。它不使用下载的源文件，而是简单地指向构建的代码。</p><p id="6a6e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当我跳进<a class="ae ko" href="https://github.com/leavez/cocoapods-binary" rel="noopener ugc nofollow" target="_blank"> CocoaPods二进制Github repo </a>并看到2019年4月的最新版本时，我有点担心。我希望这仍然可以工作，特别是考虑到我们是在Xcode 12上运行iOS 14。</p><p id="414a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最初，我需要做的就是将插件添加到我们的Podfile中，并添加一行告诉它我希望我们所有的pods都预编译。我还需要将插件安装到我的电脑上，这是通过运行<code class="fe lv lw lx ly b">gem install cocoapods-binary</code>完成的。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt nu l"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">添加了CocoaPods二进制插件并设置了all binary标志的Podfile</figcaption></figure><p id="3d26" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<strong class="js iu">第2行</strong>上，我们看到我已经添加了CocoaPods二进制插件，然后在<strong class="js iu">第7行</strong>上，我使用<code class="fe lv lw lx ly b">all_binary!</code>标志告诉CocoaPods我想要预编译该目标中的所有Pods。</p><p id="9b15" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，下一次<code class="fe lv lw lx ly b">pod install</code>运行时，安装后将运行一个额外的步骤来构建每个pod。然后，当您的项目构建时，它将只需要构建您的项目部分，而不是所有的依赖项。这意味着你可以缓存pods的构建，只需要Azure Pipelines花费时间来构建你的应用，大大减少了构建时间。</p><p id="6a70" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我很想在这里结束这个故事，但自然地，这并不适合我。我面临三个问题。</p><h1 id="7247" class="me mf it bd mg mh nh mj mk ml ni mn mo mp nj mr ms mt nk mv mw mx nl mz na nb bi translated">重要提示</h1><p id="a06c" class="pw-post-body-paragraph jq jr it js b jt nc jv jw jx nd jz ka kb ne kd ke kf nf kh ki kj ng kl km kn im bi translated">我建议在本地运行<code class="fe lv lw lx ly b">pod install</code>命令，然后尝试构建Xcode。当您不需要不断提交和推送您的更改时，调试问题会容易得多，并且您可能会发现您的本地机器下载和构建比Azure Pipelines代理更快。</p><h1 id="1522" class="me mf it bd mg mh nh mj mk ml ni mn mo mp nj mr ms mt nk mv mw mx nl mz na nb bi translated">错误</h1><h2 id="2e67" class="nv mf it bd mg nw nx dn mk ny nz dp mo kb oa ob ms kf oc od mw kj oe of na og bi translated">pod install正在为SwiftI的早期版本进行编译</h2><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="oh nu l"/></div></figure><h2 id="3e3d" class="nv mf it bd mg nw nx dn mk ny nz dp mo kb oa ob ms kf oc od mw kj oe of na og bi translated">多命令产品' */**/*。dysm</h2><p id="ef1f" class="pw-post-body-paragraph jq jr it js b jt nc jv jw jx nd jz ka kb ne kd ke kf nf kh ki kj ng kl km kn im bi translated">我收到的第二个错误与此类似，只是它有实际的文件路径:</p><p id="9a63" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe lv lw lx ly b">error: Multiple commands produce ‘*/**/*.dysm’</code></p><p id="3b27" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我为我们的一些豆荚得到这个，但不是所有的豆荚。我不知道是什么导致了这个问题，但是在仔细研究了CocoaPods二进制文件的选项后，我找到了解决方案。这是为了给我们的Podfile添加以下标志，以确保<code class="fe lv lw lx ly b">.dysm</code>文件不是为我们的pod构建的:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt nu l"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">带有自定义xcodebuild选项的Podfile。正在生成dysm文件</figcaption></figure><p id="e277" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">第8行</strong>显示我正在添加一个定制的<code class="fe lv lw lx ly b">xcodebuild</code>选项来构建，但没有为我们的pods输出<code class="fe lv lw lx ly b">.dysm</code>文件。</p><p id="1dd8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">很好，问题解决了。</p><h2 id="48f2" class="nv mf it bd mg nw nx dn mk ny nz dp mo kb oa ob ms kf oc od mw kj oe of na og bi translated">位代码问题</h2><p id="c5a3" class="pw-post-body-paragraph jq jr it js b jt nc jv jw jx nd jz ka kb ne kd ke kf nf kh ki kj ng kl km kn im bi translated">我遇到的最后一个问题是与位代码有关的错误。解决方案是向我们的Podfile添加第三个也是最后一个标志:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt nu l"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">Podfile为预构建框架启用位代码</figcaption></figure><p id="5dcd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这解决了最后一个问题。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="864e" class="me mf it bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">把所有的放在一起</h1><p id="d8ed" class="pw-post-body-paragraph jq jr it js b jt nc jv jw jx nd jz ka kb ne kd ke kf nf kh ki kj ng kl km kn im bi translated">所以现在我知道我们的应用程序已经构建好了，我需要把我学到的一切都放到Azure Pipelines YAML文件中，然后我们就出发去比赛了。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt nu l"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">我们Firebase pods的最终完整pod文件</figcaption></figure><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt nu l"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">我们Azure管道的最终代码</figcaption></figure><p id="e749" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个iOS构建管道YAML文件首先具有缓存任务，将我们预先构建的pod文件恢复(如果它们存在)到文件夹<code class="fe lv lw lx ly b">Pods</code>。</p><p id="4f16" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我安装CocoaPods二进制插件，并将<code class="fe lv lw lx ly b">xcodebuild</code>路径改为指向我们的Xcode测试版。</p><p id="f9fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，如果我们的缓存没有恢复(例如，如果我们还没有运行这个，或者一个pod发生了变化)，我们运行<code class="fe lv lw lx ly b">pod install</code>，它不仅安装我们的pod源代码，而且还构建所有的源代码。</p><p id="0c8a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这使得我们的最终任务是构建我们的应用程序的唯一责任，仅此而已。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/6024f0b2ff08571bf244e7302ded84b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*O0Qg-VdIoscBhshMOefPew.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">我们启用了CocoaPods构建缓存的新构建管道</figcaption></figure><p id="53ab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">总的来说，这将我们的应用程序构建时间从平均<strong class="js iu"> 34分钟</strong>减少到不到<strong class="js iu"> 10分钟</strong>。事实上，我们的一次跑步只花了<strong class="js iu"> 7分钟</strong>。这是一个令人难以置信的节省，它减少了代理构建时间(并腾出时间来执行其他任务)，使我们能够更快地发布应用程序，并消除了添加额外pod的巨大障碍。这意味着我们可以引入新的库，而在以前，我们必须自己编写代码。太棒了。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="7660" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你喜欢这个故事，给它一些掌声。否则，请随意留下您的任何问题，我会尽力回答。</p></div></div>    
</body>
</html>