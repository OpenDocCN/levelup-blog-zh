# JavaScript 中的轮询

> 原文：<https://levelup.gitconnected.com/polling-in-javascript-ab2d6378705a>

## 构建自己的轮询函数来查询更新的指南

![](img/0bf1869550f4651e8eb8be8bed175028.png)

轮询是一种技术，我们通过定期向服务器发出 API 请求来检查给定时间间隔内的新数据。例如，如果有频繁更改的数据，或者我们需要等待服务器转换给定的状态，我们可以使用轮询。轮询是 web 套接字或服务器事件的简单替代方法。

本文将首先描述何时需要轮询，提供一个 JavaScript 中的`poll`函数实现，然后展示如何在模拟 API 中使用它。

![](img/aced8a676f6e35c5f7a618a71ff5fd7b.png)

我想教你如何 [**ace 你的编码面试➡️**](https://skilled.dev) 。

[](https://skilled.dev) [## 编写面试问题

### 掌握编码面试的过程

技术开发](https://skilled.dev) ![](img/aced8a676f6e35c5f7a618a71ff5fd7b.png)

# 当我们使用轮询时

轮询的一个真实用例是，如果我们使用第三方身份验证提供者(比如 Firebase 或 Auth0 ),并且在继续之前需要等待结果。当用户注册时，我们将用户的数据从客户端发送到身份验证提供者。然后在服务器上，我们等待来自身份验证提供者的响应，然后在我们的数据库中创建一个用户。

在整个过程中，客户端必须等待服务器上的身份验证和用户创建。因为我们知道这个过程会很快成功或失败，所以我们可以放心地实现一个轮询，每 1 秒钟向我们的服务器发出一次 API 请求，直到我们完成注册和创建新用户的过程。

另一个投票有用的例子是我们在地图上追踪用户的位置。在像优步这样的应用程序中，我们可以通过反复查询最近的坐标来观察司机来接我们。由于这些数据经常变化，我们将设置一个时间间隔来轮询位置，以确保我们拥有最新的数据。

# 轮询实现

我们将编写一个简单的`poll`函数，它使用承诺来解析获取的结果。我将粘贴下面的代码并解释它是如何工作的。

我们的`poll`函数是一个返回函数`executePoll`的高阶函数。`executePoll`函数返回一个承诺，并将递归运行，直到满足停止条件。`poll`函数将 4 个变量作为参数:

*   `fn`:这是我们将在给定时间间隔内执行的功能。通常这是一个 API 请求。
*   这也是一个函数，我们定义一个测试，看看数据是否符合我们想要的，这将结束投票。例如，我们可以简单地测试数据是否存在，或者我们可以检查响应的嵌套属性是否达到了某个状态

《出埃及记》`validate = user => !!user`

《出埃及记》`validate = checkout => checkout.status === 'COMPLETE'`

*   `interval`:这是我们希望在轮询请求之间等待的时间。这完全由您的应用中的用例决定，拥有最新信息的重要性越高，轮询请求之间的间隔就需要越短。
*   `maxAttempts`:我们需要能够为轮询请求的数量设置一些合理的上限，以防止它无限运行。

我们的`poll`函数从声明一个`attempts`变量开始，我们围绕这个变量形成一个闭包，以跟踪我们对 API 进行了多少次轮询。然后我们声明返回承诺的`excutePoll`函数。这允许我们连续递归地调用`executePoll`，并且只有在达到有效值时才调用`resolve`。

`executePoll`函数也被声明为`async`，因此我们可以通过使用`await`轻松执行`fn`。一旦它返回，我们就增加我们的`attempts`。我们从`fn`调用`result`上的`validate`，如果它返回 true，我们就成功地`resolve`这个值。如果结果无效，我们将检查是否达到了最大轮询次数，如果达到，将抛出一个错误。否则，我们对给定的`interval`执行`setTimeout`，然后递归调用该函数，再次尝试轮询。

# 轮询示例

下面的例子是一旦你可以粘贴到一个本地的 JavaScript 文件，并使用`node`运行它。它采用我们在上一节中构建的相同的 poll 函数，并将其应用于一个假的 API 请求。它模拟等待用户被创建，在本例中，这将在 12 秒后发生。我们每秒轮询一次模拟 API，直到它返回一个用户，然后解析到我们链接的`then`函数。

## 包裹

就是这样！轮询是一种简单但功能强大的技术，它使您能够定期检查数据的最新值，并在数据进入所需状态时阻止进一步的请求。

—[@ trey huffine](https://twitter.com/treyhuffine)|[@ git connected](https://twitter.com/gitconnected)

# 分级编码

感谢您成为我们社区的一员！ [**订阅我们的 YouTube 频道**](https://www.youtube.com/channel/UC3v9kBR_ab4UHXXdknz8Fbg?sub_confirmation=1) 或者加入 [**Skilled.dev 编码面试课程**](https://skilled.dev/) 。

[](https://skilled.dev) [## 编写面试问题

### 掌握编码面试的过程

技术开发](https://skilled.dev)