<html>
<head>
<title>How to Save Uploaded Files in FastAPI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在FastAPI中保存上传的文件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-save-uploaded-files-in-fastapi-90786851f1d3?source=collection_archive---------1-----------------------#2020-09-29">https://levelup.gitconnected.com/how-to-save-uploaded-files-in-fastapi-90786851f1d3?source=collection_archive---------1-----------------------#2020-09-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="377e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接收文件并将其保存在本地的分步指南</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/7779d82f491eeb098e6a00171b5c7696.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*naCqltNivUDBZCvKgna3fg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</figcaption></figure><p id="d3e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">今天的主题是将用户上传到FastAPI服务器的图像或文本文件保存到本地磁盘中。如果你以前用过Flask，你应该知道它自带了内置的<code class="fe le lf lg lh b">file.save</code>函数来保存文件。不幸的是，在撰写本文时，FastAPI中还没有这样的特性。在本教程中，您将学习基于您自己的用例来实现这个功能。</p></div><div class="ab cl li lj hx lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="im in io ip iq"><h1 id="5604" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">单行</h1><p id="0689" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">供您参考，接受通过<code class="fe le lf lg lh b">FormData</code>上传的图像或文件的简单FastAPI服务器的最低代码如下:</p><pre class="kp kq kr ks gt ms lh mt mu aw mv bi"><span id="bb40" class="mw lq it lh b gy mx my l mz na">from fastapi import FastAPI, File, UploadFile<br/><br/>app = FastAPI()<br/><br/>@app.post("/image")<br/>async def image(image: UploadFile = File(...)):<br/>    return {"filename": image.filename}</span></pre><h2 id="c17e" class="mw lq it bd lr nb nc dn lv nd ne dp lz kb nf ng md kf nh ni mh kj nj nk ml nl bi translated">Python多部分</h2><p id="34c4" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">为了接收上传的文件，你需要安装<code class="fe le lf lg lh b">python-multipart</code>。如果必须在虚拟环境中安装终端，请在终端中运行以下命令。</p><pre class="kp kq kr ks gt ms lh mt mu aw mv bi"><span id="c00f" class="mw lq it lh b gy mx my l mz na">pip install python-multipart</span></pre><h2 id="14dd" class="mw lq it bd lr nb nc dn lv nd ne dp lz kb nf ng md kf nh ni mh kj nj nk ml nl bi translated">FastAPI上传文件</h2><p id="e612" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated"><code class="fe le lf lg lh b">UploadFile</code>使用Python <code class="fe le lf lg lh b">SpooledTemporaryFile</code>对象，这意味着只要文件大小在大小限制内，它就会被存储在内存中。否则，一旦超过大小限制，它将被存储在磁盘中。</p><p id="ff71" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于它继承自<code class="fe le lf lg lh b">Starlette</code>，因此具有以下属性:</p><ul class=""><li id="cdab" class="nm nn it js b jt ju jx jy kb no kf np kj nq kn nr ns nt nu bi translated"><code class="fe le lf lg lh b">filename</code> —文件的名称。它基于上传的原始文件名。</li><li id="1d22" class="nm nn it js b jt nv jx nw kb nx kf ny kj nz kn nr ns nt nu bi translated"><code class="fe le lf lg lh b">content_type</code> —文件的内容类型。比如JPEG图像文件应该是<code class="fe le lf lg lh b">image/jpeg</code>。</li><li id="c87c" class="nm nn it js b jt nv jx nw kb nx kf ny kj nz kn nr ns nt nu bi translated"><code class="fe le lf lg lh b">file</code> — Python文件对象。</li></ul><p id="fe87" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，<code class="fe le lf lg lh b">UploadFile</code>还附带了四个额外的<code class="fe le lf lg lh b">async</code>功能。通常，您应该在普通的<code class="fe le lf lg lh b">async</code>函数中使用await调用它们。在FastAPI中，<code class="fe le lf lg lh b">async</code>方法被设计成在线程池中运行文件方法，它将等待它们。因此，您可以不使用<code class="fe le lf lg lh b">await</code>语法来调用这些函数。</p><ul class=""><li id="b47c" class="nm nn it js b jt ju jx jy kb no kf np kj nq kn nr ns nt nu bi translated"><code class="fe le lf lg lh b">write(data)</code> —将数据写入文件。接受字符串或字节。</li><li id="ae25" class="nm nn it js b jt nv jx nw kb nx kf ny kj nz kn nr ns nt nu bi translated"><code class="fe le lf lg lh b">read(size)</code> —根据输入参数读取文件的n个字节或字符。接受整数。</li><li id="c058" class="nm nn it js b jt nv jx nw kb nx kf ny kj nz kn nr ns nt nu bi translated"><code class="fe le lf lg lh b">seek(offset)</code> —移动到文件中的字节或字符位置。使用<code class="fe le lf lg lh b">seek(0)</code>将转到文件的开头。</li><li id="658a" class="nm nn it js b jt nv jx nw kb nx kf ny kj nz kn nr ns nt nu bi translated"><code class="fe le lf lg lh b">close()</code> —关闭文件</li></ul><h2 id="ba11" class="mw lq it bd lr nb nc dn lv nd ne dp lz kb nf ng md kf nh ni mh kj nj nk ml nl bi translated">保存文件</h2><p id="3718" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">Flask有一个<code class="fe le lf lg lh b">file.save</code>包装器功能，允许你将上传的文件保存在你的磁盘上。包装器基于Python标准库的一部分<code class="fe le lf lg lh b">shutils.copyfileobj()</code>函数。然而，在撰写本文时，FastAPI还没有这样的实现。</p><p id="927f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以在FastAPI服务器内部轻松实现它。首先，你需要导入<code class="fe le lf lg lh b">shutil</code>模块。</p><pre class="kp kq kr ks gt ms lh mt mu aw mv bi"><span id="ad63" class="mw lq it lh b gy mx my l mz na">import shutil</span></pre><p id="f291" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">基本结构和代码如下所示。</p><pre class="kp kq kr ks gt ms lh mt mu aw mv bi"><span id="f76e" class="mw lq it lh b gy mx my l mz na">with open("destination.png", "wb") as buffer:<br/>    shutil.copyfileobj(image.file, buffer)</span></pre><p id="6ab5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">只需在FastAPI方法中调用它。看看下面的代码片段。</p><pre class="kp kq kr ks gt ms lh mt mu aw mv bi"><span id="c448" class="mw lq it lh b gy mx my l mz na">async def image(image: UploadFile = File(...)):<br/>    <!-- -->with open("destination.png", "wb") as buffer:<br/>        shutil.copyfileobj(image.file, buffer)<br/>    <br/>    <!-- -->return {"filename": image.filename}</span></pre><p id="98cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">重新运行您的FastAPI服务器，并提交一个表单，从您的前端代码中附加一个文件。您应该会看到一个基于您指定的路径生成的新文件。</p></div><div class="ab cl li lj hx lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="im in io ip iq"><h1 id="8a6b" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">多个文件</h1><p id="f341" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">为了处理多个文件的上传，需要导入下面的语句</p><pre class="kp kq kr ks gt ms lh mt mu aw mv bi"><span id="6608" class="mw lq it lh b gy mx my l mz na">from typing import List</span></pre><p id="250a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，修改接受<code class="fe le lf lg lh b">UploadFile</code>的<code class="fe le lf lg lh b">List</code>的FastAPI方法。</p><pre class="kp kq kr ks gt ms lh mt mu aw mv bi"><span id="8981" class="mw lq it lh b gy mx my l mz na">async def image(images: List[UploadFile] = File(...)):</span></pre><p id="5a17" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用<code class="fe le lf lg lh b">for loop</code>简单地循环它，并在其中实现保存逻辑。</p><pre class="kp kq kr ks gt ms lh mt mu aw mv bi"><span id="42fc" class="mw lq it lh b gy mx my l mz na">for image in images:<br/>    <!-- -->with open(<!-- -->image<!-- -->.filename, "wb") as buffer:<br/>        shutil.copyfileobj(<!-- -->image<!-- -->.file, buffer)</span></pre><p id="6763" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有关FastAPI的更多信息，强烈建议阅读以下文章:</p><ul class=""><li id="c90d" class="nm nn it js b jt ju jx jy kb no kf np kj nq kn nr ns nt nu bi translated"><a class="ae oa" href="https://medium.com/better-programming/migrate-from-flask-to-fastapi-smoothly-cc4c6c255397" rel="noopener">从烧瓶顺利迁移到FastAPI】</a></li><li id="6000" class="nm nn it js b jt nv jx nw kb nx kf ny kj nz kn nr ns nt nu bi translated"><a class="ae oa" rel="noopener ugc nofollow" target="_blank" href="/4-useful-advanced-features-in-fastapi-f08e4db59637">FastAPI中4个有用的高级特性</a></li><li id="4d4a" class="nm nn it js b jt nv jx nw kb nx kf ny kj nz kn nr ns nt nu bi translated"><a class="ae oa" href="https://medium.com/better-programming/metadata-and-additional-responses-in-fastapi-ea90a321d477" rel="noopener">FastAPI中的元数据和附加响应</a></li></ul></div><div class="ab cl li lj hx lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="im in io ip iq"><h1 id="22dc" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">结论</h1><p id="9235" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">让我们回顾一下今天所学的内容。</p><p id="1357" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们从一个简单的问题陈述开始，解释FastAPI中缺少保存上传文件的包装函数。</p><p id="e1f0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们深入探讨了UploadFile背后的基本概念以及如何在FastAPI服务器中使用它。</p><p id="afee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们还使用内置的shutil.copyfileobj方法实现了一个简单的文件保存功能。此外，我们还尝试扩展我们的服务器来处理多个文件上传。</p><p id="95f9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢你阅读这篇文章。希望在下一篇文章中再见到你！</p></div><div class="ab cl li lj hx lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="im in io ip iq"><h1 id="4f46" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">参考</h1><ol class=""><li id="8ba9" class="nm nn it js b jt mn jx mo kb ob kf oc kj od kn oe ns nt nu bi translated"><a class="ae oa" href="https://fastapi.tiangolo.com/tutorial/request-files/" rel="noopener ugc nofollow" target="_blank"> FastAPI请求文件</a></li><li id="f8b8" class="nm nn it js b jt nv jx nw kb nx kf ny kj nz kn oe ns nt nu bi translated"><a class="ae oa" href="https://github.com/tiangolo/fastapi/issues/426" rel="noopener ugc nofollow" target="_blank">保存上传文件FastAPI Github问题</a></li></ol></div></div>    
</body>
</html>