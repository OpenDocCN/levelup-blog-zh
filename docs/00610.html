<html>
<head>
<title>Kubernetes multi-node cluster with k3s and multipass</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes采用k3s和multipass的多节点集群</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/kubernetes-cluster-with-k3s-and-multipass-7532361affa3?source=collection_archive---------0-----------------------#2019-06-02">https://levelup.gitconnected.com/kubernetes-cluster-with-k3s-and-multipass-7532361affa3?source=collection_archive---------0-----------------------#2019-06-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a71f87b7560d4109cc7177a78b44c56d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0P_MP5y1xJiNqnTDuyhS_w.png"/></div></div></figure><p id="6dae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">与<a class="ae kw" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>合作，您可能碰巧需要一个本地Kubernetes集群来进行开发和测试。当然，Minikube是一个选择。但是如果我们需要更强大而不增加复杂性的东西呢？例如，如果我们正在准备参加<a class="ae kw" href="https://www.cncf.io/certification/ckad/" rel="noopener ugc nofollow" target="_blank"> CKAD:认证Kubernetes应用程序开发人员</a>认证呢？</p><p id="c491" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里是我个人对OS X的解决方案(但应该也能流畅地与GNU/Linux一起工作)，我想与你分享:<a class="ae kw" href="https://github.com/CanonicalLtd/multipass" rel="noopener ugc nofollow" target="_blank"> multipass </a> + <a class="ae kw" href="https://github.com/rancher/k3s" rel="noopener ugc nofollow" target="_blank"> k3s </a>。</p><h1 id="f507" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">多通道的</h1><p id="f449" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">首先，我们需要一个虚拟化层来运行任意数量的Kubernetes节点。很有可能，使用Canonical Ltd .创建的<a class="ae kw" href="https://github.com/CanonicalLtd/multipass" rel="noopener ugc nofollow" target="_blank"> multipass </a>在OS X 上获得<a class="ae kw" href="https://discourse.ubuntu.com/t/multipass-now-available-for-macos/6824" rel="noopener ugc nofollow" target="_blank"> Ubuntu VM的最简单方法是:</a></p><blockquote class="ma mb mc"><p id="27b7" class="jy jz md ka b kb kc kd ke kf kg kh ki me kk kl km mf ko kp kq mg ks kt ku kv ij bi translated">这是一个协调虚拟机和相关Ubuntu映像的创建、管理和维护以简化开发的系统。</p></blockquote><h1 id="514b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">k3s</h1><p id="9eb1" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">因为我想让事情变得小而简单，所以我利用了由牧场主k3s创建的令人惊叹的Kubernetes项目。K3s有望成为轻量级Kubernetes:</p><blockquote class="ma mb mc"><p id="9e3a" class="jy jz md ka b kb kc kd ke kf kg kh ki me kk kl km mf ko kp kq mg ks kt ku kv ij bi translated">K3s是经过<a class="ae kw" href="https://www.cncf.io/certification/software-conformance/" rel="noopener ugc nofollow" target="_blank">认证的Kubernetes发行版</a>，专为无人值守、资源有限、远程位置或物联网设备内部的生产工作负载而设计。</p></blockquote><h1 id="6582" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">如何创建本地Kubernetes集群</h1><p id="175e" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">KISS风格，只需3个简单步骤中的9个命令即可设置一个基本的3节点k3s集群:</p><ol class=""><li id="85cf" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv mm mn mo mp bi translated">安装多通道</li><li id="6d99" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">创建虚拟机</li><li id="6a18" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">创建k3s集群</li></ol><h2 id="9cdb" class="mv ky iq bd kz mw mx dn ld my mz dp lh kj na nb ll kn nc nd lp kr ne nf lt ng bi translated"><strong class="ak">第一步:安装多通道</strong></h2><p id="ee05" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我想当然的认为<a class="ae kw" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank"> brew.sh </a>在你的Mac里是不能少的。如果没有，请跟随<a class="ae kw" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank">链接</a>。之后，无非是:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="eac7" class="mv ky iq nm b gy nq nr l ns nt">brew cask install multipass</span></pre><h2 id="cf86" class="mv ky iq bd kz mw mx dn ld my mz dp lh kj na nb ll kn nc nd lp kr ne nf lt ng bi translated"><strong class="ak">第二步:创建虚拟机</strong></h2><p id="584d" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">假设我们希望Kubernetes集群有1个主节点(“<code class="fe nu nv nw nm b">k3s-master</code>”)和2个(工作)节点(“<code class="fe nu nv nw nm b">k3s-worker1</code>”和“<code class="fe nu nv nw nm b">k3s-worker2</code>”)。</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="de41" class="mv ky iq nm b gy nq nr l ns nt">multipass launch --name k3s-master --cpus 1 --mem 1024M --disk 3G<br/>multipass launch --name k3s-worker1 --cpus 1 --mem 1024M --disk 3G<br/>multipass launch --name k3s-worker2 --cpus 1 --mem 1024M --disk 3G</span></pre><h2 id="57fa" class="mv ky iq bd kz mw mx dn ld my mz dp lh kj na nb ll kn nc nd lp kr ne nf lt ng bi translated"><strong class="ak">步骤3:创建k3s集群</strong></h2><p id="f7e6" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这里的事情变得有点棘手，需要注意以下几点:</p><ul class=""><li id="ac69" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv nx mn mo mp bi translated">在k3s版本0.6.0之前，<code class="fe nu nv nw nm b">k3s-master</code> i̶s̶的部署按照<a class="ae kw" href="https://k3s.io/" rel="noopener ugc nofollow" target="_blank">官方指令</a>非常简单。添加<code class="fe nu nv nw nm b">K3S_KUBECONFIG_MODE="644"</code>了解详情，跳至“步骤4。配置kubectl "</li><li id="f2b9" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv nx mn mo mp bi translated">如果未正确配置，k3s安装脚本将作为单节点群集启动。因为我们不希望这样，所以在部署<code class="fe nu nv nw nm b">k3s-worker1</code>和<code class="fe nu nv nw nm b">k3s-worker2</code>之前，我们需要来自主节点的两个信息，它们是:<br/> - <code class="fe nu nv nw nm b">k3s-master</code> ip地址，存储在<code class="fe nu nv nw nm b">K3S_NODEIP_MASTER</code>变量<br/> - <code class="fe nu nv nw nm b">k3s-master</code> k3s令牌中，存储在<code class="fe nu nv nw nm b">K3S_TOKEN</code>变量<br/>中，以便允许工作节点加入由<code class="fe nu nv nw nm b">k3s-master</code>节点创建的同一个k3s集群。</li><li id="1092" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv nx mn mo mp bi translated"><code class="fe nu nv nw nm b">k3s-worker1</code>和<code class="fe nu nv nw nm b">k3s-worker2</code>的部署仅仅是基于这两个变量的正确配置的问题。</li></ul><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="53ab" class="mv ky iq nm b gy nq nr l ns nt"># Deploy k3s on the master node<br/>multipass exec k3s-master -- /bin/bash -c "curl -sfL <a class="ae kw" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | K3S_KUBECONFIG_MODE="644" sh -"</span><span id="c1f2" class="mv ky iq nm b gy ny nr l ns nt"># Get the IP of the master node<br/>K3S_NODEIP_MASTER="https://$(multipass info k3s-master | grep "IPv4" | awk -F' ' '{print $2}'):6443"</span><span id="89b8" class="mv ky iq nm b gy ny nr l ns nt"># Get the TOKEN from the master node<br/>K3S_TOKEN="$(multipass exec k3s-master -- /bin/bash -c "sudo cat /var/lib/rancher/k3s/server/node-token")"</span><span id="3f27" class="mv ky iq nm b gy ny nr l ns nt"># Deploy k3s on the worker node<br/>multipass exec k3s-worker1 -- /bin/bash -c "curl -sfL https://get.k3s.io | K3S_TOKEN=${K3S_TOKEN} K3S_URL=${K3S_NODEIP_MASTER} sh -"</span><span id="9cd7" class="mv ky iq nm b gy ny nr l ns nt"># Deploy k3s on the worker node<br/>multipass exec k3s-worker2 -- /bin/bash -c "curl -sfL https://get.k3s.io | K3S_TOKEN=${K3S_TOKEN} K3S_URL=${K3S_NODEIP_MASTER} sh -"</span></pre><p id="98a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">检查一切:</strong></p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="5b71" class="mv ky iq nm b gy nq nr l ns nt">multipass list</span><span id="7b16" class="mv ky iq nm b gy ny nr l ns nt">Name State IPv4 Release<br/>k3s-worker2 RUNNING 192.168.64.5 Ubuntu 18.04 LTS<br/>k3s-worker1 RUNNING 192.168.64.4 Ubuntu 18.04 LTS<br/>k3s-master RUNNING 192.168.64.3 Ubuntu 18.04 LTS</span><span id="fb41" class="mv ky iq nm b gy ny nr l ns nt">multipass exec k3s-master kubectl get nodes</span><span id="279c" class="mv ky iq nm b gy ny nr l ns nt">NAME          STATUS   ROLES    AGE   VERSION<br/>k3s-master    Ready    master   48s   v1.14.1-k3s.4<br/>k3s-worker1   Ready    &lt;none&gt;   16s   v1.14.1-k3s.4<br/>k3s-worker2   Ready    &lt;none&gt;   6s    v1.14.1-k3s.4</span></pre><p id="69e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">n̶o̶t̶e̶̶t̶h̶e̶̶<code class="fe nu nv nw nm b">&lt;none&gt;</code>̶i̶n̶̶t̶h̶e̶̶<code class="fe nu nv nw nm b">ROLES</code>̶c̶o̶l̶u̶m̶n̶.̶̶i̶n̶̶t̶h̶e̶̶s̶e̶c̶o̶n̶d̶̶p̶a̶r̶t̶̶o̶f̶̶t̶h̶i̶s̶̶s̶t̶o̶r̶y̶,̶̶w̶e̶'̶l̶l̶̶g̶e̶t̶̶t̶h̶e̶r̶e̶.<em class="md">更新2019 10 11:k3s 0 . 6 . 0版本引入了节点角色和</em> <code class="fe nu nv nw nm b">--node-label</code>和<code class="fe nu nv nw nm b">--node-taint</code>标志。</p><p id="f8c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就这样，Kubernetes集群开始运行了。尽管如此，您可能想看看以下步骤:</p><h1 id="33f2" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">如何创建一个本地Kubernetes集群(有意义)</h1><p id="db46" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在下文中，我将添加一些有用的技巧，使集群对于开发和测试非常有用:</p><p id="d365" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.配置kubectl <br/> 5。配置集群节点角色和污点。舵安装<br/> 7。服务类型"节点端口"<br/> 8。入口控制器<a class="ae kw" href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjKnILS0MriAhXSzaQKHf5xAjYQFjAAegQIBRAC&amp;url=https%3A%2F%2Ftraefik.io%2F&amp;usg=AOvVaw204mn6RPY_Znna2JH9mdFp" rel="noopener ugc nofollow" target="_blank"> Traefik </a></p><h2 id="c92a" class="mv ky iq bd kz mw mx dn ld my mz dp lh kj na nb ll kn nc nd lp kr ne nf lt ng bi translated"><strong class="ak">步骤四。配置kubectl </strong></h2><blockquote class="ma mb mc"><p id="de5e" class="jy jz md ka b kb kc kd ke kf kg kh ki me kk kl km mf ko kp kq mg ks kt ku kv ij bi translated">更新2019 10 11:k3s 0 . 6 . 0版本出于<a class="ae kw" href="https://github.com/rancher/k3s/issues/389" rel="noopener ugc nofollow" target="_blank">安全原因</a>将默认<code class="fe nu nv nw nm b"><em class="iq">k3s.yaml</em></code>权限从0644更改为0600。请看一下<a class="ae kw" href="https://github.com/rancher/k3s/issues/389#issuecomment-503616742" rel="noopener ugc nofollow" target="_blank">https://github . com/rancher/k3s/issues/389 # issue comment-503616742</a>。为了克服这种变化(在启动阶段),主要有两种解决方案:</p></blockquote><ul class=""><li id="4bf5" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv nx mn mo mp bi translated">使用<code class="fe nu nv nw nm b">--write-kubeconfig-mode 644</code></li></ul><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="9487" class="mv ky iq nm b gy nq nr l ns nt">curl -sfL <a class="ae kw" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | sh -s - --write-kubeconfig-mode 644</span></pre><ul class=""><li id="d12c" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv nx mn mo mp bi translated">使用变量<code class="fe nu nv nw nm b">K3S_KUBECONFIG_MODE</code></li></ul><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="f7b2" class="mv ky iq nm b gy nq nr l ns nt">curl -sfL <a class="ae kw" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | K3S_KUBECONFIG_MODE="644" sh -s -</span></pre></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><blockquote class="ma mb mc"><p id="4943" class="jy jz md ka b kb kc kd ke kf kg kh ki me kk kl km mf ko kp kq mg ks kt ku kv ij bi translated">更新20191011: k3s版本0 . 9 . 0<a class="ae kw" href="https://github.com/rancher/k3s/pull/750" rel="noopener ugc nofollow" target="_blank"><code class="fe nu nv nw nm b">k3s.yaml</code>中的“localhost”已被“127 . 0 . 0 . 1”</a>替换，导致<code class="fe nu nv nw nm b">sed</code>命令失败。</p></blockquote></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="1958" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们想忘记multipass CLI，配置安装在您的主机上的<code class="fe nu nv nw nm b">kubectl</code>直接使用全新的k3s集群是非常容易的(我假设<code class="fe nu nv nw nm b">kubectl</code>已经安装在您的机器上，否则:<code class="fe nu nv nw nm b">$ brew install kubernetes-cli</code>)。首先，我们需要从<code class="fe nu nv nw nm b">k3s-master</code>节点检索kubectl配置文件，并用<code class="fe nu nv nw nm b">k3s-master</code> IP地址编辑它，如下所述:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="7d01" class="mv ky iq nm b gy nq nr l ns nt"># Copy the k3s kubectl config file locally<br/>$ multipass copy-files k3s-master:/etc/rancher/k3s/k3s.yaml ${HOME}/.kube/k3s.yaml</span><span id="f213" class="mv ky iq nm b gy ny nr l ns nt"># Edit the kubectl config file with the right IP address<br/>$ sed -ie s,https://127.0.0.1:6443,${K3S_NODEIP_MASTER},g ${HOME}/.kube/k3s.yaml</span><span id="09ab" class="mv ky iq nm b gy ny nr l ns nt"># Check<br/>$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml get nodes</span></pre><p id="3abf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">指定<code class="fe nu nv nw nm b">--kubeconfig</code>很无聊，而且最重要的是，如果我们忘记这么做，并且在错误的集群中运行错误的命令，这是很危险的(有人知道吗？没有吗？实际上！).将kubectl配置文件<code class="fe nu nv nw nm b">k3s.yaml</code>与您当前的<code class="fe nu nv nw nm b">${HOME}/.kube/config</code>文件合并可能是值得的，或者，由于我们的k3s集群不打算写在石头上，我们有几个简单的选项(详情请参见<a class="ae kw" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/" rel="noopener ugc nofollow" target="_blank">官方文档</a>):</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="9c96" class="mv ky iq nm b gy nq nr l ns nt"># Create a dedicated alias:<br/>alias k3sctl="kubectl --kubeconfig=${HOME}/.kube/k3s.yaml"</span></pre><p id="406c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="bb2b" class="mv ky iq nm b gy nq nr l ns nt"># Use the KUBECONFIG variable<br/>export KUBECONFIG=${HOME}/.kube/k3s.yaml</span></pre><h2 id="6356" class="mv ky iq bd kz mw mx dn ld my mz dp lh kj na nb ll kn nc nd lp kr ne nf lt ng bi translated"><strong class="ak">第五步。配置集群节点角色和污点</strong></h2><blockquote class="ma mb mc"><p id="86e1" class="jy jz md ka b kb kc kd ke kf kg kh ki me kk kl km mf ko kp kq mg ks kt ku kv ij bi translated">更新20191011: k3s版本0.6.0引入了节点角色和<code class="fe nu nv nw nm b">--node-label</code>和<code class="fe nu nv nw nm b">--node-taint</code>标志。因此<strong class="ka ir">“第五步。”不再需要了</strong>。</p></blockquote><p id="fe9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如我们之前注意到的，这3个节点没有角色。这是因为:</p><ul class=""><li id="c61c" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv nx mn mo mp bi translated">K3s安装脚本不会标记它创建的任何节点</li><li id="743d" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv nx mn mo mp bi translated">K3s安装脚本不会影响<code class="fe nu nv nw nm b">NoSchedule</code>的主节点</li></ul><p id="b07f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们来关注这两种配置:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="7ef2" class="mv ky iq nm b gy nq nr l ns nt"># Configure the node roles:<br/>$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml label node k3s-master node-role.kubernetes.io/master=””<br/>$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml label node k3s-worker1 node-role.kubernetes.io/node=””<br/>$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml label node k3s-worker2 node-role.kubernetes.io/node=””</span><span id="a105" class="mv ky iq nm b gy ny nr l ns nt"># Configure taint NoSchedule for the k3s-master node<br/>$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml taint node k3s-master node-role.kubernetes.io/master=effect:NoSchedule</span></pre><p id="dc47" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，节点角色已正确配置:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="ba60" class="mv ky iq nm b gy nq nr l ns nt">$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml get nodes<br/>NAME STATUS ROLES AGE VERSION<br/>k3s-master Ready <strong class="nm ir">master</strong> 4h12m v1.14.1-k3s.4<br/>k3s-worker1 Ready <strong class="nm ir">node</strong> 3h57m v1.14.1-k3s.4<br/>k3s-worker2 Ready <strong class="nm ir">node</strong> 3h57m v1.14.1-k3s.4</span></pre><p id="3194" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最终，我们为部署做好了准备。我想强调的是，NGiNX pods将只在<code class="fe nu nv nw nm b">k3s-worker1</code>和<code class="fe nu nv nw nm b">k3s-worker2</code>节点进行调度:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="ea1f" class="mv ky iq nm b gy nq nr l ns nt">$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml run nginx --image=nginx --replicas=3 --expose --port 80<br/>kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.<br/>service/nginx created<br/>deployment.apps/nginx created</span><span id="533d" class="mv ky iq nm b gy ny nr l ns nt">$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml get pods -o wide<br/>NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES<br/>nginx-755464dd6c-6nzvr 1/1 Running 0 3h22m 10.42.1.3 <strong class="nm ir">k3s-worker2</strong> &lt;none&gt; &lt;none&gt;<br/>nginx-755464dd6c-rkd6r 1/1 Running 0 3h22m 10.42.1.4 <strong class="nm ir">k3s-worker2</strong> &lt;none&gt; &lt;none&gt;<br/>nginx-755464dd6c-v5v64 1/1 Running 0 3h22m 10.42.2.3 <strong class="nm ir">k3s-worker1</strong> &lt;none&gt; &lt;none&gt;</span></pre><h2 id="ecd5" class="mv ky iq bd kz mw mx dn ld my mz dp lh kj na nb ll kn nc nd lp kr ne nf lt ng bi translated"><strong class="ak">第六步:舵安装</strong></h2><p id="e6fa" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><a class="ae kw" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>试图为Kubernetes组合一个<strong class="ka ir">模板引擎</strong>和一个<strong class="ka ir">包管理器</strong>。头盔的安装可能不像我们习惯的那样简单，事实上k3s需要多几个步骤<a class="ae kw" href="https://rancher.com/docs/rancher/v2.x/en/installation/ha/helm-init/" rel="noopener ugc nofollow" target="_blank"/>:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="8bfa" class="mv ky iq nm b gy nq nr l ns nt">$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml -n kube-system create serviceaccount tiller</span><span id="f9a6" class="mv ky iq nm b gy ny nr l ns nt">$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml create clusterrolebinding tiller \<br/>--clusterrole=cluster-admin \<br/>--serviceaccount=kube-system:tiller</span><span id="9208" class="mv ky iq nm b gy ny nr l ns nt">$ helm --kubeconfig=${HOME}/.kube/k3s.yaml init --service-account tiller</span><span id="2c74" class="mv ky iq nm b gy ny nr l ns nt">$ helm --kubeconfig=${HOME}/.kube/k3s.yaml install stable/mysql</span></pre><p id="c829" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你有兴趣了解更多关于Helm的信息，我在下面的故事中分享了我关于Helm图表库主题的经验:“<a class="ae kw" href="https://medium.com/@mattiaperi/create-a-public-helm-chart-repository-with-github-pages-49b180dbb417" rel="noopener">用GitHub页面创建一个公共的Helm图表库</a>”</p><h2 id="e732" class="mv ky iq bd kz mw mx dn ld my mz dp lh kj na nb ll kn nc nd lp kr ne nf lt ng bi translated"><strong class="ak">步骤7:服务类型“节点端口”</strong></h2><p id="74b4" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">其实这一步并不是k3s特有的。我只想强调的是，<code class="fe nu nv nw nm b"><a class="ae kw" href="https://kubernetes.io/docs/concepts/services-networking/service/#nodeport" rel="noopener ugc nofollow" target="_blank">NodePort</a></code> <a class="ae kw" href="https://kubernetes.io/docs/concepts/services-networking/service/#nodeport" rel="noopener ugc nofollow" target="_blank">服务</a>的创建和往常一样简单，因为主机和虚拟机之间的网络对用户来说是透明的:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="be68" class="mv ky iq nm b gy nq nr l ns nt">$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml create deploy nginx2 --image=nginx</span><span id="ee69" class="mv ky iq nm b gy ny nr l ns nt">$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml create svc nodeport nginx2 --tcp=30001:80 --node-port=30001</span><span id="de45" class="mv ky iq nm b gy ny nr l ns nt">$ curl -XGET -s -I -o /dev/null -w "%{http_code}\n" <a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/$(multipass">http://$(multipass</a> info k3s-master | grep "IPv4" | awk -F' ' '{print $2}'):30001<br/>200</span></pre><h2 id="f4e2" class="mv ky iq bd kz mw mx dn ld my mz dp lh kj na nb ll kn nc nd lp kr ne nf lt ng bi translated">步骤8:入口控制器<a class="ae kw" href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjKnILS0MriAhXSzaQKHf5xAjYQFjAAegQIBRAC&amp;url=https%3A%2F%2Ftraefik.io%2F&amp;usg=AOvVaw204mn6RPY_Znna2JH9mdFp" rel="noopener ugc nofollow" target="_blank"> Traefik </a></h2><p id="8e19" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我之前没有提到，但很容易相信，为了保持轻便，k3s做出了一些妥协，其中之一是考虑到<a class="ae kw" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">入口</a>。为了让入口资源工作，集群必须有一个运行的<a class="ae kw" href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" rel="noopener ugc nofollow" target="_blank">入口控制器</a>(通常是<a class="ae kw" href="https://www.nginx.com/products/nginx/kubernetes-ingress-controller" rel="noopener ugc nofollow" target="_blank"> NGiNX </a>)。K3s包括用于此目的的<a class="ae kw" href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjKnILS0MriAhXSzaQKHf5xAjYQFjAAegQIBRAC&amp;url=https%3A%2F%2Ftraefik.io%2F&amp;usg=AOvVaw204mn6RPY_Znna2JH9mdFp" rel="noopener ugc nofollow" target="_blank"> Traefik </a>。它还包括一个简单的服务<a class="ae kw" href="https://github.com/rancher/k3s/blob/master/README.md#service-load-balancer" rel="noopener ugc nofollow" target="_blank">负载均衡器</a>，可以为集群中的服务获取外部IP。让我们看一个如何配置入口控制器的简单示例(只需用正确的ip地址编辑YAML文件):</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="64ac" class="mv ky iq nm b gy nq nr l ns nt">$ cat &lt;&lt;EOF &gt; ingress-controller.yaml<br/>apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: ingress<br/>spec:<br/>  rules:<br/>  - host: <strong class="nm ir">192.168.64.3</strong>.xip.io<br/>    http:<br/>      paths:<br/>      - path: /<br/>        backend:<br/>          serviceName: nginx2<br/>          servicePort: 30001<br/>EOF</span><span id="72c4" class="mv ky iq nm b gy ny nr l ns nt">$ kubectl --kubeconfig=${HOME}/.kube/k3s.yaml apply -f ingress-controller.yaml<br/>ingress.extensions/ingress created</span><span id="a477" class="mv ky iq nm b gy ny nr l ns nt">$ curl -XGET -s -I -o /dev/null -w "%{http_code}\n" <a class="ae kw" href="http://192.168.64.3.xip.io/" rel="noopener ugc nofollow" target="_blank">http://192.168.64.3.xip.io/</a><br/>200 </span></pre><p id="e137" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://nip.io/" rel="noopener ugc nofollow" target="_blank"> nip.io </a>是一个“针对任何ip地址的简单通配符DNS ”,允许您将任何IP地址映射到一个主机名。</p><h2 id="7290" class="mv ky iq bd kz mw mx dn ld my mz dp lh kj na nb ll kn nc nd lp kr ne nf lt ng bi translated">提示:如何通过SSH连接</h2><p id="bdb0" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如果您想更灵活地通过SSH而不是使用<code class="fe nu nv nw nm b">multipass shell</code>连接到多通道虚拟机，您需要使用具有适当权限的路径(OS X)中的密钥，并使用<code class="fe nu nv nw nm b">ubuntu</code>用户:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="b968" class="mv ky iq nm b gy nq nr l ns nt">$ sudo cp -a /var/root/Library/Application\ Support/multipassd/ssh-keys/id_rsa ~/.ssh/multipass<br/>$ sudo chown $USER ~/.ssh/multipass<br/>$ ssh -i ~/.ssh/multipass ubuntu@<em class="md">192.168.64.3</em></span></pre><h2 id="634b" class="mv ky iq bd kz mw mx dn ld my mz dp lh kj na nb ll kn nc nd lp kr ne nf lt ng bi translated"><strong class="ak">最后一步:清理一切</strong></h2><p id="68fd" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这是一次愉快的旅行，现在是时候摆脱一切了:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="86f0" class="mv ky iq nm b gy nq nr l ns nt">$ multipass stop k3s-master k3s-worker1 k3s-worker2<br/>$ multipass delete k3s-master k3s-worker1 k3s-worker2<br/>$ multipass purge</span></pre><h1 id="cf18" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak">结论</strong></h1><p id="9bd6" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">创建一个本地多节点Kubernetes集群是非常容易的，它具有很好的复杂性，同时又不失Minikube的简单性。此外，由于multipass VMs实现保证了Kubernetes调整的隔离和安全性，所描述的解决方案增加了显著的灵活性。</p><p id="9ba6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">作为最后一个提示，我创建了一个bash脚本，它能够建立一个k3s环境，并配有metrics-server、weavescope、prometheus和istio之类的所有功能。非常欢迎您从中获得灵感:</p><p id="5276" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://github.com/mattiaperi/k3s-multipass-cluster" rel="noopener ugc nofollow" target="_blank">https://github.com/mattiaperi/k3s-multipass-cluster</a></p></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="4834" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我希望这些信息对你有用，任何反馈或改进建议都会被很好地接受。</p></div></div>    
</body>
</html>