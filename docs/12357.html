<html>
<head>
<title>Bean injection using custom annotation (BeanPostProcessor)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨å®šåˆ¶æ³¨é‡Šçš„Beanæ³¨å…¥(BeanPostProcessor)</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://levelup.gitconnected.com/bean-injection-using-custom-annotation-beanpostprocessor-d8e886576484?source=collection_archive---------3-----------------------#2022-06-04">https://levelup.gitconnected.com/bean-injection-using-custom-annotation-beanpostprocessor-d8e886576484?source=collection_archive---------3-----------------------#2022-06-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3637" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">æ³¨é‡Šç”¨äºå‘ç¨‹åºè¦ä½¿ç”¨çš„ç±»/å­—æ®µ/æ–¹æ³•æä¾›ä¸€æ¡é™„åŠ ä¿¡æ¯ã€‚è‡ªå®šä¹‰æ³¨é‡Šç°åœ¨å¯¹æˆ‘ä»¬çš„å¼€å‘äººå‘˜æ¥è¯´å·²ç»ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹äº†ï¼Œä½ ä¼šå‘ç°å¾ˆå¤šå…³äºå®ƒçš„æ–‡ç« ã€‚è¯´åˆ°è¿™é‡Œï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è¯•å›¾åˆ†äº«æˆ‘ä»¬å¦‚ä½•é€šè¿‡ä½¿ç”¨è‡ªå®šä¹‰æ³¨é‡Šæ¥ä¸ºæ‚¨çš„æ¥å£æ³¨å…¥ç‰¹å®šçš„å®ç°ã€‚</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/f057f26e1d2bacc01d5b4d000604ba5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OoLaOisAI6qeC2y3.jpg"/></div></div></figure><h1 id="00eb" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">ä»€ä¹ˆæ˜¯BeanPostProcessorï¼Ÿ</h1><p id="5682" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">å®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®ä¾‹åŒ–beanæ—¶å®ç°å®ƒæ¥æ”¾ç½®ä¸€äº›è‡ªå®šä¹‰é€»è¾‘ã€‚å®ƒåˆ©ç”¨äº†beanåˆ›å»ºç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ä¸ºæˆ‘ä»¬æä¾›äº†å›´ç»•å®ƒå®šåˆ¶ä»»ä½•é€»è¾‘çš„çµæ´»æ€§ã€‚</p><p id="f26b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">å®ƒæœ‰ä¸¤ä¸ªæ–¹æ³•å¯ä»¥åœ¨ä»»ä½•beanåˆ›å»ºç”Ÿå‘½å‘¨æœŸä¸­è°ƒç”¨:</p><ol class=""><li id="4905" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated"><code class="fe mj mk ml mm b"><strong class="jp ir">postProcessAfterInitialization()</strong></code>å®ƒåœ¨beanåˆ›å»ºåè¢«è°ƒç”¨ã€‚</li><li id="5d9f" class="ma mb iq jp b jq mn ju mo jy mp kc mq kg mr kk mf mg mh mi bi translated"><code class="fe mj mk ml mm b"><strong class="jp ir">postProcessBeforeInitialization()</strong></code>å®ƒåœ¨beanåˆ›å»ºä¹‹å‰è¢«è°ƒç”¨ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨éœ€è¦ä¸ºç»™å®šçš„æ¥å£æ³¨å…¥ç‰¹å®šçš„beanã€‚è¿™é‡Œæ˜¯æ‚¨çš„è‡ªå®šä¹‰é€»è¾‘ã€‚</li></ol><p id="8fe7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ä¸ºå­—æ®µåˆ›å»ºè‡ªå®šä¹‰æ³¨é‡Šéœ€è¦å‡ ä¸ªæ­¥éª¤ã€‚è®©æˆ‘ä»¬é€ä¸€äº†è§£ã€‚</p><h2 id="c78f" class="ms ky iq bd kz mt mu dn ld mv mw dp lh jy mx my ll kc mz na lp kg nb nc lt nd bi translated">[æ­¥éª¤1]åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ¥å®šä¹‰æ‚¨çš„è‡ªå®šä¹‰æ³¨é‡Šã€‚</h2><pre class="km kn ko kp gt ne mm nf ng aw nh bi"><span id="03d5" class="ms ky iq mm b gy ni nj l nk nl">@Documented<br/>@Target({ElementType.TYPE,ElementType.FIELD})<br/>@Retention(RetentionPolicy.RUNTIME)<br/>public @interface CustomMock {<br/>}</span></pre><h2 id="5dbf" class="ms ky iq bd kz mt mu dn ld mv mw dp lh jy mx my ll kc mz na lp kg nb nc lt nd bi translated">[æ­¥éª¤2]åˆ›å»ºä¸€ä¸ªç±»(å¿…é¡»æ˜¯spring bean)æ¥è¦†ç›–beanåˆ›å»ºç”Ÿå‘½å‘¨æœŸã€‚</h2><p id="a98b" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">å®ƒä½¿ç”¨ä¸€ä¸ªå­—æ®µå›è°ƒç±»æ¥æ”¾ç½®ä¸€ä¸ªä½¿ç”¨åå°„çš„è‡ªå®šä¹‰é€»è¾‘ã€‚</p><pre class="km kn ko kp gt ne mm nf ng aw nh bi"><span id="33f0" class="ms ky iq mm b gy ni nj l nk nl">@Component<br/>public class CustomMockBeanPostProcessor implements BeanPostProcessor {<br/>    @Autowired<br/>    private ConfigurableListableBeanFactory configurableBeanFactory;<br/><br/>    @Override<br/>    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {<br/>        return bean;<br/>    }<br/><br/>    @Override<br/>    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {<br/>        if (bean.getClass().isAnnotationPresent(RunWith.class)) {<br/>            ReflectionUtils.doWithFields(bean.getClass(), new CustomMockFieldCallBack(configurableBeanFactory, bean));<br/>        }<br/>        return bean;<br/>    }<br/>}</span></pre><p id="e8f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ä¸Šé¢çš„å®ç°éœ€è¦ç†è§£ä¸€äº›éå¸¸é‡è¦çš„ä¸œè¥¿ã€‚æˆ‘ä»¬æ²¡æœ‰å‘<code class="fe mj mk ml mm b">afterInitialization()</code>æ·»åŠ ä»»ä½•å®šåˆ¶é€»è¾‘ï¼Œå› ä¸ºä¸€æ—¦beanè¢«åˆ›å»ºæˆ–è¿”å›ï¼Œæˆ‘ä»¬ä¸æ‰“ç®—ä¿®æ”¹ä»»ä½•ä¸œè¥¿ã€‚ç„¶è€Œï¼Œ<code class="fe mj mk ml mm b">beforeInitialization()</code>æœ‰å®šåˆ¶çš„é€»è¾‘ï¼Œå› ä¸ºæ¯å½“ä¸€ä¸ªå­—æ®µç”¨<code class="fe mj mk ml mm b">@CustomMock</code>æ³¨é‡Šæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è¿”å›æˆ‘ä»¬è‡ªå·±çš„å‡beanã€‚</p><blockquote class="nm nn no"><p id="4496" class="jn jo np jp b jq jr js jt ju jv jw jx nq jz ka kb nr kd ke kf ns kh ki kj kk ij bi translated">æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­çš„æ¯ä¸ªbeanéƒ½ä¼šè°ƒç”¨è¿™ä¸ªå®ç°ã€‚å› æ­¤ï¼Œåœ¨å°†å®šåˆ¶é€»è¾‘åº”ç”¨äºä»»ä½•beanä¹‹å‰ï¼Œæˆ‘ä»¬ä¸å¯é¿å…åœ°è¦è¿›è¡Œé€‚å½“çš„éªŒè¯/çº¦æŸã€‚</p></blockquote><p id="4e19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåªå¯¹ç”¨<code class="fe mj mk ml mm b">@RunWith</code>æ³¨é‡Šæ ‡æ³¨çš„ç±»çš„å­—æ®µæœ‰æ•ˆçš„éªŒè¯ã€‚å¯¹äºå…¶ä»–ç±»ï¼Œæ‰€æœ‰çš„beanséƒ½å°†ä½¿ç”¨é»˜è®¤çš„æµæ¥åˆ›å»ºã€‚</p><h2 id="4fff" class="ms ky iq bd kz mt mu dn ld mv mw dp lh jy mx my ll kc mz na lp kg nb nc lt nd bi translated">[æ­¥éª¤3]ä¸ºå®é™…å®šåˆ¶é€»è¾‘æ‰€åœ¨çš„å®šåˆ¶æ¨¡æ‹Ÿå­—æ®µå›è°ƒåˆ›å»ºä¸€ä¸ªç±»ã€‚</h2><pre class="km kn ko kp gt ne mm nf ng aw nh bi"><span id="6e9d" class="ms ky iq mm b gy ni nj l nk nl">public class CustomMockFieldCallBack implements ReflectionUtils.FieldCallback {<br/><br/>  private ConfigurableListableBeanFactory configurableBeanFactory;<br/>  private Object bean;<br/><br/>  public CustomWiredFieldCallBack(ConfigurableListableBeanFactory configurableBeanFactory, Object bean) {<br/>      this.configurableBeanFactory = configurableBeanFactory;<br/>      this.bean = bean;<br/>  }<br/><br/>  @Override<br/>  public void doWith(Field field) throws IllegalArgumentException, IllegalAccessException {<br/>      if (field.isAnnotationPresent(CustomMock.class)) {<br/>          Class&lt;?&gt; interface = field.getType();<br/>          ReflectionUtils.makeAccessible(field);<br/>          Object mockImplementation = getBeanInstance(InterfaceMockBeanMapper.getMockBeanName(interface), interface);<br/>          field.set(bean, mockImplementation);<br/>      }<br/><br/>  }<br/><br/>  public Object getBeanInstance(String beanName, Class interface) {<br/>      Object mockImplementation = null;<br/>      if (!configurableBeanFactory.containsBean(beanName)) {<br/>          Object newInstance = null;<br/>          try {<br/>              Constructor&lt;?&gt; ctr = interface.getConstructor();<br/>              newInstance = ctr.newInstance();<br/>          } catch (Exception e) {<br/>              throw new RuntimeException(e);<br/>          }<br/><br/>          mockImplementation = configurableBeanFactory.initializeBean(newInstance, beanName);<br/>          configurableBeanFactory.autowireBeanProperties(mockImplementation, AutowireCapableBeanFactory.AUTOWIRE_BY_NAME, true);<br/>          configurableBeanFactory.registerSingleton(beanName, mockImplementation);<br/>      } else {<br/>          mockImplementation = configurableBeanFactory.getBean(beanName);<br/>      }<br/>      return mockImplementation;<br/>  }<br/>}</span></pre><ol class=""><li id="9913" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated">ä¸Šé¢çš„ç±»åˆ©ç”¨Javaåå°„æ¥è®¿é—®ç±»çš„ç§æœ‰å­—æ®µï¼Œå¹¶å°†ç›®æ ‡beanåˆ†é…ç»™å®ƒã€‚</li><li id="78dc" class="ma mb iq jp b jq mn ju mo jy mp kc mq kg mr kk mf mg mh mi bi translated">å®ƒè¿˜å¯¹å­—æ®µè¿›è¡Œäº†éªŒè¯ï¼Œå³å­—æ®µå¿…é¡»ä½¿ç”¨<code class="fe mj mk ml mm b">@CustomMock</code>æ³¨é‡Šæ‰èƒ½å·¥ä½œã€‚</li><li id="64a2" class="ma mb iq jp b jq mn ju mo jy mp kc mq kg mr kk mf mg mh mi bi translated"><strong class="jp ir"> InterfaceMockBeanMapper </strong>ç”¨äºè·å–ç»™å®šæ¥å£çš„æ¨¡æ‹Ÿbeanåç§°ã€‚åŸºäºbeanåç§°ï¼Œå¦‚æœç»™å®šçš„beanä¸å­˜åœ¨ï¼Œå°†ä»<code class="fe mj mk ml mm b">getBeanInstance()</code>è¿”å›ä¸€ä¸ªbeanï¼Œç„¶ååˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªå…·æœ‰ç»™å®šåç§°çš„æ–°beanã€‚</li></ol><h2 id="14c3" class="ms ky iq bd kz mt mu dn ld mv mw dp lh jy mx my ll kc mz na lp kg nb nc lt nd bi translated">å¦‚ä½•åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ä½¿ç”¨<code class="fe mj mk ml mm b">@CustomMock</code>ï¼Ÿ</h2><pre class="km kn ko kp gt ne mm nf ng aw nh bi"><span id="d89a" class="ms ky iq mm b gy ni nj l nk nl">@RunWith(SpringRunner.class)</span><span id="067d" class="ms ky iq mm b gy nt nj l nk nl">public FeatureTestClass {</span><span id="a0fb" class="ms ky iq mm b gy nt nj l nk nl">   @CustomMock</span><span id="5a10" class="ms ky iq mm b gy nt nj l nk nl">   private Interface1 bean1;</span><span id="7a94" class="ms ky iq mm b gy nt nj l nk nl">   @CustomMock</span><span id="368f" class="ms ky iq mm b gy nt nj l nk nl">   private Interface2 bean2;</span><span id="1c2f" class="ms ky iq mm b gy nt nj l nk nl">   @Test</span><span id="e954" class="ms ky iq mm b gy nt nj l nk nl">   public void testFeatureClassMethod() {</span><span id="cc96" class="ms ky iq mm b gy nt nj l nk nl">        FeatureClass featureClass = new FeatureClass(bean1, bean2);</span><span id="b888" class="ms ky iq mm b gy nt nj l nk nl">        featureClass.method();</span><span id="171d" class="ms ky iq mm b gy nt nj l nk nl">        ...</span><span id="3a89" class="ms ky iq mm b gy nt nj l nk nl">        //assert</span><span id="7d5f" class="ms ky iq mm b gy nt nj l nk nl">   }</span><span id="b8d7" class="ms ky iq mm b gy nt nj l nk nl">}</span></pre><p id="1bbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">æ„Ÿè°¢é˜…è¯»ï¼ï¼</p></div><div class="ab cl nu nv hu nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="ij ik il im in"><h1 id="43c3" class="kx ky iq bd kz la ob lc ld le oc lg lh li od lk ll lm oe lo lp lq of ls lt lu bi translated">åˆ†çº§ç¼–ç </h1><p id="b362" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">æ„Ÿè°¢æ‚¨æˆä¸ºæˆ‘ä»¬ç¤¾åŒºçš„ä¸€å‘˜ï¼åœ¨ä½ ç¦»å¼€ä¹‹å‰:</p><ul class=""><li id="7f72" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk og mg mh mi bi translated">ğŸ‘ä¸ºæ•…äº‹é¼“æŒï¼Œè·Ÿç€ä½œè€…èµ°ğŸ‘‰</li><li id="d838" class="ma mb iq jp b jq mn ju mo jy mp kc mq kg mr kk og mg mh mi bi translated">ğŸ“°æŸ¥çœ‹<a class="ae oh" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">å…³å¡å‡çº§ç¼–ç </a>ä¸­çš„æ›´å¤šå†…å®¹</li><li id="51ad" class="ma mb iq jp b jq mn ju mo jy mp kc mq kg mr kk og mg mh mi bi translated">ğŸ””å…³æ³¨æˆ‘ä»¬:<a class="ae oh" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank"> Twitter </a> | <a class="ae oh" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a></li><li id="bca5" class="ma mb iq jp b jq mn ju mo jy mp kc mq kg mr kk og mg mh mi bi translated">ğŸš€ğŸ‘‰<a class="ae oh" href="https://jobs.levelup.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">è½¯ä»¶å·¥ç¨‹å¸ˆçš„é¡¶çº§å·¥ä½œ</strong> </a></li></ul></div></div>    
</body>
</html>