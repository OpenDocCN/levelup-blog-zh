<html>
<head>
<title>Installing Kubernetes with Kubespray on NIPA Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在帕尼云上使用Kubespray安装Kubernetes</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/installing-kubernetes-with-kubespray-on-nipa-cloud-a4fbeefb47ff?source=collection_archive---------8-----------------------#2020-07-08">https://levelup.gitconnected.com/installing-kubernetes-with-kubespray-on-nipa-cloud-a4fbeefb47ff?source=collection_archive---------8-----------------------#2020-07-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn"><p id="542a" class="jo jp iq bd jq jr js jt ju jv jw jx dk translated">在这里，我们将部署一个生产就绪的Kubernetes HA-Cluster，其中有5个虚拟机，3个主节点和2个工作节点。</p></blockquote><h1 id="9904" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">准备基础设施</h1><h2 id="903f" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">在<a class="ae ll" href="https://portal.nipa.cloud" rel="noopener ugc nofollow" target="_blank">帕尼云</a>上启动实例</h2><blockquote class="lm ln lo"><p id="f576" class="lp lq lr ls b lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm jx ij bi translated">帕尼云平台(NCP)是泰国领先的云提供商之一。<a class="ae ll" href="https://portal.nipa.cloud/launchinstance" rel="noopener ugc nofollow" target="_blank">https://portal . nipa . cloud</a></p></blockquote><p id="2ff0" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">我们从创建虚拟机开始。如果您已经准备好机器，可以跳过这一步。对于本地应用程序，我选择使用帕尼云，它提供无限的国内带宽和合理的项目启动价格。</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mn"><img src="../Images/3bfffe0748cbe3bcb4c7ae2e55f458b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pgQ7Bnr1nCpDdU5Z-XDotg.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">用nc3启动了5个实例。NCP上的机器类型</figcaption></figure><p id="a9f6" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">在这个集群中，我们使用6个nc3实例。NCP上的一种机器类型，其中每一种都具有下列特性:</p><ul class=""><li id="1d5e" class="nd ne iq ls b lt lu lx ly lb nf le ng lh nh jx ni nj nk nl bi translated">1个CPU，2 GB内存</li><li id="4822" class="nd ne iq ls b lt nm lx nn lb no le np lh nq jx ni nj nk nl bi translated">Ubuntu 18.04(目前20.04不工作)</li><li id="3055" class="nd ne iq ls b lt nm lx nn lb no le np lh nq jx ni nj nk nl bi translated">允许所有云防火墙规则</li></ul><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nr"><img src="../Images/c7c86a380b0c0a65dc98af5b825aa495.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V6bdfYPKcf8JsKQO6zni7A.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">NCP中的防火墙规则示例</figcaption></figure><pre class="mo mp mq mr gt ns nt nu nv aw nw bi"><span id="a51a" class="kw jz iq nt b gy nx ny l nz oa"># Check if IP forwarding is enabled<br/>$ sudo sysctl net.ipv4.ip_forward<br/>$ sudo sysctl -w net.ipv4.ip_forward=1<br/># net.ipv4.ip_forward = 1</span><span id="17e7" class="kw jz iq nt b gy ob ny l nz oa">$ sudo ufw status<br/># Status: inactive<br/>$ sudo ufw disable</span></pre><h1 id="cb92" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj oc kl km kn od kp kq kr oe kt ku kv bi translated">设置Kubespray</h1><p id="16d0" class="pw-post-body-paragraph lp lq iq ls b lt of lv lw lx og lz ma lb oh md me le oi mh mi lh oj ml mm jx ij bi translated">Kubespray 提供了一种使用Ansible playbooks和Kubeadm安装Kubernetes集群引导的简单方法。它具有易用性和灵活性，可以定制您的部署和Kubernetes附加组件。</p><h2 id="566e" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">易变主机</h2><p id="1581" class="pw-post-body-paragraph lp lq iq ls b lt of lv lw lx og lz ma lb oh md me le oi mh mi lh oj ml mm jx ij bi translated">在本例中，我使用其中一个虚拟机(即k8s-node-1)作为一个可运行的主机来运行部署脚本。为了做到这一点，我们需要为Ansible提供SSH密钥来访问所有远程主机。</p><p id="6807" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">生成<strong class="ls ir"> SSH密钥</strong>并将公钥传送给所有远程主机。</p><pre class="mo mp mq mr gt ns nt nu nv aw nw bi"><span id="3612" class="kw jz iq nt b gy nx ny l nz oa">ssh-keygen -t rsa -b 2048<br/>eval "$(ssh-agent -s)"<br/>ssh-add ~/.ssh/id_rsa</span><span id="2806" class="kw jz iq nt b gy ob ny l nz oa"># transfer the public key to all nodes.<br/>ssh-copy-id user@&lt;ip-address-1&gt;<br/>ssh-copy-id user@&lt;ip-address-n&gt;<br/># the public key will be added to ~/.ssh/authorized_keys</span><span id="8f32" class="kw jz iq nt b gy ob ny l nz oa"># add SSH key fingerprints to know_hosts<br/>ssh-keyscan -H &lt;ip-address-1&gt; &gt;&gt; ~/.ssh/known_hosts<br/>ssh-keyscan -H &lt;ip-address-n&gt; &gt;&gt; ~/.ssh/known_hosts</span></pre><h2 id="bc36" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">Kubespray配置</h2><p id="a3da" class="pw-post-body-paragraph lp lq iq ls b lt of lv lw lx og lz ma lb oh md me le oi mh mi lh oj ml mm jx ij bi translated">设置了主机和工作节点。下一步是为集群引导配置Kubespray，我们将使用Kubespray版本2 . 13 . 1(2020年5月发布)。</p><p id="8d3d" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">我们首先将kubespray存储库克隆到Ansible主机中，并安装python依赖项(例如ansible v2.9.6)。然后，我们使用来自<code class="fe ok ol om nt b">inventory/sample</code>的清单作为我们的配置模板。</p><pre class="mo mp mq mr gt ns nt nu nv aw nw bi"><span id="52ab" class="kw jz iq nt b gy nx ny l nz oa">git clone --branch v2.13.1 <a class="ae ll" href="https://github.com/kubernetes-sigs/kubespray" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes-sigs/kubespray</a> &amp;&amp; cd kubespray</span><span id="52e8" class="kw jz iq nt b gy ob ny l nz oa"># install dependencies<br/>sudo apt install -y python3-dev python3-pip <!-- -->python3-setuptools<br/>sudo pip3 install -r requirements.txt</span><span id="e211" class="kw jz iq nt b gy ob ny l nz oa"># copy `inventory/sample` as `inventory/mycluster`<br/>cp -r inventory/sample inventory/mycluster</span></pre><p id="07a2" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">从<code class="fe ok ol om nt b">inventory</code>模板看可行的行动手册结构。</p><pre class="mo mp mq mr gt ns nt nu nv aw nw bi"><span id="78a8" class="kw jz iq nt b gy nx ny l nz oa">inventory<br/>  + mycluster<br/>    + group_vars:<br/>      + all<br/>        - all.yml<br/>    + k8s-cluster<br/>      - addons.yml<br/>      - k8s-cluster.yml<br/>    - host.yml<br/>requirements.txt<br/>cluster.yml</span></pre><p id="4d7a" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">现在，我们可以自定义<strong class="ls ir"> group_vars </strong>目录下的库存变量。</p><p id="afdb" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">例如:</p><ol class=""><li id="3056" class="nd ne iq ls b lt lu lx ly lb nf le ng lh nh jx on nj nk nl bi translated">inventory/my cluster/group _ vars/<strong class="ls ir">all/all . yml</strong></li></ol><pre class="mo mp mq mr gt ns nt nu nv aw nw bi"><span id="95fe" class="kw jz iq nt b gy nx ny l nz oa"># The read-only port for the Kubelet to serve on with <br/># no authentication/authorization. <br/># It should be enabled in order to metrics-server work.<br/>kube_read_only_port: 10255</span></pre><p id="4d13" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">2.inventory/my cluster/group _ vars/<strong class="ls ir">k8s-cluster/k8s-cluster . yml</strong></p><p id="5732" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">3.inventory/my cluster/group _ vars/<strong class="ls ir">k8s-cluster/addons . yml</strong></p><p id="6e8a" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">您可以配置符合您需求的<strong class="ls ir">插件</strong>或者保留默认值。对于我来说，我选择启用这些特性，因为我发现它们非常有用。</p><pre class="mo mp mq mr gt ns nt nu nv aw nw bi"><span id="dfc7" class="kw jz iq nt b gy nx ny l nz oa"># Kubernetes dashboard<br/>dashboard_enabled: true</span><span id="b0cb" class="kw jz iq nt b gy ob ny l nz oa"># Helm deployment<br/>helm_enabled: true</span><span id="31dd" class="kw jz iq nt b gy ob ny l nz oa"># Metrics Server deployment<br/>metrics_server_enabled: true</span><span id="0171" class="kw jz iq nt b gy ob ny l nz oa"># Nginx ingress controller deployment<br/>ingress_nginx_enabled: true</span><span id="d0c4" class="kw jz iq nt b gy ob ny l nz oa"><em class="lr"># Cert manager deployment<br/></em>cert_manager_enabled: true<br/>cert_manager_namespace: "cert-manager"</span></pre><h2 id="94ec" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">库存生成器</h2><p id="9c88" class="pw-post-body-paragraph lp lq iq ls b lt of lv lw lx og lz ma lb oh md me le oi mh mi lh oj ml mm jx ij bi translated"><a class="ae ll" href="https://github.com/kubernetes-sigs/kubespray/blob/v2.13.0/contrib/inventory_builder/inventory.py" rel="noopener ugc nofollow" target="_blank"> Inventory builder </a>给出了一个自动化脚本来更新Ansible inventory文件(现在只输出YAML文件)。</p><pre class="mo mp mq mr gt ns nt nu nv aw nw bi"><span id="a0f9" class="kw jz iq nt b gy nx ny l nz oa"># see example usage<br/>python3 contrib/inventory_builder/inventory.py help</span></pre><p id="40b0" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">配置环境变量</p><pre class="mo mp mq mr gt ns nt nu nv aw nw bi"><span id="05f1" class="kw jz iq nt b gy nx ny l nz oa"># just to make it looks nicer<br/># host prefix for generated hosts. Default: node<br/>export HOST_PREFIX=k8s-node-</span><span id="234a" class="kw jz iq nt b gy ob ny l nz oa"># custom number of 3 master nodes. Default: 2<br/>export KUBE_MASTERS_MASTERS=3</span></pre><p id="a434" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">使用清单生成器添加具有不同IP地址的主机</p><pre class="mo mp mq mr gt ns nt nu nv aw nw bi"><span id="f51f" class="kw jz iq nt b gy nx ny l nz oa">declare -a IPS=(10.148.0.9 10.148.0.32 10.148.0.17 10.148.0.23 10.148.0.15)</span><span id="bd7a" class="kw jz iq nt b gy ob ny l nz oa">CONFIG_FILE=inventory/mycluster/hosts.yml python3 contrib/inventory_builder/inventory.py ${IPS[@]}</span><span id="d0a2" class="kw jz iq nt b gy ob ny l nz oa">cat inventory/mycluster/hosts.yml</span></pre><p id="27c7" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">来自<code class="fe ok ol om nt b">hosts.yml</code>的输出</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="16b5" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">从上面的主机配置文件中，我们可以查看这些属性[ <code class="fe ok ol om nt b">kube-master</code>、<code class="fe ok ol om nt b">kube-nodes</code>和<code class="fe ok ol om nt b">etcd</code>，以确保集群规范。</p><h2 id="50d0" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">Kubespray与Ansible Playbook</h2><p id="0b16" class="pw-post-body-paragraph lp lq iq ls b lt of lv lw lx og lz ma lb oh md me le oi mh mi lh oj ml mm jx ij bi translated">现在，我们正在构建Kubernetes集群。Kubespray以root用户身份运行剧本，因此需要选项<code class="fe ok ol om nt b">--become</code>。</p><pre class="mo mp mq mr gt ns nt nu nv aw nw bi"><span id="fa63" class="kw jz iq nt b gy nx ny l nz oa"><strong class="nt ir">ansible-playbook</strong> -i inventory/mycluster/<strong class="nt ir">hosts.yml</strong> --become --become-user=root cluster.yml</span></pre><p id="4f70" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated"><strong class="ls ir"> <em class="lr">可选</em> </strong> : <code class="fe ok ol om nt b">--user REMOTE_USER</code>作为您的用户连接，<code class="fe ok ol om nt b">--timeout TIMEOUT</code>作为我曾经在“链接calico-node的etcd证书”任务中遇到的<code class="fe ok ol om nt b">timeout(12s) waiting for privilege escalation prompt</code>进行故障排除，或者<code class="fe ok ol om nt b">--flush-cache</code>清除清单中每个主机的缓存。</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi oq"><img src="../Images/6173542da4fedba917af72797a2bf626.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VH-AH-WKJ6V9ntYly2pVXA.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">成功安装Kubernetes集群。</figcaption></figure><p id="c173" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">最后，我们可以使用<code class="fe ok ol om nt b">kubectl</code>来管理Kubernetes集群。</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi or"><img src="../Images/1d8dfb2dfec1767eb19d1d556b2073f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1NBEcGAKxtNFeqgkfU5jHA.png"/></div></div></figure><p id="0f65" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">是的，我们做到了！！。它将显示节点及其属性的列表。</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="os op l"/></div></figure></div><div class="ab cl ot ou hu ov" role="separator"><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy"/></div><div class="ij ik il im in"><h1 id="04cd" class="jy jz iq bd ka kb pa kd ke kf pb kh ki kj pc kl km kn pd kp kq kr pe kt ku kv bi translated">测试集群</h1><h2 id="ca64" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">你好，库伯内特！</h2><p id="6924" class="pw-post-body-paragraph lp lq iq ls b lt of lv lw lx og lz ma lb oh md me le oi mh mi lh oj ml mm jx ij bi translated">部署hello-kubernetes应用程序，它包含入口、服务和部署对象的定义，<a class="ae ll" href="https://github.com/paulbouwer/hello-kubernetes" rel="noopener ugc nofollow" target="_blank">https://github.com/paulbouwer/hello-kubernetes</a></p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="ec4f" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">现在，我们将主机名映射到/etc/hosts文件中的IP地址:<code class="fe ok ol om nt b">&lt;your-ip-address&gt;&gt; hello-kubernetes.mycluster.com</code>来访问网站。传入的请求将通过入口和服务转发到pods。</p><p id="8192" class="pw-post-body-paragraph lp lq iq ls b lt lu lv lw lx ly lz ma lb mc md me le mg mh mi lh mk ml mm jx ij bi translated">至于Kubernetes IDE，我们使用<a class="ae ll" href="https://k8slens.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="ls ir"> K8s-Lens </strong> </a>来监控、操作和调试Kubernetes集群。</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi oq"><img src="../Images/563fec27a9527c044d2a85da806a360d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uNfCqJF0y-EoiBbpQInjGA.png"/></div></div></figure></div></div>    
</body>
</html>