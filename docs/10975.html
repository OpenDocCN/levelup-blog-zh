<html>
<head>
<title>Firestore Full-Text Search With Elastic Search Part 1: Setup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Firestore弹性搜索全文搜索第1部分:设置</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/firestore-full-text-search-with-elastic-search-part-1-setup-6c9d12098a1b?source=collection_archive---------6-----------------------#2022-02-02">https://levelup.gitconnected.com/firestore-full-text-search-with-elastic-search-part-1-setup-6c9d12098a1b?source=collection_archive---------6-----------------------#2022-02-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="912c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用firebase、复杂查询、过滤等功能设置Elasticsearch！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7c3677aeec76e5aa91bcf91df13fa623.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Mvav3xGTuJgF8PUt"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">马库斯·温克勒在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="fe95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Elasticsearch很神奇，Firebase很神奇，为什么不把两者放在一起？如果你不熟悉Elasticsearch，它是一个分布式的、基于REST的搜索引擎，使用<a class="ae ky" href="https://lucene.apache.org/core/#:~:text=Apache%20Lucene%E2%84%A2%20is%20a,spell%20correction%20or%20query%20suggestions." rel="noopener ugc nofollow" target="_blank"> Lucene </a>库来提供强大的搜索功能。我是ARM的一名软件工程师，我正在构建的平台的主要功能之一是搜索。虽然我在工作中使用Azure search，但Elasticsearch的功能数量和易用性给我留下了深刻的印象。我已经在一个跨平台的移动应用程序上使用了带有firebase的Elasticsearch，我在过去的8个月里一直在做这个应用程序，我肯定会推荐它。</p><p id="f957" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在那里找到所有与搜索相关的功能，例如:</p><ol class=""><li id="e242" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">建议</li><li id="f434" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">自动完成</li><li id="31ef" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">分析学</li><li id="4f02" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">过滤</li><li id="e36f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">整理</li><li id="6934" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">还有更多...</li></ol><p id="2d4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将是一个关于如何使用Firebase和Elasticsearch的教程。在教程的第一部分，我们将设置3个监听器云函数。这些云功能的目的是将Firestore与Elasticsearch的索引完全同步。第一个函数负责同步写事件，第二个函数负责删除事件，最后一个函数负责更新事件。</p><p id="c27f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:在本教程中，我们将使用Typescript</p><p id="bc1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第二部分，我们将编写另一个云函数，在Elasticsearch的API上构建一个覆盖层，以允许各种不同的搜索查询。事不宜迟，我们开始吧！</p><h2 id="4835" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">设置弹性搜索</h2><p id="8fe2" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">你需要做的第一件事就是去<a class="ae ky" href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank"> Elasticsearch </a>创建一个账户。创建帐户后，只需登录并点击“开始免费试用”。然后，Elasticsearch会提示您命名您的第一个Elasticsearch服务，单击“下一步”后，您应该会看到一个显示您的服务凭据的窗口，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/d793dc1312f09ad6f10a52cd3a0694e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E9uHMg7LxerXZtiB45fSrw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</figcaption></figure><p id="8ce3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">把它们复制到一个安全的地方，因为它们以后会非常重要。</p><h2 id="ed8d" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">同步Firestore和Elasticsearch</h2><p id="6c86" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">在我们开始之前，让我们快速概述一下<a class="ae ky" href="https://firebase.google.com/docs/functions/database-events" rel="noopener ugc nofollow" target="_blank"> Firebase的数据库触发器</a>。顾名思义，这些触发器监听firestore并在某个动作发生时发出一个事件。这非常类似于<a class="ae ky" href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern" rel="noopener ugc nofollow" target="_blank">发布-订阅模式</a>。我们将在这里使用的3个监听器是:</p><ul class=""><li id="9411" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ni mb mc md bi translated"><code class="fe nj nk nl nm b"><a class="ae ky" href="https://firebase.google.com/docs/reference/functions/providers_database.refbuilder#on-create" rel="noopener ugc nofollow" target="_blank">onCreate()</a></code>，在实时数据库中创建新数据时触发。</li><li id="ad9d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ni mb mc md bi translated"><code class="fe nj nk nl nm b"><a class="ae ky" href="https://firebase.google.com/docs/reference/functions/providers_database.refbuilder#on-update" rel="noopener ugc nofollow" target="_blank">onUpdate()</a></code>，实时数据库数据更新时触发。</li><li id="f16d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ni mb mc md bi translated"><code class="fe nj nk nl nm b"><a class="ae ky" href="https://firebase.google.com/docs/reference/functions/providers_database.refbuilder#on-delete" rel="noopener ugc nofollow" target="_blank">onDelete()</a></code>，从实时数据库中删除数据时触发。</li></ul><p id="660f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">来源:<a class="ae ky" href="https://firebase.google.com/docs/functions/database-events" rel="noopener ugc nofollow" target="_blank"> Firebase文档</a></p><p id="2a38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:虽然我知道有一个<a class="ae ky" href="https://firebase.google.com/products/extensions/elastic-firestore-elastic-app-search" rel="noopener ugc nofollow" target="_blank">扩展</a>执行非常相似的功能，但我发现自己实现这些东西总是更好，这样您可以更好地理解它们，并对它们有更多的控制。例如，当我在我构建的移动应用程序中使用它时，在某些情况下我不想同步整个文档。具体的功能，因为这将是唯一可用的，如果你真的自己编码。</p><ol class=""><li id="288b" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu">同步写入</strong></li></ol><p id="7512" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Elasticsearch有各种各样的API，这使得开始使用有点困难:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/fca8cfa52fff22eb596b63c85d0ff22e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*-4g4yfbMKJgQl-_Bdyh_Wg.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html" rel="noopener ugc nofollow" target="_blank">弹性搜索</a></figcaption></figure><p id="c51b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用的第一个API是<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html" rel="noopener ugc nofollow" target="_blank">索引API </a>。这是因为我们将利用这个端点，它允许我们将文档添加到搜索索引中。</p><pre class="kj kk kl km gt no nm np nq aw nr bi"><span id="8710" class="mj mk it nm b gy ns nt l nu nv">PUT /&lt;target&gt;/_create/&lt;_id&gt;</span></pre><p id="5d7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Elasticsearch服务下，您可以添加许多不同的索引(称为“目标”)。在这种情况下，您不需要手动创建索引，因为如果它不存在，将我们的第一个文档放在那里会自动为我们创建一个。</p><p id="41cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要从Elasticsearch获得的下一个东西是认证。Elasticsearch的端点使用基本认证，这意味着我们需要用户名和密码。我们需要将它们编码成base64字符串。要获得这些，请前往Elasticsearch控制台<a class="ae ky" href="https://cloud.elastic.co/deployments" rel="noopener ugc nofollow" target="_blank">这里</a>，并选择您的部署。点击您的部署后，点击Elasticsearch部分的“复制端点”:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/b73cb88b217a590f397bd68c33323738.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*227fQvEsyL-J7IJ75s8HGw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</figcaption></figure><p id="4021" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还记得我们之前抢到的用户名和密码吗？我们现在要使用它们。注意，建议你把它们上传到Firebase环境变量(functions config)中，但是在本教程中，我们只是把它们作为字符串使用。</p><p id="3e7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们需要向Elasticsearch发送HTTP请求，所以我们将使用Axios。这里我们要做的是，在指定集合中创建的每个文档上，我们要将快照数据添加到Elasticsearch索引中。这可以通过以下方式完成:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</figcaption></figure><p id="89d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！现在，您只需将它部署到firebase环境中，如果您向firestore集合中添加任何文档，它都会自动同步到您的索引中。请注意，我们在索引中创建的文档与firestore快照具有相同的id。</p><h2 id="3d01" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">2.同步更新和删除</h2><p id="aa37" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">既然我们已经设置好了一切，剩下的就很简单了。首先，为了同步更新，我们将使用<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update.html" rel="noopener ugc nofollow" target="_blank">更新API </a>，更具体地说，这个端点:</p><pre class="kj kk kl km gt no nm np nq aw nr bi"><span id="aac3" class="mj mk it nm b gy ns nt l nu nv">POST /&lt;index&gt;/_update/&lt;_id&gt;</span></pre><p id="e253" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我们在这里使用的是POST请求，而对于writes，我们使用的是PUT请求。这次我们将使用“on update”firestore触发器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</figcaption></figure><p id="9dc6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，这里我们捕获的是“change.after ”,这是文档更新后的数据，我们只是将它发布到Elasticsearch。</p><p id="d3bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们现在还可以执行删除操作。这将对端点使用删除API:</p><pre class="kj kk kl km gt no nm np nq aw nr bi"><span id="4de7" class="mj mk it nm b gy ns nt l nu nv">DELETE /&lt;index&gt;/_doc/&lt;_id&gt;</span></pre><p id="bcb5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还将发送一个“删除”请求(显然),如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</figcaption></figure><h2 id="63da" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">结论</h2><p id="43c6" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">就是这样！如果你部署了这3个功能，你的firestore应该与你的Elasticsearch服务同步。如果您遇到任何不幸的错误，您可以查看云函数错误日志(希望您不要这样做)。在本教程的下一部分，我将介绍索引的搜索和过滤。欢迎在评论中留下任何问题。</p></div></div>    
</body>
</html>