<html>
<head>
<title>How to Parallelize Your Python Tests Easily With CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用CircleCI轻松并行化您的Python测试</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-parallelize-your-python-tests-easily-with-circleci-473bd79eba98?source=collection_archive---------9-----------------------#2021-03-29">https://levelup.gitconnected.com/how-to-parallelize-your-python-tests-easily-with-circleci-473bd79eba98?source=collection_archive---------9-----------------------#2021-03-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c047" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">不要让考试拖你的后腿！</h2></div><h1 id="c400" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">连续累计</h1><p id="baa8" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">持续集成(CI)是软件社区中非常广泛的实践，尤其是在多个开发人员在同一个代码库中工作的公司中。CI允许开发人员频繁地将代码变更合并到一个存储库中，在那里运行构建和测试。CircleCI等自动化工具用于断言新代码的正确性，并在集成前确保高质量的代码。</p><p id="4457" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">使用大型代码库或机器学习模型的公司通常会发现他们的测试需要很长时间才能运行。作为一个标准过程，对于每个Pull请求，整个测试套件被配置为针对每个新的提交运行。长时间的测试构建会减慢特性的部署，引发超时错误，甚至会影响团队士气(因为没有人愿意等待40分钟的测试通过来合并一个小的输入错误)。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ly"><img src="../Images/d63461b9fdf1a86236f0b8171ff18e72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dg-CEFVxCtizENgbVoLbBA.jpeg"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">另一个40分钟的测试版本！——图片由<a class="ae mo" href="https://unsplash.com/@punttim?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">蒂姆·高</a>在<a class="ae mo" href="/s/photos/developer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="929f" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">幸运的是，集群并行化拯救了数百万开发人员的生命！</p><p id="c444" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">项目中的测试越多，在单台机器上完成测试所需的时间就越长。为了减少运行时间，我们可以通过将测试分布在多个独立的集群中来并行运行测试。CircleCI提供了一个支持该功能的内置解决方案(【https://circleci.com/docs/2.0/parallelism-faster-jobs/】T4)。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mp"><img src="../Images/0353dc08e3ec19e1c9b4a2e810c30346.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k5p1wnXclPwBJzYj716ySQ.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">平行分割—来自<a class="ae mo" href="https://circleci.com/docs/2.0/parallelism-faster-jobs/" rel="noopener ugc nofollow" target="_blank"> CircleCI </a>的图像</figcaption></figure><p id="4940" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">但是，为了使其正常工作，在实施过程中需要考虑一些注意事项…</p><h1 id="6b51" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">使用CircleCI可以轻松实现并行化</h1><p id="98aa" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">CircleCI提供了三种并行化测试的方法:</p><ol class=""><li id="5d3c" class="mq mr iq kz b la lt ld lu lg ms lk mt lo mu ls mv mw mx my bi translated">使用文件名:将按字母顺序分割测试。</li><li id="0a0c" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">使用文件大小:将根据文件的大小分割测试。</li><li id="1762" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">使用计时数据:将基于先前测试计算的运行时间来分割测试。</li></ol><p id="a661" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">可以想象，减少时间的最佳方式是第三种选择，因为文件大小和文件名都没有考虑测试运行时。实施时间分割将是最终目标，所以…让我们开始吧！</p><p id="0b85" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">您的典型配置文件可能如下所示:</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="a248" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">首先，我们将使用<code class="fe ng nh ni nj b">parallelism</code>键指定不同集群的数量。它设置将创建多少个独立的执行者来运行作业的步骤，并且在作业级别实现。</p><p id="961b" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">接下来，一旦我们选择了机器的数量，我们需要告诉CircleCI我们想要拆分哪些测试以及如何拆分。CircleCI提供了<code class="fe ng nh ni nj b">circleci tests glob</code>和<code class="fe ng nh ni nj b">circleci tests split</code>命令分别用于选择和分割。</p><p id="4ba6" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">对于四台机器的并行化，如果我们按照CircleCI的说明更新配置文件，它将如下所示:</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h1 id="559b" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">但没那么容易！</h1><p id="79cb" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">只有这些修改，构建将无法正常工作。</p><p id="8aaf" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">CircleCI要求我们存储以前构建的运行时。我们必须添加一个额外的步骤<code class="fe ng nh ni nj b">store_test_results</code>，让CircleCI在指定的目录中保存计时数据。计时数据由一个文件组成，该文件说明了测试文件名(或者类名)以及对于特定的构建完成每个测试需要多长时间。</p><p id="593e" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">也就是说，对我来说，做出这样的改变还不足以创建一个正确的并行化版本。为了开始探索发生了什么，我在配置文件中添加了<code class="fe ng nh ni nj b">store_test_artifacts</code>步骤。这让我可以下载和查看保存的测试文件。我保存的测试文件不是CircleCI期望读取和正确分割的格式。</p><p id="42c8" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">根据与CircleCI支持团队的一些对话，以及我自己的调查，我对配置文件做了以下补充:</p><ul class=""><li id="760c" class="mq mr iq kz b la lt ld lu lg ms lk mt lo mu ls nk mw mx my bi translated">创建了一个文件<code class="fe ng nh ni nj b">.circleci/resources/pytest_build_config.ini</code>来改变默认的测试框架:</li></ul><pre class="lz ma mb mc gt nl nj nm nn aw no bi"><span id="9d5c" class="np kg iq nj b gy nq nr l ns nt">[pytest]</span><span id="dea9" class="np kg iq nj b gy nu nr l ns nt">junit_family=xunit1</span></pre><ul class=""><li id="0084" class="mq mr iq kz b la lt ld lu lg ms lk mt lo mu ls nk mw mx my bi translated">添加了一个命令，在测试时将上面的文件复制为<code class="fe ng nh ni nj b">pytest.ini</code>:<code class="fe ng nh ni nj b">cp -f .circleci/resources/pytest_build_config.ini pytest.ini</code>。</li><li id="06c6" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls nk mw mx my bi translated">添加了<code class="fe ng nh ni nj b">shopt -s globstar</code>命令，使<a class="ae mo" href="https://support.circleci.com/hc/en-us/articles/360007178074-Why-isn-t-my-glob-pattern-recursing-all-folders-" rel="noopener ugc nofollow" target="_blank">能够从子文件夹</a>中获取所有测试路径。</li><li id="8544" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls nk mw mx my bi translated">将我的测试文件保存在一个文件夹中，将<code class="fe ng nh ni nj b">-junitxml=test-results/junit.xml</code>选项添加到<code class="fe ng nh ni nj b">pytest</code>命令中。</li></ul><p id="d15e" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">所以我的最终配置文件看起来像这样:</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="15f4" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">在做了所有这些改变之后，我终于让并行化为我的Python测试工作了。</p><h1 id="b9aa" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">结论</h1><p id="c536" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">CircleCI提供了一种简单而强大的方法来将测试分散到几台机器上。然而，写一个配置文件并不总是那么简单。上面的例子包含一个工作配置文件，供您开始并行化Python测试套件。</p><p id="616f" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">在这个高度竞争的时代，测试并行化减少了工程师和开发人员等待的时间，加快了新特性的发布，从而提供了竞争优势。</p><p id="ede3" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">不要让考试拖了你的后腿！</p><p id="57b9" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">感谢阅读。</p></div></div>    
</body>
</html>