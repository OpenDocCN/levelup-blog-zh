<html>
<head>
<title>Untangling nested subselect SQL queries into CTEs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将嵌套的子选择SQL查询分解到cte中</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/untangling-nested-subselect-sql-queries-into-ctes-ce89f51ba156?source=collection_archive---------2-----------------------#2022-08-08">https://levelup.gitconnected.com/untangling-nested-subselect-sql-queries-into-ctes-ce89f51ba156?source=collection_archive---------2-----------------------#2022-08-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a526" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本指南中，我将遍历一个包含几层嵌套子选择的查询，并了解如何将查询重构为更易读的cte。</p><p id="d7fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据最近的经验，我将使用一个我比较熟悉的行业的业务问题:流媒体音乐分析。</p><h1 id="616b" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">业务需求</h1><p id="3856" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我们想知道哪些听众，如果有的话，有资格参加某些活跃艺术家的促销活动。有几个要求是合格的。</p><p id="b913" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.一个听众必须在最后一天播放一个被提升的艺术家的歌曲超过100次。</p><p id="162f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.这位艺术家是一次积极推广活动的一部分。</p><p id="16d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.听众已经成为付费阶层的一部分至少一年了。</p><p id="6896" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.该监听程序尚未针对活动促销进行促销。</p><h1 id="ae38" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">数据模型</h1><p id="f373" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">这里有一个非常简单的关系实体关系图(ERD ),展示了数据是如何存储在RDBMS中的。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/6d245af6abea9b9b00ac2ab8d99e24b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_dlTY07bCgEL4QN60_XjDA.png"/></div></div></figure><p id="faff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以展平的形式写出来，可能是这样的:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ma"><img src="../Images/e0a58b1df310ee3adce77954e06ea758.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mRSO3ZBXe7vxv93xR_mHDQ.png"/></div></div></figure><p id="0342" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> daily_spins </strong>:听众一天内播放某首歌曲的次数。听众和歌曲的外键。</p><p id="1a5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">监听器</strong>:监听器信息和元数据。帐户的外键。</p><p id="ebc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">账户</strong>:账户信息，包括最后更新日期。使用account_type的外键进行规范化。</p><p id="7f1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> account_type </strong>:存储不同客户层级的维度表。付费与免费增值。</p><p id="7ddd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">歌曲</strong>:包含曲目名称的歌曲信息。艺术家的外键。</p><p id="0261" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">艺术家</strong>:艺术家信息。</p><p id="e70e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">促销</strong>:主动促销信息。艺术家的外键。</p><p id="3088" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> promoted_listeners </strong>:多对多连接表，将听众链接到艺术家促销。用于跟踪已收到促销的侦听器的状态。</p><p id="3d8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们看看执行这一分析的现有查询。</p><h1 id="31da" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">子选择查询版本:</h1><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mb"><img src="../Images/0cba7f731c6169c69b42390a4810bbff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*otM6RvXEgHVw8IoSBHACDA.png"/></div></div></figure><p id="b203" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">呀！</p><p id="eae1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个查询可能会完成这项工作，但是很难阅读和维护。如果除了作者之外的任何人需要做出改变，这可能是非常具有挑战性的。即使是原作者也可能在以后很难记得它是如何工作的。</p><p id="03a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们考虑一下如何将这个查询重构为CTEs，使它产生相同的输出，但更容易理解。</p><h1 id="67bb" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">第一步:了解需求。</h1><p id="7a97" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在我们开始重构之前，让我们确保我们已经掌握了查询的目标。</p><p id="7314" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们正在寻找有资格获得他们尚未收到的积极促销的听众。听众必须在给定的一天内对所有艺术家的歌曲播放超过100次(又名旋转),并且已经成为付费客户层的一部分至少一年。</p><p id="ee3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以这意味着:</p><ol class=""><li id="dc47" class="mc md iq jp b jq jr ju jv jy me kc mf kg mg kk mh mi mj mk bi translated">如果一个听众在一天之内没有超过100次组合旋转属于一个艺术家的歌曲-&gt;过滤掉。</li><li id="5360" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">如果听众旋转不属于被提升的艺术家-&gt;过滤掉。</li><li id="ee31" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">如果一个听众至少有一年不属于付费阶层-&gt;过滤掉。</li><li id="900b" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">如果听众符合上述要求1 -3，但只符合他们已经收到的促销-&gt;过滤掉。</li></ol><p id="feac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们想要真正理解需求的原因是，在重构过程中，我们很可能会重新输入相当多的查询。<strong class="jp ir">最好是从头重写查询的主要部分，而不是剪切并粘贴子选择片段到CTE链中</strong>。试图直接对cte进行查询操作通常不太顺利。此外，重新键入让我们有机会注意到潜在的优化，我们马上就会看到这一点。</p><h1 id="b1ee" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤2:使用现有的查询获取输出基线</h1><p id="8d39" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在我们可以重构之前，我们必须首先在一组测试输入上运行查询，并将结果存储在某个临时表中。</p><p id="0c42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在任何变化发生之前，我们需要知道结果是什么。这是一种常见的QA技术。</p><p id="b22f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以稍后使用临时表来比较重构后的查询输出。</p><h1 id="6775" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤3:重构为CTEs</h1><p id="b58b" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">首先让我们试着梳理一下不同的子选择区域在做什么。</p><h1 id="f665" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">CTE 1 -&gt;听者艺术家组合旋转</h1><p id="1d53" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">首先，我们将下面的<code class="fe mq mr ms mt b">inner1</code>部分视为查询工作负载的入口点。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/bded5d128a2422f3b7b1cf03920479c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*rYvcvaZbB4_oafBxm0GZ0Q.png"/></div></figure><p id="2db7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从分组和HAVING过滤器可以清楚地看出，这部分试图对由<code class="fe mq mr ms mt b">(listener_id, artist_id)</code>播放的歌曲进行sum()并只保留sum &gt;为100的组。这可能是我们的第一个CTE <code class="fe mq mr ms mt b">listener_artist_spins</code>。</p><p id="9596" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">顶级查询将快速过滤掉听众旋转计数，这些计数没有足够的旋转数用于任何在活动促销中出现的艺术家。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mv"><img src="../Images/26a1df4a5d5593761f310e07dc15b82e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eSg5eOoxxXFx2bGyi-sx9A.png"/></div></div></figure><p id="4b7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该查询按听众和艺术家对spin记录进行分组，以获得给定听众的每个艺术家的所有spin的总和。然后，它使用必须只保留至少有100个组合旋转的组。您会注意到它还使用了一个子选择来获取活跃促销中的艺术家id。</p><p id="481b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是等等，我认为这个练习的全部目的是将查询分支到更容易解析的cte中？是的，这是真的，但有时子选择非常有用，仍然可读。在这种情况下，我们可以通过内部加入积极推广的艺术家来过滤掉大量的自旋数据。我们必须使用DISTINCT，因为给定的<code class="fe mq mr ms mt b">artist_id</code>可能会出现在多个提升中，我们不想过度扩展内部连接。</p><p id="0623" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以设置逻辑，只获取艺术家的推广作为顶级CTE，然后进行旋转级别过滤，但这不会给我们带来太多，除了稍微长一点的CTE查询。</p><p id="1bec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是对嵌套子选择查询版本的优化，该版本最初收集具有&gt; 100次旋转的每个<code class="fe mq mr ms mt b">(listener_id, artist_id)</code>组，而不管艺术家是否是活动促销的一部分。积极推广的艺术家子集比全部艺术家小几个数量级，因此这确实有助于快速过滤数据。</p><h1 id="2e8c" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">CTE 2 -&gt;听众与推广</h1><p id="e863" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">接下来我们看到这个片段，它采用<code class="fe mq mr ms mt b">inner1</code>并加入<code class="fe mq mr ms mt b">artist_id</code>的促销活动，形成<code class="fe mq mr ms mt b">inner2</code>。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/59006c1be4d099d3a60c5a82b807a3f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*MHEIG2V9S_Fe6eaxf-xSAA.png"/></div></figure><p id="a1fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一部分只保存被提升的艺术家的旋转计数，并将<code class="fe mq mr ms mt b">promotion_id</code>传递给查询的其余部分。</p><p id="ec31" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以把这个移到下一个CTE: <code class="fe mq mr ms mt b">listeners_with_promotion</code>。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mx"><img src="../Images/365b95fbde30d6597ea02d164c2abcf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IBVaIADffnth7wozUUPOag.png"/></div></div></figure><p id="0e34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个CTE只不过是内部重新加入晋升，用<code class="fe mq mr ms mt b">(listener_id, artist_id)</code>换成<code class="fe mq mr ms mt b">(listener_id, promotion_id)</code>。</p><h1 id="0c70" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">CTE 3 -&gt;以前没有晋级</h1><p id="061c" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我们要确保在考虑给定的<code class="fe mq mr ms mt b">promotion_id</code>时<code class="fe mq mr ms mt b">listener_id</code>还没有被提升。</p><p id="51f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在子选择版本中，该要求由<code class="fe mq mr ms mt b">inner3</code>满足</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi my"><img src="../Images/f0b7ff0b475f161e9c07235e30b5f4ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cH6Ah5gxIrMUbOJPog9ewA.png"/></div></div></figure><p id="0810" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以现在我们有了下一个CTE: <code class="fe mq mr ms mt b">not_previously_promoted</code></p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mz"><img src="../Images/cb57d890485b462c18a832182ce1a142.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SskxZGArtx6rMH5hy37cUg.png"/></div></div></figure><p id="f14f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，我们离开了JOIN，只接受那些没有考虑给定侦听器的<code class="fe mq mr ms mt b">promotion_id</code>。检查promoted_listeners中的null <code class="fe mq mr ms mt b">promotion_id</code>意味着左连接没有找到任何匹配，这表明用户还没有收到升级。</p><h1 id="34c6" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">CTE 4 -&gt;付费听众合格</h1><p id="e485" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">现在，我们需要考虑给定的侦听器是否符合客户身份。</p><p id="8ed1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在子选择版本中，我们可以在查询的外部看到这个逻辑</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi na"><img src="../Images/0cfeb66739baaacfeae98d7b45661652.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*z8-iEiz8lsoRZSewgm42Kw.png"/></div></figure><p id="8248" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以现在我们有了下一个CTE: <code class="fe mq mr ms mt b">listeners_eligable_for_promotion</code></p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nb"><img src="../Images/da52b91bc6ae009cb4dd2d39d05450f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lssrh04SOLufZAhgf7ODOw.png"/></div></div></figure><p id="9cda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，我们基于<code class="fe mq mr ms mt b">listener_id</code>对帐户信息做一些简单的内部连接，然后确定侦听器的帐户类型是否是<code class="fe mq mr ms mt b">paid</code>，以及定义该类型的最近更新是否在去年(基于本文撰写的时间)。在这个查询的一个稍微现实一点的版本中，我们需要一个更加明确的日期标记，而不仅仅是记录最后更新的时间，但是这可以用于演示目的。</p><p id="98f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在剩下的就是选择通过所有过滤器的剩余监听器id和促销id！</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/3132181f6e19efeab028b86d0ed11036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*hmKaTeAKjxsw1163cFYM3Q.png"/></div></figure><p id="6e2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是该查询的完整CTE版本:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nd"><img src="../Images/eb3c2b203a97a07616cfb908b0b9cc57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C0jjF0UdRcCaAxA8tdiJ8Q.png"/></div></div></figure><h1 id="90d6" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤4:比较查询输出和基线临时表的准确性。</h1><p id="a0d3" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我们可以使用EXCEPT将基线输出与任何新输出进行比较</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/73e329c3d1a977c27cb0fec39888b5e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*PKJRU1bZiH_MTh57n9El1Q.png"/></div></figure><p id="d63a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个查询有效地进行了两个不同的集合比较来回答问题。</p><ol class=""><li id="9fae" class="mc md iq jp b jq jr ju jv jy me kc mf kg mg kk mh mi mj mk bi translated">在子选择查询中找到了CTE查询中没有的记录吗？</li><li id="60bc" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">在CTE查询中是否找到了子选择查询中没有的记录？</li></ol><p id="a3ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SQL EXCEPT操作符将保留左边所有不在右边的记录。</p><p id="7e29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将它们结合在一起，只是为了得到任何差异的组合计数。</p><p id="1f01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望我们能看到差值计数等于零。这意味着基本输入集和新输出是完全相同的。</p><h1 id="9a60" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">结论</h1><p id="40d5" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我们可以遵循这个通用蓝图，将任何复杂的子选择查询重构为CTE。</p><ol class=""><li id="0a1d" class="mc md iq jp b jq jr ju jv jy me kc mf kg mg kk mh mi mj mk bi translated">仔细理解查询的要求。</li><li id="72fe" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">通过对受控测试数据运行查询，在临时表中获得基线输出。</li><li id="d051" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">将不同的子选择级别逐步分解成cte，通常从子选择查询的内部开始，然后向外移动。尽量避免复制粘贴。把它作为考虑任何优化的机会。</li><li id="57f1" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">针对相同的受控测试数据运行新版本。将输出存储到自己的临时表中。</li><li id="16b1" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">比较新旧临时表，查看是否有任何差异。如果发现了差异，这意味着CTE查询有一点问题(或者您可能发现了原始查询的一个bug)。)</li></ol></div></div>    
</body>
</html>