<html>
<head>
<title>The gRPC Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">gRPC网关</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/grpc-part-4-the-grpc-gateway-b68bc065a8ec?source=collection_archive---------4-----------------------#2021-12-10">https://levelup.gitconnected.com/grpc-part-4-the-grpc-gateway-b68bc065a8ec?source=collection_archive---------4-----------------------#2021-12-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div class="gh gi ir"><img src="../Images/d0b2fda286ab598148967bc30a561a7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*TQG7aqsJF8XwaK11WaptLQ.jpeg"/></div><figcaption class="iy iz gj gh gi ja jb bd b be z dk translated">图片由Renee French提供</figcaption></figure><h2 id="7be0" class="jc jd je bd b dl jf jg jh ji jj jk dk jl translated" aria-label="kicker paragraph">GRPC:第四部分</h2><div class=""/><div class=""><h2 id="9afb" class="pw-subtitle-paragraph kk jn je bd b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dk translated">让我们怀旧一下，把HTTP 1.x带回未来。</h2></div><p id="ae8b" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">本系列的这一部分依赖于第3部分。如果您还没有这样做，请在继续之前阅读第3部分。</p><div class="is it gp gr iu ly"><a rel="noopener  ugc nofollow" target="_blank" href="/grpc-part-3-implementing-a-grpc-service-definition-cac5404c5c1b"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd jo gy z fp md fr fs me fu fw jn bi translated">实施gRPC服务定义</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">gRPC构建生命周期有一个陡峭的学习曲线，但是您会看到我们可以自动完成这个过程。</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm iw ly"/></div></div></a></div></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="2a49" class="mu mv je bd mw mx my mz na nb nc nd ne kt nf ku ng kw nh kx ni kz nj la nk nl bi translated">什么是gRPC网关</h1><p id="2269" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">gRPC网关是<code class="fe nr ns nt nu b">protoc</code>的一个插件，它创建一个HTTP代码转换服务器，将<strong class="le jo"> HTTP转换成gRPC </strong>。gRPC网关<a class="ae nv" href="https://github.com/grpc-ecosystem/grpc-gateway" rel="noopener ugc nofollow" target="_blank">项目</a>仅适用于Golang。除了代码转换，gRPC网关插件还可以为您的gRPC服务定义生成Swagger文档。</p><p id="9200" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">gRPC网关服务器将允许客户端通过HTTP连接到您的gRPC服务。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="e8c2" class="mu mv je bd mw mx my mz na nb nc nd ne kt nf ku ng kw nh kx ni kz nj la nk nl bi translated">安装gRPC网关</h1><p id="aae4" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">为了开始使用<strong class="le jo"> grpc-gateway </strong>，我们需要在<code class="fe nr ns nt nu b">proto</code>项目中做一些工作。</p><h2 id="ce71" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">1.用新文件<code class="fe nr ns nt nu b">tools.go</code>创建一个名为<code class="fe nr ns nt nu b">tools</code>的新目录。</h2><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="963f" class="nw mv je nu b gy op oq l or os">$ mkdir $GOPATH/src/proto/tools</span></pre><figure class="oh oi oj ok gt iv"><div class="bz fp l di"><div class="ot ou l"/></div></figure><h2 id="e324" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">2.向<code class="fe nr ns nt nu b">tools.go</code>添加内容</h2><p id="4886" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">如果我们能够正确地管理我们的依赖关系，安装gRPC网关是最容易的。为此，将以下内容添加到<code class="fe nr ns nt nu b">tools.go</code>。</p><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="a691" class="nw mv je nu b gy op oq l or os">$ touch $GOPATH/src/proto/tools/tools.go</span></pre><figure class="oh oi oj ok gt iv"><div class="bz fp l di"><div class="ot ou l"/></div></figure><h2 id="0670" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">3.安装gRPC网关插件</h2><p id="9f52" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">首先，整理依赖关系</p><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="3da3" class="nw mv je nu b gy op oq l or os">$ go mod tidy</span></pre><p id="fc88" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">然后，从<code class="fe nr ns nt nu b">proto</code>目录安装依赖项。</p><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="d753" class="nw mv je nu b gy op oq l or os">$ go install \<br/>    github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway \<br/>    github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2 \<br/>    google.golang.org/protobuf/cmd/protoc-gen-go \<br/>    google.golang.org/grpc/cmd/protoc-gen-go-grpc</span></pre><h2 id="e0da" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">配置gRPC网关选项</h2><p id="34e2" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">服务定义可以用gRPC网关注释进行注释。这将指导gRPC网关插件如何创建网关服务器HTTP端点。</p><h2 id="38ad" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">1.添加googleapis原型文件</h2><p id="6c3d" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">gRPC Gateway需要托管在googleapis存储库中的一些原型文件。不幸的是，我们必须手动将这些原型文件添加到我们的项目中。</p><p id="3032" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">添加目录<code class="fe nr ns nt nu b">third_party/google/api</code>和以下文件</p><ul class=""><li id="aa47" class="ov ow je le b lf lg li lj ll ox lp oy lt oz lx pa pb pc pd bi translated"><a class="ae nv" href="https://gist.github.com/hyperstripe50/3b7e6722790d7af6dcde50cc2b6644fe" rel="noopener ugc nofollow" target="_blank"> http.proto </a></li><li id="edd2" class="ov ow je le b lf pe li pf ll pg lp ph lt pi lx pa pb pc pd bi translated"><a class="ae nv" href="https://gist.github.com/hyperstripe50/c7bb051c0bcc6266ae130d2c5a107ad4" rel="noopener ugc nofollow" target="_blank"> annotations.proto </a></li></ul><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="3955" class="nw mv je nu b gy op oq l or os">$ mkdir -p $GOPATH/src/proto/third_party/google/api<br/>$ touch $GOPATH/src/proto/third_party/google/api/http.proto<br/>$ touch $GOPATH/src/proto/third_party/google/api/annotations.proto</span></pre><p id="2931" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">您的<code class="fe nr ns nt nu b">proto</code>目录现在应该看起来像这样</p><figure class="oh oi oj ok gt iv"><div class="bz fp l di"><div class="ot ou l"/></div></figure><h2 id="b22c" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">5.添加一个<code class="fe nr ns nt nu b">google.api.http</code>注释</h2><p id="32eb" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">将<code class="fe nr ns nt nu b">salt_hash.proto</code>的内容更改如下。通过这样做，您添加了自定义的<strong class="le jo"> google.api.http </strong>注释，该注释将把http代码转换成gRPC。</p><figure class="oh oi oj ok gt iv"><div class="bz fp l di"><div class="ot ou l"/></div></figure><ul class=""><li id="b6e3" class="ov ow je le b lf lg li lj ll ox lp oy lt oz lx pa pb pc pd bi translated">(1)添加自定义<strong class="le jo"> google.api.http </strong> HTTP到gRPC转码细节。</li><li id="212a" class="ov ow je le b lf pe li pf ll pg lp ph lt pi lx pa pb pc pd bi translated">(2)声明该gRPC方法代码转换为HTTP POST方法和路径<strong class="le jo"> /v1/credentials </strong>。</li><li id="082c" class="ov ow je le b lf pe li pf ll pg lp ph lt pi lx pa pb pc pd bi translated">(3)声明HTTP请求的主体模式。</li><li id="399e" class="ov ow je le b lf pe li pf ll pg lp ph lt pi lx pa pb pc pd bi translated">(4)具有内插的<code class="fe nr ns nt nu b">{value}</code>参数的删除方法。</li></ul><p id="bc59" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">添加注释后，您可以使用gRPC网关插件生成HTTP网关代码。</p><h2 id="3645" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">6.调整Makefile以使用gRPC网关插件</h2><p id="d73b" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">我们需要对Makefile进行两处修改。首先，我们将编译<strong class="le jo"> annotations.proto和http.proto </strong>文件。其次，我们将使用gRPC网关插件和<strong class="le jo">协议</strong>为我们的<strong class="le jo"> salt_hash </strong>服务定义创建HTTP代码转换的服务器代码。</p><figure class="oh oi oj ok gt iv"><div class="bz fp l di"><div class="ot ou l"/></div></figure><h2 id="7555" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">7.构建gRPC网关</h2><p id="b8c4" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">使用Makefile生成gRPC网关代码转换服务器代码。</p><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="4963" class="nw mv je nu b gy op oq l or os">$ make compile</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="fa7e" class="mu mv je bd mw mx my mz na nb nc nd ne kt nf ku ng kw nh kx ni kz nj la nk nl bi translated">在salt-hash-svc项目中公开gRPC网关</h1><p id="c5d4" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">从在<code class="fe nr ns nt nu b">proto</code>目录下工作切换到在<code class="fe nr ns nt nu b">salt-hash-svc</code>目录下工作。如果我们使用Go模块，管理我们的依赖项和版本是最容易的，所以我们接下来将从<code class="fe nr ns nt nu b">salt-hash-svc</code>项目中创建一个Go模块。</p><h2 id="a51e" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">1.从<code class="fe nr ns nt nu b">salt-hash-svc</code>目录，初始化模块</h2><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="5ae1" class="nw mv je nu b gy op oq l or os">$ go mod init salt-hash-svc</span></pre><h2 id="53c2" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">2.在<code class="fe nr ns nt nu b">go.mod</code>文件中配置一个<code class="fe nr ns nt nu b">replacement</code>。</h2><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="f35a" class="nw mv je nu b gy op oq l or os">replace proto =&gt; ../proto</span></pre><h2 id="126d" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">3.整理依赖版本</h2><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="22ad" class="nw mv je nu b gy op oq l or os">$ go mod tidy</span></pre><p id="c9b5" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo"> 4。安装grpc-gateway运行时</strong></p><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="dc06" class="nw mv je nu b gy op oq l or os">$ go get github.com/grpc-ecosystem/grpc-gateway/v2/runtime@v2.7.1</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="62a7" class="mu mv je bd mw mx my mz na nb nc nd ne kt nf ku ng kw nh kx ni kz nj la nk nl bi translated">引导并运行gRPC网关服务器</h1><p id="5cb2" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">gRPC网关插件在我们的<code class="fe nr ns nt nu b">proto</code>项目中为我们生成了服务器代码。文件<code class="fe nr ns nt nu b">salt_hash.pb.gw.go</code>已创建。</p><h2 id="28e5" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">1.创建网关入口点</h2><p id="3611" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">从<code class="fe nr ns nt nu b">salt-hash-svc</code>项目中，通过添加<code class="fe nr ns nt nu b">gw/main.go</code>文件创建以下目录结构。</p><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="0408" class="nw mv je nu b gy op oq l or os">$ mkdir $GOPATH/src/salt-hash-svc/datastore/gw<br/>$ touch $GOPATH/src/salt-hash-svc/datastore/gw/main.go</span></pre><figure class="oh oi oj ok gt iv"><div class="bz fp l di"><div class="ot ou l"/></div></figure><h2 id="11ce" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">2.向<code class="fe nr ns nt nu b">gw/main.go</code>文件添加代码以创建网关入口点。</h2><figure class="oh oi oj ok gt iv"><div class="bz fp l di"><div class="ot ou l"/></div></figure><h2 id="ad6d" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">3.在Makefile中包含gRPC网关步骤</h2><p id="3ec8" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">将gRPC网关构建和运行命令添加到makefile中</p><figure class="oh oi oj ok gt iv"><div class="bz fp l di"><div class="ot ou l"/></div></figure><ul class=""><li id="33ec" class="ov ow je le b lf lg li lj ll ox lp oy lt oz lx pa pb pc pd bi translated">(1)构建gRPC网关服务器。</li><li id="ef36" class="ov ow je le b lf pe li pf ll pg lp ph lt pi lx pa pb pc pd bi translated">(2)创建一个命令来运行我们的网关服务器和gRPC服务器。</li><li id="7b99" class="ov ow je le b lf pe li pf ll pg lp ph lt pi lx pa pb pc pd bi translated">(3)运行网关服务器的逻辑。</li></ul><h2 id="8d2a" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">3.构建并运行网关示例</h2><p id="f97a" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">使用Makefile来引导gRPC服务器和网关服务器。网关服务器必须通过URL进行配置，以便与gRPC服务器连接。</p><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="7149" class="nw mv je nu b gy op oq l or os">$ make<br/>$ make credentials_gw_ex</span></pre><p id="5cb8" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">这将启动<code class="fe nr ns nt nu b">localhost:8081</code>上的HTTP网关。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="d761" class="mu mv je bd mw mx my mz na nb nc nd ne kt nf ku ng kw nh kx ni kz nj la nk nl bi translated">与gRPC网关服务器交互</h1><p id="16bd" class="pw-post-body-paragraph lc ld je le b lf nm ko lh li nn kr lk ll no ln lo lp np lr ls lt nq lv lw lx im bi translated">gRPC网关服务器已被配置为HTTP 1.x反向代理，它将传入的消息代码转换为gRPC，并将它们转发到我们的gRPC服务器。来自gRPC服务器的响应被从gRPC转换成HTTP 1.x。让我们通过HTTP 1.x网关服务器与gRPC服务器进行交互，来看看这在实践中是如何工作的。</p><h2 id="1c8d" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">1.创建用户</h2><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="ebe2" class="nw mv je nu b gy op oq l or os">$ curl -X POST <a class="ae nv" href="http://localhost:8081/v1/credentials" rel="noopener ugc nofollow" target="_blank">http://localhost:8081/v1/credentials</a> -d '{ "username": "new-user", "password": "password"}'</span></pre><h2 id="7660" class="nw mv je bd mw nx ny dn na nz oa dp ne ll ob oc ng lp od oe ni lt of og nk jk bi translated">2.删除用户</h2><pre class="oh oi oj ok gt ol nu om on aw oo bi"><span id="4fde" class="nw mv je nu b gy op oq l or os">$ curl -X DELETE <a class="ae nv" href="http://localhost:8081/v1/credentials" rel="noopener ugc nofollow" target="_blank">http://localhost:8081/v1/credentials</a>/new-user</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="d829" class="mu mv je bd mw mx my mz na nb nc nd ne kt nf ku ng kw nh kx ni kz nj la nk nl bi translated">摘要</h1><ul class=""><li id="b39d" class="ov ow je le b lf nm li nn ll pj lp pk lt pl lx pa pb pc pd bi translated">到目前为止，对于一个人来说，以文本消息的形式与HTTP 1.x服务交互肯定比gRPC更方便。幸运的是，gRPC网关可以自动为我们生成一个代码转换器服务器，它所需要的只是一些注释。</li><li id="2413" class="ov ow je le b lf pe li pf ll pg lp ph lt pi lx pa pb pc pd bi translated">gRPC网关充当反向代理，必须作为独立于gRPC服务器的进程运行。gRPC网关通过指定gRPC端点坐标将请求转发到gRPC服务器。</li></ul></div></div>    
</body>
</html>