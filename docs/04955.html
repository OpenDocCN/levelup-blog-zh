<html>
<head>
<title>Finding seasonality in sales data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在销售数据中寻找季节性</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/finding-seasonality-in-sales-data-9e959d17c01d?source=collection_archive---------8-----------------------#2020-07-26">https://levelup.gitconnected.com/finding-seasonality-in-sales-data-9e959d17c01d?source=collection_archive---------8-----------------------#2020-07-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0652" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">SQL与宇宙的中间话题</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ed9dd55494d7eec8a6419777c6d6d078.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t8XnpUguSDaVHcdVdczNOA.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:美国宇航局</figcaption></figure><p id="d20e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">“火星就在那里，等着被到达。”—巴兹·奥尔德林</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="23ce" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">上次在<a class="ae lz" rel="noopener ugc nofollow" target="_blank" href="/lag-functionality-on-sql-data-d58027631d8a?source=friends_link&amp;sk=808cf4b0d6867262c63ba03e5e9eaefb">SQL数据的滞后功能</a>中，我们想象去火星旅行，参观(众多山脉中的一座)奥林匹斯山<a class="ae lz" href="https://en.wikipedia.org/wiki/Olympus_Mons" rel="noopener ugc nofollow" target="_blank">的山基</a>，那里有一个食品摊在卖宇航员的冰淇淋。在帖子中的例子中，我用虚拟数据展示了带有<code class="fe ma mb mc md b">sales</code> SQL数据表的<code class="fe ma mb mc md b">LAG</code>窗口函数。</p><p id="beb3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这篇文章将使用<code class="fe ma mb mc md b">LAG</code>和<code class="fe ma mb mc md b">LEAD</code>窗口函数来解决我在<a class="ae lz" href="https://leetcode.com/" rel="noopener ugc nofollow" target="_blank"> LeetCode </a>上遇到的一个算法问题。我将引入<code class="fe ma mb mc md b">LEAD</code>功能，并解决这个问题:显示<code class="fe ma mb mc md b">sales</code>表中三个或更多连续销售值等于或大于给定数字的记录。让我们开始吧。</p><h1 id="cc29" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">更新数据</h1><p id="c425" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated">回想一下我们上次用的数据有五条<code class="fe ma mb mc md b">net_sales</code>的记录；食品摊开放的一个月内的净销售额。这张名为<code class="fe ma mb mc md b">sales</code>的桌子看起来像这样:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/a3ce42b622a046db875cf8f6a78c9afa.png" data-original-src="https://miro.medium.com/v2/resize:fit:434/format:webp/1*bZ6n5C4ul-p9SssTcBqj6A.png"/></div></figure><p id="d2fa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">出于这个博客的目的，我将添加更多的数据——具体来说，十多条记录。这代表了食品摊的<code class="fe ma mb mc md b">net_sales</code>被记录的另外十个月。为此，我使用了<code class="fe ma mb mc md b">INSERT</code>:</p><pre class="kg kh ki kj gt nc md nd ne aw nf bi"><span id="575b" class="ng mf iq md b gy nh ni l nj nk">INSERT INTO sales<br/>VALUES (6, 9343),<br/>  (7, 9123),<br/>  (8, 8770),<br/>  (9, 6780),<br/>  (10, 4002),<br/>  (11, 4999),<br/>  (12, 5673),<br/>  (13, 6002),<br/>  (14, 7109),<br/>  (15, 7994);</span></pre><p id="501f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">快速查看该表(带有<code class="fe ma mb mc md b">SELECT</code>)显示了15条记录，每条记录代表一个月，值为<code class="fe ma mb mc md b">net_sales</code>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/b90e29da5b144b6217d64fe4c0b33ffb.png" data-original-src="https://miro.medium.com/v2/resize:fit:428/format:webp/1*Yfqxqn6z5mst-EozTCWsUw.png"/></div></figure><p id="69e2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">完美。现在我们有更多的记录要查询。</p><h1 id="2717" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">铅窗函数</h1><p id="6dd1" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated"><code class="fe ma mb mc md b">LEAD</code>窗口功能类似于<code class="fe ma mb mc md b">LAG</code>功能。回想一下，使用<code class="fe ma mb mc md b">LAG</code>功能，我们可以访问当前行 之前<strong class="kx ir"> <em class="lr">处的特定偏移量的行。让我们回顾一个例子:</em></strong></p><blockquote class="nm nn no"><p id="0d32" class="kv kw lr kx b ky kz jr la lb lc ju ld np lf lg lh nq lj lk ll nr ln lo lp lq ij bi translated">假设我想查看上个月的净销售额，同时查看当前月份。如果当前行是第4个<code class="fe ma mb mc md b">month</code>并且<code class="fe ma mb mc md b">net_sales</code>值是7319，那么使用偏移量<code class="fe ma mb mc md b">1</code>，我期望在第4行的下一列中看到5618。</p></blockquote><p id="3eda" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">类似地，使用<code class="fe ma mb mc md b">LEAD</code>窗口函数，我们可以在当前行的 之后的<strong class="kx ir"> <em class="lr">处访问一行。与前面的示例类似:</em></strong></p><blockquote class="nm nn no"><p id="37b0" class="kv kw lr kx b ky kz jr la lb lc ju ld np lf lg lh nq lj lk ll nr ln lo lp lq ij bi translated">假设我想查看下个月的净销售额，同时查看当前月份。如果当前行是第4个<code class="fe ma mb mc md b"><em class="iq">month</em></code>并且<code class="fe ma mb mc md b"><em class="iq">net_sales</em></code>值是7319，那么使用<code class="fe ma mb mc md b"><em class="iq">1</em></code>的偏移量，我期望在第4行的下一列中看到9282。</p></blockquote><p id="b914" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">将此应用于<code class="fe ma mb mc md b">sales</code>的前五行:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/d4bee4d09e7173983db7d1f9e0c1829d.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/format:webp/1*AUrZtAFXcwOOLa2RUg5syw.png"/></div></figure><h1 id="b894" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">问题是</h1><p id="1017" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated">现在，我们配备了一些方便的技巧来解决这样一个问题，即小吃摊的老板想要了解一些关于她销售的季节性的信息。具体来说，她想知道是否有连续三个月或更多个月的销售额等于或大于7500。</p><p id="dd66" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有很多方法可以解决这个问题，但这里有一个使用<code class="fe ma mb mc md b">LAG</code>和<code class="fe ma mb mc md b">LEAD</code>窗口函数的解决方案:</p><pre class="kg kh ki kj gt nc md nd ne aw nf bi"><span id="bdd0" class="ng mf iq md b gy nh ni l nj nk">SELECT<br/>  s.months<br/>  , s.net_sales<br/>FROM<br/> (SELECT months<br/>  , net_sales<br/>  , LAG(net_sales, 2) OVER(ORDER BY months) before_month<br/>  , LAG(net_sales, 1) OVER(ORDER BY months) last_month<br/>  -- current month sales is net_sales<br/>  , LEAD(net_sales, 1) OVER(ORDER BY months) second_month<br/>  , LEAD(net_sales, 2) OVER(ORDER BY months) third_month<br/> FROM sales) s<br/>WHERE (s.net_sales&gt;=7500 AND s.second_month&gt;=7500 AND s.third_month&gt;=7500)<br/>  OR (s.before_month&gt;=7500 AND s.last_month&gt;=7500 AND s.net_sales&gt;=7500)<br/>  OR (s.last_month&gt;=7500 AND s.net_sales&gt;=7500 AND s.second_month&gt;=7500)</span></pre><p id="45f8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">哇——这是一个复杂的查询。让我们来分解一下。</p><p id="8fd0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，请注意子查询:</p><pre class="kg kh ki kj gt nc md nd ne aw nf bi"><span id="2193" class="ng mf iq md b gy nh ni l nj nk">(SELECT months<br/>  , net_sales<br/>  , LAG(net_sales, 2) OVER(ORDER BY months) before_month<br/>  , LAG(net_sales, 1) OVER(ORDER BY months) last_month<br/>  -- current month sales is net_sales<br/>  , LEAD(net_sales, 1) OVER(ORDER BY months) second_month<br/>  , LEAD(net_sales, 2) OVER(ORDER BY months) third_month<br/> FROM sales) s</span></pre><ul class=""><li id="6155" class="nt nu iq kx b ky kz lb lc le nv li nw lm nx lq ny nz oa ob bi translated">在其中，我们创建了一个新的视图，它有由<code class="fe ma mb mc md b">LAG</code>和<code class="fe ma mb mc md b">LEAD</code>定义的新列。</li><li id="e15e" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated">这个临时表的前五行是:</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/846ca255c98a53b0c233073b429686d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z7H3P41ayso31Ne3_mqKQQ.png"/></div></div></figure><p id="db6f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">其次，注意<code class="fe ma mb mc md b">WHERE</code>条款:</p><pre class="kg kh ki kj gt nc md nd ne aw nf bi"><span id="e166" class="ng mf iq md b gy nh ni l nj nk">WHERE (s.net_sales&gt;=7500 AND s.second_month&gt;=7500 AND s.third_month&gt;=7500)<br/>  OR (s.before_month&gt;=7500 AND s.last_month&gt;=7500 AND s.net_sales&gt;=7500)<br/>  OR (s.last_month&gt;=7500 AND s.net_sales&gt;=7500 AND s.second_month&gt;=7500)</span></pre><ul class=""><li id="03fe" class="nt nu iq kx b ky kz lb lc le nv li nw lm nx lq ny nz oa ob bi translated">这表明有三种情况可能会出现“连续三个月”</li><li id="27e6" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated">第一种情况:<code class="fe ma mb mc md b">net_sales</code>的当前记录是第一个月，接着是两个月的高销售额。</li><li id="5b92" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated">第二种情况:<code class="fe ma mb mc md b">net_sales</code>的当前记录是第三个月，在此之前有两个月的高销售额。</li><li id="7b20" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated">第三种也是最后一种情况:<code class="fe ma mb mc md b">net_sales</code>的当前记录是第二个月，在此之前出现了一个月的高销售额，在此之后出现了另一个月的高销售额。</li></ul><p id="29b7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">综上所述，我们正在查询由子查询<code class="fe ma mb mc md b">s</code>创建的表，并寻找三个或更多连续的行，其中有三个值大于7500。</p><p id="535e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/e97f80b0413877c1cc79226a118ff089.png" data-original-src="https://miro.medium.com/v2/resize:fit:422/format:webp/1*u1NjipEHAKaKJwBowpS2SQ.png"/></div></figure><p id="8560" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，从第5个月到第8个月(包括第5个月和第8个月)似乎是销售高峰期。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="13e6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">各位，这些假数据到此为止！SQL工具箱的又一个新成员。</p><p id="e475" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">作为参考，我有一系列SQL教程，涵盖了基本查询和中间查询。看一看！</p><ul class=""><li id="063d" class="nt nu iq kx b ky kz lb lc le nv li nw lm nx lq ny nz oa ob bi translated"><a class="ae lz" rel="noopener ugc nofollow" target="_blank" href="/black-holes-planets-and-sql-5667e74b272a?source=friends_link&amp;sk=82cfce28709cee06c56254ede9cfc2bb">黑洞、行星和SQL </a></li><li id="5196" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><a class="ae lz" href="https://medium.com/swlh/touring-the-solar-system-with-sql-b2a9d167b829?source=friends_link&amp;sk=b77b267ffa08a803232c06afd85816b8" rel="noopener">用SQL漫游太阳系</a></li><li id="9859" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><a class="ae lz" href="https://medium.com/swlh/searching-for-moons-with-sql-4d803738347c?source=friends_link&amp;sk=8e9af00e337fc5551e3ffe28cd7a2a46" rel="noopener">用SQL搜索卫星</a></li><li id="fe15" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><a class="ae lz" href="https://medium.com/swlh/classifying-black-holes-with-sql-88bd07b54e64?source=friends_link&amp;sk=5b4594dcf3d82881f1d316a90d118f3e" rel="noopener">用SQL对黑洞进行分类</a></li><li id="307d" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><a class="ae lz" href="https://medium.com/@kwarmbein/joining-constellations-with-sql-af40f1255562?source=friends_link&amp;sk=0c5a75976efa60006cb3b2889120e1f2" rel="noopener">用SQL连接星座图</a></li><li id="7727" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><a class="ae lz" href="https://medium.com/swlh/solar-system-classifications-with-sql-f1a3a5e4730a?source=friends_link&amp;sk=6a9eafa2c412523f5243f708a4f8e279" rel="noopener">用SQL进行太阳系分类</a></li><li id="6629" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><a class="ae lz" href="https://medium.com/swlh/many-to-many-relations-among-the-stars-1728ba18a2d0?source=friends_link&amp;sk=520341a6b29b886a2f71e13925559bf5" rel="noopener">星星之间的多(对多)关系</a></li><li id="d864" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><a class="ae lz" href="https://medium.com/swlh/creating-tables-in-sql-a3c5995da5f7?source=friends_link&amp;sk=46f6eed6a011ef5c1959bb7e1d7c48bb" rel="noopener">在SQL中创建表格</a></li><li id="30bf" class="nt nu iq kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><a class="ae lz" href="https://medium.com/swlh/a-window-to-the-solar-system-d4e882031964?source=friends_link&amp;sk=f421d2e0c4758d29efb1a13a53b0799d" rel="noopener">通往太阳系的窗口</a></li></ul><p id="617b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="lr">喜欢这些SQL帖子？有问题吗？大家在评论里聊聊吧！</em></p></div></div>    
</body>
</html>