<html>
<head>
<title>Emergencies in Distributed Systems</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分布式系统中的紧急情况</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/emergencies-in-distributed-systems-9f93c6d75600?source=collection_archive---------17-----------------------#2021-04-18">https://levelup.gitconnected.com/emergencies-in-distributed-systems-9f93c6d75600?source=collection_archive---------17-----------------------#2021-04-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f8bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">任何分布式系统都可能因为事故或攻击而陷入紧急状态。一个被认为无害的动作，比如脚本的执行，可能会对整个平台造成严重破坏，使最终用户无法使用它。这篇文章展示了软件开发人员如何在紧急情况发生之前为其准备系统。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/9ae7db8ca7605ad5cdd77d59082c34cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Gwoyg01hazCHQDWt"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated"><a class="ae lb" href="https://unsplash.com/@jayrheike?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">杰伊·海克</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="9b83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想写一个免责声明，我不是软件安全专家，只是一个全栈软件开发者，本文提供的所有信息都来自我的编码经验。我想讨论准备和处理紧急情况的主要可能性，但我不打算就正确和不正确的方法提供意见。最后，设计一个安全的分布式系统可能需要熟练的安全工程师的专业知识。</p><h1 id="a026" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">紧急协议</h1><p id="1b72" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">我相信系统设计者可能会考虑准备一个应急协议，至少了解他们如何保护分布式系统免受外部和内部威胁。通过阅读各种OWASP资源，我学到了很多关于web应用程序安全性的知识。</p><p id="48b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我认为应急方案至少应回答以下问题:</p><ul class=""><li id="9508" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated"><em class="mo">谁</em>可以启动应急协议，拥有<em class="mo">哪些</em>权利，</li><li id="51f3" class="mf mg iq jp b jq mp ju mq jy mr kc ms kg mt kk mk ml mm mn bi translated"><em class="mo">在协议执行过程中</em>发生了什么以及<em class="mo">在哪里</em>发生，</li><li id="f94e" class="mf mg iq jp b jq mp ju mq jy mr kc ms kg mt kk mk ml mm mn bi translated"><em class="mo">如何</em>才能启动<em class="mo">持续多长时间</em>。</li></ul><p id="ba72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于本文，我假设系统管理员可以使用CLI在系统上以最高权限启动应急协议。协议的调用无限期地限制了多个后端的某些功能。</p><h1 id="72a8" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">时间表</h1><p id="45b5" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">该协议可能在两种时间框架下工作:</p><ul class=""><li id="e1a8" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated">过去和未来事件-系统将针对特定的过去和所有未来事件改变其行为，</li><li id="94b1" class="mf mg iq jp b jq mp ju mq jy mr kc ms kg mt kk mk ml mm mn bi translated">未来事件—系统将针对所有未来事件改变其行为。</li></ul><p id="f2f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，并不是所有的分布式系统都支持逆向行为改变。在使用长时间运行的事务的系统中，坚持这样的转移需要执行补偿事务，该补偿事务显式地移除原始过去事务的影响。</p><h1 id="9c8a" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">解决方法</h1><p id="5042" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">我将所有可能的解决方案分为三组——在无状态协议(如HTTP)中阻止访问的，在基于消息的系统(如Kafka)中阻止访问的，以及回滚事务的。系统架构师可能会选择应用其中的一些，甚至是并行应用，只要它们在设计的系统中有实际用途。如果你能想到更有用的解决方案，请在评论区留下评论。</p><h2 id="258e" class="mu ld iq bd le mv mw dn li mx my dp lm jy mz na lq kc nb nc lu kg nd ne ly nf bi translated">无状态协议中的阻塞访问</h2><p id="4ef9" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">可以说，通过限制特定用户对资源的访问，阻止特定访问令牌(例如，JWT)是补救紧急情况的最精确方法。如果攻击者已经获得了访问令牌并可能出于恶意动机使用它，则系统可以应用这种阻碍。该解决方案可能会影响一个或多个后端，具体取决于暴露程度。</p><p id="3f76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">系统还可以阻止对特定访问方法的访问(例如，HTTP端点或RPC)。当系统管理员不知道特定攻击者的访问令牌时，或者当终端由于最近的部署而停止正常工作时，他们可能会选择此解决方案。我相信，在选择这种方式来应对问题之前，人们应该考虑锁定整个功能的后果，以及如何将这种选择传达给最终用户。</p><p id="435d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果阻止某些服务中的某些访问方法不起作用，可以考虑关闭该服务。在分布式系统中，这意味着要么禁用将请求转发到相关服务实例的负载平衡器，要么终止所有上述实例。选择任何一个选项都会对系统产生重大影响，因为许多功能将不再工作。</p><p id="84a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，系统管理员可能会决定关闭整个系统(或者至少关闭所有后端)。关闭分布式系统的精确算法很大程度上取决于它的基础设施和使用的冗余。如果有人考虑到这种可能性，他们应该考虑到系统将停止运行的后果，除了一些可能在离线模式下工作的前端功能。</p><h2 id="678a" class="mu ld iq bd le mv mw dn li mx my dp lm jy mz na lq kc nb nc lu kg nd ne ly nf bi translated">在基于消息的系统中阻止访问</h2><p id="2c43" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在基于消息的系统中，系统管理员可能禁止在系统内共享特定的消息。在某些情况下，消息代理可以应用这样的策略，而在其他情况下，这项工作属于后端。读者可以将这些规则想象成谓词函数，它接受一个参数、一条消息并返回一个布尔值。</p><p id="1a53" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，用户可以选择阻止特定主题或频道分发消息。这将间接影响依赖这种通信方式的后端。或者，可以禁止特定服务通过某个主题或通道发送或接收消息。</p><p id="5079" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，有人可能决定阻塞整个消息管道。这种解决方案就像关闭整个系统一样，会对系统内的通信产生巨大影响，可能会禁用许多功能。同样，软件开发人员应该在这种情况发生之前找出哪些功能可能会崩溃。</p><h2 id="1d3d" class="mu ld iq bd le mv mw dn li mx my dp lm jy mz na lq kc nb nc lu kg nd ne ly nf bi translated">回滚事务</h2><p id="0e0e" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">系统可能会在后端将某些事务提交到关系数据库之前回滚它们。应用这样的规则需要在后端架构中添加有效性检查，并确保后端可以及时接收到有关策略更改的信息。这个解决方案是取消已经开始的事务的一个例子。</p><p id="89e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回滚分布式事务的可行性取决于所选择的算法。在使用saga软件模式的系统中，可以开始补偿事务，以抵消原始的、长时间运行的事务的影响。和以前一样，所提出的解决方案可以恢复过去制定的交易。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ng"><img src="../Images/7903aa280b6e13858873a6e5107798d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rUkdlpYXMTeexRUX"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated"><a class="ae lb" href="https://unsplash.com/@marcinjozwiak?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Marcin Jozwiak </a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="4340" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">分发解决方案</h1><p id="a940" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">该系统可以以两种基本方式分配对紧急事件的响应:集中方式和分散方式。集中式选项包括应急指挥器或应急编排。分散式分发需要一种方式将信息传输到各种后端的所有相关实例。</p><h1 id="cbb1" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">集中分发</h1><p id="c268" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">应急指挥者通过以预定义的顺序向特定的后端发出精确的指令来管理危机响应，充当中央权威。这样，一个服务可能包含负责上述响应的全部代码。例如，编排者可以通知特定的后端关于受损的JWT。</p><p id="e41f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在定义后端来管理响应的过程中，应急编排为基础架构中的所有服务强制执行事故情况下的参与规则。它期望服务使用预定义的通信渠道来交换关于威胁的信息。例如，系统管理员可以使用用户服务公开的API注册一个被盗的JWT，然后将该信息传播到所有依赖于身份验证的后端。</p><h1 id="398b" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">分散分布</h1><p id="9b6d" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">如前所述，软件架构师可以通过创建紧急消息管道来实现分散分布。一方面，他们可以使用CLI或GUI访问它。另一方面，系统中的所有后端可以监听管道中的所有消息，并在必要时选择对其中一些消息做出反应。</p><p id="d0dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设计统一的消息管道需要考虑一种结构，以后端可以理解的格式描述紧急响应。我认为这样的结构不应该包含任何特定服务的信息，而是一个关于做什么的简明命令。例如，关闭整个系统的请求涉及到每个后端，但暂时禁止发送电子邮件的命令只属于电子邮件服务。</p><h1 id="6b1c" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">应用解决方案</h1><p id="5724" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">将解决方案应用到后端取决于具体的解决方案、后端的软件架构以及后端接收紧急信息的方式。尽管我讨论的是后端，但实际上，解决方案必须到达每个后端实例才能工作。系统设计者可以使用紧急消息管道或服务注册表来实现它。</p><p id="9cec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在使用依赖注入的后端中，基于紧急情况的限制列表可以驻留在所有请求或消息处理程序重用的组件中。用全局变量可以得到类似的结果，但我不鼓励这种方法。最后，处理程序可以运行一个检查函数来验证一些限制是否适用于当前评估的请求。</p><p id="95a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果系统使用紧急编排，接收紧急信息的后端需要通过无状态请求或消息管道与系统的其他部分共享这些信息。后端这样做的失败可能会阻止紧急响应的传播。系统设计者应该找到绕过这一障碍的方法，例如，让前一个服务在继续之前等待下一个服务对信息处理的确认。</p><h1 id="508b" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">摘要</h1><p id="498d" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">正如我在文章开头所暗示的，在分布式系统中有多种处理紧急情况的方法，因为不同的系统使用不同的模式进行后端到后端的通信。我相信，试图将危机应对融入发达系统，可能会在系统设计方面提供很多经验。如果你有任何问题，请在评论区留言。</p></div></div>    
</body>
</html>