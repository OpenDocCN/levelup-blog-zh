<html>
<head>
<title>Use Cloudflare JavaScript Workers to Deploy Your Static Generated Site (SSG)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cloudflare JavaScript Workers部署静态生成的站点(SSG)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/use-cloudflare-javascript-workers-to-deploy-you-static-generated-site-ssg-1c518e078646?source=collection_archive---------3-----------------------#2020-01-30">https://levelup.gitconnected.com/use-cloudflare-javascript-workers-to-deploy-you-static-generated-site-ssg-1c518e078646?source=collection_archive---------3-----------------------#2020-01-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/be510e2e906c20e1b4dafca719ee8082.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QKXN1T-TjDqld67y4i-P1Q.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来自<a class="ae kf" href="https://www.pexels.com/photo/man-sitting-on-edge-facing-sunset-915972/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a>的<a class="ae kf" href="https://www.pexels.com/@abhiram2244?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Abhiram Prakash </a>摄影</figcaption></figure><p id="68cc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">静态站点生成器正在成为构建和部署不需要服务器端呈现的web应用程序的实际方式。这些应用程序的页面不需要实际的web服务器来动态呈现内容。需要服务器的页面类型通常受到身份验证墙的保护。可能会有其他站点在服务器上为SEO生成动态内容。</p><p id="5c31" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://gohugo.io/" rel="noopener ugc nofollow" target="_blank"> Hugo </a>、<a class="ae kf" href="https://www.gatsbyjs.org/" rel="noopener ugc nofollow" target="_blank"> Gatsby </a>和<a class="ae kf" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> NextJS </a>是这个领域最受欢迎的解决方案。它们都在一个文件夹中构建由一组文件(HTML、CSS、JavaScript、图像)组成的输出，然后我们可以用常规服务器(NGINX、Apache等)将它们提供给用户。)或者最好通过CDN(内容交付网络),因为我们不需要服务器业务逻辑。只有CDN将用作源的文件存储。</p><p id="f02c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">除了这些工件，一些静态spa，尤其是用<code class="fe le lf lg lh b">react-router</code>开发的应用，可能需要额外的配置。我们可以通过将所有路径重定向到一个文件来实现这一点。这可以在负载平衡器上实现，甚至可以通过Cloudflare Workers本身实现。</p><p id="670c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">到目前为止，在所有这些情况下，我们仍然需要将文件存储在某个地方。使用S3桶和Cloudfront发行版的AWS一直是一个很好的选择。这篇文章的目的是展示另一种解决方案。使用最新的Workers KV数据存储直接部署到Cloudflare Workers。</p><p id="ccf6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="li">我必须指出，Cloudflare Worker的最初目的是将计算带到边缘。无服务器平台。由于Workers KV store的可用性，部署静态站点是另一个受支持的用例。</em></p><h2 id="9917" class="lj lk it bd ll lm ln dn lo lp lq dp lr kr ls lt lu kv lv lw lx kz ly lz ma mb bi translated">什么是工人</h2><p id="bc98" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">Cloudflare Worker是一段JavaScript代码，每当您访问Cloudflare代理的网站上的特定路线时，它都会运行。在请求到达Cloudflare的缓存之前，代码会在每个请求<em class="li">上执行。这意味着工作器响应不会被缓存(尽管工作器向其他web服务发出的请求可能会使用适当的缓存头进行缓存)。</em></p><p id="3a5e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">工人是在一个安全的上下文中执行的，所以我们可以安全地在其中包含秘密。工作者不能访问另一个工作者的上下文。</p><p id="f448" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是基础工:</p><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">你好工人</figcaption></figure><h2 id="2b1c" class="lj lk it bd ll lm ln dn lo lp lq dp lr kr ls lt lu kv lv lw lx kz ly lz ma mb bi translated">配置域/路由/工作者</h2><p id="8b3f" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">让我们部署第一个工人。首先，您需要在Cloudflare上配置一个域。我的仪表盘上已经有<code class="fe le lf lg lh b">outsrc.dev</code>了。</p><p id="64f8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在DNS部分，为指向<code class="fe le lf lg lh b">192.2.0.1</code>的子域<code class="fe le lf lg lh b">www</code>添加一个注册表类型A。这个IP号码被认为是一个没有人能够解决的问题。我们的工作人员会拦截所有请求。</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mn"><img src="../Images/0a0a62f5ca883ddabdb649d85dc63d71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LO8jBTquOVDbg-Wjy5VkIA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">我们将www.outsrc.dev映射到192.2.0.1</figcaption></figure><p id="b3a3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我们可以在worker选项卡上创建一个worker。</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mn"><img src="../Images/75cb88a9074b01fedf9145cb2b0d99ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YcBFyeYvl3YLD9EYwtFNGQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">工人小组</figcaption></figure><p id="97be" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在Workers面板中创建新的Worker，更改名称(我使用了<code class="fe le lf lg lh b">hello-worker</code>)并点击Save and Deploy。所有工人都可以被自动部署到一个演示工作区，在我的情况下，最终成为了<a class="ae kf" href="https://hello-worker.outsrc.workers.dev/" rel="noopener ugc nofollow" target="_blank">https://hello-worker.outsrc.workers.dev/</a></p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mn"><img src="../Images/8952d1fa9d3c7e96d2d1726e7a6d08af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*056vvJvLUeETG7HEVUU55w.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">工人编辑器</figcaption></figure><p id="4e81" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦部署完成，我们就可以在我们的主<code class="fe le lf lg lh b">outsrc.dev</code>域上运行这个worker，甚至可以在一个单一的路由路径上运行。为此，我们需要转到主帐户仪表板并选择Workers选项卡。</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mn"><img src="../Images/e620186c5cbefbd51f7d210c2482e8cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HI4PtHllaKJB3jszkzEWaw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">工人标签</figcaption></figure><p id="00d7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用<code class="fe le lf lg lh b">www.outsrc.dev/hello</code>添加路线并选择您最近部署的<code class="fe le lf lg lh b">hello-worker</code>工人。</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mn"><img src="../Images/ec283a6db015314801f719fa413402fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yqYHS0JpkoXLTCptlkNmpw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">你好工人被发送到www.outsrc.dev/hello</figcaption></figure><p id="d466" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们可以直接访问这个网址:<a class="ae kf" href="https://www.outsrc.dev/hello" rel="noopener ugc nofollow" target="_blank">https://www.outsrc.dev/hello</a></p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="1559" class="lj lk it lh b gy ms mt l mu mv">$ http <a class="ae kf" href="https://www.outsrc.dev/hello" rel="noopener ugc nofollow" target="_blank">https://www.outsrc.dev/hello</a><br/>HTTP/1.1 200 OK<br/>CF-RAY: 55d4285c0f45d4ed-MIA<br/>Connection: keep-alive<br/>Content-Length: 11<br/>Content-Type: text/plain;charset=UTF-8<br/>Date: Thu, 30 Jan 2020 14:32:51 GMT<br/>Expect-CT: max-age=604800, report-uri="<a class="ae kf" href="https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct" rel="noopener ugc nofollow" target="_blank">https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct</a>"<br/>Server: cloudflare<br/>Set-Cookie: __cfduid=dbd7b5387c4e90a370fdc89ed5e908f701580394771; expires=Sat, 29-Feb-20 14:32:51 GMT; path=/; domain=.outsrc.dev; HttpOnly; SameSite=Lax<br/>Vary: Accept-Encoding</span><span id="f931" class="lj lk it lh b gy mw mt l mu mv">hello world</span></pre><h2 id="2401" class="lj lk it bd ll lm ln dn lo lp lq dp lr kr ls lt lu kv lv lw lx kz ly lz ma mb bi translated">工具作业</h2><p id="8f4b" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">手动创建/修改工作者的代码可能会变得复杂，特别是因为我们可能想要自动化部署Web应用程序的所有步骤。</p><p id="ca9a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">进入Cloudflare工作人员的CLI工具Wrangler。<a class="ae kf" href="https://developers.cloudflare.com/workers/tooling/wrangler/" rel="noopener ugc nofollow" target="_blank">https://developers.cloudflare.com/workers/tooling/wrangler/</a></p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="49ad" class="lj lk it lh b gy ms mt l mu mv">$ npm i @cloudflare/wrangler -g</span></pre><p id="b723" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">安装完成后，我们需要在使用几个命令引导/部署相同的基本Hello Worker之前配置身份验证。转到<a class="ae kf" href="https://dash.cloudflare.com/profile/api-tokens" rel="noopener ugc nofollow" target="_blank">https://dash.cloudflare.com/profile/api-tokens</a>为牧马人工具创建API令牌。(使用Cloudflare工作人员的模板获取权限)</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mx"><img src="../Images/303290527af421ae082b90d2bb5dd526.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ZU0YKMFqhvGdKgWYAk-Cg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">为Wrangler CLI工具创建API令牌</figcaption></figure><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="cb4c" class="lj lk it lh b gy ms mt l mu mv">$ wrangler config<br/>wrangler config</span><span id="093b" class="lj lk it lh b gy mw mt l mu mv">💁  To find your API token, go to <a class="ae kf" href="https://dash.cloudflare.com/profile/api-tokens" rel="noopener ugc nofollow" target="_blank">https://dash.cloudflare.com/profile/api-tokens</a><br/> and create it using the "Edit Cloudflare Workers" template</span><span id="6bf2" class="lj lk it lh b gy mw mt l mu mv">💁  If you are trying to use your Global API Key instead of an API Token<br/> (Not Recommended), run "wrangler config --api-key".</span><span id="d08b" class="lj lk it lh b gy mw mt l mu mv">Enter API token: </span></pre><p id="64b9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">配置完成后，我们可以通过wrangler CLI工具创建新员工。</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="0c39" class="lj lk it lh b gy ms mt l mu mv">$ wrangler generate hello-worker <a class="ae kf" href="https://github.com/cloudflare/worker-template" rel="noopener ugc nofollow" target="_blank">https://github.com/cloudflare/worker-template</a></span></pre><p id="adc9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个worker模板是一个简单的JavaScript Hello Worker。除了模板的内容，我们还将有一个<code class="fe le lf lg lh b">wrangler.toml</code>文件，其中包含我们需要更新的设置，例如:</p><ul class=""><li id="6c75" class="my mz it ki b kj kk kn ko kr na kv nb kz nc ld nd ne nf ng bi translated"><strong class="ki iu"> account_id </strong>:您的账户id，您可以在主仪表盘上找到</li><li id="e345" class="my mz it ki b kj nh kn ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><strong class="ki iu">zone _ id</strong>:cloud flare上的每个DNS区域都有自己的ID，也在控制面板上</li><li id="284a" class="my mz it ki b kj nh kn ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><strong class="ki iu">路线</strong>:从哪里接近工人(例如:<a class="ae kf" href="http://www.outsrc.dev/hello" rel="noopener ugc nofollow" target="_blank">www.outsrc.dev/hello</a>)</li><li id="d1d3" class="my mz it ki b kj nh kn ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><strong class="ki iu">workers _ dev</strong>:true | false它会将您的Worker部署到一个临时环境，通常采用以下形式:<code class="fe le lf lg lh b">https://&lt;worker_name&gt;.&lt;account_name&gt;.worker.dev</code></li></ul><p id="6395" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">设置就绪后:</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="b120" class="lj lk it lh b gy ms mt l mu mv">$ wrangler publish<br/>💁  JavaScript project found. Skipping unnecessary build!<br/>✨  Successfully published your script to <a class="ae kf" href="http://www.outsrc.dev/hello" rel="noopener ugc nofollow" target="_blank">www.outsrc.dev/hello</a></span></pre><h2 id="acb3" class="lj lk it bd ll lm ln dn lo lp lq dp lr kr ls lt lu kv lv lw lx kz ly lz ma mb bi translated">工人KV商店</h2><blockquote class="nm nn no"><p id="dc5a" class="kg kh li ki b kj kk kl km kn ko kp kq np ks kt ku nq kw kx ky nr la lb lc ld im bi translated">Workers KV是一个全球性的低延迟、键值数据存储。它支持异常高的读取量和低延迟，使构建高度动态的API和网站成为可能，这些API和网站的响应速度与缓存的静态文件一样快。</p></blockquote><p id="5401" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有了这项功能，我们可以:</p><ul class=""><li id="af47" class="my mz it ki b kj kk kn ko kr na kv nb kz nc ld nd ne nf ng bi translated">在边缘存储我们的静态资产HTML、CSS、图像和JavaScript文件</li><li id="39e2" class="my mz it ki b kj nh kn ni kr nj kv nk kz nl ld nd ne nf ng bi translated">修改我们的Worker代码，根据路径返回正确的文件。(Workers KV JavaScript APIs已经支持这一点)</li><li id="1445" class="my mz it ki b kj nh kn ni kr nj kv nk kz nl ld nd ne nf ng bi translated">使用<code class="fe le lf lg lh b">wrangler</code>来自动化所有的过程。</li></ul><p id="0899" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们开始吧。</p><h2 id="fb24" class="lj lk it bd ll lm ln dn lo lp lq dp lr kr ls lt lu kv lv lw lx kz ly lz ma mb bi translated">创建静态生成的网站</h2><p id="7e58" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">任何静态站点生成器都可以。我们只需要能够拥有一个静态构建输出文件夹，我们将把它部署到Worker KV和一个Worker脚本，后者将从存储中提取并服务于它。</p><p id="8c11" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将以https://github.com/outsrc/template-frontend<a class="ae kf" href="https://github.com/outsrc/template-frontend" rel="noopener ugc nofollow" target="_blank">的</a>回购为起点。这个repo基于NextJS，并且已经包含了一个静态导出web应用程序的命令(生成了一个文件夹<code class="fe le lf lg lh b">out</code>)</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="a9c3" class="lj lk it lh b gy ms mt l mu mv">$ git clone git@github.com:outsrc/template-frontend.git static-app<br/>$ cd static-app<br/>$ yarn install<br/>$ yarn export</span></pre><p id="ecbc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们添加<code class="fe le lf lg lh b">wrangler</code>作为开发依赖项，并通过<code class="fe le lf lg lh b">wrangler.toml</code>配置部署</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="1594" class="lj lk it lh b gy ms mt l mu mv">$ yarn add --dev @cloudflare/wrangler<br/>$ wrangler init --site hello-worker<br/>⬇️ Installing cargo-generate...<br/>🔧   Creating project called `workers-site`...<br/>✨   Done! New project created /Users/ernestofreyre/Documents/nodeprojects/static-app/workers-site<br/>✨  Succesfully scaffolded workers site<br/>✨  Succesfully created a `wrangler.toml`</span></pre><p id="e3fc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将增加:</p><ul class=""><li id="c8f3" class="my mz it ki b kj kk kn ko kr na kv nb kz nc ld nd ne nf ng bi translated">文件夹:包含所有必要的依赖项和一个包含我们的静态前端应用工人的文件。</li><li id="7c23" class="my mz it ki b kj nh kn ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><code class="fe le lf lg lh b">wrangler.toml</code>文件:部署工人的设置</li></ul><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">worker-site/index.js</figcaption></figure><p id="3a03" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们不需要修改<code class="fe le lf lg lh b">worker-site</code>文件夹(目前)，但是<code class="fe le lf lg lh b">wrangler.toml</code>需要一些更新(粗体字母)。</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="124b" class="lj lk it lh b gy ms mt l mu mv">name = "hello-worker"<br/>type = "webpack"<br/>account_id = "<strong class="lh iu">&lt;YOUR ACCOUNT ID&gt;</strong>"<br/>workers_dev = <strong class="lh iu">true</strong></span><span id="2527" class="lj lk it lh b gy mw mt l mu mv">[site]<br/>bucket = "<strong class="lh iu">./out</strong>"<br/>entry-point = "workers-site"</span></pre><p id="a9b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">更新后，我们可以部署到一个暂存环境:</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="8c8f" class="lj lk it lh b gy ms mt l mu mv">$ wrangler publish<br/>🌀  Created namespace for Workers Site "__hello-worker-workers_sites_assets"<br/>💁  Uploading...<br/>✨  Success<br/>added 2 packages from 2 contributors and audited 2 packages in 0.395s<br/>found 0 vulnerabilities</span><span id="b2bc" class="lj lk it lh b gy mw mt l mu mv">⬇️ Installing wranglerjs...<br/>⬇️ Installing wasm-pack...<br/>✨  Built successfully, built project size is 11 KiB.<br/>✨  Successfully published your script to <a class="ae kf" href="https://hello-worker.outsrc.workers.dev" rel="noopener ugc nofollow" target="_blank">https://hello-worker.outsrc.workers.dev</a></span></pre><p id="8bbc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样。访问底部显示的网址，你会看到我们的静态应用程序运行良好(我不得不说非常快)</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ns"><img src="../Images/0f2ebd1c1c4796594c338c2c07aa5d36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LXBlbjKgKqtGx4KswxZVkg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">瞧啊。</figcaption></figure><h2 id="ae81" class="lj lk it bd ll lm ln dn lo lp lq dp lr kr ls lt lu kv lv lw lx kz ly lz ma mb bi translated">部署到生产环境</h2><p id="c932" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">这是我们自己的领域。我们需要修改<code class="fe le lf lg lh b">wrangler.toml</code>文件来包含一个环境部分。</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="52fc" class="lj lk it lh b gy ms mt l mu mv">name = "hello-worker"<br/>type = "webpack"<br/>account_id = "<strong class="lh iu">&lt;YOUR ACCOUNT ID&gt;</strong>"<br/>workers_dev = <strong class="lh iu">true</strong></span><span id="24e1" class="lj lk it lh b gy mw mt l mu mv">[site]<br/>bucket = "<strong class="lh iu">./out</strong>"<br/>entry-point = "workers-site"</span><span id="c200" class="lj lk it lh b gy mw mt l mu mv">[env.production]<br/>zone_id = "<strong class="lh iu">&lt;YOUR ZONE ID&gt;</strong>"<br/>route = "<a class="ae kf" href="http://www.outsrc.dev/*" rel="noopener ugc nofollow" target="_blank"><strong class="lh iu">www.outsrc.dev/*</strong></a>"</span></pre><p id="6797" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有了这些，我们现在可以:</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="7d83" class="lj lk it lh b gy ms mt l mu mv">$ wrangler publish --env production<br/>🌀  Created namespace for Workers Site "__hello-worker-production-workers_sites_assets"<br/>💁  Uploading...<br/>✨  Success<br/>⬇️ Installing wranglerjs...<br/>⬇️ Installing wasm-pack...<br/>✨  Built successfully, built project size is 11 KiB.<br/>✨  Successfully published your script to <a class="ae kf" href="http://www.outsrc.dev/*" rel="noopener ugc nofollow" target="_blank">www.outsrc.dev/*</a></span></pre><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ns"><img src="../Images/244bec0f191e186ef8b46760cd99559d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_XunJBR75aH43LhfRVskKA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">成功！！</figcaption></figure><h2 id="e8a4" class="lj lk it bd ll lm ln dn lo lp lq dp lr kr ls lt lu kv lv lw lx kz ly lz ma mb bi translated">部署更进一步</h2><p id="e12f" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">假设我们使用提交散列作为路径前缀，将所有提交构建并部署到Worker KV存储。(例如:/8982c33e/index.html)然后，我们可以将所有请求实时地重新路由到我们想要的任何提交文件夹。这意味着部署到生产和回滚可以通过更改KV存储上的单个值来即时完成。Canary也部署(一组用户将获得应用程序的一个版本)</p><p id="07c0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先创建一个名为CONTROL的新工作KV名称空间:</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="b1d2" class="lj lk it lh b gy ms mt l mu mv">$ wrangler kv:namespace create "CONTROL"<br/>🌀  Creating namespace with title "hello-worker-CONTROL"<br/>✨  Success: WorkersKvNamespace {<br/>    id: "22e976....",<br/>    title: "hello-worker-CONTROL",<br/>}<br/>✨  Add the following to your wrangler.toml:<br/><strong class="lh iu">kv-namespaces = [ <br/>  { binding = "CONTROL", id = "22e976...." } <br/>]</strong></span></pre><p id="52d6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要将粗体部分放在<code class="fe le lf lg lh b">wrangler.toml</code>文件的顶部:</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="7b82" class="lj lk it lh b gy ms mt l mu mv">name = "hello-worker"<br/>type = "webpack"<br/>account_id = "&lt;YOUR ACCOUNT ID&gt;"<br/>workers_dev = true</span><span id="5aa3" class="lj lk it lh b gy mw mt l mu mv"><strong class="lh iu">kv-namespaces = [ <br/>  { binding = "CONTROL", id = "22e976...." } <br/>]</strong></span><span id="6620" class="lj lk it lh b gy mw mt l mu mv">[site]<br/>bucket = "./out"<br/>entry-point = "workers-site"</span><span id="8517" class="lj lk it lh b gy mw mt l mu mv">[env.production]<br/>zone_id = "&lt;YOUR ZONE ID&gt;"<br/>route = "www.outsrc.dev/*"</span><span id="ef6c" class="lj lk it lh b gy mw mt l mu mv"><strong class="lh iu">kv-namespaces = [ <br/>  { binding = "CONTROL", id = "22e976...." } <br/>]</strong></span></pre><p id="5d94" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为我们的NextJS应用程序每次执行<code class="fe le lf lg lh b">yarn export</code>都会重新生成静态输出文件夹，所以我们需要相应地移动文件。此外，wrangler CLI工具不会保留以前部署的旧文件。我们需要把它们都放在同一个文件夹下。(如果wrangler允许我们在存储上保留旧文件，那就太好了)。创建一个builds文件夹，我们将在其中复制所有的静态构建。</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="6793" class="lj lk it lh b gy ms mt l mu mv">$ mkdir builds</span></pre><p id="dbe4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并将部署脚本修改为首先，将<code class="fe le lf lg lh b">out</code>文件夹重命名为当前提交哈希的名称，并将其移动到<code class="fe le lf lg lh b">builds</code>文件夹:</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="4ef8" class="lj lk it lh b gy ms mt l mu mv">{<br/>  "name": "template-frontend",<br/>  "version": "1.0.0",<br/>  "description": "",<br/>  "main": "index.js",<br/>  "scripts": {<br/>    "clean": "rimraf .next &amp;&amp; rimraf out",<br/>    "dev": "next",<br/>    "build": "next build",<br/>    "start": "next start",<br/>    "export": "yarn clean &amp;&amp; yarn build &amp;&amp; next export",<br/>    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1",<br/>    "lint": "standard",<br/>    "format": "prettier-standard --format",<br/>    <strong class="lh iu">"pre-deploy": "mv out `git rev-parse HEAD | cut -c 1-8` &amp;&amp; mv `git rev-parse HEAD | cut -c 1-8` builds",<br/>    "deploy:production": "yarn export &amp;&amp; yarn pre-deploy &amp;&amp; wrangler publish --env production"</strong><br/>  },<br/>  "keywords": [],<br/>  "author": "",<br/>  "license": "ISC",<br/>  "dependencies": {<br/>    "next": "~9.2.0",<br/>    "react": "^16.12.0",<br/>    "react-dom": "^16.12.0"<br/>  },<br/>  "devDependencies": {<br/>    "<a class="ae kf" href="http://twitter.com/cloudflare/wrangler" rel="noopener ugc nofollow" target="_blank">@cloudflare/wrangler</a>": "^1.6.0",<br/>    "<a class="ae kf" href="http://twitter.com/types/node" rel="noopener ugc nofollow" target="_blank">@types/node</a>": "^12.12.7",<br/>    "<a class="ae kf" href="http://twitter.com/types/react" rel="noopener ugc nofollow" target="_blank">@types/react</a>": "^16.9.11",<br/>    "prettier-standard": "^15.0.1",<br/>    "rimraf": "^3.0.0",<br/>    "standard": "^14.3.1",<br/>    "typescript": "^3.7.2"<br/>  }<br/>}</span></pre><p id="726c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要的最后更改在<code class="fe le lf lg lh b">worker-site/index.js</code>文件中。对于每个请求，首先获取我们想要提供的提交散列，并将请求重新映射到包含我们的资产的文件夹。使用我们之前设置的控件命名空间中的值。</p><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">workers-site/index.js</figcaption></figure><p id="25d7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们部署并尝试访问我们的应用程序，我们将获得:</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="2501" class="lj lk it lh b gy ms mt l mu mv">$ yarn deploy:production<br/>yarn run v1.21.1<br/>$ yarn export &amp;&amp; yarn pre-deploy &amp;&amp; wrangler publish --env production<br/>$ yarn clean &amp;&amp; yarn build &amp;&amp; next export<br/>$ rimraf .next &amp;&amp; rimraf out<br/>$ next build<br/>Creating an optimized production build</span><span id="6fa4" class="lj lk it lh b gy mw mt l mu mv">Compiled successfully.</span><span id="3a42" class="lj lk it lh b gy mw mt l mu mv">Automatically optimizing pages</span><span id="f05f" class="lj lk it lh b gy mw mt l mu mv">Page                            Size     First Load<br/>┌ ○ /                           595 B       75.5 kB<br/>└ ○ /about                      583 B       75.5 kB<br/>+ shared by all                 68.8 kB<br/>  ├ static/_buildManifest.js    188 B<br/>  ├ static/pages/_app.js        944 B<br/>  ├ chunks/commons.9ed1b2.js    21.7 kB<br/>  ├ chunks/framework.94bc9f.js  40.5 kB<br/>  ├ runtime/main.99b7a8.js      4.69 kB<br/>  └ runtime/webpack.b65cab.js   746 B</span><span id="20c6" class="lj lk it lh b gy mw mt l mu mv">λ  (Server)  server-side renders at runtime (uses getInitialProps or getServerProps)<br/>○  (Static)  automatically rendered as static HTML (uses no initial props)<br/>●  (SSG)     automatically generated as static HTML + JSON (uses getStaticProps)</span><span id="3513" class="lj lk it lh b gy mw mt l mu mv">&gt; using build directory: /Users/ernestofreyre/Documents/nodeprojects/static-app/.next<br/>  copying "static build" directory<br/>  launching 15 workers<br/>Exporting (3/3)</span><span id="1d7b" class="lj lk it lh b gy mw mt l mu mv">Export successful<br/>$ mv out `git rev-parse HEAD | cut -c 1-8` &amp;&amp; mv `git rev-parse HEAD | cut -c 1-8` builds<br/>🌀  Using namespace for Workers Site "__hello-worker-production-workers_sites_assets"<br/>💁  Uploading...<br/>✨  Success<br/>⬇️ Installing wranglerjs...<br/>⬇️ Installing wasm-pack...<br/>✨  Built successfully, built project size is 11 KiB.<br/>✨  Successfully published your script to <a class="ae kf" href="http://www.outsrc.dev/*" rel="noopener ugc nofollow" target="_blank">www.outsrc.dev/*</a><br/>✨  Done in 16.53s.</span></pre><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nt"><img src="../Images/0e9fa106eaef8db1f4f2a84d0fb47124.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1wD84QLxlKPcWsQJo_diAg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">错误！！</figcaption></figure><p id="00b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们刚刚错过了在控件名称空间上设置<code class="fe le lf lg lh b">show_commit</code>值。</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="624b" class="lj lk it lh b gy ms mt l mu mv">$ wrangler kv:key put --binding=CONTROL "show_commit" "0b0b0ef4"<br/>✨  Success</span></pre><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nt"><img src="../Images/a0354d2df2368ed45344c826ab733ffd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*67jpOtfV0njW2z7MIX_0rQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">成功！！</figcaption></figure><p id="16b2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，每次我们提交并部署到生产环境时，应用程序都会被构建并部署到KV商店。更新提交所用内容的命令是:</p><pre class="mh mi mj mk gt mo lh mp mq aw mr bi"><span id="249e" class="lj lk it lh b gy ms mt l mu mv">$ wrangler kv:key put --binding=CONTROL "show_commit" "&lt;COMMITHASH&gt;"</span></pre><p id="c955" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">回滚只需要与我们想要回滚的提交散列相同的命令。瞬间。</p><h2 id="7664" class="lj lk it bd ll lm ln dn lo lp lq dp lr kr ls lt lu kv lv lw lx kz ly lz ma mb bi translated">结论</h2><ul class=""><li id="834e" class="my mz it ki b kj mc kn md kr nu kv nv kz nw ld nd ne nf ng bi translated">您的Web应用需要一个CDN，Cloudflare CDN是一个成熟的解决方案。</li><li id="4cda" class="my mz it ki b kj nh kn ni kr nj kv nk kz nl ld nd ne nf ng bi translated">cloud flare Workers+cloud flare Workers KV允许您将静态站点生成的Web应用程序直接部署到边缘。</li><li id="90c3" class="my mz it ki b kj nh kn ni kr nj kv nk kz nl ld nd ne nf ng bi translated">还可以支持更复杂的用例:不同的基路径、增强的安全模式。</li><li id="7c3d" class="my mz it ki b kj nh kn ni kr nj kv nk kz nl ld nd ne nf ng bi translated">您可以将您的CI/CD管道设置为持续部署到Worker KV store，并在以后决定何时将您的用户转移到最新版本或在发现bug时回滚。</li></ul><p id="4b49" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">黑客快乐…</p></div></div>    
</body>
</html>