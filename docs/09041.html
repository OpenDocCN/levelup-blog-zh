<html>
<head>
<title>Install pg_cron on Amazon RDS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Amazon RDS上安装pg_cron</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/install-pg-cron-on-amazon-rds-758ca272f75c?source=collection_archive---------26-----------------------#2021-06-29">https://levelup.gitconnected.com/install-pg-cron-on-amazon-rds-758ca272f75c?source=collection_archive---------26-----------------------#2021-06-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6cf8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">我最近将我们位于</em><a class="ae km" href="https://theorg.com/org/theorg" rel="noopener ugc nofollow" target="_blank"><em class="kl">Org</em></a><em class="kl">的分析数据库升级到PostgreSQL 13.1，以便支持定期刷新物化视图，使用pg_cron直接在数据库中运行作业。我们之前的设置涉及触发Lambda运行刷新命令的CloudWatch事件。</em></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/98db2e63c61b5224501d994b71dc7177.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zN0tUTZbcfswMyaBD8c0gQ.jpeg"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">在Amazon RDS上安装pg_cron</figcaption></figure><h1 id="44cd" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">升级到PostgreSQL 12.5以上版本</h1><p id="1813" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">亚马逊RDS从12.5版本及更高版本开始支持pg _ cron(<a class="ae km" href="https://aws.amazon.com/about-aws/whats-new/2021/01/amazon-rds-postgresql-supports-pg-cron-extension-scheduling-database-jobs/" rel="noopener ugc nofollow" target="_blank">来源</a>)。如果您运行的是旧版本，则需要进行更新。</p><p id="231c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在AWS控制面板中或通过运行:<br/> <code class="fe mg mh mi mj b">SELECT version();</code>来检查版本</p><p id="0731" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您运行的是12.5版或更高版本，请直接跳到下一节。否则，您需要更新您的数据库。导航到您的数据库实例，将数据库引擎版本设置为PostgreSQL 13.1-R1以更新它。</p><p id="52a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步将要求您更新参数组，这也需要重新启动。同时执行这两个步骤有利于减少停机时间。</p><p id="2cc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更新主要版本将需要10-20分钟，并使您的数据库暂时不可用。我不会在这里讨论避免停机的策略。</p><h1 id="f9db" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">更新参数组</h1><p id="5f8b" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">转到参数组，更改<em class="kl">shared _ preload _ libraries</em>的值，以包含pg_cron。您不能更新默认参数组。</p><p id="923c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您正在使用<em class="kl"> default.postgres13 </em>参数组，则创建一个新的参数组，将<em class="kl">参数组族</em>设置为postgres13。这将创建模板的副本，然后您可以对其进行修改。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi mk"><img src="../Images/ee7aa5d4e9402c1f9a062df38a5e6f55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EMcfdZBGVRAfRhY24gB2dg.png"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">修改shared_preload_libraries以包含pg_cron</figcaption></figure><p id="5372" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">导航到RDS实例，然后单击修改。在附加配置下设置DB参数组，以使用您刚刚创建的组。如果您只是修改了现有的参数组，请跳过这一步。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi ml"><img src="../Images/cbde701d4c3c66f6f8c0abef38ef0bdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rfoXWW9DqbAWc0a-.png"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">为RDS实例设置数据库参数组。</figcaption></figure><p id="d93d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用更改。这需要快速重启数据库。</p><h1 id="b967" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">安装pg_cron</h1><p id="7a98" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">作为rds _超级用户连接到您的数据库。默认管理员账户(通常称为<em class="kl"> postgres </em>)是这个用户组的一部分。连接后，在postgres数据库中运行以下SQL:</p><p id="1731" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mg mh mi mj b">CREATE EXTENSION pg_cron;</code></p><p id="332f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果成功，您应该能够在postgres数据库中看到一个名为<em class="kl"> cron </em>的模式，其中包含一个<em class="kl">作业</em>和<em class="kl"> job_run_details </em>表。不成功的常见错误包括:</p><blockquote class="mm mn mo"><p id="9310" class="jn jo kl jp b jq jr js jt ju jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj kk ij bi translated"><em class="iq">错误:pg_cron只能通过shared_preload_libraries加载</em></p></blockquote><p id="4cc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参数组未正确更新。请确保您更新了正确的参数组，并将更改应用于数据库。数据库重新启动可能被挂起。</p><blockquote class="mm mn mo"><p id="31cc" class="jn jo kl jp b jq jr js jt ju jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj kk ij bi translated"><em class="iq">错误:创建扩展“pg_cron”的权限被拒绝</em></p></blockquote><p id="6f81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您验证的用户没有安装pg_cron的权限。确保您使用的是具有管理员权限的帐户。postgres和rdsadmin都可以。</p><blockquote class="mm mn mo"><p id="61dd" class="jn jo kl jp b jq jr js jt ju jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj kk ij bi translated"><em class="iq">错误:只能在数据库postgres中创建扩展</em></p></blockquote><p id="e715" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您连接到了错误的数据库。确保您正在针对<em class="kl"> postgres </em>数据库运行命令。</p><h1 id="9660" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">使用pg_cron添加Cron作业</h1><p id="c038" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">一旦安装了pg_cron，您就可以使用以下语法开始调度SQL命令:<code class="fe mg mh mi mj b"><br/>SELECT cron.schedule(SCHEDULE, COMMAND);<br/>SELECT cron.schedule(JOB_NAME, SCHEDULE, COMMAND);</code></p><p id="6fb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，这些cron作业将在<em class="kl"> postgres </em>数据库上下文中运行。我们使用pg_cron的用例是定期更新物化视图，因此我们需要更新执行命令的数据库。这可以通过首先调度作业，然后更新<em class="kl"> cron.job </em>表中的<em class="kl">数据库</em>列来完成。在我们的例子中，代码如下所示:</p><p id="bcfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mg mh mi mj b">SELECT cron.schedule(<br/> 'Refresh weekly analytics',<br/> '5 0 * * 1',<br/> $$REFRESH MATERIALIZED VIEW web_client.company_weekly_analytics$$<br/>)<br/>UPDATE cron.job SET database = 'theorg' WHERE jobid = 1</code></p><p id="be8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将在每周一的0:05在我们的主数据库中运行该命令。</p><h1 id="3455" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">pg_cron的速成班</h1><p id="3554" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">pg_cron背后的概念相当简单。计划的任务存储在<em class="kl"> cron.job </em>表中，其中包含要执行的命令和时间。时间表被表示为一个常规的cron表达式——您可以使用<a class="ae km" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank"> crontab.guru </a>来生成正确的cron表达式。</p><p id="0f3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看所有预定作业:<br/> <code class="fe mg mh mi mj b">SELECT * FROM cron.job</code></p><p id="1de6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查以前运行的日志:<br/> <code class="fe mg mh mi mj b">SELECT * FROM cron.job_run_details</code></p><p id="6182" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><br/>安排新工作:<code class="fe mg mh mi mj b">SELECT cron.schedule(JOB_NAME, SCHEDULE, COMMAND);</code></p><p id="6489" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">取消安排作业:<br/>T5】</p><p id="b6c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更新作业的cron表达式，例如to将在每天3:14运行<code class="fe mg mh mi mj b"><br/>UPDATE cron.job SET schedule = '14 3 * * *' WHERE jobid = 1</code></p><p id="346c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每次运行都会在<em class="kl"> cron.job_run_details </em>表中添加一个条目。查询它以确认您的cron作业成功执行。</p><h1 id="f91d" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">放弃</h1><p id="5003" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">考虑一下在您的数据库中直接运行cron作业是否是您的用例中的正确解决方案。它会使您的数据库变得混乱，耗尽资源，并从您的代码库中隐藏业务关键信息——可能会为您的同事带来一些非常糟糕的调试会话。</p><p id="2049" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我个人不建议直接在数据库中运行清理或数据修改作业。我们的用例是确保我们的物化视图(由于性能原因必须物化)保持更新。我们的替代方法是使用CloudWatch事件来定期触发连接到数据库并刷新视图的AWS lambda。</p><p id="414d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行Lambda来刷新视图增加了成本和复杂性，并涉及更多可能会失败的移动部件。这种方法也不是很明显，因为你必须知道lambda的存在，并且是周期性触发的。在我们的例子中，使用pg_cron是较小的错误。</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><p id="1d84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">原载于2021年6月29日</em><a class="ae km" href="https://adequatesource.com/pg-cron-aws-rds/" rel="noopener ugc nofollow" target="_blank"><em class="kl">【https://adequatesource.com】</em></a><em class="kl">。</em></p></div></div>    
</body>
</html>