<html>
<head>
<title>Use Presigned URL to upload files into AWS S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用预先指定的URL将文件上传到AWS S3</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/use-presigned-url-to-upload-files-into-aws-s3-db6b7a8c2cc9?source=collection_archive---------0-----------------------#2020-10-29">https://levelup.gitconnected.com/use-presigned-url-to-upload-files-into-aws-s3-db6b7a8c2cc9?source=collection_archive---------0-----------------------#2020-10-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1b15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博文中，我将介绍如何利用预先设计的url功能将文件上传到AWS S3。<a class="ae kl" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>将被用来为这个职位提供必要的AWS资源。</p><h2 id="be15" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">为什么我们首先需要一个预先设计的URL？</h2><p id="da0e" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">预先指定的URL可用于这样的情况，例如客户/用户想要将文件上传到他/她没有访问权限的S3存储桶中。因此，这种机制可以作为一种安全的方式，允许未经授权的用户执行上传/下载，进入或来自S3。从用户的角度来看，这减轻了使用AWS凭证(accesskey + secretkey)进行请求的负担。预先指定的URL也有一个截止日期和时间，因此它可以被多次使用，直到用完。</p><h2 id="b1d9" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">先决条件:</h2><p id="9ba6" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">必须配置AWS CLI和无服务器。如果你还没有设置的话，你可以跟随<a class="ae kl" href="https://www.serverless.com/framework/docs/providers/aws/guide/credentials/" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><h2 id="3b03" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated"><strong class="ak">我们需要的AWS资源:</strong></h2><ul class=""><li id="8379" class="lk ll iq jp b jq lf ju lg jy lm kc ln kg lo kk lp lq lr ls bi translated">一个S3桶</li><li id="1935" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">AWS Lambda函数</li><li id="c131" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">API网关端点</li></ul><h2 id="50f8" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated"><strong class="ak">工作流程</strong></h2><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/f9359de272cb7f8456d5fa1ba3fbc544.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*bNgjB-DHfQ1tH3dYz4quGg.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">用户检索预先指定的URL，并将文件上传到S3或从其下载文件</figcaption></figure><h2 id="eca7" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated"><strong class="ak">步骤</strong></h2><ol class=""><li id="a20e" class="lk ll iq jp b jq lf ju lg jy lm kc ln kg lo kk mk lq lr ls bi translated">通过使用<a class="ae kl" href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#getSignedUrl-property" rel="noopener ugc nofollow" target="_blank"> S3 API </a>创建nodejs lambda函数来生成预先指定的url。你可以选择任何你想要的语言，我使用nodejs进行测试。</li></ol><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">生成预先设计的URL的Lambda函数</figcaption></figure><p id="9d09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.创建一个无服务器模板，为我们的测试提供所有必需的AWS资源(S3、Lambda函数和API网关)。</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="5344" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.通过进入模板位置并执行以下命令，将无服务器模板部署到您的AWS环境中:</p><p id="f983" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> sls部署</strong></p><p id="2cd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.验证是否已调配资源:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mn"><img src="../Images/73fbc0ae9bfb0512acd7ff910ab6bcbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SkURE7n1oMTNMC8Zq-ypkQ.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">API网关</figcaption></figure><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi ms"><img src="../Images/d85a212865ec7cb8afde83c2e5f51388.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zZ-XaX9WOU6YuiVbzMJhww.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">λ函数</figcaption></figure><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mt"><img src="../Images/2d130700309d81db5b9dc7ec74d563b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RP9Vjo9aa-O4LL7JsZeYmw.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">S3水桶</figcaption></figure><p id="108c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.使用Postman或任何其他HTTP客户端向创建的API端点发出GET请求，以检索预先指定的url:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mu"><img src="../Images/b16dd7881c7c5a479aa8fa0dd1260d5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dUc4mDXmuTnRhnyMX-CeGw.png"/></div></div></figure><p id="f680" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果请求成功，您将能够看到作为响应返回的预先签名的url。</p><p id="11fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.上面的URL可用于将文件上传到指定的s3存储桶，如下所示</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mv"><img src="../Images/4a04e257eb4f1d11ebc16b54c2ec2299.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xG8301g0MxwGKXtc43gh9A.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">上传文件. js</figcaption></figure><p id="ead9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">原文可以在<a class="ae kl" href="https://github.com/Kulasangar/upload-file-s3-presigned-url/blob/master/test_presigned_url/upload_video.js" rel="noopener ugc nofollow" target="_blank">这里</a>找到。请确保相应地更改预先指定的url。</p><p id="1d45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.在使用接收到的URL更新脚本之后，尝试运行upload_file.js来查看文件是否已经作为对象上传到适当的S3存储桶中。您可以按如下方式运行该文件:</p><p id="faea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">节点上传_文件. js </strong></p><p id="1549" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8.检查您的s3存储桶是否已上传:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mw"><img src="../Images/5be1e37aa491df0e422f0e0e3bcc7f66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IsvfAvtwT3EzLDmVGMEZ8Q.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">上传的文件</figcaption></figure><p id="ec79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你所看到的，我使用的视频文件已经成功上传。</p><p id="2db5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样。就这么简单。通过使用CORS，您甚至可以进一步保护您的API调用。在这种情况下，确保在无服务器模板中创建API网关时只包含允许的来源。您还可以编辑bucket的CORS配置，以便只允许来自该源的特定API调用将文件上传到S3 bucket。</p><p id="1146" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完整的例子可以在<a class="ae kl" href="https://github.com/Kulasangar/upload-file-s3-presigned-url" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="dc58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参考资料:</p><ul class=""><li id="2898" class="lk ll iq jp b jq jr ju jv jy mx kc my kg mz kk lp lq lr ls bi translated"><a class="ae kl" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/PresignedUrlUploadObject.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/Amazon S3/latest/dev/presigneduruploadobject . html</a></li></ul></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="4b07" class="nh kn iq bd ko ni nj nk kr nl nm nn ku no np nq kx nr ns nt la nu nv nw ld nx bi translated">分级编码</h1><p id="db8e" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="035b" class="lk ll iq jp b jq jr ju jv jy mx kc my kg mz kk lp lq lr ls bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="5e07" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">📰查看<a class="ae kl" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="5c46" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">🔔关注我们:<a class="ae kl" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae kl" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae kl" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="583b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">🚀👉<a class="ae kl" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>