<html>
<head>
<title>Our replica set configuration is invalid or does not include us</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们的副本集配置无效或不包括我们</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/our-replica-set-configuration-is-invalid-or-does-not-include-us-af12a587d74a?source=collection_archive---------2-----------------------#2021-12-20">https://levelup.gitconnected.com/our-replica-set-configuration-is-invalid-or-does-not-include-us-af12a587d74a?source=collection_archive---------2-----------------------#2021-12-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b69d4f3d83f40a940ff6e5b2ae46be37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GzNwHqoiJ_E4VHSKljWZmg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">马库斯·温克勒在<a class="ae kc" href="https://unsplash.com/s/photos/replica?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="ddf5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下错误在未正确同步的MongoDB副本集中很常见。原因可能是，由于某种原因，实例长时间无法与主实例或辅助实例同步，然后它进入了一种永远不允许与另一个实例同步的状态。</p><p id="35fc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">长时间的群集故障和长时间的连接问题可能是发生此错误的原因。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/47d1c246f4159a135c1dd5e5cfb664f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lsIOdhL6X0wDaL3TnkPkjQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">mongo日志</figcaption></figure><h2 id="bfd1" class="lg lh iq bd li lj lk dn ll lm ln dp lo ko lp lq lr ks ls lt lu kw lv lw lx ly bi translated">让我们确认受害者的身份</h2><p id="6605" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在进入解决方案之前，让我们收集一些信息。</p><h2 id="32ea" class="lg lh iq bd li lj lk dn ll lm ln dp lo ko lp lq lr ks ls lt lu kw lv lw lx ly bi translated"><span class="l me mf mg bm mh mi mj mk ml di"> 1。</span>检查副本集的状态</h2><p id="5e27" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">进入主mongo，以数据库管理员身份登录</p><p id="ac7b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mm">ku bectl exec-it</em><code class="fe mn mo mp mq b"><em class="mm">podname</em></code><em class="mm">mongo</em></p><p id="9b81" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mm">使用管理员</em></p><p id="6cc5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mm">db . auth(</em><code class="fe mn mo mp mq b"><em class="mm">username</em></code><em class="mm">”，</em><code class="fe mn mo mp mq b"><em class="mm">password</em></code><em class="mm">)</em></p><p id="c5ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<code class="fe mn mo mp mq b">rs.status()</code>查看副本集状态</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/8d8a1a3bfba4b7c2067ad122cb78dc05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gEAshZyQVXxpHiM9pnn4Og.png"/></div></div></figure><p id="7c7c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将看到HeartBeatMessage显示为<em class="mm">“我们的副本集配置无效或不包括我们”</em>，并且还将观察到<code class="fe mn mo mp mq b">syncSourceId</code>为负，并且<code class="fe mn mo mp mq b">syncingTo</code>属性值为空。</p><h1 id="ed86" class="ms lh iq bd li mt mu mv ll mw mx my lo mz na nb lr nc nd ne lu nf ng nh lx ni bi translated">2.这个计划</h1><p id="8742" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们需要将副本集恢复到健康状态，并且所有mongo实例都应该正确同步。首先请检查所有网络连接是否正常工作。确保拥有MongoDB副本的机器可以相互通信。</p><p id="a095" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">简单地说，我们要做的是，<br/> <em class="mm">从副本集中删除特定的容易出错的MongoDB实例，并相应地重新添加它。同时，您必须允许成员通过删除特定节点的数据文件夹来正确地重新同步。</em></p><p id="a0e3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我的例子中，数据库不是太大，因此删除数据文件夹效果很好。但是，当您的数据库太大时，您可以从另一台正确同步的辅助机器上复制数据文件夹。</p><h1 id="df08" class="ms lh iq bd li mt mu mv ll mw mx my lo mz na nb lr nc nd ne lu nf ng nh lx ni bi translated">3.遵循步骤</h1><p id="6dc3" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><strong class="kf ir">第一步</strong></p><p id="aa45" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">识别具有损坏的副本集成员的机器。</p><p id="3947" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">第二步</strong></p><p id="07c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在特定节点停止mongodb pod。</p><p id="d310" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当mongodb pod在特定节点上运行时，您不能删除节点的数据文件夹。因此，您必须停止该特定节点中的mongodb pod。这是一个棘手的情况，因为您仍然要删除pod，因为Kubernetes会自动重启pod来维护副本的数量。</p><p id="187c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了避免创建pod，您可以按照对mongodb实例进行限制的方式来标记pod。</p><p id="c48d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如:我的节点标有<code class="fe mn mo mp mq b">database=yes</code>，只有这些节点被用来创建mongodb pods。我将受损节点的标签更改为<code class="fe mn mo mp mq b">databse-</code>,这样这个节点就没有资格使用mongodb pods。</p><p id="6f2f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设<code class="fe mn mo mp mq b">worker1</code>是具有易错副本集成员<code class="fe mn mo mp mq b">mongo-3</code>的节点。</p><p id="d1b7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mn mo mp mq b">kubectl label node worker1 database-</code></p><p id="3029" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mn mo mp mq b">kubectl delete pod mongo-3</code></p><p id="2755" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将避免Kubernetes在特定的节点中制作mongodb pod。请注意，标签名称取决于您的应用程序设置。</p><p id="0829" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">第三步</strong></p><p id="4184" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">删除数据文件夹。这将允许从头开始重新同步您的节点。</p><p id="d960" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">第四步</strong></p><p id="53f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从副本集中删除成员</p><p id="c18b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mn mo mp mq b"><em class="mm">kubectl exec -it podname mongo<br/>use admin<br/>db.auth(“ username ”, “ password ”)</em></code></p><p id="d067" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mn mo mp mq b">rs.remove(‘mongo-3:27017”)</code></p><p id="2c77" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">第五步</strong></p><p id="b397" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">恢复正确的标签并允许pod启动。请注意，标签名称取决于您的场景。</p><p id="8d9a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mn mo mp mq b">kubectl label node worker1 database=yes</code></p><p id="01a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在mongo pod应该再次在这个节点中创建</p><p id="7914" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">第六步</strong></p><p id="93a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">重新添加replicatet成员。在此步骤中，请根据您的senario使用正确的属性。</p><p id="e5c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mn mo mp mq b">rs.add({_id:3 host: “mongo-3:27017”})</code></p><pre class="lc ld le lf gt nj mq nk nl aw nm bi"><span id="ec49" class="lg lh iq mq b gy nn no l np nq">rs.reconfig(rs.config(),{force:true})</span></pre><p id="8f88" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在你损坏的mongo节点应该再次启动并尝试同步。在几分钟内，你会看到这是一个秒变和同步源满足。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="7c00" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当<code class="fe mn mo mp mq b">rs.config()</code>中有两个损坏的副本集成员时，照原样执行前2步，然后一次移除两个成员。然后一个接一个地执行剩下的过程。启动一个节点的mongo，并将其添加到<code class="fe mn mo mp mq b">rs.config()</code>中，然后等待一段时间，直到它的状态变为Secondary。然后按照第二个节点的步骤操作。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/76c1838b065dc6d297ddb5394975555c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sxgzAdaAoKwLwLjV2L6Vpg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">恩库鲁列科·马亚涅在<a class="ae kc" href="https://unsplash.com/s/photos/replica?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="5853" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我处理<code class="fe mn mo mp mq b">Our replica set configuration is invalid or does not include us</code>的方式，在整个过程之后，我的复制集状态变得正常而健康。</p><p id="d86b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你知道任何其他方法来解决这个问题或任何逻辑原因，请让我知道作为回应。</p><p id="de40" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">谢谢你</p></div></div>    
</body>
</html>