<html>
<head>
<title>Beanstalk Multicontainer Docker logs to Cloudwatch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Beanstalk多容器Docker日志到Cloudwatch</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/beanstalk-multicontainer-docker-logs-to-cloudwatch-26c10fd9e74d?source=collection_archive---------16-----------------------#2020-06-29">https://levelup.gitconnected.com/beanstalk-multicontainer-docker-logs-to-cloudwatch-26c10fd9e74d?source=collection_archive---------16-----------------------#2020-06-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ced5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何从Beanstalk获取Stdouterr日志到Cloudwatch</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d4a39afcf339381fb0fa3cfc6b52d0ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*69eKClDWK47hjp0Am4UVjw.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">流向云端…哈哈。|图片来自<a class="ae ky" href="https://pixabay.com/de/users/cowins-822708/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=679014" rel="noopener ugc nofollow" target="_blank"> Alex Hu </a></figcaption></figure><p id="b87a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">日志——它们对于监控和调试应用程序至关重要，尤其是在生产环境中。</p><p id="8b5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将探索如何将日志从<em class="lv">AWS Elastic Beanstalk</em><strong class="lb iu">multi container Docker平台</strong>传输到<em class="lv">亚马逊的Cloudwatch </em>。</p><p id="56dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不幸的是，有点令人惊讶的是，在<em class="lv"> Cloudwatch </em>中检索您的Beanstalk应用程序的日志令人困惑，并且不能像在其他Beanstalk应用程序平台上那样开箱即用。<em class="lv">至少截至目前；AWS可能正在做一些事情来解决这个问题。</em></p><h2 id="289c" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">TL；速度三角形定位法(dead reckoning)</h2><p id="97f0" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">如果您只是在搜索立即修复问题的<strong class="lb iu">配置</strong>，请跳到<a class="ae ky" href="#a7e4" rel="noopener ugc nofollow">本节</a>。<br/>或者看看这篇文章的完整<a class="ae ky" href="https://github.com/SlootSantos/medium-beanstalk-logs-cloudwatch" rel="noopener ugc nofollow" target="_blank">代码。</a></p><h2 id="b618" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">我们要看的是</h2><ul class=""><li id="dd97" class="mu mv it lb b lc mp lf mq li mw lm mx lq my lu mz na nb nc bi translated"><a class="ae ky" href="#ffcf" rel="noopener ugc nofollow">使用Terraform </a>设置示例Beanstalk应用&amp;环境</li><li id="c955" class="mu mv it lb b lc nd lf ne li nf lm ng lq nh lu mz na nb nc bi translated"><a class="ae ky" href="#ef66" rel="noopener ugc nofollow">通过<em class="lv">docker run . AWS . JSON</em>T24】部署Nginx</a></li><li id="486d" class="mu mv it lb b lc nd lf ne li nf lm ng lq nh lu mz na nb nc bi translated"><a class="ae ky" href="#1e76" rel="noopener ugc nofollow">在Beanstalk上启用日志流</a></li><li id="fa32" class="mu mv it lb b lc nd lf ne li nf lm ng lq nh lu mz na nb nc bi translated"><a class="ae ky" href="#a7e4" rel="noopener ugc nofollow">流式传输<strong class="lb iu">stdouter</strong>使用ebextension </a></li><li id="78d7" class="mu mv it lb b lc nd lf ne li nf lm ng lq nh lu mz na nb nc bi translated"><a class="ae ky" href="#cdef" rel="noopener ugc nofollow">验证…多田🧚‍♂️ </a></li><li id="99ce" class="mu mv it lb b lc nd lf ne li nf lm ng lq nh lu mz na nb nc bi translated"><a class="ae ky" href="#e356" rel="noopener ugc nofollow">故障排除</a></li></ul><h2 id="ffcf" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">开始之前</h2><p id="55a2" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">按照本文，我建议创建一个新的空目录，您可以在其中创建我们将在下面使用的所有文件。名称和格式完全由您决定:)</p><h2 id="df6b" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">AWS弹性豆茎设置</h2><p id="4403" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">出于演示目的，我们将在Beanstalk中创建一个示例应用程序和环境。</p><blockquote class="ni nj nk"><p id="b250" class="kz la lv lb b lc ld ju le lf lg jx lh nl lj lk ll nm ln lo lp nn lr ls lt lu im bi translated"><strong class="lb iu">注</strong>:如果您已经有一个应用程序在运行，只需跳过这一部分，继续执行<a class="ae ky" href="http://ada" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">启用日志流</strong> </a>。</p></blockquote><p id="7175" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在这里使用这个Terraform模板，或者自己在AWS控制台中配置应用程序。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><h2 id="ef66" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">使用Nginx的Dockerrun.aws.json示例</h2><p id="e5b9" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">同样，你可以按照我提供的例子图片或者使用你自己的Docker图片。</p><p id="ab6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将使用打印日志到<strong class="lb iu"><em class="lv"/></strong>的官方Nginx图像。</p><p id="7186" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是Beanstalk用来配置多容器平台的<em class="lv"> Dockerrun.aws.json </em>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="28d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要上传这个JSON配置，最好使用Beanstalk UI。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/9ac8268be3319dfa70e19c1f04440637.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L4G95wneS93SFU1o_gzEMA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Beanstalk环境&gt;“上传和部署”</figcaption></figure><p id="450b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击<em class="lv">展开</em>并等待大约一分钟。</p><p id="4ba8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当导航到您的环境URL时，例如<a class="ae ky" href="http://streamingtest-env.eba-iam93mfy.us-east-1.elasticbeanstalk.com/" rel="noopener ugc nofollow" target="_blank">streaming test-env . EBA-iam 93 mfy . us-east-1 . elastic beanstalk . com</a>，您应该会看到默认的Nginx登录页面。</p><h2 id="1e76" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">启用日志流</h2><p id="8d24" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">如果流配置没有正确设置，或者如果<a class="ae ky" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html" rel="noopener ugc nofollow" target="_blank">实例概要文件</a>没有足够的权限访问服务，您的应用程序将不会向Cloudwatch传输任何内容。</p><blockquote class="ni nj nk"><p id="1408" class="kz la lv lb b lc ld ju le lf lg jx lh nl lj lk ll nm ln lo lp nn lr ls lt lu im bi translated"><strong class="lb iu">注意</strong>:如果您使用了Terraform模板，您已经准备好了。您可以跳过这一部分。</p></blockquote><p id="8125" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要检查环境是否可以传输日志，请转到Beanstalk环境日志记录设置页面<em class="lv">(位于“配置”&gt;“软件”)。</em>查看<em class="lv">日志流</em>下的<em class="lv">启用</em>复选框是否勾选，如果没有勾选则勾选。点击<em class="lv">应用</em>保存您的更改。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/d98b7f6e60065678f886df9f53ca7662.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DBZaU6f2FqnfWE5VtDnL9w.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Beanstalk环境&gt;配置&gt;软件</figcaption></figure><p id="fa40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Cloudwatch服务的<em class="lv">日志组</em>下，您将看到这个Beanstalk环境的日志组。然而，在这些日志组中，你都不会在这个环境中找到你的容器的外部。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/9a3d7951989d26307ea43bb74a9902cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t8mAwsOYDmlKHRsxkq-FZQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">云观察&gt;日志组</figcaption></figure><h2 id="a7e4" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">将StdoutErr流式传输到Cloudwatch</h2><p id="6698" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">要将非默认日志流式传输到Cloudwatch，<strong class="lb iu">我们必须使用</strong><a class="ae ky" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebextensions.html" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu"><em class="lv">EB extensions</em></strong></a><strong class="lb iu">；</strong>没有其他方法可以对日志进行流式处理。</p><p id="a943" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我们必须在应用程序的源目录中创建一个新文件夹。这个文件夹必须命名为<em class="lv">。ebextensions </em>并在里面创建一个名为<em class="lv"> log.config </em>的文件，内容如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><blockquote class="ni nj nk"><p id="8326" class="kz la lv lb b lc ld ju le lf lg jx lh nl lj lk ll nm ln lo lp nn lr ls lt lu im bi translated">注意:由于配置是YAML，我建议验证缩进。这个验证器完成这项工作。</p></blockquote><p id="a3d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了适应您的定制应用程序的这种配置，您需要更改Cloudwatch日志组名称</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="8cb5" class="lw lx it nu b gy ny nz l oa ob">log_group_name=/aws/elasticbeanstalk/<strong class="nu iu">StreamingTest-env</strong>/docker-stdout</span></pre><p id="de68" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以及您在<em class="lv"> Dockerrun.aws.json </em>中为容器映像定义的容器名</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="edbe" class="lw lx it nu b gy ny nz l oa ob">file=/var/log/containers/<strong class="nu iu">nginx</strong>-*-stdouterr.log</span></pre><h2 id="cdef" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">最后，上传配置和ebextensions</h2><p id="844b" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">之前，我们只上传了<em class="lv"> Dockerrun.aws.json </em>配置文件。但是，为了让日志配置在Beanstalk环境中生效，我们必须上传配置和新的ebextensions文件夹。</p><p id="ec2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，Beanstalk也接受ZIP文件。因此，我们可以将所有需要的配置压缩在一起，并直接上传到Beanstalk。</p><p id="3797" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的应用程序目录中，执行zip命令:</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="a2fe" class="lw lx it nu b gy ny nz l oa ob">zip -r app.zip .ebextensions/ Dockerrun.aws.json</span></pre><p id="c650" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后使用与前面相同的<em class="lv">上传和部署</em>文件上传将结果ZIP文件上传到Beanstalk环境。</p><p id="88a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再给它一分钟来部署新版本，然后前往Cloudwatch。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/d25d69027dbcd528048db5703508e17d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wUbWBrPKu4eONCsikp_DLQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">云观察&gt;日志组</figcaption></figure><p id="b717" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们期待已久的Stdouterr日志输出🎉。<br/>当读取流时，您应该看到一串Nginx启动输出或者来自您的自定义应用程序的<strong class="lb iu"> Stdout </strong>。</p><h2 id="e356" class="lw lx it bd ly lz ma dn mb mc md dp me li mf mg mh lm mi mj mk lq ml mm mn mo bi translated">解决纷争</h2><p id="4eec" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated"><strong class="lb iu">权限<br/> </strong>您遇到的最可能的问题是缺少Beanstalk用来执行应用程序的<em class="lv"> IAM </em>角色的权限。<br/>角色必须有权限<a class="ae ky" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/AWSHowTo.cloudwatchlogs.html#AWSHowTo.cloudwatchlogs.prereqs" rel="noopener ugc nofollow" target="_blank">在Cloudwatch </a>中放置和创建流。</p><p id="7441" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了验证您的角色策略，您首先必须弄清楚哪个角色用于特定的环境。在您的Beanstalk环境中，转到<em class="lv">配置&gt;安全</em>并搜索标签为<strong class="lb iu"> <em class="lv"> IAM实例概要的下拉列表。</em>T24】</strong></p><blockquote class="ni nj nk"><p id="83c5" class="kz la lv lb b lc ld ju le lf lg jx lh nl lj lk ll nm ln lo lp nn lr ls lt lu im bi translated"><strong class="lb iu">注意</strong>:您需要的是<strong class="lb iu"> <em class="it">而不是</em> </strong>的“服务角色”</p></blockquote><p id="a4d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">记住这个角色名称，跳到<strong class="lb iu"> AWS IAM服务</strong>并在仪表板上搜索<strong class="lb iu">角色</strong>选项卡</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/7915874ebdb6dd55d93c7fcd60111474.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YrgusDlL3iASBlTz04UDkg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">IAM服务仪表板</figcaption></figure><p id="4a40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在roles选项卡中，搜索您在Beanstalk配置中找到的角色名称，单击该角色，并检查附加的策略。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/fd2d536e8bf7052e1068c4f9b8ab4f95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7xsc2sOvaxW6Q2Vj7_ehtw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">IAM &gt;角色&gt;您的角色名称&gt;权限</figcaption></figure><p id="faf3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的角色碰巧没有附加任何Cloudwatch策略，只需使用<em class="lv"> Attach policies </em>按钮添加它们。</p><blockquote class="ni nj nk"><p id="fa74" class="kz la lv lb b lc ld ju le lf lg jx lh nl lj lk ll nm ln lo lp nn lr ls lt lu im bi translated"><strong class="lb iu">注意</strong>:如果你要在生产中使用它，你会想要限制你的应用程序拥有的权限，而不是给它一个服务<strong class="lb iu"> <em class="it">完全访问</em> </strong>策略</p></blockquote><p id="7486" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">容器名称<br/> </strong>确保更改为<em class="lv">中的名称。ebextensions/log.config </em>文件来匹配您的容器名。</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="1dbc" class="lw lx it nu b gy ny nz l oa ob">file=/var/log/containers/<strong class="nu iu">CONTAINER_NAME</strong>-*-stdouterr.log</span></pre><p id="aacf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">应用平台<br/> </strong>你可能正在使用单集装箱码头平台。如果是这种情况，您仍然可以使用完全相同的配置传输日志，但是，服务器上日志文件的路径会有所不同，并且更接近</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="4dd0" class="lw lx it nu b gy ny nz l oa ob">file=/var/log/eb-docker/containers/eb-current-app/stdouterr.log</span></pre><p id="e86d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="lv">如果还有什么不适合你的，请告诉我！简单地回复这篇文章，我会尽力帮助你！</em> </strong>😊</p></div></div>    
</body>
</html>