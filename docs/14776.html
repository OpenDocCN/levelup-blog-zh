<html>
<head>
<title>How I use BigQuery Analytic Functions as a Data Scientist</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">作为一名数据科学家，我如何使用BigQuery分析函数</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-i-use-bigquery-analytic-functions-as-a-data-scientist-d8d662fd6c97?source=collection_archive---------11-----------------------#2022-12-23">https://levelup.gitconnected.com/how-i-use-bigquery-analytic-functions-as-a-data-scientist-d8d662fd6c97?source=collection_archive---------11-----------------------#2022-12-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/fdef030b007ca213d75fe0c168482e61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2JIEayd21JBGJw50ew7weQ.jpeg"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">照片由<a class="ae jg" href="https://unsplash.com/@lilzidesigns?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> lilzidesigns </a>拍摄</figcaption></figure><div class=""/><div class=""><h2 id="15cb" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">如何在BigQuery中使用高级SQL进行分析的实例</h2></div><p id="24dc" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我使用BigQuery已经3年多了，所以我认为是时候分享一下我在作为一名数据科学家的日常工作中是如何使用它最强大的功能之一——分析功能(或者也称为窗口功能)的了。</p><p id="b5fe" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了让您了解这个工具有多有用，您可以使用分析函数计算移动平均值、排列项目列表、计算累积和，以及执行其他非常有用和更复杂的分析，所有这些都直接来自BigQuery。</p><p id="4a4b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你想了解更多关于分析函数调用如何工作的细节，我建议你查阅官方的<a class="ae jg" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/window-function-calls" rel="noopener ugc nofollow" target="_blank">文档</a>，否则在下一节中，我将带你浏览一些我经常遇到的真实用例，这将帮助你开始！</p><h1 id="b260" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">使用案例和示例</h1><h2 id="0347" class="mm lv jj bd lw mn mo dn ma mp mq dp me lh mr ms mg ll mt mu mi lp mv mw mk mx bi translated">1.查找每个Youtube频道的前5个视频</h2><p id="ba05" class="pw-post-body-paragraph ky kz jj la b lb my kk ld le mz kn lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">假设您处理Youtube数据，并且可以访问每个视频占一行的表格。对于每一个视频，你也可以得到它的总浏览量和它属于哪个频道。这是一张桌子的样本</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nd"><img src="../Images/6c1ac9d819e769510083c60318cab0a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e0vLlcUCerUZZ-PNVJIS4A.png"/></div></div></figure><p id="702c" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">分析范围:</strong></p><blockquote class="ni"><p id="f6b2" class="nj nk jj bd nl nm nn no np nq nr lt dk translated">现在，你的利益相关者走到你面前，问你“你能帮我找到每个频道的前5个视频(基于他们的总浏览量)吗？”</p></blockquote><p id="a02e" class="pw-post-body-paragraph ky kz jj la b lb ns kk ld le nt kn lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated"><strong class="la jk">解决方案:</strong>通过使用解析函数<code class="fe nx ny nz oa b">ROW_NUMBER()</code>，我们可以根据<code class="fe nx ny nz oa b">view_count</code>为每个<code class="fe nx ny nz oa b">channel_id</code> <em class="ob">给每一行一个排名。</em></p><pre class="ne nf ng nh gt oc oa od bn oe of bi"><span id="9149" class="og lv jj oa b be oh oi l oj ok">ROW_NUMBER() OVER (PARTITION BY channel_id ORDER BY view_count DESC)</span></pre><p id="dde9" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是完整的SQL语句:</p><pre class="ne nf ng nh gt oc oa od bn oe of bi"><span id="fea9" class="og lv jj oa b be oh oi l oj ok">SELECT<br/>  *<br/>FROM table<br/>-- Here is the solution<br/>-- We use the QUALIFY clause to filter the results of the window function<br/>QUALIFY ROW_NUMBER() OVER (PARTITION BY channel_id ORDER BY view_count DESC) &lt;= 5</span></pre><h2 id="e883" class="mm lv jj bd lw mn mo dn ma mp mq dp me lh mr ms mg ll mt mu mi lp mv mw mk mx bi translated">2.获取每个客户可用的最新订阅数据</h2><p id="1dc5" class="pw-post-body-paragraph ky kz jj la b lb my kk ld le mz kn lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">假设您有一个包含订阅数据的表，但是每次以某种方式更新订阅时，都会创建一个新行。这是一张桌子的样本</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ol"><img src="../Images/c2efc33cfd72dfd403eaea703e4c8058.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NuxyRHu1wrDtgU9rOLV16w.png"/></div></div></figure><p id="8dc3" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">分析范围:</strong></p><blockquote class="ni"><p id="ce79" class="nj nk jj bd nl nm nn no np nq nr lt dk translated">有人问你，“你能告诉我我们的活跃用户中有百分之多少是每月会员吗？”。</p><p id="90f5" class="nj nk jj bd nl nm nn no np nq nr lt dk translated">当然，在你开始计算你的用户的“计费频率”分布之前，你必须确保你只考虑了每个用户可用的最新的订阅数据</p></blockquote><p id="ac47" class="pw-post-body-paragraph ky kz jj la b lb ns kk ld le nt kn lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated"><strong class="la jk">解决方案:</strong>通过使用解析函数<code class="fe nx ny nz oa b">ROW_NUMBER()</code>，我们可以根据每个<code class="fe nx ny nz oa b">subscription_id</code> <em class="ob">的<code class="fe nx ny nz oa b">last_update_date</code>给每一行一个排名。</em></p><pre class="ne nf ng nh gt oc oa od bn oe of bi"><span id="426f" class="og lv jj oa b be oh oi l oj ok">ROW_NUMBER() OVER (PARTITION BY subscription_id ORDER BY last_update_date)</span></pre><pre class="om oc oa od bn oe of bi"><span id="3bf9" class="og lv jj oa b be oh oi l oj ok">SELECT<br/>  *<br/>FROM table<br/>-- Here is the solution<br/>-- We use the QUALIFY clause to filter the results of the window function<br/>QUALIFY ROW_NUMBER() OVER (PARTITION BY subscription_id ORDER BY last_update) = 1</span></pre><h2 id="a4a1" class="mm lv jj bd lw mn mo dn ma mp mq dp me lh mr ms mg ll mt mu mi lp mv mw mk mx bi translated">3.计算累计收入，同时保留每月收入</h2><p id="27f7" class="pw-post-body-paragraph ky kz jj la b lb my kk ld le mz kn lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">假设您有公司的月度收入数据。每月产生的收入占一行。这是一张桌子的样本</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div class="gh gi on"><img src="../Images/a48676d9024fb60a301aa18ea929ff39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*8_p0CUhTzksxRpRoNtFRZw.png"/></div></figure><p id="ad40" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">分析范围:</strong></p><blockquote class="ni"><p id="efbd" class="nj nk jj bd nl nm nn no np nq nr lt dk translated">你的利益相关者问你“你能展示一个比较月收入和累计收入的图表吗？”</p></blockquote><p id="e7e7" class="pw-post-body-paragraph ky kz jj la b lb ns kk ld le nt kn lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated"><strong class="la jk">解决方案:</strong>使用<code class="fe nx ny nz oa b">SUM()</code>和<code class="fe nx ny nz oa b">ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code> <strong class="la jk"> </strong>来合计从分区的第一行到当前行的收入，这将计算到可用的每个点的总收入。</p><pre class="ne nf ng nh gt oc oa od bn oe of bi"><span id="373c" class="og lv jj oa b be oh oi l oj ok">SUM(revenue) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)</span></pre><p id="fc4a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是完整的SQL语句:</p><pre class="ne nf ng nh gt oc oa od bn oe of bi"><span id="b5ad" class="og lv jj oa b be oh oi l oj ok">SELECT<br/>  date,<br/>  revenue,<br/>  -- Here is the solution<br/>  SUM(revenue) OVER (<br/>    ORDER BY date<br/>    ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW<br/>  ) AS total_revenue<br/>FROM table</span></pre><h2 id="6a66" class="mm lv jj bd lw mn mo dn ma mp mq dp me lh mr ms mg ll mt mu mi lp mv mw mk mx bi translated">4.找到每个用户在每个平台上第一次和最后一次活动的时间</h2><p id="6989" class="pw-post-body-paragraph ky kz jj la b lb my kk ld le mz kn lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">假设您有每个用户的活动数据。用户可以在桌面或移动设备上活动。</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oo"><img src="../Images/5110023fd2cff0ba9312ededf1ccaaf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GLS2d-8aMR_oN4P3SFlUPQ.png"/></div></div></figure><p id="88ce" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">分析范围:</strong></p><blockquote class="ni"><p id="dda1" class="nj nk jj bd nl nm nn no np nq nr lt dk translated">您的利益相关者找到您，要求您汇总每个用户的活动，以及他们在每个平台上第一次和最后一次活动的时间。</p></blockquote><p id="478f" class="pw-post-body-paragraph ky kz jj la b lb ns kk ld le nt kn lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated"><strong class="la jk">解决方案:</strong>使用<code class="fe nx ny nz oa b">MIN()</code>和<code class="fe nx ny nz oa b">MAX()</code>分别找到每个<code class="fe nx ny nz oa b">platform</code>内每个<code class="fe nx ny nz oa b">user_id</code>的第一个和最后一个日期。</p><pre class="ne nf ng nh gt oc oa od bn oe of bi"><span id="91d4" class="og lv jj oa b be oh oi l oj ok">MIN(activity_date) OVER (PARTITION BY platform, user_id)</span></pre><p id="0706" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是完整的SQL语句:</p><pre class="ne nf ng nh gt oc oa od bn oe of bi"><span id="116f" class="og lv jj oa b be oh oi l oj ok">SELECT<br/>  activity_date,<br/>  platform,<br/>  user_id,<br/>  SUM(plays) AS total_plays,<br/>  SUM(downloads) AS total_downloads,<br/>  -- Here is the solution<br/>  MIN(activity_date) OVER (PARTITION BY platform, user_id) AS first_activity_date,<br/>  MAX(activity_date) OVER (PARTITION BY platform, user_id) AS last_activity_date,<br/>FROM table<br/>GROUP BY 1, 2, 3</span></pre><h2 id="cdf2" class="mm lv jj bd lw mn mo dn ma mp mq dp me lh mr ms mg ll mt mu mi lp mv mw mk mx bi translated">5.计算月环比收入增长</h2><p id="45b0" class="pw-post-body-paragraph ky kz jj la b lb my kk ld le mz kn lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">假设您有一个包含月收入数据的表。这是一个数据样本</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div class="gh gi on"><img src="../Images/a48676d9024fb60a301aa18ea929ff39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*8_p0CUhTzksxRpRoNtFRZw.png"/></div></figure><p id="9b4f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">分析范围:</strong></p><blockquote class="ni"><p id="68ef" class="nj nk jj bd nl nm nn no np nq nr lt dk translated">你的利益相关者走近你，问你“在给定的时间段内，公司的销售收入增长情况如何，比如年同比？”</p></blockquote><p id="9ddd" class="pw-post-body-paragraph ky kz jj la b lb ns kk ld le nt kn lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated"><strong class="la jk">解决方案:</strong>使用<code class="fe nx ny nz oa b">LAG()</code>来帮助查找前一行的收入，在本例中是上个月的收入。</p><pre class="ne nf ng nh gt oc oa od bn oe of bi"><span id="c282" class="og lv jj oa b be oh oi l oj ok">LAG(revenue) OVER (ORDER BY date ASC) AS prev_month_revenue</span></pre><p id="d793" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是完整的SQL语句:</p><pre class="ne nf ng nh gt oc oa od bn oe of bi"><span id="496f" class="og lv jj oa b be oh oi l oj ok">WITH<br/>find_last_month_revenue AS (<br/>  SELECT<br/>    date,<br/>    revenue,<br/>    -- Use LAG() to help find the previous month revenue<br/>    LAG(revenue) OVER (ORDER BY date ASC) AS last_month_revenue<br/>  FROM table<br/>)<br/>SELECT<br/>  date,<br/>  revenue,<br/>  -- Apply Growth Rate formula<br/>  ((revenue - last_month_revenue)/last_month_revenue) * 100 AS growth_rate<br/>FROM find_last_month_revenue</span></pre><p id="7149" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">希望这个指南有用，如果你有任何想法或问题，请在下面的评论中留下:)</p><p id="1633" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">另外，如果你希望支持我成为一名作家，可以考虑<a class="ae jg" href="https://medium.com/@avourakis/membership" rel="noopener">注册成为一名灵媒成员</a>。</p></div></div>    
</body>
</html>