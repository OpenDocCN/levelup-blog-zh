<html>
<head>
<title>How to Access and Query Your Google BigQuery Data Using Python and R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Python和R访问和查询您的Google BigQuery数据</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-access-and-query-your-google-bigquery-data-using-python-and-r-e5a3f65042c7?source=collection_archive---------3-----------------------#2021-05-05">https://levelup.gitconnected.com/how-to-access-and-query-your-google-bigquery-data-using-python-and-r-e5a3f65042c7?source=collection_archive---------3-----------------------#2021-05-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3aa4a09ff39cc61cf288ba4b08b0454f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_V3-x77YJHrTjunu.png"/></div></div></figure><h1 id="8fd2" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">概观</h1><p id="827c" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在本文中，我们将看到如何使用Python和R加载Google BigQuery数据，然后查询数据以获得有用的见解。我们利用<a class="ae lu" href="https://rudderstack.com/integration/gcp-storage/" rel="noopener ugc nofollow" target="_blank"> Google Cloud BigQuery </a>库来连接BigQuery Python，而<a class="ae lu" href="https://github.com/r-dbi/bigrquery" rel="noopener ugc nofollow" target="_blank">big query</a>库用于对r做同样的事情</p><p id="3308" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">我们还研究了使用Python/R操作BigQuery数据的两个步骤:</p><ul class=""><li id="4c52" class="ma mb iq ky b kz lv ld lw lh mc ll md lp me lt mf mg mh mi bi translated">连接到Google BigQuery并访问数据</li><li id="7233" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">使用Python/R查询数据</li></ul><blockquote class="mo mp mq"><p id="491b" class="kw kx mr ky b kz lv lb lc ld lw lf lg ms lx lj lk mt ly ln lo mu lz lr ls lt ij bi translated"><em class="iq">在本帖中，我们假设您将所有客户数据都存储在Google BigQuery中。</em></p><p id="375f" class="kw kx mr ky b kz lv lb lc ld lw lf lg ms lx lj lk mt ly ln lo mu lz lr ls lt ij bi translated"><em class="iq">如果您有兴趣了解如何将数据源中的数据实时导入到Google BigQuery等工具和其他数据仓库解决方案中，您应该探索一下</em> <a class="ae lu" href="https://rudderstack.com" rel="noopener ugc nofollow" target="_blank"> <em class="iq">客户数据基础设施工具，如RudderStack </em> </a> <em class="iq">。</em></p></blockquote><h1 id="52fb" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">计算机编程语言</h1><p id="7b67" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Python是最广泛使用的通用编程语言之一。由于其易用性和灵活性，它获得了很多关注和欢迎。</p><p id="0d5f" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">许多工程师和数据科学团队也更喜欢Python，因为他们可以使用大量的库和工具来连接其他第三方系统以操作数据。</p><h1 id="3c02" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">用Python连接Google BigQuery</h1><p id="6dab" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">为了使用Python查询您的Google BigQuery数据，我们需要将Python客户端连接到我们的BigQuery实例。我们使用Google BigQuery API的云客户端库来实现这一点。您也可以选择使用任何其他第三方选项来连接BigQuery和Python由<em class="mr"> tylertreat </em>开发的<a class="ae lu" href="https://github.com/tylertreat/BigQuery-Python" rel="noopener ugc nofollow" target="_blank"> BigQuery-Python库</a>也是一个不错的选择。</p><p id="0471" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">我们使用Google Cloud BigQuery库，因为它是稳定的，并且得到了Google的官方支持。</p><blockquote class="mo mp mq"><p id="ec89" class="kw kx mr ky b kz lv lb lc ld lw lf lg ms lx lj lk mt ly ln lo mu lz lr ls lt ij bi translated">对于这篇文章，我们假设你已经建立了一个Python开发环境。如果没有，我们强烈推荐你参考 <a class="ae lu" href="https://cloud.google.com/python/setup" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Python开发环境设置指南</em> </a> <em class="iq">。</em></p></blockquote><p id="9c1f" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">要安装库，请从终端运行以下命令:</p><p id="6dc0" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><code class="fe mv mw mx my b">pip install --upgrade google-cloud-bigquery</code></p><p id="2410" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">接下来，我们将客户端连接到数据库。为此，您需要下载一个包含BigQuery服务帐户凭证的JSON文件。如果您没有服务帐户，<a class="ae lu" href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" rel="noopener ugc nofollow" target="_blank">按照这个指南创建一个</a>，然后继续下载JSON文件到您的本地机器。</p><p id="0f9b" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">现在我们已经设置好了一切，我们继续初始化连接。以下Python代码用于实现这一目的:</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="4889" class="nh jz iq my b gy ni nj l nk nl">rom google.cloud import bigquery<br/>from google.oauth2 import service_account<br/>credentials = service_account.Credentials.from_service_account_file(<br/>'path/to/file.json')<br/><br/>project_id = 'my-bq'<br/>client = bigquery.Client(credentials= credentials,project=project_id)</span></pre><p id="ca1a" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">在上面的代码片段中，您需要指定JSON密钥文件的和位置，方法是将<code class="fe mv mw mx my b"><strong class="ky ir">'path/to/file.json'</strong></code>替换为本地存储的JSON文件的实际路径。</p><blockquote class="mo mp mq"><p id="2a32" class="kw kx mr ky b kz lv lb lc ld lw lf lg ms lx lj lk mt ly ln lo mu lz lr ls lt ij bi translated"><em class="iq">在Google BigQuery中，该项目是一个顶级容器，并提供跨所有数据集的默认访问控制。</em></p></blockquote><h1 id="9f78" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">使用Python对BigQuery数据执行查询</h1><p id="f3cd" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">既然我们已经设置了BigQuery客户机并准备好使用，我们就可以对BigQuery数据集执行查询了。</p><p id="1793" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">为此，我们使用query方法，它将一个查询作业插入到BigQuery队列中。然后异步执行这些查询——也就是说，我们不指定任何超时，客户机等待作业完成。作业一完成，该方法就返回一个包含结果的<code class="fe mv mw mx my b">Query_Job</code>实例。</p><p id="bd37" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">关于这种方法如何工作的更多细节，请参考官方文档<a class="ae lu" href="https://googlecloudplatform.github.io/google-cloud-python/latest/bigquery/reference.html#google.cloud.bigquery.job.QueryJob" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="e7ac" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">所需的Python代码如下:</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="d1bc" class="nh jz iq my b gy ni nj l nk nl">query_job = client.query("""<br/>   SELECT *<br/>   FROM dataset.my_table<br/>   LIMIT 1000 """)<br/><br/>results = query_job.result() # Wait for the job to complete.</span></pre><p id="2e8c" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">请注意，上面的查询默认使用标准的SQL语法。如果您希望使用遗留SQL，请使用下面的代码:</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="b4da" class="nh jz iq my b gy ni nj l nk nl">job_config.use_legacy_sql = True<br/>query_job = client.query("""<br/>   SELECT *<br/>   FROM dataset.my_table<br/>   LIMIT 1000""", job_config = job_config)<br/><br/>results = query_job.result() # Wait for the job to complete.</span></pre><h1 id="3125" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">稀有</h1><p id="6241" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">r是许多数据科学家和工程师使用的Python的流行替代品。如果详细的、有条理的统计数据分析是你的目标，那么很少有语言像r一样好。</p><p id="e4f8" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">当使用Google BigQuery时，R too提供了一个健壮且易于使用的库来进行数据操作和查询。在这篇文章中，我们使用了由首席科学家Hadley Wickham创建和维护的库。</p><p id="fb4c" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">对于本节，我们假设您已经建立了R开发环境。如果没有，您可以随时<a class="ae lu" href="https://rstudio-education.github.io/hopr/starting.html" rel="noopener ugc nofollow" target="_blank">按照本</a> <a class="ae lu" href="https://rstudio-education.github.io/hopr/starting.html" rel="noopener ugc nofollow" target="_blank">指南</a>设置RStudio。</p><h1 id="edee" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">用R连接到Google BigQuery</h1><p id="3479" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">为了安装bigrquery，我们在R控制台中运行以下命令:</p><p id="7778" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><code class="fe mv mw mx my b">install.packages("bigrquery")</code></p><p id="2e70" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">就是这样！我们准备好了。</p><p id="4ad9" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">与Python一样，我们需要授权我们的R客户机访问Google云服务。根据bigrquery的<a class="ae lu" href="https://github.com/r-dbi/bigrquery#authentication-and-authorization" rel="noopener ugc nofollow" target="_blank">文档</a>，我们将按照R控制台中的提示打开授权URL并将代码复制到控制台中。</p><blockquote class="mo mp mq"><p id="2cf6" class="kw kx mr ky b kz lv lb lc ld lw lf lg ms lx lj lk mt ly ln lo mu lz lr ls lt ij bi translated"><em class="iq">注意，这个授权只需要做一次。后续请求将自动刷新访问凭证。</em></p></blockquote><h1 id="b89a" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">用R对BigQuery数据执行查询</h1><p id="c7b6" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">要使用R对BigQuery数据执行查询，我们将遵循以下步骤:</p><ul class=""><li id="5f6a" class="ma mb iq ky b kz lv ld lw lh mc ll md lp me lt mf mg mh mi bi translated">从Google Cloud控制台指定项目ID，就像我们使用Python一样。</li><li id="0c86" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">形成查询字符串来查询数据。</li><li id="4081" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">用您的项目ID和查询字符串调用<code class="fe mv mw mx my b">query_exec</code>。</li></ul><p id="1ee3" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">实现这一点的代码如下:</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="1e50" class="nh jz iq my b gy ni nj l nk nl">#import library<br/>library(bigrquery)<br/><br/>#Your project ID here<br/>project_id &lt;- "your-project-id" # Your project ID goes here<br/><br/>#Sample query<br/>sql_string &lt;- "SELECT * FROM dataset.my_table LIMIT 1000"<br/><br/>#Execute the query and storing the result<br/>query_results &lt;- query_exec(sql_string, project = project_id, useLegacySql = FALSE)</span></pre><p id="71d5" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">与Python一样，如果您希望使用遗留SQL执行查询，可以在您的<code class="fe mv mw mx my b">query_exec</code>函数中将<code class="fe mv mw mx my b">useLegacySql</code>改为<code class="fe mv mw mx my b">TRUE</code>。</p><h1 id="095d" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="2990" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在这篇文章中，我们看到了使用Python和r来访问和操作存储在Google BigQuery中的数据是多么简单和直接。</p><p id="60fb" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">这两种语言使得在这些数据的基础上建立一个统计模型变得非常容易，这可以用于各种目的——理解客户的应用内行为，预测流失率等。只是一些使用案例。</p><p id="99c0" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">与使用其他介质(如CSV文件)相比，使用数据库存储数据有很大的优势。除了可以灵活地存储各种数据类型的大量数据之外，您还可以利用SQL的强大功能来生成复杂的查询，从而获得有意义的见解。</p><p id="40da" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">虽然这篇文章关注的是Google BigQuery，但是使用R和Python来使用任何其他数据库工具都同样容易。唯一的区别是用于连接数据库的Python/R库的选择。</p><h1 id="d965" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">今天试试方向舵堆栈</h1><p id="6cd4" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">开始构建更智能的客户数据管道。使用你所有的客户数据。回答更难的问题。向您的整个客户数据堆栈发送见解。今天就报名参加<a class="ae lu" href="https://app.rudderlabs.com/signup?type=freetrial" rel="noopener ugc nofollow" target="_blank">舵栈云免费</a>。</p><p id="8b62" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">加入我们的<a class="ae lu" href="https://resources.rudderstack.com/join-rudderstack-slack" rel="noopener ugc nofollow" target="_blank"> Slack </a>与我们的团队聊天，查看我们在<a class="ae lu" href="https://github.com/rudderlabs" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上的开源报告，订阅<a class="ae lu" href="https://rudderstack.com/blog/" rel="noopener ugc nofollow" target="_blank">我们的博客</a>，在社交上关注我们:<a class="ae lu" href="https://twitter.com/RudderStack" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae lu" href="https://www.linkedin.com/company/rudderlabs/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>、<a class="ae lu" href="https://dev.to/rudderstack" rel="noopener ugc nofollow" target="_blank"> dev.to </a>、<a class="ae lu" href="https://rudderstack.medium.com/" rel="noopener"> Medium </a>、<a class="ae lu" href="https://www.youtube.com/channel/UCgV-B77bV_-LOmKYHw8jvBw" rel="noopener ugc nofollow" target="_blank"> YouTube </a>。不要错过任何更新。<a class="ae lu" href="https://rudderstack.com/blog/" rel="noopener ugc nofollow" target="_blank">立即订阅</a>我们的博客！</p></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><p id="ca7d" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><em class="mr">原载于https://rudderstack.com</em><a class="ae lu" href="https://rudderstack.com/blog/how-to-access-and-query-your-bigquery-data-using-python-and-r" rel="noopener ugc nofollow" target="_blank"><em class="mr"/></a><em class="mr">。</em></p></div></div>    
</body>
</html>