<html>
<head>
<title>Sidecar BDD in Jenkins</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">詹金斯的边车BDD</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/side-car-bdd-in-jenkins-6b25c413777f?source=collection_archive---------7-----------------------#2021-03-22">https://levelup.gitconnected.com/side-car-bdd-in-jenkins-6b25c413777f?source=collection_archive---------7-----------------------#2021-03-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/430e8de6818510f609a00954fa04ee51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0GO5SP7cV5Xe44Uo"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">奥地利国家图书馆在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的<a class="ae kf" href="https://unsplash.com/@austriannationallibrary?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure><p id="c7a8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有时BDD测试需要一个数据库，因为它需要某种形式的数据输入来形成特定行为的情况。许多BDD工具，如CakePHP或<a class="ae kf" href="https://guides.rubyonrails.org/testing.html#the-low-down-on-fixtures" rel="noopener ugc nofollow" target="_blank"> Ruby on Rails </a>允许程序员将fixture测试数据注入数据库并运行您的测试。</p><p id="3480" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我有一个情况，我不仅需要mysql，还需要redis来运行BDD，我需要在Jenkins管道中自动化它，以便每次有PR时，它在被允许合并到master/main分支之前得到质量测试。</p><p id="c91b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我写了这个阶段来满足这个用例:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="acc0" class="ln lo it lj b gy lp lq l lr ls">stage('BDD Test') {<br/>  when { changeRequest target: 'master' }<br/>  steps {<br/>    script {<br/>      withEnv([<br/>        "MYSQL_HOST=127.0.0.1",<br/>        "MYSQL_USER=root",<br/>        "MYSQL_ROOT_PASSWORD=&lt;ur-passwd&gt;",<br/>        "MYSQL_PORT=&lt;10000 - 60000&gt;",<br/>        "MYSQL_DATABASE=&lt;urDB&gt;",<br/>        "REDIS_HOST=127.0.0.1",<br/>        "REDIS_PORT=&lt;10000 - 60000&gt;",<br/>      ]){<br/>        docker.image('mysql:5.7')<br/>          .withRun(" \<br/>          -e MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD} \<br/>          -p ${MYSQL_PORT}:3306") { d -&gt;<br/>            // ensure that the container is up and running<br/>            sh 'while ! nc -z 127.0.0.1 ${MYSQL_PORT}; do sleep 1 ; done'<br/>            docker.image('redis').withRun("-p ${REDIS_PORT}:6379") { r -&gt;<br/>              sh 'while ! nc -z 127.0.0.1 ${REDIS_PORT}; do sleep 1 ; done'<br/>              sh '&lt;run-bdd-command&gt;'<br/>            }<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="57ff" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请允许我强调这一阶段的一些独特之处:</p><p id="a327" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">MYSQL和REDIS的端口号都需要随机化，以便在两个或更多构建同时运行的情况下，它们不会争夺同一个端口。确保您的单元测试具有从env获取端口号的机制。</p><p id="593f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe lt lu lv lj b">withRun</code>:使用<code class="fe lt lu lv lj b">withRun</code>非常重要，因为该功能将帮助您干净地关闭相关容器，不会留下正在运行或停止的容器。当您不能完全访问jenkins master或nodes来清理容器时，这尤其有用</p><figure class="le lf lg lh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lw"><img src="../Images/3b563575db716981d2b47b46a50d5dd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nWymXtEInsWkGc4VZ0-IEA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">withRun帮助您在单元测试运行后移除容器</figcaption></figure><p id="99bd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe lt lu lv lj b">nc</code>:这是<a class="ae kf" href="https://linuxize.com/post/netcat-nc-command-with-examples" rel="noopener ugc nofollow" target="_blank"> netcat </a>命令，它帮助您再次确认实例已经启动并正在运行，端口已经占用。这样，您就知道MySQL和Redis容器已经可以使用了。当数据库服务器没有准备好接受固定设备时，您不会冒运行测试的风险。不幸的是，netcat并不检查您的数据库是否完全恢复，所以这是一个我将进入的绝对不可能的情况。</p><figure class="le lf lg lh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lx"><img src="../Images/d3bb7a9f6cbec8f1889cf6f0d3e159a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YIZEGJ-rTgRRvHdNulPQEw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">不要在詹金斯管道内这样做</figcaption></figure><p id="6877" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> <em class="ly">不要</em> </strong>恢复一个完整的数据库来运行BDD。BDD并不意味着在一个完整的数据库上运行，除非你在谈论像Drupal这样的大型CMS BDD，其中大部分设置都在数据库中。您应该根据正在运行的测试添加夹具数据，并且应该为新的测试清除这些数据。不恢复完整数据库的原因有很多，但我强调两个主要原因。1)您不知道完全恢复数据库需要多长时间。如果它太长，它会减慢您的部署，这违背了DevOps的目的。2)如果必须更改数据结构，运行永久数据库来运行BDD会很困难。您必须重新创建。sql文件并签入SCM，这不是一个好的做法。因此，在你走这条路之前，请仔细考虑。</p></div></div>    
</body>
</html>