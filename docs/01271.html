<html>
<head>
<title>Create a serverless API with AWS Lambda, AWS API Gateway, and MySQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用AWS Lambda、AWS API Gateway和MySQL创建一个无服务器API</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/create-a-serverless-api-with-aws-lambda-aws-api-gateway-and-mysql-3ef01bc78af1?source=collection_archive---------5-----------------------#2019-12-10">https://levelup.gitconnected.com/create-a-serverless-api-with-aws-lambda-aws-api-gateway-and-mysql-3ef01bc78af1?source=collection_archive---------5-----------------------#2019-12-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="759f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><strong class="ak">本文将指导您使用MySQL数据库在AWS中设置API</strong></h2></div><blockquote class="ki kj kk"><p id="545b" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">如果你想使用PostgreSQL，可以看看这篇文章:<a class="ae li" href="https://medium.com/swlh/creating-a-serverless-rest-api-with-node-js-aws-lambda-api-gateway-rds-and-postgresql-303b0baac834" rel="noopener">用Node.js、AWS Lambda、API Gateway、RDS和PostgreSQL部署无服务器REST API。</a></p></blockquote><p id="0ab9" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">因为我们使用AWS，你需要确保你有一个AWS控制台的<a class="ae li" href="https://portal.aws.amazon.com/billing/signup?nc2=h_ct&amp;src=header_signup&amp;redirect_url=https%3A%2F%2Faws.amazon.com%2Fregistration-confirmation&amp;language=de_de#/start" rel="noopener ugc nofollow" target="_blank">账户。此外，检查您的本地节点和npm版本。您需要节点版本6或更高版本。</a></p><h1 id="e837" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">创建权限</h1><p id="8fa4" class="pw-post-body-paragraph kl km it ko b kp me ju kr ks mf jx ku lj mg kx ky lk mh lb lc ll mi lf lg lh im bi translated">首先添加创建数据库条目和部署我们的功能的权限。</p><p id="26ba" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">在您的AWS帐户中，请导航至<strong class="ko iu">服务&gt; IAM </strong>并选择<strong class="ko iu">用户</strong>。建议为此API系统创建一个新的IAM用户。</p><p id="493a" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">插入用户名(如无服务器)，并确保选择<strong class="ko iu">“编程访问”</strong>。在下一步中，从现有策略中选择并选择</p><ul class=""><li id="535f" class="mj mk it ko b kp kq ks kt lj ml lk mm ll mn lh mo mp mq mr bi translated">AmazonS3FullAccess(用于存储压缩代码)</li><li id="d18d" class="mj mk it ko b kp ms ks mt lj mu lk mv ll mw lh mo mp mq mr bi translated">AWSLambdaFullAccess(用于执行lambda函数)</li><li id="95d8" class="mj mk it ko b kp ms ks mt lj mu lk mv ll mw lh mo mp mq mr bi translated">AmazonRDSFullAccess(用于访问数据库)</li><li id="3c82" class="mj mk it ko b kp ms ks mt lj mu lk mv ll mw lh mo mp mq mr bi translated">AmazonAPIGatewayAdministrator(用于通过API网关管理端点)</li><li id="2de1" class="mj mk it ko b kp ms ks mt lj mu lk mv ll mw lh mo mp mq mr bi translated">AWSCloudFormationFullAccess(用于部署和创建代码堆栈)</li></ul><p id="eaf3" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">完成这个步骤，提交用户，不要忘记存储您的访问密钥ID和访问密码。</p><figure class="my mz na nb gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi mx"><img src="../Images/ba80f04e488a58d2f7804d3a18502e64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0x80PY0CfSzYpQPrTMB5hg.png"/></div></div></figure></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><h1 id="e311" class="lm ln it bd lo lp nq lr ls lt nr lv lw jz ns ka ly kc nt kd ma kf nu kg mc md bi translated">创建数据库</h1><p id="2260" class="pw-post-body-paragraph kl km it ko b kp me ju kr ks mf jx ku lj mg kx ky lk mh lb lc ll mi lf lg lh im bi translated">然后转到<strong class="ko iu">服务&gt; RDS </strong>并点击按钮<strong class="ko iu">“创建数据库”</strong>。对于这个简短的教程，在自由层模板中选择MySQL。添加一个数据库标识符和一个带密码的主用户。接下来，选择最小的可用实例大小。如果您已经知道您将存储大量数据，那么您应该选择另一个选项。</p><p id="5e13" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">现在，选择您的数据库公开可用。在这个主题中，我不会涉及AWS的安全组，如果您不想公开它，您将需要它。接下来，您应该展开<strong class="ko iu">“附加配置”</strong>部分。这就是我在第一次尝试中错过的。在这里，您可以为您的数据库取一个实际的名称，以便以后更容易连接到它。所有其他选项都可以保持默认值。然后，创建数据库。</p><figure class="my mz na nb gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nv"><img src="../Images/ab34fa5c11627a0c1d1692c270d725f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pY8Q3-nHsedX929SLtJ05A.png"/></div></div></figure><p id="7268" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">现在，您可以将数据库工具(如Sequel Pro)连接到数据库。</p><p id="fb30" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">为了完成教程，创建一个名为“函数”的表，并添加一个字段“ID”和“name”。用虚拟内容填充它。</p></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><h1 id="d280" class="lm ln it bd lo lp nq lr ls lt nr lv lw jz ns ka ly kc nt kd ma kf nu kg mc md bi translated">本地安装无服务器</h1><p id="7768" class="pw-post-body-paragraph kl km it ko b kp me ju kr ks mf jx ku lj mg kx ky lk mh lb lc ll mi lf lg lh im bi translated"><em class="kn">先决条件:您的机器</em>上已经安装了Node ( &gt; v6)和npm</p><p id="861c" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">运行<code class="fe nw nx ny nz b">npm install -g serverless</code>。</p><p id="628f" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">这会将无服务器CLI全局安装到您的计算机上。稍后，您将需要这些命令。导航到您的项目文件夹并运行<code class="fe nw nx ny nz b">serverless</code>。该框架将指导您完成安装。对于无服务器，您还需要以前添加的IAM用户。CLI会要求您添加凭据以自动部署无服务器应用程序。</p><figure class="my mz na nb gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi oa"><img src="../Images/e2d332dd8375257c1c5965b8e142b0ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pGUr0kxC0VkKnHLBqUEvGg.png"/></div></div></figure><p id="88af" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">接下来，将无服务器离线软件包安装到您的本地文件夹:<code class="fe nw nx ny nz b">npm install serverless-offline</code>。这使得无需在每次更改后都部署到AWS就可以对API进行本地测试。</p><p id="4fb3" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">在新创建的文件夹中，您会看到一个文件<em class="kn"> serverless.yml </em>。该工具在其中生成了代码，还有一些有用的注释。现在，您已经准备好设置一些路径。</p><p id="f93c" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">通过添加您的AWS区域，开始更改您的<em class="kn"> serverless.yml </em>。</p><blockquote class="ki kj kk"><p id="a651" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">在我的例子中，API和Lambda函数应该在eu-central-1(法兰克福)中运行。</p></blockquote><p id="4845" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">此外，将以下内容添加到文件的末尾，以使脱机软件包实际可用:</p><pre class="my mz na nb gt ob nz oc od aw oe bi"><span id="d179" class="of ln it nz b gy og oh l oi oj">plugins:<br/>  - serverless-offline</span></pre></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><h1 id="d9a4" class="lm ln it bd lo lp nq lr ls lt nr lv lw jz ns ka ly kc nt kd ma kf nu kg mc md bi translated">添加端点和函数</h1><p id="4b61" class="pw-post-body-paragraph kl km it ko b kp me ju kr ks mf jx ku lj mg kx ky lk mh lb lc ll mi lf lg lh im bi translated">您已经准备好创建您的端点和函数调用。首先，创建“函数”属性。之后添加一个端点。</p><p id="eaf4" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">模式如下:</p><pre class="my mz na nb gt ob nz oc od aw oe bi"><span id="4ec6" class="of ln it nz b gy og oh l oi oj">functions:<br/>  myTestFunction:<br/>    handler: folder/javascript-file.myTestFunction<br/>    events:<br/>      - http:<br/>          path: /path<br/>          method: get<br/>          cors: true</span></pre><p id="7e8e" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">这意味着通过HTTP调用<code class="fe nw nx ny nz b">/path</code>，GET执行函数“<code class="fe nw nx ny nz b">myTestFunction</code>”。该函数位于<em class="kn"> javascript-file.js </em>中。</p><p id="42d9" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">在您的<em class="kn"> javascript-file.js </em>中声明函数为async:</p><pre class="my mz na nb gt ob nz oc od aw oe bi"><span id="c46a" class="of ln it nz b gy og oh l oi oj">myTestFunction: async (event, context, callback) =&gt; { }</span></pre></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><h1 id="d63a" class="lm ln it bd lo lp nq lr ls lt nr lv lw jz ns ka ly kc nt kd ma kf nu kg mc md bi translated">连接到数据库</h1><p id="f24c" class="pw-post-body-paragraph kl km it ko b kp me ju kr ks mf jx ku lj mg kx ky lk mh lb lc ll mi lf lg lh im bi translated">下一步是准备JavaScript，以便能够连接到数据库。创建一个<em class="kn"> db-config.js </em>，并确保将其添加到<em class="kn">中。gitignore </em>。只需将以下结构添加到该文件中:</p><pre class="my mz na nb gt ob nz oc od aw oe bi"><span id="9073" class="of ln it nz b gy og oh l oi oj">module.exports = {<br/>    database: 'databasename',<br/>    host: 'hostname',<br/>    port: 'portnumber',<br/>    user: 'db-user',<br/>    password: 'db-password',<br/>};</span></pre><p id="a1a4" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">运行<code class="fe nw nx ny nz b">npm i serverless-mysql</code>在无服务器应用中启用MySQL调用。添加一个名为<em class="kn"> db-connect.js </em>的新文件，并使用以下代码连接到数据库:</p><pre class="my mz na nb gt ob nz oc od aw oe bi"><span id="a91d" class="of ln it nz b gy og oh l oi oj">const dbConfig = require('./db-config');<br/>const mysql = require('serverless-mysql')({<br/>    config: dbConfig<br/>});</span><span id="bf1e" class="of ln it nz b gy ok oh l oi oj">module.exports = mysql;</span></pre><p id="140b" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">这将建立数据库连接。将其导入到创建的<em class="kn"> javascript-file.js </em>中。在第一行粘贴中:</p><pre class="my mz na nb gt ob nz oc od aw oe bi"><span id="3c95" class="of ln it nz b gy og oh l oi oj">const db = require('../db_connect');</span></pre><p id="523e" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">之后，您就可以执行类似于<code class="fe nw nx ny nz b">db.query()</code>的SQL查询了。像这样的函数是异步的，必须等待。</p></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><h1 id="32fe" class="lm ln it bd lo lp nq lr ls lt nr lv lw jz ns ka ly kc nt kd ma kf nu kg mc md bi translated">调用数据库并返回值</h1><p id="1674" class="pw-post-body-paragraph kl km it ko b kp me ju kr ks mf jx ku lj mg kx ky lk mh lb lc ll mi lf lg lh im bi translated">回到您的<code class="fe nw nx ny nz b">myTestFunction</code>，简单地添加一些类似如下的代码:</p><pre class="my mz na nb gt ob nz oc od aw oe bi"><span id="e59b" class="of ln it nz b gy og oh l oi oj">myTestFunction: async (event, context, callback) =&gt; {<br/>    context.callbackWaitsForEmptyEventLoop = false;</span><span id="95c4" class="of ln it nz b gy ok oh l oi oj">    const functions = await db.query('SELECT * FROM functions');</span><span id="cae6" class="of ln it nz b gy ok oh l oi oj">    await db.end();</span><span id="62e4" class="of ln it nz b gy ok oh l oi oj">    if (functions) {<br/>        callback(null, {<br/>            statusCode: 200,<br/>            headers: {<br/>                'Access-Control-Allow-Origin': '*',<br/>                'Access-Control-Allow-Credentials': true,<br/>            },<br/>            body: JSON.stringify(functions),<br/>        })<br/>    } else {<br/>        callback('error', {<br/>            statusCode: 400,<br/>             headers: {<br/>                'Access-Control-Allow-Origin': '*',<br/>                'Access-Control-Allow-Credentials': true,<br/>            },<br/>            body: {<br/>                message: 'No functions found.'<br/>            },<br/>        })<br/>    }<br/>},</span></pre><p id="214e" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lj kw kx ky lk la lb lc ll le lf lg lh im bi translated">这将从函数表中获取所有内容。如您所见，代码等待查询函数和数据库连接的结束。这确保了它获取了所有结果。然后，它检查结果是否不为null或false，并返回回调。对于主体，它提供字符串化的结果。</p><blockquote class="ki kj kk"><p id="8e5a" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">由于从我的机器到AWS的CORS，我必须将这些头添加到每个响应中。</p></blockquote></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><h1 id="ecd2" class="lm ln it bd lo lp nq lr ls lt nr lv lw jz ns ka ly kc nt kd ma kf nu kg mc md bi translated">部署应用程序</h1><p id="9a6c" class="pw-post-body-paragraph kl km it ko b kp me ju kr ks mf jx ku lj mg kx ky lk mh lb lc ll mi lf lg lh im bi translated">你快完成了。回到你的控制台，运行<code class="fe nw nx ny nz b">serverless deploy</code>。如果您之前正确地为无服务器设置了AWS连接，它应该会为您完成剩下的所有工作。命令成功运行后，使用您选择的REST-service尝试您的API。您应该会看到类似的响应，如下所示:</p><pre class="my mz na nb gt ob nz oc od aw oe bi"><span id="d297" class="of ln it nz b gy og oh l oi oj">[<br/>     {<br/>          id: 1,<br/>          name: "funnyFunctionName"<br/>     },</span><span id="4b79" class="of ln it nz b gy ok oh l oi oj">     {<br/>          id: 2,<br/>          name: "boringFunctionName"<br/>     },</span><span id="b061" class="of ln it nz b gy ok oh l oi oj">]</span></pre><h1 id="a701" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">恭喜你，你做到了！🥳</h1></div></div>    
</body>
</html>