# 代码覆盖工具并不令人兴奋

> 原文：<https://levelup.gitconnected.com/code-coverage-tools-arent-exciting-f77d29ef0745>

## 但是他们真的应该

![](img/112d1f5e8843eaff5604aed11cccff60.png)

奥斯卡·伊尔迪兹在 [Unsplash](https://unsplash.com/s/photos/programming?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄的照片

你有没有用过这么神奇的东西，可能是我们写代码方式的一次革命，但后来发现“没人”在意？

# 实时代码覆盖率

在我 2012 年参与的一个项目中，我们使用了[一个叫做 NCrunch](https://www.ncrunch.net/) 的代码覆盖工具，直到今天我仍然认为它比开发人员通常采用的单元测试方法更先进。

这个概念非常重要，足以引起注意；像游戏中许多迟到的东西一样，微软制作了一个名为 [Live Unit Testing](https://docs.microsoft.com/en-us/visualstudio/test/live-unit-testing-start?view=vs-2022) 的抄袭版本，但它仅适用于 Visual Studio 2019 Enterprise Edition(及更高版本)。它仍然没有那么先进，但它确实起作用了。JetBrains 有自己的，叫做 [dotCover](https://www.jetbrains.com/dotcover/) 。如果你不是 C#程序员，我相信其他语言也有类似的工具(除了 YMMV)。

## 它为你做了什么

如果你没有使用过实时代码覆盖，这个想法是非常好的。在你的代码编辑器中，你会有一小块空白区域，每一行代码都有不同的颜色。如果该行代码仅通过测试执行，它将是绿色的。如果在任何时候至少有一个失败的测试执行了它，它将是红色的。如果代码行没有被任何测试执行，它将是黑色的(取决于工具)。术语“由...执行”意味着无论是直接还是间接，该行代码都是作为单元测试调用的代码的结果而运行的。

实时部分可能是最酷的功能。当您在编辑器中输入并暂停时，插件将扫描编辑器的内存中文本表示，并在临时目录中重新编译文件，然后重新运行与您的文件所属的库相关联的测试。你甚至不需要保存你的文件来触发这一连串的事件。

所有这些都将在后台线程上运行，您可以控制它使用的线程数量。它使用自己的缓存，并且足够聪明，不会重新编译所有东西，所以性能不会变得很糟糕。在这种情况下，您还可以基于每个库启用/禁用它。您还可以将单个长时间运行的测试标记为从实时覆盖中排除。

# 为什么开发人员需要代码覆盖

当编辑现有的代码时，你将知道你写了一些破坏测试的东西的确切时间和地点。当编写新代码时，它会提醒您哪些行没有被测试覆盖——即使您正在实践 TDD。这有助于您跟踪每个早期的`return`，每个`throw`和`catch`，每个`switch`中的`case`，每个`continue`，每个`break`，`if`和`else`语句。

并不是说你绝对*需要*涵盖一切，但是你需要知道*涵盖了什么*和*没有涵盖什么*，然后做出明智的决定。

如果开发人员不关心测试的粒度，假设 QA 可能会在代码有问题时捕捉到任何 bug，他们就没有接触到现实。事实是，开发人员是唯一知道他们代码中每一个逻辑分支的人(除了代码审查人员),假设*QA 测试计划覆盖了所有分支是鲁莽的——除非 QA 参与了代码审查过程。*

那是什么意思？这意味着你可以写一堆永远不会被执行的代码，以这样或那样的方式来验证它的工作。让我们面对现实吧，我们中的许多人无法为复杂的工作流编写第一次就能完美运行的代码。这就导致了大量的漏洞被客户发现。这增加了周转，降低了产品质量的外部印象。

# 缺乏兴趣

在每天使用它几年后，当我注意到其他团队没有使用它时，我急于告诉其他人。我会展示它是如何工作的，要么通过一个突出概念的快速视频，要么在我们的代码库中进行现场演示。

人们的反应从完全的沉默，到“哦，酷…”到“哇，太棒了！”但在大多数情况下，人们只是回去工作——而不是问如何得到它，设置它，或任何事情。也许有人担心它会太慢。让我告诉你，令人沮丧的是，对一些能对产品质量产生积极影响的东西缺乏关注。

## 为什么有些开发商可能不在乎

我只能试着想象缺乏兴趣的原因，但是如果不对开发人员做任何假设，也不要求他们走捷径，这是很困难的。

当你像这样练习编写代码时，它会让你陷入更多的困境，因为你的单元测试套件中的所有漏洞都会暴露出来。假装不知道，然后等着看 QA 测试中是否有 bug 出现更容易——或者如果“幸运”的话，直到几年后才有人发现它们。我知道，因为我过去在大三的时候也这样做过，我也看到过其他人也这样做过。

**需要时间**
在称某事“完成”之前需要做额外的工作总是很拖拉。没有一个开发人员喜欢被告知他们还没有完成。代码覆盖率通常就是这样做的。

如果你坚持编写单元测试，代码覆盖工具可以*为你节省*大量时间，作为寻找你所遗漏的东西的视觉辅助。它不是你的敌人；支持你的是朋友。

许多开发人员工作节奏很快，只能勉强应付截止日期，处理大量的错误修复和功能开发，以及其他事情。再增加一件要担心的事情可能会打破他们的平衡。

然而，忽视它就错过了。当你没有把注意力集中在测试上时，这些工具可以帮你思考。尽早发现错误是打破不断修复错误的循环的关键。

# 缺乏接触

不能使用代码覆盖工具有多种原因。

## 不在预算内

这可能更多的是一个借口，而不是一个合理的理由。当然，并不是所有的商店都能为每个开发人员提供 Visual Studio 企业版，这是一个合理的担忧。像 NCrunch 和 dotCover 这样的第三方插件更好，因为这是他们产品的主要目的。以一个初级程序员不到一天的工资为代价，如果你能抓住一个需要一天才能解决的 bug，这是值得的。

## 不在我们的技术堆栈中

如前所述，各种编程语言都有代码覆盖工具。虽然为您的语言找到实时代码覆盖可能更难，但它们确实存在于 C#编程之外。然而，也有一些挑战。

**语言和运行时**
毫无疑问，这些工具更容易创建。Net 提供了丰富的元数据和编译代码中的运行时类型信息(RTTI)。也许这就是我第一次看到它的原因。

然而，有工具可以生成[代码覆盖数据](https://en.wikipedia.org/wiki/Gcov)文件(这似乎是语言不可知的)。Clang 支持生成带有构建标志的覆盖数据。如果您进行研究，代码覆盖率数据可用于许多语言。然后，这些数据可以[用于制作报告](https://wiki.documentfoundation.org/Development/Lcov)，并集成到 CI 系统中，如果工具开发人员热衷的话，甚至可以通过 IDE 插件读取。

**IDE 和工具的自由**
一旦你接触到 Visual Studio 20xx 已经过时并且代码覆盖率不够“流行”的语言，你会发现可用的工具将取决于你正在使用的代码编辑器或 IDE。您可以找到用于编辑器内覆盖的 VS 代码扩展，它支持代码覆盖文件格式，但它们可能不是实时的。

如果你也不喜欢 VS 代码，而想使用 Atom、Sublime Text 或 Emacs，那么你该怎么办？选项变得越来越窄，而且没有人会为每个编辑器构建功能相同的工具。你会强迫你的团队仅仅为了工具而使用特定的 IDE 吗？

# CI 系统代码覆盖率

无论您是否有可用的编辑器内代码覆盖工具，您都应该认真考虑您的 CI 系统中的覆盖。

我目前在 C++中工作，我们有生成代码覆盖数据的构建配置。然后，这些数据被集成到我们的 BitBucket pull 请求中，代码评审人员可以在 diff 中逐行查看覆盖范围。

这是我第一次在一个将覆盖率整合到 PRs 的团队中工作。这很神奇，但也很悲哀，我不得不等这么久才看到它，因为这意味着许多团队没有这样做。

## 在配置项上与在编辑器中

我非常喜欢来自 CI 的覆盖，因为这使得作者和评审者之间有意识地决定未覆盖的代码将被合并。公关会指出来，你可以决定重要不重要。只有 CI 的缺点是，你必须推动你的分支，创建一个 PR 并等待 CI 构建完成，然后才知道你是否错过了什么。

我喜欢我的编辑器中的实时报道，因为当我打破一些东西，然后发现它时，它几乎是即时的。当时我们在 CI 上没有它，所以我们的小团队在同意我们在编写代码时总是启用覆盖之后，使用了荣誉系统。然而，如果你没有管理一个紧密团结的团队，那么荣誉体系就会失效——这意味着你不能信任你的同事——这是一个更大的问题。

因此，我建议两者兼得。

# 最后的想法

每一种流行的编辑器或编程语言都缺乏现代的覆盖工具，这说明我们的软件公司在这个主题上的投资是多么的少。

10 年前，我被实时报道震撼了，几年后，我再次为 CI 报道兴奋不已。然而，这种情况少之又少，与其兴奋或被吹走，倒不如成为常态。

为了让它成为规范，我们需要兴趣和热情，在这些神奇的工具淡出人们的视线之前，那将是一场悲剧。

# 分级编码

感谢您成为我们社区的一员！在你离开之前:

*   👏为故事鼓掌，跟着作者走👉
*   📰查看更多内容在[关卡升级编码](https://levelup.gitconnected.com/)
*   🔔关注我们:[推特](https://twitter.com/gitconnected) | [LinkedIn](https://www.linkedin.com/company/gitconnected) | [时事通讯](https://newsletter.levelup.dev)
*   🚀👉 [**软件工程师的热门职位**](https://jobs.levelup.dev/)