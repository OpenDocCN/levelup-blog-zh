<html>
<head>
<title>BigQuery from the command line</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">来自命令行的BigQuery</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/bigquery-from-the-command-line-9e76f0d76e77?source=collection_archive---------6-----------------------#2020-03-19">https://levelup.gitconnected.com/bigquery-from-the-command-line-9e76f0d76e77?source=collection_archive---------6-----------------------#2020-03-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8ef4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从命令行管理BigQuery可以节省大量时间。以下是如何设置这一点。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/dfc3a89d6324950c806bbef2846a1806.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*06m1s0EzmjhdUqgv"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/@lejo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">艾莉·约翰逊</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="4921" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用BigQuery可能非常复杂。云控制台(Google对基于网络的云管理界面的命名)功能强大，但任务很快变得重复和繁琐。实现API客户端、Composer DAGs和类似的应用程序通常是多余的，尤其是对于相当基本和附带的操作。幸运的是，Google还提供了一个很棒的工具包，其中包括许多Google Cloud APIs的命令行客户端。这些客户端的优势在于，简单的任务可以以简单的方式执行，而复杂的任务仍然是可能的。命令可以被复制和粘贴、编写脚本、在cron表中定期执行、放入版本控制等等。所有这些都可以从您的一个GCP项目中的VM实例中获得，也可以从您在街角咖啡店的笔记本中获得。</p><h1 id="be44" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">入门指南</h1><p id="5e59" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">显然，您首先需要的是一个命令行。对于本文，我假设您有可用的命令行。Linux和macOS用户会懂我的意思，Windows用户可能不懂。我们将要安装的工具包将为您提供一个Windows命令行，但是shell有些受限。作为一种选择，WSL (Windows Subsystem for Linux)将为您提供一个您选择的基本但非常实用的Linux安装，它包括一个合适的终端，您可以在其中运行一个shell。所有的例子都是在运行bash shell的Linux终端中执行时给出的，但是这些例子很容易被转换成不同的shell。</p><p id="2316" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是安装<a class="ae lb" href="https://cloud.google.com/sdk/docs/" rel="noopener ugc nofollow" target="_blank">云SDK </a>。这为你提供了一套与云平台交互的工具。遵循在线文档中的说明，包括初始化SDK的步骤。这将允许您使用您的GCP帐户进行身份验证，该帐户当然应该有足够的权限来管理BigQuery和云存储。</p><h1 id="f577" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">一点探索</h1><p id="06ca" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">安装完Cloud SDK后，启动终端并键入:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="c6a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将向您显示GCP可用的各种子系统的大量信息，按组进行组织。就本文而言，<code class="fe mh mi mj mk b">auth</code>组尤其重要:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="3d1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这显示了初始化SDK时使用的帐户。通过输入以下内容添加另一个帐户:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="3290" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按照指示去做。然后，您可以在帐户之间切换。</p><p id="eb09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个有用的选项是<code class="fe mh mi mj mk b">config</code>组，它允许您管理一些基本设置，例如活动帐户和项目。使用<code class="fe mh mi mj mk b">gcloud help config</code>获取所有可用参数的完整列表。使用以下方法检查活动设置:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><h1 id="81e0" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">回避云存储</h1><p id="2f33" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">云存储作为BigQuery导入或导出数据的存储位置非常方便，所以让我们稍微回避一下从命令行管理云存储。这个实用程序是<code class="fe mh mi mj mk b">gsutil</code>，它以类似于<code class="fe mh mi mj mk b">gcloud</code>的方式接受子命令。列出可用存储桶的过程如下:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="d112" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用选项可以获得更详细的信息:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="22a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe mh mi mj mk b">cp</code>子命令将数据复制到云存储中或从云存储中复制数据:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="fe4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不需要创建文件夹，因为路径映射到云存储中的对象。使用<code class="fe mh mi mj mk b">gsutil</code>可以控制的还有很多。有关更多信息，请查看内置帮助和联机文档。</p><p id="bf48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了使用<code class="fe mh mi mj mk b">gsutil</code>之外，云存储上的对象也可以通过使用<code class="fe mh mi mj mk b">gcsfuse</code>挂载桶作为本地文件系统来为一些操作系统进行管理，如这里的<a class="ae lb" href="https://medium.com/swlh/three-strategies-for-accessing-google-cloud-storage-from-php-d2ea5f07c7d2" rel="noopener">所解释的</a>。</p><h1 id="47fa" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">管理BigQuery</h1><p id="87aa" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">使用<code class="fe mh mi mj mk b">bq</code>命令完成与BigQuery的交互。与其他云SDK工具一样，帮助内置于:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="e195" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们通过几个步骤来演示您在日常工作中可能使用BigQuery执行的基本操作。首先，我们创建一个数据集，我们可以在不影响重要数据的情况下进行实验。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="b343" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mh mi mj mk b">mk</code>子命令用于创建各种资源，包括数据集和表格。相反，<code class="fe mh mi mj mk b">rm</code>子命令用于删除资源。</p><p id="20de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在继续创建表之前，我们需要决定如何提供表的模式。对于简单的表，可以在命令行上使用<code class="fe mh mi mj mk b">--schema</code>选项提供模式，但是该选项也可以用于指定模式文件，允许更复杂的表定义。作为一个例子，我将使用下面的模式来表示一个order对象，它有一个或多个order行，保存在一个名为<code class="fe mh mi mj mk b">order.json</code>的文件中:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="3d9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建表格的命令是:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="386e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，有更多的选项可以帮助您控制创建什么，以及至少同样重要的是，在哪里创建它。同样，de<code class="fe mh mi mj mk b">bq</code>utility中的内置帮助是一个很好的起点。</p><p id="d031" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经创建了一个表，下一个明显的步骤是将一些数据放入其中，这是使用<code class="fe mh mi mj mk b">load</code>子命令实现的。这允许导入各种格式的数据，包括CSV和JSON。您可能已经注意到，我创建了一个包含重复记录的表，因此CSV不是一个选项，但JSON是。假设我有一个包含订单信息的文件，其中每个订单看起来有点像这样:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="a719" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，JSON文件需要格式化，以便每个记录只占一行，所以漂亮打印的JSON将无法工作。假设我已经在一个文件中收集了一组订单，每行一个完整的订单文档，我可以使用以下命令导入这些订单:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="9207" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在可以在云控制台中找到导入作业，在那里可以使用由<code class="fe mh mi mj mk b">bq</code>命令打印的作业id来识别它。在这种情况下，我导入的文件是一个本地文件，但它也可能是之前使用<code class="fe mh mi mj mk b">gsutil</code>放在云存储空间中的文件。</p><p id="66ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">进一步考虑导入，如果我必须导入一组文件，我可以使用一个循环在一个命令中完成:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="7452" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我使用UNIX风格的换行(一个反斜杠作为一行的最后一个字符)来提高可读性。对文件列表命令的结果进行循环，将每个CSV文件加载到我们之前创建的数据集中的一个假想的<code class="fe mh mi mj mk b">shipment</code>表中。我使用额外的选项来控制导入，比如不替换现有的表格内容(<code class="fe mh mi mj mk b">--noreplace</code>)，跳过CSV标题(<code class="fe mh mi mj mk b">--skip_leading_rows=1</code>)。结果将是一个作业id列表，每个导入的CSV文件一个。请注意，其他shells的循环语法可能略有不同。</p><p id="771b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要解决的最后一个基本步骤是从BigQuery中获取数据。我想演示两个场景，第一个是按原样导出表格内容。最简单的形式是，将表内容转储到文件中，如下所示:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="eab0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提取只能在云存储中完成，这就是为什么目的地URI指向一个桶。如前所述，使用<code class="fe mh mi mj mk b">gsutil</code>将文件下载到您的本地系统。默认的导出格式是CSV，它不支持嵌套模式。对于上面的<code class="fe mh mi mj mk b">order</code>表，我们需要指定一种支持嵌套的格式，例如:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="a549" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">也可以压缩输出。更多信息见<code class="fe mh mi mj mk b">bq help extract</code>。</p><p id="c400" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个更复杂的场景是我们想要导出查询的结果。除了用<code class="fe mh mi mj mk b">bq</code>命令打印结果之外，没有直接导出查询结果的方法，这对于较大的数据集来说不太实用。因此，这个过程必须分成几个步骤。首先，我们执行查询，将结果写入表中，然后提取数据，最后，我们删除包含查询结果的表。可以按如下方式创建结果表:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="fe3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里，我将一个相当简单的查询赋给了一个变量，就像在脚本中一样。更常见的是编写这些过程的脚本，以便它们可以无人值守地运行，在这种情况下，可以通过使用临时表来使过程更加简洁。事实是，每个查询的结果都会免费存储一段时间(目前大约是24小时)，这些结果集也可以用来提取数据。为了做到这一点，我们需要数据被写入的表的信息。我们可以在运行查询的作业中找到以下信息:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="b37e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以上是上一份工作可用的大量信息的一个小例子。临时目标表中的数据集和表id可用于导出数据:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="72f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几句话到位。首先，应该检查输出的作业状态。如果工作状态不是“完成”，那么继续下去就没有意义。此外，如果使用临时表的作业并发运行，验证临时表是由正确的作业创建的非常重要。如果流程变得像这样复杂，这可能是一个切换到比命令行更合适的环境的好时机，例如适当的Google API客户端或成熟的工作流管理器，如Airflow或Composer (Google对其基于Airflow的服务的名称)和类似的解决方案。</p><p id="dd70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望已经让您对如何从命令行和在基本的shell脚本中与BigQuery进行交互有了基本的了解，而不必立即开发API客户机。能够使用一次性导入或简单的cron作业来完成这项工作可以节省大量时间。</p></div></div>    
</body>
</html>