<html>
<head>
<title>Deploying a Go Service to the Integrated Docker Registry in Gitlab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Go服务部署到Gitlab中的集成Docker注册中心</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploying-a-go-service-to-the-integrated-docker-registry-in-gitlab-60a13e638013?source=collection_archive---------5-----------------------#2019-11-12">https://levelup.gitconnected.com/deploying-a-go-service-to-the-integrated-docker-registry-in-gitlab-60a13e638013?source=collection_archive---------5-----------------------#2019-11-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e5d9ca3622c13fe76dc510d5d997cf84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TZpFsKKkqMEyOBA0.png"/></div></div></figure><p id="a489" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Gitlab/K8S CI文章的第二部分中，我们使用Gitlab CI和我们之前建立的注册表<a class="ae kw" href="https://medium.com/@lightphos/gitlab-installation-registry-and-runner-with-docker-700549b93803" rel="noopener"/>部署了一个简单的Go服务器，并运行从我们自己的注册表中提取的映像构建。</p><h1 id="53ad" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Go服务</h1><p id="58c9" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在gitlab中，在gitlab.lightphos.com:30080创建了一个私人项目“hi”</p><p id="cbcb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">克隆项目(在我的例子中，用户名是<strong class="ka ir"> sr </strong>)</p><p id="6ed5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ma mb mc md b">git clone ssh://git@gitlab.lightphos.com:30022/sr/hi.git</code></p><p id="40ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">导航到它:</p><p id="dd99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用以下内容添加文件<code class="fe ma mb mc md b">hi.go</code>:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="1880" class="mm ky iq md b gy mn mo l mp mq">package main<br/><br/>import (<br/>	"fmt"<br/>	"net/http"<br/>)<br/><br/>func main() {<br/>	fmt.Println("Started on 8090")<br/>	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {<br/>	   fmt.Fprintf(w, "Hi %s\n", r.URL.Path)<br/>	})<br/>	http.ListenAndServe(":8090", nil)<br/>}</span></pre><p id="1e04" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加、提交和推送文件到git。浏览您的本地gitlab，您应该看到列出了文件hi.go。</p><p id="aee0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建以下内容，并将其命名为Dockerfile</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="ee96" class="mm ky iq md b gy mn mo l mp mq">FROM golang:1.12.0-alpine3.9 as builder <br/>RUN mkdir /app <br/>ADD hi.go /app <br/>WORKDIR /app <br/>RUN go build -o hi . </span><span id="1653" class="mm ky iq md b gy mr mo l mp mq">FROM alpine:latest as host <br/>RUN apk add --no-cache ca-certificates <br/>COPY --from=builder /app/hi / <br/>WORKDIR / <br/>EXPOSE 8090 <br/>CMD ["/hi"]</span></pre><p id="946e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Gitlab ci文件。gitlab-ci.yml</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="060e" class="mm ky iq md b gy mn mo l mp mq">variables:<br/>  REPO_NAME: ${CI_REGISTRY}/${CI_PROJECT_PATH}<br/>  CONTAINER_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_BUILD_REF_NAME}_${CI_BUILD_REF}<br/>  CONTAINER_IMAGE_LATEST: ${CI_REGISTRY}/${CI_PROJECT_PATH}:latest<br/>  DOCKER_DRIVER: overlay2<br/><br/>before_script:<br/>  - mkdir -p $GOPATH/src/$(dirname $REPO_NAME)<br/>  - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_NAME<br/>  - cd $GOPATH/src/$REPO_NAME  <br/><br/><br/>stages:<br/>  - test<br/>  - build<br/>  - release<br/>  - deploy<br/><br/>format:<br/>  image: golang:latest<br/>  stage: test<br/>  script:<br/>    - go fmt $(go list ./... | grep -v /vendor/)<br/>    - go vet $(go list ./... | grep -v /vendor/)<br/>    - go test -race $(go list ./... | grep -v /vendor/)<br/><br/>compile:<br/>  image: golang:latest<br/>  stage: build<br/>  script:<br/>    - go build -race -ldflags "-extldflags '-static'" -o $CI_PROJECT_DIR/hi<br/>  artifacts:<br/>    paths:<br/>      - hi<br/><br/><br/>release:<br/>    image: docker:19.03.1<br/>    stage: release<br/>    before_script:<br/>      - echo ${CONTAINER_IMAGE}<br/>      - echo  $CI_BUILD_TOKEN | docker login -u gitlab-ci-token --password-stdin ${CI_REGISTRY}<br/>    script:<br/>      - docker build -t ${CONTAINER_IMAGE} -t ${CONTAINER_IMAGE_LATEST} .<br/>      - docker push ${CONTAINER_IMAGE}<br/>      - docker push ${CONTAINER_IMAGE_LATEST}</span></pre><p id="6493" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注册一名跑步者，并将其设置为无标记跑步(参见<a class="ae kw" href="https://medium.com/@lightphos/gitlab-installation-registry-and-runner-with-docker-700549b93803" rel="noopener">上一篇文章</a>)</p><p id="0207" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Git提交这些文件并推送。</p><p id="9e72" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CI应该介入，构建go服务并注册它。发布阶段应该如下所示:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="20fc" class="mm ky iq md b gy mn mo l mp mq">Running with gitlab-runner 12.4.0 (1564076b)<br/>  on Runner 8RydtMPh<br/>Using Docker executor with image docker:19.03.1 ...<br/>Pulling docker image docker:19.03.1 ...<br/>Using docker image sha256:0cecfefe921f22fc898f7a0055358380c8870ab6f05b01999367911714fe9d00 for docker:19.03.1 ...<br/>Running on runner-8RydtMPh-project-3-concurrent-0 via d00feb8672c0...<br/>Fetching changes with git depth set to 50...<br/>Reinitialized existing Git repository in /builds/sr/hi/.git/<br/>Checking out 3538cfa1 as master...<br/>Removing hi<br/><br/>Skipping Git submodules setup<br/>Downloading artifacts for compile (124)...<br/>Downloading artifacts from coordinator... ok        id=124 responseStatus=200 OK token=dWTn-Pwd<br/>$ echo ${CONTAINER_IMAGE}<br/>gitlab.lightphos.com:5555/sr/hi:master_3538cfa18843906473c0a075d39cce785d2f5eb4<br/>$ echo  $CI_BUILD_TOKEN | docker login -u gitlab-ci-token --password-stdin ${CI_REGISTRY}<br/>WARNING! Your password will be stored unencrypted in /root/.docker/config.json.<br/>Configure a credential helper to remove this warning. See<br/>https://docs.docker.com/engine/reference/commandline/login/#credentials-store<br/><br/>Login Succeeded<br/>$ docker build -t ${CONTAINER_IMAGE} -t ${CONTAINER_IMAGE_LATEST} .<br/>Sending build context to Docker daemon  9.755MB<br/><br/>Step 1/11 : FROM golang:1.12.0-alpine3.9 as builder<br/> ---&gt; 2205a315f9c7<br/>Step 2/11 : RUN mkdir /app<br/> ---&gt; Using cache<br/> ---&gt; 54da6752cdd5<br/>Step 3/11 : ADD hi.go /app<br/> ---&gt; d21d0d2af424<br/>Step 4/11 : WORKDIR /app<br/> ---&gt; Running in e2e87def04e3<br/>Removing intermediate container e2e87def04e3<br/> ---&gt; 4d78d2a12967<br/>Step 5/11 : RUN go build -o hi .<br/> ---&gt; Running in 60fc1b0dffe8<br/>Removing intermediate container 60fc1b0dffe8<br/> ---&gt; 5b2fa72dd518<br/>Step 6/11 : FROM alpine:latest as host<br/> ---&gt; 965ea09ff2eb<br/>Step 7/11 : RUN apk add --no-cache ca-certificates<br/> ---&gt; Using cache<br/> ---&gt; ba261b495589<br/>Step 8/11 : COPY --from=builder /app/hi /<br/> ---&gt; 8d376b2c37cb<br/>Step 9/11 : WORKDIR /<br/> ---&gt; Running in 7f60e9fb9d88<br/>Removing intermediate container 7f60e9fb9d88<br/> ---&gt; 387b7422eab2<br/>Step 10/11 : EXPOSE 8090<br/> ---&gt; Running in 3aa6f0aa255b<br/>Removing intermediate container 3aa6f0aa255b<br/> ---&gt; 9f8c5dbf79b4<br/>Step 11/11 : CMD ["/hi"]<br/> ---&gt; Running in a46f92a45ab4<br/>Removing intermediate container a46f92a45ab4<br/> ---&gt; 4a72c58b9b54<br/>Successfully built 4a72c58b9b54<br/>Successfully tagged gitlab.lightphos.com:5555/sr/hi:master_3538cfa18843906473c0a075d39cce785d2f5eb4<br/>Successfully tagged gitlab.lightphos.com:5555/sr/hi:latest<br/>$ docker push ${CONTAINER_IMAGE}<br/>The push refers to repository [gitlab.lightphos.com:5555/sr/hi]<br/>f85f9ff79b0a: Preparing<br/>3162ed9eaf42: Preparing<br/>77cae8ab23bf: Preparing<br/>3162ed9eaf42: Layer already exists<br/>77cae8ab23bf: Layer already exists<br/>f85f9ff79b0a: Pushed<br/>master_3538cfa18843906473c0a075d39cce785d2f5eb4: digest: sha256:393b1ab11ab37aff4ddf9192fb8dd96561d15cab875aa67266efdef5234b49c4 size: 949<br/>$ docker push ${CONTAINER_IMAGE_LATEST}<br/>The push refers to repository [gitlab.lightphos.com:5555/sr/hi]<br/>f85f9ff79b0a: Preparing<br/>3162ed9eaf42: Preparing<br/>77cae8ab23bf: Preparing<br/>f85f9ff79b0a: Layer already exists<br/>3162ed9eaf42: Layer already exists<br/>77cae8ab23bf: Layer already exists<br/>latest: digest: sha256:393b1ab11ab37aff4ddf9192fb8dd96561d15cab875aa67266efdef5234b49c4 size: 949<br/>Job succeeded</span></pre><p id="33f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您应该在Packages -&gt; Container Registry中看到该图像。</p><p id="5d55" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制最新的图像细节，并像这样运行:</p><p id="92d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ma mb mc md b">docker run --rm -it -p 8090:8090 gitlab.lightphos.com:5555/sr/hi:latest</code></p><p id="089a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它应该输出</p><p id="2621" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ma mb mc md b">Started on 8090</code></p><p id="5ed9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">导航至以下链接:</p><p id="cea2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="http://localhost:8090/there" rel="noopener ugc nofollow" target="_blank">http://localhost:8090/there</a></p><p id="c22e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应该给你:</p><p id="6635" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你好</p><p id="c532" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在下一篇<a class="ae kw" href="https://blog.ramjee.uk/minikube-and-gitlab-ci/" rel="noopener ugc nofollow" target="_blank">文章中，我们将着眼于将kubernetes集成到gitlab，并通过CI管道将映像部署到git lab。</a></p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><p id="6f28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mz">原载于2019年11月12日</em><a class="ae kw" href="https://blog.ramjee.uk/deploying-a-go-service-to-the-integrated-docker-registry-in-gitlab/" rel="noopener ugc nofollow" target="_blank"><em class="mz">https://blog . ram JEE . uk</em></a><em class="mz">。</em></p></div></div>    
</body>
</html>