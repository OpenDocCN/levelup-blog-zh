<html>
<head>
<title>How to Work With Secrets on Google Cloud Platform (GCP)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在谷歌云平台上使用秘密(GCP)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-work-with-secrets-in-google-cloud-platform-gcp-ebfcad03b8cf?source=collection_archive---------3-----------------------#2022-06-28">https://levelup.gitconnected.com/how-to-work-with-secrets-in-google-cloud-platform-gcp-ebfcad03b8cf?source=collection_archive---------3-----------------------#2022-06-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a03f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解管理敏感数据的更好方法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/53888df3616662830816f45db36e4072.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JPxvSdG5GwTm0seq.jpg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://pixabay.com/photos/fingerprint-unlock-network-man-2904774/" rel="noopener ugc nofollow" target="_blank"> geralt </a>在Pixabay拍摄</figcaption></figure><p id="d311" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用程序通常需要一些敏感数据，如API密钥、数据库密码、私钥等。通常将它们存储为环境变量。但是，这不是一个好的做法，因为环境变量的值是以纯文本的形式设置和存储的，因此很容易被发现。如果你的应用程序托管在谷歌云平台(GCP)上，你可以使用秘密管理器来管理这些敏感数据，这是一个非常安全和方便的解决方案。在这篇文章中，我们将介绍在我们的应用程序中使用Secret Manager的要点。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="701d" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">准备</h2><p id="a2e0" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果你刚到GCP，你可以根据<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-set-up-your-local-environment-to-work-with-gcp-4ed0a11421ef">这个帖子</a>来设置你当地的开发环境。</p><p id="a0db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你用你的私人Google账号创建了一个项目，那么你就是项目的所有者，不需要担心权限问题。然而，如果你在一个团队中工作，你需要被授予<a class="ae ky" href="https://cloud.google.com/secret-manager/docs/access-control" rel="noopener ugc nofollow" target="_blank">秘密管理者</a>的角色，如果你想遵循这篇文章中的所有指示。通常，作为开发人员，您可能没有这个管理员角色，而只有一些有限的角色来创建秘密版本或只是查看秘密。请查看<a class="ae ky" href="https://cloud.google.com/secret-manager/docs/access-control" rel="noopener ugc nofollow" target="_blank">此链接</a>了解秘密管理者的精细角色。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="100c" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">创造一个秘密</h2><p id="1edd" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">通常我们不需要在代码中以编程的方式创建秘密。我们只需要在需要创建或更新敏感数据时不时地手动执行。因此，在GCP控制台中创建秘密更方便，在那里你可以得到很多有用的提示，比如什么、为什么和如何。</p><p id="12d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在GCP控制台中，搜索“秘密管理器”并选择下面显示的一个:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/9d4065c7f6958694f2241057f3bed7ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BhlGH3r59INQ9nCoPJSmJQ.png"/></div></div></figure><p id="1b12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后单击“创建密码”创建一个新密码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/05612b38e4bb22887dd66c5bd89eb550.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*YB0WOSfI-zScn8TYhBhUPA.png"/></div></figure><p id="afb3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在打开的页面上，输入机密的名称，该名称在项目中必须是唯一的。因此，请给它一个易于识别的描述性且唯一的名称。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/7616f014b17c8529b5ce91c3fdbd2f39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*jNB2-6wdJP1lypMf6qBFEQ.png"/></div></figure><p id="a741" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以直接输入您的密码值，也可以从文件中导入。在这里直接输入敏感数据是安全的，因为除非你在一个不安全的环境中工作，并且有人在看着你的屏幕，否则它不会在任何地方泄露👀。对于通常已经存储在文本文件中的私钥，直接上传文件更方便。</p><p id="16a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以保持所有其他选项不变，因为默认选项在大多数情况下已经足够了。当然，通过微调这些选项，您可以对如何管理秘密进行更细粒度的控制。现在点击“创建密码”来创建密码。</p><p id="1396" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建密码的gcloud命令是</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="ccaa" class="mc md it ne b gy ni nj l nk nl">$ gcloud secrets create my-secret --data-file=/tmp/secret</span></pre><p id="d3b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在终端本地，最好通过数据文件而不是纯文本来指定秘密值，因为后者可能会在Linux命令历史中暴露出来，这本身就是一个安全问题。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="4d7b" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">检查秘密值</h2><p id="102d" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">对于秘密管理者创造的秘密，一个很重要的概念就是“版本”。秘密版本包含秘密的实际值。一个秘密可以包含多个版本，从1开始依次命名。默认情况下，如果没有指定版本id，则使用版本号最大的最新版本。我们还可以通过指定版本id来访问特定版本的值。</p><p id="3e5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用版本控制特性的一个好处是，具有不同值的相同秘密可以用于不同的环境，从而最小化要维护的秘密的数量。例如，我们通常为开发、试运行和生产环境提供不同的API键。对于这些环境，我们可以使用同一个秘密的不同版本。</p><p id="ac3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们检查一下我们的秘密的第一个版本的价值:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/b3c7076c699f70687c580370d7393f76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*YrJICN8pAQRSSqz2oWRAMA.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/627b8b4bb5b52bf13ed60d5ff862def5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*4DauXrpr6_kPiHv9mrcT3g.png"/></div></figure><p id="4f7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查密码值的gcloud命令是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="4873" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以通过版本id或“最新”标签来访问秘密版本。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="c6ee" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">添加秘密版本</h2><p id="8888" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果我们需要为不同的环境拥有不同的值，或者仅仅是因为我们需要更新秘密的值，我们可能需要添加秘密版本。</p><p id="96d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在GCP控制台中创建新版本很简单:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/78a551e314235de514489c1f0bc042e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n1ls2igtF82oFxXKaDztiw.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/82ec36392d3ecd0b68660dcb55dc20a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*l2Z2PbNj3tTrX1_Au-ZACg.png"/></div></figure><p id="19e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为密码创建新版本的gcloud命令是:</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="f3e5" class="mc md it ne b gy ni nj l nk nl">$ gcloud secrets versions add secret-id --data-file=/tmp/secret</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="7f9b" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">在应用程序代码中直接使用secret</h2><p id="6fd7" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">作为开发人员，我们主要关注的是如何在应用程序代码中使用秘密管理器创建的秘密。为此，我们需要为特定的编程语言安装一个Secret Manager客户端库。如果使用Python，可以使用<code class="fe ns nt nu ne b">pip</code>安装客户端库:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="48cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">建议创建一个<a class="ae ky" href="https://lynn-kwong.medium.com/how-to-create-virtual-environments-with-venv-and-conda-in-python-31814c0a8ec2" rel="noopener">虚拟环境</a>，并在那里安装客户端库，这样它就不会与您的系统库混淆。</p><p id="e3fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们可以使用以下代码来读取机密的值，并在我们的应用程序中使用它进行身份验证:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="be7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意事项:</p><ul class=""><li id="cc91" class="nv nw it lb b lc ld lf lg li nx lm ny lq nz lu oa ob oc od bi translated">如果你遇到认证问题，请看看<a class="ae ky" href="https://medium.com/p/4ed0a11421ef" rel="noopener">这篇文章</a>，它很可能会解决你的问题。</li><li id="17ae" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">我们需要用项目ID、秘密ID和版本ID构造一个完整的资源名称，然后用它来访问秘密。项目ID、秘密ID和版本ID可以存储为环境变量。</li><li id="3157" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">默认情况下，该值作为二进制字符串返回，在大多数情况下，我们需要<a class="ae ky" href="https://lynn-kwong.medium.com/understand-the-encoding-decoding-of-python-strings-unicode-utf-8-f6f97a909ee0" rel="noopener">将</a>解码为普通字符串。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="6d9d" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">将机密作为环境变量挂载</h2><p id="5935" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">正如您在上面发现的，如果我们需要直接访问秘密值，我们需要使用客户端库。然而，有时你的代码会严重依赖环境变量或秘密文件，例如当你使用<a class="ae ky" href="https://lynn-kwong.medium.com/how-to-use-pydantic-to-read-environment-variables-and-secret-files-in-python-8a6b8c56381c" rel="noopener"> Pydantic </a>库来管理这些数据时。在这种情况下，如果您想摆脱Pydantic并直接使用Secret Manager客户端库，就需要进行重大的重构。</p><p id="48c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，我们不需要这样做！对于像Cloud Run这样的GCP服务，我们可以将秘密作为环境变量挂载，并在Pydantic中直接使用它们。根本不需要重构工作。</p><p id="1ea1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从头开始创建云运行微服务需要做大量工作，因为您需要为微服务准备代码(通常是一些API代码)以及如何构建和部署服务。请查看<a class="ae ky" href="https://betterprogramming.pub/how-to-deploy-a-web-application-to-cloud-run-automatically-6967d7c7d42a" rel="noopener ugc nofollow" target="_blank">这篇文章</a>，了解如何从头开始部署云运行服务。这里我们将只关注如何将一个秘密暴露为一个环境变量或一个挂载的卷。</p><p id="f38f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以编辑您的云运行服务并切换到“变量和秘密”选项卡，在这里您可以引用一个秘密并将其用作环境变量:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/a0bca4d73aef2e6c90b171758cce7536.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*snMyvXaqyuKPLSfXRmR2rA.png"/></div></figure><p id="14ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您单击“引用机密”时，您可以指定机密id、版本id以及如何在您的云运行服务中引用它:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/b2bd1d3915fcdac1f1e8f15cc25a07cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/1*YAgKVM-iI2wGSt8leGZuNA.gif"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/5087c5a530d0a2dc663719ebbc939afb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*fSoks91S5MVp7nPsDdyX7w.png"/></div></figure><p id="71b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在你可以在你的代码中使用secret作为一个环境变量，而根本不需要修改你的代码，这非常方便。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="9f85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我们介绍了如何使用秘密管理器创建、更新和访问秘密。一个非常重要的概念是版本化，每个版本存储一个独立的秘密值，便于维护。我们还介绍了如何使用Python访问应用程序代码中的秘密。最后但同样重要的是，我们可以在云运行服务中将秘密作为环境变量公开，这让我们可以方便地利用秘密的安全特性，而无需对代码进行重大重构。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="7732" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相关文章:</p><ul class=""><li id="0eba" class="nv nw it lb b lc ld lf lg li nx lm ny lq nz lu oa ob oc od bi translated"><a class="ae ky" href="https://medium.com/p/4ed0a11421ef" rel="noopener">如何设置您的本地环境以便与GCP一起工作</a></li><li id="a6e2" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" href="https://lynn-kwong.medium.com/how-to-use-pydantic-to-read-environment-variables-and-secret-files-in-python-8a6b8c56381c" rel="noopener">如何使用pydantic读取Python中的环境变量和秘密文件</a></li></ul></div></div>    
</body>
</html>