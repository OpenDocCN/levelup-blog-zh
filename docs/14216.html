<html>
<head>
<title>Typescript Missed This But You Shouldn’t — Runtime Type Validation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Typescript错过了这一点，但您不应该错过——运行时类型验证</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/typescript-missed-this-but-you-shouldnt-runtime-type-validation-aa8a81ce4289?source=collection_archive---------29-----------------------#2022-11-08">https://levelup.gitconnected.com/typescript-missed-this-but-you-shouldnt-runtime-type-validation-aa8a81ce4289?source=collection_archive---------29-----------------------#2022-11-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="4c05" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本文旨在演示使用Typescript时运行时类型检查的重要性和方法。作为一种构建时语言，它在Typescript中被遗漏了。</p><ul class=""><li id="4a63" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">Typescript中遗漏了什么</li><li id="b8fe" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">介绍佐德</li><li id="d163" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">进一步地</li></ul><p id="393a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">TL；DR代码repo <a class="ae lc" href="https://github.com/caopengau/typescript-type-validation" rel="noopener ugc nofollow" target="_blank">此处</a>。让我们开始吧…</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ld"><img src="../Images/6ba1a25ec0924c15f1fa4031c2d942a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kqu_8NE9kYHTaic0hUKK_g.png"/></div></div></figure><h1 id="2c3a" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">一个Typescript会遗漏什么的例子</h1><pre class="le lf lg lh gt mn mo mp mq aw mr bi"><span id="6789" class="ms lq it mo b gy mt mu l mv mw">// Typescript definition<br/>type Bank = {<br/>  id: number;<br/>  uid: string;<br/>  account_number: string;<br/>  iban: string;<br/>  bank_name: string;<br/>  routing_number: string;<br/>  swift_bic: string;<br/>};</span><span id="f8e7" class="ms lq it mo b gy mx mu l mv mw">// communicates with external API<br/>const fetchData = (): Promise&lt;Bank&gt; =&gt; {};</span><span id="4db8" class="ms lq it mo b gy mx mu l mv mw">const processBank = (bank: Bank) =&gt; {};</span><span id="7819" class="ms lq it mo b gy mx mu l mv mw">const main = async () =&gt; {<br/>  const data = await fetchData();<br/>  processBank(data);  // might fail if data is in bad shape!!!<br/>};</span></pre><p id="eb7f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">原因是外部API可能返回不符合<code class="fe my mz na mo b">Bank</code>类型的对象，并且没有错误处理，<code class="fe my mz na mo b">processBank</code>中的业务逻辑可能会产生意外/不希望的结果。</p><h1 id="ed3d" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">有什么教训？</h1><p id="fffc" class="pw-post-body-paragraph jq jr it js b jt nb jv jw jx nc jz ka kb nd kd ke kf ne kh ki kj nf kl km kn im bi translated">一般的经验法则是:</p><blockquote class="ng nh ni"><p id="7e1a" class="jq jr nj js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">验证应用程序的所有外部来源。</p></blockquote><p id="9f49" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">外部来源是外部的或无法访问您的应用程序的任何东西。一些例子:</p><ul class=""><li id="bb8f" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">API响应</li><li id="8330" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">文件内的内容</li><li id="285f" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">来自用户的输入</li><li id="18c2" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">无类型库</li></ul><p id="a94e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有两种方法可以在Typescript中验证运行时类型:通过第三个库 <code class="fe my mz na mo b"><strong class="js iu">Zod</strong></code>或者通过<strong class="js iu">构建定制的类型守卫</strong>。各有利弊。</p><h1 id="0561" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">介绍<a class="ae lc" href="https://www.npmjs.com/package/zod" rel="noopener ugc nofollow" target="_blank">佐德</a></h1><p id="6b7d" class="pw-post-body-paragraph jq jr it js b jt nb jv jw jx nc jz ka kb nd kd ke kf ne kh ki kj nf kl km kn im bi translated"><a class="ae lc" href="https://zod.dev/" rel="noopener ugc nofollow" target="_blank"> Zod </a>是Typescript的类型和在Javascript中实施类型之间缺少的环节。它允许您定义模式、推断类型并在一次刷卡中验证数据。</p><p id="f09d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的<code class="fe my mz na mo b">Bank</code>类型可以这样定义:</p><pre class="le lf lg lh gt mn mo mp mq aw mr bi"><span id="a0a1" class="ms lq it mo b gy mt mu l mv mw">import { z } from "zod";<br/>const BankZModel = z.object({<br/>  id: z.number(),<br/>  uid: z.string(),<br/>  account_number: z.string(),<br/>  iban: z.string(),<br/>  bank_name: z.string(),<br/>  routing_number: z.string(),<br/>  swift_bic: z.string(),<br/>});</span></pre><p id="ccb1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后可以从该模式中提取(推断)类型。</p><pre class="le lf lg lh gt mn mo mp mq aw mr bi"><span id="26d7" class="ms lq it mo b gy mt mu l mv mw">type Bank = z.infer&lt;typeof BankZModel&gt;;</span></pre><p id="9a7f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">验证看起来像这样</p><pre class="le lf lg lh gt mn mo mp mq aw mr bi"><span id="dd01" class="ms lq it mo b gy mt mu l mv mw">const bankApiRes = await <!-- -->fetchData();<br/>const bank = <!-- -->BankZModel<!-- -->.parse(bankApiRes) <br/>// <!-- -->BankZModel<!-- -->.parse will throw error if bankApiRes does not comply with <!-- -->Bank type</span></pre><p id="140f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们有了一个类型和经过验证的数据，我们需要编写的代码只比没有验证函数时多一点点。在运行时，它要么保证我们的数据处于良好状态，要么大声地抛出错误以引起开发人员的注意，防止程序无声地失败和累积损失。</p><p id="6a10" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请随时查看zod官方文档以了解更多信息。它支持多种数据类型，如<code class="fe my mz na mo b">map</code> <code class="fe my mz na mo b">set</code> <code class="fe my mz na mo b">object</code>。它还为您正在定义的类型的键和值提供了许多修饰符。它还介绍了异步情况和safeParse，safe parse不会抛出错误，而是允许您决定在解析成功或失败时做什么。Zod将满足您的数据验证需求。</p><h1 id="9c39" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated"><code class="fe my mz na mo b">Customised Type</code>警卫</h1><p id="7147" class="pw-post-body-paragraph jq jr it js b jt nb jv jw jx nc jz ka kb nd kd ke kf ne kh ki kj nf kl km kn im bi translated">类型保护是一些执行运行时检查的表达式，它保证类型在某个范围内。</p><pre class="le lf lg lh gt mn mo mp mq aw mr bi"><span id="e5ca" class="ms lq it mo b gy mt mu l mv mw">// Using type predicates<br/>const isBank = (obj: any): obj is Bank =&gt; {<br/>  return (<br/>    obj.id !== undefined &amp;&amp;<br/>    obj.uid !== undefined &amp;&amp;<br/>    obj.account_number !== undefined &amp;&amp;<br/>    obj.iban !== undefined &amp;&amp;<br/>    obj.bank_name !== undefined &amp;&amp;<br/>    obj.routing_number !== undefined &amp;&amp;<br/>    obj.swift_bic !== undefined<br/>  );<br/>};</span><span id="3426" class="ms lq it mo b gy mx mu l mv mw">// Using the in operator<br/>const isBank = (obj: any): boolean =&gt; {<br/>  return (<br/>    "id" in obj &amp;&amp;<br/>    "uid" in obj &amp;&amp;<br/>    "account_number" in obj &amp;&amp;<br/>    "iban" in obj &amp;&amp;<br/>    "bank_name" in obj &amp;&amp;<br/>    "routing_number" in obj &amp;&amp;<br/>    "swift_bic" in obj<br/>  );<br/>}</span></pre><p id="5ca8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用type guard，我们可以编写自定义控件，控制我们希望如何验证类型以及如何处理错误、警告和日志记录的各个方面。收集业务规则和在类型保护中实现适当处理级别所需的时间和精力越多。</p><h2 id="ae5d" class="ms lq it bd lr nn no dn lv np nq dp lz kb nr ns md kf nt nu mh kj nv nw ml nx bi translated">延伸阅读:</h2><ul class=""><li id="41b8" class="ko kp it js b jt nb jx nc kb ny kf nz kj oa kn kt ku kv kw bi translated"><a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/typescript-must-know-fundamentals-for-your-next-tech-interview-or-project-255ae70df0a3"> TypeScript必备基础知识—类型别名和接口</a></li><li id="6067" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated"><a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/use-typescript-keyof-like-a-pro-56f3a3d06b73">像专家一样使用打字键盘</a></li><li id="81d8" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated"><a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/typescript-classes-from-zero-to-hero-a429a3c96189">打字班——从零到英雄</a></li><li id="c559" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated"><a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/next-level-your-typescript-runtime-type-validation-using-class-and-decorators-ddd2ce3c86f3">使用类和装饰器的下一级Typescript运行时类型验证</a></li><li id="68aa" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated"><a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/mastering-typescript-generics-the-ultimate-guide-3a62afeff44">掌握类型脚本泛型:终极指南</a></li><li id="c096" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated"><a class="ae lc" href="https://bootcamp.uxdesign.cc/typescript-tricks-and-tips-become-a-pro-in-no-time-5390aba151be" rel="noopener" target="_blank">打字技巧和提示:立即成为专业人员</a></li><li id="f813" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated"><a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/generics-in-typescript-must-know-fundamentals-stupidly-simplified-e7b4d7ffc0e3">TypeScript中的泛型——愚蠢简化的基础知识</a></li><li id="ff23" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated"><a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/typescript-enum-pitfalls-and-solutions-must-know-bb971cb0f7d2"> Typescript枚举陷阱和解决方案必须知道</a></li><li id="27e6" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated"><a class="ae lc" href="https://bootcamp.uxdesign.cc/mastering-typescript-generics-the-ultimate-guide-essential-interface-techniques-86e793cf1fc" rel="noopener" target="_blank">掌握类型脚本泛型—终极指南—基本接口技术</a></li><li id="0a9f" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">【Javascript开发者经常忽略的Typescript特性</li><li id="bc34" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">掌握打字稿中的交集和并集类型:终极指南和基本技巧</li></ul></div><div class="ab cl ob oc hx od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="im in io ip iq"><p id="7125" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你觉得这个指南有帮助，请鼓掌并跟我来。通过<a class="ae lc" href="https://medium.com/@caopengau/membership" rel="noopener">链接</a>加入medium，获取我和所有其他优秀作家在medium上发表的所有优质文章。</p></div><div class="ab cl ob oc hx od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="im in io ip iq"><h1 id="137e" class="lp lq it bd lr ls oi lu lv lw oj ly lz ma ok mc md me ol mg mh mi om mk ml mm bi translated">分级编码</h1><p id="436b" class="pw-post-body-paragraph jq jr it js b jt nb jv jw jx nc jz ka kb nd kd ke kf ne kh ki kj nf kl km kn im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="474a" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="36c4" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">📰查看<a class="ae lc" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">级编码出版物</a>中的更多内容</li><li id="6d6b" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">🔔关注我们:<a class="ae lc" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a> | <a class="ae lc" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a> | <a class="ae lc" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="7f4f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">🚀👉<a class="ae lc" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">加入升级人才集体，找到一份惊艳的工作</strong> </a></p></div></div>    
</body>
</html>