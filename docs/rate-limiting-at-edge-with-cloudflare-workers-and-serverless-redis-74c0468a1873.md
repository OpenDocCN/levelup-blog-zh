# Cloudflare Workers å’Œæ— æœåŠ¡å™¨ Redis çš„è¾¹ç¼˜é€Ÿç‡é™åˆ¶

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/rate-limiting-at-edge-with-cloudflare-workers-and-serverless-redis-74c0468a1873>

![](img/a1e4f45fe1079062547ab4e4a1468f29.png)

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Cloudflare Workers å’Œ Upstash Redis å¯¹æ‚¨çš„åº”ç”¨ç¨‹åºè¿›è¡Œé€Ÿç‡é™åˆ¶ã€‚æˆ‘ä»¬å°†ä½¿ç”¨[é€Ÿç‡é™åˆ¶ SDK](https://github.com/upstash/ratelimit) ï¼Œå®ƒå°†æ•°æ®ä¿å­˜åœ¨ Upstash Redis ä¸­ã€‚

# Redis è®¾ç½®

ä½¿ç”¨ [Upstash æ§åˆ¶å°](https://console.upstash.com)æˆ– [Upstash CLI](https://github.com/upstash/cli) åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª Redis æ•°æ®åº“ã€‚ä¸è¦é€‰æ‹©å…¨å±€ï¼Œè€Œæ˜¯åœ¨ä¸åŒçš„åŒºåŸŸåˆ›å»ºå¤šä¸ªæ•°æ®åº“ï¼Œåœ¨é‚£é‡Œä½ çš„ç«™ç‚¹ä¼šæœ‰æµé‡ã€‚(ä¸ºä»€ä¹ˆï¼Ÿæˆ‘ä»¬å°†ç¨åè§£é‡Š)åœ¨æ¥ä¸‹æ¥çš„æ­¥éª¤ä¸­ï¼Œæ‚¨å°†éœ€è¦ REST URL å’Œä»¤ç‰Œã€‚

# é¡¹ç›®è®¾ç½®

æˆ‘ä»¬å°†ä½¿ç”¨ç‰§é©¬äºº 2 è¿›è¡Œéƒ¨ç½²ï¼Œå› æ­¤å®‰è£…(æˆ–å‡çº§)[ç‰§é©¬äºº 2](https://developers.cloudflare.com/workers/wrangler/) ã€‚

ä¸ºæ‚¨çš„é¡¹ç›®åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹å¹¶è¿è¡Œ`wrangler init`ã€‚é€‰æ‹©`ts`:

```
â›…ï¸ wrangler 2.0.7 (update available 2.0.26) ------------------------------------------------------ Using npm as package manager. 
âœ¨ Created wrangler.toml No package.json found.
 Would you like to create one? (y/n) 
âœ¨ Created package.json Would you like to use TypeScript? (y/n) 
âœ¨ Created tsconfig.json Would you like to create a Worker at src/index.ts? (y/n) 
âœ¨ Created src/index.ts
```

# ä»£ç 

æ›´æ–°å·¥äººåŠŸèƒ½å¦‚ä¸‹:

æ›¿æ¢ä¸Šé¢ Redis å®ä¾‹çš„ REST_URL å’Œæ ‡è®°ã€‚æ‚¨å¯ä»¥æ ¹æ®æ‚¨çš„æµé‡åœ¨ä¸åŒçš„åŒºåŸŸæ·»åŠ æ›´å¤šçš„ Redis æ•°æ®åº“(æˆ–è®¾ç½®ä¸€ä¸ª)ã€‚

# æµ‹è¯•å’Œéƒ¨ç½²

æ‚¨å¯ä»¥ä½¿ç”¨`wrangler dev`åœ¨æœ¬åœ°æµ‹è¯•è¯¥åŠŸèƒ½ã€‚

ä½¿ç”¨`wrangler publish`å°†æ‚¨çš„åŠŸèƒ½éƒ¨ç½²åˆ° Cloudflare

å‡½æ•°çš„ç«¯ç‚¹å°†è¢«æ‰“å°å‡ºæ¥ã€‚ä¾‹å¦‚[https://cloud flare-workers-rate-limiting . upsdev . workers . dev/](https://cloudflare-workers-rate-limiting.upsdev.workers.dev/)å½“ä½ è¿ç»­åˆ·æ–°é¡µé¢ 5 æ¬¡ï¼Œåº”è¯¥ä¼šçœ‹åˆ°ä½ æ˜¯é€Ÿç‡å—é™çš„ã€‚

å¥½äº†ï¼Œæ•™ç¨‹ç»“æŸäº†(å¾ˆå®¹æ˜“å§ï¼Ÿ)ï¼Œç°åœ¨è®©æˆ‘ä»¬è¿›å…¥ä¸€äº›ç»†èŠ‚ã€‚

# å¯¹æ¯ä¸ªè¯·æ±‚è¿›è¡Œè¿œç¨‹è°ƒç”¨çš„æˆæœ¬ä¸æ˜¯å¾ˆé«˜å—ï¼Ÿ

å¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨çŸ­æš‚çš„ç¼“å­˜ï¼Œå®ƒå¯èƒ½æ˜¯ã€‚[ä¸´æ—¶ç¼“å­˜](https://github.com/upstash/ratelimit#ephemeral-cache)æ˜¯åœ¨å¤„ç†ç¨‹åºä¹‹å¤–å®šä¹‰çš„ map å¯¹è±¡ã€‚å½“æ— æœåŠ¡å™¨åŠŸèƒ½æ¿€æ´»(çƒ­)æ—¶ï¼Œé€Ÿç‡é™åˆ¶ SDK ä½¿ç”¨å®ƒæ¥ç¼“å­˜æ ‡è¯†ç¬¦ã€‚åœ¨å¤„ç†ç¨‹åºä¹‹å¤–å®šä¹‰å®ƒå¾ˆé‡è¦ï¼Œå› æ­¤å®ƒå°†æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ã€‚Cloudflare Workers ä¸ä¿è¯ä¸åŒçš„è°ƒç”¨ä¼šä½¿ç”¨åŒä¸€ä¸ªå˜é‡ï¼Œä½†åœ¨æµé‡é«˜å³°æ—¶ç¼“å­˜å®ƒè¿˜æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚

# ä¸ºä»€ä¹ˆä¸æ˜¯å…¨çƒæ•°æ®åº“ï¼Ÿ

Upstash Global databases å°† Redis æ•°æ®å¤åˆ¶åˆ°å¤šä¸ªåœ°åŒºã€‚å®ƒéå¸¸é€‚åˆè®¸å¤šè¾¹ç¼˜ä½¿ç”¨æ¡ˆä¾‹ã€‚ä½†æ˜¯å¯¹äºé€Ÿç‡é™åˆ¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦å°†ä¸€ä¸ªåŒºåŸŸä¸­çš„æ•°æ®å¤åˆ¶åˆ°æ‰€æœ‰å…¶ä»–åŒºåŸŸã€‚é€Ÿç‡é™åˆ¶ä¼šè¯å…·æœ‰æœ¬åœ°ä½œç”¨åŸŸã€‚æˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå…¨çƒæ•°æ®åº“ï¼Œä½†è¿™å°†æ˜¯ä¸å¿…è¦çš„æˆæœ¬ï¼Œå› ä¸ºæ¯æ¬¡æ›´æ–°éƒ½å°†è¢«å¤åˆ¶åˆ°ä¸–ç•Œå„åœ°ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬é€‰æ‹©åˆ›å»ºå¤šä¸ªåŒºåŸŸæ€§æ•°æ®åº“ï¼Œæ­£å¦‚é™é€Ÿ SDK æ¨èçš„é‚£æ ·ã€‚

# IP ä½œä¸ºæ ‡è¯†ç¬¦

æˆ‘ä»¬å·²ç»ä½¿ç”¨ç”¨æˆ·çš„ IP ä½œä¸ºé€Ÿç‡é™åˆ¶åŠŸèƒ½çš„æ ‡è¯†ç¬¦ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬é™åˆ¶å•ä¸ªç”¨æˆ·çš„é€Ÿç‡ã€‚å¦‚æœæ‚¨çš„è¯·æ±‚ä¸­æœ‰æ›´å¥½çš„æ ‡è¯†ç¬¦(ç”¨æˆ·åã€ç”µå­é‚®ä»¶ç­‰)ï¼Œè¯·ä½¿ç”¨å®ƒã€‚å¦‚æœæ‚¨æƒ³é™åˆ¶æ€»æµé‡ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªå¸¸é‡å­—ç¬¦ä¸²ã€‚æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨åœ°åŒºæˆ–å›½å®¶( [request.cf.country](https://developers.cloudflare.com/workers/examples/country-code-redirect/) )ä½œä¸ºæ ‡è¯†ç¬¦æ¥é™åˆ¶æ¯ä¸ªåœ°ç†åŒºåŸŸçš„æµé‡ã€‚

# æˆ‘å¯ä»¥ä½¿ç”¨è‡ªæ‰˜ç®¡ Redis å—ï¼Ÿ

Cloudflare Workers åœ¨ V8 éš”ç¦»ä¸Šè¿è¡Œï¼Œä¸å…è®¸ TCP è¿æ¥ã€‚æ‰€ä»¥ä½ ä¸èƒ½è®¿é—®è‡ªæ‰˜ç®¡çš„ Redisã€Redislabs æˆ– Elasticacheï¼Œé™¤éä½ ä½¿ç”¨ REST ä»£ç†ã€‚upshredis æœ‰ä¸€ä¸ªå†…ç½®çš„ REST APIã€‚

# æ•´åˆåˆ°æ‚¨ç°æœ‰çš„ç½‘ç«™

æ‚¨å¯ä»¥å¯¹ç°æœ‰çš„ web åº”ç”¨ç¨‹åº/ç½‘ç«™è¿›è¡Œåˆ†çº§é™åˆ¶ï¼Œè€Œæ— éœ€è§¦åŠå®ƒä»¬çš„ä»£ç ã€‚æ‚¨åªéœ€è¦åœ¨ Cloudflare ä¸­åˆ›å»ºä¸€ä¸ªç«™ç‚¹ï¼Œå¹¶ç›¸åº”åœ°ä¸ºæ‚¨çš„åŸŸè®¾ç½®åç§°æœåŠ¡å™¨ã€‚å› æ­¤ï¼ŒCloudflare å°†èƒ½å¤Ÿæ‹¦æˆªå¯¹æ‚¨ç½‘ç«™çš„è¯·æ±‚ï¼Œå¹¶è¿è¡Œ Workers åŠŸèƒ½ã€‚å¦å¤–ï¼Œå–æ¶ˆå¯¹ XX è¡Œçš„æ³¨é‡Šï¼Œå¦‚æœè¯·æ±‚æ²¡æœ‰é€Ÿç‡é™åˆ¶ï¼Œé‚£ä¹ˆ Workers å‡½æ•°ä¼šå°†è¯·æ±‚è½¬å‘åˆ°æ‚¨çš„ç½‘ç«™ã€‚

*åŸè½½äº 2022 å¹´ 8 æœˆ 22 æ—¥*[*https://dev . to*](https://dev.to/noahfschr/rate-limiting-at-edge-with-cloudflare-workers-and-serverless-redis-4opd)*ã€‚*

# åˆ†çº§ç¼–ç 

æ„Ÿè°¢æ‚¨æˆä¸ºæˆ‘ä»¬ç¤¾åŒºçš„ä¸€å‘˜ï¼åœ¨ä½ ç¦»å¼€ä¹‹å‰:

*   ğŸ‘ä¸ºæ•…äº‹é¼“æŒï¼Œè·Ÿç€ä½œè€…èµ°ğŸ‘‰
*   ğŸ“°æŸ¥çœ‹[å‡çº§ç¼–ç å‡ºç‰ˆç‰©](https://levelup.gitconnected.com/?utm_source=pub&utm_medium=post)ä¸­çš„æ›´å¤šå†…å®¹
*   ğŸ””å…³æ³¨æˆ‘ä»¬:[Twitter](https://twitter.com/gitconnected)|[LinkedIn](https://www.linkedin.com/company/gitconnected)|[æ—¶äº‹é€šè®¯](https://newsletter.levelup.dev)

ğŸš€ğŸ‘‰ [**åŠ å…¥å‡çº§äººæ‰é›†ä½“ï¼Œæ‰¾åˆ°ä¸€ä»½ç¥å¥‡çš„å·¥ä½œ**](https://jobs.levelup.dev/talent/welcome?referral=true)