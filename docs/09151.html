<html>
<head>
<title>Set up an AWS Amplify app with Google Sign In</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google登录设置AWS Amplify应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/set-up-an-aws-amplify-app-with-google-sign-in-c738df79d272?source=collection_archive---------0-----------------------#2021-07-11">https://levelup.gitconnected.com/set-up-an-aws-amplify-app-with-google-sign-in-c738df79d272?source=collection_archive---------0-----------------------#2021-07-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/62a6012ab031a42b22c5af7be6029333.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QG2yBTbSxaMTQhxnXsgYHw.png"/></div></div></figure><p id="fb61" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文讨论了如何使用React应用程序前端设置一个带有Google Sign的Amplify应用程序。这也将提到如何为每个应用程序配置多个重定向URIs。</p><p id="49ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一部分专门介绍React、Github、Amplify和Google开发者控制台的样板设置，第二部分介绍如何添加auth。</p><blockquote class="kw kx ky"><p id="8d13" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">/**如果您已经创建了一个应用程序，请跳过设置步骤，直接转到标题<strong class="ka ir">添加授权以放大应用程序</strong> */</p></blockquote><h1 id="f21a" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">设置反应和放大</h1><h2 id="2359" class="mb le iq bd lf mc md dn lj me mf dp ln kj mg mh lr kn mi mj lv kr mk ml lz mm bi translated"><strong class="ak"> 1。创建一个新的React应用和GitHub repo，在Google开发者控制台中添加一个项目</strong></h2><p id="f0c0" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated"><strong class="ka ir">在命令行上</strong></p><ul class=""><li id="5d55" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">在应用程序中创建一个带有<code class="fe nb nc nd ne b">npx create-react-app google-test</code>、<code class="fe nb nc nd ne b">cd</code>的react应用程序，并在您的本地机器上运行<code class="fe nb nc nd ne b">npm start</code>来启动它。</li><li id="3bd8" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">在GH中为app新建一个回购，推送到这个回购。</li></ul><p id="4021" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">在AWS控制台</strong></p><ul class=""><li id="d342" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">登录AWS控制台，找到Amplify服务。</li><li id="e832" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">在主放大页面上，选择<strong class="ka ir">开始</strong>和<strong class="ka ir">交付</strong>创建一个web应用<em class="kz">或</em>从应用页面上，选择<strong class="ka ir">新建应用</strong>和<strong class="ka ir"> Web应用。</strong></li><li id="7b74" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">选择GitHub作为提供商。</li><li id="7de6" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">如果没有，请与GH联系。</li><li id="2d9d" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">选择回购和分支<code class="fe nb nc nd ne b">main</code>。</li><li id="dd76" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">选择默认构建设置。我使用npm作为包管理器，所以我在<code class="fe nb nc nd ne b">npm start</code>和<code class="fe nb nc nd ne b">npm run build</code>命令中从<code class="fe nb nc nd ne b">yarn</code>改为<code class="fe nb nc nd ne b">npm</code>。</li><li id="df93" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">保存。</li></ul><p id="517b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的GH repo将与Amplify实例同步，并将设置持续部署——</p><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/98555eb175235759405db21694d90222.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6IabBxdLbk3xJtejJgdFRA.png"/></div></div></figure><p id="f864" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">在谷歌开发者控制台</strong></p><ul class=""><li id="02ac" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">创建一个项目并命名。</li><li id="537c" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">在API和服务页面中，选择<strong class="ka ir"> Oauth同意屏幕</strong>选项卡。</li><li id="3503" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">使用必填字段设置OAuth同意屏幕—这些字段稍后都可以更改。</li><li id="dc86" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">选择<strong class="ka ir">凭证</strong>选项卡→创建凭证→ Oauth客户端ID</li></ul><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/1c6832303ae2855755f62c4d8a338f23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B6UnsfIYfMcoGffHqprtNQ.png"/></div></div></figure><ul class=""><li id="b4f5" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">命名项目并保存它以获得Oauth客户端ID和密码。我以JSON的形式下载了它，以便于以后访问。</li></ul><h2 id="2cf3" class="mb le iq bd lf mc md dn lj me mf dp ln kj mg mh lr kn mi mj lv kr mk ml lz mm bi translated">2.在React应用中设置Amplify</h2><p id="fd8b" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated"><strong class="ka ir">在命令行上</strong></p><ul class=""><li id="ab76" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated"><code class="fe nb nc nd ne b">npm install -g @aws-amplify/cli</code> —安装Amplify CLI，允许您使用前缀为<code class="fe nb nc nd ne b">amplify</code>的CLI命令。</li></ul><p id="9f2e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">在AWS控制台</strong></p><ul class=""><li id="4857" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">在您的项目页面中，单击<strong class="ka ir">后端环境</strong>选项卡→ <strong class="ka ir">开始。</strong>这将初始化一个后端环境。</li><li id="80db" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">完成后，点击<strong class="ka ir">本地设置说明下拉菜单</strong>并复制CLI命令:<code class="fe nb nc nd ne b">amplify pull --appId {appId} --envName staging</code></li></ul><p id="832b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">在命令行上</strong></p><ul class=""><li id="fcf1" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">运行复制的命令。</li><li id="97bb" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">在浏览器中登录放大管理用户界面。</li><li id="3c21" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">从列出的选项中选择默认值或适用于您的项目的选项。</li></ul><pre class="nl nm nn no gt nq ne nr ns aw nt bi"><span id="eac9" class="mb le iq ne b gy nu nv l nw nx">? Choose your default editor: <strong class="ne ir">Visual Studio Code</strong><br/>? Choose the type of app that you're building <strong class="ne ir">javascript</strong><br/>Please tell us about your project<br/>? What javascript framework are you using <strong class="ne ir">react</strong><br/>? Source Directory Path:  <strong class="ne ir">src</strong><br/>? Distribution Directory Path: <strong class="ne ir">build</strong><br/>? Build Command:  <strong class="ne ir">npm run-script</strong> <strong class="ne ir">build</strong><br/>? Start Command: <strong class="ne ir">npm run-script</strong> <strong class="ne ir">start</strong><br/>? Do you plan on modifying this backend? <strong class="ne ir">Yes</strong></span></pre><ul class=""><li id="11d6" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated"><code class="fe nb nc nd ne b">amplify pull</code></li><li id="8a1d" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated"><code class="fe nb nc nd ne b">npm install aws-amplify</code></li></ul><h1 id="5bd1" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">将auth添加到Amplify应用程序</h1><h2 id="9e83" class="mb le iq bd lf mc md dn lj me mf dp ln kj mg mh lr kn mi mj lv kr mk ml lz mm bi translated">1.将auth添加到Amplify后端，并完成Google Oauth同意屏幕的设置</h2><p id="cb41" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated"><strong class="ka ir">在命令行上</strong></p><ul class=""><li id="bb24" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated"><code class="fe nb nc nd ne b">amplify add auth</code> —我们现在正在将<strong class="ka ir"> auth </strong>基础设施添加到我们的应用中！</li><li id="f5bb" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">它将显示一个选项列表—选择<strong class="ka ir">与社交提供商(联盟)</strong>的默认配置以使用社交登录和直接登录，并选择您希望用户能够进行身份验证的其他方式(电子邮件、用户名、电话号码)。</li></ul><pre class="nl nm nn no gt nq ne nr ns aw nt bi"><span id="341f" class="mb le iq ne b gy nu nv l nw nx">Do you want to use the default authentication and security configuration? <strong class="ne ir">Default configuration with Social Provider (Federation)</strong><br/> Warning: you will not be able to edit these selections.<br/> How do you want users to be able to sign in? <strong class="ne ir">Email</strong><br/> Do you want to configure advanced settings? <strong class="ne ir">No, I am done.</strong><br/> What domain name prefix do you want to use? <strong class="ne ir">googlesignin</strong><br/> Enter your redirect signin URI: <a class="ae ny" href="https://main.dpdzznty4hgmh.amplifyapp.com/" rel="noopener ugc nofollow" target="_blank"><strong class="ne ir">https://main.dpdzznty4hgmh.amplifyapp.com/</strong></a><br/>? Do you want to add another redirect signin URI <strong class="ne ir">Yes</strong><br/> Enter your redirect signin URI: <a class="ae ny" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"><strong class="ne ir">http://localhost:3000/</strong></a><br/>? Do you want to add another redirect signin URI <strong class="ne ir">No</strong><br/> Enter your redirect signout URI: <a class="ae ny" href="https://main.dpdzznty4hgmh.amplifyapp.com/" rel="noopener ugc nofollow" target="_blank"><strong class="ne ir">https://main.dpdzznty4hgmh.amplifyapp.com/</strong></a><br/>? Do you want to add another redirect signout URI <strong class="ne ir">Yes</strong><br/> Enter your redirect signout URI: <a class="ae ny" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"><strong class="ne ir">http://localhost:3000/</strong></a><br/>? Do you want to add another redirect signout URI <strong class="ne ir">No</strong><br/> Select the social providers you want to configure for your user pool: <strong class="ne ir">Google</strong></span></pre><ul class=""><li id="fc0f" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">对于<strong class="ka ir">域名前缀，</strong>你可以使用默认给定的，我只是有一个受保护的词，<code class="fe nb nc nd ne b">aws</code>在我的，所以我不得不改变它。</li><li id="6a9a" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">对于<strong class="ka ir">重定向签到/签出URIs </strong>添加Amplify app的URL，可以找到<strong class="ka ir">前端环境</strong>标签，结构类似<code class="fe nb nc nd ne b">main. ... .amplifyapp.com</code>。我添加了两个重定向登录/注销URIs，一个用于“已部署”URL，另一个用于localhost在我的本地机器上测试auth。</li><li id="c78e" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated"><code class="fe nb nc nd ne b">amplify push</code></li></ul><blockquote class="kw kx ky"><p id="efa3" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">❓ <strong class="ka ir">问:什么是重定向登录/注销URI？</strong></p><p id="f44b" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">⁉️ <strong class="ka ir">答:</strong>当用户点击登录谷歌时，他们会被带到谷歌运营的页面，在那里他们的谷歌证书会被验证。如果你看看这个网页的网址，它是这样的:<code class="fe nb nc nd ne b"><a class="ae ny" href="https://accounts.google.com/o/oauth2/auth/" rel="noopener ugc nofollow" target="_blank">accounts.google.com/o/oauth</a>…</code>。这意味着一旦注册完成，用户必须被推回到主站点。该URL定义了该用户将被推送到哪里。</p></blockquote><p id="fbb2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> In React &gt; src文件夹</strong></p><ul class=""><li id="7b5f" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">一旦更新被推送，中的<code class="fe nb nc nd ne b">/src</code>文件夹中的<code class="fe nb nc nd ne b">aws-exports.js</code>文件将会使用Amplify中设置的Oauth配置进行更新。</li><li id="4481" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">复制oauth对象中的<code class="fe nb nc nd ne b">domain</code>，例如<code class="fe nb nc nd ne b">googlesignin-staging.auth.us-east-2.amazoncognito.com</code></li></ul><p id="c621" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">在谷歌开发者控制台</strong></p><ul class=""><li id="bc32" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated"><strong class="ka ir">凭证</strong>选项卡→ Oauth 2.0客户端id→单击铅笔图标编辑您的项目。</li><li id="9eef" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">将复制的域添加为授权的Javascript源，并重定向URI。在重定向URIs部分的域末尾，添加<code class="fe nb nc nd ne b">/oauth2/idpresponse</code>。这是不可配置的，所以您必须准确地添加片段。</li></ul><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/9b13d40a52fd3db91012f191e9c42c7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gt66C5a2PfNwlt8sLOTkLw.png"/></div></div></figure><blockquote class="kw kx ky"><p id="0ca4" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">❓ <strong class="ka ir">问:</strong> <code class="fe nb nc nd ne b"><strong class="ka ir">/oauth2/idresponse</strong></code> <strong class="ka ir">片段是做什么用的？</strong></p><p id="387b" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">⁉️ <strong class="ka ir">答:</strong>这个<strong class="ka ir"> </strong>是来自Amplify的现有端点，在Oauth登录期间<a class="ae ny" href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-social-idp.html#cognito-user-pools-social-idp-step-1" rel="noopener ugc nofollow" target="_blank">处理重定向。因为您的Amazon Cognito用户池URL与您的应用程序相关联，它可以使用此端点将您的用户发送到您在Amplify配置中指定的重定向。</a></p></blockquote><h1 id="8848" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">在前端使用谷歌登录</h1><h2 id="59cc" class="mb le iq bd lf mc md dn lj me mf dp ln kj mg mh lr kn mi mj lv kr mk ml lz mm bi translated">1.将index.js配置为侦听多个重定向URIs</h2><ul class=""><li id="9214" class="ms mt iq ka b kb mn kf mo kj oa kn ob kr oc kv mx my mz na bi translated">首先，我们将把Amplify和auth config导入React应用程序，并添加一些条件来检测env将使用哪个重定向登录/注销URI。</li><li id="b35a" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">我粗略地使用了在重定向URIs标题下的放大文档<a class="ae ny" href="https://docs.amplify.aws/lib/auth/social/q/platform/js#amazon-cognito-user-pool-setup" rel="noopener ugc nofollow" target="_blank">中概述的代码示例。</a></li></ul><p id="e8dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> index.js </strong></p><pre class="nl nm nn no gt nq ne nr ns aw nt bi"><span id="ac89" class="mb le iq ne b gy nu nv l nw nx">// add to existing imports<br/>import Amplify from 'aws-amplify';<br/>import config from './aws-exports';<br/></span><span id="a06e" class="mb le iq ne b gy od nv l nw nx">// check if env is localhost or not<br/>// if you're not developing on localhost, you will need to detect this is another way—the docs linked above give some examples. </span><span id="0c77" class="mb le iq ne b gy od nv l nw nx">const isLocalhost = !!(window.location.hostname === "localhost");</span><span id="2bb9" class="mb le iq ne b gy od nv l nw nx"><br/>// split redirect signin and signout strings into correct URIs</span><span id="f8bf" class="mb le iq ne b gy od nv l nw nx">const [<br/>productionRedirectSignIn,<br/>localRedirectSignIn ] = config.oauth.redirectSignIn.split(",");</span><span id="f01e" class="mb le iq ne b gy od nv l nw nx">const [<br/>productionRedirectSignOut,<br/>localRedirectSignOut ] = config.oauth.redirectSignOut.split(",");</span><span id="694f" class="mb le iq ne b gy od nv l nw nx"><br/>// use correct URI in the right env</span><span id="2834" class="mb le iq ne b gy od nv l nw nx">const updatedAwsConfig = {<br/>...config,<br/>oauth: {<br/>...config.oauth,<br/>redirectSignIn: isLocalhost <br/>    ? localRedirectSignIn <br/>    : productionRedirectSignIn,<br/>redirectSignOut: isLocalhost <br/>    ? localRedirectSignOut <br/>    : productionRedirectSignOut, }<br/>}</span><span id="c7ea" class="mb le iq ne b gy od nv l nw nx"><br/>Amplify.configure(updatedAwsConfig);</span></pre><blockquote class="kw kx ky"><p id="e209" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">您可以通过只让auth在开发或生产环境中工作来避免多次重定向this但这似乎会使测试/部署更加困难。</p></blockquote><ul class=""><li id="6acd" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">需要一些基本的用户界面来完成这个例子。我跑<code class="fe nb nc nd ne b">npm i skylight-react</code>是为了用一个我做的基本组件库，但是用什么组件由你决定！要使用AWS UI库，也要安装<code class="fe nb nc nd ne b">@aws-amplify/ui-react</code>包……我觉得这个UI库简直太单调了，不过那是主观的。</li><li id="4fc4" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">我们将配置App.js，使用Amplify <strong class="ka ir"> Auth </strong>类检查每个页面刷新中是否存在用户，并使用事件监听器组件<strong class="ka ir"> Hub </strong>监听Auth事件登录和注销。</li></ul><h2 id="57b1" class="mb le iq bd lf mc md dn lj me mf dp ln kj mg mh lr kn mi mj lv kr mk ml lz mm bi translated">2.监听身份验证并将用户存储在状态中</h2><p id="9053" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">这建立了一个基本的配置，如果有用户，他们将被定向到<UserHome/>页面，如果没有，将被定向到一个普通的<Landing/>页面。</p><ul class=""><li id="fb50" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">在这个例子中，我将用户存储在简单的useState中，但是更大的应用程序将使用useContext钩子或状态管理库来存储用户。</li></ul><p id="6742" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> App.js </strong></p><pre class="nl nm nn no gt nq ne nr ns aw nt bi"><span id="a00a" class="mb le iq ne b gy nu nv l nw nx">import React, { useEffect, useState } from 'react';<br/>import { Hub, Auth } from 'aws-amplify';<br/>import { Loader } from 'skylight-react';<br/>import './App.css';<br/>import 'skylight-react/dist/skylight.css';<br/>import Landing from './modules/Landing';<br/>import UserHome from './modules/UserHome';</span><span id="5f4a" class="mb le iq ne b gy od nv l nw nx">function App() {</span><span id="202a" class="mb le iq ne b gy od nv l nw nx">// init state to store user and show loader </span><span id="8ab0" class="mb le iq ne b gy od nv l nw nx">const [user, setUser] = useState(null);<br/>const [loading, setLoading] = useState(true);</span><span id="b386" class="mb le iq ne b gy od nv l nw nx"><br/>// get user</span><span id="6cc6" class="mb le iq ne b gy od nv l nw nx">async function getUser() {<br/>try {<br/>const token = await Auth.currentAuthenticatedUser();<br/>   setLoading(false);<br/>   setUser(token);<br/>} catch(err) {<br/>   console.log(err);<br/>   setLoading(false);<br/>   }<br/>}</span><span id="0598" class="mb le iq ne b gy od nv l nw nx">//listen for sign in + out events, if neither are happening check if user exists </span><span id="d15d" class="mb le iq ne b gy od nv l nw nx">useEffect(() =&gt; {<br/>Hub.listen('auth', ({ payload }) =&gt; {<br/>   if (payload.event === 'signIn') {<br/>      return getUser();<br/>}</span><span id="7533" class="mb le iq ne b gy od nv l nw nx">   if (payload.event === 'signOut') {<br/>      setUser(null);<br/>      return setLoading(false);<br/>     }<br/>});</span><span id="8fcd" class="mb le iq ne b gy od nv l nw nx">getUser();<br/>}, []);</span><span id="2a78" class="mb le iq ne b gy od nv l nw nx"><br/>// show loading screen while fetching, otherwise return page</span><span id="0404" class="mb le iq ne b gy od nv l nw nx">if(loading) return &lt;Loader/&gt;</span><span id="f220" class="mb le iq ne b gy od nv l nw nx">return (</span><span id="5d7b" class="mb le iq ne b gy od nv l nw nx">&lt;div className="App"&gt;</span><span id="ccef" class="mb le iq ne b gy od nv l nw nx">  {user</span><span id="5133" class="mb le iq ne b gy od nv l nw nx">     ? &lt;UserHome email={user.attributes.email}/&gt;</span><span id="96f1" class="mb le iq ne b gy od nv l nw nx">     : &lt;Landing/&gt;}</span><span id="ec14" class="mb le iq ne b gy od nv l nw nx">&lt;/div&gt;</span><span id="f467" class="mb le iq ne b gy od nv l nw nx">)};</span><span id="8454" class="mb le iq ne b gy od nv l nw nx">export default (App);</span></pre><ul class=""><li id="c1ca" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">我们在每次登录事件或任何没有注销事件的页面加载时检查用户。<code class="fe nb nc nd ne b">currentAuthenticatedUser()</code>方法返回一个CognitoUser类，该类包含关于用户及其元数据的信息。这个物体看起来像这样:</li></ul><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/5895f50aebe17abeabf9c020a16886bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xfTKQR8lL9VUwrzB0VRj_g.png"/></div></div></figure><ul class=""><li id="b851" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">属性是一个包含用户信息的对象，比如email。这就是如何使用<code class="fe nb nc nd ne b">user.attributes.email</code>属性在前端获取用户的电子邮件。</li><li id="5890" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">如果没有auth user，则不会返回任何内容。</li><li id="c02b" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated"><em class="kz">参见底部的参考资料部分，获取Hub和Auth的开发文档。</em></li></ul><h2 id="39af" class="mb le iq bd lf mc md dn lj me mf dp ln kj mg mh lr kn mi mj lv kr mk ml lz mm bi translated">3.使用Google按钮登录，并添加到登录页面</h2><ul class=""><li id="b105" class="ms mt iq ka b kb mn kf mo kj oa kn ob kr oc kv mx my mz na bi translated">从谷歌<a class="ae ny" href="https://developers.google.com/identity/branding-guidelines" rel="noopener ugc nofollow" target="_blank">这里</a>下载资产或获取按钮的规格。</li></ul><pre class="nl nm nn no gt nq ne nr ns aw nt bi"><span id="b5e6" class="mb le iq ne b gy nu nv l nw nx">import React from 'react';<br/>import { Auth } from 'aws-amplify';<br/>import btn from '../../assets/auth/btn_normal.png';</span><span id="bac2" class="mb le iq ne b gy od nv l nw nx">const GoogleSignIn = () =&gt; {</span><span id="3971" class="mb le iq ne b gy od nv l nw nx">return (</span><span id="73ef" class="mb le iq ne b gy od nv l nw nx">&lt;button onClick={() =&gt; Auth.federatedSignIn({ provider:"Google" })}&gt;</span><span id="1a71" class="mb le iq ne b gy od nv l nw nx">&lt;img src={btn} alt="Google Sign In button"</span><span id="7ccc" class="mb le iq ne b gy od nv l nw nx">     className="googleSignIn"</span><span id="01ac" class="mb le iq ne b gy od nv l nw nx">     style={{height:"45px", width:"190px"}}/&gt;</span><span id="d638" class="mb le iq ne b gy od nv l nw nx">&lt;/button&gt;</span><span id="5e32" class="mb le iq ne b gy od nv l nw nx">);</span><span id="a341" class="mb le iq ne b gy od nv l nw nx">}</span><span id="8feb" class="mb le iq ne b gy od nv l nw nx">export default GoogleSignIn;</span></pre><p id="c46c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> Landing.js </strong></p><pre class="nl nm nn no gt nq ne nr ns aw nt bi"><span id="cd2f" class="mb le iq ne b gy nu nv l nw nx">import React from 'react';<br/>import GoogleSignIn from './auth/GoogleSignIn';<br/>import { Flex } from 'skylight-react';</span><span id="def1" class="mb le iq ne b gy od nv l nw nx">const Landing = () =&gt; {</span><span id="95c3" class="mb le iq ne b gy od nv l nw nx">return (<br/>&lt;Flex column center middle gap={1} height="100vh" width="100%"&gt;</span><span id="fd92" class="mb le iq ne b gy od nv l nw nx">&lt;h3&gt;Authenticate to continue&lt;/h3&gt;</span><span id="f25f" class="mb le iq ne b gy od nv l nw nx">&lt;GoogleSignIn/&gt;</span><span id="dc6b" class="mb le iq ne b gy od nv l nw nx">&lt;/Flex&gt;);<br/>}</span><span id="76ad" class="mb le iq ne b gy od nv l nw nx">export default Landing;</span></pre><ul class=""><li id="2ab5" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">为经过身份验证的用户创建一个基本页面。</li><li id="e897" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">在屏幕上显示用户的电子邮件以证明他们已登录。</li></ul><h2 id="afaf" class="mb le iq bd lf mc md dn lj me mf dp ln kj mg mh lr kn mi mj lv kr mk ml lz mm bi translated">4.创建一个只对授权用户可用的受保护页面</h2><p id="3c28" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated"><strong class="ka ir"> UserHome.js </strong></p><pre class="nl nm nn no gt nq ne nr ns aw nt bi"><span id="9206" class="mb le iq ne b gy nu nv l nw nx">import React from 'react';</span><span id="7d74" class="mb le iq ne b gy od nv l nw nx">import { Flex } from 'skylight-react';</span><span id="3a33" class="mb le iq ne b gy od nv l nw nx">const UserHome = ({ email }) =&gt; {</span><span id="3beb" class="mb le iq ne b gy od nv l nw nx">return (</span><span id="848c" class="mb le iq ne b gy od nv l nw nx">&lt;Flex center middle height="100vh" width="100%" gap={1}&gt;</span><span id="919f" class="mb le iq ne b gy od nv l nw nx">&lt;h3&gt;Hello, {email}.&lt;/h3&gt;</span><span id="2f72" class="mb le iq ne b gy od nv l nw nx">&lt;p&gt;This route is for protected users :~)&lt;/p&gt;</span><span id="c493" class="mb le iq ne b gy od nv l nw nx">&lt;/Flex&gt;</span><span id="e0d7" class="mb le iq ne b gy od nv l nw nx">);</span><span id="a1c6" class="mb le iq ne b gy od nv l nw nx">}</span><span id="faeb" class="mb le iq ne b gy od nv l nw nx">export default UserHome;</span></pre><ul class=""><li id="3bc0" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">按下GitHub，等待Amplify中的更改同步。</li><li id="5b3d" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">这应该对AWS和localhost给我们的URL都有效:3000！</li></ul><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/266e077eaca88a0d51f383f67483a546.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UnnIBj1jQxziPhHw1RJV_w.png"/></div></div><figcaption class="og oh gj gh gi oi oj bd b be z dk translated">匿名用户的超级基本登录页面</figcaption></figure><ul class=""><li id="7aae" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">点击使用Google登录</li></ul><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/c322143df57d35111c35adf95fa2010d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q53UtrL8IZMTIybz0XoAtw.png"/></div></div><figcaption class="og oh gj gh gi oi oj bd b be z dk translated">Google Oauth屏幕</figcaption></figure><ul class=""><li id="adf8" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">注意Oauth屏幕上的名称是amazoncognito.com，而不是配置的应用程序名称。这是因为我们的应用程序是一个<strong class="ka ir">未验证的</strong>外部应用程序，必须通过谷歌验证才能使用显示名称。</li><li id="d664" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">选择一个帐户并进行身份验证。</li></ul><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ol"><img src="../Images/39c8c9b420ef903b7941dd89e9e69000.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9n1bsnf2TL_6P1s4kW1NdA.png"/></div></div><figcaption class="og oh gj gh gi oi oj bd b be z dk translated">我们在…</figcaption></figure><ul class=""><li id="15df" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">要查看用户，请转到AWS控制台中的Cognito服务，然后单击<strong class="ka ir">用户池</strong> →选择您的项目→用户和组</li></ul><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi om"><img src="../Images/ca5f5861b35e356e49adc63785364166.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qjpq2Npr5ARkSYmOq50AdA.png"/></div></div><figcaption class="og oh gj gh gi oi oj bd b be z dk translated">唯一的，孤独的用户</figcaption></figure><p id="2164" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是我们的单一用户！</p><p id="f61b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们有效地完成了这一指南。一些最后要考虑的事情…</p><ul class=""><li id="1803" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">Amazon使用本地存储来存储ID、访问和刷新令牌。所有这些都可以通过在浏览器的开发工具中打开本地存储，在JS中检查它，或者运行<code class="fe nb nc nd ne b">const session = await Auth.currentSession()</code>并查看<code class="fe nb nc nd ne b">session</code>来查看。</li></ul><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi on"><img src="../Images/8fe92953f5330c6cb1bf703104295335.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dNvh5fV9Ze_xISwvwHZhqw.png"/></div></div></figure><ul class=""><li id="e3d6" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">默认情况下，访问和id令牌为60分钟，但最长可达一天。<a class="ae ny" href="https://docs.amplify.aws/lib/auth/emailpassword/q/platform/js#sign-out" rel="noopener ugc nofollow" target="_blank">来源</a>。</li><li id="ff70" class="ms mt iq ka b kb nf kf ng kj nh kn ni kr nj kv mx my mz na bi translated">刷新令牌可以刷新自发布时间起30天的访问权限，但可以设置为60分钟到10年。<a class="ae ny" href="https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html" rel="noopener ugc nofollow" target="_blank">来源</a>。</li></ul><p id="0c5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">放大参考文献:</strong></p><p id="ba11" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ny" href="https://docs.amplify.aws/lib/auth/social/q/platform/js#amazon-cognito-user-pool-setup" rel="noopener ugc nofollow" target="_blank">放大Oauth实现文档</a>—非常全面，参见代码示例</p><p id="7cec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ny" href="https://aws-amplify.github.io/amplify-js/api/classes/authclass.html" rel="noopener ugc nofollow" target="_blank">授权文档</a> ⚫️ <a class="ae ny" href="https://medium.com/@dantasfiles/three-methods-to-get-user-information-in-aws-amplify-authentication-e4e39e658c33" rel="noopener">用户检索方法的解释</a>—这很有用，因为授权API文档很差</p><p id="f8eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ny" href="https://docs.amplify.aws/lib/utilities/hub/q/platform/js" rel="noopener ugc nofollow" target="_blank"> Hub docs </a> ⚫️ <a class="ae ny" href="https://docs.amplify.aws/lib/auth/auth-events/q/platform/js" rel="noopener ugc nofollow" target="_blank">可以监听的Hub auth事件的完整列表</a></p><p id="aa81" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ny" href="https://developers.google.com/identity/branding-guidelines" rel="noopener ugc nofollow" target="_blank">谷歌登录按钮开发文档</a></p><p id="1a28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">参考资料上的社会标志:</strong></p><p id="c681" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ny" href="https://docs.amplify.aws/lib/auth/overview/q/platform/js#accessing-aws-services" rel="noopener ugc nofollow" target="_blank"> AWS |引擎盖下的社会服务提供者联盟</a></p><p id="558f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ny" href="https://medium.com/@bretanac93/how-social-authentication-works-787e4508b75d" rel="noopener">媒介|社会认证如何工作</a></p><p id="8dfc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ny" href="https://auth0.com/learn/social-login/" rel="noopener ugc nofollow" target="_blank"> Auth0 |学习社交登录</a></p><p id="a8e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ny" href="https://developer.okta.com/blog/2017/06/21/what-the-heck-is-oauth" rel="noopener ugc nofollow" target="_blank">Okta | Oauth是什么鬼？</a></p></div></div>    
</body>
</html>