<html>
<head>
<title>Rate Limit Plus Worker Pool in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golangçš„é€Ÿåº¦é™åˆ¶å’Œå·¥äººæ± </h1>
<blockquote>åŸæ–‡ï¼š<a href="https://levelup.gitconnected.com/rate-limit-plus-worker-pool-in-golang-8df5b8cab378?source=collection_archive---------5-----------------------#2022-11-28">https://levelup.gitconnected.com/rate-limit-plus-worker-pool-in-golang-8df5b8cab378?source=collection_archive---------5-----------------------#2022-11-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="8a65" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¿™ç¯‡æ–‡ç« æ˜¯å…³äºå¦‚ä½•ä½¿ç”¨é€Ÿç‡é™åˆ¶ç­–ç•¥å’Œworker poolæ¨¡å¼æ¥å‘å‡ºå¤§é‡HTTPè¯·æ±‚ã€‚</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/d2a45da305f5f609717213d132b716ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9GqmmW831-UjrIlm"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">ç…§ç‰‡ç”±<a class="ae le" href="https://unsplash.com/@sohaib_alkharsa?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">ç´¢æµ·å¸ƒÂ·é˜¿å°”Â·å“ˆå°”è¨</a>åœ¨<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šæ‹æ‘„</figcaption></figure><p id="9601" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ä»£ç å¯åœ¨<a class="ae le" href="https://gist.github.com/jerryan999/ef0aa671b0f15b73c8dbd225f411a963" rel="noopener ugc nofollow" target="_blank"> GitHub </a>ä¸Šè·å¾—ã€‚</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="c676" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">å…ˆå†³æ¡ä»¶</h1><p id="faf5" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">Go <a class="ae le" href="https://pkg.go.dev/go.uber.org/ratelimit" rel="noopener ugc nofollow" target="_blank">é€Ÿç‡é™åˆ¶å™¨</a>åŒ…æ˜¯é™åˆ¶è¯·æ±‚é€Ÿç‡çš„æœ€ç®€å•çš„æ–¹æ³•ã€‚è¿™æ˜¯æˆ‘ä»¬åœ¨è¿™ä¸ªèŒä½ä¸Šå”¯ä¸€çš„å…ˆå†³æ¡ä»¶ã€‚</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mp"><img src="../Images/bf560c5087c6c1fb41334cd49cc6c781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ui-tlMr9yKK_quCR.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">å›¾ç‰‡ç”±<a class="ae le" href="https://www.mikeperham.com/2020/11/09/the-leaky-bucket-rate-limiter/" rel="noopener ugc nofollow" target="_blank">é“¾æ¥</a>æä¾›ã€‚</figcaption></figure><p id="fbb0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¯¥è½¯ä»¶åŒ…æä¾›äº†æ¼æ¡¶é€Ÿç‡é™åˆ¶ç®—æ³•çš„Golangå®ç°ã€‚å¦‚æœä½ å¯¹ç®—æ³•ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥çœ‹çœ‹å…³äºå®ƒçš„æ–‡ç« ã€‚</p><div class="mq mr gp gr ms mt"><a href="https://betterprogramming.pub/4-rate-limit-algorithms-every-developer-should-know-7472cb482f48" rel="noopener  ugc nofollow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd iu gy z fp my fr fs mz fu fw is bi translated">æ¯ä¸ªå¼€å‘äººå‘˜éƒ½åº”è¯¥çŸ¥é“çš„4ç§é€Ÿç‡é™åˆ¶ç®—æ³•</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">å®ç°é€Ÿç‡é™åˆ¶çš„åˆå­¦è€…æŒ‡å—</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">betterç¼–ç¨‹. pub</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh ky mt"/></div></div></a></div><h1 id="2b0b" class="lm ln it bd lo lp ni lr ls lt nj lv lw lx nk lz ma mb nl md me mf nm mh mi mj bi translated">çœŸå®ä¸–ç•Œçš„ä¾‹å­</h1><p id="2395" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">å‡è®¾æˆ‘ä»¬éœ€è¦å‘ç¬¬ä¸‰æ–¹APIå‘å‡ºè®¸å¤šHTTPè¯·æ±‚æ¥è·å–ä¸€äº›æ•°æ®ã€‚APIçš„é€Ÿç‡é™åˆ¶ä¸ºæ¯åˆ†é’ŸXä¸ªè¯·æ±‚ã€‚</p><p id="635b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ä»¥ç¡®ä¿æˆ‘ä»¬ä¸ä¼šè¶…è¿‡é™é€Ÿã€‚æˆ‘ä»¬å¿…é¡»å¯¹æˆ‘ä»¬çš„è¯·æ±‚ä½¿ç”¨é€Ÿç‡é™åˆ¶ã€‚</p><p id="506d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ä¾‹å¦‚:</p><ul class=""><li id="7d76" class="nn no it js b jt ju jx jy kb np kf nq kj nr kn ns nt nu nv bi translated">æˆ‘ä»¬çš„ç›®æ ‡ç½‘ç«™æ˜¯:<a class="ae le" href="https://httpbin.org/get" rel="noopener ugc nofollow" target="_blank">https://httpbin.org/get</a></li><li id="f7a9" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">é€šè¿‡ç»™å®šä¸åŒçš„æŸ¥è¯¢å‚æ•°ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¤šä¸ªè¯·æ±‚ï¼Œå¦‚<a class="ae le" href="https://httpbin.org/get?i=1," rel="noopener ugc nofollow" target="_blank">https://httpbin.org/get?i=1,</a>T15ã€‘https://httpbin.org/get?i=2,ç­‰ã€‚</li><li id="1916" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">åˆ†çº§é™åˆ¶ä¸ºæ¯åˆ†é’Ÿ100ä¸ªè¯·æ±‚ã€‚</li></ul><p id="5978" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å¦‚ä½•ä½¿ç”¨é€Ÿç‡é™åˆ¶åŒ…å’Œå·¥äººæ± æ¨¡å¼æ¥å®ç°æˆ‘ä»¬çš„ç›®æ ‡ï¼Ÿ</p><h1 id="9867" class="lm ln it bd lo lp ni lr ls lt nj lv lw lx nk lz ma mb nl md me mf nm mh mi mj bi translated">ä½“ç³»ç»“æ„</h1><p id="8f91" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">æˆ‘ä»¬ç¨‹åºçš„æ¶æ„å¾ˆç®€å•ã€‚æˆ‘ä»¬çš„æ¶æ„ä¸­æœ‰ä¸€äº›é‡è¦çš„ç»„ä»¶:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ob"><img src="../Images/3b4419997151d4f13fd9c516442b66c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oAj8jlANc7raZq5p_l4zhA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">é€Ÿç‡é™åˆ¶åŠ å·¥äººæ± ä½“ç³»ç»“æ„</figcaption></figure><h2 id="3e16" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated">ä»»åŠ¡ç»“æ„</h2><p id="d92b" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated"><em class="oo"> Task </em> structç”¨äºå­˜å‚¨æ¯ä¸ªè¯·æ±‚å’Œå“åº”çš„ç»“æœã€‚</p><pre class="kp kq kr ks gt op oq or bn os ot bi"><span id="7614" class="ou ln it oq b be ov ow l ox oy">type Task struct {<br/>   seq        int        // task number seq<br/>   url        string<br/>   data       []byte<br/>   err        string<br/>   statusCode int<br/>   duration   time.Duration<br/>   handleBy   string    // worker name<br/>}<br/><br/>func (t Task) String() string {<br/>   return fmt.Sprintf("seq: %d, URL: %s, handleBy: %s, duration: %d, statusCode: %d, err: %s ...", t.seq, t.url, t.handleBy, t.duration, t.statusCode, t.err)<br/>}</span></pre><h2 id="fbee" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated">ä»»åŠ¡å·²æ›´æ”¹</h2><p id="b700" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated"><em class="oo"> Task Chan </em>æ˜¯ä»»åŠ¡çš„å®¹å™¨ï¼Œä¸‹é¢çš„ç”Ÿäº§è€…ä¼šå°†æ¯ä¸ªä»»åŠ¡å‘é€ç»™å®ƒã€‚</p><h2 id="8881" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated">ç”Ÿäº§è€…</h2><p id="d9cd" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">ç”Ÿäº§è€…ç»„ä»¶ç”Ÿæˆæ‰€æœ‰çš„ä»»åŠ¡ï¼Œå¹¶å°†å…¶å‘é€ç»™<em class="oo">ä»»åŠ¡å˜æ›´</em>ä»¥ä¾›ä¸‹æ¸¸æµç¨‹ä½¿ç”¨ã€‚</p><pre class="kp kq kr ks gt op oq or bn os ot bi"><span id="9a88" class="ou ln it oq b be ov ow l ox oy">// generate tasks and send to task chan<br/>func producer(rl ratelimit.Limiter) &lt;-chan Task {<br/>   var tasks []Task<br/>   for i := 0; i &lt; 1000; i++ {<br/>      url := "https://httpbin.org/get?i=" + fmt.Sprintf("%d", i)<br/>      tasks = append(tasks, Task{seq: i, url: url})<br/>   }   <br/>   <br/>   out := make(chan Task)<br/>   go func() {<br/>      defer close(out)<br/>      for _, task := range tasks {<br/>         rl.Take()<br/>         out &lt;- task<br/>      }<br/>   }()<br/>   <br/>   return out<br/>}</span></pre><p id="8eb8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¿™é‡Œæœ€é‡è¦çš„åŠŸèƒ½æ˜¯æˆ‘ä»¬ä½¿ç”¨<em class="oo">é€Ÿç‡é™åˆ¶å™¨</em>æ¥æ§åˆ¶ä»»åŠ¡ç”Ÿæˆé€Ÿåº¦ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ä¸è¶…è¿‡ä¸‹æ¸¸HTTPé€Ÿç‡é™åˆ¶ã€‚</p><h2 id="6207" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated"><code class="fe oz pa pb oq b">RateLimiter</code></h2><p id="6fed" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">é€Ÿç‡é™åˆ¶å™¨åŒ…å®šä¹‰äº†æ¼æ¡¶é€Ÿç‡é™åˆ¶ç®—æ³•çš„å®ç°ã€‚</p><p id="2f42" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ä¸‹é¢æ˜¯åˆ›å»ºä¸€ä¸ªé€Ÿç‡é™åˆ¶å™¨çš„ä»£ç ï¼Œé™åˆ¶ä¸ºæ¯åˆ†é’Ÿ500ä¸ªè¯·æ±‚ã€‚</p><pre class="kp kq kr ks gt op oq or bn os ot bi"><span id="e7ea" class="ou ln it oq b be ov ow l ox oy">rl := ratelimit.New(500, ratelimit.Per(60*time.Second))</span></pre><h2 id="216d" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated">ç»“æœé¢‘é“</h2><p id="34ff" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated"><em class="oo"> Result Chan </em>æ˜¯å¦ä¸€ä¸ªä»»åŠ¡å®¹å™¨ï¼›å®ƒåŒ…æ‹¬æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡åŠå…¶ç”±å·¥ä½œäººå‘˜ç”Ÿæˆçš„ç»“æœã€‚</p><h2 id="7813" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated">å·¥äººæ± </h2><p id="ddfc" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">æ¯ä¸ªå·¥äººå°†åˆ†åˆ«å¤„ç†æ¥è‡ª<em class="oo">ä»»åŠ¡å˜æ›´</em>çš„ä»»åŠ¡ï¼Œå¹¶å°†ç»“æœå‘é€ç»™<em class="oo">ç»“æœå˜æ›´</em>ã€‚</p><pre class="kp kq kr ks gt op oq or bn os ot bi"><span id="43e0" class="ou ln it oq b be ov ow l ox oy">func worker(name string, taskChan &lt;-chan Task, resultChan chan&lt;- Task) {<br/>   for task := range taskChan {<br/>      start := time.Now()<br/>      body, code, err := Get(task.url)<br/>      if err != nil {<br/>          task.err = err.Error()<br/>      }<br/>      <br/>      task.statusCode = code<br/>      task.data = body<br/>      task.handleBy = name<br/>      task.duration = time.Duration(time.Since(start).Milliseconds())<br/>  <br/>      resultChan &lt;- task<br/> }<br/>}</span></pre><p id="5dd0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ä»¥ä¸‹æ˜¯å¦‚ä½•å¯åŠ¨äº”ä¸ªå·¥äººï¼Œå¹¶ç­‰å¾…ä»–ä»¬å®Œæˆã€‚</p><pre class="kp kq kr ks gt op oq or bn os ot bi"><span id="e490" class="ou ln it oq b be ov ow l ox oy"> // ... <br/> numWorker := 5<br/> <br/> var wg sync.WaitGroup<br/> for i := 0; i &lt; numWorker; i++ {<br/>    wg.Add(1)<br/>    go func(x int) {<br/>       defer wg.Done()<br/>       worker(fmt.Sprintf("worker-%d", x), taskChan, resultsChan)<br/>  }(i)<br/><br/>// ...</span></pre><p id="9175" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å®Œæ•´ä»£ç å¯åœ¨<a class="ae le" href="https://gist.github.com/jerryan999/ef0aa671b0f15b73c8dbd225f411a963" rel="noopener ugc nofollow" target="_blank"> GitHub </a>ä¸Šè·å¾—ã€‚</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="4c03" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æˆ‘å¸Œæœ›ä½ å–œæ¬¢è¯»è¿™ç¯‡æ–‡ç« ã€‚å¦‚æœä½ æ„¿æ„æ”¯æŒæˆ‘æˆä¸ºä¸€åä½œå®¶ï¼Œå¯ä»¥è€ƒè™‘æ³¨å†Œ<a class="ae le" href="https://jerryan.medium.com/membership" rel="noopener">æˆä¸º</a>ä¸­çš„ä¸€å‘˜ã€‚ä½ è¿˜å¯ä»¥æ— é™åˆ¶åœ°è®¿é—®åª’ä½“ä¸Šçš„æ¯ä¸ªæ•…äº‹ã€‚</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="f3b5" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">åˆ†çº§ç¼–ç </h1><p id="5113" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">æ„Ÿè°¢æ‚¨æˆä¸ºæˆ‘ä»¬ç¤¾åŒºçš„ä¸€å‘˜ï¼åœ¨ä½ ç¦»å¼€ä¹‹å‰:</p><ul class=""><li id="502e" class="nn no it js b jt ju jx jy kb np kf nq kj nr kn ns nt nu nv bi translated">ğŸ‘ä¸ºæ•…äº‹é¼“æŒï¼Œè·Ÿç€ä½œè€…èµ°ğŸ‘‰</li><li id="72e8" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">ğŸ“°æŸ¥çœ‹<a class="ae le" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">å‡çº§ç¼–ç å‡ºç‰ˆç‰©</a>ä¸­çš„æ›´å¤šå†…å®¹</li><li id="4c10" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">ğŸ””å…³æ³¨æˆ‘ä»¬:<a class="ae le" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae le" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae le" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">æ—¶äº‹é€šè®¯</a></li></ul><p id="8a72" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ğŸš€ğŸ‘‰<a class="ae le" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">åŠ å…¥äººæ‰é›†ä½“ï¼Œæ‰¾åˆ°ä¸€ä»½ä»¤äººæƒŠå–œçš„å·¥ä½œ</strong> </a></p></div></div>    
</body>
</html>