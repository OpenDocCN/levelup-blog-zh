<html>
<head>
<title>Rate Limit Plus Worker Pool in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang的速度限制和工人池</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/rate-limit-plus-worker-pool-in-golang-8df5b8cab378?source=collection_archive---------5-----------------------#2022-11-28">https://levelup.gitconnected.com/rate-limit-plus-worker-pool-in-golang-8df5b8cab378?source=collection_archive---------5-----------------------#2022-11-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="8a65" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这篇文章是关于如何使用速率限制策略和worker pool模式来发出大量HTTP请求。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/d2a45da305f5f609717213d132b716ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9GqmmW831-UjrIlm"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">照片由<a class="ae le" href="https://unsplash.com/@sohaib_alkharsa?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">索海布·阿尔·哈尔萨</a>在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="9601" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">代码可在<a class="ae le" href="https://gist.github.com/jerryan999/ef0aa671b0f15b73c8dbd225f411a963" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="c676" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">先决条件</h1><p id="faf5" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">Go <a class="ae le" href="https://pkg.go.dev/go.uber.org/ratelimit" rel="noopener ugc nofollow" target="_blank">速率限制器</a>包是限制请求速率的最简单的方法。这是我们在这个职位上唯一的先决条件。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mp"><img src="../Images/bf560c5087c6c1fb41334cd49cc6c781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ui-tlMr9yKK_quCR.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">图片由<a class="ae le" href="https://www.mikeperham.com/2020/11/09/the-leaky-bucket-rate-limiter/" rel="noopener ugc nofollow" target="_blank">链接</a>提供。</figcaption></figure><p id="fbb0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该软件包提供了漏桶速率限制算法的Golang实现。如果你对算法不熟悉，可以看看关于它的文章。</p><div class="mq mr gp gr ms mt"><a href="https://betterprogramming.pub/4-rate-limit-algorithms-every-developer-should-know-7472cb482f48" rel="noopener  ugc nofollow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd iu gy z fp my fr fs mz fu fw is bi translated">每个开发人员都应该知道的4种速率限制算法</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">实现速率限制的初学者指南</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">better编程. pub</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh ky mt"/></div></div></a></div><h1 id="2b0b" class="lm ln it bd lo lp ni lr ls lt nj lv lw lx nk lz ma mb nl md me mf nm mh mi mj bi translated">真实世界的例子</h1><p id="2395" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">假设我们需要向第三方API发出许多HTTP请求来获取一些数据。API的速率限制为每分钟X个请求。</p><p id="635b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以确保我们不会超过限速。我们必须对我们的请求使用速率限制。</p><p id="506d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如:</p><ul class=""><li id="7d76" class="nn no it js b jt ju jx jy kb np kf nq kj nr kn ns nt nu nv bi translated">我们的目标网站是:<a class="ae le" href="https://httpbin.org/get" rel="noopener ugc nofollow" target="_blank">https://httpbin.org/get</a></li><li id="f7a9" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">通过给定不同的查询参数，可以模拟多个请求，如<a class="ae le" href="https://httpbin.org/get?i=1," rel="noopener ugc nofollow" target="_blank">https://httpbin.org/get?i=1,</a>T15】https://httpbin.org/get?i=2,等。</li><li id="1916" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">分级限制为每分钟100个请求。</li></ul><p id="5978" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如何使用速率限制包和工人池模式来实现我们的目标？</p><h1 id="9867" class="lm ln it bd lo lp ni lr ls lt nj lv lw lx nk lz ma mb nl md me mf nm mh mi mj bi translated">体系结构</h1><p id="8f91" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">我们程序的架构很简单。我们的架构中有一些重要的组件:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ob"><img src="../Images/3b4419997151d4f13fd9c516442b66c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oAj8jlANc7raZq5p_l4zhA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">速率限制加工人池体系结构</figcaption></figure><h2 id="3e16" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated">任务结构</h2><p id="d92b" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated"><em class="oo"> Task </em> struct用于存储每个请求和响应的结果。</p><pre class="kp kq kr ks gt op oq or bn os ot bi"><span id="7614" class="ou ln it oq b be ov ow l ox oy">type Task struct {<br/>   seq        int        // task number seq<br/>   url        string<br/>   data       []byte<br/>   err        string<br/>   statusCode int<br/>   duration   time.Duration<br/>   handleBy   string    // worker name<br/>}<br/><br/>func (t Task) String() string {<br/>   return fmt.Sprintf("seq: %d, URL: %s, handleBy: %s, duration: %d, statusCode: %d, err: %s ...", t.seq, t.url, t.handleBy, t.duration, t.statusCode, t.err)<br/>}</span></pre><h2 id="fbee" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated">任务已更改</h2><p id="b700" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated"><em class="oo"> Task Chan </em>是任务的容器，下面的生产者会将每个任务发送给它。</p><h2 id="8881" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated">生产者</h2><p id="d9cd" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">生产者组件生成所有的任务，并将其发送给<em class="oo">任务变更</em>以供下游流程使用。</p><pre class="kp kq kr ks gt op oq or bn os ot bi"><span id="9a88" class="ou ln it oq b be ov ow l ox oy">// generate tasks and send to task chan<br/>func producer(rl ratelimit.Limiter) &lt;-chan Task {<br/>   var tasks []Task<br/>   for i := 0; i &lt; 1000; i++ {<br/>      url := "https://httpbin.org/get?i=" + fmt.Sprintf("%d", i)<br/>      tasks = append(tasks, Task{seq: i, url: url})<br/>   }   <br/>   <br/>   out := make(chan Task)<br/>   go func() {<br/>      defer close(out)<br/>      for _, task := range tasks {<br/>         rl.Take()<br/>         out &lt;- task<br/>      }<br/>   }()<br/>   <br/>   return out<br/>}</span></pre><p id="8eb8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里最重要的功能是我们使用<em class="oo">速率限制器</em>来控制任务生成速度。因此，我们可以确保不超过下游HTTP速率限制。</p><h2 id="6207" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated"><code class="fe oz pa pb oq b">RateLimiter</code></h2><p id="6fed" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">速率限制器包定义了漏桶速率限制算法的实现。</p><p id="2f42" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是创建一个速率限制器的代码，限制为每分钟500个请求。</p><pre class="kp kq kr ks gt op oq or bn os ot bi"><span id="e7ea" class="ou ln it oq b be ov ow l ox oy">rl := ratelimit.New(500, ratelimit.Per(60*time.Second))</span></pre><h2 id="216d" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated">结果频道</h2><p id="34ff" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated"><em class="oo"> Result Chan </em>是另一个任务容器；它包括所有已完成的任务及其由工作人员生成的结果。</p><h2 id="7813" class="oc ln it bd lo od oe dn ls of og dp lw kb oh oi ma kf oj ok me kj ol om mi on bi translated">工人池</h2><p id="ddfc" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">每个工人将分别处理来自<em class="oo">任务变更</em>的任务，并将结果发送给<em class="oo">结果变更</em>。</p><pre class="kp kq kr ks gt op oq or bn os ot bi"><span id="43e0" class="ou ln it oq b be ov ow l ox oy">func worker(name string, taskChan &lt;-chan Task, resultChan chan&lt;- Task) {<br/>   for task := range taskChan {<br/>      start := time.Now()<br/>      body, code, err := Get(task.url)<br/>      if err != nil {<br/>          task.err = err.Error()<br/>      }<br/>      <br/>      task.statusCode = code<br/>      task.data = body<br/>      task.handleBy = name<br/>      task.duration = time.Duration(time.Since(start).Milliseconds())<br/>  <br/>      resultChan &lt;- task<br/> }<br/>}</span></pre><p id="5dd0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以下是如何启动五个工人，并等待他们完成。</p><pre class="kp kq kr ks gt op oq or bn os ot bi"><span id="e490" class="ou ln it oq b be ov ow l ox oy"> // ... <br/> numWorker := 5<br/> <br/> var wg sync.WaitGroup<br/> for i := 0; i &lt; numWorker; i++ {<br/>    wg.Add(1)<br/>    go func(x int) {<br/>       defer wg.Done()<br/>       worker(fmt.Sprintf("worker-%d", x), taskChan, resultsChan)<br/>  }(i)<br/><br/>// ...</span></pre><p id="9175" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完整代码可在<a class="ae le" href="https://gist.github.com/jerryan999/ef0aa671b0f15b73c8dbd225f411a963" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="4c03" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我希望你喜欢读这篇文章。如果你愿意支持我成为一名作家，可以考虑注册<a class="ae le" href="https://jerryan.medium.com/membership" rel="noopener">成为</a>中的一员。你还可以无限制地访问媒体上的每个故事。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="f3b5" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">分级编码</h1><p id="5113" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="502e" class="nn no it js b jt ju jx jy kb np kf nq kj nr kn ns nt nu nv bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="72e8" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">📰查看<a class="ae le" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="4c10" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">🔔关注我们:<a class="ae le" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae le" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae le" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="8a72" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">🚀👉<a class="ae le" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">加入人才集体，找到一份令人惊喜的工作</strong> </a></p></div></div>    
</body>
</html>