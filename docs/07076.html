<html>
<head>
<title>Node.js Basics — Socket.io</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js基础— Socket.io</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/node-js-basics-socket-io-e19053a4441b?source=collection_archive---------5-----------------------#2021-01-22">https://levelup.gitconnected.com/node-js-basics-socket-io-e19053a4441b?source=collection_archive---------5-----------------------#2021-01-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/2d1d0eb4d98a7ce5ace0626d4368bc11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Rw_ib58DZ-FOizK1"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@tekton_tools?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Tekton </a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><h1 id="8980" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">使用Socket.io进行实时通信</h1><p id="f9a2" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">Socket.io是一个实时通信库，它将HTTP请求与WebSockets结合起来，以实现我们的应用程序中的实时通信。</p><p id="1745" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">例如，我们可以用Socket.io编写一个简单的应用程序:</p><p id="e907" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><code class="fe mh mi mj mk b">index.js</code></p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="291f" class="mt kh it mk b gy mu mv l mw mx">const content = require('fs').readFileSync(__dirname + '/index.html', 'utf8');</span><span id="cc65" class="mt kh it mk b gy my mv l mw mx">const httpServer = require('http').createServer((req, res) =&gt; {<br/>  res.setHeader('Content-Type', 'text/html');<br/>  res.setHeader('Content-Length', Buffer.byteLength(content));<br/>  res.end(content);<br/>});</span><span id="a075" class="mt kh it mk b gy my mv l mw mx">const io = require('socket.io')(httpServer);</span><span id="1076" class="mt kh it mk b gy my mv l mw mx">io.on('connect', socket =&gt; {<br/>  console.log('connect');<br/>});</span><span id="a9ae" class="mt kh it mk b gy my mv l mw mx">httpServer.listen(3000, () =&gt; {<br/>  console.log('go to http://localhost:3000');<br/>});</span></pre><p id="1074" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><code class="fe mh mi mj mk b">index.html</code></p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="55ed" class="mt kh it mk b gy mu mv l mw mx">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;</span><span id="261d" class="mt kh it mk b gy my mv l mw mx">&lt;head&gt;<br/>  &lt;meta charset="UTF-8"&gt;<br/>  &lt;title&gt;Minimal working example&lt;/title&gt;<br/>&lt;/head&gt;</span><span id="016a" class="mt kh it mk b gy my mv l mw mx">&lt;body&gt;<br/>  &lt;ul id="events"&gt;&lt;/ul&gt;</span><span id="502a" class="mt kh it mk b gy my mv l mw mx">&lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;<br/>  &lt;script&gt;<br/>    const $events = document.getElementById('events');</span><span id="2736" class="mt kh it mk b gy my mv l mw mx">    const newItem = (content) =&gt; {<br/>      const item = document.createElement('li');<br/>      item.innerText = content;<br/>      return item;<br/>    };</span><span id="c996" class="mt kh it mk b gy my mv l mw mx">    const socket = io();</span><span id="ba67" class="mt kh it mk b gy my mv l mw mx">    socket.on('connect', () =&gt; {<br/>      $events.appendChild(newItem('connect'));<br/>    });<br/>  &lt;/script&gt;<br/>&lt;/body&gt;</span><span id="7e96" class="mt kh it mk b gy my mv l mw mx">&lt;/html&gt;</span></pre><p id="a6a0" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在<code class="fe mh mi mj mk b">index.js</code>，我们提供<code class="fe mh mi mj mk b">index.html</code>文件。</p><p id="666b" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">此外，我们监听<code class="fe mh mi mj mk b">connect</code>事件，以监听来自客户端的任何连接。</p><p id="0a3c" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在<code class="fe mh mi mj mk b">index.html</code>中，我们建立了联系。</p><p id="990f" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">当我们连接到Socket.io服务器时，我们调用<code class="fe mh mi mj mk b">socket.on</code>来监听<code class="fe mh mi mj mk b">connect</code>事件以添加项目。</p><h1 id="aa62" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">快速安装</h1><p id="8664" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们可以通过Express应用程序使用Socket.io。</p><p id="b521" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">为此，我们可以写:</p><p id="42e5" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><code class="fe mh mi mj mk b">index.js</code></p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="9bba" class="mt kh it mk b gy mu mv l mw mx">const express = require('express');<br/>const app = express();<br/>const server = require('http').createServer(app);<br/>const options = { /* ... */ };<br/>const io = require('socket.io')(server, options);</span><span id="b7d7" class="mt kh it mk b gy my mv l mw mx">io.on('connection', socket =&gt; {<br/>  console.log('connect')<br/>});</span><span id="b079" class="mt kh it mk b gy my mv l mw mx">app.use(express.static('public'));</span><span id="a22d" class="mt kh it mk b gy my mv l mw mx">app.get('/', (req, res) =&gt; {<br/>  res.sendFile(`${__dirname}/index.html`);<br/>});</span><span id="a8b1" class="mt kh it mk b gy my mv l mw mx">server.listen(3000);</span></pre><p id="33eb" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><code class="fe mh mi mj mk b">index.html</code></p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="43be" class="mt kh it mk b gy mu mv l mw mx">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;</span><span id="55d2" class="mt kh it mk b gy my mv l mw mx">&lt;head&gt;<br/>  &lt;meta charset="UTF-8"&gt;<br/>  &lt;title&gt;Minimal working example&lt;/title&gt;<br/>&lt;/head&gt;</span><span id="c5e2" class="mt kh it mk b gy my mv l mw mx">&lt;body&gt;<br/>  &lt;ul id="events"&gt;&lt;/ul&gt;</span><span id="1d8c" class="mt kh it mk b gy my mv l mw mx">  &lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;<br/>  &lt;script&gt;<br/>    const $events = document.getElementById('events');<br/>    const newItem = (content) =&gt; {<br/>      const item = document.createElement('li');<br/>      item.innerText = content;<br/>      return item;<br/>    };<br/>    const socket = io();<br/>    socket.on('connect', () =&gt; {<br/>      $events.appendChild(newItem('connect'));<br/>    });<br/>  &lt;/script&gt;<br/>&lt;/body&gt;</span><span id="9454" class="mt kh it mk b gy my mv l mw mx">&lt;/html&gt;</span></pre><p id="faa3" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们使用和以前一样的<code class="fe mh mi mj mk b">index.html</code>文件。</p><p id="79f5" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">唯一的区别是我们用快递服务。</p><p id="43d2" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们使用Express app实例调用<code class="fe mh mi mj mk b">http</code>模块的<code class="fe mh mi mj mk b">createServer</code>方法，而不是使用回调函数。</p><p id="9e81" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">然后我们用<code class="fe mh mi mj mk b">res.sendFile</code>方法提供静态文件。</p><h1 id="eb67" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">命名空间</h1><p id="1dbc" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们可以创建名称空间来隔离通信流量。</p><p id="012b" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">例如，我们可以写:</p><p id="ef0a" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><code class="fe mh mi mj mk b">index.js</code></p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="02f7" class="mt kh it mk b gy mu mv l mw mx">const express = require('express');<br/>const app = express();<br/>const server = require('http').createServer(app);<br/>const options = { /* ... */ };<br/>const io = require('socket.io')(server, options);</span><span id="23cb" class="mt kh it mk b gy my mv l mw mx">io.on('connection', socket =&gt; {<br/>  console.log('connect')<br/>});</span><span id="b855" class="mt kh it mk b gy my mv l mw mx">const adminNamespace = io.of('/admin');</span><span id="798e" class="mt kh it mk b gy my mv l mw mx">adminNamespace.use((socket, next) =&gt; {<br/>  console.log(socket);<br/>  next();<br/>});</span><span id="61f4" class="mt kh it mk b gy my mv l mw mx">adminNamespace.on('connection', socket =&gt; {<br/>  socket.on('delete user', (data) =&gt; {<br/>    console.log(data);<br/>  });<br/>});</span><span id="f824" class="mt kh it mk b gy my mv l mw mx">app.get('/', (req, res) =&gt; {<br/>  res.sendFile(`${__dirname}/index.html`);<br/>});</span><span id="fa82" class="mt kh it mk b gy my mv l mw mx">server.listen(3000);</span></pre><p id="c6d9" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><code class="fe mh mi mj mk b">index.html</code></p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="2eea" class="mt kh it mk b gy mu mv l mw mx">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;</span><span id="be29" class="mt kh it mk b gy my mv l mw mx">&lt;head&gt;<br/>  &lt;meta charset="UTF-8"&gt;<br/>  &lt;title&gt;Minimal working example&lt;/title&gt;<br/>&lt;/head&gt;</span><span id="f16d" class="mt kh it mk b gy my mv l mw mx">&lt;body&gt;<br/>  &lt;ul id="events"&gt;&lt;/ul&gt;</span><span id="461b" class="mt kh it mk b gy my mv l mw mx">  &lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;<br/>  &lt;script&gt;<br/>    const socket = io('/admin');<br/>    socket.emit('delete user', 'foo')<br/>  &lt;/script&gt;<br/>&lt;/body&gt;</span><span id="898a" class="mt kh it mk b gy my mv l mw mx">&lt;/html&gt;</span></pre><p id="5eaf" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在<code class="fe mh mi mj mk b">index.js</code>文件中，我们用以下内容创建了<code class="fe mh mi mj mk b">/admin</code>名称空间:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="5a38" class="mt kh it mk b gy mu mv l mw mx">const adminNamespace = io.of('/admin');</span></pre><p id="9cae" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">然后，在监听到名称空间的连接之前，我们用自己的中间件函数调用<code class="fe mh mi mj mk b">use</code>方法。</p><p id="eb08" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们可以在<code class="fe mh mi mj mk b">use</code>回调中添加允许或拒绝连接的逻辑。</p><p id="c2f5" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们调用<code class="fe mh mi mj mk b">next</code>来完成连接。</p><p id="6dd3" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><code class="fe mh mi mj mk b">adminNamespace.on</code>方法监视<code class="fe mh mi mj mk b">connection</code>事件，以监视到名称空间的连接。</p><p id="0527" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">然后我们用想要监听的事件名调用<code class="fe mh mi mj mk b">socket.on</code>，然后从<code class="fe mh mi mj mk b">data</code>参数中获取数据。</p><p id="70bc" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在<code class="fe mh mi mj mk b">index.html</code>中，我们调用<code class="fe mh mi mj mk b">io('/admin')</code>连接到<code class="fe mh mi mj mk b">'/admin'</code>名称空间。</p><p id="7980" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">然后我们调用<code class="fe mh mi mj mk b">socket.emit</code>，将事件名称作为第一个参数，将事件数据作为第二个参数。</p><h1 id="a8aa" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">结论</h1><p id="d267" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们可以很容易地用Socket.io进行实时通信。</p></div></div>    
</body>
</html>