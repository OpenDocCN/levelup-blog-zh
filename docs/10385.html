<html>
<head>
<title>How to Add Timestamp to FastAPI/Uvicorn Logs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何给FastAPI/uvicon日志添加时间戳</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-add-timestamp-to-fastapi-uvicorn-logs-221f7f16a2ca?source=collection_archive---------4-----------------------#2021-11-30">https://levelup.gitconnected.com/how-to-add-timestamp-to-fastapi-uvicorn-logs-221f7f16a2ca?source=collection_archive---------4-----------------------#2021-11-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="bd1f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过添加时间戳简化调试过程</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/16a3b636611837b7049588a5ae801117.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y0uwZGiC2HRNWzeg5ADZCw.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">维克多·塔拉舒克在<a class="ae le" href="https://unsplash.com/s/photos/file?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="3878" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本教程中，您将学习如何配置Uvicorn并向所有访问和调试日志添加时间戳。让我们看看下面的问题状态，以便更清楚地了解日志中有时间戳的好处。</p><p id="21b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">给定FastAPI服务器的以下Python文件:</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="d7ee" class="lk ll it lg b gy lm ln l lo lp">from fastapi import FastAPI</span><span id="dc25" class="lk ll it lg b gy lq ln l lo lp">api = FastAPI()</span><span id="fb35" class="lk ll it lg b gy lq ln l lo lp">@api.get("/")<br/>def index():<br/>    return {"Hello": "World"}</span></pre><p id="5a0a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通常的部署命令如下:</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="6422" class="lk ll it lg b gy lm ln l lo lp">uvicorn main:app --host 0.0.0.0 --port 8000</span></pre><p id="254f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当访问根端点时，您应该在终端上获得以下输出:</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="6f85" class="lk ll it lg b gy lm ln l lo lp">INFO:     Started server process [17028]<br/>INFO:     Waiting for application startup.<br/>INFO:     Application startup complete.<br/>INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)<br/>INFO:     &lt;IP&gt; - "GET / HTTP/1.1" 200 OK<br/>INFO:     &lt;IP&gt; - "GET / HTTP/1.1" 200 OK</span></pre><p id="0da8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如您所见，输出仅包含以下信息:</p><ul class=""><li id="df73" class="lr ls it js b jt ju jx jy kb lt kf lu kj lv kn lw lx ly lz bi translated">用户的IP地址</li><li id="a89a" class="lr ls it js b jt ma jx mb kb mc kf md kj me kn lw lx ly lz bi translated">用户调用的端点(类型、http版本、状态代码)</li></ul><p id="fce8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您试图调试应用程序时，这可能会很麻烦。如果你能把它配置成包含你需要的东西，那就方便多了。例如，拥有时间戳非常有用，因为您可以使用它来确定某一天发生的问题。</p><p id="ec6a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们继续下一节，了解更多关于实现的信息。</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="8610" class="mm ll it bd mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni bi translated">履行</h1><p id="399e" class="pw-post-body-paragraph jq jr it js b jt nj jv jw jx nk jz ka kb nl kd ke kf nm kh ki kj nn kl km kn im bi translated">有多种方法可以修改日志的配置。您可以选择:</p><ul class=""><li id="74f6" class="lr ls it js b jt ju jx jy kb lt kf lu kj lv kn lw lx ly lz bi translated">通过<code class="fe no np nq lg b">logging</code>模块将配置指定为字典代码</li><li id="c488" class="lr ls it js b jt ma jx mb kb mc kf md kj me kn lw lx ly lz bi translated">创建一个json或yaml文件，并使用<code class="fe no np nq lg b">--log-config</code>标志运行uvicorn</li></ul><p id="0365" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本教程涵盖了使用yaml文件的第二个选项。这种方法更加灵活，因为您可以简单地将配置文件移动到您的新项目中。此外，你可以很容易地禁用或启用它通过<code class="fe no np nq lg b">--log-config</code>标志。</p><h2 id="2da8" class="lk ll it bd mn nr ns dn mr nt nu dp mv kb nv nw mz kf nx ny nd kj nz oa nh ob bi translated">PyYaml</h2><p id="d624" class="pw-post-body-paragraph jq jr it js b jt nj jv jw jx nk jz ka kb nl kd ke kf nm kh ki kj nn kl km kn im bi translated">你需要额外安装一个叫PyYaml的包来使它工作。按照以下方式安装:</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="5d01" class="lk ll it lg b gy lm ln l lo lp">pip install pyyaml</span></pre><p id="c6bf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">或者，如果您安装了<code class="fe no np nq lg b">uvicorn</code>的标准版本，这个包将作为依赖项组合在一起:</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="7b38" class="lk ll it lg b gy lm ln l lo lp">pip install uvicorn[standard]</span></pre><h2 id="ce11" class="lk ll it bd mn nr ns dn mr nt nu dp mv kb nv nw mz kf nx ny nd kj nz oa nh ob bi translated">配置文件</h2><p id="bd42" class="pw-post-body-paragraph jq jr it js b jt nj jv jw jx nk jz ka kb nl kd ke kf nm kh ki kj nn kl km kn im bi translated">接下来，在您的工作目录中创建一个名为<code class="fe no np nq lg b">log_conf.yml</code>的新文件。对于除版本0.18.1之外的所有<code class="fe no np nq lg b">uvicorn</code>版本，在其中添加以下代码:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="8d6f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于版本0.18.1，<code class="fe no np nq lg b">logging</code>模块<a class="ae le" href="https://github.com/encode/uvicorn/pull/1426" rel="noopener ugc nofollow" target="_blank">已被重命名，以防止与标准库</a>冲突。</p><blockquote class="oe of og"><p id="dab9" class="jq jr oh js b jt ju jv jw jx jy jz ka oi kc kd ke oj kg kh ki ok kk kl km kn im bi translated">开发人员从版本0.18.2开始恢复了这个特性。建议将<code class="fe no np nq lg b">uvicorn</code>更新至最新版本，并使用<code class="fe no np nq lg b">uvicorn.logging</code>作为模块名称。</p></blockquote><p id="6d31" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">0.18.1版本使用<code class="fe no np nq lg b">_logging</code>作为模块名。因此，新的配置文件应该如下所示:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="7b6e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该文件包含以下所有相关配置:</p><ul class=""><li id="cf6f" class="lr ls it js b jt ju jx jy kb lt kf lu kj lv kn lw lx ly lz bi translated">格式化程序</li><li id="59fd" class="lr ls it js b jt ma jx mb kb mc kf md kj me kn lw lx ly lz bi translated">经理人</li><li id="ba40" class="lr ls it js b jt ma jx mb kb mc kf md kj me kn lw lx ly lz bi translated">记录器</li></ul><p id="e212" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">每个组件将进一步分为默认组件或访问组件。您可以选择设置不同的配置或保留相同的设置。</p><h2 id="c133" class="lk ll it bd mn nr ns dn mr nt nu dp mv kb nv nw mz kf nx ny nd kj nz oa nh ob bi translated">格式化程序</h2><p id="324e" class="pw-post-body-paragraph jq jr it js b jt nj jv jw jx nk jz ka kb nl kd ke kf nm kh ki kj nn kl km kn im bi translated">最重要的部分是关于格式化程序。在上面的脚本中，它被设置为:</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="8c75" class="lk ll it lg b gy lm ln l lo lp">datefmt: "%Y-%m-%dT%H:%M:%S"<br/>format: '[%(asctime)s.%(msecs)03dZ] %(name)s %(levelname)s %(message)s'</span></pre><p id="cf15" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe no np nq lg b">datefmt</code>指的是<a class="ae le" href="https://docs.python.org/3/library/datetime.html#strftime-and-strptime-format-codes" rel="noopener ugc nofollow" target="_blank"> Python日期格式字符串</a>，可以用来定义你的日期时间字符串的格式。</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="e8d4" class="lk ll it lg b gy lm ln l lo lp">%Y-%m-%dT%H:%M:%S</span></pre><p id="aff8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这种情况下，它将显示如下输出:</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="ccae" class="lk ll it lg b gy lm ln l lo lp">2021-11-29T13:22:40</span></pre><p id="d86d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不要被中间的T字符吓到，因为它是日期时间的<a class="ae le" href="https://en.wikipedia.org/wiki/ISO_8601" rel="noopener ugc nofollow" target="_blank"> ISO 8601 </a>标准的一部分。示例输出仍然需要以微秒和Z字符结尾，以便与标准完全兼容。然而，如下设置将不起作用，因为Python3不支持它，尽管它在官方文档中有说明。</p><p id="9ef6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，您仍然可以通过利用<a class="ae le" href="https://docs.python.org/3/library/logging.html#logrecord-attributes" rel="noopener ugc nofollow" target="_blank">日志记录属性</a>来实现它，如下所示:</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="9d1c" class="lk ll it lg b gy lm ln l lo lp">[%(asctime)s.%(msecs)03dZ] %(name)s %(levelname)s %(message)s</span></pre><p id="b05c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe no np nq lg b">asctime</code>将输出我们之前定义的日期时间字符串</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="55fb" class="lk ll it lg b gy lm ln l lo lp">.%(msecs)03dZ</span></pre><p id="d2e2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将在它的末尾附加以下内容:</p><ul class=""><li id="34c9" class="lr ls it js b jt ju jx jy kb lt kf lu kj lv kn lw lx ly lz bi translated">一个点</li><li id="c1e5" class="lr ls it js b jt ma jx mb kb mc kf md kj me kn lw lx ly lz bi translated">三个字符的毫秒值</li><li id="59e7" class="lr ls it js b jt ma jx mb kb mc kf md kj me kn lw lx ly lz bi translated">Z字符</li></ul><h2 id="9cf1" class="lk ll it bd mn nr ns dn mr nt nu dp mv kb nv nw mz kf nx ny nd kj nz oa nh ob bi translated">运行服务器</h2><p id="94d1" class="pw-post-body-paragraph jq jr it js b jt nj jv jw jx nk jz ka kb nl kd ke kf nm kh ki kj nn kl km kn im bi translated">保存文件并运行以下命令来启动FastAPI服务器:</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="1031" class="lk ll it lg b gy lm ln l lo lp">uvicorn main:app --host 0.0.0.0 --port 8000 --log-config log_conf.yml</span></pre><p id="7522" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您应该在终端上得到以下输出:</p><pre class="kp kq kr ks gt lf lg lh li aw lj bi"><span id="8205" class="lk ll it lg b gy lm ln l lo lp">[2021-11-29T08:48:33.632Z] uvicorn.error INFO:     Started server process [31514]<br/>[2021-11-29T08:48:33.633Z] uvicorn.error INFO:     Waiting for application startup.<br/>[2021-11-29T08:48:33.633Z] uvicorn.error INFO:     Application startup complete.<br/>[2021-11-29T08:48:33.633Z] uvicorn.error INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)<br/>[2021-11-29T08:48:37.568Z] uvicorn.access INFO:     &lt;IP&gt; - "GET / HTTP/1.1" 200<br/>[2021-11-29T08:48:40.561Z] uvicorn.access INFO:     &lt;IP&gt; - "GET / HTTP/1.1" 200</span></pre><p id="1331" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如您所见，新的日志为您提供了用户何时访问端点的更清晰的图像。您可以根据需要进一步定制它，以简化调试体验。</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="20de" class="mm ll it bd mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni bi translated">结论</h1><p id="fd5d" class="pw-post-body-paragraph jq jr it js b jt nj jv jw jx nk jz ka kb nl kd ke kf nm kh ki kj nn kl km kn im bi translated">让我们回顾一下你今天所学的内容。</p><p id="e414" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本文从一个简单的问题开始，即uvicorn日志中缺少时间戳，这在调试过程中可能会产生问题。</p><p id="95f4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，它讲述了如何安装pyyaml包并创建相应的配置文件。随后，我们转到formatters部分，重点介绍Python日期时间字符串和日志记录属性。</p><p id="2aea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，提供了一个使用配置文件和示例输出运行uvicorn的示例。</p><p id="6658" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢你阅读这篇文章。祝你有美好的一天！</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="4d9f" class="mm ll it bd mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni bi translated">参考</h1><ol class=""><li id="1b57" class="lr ls it js b jt nj jx nk kb ol kf om kj on kn oo lx ly lz bi translated"><a class="ae le" href="https://stackoverflow.com/questions/62934384/how-to-add-timestamp-to-each-request-in-uvicorn-logs" rel="noopener ugc nofollow" target="_blank"> StackOverflow —如何给uvicorn日志中的每个请求添加时间戳</a></li><li id="5163" class="lr ls it js b jt ma jx mb kb mc kf md kj me kn oo lx ly lz bi translated"><a class="ae le" href="https://www.uvicorn.org/settings/#logging" rel="noopener ugc nofollow" target="_blank">设置—uv icon</a></li></ol></div></div>    
</body>
</html>