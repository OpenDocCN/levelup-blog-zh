<html>
<head>
<title>How To Test UI In Android With Screenshot Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用截图测试来测试Android中的UI</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/testing-ui-in-android-with-screenshot-testing-7cc633836aad?source=collection_archive---------9-----------------------#2022-07-03">https://levelup.gitconnected.com/testing-ui-in-android-with-screenshot-testing-7cc633836aad?source=collection_archive---------9-----------------------#2022-07-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="97cd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">什么是截图测试，如何在你的项目中使用它</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/61f573095717b0ae4ab73c87902ef98c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AV-sjNckb67aO7Yg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">戴维·特拉维斯在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="7136" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有一些在生产环境中开发Android应用的经验，你应该已经知道测试你的应用的重要性。在测试的时候，我们可以做很多不同的测试，单元测试，集成测试……但是对我来说，让我对代码库更有安全感的是UI测试。</p><p id="f846" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">传统上，在Android中，UI测试是用Espresso完成的，并且需要运行物理或虚拟设备，所以正如你可以想象的那样，我们正在谈论的测试是繁重的，因此，即使你没有庞大的测试覆盖范围，也需要花费很多时间来运行。</p><p id="9d06" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">几个月前，我发现了截图测试，这基本上是在你认为有效的特定状态下对你的应用程序进行截图，然后将其与测试运行时拍摄的另一张截图进行比较。</p><p id="e201" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好像太容易了吧？嗯，那是因为确实是。</p><h1 id="0030" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Android中屏幕截图测试的替代方法</h1><p id="7985" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在我的调查中，我发现有三个顶级的截图测试库:</p><ul class=""><li id="dd03" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated"><a class="ae ky" href="https://github.com/pedrovgs/Shot" rel="noopener ugc nofollow" target="_blank">拍摄</a></li><li id="ec3e" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><a class="ae ky" href="https://github.com/facebook/screenshot-tests-for-android" rel="noopener ugc nofollow" target="_blank">脸书截图测试</a></li><li id="45de" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><a class="ae ky" href="http://shopify.github.io/android-testify/" rel="noopener ugc nofollow" target="_blank">购物作证</a></li></ul><blockquote class="ng nh ni"><p id="4ac1" class="kz la nj lb b lc ld ju le lf lg jx lh nk lj lk ll nl ln lo lp nm lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/dropbox/dropshots" rel="noopener ugc nofollow" target="_blank"> Dropbox刚刚发布了一款</a>但是说实话，我没有时间去查看或者阅读它，所以我没有把它放在这个故事中，但是如果有任何建议不适合你，请记住它。</p></blockquote><p id="5afc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每一种都有其优点和缺点，但就我而言，我最终使用了Shopify evidence。</p><p id="3ae7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这一决定背后的原因是，在Jenkins &amp; Firebase的CI环境中进行UI截图测试有一些限制，并且我还发现了更多关于Shopify替代方案的文档和支持。据我所知，他们都或多或少地以相同的方式工作，所以如果你从一个团队开始，想换团队，这看起来不会是一个特别痛苦的过程。</p><h1 id="8e6b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">开始编码前需要知道的事情</h1><p id="a7de" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">实现一个基本的屏幕截图测试非常容易，但是有两个限制需要注意。</p><p id="0d4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，当运行屏幕截图测试时，强制要求设备始终是具有相同Android版本的设备，或者您使用的仿真器每次都需要具有精确的配置。说到底，这些测试所做的只是在UI处于你认为正确的状态时，截屏用作基线，然后再次运行应用程序，截屏并与基线进行比较。如果设备的屏幕大小不同，或者语言不同，或者Android版本发生变化，测试就会失败，因为我们正在比较不同的图像。</p><p id="00db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二，我不知道我之前建议的其他库，但是Shopify evidence只能够在测试配置时对指定的活动进行截图。如果您导航到另一个活动，屏幕截图将不会正确拍摄。我相信这个库是为遵循单一活动模式的应用程序设计的，在这种模式下，应用程序有一个活动作为容器，所有的UI都由片段和不同的导航栈驱动，或者可能有一些框架限制，但我更倾向于第一种可能性。</p><blockquote class="ng nh ni"><p id="d9b3" class="kz la nj lb b lc ld ju le lf lg jx lh nk lj lk ll nl ln lo lp nm lr ls lt lu im bi translated">就像你可能对Espresso做的那样，在运行UI测试时，记得在设备的开发者设置中<a class="ae ky" href="https://github.com/dropbox/dropshots" rel="noopener ugc nofollow" target="_blank">禁用动画比例</a></p></blockquote><p id="6c4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好的，一旦我们意识到了局限性，我们可以从一些代码开始。和往常一样，我们需要开始配置Gradle项目，在我们的项目build.gradle中添加以下依赖项。</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="9221" class="ns lw it no b gy nt nu l nv nw">buildscript {<br/>    repositories {<br/>        mavenCentral()<br/>    }<br/>    dependencies {<br/>        classpath "com.shopify.testify:plugin:1.2.0-alpha01"<br/>    }<br/>}</span></pre><p id="2d9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于应用模块或您将要学习的模块。</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="53b8" class="ns lw it no b gy nt nu l nv nw">plugins {<br/>    id("com.shopify.testify")<br/>}</span><span id="2627" class="ns lw it no b gy nx nu l nv nw">dependencies {<br/>    androidTestImplementation "androidx.test:rules:1.4.0"<br/>}</span></pre><p id="8822" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Gradle sync之后，是时候写一个测试了。为此，正如您在文档中看到的，我们只需要以下几行。</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="02da" class="ns lw it no b gy nt nu l nv nw">@get:Rule var rule = ScreenshotRule(MainActivity::class.java)<br/><br/>    @ScreenshotInstrumentation<br/>    @Test<br/>    fun default() {<br/>        rule.assertSame()<br/>    }</span></pre><p id="f413" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将启动MainActivity，并使用该屏幕截图。有一些预先构建的Gradle任务可以与库进行交互，所以不要忘记查看它们。</p><p id="a8f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了运行我们刚刚编写的测试，我们需要记录一个基线截图。默认情况下，这个截图将被保存在<code class="fe ny nz oa no b">src/androidTest/assets/screenshots/&lt;deviceName&gt;</code>中，其中<code class="fe ny nz oa no b">deviceName</code>是<code class="fe ny nz oa no b">&lt;apiLevel&gt;-&lt;deviceResolution&gt;@&lt;deviceDPI&gt;-&lt;locale&gt;</code>。例如，如果我们在运行Android 10的Pixel 3模拟器中运行测试，截图将存储在<code class="fe ny nz oa no b">src/androidTest/assets/screenshots/30-1080x2160@440dp-en_US</code>中。</p><p id="1a9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是为什么总是使用相同的仿真器配置是很重要的，因为如果您获取基线截图，然后使用不同的仿真器运行测试，测试甚至不会比较截图，因为它不会找到基线。</p><p id="2ac4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了制作上述测试的基线截图，我们可以在终端中运行以下命令。</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="a158" class="ns lw it no b gy nt nu l nv nw">./gradlew screenshotRecord -PtestClass=com.screenshotSample.MyScreenshotTest#default</span></pre><p id="7a4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基线截图完成后，您可以像使用Android Studio的其他测试一样运行测试，您将有您的第一个截图测试！</p><p id="44ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">知道您可以在获取基线和测试运行的屏幕截图之前配置规则来运行Espresso操作也是很有用的，这样您就可以导航到您需要测试的UI部分。</p><h1 id="2cf8" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">您可能会用到的一些额外功能</h1><p id="3f25" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">您可以查看GitHub项目中的<a class="ae ky" href="https://github.com/Shopify/android-testify/wiki" rel="noopener ugc nofollow" target="_blank"> wiki </a>来了解更多关于该库提供的内容，但是在这里我将总结我在项目中使用最多的三个。</p><h2 id="cf0a" class="ns lw it bd lx ob oc dn mb od oe dp mf li of og mh lm oh oi mj lq oj ok ml ol bi translated">从截图中排除某些部分</h2><p id="6c0b" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">此功能会忽略您选择的用户界面的特定部分。在基线截图中，你会看到，即使你排除了一些视图，截图显示了整个用户界面，但当测试运行时，它会忽略这一部分，只比较其余部分。例如，对于具有随机组件的视图，或者当您正在进行某项特定的工作，并且不希望您的测试失败时，这个特性非常有用。</p><h2 id="1760" class="ns lw it bd lx ob oc dn mb od oe dp mf li of og mh lm oh oi mj lq oj ok ml ol bi translated">比较图像</h2><p id="6454" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">使用截图测试，为了知道测试失败的原因，您需要手动检查基线截图，然后是运行测试时拍摄的截图。有时候很容易看出来，但是可以想象，情况并不总是这样。为此，该库附带了一个Gradle任务，它依赖于<a class="ae ky" href="https://imagemagick.org/index.php" rel="noopener ugc nofollow" target="_blank"> ImageMagick </a>来比较图像，并给你一个直观的表示，告诉你用户界面中哪些部分是不同的。</p><h2 id="de5f" class="ns lw it bd lx ob oc dn mb od oe dp mf li of og mh lm oh oi mj lq oj ok ml ol bi translated">使用构建变体运行测试</h2><p id="c8c4" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">默认情况下，库将采用您设置的第一个构建变体，但是如果您想要采用基线并使用不同的构建变体运行测试，您需要在Gradle模块中配置它。也许这不是很多人使用的东西，但对我来说它很重要，并且在文档中没有解释，所以我必须阅读源代码来学习如何做到这一点。记住，如果你需要维基中没有解释的东西，你也可以这样做。</p><p id="8416" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，要指定一个构建变体，您只需要用您需要的配置将下面几行添加到Gradle模块中。</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="767b" class="ns lw it no b gy nt nu l nv nw">testify {<br/>    installAndroidTestTask ""<br/>    installTask ""<br/>    applicationPackageId ""<br/>    testPackageId ""<br/>}</span></pre><h1 id="837e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="a6ea" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">如果你在阅读教程的时候一直在编写代码，你应该已经注意到这个测试与Espresso相比运行起来要快得多，也容易得多。当然，它们有一些限制，但我认为速度是至关重要的，特别是如果你运行的是按使用付费的CI系统。</p><p id="164c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你怎么想呢?你要试试这个吗？如果你想补充什么或问任何问题，别忘了留下评论。</p></div><div class="ab cl om on hx oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="im in io ip iq"><p id="5f7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想阅读更多这样的内容，并支持我，不要忘记检查我的个人资料，或给媒体一个机会，成为会员，以获得我和其他作家的无限故事。一个月只要5美元，如果你使用这个链接，我会得到一小笔佣金。</p><div class="ot ou gp gr ov ow"><a href="https://medium.com/@molidev8/membership" rel="noopener follow" target="_blank"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd iu gy z fp pb fr fs pc fu fw is bi translated">通过我的推荐链接加入Medium—Miguel</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">阅读米格尔的每一个故事(以及媒体上成千上万的其他作家)。你的会员费直接支持米盖尔…</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">medium.com</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk ks ow"/></div></div></a></div><h1 id="8c41" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">分级编码</h1><p id="8aa4" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">感谢您成为我们社区的一员！更多内容请参见<a class="ae ky" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>。<br/>跟随:<a class="ae ky" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a>，<a class="ae ky" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">领英</a>，<a class="ae ky" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">通迅</a> <br/> <strong class="lb iu">升一级正在改造理工大招聘➡️ </strong> <a class="ae ky" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">加入我们的人才集体</strong> </a></p></div></div>    
</body>
</html>