<html>
<head>
<title>Search autocomplete with React &amp; AWS CloudSearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React &amp; AWS CloudSearch自动完成搜索</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/search-autocomplete-for-2-million-records-with-react-aws-cloudsearch-16fc02365bb1?source=collection_archive---------1-----------------------#2019-02-27">https://levelup.gitconnected.com/search-autocomplete-for-2-million-records-with-react-aws-cloudsearch-16fc02365bb1?source=collection_archive---------1-----------------------#2019-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/80dc1fdbc27e96481c4104bcc405b1f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dYJFDblglCRAgwlJHj65yw.png"/></div></div></figure><p id="5d69" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://truehome.hk" rel="noopener ugc nofollow" target="_blank"> True Home </a>是一个自举式的网络应用程序，为香港的每处房产提供房屋价值评估——这意味着超过200万套房屋。</p><p id="18f6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让用户尽可能高效地查看自己的家成了一个挑战。</p><p id="096b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了让用户更容易找到他们的家，我们使用以下堆栈构建了一个搜索自动完成服务:</p><ul class=""><li id="143f" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">AWS云搜索</li><li id="a3bd" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">反应</li><li id="f320" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe ll lm ln lo b">react-autosuggest</code> &amp; <code class="fe ll lm ln lo b">autosuggest-highlight</code>模块</li><li id="c636" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">Express.js服务器</li></ul><h1 id="a620" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">最终结果:</h1><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><h1 id="932e" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">香港房地产的一些趣闻:</h1><ul class=""><li id="9490" class="kx ky iq ka b kb mt kf mu kj mv kn mw kr mx kv lc ld le lf bi translated">大多数人住在有数百个单元的高层公寓里。</li><li id="06e4" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">香港的每座建筑都有一个独特的名字，比如“贝尔彻斯的肯尼迪”。</li><li id="0e59" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">香港人一般不会用诸如“123 Main Street ”这样的地址来称呼他们的居住地。相反，他们使用他们的建筑名称和地区，如“铜锣湾宝翠园A座”。</li></ul><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/ac92aca5afebdc563406d63d7a66301f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*o_RsSmbu786B3ZraDlw1nA.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">香港人就是这样生活的。中间那栋楼也正好是我现在的家！</figcaption></figure><h1 id="306e" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">我们的搜索自动完成要求:</h1><ul class=""><li id="2231" class="kx ky iq ka b kb mt kf mu kj mv kn mw kr mx kv lc ld le lf bi translated">无法使用<a class="ae kw" href="https://developers.google.com/maps/documentation/javascript/places-autocomplete" rel="noopener ugc nofollow" target="_blank"> Google Places API </a>，因为没有办法将结果连接到我们的数据库记录。</li><li id="87c8" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">我不能使用Algolia，因为它对我们的自举应用来说太贵了(200万张唱片每月700美元)。</li><li id="e789" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">用户应该能够通过建筑物的名称进行搜索。</li><li id="4a1d" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">用户应该能够通过建筑物名称和单元号来搜索他们的确切单元。</li></ul><h1 id="127f" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">在我们建造之前，我们先设计！</h1><p id="0af7" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj ne kl km kn nf kp kq kr ng kt ku kv ij bi translated">为了设计我们搜索功能的外观和感觉，我使用了<a class="ae kw" href="https://www.sketchapp.com/" rel="noopener ugc nofollow" target="_blank">草图应用</a>，并从我曾经工作过的地方<a class="ae kw" href="https://redfin.com" rel="noopener ugc nofollow" target="_blank"> Redfin </a>汲取灵感。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/37d2d3e8d589fde539c3531ee754c8a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JVrUB_GxTaN5WVHYnIRlJA.png"/></div></div></figure><p id="b3db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尽早敲定设计很重要，因为它帮助我弄清楚我需要使用什么工具，需要什么数据。</p><h1 id="8893" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">现在让我们为AWS CloudSearch准备数据</h1><p id="f015" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj ne kl km kn nf kp kq kr ng kt ku kv ij bi translated">您可以准备JSON、CSV、xml或txt格式的数据。我们选择JSON是因为批量上传只支持JSON和xml格式。</p><p id="1dba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">True Home有两个搜索类别:<code class="fe ll lm ln lo b">buildings</code>和<code class="fe ll lm ln lo b">units</code>。下面是我们的JSON文件的一个例子:</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="ni ms l"/></div></figure><h1 id="aa36" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">将数据上传到AWS CloudSearch</h1><p id="d287" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj ne kl km kn nf kp kq kr ng kt ku kv ij bi translated">您可以通过两种方式上传数据:通过AWS GUI控制台或通过终端通过<code class="fe ll lm ln lo b">aws</code>命令。</p><p id="8b32" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以上传到AWS CloudSearch的最大文件大小仅为5mb。这给我们带来了一个问题，因为我们有200万条记录，总共900mb的数据要上传！</p><p id="f95e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了解决这个问题，我们必须生成180个JSON文件，每个文件略低于5mb，并通过<code class="fe ll lm ln lo b">aws</code>命令行工具批量上传它们。</p><p id="7b62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是我们用来遍历所有180个JSON文件并上传到端点的bash脚本:</p><pre class="mn mo mp mq gt nj lo nk nl aw nm bi"><span id="0f52" class="nn lq iq lo b gy no np l nq nr">for VARIABLE in $(ls *.json); do echo $VARIABLE; aws cloudsearchdomain --endpoint-url {ENDPOINT URL here} upload-documents --content-type application/json --documents $VARIABLE; sleep 1s; done</span></pre><h1 id="b035" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">测试搜索结果</h1><p id="5059" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj ne kl km kn nf kp kq kr ng kt ku kv ij bi translated">AWS CloudSearch提供的一个好处是能够在控制台中立即测试搜索您的数据。</p><p id="8d27" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，我们可以测试新上传的数据:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/7b5857621fc943779af5dd9fcb45ed18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CYwkIZFO8EDvyFyNdKsRXA.png"/></div></div></figure><h1 id="dbe7" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">为AWS CloudSearch设置Express.js端点</h1><p id="66e0" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj ne kl km kn nf kp kq kr ng kt ku kv ij bi translated">一旦确认可以搜索新上传的数据，让我们在服务器上运行一个API来查询数据。真家正好用Express.js。</p><p id="4770" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">数据流是这样工作的:</p><p id="8e5f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ll lm ln lo b">User types a search → search query is sent to Express server → Express server gets data from CloudSearch endpoint → Express sends search results back to browser</code></p><p id="7ac8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">等一下！为什么我们需要通过服务器？为什么不直接从浏览器查询CloudSearch端点？</p><p id="bc74" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不幸的是，CloudSearch不支持CORS，这意味着你要么必须通过Express.js这样的服务器，要么设置某种代理服务，这两者都会增加每个查询的延迟。</p><p id="346e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，延迟影响并不太大，因为我们的服务器和CloudSearch实例托管在同一个AWS位置。</p><p id="4389" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是如何设置Express API的示例:</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="ni ms l"/></div></figure><p id="b73a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CloudSearch有<a class="ae kw" href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/CloudSearch.html" rel="noopener ugc nofollow" target="_blank">官方Javascript支持</a>，但出于某种原因，我很难让它工作。总体而言，缺乏AWS文档。</p><p id="3c00" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">作为一种变通方法，我简单地使用测试工具自动生成的端点作为我的快速获取URL。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/49a93b1d147e12e460434368007ab05e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e9UatkB7iiBg3aNw0oKQSw.png"/></div></div></figure><h1 id="ca7c" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">构建React组件</h1><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/f01ab23d88ebe023f02c25cb57f6744f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wXgz3bA5QUbGLU3w6Usq2w.png"/></div></div></figure><p id="fe58" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">True Home的React搜索组件是用<code class="fe ll lm ln lo b"><a class="ae kw" href="https://github.com/moroshko/react-autosuggest" rel="noopener ugc nofollow" target="_blank">react-autosugge</a>st</code>构建的。我们选择这个模块是因为它有很好的文档和易于理解的例子。</p><p id="d5c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最初，我担心用户输入时难以高亮显示单词，但是<code class="fe ll lm ln lo b"><a class="ae kw" href="https://github.com/moroshko/autosuggest-highlight" rel="noopener ugc nofollow" target="_blank">autosuggest-highlight</a></code>让这变得轻而易举。</p><p id="1270" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">总而言之，前端代码大概花了4个小时才完成。大部分时间花在格式化来自CloudSearch的数据上，其余时间花在样式化组件上。</p><p id="6987" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是True Home的搜索组件<a class="ae kw" href="https://gist.github.com/jlei523/dbe6b37540da793b5ada5cee9b00e58a" rel="noopener ugc nofollow" target="_blank">的全部内容</a>以供参考。</p><h1 id="81d6" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">结论:使用现代工具，搜索自动完成非常容易，但是我不会再使用云搜索了</h1><p id="5bf5" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj ne kl km kn nf kp kq kr ng kt ku kv ij bi translated">整个功能花了大约32个小时完成——比我最初想象的要快得多，因为我以前没有搜索经验。</p><p id="627f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">相比之下，早在2014年，一位经验丰富得多的工程师就花了一个多月的时间来构建Redfin的搜索功能。诚然，Redfin的搜索有更多的需求、更多的数据和更多的平台需要支持。</p><p id="a779" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最耗时的部分是为CloudSearch准备数据，以及查找CloudSearch糟糕而稀疏的文档。</p><p id="c950" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">亚马逊似乎不再改进CloudSearch了。上一次重大更新是在2013年。我怀疑这是由于<a class="ae kw" href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank">elastic search</a>的受欢迎程度超过了<a class="ae kw" href="http://lucene.apache.org/solr/" rel="noopener ugc nofollow" target="_blank">Solr</a>(cloud search的基础)。</p><p id="1eda" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果让我再做一次，我会选择Elasticsearch而不是CloudSearch，因为前者有更好的文档并支持CORS。</p><p id="9cb7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样！</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><p id="2b62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">跟我来:https://joelei.substack.com/<a class="ae kw" href="https://joelei.substack.com/" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>