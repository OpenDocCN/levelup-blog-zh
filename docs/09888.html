<html>
<head>
<title>Run Go AWS Lambda Locally with LocalStack and Serverless Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用LocalStack和无服务器框架在本地运行Go AWS Lambda</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/run-go-aws-lambda-locally-with-localstack-and-serverless-framework-5c80894f389c?source=collection_archive---------0-----------------------#2021-09-28">https://levelup.gitconnected.com/run-go-aws-lambda-locally-with-localstack-and-serverless-framework-5c80894f389c?source=collection_archive---------0-----------------------#2021-09-28</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="602f" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">痛苦和收获</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/0619c54a2e1877825443c1d82d293141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*I22lVrCYcx5PVmIT"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk">Photo by <a class="ae kz" href="https://unsplash.com/@hhh13?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">傅甬 华</a> on <a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="fa13" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我之前写过如何设置你的<a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/setup-your-go-lambda-and-deploy-with-terraform-9105bda2bd18"> Go Lambda并使用Terraform </a>进行部署。现在我们需要谈谈如何在本地运行Go Lambda。为什么？以避免每次都部署到AWS来测试您的代码更改。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="6c9e" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">无服务器离线FTW？</h1><p id="095b" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">我的第一反应是尝试<a class="ae kz" href="https://github.com/dherault/serverless-offline" rel="noopener ugc nofollow" target="_blank">无服务器离线</a>，但是通读他们的代码，我发现他们“不支持”Go。</p><p id="2a00" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你可以试着用特征标志<code class="fe na nb nc nd b">--useDocker</code>来运行它，我这么做了，哦，天哪，它慢得令人痛苦。比如30秒启动缓慢，每一次代码更改都需要30秒。不要误会，如果你正在运行JS项目，那么<a class="ae kz" href="https://github.com/dherault/serverless-offline" rel="noopener ugc nofollow" target="_blank">无服务器离线</a>是很棒的，只是不要去。</p><h1 id="0c9b" class="md me iu bd mf mg ne mi mj mk nf mm mn ka ng kb mp kd nh ke mr kg ni kh mt mu bi translated">LocalStack FTW？</h1><p id="5a69" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">在Google上浏览了更多之后，第二个选择也是最后一个选择是将<a class="ae kz" href="https://localstack.cloud/" rel="noopener ugc nofollow" target="_blank"> LocalStack </a>与<a class="ae kz" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>结合使用。他们的<a class="ae kz" href="https://localstack.cloud/docs/getting-started/overview/" rel="noopener ugc nofollow" target="_blank">文档</a>或多或少是全面的，并且不难发现是否有什么东西不工作。在继续阅读之前，请遵循他们的<a class="ae kz" href="https://localstack.cloud/docs/getting-started/installation/" rel="noopener ugc nofollow" target="_blank">安装</a>步骤。</p><p id="317d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">LocalStack允许你用两个选项来运行你的Lambda:本地“部署”或者把你的Go Lambda代码直接装载到LocalStack中。本地“部署”是现成的，使用无服务器框架，但是在测试代码之前，您需要等待伪“部署”到LocalStack中。那开发的时候还是又慢又烦。幸运的是，第二个选项非常快，只需稍作调整，您就有一个观察者来查看代码变化、编译代码、更新LocalStack中的本地Lambda并准备好测试。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="bdbc" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">给我看看魔法！</h1><p id="9b73" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">完整的设置和代码可以在<a class="ae kz" href="https://github.com/jagonzalr/go-lambda-localstack" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h2 id="6083" class="nj me iu bd mf nk nl dn mj nm nn dp mn lj no np mp ln nq nr mr lr ns nt mt nu bi translated"><strong class="ak">步骤1 —安装依赖关系</strong></h2><ol class=""><li id="fa9b" class="nv nw iu lc b ld mv lg mw lj nx ln ny lr nz lv oa ob oc od bi translated"><code class="fe na nb nc nd b">npm init -y</code></li><li id="477d" class="nv nw iu lc b ld oe lg of lj og ln oh lr oi lv oa ob oc od bi translated"><code class="fe na nb nc nd b">npm install --save-dev concurrently nodemon serverless serverless-localstack</code></li></ol><h2 id="30a6" class="nj me iu bd mf nk nl dn mj nm nn dp mn lj no np mp ln nq nr mr lr ns nt mt nu bi translated">步骤2-设置无服务器框架</h2><p id="282e" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">重要的部分是在<code class="fe na nb nc nd b">serverless.yml</code>文件内部配置LocalStack时设置<code class="fe na nb nc nd b">mountCode: true</code>。</p><pre class="kk kl km kn gu oj nd ok ol aw om bi"><span id="7e77" class="nj me iu nd b gz on oo l op oq">service: hello</span><span id="032f" class="nj me iu nd b gz or oo l op oq">provider:<br/>  name: aws<br/>  runtime: go1.x<br/>  region: us-east-1<br/>  stage: local</span><span id="1a92" class="nj me iu nd b gz or oo l op oq">plugins:<br/>  - serverless-localstack</span><span id="ed4c" class="nj me iu nd b gz or oo l op oq">package:<br/>  individually: true<br/>  custom:<br/>    localstack:<br/>      debug: true<br/>      edgePort: 4566<br/>      autostart: false<br/>      stages: [local]<br/>      lambda:<br/>        mountCode: true</span><span id="e0a4" class="nj me iu nd b gz or oo l op oq">functions:<br/>  hello:<br/>    handler: bin/hello<br/>    events:<br/>      - http:<br/>          path: hello<br/>          method: get<br/>          cors: true</span><span id="30a3" class="nj me iu nd b gz or oo l op oq">resources:<br/>  Resources:</span></pre><h2 id="36ec" class="nj me iu bd mf nk nl dn mj nm nn dp mn lj no np mp ln nq nr mr lr ns nt mt nu bi translated">步骤3 —定义构建脚本</h2><p id="10cb" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">你需要建立你的Go Lambda函数。为此，添加一个小的bash脚本<code class="fe na nb nc nd b">build.sh</code>。记得运行<code class="fe na nb nc nd b">chmod +x build.sh</code>，这样你就有权限运行这个脚本。</p><p id="55cf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">该脚本将类似于以下内容:</p><pre class="kk kl km kn gu oj nd ok ol aw om bi"><span id="6117" class="nj me iu nd b gz on oo l op oq">cd src/hello<br/>env GOOS=linux GOARCH=amd64 go build -o ../../bin/hello<br/>cd ../..</span></pre><h2 id="9f37" class="nj me iu bd mf nk nl dn mj nm nn dp mn lj no np mp ln nq nr mr lr ns nt mt nu bi translated">步骤4 —定义NPM脚本以在LocalStack中运行您的代码</h2><pre class="kk kl km kn gu oj nd ok ol aw om bi"><span id="ca99" class="nj me iu nd b gz on oo l op oq">"scripts": {<br/>  "build": "sh build.sh",<br/>  "deploy:local": "serverless deploy --stage local",<br/>  "start": "npm run build &amp;&amp; npm run deploy:local &amp;&amp; npm run watch",<br/>  "watch": "nodemon --watch src -e go --exec npm run build"<br/>}</span></pre><h2 id="dfe3" class="nj me iu bd mf nk nl dn mj nm nn dp mn lj no np mp ln nq nr mr lr ns nt mt nu bi translated">第五步—定义<code class="fe na nb nc nd b">docker-compose.yml</code>文件</h2><p id="9332" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">这是为了在本地运行带有必要AWS服务的LocalStack，并指定Go Lambda代码在机器中的位置。</p><pre class="kk kl km kn gu oj nd ok ol aw om bi"><span id="f30b" class="nj me iu nd b gz on oo l op oq">version: '3.8'<br/>services:<br/>  localstack:<br/>    image: localstack/localstack:latest<br/>    environment:<br/>      - EDGE_PORT=4566<br/>      - LAMBDA_EXECUTOR=local<br/>      - LAMBDA_REMOTE_DOCKER=0<br/>      - SERVICES=lambda,dynamodb,cloudformation,s3,sts,iam,apigateway,ecr<br/>      - HOST_TMP_FOLDER="${TMPDIR:-/tmp}/localstack"<br/>      - DEFAULT_REGION=us-east-1<br/>      - DEBUG=1<br/>    ports:<br/>      - '4566-4583:4566-4583'<br/>    volumes:<br/>      - '${TMPDIR:-/tmp/localstack}:/tmp/localstack'<br/>      - '/var/run/docker.sock:/var/run/docker.sock'<br/>      - '/path/to/code/bin/hello/hello:/path/to/code/bin/hello/hello'</span></pre><h2 id="a089" class="nj me iu bd mf nk nl dn mj nm nn dp mn lj no np mp ln nq nr mr lr ns nt mt nu bi translated">第六步——编写你的Go代码</h2><p id="48cb" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">我个人创建了一个<code class="fe na nb nc nd b">src</code>文件夹，并在里面为每个功能创建了一个文件夹。</p><h2 id="920e" class="nj me iu bd mf nk nl dn mj nm nn dp mn lj no np mp ln nq nr mr lr ns nt mt nu bi translated">步骤7 —启动本地堆栈</h2><p id="4913" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">要运行LocalStack，请记住Docker已经在运行了。要旋转您的LocalStack实例，请在您的<code class="fe na nb nc nd b">docker-compose.yml</code>所在的位置运行命令<code class="fe na nb nc nd b">docker-compose up</code>。</p><h2 id="fc7f" class="nj me iu bd mf nk nl dn mj nm nn dp mn lj no np mp ln nq nr mr lr ns nt mt nu bi translated">步骤8-在本地运行您的Go代码</h2><p id="3ed3" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">只需运行<code class="fe na nb nc nd b">npm start</code>。这将首次构建您的代码，将其挂载到LocalStack，并使用<a class="ae kz" href="https://github.com/remy/nodemon" rel="noopener ugc nofollow" target="_blank"> nodemon </a>监听代码更改。LocalStack将生成一个url，您可以在那里访问它并运行您的代码。它将类似于:<code class="fe na nb nc nd b">http://localhost/4566/restapis/[random_id]/local/_user_request_</code></p><p id="cc43" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">添加您在<code class="fe na nb nc nd b">serverless.yml</code>文件中定义的路线，例如<code class="fe na nb nc nd b">hello</code>，您应该会看到您的端点的输出</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj os"><img src="../Images/6f5058e130e78f745507f03a095ff290.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m9-zJltp7SXaZgYKDwxXrQ.png"/></div></div></figure><p id="e8ab" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在尝试更改您的代码，看看一切是如何自动刷新的。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><p id="808a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你现在可以在本地开发类似于JS的Go Lambda，而不需要每次都部署你的修改🎉</p><h2 id="01fc" class="nj me iu bd mf nk nl dn mj nm nn dp mn lj no np mp ln nq nr mr lr ns nt mt nu bi translated">笔记</h2><ul class=""><li id="63ff" class="nv nw iu lc b ld mv lg mw lj nx ln ny lr nz lv ot ob oc od bi translated">Go运行起来不像JS，你总是需要把二进制文件交给Lambda。这就是为什么我们总是在将代码挂载到LocalStack之前构建它。</li><li id="2f00" class="nv nw iu lc b ld oe lg of lj og ln oh lr oi lv ot ob oc od bi translated">当我们在<code class="fe na nb nc nd b">docker-compose.yml</code>中定义代码路径时，它是编译后的二进制文件的路径，而不是Go代码的路径。</li><li id="9459" class="nv nw iu lc b ld oe lg of lj og ln oh lr oi lv ot ob oc od bi translated">当您重新启动无服务器随机id将发生变化。</li></ul><div class="ou ov gq gs ow ox"><a href="https://blog.jagonzalr.com/membership" rel="noopener  ugc nofollow" target="_blank"><div class="oy ab fp"><div class="oz ab pa cl cj pb"><h2 class="bd iv gz z fq pc fs ft pd fv fx it bi translated">加入我的介绍链接媒体-何塞安东尼奥冈萨雷斯罗德里格斯</h2><div class="pe l"><h3 class="bd b gz z fq pc fs ft pd fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pf l"><p class="bd b dl z fq pc fs ft pd fv fx dk translated">blog.jagonzalr.com</p></div></div><div class="pg l"><div class="ph l pi pj pk pg pl kt ox"/></div></div></a></div></div></div>    
</body>
</html>