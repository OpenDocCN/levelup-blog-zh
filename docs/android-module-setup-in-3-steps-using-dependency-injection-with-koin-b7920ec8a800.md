# å¹²å‡€çš„ä»£ç :Android æ¨¡å—å’Œä¾èµ–æ³¨å…¥(ä¸“é•¿:Koin)

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/android-module-setup-in-3-steps-using-dependency-injection-with-koin-b7920ec8a800>

## ä¸€ä¸ªå¹²å‡€çš„åˆ†ç¦»å’Œäº²åˆ‡çš„åè®®çš„æ•…äº‹

æ¨¡å—åŒ–çš„åº”ç”¨ç¨‹åºè®¾è®¡å¯¹äºå¼€å‘äººå‘˜çš„ç†æ™ºã€åº”ç”¨ç¨‹åºçš„å¯ä¼¸ç¼©æ€§å’Œä»£ç è´¨é‡è‡³å…³é‡è¦ã€‚

> è®¾è®¡æ˜¯åˆ†ç¦»ã€ç»„åˆã€æŠ½è±¡å’Œéšè—çš„è‰ºæœ¯ã€‚â€”é²ä¼¯Â·é©¬ä¸å”å”

å½“æ¯ä¸ªæ¨¡å—å¯èƒ½éƒ½éœ€è¦çŸ¥é“`Application`ç±»æ˜¯ä½•æ—¶åˆ›å»ºçš„æ—¶å€™ï¼Œæˆ‘å¦‚ä½•æ‰èƒ½äº«å—ä¸€ä¸ªç”±é€‚å½“çš„åˆ†ç¦»å’ŒæŠ½è±¡(ä½¿ç”¨æ¨¡å—)ç»„æˆçš„ Android åº”ç”¨ç¨‹åºå‘¢ï¼Ÿ

*(è®¾ç½®æ¨¡å—çš„å‡ ä¸ªç”¨ä¾‹æ˜¯:åˆå§‹åŒ–åˆ†æåº“ï¼Œå½“åº”ç”¨ç¨‹åºè¯­è¨€æ”¹å˜æ—¶ï¼Œè§‚å¯Ÿ* `*LocaleLiveData*` *ä»¥åŒæ­¥å»ºè®®ï¼Œæˆ–è€…è§£åŒ…æ†ç»‘çš„æ•°æ®å¹¶æ’å…¥åˆ°æœ¬åœ°æ•°æ®åº“ä¸­ã€‚)*

å¾ˆæ£’çš„é—®é¢˜ï¼ä¸ºäº†è§£é‡Šï¼Œè®©æˆ‘ä»¬å¬å¬æˆ‘ä»¬çš„å¥½æœ‹å‹ï¼Œ`Application`:

*å¿«é€Ÿæç¤º:è™½ç„¶æˆ‘ä»¬åœ¨è¿™é‡Œå°†ä½¿ç”¨ Koin ä½œä¸ºæˆ‘ä»¬çš„ DI åº“ï¼Œä½†æ˜¯ä¸‹é¢çš„è®¾è®¡æ¨¡å¼å’Œè¿‡ç¨‹ä¹Ÿé€‚ç”¨äº Dagger 2(ä»¥åŠå¤§å¤šæ•°(å¦‚æœä¸æ˜¯å…¨éƒ¨çš„è¯)å…¶ä»– DI åº“)ã€‚*

> å—¨ï¼Œæˆ‘æ˜¯[ç”³è¯·](https://developer.android.com/reference/android/app/Application)ï¼
> 
> æˆ‘ä½åœ¨ä¸€ä¸ªå«`app`çš„æ¨¡å—é‡Œã€‚æˆ‘ç”±è®¸å¤šä¸åŒçš„[æ¨¡å—](https://medium.com/google-developer-experts/modularizing-android-applications-9e2d18f244a0)ç»„æˆï¼Œå› ä¸ºæˆ‘å–œæ¬¢[å¹²å‡€](https://medium.com/mindorks/understanding-clean-code-in-android-ebe42ad89a99)ï¼æˆ‘è®©æ¯ä¸ªæ¨¡å—åšè‡ªå·±çš„äº‹æƒ…ï¼Œæˆ‘ä¸æ‹…å¿ƒå®ƒä»¬çš„å®ç°ç»†èŠ‚â€”â€”è€å®è¯´ï¼Œæˆ‘æ›´å…³æ³¨å¤§å±€â€¦
> 
> ä½†æ˜¯æ¨¡å—éœ€è¦æˆ‘...å°¤å…¶æ˜¯å½“æˆ‘ç¬¬ä¸€æ¬¡è¢«åˆ›é€ çš„æ—¶å€™ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å·²ç»å°±å¦‚ä½•ç›¸äº’äº¤æµè¾¾æˆäº†ä¸€è‡´ï¼`base`æ¨¡å—ç§°ä¹‹ä¸º:`ModuleSetup` `interface`ã€‚æˆ‘éœ€è¦åšçš„å°±æ˜¯å‘æˆ‘ä»¬çš„æœ‹å‹`[Koin](https://insert-koin.io/)`è¯·æ±‚`ModuleSetup`çš„æ‰€æœ‰å®ä¾‹ï¼Œå¹¶å¯¹æ¯ä¸ªå®ä¾‹è°ƒç”¨`setup`æ–¹æ³•ï¼æˆ‘è®©å•ä¸ªæ¨¡å—åšå‘Šè¯‰`Koin`å¦‚ä½•æä¾›è¿™äº›å®ç°çš„å…·ä½“å·¥ä½œã€‚å°èœä¸€ç¢Ÿ*ğŸ°*ã€‚
> 
> æˆ‘ä»¬äº’ä¸å¹²æ¶‰ï¼Œä½†ä»ç„¶ä¿æŒç€éå¸¸å‹å¥½çš„å…³ç³»ğŸ™‚ã€‚
> 
> é³çŠ¶ç‰©

å¯¹äºé‚£äº›å–œæ¬¢åˆ—è¡¨è€Œä¸æ˜¯æ¥è‡ªæ— ç”Ÿå‘½ç‰©ä½“çš„æ•…äº‹çš„äººæ¥è¯´ï¼›éµå¾ªä»¥ä¸‹ä¸‰ä¸ªç®€å•çš„æ­¥éª¤æ¥è®¾ç½®æ‚¨çš„ Android åº”ç”¨ç¨‹åºçš„æ¨¡å—:

1.  ç”¨ä¸€ä¸ª`setup(app: Application)`æ–¹æ³•åˆ›å»ºä¸€ä¸ªå…±äº«çš„`ModuleSetup`T1
2.  æä¾›æ¥è‡ªæ¯ä¸ªæ¨¡å—çš„`ModuleSetup`å®ç°ï¼Œå¹¶å°†å®ƒä»¬`bind`åˆ°`interface`
3.  åœ¨`Application` `onCreate`ä¸­ï¼Œä½¿ç”¨`Koin`çš„`getAll<ModuleSetup>`è·å–æ‰€æœ‰å®ç°ï¼Œå¹¶ä½¿ç”¨`Application`ä¸Šä¸‹æ–‡å¯¹æ¯ä¸ªå®ç°è°ƒç”¨`setup`

![](img/86fa0f382803a0346b75068dd7281a32.png)

ç…§ç‰‡ç”±[pix poeties](https://unsplash.com/@blackpoetry?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„

å¯¹äºä»¥ä¸‹è§£é‡Šï¼Œäº†è§£éšå«çš„åº”ç”¨ç¨‹åºç»“æ„å°†å¾ˆæœ‰å¸®åŠ©:

```
-- app
-- modules
   -- base
   -- ...
   -- ...
   -- super-cool
```

`modules`å¯¹`app`ä¸€æ— æ‰€çŸ¥ã€‚`base`æ¨¡å—å°†åŒ…å«æ‰€æœ‰å…¶ä»–æ¨¡å—å¯ç”¨çš„ä»£ç ï¼ŒåŒ…æ‹¬`app`æ¨¡å—ã€‚è¿™æ˜¯æˆ‘ä»¬æ”¾ç½®`ModuleSetup` `interface`çš„åœ°æ–¹ã€‚

# åˆ›å»ºä¸€ä¸ª`ModuleSetup` `interface`

æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ç»å¸¸æœ‰éœ€è¦åˆå§‹åŒ–çš„ä»£ç ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦åœ¨åˆ›å»º`Application`ç±»æ—¶æä¾›å›è°ƒçš„èƒ½åŠ›ã€‚å¦å¤–ï¼Œåˆå§‹åŒ–ä»£ç é€šå¸¸éœ€è¦ä¸€ä¸ª`Context`æ¥è¿è¡Œã€‚

ä¸ºäº†æ»¡è¶³è¿™ä¸¤ä¸ªéœ€æ±‚ï¼Œåœ¨ç¼–å†™å¹²å‡€ä»£ç çš„åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºä¸€ä¸ªç±»åˆ›å»ºä¸€ä¸ªå¥‘çº¦ï¼Œè¯¥ç±»åŒ…å«ä¸€ä¸ªå°†`Application`ä¸Šä¸‹æ–‡ä½œä¸ºå‚æ•°çš„æ–¹æ³•ã€‚è¿™å°†å…è®¸`Koin`çš„`getAll<T>`æ–¹æ³•è¿”å›æˆ‘ä»¬å¥‘çº¦çš„æ‰€æœ‰å®ç°ï¼Œå› æ­¤`Application`å¯ä»¥ç›¸åº”åœ°ä¸å®ƒä»¬äº¤äº’ã€‚è¿™ä¸ªå¥‘çº¦éœ€è¦å¯¹`app`æ¨¡å—å’Œæ‰€æœ‰å…¶ä»–æ¨¡å—éƒ½å¯ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒæ”¾åœ¨æˆ‘ä»¬çš„`base`æ¨¡å—ä¸­ã€‚

æˆ‘ä»¬çš„åˆåŒå°†æ˜¯è¿™æ ·çš„:

```
package appname.setupinterface *ModuleSetup* {
    fun setup(app: Application)
}
```

ç°åœ¨ï¼Œä»»ä½•éœ€è¦åœ¨`Application`åˆ›å»ºä¸Šè®¾ç½®çš„æ¨¡å—éƒ½å¯ä»¥å®ç°è¿™ä¸ª`interface`å¹¶ä¸ºå…¶æä¾›`Koin`ã€‚

# å®ç°ã€æä¾›å¹¶ç»‘å®šæ‚¨çš„`ModuleSetup`å®ç°

äºæ˜¯ï¼Œ`base`ä¸ºæˆ‘ä»¬åˆ›é€ äº†ä¸€ä¸ª`interface`ã€‚è®©æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„`super-cool`æ¨¡å—ä¸­å®ç°å®ƒï¼Œå¹¶è¿è¡Œä¸€äº›æƒŠäººçš„åˆå§‹åŒ–ä»£ç ã€‚

```
package appname.modules.super.cool.setupimport appname.setup.ModuleSetup
import ... class ModuleSetupImpl constructor(private val repo: SuperCoolRepository, private val locale: LocaleLiveData) : *ModuleSetup* { @MainThread
    override fun setup(app: Application) {

        // warning: do not run blocking code on the main thread
        locale.observeForever {
            // runs task in background
            repo.syncRecommendations(it.languageTag)
        } }
}
```

å¦‚æœéœ€è¦ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`Koin`å°†ä¾èµ–æ³¨å…¥åˆ°æˆ‘ä»¬çš„å®ç°ä¸­ï¼›æ³¨æ„`SuperCoolRepository`å’Œ`LocaleLiveData`å‚æ•°ã€‚

åœ¨è¿™ä¸ªè®¾ç½®ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ³¨å…¥äº†ä¸€ä¸ª LiveDataï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„åŒºåŸŸè®¾ç½®å’Œä¸€ä¸ªå­˜å‚¨åº“ï¼Œè¯¥å­˜å‚¨åº“å°†æ ¹æ®åŒºåŸŸè®¾ç½®ä¸ºæˆ‘ä»¬æ„å»ºä¸€äº›å†…å®¹æ¨èã€‚è¿™ç§è®¾ç½®å…è®¸æˆ‘ä»¬ä¿æŒæˆ‘ä»¬çš„å†…å®¹ä¸ç”¨æˆ·çš„è¯­è¨€åŒæ­¥ï¼Œæ— è®ºå®ƒä½•æ—¶ä½•åœ°å‘ç”Ÿå˜åŒ–ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨æˆ‘ä»¬çš„`Koin` [æ¨¡å—](https://doc.insert-koin.io/#/koin-core/modules)ä¸­æä¾›å®ç°ã€‚

```
package appname.modules.super.cool.di.modulesimport ...val superCoolModule= module{ ...
    single { SuperCoolRepository() }
    single { ModuleSetupImpl(get(), get()) } bind ModuleSetup::class
    ...}
```

è¿™é‡Œçš„å…³é”®æ˜¯`Koin`çš„`[bind](https://doc.insert-koin.io/#/koin-core/definitions?id=additional-type-binding)`æ“ä½œç¬¦ã€‚è¿™å…è®¸æˆ‘ä»¬å°†æˆ‘ä»¬çš„å®ç°ç»‘å®šåˆ°`ModuleSetup` `interface`ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥æœ€åä¸€æ­¥äº†ã€‚

# å‘`Koin`ç´¢è¦`ModuleSetup`èŒä¸šå’Œæ”¶ç›Šï¼

æˆ‘ä»¬å·²ç»æŠŠæ‰€æœ‰ä¸œè¥¿è¿åœ¨ä¸€èµ·äº†ï¼æœ€åè¦åšçš„äº‹æƒ…æ˜¯å‘`Koin`è¯·æ±‚æ‰€æœ‰çš„`ModuleSetup`ç±»ï¼Œå¹¶å¯¹æ¯ä¸ªç±»è°ƒç”¨`setup`æ–¹æ³•ã€‚

```
class ModularApplication : Application(), *KoinComponent* {

    override fun onCreate() {
        super.onCreate()
 *startKoin* {
            *androidLogger*()
            *androidContext*(this@ModularApplication)
            modules(
                *appModule,
                baseModule,
                â€¦,
                superCoolModule* )
        }

        // Set up our modules
        getKoin().getAll<*ModuleSetup*>().*forEach* {
            it.setup(this)
        }
    }

}
```

è¿™é‡Œéœ€è¦æŒ‡å‡ºå‡ ä»¶äº‹:

1.  æˆ‘ä»¬ç…§å¸¸å¯åŠ¨`Koin`å¹¶åŠ è½½æˆ‘ä»¬çš„æ¨¡å—ï¼ŒåŒ…æ‹¬`superCoolModule`
2.  æˆ‘ä»¬å®ç°äº†`KoinComponent` `interface`ä»¥ä¾¿è®¿é—®`Koin`
3.  æˆ‘ä»¬æŒ‰ç…§`KoinComponent`æä¾›çš„`getKoin()`è°ƒç”¨`getAll<ModuleSetup>`æ–¹æ³•(åœ¨ä¸»çº¿ç¨‹ä¸Šè°ƒç”¨*ï¼Œä»¥ä¾¿å¾ªç¯é€šè¿‡å¹¶è®¾ç½®å„ä¸ªæ¨¡å—*

å°±æ˜¯è¿™æ ·ï¼

*åœ¨æˆ‘ä»¬ç¦»å¼€ä¹‹å‰æœ‰ä¸€ä¸ªé‡è¦çš„æ³¨æ„äº‹é¡¹:å½“* `*Application*` *è¢«åˆ›å»ºæ—¶ï¼Œ* `*setup*` *æ–¹æ³•ä¸­çš„æ‰€æœ‰ä»£ç éƒ½å°†åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¿…é¡»ä¸æƒœä¸€åˆ‡ä»£ä»·é¿å…åœ¨è®¾ç½®æ–¹æ³•ä¸­é˜»å¡ä»£ç ï¼Œé™¤éæˆ‘ä»¬é¦–å…ˆå°†å·¥ä½œå¸è½½åˆ°åå°çº¿ç¨‹ã€‚æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œçš„é˜»å¡ä»£ç è¶Šå¤šï¼Œåº”ç”¨ç¨‹åºå¯åŠ¨çš„æ—¶é—´å°±è¶Šé•¿ã€‚åœ¨æ›´æç«¯çš„æƒ…å†µä¸‹ï¼Œè¿è¡Œé˜»å¡ä»£ç (ç£ç›˜ I/Oã€ç½‘ç»œç­‰ã€‚)ï¼Œä¼šå¯¼è‡´ app å´©æºƒã€‚*

æˆ‘ä»¬ç°åœ¨å·²ç»å®ç°äº†ä¸€ç§æ–¹æ³•ï¼Œå°†æˆ‘ä»¬çš„ä»£ç åˆ†æˆæ¨¡å—ï¼ŒåŒæ—¶ä¿æŒåœ¨`Application`åˆ›å»ºæ—¶è¿è¡Œé‡è¦ä»£ç çš„èƒ½åŠ›ï¼Œæ‰€æœ‰è¿™ä¸€åˆ‡åªéœ€ä¸‰ä¸ªç®€å•çš„æ­¥éª¤:

1.  åˆ›å»ºæˆ‘ä»¬çš„å®‰è£…åˆåŒ(`interface`
2.  å®ç°å¹¶æä¾›åˆåŒçš„æ‰€æœ‰å®ä¾‹
3.  åœ¨`Application`T5 æ£€ç´¢åˆåŒå®ç°å¹¶ä¸ä¹‹äº¤äº’

ç°åœ¨ï¼Œäº«å—ä½ çš„å¹²å‡€å’Œæ¨¡å—åŒ–çš„ Android åº”ç”¨ç¨‹åºå§ï¼

![](img/e8e3cae1ce0885aabd3fee417500d2c0.png)

åŠ³ä¼¦Â·æ›¼å…‹åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šçš„ç…§ç‰‡