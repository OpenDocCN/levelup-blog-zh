<html>
<head>
<title>Reverse Proxies &amp; Client Connections</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反向代理和客户端连接</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/linux-kernel-tuning-for-high-performance-networking-f3256ffecf98?source=collection_archive---------7-----------------------#2020-01-12">https://levelup.gitconnected.com/linux-kernel-tuning-for-high-performance-networking-f3256ffecf98?source=collection_archive---------7-----------------------#2020-01-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5d14" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">高性能网络系列的Linux内核调优</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/cb7613924f1213955e9f6a31a8c91dec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IkLU_r37zj-mbPeM"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">肖恩·林在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="bb6e" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">短暂的港口</h1><p id="c1a9" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">当客户端连接到服务器时，使用临时端口。当操作上游工作线程的反向代理时，连接到工作线程的代理服务创建客户端套接字，上游工作线程创建服务器端套接字。当反向代理需要同时建立多个上行连接时，当上行连接的数量超过反向代理主机上的临时端口范围时，会出现<strong class="lq ir"> <em class="mk">临时端口耗尽</em> </strong>。在这种情况下，可以增加临时端口范围，使更多的套接字可用于代理服务器，从而允许更多的连接。</p><p id="3097" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">检测短暂的端口耗尽依赖于建立客户端连接的软件，但通常在应用程序的错误日志中会提到上游或代理“没有可用的客户端端口”错误。另一个症状是大量连接处于TIME_WAIT状态。当然，只需对照总数检查客户端连接的数量，就能确定已经达到了短暂的端口限制。</p><p id="5d42" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">使用中的临时端口的数量可以通过bash作为root来检查，可能需要为您的系统修改脚本:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="dbda" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">如果可用端口数量很少，请考虑增加端口范围。</p><p id="ca66" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated"><strong class="lq ir">临时端口范围<br/></strong>IANA客户端连接的建议临时端口范围是端口49152–65535。端口1024–49151被IANA视为半保留端口，因为应用程序开发人员可以为他们的应用程序注册一个端口，但只有当这些注册的服务之一在服务器上运行并侦听注册的端口时，才需要关注这些端口。</p><p id="ee61" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">默认情况下，许多linux内核中的网络堆栈默认使用端口32768–61000来维护服务器端的通信会话。这仅允许最多28，232个TCP连接。为了增加临时端口的数量并允许更多的代理连接，应该扩大该端口范围，以处理反向代理中配置的代理连接的数量。</p><p id="7928" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">系统端口号应排除在此范围之外，因此所选的最低端口应不低于1024，但也必须高于系统上任何已配置的侦听器所使用的最高端口，以避免端口冲突。例如，如果有一个服务正在侦听端口9990上的连接，最低的临时端口应该是9991或更高。对于具有环境端口方案的系统，选择方案中最高端口以上的端口。</p><p id="0046" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">虽然web服务器倾向于在端口80和443上运行，但是修改侦听器以使用非标准端口的主要原因是为了允许服务作为非根服务帐户被轻松控制。在这种情况下，web服务器应该位于能够将流量路由到非标准端口的负载平衡器之后。许多服务使用1024和9999范围内的侦听器就能很好地运行，因此排除这个范围可以灵活地在系统上配置服务侦听器，同时仍然可以将上游连接可用的临时端口数量增加近一倍。虽然不是唯一的好处，但开放8976个端口的侦听器端口范围也为制定端口方案标准创造了选择，以帮助管理由开发、测试、用户验收、试运行和生产环境组成的企业环境。</p><p id="8e0d" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated"><strong class="lq ir">示例<br/> </strong> Nginx在端口6180/6143监听生产流量，在端口9443监听nginx API流量，并且是几个后端服务的反向代理。<br/>因此，最低的短命端口应该是9444或以上；然而，为了避免试图维护部落知识转移所导致的问题，10000将是一个好的选择，因为它在最常见的侦听器端口之外，并且提供了一个易于记住并与团队共享的标准:“不要在10000以上的侦听器端口上配置任何服务。”</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">00-IP-本地-端口-范围. conf</figcaption></figure><h1 id="763e" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">最大分段寿命</h1><p id="a75f" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">许多反向代理服务器可以在负载下看到“TIME_WAIT”中连接数的增加。这是打开/关闭许多客户端连接的结果，有几个设置来处理这个问题。</p><h2 id="e4e5" class="ms kx iq bd ky mt mu dn lc mv mw dp lg lx mx my li mb mz na lk mf nb nc lm nd bi translated">在TIME_WAIT中重用连接</h2><p id="1eb1" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">如果通过将<code class="fe ne nf ng nh b"><strong class="lq ir"><em class="mk">net.ipv4.tcp_tw_reuse</em></strong></code>设置为1来启用，内核可以重用处于“TIME_WAIT”状态的连接，因此如果系统经历了大量的“TIME_WAIT ”,这可能是在受影响的系统上测试的一个好设置。</p><p id="705a" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">在linux中，根据您的内核版本，MSL被设置为以下内核设置之一。</p><ul class=""><li id="8e60" class="ni nj iq lq b lr ml lu mm lx nk mb nl mf nm mj nn no np nq bi translated">net . net filter . nf _ conn track _ TCP _ time out _ time _ wait</li><li id="0544" class="ni nj iq lq b lr nr lu ns lx nt mb nu mf nv mj nn no np nq bi translated">net . IP v4 . net filter . IP _ conntrack _ TCP _ time out _ time _ wait</li></ul></div></div>    
</body>
</html>