# MySQL 计数工作日出现次数

> 原文：<https://levelup.gitconnected.com/mysql-count-weekday-occurrences-5241511dba8c>

## 数字猫头鹰的散文

每一种 SQL 方言在某种程度上都与下一种*风格*不同。有的方言有这个功能，有的方言有那个功能。在这篇文章中，我将介绍将 Oracle SQL 移植到 MySQL 的方法，以便统计在当前给定月份(撰写本文时)某个特定工作日出现的次数，这纯粹是一个学习练习，重点是 MySQL 的函数和子句

![](img/acd95b7df31d834b95dd79f538021479.png)

图片由[tiger ly 713](https://pixabay.com/users/tigerlily713-194784/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=660670)从 [Pixabay](https://pixabay.com/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=660670) 拍摄

使用的操作系统和数据库:

*   Linux 薄荷 20“乌利亚纳”
*   MySQL 8.0.23

自我推销:

如果你喜欢这里写的内容，尽一切办法，把这个博客和你最喜欢的帖子分享给其他可能从中受益或喜欢它的人。既然咖啡是我最喜欢的饮料，如果你愿意，你甚至可以给我买一杯！

我写这篇博文的灵感来自于这个奇妙的 YouTube 视频。

尽管视频中的示例使用的是 Oracle 数据库(我没有怎么用过),但我还是学到了很多。而且，将 Oracle SQL 移植到 MySQL 的挑战对我来说是一个学习更多关于这两种实现的绝好机会。

## MySQL 计数工作日出现次数:需要数据

该练习的最终目标是统计某个月中某个特定工作日的出现次数。要解决这个问题，我们需要 3 个指标:

*   给定月份的第一天
*   给定月份的最后一天
*   给定月份中的天数。

## 1.每月的第一天

据我所知，MySQL 没有一个*每月第一天*类型的函数。但是，我们可以通过使用许多内置的`DATE`函数的组合来轻松检索当月的第一天。

让我们详细看看下面的查询:

在上面的查询中使用了 3 个函数来检索由`NOW()`函数提供的当月的第一天:

*   `DATE_ADD()`–执行日期运算
*   `NOW()`–提供当前日期和时间
*   `DAY()`–一个月中的第几天(1–31)

`DATE_ADD()`、`NOW()`和`DAY()`函数的组合产生一个`TIMESTAMP`值。然而，我只需要时间戳中的日期部分。通过将整个表达式包装在`DATE()`函数调用中，我们返回了日期值:

## 2.每月的最后一天

幸运的是，MySQL 确实有一个`LAST_DAY()`日期函数，它返回一个月的最后一天。

将`NOW()`函数作为`LAST_DAY()`的目标日期参数传递会产生该月的最后一天。我再次对整个表达式调用`DATE()`函数，检索结果的日期值:

## 3.一个月中的天数

我们现在有了 3 个所需指标中的 2 个:

要计算一个月的第一天和最后一天之间的天数，即一个月中的天数，我们可以简单地将上述指标相减，然后将结果加 1。写这篇文章的当前时间是 2021 年 3 月，有 31 天:

# MySQL 计数工作日出现次数:递归 CTE

我们需要的下一组数据之一是该月的第一天，重复的次数等于目标月份的天数。YouTube 视频作者使用了 Oracle SQL `CONNECT BY`子句来满足这一需求。但是，MySQL 没有`CONNECT BY`子句。

那么我可以用 MySQL 的什么来重现类似的`CONNECT BY`子句的行为呢？

利用递归`WITH`子句(也称为公用表表达式或 CTE)。

让我们首先使用递归 CTE 生成当前月份(31)的天数表:

只要“num _ days”CTE 在*范围*内，它就可以用于任何*后续*查询，并且可以在`FROM`子句中命名为数据源，如本查询所示:

实质上，如果“d_number”列值小于该月最后一天的值(本例中为 31)，则第二个`SELECT`语句的`WHERE`子句 conditional–1 将加到*循环*值上。

**重要提示**:CTE 名为‘num _ days’，第二个`SELECT`查询的`FROM`子句中的目标表/结果集也是如此。这就是递归。

为了更好地解释，我提供了官方文档中的确切措辞(参见结尾部分的链接):

> *"第一次选择产生 CTE 的初始行，而不引用 CTE 名称。第二个 SELECT 语句通过引用 FROM 子句中的 CTE 名称来生成额外的行并进行递归。当这部分不产生新行时，递归结束。因此，递归 CTE 由非递归选择部分和其后的递归选择部分组成*

当我继续在我的博客上提供有价值的内容时，考虑捐款。非常感谢！非常感谢。

![](img/a1152b14f0911b32b5b6e7ca345718b9.png)

## 用递归 CTE 复制一个月的第一天的值

现在，我们必须将该月的第一天的值复制与目标月份中的天数相同的次数。由于我们有一个递归 CTE，我们可以将这个值包含在两个`SELECT`的列列表中。在*递归* `SELECT`中，我们将非递归`SELECT`中的 1 加 1。

此外，我们必须在递归`SELECT`查询的`WHERE`子句中过滤，*监视*(某种程度上)d_number 值。只要' d_number '的计算结果小于一个月中的天数，则`WHERE`子句的结果为真，并且递归 CTE 继续生成行。

然而，一旦‘d _ number’等于一个月中的天数，在下一次迭代中，`WHERE`子句条件计算为 FALSE，递归停止。

为了更好地直观理解，我将`SELECT`列出“n _ days”CTE 的所有可用行:

复制一个月的第一天值的目的是，现在我们可以通过给每一行加 1 来执行日期计算，代表一个月中的每一天。但是，有一个小问题。添加值范围从 1 到 31，当添加到相应的月的第一天值时，每个结果日期将比预期值多 1 天。

修复方法是简单地从“d_number”列中减去 1(我把它看作是各种各样的*计数器*)，对于 CTE 返回的每一行:

通过从每个月的第一天值中减去 1，我们现在有了一个用于*日期计算*的数字。当将这两列相加时，我们会收到该月每一天的`DATE`值。同样，`DATE()`函数用于整个表达式，返回一个`DATE`值:

# MySQL Count Weekday occurrences:派生表和更多内置日期函数

**注意:**在接下来的几个查询中，假设我们到目前为止一直使用的 CTE 是可用的，因为为了提供更好的屏幕阅读并避免不必要的重复，它不会在下面的查询中显示。

从在`FROM`子句中使用“n _ days”CTE 的`SELECT`查询中创建一个`DERIVED TABLE`，连同`DAYNAME()`日期函数，我们可以检索 31 行中每一行的工作日名称(一个月中的每一天):

假设我想知道 2021 年 3 月有多少个星期二和星期五(本文的目标示例)？首先，我将在`WHERE`子句中使用`IN`谓词，并只过滤这两个工作日名称:

然后使用`COUNT()`聚合函数和`GROUP BY`函数返回值:

它返回工作日“星期二”和“星期五”的发生次数。

## 信息资源

*   [MySQL —查找一个月的第一天和最后一天](https://blog.sqlauthority.com/2014/04/09/mysql-finding-first-day-and-last-day-of-a-month/)
*   [MySQL 日期和时间函数](https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html)
*   [MySQL WITH(常用表表达式)](https://dev.mysql.com/doc/refman/8.0/en/with.html)

我非常喜欢写这篇文章，学习了很多关于 MySQL CTE、日期函数和 Oracle 数据库的知识。如果您在代码或解释中看到任何错误，请在下面评论，让我知道。

喜欢你读过的？看到什么不正确的吗？请在下面评论，感谢阅读！！！

# 行动的号召！

感谢你花时间阅读这篇文章。我真心希望你发现了一些有趣和有启发性的东西。请在这里与你认识的其他人分享你的发现，他们也会从中获得同样的价值。

访问 [Portfolio-Projects 页面](https://wp.me/P28ctb-3KD)查看我为客户完成的博客帖子/技术写作。

如果你给我买一杯咖啡，我保证我会喝掉它！

要在最新的博客文章发表时收到来自本博客(“数字猫头鹰散文”)的电子邮件通知(绝不是垃圾邮件)，请点击“点击订阅！”按钮在首页的侧边栏！(如有任何问题，请随时查看 [Digital Owl 的散文隐私政策页面](https://wp.me/P28ctb-3gI):电子邮件更新、选择加入、选择退出、联系表格等)

请务必访问[“最佳”](https://joshuaotwell.com/where-blog_post-in-digital-owls-prose-best-of/)页面，收集我的最佳博文。

[作为一名 SQL 开发人员和博客写手，Josh Otwell](https://joshuaotwell.com/about/) 热衷于学习和成长。其他最喜欢的活动是让他埋头于一本好书、一篇文章或 Linux 命令行。其中，他喜欢桌面 RPG 游戏，阅读奇幻小说，并与妻子和两个女儿共度时光。

免责声明:本文中的例子是关于如何实现类似结果的假设。它们不是最好的解决方案。所提供的大多数(如果不是全部)示例都是在个人发展/学习工作站环境中执行的，不应被视为生产质量或就绪。您的特定目标和需求可能会有所不同。使用那些最有利于你的需求和目标的实践。观点是我自己的。

*原载于 2021 年 4 月 7 日 https://joshuaotwell.com**[*。*](https://joshuaotwell.com/mysql-count-weekday-occurrences/)*