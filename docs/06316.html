<html>
<head>
<title>Simple DotNet Core API with AWS ECS Fargate using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform的简单DotNet核心API和AWS ECS Fargate</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/simple-dotnet-core-api-with-aws-ecs-fargate-using-terraform-f36f4664dcf0?source=collection_archive---------2-----------------------#2020-11-15">https://levelup.gitconnected.com/simple-dotnet-core-api-with-aws-ecs-fargate-using-terraform-f36f4664dcf0?source=collection_archive---------2-----------------------#2020-11-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0992" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS Fargate是一个用于容器的无服务器计算引擎，可以与亚马逊弹性容器服务(ECS)和亚马逊弹性容器服务(EKS)一起工作。Fargate使您可以轻松地专注于构建应用程序。Fargate消除了供应和管理服务器的需要，允许您为每个应用程序指定和支付资源，并通过设计应用程序隔离来提高安全性。(<a class="ae kl" href="https://aws.amazon.com/fargate" rel="noopener ugc nofollow" target="_blank">参见</a>)</p><p id="2e13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将使用Terraform向使用Fargate启动类型的ECS提供DotNet容器API。为了使事情更简单，我删除了所有可选属性；仅填写有助于我们使用Fargate部署到ECS的必需属性。如果你对实现的细节感兴趣，可以随意参考<a class="ae kl" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecs_service" rel="noopener ugc nofollow" target="_blank">这里的</a>。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="55c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要计划这些堆栈需要什么。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/d1c5361b9c20932a00e310332306ab49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1LTkrw3iecO_4IEleCYwjA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">基本API服务</figcaption></figure><p id="8db4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS Fargate中的基本API需要以下组件:-</p><ol class=""><li id="f1a5" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">应用程序负载平衡器:接受公共请求并路由到您的示例服务</li><li id="40ec" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">ECS集群:管理您所有的Fargate服务</li><li id="bbd0" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">ECR:存储您的图像工件</li><li id="9da5" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">示例服务:您应用程序在ECS服务中运行，使用Fargate启动类型</li></ol></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="0951" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">先决条件</h1><p id="9f31" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">为了遵循设置，您需要以下内容:-</p><ol class=""><li id="07a8" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated"><a class="ae kl" href="https://aws.amazon.com/free/?trk=ps_a134p000003yHrnAAE&amp;trkCampaign=acq_paid_search_brand&amp;sc_channel=PS&amp;sc_campaign=acquisition_MY&amp;sc_publisher=Google&amp;sc_category=Core&amp;sc_country=MY&amp;sc_geo=APAC&amp;sc_outcome=acq&amp;sc_detail=%2Baws%20%2Baccount&amp;sc_content=Account_bmm&amp;sc_segment=444351555789&amp;sc_medium=ACQ-P|PS-GO|Brand|Desktop|SU|AWS|Core|MY|EN|Text&amp;s_kwcid=AL!4422!3!444351555789!b!!g!!%2Baws%20%2Baccount&amp;ef_id=Cj0KCQiAnb79BRDgARIsAOVbhRpTdbVEw6q2GhWhOsQS-AfLEUC04_VYhKfpHa28oKyBwdQf1J7fn2saAu1hEALw_wcB:G:s&amp;s_kwcid=AL!4422!3!444351555789!b!!g!!%2Baws%20%2Baccount&amp;all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc" rel="noopener ugc nofollow" target="_blank"> AWS账户</a>带有访问密钥，密钥准备就绪</li><li id="c985" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><a class="ae kl" href="https://www.docker.com/products/docker-desktop" rel="noopener ugc nofollow" target="_blank"> Docker桌面</a>已安装</li><li id="c3f1" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><a class="ae kl" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio代码</a>已安装(可选)</li><li id="8be6" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><a class="ae kl" href="https://opensource.com/article/18/8/what-how-makefile" rel="noopener ugc nofollow" target="_blank"> Makefile </a>工具已安装</li></ol><blockquote class="na nb nc"><p id="ffff" class="jn jo nd jp b jq jr js jt ju jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj kk ij bi translated"><em class="iq">我们将运行并测试docker环境中的所有内容以及引用Makefile的所有命令。虽然这个项目在Mac环境下运行，但是对Makefile做最小的修改就可以在Window环境下运行。</em></p></blockquote></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="fbf3" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">环境设置</h1><p id="64f9" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">为了使环境对每个人都一样，我们将使用docker来运行和测试我们的项目。我们还使用makefile来存储我们需要的所有命令。</p><h2 id="1b8b" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">Makefile设置</h2><p id="0213" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">创建新文件夹并创建Makefile，如下所示:-</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="92e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Makefile会保留所有的命令来构建我们的实验室环境，创建DotNet项目，规划，应用和杀死terraform状态。</p><h2 id="acbf" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">在docker中设置实验室环境</h2><p id="2b1c" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">在根项目中创建一个包含以下内容的docker文件，以便我们可以在docker中创建我们的实验室环境:-</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="a10d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用aws-cli映像作为基础映像，并包括terraform和dotnet依赖项。</p><p id="7977" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在根项目中运行<code class="fe nv nw nx ny b">make lab</code>命令来构建实验室映像，如下所示:-</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi nz"><img src="../Images/b1799d3e6f54b036b9971c3830c233f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SYIi-n-nFpvSQmz_AU6bBQ.png"/></div></div></figure><p id="ec99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行<code class="fe nv nw nx ny b">make login-lab</code>构建docker实验室环境，你要用交互模式运行。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="0cf5" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">创建示例项目</h1><p id="0285" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">在同一个docker交互终端中，运行根文件夹中的<code class="fe nv nw nx ny b">make sample-project</code>，一个新的webapi项目将在<code class="fe nv nw nx ny b">src/SampleApi</code>中创建，如下所示:-</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi oa"><img src="../Images/11dabfa543e757012ec2c5c21c2634d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nEChAF_V77jJ0FDH-0f8HQ.png"/></div></div></figure><h2 id="b3a2" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">测试运行您的API</h2><p id="1634" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">运行<code class="fe nv nw nx ny b">make run-project</code>命令来测试你的api，你将能够从<code class="fe nv nw nx ny b">localhost:5000/WeatherForecast</code>触发它。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ob"><img src="../Images/e1129e13edb6117847edc4822ca029b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4dX6ZNb6ohI5RBki0rcsxA.png"/></div></div></figure><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi oc"><img src="../Images/13b4c066b4ed337830a7f6a888e74f68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*agphcnU-OtloWYHys8XxyQ.png"/></div></div></figure><h2 id="c841" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">向API项目添加健康检查支持</h2><p id="3840" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">应用程序负载平衡器要求目标ECR服务具有healthcheck终结点，以便了解您的服务运行状况。添加<code class="fe nv nw nx ny b">ConfigureServices</code>中的<code class="fe nv nw nx ny b">services.AddHealthChecks()</code>和<code class="fe nv nw nx ny b">Startup.cs</code>文件中<code class="fe nv nw nx ny b">Configure</code>部分的<code class="fe nv nw nx ny b">app.UseHealthCheck("/")</code>如下:-</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure><h2 id="83ac" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">将您的API项目归档</h2><p id="d7de" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">将新的Dockerfile添加到<code class="fe nv nw nx ny b">src/SampleApi</code>文件夹中，内容如下:-</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="b305" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">将图像推送到ECR</h1><p id="9e74" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">现在我们已经准备好了我们的DotNet API项目，是时候创建图像并将其推送到我们的ECR了。</p><h2 id="3b7e" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">设置AWS CLI凭据</h2><p id="3289" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">在您的交互式终端中，运行<code class="fe nv nw nx ny b">aws configure</code>来设置您的AWS凭证。或者，您可以使用命令<code class="fe nv nw nx ny b">export AWS_ACCESS_KEYID=&lt;your access key&gt; &amp;&amp; export AWS_SECRET_ACCESS_KEY=&lt;your secret access key&gt;</code>。如果您使用的是AWS SSO，则需要填写<code class="fe nv nw nx ny b">AWS_SESSION_TOKEN</code>。</p><h2 id="9c43" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">测试您的AWS CLI</h2><p id="e06c" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">运行命令<code class="fe nv nw nx ny b">aws sts get-caller-identity</code>来验证您的AWS帐户设置。如果您的凭证设置成功，您应该能够看到正确的帐号。</p><h2 id="42be" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">创建ECR新存储库</h2><p id="9dda" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">运行命令<code class="fe nv nw nx ny b">make repo</code>在您的AWS账户中创建新的回购，如下所示:-</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi od"><img src="../Images/5a54783fe7fe1afe102a5d885ff5b8bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G2HmaTbfDHEzXrgg3-GYzQ.png"/></div></div></figure><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi oe"><img src="../Images/c4997688009371266d2f98516180a746.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xsYsQFfZHVRFvdjU9l5DHg.png"/></div></div></figure><p id="cca0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以登录AWS控制台来验证您的存储库。</p><h2 id="5aac" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">登录ECR</h2><p id="a4c2" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">为了将您的本地映像推送到ECR，您需要登录ECR。运行命令<code class="fe nv nw nx ny b">make login</code>登录您的ECR。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi of"><img src="../Images/014482ce8793be992d517d2cb45f369c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sTIoEi5YTERvjOJLTqTwkg.png"/></div></div></figure><h2 id="e5ee" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">提升你的形象</h2><p id="cc5a" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">跑<code class="fe nv nw nx ny b">make image</code>把你的形象推到ECR。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi og"><img src="../Images/5b6c1554ab5538f129da4c2fc8abc997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4GjWLAG75M9pTy9D_Nmfgg.png"/></div></div></figure></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="8c70" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">设置地形脚本</h1><p id="f13b" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">我们已经完成了应用程序方面的工作。现在，我们需要建设我们的基础设施。在项目根目录下创建文件夹<code class="fe nv nw nx ny b">infra</code>，并设置如下内容。</p><h2 id="cc11" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated"><strong class="ak">数据资源</strong></h2><p id="b9ac" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">Terraform资源允许我们读取现有基础设施属性，如VPC和子网。在我们的例子中，我们重用现有的默认VPC。</p><p id="9dd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在infra文件夹中创建文件<code class="fe nv nw nx ny b">data.tf</code>，内容如下:-</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure><h2 id="e9cb" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">应用负载平衡器</h2><p id="5baf" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">在infra文件夹中创建文件<code class="fe nv nw nx ny b">alb.tf</code>，内容如下:-</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure><blockquote class="na nb nc"><p id="383d" class="jn jo nd jp b jq jr js jt ju jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj kk ij bi translated">我们用默认的静态内容和路径<code class="fe nv nw nx ny b">/WeatherForecast*</code>的路由规则设置ALB到我们的ECS资源。</p></blockquote><h2 id="4cd1" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated"><strong class="ak"> ECS集群</strong></h2><p id="1a93" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">在infra文件夹中创建文件<code class="fe nv nw nx ny b">cluster.tf</code>，内容如下:-</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure><h2 id="05b7" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">安全组</h2><p id="64e9" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">我们将为ALB和服务创建一个共享的安全组，在infra文件夹中创建<code class="fe nv nw nx ny b">sg.tf</code>，包含以下内容:-</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure><blockquote class="na nb nc"><p id="c297" class="jn jo nd jp b jq jr js jt ju jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj kk ij bi translated">我们创建的安全组将允许端口80的内部流量和公共流量</p></blockquote><h2 id="f0c2" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">ECS服务</h2><p id="2876" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">我们创建一个ECS服务<code class="fe nv nw nx ny b">my-api</code>在我们的ECS集群中运行。在infra文件夹中创建文件<code class="fe nv nw nx ny b">service.tf</code>，内容如下:-</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure><blockquote class="na nb nc"><p id="6570" class="jn jo nd jp b jq jr js jt ju jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj kk ij bi translated">ECS服务将使用运行任务的基本设置，并从ALB路由流量</p></blockquote><h2 id="4204" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">任务内容</h2><p id="6e87" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">任务定义用于描述我们需要运行什么样的容器配置和映像。在infra文件夹中创建文件<code class="fe nv nw nx ny b">task-def.tf</code>，内容如下:-</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure><blockquote class="na nb nc"><p id="988d" class="jn jo nd jp b jq jr js jt ju jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj kk ij bi translated">我们使用之前为这个任务定义推出的图像</p></blockquote><h2 id="03fd" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">任务角色和任务执行角色</h2><p id="06be" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">ECS有两种权限模型来管理资源。一个是<code class="fe nv nw nx ny b">Task Role</code>来承担容器的角色访问，另一个是<code class="fe nv nw nx ny b">Task Execution Role</code>让ECS集群代表我们运行，比如拉映像。为了简单起见，我们将对两种权限使用一个角色。在以下文件夹中创建文件<code class="fe nv nw nx ny b">task_role.tf</code>,内容如下:-</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure><blockquote class="na nb nc"><p id="b2a4" class="jn jo nd jp b jq jr js jt ju jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj kk ij bi translated">该角色仅提供基本的ECSTaskExecution角色策略和CreateLogGroup权限。如果需要其他权限，您可以添加更多。</p></blockquote><h2 id="fece" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">输出文件</h2><p id="b51a" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">最后，我们需要打印出我们的ALB信息，这样我们就可以触发它。在以下内容的基础文件夹中创建<code class="fe nv nw nx ny b">output.tf</code></p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="nt nu l"/></div></figure></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="678f" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">部署您的基础设施</h1><p id="a1b6" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">太好了！您已经使用terraform脚本设置完成了所有基础设施。事实上，大多数组件可以被设置为可重用的组件，以简化新服务的设置。现在，让我们回到你的docker交互终端。</p><h2 id="d279" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">初始化地形</h2><p id="fb6a" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">运行<code class="fe nv nw nx ny b">make init</code>来初始化所有需要的插件和提供者。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi oh"><img src="../Images/44945c86cbdae22d1db12b18c53c78e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nBROJEYYJzjzWGRLzxapjQ.png"/></div></div></figure><h2 id="7b3d" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">规划地形</h2><p id="96a8" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">运行<code class="fe nv nw nx ny b">make plan</code>以验证所有terraform设置是否正确。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi oi"><img src="../Images/1f04cd7618c96e33e29b599966189d51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*huXxgoJqOh3RbjzDS8HglA.png"/></div></div></figure><h2 id="384c" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">应用地形</h2><p id="f680" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">运行<code class="fe nv nw nx ny b">make apply</code>将更改应用到我们的AWS帐户。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi oj"><img src="../Images/53d99ecdb090bf8c6498b0926204cbb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O4xJR8j_1-hoI3ePecsSJQ.png"/></div></div></figure><blockquote class="na nb nc"><p id="6a55" class="jn jo nd jp b jq jr js jt ju jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj kk ij bi translated">成功应用上面的脚本后，您将能够在输出中找到您的ALB url。</p></blockquote><h2 id="1aa0" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">测试API</h2><p id="3b78" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">运行<code class="fe nv nw nx ny b">make test</code>来测试你的api，或者用<code class="fe nv nw nx ny b">{url}/WeatherForecast</code>打开浏览器。您可能需要尝试几次，直到所有都集成在一起。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ok"><img src="../Images/dc89cdc4ffd18fcafcedc6a646002c0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LQMxMKGwTPmkC6613xOUYg.png"/></div></div></figure><h2 id="a0c7" class="nh ly iq bd lz ni nj dn md nk nl dp mh jy nm nn ml kc no np mp kg nq nr mt ns bi translated">清除资源</h2><p id="0013" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">您可以登录AWS帐户来验证ECS cluster、ALB和cloudwatch。满意后，运行<code class="fe nv nw nx ny b">make kill</code>清空所有资源。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ol"><img src="../Images/1e1bb74d8e8d99bea4e0f5ea6f51c3de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xwYQi8-C0gldL1egmwF8-Q.png"/></div></div></figure></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="e97f" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">结论</h1><p id="455c" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">在本文中，我们将了解如何使用terraform脚本在AWS的Fargate launch类型中设置整个ECS服务。除此之外，我们还学习使用docker环境来完成所有步骤，并将所有命令打包到Makefile中。所有源代码可以参考<a class="ae kl" href="https://github.com/jazztong/dotnet-api-fargate" rel="noopener ugc nofollow" target="_blank">这里</a>。</p></div></div>    
</body>
</html>