<html>
<head>
<title>Using IAM roles to allow the Pods in AWS EKS to read the AWS S3 bucket</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用IAM角色允许AWS EKS中的pod读取AWS S3存储桶</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-iam-roles-to-allow-the-pods-in-aws-eks-to-read-the-aws-s3-bucket-be493fbdda84?source=collection_archive---------0-----------------------#2021-08-08">https://levelup.gitconnected.com/using-iam-roles-to-allow-the-pods-in-aws-eks-to-read-the-aws-s3-bucket-be493fbdda84?source=collection_archive---------0-----------------------#2021-08-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="6950" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ko translated"><span class="l kp kq kr bm ks kt ku kv kw di"> T </span> he <strong class="js iu"> AWS IAM(身份&amp;访问管理)</strong>服务允许AWS服务根据赋予其附属角色的策略进行交互。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/16b8ba9d49377311acf8463ff99cf8fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:710/format:webp/1*oYQ2nTjF1KY0-DXd0kUL3g.jpeg"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">AWS IAM</figcaption></figure><p id="c24d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们还可以将<strong class="js iu"> IAM角色</strong>与<strong class="js iu"> Kubernetes (k8s)本地服务帐户(SA) </strong>一起使用，这将允许在Kubernetes集群中运行的pod或<strong class="js iu"> AWS弹性Kubernetes服务(EKS) </strong>与AWS服务对话。</p><p id="d83a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇博客中，我们将了解如何通过使用具有Kubernetes本地服务帐户的IAM角色，允许在AWS EKS运行的Pod列出AWS S3存储桶中的对象。</p><p id="ac3b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">转到AWS S3服务，创建一个存储桶，然后向其中添加一些对象。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lj"><img src="../Images/57486e705d4aa0417e536bf3fa57b7e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*carEH5Hrp-NwCKTiO_UCIg.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">AWS S3 —桶创建— k8s-nest</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lo"><img src="../Images/9d6b7bb4852a30a3c5de8d206fbd1ce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CXfULuJy-3TZ8xzL5wF-iw.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">AWS S3-添加对象</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lp"><img src="../Images/87c35390c1643c229975c924217a1812.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XIytwrB7JxkYPdowY8GDWw.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">AWS S3</figcaption></figure><h2 id="2b61" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">创建身份提供者:-</h2><p id="3d52" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">a) <strong class="js iu">从现有的AWS EKS集群中复制OIDC (OpenID Connect) </strong>提供者URL，例如，在我的例子中，这是URL<a class="ae mo" href="https://oidc.eks.us-east-1.amazonaws.com/id/8B7D06AD395F38CE1EE8EF0AF2922255" rel="noopener ugc nofollow" target="_blank">https://oidc . eks . us-east-1 . Amazon AWS . com/id/8 b7d 06 ad 395 f 38 ce 1ee 8 ef 0 af 2922255</a></p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mp"><img src="../Images/52bfe445ca53530fee3e75c34fb43c16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oWKGPkB6J8lL_Ussi4GBWg.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">AWS EKS — OIDC</figcaption></figure><p id="2836" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">b)转到IAM -&gt; <strong class="js iu">身份提供者</strong>，单击“<strong class="js iu">添加提供者</strong>”按钮，然后选择“<strong class="js iu"> OpenID连接</strong>”。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mq"><img src="../Images/7735d6838c4506a19420f54a238a5982.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T9U34XcKHPANtWrIUx77oQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">IAM —身份提供者</figcaption></figure><p id="0553" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将复制的OIDC网址(来自EKS)粘贴到'<strong class="js iu">提供商网址</strong>选项下，点击'<strong class="js iu">获取指纹</strong>按钮，将<strong class="js iu">sts.amazonaws.com</strong>放在'<strong class="js iu">受众</strong>选项下，如下图所示。根据需要添加标签，并单击末尾的“<strong class="js iu">添加提供者</strong>”按钮添加身份提供者。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mr"><img src="../Images/78f44bc59eba30cec4b18609d7b94f7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e_Iam7NIRV-ovS1TxRPC4g.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">身份提供者</figcaption></figure><h2 id="ac2d" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">创建IAM策略以读取S3存储桶中的对象:-</h2><p id="0720" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">转到IAM策略，使用以下JSON创建一个自定义策略，以从S3存储桶中读取对象:-</p><pre class="ky kz la lb gt ms mt mu mv aw mw bi"><span id="337f" class="lq lr it mt b gy mx my l mz na">{<br/> “Version”: “2012–10–17”,<br/> “Statement”: [<br/>    {<br/>      “Effect”: “Allow”,<br/>      “Action”: [<br/>               “s3:ListBucket”,<br/>               “s3:GetObject”<br/>       ],<br/>       “Resource”: “arn:aws:s3:::k8s-nest”<br/>    }<br/> ]<br/>}</span></pre><h2 id="edda" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">创建与身份提供者具有信任关系的IAM角色:-</h2><p id="9e7f" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">转到IAM，创建一个信任类型为“<strong class="js iu"> Web identity </strong>”的新角色，并选择我们之前创建的正确身份提供者(从下拉列表中)和受众<strong class="js iu">sts.amazonaws.com</strong>，然后单击“<strong class="js iu">下一步:权限</strong>按钮，如下所示:-</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nb"><img src="../Images/9d01f74af30b35ab66297238f3c34103.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vKKAWfSsHCDldHkbeWYVxg.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">IAM角色Web身份</figcaption></figure><p id="edbb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">附加先前创建的。读取S3存储桶对象的自定义策略:-</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nc"><img src="../Images/3cbf988393e2b1e0f966d81305c2dbc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6wttUvVGVgy-9DN9s8jkMg.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">IAM角色-附加策略</figcaption></figure><p id="bfc3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为角色命名并创建它。</p><p id="6cc7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后再次打开同一个角色并编辑它的信任关系，以确保只有一个特定的Kubernetes服务帐户可以承担这个角色。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nd"><img src="../Images/91ad6fdfecb406cd78ebb229b0667fc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1HY0EN2VqRYtTlQCRDSayQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">IAM角色</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ne"><img src="../Images/b7ef857a9ef8f5afce6f1164ef443176.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9_nJgP4x-ErqDqH5vdmpCw.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">IAM角色—编辑信任关系</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nf"><img src="../Images/7e8591c602db50010a14a55c63826789.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Je885ce-8DEKjfa3L_9fg.png"/></div></div></figure><p id="fe9b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据策略，<strong class="js iu">将仅</strong> <strong class="js iu">允许</strong>名为“<strong class="js iu"> my-sa </strong>”(在名称空间“<strong class="js iu"> dev </strong>”)的Kubernetes服务帐户使用<strong class="js iu">AWS STS</strong><strong class="js iu">AssumeRoleWithWebIdentity</strong>来承担角色“<strong class="js iu"><em class="ng">custom-read-S3-bucket-objects</em>”。</strong></p><pre class="ky kz la lb gt ms mt mu mv aw mw bi"><span id="ee9a" class="lq lr it mt b gy mx my l mz na">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "Federated": "arn:aws:iam::195725532069:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/8B7D06AD395F38CE1EE8EF0AF2922255"<br/>      },<br/>      "Action": "sts:AssumeRoleWithWebIdentity",<br/>      "Condition": {<br/>        "StringEquals": {<br/>          "oidc.eks.us-east-1.amazonaws.com/id/8B7D06AD395F38CE1EE8EF0AF2922255:sub": "system:serviceaccount:dev:my-sa"<br/>        }<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="4bd3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">AWS侧的所有配置都已完成。现在，使用您的CLI(命令行界面)在同一个AWS EKS集群中创建一个服务帐户和Pod。</p><h2 id="b3cd" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">在Kubernetes中创建一个名称空间“dev”:</h2><pre class="ky kz la lb gt ms mt mu mv aw mw bi"><span id="5c2a" class="lq lr it mt b gy mx my l mz na">kubectl create ns dev</span></pre><h2 id="99a9" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">创建名为“my-sa”的服务帐户:</h2><p id="e469" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">创建一个服务帐户<strong class="js iu">，为之前创建的IAM角色ARN </strong>添加注释。如下图。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nh"><img src="../Images/6e8929ecb3ed0f960f4151fb9d6fca56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lq61NWcIBFS-MRFcir7A3A.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">我扮演ARN</figcaption></figure><pre class="ky kz la lb gt ms mt mu mv aw mw bi"><span id="6f92" class="lq lr it mt b gy mx my l mz na">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/> name: my-sa<br/> namespace: dev<br/> annotations:<br/>   eks.amazonaws.com/role-arn:  arn:aws:iam::195725532069:role/custom-read-s3-bucket-objects</span><span id="4eb9" class="lq lr it mt b gy ni my l mz na">kubectl create -f my-sa.yaml</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nj"><img src="../Images/a37ff75119ab92736d864c72e8f9f716.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NNeZAQuUB9umDBbWElZpKA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">命令行界面</figcaption></figure><h2 id="86e0" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">使用此服务帐户安排新的Pod</h2><p id="3cf1" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">不使用默认服务帐户，而是使用上面创建的帐户，即<strong class="js iu"> my-sa </strong>，并将其附加到Pod，如下所示。</p><pre class="ky kz la lb gt ms mt mu mv aw mw bi"><span id="bc67" class="lq lr it mt b gy mx my l mz na">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  labels:<br/>    run: my-pod<br/>  name: my-pod<br/>  namespace: dev<br/>spec:<br/>  serviceAccountName: my-sa<br/>  initContainers:<br/>  - image: amazon/aws-cli<br/>    name: my-aws-cli<br/>    command: ['aws', 's3', 'ls', 's3://k8s-nest/']<br/>  containers:<br/>  - image: nginx<br/>    name: my-pod<br/>    ports:<br/>    - containerPort: 80<br/>  dnsPolicy: ClusterFirst<br/>  restartPolicy: Always<br/>status: {}</span><span id="70bf" class="lq lr it mt b gy ni my l mz na">kubectl create -f my-pod.yaml</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nj"><img src="../Images/a37ff75119ab92736d864c72e8f9f716.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NNeZAQuUB9umDBbWElZpKA.png"/></div></div></figure><p id="25ec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，检查init容器的日志，你会注意到Pod成功地承担了角色，并与AWS S3通信，以安全地列出其中的所有对象，并使用最小特权原则减小爆炸半径。</p><pre class="ky kz la lb gt ms mt mu mv aw mw bi"><span id="a89f" class="lq lr it mt b gy mx my l mz na">kubectl logs my-pod my-aws-cli -n dev</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nk"><img src="../Images/c253a2697e90c5b95c806fff0ad95eb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t-zszd6o8kHejpnCNZ5pnQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">命令行界面— InitContainer</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nk"><img src="../Images/c253a2697e90c5b95c806fff0ad95eb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t-zszd6o8kHejpnCNZ5pnQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">命令行界面— InitContainer</figcaption></figure><p id="e05d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你喜欢这篇文章:)</p><h1 id="9156" class="nl lr it bd ls nm nn no lv np nq nr ly ns nt nu mb nv nw nx me ny nz oa mh ob bi translated">一些有趣的事实</h1><p id="cf40" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">如果您在pod上描述或执行get操作，那么您会看到很多信息，尤其是关于新的<strong class="js iu">卷挂载(aws-iam-token) </strong>和<strong class="js iu"> AWS环境变量</strong>。</p><pre class="ky kz la lb gt ms mt mu mv aw mw bi"><span id="e175" class="lq lr it mt b gy mx my l mz na">~/go/mywork/mydevelopment/k8s-nest/iac/k8s/iam-roles-with-k8s-service-account  ‹iam-roles-sa*› $ kubectl describe po my-pod -n dev                           1 <br/><br/>Name:         my-pod<br/>Namespace:    dev<br/>Priority:     0<br/>Node:         ip-192-168-49-52.ec2.internal/192.168.49.52<br/>Start Time:   Sun, 08 Aug 2021 13:22:39 +0530<br/>Labels:       run=my-pod<br/>Annotations:  kubernetes.io/psp: eks.privileged<br/>Status:       Running<br/>IP:           192.168.55.23<br/>IPs:<br/>  IP:  192.168.55.23<br/>Init Containers:<br/>  my-aws-cli:<br/>    Container ID:  docker://b154f0044d33ae02282522fa9100466e4e5d7bd156fcdae808fbf3315dd55642<br/>    Image:         amazon/aws-cli<br/>    Image ID:      docker-pullable://amazon/aws-cli@sha256:598e7034c011611a9218c75f6305e528d63eea2898a02f94df0331a4c8eac66e<br/>    Port:          &lt;none&gt;<br/>    Host Port:     &lt;none&gt;<br/>    Command:<br/>      aws<br/>      s3<br/>      ls<br/>      s3://k8s-nest/<br/>    State:          Terminated<br/>      Reason:       Completed<br/>      Exit Code:    0<br/>      Started:      Sun, 08 Aug 2021 13:22:40 +0530<br/>      Finished:     Sun, 08 Aug 2021 13:22:41 +0530<br/>    Ready:          True<br/>    Restart Count:  0<br/>    Environment:<br/>      AWS_DEFAULT_REGION:           us-east-1<br/>      AWS_REGION:                   us-east-1<br/>      AWS_ROLE_ARN:                 arn:aws:iam::195725532069:role/custom-read-s3-bucket-objects<br/>      AWS_WEB_IDENTITY_TOKEN_FILE:  /var/run/secrets/eks.amazonaws.com/serviceaccount/token<br/>    Mounts:<br/>      /var/run/secrets/eks.amazonaws.com/serviceaccount from aws-iam-token (ro)<br/>      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-ns57p (ro)<br/>Containers:<br/>  my-pod:<br/>    Container ID:   docker://419aaf1b5493e099a7f94f5e0a31bc1b5d736766c909c41b921695b95dfa2aca<br/>    Image:          nginx<br/>    Image ID:       docker-pullable://nginx@sha256:8f335768880da6baf72b70c701002b45f4932acae8d574dedfddaf967fc3ac90<br/>    Port:           80/TCP<br/>    Host Port:      0/TCP<br/>    State:          Running<br/>      Started:      Sun, 08 Aug 2021 13:22:42 +0530<br/>    Ready:          True<br/>    Restart Count:  0<br/>    Environment:<br/>      AWS_DEFAULT_REGION:           us-east-1<br/>      AWS_REGION:                   us-east-1<br/>      AWS_ROLE_ARN:                 arn:aws:iam::195725532069:role/custom-read-s3-bucket-objects<br/>      AWS_WEB_IDENTITY_TOKEN_FILE:  /var/run/secrets/eks.amazonaws.com/serviceaccount/token<br/>    Mounts:<br/>      /var/run/secrets/eks.amazonaws.com/serviceaccount from aws-iam-token (ro)<br/>      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-ns57p (ro)<br/>Conditions:<br/>  Type              Status<br/>  Initialized       True<br/>  Ready             True<br/>  ContainersReady   True<br/>  PodScheduled      True<br/>Volumes:<br/>  aws-iam-token:<br/>    Type:                    Projected (a volume that contains injected data from multiple sources)<br/>    TokenExpirationSeconds:  86400<br/>  kube-api-access-ns57p:<br/>    Type:                    Projected (a volume that contains injected data from multiple sources)<br/>    TokenExpirationSeconds:  3607<br/>    ConfigMapName:           kube-root-ca.crt<br/>    ConfigMapOptional:       &lt;nil&gt;<br/>    DownwardAPI:             true<br/>QoS Class:                   BestEffort<br/>Node-Selectors:              &lt;none&gt;<br/>Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s<br/>                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s<br/>Events:<br/>  Type    Reason     Age   From               Message<br/>  ----    ------     ----  ----               -------<br/>  Normal  Scheduled  15m   default-scheduler  Successfully assigned dev/my-pod to ip-192-168-49-52.ec2.internal<br/>  Normal  Pulling    15m   kubelet            Pulling image "amazon/aws-cli"<br/>  Normal  Pulled     15m   kubelet            Successfully pulled image "amazon/aws-cli" in 124.439524ms<br/>  Normal  Created    15m   kubelet            Created container my-aws-cli<br/>  Normal  Started    15m   kubelet            Started container my-aws-cli<br/>  Normal  Pulling    15m   kubelet            Pulling image "nginx"<br/>  Normal  Pulled     15m   kubelet            Successfully pulled image "nginx" in 134.055866ms<br/>  Normal  Created    15m   kubelet            Created container my-pod<br/>  Normal  Started    15m   kubelet            Started container my-pod</span></pre><p id="799c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">新的AWS环境变量和卷安装:-</p><pre class="ky kz la lb gt ms mt mu mv aw mw bi"><span id="2c99" class="lq lr it mt b gy mx my l mz na">env:<br/>    - name: AWS_DEFAULT_REGION<br/>      value: us-east-1<br/>    - name: AWS_REGION<br/>      value: us-east-1<br/>    - name: AWS_ROLE_ARN<br/>      value: arn:aws:iam::195725532069:role/custom-read-s3-bucket-objects<br/>    - name: AWS_WEB_IDENTITY_TOKEN_FILE<br/>      value: /var/run/secrets/eks.amazonaws.com/serviceaccount/token</span><span id="e90b" class="lq lr it mt b gy ni my l mz na">volumes:<br/>  - name: aws-iam-token<br/>    projected:<br/>      defaultMode: 420<br/>      sources:<br/>      - serviceAccountToken:<br/>          audience: sts.amazonaws.com<br/>          expirationSeconds: 86400<br/>          path: token</span></pre><p id="ae0a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">环境变量<strong class="js iu">AWS _ WEB _ IDENTITY _ TOKEN _ FILE</strong>和<strong class="js iu"> AWS_ROLE_ARN </strong>通过改变配置在AWS EKS中的kube-api服务器上的webhook控制器以及安装在容器中的卷(<strong class="js iu"> aws-iam-token </strong>)被动态注入到Pod清单文件中。<strong class="js iu"> aws-iam-token </strong>卷<strong class="js iu">Pod进一步使用此令牌来调用AWS S3。</strong></p><h1 id="32da" class="nl lr it bd ls nm nn no lv np nq nr ly ns nt nu mb nv nw nx me ny nz oa mh ob bi translated">总结:</h1><p id="6034" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">在这篇博客中，我们了解了如何使用<strong class="js iu"> AWS IAM角色</strong>并创建与<strong class="js iu"> Kubernetes服务帐户</strong>的信任关系，并使用该服务帐户和在AWS EKS内部运行的Pods，以最小特权原则<strong class="js iu">调用AWS S3。</strong></p><p id="6917" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在后台，OIDC联邦允许Pod通过带有AWS STS的Kubernetes服务帐户来承担IAM角色，以接收JSON Web令牌(JWT)。在Kubernetes中，我们然后使用作为有效OIDC令牌的计划服务帐户令牌，给予每个Pod加密的签名令牌，STS可以针对OIDC提供者验证这些令牌，以便通过使用AWS STS <strong class="js iu">的<strong class="js iu">AssumeRoleWithWebIdentity</strong>将OIDC令牌交换为IAM角色凭证来建立其身份。</strong></p><p id="5f85" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">像往常一样，你可以在我的GitHub库找到完整的源代码。请随意分叉它，并添加更多的IaC(基础设施代码)</p><p id="7098" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae mo" href="https://github.com/vinod827/k8s-nest/tree/main/iac/k8s/iam-roles-with-k8s-service-account" rel="noopener ugc nofollow" target="_blank">https://github . com/vinod 827/k8s-nest/tree/main/IAC/k8s/iam-roles-with-k8s-service-account</a></p></div></div>    
</body>
</html>