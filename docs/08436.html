<html>
<head>
<title>Building a Prometheus Exporter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">建造一个普罗米修斯出口器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/building-a-prometheus-exporter-8a4bbc3825f5?source=collection_archive---------0-----------------------#2021-05-03">https://levelup.gitconnected.com/building-a-prometheus-exporter-8a4bbc3825f5?source=collection_archive---------0-----------------------#2021-05-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b4d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://prometheus.io/docs/introduction/overview/" rel="noopener ugc nofollow" target="_blank"> <em class="km">普罗米修斯</em> </a> <em class="km">是一款开源监控工具，用于从您的应用和基础设施中收集指标。作为云原生环境的基础之一，Prometheus已经成为云原生环境中可见性的事实上的标准。</em></p><h1 id="5a8d" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">普罗米修斯是如何工作的？</h1><p id="55eb" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">普罗米修斯是一个<a class="ae kl" href="https://www.influxdata.com/time-series-database/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"/></a><strong class="jp ir"/>时序数据库和一个<strong class="jp ir"> </strong>拉动式监控系统。它定期抓取HTTP端点(目标)来检索指标。它可以监控服务器、数据库、独立虚拟机等目标。</p><p id="5fc6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Prometheus使用简单的<a class="ae kl" href="https://prometheus.io/docs/instrumenting/exposition_formats/#text-based-format" rel="noopener ugc nofollow" target="_blank">基于文本的</a>展示格式读取目标展示的指标。有一些客户端库可以帮助您的应用程序公开普罗米修斯格式的指标。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/8053eff5e2394f9e82480a5c9c9cc215.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UhSRulXaVEDoQQRL4nPu6g.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">普罗米修斯是如何工作的？(<a class="ae kl" href="https://www.youtube.com/watch?v=D09x0eR4vu4" rel="noopener ugc nofollow" target="_blank">参考</a>)</figcaption></figure><h1 id="54c8" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">普罗米修斯矩阵</h1><p id="9c9f" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">与Prometheus合作时，了解Prometheus metrics非常重要。这是四种类型的指标，有助于为您的应用提供工具:</p><ol class=""><li id="7c53" class="mg mh iq jp b jq jr ju jv jy mi kc mj kg mk kk ml mm mn mo bi translated"><strong class="jp ir">计数器(唯一的方法是up): </strong>使用计数器对事件、作业、金钱、HTTP请求等进行计数。其中累积值是有用的。</li><li id="1b11" class="mg mh iq jp b jq mp ju mq jy mr kc ms kg mt kk ml mm mn mo bi translated"><strong class="jp ir">度量(当前图片):</strong>在当前值重要的地方使用——CPU、RAM、JVM内存使用、队列级别等<strong class="jp ir">。</strong></li><li id="4aea" class="mg mh iq jp b jq mp ju mq jy mr kc ms kg mt kk ml mm mn mo bi translated"><strong class="jp ir">直方图(抽样观察):</strong>通常与计时一起使用，<strong class="jp ir"> </strong>在需要一个时间范围内的整体情况时—查询时间、HTTP响应时间。</li><li id="783a" class="mg mh iq jp b jq mp ju mq jy mr kc ms kg mt kk ml mm mn mo bi translated"><strong class="jp ir">摘要(客户端分位数):</strong>本质上类似于直方图，不同之处在于分位数也在客户端计算。当您开始对一个或多个直方图指标频繁使用分位数值时使用。</li></ol><h1 id="18b1" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">利用普罗米修斯</h1><ul class=""><li id="df2a" class="mg mh iq jp b jq ll ju lm jy mu kc mv kg mw kk mx mm mn mo bi translated">Prometheus提供了客户端库，您可以使用这些库向您的应用程序添加工具。</li><li id="abd5" class="mg mh iq jp b jq mp ju mq jy mr kc ms kg mt kk mx mm mn mo bi translated">客户端库在URL处公开您的指标，例如<a class="ae kl" href="http://localhost:8000/metrics." rel="noopener ugc nofollow" target="_blank"><em class="km">http://localhost:8000/metrics</em></a></li><li id="d148" class="mg mh iq jp b jq mp ju mq jy mr kc ms kg mt kk mx mm mn mo bi translated">将URL配置为Prometheus中的目标之一。普罗米修斯现在会定期收集数据。您可以使用Grafana等可视化工具来查看您的指标，或者使用Alertmanager通过配置文件中定义的自定义规则来配置警报。</li></ul><h1 id="1027" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">普罗米修斯出口商</h1><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi my"><img src="../Images/d0fbb29a5ec32506d0e66fc7dc40b57f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1OpRRb67QvRVg4nx"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated"><a class="ae kl" href="https://unsplash.com/@matthewhenry?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马太·亨利</a>在<a class="ae kl" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="4db6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">普罗米修斯<strong class="jp ir"> </strong>有一个<a class="ae kl" href="https://awesomeopensource.com/projects/prometheus-exporter" rel="noopener ugc nofollow" target="_blank">出口商</a>的庞大生态系统。<strong class="jp ir"> </strong> Prometheus导出器在Prometheus和不使用Prometheus格式导出指标的应用程序之间架起了一座桥梁。例如，Linux不公开普罗米修斯格式的指标。这就是普罗米修斯导出器存在的原因，比如节点导出器。</p><p id="5fd4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一些应用程序，如Spring Boot，Kubernetes等。将普罗米修斯指标开箱即用。另一方面，导出器使用现有来源的指标，并利用Prometheus客户端库将指标导出到Prometheus。</p><p id="ba79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">普罗米修斯导出器可以是有状态的，也可以是无状态的。有状态导出器负责收集数据，并使用通用度量格式(如计数器、计量器等)导出数据。无状态导出器是使用计数器度量族、计量器度量族等将度量从一种格式转换为普罗米修斯度量格式的导出器。它们不维护任何本地状态，而是显示来自另一个度量源(如JMX)的视图。例如，Jenkins Jobmon是Jenkins的Prometheus exporter，它调用Jenkins API来获取每次抓取的指标。</p><div class="mz na gp gr nb nc"><a href="https://github.com/grofers/jenkins-jobmon" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd ir gy z fp nh fr fs ni fu fw ip bi translated">格罗佛斯/詹金斯-乔布门律师事务所</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">詹金斯出口商为普罗米修斯在python。它使用普罗米修斯自定义收集器API，允许自定义…</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">github.com</p></div></div><div class="nl l"><div class="nm l nn no np nl nq ma nc"/></div></div></a></div><h1 id="bfae" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">让我们构建一个通用的HTTP服务器度量导出器！</h1><p id="c57d" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">我们将构建一个Prometheus exporter，用于从日志中监控HTTP服务器。它从HTTP日志中提取数据，并将其导出到Prometheus。我们将使用一个<a class="ae kl" href="https://github.com/prometheus/client_python" rel="noopener ugc nofollow" target="_blank"> python客户端库</a>，<code class="fe nr ns nt nu b">prometheus_client</code>，通过HTTP端点定义和公开指标。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi nv"><img src="../Images/01ca8d86296335c88b284307d90d7bf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tnVyecPLcTgwQY0LbChBxw.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">httpd_exporter中的一个指标</figcaption></figure><p id="af00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的HTTP exporter将重复跟踪服务器日志，以提取有用的信息，如HTTP请求、状态代码、传输的字节和请求计时信息。HTTP日志是跨Apache、Nginx等不同服务器结构化和标准化的。你可以从<a class="ae kl" href="https://publib.boulder.ibm.com/tividd/td/ITWSA/ITWSA_info45/en_US/HTML/guide/c-logs.html" rel="noopener ugc nofollow" target="_blank">这里</a>了解更多。</p><pre class="lr ls lt lu gt nw nu nx ny aw nz bi"><span id="756f" class="oa ko iq nu b gy ob oc l od oe">127.0.0.1 user-identifier frank [10/Oct/2000:13:55:36 -0700] "GET /apache_pb.gif HTTP/1.0" 200 2326</span></pre><ul class=""><li id="f47f" class="mg mh iq jp b jq jr ju jv jy mi kc mj kg mk kk mx mm mn mo bi translated">我们将使用一个<em class="km">计数器度量</em>来存储使用状态代码作为标签的HTTP请求。</li><li id="5a33" class="mg mh iq jp b jq mp ju mq jy mr kc ms kg mt kk mx mm mn mo bi translated">我们将使用计数器度量来存储传输的字节。</li></ul><p id="2e2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是从apache日志中无限收集数据并向Prometheus公开指标的脚本:</p><figure class="lr ls lt lu gt lv"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="7a98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">函数无限跟踪存储在系统中的apache日志。<code class="fe nr ns nt nu b">gather_metrics()</code>使用正则表达式从<em class="km"> status_code </em>和<em class="km"> total_bytes_sent </em>等日志中提取有用的信息，并相应地递增计数器。</p><p id="a237" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您运行该脚本，它将在<a class="ae kl" href="http://localhost:8000." rel="noopener ugc nofollow" target="_blank"> http://localhost:8000 </a>启动服务器，收集的指标将显示在那里。设置<a class="ae kl" href="https://github.com/Nancy-Chauhan/httpd_exporter/blob/master/prometheus/prometheus.yml" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>刮端点。随着时间的推移，Prometheus将为收集的指标构建时间序列。设置<a class="ae kl" href="https://github.com/Nancy-Chauhan/httpd_exporter/blob/master/docker-compose.yml" rel="noopener ugc nofollow" target="_blank"> Grafana </a>在Prometheus中可视化数据。</p><p id="4303" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在这里找到代码并运行导出器:</p><div class="mz na gp gr nb nc"><a href="https://github.com/Nancy-Chauhan/httpd_exporter" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd ir gy z fp nh fr fs ni fu fw ip bi translated">南希-肖汉/httpd_exporter</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">用于监控apache Permalink的Prometheus exporter无法加载最新提交信息。普罗米修斯出口商为…</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">github.com</p></div></div><div class="nl l"><div class="oh l nn no np nl nq ma nc"/></div></div></a></div></div></div>    
</body>
</html>