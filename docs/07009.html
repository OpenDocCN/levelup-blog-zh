<html>
<head>
<title>Better logs for ExpressJS using Winston and Morgan with Typescript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Winston和Morgan和Typescript实现更好的ExpressJS日志</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/better-logs-for-expressjs-using-winston-and-morgan-with-typescript-1c31c1ab9342?source=collection_archive---------0-----------------------#2021-01-19">https://levelup.gitconnected.com/better-logs-for-expressjs-using-winston-and-morgan-with-typescript-1c31c1ab9342?source=collection_archive---------0-----------------------#2021-01-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7771" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何使用Typescript通过Winston和Morgan记录器配置ExpressJS应用程序的分步指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0ac0fb583440824dae78ebd4eb66ffe7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ogNUg1KbGDWry3Fkk-lgg.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@nubelsondev?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">努贝尔森·费尔南德斯</a>在<a class="ae kv" href="https://unsplash.com/s/photos/debugging?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><blockquote class="ld le lf"><p id="589b" class="lg lh li lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">一个好的日志系统是检查应用程序行为的最简单的方法之一，也是我们发现错误的第一个武器</p></blockquote></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="909e" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">如果您正在启动或者已经启动了一个ExpressJS应用程序，您可能想知道，我如何才能创建一个良好组织的日志系统？</p><p id="43c4" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">问题是，很多应用程序没有一个全面的日志系统，甚至更糟糕的是，它们到处都使用简单的<code class="fe mg mh mi mj b">console.log</code>。</p><p id="a4fa" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">在本文中，您将了解如何使用Winston和Morgan配置日志。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="bab8" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">TL；DR；</h1><p id="9a1d" class="pw-post-body-paragraph lg lh iq lj b lk nc jr lm ln nd ju lp md ne ls lt me nf lw lx mf ng ma mb mc ij bi translated">在这里您可以找到完全配置的<a class="ae kv" href="https://github.com/vassalloandrea/medium-morgan-winston-example/tree/complete" rel="noopener ugc nofollow" target="_blank">项目</a>(使用名为<code class="fe mg mh mi mj b">complete</code>的分支)</p><p id="fb1e" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">我没有在本文中添加单元测试，但是下面的代码已经过全面测试。您可以在上面的存储库中找到所有的测试。</p><p id="b52b" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">你需要一个好的模板来开始你的<strong class="lj ir">express js graph QL API</strong>吗？用我的:<a class="ae kv" href="https://github.com/vassalloandrea/express-template" rel="noopener ugc nofollow" target="_blank">https://github.com/vassalloandrea/express-template</a></p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="fe1e" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">我们开始吧</h1><p id="3793" class="pw-post-body-paragraph lg lh iq lj b lk nc jr lm ln nd ju lp md ne ls lt me nf lw lx mf ng ma mb mc ij bi translated">首先，我们需要一个ExpressJS应用。您可以克隆此存储库。</p><pre class="kg kh ki kj gt nh mj ni nj aw nk bi"><span id="7de6" class="nl ml iq mj b gy nm nn l no np">git clone <a class="ae kv" href="https://github.com/vassalloandrea/medium-morgan-winston-example.git" rel="noopener ugc nofollow" target="_blank">https://github.com/vassalloandrea/medium-morgan-winston-example</a>.git</span></pre><h1 id="015d" class="mk ml iq bd mm mn nq mp mq mr nr mt mu jw ns jx mw jz nt ka my kc nu kd na nb bi translated">启动服务器</h1><p id="3673" class="pw-post-body-paragraph lg lh iq lj b lk nc jr lm ln nd ju lp md ne ls lt me nf lw lx mf ng ma mb mc ij bi translated">该项目是使用从头开始的基本配置创建的。使用以下命令启动服务器:</p><pre class="kg kh ki kj gt nh mj ni nj aw nk bi"><span id="d548" class="nl ml iq mj b gy nm nn l no np">cd medium-morgan-winston-example<br/>npm install<br/>npm run dev</span></pre><h1 id="1422" class="mk ml iq bd mm mn nq mp mq mr nr mt mu jw ns jx mw jz nt ka my kc nu kd na nb bi translated">安装温斯顿</h1><p id="1c18" class="pw-post-body-paragraph lg lh iq lj b lk nc jr lm ln nd ju lp md ne ls lt me nf lw lx mf ng ma mb mc ij bi translated"><a class="ae kv" href="https://github.com/winstonjs/winston" rel="noopener ugc nofollow" target="_blank"> Winston </a>是一个有用的库，需要它来配置和定制访问许多有用特性的应用程序日志。</p><blockquote class="ld le lf"><p id="a8f7" class="lg lh li lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">要在没有第三方库的情况下使用普通的<code class="fe mg mh mi mj b">console.log</code>，我们需要编写大量代码，并重新发明轮子，了解这些年来<a class="ae kv" href="https://github.com/winstonjs/winston" rel="noopener ugc nofollow" target="_blank"> Winston </a>抓住的所有边缘案例。</p></blockquote><p id="4f27" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">下面是我们应该在项目中实现的主要特性:</p><ul class=""><li id="d907" class="nv nw iq lj b lk ll ln lo md nx me ny mf nz mc oa ob oc od bi translated">区分日志级别:错误、警告、信息、HTTP、调试</li><li id="f9d5" class="nv nw iq lj b lk oe ln of md og me oh mf oi mc oa ob oc od bi translated">区分颜色，为每个日志级别添加一个颜色</li><li id="7ea4" class="nv nw iq lj b lk oe ln of md og me oh mf oi mc oa ob oc od bi translated">根据应用程序环境显示或隐藏不同的日志级别；例如，当应用程序在生产环境中运行时，我们不会显示所有日志。</li><li id="6fc1" class="nv nw iq lj b lk oe ln of md og me oh mf oi mc oa ob oc od bi translated">向每个日志行添加时间戳</li><li id="7f63" class="nv nw iq lj b lk oe ln of md og me oh mf oi mc oa ob oc od bi translated">将日志保存在文件中</li></ul><pre class="kg kh ki kj gt nh mj ni nj aw nk bi"><span id="0f30" class="nl ml iq mj b gy nm nn l no np">npm install winston</span></pre><h1 id="51d7" class="mk ml iq bd mm mn nq mp mq mr nr mt mu jw ns jx mw jz nt ka my kc nu kd na nb bi translated">配置温斯顿</h1><p id="1e04" class="pw-post-body-paragraph lg lh iq lj b lk nc jr lm ln nd ju lp md ne ls lt me nf lw lx mf ng ma mb mc ij bi translated">在下面的代码行中，有一个简单的记录器配置。将它们复制并粘贴到您的项目中。可以用这个路径:<code class="fe mg mh mi mj b">src/lib/logger.ts</code>或者类似的。</p><p id="c543" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">稍后我会解释每一行。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="cf46" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">现在，您可以在导入应用程序的任何地方使用<strong class="lj ir"> <em class="li"> Logger </em> </strong>函数。</p><p id="d003" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">转到定义了<a class="ae kv" href="https://expressjs.com/it/" rel="noopener ugc nofollow" target="_blank"> ExpressJS </a>服务器的<code class="fe mg mh mi mj b">index.ts</code>文件，用自定义的<strong class="lj ir"> <em class="li"> Logger </em> </strong>方法替换所有的<code class="fe mg mh mi mj b">console.log</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="ac2b" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">查看结果启动服务器并通过<code class="fe mg mh mi mj b">logger</code> <a class="ae kv" href="http://localhost:3000/logger" rel="noopener ugc nofollow" target="_blank">端点</a>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/ab0fc4f6d3faaa2739e6f460d8004b25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cKI3ykXED7GwB9roVx7FCQ.png"/></div></div></figure><p id="b128" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">正如您所看到的，日志记录器根据日志的严重性使用不同的颜色显示日志，另一个重要的特性是所有这些日志都打印在<code class="fe mg mh mi mj b">logs</code>目录下的<code class="fe mg mh mi mj b">all.log</code>和<code class="fe mg mh mi mj b">error.log</code>文件中。</p><h1 id="b7a5" class="mk ml iq bd mm mn nq mp mq mr nr mt mu jw ns jx mw jz nt ka my kc nu kd na nb bi translated"><strong class="ak">了解有关配置的更多信息</strong></h1><p id="6828" class="pw-post-body-paragraph lg lh iq lj b lk nc jr lm ln nd ju lp md ne ls lt me nf lw lx mf ng ma mb mc ij bi translated">配置文件很简单。检查下面文件中的注释。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="9079" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">评估形势</h1><p id="bb03" class="pw-post-body-paragraph lg lh iq lj b lk nc jr lm ln nd ju lp md ne ls lt me nf lw lx mf ng ma mb mc ij bi translated">现在，我们能够根据特性的复杂性添加日志来检测应用程序代码。</p><blockquote class="ld le lf"><p id="e2ba" class="lg lh li lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">使用Winston，您还可以使用ENV变量在运行时更改日志严重性。</p></blockquote><p id="d83e" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">因为ExpressJS是用来处理请求的，所以我们应该添加一个请求记录器，自动记录每个请求信息。应该使用一个可以很容易地与Winston配置集成的库来实现这个目标。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="2ff9" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">安装摩根</h1><p id="d6bb" class="pw-post-body-paragraph lg lh iq lj b lk nc jr lm ln nd ju lp md ne ls lt me nf lw lx mf ng ma mb mc ij bi translated">Morgan是一个NodeJS中间件，用于定制请求日志。</p><p id="5641" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">与Winston的集成非常简单。您还记得我们添加到Winston配置中的<code class="fe mg mh mi mj b">http</code>严重级别吗？它被设计成只能在摩根中间件上使用。</p><pre class="kg kh ki kj gt nh mj ni nj aw nk bi"><span id="dfd1" class="nl ml iq mj b gy nm nn l no np">npm install morgan @types/morgan</span></pre><h1 id="fcaf" class="mk ml iq bd mm mn nq mp mq mr nr mt mu jw ns jx mw jz nt ka my kc nu kd na nb bi translated">配置摩根</h1><p id="4b49" class="pw-post-body-paragraph lg lh iq lj b lk nc jr lm ln nd ju lp md ne ls lt me nf lw lx mf ng ma mb mc ij bi translated">在下面的代码行中，有一个简单的Morgan中间件配置。将它们复制并粘贴到您的项目中。可以用这个路径:<code class="fe mg mh mi mj b">src/config/morganMiddleware.ts</code>或者类似的。</p><p id="7077" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">阅读评论以理解或扩展下面的配置。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="0d5c" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">将这个中间件添加到ExpressJS服务器的<code class="fe mg mh mi mj b">index.ts</code>文件中:</p><pre class="kg kh ki kj gt nh mj ni nj aw nk bi"><span id="1f9f" class="nl ml iq mj b gy nm nn l no np">import morganMiddleware from './config/morganMiddleware'</span><span id="5c0d" class="nl ml iq mj b gy om nn l no np">...<br/>...</span><span id="47e6" class="nl ml iq mj b gy om nn l no np">const PORT = 3000;</span><span id="e318" class="nl ml iq mj b gy om nn l no np">app.use(morganMiddleware)</span><span id="69fa" class="nl ml iq mj b gy om nn l no np">app.get("/logger", (_, res) =&gt; {</span><span id="6326" class="nl ml iq mj b gy om nn l no np">...</span></pre><p id="aa5d" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">启动服务器，请求访问<code class="fe mg mh mi mj b">logger</code> <a class="ae kv" href="http://localhost:3000/logger" rel="noopener ugc nofollow" target="_blank">端点</a>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/52063efbeacfff3764b9b8300796f6d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m5wjhES49Qso57KFKsxAcA.png"/></div></div></figure><p id="d91d" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">以下是请求日志的其他示例:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/ad14e137762d0f1189dd976cf4f5a75c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dilFEyBmEaZzHkDzgMNaEw.png"/></div></div></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="834a" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">享受配置</h1><p id="c75b" class="pw-post-body-paragraph lg lh iq lj b lk nc jr lm ln nd ju lp md ne ls lt me nf lw lx mf ng ma mb mc ij bi translated">仅此而已！我希望这种配置能够帮助您测试您的代码，更容易地找到隐藏的错误。🐛</p><p id="0ceb" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">你喜欢这篇文章吗？用掌声和评论让我知道🙏</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="0423" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">您的ExpressJS应用程序需要帮助吗？<a class="ae kv" href="mailto:andrea.vassallo.94@gmail.com" rel="noopener ugc nofollow" target="_blank"> <strong class="lj ir">雇佣我</strong> </a></p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="d0ea" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">GraphQL Morgan配置的深化</h1><p id="2bd2" class="pw-post-body-paragraph lg lh iq lj b lk nc jr lm ln nd ju lp md ne ls lt me nf lw lx mf ng ma mb mc ij bi translated">本节只是对使用GraphQL的项目的深化。</p><p id="aaf0" class="pw-post-body-paragraph lg lh iq lj b lk ll jr lm ln lo ju lp md lr ls lt me lv lw lx mf lz ma mb mc ij bi translated">默认情况下，GraphQL只有一条路由，因此我们需要更改Morgan配置以使其有意义。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure></div></div>    
</body>
</html>