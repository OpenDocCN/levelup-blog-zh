<html>
<head>
<title>3 CQRS Architectures that Every Software Architect Should Know</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">每个软件架构师都应该知道的3个CQRS架构</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/3-cqrs-architectures-that-every-software-architect-should-know-a7f69aae8b6c?source=collection_archive---------0-----------------------#2020-10-30">https://levelup.gitconnected.com/3-cqrs-architectures-that-every-software-architect-should-know-a7f69aae8b6c?source=collection_archive---------0-----------------------#2020-10-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="9343" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">软件架构和重构</h2><div class=""/><div class=""><h2 id="d438" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">关注点分离是一种有效整理一个人思想的技术。你应该把注意力集中在一个方面。埃德格·w·迪杰斯特拉</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/0ce50d3b8605d84aab24e3ce805ddba7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j6qnvbqCX7FcYrivYOkkQw.png"/></div></div></figure><h1 id="667b" class="ld le it bd lf lg lh li lj lk ll lm ln ki lo kj lp kl lq km lr ko ls kp lt lu bi translated">命令-查询分离(CQS)</h1><p id="1050" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">1988年<a class="ae mr" href="https://en.wikipedia.org/wiki/Bertrand_Meyer" rel="noopener ugc nofollow" target="_blank"> Bertrand Meyer </a>在《T2】面向对象软件构造一书中为面向对象语言设计了CQS原则。简而言之，原则是软件要么修改系统(命令)，要么返回值(查询)，你应该在你的软件中保持命令-查询分离。</p><p id="0eb1" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated"><a class="ae mr" href="https://martinfowler.com/" rel="noopener ugc nofollow" target="_blank">马丁·福勒</a>在他2005年的<a class="ae mr" href="https://martinfowler.com/bliki/CommandQuerySeparation.html" rel="noopener ugc nofollow" target="_blank">博客文章</a>中说，实现这种分离并不总是可能的，他是对的。一个很好的例子是返回刚刚插入的记录的id。首先，将记录保存到持久性中(命令)，其次，获取新分配的id(查询)。</p></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><h1 id="a083" class="ld le it bd lf lg ne li lj lk nf lm ln ki ng kj lp kl nh km lr ko ni kp lt lu bi translated">CQRS建筑</h1><p id="2a61" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">命令查询责任分离(CQRS)架构在架构级别扩展了命令查询划分的概念。但是这些架构并不是整个软件系统的架构。它只是软件一部分的设计，这部分被称为应用层。</p><p id="ff0c" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">如果您正在寻找整个软件系统的架构，请点击下面我的关于以领域为中心的架构的文章的链接。</p><div class="nj nk gp gr nl nm"><a rel="noopener  ugc nofollow" target="_blank" href="/3-domain-centric-architectures-every-software-developer-should-know-a15727ada79f"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd jd gy z fp nr fr fs ns fu fw jc bi translated">每个软件开发人员都应该知道的3个以领域为中心的架构</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">建筑师首先关心的是确保房子是可用的，而不是确保房子是…</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa lb nm"/></div></div></a></div><p id="0fec" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">CQRS建议将应用层分成两部分，命令端<strong class="lx jd">，</strong>和查询端<strong class="lx jd"/>。</p><p id="dfda" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated"><strong class="lx jd">查询端</strong>应该负责并优化读取数据。查询是从持久化中读取数据，然后将它们映射成表示层所需的形式。这种表格通常被称为<a class="ae mr" href="https://en.wikipedia.org/wiki/Data_transfer_object" rel="noopener ugc nofollow" target="_blank">数据传输对象(dto)</a>。</p><p id="692a" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated"><strong class="lx jd">命令端</strong>负责并优化数据写入。命令是执行用例，改变实体的状态，并将它们保存到持久性中。</p><p id="4c56" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">通过分离读写操作，我们提高了性能，并在系统中支持<a class="ae mr" href="https://en.wikipedia.org/wiki/Separation_of_concerns" rel="noopener ugc nofollow" target="_blank">关注点分离原则</a>。</p><p id="5845" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">您可以实现三种主要类型的CQRS体系结构。</p></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><h1 id="2312" class="ld le it bd lf lg ne li lj lk nf lm ln ki ng kj lp kl nh km lr ko ni kp lt lu bi translated">单一数据库CQRS</h1><p id="5c75" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">单一数据库CQRS设计没有一个正式的名字，所以<a class="ae mr" href="https://pluralsight.com/courses/clean-architecture-patterns-practices-principles/" rel="noopener ugc nofollow" target="_blank">马修·伦茨在他的Pluralsight课程清洁架构</a>中称之为单一数据库CQRS和我也会。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/da2bc941fe7d8842c55b1cd8328b18ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*RwCXebqefUG0-gX2T8dedA.png"/></div><figcaption class="oc od gj gh gi oe of bd b be z dk translated">单一数据库CQRS</figcaption></figure><p id="345e" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">顾名思义，双方都在和一个数据库对话。命令在修改实体状态的域中执行用例。然后通过实体框架核心或Hibernate等ORM将实体保存到数据库中。</p><p id="cb18" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">查询是通过数据访问层直接执行的，数据访问层要么是使用Linq to SQL之类的投影的ORM，要么是存储过程。</p></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><h1 id="6f82" class="ld le it bd lf lg ne li lj lk nf lm ln ki ng kj lp kl nh km lr ko ni kp lt lu bi translated">双数据库CQRS</h1><p id="43bc" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">在双数据库方法中，我们有两个专用数据库，一个用于写操作，一个用于读操作。命令端有<strong class="lx jd">写数据库</strong>为写操作优化。查询端的<strong class="lx jd">读取数据库</strong>针对读取操作进行了优化。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/de7e454816de0f2fbb51a4544fa0cad8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*XLO77rsB6RDnxk6t9P1pTQ.png"/></div><figcaption class="oc od gj gh gi oe of bd b be z dk translated">双数据库CQRS</figcaption></figure><p id="ea26" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">随着每个状态被命令改变，修改后的数据必须从写数据库被推入读数据库，或者作为跨两个数据库的单个协调事务，或者使用<a class="ae mr" href="https://theacetechnologist.com/post/eventually-consistent-architecture-pattern/" rel="noopener ugc nofollow" target="_blank">最终一致性模式</a>。</p><p id="3106" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">这种体系结构在软件的查询方面带来了数量级的性能改进，这是一件好事，因为软件用户通常花在读取数据上的时间比写数据的时间多。</p></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><h1 id="c010" class="ld le it bd lf lg ne li lj lk nf lm ln ki ng kj lp kl nh km lr ko ni kp lt lu bi translated">CQRS事件采购</h1><p id="d0c3" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">这是最复杂的CQRS建筑。事件源是一种完全不同的存储数据的思想，与前面介绍的两种体系结构不同。</p><p id="b0de" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">在事件源方法中，我们不仅存储实体的当前状态，还将实体发生的每个状态存储为快照。实体不保存为规范化数据，而是保存为带有事件时间戳的直接修改。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/261a70b1d3a788da2c34dd8c00d75b9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*zFgVF0C1F2EU2UDdF2ofmA.png"/></div><figcaption class="oc od gj gh gi oe of bd b be z dk translated">CQRS事件采购</figcaption></figure><p id="f6ba" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">当我们想要操作域中实体的当前状态时，我们必须首先通过在实体上应用每个事件来构造这样一个实体。</p><p id="a7b3" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">一旦我们有了当前的实体，命令可以修改它。修改将生成一个新事件，我们将把它存储在事件存储中。因此，我们将实体的当前状态推送到一个读取数据库中，这样读取可以保持极快的速度。</p><p id="e698" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">事件采购带来了以下好处:</p><ul class=""><li id="0242" class="og oh it lx b ly ms mb mt me oi mi oj mm ok mq ol om on oo bi translated">事件存储是一个完整的审计跟踪，在受到严格监管的行业中可以派上用场。</li><li id="88e6" class="og oh it lx b ly op mb oq me or mi os mm ot mq ol om on oo bi translated">我们可以在任何时间点重建任何实体的任何状态。这对调试非常有用。</li><li id="a559" class="og oh it lx b ly op mb oq me or mi os mm ot mq ol om on oo bi translated">您可以重放事件，随时查看系统中到底发生了什么。这个特性对于负载测试和bug修复非常有用。</li><li id="ebe3" class="og oh it lx b ly op mb oq me or mi os mm ot mq ol om on oo bi translated">您可以轻松地重建生产数据库。</li><li id="d8e6" class="og oh it lx b ly op mb oq me or mi os mm ot mq ol om on oo bi translated">您可以拥有多个读取优化数据存储。</li></ul><p id="df39" class="pw-post-body-paragraph lv lw it lx b ly ms kd ma mb mt kg md me mu mg mh mi mv mk ml mm mw mo mp mq im bi translated">不幸的是，它很难实现，而且如果你不能从它的大部分特性中获益，它可能会变得有些过火。</p></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><h1 id="690b" class="ld le it bd lf lg ne li lj lk nf lm ln ki ng kj lp kl nh km lr ko ni kp lt lu bi translated">摘要</h1><p id="7993" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">CQRS的真正强大之处在于能够针对读写操作进行不同的优化。另一方面，软件变得越来越复杂，在命令端和查询端会有不一致的代码，随着一个以上的数据库的出现，对它的管理变得更加复杂，ORM映射也更多。</p></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><h1 id="3146" class="ld le it bd lf lg ne li lj lk nf lm ln ki ng kj lp kl nh km lr ko ni kp lt lu bi translated">进一步阅读</h1><div class="nj nk gp gr nl nm"><a rel="noopener  ugc nofollow" target="_blank" href="/from-monolith-to-microservices-in-5-minutes-83069677d021"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd jd gy z fp nr fr fs ns fu fw jc bi translated">5分钟内从整体服务到微服务</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">微服务架构风格是将单个应用程序开发成一套小型服务的方法——</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="nv l"><div class="ou l nx ny nz nv oa lb nm"/></div></div></a></div><div class="nj nk gp gr nl nm"><a href="https://danielrusnok.medium.com/layers-in-software-architecture-that-every-sofware-architect-should-know-76b2452b9d9a" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd jd gy z fp nr fr fs ns fu fw jc bi translated">每个软件架构师都应该知道的软件体系结构的层次</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">“所有的架构都有相同的目标——关注点的分离。都是通过分软件来实现的…</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">danielrusnok.medium.com</p></div></div><div class="nv l"><div class="ov l nx ny nz nv oa lb nm"/></div></div></a></div><div class="nj nk gp gr nl nm"><a href="https://danielrusnok.medium.com/let-me-hear-you-screaming-architecture-3adcc02f2ca3" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd jd gy z fp nr fr fs ns fu fw jc bi translated">文件夹和尖叫建筑的功能组织</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">架构应该表达系统的意图——鲍勃叔叔</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">danielrusnok.medium.com</p></div></div><div class="nv l"><div class="ow l nx ny nz nv oa lb nm"/></div></div></a></div><h1 id="a405" class="ld le it bd lf lg lh li lj lk ll lm ln ki lo kj lp kl lq km lr ko ls kp lt lu bi translated">来源</h1><ul class=""><li id="ad42" class="og oh it lx b ly lz mb mc me ox mi oy mm oz mq ol om on oo bi translated">Matthew Renze 的《多视角课程——清洁建筑:模式、实践和原则》</li><li id="9be6" class="og oh it lx b ly op mb oq me or mi os mm ot mq ol om on oo bi translated"><a class="ae mr" href="https://en.wikipedia.org/wiki/Command%E2%80%93query_separation" rel="noopener ugc nofollow" target="_blank">维基百科上的命令-查询分离</a></li><li id="265c" class="og oh it lx b ly op mb oq me or mi os mm ot mq ol om on oo bi translated"><a class="ae mr" href="https://martinfowler.com/bliki/CommandQuerySeparation.html" rel="noopener ugc nofollow" target="_blank">马丁·福勒关于CQS的博客文章</a></li><li id="b8e0" class="og oh it lx b ly op mb oq me or mi os mm ot mq ol om on oo bi translated"><a class="ae mr" href="https://en.wikipedia.org/wiki/Separation_of_concerns" rel="noopener ugc nofollow" target="_blank">维基百科关注点分离</a></li><li id="f3f9" class="og oh it lx b ly op mb oq me or mi os mm ot mq ol om on oo bi translated"><a class="ae mr" href="https://www.goodreads.com/quotes/tag/separation-of-concerns" rel="noopener ugc nofollow" target="_blank">埃德格·w·迪杰斯特拉关于足球的名言</a></li><li id="7075" class="og oh it lx b ly op mb oq me or mi os mm ot mq ol om on oo bi translated"><a class="ae mr" href="https://theacetechnologist.com/post/eventually-consistent-architecture-pattern/" rel="noopener ugc nofollow" target="_blank">关于最终一致性模式的文章</a></li></ul></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><div class="ks kt ku kv gt nm"><a href="https://www.danielrusnok.com/daniel-rusnoks-newsletter" rel="noopener  ugc nofollow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd jd gy z fp nr fr fs ns fu fw jc bi translated">丹尼尔·鲁斯诺克的时事通讯</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">每个月我都会给你发一封电子邮件，列出我的最新文章。这当然是友好的联系…</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">www.danielrusnok.com</p></div></div><div class="nv l"><div class="pa l nx ny nz nv oa lb nm"/></div></div></a></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><a href="https://www.buymeacoffee.com/danielrusnok"><div class="gh gi pb"><img src="../Images/88f0e07ab6797fc4fcd13ed7410af039.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/format:webp/1*yzOQeIJSJCaRDN_oP5OidA.png"/></div></a></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><a href="https://itixo.com"><div class="gh gi pc"><img src="../Images/f3d94d9b86b4ee7080bab6d72172b50a.png" data-original-src="https://miro.medium.com/v2/resize:fit:180/format:webp/1*mLQH7u1-b2HPVcLURnQ9NQ.png"/></div></a></figure></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><h1 id="bf42" class="ld le it bd lf lg ne li lj lk nf lm ln ki ng kj lp kl nh km lr ko ni kp lt lu bi translated">分级编码</h1><p id="86dd" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">感谢您成为我们社区的一员！<a class="ae mr" href="https://www.youtube.com/channel/UC3v9kBR_ab4UHXXdknz8Fbg?sub_confirmation=1" rel="noopener ugc nofollow" target="_blank"> <strong class="lx jd">订阅我们的YouTube频道</strong> </a>或者加入<a class="ae mr" href="https://skilled.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="lx jd"> Skilled.dev编码面试课程</strong> </a>。</p><div class="nj nk gp gr nl nm"><a href="https://skilled.dev" rel="noopener  ugc nofollow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd jd gy z fp nr fr fs ns fu fw jc bi translated">编写面试问题+获得开发工作</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">掌握编码面试的过程</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">技术开发</p></div></div><div class="nv l"><div class="pd l nx ny nz nv oa lb nm"/></div></div></a></div></div></div>    
</body>
</html>