<html>
<head>
<title>GCP — Schedule Queries in Cloud SQL Using Cloud Scheduler (CLI Approach)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP —使用云调度程序在云SQL中调度查询(CLI方法)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/gcp-time-savers-how-to-connect-to-cloud-sql-from-cloud-scheduler-44537f66f49b?source=collection_archive---------9-----------------------#2020-02-06">https://levelup.gitconnected.com/gcp-time-savers-how-to-connect-to-cloud-sql-from-cloud-scheduler-44537f66f49b?source=collection_archive---------9-----------------------#2020-02-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="bc32" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Cloud Scheduler是GCP的cron作业服务，Cloud SQL是GCP的关系数据库。</p><p id="92db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">曾经想知道是否有可能使用云调度器来调度针对云SQL的查询执行？如果是这样，我们如何避免数据库凭证的纯文本？我们可以在哪里托管代码？实现这一点所需的最低权限是什么？哪种GCP服务组合可用于解决这一问题？整个配置只能通过CLI实现吗？</p><p id="a8b8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本文介绍了一种使用GCP核心服务的架构方法，以及一种彻头彻尾的命令行方法(CLI)</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/d6560d8d0f0eac8bf62b324e07350141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/1*BG2kRO57OQrQVMN7qUKHhg.png"/></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">使用HTTP端点扩展云调度器核心功能</figcaption></figure><h1 id="439e" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">问题陈述:</h1><p id="6993" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">云调度器是GCP的企业级cron作业服务，可用于调度任何类型的批处理作业、操作相关的作业等。目前，可以针对以下目标调用这些作业:</p><ul class=""><li id="d39f" class="md me it js b jt ju jx jy kb mf kf mg kj mh kn mi mj mk ml bi translated">HTTP/HTTPS端点</li><li id="acae" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">云发布/订阅</li><li id="4baa" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">谷歌应用引擎</li></ul><p id="9422" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本文旨在使用Google的最佳实践来扩展云调度程序，并通过云函数使用HTTP/HTTPS端点连接到云SQL(以便执行任何基于SQL的语句/作业)。</p><h1 id="fa71" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">先决条件:</h1><p id="b993" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">使用您选择的数据库创建云SQL实例。用示例数据加载数据库。使用以下参考资料开始</p><h2 id="8ff0" class="mr lb it bd lc ms mt dn lg mu mv dp lk kb mw mx lo kf my mz ls kj na nb lw nc bi translated">参考资料:</h2><ul class=""><li id="9759" class="md me it js b jt ly jx lz kb nd kf ne kj nf kn mi mj mk ml bi translated">快速启动→<a class="ae ng" href="https://cloud.google.com/sql/docs/mysql/quickstart" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/sql/docs/mysql/quickstart</a></li><li id="86c2" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">样本数据库→【https://www.mysqltutorial.org/mysql-sample-database.aspx T2】</li></ul></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="da59" class="la lb it bd lc ld no lf lg lh np lj lk ll nq ln lo lp nr lr ls lt ns lv lw lx bi translated">要考虑的设计要素:</h1><ul class=""><li id="0e08" class="md me it js b jt ly jx lz kb nd kf ne kj nf kn mi mj mk ml bi translated">云调度器中的哪个目标选项可以用来连接云SQL？</li><li id="f566" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">连接云SQL的首选库是什么？如何相应地加载库依赖项？</li><li id="26d4" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">如何确保数据库名称、用户名和密码等关键数据库信息不以明文格式传递？</li><li id="4c2e" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">为确保“最小特权原则”，需要考虑的最小角色集是什么？</li></ul><h1 id="8e8e" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">方法:</h1><ul class=""><li id="96d7" class="md me it js b jt ly jx lz kb nd kf ne kj nf kn mi mj mk ml bi translated">HTTP/HTTPS端点是连接到云SQL的潜在目标选项。这可以通过使用其支持的编程语言之一的云函数来实现。在本文中，我们将使用Python 3.7作为编程语言的选择。</li><li id="d22f" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">SQLAlchemy是一个python SQL工具包，提供了从Python 3.7通过Cloud函数连接到Cloud SQL的库。作为云函数的一部分，可以通过在requirements.txt文件中指定依赖库来加载库依赖项。</li><li id="9f48" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">云KMS的秘密管理可用于防止以纯文本格式或通过环境变量传递关键数据库信息。</li><li id="422e" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">具有“秘密访问器”和“云SQL客户端”角色的服务帐户将确保此特定云功能遵循“最小特权原则”。</li></ul></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="9fd5" class="la lb it bd lc ld no lf lg lh np lj lk ll nq ln lo lp nr lr ls lt ns lv lw lx bi translated">解决既定方法的构建模块:</h1><h2 id="88a7" class="mr lb it bd lc ms mt dn lg mu mv dp lk kb mw mx lo kf my mz ls kj na nb lw nc bi translated"><strong class="ak">创建服务账户</strong></h2><pre class="kp kq kr ks gt nt nu nv nw aw nx bi"><span id="77d2" class="mr lb it nu b gy ny nz l oa ob"><strong class="nu iu"><em class="oc"># Syntax</em></strong><em class="oc"><br/>gcloud iam service-accounts create &lt;service-account-name&gt; --display-name "&lt;service-account-display-name&gt;"</em></span><span id="1e3f" class="mr lb it nu b gy od nz l oa ob"><strong class="nu iu"><em class="oc">#Example</em></strong><em class="oc"><br/>gcloud iam service-accounts create cloud-scheduler-function --display-name "Cloud Scheduler Function"</em></span></pre><h2 id="3e5d" class="mr lb it bd lc ms mt dn lg mu mv dp lk kb mw mx lo kf my mz ls kj na nb lw nc bi translated"><strong class="ak">为服务账户分配适当的角色</strong></h2><p id="ef19" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">在这种情况下，角色—云SQL客户端将允许云函数访问云SQL，角色—机密访问器将允许云函数通过机密管理器从云KMS获取敏感的数据库凭证</p><pre class="kp kq kr ks gt nt nu nv nw aw nx bi"><span id="1cfc" class="mr lb it nu b gy ny nz l oa ob"><strong class="nu iu"><em class="oc">#Syntax</em></strong><em class="oc"><br/>gcloud projects add-iam-policy-binding &lt;project-id&gt; \<br/>  --member='serviceAccount:&lt;service-account-name&gt;@&lt;project-id&gt;.iam.gserviceaccount.com' \<br/>  --role='roles/&lt;role-name&gt;'</em></span><span id="ee36" class="mr lb it nu b gy od nz l oa ob"><strong class="nu iu"><em class="oc">#Assign SecretAccessor role to service account</em></strong><em class="oc"><br/>gcloud projects add-iam-policy-binding gcp-time-savers \<br/>  --member='serviceAccount:cloud-scheduler-function@gcp-time-savers.iam.gserviceaccount.com' \<br/>  --role='roles/secretmanager.secretAccessor'</em></span><span id="9343" class="mr lb it nu b gy od nz l oa ob"><strong class="nu iu"><em class="oc">#Assign CloudSQL Client role to service account</em></strong><em class="oc"><br/>gcloud projects add-iam-policy-binding gcp-time-savers \<br/>  --member='serviceAccount:cloud-scheduler-function@gcp-time-savers.iam.gserviceaccount.com' \<br/>  --role='roles/cloudsql.client'</em></span></pre><h2 id="87f5" class="mr lb it bd lc ms mt dn lg mu mv dp lk kb mw mx lo kf my mz ls kj na nb lw nc bi translated">使用机密管理器创建机密:</h2><p id="c2d8" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated"><strong class="js iu">启用秘密管理器API </strong></p><pre class="kp kq kr ks gt nt nu nv nw aw nx bi"><span id="4c6b" class="mr lb it nu b gy ny nz l oa ob">gcloud services enable secretmanager.googleapis.com</span></pre><p id="5999" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">为数据库凭证创建秘密</strong></p><p id="0b75" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是一个为数据库用户名创建密码的例子。对于数据库口令和数据库模式名(如果需要的话),应该重复同样的操作</p><pre class="kp kq kr ks gt nt nu nv nw aw nx bi"><span id="8f58" class="mr lb it nu b gy ny nz l oa ob"><strong class="nu iu"><em class="oc">#Syntax</em></strong><em class="oc"><br/>echo -n "&lt;secret-value&gt;" | \<br/>    gcloud beta secrets create &lt;secret-name&gt; \<br/>      --data-file=- \<br/>      --replication-policy automatic</em></span><span id="df38" class="mr lb it nu b gy od nz l oa ob"><strong class="nu iu"><em class="oc">#Example for database username</em></strong><em class="oc"><br/>echo -n "gcptimesavers" | \<br/>    gcloud beta secrets create db-username \<br/>      --data-file=- \<br/>      --replication-policy automatic</em></span></pre><h2 id="fbc9" class="mr lb it bd lc ms mt dn lg mu mv dp lk kb mw mx lo kf my mz ls kj na nb lw nc bi translated">创建、配置和部署云功能以调用云SQL</h2><p id="01a3" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated"><strong class="js iu">用Python 3.7开发云函数的源代码</strong></p><blockquote class="oe of og"><p id="b057" class="jq jr oc js b jt ju jv jw jx jy jz ka oh kc kd ke oi kg kh ki oj kk kl km kn im bi translated">这篇文章的源代码可以在https://github.com/sandeepmanchi/connect-to-cloud-sql<a class="ae ng" href="https://github.com/sandeepmanchi/connect-to-cloud-sql" rel="noopener ugc nofollow" target="_blank">找到</a></p></blockquote><p id="5719" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了编写适合云功能的代码，需要两个主要文件:</p><ul class=""><li id="e6ce" class="md me it js b jt ju jx jy kb mf kf mg kj mh kn mi mj mk ml bi translated">main.py这是一个保存入口点方法的python文件。后续的方法可以写在同一个文件或附加的python文件中。</li><li id="dbdb" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">requirements . txt——这是一个捕获python依赖项的文本文件(将作为部署云功能的一部分进行安装)</li></ul><p id="7fbc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">演示使用SQLAlchemy连接到云SQL的连接字符串的构造的代码段。</p><pre class="kp kq kr ks gt nt nu nv nw aw nx bi"><span id="aaa1" class="mr lb it nu b gy ny nz l oa ob"><em class="oc">db = sqlalchemy.create_engine(<br/>    # Equivalent URL:<br/>    # mysql+pymysql://&lt;db_user&gt;:&lt;db_pass&gt;@/&lt;db_name&gt;?unix_socket=/cloudsql/project-id:region-name:&lt;cloud_sql_instance_name&gt;<br/>    sqlalchemy.engine.url.URL(<br/>        drivername="mysql+pymysql",<br/>        username=db_user,<br/>        password=db_pass,<br/>        database=db_name,<br/>        query={"unix_socket": "/cloudsql/gcp-time-savers:us-central1:{}".format(cloud_sql_connection_name)},<br/>    ),<br/>    pool_size=5,<br/>    max_overflow=2,<br/>    pool_timeout=30,<br/>    pool_recycle=1800,<br/>)</em></span></pre><p id="da11" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">保存依赖项的requirements.txt文件的内容。</p><pre class="kp kq kr ks gt nt nu nv nw aw nx bi"><span id="bdef" class="mr lb it nu b gy ny nz l oa ob"><em class="oc"># Function dependencies, for example:<br/># package&gt;=version</em></span><span id="76ee" class="mr lb it nu b gy od nz l oa ob"><em class="oc">sqlalchemy<br/>pymysql<br/>google-cloud-secret-manager==0.1.1</em></span></pre><p id="5ff4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">代码开发完成后，压缩上述两个文件，并为压缩文件提供一个名称。例如:连接到云sql.zip</p><p id="520c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">发布代码到云存储</strong></p><ul class=""><li id="de90" class="md me it js b jt ju jx jy kb mf kf mg kj mh kn mi mj mk ml bi translated">创建一个云存储桶</li></ul><pre class="kp kq kr ks gt nt nu nv nw aw nx bi"><span id="10e9" class="mr lb it nu b gy ny nz l oa ob"><em class="oc">gsutil mb -c regional -l us-central1 gs://gcp-time-savers-cloud-function-code</em></span></pre><ul class=""><li id="6c27" class="md me it js b jt ju jx jy kb mf kf mg kj mh kn mi mj mk ml bi translated">将zip文件移动到创建的云存储桶内的文件夹中</li></ul><pre class="kp kq kr ks gt nt nu nv nw aw nx bi"><span id="5062" class="mr lb it nu b gy ny nz l oa ob"><em class="oc">gsutil cp connect-to-cloud-sql.zip gs://gcp-time-savers-cloud-function-code/connect-to-cloud-sql/</em></span></pre><p id="ae27" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">配置部署云功能</strong></p><p id="aab0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过命令行部署云功能，并配置:</p><ul class=""><li id="e741" class="md me it js b jt ju jx jy kb mf kf mg kj mh kn mi mj mk ml bi translated">HTTP触发器</li><li id="d6c0" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">使用存储桶URI从云存储桶中获取源代码</li><li id="4814" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">指定入口点以标识执行点</li><li id="6078" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">分配具有云功能所需的最低权限的服务帐户</li></ul><pre class="kp kq kr ks gt nt nu nv nw aw nx bi"><span id="01a6" class="mr lb it nu b gy ny nz l oa ob"><em class="oc">gcloud functions deploy connect-to-cloud-sql1 --allow-unauthenticated --entry-point=connect_to_cloud_sql --memory=256MB \<br/>  --runtime=python37 --service-account=cloud-scheduler-function@gcp-time-savers.iam.gserviceaccount.com \<br/>  --source=gs://gcp-time-savers-cloud-function-code/connect-to-cloud-sql/connect-to-cloud-sql.zip \<br/>  --timeout=60s --trigger-http</em></span></pre><h2 id="c139" class="mr lb it bd lc ms mt dn lg mu mv dp lk kb mw mx lo kf my mz ls kj na nb lw nc bi translated">配置云调度程序以启动连接到云SQL的云功能</h2><p id="b827" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">在这种情况下，云调度程序的关键输入是:</p><ul class=""><li id="eb3a" class="md me it js b jt ju jx jy kb mf kf mg kj mh kn mi mj mk ml bi translated">Cron作业名称—连接到云sql作业</li><li id="3eab" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">目标类型— http</li><li id="1ba3" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">时间表—* * * * * *(这是指每一分钟。然而，这可以根据用户来设置)</li><li id="d88e" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">函数URL —连接到云SQL的云函数的URL</li><li id="0f43" class="md me it js b jt mm jx mn kb mo kf mp kj mq kn mi mj mk ml bi translated">方法—获取</li></ul><pre class="kp kq kr ks gt nt nu nv nw aw nx bi"><span id="f8c5" class="mr lb it nu b gy ny nz l oa ob"><em class="oc">gcloud scheduler jobs create http connect-to-cloud-sql-job --schedule "* * * * *" --uri "http://us-central1-gcp-time-savers.cloudfunctions.net/connect-to-cloud-sql" --http-method GET</em></span></pre></div></div>    
</body>
</html>