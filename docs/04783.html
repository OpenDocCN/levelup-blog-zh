<html>
<head>
<title>Six Tips For Running Swarm Cluster in Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在生产中运行Swarm集群的六个技巧</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/six-tips-for-running-swarm-cluster-in-production-e0f2ef367694?source=collection_archive---------3-----------------------#2020-07-15">https://levelup.gitconnected.com/six-tips-for-running-swarm-cluster-in-production-e0f2ef367694?source=collection_archive---------3-----------------------#2020-07-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="eb46" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">码头集群</h2><div class=""/><div class=""><h2 id="8669" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">在生产环境中以高可用性模式运行群集群的技巧</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/7f9c1ecee3d724bce77e67538a08783a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HBkGZjdUfYrjMMOF"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">亚历克斯·伊比在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="2069" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">用Docker Swarm开始运行Docker容器是一项简单的任务，特别是如果你有使用docker-compose文件的知识和经验。创建Docker Swarm集群可以通过执行一个命令行来轻松完成。此外，使用一个命令行就可以用更多的服务器来扩展集群。</p><p id="ea5f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">另一方面，在生产环境的集群上运行Docker服务可能是一项具有挑战性的任务，因为生产环境应该是稳定的，并保持一定的质量水平。例如，生产服务器上的服务应该以高可用性模式托管。</p><p id="1a45" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在这篇文章中，我将强调在Docker Swarm集群中运行生产服务需要解决的一些问题。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h2 id="08e3" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated"><strong class="ak">虫群集群设置</strong></h2><p id="bb58" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">从基础架构和集群设置的角度出发，生产环境应该以高可用性模式托管。这意味着为这些环境建立的群集群必须确保集群和服务的可用性，即使在可能发生故障的情况下也是如此。</p><p id="987c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">举例来说，可以创建一个只有一个节点的群集群。但是，这种设置的可用性不高。如果由于任何原因出现节点故障，整个集群和其中运行的服务都将停止运行。</p><p id="e863" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">很明显，为了能够减轻这种风险，群集群的生产应该由多个节点(管理人员和工人)组成。然而，工作者和主节点的确切数量以及集群的架构并不固定，它们取决于项目的需求。下面是一些在构建Swarm集群时可以考虑的技巧。</p><p id="9446" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">→主节点的数量必须是奇数。否则，领导者选举将不会像预期的那样进行，因此群集将会以一种意想不到的方式运行。根据托管服务的数量和项目预算，您可以选择主节点的数量。</p><p id="4649" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">→主节点应放置在不同的数据中心(理想情况下是三个不同的数据中心，配备三名管理人员)。这将有助于即使在一个管理器节点关闭、一个数据中心关闭(即停电)或网络分区，其中一个数据中心无法与其他数据中心通信。</p><p id="6f30" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">→主节点应在排出模式下运行(不托管任何Docker容器)。</p><p id="a8d6" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">→工人数量没有限制(需要多少就有多少)。然而，工作节点需要分布在多个数据中心。</p><p id="a566" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">→在负载平衡器后面将多个独立的群集群连接在一起，不仅可以实现高可用性，还可以支持canary部署。例如，如果生产环境由两个独立的集群组成，我们可以关闭其中一个集群并升级Docker，然后群集部署新的服务，而服务仍然可供最终客户使用。一旦我们完成了第一个集群，我们就启动它，并对第二个集群重复该任务。这种方法的唯一缺点是我们需要将相同的服务部署到多个集群中(也可以是自动化的)。</p><h2 id="afd0" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated"><strong class="ak">服务可用性</strong></h2><p id="5824" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">Docker Swarm服务的部署服务或滚动更新需要在零停机时间内完成。否则，最终用户的体验将会受到影响，群服务(尤其是那些公开web或API接口的服务)将会关闭，并且对客户端不可用。</p><p id="fd64" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">幸运的是，为群服务实现高可用性和零停机部署是一项简单的任务，只需更新相应服务的堆栈文件即可完成。</p><p id="5e77" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">下面是一篇博文，详细描述了如何实现Docker Swarm服务的零停机部署。</p><div class="ni nj gp gr nk nl"><a href="https://medium.com/faun/zero-downtime-deployment-with-docker-swarm-d84d8d9d9a14" rel="noopener follow" target="_blank"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd jd gy z fp nq fr fs nr fu fw jc bi translated">Docker Swarm实现零停机部署</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">部署Docker服务，无需维护通知，也不会影响最终用户</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">medium.com</p></div></div><div class="nu l"><div class="nv l nw nx ny nu nz lb nl"/></div></div></a></div><h2 id="0485" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated"><strong class="ak">处理服务日志</strong></h2><p id="219b" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">默认情况下，Docker使用<code class="fe oa ob oc od b">json-file</code>日志驱动程序。这个驱动程序将把容器日志存储在主节点<code class="fe oa ob oc od b">/lib/docker/containers/${id}/${id}-json.log</code>上的以下路径下的文件系统中。只要容器在运行，这个文件就会被使用，并且它的大小会不断增长。如果日志文件耗尽了主机节点上的所有可用空间，这种行为会使Docker群节点面临停机。作为这种情况的解决方案，可以实施以下选项之一。</p><p id="f0d9" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">→使用另一个日志驱动程序:Docker支持几个<a class="ae lh" href="https://docs.docker.com/config/containers/logging/configure/" rel="noopener ugc nofollow" target="_blank">日志驱动程序</a>，如Syslog、Fluentd或Gelf。这些日志驱动程序支持将容器日志传送到集中的日志服务器。因此，Docker群节点空间不会被用来存储容器日志。</p><p id="53f5" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">→旋转日志文件:Docker支持旋转容器日志文件，以控制日志文件的大小并保持群节点健康。通过在服务定义中添加下面几行，可以简单地实现群服务的日志轮换。</p><pre class="ks kt ku kv gt oe od of og aw oh bi"><span id="1320" class="ml mm it od b gy oi oj l ok ol">logging:<br/>      driver: json-file<br/>      options:<br/>        "max-size": "10m"<br/>        "max-file": "5"</span></pre><p id="86bb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">上面的配置将Docker配置为一旦日志文件的大小超过10MB，就对其进行循环，并保留最后5个循环的文件。这种方法的缺点是旧的日志会自动从服务器上删除，并且会丢失。因此，需要复制旋转的文件，并在需要时实现它们。</p><h2 id="2b72" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated"><strong class="ak">资源使用情况</strong></h2><p id="c124" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">资源管理和限制是每个Docker集群都需要处理的一个非常重要的主题。在群集集群中运行服务而不限制这些服务的附加资源(RAM和CPU)可能会使整个群集集群和其中运行的服务面临停机。例如，如果一个服务出现内存泄漏，并一直消耗主机上的可用内存，则同一主机上运行的其他服务可能会因为主机上没有足够的内存而无法执行其任务。此外，管理器不会在主机上安排服务，因为没有内存可用于新服务。关于管理群服务资源限制的更多细节可以在下面的博客文章中找到。</p><div class="ni nj gp gr nk nl"><a href="https://medium.com/faun/limit-resources-for-swarm-services-249dcebed833" rel="noopener follow" target="_blank"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd jd gy z fp nq fr fs nr fu fw jc bi translated">限制群服务的资源</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">开始控制Docker服务和容器的资源消耗</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">medium.com</p></div></div><div class="nu l"><div class="om l nw nx ny nu nz lb nl"/></div></div></a></div><h2 id="7e35" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated"><strong class="ak">网络极限:几家vs大网</strong></h2><p id="a2da" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">将所有Docker群服务托管在一个Docker网络中更容易且需要更少的努力，因为默认情况下所有服务将能够彼此通信，并且不需要管理它们之间的通信。服务。然而，在单一网络中运行Docker Swarm服务之前，需要考虑以下事项</p><p id="ec70" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">→每个服务都可以访问其他服务，这可能会带来不必要的通信或未授权操作的风险。例如，如果一个连接者获得了对一个服务访问，他可能能够访问其他服务。</p><p id="8293" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">→默认覆盖网络的规模由<code class="fe oa ob oc od b">/24</code>子网决定，这意味着这些网络只能有265个IP。Swarm中的服务可以使用不止一个IP。服务需要一个IP，每个副本或任务都需要一个IP。底线是在单个网络中运行的服务和容器的数量是有限制的。如果单个网络中运行的服务和容器的总数超过此限制，新的Docker容器将无法启动，并将处于挂起状态。为了解决这个问题并能够在一个网络中运行更多的服务，我们需要使用具有更大子网的网络。以下命令可用于创建一个更大的Docker覆盖网络。</p><pre class="ks kt ku kv gt oe od of og aw oh bi"><span id="df88" class="ml mm it od b gy oi oj l ok ol">docker network create --driver overlay --subnet=192.168.0.0/16 bignt</span></pre><p id="ddb8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">关于这个问题的更多信息可以在这个<a class="ae lh" href="https://success.docker.com/article/how-to-identify-ip-exhaustion" rel="noopener ugc nofollow" target="_blank">链接</a>中找到。</p><h2 id="cba2" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated"><strong class="ak">集群清理:Docker系统修剪</strong></h2><p id="38c7" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">创建Docker容器的第一步是在运行容器的主机上本地下载Docker映像。这些Docker映像消耗了Docker主机的一些空闲空间。部署这些服务的多个版本将下载新的Docker映像，并将消耗Docker节点上的更多空间，同时不再需要旧的Docker映像，因为新的容器正在使用新的Docker映像。这种行为的结果是，存在Docker Swarm由于空间问题而无法安排新容器或服务的风险。为了防止这种情况，建议在Docker节点上执行清理，以删除旧的Docker映像。幸运的是，这个任务可以通过执行下面的命令轻松完成。</p><pre class="ks kt ku kv gt oe od of og aw oh bi"><span id="5dd2" class="ml mm it od b gy oi oj l ok ol">docker image prune -a --filter "until=24h"</span></pre><p id="6234" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">以上命令将删除超过24小时前创建的所有docker映像。更多关于修剪命令的信息可以在<a class="ae lh" href="https://docs.docker.com/config/pruning/" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h2 id="7a8a" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated"><strong class="ak">结论</strong></h2><p id="cea5" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">在开发环境中使用Docker Swarm托管服务是一项简单的任务，可以在几分钟内完成。然而，在生产环境中使用Docker Swarm更加复杂，需要关注许多领域和主题，以保持集群的健康和高可用性。</p></div></div>    
</body>
</html>