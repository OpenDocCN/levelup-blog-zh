<html>
<head>
<title>Yahoo Finance Web Scraping with R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">雅虎财经网页抓取与R</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/yahoo-finance-web-scraping-with-r-5584d226c3a6?source=collection_archive---------13-----------------------#2021-02-22">https://levelup.gitconnected.com/yahoo-finance-web-scraping-with-r-5584d226c3a6?source=collection_archive---------13-----------------------#2021-02-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c31a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">公司的财务健康围绕三个核心要素:(1)运转良好的日常系统和流程，(2)弹性(抵御冲击的能力)，以及(3)追求长期目标。公司的财务表现也反映了管理的有效性。Yahoo Finance是公开交易股票财务数据的一个很好的来源，我有兴趣收集对一长串公司财务健康状况的理解。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/d6fbbab5a42d8e2be227e3bea4e15a05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nRLAD8OysbkBlnNV"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">马库斯·斯皮斯克在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="198c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很多网站都是动态创建的。这可以通过加载内容或数据的方式来实现，通常使用JavaScript / react.js来完成。或者，根据思想流派，可以动态创建网站的模板或架构，而不是使用更传统的预定义标签嵌套。Yahoo Finance就是这样一个动态创建的网站，其中<em class="lc">类</em>和<a class="ae lb" href="https://www.pluralsight.com/guides/introduction-to-the-data-reactid-attribute-in-html" rel="noopener ugc nofollow" target="_blank"> <em class="lc"> data-reactid </em> </a>的值是动态生成的属性，数据通过json加载。</p><p id="c9f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Python有BeautifulSoup和Selenium包来帮助web抓取。在这篇文章中，我们将看看R的网络抓取，特别是雅虎财经网站。数据是通过react.js填充的，因此我们可以从root.app.main组件的页面源中获取json格式的数据。让我们开始设置吧！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ld"><img src="../Images/da08c9d83f739cbacb947e8777bc051e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cR8SuNFMR3H-uS91JYJGWg.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">root.app.main组件包含页面的数据。</figcaption></figure></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="d241" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">设置</h1><p id="d61e" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">除了一些常规使用的R库，你还需要加载一些库，特别是下面4个处理HTML读取和解析的库:</p><ol class=""><li id="4860" class="mo mp iq jp b jq jr ju jv jy mq kc mr kg ms kk mt mu mv mw bi translated">xml2 —用于读取HTML或xml</li><li id="aefa" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated">XML —用于解析XML或HTML文件或字符串</li><li id="ee27" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated">rvest —用于提取HTML文档的节点和片段，包括CSS选择器</li><li id="438d" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated">httr —用于处理http请求— GET()、PUT()、POST()、PATCH()、HEAD()和DELETE()</li></ol><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="9518" class="nh lm iq nd b gy ni nj l nk nl">library(data.table)<br/>library(tidyr)<br/>library(tidyverse)<br/>library(XML)<br/>library(xml2)<br/>library(rvest)<br/>library(httr)</span></pre><h1 id="863f" class="ll lm iq bd ln lo nm lq lr ls nn lu lv lw no ly lz ma np mc md me nq mg mh mi bi translated">我们要刮什么？</h1><p id="5bdd" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">雅虎财经网站上的公司财务可以按年度或季度报告。无论哪种方式，我们都可以从大量的指标中提取数据。这些指标如下所示:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/fc8a1a30991e113dcb3b3e819011dee7.png" data-original-src="https://miro.medium.com/v2/resize:fit:506/format:webp/1*YKnop0FwxrHqDez9GPxAFA.png"/></div></figure><p id="b616" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">出于我的目的，我对每季度报告的以下指标感兴趣:</p><ul class=""><li id="9356" class="mo mp iq jp b jq jr ju jv jy mq kc mr kg ms kk ns mu mv mw bi translated">总收入</li><li id="4b22" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk ns mu mv mw bi translated">收益</li><li id="b08f" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk ns mu mv mw bi translated">收入成本</li><li id="7943" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk ns mu mv mw bi translated">毛利</li></ul></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="c4c1" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">密码</h1><p id="0bc9" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">首先，我们必须阅读HTML脚本，并开始解析网站。</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="6250" class="nh lm iq nd b gy ni nj l nk nl">url &lt;- paste0('https://finance.yahoo.com/quote/', symbol, '/financials?p=', symbol)<br/>html_M &lt;- read_html(url) %&gt;% html_node('body') %&gt;% html_text() %&gt;% toString()</span></pre><p id="e971" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想将所有股票的财务数据标准化为美元，以便于比较。因此，提取报告财务所用的货币非常重要。报告货币以下列方式通过root.app.main组件传递:<em class="lc">，\ " financial currency \ ":\ " JPY \ " }</em>，。下面是我用来提取和剥离“<strong class="jp ir"><em class="lc">【JPY】</em></strong><em class="lc">”货币代码字符串的脚本。</em>稍后，我将使用货币兑换率，将收入数字转换为美元。</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="af7b" class="nh lm iq nd b gy ni nj l nk nl">fin_cur &lt;- sub(".*\"financialCurrency\":*(.*?) *[\n|\r\n|\r]{2}", "\\1", html_M)<br/>fin_cur &lt;- head(stringr::str_match_all(fin_cur, "(.*?)\\}")[[1]][, 2],1)<br/>fin_cur=gsub("\"", "", fin_cur, fixed=T)</span></pre><h2 id="a6b3" class="nh lm iq bd ln nt nu dn lr nv nw dp lv jy nx ny lz kc nz oa md kg ob oc mh od bi translated">季度总收入和收益</h2><p id="cdc7" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">我们希望能够提取季度总收入和收益数据，并将其保存为可用的格式。为此，我们需要提取季度数据，将其解析为可读的格式，然后迭代地获取数据和原始数据。我们通过下面的代码片段来实现。在第5行，在下面的代码片段中，splitQ变量由屏幕截图中显示的输出组成；因此，我们需要使用第6到18行来提取总收入和日期的原始数据。我们也可以使用类似的代码来提取季度收益。</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="123b" class="nh lm iq nd b gy ni nj l nk nl">Q_results &lt;- sub(".*\"quarterly\":*(.*?) *[\n|\r\n|\r]{2}", "\\1", html_M)<br/>Q_results &lt;- head(stringr::str_match_all(Q_results, "\\[(.*?)\\]")[[1]][, 2],1)<br/>splitQ &lt;- str_split(Q_results, "\\{\"date\":")<br/>splitQ &lt;- splitQ[[1]]<br/>splitQ&lt;- paste("\\{\"date\":", splitQ, sep="")</span><span id="9a08" class="nh lm iq nd b gy oe nj l nk nl">if(length(splitQ)&gt;0){<br/>   tot_rev_df &lt;- data.frame(curr = fin_cur,<br/>      key=str_extract(splitQ, "\"date\":\"*(.*?) *\""),<br/>      value=str_extract(splitQ, "\"revenue\":\\{\"raw\":*(.*?) *,"))<br/>   tot_rev_df &lt;- tot_rev_df[complete.cases(tot_rev_df), ]<br/>   tot_rev_df &lt;- data.frame(lapply(tot_rev_df, as.character), stringsAsFactors=FALSE)<br/>   tot_rev_df &lt;- tot_rev_df %&gt;%<br/>      separate(key, c("first", "key"), sep=":") %&gt;% <br/>      select(-first)<br/>   tot_rev_df &lt;- tot_rev_df %&gt;%<br/>      separate(value, c("first", "second", "value"), sep=":") %&gt;%<br/>      select(-first, -second)<br/>   tot_rev_df &lt;- tot_rev_df %&gt;%<br/>      mutate(key=gsub("\"", "", key, fixed=T),<br/>         value=gsub(",", "", value, fixed=T))<br/>}</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi of"><img src="../Images/bea64df293e77d711e50a3a34090b55e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*va1KKcG0d3wJhSZdmgrGSw.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">splitQ中捕获的结果的屏幕截图</figcaption></figure><h2 id="d063" class="nh lm iq bd ln nt nu dn lr nv nw dp lv jy nx ny lz kc nz oa md kg ob oc mh od bi translated">收入成本和毛利</h2><p id="feb6" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">可以使用下面的代码提取属于收入成本和毛利指标的原始数据。从ex_between函数提取的字符向量的前半部分包含季度数据，后半部分包含年度数据。</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="5278" class="nh lm iq nd b gy ni nj l nk nl">cost_rev&lt;- qdapRegex::ex_between(html_M, "\"costOfRevenue\":", "\"fmt\"")[[1]]<br/>cost_rev &lt;- cost_rev[1:(length(cost_rev)/2)]<br/>cost_rev &lt;- gsub("{\"raw\":", "", cost_rev, fixed=T)<br/>cost_rev &lt;- gsub(",", "", cost_rev, fixed=T)</span><span id="7a68" class="nh lm iq nd b gy oe nj l nk nl">gp &lt;- qdapRegex::ex_between(html_M, "\"grossProfit\":", "\"fmt\"")[[1]]<br/>gp &lt;- gp[1:(length(gp)/2)]<br/>gp &lt;- gsub("{\"raw\":", "", gp, fixed=T)<br/>gp &lt;- gsub(",", "", gp, fixed=T)</span></pre><h1 id="ab9e" class="ll lm iq bd ln lo nm lq lr ls nn lu lv lw no ly lz ma np mc md me nq mg mh mi bi translated">结论</h1><p id="19b7" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated"><em class="lc">if(length(splitQ)&gt;0){ }</em>的if条件负责捕捉股票未上市或财务报告未完成时的错误。一旦您为感兴趣的指标编译了代码片段并将结果分类到数据帧中，您就可以将脚本包装在for循环中，并迭代地抓取您感兴趣的不同股票。</p><h1 id="8ecd" class="ll lm iq bd ln lo nm lq lr ls nn lu lv lw no ly lz ma np mc md me nq mg mh mi bi translated">额外资源</h1><p id="9c83" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">如果你对使用Python搜集雅虎财经感兴趣，你可以看看:</p><ul class=""><li id="78a9" class="mo mp iq jp b jq jr ju jv jy mq kc mr kg ms kk ns mu mv mw bi translated"><a class="ae lb" href="https://codeburst.io/how-to-scrape-yahoo-finance-using-python-31164aa06468" rel="noopener" target="_blank">https://code burst . io/how-to-scrape-Yahoo-finance-using-python-31164 aa 06468</a></li><li id="0955" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk ns mu mv mw bi translated"><a class="ae lb" href="https://towardsdatascience.com/web-scraping-yahoo-finance-477fe3daa852" rel="noopener" target="_blank">https://towards data science . com/we B- scraping-Yahoo-finance-477 Fe 3 da a852</a></li></ul></div></div>    
</body>
</html>