<html>
<head>
<title>Hacking iframe badges into auto-updating Github profile images with AWS Lambda and Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda和Golang将iframe徽章植入自动更新的Github个人资料图像</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/hacking-iframe-badges-into-auto-updating-github-profile-images-with-aws-lambda-and-golang-d6fbf78d6f6d?source=collection_archive---------29-----------------------#2021-02-22">https://levelup.gitconnected.com/hacking-iframe-badges-into-auto-updating-github-profile-images-with-aws-lambda-and-golang-d6fbf78d6f6d?source=collection_archive---------29-----------------------#2021-02-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="c490" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">我终于得到了一个我引以为豪的互联网徽章，但我却无法将它嵌入到我的Github个人资料中！</h1><p id="b1c9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><a class="ae lj" href="https://www.wren.co/join/ZackProser?utm_campaign=share&amp;utm_medium=profile_referral_link" rel="noopener ugc nofollow" target="_blank">Wren.co</a>是一家初创公司，通过资助气候基金投资组合的恢复性项目，让你、你的朋友和家人能够抵消你的碳足迹。Wren.co<a class="ae lj" href="https://www.wren.co/" rel="noopener ugc nofollow" target="_blank">的团队正在做非常重要的工作，你应该支持他们，无论是抵消你自己的足迹，如果你负担得起，还是把任介绍给你的朋友和同事。</a></p><p id="6b65" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">他们不仅要解决与气候相关的损害，还要解决围绕应对气候变化建立社会共识和合作的相关问题，允许你<a class="ae lj" href="https://www.wren.co/gifts" rel="noopener ugc nofollow" target="_blank">赠送鹪鹩</a>，抵消他人的足迹<a class="ae lj" href="https://www.wren.co/teams" rel="noopener ugc nofollow" target="_blank">，创建并加入团队</a>，以及<a class="ae lj" href="https://www.wren.co/leaderboard" rel="noopener ugc nofollow" target="_blank">在友好排行榜上竞争</a>。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/2f9d15be7201fe163f6a5207d553b141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*acJXEfWH06E3Q5U3HtWAPw.png"/></div></div></figure><h1 id="c907" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">SVG徽章很容易包含在任何地方——除了Github</h1><p id="58cd" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">最近，<a class="ae lj" href="https://www.notion.so/Wren-Badge-a1141624a25d4a35a05723496036a8db" rel="noopener ugc nofollow" target="_blank"> Wren发布了一个功能</a>，允许你展示一个光滑的徽章，根据你的贡献显示你的整体气候影响。</p><p id="ab32" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">它看起来像这样，虽然你可以从几个风格中选择。请注意，碳补偿的吨数是实时更新的:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/fe8ec412dbfd48f12f6cc45365c3c264.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/1*auPJB4LJoJntEY1r2X19zA.png"/></div></figure><p id="fb9c" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我的第一个想法是，我想通过最近推出的Github个人自述功能将这个徽章放在我的<a class="ae lj" href="https://github.com/zackproser" rel="noopener ugc nofollow" target="_blank"> Github个人资料</a>上。此功能允许您编辑特殊存储库中的README.md文件，该文件将内嵌到您的Github配置文件中，因此您可以对其进行一些个性化设置:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mc"><img src="../Images/5c60dd3a49d2fa4a310ccb86a413986f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tOeaGIRB9jPS9bOIC-k6sA.png"/></div></div></figure><p id="3db4" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这是Github给了它的用户更多的控制来设计他们自己的个人资料，只要你在<a class="ae lj" href="https://en.wikipedia.org/wiki/Markdown" rel="noopener ugc nofollow" target="_blank"> Markdown </a>中渲染东西。在我的例子中，包含我的徽章、关于我的兴趣的简短简介和指向我的其他内容的链接的表格的图像右侧的块都在Markdown中呈现，它位于这个特殊的repo中。</p><h1 id="42dd" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">降价既快又容易，但有限制性</h1><p id="d503" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Github针对profile READMEs的markdown解析器只允许呈现特定的HTML元素，这是有充分的安全理由的(一个主要的问题是有人可能会在HTML中注入恶意的脚本，这样任何访问profile的人都容易受到脚本攻击)。</p><p id="6581" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">但是，这也必然会限制您可以在个人资料自述文件中呈现和显示的内容。<a class="ae lj" href="https://www.wren.co/join/ZackProser?utm_campaign=share&amp;utm_medium=profile_referral_link" rel="noopener ugc nofollow" target="_blank">Wren.co</a>发布了作为iframes实现的徽章的第一次迭代，你可以快速嵌入到你控制的任何站点来呈现你的徽章，你甚至可以通过几个参数在某种程度上修改样式:</p><pre class="lq lr ls lt gt md me mf mg aw mh bi"><span id="8d51" class="mi jo iq me b gy mj mk l ml mm">&lt;iframe src="<a class="ae lj" href="http://wren.co/badge/simple/mims" rel="noopener ugc nofollow" target="_blank">http://wren.co/badge/simple/mims</a>" style="width: 300px; height: 128px; border: 0" /&gt;</span></pre><p id="5dba" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">不幸的是，iframes是Github的markdown解析器的禁忌元素之一，但我仍然希望显示我的徽章并定期更新，而不必自己手动完成。所以，我写了一个快捷的应用程序来帮我做这件事。</p><h1 id="917b" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">这难道不是过分和不必要的吗？</h1><p id="7fb0" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Wren.co不会更新他们的徽章以支持稍后返回图像吗？肯定，是的，也许。但这仍然是使用AWS无服务器技术的良好实践。</p><h1 id="ca3a" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">我们正在建造的东西</h1><p id="60d6" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">虽然我决定对我的Wren.co徽章使用这种方法，但是您可以使用这里概述的相同技术和代码对任何其他只作为iframe提供的徽章做同样的事情。这个解决方案的代码也可以在https://github.com/zackproser/wren-badge-rotator的<a class="ae lj" href="https://github.com/zackproser/wren-badge-rotator" rel="noopener ugc nofollow" target="_blank">找到。</a></p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mn"><img src="../Images/288994d6c3f23af5d364a72faaaf0c21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r9uy0kGfXQ3V9701UWqPPA.png"/></div></div></figure><p id="06a3" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在本演练中，我将分享我的问题解决方法以及设置系统的所有代码，该系统将:</p><ol class=""><li id="273a" class="mo mp iq kn b ko lk ks ll kw mq la mr le ms li mt mu mv mw bi translated">每月自动获取我最新的iframe徽章</li><li id="fc1c" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">将其转换为静态图像</li><li id="a7ea" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">通过Pull请求将其发布到我的Github个人资料上</li></ol><p id="95d6" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如果你想跳到这个应用的代码，你可以在https://github.com/zackproser/wren-badge-rotator<a class="ae lj" href="https://github.com/zackproser/wren-badge-rotator" rel="noopener ugc nofollow" target="_blank">找到它。</a></p><h1 id="f1d7" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">问题陈述</h1><p id="fa2e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我知道我希望我的徽章显示在我的Github个人资料README上，我不能在我的markdown中直接使用iframe，因为Github会在呈现我的个人资料之前对它进行清理。</p><p id="a3b0" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我可以对我自己的徽章进行截图，然后将其作为本地图像添加到我的特殊个人资料README repo中，并通过本地图像href引用它，如下所示:</p><pre class="lq lr ls lt gt md me mf mg aw mh bi"><span id="0210" class="mi jo iq me b gy mj mk l ml mm">![Climate Neutral Human](img/wren-carbon.png)</span></pre><p id="4bb5" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">然后我可以把图片包装在一个链接里，或者是我的鹪鹩推荐链接或者是我的鹪鹩简介。这最初是可行的，但因为我订阅了Wren的月度补偿，并且因为我偶尔会进行一次性补偿或为他人购买补偿，所以我知道我的统计数据将会定期变化，也就是说，假设Wren徽章支持实时更新？</p><h1 id="1eda" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">侦察</h1><p id="e34b" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我通读了<a class="ae lj" href="https://www.notion.so/Wren-Badge-a1141624a25d4a35a05723496036a8db" rel="noopener ugc nofollow" target="_blank">鹪鹩徽章公告</a>，并检查了建议的iframes所指向的URL。我找到了一个类似这样的HTML页面:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nc"><img src="../Images/d5faa80bd73fd18991d903151e825354.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yl4WIxTkJLLApcnIYYGJRQ.png"/></div></div></figure><p id="e1c8" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">所以—底层HTML页面本身呈现一个填充视口宽度的徽章。值得注意的是，我尝试添加了。png”添加到URL的末尾，看看服务器是否会返回一个我可以直接链接到的图像，但是目前还不支持该功能。相反，它返回了一个应用程序错误，告诉我Wren正在使用Heroku:)</p><h1 id="b4f8" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">弄清楚徽章是如何工作的</h1><p id="81e3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我还能够实时确认徽章统计数据的更新。我从查看我目前的徽章开始，然后去雷恩做<a class="ae lj" href="https://www.wren.co/offset-anything" rel="noopener ugc nofollow" target="_blank">1吨碳的一次性抵消</a>，然后刷新我的徽章，它立即通过将我的总吨抵消计数增加1来反映这一点。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/388613620846694b4c4619b46d4e744b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*JffaInPbmWUgey6oZ4scoA.png"/></div></figure><p id="7755" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">您可以传递一些URL参数来控制徽章的呈现，例如Wren用户的“用户名”和徽章本身的“样式”“{simple，logo}”。请参见<a class="ae lj" href="https://www.notion.so/Wren-Badge-a1141624a25d4a35a05723496036a8db" rel="noopener ugc nofollow" target="_blank">徽章功能公告</a>了解更多信息。</p><p id="a761" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">还值得注意的是，页面的CSS是与页面本身一起编写的，而不是来自一个单独的脚本。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ne"><img src="../Images/ca4de8081d22cc98499b699ea75d08be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JI7dDdJXNQ5fKkYzpelw3A.png"/></div></div></figure><h1 id="cdd7" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">在开发工具中修改全角徽章</h1><p id="6263" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">仍然在Firefox开发工具中，我修补了HTML和CSS，直到我得到了一些看起来像中等大小徽章的东西。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nf"><img src="../Images/b242d828e0c7dd4a2cea71ea2da1578b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hfcqNPXyrY4Bb8SMJVniPg.png"/></div></div></figure><p id="cc8b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我发现徽章本身是一个<a>标签，包裹着一个SVG(鹪鹩鸟标志)和一些其他元素。有一个容器元素——通过向它添加一个宽度:25%的规则，我能够按照我想要的方式调整徽章的大小。更多的实验表明，我还应该将HTML元素的宽度限制为300像素，高度限制为117像素。</a></p><p id="1f6a" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在这一点上，我想为我的徽章抓取这个HTML页面，但是有一个障碍，徽章会自然地填充视口的宽度，所以我不能只抓取页面并原样使用它。在获取它之后，需要进行一些修改和翻译。</p><h1 id="cc69" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">修改HTML页面，并处理剩余的CSS问题</h1><p id="ef00" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">通过Dev tools直接在wren badge页面上修改CSS对于找出要做的更改非常有用，但是我怎样才能永久地应用我的CSS更改来设计我的徽章呢？</p><p id="b1af" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如果我想让我的CSS修改永久化，我需要拥有自己徽章的HTML。换句话说，我需要抓取我的徽章，动态地重写CSS规则，将它放在我控制的URL中的某个地方，然后对那个徽章进行快照<strong class="kn ir">,以获得我想要的最终输出。</strong></p><h1 id="a8e0" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">查找HTML页面snappshotter</h1><p id="8a69" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我开始思考各种快照解决方案。想到了<a class="ae lj" href="https://github.com/puppeteer/puppeteer/" rel="noopener ugc nofollow" target="_blank">木偶师</a>，但最终我只是想要一个API，所以在尝试了他们的免费演示后，我决定用<a class="ae lj" href="https://htmlcsstoimage.com" rel="noopener ugc nofollow" target="_blank">https://htmlcsstoimage.com/</a>说服我他们的API工作良好。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/d23fba8e0ec8cf71ea2319c9445f02ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1BjihO5hdw4htcAdF9QXpA.png"/></div></div></figure><p id="3ca6" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我现在还注意到另一个问题，即使我修改了我的徽章HTML页面的CSS版本，任何查看该页面的内容都会看到一个绿色的小徽章在白色页面的海洋中游泳。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ng"><img src="../Images/ae9869a86e2101590bafd1ad9e773290.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*23g8eFO5szS2kF-hZAjy0w.png"/></div></div></figure><p id="c7f2" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><a class="ae lj" href="https://hcti.io/" rel="noopener ugc nofollow" target="_blank"> HCTI API </a>允许你指定他们在生成快照时使用的视口。这可以解决我的裁剪问题，但仍有一个遗留的CSS问题:鹪鹩徽章应用了温和的“边界半径”规则，使它们的角变圆，所以如果你拍摄一个完美的正方形截图，它们会在圆角周围显示一些白色背景像素。</p><p id="1012" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这可能看起来没什么大不了的，但是我和其他许多人都是在黑暗模式下运行Github的，所以在黑色背景下这看起来会很恶心(对我的Github简介自述文件的快速测试证实了这一点)。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nh"><img src="../Images/c43472045320578aa6e660ade7d6b452.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*GB5iebE7qfo_9AP6X5JbEg.png"/></div></div></figure><p id="f073" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我决定我修改后的徽章页面也将去掉边框半径，这样我就可以在白色或黑色背景上显示我完美的方形截屏徽章，而不会在角落周围出现任何多余的像素。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ni"><img src="../Images/603b4df51840b77bda84a70f587e79a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*axU4hv27lO6nggFMEHmerw.png"/></div></div></figure><p id="05db" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">最后，HCTI还让我传递一个CSS选择器，他们将在截屏页面时使用该选择器来检索该元素。我想要一个完美的裁剪徽章，所以我可以提供”。容器”选择器，测试证实，它工作得非常好——只有我更新的方形徽章本身被提取为图像。</p><h1 id="4b33" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">仔细考虑端到端自动化的要求</h1><p id="c780" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这一点上，很明显我需要采取一些步骤来使这个工作按照我想要的方式进行。现在，我们可以回顾一下带有更多内容的相同系统流程图:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mn"><img src="../Images/288994d6c3f23af5d364a72faaaf0c21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r9uy0kGfXQ3V9701UWqPPA.png"/></div></div></figure><ol class=""><li id="2dae" class="mo mp iq kn b ko lk ks ll kw mq la mr le ms li mt mu mv mw bi translated">我需要一些东西来启动这个过程，每个月一次，因为我的徽章所代表的统计数据至少会更新那么频繁。</li><li id="09cc" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">我需要直接捕获徽章页面的原始HTML，因为它是我的用户名。</li><li id="d98b" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">接下来，我需要对CSS本身进行一些修改，但是我希望整个HTML页面结构保持不变。</li><li id="df60" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">我需要在运行时重写HTML和CSS。</li><li id="ed5b" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">然后，我需要在本地的某个地方编写我的徽章的HTML页面的修改版本，包含我调整的CSS规则。</li><li id="1ec9" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">接下来，我需要立即在一个公共URL上发布这个修改过的HTML页面，这样我就可以将它提供给HCTI API进行抓取。</li><li id="e6e2" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">然后，我将调用HCTI API，给他们我修改过的页面的URL，以及前面提到的“viewport_width”、“viewport_height”和“css_selector”参数。</li><li id="0412" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">这个API调用将导致来自HCTI的响应，其中包含我的徽章图像的完美快照版本的URL，以及我最新的碳补偿统计数据。</li><li id="76dc" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">然后，我需要从这个URL读取图像，并将其保存在本地或远程的某个地方，以备后用。</li><li id="6363" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">然后，我需要在运行时克隆我的特殊Github配置文件库。</li><li id="dda9" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">然后，我需要用这个新更新的徽章图像覆盖我的README.md文件当前链接到的现有“img/wren-badge.png”。</li><li id="9012" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">然后，我需要以编程方式将这些更改提交并推送到我的远程repo，使用我的用户名和<a class="ae lj" href="https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token" rel="noopener ugc nofollow" target="_blank"> Github个人访问令牌</a>利用HTTP basic auth。</li><li id="b3eb" class="mo mp iq kn b ko mx ks my kw mz la na le nb li mt mu mv mw bi translated">最后，我可以用我的令牌调用Github API来打开一个Pull请求，这样我就可以在合并我的更新徽章之前检查一切看起来都很好。</li></ol><p id="2edc" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我最后写的<a class="ae lj" href="https://github.com/zackproser/wren-badge-rotator" rel="noopener ugc nofollow" target="_blank"> Golang lambda函数</a>能够在大约6秒内完成所有这些。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nj"><img src="../Images/4cbb3b0d18c37392c6b194cf54fe2cc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2p_As6WxJqqeR0NGv_5MdA.png"/></div></div></figure><h1 id="9021" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">解决方案成形了</h1><p id="0883" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我在<a class="ae lj" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS lambda </a>上登陆了一个<a class="ae lj" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Golang </a>运行时，因为我可以设置一个<a class="ae lj" href="https://aws.amazon.com/cloudwatch/" rel="noopener ugc nofollow" target="_blank"> CloudWatch </a> alert来触发我的lambda每月一次。</p><p id="7451" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我没有从头开始，而是利用<a class="ae lj" href="https://aws.amazon.com/serverless/sam/" rel="noopener ugc nofollow" target="_blank"> AWS无服务器应用程序模型(SAM) </a>快速搭建一个lambda函数，连接到<a class="ae lj" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank"> API网关</a>实例、<a class="ae lj" href="https://aws.amazon.com/xray/" rel="noopener ugc nofollow" target="_blank"> Xray </a>跟踪和<a class="ae lj" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html" rel="noopener ugc nofollow" target="_blank"> CloudWatch日志</a>。</p><h1 id="cce2" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">利用云计算实现快速、轻松的部署</h1><p id="7a6c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">一旦我有了默认的无服务器API模板和我想要的Lambda，我就修改了Cloudformation模板，删除了不必要的API网关及其端点，代之以CloudWatch事件触发器，该触发器配置了cron调度，在每月的第二天运行。</p><p id="c1ee" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我这样做是因为这个系统不需要外部API调用，它只需要每月运行一次。</p><p id="6c60" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">Cloudformation可以轻松地快速拆除和恢复整个堆栈，并使其他想要自己部署应用程序的人能够在自己的帐户中快速启动并运行它。这是我最终的云层模板的样子。</p><p id="f768" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">请注意，此模板描述了运行此应用程序所需的每个AWS资源及其关系:</p><pre class="lq lr ls lt gt md me mf mg aw mh bi"><span id="226f" class="mi jo iq me b gy mj mk l ml mm">AWSTemplateFormatVersion: '2010-09-09'<br/>Transform: AWS::Serverless-2016-10-31<br/>Description: &gt;<br/>  wren-badge-rotator</span><span id="361c" class="mi jo iq me b gy nk mk l ml mm">Resources:<br/>  WrenBadgeImageResizeBucket:<br/>    Type: AWS::S3::Bucket<br/>  # Attach a bucket policy that allows all objects uploaded to it to be read by anonymous principals (such as the HCTI API's screenshotting / scraping bots)<br/>  WrenBadgeImageResizeBucketAllowPublicReadPolicy:<br/>    Type: AWS::S3::BucketPolicy<br/>    Properties:<br/>      Bucket: !Ref WrenBadgeImageResizeBucket<br/>      PolicyDocument:<br/>        Version: "2012-10-17"<br/>        Statement:<br/>          - Effect: Allow<br/>            Action:<br/>              - "s3:GetObject"<br/>            Resource:<br/>              - !Join<br/>                - ''<br/>                - - 'arn:aws:s3:::'<br/>                  - !Ref WrenBadgeImageResizeBucket<br/>                  - /*<br/>            Principal: "*"</span><span id="6953" class="mi jo iq me b gy nk mk l ml mm">WrenBadgeRotatorFunction:<br/>    Type: AWS::Serverless::Function # More info about Function Resource: <a class="ae lj" href="https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction" rel="noopener ugc nofollow" target="_blank">https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction</a><br/>    Properties:<br/>      CodeUri: wren-badge-rotator/<br/>      Handler: wren-badge-rotator<br/>      Runtime: go1.x<br/>      Description: A lambda function that scrapes, processes, and updates my Wren.co badge on my Github profile<br/>      # Allow a timeout of 15 minutes, the maximum supported by lambda, even though we won't need that much time<br/>      Timeout: 900<br/>      Events:<br/>        SimpleCWEEvent:<br/>          Type: Schedule<br/>          Properties:<br/>            # Run the lambda function once, on the second day of every month, at 8am<br/>            Schedule: cron(0 8 2 * ? *)<br/>      Environment:<br/>        Variables:<br/>          S3_BUCKET: !Ref WrenBadgeImageResizeBucket<br/>          WREN_USERNAME: zackproser<br/>          REPO_OWNER: zackproser</span><span id="b9d7" class="mi jo iq me b gy nk mk l ml mm">WrenBadgeRotatorFunctionS3BucketPolicy:<br/>    Type: AWS::IAM::Policy<br/>    Properties:<br/>      PolicyName: ManageImageResizeS3Bucket<br/>      PolicyDocument:<br/>        Version: '2012-10-17'<br/>        Statement:<br/>          - Effect: Allow<br/>            Action:<br/>              - 's3:*'<br/>            # Grant the Lambda function access to every file in the S3 bucket used for hosting the modified badge HTML and the final processed badge image<br/>            Resource:<br/>              - !Join<br/>                - ''<br/>                - - 'arn:aws:s3:::'<br/>                  - !Ref WrenBadgeImageResizeBucket<br/>                  - /*<br/>      Roles:<br/>        - !Ref WrenBadgeRotatorFunctionRole</span><span id="1adf" class="mi jo iq me b gy nk mk l ml mm">Outputs:<br/>  WrenBadgeRotatorFunction:<br/>    Description: "Lambda function ARN"<br/>    Value: !GetAtt WrenBadgeRotatorFunction.Arn<br/>  WrenbadgeRotatorFunctionIamRole:<br/>    Description: "Implicit IAM Role created for the badge rotator function"<br/>    Value: !GetAtt WrenBadgeRotatorFunctionRole.Arn</span></pre><h1 id="bf35" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">处理秘密</h1><p id="e30c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们总是希望在我们的代码和版本控制之外保留我们的秘密，Lambda使得通过Lambda仪表板快速存储敏感的环境变量变得容易，比如我的API密钥和我的Github个人访问令牌。</p><p id="b0b1" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">它们在AWS中被加密，并在运行时自动注入到我的lambda上下文中，所以我的Go代码只需要从环境中读取秘密。</p><p id="de96" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">通过这种方式，我可以将所有的秘密隐藏在我的代码之外，这样我就可以开源这个应用程序。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/384a32db1b02eda3ec7b934a2eb07580.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*Na2A0AHOukKwG0b-xVnTbw.png"/></div></figure><p id="c444" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">请注意，与其他AWS原生的秘密管理解决方案(如AWS Secrets Manager和AWS Systems Manager Parameter Store)不同，Lambda <em class="nm">将在您登录仪表板并查看该功能时以明文形式</em>显示您的环境变量(无需单击任何东西来显示值)，但如果您是在自己的帐户中运行该功能的个人开发人员，这也没问题。</p><p id="e61c" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">一旦你开始与一个团队合作，选择Secrets Manager或SSM参数存储增加的安全性(以及增加的管理开销和代码复杂性)。</p><h1 id="ad48" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">通过Golang模板重写HTML</h1><p id="d0e7" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这个应用程序最有趣的部分是从Wren.co的原始HTML页面中提取现有的徽章，并即时重写其样式。</p><p id="c5a5" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">因为我注意到Wren的徽章页面的CSS样式内嵌在页面中，所以创建一个与HTML页面几乎相同的Golang模板更容易，但是包含了我修改过的规则。</p><pre class="lq lr ls lt gt md me mf mg aw mh bi"><span id="86e7" class="mi jo iq me b gy mj mk l ml mm">const wrapper = `<br/>            &lt;!doctype html&gt;<br/>            &lt;html&gt;<br/>              &lt;head&gt;<br/>                &lt;link href="<a class="ae lj" href="https://fonts.googleapis.com/css2?family=Roboto&amp;display=swap" rel="noopener ugc nofollow" target="_blank">https://fonts.googleapis.com/css2?family=Roboto&amp;display=swap</a>" rel="stylesheet"&gt;<br/>                &lt;style&gt;<br/>                  html {</span><span id="0afd" class="mi jo iq me b gy nk mk l ml mm">                    # Here are some of my modifications<br/>                    width: 300px;<br/>                    height: 117px;<br/>                  }</span><span id="2e1a" class="mi jo iq me b gy nk mk l ml mm">                  .wrapper-link {<br/>                    text-decoration: none;<br/>                  }<br/># ... (more css rules elided here for brevity)</span><span id="b651" class="mi jo iq me b gy nk mk l ml mm">              &lt;/head&gt;<br/>              &lt;body&gt;<br/>               {{ .Contents }}<br/>              &lt;/body&gt;</span></pre><p id="be19" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">有了这个模板，我们只需要在运行时将徽章本身的HTML输入到<code class="fe nn no np me b">Contents</code>变量中。</p><p id="69d6" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这是通过使用递归在从Wren获取的HTML文档中查找原始徽章的包装标签<a>来实现的。你可以在</a><a class="ae lj" href="https://github.com/zackproser/wren-badge-rotator" rel="noopener ugc nofollow" target="_blank">repo</a>的html-rewriter.go文件中看到完整的解决方案:</p><pre class="lq lr ls lt gt md me mf mg aw mh bi"><span id="2d99" class="mi jo iq me b gy mj mk l ml mm">// Badge recursively searches the HTML document to find the badge node, which is wrapped in an "a" tag, or link<br/>func Badge(doc *html.Node) (*html.Node, error) {<br/> var badge *html.Node<br/> var crawler func(*html.Node)<br/> crawler = func(node *html.Node) {<br/>  if node.Type == html.ElementNode &amp;&amp; node.Data == "a" {<br/>   badge = node<br/>   return<br/>  }<br/>  for child := node.FirstChild; child != nil; child = child.NextSibling {<br/>   crawler(child)<br/>  }<br/> }<br/> crawler(doc)<br/> if badge != nil {<br/>  return badge, nil<br/> }<br/> return nil, errors.New("Missing &lt;a&gt; in the node tree")<br/>}</span></pre><p id="67ac" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">所有这些都呈现在HTML文档的主体中。然后，修改后的HTML被本地写入Lambda执行上下文，然后被推送到S3，这样任何人都可以公开访问它，包括HCTI API的抓取和截屏机器人。</p><h1 id="f3eb" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">检查代码并自己使用它</h1><p id="441d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我把我的解决方案推给了下面的回购<a class="ae lj" href="https://github.com/zackproser/wren-badge-rotator" rel="noopener ugc nofollow" target="_blank">，我把它命名为wren-badge-rotator </a>。</p><p id="db97" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">由于一切都是通过环境变量参数化的，如果您熟悉AWS / Cloudformation / SAM，您可以使用它来部署您自己的相同应用程序实例，填充您自己的Github和Wren用户名，以及您的Github个人访问令牌和您的HCTI API密钥和用户ID。</p><h1 id="f43c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">项目结构一览</h1><p id="5def" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">快速浏览一下项目的整体结构，img目录仅保存README.md用于呈现示例图像的图片。</p><p id="d0cb" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">当您执行<code class="fe nn no np me b">sam build</code>命令时，SAM cli使用Makefile来运行构建。</p><p id="e3a6" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">Golang Lambda函数的整体包含在<code class="fe nn no np me b">wren-badge-rotator/.</code>中</p><pre class="lq lr ls lt gt md me mf mg aw mh bi"><span id="d9e8" class="mi jo iq me b gy mj mk l ml mm">$ tree<br/>.<br/>├── img<br/>│   └── github-profile.png<br/>├── Makefile<br/>├── README.md<br/>├── template.yaml<br/>└── wren-badge-rotator<br/>    ├── git.go<br/>    ├── go.mod<br/>    ├── go.sum<br/>    ├── html-rewriter.go<br/>    ├── html-to-img.go<br/>    ├── main.go<br/>    ├── s3.go<br/>    └── startup.go</span><span id="8420" class="mi jo iq me b gy nk mk l ml mm">2 directories, 12 files</span></pre><p id="8bce" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如果你想深入探索代码，你可以在这里查看资源库:<a class="ae lj" href="https://github.com/zackproser/wren-badge-rotator" rel="noopener ugc nofollow" target="_blank">https://github.com/zackproser/wren-badge-rotator</a>。它通过注释被合理地很好地记录下来。</p><h1 id="0639" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">部署您自己的实例</h1><p id="a4f9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果您想自己运行它，您可以派生它，修改环境变量以指向您自己的repos和Wren帐户。自述文件包括通过附带的Cloudformation <code class="fe nn no np me b">template.yml</code>部署它的说明。</p><h1 id="137d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="0606" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">有了这个解决方案，我现在可以让我的Wren.co徽章显示在我的Github个人资料上，并每月自动更新一次，这样它就会始终反映我的最新统计数据。与此同时，这是一个有趣的实验，利用AWS Lambda、CloudWatch events和Cloudformation，使用纯无服务器AWS产品创建了一个无需维护、运行成本低廉的应用程序。</p></div></div>    
</body>
</html>