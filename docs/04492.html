<html>
<head>
<title>Running Workflows on windows with Jenkins pipeline and Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Jenkins pipeline和Kubernetes在windows上运行工作流</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/running-workflows-on-windows-with-jenkins-pipeline-and-kubernetes-52752a89a0e7?source=collection_archive---------18-----------------------#2020-06-29">https://levelup.gitconnected.com/running-workflows-on-windows-with-jenkins-pipeline-and-kubernetes-52752a89a0e7?source=collection_archive---------18-----------------------#2020-06-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/3d29665b9018061fddd80bfefccd1099.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*UIbSwVXEgtJTv77zEndjcQ.jpeg"/></div></figure><p id="29e4" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">作为Cloudify.co的DevOps工程师，我正在基于Kubernetes和Jenkins构建一个新的CI/CD管道。最近，我在一个工作流中工作，我需要在windows上构建工件(可执行文件)，您可以在windows worker节点上运行基于windows映像的容器。我将在这篇文章中分享我的经验，关于如何将windows worker节点添加到您的EKS集群，然后在其上运行windows工作流。</p><p id="9f9b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们开始吧。</p><h1 id="a159" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">詹金斯是什么？</h1><blockquote class="lt lu lv"><p id="9703" class="jx jy lw jz b ka kb kc kd ke kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ku im bi translated">Jenkins是一款独立的开源自动化服务器，可用于自动化与构建、测试、交付或部署软件相关的各种任务。<a class="ae ma" href="https://jenkins.io/doc/" rel="noopener ugc nofollow" target="_blank"><em class="it"/></a></p></blockquote><h1 id="3d87" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">詹金斯管道是什么？</h1><p id="b7a7" class="pw-post-body-paragraph jx jy it jz b ka mb kc kd ke mc kg kh ki md kk kl km me ko kp kq mf ks kt ku im bi translated">Jenkins Pipeline(或简称为“Pipeline”，大写字母为“P”)是一套插件，支持将<em class="lw">连续交付管道</em>集成到Jenkins中。</p><p id="d5f6" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><a class="ae ma" href="https://www.jenkins.io/doc/book/pipeline/" rel="noopener ugc nofollow" target="_blank">https://www.jenkins.io/doc/book/pipeline/</a></p><h1 id="c2aa" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">Jenkins的Kubernetes插件是什么？</h1><blockquote class="lt lu lv"><p id="f93f" class="jx jy lw jz b ka kb kc kd ke kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ku im bi translated"><em class="it">在Kubernetes集群中运行动态代理的Jenkins插件。</em></p><p id="6736" class="jx jy lw jz b ka kb kc kd ke kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ku im bi translated"><em class="it">插件为每个启动的代理创建一个Kubernetes Pod，由Docker映像定义运行，并在每次构建后停止它。</em></p><p id="b1d5" class="jx jy lw jz b ka kb kc kd ke kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ku im bi translated"><a class="ae ma" href="https://plugins.jenkins.io/kubernetes/" rel="noopener ugc nofollow" target="_blank"><em class="it">https://plugins.jenkins.io/kubernetes/</em></a></p></blockquote><h1 id="34c8" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">什么是亚马逊EKS？</h1><blockquote class="lt lu lv"><p id="101f" class="jx jy lw jz b ka kb kc kd ke kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ku im bi translated">亚马逊弹性Kubernetes服务(亚马逊EKS)是一项托管服务，使您可以轻松地在AWS上运行Kubernetes，而无需建立或维护自己的Kubernetes控制面板。Kubernetes是一个开源系统，用于自动化容器化应用程序的部署、扩展和管理。</p><p id="1a4c" class="jx jy lw jz b ka kb kc kd ke kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ku im bi translated"><a class="ae ma" href="https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/eks/latest/user guide/what-is-eks . html</a></p></blockquote><h1 id="8c52" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">将windows工作节点添加到仅包含linux节点的现有EKS集群中</h1><h2 id="325c" class="mg kw it bd kx mh mi dn lb mj mk dp lf ki ml mm lj km mn mo ln kq mp mq lr mr bi translated">直接使用eksctl实用程序创建一个包含windows节点的新节点组(AWS自动缩放组),而不使用config</h2><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="27fd" class="mg kw it mx b gy nb nc l nd ne">$ eksctl create nodegroup \<br/>--cluster your_cluster_name \<br/>--region us-west-2 \<br/>--version 1.15 \<br/>--name ng-windows \<br/>--node-type t3.medium \<br/>--nodes 3 \<br/>--nodes-min 1 \<br/>--nodes-max 4 \<br/>--node-ami-family WindowsServer2019FullContainer</span></pre><p id="6fea" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这里最重要的参数是node-ami-family:windows server 2019 full container</p><h2 id="294d" class="mg kw it bd kx mh mi dn lb mj mk dp lf ki ml mm lj km mn mo ln kq mp mq lr mr bi translated">使用配置文件中的windows节点并使用eksctl实用程序创建一个节点组</h2><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="0bf9" class="mg kw it mx b gy nb nc l nd ne"># eks_cluster_config.yaml</span><span id="8c9f" class="mg kw it mx b gy nf nc l nd ne">- name: ng-windows<br/>  amiFamily: WindowsServer2019FullContainer<br/>  desiredCapacity: 3<br/>  minSize: 1<br/>  maxSize: 4<br/>  instanceType: t3.medium<br/>  privateNetworking: true<br/>  availabilityZones: ["eu-west-1a", "eu-west-1b", "eu-west-1c"]<br/>  labels:<br/>    instance-type: windows</span><span id="1746" class="mg kw it mx b gy nf nc l nd ne">$ eksctl create nodegroup --config-file=eks_cluster_config.yaml --include=ng-windows</span></pre><h2 id="911c" class="mg kw it bd kx mh mi dn lb mj mk dp lf ki ml mm lj km mn mo ln kq mp mq lr mr bi translated">您可能还有更高级的配置，例如在spot实例上运行windows节点</h2><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="dc74" class="mg kw it mx b gy nb nc l nd ne">- name: ng-spot-windows<br/>  amiFamily: WindowsServer2019FullContainer<br/>  desiredCapacity: 0<br/>  minSize: 0<br/>  maxSize: 10<br/>  privateNetworking: true<br/>  instancesDistribution:<br/>    instanceTypes: ["t2.large", "t3.large", "m3.large"]<br/>    onDemandBaseCapacity: 0<br/>    onDemandPercentageAboveBaseCapacity: 0<br/>    spotInstancePools: 3<br/>  tags:<br/>    k8s.io/cluster-autoscaler/node-template/label/instance-type: spot-windows<br/>  availabilityZones: ["eu-west-1a", "eu-west-1b", "eu-west-1c"]<br/>  labels:<br/>    instance-type: spot-windows<br/>  iam:<br/>    withAddonPolicies:<br/>      autoScaler: true</span></pre><p id="ad24" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在本例中，我使用集群集群自动缩放器来自动调整Kubernetes集群的大小</p><p id="7bb9" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><a class="ae ma" href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler" rel="noopener ugc nofollow" target="_blank">https://github . com/kubernetes/auto scaler/tree/master/cluster-auto scaler</a></p><blockquote class="ng"><p id="a059" class="nh ni it bd nj nk nl nm nn no np ku dk translated">此外，请阅读C <a class="ae ma" href="https://docs.aws.amazon.com/eks/latest/userguide/windows-support.html" rel="noopener ugc nofollow" target="_blank">注意事项</a>，其中包含重要信息，如</p><p id="e3e3" class="nh ni it bd nj nk nl nm nn no np ku dk translated">Windows工作负载不支持Amazon EC2实例类型C3、C4、D2、I2、M4(不包括m 4.16 x大型)和R3实例。</p></blockquote><h2 id="b442" class="mg kw it bd kx mh nq dn lb mj nr dp lf ki ns mm lj km nt mo ln kq nu mq lr mr bi translated">将VPC资源控制器和VPC准入Webhook安装到集群中</h2><p id="4164" class="pw-post-body-paragraph jx jy it jz b ka mb kc kd ke mc kg kh ki md kk kl km me ko kp kq mf ks kt ku im bi translated">这些组件在Linux节点上运行，负责为Windows节点上的传入pod启用网络。要使用该工具，我们运行以下命令。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="d1a4" class="mg kw it mx b gy nb nc l nd ne">$ <!-- -->eksctl utils install-vpc-controllers --name <!-- -->your_cluster_name<!-- --> --approve</span></pre><h2 id="68bf" class="mg kw it bd kx mh mi dn lb mj mk dp lf ki ml mm lj km mn mo ln kq mp mq lr mr bi translated">部署Windows示例应用程序</h2><p id="6f61" class="pw-post-body-paragraph jx jy it jz b ka mb kc kd ke mc kg kh ki md kk kl km me ko kp kq mf ks kt ku im bi translated"><a class="ae ma" href="https://docs.aws.amazon.com/eks/latest/userguide/windows-support.html#windows-sample-application" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/eks/latest/user guide/windows-support . html # windows-sample-application</a></p><p id="8c0d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我建议您部署一个windows示例应用程序来验证您的集群配置是否正确。</p><h2 id="279a" class="mg kw it bd kx mh mi dn lb mj mk dp lf ki ml mm lj km mn mo ln kq mp mq lr mr bi translated">在应用程序中正确设置节点选择器</h2><p id="812b" class="pw-post-body-paragraph jx jy it jz b ka mb kc kd ke mc kg kh ki md kk kl km me ko kp kq mf ks kt ku im bi translated">因此，群集已配置好并能够运行windows工作流，现在您必须在您的应用程序上指定节点选择器，以便pod位于具有适当操作系统的节点上。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="ae75" class="mg kw it mx b gy nb nc l nd ne"># Targeting Windows<br/>  nodeSelector:<br/>    beta.kubernetes.io/os: windows<br/>    beta.kubernetes.io/arch: amd64</span><span id="339b" class="mg kw it mx b gy nf nc l nd ne"># Targeting Linux<br/>  nodeSelector:<br/>    beta.kubernetes.io/os: linux<br/>    beta.kubernetes.io/arch: amd64</span></pre><blockquote class="lt lu lv"><p id="b94f" class="jx jy lw jz b ka kb kc kd ke kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ku im bi translated">根据我的经验，这是<strong class="jz iu">最重要的部分</strong>，因为如果您使用您创建的标签来选择所需的节点，而不是像推荐的那样将“beta.kubernetes.io/os: windows”选择器附加到您的应用程序，您可能会遇到麻烦，并且您的pod可能会停留在挂起状态，并出现类似于下面的错误:<code class="fe nv nw nx mx b">Failed create pod sandbox: rpc error: code = Unknown desc = [failed to set up sandbox container "…" network for pod "…": NetworkPlugin cni failed to set up pod "…" network: failed to parse Kubernetes args: pod does not have label vpc.amazonaws.com/PrivateIPv4Address...</code></p><p id="07ec" class="jx jy lw jz b ka kb kc kd ke kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ku im bi translated">在这种情况下，检查你设置的节点选择器是否正确，如果有问题，你可以阅读<a class="ae ma" href="https://github.com/aws/containers-roadmap/issues/542" rel="noopener ugc nofollow" target="_blank">这个</a></p></blockquote><h1 id="e722" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">使用Jenkins pipeline在windows上运行工作流</h1><p id="96f1" class="pw-post-body-paragraph jx jy it jz b ka mb kc kd ke mc kg kh ki md kk kl km me ko kp kq mf ks kt ku im bi translated">在本例中，我使用“windows server core”映像和PowerShell来创建一个示例文件，并将其上传到s3 bucket，您需要对其进行定义。</p><p id="bd18" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我还在“Vault”中存储AWS的凭证，我在上一篇文章中描述了如何在Jenkins管道中读取Vault的秘密:<a class="ae ma" href="https://medium.com/@warolv/read-vaults-secrets-from-jenkin-s-declarative-pipeline-50a690659d6" rel="noopener">https://medium . com/@ warolv/read-vaults-secrets-from-jenkin-s-declarative-pipeline-50a 690659 D6</a></p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="865f" class="mg kw it mx b gy nb nc l nd ne">def secrets = [<br/>  [path: 'secret/jenkins/aws', engineVersion: 2, secretValues: [<br/>    [envVar: 'AWS_ACCESS_KEY_ID', vaultKey: 'aws_access_key_id'],<br/>    [envVar: 'AWS_SECRET_ACCESS_KEY', vaultKey: 'aws_secret_access_key']]],<br/>]</span><span id="1f80" class="mg kw it mx b gy nf nc l nd ne">def configuration = [vaultUrl: "${env.VAULT_URL}",  vaultCredentialId: 'vault-approle', engineVersion: 2]</span><span id="fe03" class="mg kw it mx b gy nf nc l nd ne">pipeline {<br/>  agent {<br/>    kubernetes {<br/>      label 'workflow-example'<br/>      defaultContainer 'jnlp'<br/>      yaml """<br/>kind: Pod<br/>spec:<br/>  containers:<br/>  - name: jnlp<br/>    image: jenkins/inbound-agent:windowsservercore-1809<br/>  - name: shell<br/>    image: mcr.microsoft.com/powershell:preview-windowsservercore-1809<br/>    command:<br/>    - powershell<br/>    args:<br/>    - Start-Sleep<br/>    - 999999<br/>  nodeSelector:<br/>    beta.kubernetes.io/os: windows<br/>    beta.kubernetes.io/arch: amd64<br/>"""<br/>    }<br/>  }<br/>  <br/>  environment {<br/>    branch = 'master' <br/>    workspace = '/home/jenkins/agent/workspace/workflow-example'<br/>    s3_path = "s3://path_to_your_s3_bucket"<br/>  }<br/>  <br/>  stages {<br/>    stage('prepare') {<br/>      steps {<br/>        container('shell'){<br/>          dir("${workspace}") {<br/>            withVault([configuration: configuration, vaultSecrets: secrets]) {  <br/>              powershell """<br/>       <br/>              echo "### Install chocolatey package manager ###"<br/>              Set-ExecutionPolicy Bypass -Scope Process -Force;   [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('<a class="ae ma" href="https://chocolatey.org/install.ps1'" rel="noopener ugc nofollow" target="_blank">https://chocolatey.org/install.ps1'</a>))<br/>              <br/>              echo "### Install AWS cli ###"<br/>              choco install awscli -y</span><span id="3d67" class="mg kw it mx b gy nf nc l nd ne">              echo "### Create sample data for upload ###"<br/>              echo 'Data sample' &gt; data-sample.txt<br/>              <br/>              echo "### Upload to S3 ###"<br/>              aws s3 cp .\\ ${s3_path} --acl public-read --recursive<br/>              """<br/>            }<br/>          }<br/>        }<br/>      }<br/>    }<br/>  }<br/>  <br/>  options {<br/>    buildDiscarder(logRotator(numToKeepStr:'30'))<br/>    timeout(time: 60, unit: 'MINUTES')<br/>    timestamps()<br/>  }<br/>}</span></pre><h1 id="2807" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">结论</h1><p id="71b2" class="pw-post-body-paragraph jx jy it jz b ka mb kc kd ke mc kg kh ki md kk kl km me ko kp kq mf ks kt ku im bi translated">在这篇文章中，我向您展示了如何将一个windows worker节点连接到现有的带有Linux节点的EKS集群，以及如何使用Jenkins pipeline在windows上运行工作流。当然，当我们使用Linux和Windows节点以及许多很酷的东西并行运行多个阶段时，我们也可以创建更高级的工作流。感谢您的阅读，希望对您有用。</p><p id="fbbc" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">你也可以在我的博客中读到:<a class="ae ma" href="https://igorzhivilo.com/" rel="noopener ugc nofollow" target="_blank">https://igorzhivilo.com/</a></p><h1 id="98c4" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">参考</h1><p id="a4e2" class="pw-post-body-paragraph jx jy it jz b ka mb kc kd ke mc kg kh ki md kk kl km me ko kp kq mf ks kt ku im bi translated"><a class="ae ma" href="https://aws.amazon.com/blogs/aws/amazon-eks-windows-container-support-now-generally-available/" rel="noopener ugc nofollow" target="_blank">亚马逊EKS Windows容器支持现已全面上市</a></p><p id="99c6" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><a class="ae ma" href="https://eksctl.io/usage/windows-worker-nodes/" rel="noopener ugc nofollow" target="_blank"> Windows工作者节点</a></p><p id="eb3a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><a class="ae ma" href="https://docs.aws.amazon.com/eks/latest/userguide/launch-windows-workers.html" rel="noopener ugc nofollow" target="_blank">启动亚马逊EKS视窗工人节点</a></p><p id="560f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><a class="ae ma" href="https://docs.aws.amazon.com/eks/latest/userguide/windows-support.html#windows-sample-application" rel="noopener ugc nofollow" target="_blank"> Windows支持</a></p><p id="56f7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><a class="ae ma" href="https://github.com/jenkinsci/kubernetes-plugin/blob/master/src/main/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/samples/windows.groovy" rel="noopener ugc nofollow" target="_blank">kubernetes-windows插件示例</a></p></div></div>    
</body>
</html>