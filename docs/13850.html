<html>
<head>
<title>Terraform: Deploying a 2-Tier Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform:部署2层架构</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/terraform-deploying-a-2-tier-architecture-5d26ae6e3f73?source=collection_archive---------9-----------------------#2022-10-11">https://levelup.gitconnected.com/terraform-deploying-a-2-tier-architecture-5d26ae6e3f73?source=collection_archive---------9-----------------------#2022-10-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d79fc50e7d744c7932c3387d8a923b90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QMk06VBnuiZgumwBJTAGpw.png"/></div></div></figure><h2 id="df2a" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak"> <em class="ku">场景</em> </strong></h2><p id="e398" class="pw-post-body-paragraph kv kw iq kx b ky kz la lb lc ld le lf kh lg lh li kl lj lk ll kp lm ln lo lp ij bi translated">您的团队需要您为您的公司绘制和部署一个双层架构。对于基础项目，你可以将所有代码放在一个带有硬编码数据的<a class="ae lq" href="http://main.tf/" rel="noopener ugc nofollow" target="_blank"> main.tf </a>文件中。</p><ol class=""><li id="460b" class="lr ls iq kx b ky lt lc lu kh lv kl lw kp lx lp ly lz ma mb bi translated">使用CIDR 10.0.0.0/16部署一个VPC，并使用CIDR 10.0.1.0/24和10.0.2.0/24部署两个公共子网。为了实现高可用性，每个公共子网应该位于不同的AZ中。</li><li id="6446" class="lr ls iq kx b ky mc lc md kh me kl mf kp mg lp ly lz ma mb bi translated">使用CIDR“10 . 0 . 3 . 0/24”和“10.0.4.0/24”创建两个专用子网，其中一个子网中有一个RDS MySQL实例(微型)。每个专用子网应该位于不同的AZ中。</li><li id="8aed" class="lr ls iq kx b ky mc lc md kh me kl mf kp mg lp ly lz ma mb bi translated">将流量导向公共子网的负载平衡器。</li><li id="c8c4" class="lr ls iq kx b ky mc lc md kh me kl mf kp mg lp ly lz ma mb bi translated">在每个公共子网中部署1个EC2 t2.micro实例。</li></ol><h2 id="4e7f" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak"> <em class="ku">先决条件</em> </strong></h2><ol class=""><li id="dac8" class="lr ls iq kx b ky kz lc ld kh mh kl mi kp mj lp ly lz ma mb bi translated">安装的地形</li><li id="af32" class="lr ls iq kx b ky mc lc md kh me kl mf kp mg lp ly lz ma mb bi translated">已安装AWS CLI</li><li id="f048" class="lr ls iq kx b ky mc lc md kh me kl mf kp mg lp ly lz ma mb bi translated">GitHub帐户</li><li id="af89" class="lr ls iq kx b ky mc lc md kh me kl mf kp mg lp ly lz ma mb bi translated">地形登记处—<a class="ae lq" href="https://registry.terraform.io/" rel="noopener ugc nofollow" target="_blank">https://registry.terraform.io/</a></li></ol><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/1234a9683cf1b35e2d97545b934da07b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*agQnFWepzrRRXg-ClpF25w.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated"><strong class="bd ka">两层架构</strong></figcaption></figure><p id="d362" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir">定义</strong></p><p id="bc85" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir"><em class="mw">terra form:</em></strong><em class="mw">terra form是一项开源服务，允许您以代码的形式构建基础设施，以供应来自任何基础设施提供商的资源。Terraform通过其应用编程接口(API)在云平台和其他服务上创建和管理资源。提供商使Terraform能够使用可访问的API与几乎任何平台或服务一起工作。</em> <a class="ae lq" href="https://www.terraform.io/intro" rel="noopener ugc nofollow" target="_blank"> <em class="mw">参见文献</em> </a></p><p id="7008" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><em class="mw">核心Terraform工作流程包括三个阶段:</em></p><ul class=""><li id="210f" class="lr ls iq kx b ky lt lc lu kh lv kl lw kp lx lp mx lz ma mb bi translated"><strong class="kx ir"> <em class="mw">写:</em> </strong> <em class="mw">你定义的资源，可能跨多个云提供商和服务。例如，您可以创建一个配置，在虚拟专用云(VPC)网络中的虚拟机上部署一个应用程序，该网络具有安全组和负载平衡器。</em></li><li id="7bcf" class="lr ls iq kx b ky mc lc md kh me kl mf kp mg lp mx lz ma mb bi translated"><strong class="kx ir"> <em class="mw">计划:</em> </strong> <em class="mw"> Terraform创建一个执行计划，描述它将根据现有基础设施和您的配置创建、更新或销毁的基础设施。</em></li><li id="003a" class="lr ls iq kx b ky mc lc md kh me kl mf kp mg lp mx lz ma mb bi translated"><strong class="kx ir"> <em class="mw">应用:</em> </strong> <em class="mw">批准后，Terraform会按照正确的顺序执行建议的操作，并尊重任何资源依赖关系。例如，如果您更新VPC的属性并更改该VPC中的虚拟机数量，Terraform将在扩展虚拟机之前重新创建VPC。</em></li></ul><p id="df02" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir"> <em class="mw">变量:</em> </strong> <em class="mw">输入变量让你定制Terraform模块的各个方面，而不改变模块自己的源代码。该功能允许您在不同的平台配置之间共享模块，使您的模块可组合和可重用。</em></p><p id="24ed" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir"> <em class="mw">资源:</em> </strong> <em class="mw">资源块描述了一个或多个基础设施对象，如虚拟网络、计算实例或更高级别的组件，如DNS记录。</em><strong class="kx ir"><em class="mw"/></strong><a class="ae lq" href="https://www.terraform.io" rel="noopener ugc nofollow" target="_blank"><strong class="kx ir"><em class="mw">参见文档</em> </strong> </a></p><p id="38d4" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">本演练包括构建一个2层架构，并从创建一个VPC到部署ec2实例和一个数据库实例。让我们开始吧。</p><p id="7400" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir">第一步:创建main.tf </strong></p><p id="b545" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">在terraform可以构建任何基础设施之前，它需要将代码存储在配置文件中。</p><p id="ce12" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">这里要用到的文件是<strong class="kx ir">main . TF</strong>file<strong class="kx ir">T27】(<strong class="kx ir">注:</strong> the "。tf”扩展名允许terraform跟踪文件)。</strong></p><p id="4016" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">第一组代码必须显示terraform配置需要哪些提供者。在这种情况下，AWS提供者被指定，它与AWS支持的许多资源进行交互。请记住，在使用提供程序之前，您必须用凭据配置它</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="d136" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir">步骤2:创建VPC(虚拟私有云)和子网</strong></p><p id="09ee" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">我们将创建VPC、2个公共子网和2个私有子网。公共子网和私有子网将位于不同的可用性区域</p><pre class="ml mm mn mo gt na nb nc nd aw ne bi"><span id="cee5" class="jy jz iq nb b gy nf ng l nh ni">VPC CIDR  - 10.0.0.0/16 <br/>Public_sub2a - 10.0.1.0/24 - us-west-2a<br/>Public_sub2b - 10.0.2.0/24 - us-west-2b<br/>Private_sub2a - 10.0.3.0/24 - us-west-2a<br/>Private_sub2b - 10.0.4.0/24 - us-west-2b</span></pre><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="d4f3" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir">步骤3:创建路由表和互联网网关</strong></p><p id="e034" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">下一步是为公共子网创建internet网关和路由表。指定的路由显示流量将通过互联网网关到达互联网</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="3c4f" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir">步骤4:公共子网与路由表的关联</strong></p><p id="898f" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">在这里，我们必须指定每个公共子网的子网id和路由表id。</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="e74c" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir">步骤5:为VPC和RDS MySQL实例创建安全组</strong></p><p id="a3e1" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">我们必须正确设置安全组，以允许入站流量进入将在公共子网中启动的实例，这一点很重要。将为VPC和RDS MySQL实例设置安全组。</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="0f96" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir">步骤6:创建目标组和负载平衡器</strong></p><p id="e15b" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">接下来，我们将创建应用程序负载平衡器和目标组。负载平衡器正在侦听端口80，目标组也必须指定端口80</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="f780" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir">步骤7:创建ec2实例和数据库实例</strong></p><p id="6b5c" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">现在，我们将创建ec2和数据库实例，并在ec2实例中进行一些引导</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="b59a" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">现在真正的乐趣开始了。我们将运行的第一个代码如下所示</p><pre class="ml mm mn mo gt na nb nc nd aw ne bi"><span id="306d" class="jy jz iq nb b gy nf ng l nh ni">terraform init</span></pre><p id="cd10" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">该命令为terraform准备当前工作目录，以运行配置</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/3f8366fc3e6d262a3ae4b3c0c0f3e30f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gux8yLZxFnh4VtaTZXb2Ww.png"/></div></div></figure><p id="02ec" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">下一个命令</p><pre class="ml mm mn mo gt na nb nc nd aw ne bi"><span id="b233" class="jy jz iq nb b gy nf ng l nh ni">terraform validate</span></pre><p id="1db8" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">该代码实际上是一个救命稻草，因为它可以验证您的配置，指出您的资源块中的任何错误或未指定的属性。在分别运行代码后，我得到了很多次这样的结果。现在我们的配置超级有效</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/9de3a2ea75ffc153993184cb3901e7ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VT8v8LoBsGvX1NrAw3yc1g.png"/></div></div></figure><p id="e307" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">之后，我们将运行</p><pre class="ml mm mn mo gt na nb nc nd aw ne bi"><span id="6676" class="jy jz iq nb b gy nf ng l nh ni">terraform plan</span></pre><p id="6662" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">这基本上显示了要执行/部署的每个资源的计划。它允许您在执行配置之前检查计划</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/0b505baffd7dfd5917877702ef7188ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:794/format:webp/1*lpDCVhW-mK_vgfAZNv-w9w.png"/></div></figure><p id="93e7" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">最后</p><pre class="ml mm mn mo gt na nb nc nd aw ne bi"><span id="31b5" class="jy jz iq nb b gy nf ng l nh ni">terraform apply</span></pre><p id="35e3" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">这在地形配置上采取行动来创建资源</p><p id="52ff" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">运行完成后，我们添加了20个资源</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/4c4bf30904631ecf3014c1ee8519ee94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8yBYiunLCUCs39C88SJKow.png"/></div></div></figure><p id="c061" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">让我们导航到AWS控制台，看看我们旋转了什么。我会展示其中的一些</p><p id="8065" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir"> Vpc和子网</strong></p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/36c73cd386c54d7f80d0789ee8b255ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NuMtswT71wa_ke0o3NJO1Q.png"/></div></div></figure><p id="c9c9" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir">带有确认引导的Ec2实例在网页上工作</strong></p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/a68af3d682f847158dd4e386e12f2620.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g_0D0h9Tdtz5rHdMOrW0qg.png"/></div></div></figure><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/34938e7481e1275234ab7e840722586b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3YZ-4bEA1KFXovJ71hMdhw.png"/></div></div></figure><p id="1140" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated"><strong class="kx ir"> RDS MYSQL实例</strong></p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/6160dd7c48f4d2b30123d68f06e7cb1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cE8RIt-WWkD-1iLnfdUH0g.png"/></div></div></figure><p id="a0d5" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">在结束之前，我们将再运行一段代码</p><pre class="ml mm mn mo gt na nb nc nd aw ne bi"><span id="2ea5" class="jy jz iq nb b gy nf ng l nh ni">terraform fmt</span></pre><p id="9c29" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">这基本上将配置重写为可读性和一致性的格式和样式。</p><p id="e03c" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">最后，我们必须使用下面的命令来删除我们创建的所有内容</p><pre class="ml mm mn mo gt na nb nc nd aw ne bi"><span id="3e9e" class="jy jz iq nb b gy nf ng l nh ni">terraform destroy</span></pre><p id="f71d" class="pw-post-body-paragraph kv kw iq kx b ky lt la lb lc lu le lf kh mt lh li kl mu lk ll kp mv ln lo lp ij bi translated">感谢您的阅读。</p></div></div>    
</body>
</html>