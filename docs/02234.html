<html>
<head>
<title>Delete entities of Datastore in bulk with Dataflow implemented in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python实现的数据流批量删除数据存储的实体</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/delete-entities-of-datastore-in-bulk-with-dataflow-implemented-in-python-37cbe2dd7e08?source=collection_archive---------6-----------------------#2020-02-28">https://levelup.gitconnected.com/delete-entities-of-datastore-in-bulk-with-dataflow-implemented-in-python-37cbe2dd7e08?source=collection_archive---------6-----------------------#2020-02-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/9a4623c2df6ee757067a0b833de8d575.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/1*hKJIBTadpeif2w9e50xe5Q.png"/></div></div></figure><p id="4f9b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有时，我们可能需要批量删除Google Cloud Datastore的实体。例如，当客户停止使用我们的服务时，我们可能不得不删除他们在我们的数据存储上的数据。在这种情况下，谷歌云数据流适合批量删除实体，根据<a class="ae kz" href="https://cloud.google.com/datastore/docs/bulk-delete?hl=en" rel="noopener ugc nofollow" target="_blank">这个GCP文档</a>。Dataflow帮助我们开发了一个基于Apache Beam SDK的数据管道。这也支持Java和Python。</p><p id="f5c8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这篇文章中，我将向<strong class="kd iu">介绍一种简单的方法</strong>，用Apache Beam Python SDK在数据流上批量删除实体。然后，我将介绍使用运行时参数运行管道的方法。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="fd55" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">发展环境</h1><p id="1a03" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">本文的示例代码中使用了下面这些python包。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="7be5" class="mt li it mp b gy mu mv l mw mx">REQUIRED_PACKAGES = [<br/>    'apache-beam[gcp]==2.17.0',<br/>    'googledatastore==7.1.0'<br/>]</span></pre><h1 id="14f6" class="lh li it bd lj lk my lm ln lo mz lq lr ls na lu lv lw nb ly lz ma nc mc md me bi translated">带束批量删除实体</h1><p id="45ed" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">在本文中，我使用了在<em class="nd"> datastore.v1new </em>包中实现的模块来删除实体。在这个示例代码中，具有名为“foo”的<em class="nd">名称</em>列的<em class="nd">用户</em>实体将被删除。流水线按照以下步骤执行:</p><ol class=""><li id="2ccb" class="ne nf it kd b ke kf ki kj km ng kq nh ku ni ky nj nk nl nm bi translated">基于查询读取实体</li><li id="009c" class="ne nf it kd b ke nn ki no km np kq nq ku nr ky nj nk nl nm bi translated">把实体转化为自己的钥匙</li><li id="2626" class="ne nf it kd b ke nn ki no km np kq nq ku nr ky nj nk nl nm bi translated">根据关键字删除实体</li></ol><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="a907" class="mt li it mp b gy mu mv l mw mx">import apache_beam as beam<br/>from apache_beam.io.gcp.datastore.v1new.types import Query<br/>from apache_beam.io.gcp.datastore.v1new.datastoreio import ReadFromDatastore, DeleteFromDatastore</span><span id="b8f6" class="mt li it mp b gy ns mv l mw mx">with beam.Pipeline(options=options) as p:<br/>    filters = [("name", "=", "foo")]<br/>    query = Query(kind="User", project=project_id, filters=filters)<br/>    (p<br/>    | "Read" &gt;&gt; ReadFromDatastore(query=query)<br/>    | "ConvertToKey" &gt;&gt; beam.Map(lambda entity: entity.key)<br/>    | "Delete" &gt;&gt; DeleteFromDatastore(project=project_id))</span></pre><h2 id="0c29" class="mt li it bd lj nt nu dn ln nv nw dp lr km nx ny lv kq nz oa lz ku ob oc md od bi translated">用键过滤</h2><p id="7889" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">上面的代码删除了具有特定属性但没有键的实体。如果开发人员希望通过关键字过滤实体，那么<em class="nd"> google.cloud.datastore </em>包中的<em class="nd"> Key </em>类可以实现这一点。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="7de2" class="mt li it mp b gy mu mv l mw mx">from google.cloud.datastore.key import Key<br/>filters = [("__key__", "=", Key("User", element, project=self.project_id))]</span></pre><h2 id="1978" class="mt li it bd lj nt nu dn ln nv nw dp lr km nx ny lv kq nz oa lz ku ob oc md od bi translated">创建模板</h2><p id="f9bc" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">虽然开发人员可以在本地运行管道，但是可以灵活地使用数据流模板。您可以检查<a class="ae kz" href="https://cloud.google.com/dataflow/docs/guides/templates/overview" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><blockquote class="oe of og"><p id="a5f0" class="kb kc nd kd b ke kf kg kh ki kj kk kl oh kn ko kp oi kr ks kt oj kv kw kx ky im bi translated">模板工作流将开发步骤与准备和执行步骤分开。</p></blockquote><p id="d7c7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦创建了模板，就可以通过使用Google Cloud控制台、REST API或gcloud命令行工具使用模板来执行管道。</p><p id="03bf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要创建模板，请使用以下命令。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="4ef8" class="mt li it mp b gy mu mv l mw mx">python pipeline.py --runner DataflowRunner --project [PROJECT] --temp_location gs://[BUCKET]/[PATH]/temp --template_location gs://[BUCKET]/[PATH]/delete_datastore</span></pre><h2 id="35f9" class="mt li it bd lj nt nu dn ln nv nw dp lr km nx ny lv kq nz oa lz ku ob oc md od bi translated">执行模板</h2><p id="f96b" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">若要使用模板运行此管道，请使用以下命令。如前所述，开发人员也可以通过使用谷歌云控制台REST API来运行这个管道。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="52d6" class="mt li it mp b gy mu mv l mw mx">gcloud dataflow jobs run delete_datastore -project [PROJECT] -gcs-location gs://[BUCKET]/[PATH]/delete_datastore -region [REGION]</span></pre><p id="5be6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦在Dataflow UI中创建了作业，它将如下所示。</p><figure class="mk ml mm mn gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ok"><img src="../Images/95b5ad4c1f4d9634a9af9da9812ae562.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ml2bc1Z-T23fkZ0NusrTg.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">删除实体的管道</figcaption></figure><p id="dee2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">很简单吧？Dataflow提供了一种非常简单的批量删除实体的方法。此外，这种删除将在数据流上可伸缩地执行。</p><p id="58bf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面是完整的代码链接:</p><figure class="mk ml mm mn gt ju"><div class="bz fp l di"><div class="op oq l"/></div></figure><h1 id="294a" class="lh li it bd lj lk my lm ln lo mz lq lr ls na lu lv lw nb ly lz ma nc mc md me bi translated">使用运行时参数执行</h1><p id="d94a" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">有时我们需要用运行时参数运行管道。数据流模板可以使用运行时参数。您可以检查<a class="ae kz" href="https://cloud.google.com/dataflow/docs/guides/templates/creating-templates" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><h2 id="130b" class="mt li it bd lj nt nu dn ln nv nw dp lr km nx ny lv kq nz oa lz ku ob oc md od bi translated">带有运行时原语参数</h2><p id="6e40" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">在Python SDK中，<em class="nd">add _ value _ provider _ argument</em>方法<em class="nd"> </em>可以接受运行时参数。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="4719" class="mt li it mp b gy mu mv l mw mx">from apache_beam.options.pipeline_options import PipelineOptions</span><span id="00ca" class="mt li it mp b gy ns mv l mw mx">class DeleteOptions(PipelineOptions):<br/>    <a class="ae kz" href="http://twitter.com/classmethod" rel="noopener ugc nofollow" target="_blank">@classmethod</a><br/>    def _add_argparse_args(cls, parser):<br/>        parser.add_value_provider_argument('--name')</span></pre><p id="5838" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要使用模板和运行时参数运行此管道，请使用以下命令。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="cdb5" class="mt li it mp b gy mu mv l mw mx">gcloud dataflow jobs run delete_datastore -project [PROJECT] -gcs-location gs://[BUCKET]/[PATH]/delete_datastore -region [REGION] -parameters name=foo</span></pre><p id="1b99" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">但是，正如上面的文档中所写的，在执行管道之前，您不能获得运行时参数。</p><blockquote class="oe of og"><p id="23fd" class="kb kc nd kd b ke kf kg kh ki kj kk kl oh kn ko kp oi kr ks kt oj kv kw kx ky im bi translated">您可以使用<code class="fe or os ot mp b">isAccessible()</code>来检查<code class="fe or os ot mp b">ValueProvider</code>的值是否可用。如果在管道执行前调用<code class="fe or os ot mp b">get()</code>，Apache Beam返回错误:<br/> <code class="fe or os ot mp b">Value only available at runtime, but accessed from a non-runtime context.</code></p></blockquote><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="c5fb" class="mt li it mp b gy mu mv l mw mx">def run(argv=None):<br/>    options = DeleteOptions(flags=argv)</span><span id="59ca" class="mt li it mp b gy ns mv l mw mx">    with beam.Pipeline(options=options) as p:<br/><strong class="mp iu">        # This error happens: Value only available at runtime, but accessed from a non-runtime context.<br/></strong>        filters=[("name", "=", options.name)])</span></pre><p id="38fd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，您必须像下面的代码一样在上下文中调用<em class="nd"> get() </em>方法。现在管用了。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="9d1b" class="mt li it mp b gy mu mv l mw mx">with beam.Pipeline(options=options) as p:<br/>    (p<br/>        | "Read" &gt;&gt; ReadFromDatastore(query=Query(kind="User", project=project_id, filters=[("name", "=", options.name)]))<br/>        | "ConvertToKey" &gt;&gt; beam.Map(lambda entity: entity.key)<br/>        | "Delete" &gt;&gt; DeleteFromDatastore(project=project_id))</span></pre><p id="ce3e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">整个代码如下链接:</p><figure class="mk ml mm mn gt ju"><div class="bz fp l di"><div class="op oq l"/></div></figure><h2 id="8a57" class="mt li it bd lj nt nu dn ln nv nw dp lr km nx ny lv kq nz oa lz ku ob oc md od bi translated">使用运行时数组参数</h2><p id="add9" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">让我们考虑一个高级的例子，在这个例子中，管道接受数组运行时参数。不幸的是，<em class="nd"> PipelineOptions </em>不能接受数组值。因此，本文介绍了接受数组运行时参数的另一种方法。在下面的代码中，管道通过以下这些步骤接受数组值:</p><ol class=""><li id="1250" class="ne nf it kd b ke kf ki kj km ng kq nh ku ni ky nj nk nl nm bi translated">管道接受以逗号分隔的<em class="nd">add _ value _ provider _ argument</em>。</li></ol><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="acbb" class="mt li it mp b gy mu mv l mw mx">from apache_beam.options.pipeline_options import PipelineOptions</span><span id="5b7c" class="mt li it mp b gy ns mv l mw mx">class DeletionOptions(PipelineOptions):<br/>    <a class="ae kz" href="http://twitter.com/classmethod" rel="noopener ugc nofollow" target="_blank">@classmethod</a><br/>    def _add_argparse_args(cls, parser):<br/>        # Ex: names=foo,bar<br/>        parser.add_value_provider_argument('--names')</span></pre><p id="db45" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">2.在管道上下文中，此字符串被更改为用逗号分隔的字符串数组。在<em class="nd">展开</em>方法中，<em class="nd"> PBegin </em>对象通过<em class="nd"> </em>调用<em class="nd">impact()</em>方法<em class="nd">、</em>然后<em class="nd"> </em>成为<em class="nd">pccollection</em>在运行时上下文中逗号分隔的字符串。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="4b1c" class="mt li it mp b gy mu mv l mw mx">class SplitNames(PTransform):<br/>    def __init__(self, names_opt):<br/>        self.names_opt = names_opt</span><span id="1ac1" class="mt li it mp b gy ns mv l mw mx">    def expand(self, pbegin):<br/>        import apache_beam as beam<br/>        from apache_beam.transforms import Impulse<br/>        return pbegin | Impulse() | beam.FlatMap(lambda _: self.names_opt.get().split(","))</span></pre><p id="db7b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">3.基于字符串数组，管道删除实体。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="a345" class="mt li it mp b gy mu mv l mw mx">def run(argv=None):<br/>    options = DeleteOptions(flags=argv)</span><span id="7146" class="mt li it mp b gy ns mv l mw mx">    with beam.Pipeline(options=options) as p:<br/>        (p<br/>        | "SplitNames" &gt;&gt; SplitNames(options.names)<br/>        | "Query" &gt;&gt; beam.ParDo(CreateQuery(project_id))<br/>        | "Read" &gt;&gt; beam.ParDo(ReadFromDatastore._QueryFn())<br/>        | "ConvertToKey" &gt;&gt; beam.Map(lambda entity: entity.key)<br/>        | "Delete" &gt;&gt; DeleteFromDatastore(project=project_id))</span><span id="3dce" class="mt li it mp b gy ns mv l mw mx">class CreateQuery(DoFn):<br/>    def __init__(self, project_id):<br/>        self.project_id = project_id</span><span id="0ff1" class="mt li it mp b gy ns mv l mw mx">    def process(self, element):<br/>        from apache_beam.io.gcp.datastore.v1new.types import Query<br/>        filters = [("name", "=", element)]<br/>        return [Query(kind="User", project=self.project_id, filters=filters)]</span></pre><p id="3f46" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要使用以逗号分隔的运行时参数运行此管道，请使用以下命令。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="905c" class="mt li it mp b gy mu mv l mw mx">gcloud dataflow jobs run delete_datastore -project [PROJECT] -gcs-location gs://[BUCKET]/[PATH]/delete_datastore -region [REGION] -parameters=^:^names=foo,bar</span></pre><p id="158b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦在数据流用户界面中创建了作业，它将如下所示。</p><figure class="mk ml mm mn gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ou"><img src="../Images/b0b9d55a2003051d3eb30285f1f87159.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sxYxpyLk0SoOlJflJHLhdw.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">删除具有运行时数组参数的实体的管道</figcaption></figure><p id="98ae" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">整个代码如下链接:</p><figure class="mk ml mm mn gt ju"><div class="bz fp l di"><div class="op oq l"/></div></figure><p id="e644" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我希望本文能对你的工作有所帮助。</p><p id="dc58" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">谢谢你的阅读！</p></div></div>    
</body>
</html>