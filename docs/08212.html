<html>
<head>
<title>Terraform: Staying DRY + Feature Toggling</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">地形:保持干燥+功能切换</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/terraform-staying-dry-feature-toggling-f75cf5660406?source=collection_archive---------7-----------------------#2021-04-11">https://levelup.gitconnected.com/terraform-staying-dry-feature-toggling-f75cf5660406?source=collection_archive---------7-----------------------#2021-04-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/db5d49ba3b6ebb21db60387b03d4aa67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MJZvBb9DnXevtWIU"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@joemania?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">乔·马涅</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="e04d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所有代码都有生命周期。今天的好代码明天可能就是坏代码。这并不是说在代码最初实现时做出了错误的决定，而是有时您根本无法预见您的代码将被要求做什么和支持什么。正因为如此，我经常尝试预先建立良好的模式，希望这些模式能够扩展并为未来的问题提供解决方案。然而，即使仔细考虑，一个常量仍然存在——新代码将被需要，旧代码将被淘汰。</p><p id="b7ea" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据我的经验，处理这个常量的最简单的方法是将您的代码分割成小的/可重用的片段，这些片段可以根据需要方便地管理和交换。</p><p id="db28" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你还没有读过，我强烈建议你读一下<a class="ae kf" href="https://medium.com/dev-genius/terraform-staying-dry-when-using-count-conditionals-2c4f6c15a4ac" rel="noopener"> Terraform:使用计数条件时保持干燥</a>。虽然那篇文章和这篇文章讨论的是同一个主题，但是它们针对不同的问题提供了不同的方法/解决方案。在第一篇文章中，如果你不熟悉“保持干燥”是什么意思，我们也会谈到。</p><p id="a4f6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将在这里讨论的方法不仅允许您保持干燥，而且可以轻松地重用/实例化您的代码，并根据需要打开/关闭特性。您可以以最少的复杂性或文档要求获得所有这些</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="5fc7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我曾经是在自动化中使用布尔的粉丝。在某种程度上，我仍然认为布尔有价值，但是有一天我的一个同事告诉我:“布尔只告诉你一条信息，为什么不让它更有帮助呢”。这相当于问某人“你想吃冰淇淋吗？”。如果他们说是，你将不得不立即跟进另一个问题“你想要什么口味的？”。相反，你可以直接问“你想要什么口味的冰淇淋？”同时得到两个问题的答案。</p><p id="ed46" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用Terraform中的对象地图，您可以做到这一点。这是它的样子:</p><pre class="lp lq lr ls gt lt lo lu lv aw lw bi"><span id="d6cb" class="lx ly it lo b gy lz ma l mb mc">variable "ice_cream_order" {<br/>  type = map(object({<br/>    flavor       = string<br/>    bowl_or_cone = string<br/>    size         = string<br/>    toppings     = list(string)</span><span id="4e0d" class="lx ly it lo b gy md ma l mb mc">}))<br/>}</span></pre><p id="b565" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，不用我说别的，你已经知道点冰淇淋需要什么了。创建的对象定义了预先需要的每一个属性。</p><p id="b67a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我有点言过其实了，但是我想强调一些事情。我们可以仅使用一个对象来完成上述结果。然而，使用对象映射给我们带来了额外的好处，我们可以根据需要多次调用这个代码，而不需要任何其他东西。这是我们点冰淇淋时的样子。</p><pre class="lp lq lr ls gt lt lo lu lv aw lw bi"><span id="07b3" class="lx ly it lo b gy lz ma l mb mc">ice_cream_order = {<br/>  kens = {<br/>    flavor       = chocolate<br/>    bowl_or_cone = cone<br/>    size         = medium<br/>    toppings     = ["whipped cream"]<br/>  }<br/>  billys = {<br/>    flavor       = vanilla<br/>    bowl_or_cone = bowl<br/>    size         = small<br/>    toppings     = ["chocolate chips", "M&amp;Ms"]<br/>  }<br/>  sarahs = {<br/>    flavor       = strawberry<br/>    bowl_or_cone = cone<br/>    size         = large<br/>    toppings     = ["strawberries", "whipped cream"]<br/>  }</span><span id="150b" class="lx ly it lo b gy md ma l mb mc">}</span></pre></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="73da" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了简单起见，我将放弃冰淇淋的类比，假设我们正在配置服务器。我们新的天体图是:</p><pre class="lp lq lr ls gt lt lo lu lv aw lw bi"><span id="1c12" class="lx ly it lo b gy lz ma l mb mc">variable "server_fleet" {<br/>  type = map(object({<br/>    image_name      = string<br/>    server_hostname = string<br/>    instance_type   = string<br/>    ssh_key_name    = string</span><span id="9103" class="lx ly it lo b gy md ma l mb mc">  }))<br/>}</span></pre><p id="90dd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用上面的对象映射，我们的声明如下所示:</p><pre class="lp lq lr ls gt lt lo lu lv aw lw bi"><span id="c5f8" class="lx ly it lo b gy lz ma l mb mc">server_fleet = {<br/>  bastion = {<br/>    image_name      = "Ubuntu"<br/>    server_hostname = "bastion"<br/>    instance_type   = t2.small<br/>    ssh_key_name    = kens-ssh-key<br/>  }<br/>  web = {<br/>    image_name      = "Ubuntu"<br/>    server_hostname = "web-server"<br/>    instance_type   = t3.large<br/>    ssh_key_name    = kens-ssh-key<br/>  }<br/>  db01= {<br/>    image_name      = "Centos"<br/>    server_hostname = "mysql-db01-server"<br/>    instance_type   = t3.4xlarge<br/>    ssh_key_name    = kens-ssh-key<br/>  }<br/>  db02= {<br/>    image_name      = "Centos"<br/>    server_hostname = "mysql-db02-server"<br/>    instance_type   = t3.4xlarge<br/>    ssh_key_name    = kens-ssh-key<br/>  }<br/>}</span></pre><p id="4e47" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，当我们定义创建服务器所需的资源时，我们将使用<code class="fe ll lm ln lo b">for_each</code>遍历每个对象。</p><pre class="lp lq lr ls gt lt lo lu lv aw lw bi"><span id="079c" class="lx ly it lo b gy lz ma l mb mc">resource "aws_security_group" "random_server" {<br/>  for_each = var.server_fleet</span><span id="1d9b" class="lx ly it lo b gy md ma l mb mc">  name        = "${each.value.server_hostname}-security-group"<br/>  description = "Defines access to the ${each.value.server_hostname} server"<br/>  // Truncated</span><span id="9cb9" class="lx ly it lo b gy md ma l mb mc">}</span><span id="aa3f" class="lx ly it lo b gy md ma l mb mc">resource "aws_eip" "random_server" {<br/>  for_each = var.server_fleet</span><span id="0f9b" class="lx ly it lo b gy md ma l mb mc">  instance = aws_instance.random_server[each.key].id<br/>  vpc      = true</span><span id="4372" class="lx ly it lo b gy md ma l mb mc">}</span><span id="c6ec" class="lx ly it lo b gy md ma l mb mc">resource "aws_instance" "random_server" {<br/>  for_each = var.server_fleet</span><span id="54ca" class="lx ly it lo b gy md ma l mb mc">  ami           = each.value.image_name<br/>  instance_type = each.value.instance_type<br/>  key_name      = each.value.ssh_key_name</span><span id="c280" class="lx ly it lo b gy md ma l mb mc">  tags = {<br/>    Name = each.value.server_hostname<br/>  }</span><span id="71ed" class="lx ly it lo b gy md ma l mb mc">  // Truncated</span><span id="c819" class="lx ly it lo b gy md ma l mb mc">}</span></pre><p id="10b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意:我们使用<code class="fe ll lm ln lo b">each.value.PROPERTY</code>引用对象内部的值。</p><p id="b438" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里将发生的是，对于地图中的每个对象，上述所有资源都将被实例化。您将最终拥有四台服务器，每台服务器都有一个安全组和一个EIP(公共IP地址)。这里的好处很多。仅举几个例子:</p><ul class=""><li id="2016" class="me mf it ki b kj kk kn ko kr mg kv mh kz mi ld mj mk ml mm bi translated">您的代码是配置驱动的</li><li id="20ed" class="me mf it ki b kj mn kn mo kr mp kv mq kz mr ld mj mk ml mm bi translated">乍一看，代码很容易理解</li><li id="4349" class="me mf it ki b kj mn kn mo kr mp kv mq kz mr ld mj mk ml mm bi translated">你的代码是枯燥的，因为你不必重复自己。</li><li id="85eb" class="me mf it ki b kj mn kn mo kr mp kv mq kz mr ld mj mk ml mm bi translated">根据您定义的对象，您可以打开/关闭代码的不同部分。(我们将在下面更深入地讨论这个问题)。</li></ul></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="3026" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">举了上面的例子后，我想花一点时间来解决这个问题。使用terraform模块可以很容易地完成上面的特定示例。Terraform模块就其定义而言，允许您对代码进行分组，并根据需要多次实例化它。然而，以上只是演示该方法的一个示例。使用对象是对模块的补充，它们并不互相排斥。</p><p id="9a5e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以上内容的真正美妙之处在于，您可以在更细粒度的级别上获得与模块相同的好处，并且还可以切换特性。</p><p id="a29a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这种方法最擅长的一个例子是，您有一个需要新基础设施资源的新服务。您可以根据是否定义了先决条件对象，在每个环境中切换这些资源。</p><p id="d507" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一个例子是，只有特定的环境需要特定的资源(例如WAF)。最后一个例子是，每个环境需要不同数量的对等连接。</p><p id="48b7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Terraform有多种方法可以解决上述问题，但这是唯一一种100%由配置驱动的方法。您的所有环境都可以使用完全相同的地形，同时干净地适应差异。您还可以通过比较不同环境的配置，轻松看出它们之间的差异。这大大减少了环境漂移。</p><p id="33c1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如何处理异常决定了代码的伸缩性。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="600a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为最后一点，您可以将上述方法用作转换状态的一部分。使用前面的例子:</p><pre class="lp lq lr ls gt lt lo lu lv aw lw bi"><span id="b9e9" class="lx ly it lo b gy lz ma l mb mc">you have a new service that requires new infrastructure resources. You can toggle these resources per environment based on whether the pre-requisite object is defined.</span></pre><p id="d38b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦新服务被部署到所有环境中，您就可以移除这种切换，这样您的代码/配置就更清晰了。</p><p id="7a76" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">同样的方法也适用于贬低资源的情况。向相关代码添加一个开关，并开始一次关闭一个环境的资源。一旦从所有环境中移除了资源，您就可以移除切换并一起删除代码。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="c979" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了获得无限的故事，你还可以考虑注册<a class="ae kf" href="https://blog.rhel.solutions/membership" rel="noopener ugc nofollow" target="_blank"><em class="ms"/></a><em class="ms">成为中等会员，只需5美元。如果您使用</em> <a class="ae kf" href="https://blog.rhel.solutions/membership" rel="noopener ugc nofollow" target="_blank"> <em class="ms">我的链接</em> </a> <em class="ms">注册，我会收到一小笔佣金(无需您额外付费)。</em></p></div></div>    
</body>
</html>