<html>
<head>
<title>Test Windows Ansible Roles On Local libvirt VMs Within Minutes.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在几分钟内测试本地libvirt虚拟机上的Windows Ansible角色。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/test-windows-ansible-roles-on-local-libvirt-vms-within-minutes-e5dfa031bc4?source=collection_archive---------16-----------------------#2022-08-03">https://levelup.gitconnected.com/test-windows-ansible-roles-on-local-libvirt-vms-within-minutes-e5dfa031bc4?source=collection_archive---------16-----------------------#2022-08-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="4f19" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">ansi ble | Testing | libvirt | Windows | KVM</h2><div class=""/><div class=""><h2 id="dbe2" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">在几分钟内启动Windows虚拟机，测试您的可行角色。</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/7ea69655f20529e00b44bbbf3a21945d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WWN4LquYZSOv5ixLd3CeaQ.jpeg"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">杰夫·哈迪在<a class="ae lh" href="https://unsplash.com/s/photos/windows-computer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="8096" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果你还没有看过，也可以看看我之前写的关于用Molecule测试角色的文章。</p><div class="me mf gp gr mg mh"><a href="https://betterprogramming.pub/testing-ansible-roles-locally-with-molecule-on-linux-and-windows-a0903ec92496" rel="noopener  ugc nofollow" target="_blank"><div class="mi ab fo"><div class="mj ab mk cl cj ml"><h2 class="bd jd gy z fp mm fr fs mn fu fw jc bi translated">在Linux和Windows上用Molecule在本地测试角色</h2><div class="mo l"><h3 class="bd b gy z fp mm fr fs mn fu fw dk translated">加快您的开发周期，满怀信心地发布</h3></div><div class="mp l"><p class="bd b dl z fp mm fr fs mn fu fw dk translated">better编程. pub</p></div></div><div class="mq l"><div class="mr l ms mt mu mq mv lb mh"/></div></div></a></div></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="6471" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">在15分钟内为虚拟机准备好映像</h1><p id="b7b1" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">这是一个简单的指南，可以让Windows虚拟机在几分钟内运行，以测试您的角色。</p><p id="9d5a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我发布的Ansible角色允许您通过无人值守安装“从头开始”创建Windows虚拟机。虽然这是完全可复制的，并且非常有效，但是从CD启动，运行安装程序，重新启动系统，直到Ansible最终可以在上面运行角色，显然需要花费很长时间(大约5分钟)。</p><p id="d838" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">因此，本指南分为两个步骤，第一步:从头开始创建虚拟机，为此您需要上述耐心；第二步:保存虚拟机的映像，以便用它来更快地启动未来的测试虚拟机。</p><div class="me mf gp gr mg mh"><a href="https://github.com/DrPsychick/ansible-testing" rel="noopener  ugc nofollow" target="_blank"><div class="mi ab fo"><div class="mj ab mk cl cj ml"><h2 class="bd jd gy z fp mm fr fs mn fu fw jc bi translated">GitHub-DrPsychick/ansible-testing:一个ansi ble角色，允许为…</h2><div class="mo l"><h3 class="bd b gy z fp mm fr fs mn fu fw dk translated">允许创建SystemD实例来测试角色的一个角色</h3></div><div class="mp l"><p class="bd b dl z fp mm fr fs mn fu fw dk translated">github.com</p></div></div><div class="mq l"><div class="oa l ms mt mu mq mv lb mh"/></div></div></a></div></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="9dc8" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">创建无人值守安装的虚拟机</h1><p id="bc04" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">创建一个角色并从<code class="fe ob oc od oe b">DrPsychick/ansible-testing</code>下载示例<code class="fe ob oc od oe b">libvirt</code>配置:</p><pre class="ks kt ku kv gt of oe og oh aw oi bi"><span id="a36d" class="oj ne it oe b gy ok ol l om on">molecule init role demo.testrole<br/>cd testrole<br/>molecule init scenario libvirt</span><span id="52bc" class="oj ne it oe b gy oo ol l om on">for f in create destroy molecule requirements vars; do<br/>  curl -o molecule/libvirt/$f.yml https://raw.githubusercontent.com/DrPsychick/ansible-testing/master/docs/molecule/libvirt/$f.yml<br/>done</span></pre><p id="5523" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">调整<code class="fe ob oc od oe b">molecule/libvirt</code>中的配置，定义您想要测试的Windows版本。您在此处定义的管理员密码将被保存到映像中。</p><p id="0288" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><code class="fe ob oc od oe b">vars.yml</code></p><pre class="ks kt ku kv gt of oe og oh aw oi bi"><span id="febb" class="oj ne it oe b gy ok ol l om on">virtual_machines:<br/>  - name: "windows2016"<br/>    password: "Ecoo6pev"<br/>    os: "windows"<br/>    isos:<br/>      - name: "WindowsServer2016.iso"<br/>        dev: sda<br/>      - name: "virtio-win.iso"<br/>        dev: sdb<br/>      - name: "scripts-windows2016.iso"<br/>        dev: sdc<br/>    disk_size: 20G<br/>    image_index: 2<br/>    drivers:<br/>      - 'E:\amd64\2k16'<br/>      - 'E:\NetKVM\2k16\amd64'<br/>      - 'E:\Balloon\2k16\amd64'<br/>    mac: "02:00:00:00:13:37"<br/>    vnc_port: 56682</span></pre><p id="86f8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果您更改了虚拟机的名称，不要忘记相应地调整<code class="fe ob oc od oe b">molecule.yml</code>:</p><pre class="ks kt ku kv gt of oe og oh aw oi bi"><span id="f7c9" class="oj ne it oe b gy ok ol l om on">[...]<br/>platforms:<br/>  - name: windows2016<br/>[...]</span></pre><p id="f10c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在创建VM之前，您需要从公共资源下载适当的ISO文件，因为它们不包含在角色中，请参见<a class="ae lh" href="https://github.com/DrPsychick/ansible-testing#test-with-windows-vms" rel="noopener ugc nofollow" target="_blank">https://github . com/drpsycick/ansi ble-testing # test-with-windows-VMs</a></p><p id="ba64" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在运行<code class="fe ob oc od oe b">molecule create -s libvirt</code>，等待虚拟机启动并运行。您可以通过已配置的<code class="fe ob oc od oe b">vnc_port</code>上的VNC连接到虚拟机来观察进度。如果您得到一个<code class="fe ob oc od oe b">sudo: a password is required</code>错误，运行<code class="fe ob oc od oe b">sudo echo</code>然后再试一次。</p><p id="6390" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">完成所有检查后，关闭虚拟机:<code class="fe ob oc od oe b">sudo virsh shutdown windows2016</code>。</p><h1 id="f3ce" class="nd ne it bd nf ng op ni nj nk oq nm nn ki or kj np kl os km nr ko ot kp nt nu bi translated">保存图像以备后用</h1><p id="0c0d" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">现在，创建一个现成图像的zip文件。这需要几分钟时间。图像必须具有实例的名称，并且存储在没有路径的zip文件中。</p><pre class="ks kt ku kv gt of oe og oh aw oi bi"><span id="9921" class="oj ne it oe b gy ok ol l om on">(cd /var/lib/libvirt/images; zip windows2016-clean.zip windows2016.qcow2)</span></pre><p id="fae2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">将zip文件移动到<code class="fe ob oc od oe b">iso_dir</code>，以便<code class="fe ob oc od oe b">DrPsychick/ansible-testing</code>角色可以找到它并将其用于新的虚拟机。</p><pre class="ks kt ku kv gt of oe og oh aw oi bi"><span id="2d15" class="oj ne it oe b gy ok ol l om on">cd /var/lib/libvirt/images<br/>mv windows2016-clean.zip ../isos/</span></pre><h1 id="fab1" class="nd ne it bd nf ng op ni nj nk oq nm nn ki or kj np kl os km nr ko ot kp nt nu bi translated">配置ansible-testing以使用压缩图像</h1><p id="c2db" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">销毁分子场景进行清理:<code class="fe ob oc od oe b">molecule destroy -s libvirt</code>，这将删除原来的VM磁盘镜像。</p><p id="d3fd" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在将<code class="fe ob oc od oe b">vars.yml</code>中的定义改为使用压缩图像:</p><pre class="ks kt ku kv gt of oe og oh aw oi bi"><span id="53ad" class="oj ne it oe b gy ok ol l om on">virtual_machines:<br/>  - name: "windows2016"<br/>    password: "Ecoo6pev"<br/>    os: "windows"<br/>    disk_image: "windows2016-clean.zip"<br/>    mac: "02:00:00:00:13:37"<br/>    vnc_port: 56682</span></pre><p id="08f3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">你完了！</p><p id="d1c4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">当您现在运行<code class="fe ob oc od oe b">molecule create -s libvirt</code>时，您会注意到Windows实例是如何在不到两分钟的时间内出现的，并且可以通过WinRM直接访问。所以创建实例至少比快一倍。</p><p id="0822" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">万一您在远程Linux机器上运行Molecule，如果需要，您可以简单地执行SSH端口转发来连接到VNC:</p><pre class="ks kt ku kv gt of oe og oh aw oi bi"><span id="8998" class="oj ne it oe b gy ok ol l om on">ssh -L &lt;vnc_port&gt;:localhost:&lt;vnc_port&gt; user@remote-machine<br/># now connect with VNC to localhost:&lt;vnc_port&gt;</span></pre><h2 id="395f" class="oj ne it bd nf ou ov dn nj ow ox dp nn lr oy oz np lv pa pb nr lz pc pd nt iz bi translated">参考资料:</h2><div class="me mf gp gr mg mh"><a href="https://github.com/DrPsychick/ansible-testing" rel="noopener  ugc nofollow" target="_blank"><div class="mi ab fo"><div class="mj ab mk cl cj ml"><h2 class="bd jd gy z fp mm fr fs mn fu fw jc bi translated">GitHub—DrPsychick/ansible-testing:一个允许为…创建SystemD实例的ansi ble角色</h2><div class="mo l"><h3 class="bd b gy z fp mm fr fs mn fu fw dk translated">一个允许创建SystemD实例来测试角色的角色——用于分子…</h3></div><div class="mp l"><p class="bd b dl z fp mm fr fs mn fu fw dk translated">github.com</p></div></div><div class="mq l"><div class="pe l ms mt mu mq mv lb mh"/></div></div></a></div><div class="me mf gp gr mg mh"><a href="https://molecule.readthedocs.io/en/latest/" rel="noopener  ugc nofollow" target="_blank"><div class="mi ab fo"><div class="mj ab mk cl cj ml"><h2 class="bd jd gy z fp mm fr fs mn fu fw jc bi translated">易变分子——分子文件</h2><div class="mo l"><h3 class="bd b gy z fp mm fr fs mn fu fw dk translated">Molecule只支持Ansible的最新两个主要版本(N/N-1)，也就是说如果最新版本是2.9.x…</h3></div><div class="mp l"><p class="bd b dl z fp mm fr fs mn fu fw dk translated">分子. readthedocs.io</p></div></div><div class="mq l"><div class="pf l ms mt mu mq mv lb mh"/></div></div></a></div><div class="me mf gp gr mg mh"><a href="https://drpsychick.org/drpsychick-on-the-web-a9ccfb0df17e" rel="noopener  ugc nofollow" target="_blank"><div class="mi ab fo"><div class="mj ab mk cl cj ml"><h2 class="bd jd gy z fp mm fr fs mn fu fw jc bi translated">网上心理咨询</h2><div class="mo l"><h3 class="bd b gy z fp mm fr fs mn fu fw dk translated">我所在的所有网站的一个简单的“登陆页”。</h3></div><div class="mp l"><p class="bd b dl z fp mm fr fs mn fu fw dk translated">drpsychick.org</p></div></div><div class="mq l"><div class="pg l ms mt mu mq mv lb mh"/></div></div></a></div><h2 id="9fc2" class="oj ne it bd nf ou ov dn nj ow ox dp nn lr oy oz np lv pa pb nr lz pc pd nt iz bi translated">谢谢大家！</h2><p id="cf42" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">…为了您的时间和兴趣！</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><pre class="ks kt ku kv gt of oe og oh aw oi bi"><span id="7fab" class="oj ne it oe b gy ok ol l om on"><strong class="oe jd">Want to Connect?</strong></span><span id="bab4" class="oj ne it oe b gy oo ol l om on">If you want to support me, sign up for Medium through my membership link: <a class="ae lh" href="https://drpsychick.org/membership" rel="noopener ugc nofollow" target="_blank"><em class="ph">https://drpsychick.org/membership</em></a> or visit me on GitHub.</span></pre></div></div>    
</body>
</html>