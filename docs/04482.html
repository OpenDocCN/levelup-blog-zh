<html>
<head>
<title>Automating Android Games with Python &amp; Pytesseract: Sudoku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python和Pytesseract自动化Android游戏:数独</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/automating-android-games-with-python-pytesseract-sudoku-c25b811d5e8a?source=collection_archive---------8-----------------------#2020-06-29">https://levelup.gitconnected.com/automating-android-games-with-python-pytesseract-sudoku-c25b811d5e8a?source=collection_archive---------8-----------------------#2020-06-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/17218dd51d0cc4de0a2fb0c0c85e686d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PqHyA8Rst-nk0urWpc3ckw.jpeg"/></div></div></figure><h1 id="a01d" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">介绍</h1><p id="e94b" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">我做了一个Python脚本来自动化Android上的数独游戏，之前我在Youtube上看了<a class="ae lx" href="https://www.youtube.com/channel/UCrUL8K81R4VBzm-KOYwrcxQ" rel="noopener ugc nofollow" target="_blank"> Engineer Man的视频</a>对不同的游戏做了同样的事情。</p><p id="c585" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">该脚本可以分为5个部分</p><ol class=""><li id="2598" class="md me it lb b lc ly lg lz lk mf lo mg ls mh lw mi mj mk ml bi translated">使用ADB连接到Android设备，并从中获取游戏截图</li><li id="0b3b" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw mi mj mk ml bi translated">使用<a class="ae lx" href="https://pypi.org/project/Pillow/" rel="noopener ugc nofollow" target="_blank">抱枕</a>为<a class="ae lx" href="https://pypi.org/project/pytesseract/" rel="noopener ugc nofollow" target="_blank">宇宙魔方</a>处理截图</li><li id="f4c8" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw mi mj mk ml bi translated">使用<a class="ae lx" href="https://pypi.org/project/pytesseract/" rel="noopener ugc nofollow" target="_blank">pytesserac</a>将数独游戏网格提取到Python中的2D列表中。</li><li id="1533" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw mi mj mk ml bi translated">解决数独游戏</li><li id="19c1" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw mi mj mk ml bi translated">使用Python将求解的输入发送到您的Android设备</li></ol><p id="05b8" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">在这5个主题中，我将主要关注第2、3和5个，因为第1和第4个主题已经被广泛涉及。</p><p id="d9b8" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">链接到我自动化的游戏:<a class="ae lx" href="https://play.google.com/store/apps/details?id=com.quarzo.sudoku" rel="noopener ugc nofollow" target="_blank">https://play.google.com/store/apps/details?id=com.quarzo.sudoku </a></p><p id="7e6f" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">完整的代码可从以下存储库中获得:</p><p id="d632" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><a class="ae lx" href="https://github.com/haideralipunjabi/sudoku_automate" rel="noopener ugc nofollow" target="_blank">Github:haideralipunjabi/sudoku _ automate</a></p><p id="ebdf" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">您还可以观看脚本的运行:</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><h1 id="12fc" class="kb kc it bd kd ke ne kg kh ki nf kk kl km ng ko kp kq nh ks kt ku ni kw kx ky bi translated">使用的库</h1><ul class=""><li id="5acd" class="md me it lb b lc ld lg lh lk nj lo nk ls nl lw nm mj mk ml bi translated"><a class="ae lx" href="https://pypi.org/project/Pillow/" rel="noopener ugc nofollow" target="_blank">枕头</a></li><li id="4766" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw nm mj mk ml bi translated"><a class="ae lx" href="https://pypi.org/project/pure-python-adb/" rel="noopener ugc nofollow" target="_blank">纯python-adb </a></li><li id="da49" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw nm mj mk ml bi translated"><a class="ae lx" href="https://pypi.org/project/pytesseract/" rel="noopener ugc nofollow" target="_blank">宇宙魔方</a></li><li id="a418" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw nm mj mk ml bi translated"><a class="ae lx" href="https://pypi.org/project/progress/" rel="noopener ugc nofollow" target="_blank">进度</a></li></ul></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><h1 id="3b0d" class="kb kc it bd kd ke ne kg kh ki nf kk kl km ng ko kp kq nh ks kt ku ni kw kx ky bi translated">辅导的</h1><h2 id="f036" class="nn kc it bd kd no np dn kh nq nr dp kl lk ns nt kp lo nu nv kt ls nw nx kx ny bi translated">第1 (a)条。使用ADB连接到您的设备</h2><p id="0cd7" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">互联网上的大多数教程使用有线ADB，这阻碍了许多人使用这种方法。我将使用无线ADB，这不是很难设置。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/358e4f9cdf6eabf23ddee4945c103647.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Lvp4vd5KCoP42peg.png"/></div></div></figure><ol class=""><li id="f2e1" class="md me it lb b lc ly lg lz lk mf lo mg ls mh lw mi mj mk ml bi translated">转到您的手机设置&gt;系统&gt;开发者选项(这可能会因手机不同而有所差异，因此如果在您的中有所不同，请在互联网上查找)</li><li id="1ce3" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw mi mj mk ml bi translated">通过网络打开Android调试和ADB。</li><li id="56cd" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw mi mj mk ml bi translated">请注意ADB over Network下显示的IP地址和端口</li><li id="b128" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw mi mj mk ml bi translated">在你的电脑上安装亚洲开发银行</li><li id="3848" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw mi mj mk ml bi translated">进入命令行/命令提示符，输入<br/> adb connect &lt; ip地址&gt; : &lt; port &gt; <br/>使用第3步中的ip地址和端口</li><li id="85f6" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw mi mj mk ml bi translated">首次连接时，您需要在手机上授权连接。</li><li id="edc8" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw mi mj mk ml bi translated">您的设备应通过WiFi连接到您的电脑。</li></ol><h2 id="4123" class="nn kc it bd kd no np dn kh nq nr dp kl lk ns nt kp lo nu nv kt ls nw nx kx ny bi translated">第1款(b)项。使用ADB和Python ( <a class="ae lx" href="https://pypi.org/project/pure-python-adb/" rel="noopener ugc nofollow" target="_blank"> pure-python-adb </a>)</h2><p id="c69c" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">您可以使用Python定义以下函数来连接到与您的计算机相连的第一台ADB设备</p><pre class="mr ms mt mu gt oa ob oc od aw oe bi"><span id="cad6" class="nn kc it ob b gy of og l oh oi">from ppadb.client import Client</span><span id="33f4" class="nn kc it ob b gy oj og l oh oi">def connect_device():<br/>    adb = Client(host='127.0.0.1',port=5037)<br/>    devices = adb.devices()</span><span id="556b" class="nn kc it ob b gy oj og l oh oi">    if len(devices) == 0:<br/>        print("No Devices Attached")<br/>        quit()<br/>    return devices[0]</span></pre><p id="1715" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">我们稍后将使用该函数返回一个<code class="fe ok ol om ob b">ppadb.device.Device</code>实例，该实例将用于截图，并将输入发送到您的设备。</p><h2 id="a944" class="nn kc it bd kd no np dn kh nq nr dp kl lk ns nt kp lo nu nv kt ls nw nx kx ny bi translated">1 c .截图并保存</h2><p id="fecd" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated"><a class="ae lx" href="https://pypi.org/project/pure-python-adb/" rel="noopener ugc nofollow" target="_blank"> pure-python-adb </a>让捕捉你的设备截图变得非常容易。<code class="fe ok ol om ob b">screencap</code>函数就是你获取截图所需要的全部。使用Pythons文件IO保存到<code class="fe ok ol om ob b">screen.png</code></p><pre class="mr ms mt mu gt oa ob oc od aw oe bi"><span id="5551" class="nn kc it ob b gy of og l oh oi">def take_screenshot(device):<br/>    image = device.screencap()<br/>    with open('screen.png', 'wb') as f:<br/>        f.write(image)</span></pre><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/1073210455330223ef37f4a3ef23dfae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aXx2yJjzSyqOqzqC.png"/></div></div></figure><h2 id="0e81" class="nn kc it bd kd no np dn kh nq nr dp kl lk ns nt kp lo nu nv kt ls nw nx kx ny bi translated">2.用<a class="ae lx" href="https://pypi.org/project/Pillow/" rel="noopener ugc nofollow" target="_blank">枕头</a>处理截图</h2><p id="f490" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">在抓取的截图中，任何OCR的准确率都会很低。为了提高准确性，我使用了<a class="ae lx" href="https://pypi.org/project/Pillow/" rel="noopener ugc nofollow" target="_blank"> Pillow </a>来处理截图，以便它只在白色背景上以黑色显示数字。</p><p id="72eb" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">为此，我们首先使用<code class="fe ok ol om ob b">image.convert('L')</code>将图像转换为灰度(或单通道)。这将使颜色转换为灰色阴影(0-255)。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/2f1502c630d9db593d330bd2a3fdbe6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wSm6Dq_A6UQm_ii-.png"/></div></div></figure><p id="4ba4" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">在此之后，我们需要黑色的数字(最暗的，或非常接近黑色的)，其余的是白色的。为此，我们使用<code class="fe ok ol om ob b">image.point()</code>使所有的灰色&gt; 50变成白色(255)，其余的(数字)变成0。为了安全起见，我还增加了一点对比度和清晰度。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/c93dcb520fce1f9b40585c2d8fdef74a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X0OaiqhBjQLMaMki.png"/></div></div></figure><pre class="mr ms mt mu gt oa ob oc od aw oe bi"><span id="58b0" class="nn kc it ob b gy of og l oh oi">def process_image(image):<br/>    image = image.convert('L')<br/>    image = image.point(lambda x: 255 if x &gt; 50 else 0, mode='L')<br/>    image = ImageEnhance.Contrast(image).enhance(10)<br/>    image = ImageEnhance.Sharpness(image).enhance(2)<br/>    return image</span></pre><h2 id="c7a6" class="nn kc it bd kd no np dn kh nq nr dp kl lk ns nt kp lo nu nv kt ls nw nx kx ny bi translated">3.使用<a class="ae lx" href="https://pypi.org/project/pytesseract/" rel="noopener ugc nofollow" target="_blank"> pytesseract </a>从图像中提取数字</h2><p id="f516" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">在整个图像上使用<a class="ae lx" href="https://pypi.org/project/pytesseract/" rel="noopener ugc nofollow" target="_blank"> pytesseract </a>可能会给我们数字，但它不会告诉我们数字出现在哪个盒子里。因此，我使用<a class="ae lx" href="https://pypi.org/project/Pillow/" rel="noopener ugc nofollow" target="_blank">枕头</a>来裁剪每个框，然后在裁剪后的图像上使用<a class="ae lx" href="https://pypi.org/project/pytesseract/" rel="noopener ugc nofollow" target="_blank">立方体</a>。在使用<a class="ae lx" href="https://pypi.org/project/pytesseract/" rel="noopener ugc nofollow" target="_blank">pytesserac</a>之前，我定义了一些函数来给我每个盒子的坐标，并给我每个盒子的裁剪图像。</p><p id="247e" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">因为数独有一个9x9的网格，所以我使用两个从0到8的for循环来遍历每个盒子。默认配置下的<a class="ae lx" href="https://pypi.org/project/pytesseract/" rel="noopener ugc nofollow" target="_blank"> pytesseract </a>不够精确，我不得不通过配置<code class="fe ok ol om ob b">--psm 10 --oem 0</code>。</p><ul class=""><li id="d717" class="md me it lb b lc ly lg lz lk mf lo mg ls mh lw nm mj mk ml bi translated"><code class="fe ok ol om ob b">--psm</code>参数定义了页面分段方法。<code class="fe ok ol om ob b">10</code>代表<code class="fe ok ol om ob b">Treat the image as a single character</code>。这似乎是最合适的，因为我传递的是每个盒子的裁剪图像。</li><li id="0957" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw nm mj mk ml bi translated"><code class="fe ok ol om ob b">--oem</code>参数定义了OCR引擎模式。<code class="fe ok ol om ob b">0</code>代表<code class="fe ok ol om ob b">Legacy Engine Only</code>。</li></ul><p id="3e57" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">下面的函数将从传递的<code class="fe ok ol om ob b">image</code>中提取数字，并返回一个包含数字的9x9 2D列表。</p><pre class="mr ms mt mu gt oa ob oc od aw oe bi"><span id="11f4" class="nn kc it ob b gy of og l oh oi">def get_grid_from_image(image):<br/>    grid = []<br/>    bar = Bar("Processing: ", max=81)<br/>    for i in range(9):<br/>        row = []<br/>        for j in range(9):<br/>            digit = pytesseract.image_to_string(<br/>                get_box(image, i, j), config='--psm 10 --oem 0')<br/>            if digit.isdigit():     # If pytesseract returned a digit<br/>                row.append(int(digit))<br/>            else:<br/>                row.append(0)<br/>            bar.next()<br/>        grid.append(row)<br/>    return grid</span></pre><h2 id="9e30" class="nn kc it bd kd no np dn kh nq nr dp kl lk ns nt kp lo nu nv kt ls nw nx kx ny bi translated">4.解决数独游戏</h2><p id="0dd0" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">现在我们有了9x9数独，我们需要解决它。解数独是一个已经涉及很多的话题，我也是从<a class="ae lx" href="https://www.geeksforgeeks.org/" rel="noopener ugc nofollow" target="_blank">geeksforgeeks.org</a>那里复制了这段代码。</p><p id="eede" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><a class="ae lx" href="https://www.geeksforgeeks.org/sudoku-backtracking-7/" rel="noopener ugc nofollow" target="_blank">这是geekforgeeks关于数独的文章</a></p><h2 id="a312" class="nn kc it bd kd no np dn kh nq nr dp kl lk ns nt kp lo nu nv kt ls nw nx kx ny bi translated">5.使用Python将求解的输入发送到您的Android设备</h2><p id="e474" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">为了发送输入，我首先从解出的数独网格中过滤出输入，也就是说，只发送丢失的值。我使用前面的<code class="fe ok ol om ob b">get_coords</code>函数得到每个盒子的坐标，然后计算它们的中心。我使用亚洲开发银行在该中心发送了一个联系人，然后发送了解决方案。</p><pre class="mr ms mt mu gt oa ob oc od aw oe bi"><span id="4398" class="nn kc it ob b gy of og l oh oi">def automate_game(org_grid, solved_grid):<br/>    for i in range(9):<br/>        for j in range(9):<br/>            if org_grid[i][j] == 0:     # If the box was blank in the game<br/>                x1, y1, x2, y2 = get_coords(i, j)<br/>                center = (x1 + (x2 - x1)/2, y1 + (y2-y1)/2)     # Calculating the center of the box (to select it)<br/>                solution = solved_grid[i][j]<br/>                device.shell(<br/>                    f'input touchscreen swipe {center[0]} {center[1]} {center[0]} {center[1]} 5')<br/>                device.shell(f'input text {solution}')</span></pre><h2 id="2ada" class="nn kc it bd kd no np dn kh nq nr dp kl lk ns nt kp lo nu nv kt ls nw nx kx ny bi translated">运行代码</h2><p id="ffdb" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">我写的所有代码都在函数中，它们被一个一个地调用。注意，我在步骤3中得到的网格没有直接传递到步骤4。我使用<code class="fe ok ol om ob b">deepcopy</code>来创建它的一个副本，这样我就可以将已求解的网格与步骤5中未求解的/原始的网格进行比较。</p><pre class="mr ms mt mu gt oa ob oc od aw oe bi"><span id="85ba" class="nn kc it ob b gy of og l oh oi">if __name__ == "__main__":<br/>    # Connect the device using ADB<br/>    device = adb.connect_device()<br/>    # Take Screenshot of the screen and save it in screen.png<br/>    adb.take_screenshot(device)<br/>    image = Image.open('screen.png')<br/>    image = process_image(image)        # Process the image for OCR<br/>    org_grid = get_grid_from_image(image)      # Convert the Image to 2D list using OCR / Pytesseract<br/>    solved_grid = deepcopy(org_grid)        # Deepcopy is used to prevent the function from modifying the original sudoku game<br/>    solve_sudoku(solved_grid)<br/>    automate_game(org_grid, solved_grid)        # Input the solved game into your device</span></pre><h1 id="9a68" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">参考</h1><ul class=""><li id="3456" class="md me it lb b lc ld lg lh lk nj lo nk ls nl lw nm mj mk ml bi translated"><a class="ae lx" href="https://www.youtube.com/channel/UCrUL8K81R4VBzm-KOYwrcxQ" rel="noopener ugc nofollow" target="_blank">工程师男的Youtube </a></li><li id="d168" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw nm mj mk ml bi translated"><a class="ae lx" href="https://ai-facets.org/tesseract-ocr-best-practices/" rel="noopener ugc nofollow" target="_blank"> Tesseract OCR最佳实践—ai-facets.org</a></li><li id="acc6" class="md me it lb b lc mm lg mn lk mo lo mp ls mq lw nm mj mk ml bi translated"><a class="ae lx" href="https://developer.android.com/studio/command-line/adb#wireless" rel="noopener ugc nofollow" target="_blank">亚行—通过无线网络连接</a></li></ul></div></div>    
</body>
</html>