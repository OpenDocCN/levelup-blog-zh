# 如何调试你无权访问的程序

> 原文：<https://levelup.gitconnected.com/how-to-debug-a-program-you-dont-have-access-to-ba14b45ab6ae>

## 一旦可以工作，在黑盒中修复 bug 是非常有趣的

![](img/378e33aba9f95e838361d01c93ffcfe5.png)

错综复杂的探险家在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

今天，我想到了我最喜欢的“编程传奇”之一，这很可能是一个都市神话——以及我自己版本的需要调试的黑盒系统。

城市的神话是来自乌克兰的放射性火车车厢导致了计算机系统的错误，你可以在这里[读到它。](https://www.jakepoz.com/debugging-behind-the-iron-curtain/)

# 理解黑盒系统以及它们在现代生活中的作用

黑盒是编程中的一个常见概念，它假设你站在系统之外，甚至只是一个你不能直接访问代码的组件。这可能来自几个不同的因素:

*   你使用的是第三方软件，他们根本不会给出代码。
*   您可以在外部或内部与 API 进行交互，实际的逻辑被抽象出来。
*   您没有访问 Git 存储库所需的用户权限。
*   由于复杂性，即使是完全可访问的系统也可能成为事实上的黑箱。
*   你面对的是突然失去一个掌握所有关键和知识的同事。
*   遗留系统由“它总是工作的”组成。如果可能的话，服务器上的 dll 根本没有连接到版本控制，甚至需要反编译才能查看任何代码。

所有这些因素归结起来就是你手头有一个问题，而这个问题不是你能立即解决的，但是不管是谁，除非他们知道错误是什么，否则他们都无能为力。所以你需要投入工作。

# 我们自己的问题是所有这些的混合

上面的列表可能并不详尽，因为它是对我们的情况起作用的因素的直接列表。我们有一个刚被解雇的开发人员，这是一个复杂的系统，广泛分布在各种服务器上，有一个主。dll，并“做了这件事”，即使没有人真正知道为什么和到底是什么。

它调用第三方服务，几乎没有日志记录，我们仅有的备份是文件系统存储。没有任何代码。现在，所有这些都是不可维护的，因为你可能会说，整个系统在适当的时候被重写——但这个错误是紧急的，需要修复。

我们可以说，在大多数情况下，它做的大多是正确的事情，在某种程度上，如果结果是一致的，我们可以接受这种不完整的结果。然而，每一百组左右的数据结果都是错误的，我们所能做的就是从外部调试它——回想起来真是太有趣了。

这是我非常感谢我成长的那个混乱的世界的一个例子，因为大多数公司不会面临如此严重的问题，也不会让一个刚毕业的学生去做这件事。我很幸运，更幸运的是有经验丰富的开发人员在整个过程中指导我。这是我们的终极方法。

# 重现错误(最好有多个测试用例)

当你知道实际的错误是什么的时候，问题就差不多解决了——但是当错误处于一个短暂的状态时，要达到这一点是非常困难的。再想象一下火车的例子，如果他们不能建立一个模式，祝你好运。因为这就是你在这种状态下要寻找的东西，一种什么时候出了问题以及如何出问题的模式。

在我们的案例中，我们相对容易，我们知道我们收到的错误的类型，并且它重复发生，尽管如此罕见，以至于我们花了相当多的时间来缩小案例范围并理解它们。

但是当你有了一组你知道会失败，并且会重复失败的测试用例时，你就可以开始实际的调试部分了。为了给大家举一个不同过程的例子，我们通过模式匹配缩小了源的范围，下面是当我们的一个系统每隔一周的星期四晚上都出现故障，而日志文件中没有任何奇怪的内容时的过程:

*   我们可以说我们的系统没有产生错误信息，但是它关闭了。
*   我们匹配事件，直到我们确定这发生在星期四，而不是其他日子，在晚上没有人工作的时候。
*   我们确保在此期间没有安排自动更新，检查了在同一台服务器上运行的所有自动任务——什么都没有。
*   我们查看了系统在元级别上实际做了什么，最终将范围缩小到一个共享驱动器上的超时，当我们的服务运行时，一个在完全不同的服务器上运行的大型清理任务每两周访问一次该共享驱动器。没有人想到这一点，但他们都在凌晨 3 点开始跑步

# 建立测试环境(即使是在生产环境中)

一旦你有了一系列的错误，你就可以开始研究真正的原因和解决方案——为此你需要一个测试系统。

我的意思是你需要两个常数:

*   您使用的数据不会被其他系统更改
*   可能的损害被尽可能地限制

在我们的例子中，我们不能在测试服务器上重现错误——这是显而易见的，因为。与生产服务器相比，dll 处于完全不同的状态。回滚到旧的状态也不起作用，因为它破坏了其他同样重要的东西。

所以我们坐下来，问自己“如果我们搞砸了，最糟糕的情况是什么？”—然后编写了一个数据库脚本，将所有结果设置为错误状态，这样我们就知道下面的系统不会处理它们。

您还可以做一些事情，比如关闭服务器或任务，将逻辑上的下一步从生产线上拉下来等等，这取决于您的系统架构是如何构建的。

# 比较输入数据，找出与工作数据集的相似之处和不同之处

虽然您不能告诉代码在黑盒场景中实际上做了什么，但是您可以做一种逆向工程，这通常可以让您很好地了解是什么导致了问题。

在我们的例子中，我们拥有来自触发我们输入的前一个系统的格式非常好的 JSON 文件。因此，一旦我们设置好了一切，这实际上只是在 Notepad++中比较几个文本文件的问题，直到我们发现导致错误的文件之间的相似之处，然后发现这些文件和正确工作的文件之间的差异。

我们很幸运，可以很快发现这个错误是由一组非常特殊的客户标志引起的，我们有一个即时的解决方法，因为这个案例可能是用相似但不同的标志“伪造”的。因此，既然我们已经知道整个系统将被重写(因为我们没有其他选择，真的),我们决定解决这个错误，而不是以某种方式反编译和修复这个错误。

# 更改输入，看看您的猜测是否会导致预期的结果(并包含任何损害)

显然，在生产环境中更改数据库上的实时数据，并希望它在没有任何真正测试的情况下工作，这是一个非常糟糕的想法——但这也是我们唯一的选择。

结果很好，无论如何案例的数量很少，我们手动做的最初几个测试结果完全符合要求。

因此，我们简单地结束了编写另一个自动化任务，在这些问题进入系统之前修复它们，然后开始了一个为期三个月的项目，从头开始重写该程序，只是这次是透明的，并连接到版本控制和构建管道。

多好的旅程啊。

# 要点:仅仅通过在一个系统中走来走去，用棍子戳戳它，就可以推断出很多东西

对我来说，这种调试和查找错误的方法非常令人兴奋——我只是在这方面很奇怪，而且喜欢编程与肾上腺素激增重叠的时候。

如果你从未看过关于 SQL 注入和数据库逆向工程的视频，我强烈推荐你[看一看](https://www.youtube.com/watch?v=ciNHn38EyRc)，在我看来，这几乎是必读之作。该视频中使用的技术与您可以用于非恶意调试的技术非常相似。

我希望这是一个有用的阅读，以下是我的一些帖子:

[](/how-to-become-a-true-keyboard-warrior-and-stop-using-your-mouse-a87cd29c5801) [## 如何成为一名真正的键盘战士(并停止使用你的鼠标)

### 看似缓慢的工作方式如何变得更快

levelup.gitconnected.com](/how-to-become-a-true-keyboard-warrior-and-stop-using-your-mouse-a87cd29c5801) [](https://crypto.plainenglish.io/bitcoin-dont-care-70e38899e045) [## 比特币不在乎

### 这是最棒的部分

crypto . plain 英语. io](https://crypto.plainenglish.io/bitcoin-dont-care-70e38899e045)