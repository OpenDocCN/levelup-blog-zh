# 什么是活动采购(为什么)?

> 原文：<https://levelup.gitconnected.com/basics-of-event-sourcing-12ebe0b86788>

## 深入了解活动采购

![](img/2b3ba8e30f79e1ce82164ed318ccec6f.png)

事件源是领域驱动设计(DDD)和 CQRS 中经常提到的一种数据持久性策略。这些概念是独立的，但是**完美地互补**。但是事件采购是如何工作的呢？

存储数据通常遵循 **CRUD** 原则。然而，其中包含的**四个数据库操作**(“创建”、“读取”、“更新”和“删除”)并不都是相同的类型，因为更新和删除与其他操作不同，是破坏性操作。因此，通常使用带有“isDeleted”标志的更新来代替删除。但是更新也是破坏性的，因为之前保存的数据通常会丢失。

因此，事件源的基本思想是放弃更新和删除，而**只使用非破坏性的创建和读取操作**。借助事件源，每个技术变更或技术流程都作为一个**新条目**输入到一个不断增长的列表中，该列表通过 CREATE 创建，即所谓的**仅附加日志**。这些条目将**永远不会被更改**甚至删除！

事件源随着时间的推移收集越来越多的数据，给你一个**历史**和**审计日志**，这对报告和**数据分析**非常有用。它们还能让**重新诠释过去**获得洞见，为未来学习。由于关注于记录业务流程，**事件源远比 CRUD** 更受业务驱动，CRUD 通常被视为反模式，因为它更面向技术。

因此，事件源不存储当前状态，而是存储随着时间的推移导致当前状态的各个步骤。以这种方式工作的数据库被称为“**事件存储库**”。

读取当前状态可在事件源中启用所谓的“**重放**”。为一个对象保存的所有条目被**重新加载，并以原始顺序聚集**。然而，这不仅对于当前状态是可能的，对于昨天、前天或过去的任何其他时间点也是可能的。

![](img/3c3bcd59613bd27d1d55a62426fe5c7c.png)

照片由[Janko ferli](https://unsplash.com/@itfeelslikefilm?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

# 事件来源的缺点

因此，事件源提供了一种更具技术性的方法来收集历史数据，提供审计日志，为报告和数据分析提供良好的基础，并适合作为重新解释过去的起点。与 CRUD 相比，这是几个优势。但是缺点是什么呢？

说到事件采购，有三个基本挑战，但每个都有解决方案。第一个挑战是与重放相关的线性增加的工作量:必须加载和聚集的条目越多，重放花费的时间就越长。所谓的“**快照**在这里提供了一种补救措施，它显示定期额外保存的中间结果。

## 增加执行时间

其基础是认识到**重放总是确定性地运行**，因为存储在事件存储器**中的条目将不再改变。**对于时间 X 的快照来说，随后是否有更多条目也是无关紧要的。一路走来，重播并不总是要从头开始。相反，读出并聚集自上次快照以来添加的条目**就足够了。**

## 增加容量存储

第二个挑战是**活动商店不断增长的存储需求**，同时，应该注意的是，如今存储空间几乎不需要任何成本。此外，如果需要的话，也可以删除不再需要的旧条目**，前提是存在可以基于其进行重放的**快照**。**

## **事件记录太多**

**第三个挑战是加载不是一个而是所有记录的当前状态。在这种情况下，**必须为每个数据集**执行单独的重放，这很快变得过于**耗时**。这个问题也可以通过**快照**来解决，即每次添加最新条目时都必须写入一个新的快照。**

**![](img/006c64d9083bbd044a7bec363874137d.png)**

**由 [Towfiqu barbhuiya](https://unsplash.com/@towfiqu999999?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片**

# **CRUD 与事件来源**

**当**需要变更的可追溯性**时，事件源尤其适用。对历史数据的需求，特别是对审计日志的需求，也是**事件外包何时是一个好选择的良好指标**。**

**当对数据进行改变时，事件源还导致**较低的潜在冲突**,因为增量被写入仅包含部分数据:事件存储中的两个条目仅在它们同时出现并且关于各自的数据重叠不同时才彼此冲突。这是实践中不太常见的情况，也可以通过使用版本控制的**乐观并发**来避免。**

**然而，CRUD 也有优势:如果既没有语义也没有主题，事件源就不能充分利用它的优势。这些相位从无到有，但肯定已经像事物一样被锚定。所以说，如果你选择**领域驱动的设计**，那么事件采购通常是一个不错的选择。如果不是这样，CRUD 通常是更合适的选择。原始数据的高性能存储不需要任何专业逻辑，也很适合 CRUD。**

**CRUD 还展示了它在 d **检测重复**和**保证唯一性**方面的优越性。事件采购需要为此付出更大的努力。因此，将 CRUD 和事件源结合起来是有意义的，CRUD 用于更技术性的方面，而事件源用于专家方面。**

**![](img/c6213bb93ebc9328c605b623d9f873cb.png)**

**照片由 [XPS](https://unsplash.com/@xps?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄**

# **哪个数据库用于事件采购？**

**一旦你决定做事件源，你需要一个合适的数据库。乍一看，**要求很低**，因为只需要“插入”和“选择”的支持。不需要复杂的连接、公共表表达式(CTE)或其他 SQL 高级结构。在最好的情况下，对事务的支持仍然与在保存条目时能够映射全有或全无语义相关。**

**然而，乍一看，SQL 数据库似乎不是事件源的好选择，因为事件存储中的所有条目都具有典型的结构。尽管如此，专家数据的结构**因应用而异**。事件存储从来不需要评估这个结构，所以 BLOB 或 JSON 类型的字段完全可以存储技术数据。因此，SQL 数据库几乎是理想的。**

****NoSQL 数据库**(文档数据库，如 **MongoDB** 在这种情况下特别有意义)有一个**优势**，因为它们在没有模式的情况下工作，并且被设计为处理不同的 **JSON 格式**。**

**最后但并非最不重要的是，存在误用其他系统的选择:一个典型的例子是消息代理 **Apache Kafka** ，它可以用作一种事件存储。使用卡夫卡作为一个事件商店是两极化的:支持者反对一群至少同样重要的开发者，并从根本上拒绝这一想法。因此，只有在特殊情况下才应该这样做。**

**总而言之，**推荐使用 MongoDB 之类的 NoSQL 数据库**解决方案，因为事件数据不一定需要结构化。**

**![](img/4ebe774d18479dd0dd59c386f972a389.png)**

**照片由[潘卡杰·帕特尔](https://unsplash.com/@pankajpatel?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄**

# **领域驱动的设计和事件源**

**正如开头提到的，事件源经常在**与领域驱动设计** (DDD)的联系中被提及。“事件”一词在这两个概念中都是一个常用术语。在事件采购中，它已经是概念名称的一部分。与 DDD，它被发现与所谓的“**域事件**”有关。**

**在这两种情况下，事件(或域事件)描述过去的**域相关事件**。因此，它们不能再被撤销，但其影响最多只能通过反交易来补偿。所以这是两个世界中相同的概念。由于 DDD 对于**微服务**来说是一个很好的概念，所以对于活动采购来说也是如此。**

**因为域事件通常是命令的结果，所以**将这些域事件**作为条目存储在**事件存储**中是有意义的。然后使用重放来恢复所需单元的状态，这是处理进一步命令的基础。**

**这种想法也非常适合事件源，因为通常不是单个条目流，而是许多小条目组合成组——从 DDD 到聚合。**

# **结论**

**事件源对于持久化数据来说是一个令人兴奋和有趣的概念。这种方法在所有涉及对现在和过去的数据进行领域评估的场景中展示了它的优势。**

**事件源不太适合纯粹的技术数据存储，如数据上的表单，或者当涉及到确定数据的技术方面时，如重复或唯一性。**

**因此，事件源不能替代 CRUD，正如 CRUD 不能替代事件源一样。相反，这两个概念通常可以很好地相互补充，以便您可以根据具体情况决定使用哪种方法。不管你最终使用的是什么，了解活动采购总是有益的，即使只是为了拓宽你的视野。**

**感谢您阅读我关于事件源的文章。我希望你能从中吸取一些东西。关注更多。**

**干杯！**

# **接下来阅读**

**[](/what-is-cqrs-8ddd74ca05bb) [## 深入 CQRS —一个伟大的微服务模式

### 什么是 CQRS，为什么它越来越受欢迎？

levelup.gitconnected.com](/what-is-cqrs-8ddd74ca05bb) [](/domain-driven-design-in-software-development-f92c3f58d012) [## 微服务:深入领域驱动的设计

### 软件开发背景下的领域驱动设计

levelup.gitconnected.com](/domain-driven-design-in-software-development-f92c3f58d012) [](/why-did-i-move-from-typescript-to-go-1d9f92ef882a) [## 为什么我从打字稿转向 Go

### 以及为什么我不会放弃使用 TypeScript

levelup.gitconnected.com](/why-did-i-move-from-typescript-to-go-1d9f92ef882a)**