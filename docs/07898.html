<html>
<head>
<title>The N + 1 Problem</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">N + 1问题</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/the-n-1-problem-a8f66e3fcf54?source=collection_archive---------2-----------------------#2021-03-19">https://levelup.gitconnected.com/the-n-1-problem-a8f66e3fcf54?source=collection_archive---------2-----------------------#2021-03-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="187a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">这是数学…但不是</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/804967fcc41d241d166e246515b10151.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hcKZe4hkZyfRbDcQlEgogw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">提示—这是数据库问题！简·安东宁·科拉尔在<a class="ae kv" href="/s/photos/database?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="d508" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">什么是N + 1？为什么这是个问题？我发现这个问题需要一点极客潜水。首先，我觉得我需要多了解一点关系数据库和SQL查询。此外，我需要一个ORMs(对象关系映射)的基本复习。让我们倒回去一点:</p><p id="817c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据<a class="ae kv" href="https://www.sitepoint.com/orm-ruby-introduction/" rel="noopener ugc nofollow" target="_blank">马努·阿吉特·库玛尔</a>、<em class="ls">的说法，“一个ORM框架是用面向对象的语言(比如Ruby、Python、PHP等)编写的。)并包装在关系数据库中。对象类被映射到数据库中的数据表，对象实例被映射到这些表中的行。</em></p><p id="52bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://aws.amazon.com/relational-database/" rel="noopener ugc nofollow" target="_blank">关系数据库</a>正如其名:<em class="ls">“关系数据库是数据项的集合，它们之间有预定义的关系……表中的每一列保存某种数据，一个字段存储属性的实际值。表中的行表示一个对象或实体的相关值的集合。表中的每一行都可以用一个被称为主键的唯一标识符来标记，并且多个表中的行可以使用外键来关联…”</em></p><p id="609d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ORM框架允许我们更容易地与(关系)数据库中的数据进行交互，反映了我们用各种属性实例化类实例的方式。活动记录就是这样一个ORM框架。它与Ruby on Rails一起“开箱即用”。活动记录的一大好处是它与许多不同的关系数据库兼容。根据马努·阿吉特·库玛尔的说法，以下是其他一些例子:</p><ul class=""><li id="3bbb" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated"><em class="ls">数据表现为模型。</em></li><li id="f706" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated"><em class="ls">可以使用这些模型实现关联。</em></li><li id="bbfc" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated"><em class="ls">可以通过相关模型实现继承。</em></li><li id="bfaf" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated"><em class="ls">数据保存到数据库前的验证。</em></li><li id="e4ec" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated"><em class="ls">面向对象处理数据库操作的方式。</em></li></ul><p id="f4d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一个很大的优势是，活动记录接管了执行SQL查询的工作，更复杂的查询可能有点吓人(内连接…还是左外连接？？嗯，不用了，谢谢)。对于任何不“了解”SQL的人来说，这里是通过我们在W3学校的朋友得到的描述:</p><ul class=""><li id="90e5" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">SQL代表结构化查询语言</li><li id="a2d7" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">SQL允许你访问和操作数据库</li><li id="ea8d" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">SQL在1986年成为美国国家标准协会(ANSI)的标准，并在1987年成为国际标准化组织(ISO)的标准</li></ul><p id="3093" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">✴️注意:最基本的SQL命令实际上很容易也很有趣，W3Schools为任何想尝试一下的人提供了一个很酷的互动教程。</p><p id="b2cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以。回到那个卑鄙的N + 1和它固有的…问题。如果我们有一个学生数据库，并且我们想要查询他们的成绩单历史，我们将有N个查询(每个学生= &gt;他们的成绩单)，加上1个对<code class="fe mh mi mj mk b">Student.all</code>的查询。如果学校很小(佛蒙特州的万宝路学院有192名学生注册*)，那么Ruby代码和相应的SQL查询可能是这样的:</p><p id="e8a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mh mi mj mk b">Student.all.map { |student| student.report_card }.flatten</code></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">典型的SQL调用—小心N + 1问题…</figcaption></figure><p id="aa25" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这种情况下，N = 192。这不太好，但也不可怕。但是佛罗里达中央大学拥有59483名学生。*当N = 59，483时…这是一个很大的查询量！我们总是希望最小化数据库查询的数量，以获得最佳的性能和页面加载。</p><p id="3c91" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">令人高兴的是，Active Record为我们提供了一个解决太多查询问题的简单方法:“<em class="ls"> Active Record让您可以预先指定将要加载的所有关联。这可以通过指定</em> <code class="fe mh mi mj mk b"><em class="ls">Model.find</em></code> <em class="ls">调用的</em> <code class="fe mh mi mj mk b"><a class="ae kv" href="https://api.rubyonrails.org/v6.1.3/classes/ActiveRecord/QueryMethods.html#method-i-includes" rel="noopener ugc nofollow" target="_blank"><em class="ls">includes</em></a></code> <em class="ls">方法来实现。使用</em> <code class="fe mh mi mj mk b"><em class="ls">includes</em></code> <em class="ls">，活动记录确保使用尽可能少的查询来加载所有指定的关联。”</em></p><p id="02ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用。包括时，Ruby代码应该是这样的:<code class="fe mh mi mj mk b">Student.includes(:report_cards).map { |student| student.report_card }.flatten</code></p><p id="3a12" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并且只有两个相关的SQL查询。DB优化！✅</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">没有N + 1问题</figcaption></figure><p id="6106" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在幕后，Active Record使用了一种叫做急切加载的技术。根据<a class="ae kv" href="https://guides.rubyonrails.org/active_record_querying.html#eager-loading-associations" rel="noopener ugc nofollow" target="_blank"> Ruby on Rails指南</a> : <em class="ls">“急切加载是使用尽可能少的查询来加载</em> <code class="fe mh mi mj mk b"><em class="ls">Model.find</em></code> <em class="ls">返回的对象的关联记录的机制。”</em>如果你有兴趣了解更多幕后发生的事情，这里有一篇非常棒的文章<a class="ae kv" href="https://medium.com/@bretdoucette/n-1-queries-and-how-to-avoid-them-a12f02345be5" rel="noopener"/>,深入探讨了问题和解决方案，包括在我看来相当于时间复杂性的东西(线性时间！)进行N + 1 SQL查询，以及Active Record如何通过缓存数据来使用急切加载。</p><p id="5b79" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就我的目的而言，我很高兴知道我们为什么使用。包括在我们的Rails控制器中，用于“有很多东西”的类。使用。includes将产生两个SQL查询，一个用于Activity.all，另一个用于所有user_activities。这里没有N + 1的问题！！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/9a83f94c0252882c55beb1e97baaaddd.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/format:webp/1*MVM2Fh3i_j6x23pzioKObw.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">一个活动有_many :user_activities</figcaption></figure><p id="10e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">*学生数据来自《美国新闻与世界报道》</p><div class="mo mp gp gr mq mr"><a href="https://guides.rubyonrails.org/active_record_querying.html" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd ir gy z fp mw fr fs mx fu fw ip bi translated">活动记录查询接口——Ruby on Rails指南</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">活动记录查询界面本指南涵盖了使用活动记录从数据库中检索数据的不同方法</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">guides.rubyonrails.org</p></div></div><div class="na l"><div class="nb l nc nd ne na nf kp mr"/></div></div></a></div><div class="mo mp gp gr mq mr"><a href="https://engineering.gusto.com/a-visual-guide-to-using-includes-in-rails/" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd ir gy z fp mw fr fs mx fu fw ip bi translated">可视化使用指南:包含在Rails中</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">如果您是开发Rails应用程序的新手，您可能会遇到术语N + 1查询。你可能也…</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">engineering.gusto.com</p></div></div><div class="na l"><div class="ng l nc nd ne na nf kp mr"/></div></div></a></div><div class="mo mp gp gr mq mr"><a href="https://www.sitepoint.com/orm-ruby-introduction/" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd ir gy z fp mw fr fs mx fu fw ip bi translated">Ruby中的ORM:简介-站点点</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">任何有开发基于web的应用程序或使用web框架经验的人都处理过关系…</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">www.sitepoint.com</p></div></div><div class="na l"><div class="nh l nc nd ne na nf kp mr"/></div></div></a></div><div class="mo mp gp gr mq mr"><a href="https://www.w3schools.com/sql/sql_intro.asp" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd ir gy z fp mw fr fs mx fu fw ip bi translated">SQL简介</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">SQL是访问和操作数据库的标准语言。</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">www.w3schools.com</p></div></div><div class="na l"><div class="ni l nc nd ne na nf kp mr"/></div></div></a></div></div></div>    
</body>
</html>