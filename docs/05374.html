<html>
<head>
<title>How to back up Firestore easily and automatically</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何轻松自动地备份Firestore</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-back-up-firestore-easily-and-automatically-eab6bf0d7e1f?source=collection_archive---------2-----------------------#2020-08-24">https://levelup.gitconnected.com/how-to-back-up-firestore-easily-and-automatically-eab6bf0d7e1f?source=collection_archive---------2-----------------------#2020-08-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7172dcfaf8144fc50d9ae57a089a67e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m-m1UO-KNpGnmI-4YXIIoA.png"/></div></div></figure><p id="1fcf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Firebase和Firestore为开发人员提供了一个很好的、完全托管的平台，可以快速开发和发布他们的产品。不幸的是，备份似乎是平台中被忽视的部分，没有易于使用的控件来捕获数据库的定期快照。虽然您不太可能因为硬件故障而丢失任何数据，但备份仍然至关重要，因为故障的另一个来源是开发人员。</p><p id="d902" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">迁移出错，代码有缺陷。即使你努力追求完美(并实现它！)，下一个做它的人会这么敬业吗？你需要备份，由于Firestore中没有这样做的按钮，我们只能自己做。幸运的是，现在可以通过使用Firebase功能(启动和自动化备份)和Google云存储(存储备份)的组合来非常简单地实现。</p><h2 id="489e" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">步骤1:规划您的备份策略</h2><p id="a18f" class="pw-post-body-paragraph jy jz iq ka b kb lp kd ke kf lq kh ki kj lr kl km kn ls kp kq kr lt kt ku kv ij bi translated">在进行任何配置之前，您需要考虑以下几点:</p><ul class=""><li id="ca34" class="lu lv iq ka b kb kc kf kg kj lw kn lx kr ly kv lz ma mb mc bi translated">您希望多久进行一次备份？越频繁=读取次数越多，存储的数据越多=成本越高。频率越低=潜在的数据丢失率越高。</li><li id="02f4" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">你能按需运行它们吗？鉴于我们的主要故障模式是开发人员故障，备份作为部署前步骤可能是合理的。</li><li id="9680" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">您希望多久删除一次备份？对于某些行业，您将需要有特定的时间窗口来保留数据，包括备份。该窗口结束后，您可能也不允许保留数据，这也包括备份。所以也需要一种自动删除它们的方法。</li><li id="f616" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">GDPR适用吗？被遗忘的权利可能也适用于备份，这就是为什么当它首次宣布时，我(和许多开发人员一样)采取了双重措施，并在心里将欧盟从我未来的目标市场中划掉。我在这个问题上的立场已经成熟，但如果你想符合GDPR标准，你可能无法长期存储包含识别信息的备份，除非你有办法忘记旧备份中的个人数据，例如将所有个人信息保存在不同配置备份周期的单独数据库/服务中。</li></ul><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/bd4af8c9f2c3fe8b97d062936fb11fcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ij4KT4i8MQ3Uyr2w_AQQGg.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">真是让人头疼……(图片由<a class="ae mr" href="https://unsplash.com/photos/sxQz2VfoFBE" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>提供)</figcaption></figure><p id="f0ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">考虑到这一点，你现在应该有一个保留时间和调节诱导头痛。让我们开始实际实施备份。</p><h2 id="f9fc" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">第二步:备份的去处</h2><p id="9fcb" class="pw-post-body-paragraph jy jz iq ka b kb lp kd ke kf lq kh ki kj lr kl km kn ls kp kq kr lt kt ku kv ij bi translated">在谷歌云存储中创建一个桶。<strong class="ka ir">请注意，该存储桶必须与您的Firestore数据库位于同一地区或多地区。</strong></p><ul class=""><li id="61ca" class="lu lv iq ka b kb kc kf kg kj lw kn lx kr ly kv lz ma mb mc bi translated">前往<a class="ae mr" href="https://console.cloud.google.com/storage/browser" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a></li><li id="6707" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">确保你在顶栏中选择了正确的项目！</li><li id="3ebf" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">点击“创建存储桶”</li><li id="c356" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">给它一个名字——我喜欢混合使用一个明显的描述和一个不明显的后缀，通过模糊来增加安全性</li><li id="728c" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">选择与您的Firestore数据库相同的区域或多区域。比如美国多地区。</li><li id="ff81" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">选择存储类别。如果您只打算一次保留几个月的备份，近线是理想的选择，因为它的最短保留期只有30天。否则，Coldline将保留90天，并进一步节省成本。</li><li id="523f" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">对于访问控制，由于此存储桶将只存储备份，因此“统一”访问控制最有意义，也最容易维护。我们不希望我们的备份被除我们之外的任何人访问，这使得实施起来很容易。</li><li id="6473" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">最后是高级设置。这是我们设置保留期的地方—勾选“设置保留策略”并添加您想要的配置。</li><li id="8cfb" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">点击“创建”。</li></ul><p id="3252" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">假设您的bucket与您的Firebase应用程序位于同一个项目中，那么您的应用程序的服务帐户应该自动拥有对您的bucket进行读写的权限。您可以通过在控制台中打开您的bucket，转到“Permissions”选项卡并查找<code class="fe ms mt mu mv b">yourproject@appspot.gserviceaccount.com</code>来仔细检查这一点。它应该具有“存储管理员”角色。</p><h2 id="85e4" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">步骤3:编写我们的自动化备份</h2><p id="e99c" class="pw-post-body-paragraph jy jz iq ka b kb lp kd ke kf lq kh ki kj lr kl km kn ls kp kq kr lt kt ku kv ij bi translated">是时候写一些代码来触发备份了。实现这一点最简单的方法是实现一个<a class="ae mr" href="https://firebase.google.com/docs/functions/" rel="noopener ugc nofollow" target="_blank"> Firebase函数</a>——特别是一个<a class="ae mr" href="https://firebase.google.com/docs/functions/schedule-functions" rel="noopener ugc nofollow" target="_blank">预定函数</a>。我假设您以前已经使用过Firebase函数，并在您的项目中设置了它。如果没有，<a class="ae mr" href="https://firebase.google.com/docs/functions/get-started" rel="noopener ugc nofollow" target="_blank">执行第一个</a>。</p><p id="550c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们需要确保我们的新功能可以通过授予我们的服务帐户<code class="fe ms mt mu mv b">yourproject@appspot.gserviceaccount.com</code>“云数据存储导入导出管理员”角色来运行数据导出。你可以通过谷歌云控制台的IAM界面或者从命令行(替换掉两个<code class="fe ms mt mu mv b">yourproject</code>的实例)来实现:</p><pre class="mj mk ml mm gt mw mv mx my aw mz bi"><span id="aa20" class="kw kx iq mv b gy na nb l nc nd">gcloud projects add-iam-policy-binding yourproject \<br/>  --member serviceAccount:yourproject@appspot.gserviceaccount.com \<br/>  --role roles/datastore.importExportAdmin</span></pre><p id="a5c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们实现的函数中，我们将使用Firebase Admin SDK ( <code class="fe ms mt mu mv b">yarn add @google-cloud/firestore</code>将其添加到functions项目中)来触发备份作业的创建。由于我们是从Firebase函数内部运行的，所以我们可以从环境中获得所需的大部分项目配置。只要确保将<code class="fe ms mt mu mv b">gs://your-bucket-name</code>替换为您实际的桶名即可！您还可以根据自己的需求更改时间表，在本例中，我将其设置为每日:</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="6c81" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦我们做好准备，我们的计划备份功能现在将通过一个简单的<code class="fe ms mt mu mv b">firebase deploy</code>与应用程序的其余部分一起部署。然后，它应该会按照您设定的时间表愉快地运行。要手动调用它，我们可以使用web UI:</p><ul class=""><li id="c658" class="lu lv iq ka b kb kc kf kg kj lw kn lx kr ly kv lz ma mb mc bi translated">转到项目的Firebase控制台，然后从侧栏中选择Functions</li><li id="3ac3" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">找到您的函数，然后单击该行右侧的三个点，并选择“在云调度程序中查看”</li><li id="675b" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">找到您的时间表并点击“立即运行”</li></ul><p id="578a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者，我们可以使用<code class="fe ms mt mu mv b">gcloud</code> CLI(例如，作为您的CI/CD流程的一部分):</p><ul class=""><li id="d6ce" class="lu lv iq ka b kb kc kf kg kj lw kn lx kr ly kv lz ma mb mc bi translated">获取您的预定功能列表:<code class="fe ms mt mu mv b">gcloud scheduler jobs list</code></li><li id="dc21" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">运行一个:<code class="fe ms mt mu mv b">gcloud scheduler jobs run your-scheduler-name</code></li></ul><p id="17c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦您的函数运行完毕，查看一下您之前创建的bucket。您可能需要等待备份完成(<code class="fe ms mt mu mv b">gcloud firestore operations list</code>来检查最近的操作)，但最终您应该会看到一个包含备份的带时间戳的文件夹:</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/52de4d7e2c17ac7c1cfc286d1b7c3f67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TxtvoARFi81iqx5El4L7Eg.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">成功备份！</figcaption></figure><h2 id="ff5a" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">先说成本</h2><p id="7fd8" class="pw-post-body-paragraph jy jz iq ka b kb lp kd ke kf lq kh ki kj lr kl km kn ls kp kq kr lt kt ku kv ij bi translated">Firestore本身有一个有趣的定价模式。它根据读取和写入、总存储和总传输量计费。但是真正昂贵的部分呢？读和写。他们最近在他们的文档中添加了一个警告，澄清了导出数据(即备份)时读取肯定是要收费的，但这是我不得不通过艰苦的方式发现的事情。</p><p id="f6ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">根据您存储的数据量和备份的频率，备份的成本可能会比应用程序的实际运行成本高出几个数量级。在我目前的项目中，我需要存储大量不常访问的货币兑换率数据，这意味着极其昂贵的备份。</p><p id="06b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不幸的是，现阶段唯一的解决方法是少备份一些数据，或者只选择性地备份数据。通过修改<code class="fe ms mt mu mv b">collectionIds</code>参数，您可以在备份代码中明确声明您想要包含哪些集合。因此，如果你只想备份你的<code class="fe ms mt mu mv b">users</code>和<code class="fe ms mt mu mv b">restaurants</code>集合，你可以指定<code class="fe ms mt mu mv b">collectionIds: ['users', 'restaurants']</code>。</p><p id="fdd1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一个大问题是嵌套集合(例如<code class="fe ms mt mu mv b">users/{userId}/posts</code>)也需要被添加，否则<strong class="ka ir">它们将不会被备份。</strong>这没有很好的记录，但是为了避免一些试验性的&amp;错误<strong class="ka ir">这是您备份子集合的方式</strong>:</p><pre class="mj mk ml mm gt mw mv mx my aw mz bi"><span id="f844" class="kw kx iq mv b gy na nb l nc nd">collectionIds: [<br/>  // This will back up users/{userId}<br/>  'users',<br/>  // This will back up users/{userId}/posts/{postId}<br/>  'posts'<br/>]</span></pre><p id="ddba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于您认为备份成本太高的数据，请确保您有一个灾难恢复计划，以便在出现问题时能够恢复这些数据。</p><h2 id="36bd" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">事后思考</h2><p id="efff" class="pw-post-body-paragraph jy jz iq ka b kb lp kd ke kf lq kh ki kj lr kl km kn ls kp kq kr lt kt ku kv ij bi translated">我希望在某个阶段Firebase可以改进他们的备份工具。目前，对于一些常见的工作负载来说，它非常昂贵，而且对用户或开发人员来说也不友好。我会说这是一个很好的开发者体验中较弱的部分。备份是您需要从第一天开始就为您的服务实施的东西，因此我认为每个负责任的托管数据库服务都应该包括用于备份和恢复的突出工具，并且至少提供一个简单的基本设置自动化备份解决方案。备份数据成本过高或技术难度太大可能会导致许多客户搬起石头砸自己的脚，或者决定冒这个险，我担心Firestore就是这么做的。</p><p id="e264" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">无论这是否适用于您或者您刚刚开始，希望本文已经向您展示了如何为您自己的Firebase应用程序构建一个健壮的备份系统。不要忘记测试你的备份是否经常工作。有太多这样的恐怖故事:项目人员组装了一个备份系统，但在灾难发生之前，他们从未真正尝试过从备份系统中恢复数据…</p></div></div>    
</body>
</html>