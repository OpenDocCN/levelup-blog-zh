<html>
<head>
<title>Terraform remote state — sharing information across state files</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform远程状态—跨状态文件共享信息</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/terraform-remote-state-sharing-information-across-state-files-1c886aa0d099?source=collection_archive---------10-----------------------#2020-02-18">https://levelup.gitconnected.com/terraform-remote-state-sharing-information-across-state-files-1c886aa0d099?source=collection_archive---------10-----------------------#2020-02-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/bc61adb43b77b1cc5eb73bb02e031e6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LQvmOMwd2bq984n9.png"/></div></div></figure><p id="cfe5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我最近使用的一个非常酷的功能是跨多个terraform项目共享一个terraform状态。</p><p id="f7b0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里有一个我用过的结构的例子，它对我很有效。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="9dcf" class="li lj it le b gy lk ll l lm ln">.<br/>├── management<br/>│   ├── outputs.tf<br/>│   ├── route53.tf<br/>│   └── vpc.tf<br/>├── service-1<br/>│   ├── api-gateway.tf<br/>│   └── data.tf<br/>└── service-2<br/>    ├── api-gateway.tf<br/>    └── data.tf</span></pre><p id="218a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我以这种方式进行了拆分，以处理将处理核心基础架构的核心“管理”配置，我希望将核心基础架构与基础架构中托管的单个服务分离开来。</p><p id="a22a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以这种方式分割项目还有其他原因，比如简化部署，有时是为了循环依赖，有时是配置问题。</p><p id="3dd8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我的例子中，服务1和服务2依赖于管理，以访问VPC和路由53信息。将所有的terraform配置包含在一个“项目”中是可能的，但是我想避免创建一个单一的基础设施配置。</p><p id="8dac" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了在service-1、service-2和管理之间创建松散的连接，并从其状态的最新版本中引用基础结构，您的项目可以访问另一个服务的远程状态。这在<a class="ae lo" href="https://www.terraform.io/docs/providers/terraform/d/remote_state.html" rel="noopener ugc nofollow" target="_blank"> terraform网站</a>上有很好的记录</p><p id="808a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">通过使用输出来共享数据，例如，我有一个在管理中运行的容器，我希望能够输出Route 53区域id，以便与其他服务共享</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="9eff" class="li lj it le b gy lk ll l lm ln">output "route53_zone_id" {<br/>  value = "${aws_route53_zone.zone.zone_id}"<br/>}</span></pre><p id="7b7f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当您运行带有输出的应用程序时，您也会在控制台中看到它</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="7ee9" class="li lj it le b gy lk ll l lm ln">Apply complete! Resources: 0 added, 1 changed, 0 destroyed.</span><span id="2253" class="li lj it le b gy lp ll l lm ln">Outputs:</span><span id="069a" class="li lj it le b gy lp ll l lm ln">route53_zone_id = Z1J2WFZ3ZFF4B5</span></pre><p id="ff61" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了从另一个项目引用它，我添加了一个指向远程状态的数据块:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="b7f9" class="li lj it le b gy lk ll l lm ln">data "terraform_remote_state" "management" {<br/>  backend = "s3"<br/>  config {<br/>    bucket = "craig-godden-payne-terraform-remote-state"<br/>    key    = "infrastructure/management/terraform.tfstate"<br/>    region = "eu-west-1"<br/>  }<br/>}</span></pre><p id="94e6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，当我想使用远程状态的数据时，我可以这样做:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="e69f" class="li lj it le b gy lk ll l lm ln">"${data.terraform_remote_state.management.route53_zone_id}"</span></pre><p id="2ded" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您有问题，请确保您已经在源环境上运行了<code class="fe lq lr ls le b">terraform apply</code>,即使您没有做任何更改。</p><figure class="kz la lb lc gt ju gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/d270ea1bc487aa00a4f9f7aa51b4a6aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/0*Bjv-Ha-mGhta2e4Q.png"/></div></figure></div></div>    
</body>
</html>