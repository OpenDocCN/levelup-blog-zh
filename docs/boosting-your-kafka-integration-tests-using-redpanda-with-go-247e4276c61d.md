# ä½¿ç”¨ Redpanda å’Œ Go å¢å¼ºæ‚¨çš„ Kafka é›†æˆæµ‹è¯•ğŸš€

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/boosting-your-kafka-integration-tests-using-redpanda-with-go-247e4276c61d>

## ä»¥ testcontainers å’Œ dockertest ä¸ºä¾‹

> é›†æˆæµ‹è¯•æ˜¯ç¼–æ’æµ‹è¯•ã€‚ä»–ä»¬ä¸æµ‹è¯•ä¸šåŠ¡è§„åˆ™ã€‚æ›´ç¡®åˆ‡åœ°è¯´ï¼Œå®ƒä»¬æµ‹è¯•çš„æ˜¯ç»„ä»¶ç»„åˆåœ¨ä¸€èµ·çš„æ•ˆæœã€‚å®ƒä»¬æ˜¯ç®¡é“æµ‹è¯•ï¼Œç¡®ä¿ç»„ä»¶æ­£ç¡®è¿æ¥ï¼Œå¹¶ä¸”å¯ä»¥æ¸…æ™°åœ°ç›¸äº’é€šä¿¡ã€‚[ã€1ã€‘](https://www.amazon.com/Clean-Coder-Conduct-Professional-Programmers/dp/0137081073)

å¤§å®¶å¥½ï¼åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³è°ˆè°ˆ [**ã€Redpanda**](https://redpanda.com/) ï¼Œä»¥åŠæˆ‘ä»¬å°†å¦‚ä½•åœ¨æˆ‘ä»¬çš„é›†æˆæµ‹è¯•ä¸­ä»¥ä¸¤ä¸ªæµè¡Œçš„åº“ä¸ºä¾‹æ¥å®ç°å®ƒï¼› [**testcontainers**](https://github.com/testcontainers/testcontainers-go) å’Œ [**dockertest**](https://github.com/ory/dockertest) ã€‚

> **TLï¼›DR**:[https://github . com/abdulsamiteleri/integration-tests-with-red panda](https://github.com/Abdulsametileri/integration-tests-with-redpanda)

![](img/be99c27d1185198ea6bbac5f0d55f84e.png)

å›¾:åœ°é¼ æƒ³å­¦ä¹ å¦‚ä½•å®ç° Redpanda

## ä»€ä¹ˆæ˜¯ RedpandağŸ¤”

**Redpanda** æ˜¯ä¸€ä¸ª Kafka å…¼å®¹çš„æµæ•°æ®å¹³å°ï¼Œé€Ÿåº¦å¿« 10 å€ï¼Œç¡¬ä»¶æ•ˆç‡é«˜ 6 å€ã€‚å®ƒä¹Ÿæ˜¯æ—  JVMã€æ—  ZooKeeperã€ [Jepsen æµ‹è¯•](https://redpanda.com/blog/redpanda-official-jepsen-report-and-analysis/)ï¼Œå¹¶ä¸”æºä»£ç å¯ç”¨ã€‚[ã€2ã€‘](https://redpanda.com/)

## æˆ‘ä¸ºä»€ä¹ˆè¦ç”¨ RedpandağŸ¤”

æœ‰äº† Redpanda çš„è¿™äº›ä¼˜ç§€å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°åœ¨æµ‹è¯•ä¸­ä½¿ç”¨å®ƒï¼Œè€Œæ— éœ€è¿è¡Œ Kafka å’Œ Zookeeper å®¹å™¨ã€‚(æ›´å¥½çš„å¯åŠ¨æ—¶é—´å’Œæ— æ•…éšœ)ã€‚æ­¤å¤–ï¼Œç”±äºå®ƒçš„å…¼å®¹æ€§ï¼Œä¸éœ€è¦æ›´æ”¹ Kafka æ‰€åœ¨çš„ä»»ä½•ç”Ÿäº§ä»£ç ã€‚

æ­£å¦‚æˆ‘ä»¬å·²ç»çŸ¥é“çš„ï¼Œç¼–å†™å’Œç»´æŠ¤é›†æˆæµ‹è¯•æ˜¯å›°éš¾çš„ã€‚æˆ‘ä»¬å¸Œæœ›å°½å¿«å¾—åˆ°è¿™äº›æµ‹è¯•çš„ç»“æœã€‚åœ¨ç”¨ Redpanda æ›¿æ¢äº†æˆ‘ä»¬çš„é›†æˆæµ‹è¯•ä¹‹åï¼Œæˆ‘ä»¬çš„æµ‹è¯•æ¯”æ—§çš„ Kafka æµ‹è¯•å·¥ä½œå¾—éå¸¸å¿«ã€‚æ‰€ä»¥æˆ‘æƒ³å’Œä½ åˆ†äº«ğŸ”¥

åœ¨è¿›å…¥å®ç°ç»†èŠ‚ä¹‹å‰ï¼Œæˆ‘æƒ³é€šçŸ¥ä½ ï¼›æˆ‘å°†ç”¨ä¸€ä¸ªæ¼‚äº®çš„æµ‹è¯•åº“[ä½œè¯](https://github.com/stretchr/testify)*(suite å’Œ assert åŒ…)*ã€‚æ‰€ä»¥å¦‚æœä½ æ²¡æœ‰ä»»ä½•ç»éªŒï¼Œæˆ‘å¼ºçƒˆå»ºè®®ä½ å»çœ‹çœ‹ã€‚

æ³¨æ„:æˆ‘å°†ä¸ºæ¯ä¸ª`*(TestContainerWrapper, DockerTestWrapper)*`åˆ›å»ºä¸€ä¸ªåŒ…è£…å™¨ç»“æ„ï¼Œå¹¶ä¸»è¦ç¼–å†™æˆ‘ä»¬éœ€è¦çš„ä¸‰ä¸ªæ–¹æ³•:`RunContainer`ã€`CleanUp`ã€`GetBrokerAddresses`ã€‚

æ³¨ 2:æˆ‘æƒ³æµ‹è¯•ä¸¤ä¸ªåŠŸèƒ½ï¼Œä»¥ç¡®ä¿æˆ‘çš„åº”ç”¨ç¨‹åºå¯ä»¥æˆåŠŸåœ°ç”Ÿæˆ Kafka æ¶ˆæ¯å’Œä½¿ç”¨ Kafka æ¶ˆæ¯ã€‚

æˆ‘ä»¬å¼€å§‹å§ï¼

## ğŸ‘‰ç”¨ testcontainers å®ç°

é¦–å…ˆï¼Œåœ¨æˆ‘ä»¬çš„é›†æˆæµ‹è¯•å¼€å§‹å·¥ä½œä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿æˆ‘ä»¬çš„è®¾ç½®è¿‡ç¨‹å·²ç»å®Œæˆå¹¶å‡†å¤‡å¥½ç»§ç»­ã€‚

æˆ‘ä»¬çš„æµ‹è¯•å¥—ä»¶å¦‚ä¸‹æ‰€ç¤ºã€‚æˆ‘ä»¬åˆ›å»ºäº†`TestContainerWrapper`ç»“æ„ï¼Œå¹¶å°†å…¶ç”¨äºå¥—ä»¶ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥ä¸“æ³¨äº`RunContainer`å®ç°ã€‚

åœ¨æä¾›äº† Redpanda æ˜ åƒå’Œç‰ˆæœ¬ä¹‹åï¼Œæˆ‘ä»¬å…¬å¼€äº† **9092** ç«¯å£ã€‚**å°å¿ƒï¼›è¿™ä¸ªå…¬å¼€çš„ç«¯å£å·æ˜¯ä»å®¹å™¨çš„è§’åº¦æ¥çœ‹çš„ï¼**ä»ä¸»æœºçš„è§’åº¦æ¥çœ‹*ï¼Œ* Testcontainers åœ¨ä¸€ä¸ªéšæœºçš„ç©ºé—²ç«¯å£ä¸Šå…¬å¼€å®ƒã€‚è¿™æ˜¯ä¸ºäº†é¿å…æœ¬åœ°è¿è¡Œçš„è½¯ä»¶æˆ–å¹¶è¡Œæµ‹è¯•è¿è¡Œä¹‹é—´å¯èƒ½å‡ºç°çš„ç«¯å£å†²çªã€‚[ã€3ã€‘](https://www.testcontainers.org/features/networking/)ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—æ˜ å°„ç«¯å£ **9092** æ¥ä»æˆ‘ä»¬çš„ä¸»æœºè¿æ¥ä»£ç†ã€‚

æˆ‘ä»¬ä½¿ç”¨é»˜è®¤çš„`redpanda start`å‘½ä»¤ã€‚æœ‰å‡ ä¸ªä¸åŒçš„å‚æ•°:è¿™è¦çœ‹ä½ æµ‹è¯•çš„æ˜¯ä»€ä¹ˆç­‰ç­‰ã€‚Redpanda å®¹å™¨ä»¥*å¼€å¤´â€”â€”dev-container*ã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œ[é»˜è®¤æƒ…å†µä¸‹ä¼šä¼ é€’å‡ ä¸ªå…¶ä»–å‚æ•°ã€‚](https://github.com/redpanda-data/redpanda/blob/36902e558294680e6d89e501a80e4e09811bc815/src/go/rpk/pkg/cli/cmd/redpanda/start.go#L1062)

æˆ‘å°† true ä¼ é€’ç»™äº†`AutoRemove`æ ‡å¿—ï¼Œå› æ­¤å®¹å™¨å°†åœ¨åœæ­¢æ—¶ä»ä¸»æœºä¸­ç§»é™¤ã€‚

æœ€åï¼Œæˆ‘æ›¾ç»ç»™æˆ‘çš„é”™è¯¯ [*(%w)*](https://go.dev/blog/go1.13-errors) æ·»åŠ äº†é¢å¤–çš„ä¸Šä¸‹æ–‡ï¼Œä»¥äº†è§£å“ªä¸ªæµå¼•å‘äº†é”™è¯¯ã€‚

ä¸Šé¢æ²¡æœ‰å…·ä½“çš„é€»è¾‘ã€‚åœ¨æˆ‘ä»¬çš„é›†æˆæµ‹è¯•å®Œæˆä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥ç»ˆæ­¢æˆ‘ä»¬çš„å®¹å™¨ã€‚æˆ‘æ€»æ˜¯å°è¯•ä½¿ç”¨`context.WithTimeout`æ¥å®Œæˆè¿™ç±»ä»»åŠ¡ã€‚`Terminate`æ–¹æ³•åº”ä½¿å…¶åœ¨æœ€å¤š 5 ç§’å†…è¿”å›ã€‚

## ğŸ‘‰ç”¨ Dockertest å®ç°

å› ä¸ºå¥—ä»¶ç”Ÿå‘½å‘¨æœŸä¸ testcontainer éƒ¨åˆ†ç›¸åŒï¼Œæ‰€ä»¥æˆ‘è·³è¿‡äº†è¿™ä¸€éƒ¨åˆ†ã€‚

ä¹ä¸€çœ‹ï¼Œæ‚¨æ„è¯†åˆ°æˆ‘ä»¬å®ç°äº†æˆ‘ä»¬çš„è‡ªç”±ç«¯å£å®ç°ï¼Œå¹¶å°†å…¶ä¸æˆ‘ä»¬çš„å®¹å™¨é›†æˆåœ¨ä¸€èµ·ã€‚å› ä¸ºæ²¡æœ‰æš´éœ²çš„éšæœºä¸»æœºç«¯å£ä½œä¸º testcontainerï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥è‡ªå·±åšã€‚

`ExposedPorts`ä¸ºå®¹å™¨çš„é€è§†å›¾ã€‚

`PortBinding`ç”¨äºæä¾›å®¹å™¨å’Œä¸»æœºç«¯å£çš„æ˜ å°„ç»‘å®šã€‚

æˆ‘ä»¬è¿˜éœ€è¦æ˜¾å¼åœ°è®¾ç½®`[advertise-kafka-addr](https://www.confluent.io/blog/kafka-listeners-explained/)`æ¥æä¾›ä»æˆ‘ä»¬çš„ä¸»æœºåˆ°å®¹å™¨çš„è¿æ¥ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸åœ¨ testcontainer éƒ¨åˆ†è®¾ç½®å®ƒğŸ¤”ã€‚è¿™æ˜¯å› ä¸ºå®¹å™¨ 9092 ç«¯å£åœ¨å†…éƒ¨æš´éœ²ç»™äº†ç©ºé—²çš„éšæœºä¸»æœºç«¯å£ã€‚ä½†æ˜¯åœ¨è¿™é‡Œï¼Œå¦‚æœæˆ‘ä»¬ä¸æä¾›è¿™ä¸ªï¼Œæˆ‘ä»¬å¿…é¡»ä½œä¸ºä¸»æœºçš„ 9092 ç«¯å£è¿æ¥ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸æƒ³ä½¿ç”¨é™æ€ä¸»æœºç«¯å£è¿›è¡Œå¹¶è¡Œè¿è¡Œã€‚

æˆ‘ä»¬è¿˜æä¾›äº†ä¸€ä¸ª`retryFunc`æ¥äº†è§£æˆ‘ä»¬çš„å®¹å™¨æ˜¯å¦å‡†å¤‡å¥½äº†ã€‚RetryFunc å°è¯•è¿æ¥ Kafka brokersï¼Œå¦‚æœè¿æ¥æˆåŠŸå»ºç«‹ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å‰è¿›ï¼Œæˆ–è€…å°è¯•ç”¨å¯è°ƒé€€é¿æ—¶é—´é‡æ–°è¿æ¥ã€‚

åœ¨`cleanUp`ç«¯ï¼Œæˆ‘ä»¬æ¸…é™¤æˆ‘ä»¬çš„å®¹å™¨ï¼Œä» docker ä¸­åˆ é™¤å®¹å™¨å’Œé“¾æ¥çš„å·ã€‚

## æˆ‘ä»¬çš„æµ‹è¯•ğŸš€

æˆ‘æ€»æ˜¯è¯•ç€æŠŠæˆ‘çš„æµ‹è¯•å’Œç»™å®šæ—¶é—´åˆ†å¼€ã€‚å®ƒçš„æ„æ€æ˜¯ï¼Œåœ¨æŸç§æƒ…å†µä¸‹ï¼Œå½“æŸç§è¡Œä¸ºè¢«æ‰§è¡Œæ—¶ï¼Œå°±ä¼šå‘ç”Ÿä¸€ç³»åˆ—çš„åæœã€‚

æˆ‘è¿˜å°è¯•ç”¨ä¸‹åˆ’çº¿æ¥å‘½åæˆ‘çš„æµ‹è¯•ã€‚è¿™æ ·ï¼Œé€šè¿‡æœç´¢ go test è¾“å‡ºï¼Œå¾ˆå®¹æ˜“æ‰¾åˆ°å¤±è´¥çš„å‡½æ•°ã€‚

**æºä»£ç :**[https://github . com/abdulsamiteleri/integration-tests-with-red panda](https://github.com/Abdulsametileri/integration-tests-with-redpanda)

æ„Ÿè°¢æ‚¨çš„é˜…è¯»ğŸ’›ï¼›ä½ ä¹Ÿå¯ä»¥çœ‹çœ‹æˆ‘çš„å…¶ä»–æ–‡ç« ã€‚

*   [å¡å¤«å¡ä¾‹å¤– Cronsumer](https://medium.com/trendyol-tech/kafka-exception-c-r-onsumer-37c459e4849d)
*   [è®©æˆ‘ä»¬ä½¿ç”¨ Go](https://itnext.io/lets-implement-a-real-time-package-tracking-app-with-rabbitmq-and-web-socket-using-go-80f5a5ca5c55) é€šè¿‡ RabbitMQ å’Œ Web socket å®ç°ä¸€ä¸ªå®æ—¶åŒ…è£¹è·Ÿè¸ªåº”ç”¨ç¨‹åº
*   [è®©æˆ‘ä»¬ä½¿ç”¨ Go å®ç°åŸºæœ¬çš„æœåŠ¡å‘ç°](https://itnext.io/lets-implement-basic-service-discovery-using-go-d91c513883f6)
*   [æˆ‘å¦‚ä½•ä½¿ç”¨ pure Go æ„å»ºä¸€ä¸ªç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ(VCS)](/how-was-i-build-a-version-control-system-vcs-using-pure-go-83ec8ec5d4f4)
*   [å°† Grafana é€šçŸ¥ä¸ GitLab ç®¡é“é›†æˆï¼Œä½¿ç”¨ Go é‡æ–°å¯åŠ¨ Debezium ä»»åŠ¡](https://medium.com/modanisa-engineering/integrating-grafana-notifications-with-gitlab-pipeline-to-restart-debezium-tasks-using-go-1378c9eaf7b8)
*   [é”®ç›˜é”ç®€ä»‹](https://medium.com/codex/introduction-to-keycloak-227c3902754a)

## å‚è€ƒ

[1]ã€Šå¹²å‡€çš„ç¨‹åºå‘˜:èŒä¸šç¨‹åºå‘˜çš„è¡Œä¸ºå‡†åˆ™ã€‹

[2]https://redpanda.com

[3][https://www.testcontainers.org/features/networking/](https://www.testcontainers.org/features/networking/)

[https://www.confluent.io/blog/kafka-listeners-explained/](https://www.confluent.io/blog/kafka-listeners-explained/)