<html>
<head>
<title>How I Made Power Outage Notifications Using a Serverless Function for Free</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何免费使用无服务器功能发出停电通知</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-i-made-power-outage-notifications-using-a-serverless-function-for-free-ceb0f7714284?source=collection_archive---------3-----------------------#2019-06-27">https://levelup.gitconnected.com/how-i-made-power-outage-notifications-using-a-serverless-function-for-free-ceb0f7714284?source=collection_archive---------3-----------------------#2019-06-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2280" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">发布于2019年6月5日</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/8c77dff06c51d553b957873ba7e78a5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YCsAp57XRpSQRe4e"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/@nasa?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> NASA </a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><h1 id="0a7a" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">原因</h1><p id="01fe" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">有一天我在工作，碰巧查看了我的电子邮件。我注意到一个社区应用程序生成的标题为“有人停电了吗？”。</p><p id="b1ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我是一个很喜欢智能家居的人，所以我当然会在家里安装摄像头和传感器。我很快检查我的相机饲料，果然:无法连接。我的一些智能家居技术人员说它已经有一个小时没有连接了。</p><p id="af6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我有点慌了，因为去年夏天我们彻底完成了我们的地下室。我买了我能找到的最好的带备用电池的排水泵，但我从未测试过它。我不知道这场雨会持续多久，当然这几天一直在下雨。我工作的地方离这里有35分钟的路程，所以我开始给家人打电话，看看他们中有没有人能借我一台发电机。</p><p id="e7e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们通过城市获得电力，我们的城市有一个网站。在这个网站上有一个显示城市地图的链接，所有停电都用阴影标出。果然，我家是停电的一部分。非常方便。我不停地按刷新键，看看有没有更新。</p><p id="862d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">又过了一个小时，地图终于更新了。我的房子已经不在阴影部分了。我检查了我的相机，它们又开了！我终于可以放松了。</p><h1 id="80f5" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">一定有更好的方法</h1><p id="78a4" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">所以，无论我的家有多智能，有水传感器和报警器，如果我的家没有电，它就没有办法和我交流。</p><p id="0447" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">直到我能买得起一个在没电时自动打开的天然气发电机，我需要能够在停电的几个小时内回家并连接上一个便携式发电机，否则我可能会因地下室洪水损坏而损失数千美元。</p><p id="2e98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我在网上查了一下，看看有没有什么服务可以在停电时提醒我。没什么。当然，我的电力供应商没有为我的小镇提供这样的服务…</p><p id="e87b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是等等…他们有那张地图。我想知道那张地图是如何得到数据来知道哪些部分有阴影的。</p><h1 id="a78c" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">在网站上检查幕后</h1><p id="7246" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">如果你用谷歌浏览器加载一个网站，你可以点击<code class="fe mf mg mh mi b">F12 </code>来查看开发者工具。其中一个选项卡叫做“网络”。该选项卡将向您显示该网站需要引入的所有资产，如图像、字体、数据，并显示其来源。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mj"><img src="../Images/6bc850381a3a7f58308c3136fbab070e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5X4TStg-Rp_NR8Pb.jpeg"/></div></div></figure><p id="aec0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Chrome开发工具。我把我的调成了黑暗模式。</p><p id="5a05" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最初加载该选项卡时，它可能是空白的。只要刷新网站，它就会开始填充数据。</p><p id="d1b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我感兴趣的部分是它从服务器获取的任何数据。所以我过滤了XHR。果然，我找到一个叫做<code class="fe mf mg mh mi b">get_live_data</code>的。点击它会显示任何停机的数据！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mk"><img src="../Images/1b255f51fcf115cf2d41894b66eb8438.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hR4PaBYNIEklla3x.jpeg"/></div></div></figure><p id="7962" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用API从服务器获取停机信息</p><p id="a41b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但他们肯定有某种认证和安全措施，所以不是任何人都可以访问这些数据。我决定找出答案。我加载了一个名为<a class="ae lb" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank">邮递员</a>的免费工具来检查API。</p><p id="43e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从开发工具的Headers选项卡中，我找到了<code class="fe mf mg mh mi b">Request URL</code>。当我把它插入Postman时，它返回相同的中断结果！这个API对公众开放，我可以在自己的应用程序中使用它。太棒了。🙌</p><p id="e855" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是等等，还有更好的。进一步浏览地图，我发现了一个获取断电细节的链接。当我查看其背后的API时，我发现它给了我一个中断的街道名称列表。这是完美的，因为现在我可以只检查我的街道名称，而不是经度和纬度。</p><blockquote class="ml mm mn"><p id="74da" class="jn jo mo jp b jq jr js jt ju jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj kk ij bi translated"><em class="iq">注意:我知道这是我的特殊情况。这实际上不会帮助任何人，除非他们和我住在同一个城镇。然而，我的目标是展示我是如何在网站的幕后看到它是如何工作的。</em></p></blockquote><p id="ad58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我有我的数据。但是现在我需要一种方法来持续检查我的街道是否出现。通常我会设置一个web服务器，它有一个调用API和解析街道名称的时间表。然而，我的问题是:</p><ul class=""><li id="f3aa" class="ms mt iq jp b jq jr ju jv jy mu kc mv kg mw kk mx my mz na bi translated">我不能在我的房子里托管这个web服务器，因为这样做的目的是为了发现我的房子什么时候没电了。</li><li id="3b8e" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">托管一个在云中运行代码的web服务器可能要花钱。即使一个月只有5美元，我也不想为此付钱。</li></ul><h1 id="e579" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">无服务器功能来拯救</h1><p id="eb04" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">我最近听到人们谈论无服务器功能有多棒，以及它们将如何改变开发，但我从未真正研究过它们，也没有发现对它们的需求。</p><p id="088a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">基本上，您可以编写一些基于触发器运行的代码。不需要在服务器上安装操作系统，也不需要确保操作系统正在运行、是最新的并且是安全的。并且不需要安装整个网站框架。</p><p id="d301" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这听起来很有趣，所以我查看了亚马逊最受欢迎的服务之一，名为<a class="ae lb" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>。他们甚至有一个免费层，只要你每月运行该功能少于一百万次。相当慷慨！</p><p id="205d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我注册了AWS。这确实需要一张信用卡，这样如果我去他们的免费层，我将被收费。他们有一个账单预算提醒系统，你可以设置它，这样你就可以在事情发生前得到通知。</p><p id="6438" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS Lambda允许你用几种不同的语言编写。我最近一直在努力学习Python，所以我选择了这个。</p><h1 id="6704" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">设置您的环境</h1><p id="0f86" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">此时，我已经准备好直接从AWS网站上创建这个函数。这肯定是可能的，它有一个内置的代码编辑器和所有你需要的工具。然而，我发现一种更简化的方法是在我的计算机上本地开发代码，并使用一个名为serverless的npm包将其引入AWS。因此，这假设您的系统上安装了Python 3，并且还安装了Node JS v6.5.0或更高版本。</p><h1 id="86d8" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">步骤1:创建框架</h1><p id="b17f" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">从您的终端安装无服务器</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="ff3e" class="nk ld iq mi b gy nl nm l nn no">npm install -g serverless</span></pre><p id="e129" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在转到您想要存储该项目的位置。我有一个名为“代码”的文件夹，所以我在终端的那个文件夹中运行了这个</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="63b1" class="nk ld iq mi b gy nl nm l nn no">serverless create</span></pre><p id="ed99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将在代码中创建一个名为<code class="fe mf mg mh mi b">power-outage-bot</code>的新文件夹。在该文件夹中，它创建了两个文件:</p><p id="076e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在您喜欢的代码编辑器中加载这些代码。我使用免费的<a class="ae lb" href="https://www.jetbrains.com/pycharm/" rel="noopener ugc nofollow" target="_blank"> PyCharm社区</a> IDE。</p><p id="7829" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在向power-outage-bot文件夹添加一个名为requirements.txt的新文件。</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="a7e0" class="nk ld iq mi b gy nl nm l nn no">requests</span></pre><p id="e994" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将确保请求模块被加载到Python中。</p><h1 id="4459" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">步骤2:通过AWS进行身份验证</h1><p id="518f" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">接下来，设置您的本地系统以连接到您的AWS帐户。</p><ul class=""><li id="00f9" class="ms mt iq jp b jq jr ju jv jy mu kc mv kg mw kk mx my mz na bi translated">登录AWS控制台，进入服务&gt;安全&gt; IAM。找到“用户”部分，点击“添加用户”蓝色按钮。</li><li id="ecfd" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">选择一个用户名，然后只选择“编程访问”复选框。</li><li id="baf9" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">在第二页上，选择“直接附加现有策略”。寻找“管理员访问”并检查它。</li><li id="db4c" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">最后，一旦用户被创建，它将显示您的“访问密钥ID”和“秘密访问密钥”。把这些拷贝到安全的地方。</li></ul><p id="a3b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回到你的终端，通过键入添加密钥(替换&lt;&gt;部分)</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="f975" class="nk ld iq mi b gy nl nm l nn no">export AWS_ACCESS_KEY_ID=&lt;Access key ID&gt; export AWS_SECRET_ACCESS_KEY=&lt;Secret access key&gt;</span></pre><h1 id="1c21" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">第三步:设置你的电报机器人</h1><p id="633a" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">这个功能需要在我没电的时候提醒我。如果你愿意，你可以设置电子邮件或短信，但你需要找到一个提供这些服务的服务，因为我们不使用服务器，这可能需要每月付费。我敢肯定，如果你搜索，有免费层可用。</p><p id="4a7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对我来说，我决定用<a class="ae lb" href="https://telegram.org/" rel="noopener ugc nofollow" target="_blank">电报</a>。这是我手机上的一个免费应用程序，你可以用它在Telegram上与其他人交流。Telegram对开发者非常友好，它允许你创建免费的机器人，你的代码可以插入其中以便进行通信。</p><p id="6231" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦你在手机上安装了Telegram并设置了帐户，你就可以与<a class="ae lb" href="https://web.telegram.org/#/im?p=@BotFather" rel="noopener ugc nofollow" target="_blank"> @botFather </a>开始新的对话。您也可以从计算机上的web浏览器中完成此操作。键入<code class="fe mf mg mh mi b">/newbot</code> to @botFather，它会引导你设置一个新的机器人。最后，@botFather会给你一个令牌，你可以用它从我们的Python代码连接到bot。让我们从终端将它存储在一个环境变量中。</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="cbee" class="nk ld iq mi b gy nl nm l nn no">export TELEGRAM_TOKEN="4592342328:APHruyw7ZFj5qOasDFSDFdsfdDFSFJxil-zsdF98"</span></pre><p id="d65a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">@botFather还会显示创建的新机器人的链接。转到这个开始对话。你可以发送任何东西，只要说点什么，它就会打开一个频道。</p><p id="fba6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为你是唯一一个将要与你刚刚创建的这个新机器人对话的人，所以我们只关心向这个聊天对话发送警报。我们需要获取聊天id。</p><p id="6fd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将以下内容粘贴到您的浏览器中，但用您的令牌替换<code class="fe mf mg mh mi b">&lt;API-access-token&gt;</code>:</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="ca57" class="nk ld iq mi b gy nl nm l nn no">https:<em class="mo">//api.telegram.org/bot&lt;API-access-token&gt;/getUpdates?offset=0</em></span></pre><p id="2274" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您应该能够从结果中找到您的聊天id。它将是聊天部分中的id。</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="134a" class="nk ld iq mi b gy nl nm l nn no">{  <br/>   "ok":true,<br/>   "result":[  <br/>      {  <br/>         "update_id":XXXXXXXXX,<br/>         "message":{  <br/>            "message_id":2,<br/>            "from":{  <br/>               "id":123456789,<br/>               "first_name":"Mushroom",<br/>               "last_name":"Kap"<br/>            },<br/>            "chat":{  <br/>               "id":123456789,<br/>               "first_name":"Mushroom",<br/>               "last_name":"Kap",<br/>               "type":"private"<br/>            },<br/>            "date":1487183963,<br/>            "text":"hi"<br/>         }<br/>      }<br/>   ]<br/>}</span></pre><p id="fa14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们将它保存到一个环境变量中</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="591c" class="nk ld iq mi b gy nl nm l nn no">export CHAT_ID=123456789</span></pre><p id="1c79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们不需要用Telegram设置任何类型的网络挂钩，因为所有的通信都是单向的。机器人会通知我，但我没有在我的代码中听到任何响应。</p><h1 id="fd2f" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">编码时间到了</h1><p id="3e68" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">最后，设置完成后，让我们开始编码吧！</p><p id="a568" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe mf mg mh mi b">handler.py</code>载入你的编辑器。我们的Python代码将需要一些包，所以确保这是在顶部</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="e3ec" class="nk ld iq mi b gy nl nm l nn no">import json<br/>import os<br/>import sys<br/><br/>here = os.path.dirname(os.path.realpath(__file__))<br/>sys.path.append(os.path.join(here, "./vendored"))<br/><br/>import requests</span></pre><p id="7f83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们设置一些我们将在整个代码中使用的常量，这样就更容易阅读和更新了</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="4236" class="nk ld iq mi b gy nl nm l nn no">TOKEN = os.environ['TELEGRAM_TOKEN']<br/>CHAT_ID = os.environ['CHAT_ID']<br/>BASE_URL = "https://api.telegram.org/bot{}".format(TOKEN)<br/>STREETS_TO_CHECK = [<br/>    'SESAME ST',<br/>    'MAIN ST'<br/>]</span></pre><p id="1310" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我决定，如果我的任何朋友和家人遭遇停电，我希望得到提醒，这样我就可以让他们知道，而不是只检查一条街道。这就是为什么我列出了街道，而不仅仅是街道的字符串。</p><p id="b1ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们想给电力公司的API打电话，获取他们停电的街道列表。然后我们想过滤列表，只显示我们关心的街道。</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="1e9d" class="nk ld iq mi b gy nl nm l nn no">def check_power_outages():<br/>    url = "http://path_to_public_power_api.com/get_outage_details"<br/>    response = requests.request("POST", url)<br/>    data = json.loads(response.text)<br/>    return list(filter(filter_streets, data["Streets"]))</span></pre><p id="ebd3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在return语句中使用的Python过滤函数使用了一个名为<code class="fe mf mg mh mi b">filter_streets</code>的过滤方法。看起来是这样的:</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="a69a" class="nk ld iq mi b gy nl nm l nn no">def filter_streets(street):<br/>    return street in STREETS_TO_CHECK</span></pre><p id="51fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不言自明。这个<code class="fe mf mg mh mi b">filter(filter_streets, data["Streets"])</code>正在检查每一条断电的街道，并过滤出那些包含在我要检查的街道列表中的街道。最后，我们将结果放入Python列表中。</p><p id="8309" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将由AWS运行的主要功能称为<code class="fe mf mg mh mi b">hello</code>。这是里面的代码。</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="083d" class="nk ld iq mi b gy nl nm l nn no">def hello(event, context):<br/>    filtered_streets = check_power_outages()<br/>    if filtered_streets:<br/>        response = ''<br/>        try:<br/>            for filtered_street in filtered_streets:<br/>                response += 'Power out on ' + filtered_street + '! '<br/><br/>            response += 'http://link-to-power-outage-map.com'<br/><br/>            data = {"text": response.encode("utf8"), "chat_id": CHAT_ID}<br/>            url = BASE_URL + "/sendMessage"<br/>            requests.post(url, data)<br/><br/>        except Exception as e:<br/>            print(e)<br/><br/>    return {"statusCode": 200}</span></pre><p id="5a98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们调用刚刚构建的<code class="fe mf mg mh mi b">check_power_outages </code>方法，并返回我们关心的街道列表。</p><p id="2c00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Python中，如果列表为空，那么当在“if”语句中调用时，它将返回一个<code class="fe mf mg mh mi b">False </code>。因此，当我们说<code class="fe mf mg mh mi b">if filtered_streets:</code>没有中断时，它将简单地跳到结尾，什么也不做。</p><p id="0b08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，如果它找到了一条或多条街道，它将开始遍历这些街道并构建我们想要发送给机器人的消息。</p><p id="a974" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，它将我们的响应放入一个Python字典中，该字典还包含聊天id。然后我们用<code class="fe mf mg mh mi b">requests.post(url, data)</code>把它发送给聊天机器人。</p><h1 id="f0c3" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">将其部署到AWS</h1><p id="6fcd" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">看一看生成的<code class="fe mf mg mh mi b">serverless.yml</code>。这是您的AWS配置文件。这是我的样子:</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="d9af" class="nk ld iq mi b gy nl nm l nn no">service: power-outage-bot<br/>provider:<br/>  name: aws<br/>  runtime: python3.7<br/>  stage: dev<br/>  region: us-east-1<br/>  environment:<br/>    TELEGRAM_TOKEN: ${env:TELEGRAM_TOKEN}<br/>    CHAT_ID: ${env:CHAT_ID}<br/>functions:<br/>  hello:<br/>    handler: handler.hello<br/>    events:<br/>      - schedule: rate(15 minutes)</span></pre><p id="4de2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我已经将我的触发器设置为每15分钟运行一次的计划。这使我保持在每月100万次的请求之下。</p><p id="e09a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们准备将它发送到AWS。回到您的终端，键入</p><pre class="km kn ko kp gt ng mi nh ni aw nj bi"><span id="19d8" class="nk ld iq mi b gy nl nm l nn no">serverless deploy</span></pre><p id="2bac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样。该功能现在应该每15分钟运行一次。无服务器框架还设置了AWS CloudWatch的日志记录。如果您在AWS控制台中访问该服务，您应该会看到一个日志部分，一段时间后，它应该会开始填充。</p><blockquote class="ml mm mn"><p id="939c" class="jn jo mo jp b jq jr js jt ju jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj kk ij bi translated"><em class="iq">提示:如果您需要稍微调试一下，Python中的任何</em> <code class="fe mf mg mh mi b"><em class="iq">print()</em></code> <em class="iq">语句都会被记录下来。</em></p></blockquote><h1 id="b465" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">结论</h1><p id="f860" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">现在我有一个警报系统，当我家里停电时，它会告诉我。我不必让服务器在任何地方运行，而且它是完全免费的。还不错。</p><p id="7756" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">显然，只有当你和我住在同一个城镇时，这种特殊的设置才有效，否则城市断电API对你来说毫无价值。但是希望这能给你一些想法，告诉你如何基于你能访问的其他类型的数据来创建你自己的通知系统。</p><h1 id="0b20" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">参考</h1><p id="b581" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">当我从事这个项目时，我发现这些帖子非常有用:</p><ul class=""><li id="26c5" class="ms mt iq jp b jq jr ju jv jy mu kc mv kg mw kk mx my mz na bi translated"><a class="ae lb" href="https://hackernoon.com/serverless-telegram-bot-on-aws-lambda-851204d4236c" rel="noopener ugc nofollow" target="_blank">AWS Lambda上的无服务器电报机器人</a></li><li id="edd9" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated"><a class="ae lb" href="https://dev.to/nqcm/-building-a-telegram-bot-with-aws-api-gateway-and-aws-lambda-27fg" rel="noopener ugc nofollow" target="_blank">使用AWS API网关和AWS Lambda构建电报机器人</a></li></ul></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><p id="0c18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mo">原发布于</em><a class="ae lb" href="https://nlehman.dev/blog/post/how-i-made-power-outage-notifications-using-serverless-function" rel="noopener ugc nofollow" target="_blank"><em class="mo">https://nlehman . dev</em></a><em class="mo">。</em></p></div></div>    
</body>
</html>