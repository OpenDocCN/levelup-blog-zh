<html>
<head>
<title>Getting Browser User Permission with the Permissions API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用权限API获取浏览器用户权限</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/getting-browser-user-permission-with-the-permissions-api-eafbc9c7f4d7?source=collection_archive---------4-----------------------#2020-02-01">https://levelup.gitconnected.com/getting-browser-user-permission-with-the-permissions-api-eafbc9c7f4d7?source=collection_archive---------4-----------------------#2020-02-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/e558a7953ab912474856fe69c6ab09d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*urDxqLAX5N3EN3XC"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">本·怀特在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="6c0d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我们想做任何改变用户体验的事情时，我们必须得到用户的同意。例如，我们需要获得用户许可来显示通知或访问他们的硬件。</p><p id="e4ba" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现代浏览器在如何获得权限方面是标准化的。这些都在权限API中。</p><p id="c429" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">依赖权限API获取权限的API包括剪贴板API、通知API、推送API和Web MIDI API。</p><p id="9007" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在标准浏览器和工作环境中，<code class="fe le lf lg lh b">navigator</code>对象都有<code class="fe le lf lg lh b">permissions</code>属性。这给了我们一个获得许可的方法。然而，对于每个API，我们请求权限的方式是不同的。</p><p id="8b86" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个API是实验性的，所以检查你的目标浏览器是否受支持。</p><h1 id="0576" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">查询权限</h1><p id="4d29" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated"><code class="fe le lf lg lh b">navigation.permissions</code>对象让我们查询用<code class="fe le lf lg lh b">query</code>方法设置的权限。</p><p id="84f7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它返回一个承诺，让我们得到许可的状态。例如，我们可以编写以下代码来检查地理定位API的权限:</p><pre class="ml mm mn mo gt mp lh mq mr aw ms bi"><span id="4b20" class="mt lj it lh b gy mu mv l mw mx">(async () =&gt; {<br/>  const result = await navigator.permissions.query({<br/>    name: 'geolocation'<br/>  });<br/>  console.log(result.state);<br/>})();</span></pre><p id="95bc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">result.state</code>的可能值是<code class="fe le lf lg lh b">'granted'</code>、<code class="fe le lf lg lh b">'denied'</code>或<code class="fe le lf lg lh b">'prompt'</code>。</p><p id="43ed" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">也有一个为网络工作者做同样的事情。</p><p id="ce89" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们传递给<code class="fe le lf lg lh b">query</code>方法的对象是权限描述符对象，它具有以下属性:</p><ul class=""><li id="0860" class="my mz it ki b kj kk kn ko kr na kv nb kz nc ld nd ne nf ng bi translated"><code class="fe le lf lg lh b">name</code> —我们想要获得许可的API的名称。火狐只支持<code class="fe le lf lg lh b">geolocation</code>、<code class="fe le lf lg lh b">notifications</code>、<code class="fe le lf lg lh b">push</code>和<code class="fe le lf lg lh b">persistent-storage</code></li><li id="b132" class="my mz it ki b kj nh kn ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><code class="fe le lf lg lh b">userVisibleOnly</code> —表示我们是否希望显示每条消息的通知，或者能够发送静默推送通知。默认值为<code class="fe le lf lg lh b">false</code>。</li><li id="a482" class="my mz it ki b kj nh kn ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><code class="fe le lf lg lh b">sysex</code> —仅适用于MIDI。指示我们是否需要接收系统独占消息。默认值为<code class="fe le lf lg lh b">false</code>。</li></ul><h1 id="9ce8" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">请求许可</h1><p id="b55f" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">请求权限在API之间是不同的。例如，当我们调用<code class="fe le lf lg lh b">getCurrentPosition()</code>时，地理定位API将显示一个权限提示，如下所示:</p><pre class="ml mm mn mo gt mp lh mq mr aw ms bi"><span id="411a" class="mt lj it lh b gy mu mv l mw mx">navigator.geolocation.getCurrentPosition((position) =&gt; {<br/>  console.log('Geolocation permissions granted');<br/>  console.log(`Latitude: ${position.coords.latitude}`);  <br/>  console.log(`Longitude: ${position.coords.longitude}`);<br/>});</span></pre><p id="5cf1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通知API有一个<code class="fe le lf lg lh b">requestPermission</code>方法来请求权限:</p><pre class="ml mm mn mo gt mp lh mq mr aw ms bi"><span id="d82b" class="mt lj it lh b gy mu mv l mw mx">Notification.requestPermission((result) =&gt; {<br/>  console.log(result);<br/>});</span></pre><h1 id="23b3" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">监视权限更改</h1><p id="d0c3" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">这个<code class="fe le lf lg lh b">navigator.permissions.query</code>承诺解析为一个<code class="fe le lf lg lh b">PermissionStatus</code>对象。我们可以用它来设置一个<code class="fe le lf lg lh b">onchange</code>事件处理函数来监视权限的变化。</p><p id="a4e9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我们可以对此示例进行扩展，添加一个事件处理函数来监视地理位置API权限的变化:</p><pre class="ml mm mn mo gt mp lh mq mr aw ms bi"><span id="3cc0" class="mt lj it lh b gy mu mv l mw mx">(async () =&gt; {<br/>  const result = await navigator.permissions.query({<br/>    name: 'geolocation'<br/>  });<br/>  console.log(result.state);<br/>})();</span></pre><p id="80e5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以写:</p><pre class="ml mm mn mo gt mp lh mq mr aw ms bi"><span id="ee6f" class="mt lj it lh b gy mu mv l mw mx">(async () =&gt; {<br/>  const permissionStatus = await navigator.permissions.query({<br/>    name: 'geolocation'<br/>  });<br/>  permissionStatus.onchange = () =&gt; {<br/>    console.log(permissionStatus.state);<br/>  }<br/>})();</span></pre><p id="8495" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">permissionStatus.state</code>将拥有地理定位API的权限。</p><p id="ef0a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每当权限改变时，例如当我们在浏览器中改变权限设置时，它就会记录下来。</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nm"><img src="../Images/9ff4c928c7ff7ff776934f1ba0d32d07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uvjhMKQ6Mv5YZGTC"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@lazycreekimages?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Michael Dziedzic </a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><h1 id="e46d" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">撤销权限</h1><p id="69aa" class="pw-post-body-paragraph kg kh it ki b kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz mk lb lc ld im bi translated">我们可以通过使用<code class="fe le lf lg lh b">revoke</code>方法来撤销许可。</p><p id="84ad" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要调用它，我们可以从<code class="fe le lf lg lh b">navigator.permissions</code>对象访问它，如下所示:</p><pre class="ml mm mn mo gt mp lh mq mr aw ms bi"><span id="e9e9" class="mt lj it lh b gy mu mv l mw mx">navigator.permissions.revoke(descriptor);</span></pre><p id="8785" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其中<code class="fe le lf lg lh b">descriptor</code>是我们上面描述的许可描述符。</p><p id="2615" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它返回一个承诺，用指示请求结果的权限状态对象进行解析。</p><p id="27bd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果获取权限描述符失败，或者权限不存在或不受浏览器支持，此方法将引发TypeError。</p><p id="5b42" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">权限描述符的<code class="fe le lf lg lh b">name</code>属性可以接受以下值之一<code class="fe le lf lg lh b">'geolocation'</code>、<code class="fe le lf lg lh b">'midi'</code>、<code class="fe le lf lg lh b">'notifications'</code>和<code class="fe le lf lg lh b">'push'</code>。</p><p id="c810" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其他属性保持与<code class="fe le lf lg lh b">query</code>方法相同。</p><p id="2e2a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我们可以这样使用它:</p><pre class="ml mm mn mo gt mp lh mq mr aw ms bi"><span id="5c72" class="mt lj it lh b gy mu mv l mw mx">(async () =&gt; {<br/>  const permissionStatus = await navigator.permissions.revoke({<br/>    name: 'geolocation'<br/>  });<br/>  console.log(permissionStatus);<br/>})();</span></pre><p id="b727" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意，我们必须在Firefox 51或更高版本中将<code class="fe le lf lg lh b">dom.permissions.revoke.enable</code>设置为<code class="fe le lf lg lh b">true</code>才能使用这个方法。Chrome中没有启用。</p><p id="d9e6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">权限API让我们以统一的方式检查和撤销浏览器权限。</p><p id="b1dc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于每个API，请求权限是不同的。这种情况短期内不会改变。</p><p id="8db6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是一个实验性的API，所以在生产中使用它可能还为时过早。</p></div></div>    
</body>
</html>