<html>
<head>
<title>Spinning up a Node.js Server in a Container on AWS with EC2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用EC2在AWS上的容器中启动Node.js服务器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/spinning-up-a-node-js-server-in-a-container-on-aws-with-ec2-2cf7f41f4aec?source=collection_archive---------4-----------------------#2021-11-22">https://levelup.gitconnected.com/spinning-up-a-node-js-server-in-a-container-on-aws-with-ec2-2cf7f41f4aec?source=collection_archive---------4-----------------------#2021-11-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/aa4aea96d8d10071fba6cd525136cebb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m8p6DOfDklenW_axMlqNIw.jpeg"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://unsplash.com/@convertkit?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">转换器</a>在<a class="ae jg" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">去飞溅</a>上拍照</figcaption></figure><h2 id="67ec" class="jh ji jj bd b dl jk jl jm jn jo jp dk jq translated" aria-label="kicker paragraph">给未来自己的笔记</h2><div class=""/><div class=""><h2 id="3a8e" class="pw-subtitle-paragraph kp js jj bd b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dk translated">我需要这样做，我做了笔记。随便抄。</h2></div><p id="20cd" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">对于工作中的一个项目，我需要在Docker容器中运行Node.js Express服务器，然后将该容器部署到AWS上的EC2实例。我一路上做着笔记，因为我确信有一天我还需要做类似的事情。然后，我想——既然我做了笔记——我不妨分享一下我的笔记。</p><p id="4752" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">您可以根据自己的需要概括我的用例。它不一定是Node.js服务器。它可以是您需要部署到AWS EC2的任何Docker容器映像，只要您知道您需要向外界公开容器上的哪个(哪些)端口。</p><p id="6494" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">你准备好开始了吗？开始了。</p><h1 id="46e8" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">1.建立Docker形象</h1><p id="3fe7" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">对于本文，我们将通过部署一个具有单个端点的基本Node.js Express服务器来保持简单。我初始化了Node.js项目，添加了<code class="fe na nb nc nd b">express</code>，然后写了下面的<code class="fe na nb nc nd b">index.js</code>文件:</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="3e7f" class="nm me jj nd b gy nn no l np nq">const PORT = 8080;<br/>const express = require('express');<br/>const app = express();</span><span id="e032" class="nm me jj nd b gy nr no l np nq">app.get('/', async (req, res, next) =&gt; {<br/>  res.send('Hello world.');<br/>});</span><span id="9cf0" class="nm me jj nd b gy nr no l np nq">app.listen(PORT, () =&gt; {<br/>  console.log(`Server is listening on port ${PORT}`);<br/>});</span></pre><p id="f0e6" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">注意，我的例子中的服务器正在监听端口<code class="fe na nb nc nd b">8080</code>。这是我的项目文件夹的样子:</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="595b" class="nm me jj nd b gy nn no l np nq">$ tree -L 1<br/>.<br/>├── index.js<br/>├── node_modules<br/>├── package.json<br/>└── yarn.lock</span><span id="4f04" class="nm me jj nd b gy nr no l np nq">1 directory, 3 files</span></pre><p id="465e" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">为了将这个项目作为Docker容器进行部署，我们编写了一个<code class="fe na nb nc nd b">Dockerfile</code>，将其放在项目根文件夹中。</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="0786" class="nm me jj nd b gy nn no l np nq">FROM node:14-alpine</span><span id="908e" class="nm me jj nd b gy nr no l np nq">WORKDIR /usr/src/app</span><span id="ff1b" class="nm me jj nd b gy nr no l np nq">COPY package*.json /usr/src/app<br/>RUN npm install</span><span id="b6b9" class="nm me jj nd b gy nr no l np nq">COPY . .</span><span id="84af" class="nm me jj nd b gy nr no l np nq">EXPOSE 8080</span><span id="a982" class="nm me jj nd b gy nr no l np nq">CMD ["node", "index.js"]</span></pre><p id="bcc2" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我的项目运行在节点<code class="fe na nb nc nd b">v14.16.0</code>上。你可以运行<code class="fe na nb nc nd b">node --version</code>确定你的版本，然后找到对应的<a class="ae jg" href="https://hub.docker.com/_/node" rel="noopener ugc nofollow" target="_blank">节点高山基图</a>。写好你的<code class="fe na nb nc nd b">Dockerfile</code>，建立图像。</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="0034" class="nm me jj nd b gy nn no l np nq">$ docker build --file ./Dockerfile --tag my-node-server .<br/>...<br/>Successfully built a6df3f2bda72<br/>Successfully tagged my-node-server:latest</span><span id="0536" class="nm me jj nd b gy nr no l np nq">$ docker images<br/>REPOSITORY        TAG         IMAGE ID       CREATED         SIZE<br/>my-node-server    latest      a6df3f2bda72   2 minutes ago   123MB</span></pre><p id="41a3" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">您可以在本地机器上测试您的容器:</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="261b" class="nm me jj nd b gy nn no l np nq">$ docker run -d -p 3000:8080 my-node-server:latest<br/>c992be3580b1c27c81f6e2af54f9f49bf82f977df36d82c7af02c30e4c3b321d</span><span id="b030" class="nm me jj nd b gy nr no l np nq">$ curl localhost:3000<br/>Hello world.</span><span id="bcbc" class="nm me jj nd b gy nr no l np nq">$ docker stop c992be3580</span></pre><p id="ed91" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">注意，我用<code class="fe na nb nc nd b">-p 3000:8080</code>运行了我的容器，这将我的容器(我的Node.js服务器正在监听的容器)上的端口<code class="fe na nb nc nd b">8080</code>暴露给我的本地机器上的端口<code class="fe na nb nc nd b">3000</code>。这允许我们向<code class="fe na nb nc nd b">localhost:3000</code>发送请求，并从我们的服务器获得响应。稍后，当我们在AWS EC2中运行时，我们将把容器上的端口<code class="fe na nb nc nd b">8080</code>公开给EC2实例上的端口<code class="fe na nb nc nd b">80</code>。</p><h1 id="21c5" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">2.准备您的AWS ECR存储库</h1><p id="43ed" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">我们的EC2机器在运行之前需要获取我们的容器映像。为此，我们需要<a class="ae jg" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/docker-push-ecr-image.html" rel="noopener ugc nofollow" target="_blank">将我们的容器映像推送到AWS ECR </a>。但是在我们这样做之前，我们需要准备我们的存储库并设置访问。确保您已经安装了<a class="ae jg" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>。</p><h1 id="e69a" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">创建ECR存储库</h1><p id="9def" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">首先，在AWS ECR中，创建一个新的存储库。对于我们的AWS地区，我们将使用<code class="fe na nb nc nd b">us-east-2</code>(俄亥俄州)。</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ns"><img src="../Images/fb9c5023fb372c25eff0e2bba9fbd0cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xw9DiVPCaz7MJ0Lh.png"/></div></div></figure><p id="627a" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们创建一个名为<code class="fe na nb nc nd b">my-node-server</code>的<strong class="lj jt">私有</strong>存储库，保留所有剩余的默认设置。</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nt"><img src="../Images/197f31c9d8b0ee990ca95819e412e51e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1FOsxkkjOr1pPi2D.png"/></div></div></figure><p id="29d9" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">很快，我们将需要使用<code class="fe na nb nc nd b">docker login</code>来访问我们的存储库并推送我们的容器映像。要登录，我们需要一个注册中心的认证令牌。确保您已经<a class="ae jg" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html#id_users_create_console" rel="noopener ugc nofollow" target="_blank">创建了一个具有编程访问权限的IAM用户</a>，并且您已经运行了<code class="fe na nb nc nd b">aws configure</code>来使用该IAM用户的凭证。</p><h1 id="62a4" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">创建IAM策略以允许<code class="fe na nb nc nd b">ecr:GetAuthorizationToken</code></h1><p id="c608" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">您的IAM用户需要获得<code class="fe na nb nc nd b">ecr:GetAuthorizationToken</code>的许可。在“AWS IAM策略”页面上，使用以下JSON创建新策略:</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="1672" class="nm me jj nd b gy nn no l np nq">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "VisualEditor0",<br/>            "Effect": "Allow",<br/>            "Action": "ecr:GetAuthorizationToken",<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="1589" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">为新策略提供一个名称(例如:<code class="fe na nb nc nd b">ecr-get-authorization-token</code>)。将策略附加到您的IAM用户。</p><h1 id="a341" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">创建IAM策略以允许上传到您的ECR存储库</h1><p id="3649" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">您的IAM用户还需要将容器图像上传到您的ECR存储库的权限。使用下面的JSON创建另一个IAM策略，确保将<code class="fe na nb nc nd b">Resource</code>设置为您的存储库的ARN。</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="8143" class="nm me jj nd b gy nn no l np nq">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "VisualEditor0",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "ecr:BatchCheckLayerAvailability",<br/>                "ecr:BatchGetImage",<br/>                "ecr:CompleteLayerUpload",<br/>                "ecr:DescribeImages",<br/>                "ecr:DescribeRepositories",<br/>                "ecr:GetDownloadUrlForLayer",<br/>                "ecr:GetRepositoryPolicy",<br/>                "ecr:InitiateLayerUpload",<br/>                "ecr:ListImages",<br/>                "ecr:PutImage",<br/>                "ecr:UploadLayerPart"<br/>            ],<br/>            "Resource": "arn:aws:ecr:us-east-2:1539********:repository/my-node-server"<br/>        }<br/>    ]<br/>}</span></pre><p id="4700" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">为您的新策略提供一个名称(例如:<code class="fe na nb nc nd b">ecr-upload-to-my-node-server-repo</code>)，并将该策略附加到您的IAM用户。</p><h1 id="7b30" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">3.将容器图像推送到AWS ECR</h1><p id="c26a" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">现在，我们准备将我们的容器映像提升到AWS ECR。</p><h1 id="8b63" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">标记您的本地容器图像</h1><p id="d61c" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">我们创建的容器图像被标记为<code class="fe na nb nc nd b">my-node-server:latest</code>。我们需要用我们的ECR注册中心、存储库和(可选的)图像标记名来标记该图像。为此，您将需要上面创建的ECR存储库的URI。</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="25ec" class="nm me jj nd b gy nn no l np nq">$ docker tag my-node-server:latest \<br/>  1539********.dkr.ecr.us-east-2.amazonaws.com/my-node-server:latest</span><span id="5044" class="nm me jj nd b gy nr no l np nq">$ docker images<br/>REPOSITORY                                                   TAG     IMAGE ID    <br/>1539********.dkr.ecr.us-east-2.amazonaws.com/my-node-server  latest  a6df3f2bda72<br/>my-node-server                                               latest  a6df3f2bda72</span></pre><p id="2b10" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">当然，你的库URI会有你的AWS账户ID和区域。</p><h1 id="f201" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">登录到您的容器注册表</h1><p id="a828" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">当您的IAM用户被授权给<code class="fe na nb nc nd b">ecr:GetAuthorizationToken</code>时，您可以获得令牌并通过<code class="fe na nb nc nd b">docker login</code>命令使用它。确保您获取授权令牌的区域与您尝试登录的区域相同。</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="e147" class="nm me jj nd b gy nn no l np nq">$ aws ecr get-login-password --region us-east-2 | docker login \<br/>  --username AWS \<br/>  --password-stdin 1539********.dkr.ecr.us-east-2.amazonaws.com</span><span id="dd67" class="nm me jj nd b gy nr no l np nq">...<br/>Login Succeeded</span></pre><h1 id="46b1" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">将您的集装箱推到AWS ECR</h1><p id="7d85" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">现在我们已经登录了，我们可以将我们的容器推送到我们的注册表中。</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="564e" class="nm me jj nd b gy nn no l np nq">$ docker push 1539********.dkr.ecr.us-east-2.amazonaws.com/my-node-server:latest<br/>The push refers to repository [1539********.dkr.ecr.us-east-2.amazonaws.com/my-node-server]<br/>7ac6ec3e6477: Pushed <br/>f56ccac17bd2: Pushed <br/>91b00ce18dd1: Pushed <br/>58b7b5e46ecb: Pushed<br/>0f9a2482a558: Pushed<br/>8a5d6c9c178c: Pushed <br/>124a9240d0af: Pushed <br/>e2eb06d8af82: Pushed <br/>latest: digest: sha256:9aa81957bd5a74b3fc9ab5da82c7894014f6823a2b1e61cd837362107dc062e5 size: 1993</span></pre><p id="616d" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们的Node.js服务器的容器映像现在位于AWS ECR！</p><p id="4562" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">困难的部分已经完成了。现在，我们可以加速我们的EC2实例。</p><h1 id="a094" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">4.启动EC2实例</h1><p id="7f37" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">转到EC2主页，确保您使用的是与前面步骤相同的地区(<code class="fe na nb nc nd b">us-east-2</code>)。点击“启动实例”</p><p id="571f" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们将推出一个“符合免费层条件”的Amazon Linux 2 AMI实例。选择64位(x86)版本，然后单击“选择”</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nv"><img src="../Images/16960a71ece4aea55bd3cbea250ea033.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P3DQEk-cQx2TUiRV.png"/></div></div></figure><p id="bf3c" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">为了在这次学习体验中停留在免费层，我们将选择<code class="fe na nb nc nd b">t2.micro</code>实例类型。然后，我们将跳到“配置安全组”页面。</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nw"><img src="../Images/acecda02537f63c71092fa28535e4348.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XRQrk018lwURkFvD.png"/></div></div></figure><p id="147c" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">对于EC2实例的安全组，我们将创建一个新的安全组，并提供名称和描述。我们的EC2将需要允许SSH (TCP在端口<code class="fe na nb nc nd b">22</code>)和HTTP访问(TCP在端口<code class="fe na nb nc nd b">80</code>)。AWS可能会警告您，您可能希望将流量限制在IP地址的白名单中。对于生产级部署，您可能需要考虑采取比我们在这里所做的演示更安全的措施。</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nx"><img src="../Images/97a0e3ec1efffa61560693cbe23f21c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-Wud4nbI09rEvvpL.png"/></div></div></figure><p id="80c6" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">点击“查看并启动”，然后点击“启动”</p><p id="9626" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">您将看到一个对话框，用于为对EC2实例的SSH访问创建新的密钥对。选择“创建新的密钥对”，选择“RSA”作为密钥对类型，然后给密钥对命名。然后，点击“下载密钥对”</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ny"><img src="../Images/29219629fcf991d85a8afafeceefa3c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*b_tjb-EmTgRlNYSS.png"/></div></div></figure><p id="78c6" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">将下载的私钥文件存储在安全的地方。然后，单击“启动实例”</p><p id="484d" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">您的EC2实例可能需要几分钟才能启动。</p><h1 id="6a86" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">5.连接到EC2来安装和运行Docker</h1><p id="c019" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">一旦我们的EC2实例运行，我们将设置它来运行我们的Docker容器。</p><h1 id="de13" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">连接到您的EC2实例</h1><p id="8551" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">在EC2 instances页面上，选择您刚刚启动的实例，然后点击“Connect”这里有使用您刚刚下载的私有密钥的SSH客户端的说明。您还可以在AWS控制台中使用EC2实例连接选项。点击“连接”</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nz"><img src="../Images/ce28c691c2f90f2245c665df77b0a4f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QiovkQXICDZGtIQf.png"/></div></div></figure><p id="3426" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这将在您的浏览器中打开一个新的选项卡，您将拥有一个浏览器内终端，可以通过命令行访问您的EC2实例。</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oa"><img src="../Images/409e0c13db3421e482a41dc427e8fa67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Zqv4vnCnzV5rh8zA.png"/></div></div></figure><h1 id="4f3f" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">安装并启动Docker</h1><p id="717e" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">在EC2终端中，运行以下命令将Docker安装到您实例中:</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="87a2" class="nm me jj nd b gy nn no l np nq">[ec2-user@ip-172-31-38-144 ~]$ sudo yum update -y<br/>...<br/>No packages marked for update<br/> <br/>[ec2-user@ip-172-31-38-144 ~]$ sudo amazon-linux-extras install docker<br/>...<br/>Installed size: 285 M<br/>Is this ok [y/d/N]: y<br/>...</span><span id="7666" class="nm me jj nd b gy nr no l np nq">[ec2-user@ip-172-31-38-144 ~]$ sudo service docker start<br/> <br/>[ec2-user@ip-172-31-38-144 ~]$ sudo chmod 666 /var/run/docker.sock</span></pre><h1 id="71d8" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">运行<code class="fe na nb nc nd b">aws configure</code>设置IAM用户凭证</h1><p id="b0b3" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">在EC2命令行中，您将需要运行<code class="fe na nb nc nd b">aws configure</code>，使用与您在本地机器上相同的IAM用户凭证，以便您可以运行类似的AWS CLI命令。</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="85d3" class="nm me jj nd b gy nn no l np nq">[ec2-user@ip-172-31-38-144 ~]$ aws configure<br/>AWS Access Key ID [None]: AKIA****************<br/>AWS Secret Access Key [None]: z8e*********************************<br/>Default region name [None]: us-east-2<br/>Default output format [None]: json</span></pre><h1 id="560a" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">登录到您的容器注册表</h1><p id="2b55" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">就像我们将我们的映像从本地机器推送到ECR时所做的那样，我们需要登录到我们的注册中心(从我们的EC2中)，以便我们可以提取我们的映像。</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="bd29" class="nm me jj nd b gy nn no l np nq">[ec2-user@ip-172-31-38-144 ~]$ $ aws ecr get-login-password --region us-east-2 | docker login \<br/>  --username AWS \<br/>  --password-stdin 1539********.dkr.ecr.us-east-2.amazonaws.com</span><span id="36ea" class="nm me jj nd b gy nr no l np nq">...<br/>Login Succeeded</span></pre><h1 id="b787" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">下拉容器图像</h1><p id="597b" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">现在我们已经登录，我们拉下我们的容器图像。</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="4615" class="nm me jj nd b gy nn no l np nq">[ec2-user@ip-172-31-38-144 ~]$ docker pull 1539********.dkr.ecr.us-east-2.amazonaws.com/my-node-server:latest<br/>latest: Pulling from my-node-server<br/>a0d0a0d46f8b: Pull complete <br/>4684278ccdc1: Pull complete <br/>cb39e3b315fc: Pull complete <br/>90bb485869f4: Pull complete <br/>32c992dbb44a: Pull complete <br/>4d7fffd328bd: Pull complete <br/>562d102dfc97: Pull complete <br/>d7de8aedebed: Pull complete <br/>Digest: sha256:9aa81957bd5a74b3fc9ab5da82c7894014f6823a2b1e61cd837362107dc062e5<br/>Status: Downloaded newer image for 1539********.dkr.ecr.us-east-2.amazonaws.com/my-node-server:latest<br/>1539********.dkr.ecr.us-east-2.amazonaws.com/my-node-server:latest</span></pre><h1 id="ed34" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">运行Docker</h1><p id="4c1e" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">有了我们的容器映像，我们可以用Docker运行它。记住，我们希望将容器上的端口<code class="fe na nb nc nd b">8080</code>公开给EC2实例上的端口<code class="fe na nb nc nd b">80</code>(这个端口对HTTP访问开放)。</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="3063" class="nm me jj nd b gy nn no l np nq">[ec2-user@ip-172-31-38-144 ~]$ docker run -t -i -d \<br/>-p 80:8080 1539********.dkr.ecr.us-east-2.amazonaws.com/my-node-server</span><span id="5996" class="nm me jj nd b gy nr no l np nq"> 8cb7c337b9d5f39ea18a60a69f5e1d2d968f586b06f599abfada34f3fff420c1</span></pre><h1 id="0c2c" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">6.使用HTTP请求进行测试</h1><p id="932e" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">我们已经设置并连接了所有的部分。最后，我们可以测试对服务器的访问。注意，我们只设置了EC2实例和网络来响应HTTP(不是HTTPS)请求。<strong class="lj jt">我们将在以后的文章中介绍HTTPS和自定义域的附加配置。</strong></p><p id="2b20" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">为了测试我们的设置，我们只需要向EC2实例的公共IPv4地址(或者公共IPv4 DNS地址，这是一个别名)发出curl请求。</p><pre class="ne nf ng nh gt ni nd nj nk aw nl bi"><span id="6945" class="nm me jj nd b gy nn no l np nq">$ curl http://3.14.11.142<br/>Hello world.</span><span id="71a2" class="nm me jj nd b gy nr no l np nq">$ curl http://ec2-3-14-11-142.us-east-2.compute.amazonaws.com<br/>Hello world.</span></pre><p id="0c91" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">注意，我们没有在请求中指定端口，这意味着我们对HTTP请求使用默认端口(<code class="fe na nb nc nd b">80</code>)。当我们用docker run启动容器时，我们将EC2实例上的端口<code class="fe na nb nc nd b">80</code>与容器上的开放端口<code class="fe na nb nc nd b">8080</code>相关联。我们还设置了安全组来允许来自端口<code class="fe na nb nc nd b">80</code>的流量。</p><h1 id="a3e9" class="md me jj bd mf mg mh mi mj mk ml mm mn ky mo kz mp lb mq lc mr le ms lf mt mu bi translated">结论</h1><p id="c95f" class="pw-post-body-paragraph lh li jj lj b lk mv kt lm ln mw kw lp lq mx ls lt lu my lw lx ly mz ma mb mc im bi translated">在AWS EC2中启动一个基本服务器并作为一个容器运行可能感觉很复杂。诚然，这需要很多步骤，但它们都很简单。您自己的用例可能有所不同(服务器实现、容器需求、要公开的端口)，但是过程仍然会非常相似。在我们的<a class="ae jg" rel="noopener ugc nofollow" target="_blank" href="/adding-a-custom-domain-and-ssl-to-aws-ec2-a2eca296facd">后续文章</a>中，我们将通过设置一个自定义域并通过SSL/HTTPS访问我们的服务器来更进一步。</p></div></div>    
</body>
</html>