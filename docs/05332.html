<html>
<head>
<title>Building a Full-Text Search App Using Django, Docker and Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Django、Docker和Elasticsearch构建全文搜索应用</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/building-a-full-text-search-app-using-django-docker-and-elasticsearch-d1bc18504ca4?source=collection_archive---------2-----------------------#2020-08-20">https://levelup.gitconnected.com/building-a-full-text-search-app-using-django-docker-and-elasticsearch-d1bc18504ca4?source=collection_archive---------2-----------------------#2020-08-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/42721c8384e9ce91a7814c88c54bddab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o1IdV4OjRw5T-t2M7EI7og.png"/></div></div></figure><p id="8048" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章中，我会给你一些关于Elasticsearch的简单信息，它的安装，以及一些使用的例子。</p><h1 id="c084" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">弹性搜索—基本概念</h1><blockquote class="lu lv lw"><p id="202b" class="jy jz lx ka b kb kc kd ke kf kg kh ki ly kk kl km lz ko kp kq ma ks kt ku kv ij bi translated">Elasticsearch是一个实时分布式开源全文搜索和分析引擎。它可以从RESTful web服务接口访问，并使用无模式JSON (JavaScript对象符号)文档来存储数据。它建立在Java编程语言之上，这使得Elasticsearch可以在不同的平台上运行。它使用户能够以非常高的速度探索大量的数据。</p></blockquote><p id="7852" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有一些弹性搜索的基础，一旦你把它们内化了，就能减少学习曲线的创伤。我总结了4个最重要的概念:</p><ol class=""><li id="6d14" class="mb mc iq ka b kb kc kf kg kj md kn me kr mf kv mg mh mi mj bi translated"><strong class="ka ir">字段:</strong>弹性搜索中数据的最小个体单位。每个字段都有定义的数据类型；核心数据类型(字符串、数字、日期、布尔值)或复杂数据类型(对象和嵌套)。</li><li id="c64b" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated"><strong class="ka ir">索引:</strong>不同类型文档和文档属性的集合。它可以比作关系数据库世界中的一个数据库。</li><li id="3aa4" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated"><strong class="ka ir">文档:</strong>以特定方式在JSON格式中定义的字段集合。每个文档都属于一种类型，并驻留在索引中。在关系数据库的世界中，文档可以比作表中的一行。</li><li id="a8d4" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated"><strong class="ka ir">映射:</strong>共享同一索引中一组公共字段的文档集合。同样，它就像关系数据库世界中的一个模式。</li></ol><p id="610a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">⚠️:值得一提的是，Elasticsearch不能用作数据库，它不是为此目的而建立的。因此，最好是在项目中将其作为PostgreSQL、MySQL或其他数据库旁边的附加服务。</p><h1 id="dfc9" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">使用Django的Elasticsearch</h1><p id="84bc" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">很多教程都在使用<a class="ae mu" href="https://django-haystack.readthedocs.io/" rel="noopener ugc nofollow" target="_blank"> Django-Haystack </a>，这个在Django社区使用非常广泛的工具，作为一个模块化的搜索来插入ElasticSearch(或者其他任何搜索引擎比如Solr，Whoosh，Xapian等。)，因为它的最小配置和查询语法类似于Django的ORM。</p><p id="450b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我最近在一个项目中使用了它和Solr，我对它的简单实现印象深刻，我喜欢它，但我不会在本文中使用它，我认为Elasticsearch本身很容易使用。</p><p id="4848" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我将使用Docker来运行Elasticsearch。</p><p id="f5a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是源代码，这样您就可以清楚地看到发生了什么:</p><div class="mv mw gp gr mx my"><a href="https://github.com/aymaneMx/django-elasticsearch" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd ir gy z fp nd fr fs ne fu fw ip bi translated">aymaneMx/django-elasticsearch</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">用Django测试Elasticsearch的简单项目，基于docker构建。</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">github.com</p></div></div><div class="nh l"><div class="ni l nj nk nl nh nm jw my"/></div></div></a></div><figure class="no np nq nr gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/9838c5ec3b524827c1eac92c4cecfd0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/1*DDOQkN585MAvdWoBnafEYw.gif"/></div></figure></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><h1 id="c734" class="kw kx iq bd ky kz nz lb lc ld oa lf lg lh ob lj lk ll oc ln lo lp od lr ls lt bi translated">弹性搜索实例</h1><p id="8c46" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">在项目目录中编辑<code class="fe oe of og oh b">docker-compose.yml</code>以添加一个ES服务:</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="86f0" class="om kx iq oh b gy on oo l op oq">es:<br/>    image: elasticsearch:7.8.1<br/>    environment:<br/>      - discovery.type=single-node<br/>    ports:<br/>      - "9200:9200"</span></pre><p id="4729" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后将<code class="fe oe of og oh b">es</code>添加到Django app service所依赖的服务中，将<code class="fe oe of og oh b">ELASTICSEARCH_DSL_HOSTS=es:9200</code>添加到<code class="fe oe of og oh b">docker-compose.env</code>:</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="1cd8" class="om kx iq oh b gy on oo l op oq">web:<br/>    build: .<br/>    command: python /code/manage.py runserver 0.0.0.0:8000<br/>    volumes:<br/>      - .:/code<br/>    ports:<br/>      - 8000:8000<br/>    env_file:<br/>      - docker-compose.env<br/>    depends_on:<br/>      - db<br/>      - es    &lt;--- here</span></pre><p id="19c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在运行<code class="fe oe of og oh b">docker-compose up -d --build</code></p><p id="f220" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以通过curl检查它是否正常工作:</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="1949" class="om kx iq oh b gy on oo l op oq">curl -X GET localhost:9200/_cluster/health</span></pre><h1 id="af20" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">设置弹性搜索</h1><p id="452b" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">让我们安装Django Elasticsearch DSL。用你喜欢的Python包管理器从PyPI安装app，我用pipenv。</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="ab71" class="om kx iq oh b gy on oo l op oq">pipenv install django-elasticsearch-dsl</span></pre><p id="0bb1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">与大多数Django应用程序一样，您应该将<code class="fe oe of og oh b">django_elasticsearch_dsl</code>添加到设置文件中的INSTALLED_APPS:</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="3360" class="om kx iq oh b gy on oo l op oq">INSTALLED_APPS = [<br/>    ...<br/>    'django_elasticsearch_dsl',<br/>    ...<br/>]</span></pre><p id="da1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，您必须在Django设置中定义ELASTICSEARCH_DSL。</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="1412" class="om kx iq oh b gy on oo l op oq"># Elasticsearch<br/>ELASTICSEARCH_DSL = {<br/>    'default': {<br/>        <!-- -->'hosts': os.getenv("ELASTICSEARCH_DSL_HOSTS", 'localhost:9200')<br/>    },<br/>}</span></pre><h1 id="a2a0" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">将数据索引到弹性搜索中</h1><p id="3aad" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">让我们考虑以下模型:</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="d07a" class="om kx iq oh b gy on oo l op oq">class Post(models.Model):<br/>    title = models.CharField(max_length=128)<br/>    content = models.CharField(max_length=5000)<br/>    created_at = models.DateTimeField(default=timezone.now)<br/>    likes = models.PositiveIntegerField(default=0)<br/>    slug = models.SlugField(max_length=128, db_index=True, null=True)<br/>    draft = models.BooleanField(default=True)</span><span id="087e" class="om kx iq oh b gy or oo l op oq">    user = models.ForeignKey(<br/>        User, <br/>        related_name='posts', <br/>        on_delete=models.CASCADE<br/>    )</span><span id="6c43" class="om kx iq oh b gy or oo l op oq">    def __str__(self):<br/>        return self.title</span><span id="780e" class="om kx iq oh b gy or oo l op oq">    class Meta:<br/>        app_label = 'posts'</span></pre><p id="2c7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后我们应该运行迁移:</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="ad4c" class="om kx iq oh b gy on oo l op oq">$ docker-compose run web python manage.py makemigrations<br/>$ docker-compose run web python manage.py migrate</span></pre><p id="5fa7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们定义ElasticSearch索引，这需要在您的应用程序目录中的<code class="fe oe of og oh b"><a class="ae mu" href="http://documents.py/" rel="noopener ugc nofollow" target="_blank">documents.py</a></code>中定义文档类。</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="ba8f" class="om kx iq oh b gy on oo l op oq">from django.contrib.auth import get_user_model<br/>from django_elasticsearch_dsl import Document, fields<br/>from django_elasticsearch_dsl.registries import registry<br/>from .models import Post, Reply</span><span id="f924" class="om kx iq oh b gy or oo l op oq">User = get_user_model()</span><span id="3789" class="om kx iq oh b gy or oo l op oq">@registry.register_document<br/>class PostDocument(Document):<br/>    user = fields.ObjectField(properties={<br/>        'id': fields.IntegerField(),<br/>        'username': fields.TextField(),<br/>    })</span><span id="be27" class="om kx iq oh b gy or oo l op oq">class Index:<br/>        name = 'posts'<br/>        settings = {'number_of_shards': 1,<br/>                    'number_of_replicas': 0}</span><span id="5931" class="om kx iq oh b gy or oo l op oq">class Django:<br/>        model = Post</span><span id="425d" class="om kx iq oh b gy or oo l op oq">fields = [<br/>            'title',<br/>            'content',<br/>            'created_at',<br/>            'likes',<br/>            'draft',<br/>            'slug',<br/>        ]</span><span id="4818" class="om kx iq oh b gy or oo l op oq">def get_queryset(self):<br/>        return super(PostDocument, self).get_queryset().select_related(<br/>            'user'<br/>        )</span><span id="dcbb" class="om kx iq oh b gy or oo l op oq">def get_instances_from_related(self, related_instance):<br/>        if isinstance(related_instance, User):<br/>            return related_instance.posts.all()<br/>        elif isinstance(related_instance, Reply):<br/>            return related_instance.post</span></pre><h1 id="ab87" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">用法示例</h1><p id="6e4e" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">为了用一些内容填充数据库，我为此发出了一个命令，只需运行:</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="bcc6" class="om kx iq oh b gy on oo l op oq">docker-compose run web python manage.py load_posts 20</span></pre><p id="e518" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们进入交互式Python shell ( <code class="fe oe of og oh b">docker-compose run web python manage.py shell</code>)并尝试使用ElasticSearch查询:</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="1f73" class="om kx iq oh b gy on oo l op oq">&gt;&gt;&gt; from posts.documents import PostDocument<br/>&gt;&gt;&gt; posts = PostDocument.search()<br/>&gt;&gt;&gt; for hit in posts:<br/>...     print(hit.title)<br/>... <br/>Design half three bar quickly material center.<br/>Author true left. Position entire someone study be.<br/>School draw individual sell produce brother.<br/>Truth drug compare TV modern.<br/>Expert apply baby reveal team along.<br/>Beautiful for suddenly half.<br/>Plant argue enough less order receive sing.<br/>Store economy offer decision industry.<br/>Beat chair affect assume score occur include laugh.<br/>Language poor cell fish worry ready industry use.<br/>&gt;&gt;&gt;</span></pre><p id="8de3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我收集了一些你可能需要的例子:</p><pre class="no np nq nr gt oi oh oj ok aw ol bi"><span id="3d49" class="om kx iq oh b gy on oo l op oq">search = PostDocument.search()</span><span id="f41b" class="om kx iq oh b gy or oo l op oq"># Filter by single field equal to a value<br/>search = search.query('match', draft=False)</span><span id="f227" class="om kx iq oh b gy or oo l op oq"># Filter by single field containing a value<br/>search = search.filter('match_phrase', title="value")</span><span id="0698" class="om kx iq oh b gy or oo l op oq"># Add the query to the Search object<br/>from elasticsearch_dsl import Q<br/>q = Q("multi_match", query='python django', fields=['title', 'content'])<br/>search = search.query(q)</span><span id="9a95" class="om kx iq oh b gy or oo l op oq"># Query combination<br/>or_q = Q("match", title='python') | Q("match", title='django')<br/>and_q = Q("match", title='python') &amp; Q("match", title='django')<br/>search = search.query(or_q)</span><span id="b295" class="om kx iq oh b gy or oo l op oq"># Exclude items from your query<br/>search = search.exclude('match', draft=True)</span><span id="2694" class="om kx iq oh b gy or oo l op oq"># Filter documents that contain terms within a provided range.<br/># eg: the posts created for the past day<br/>search = search.filter('range', created_at={"gte": "now-1d"})</span><span id="7044" class="om kx iq oh b gy or oo l op oq"># Ordering<br/># prefixed by the - sign to specify a descending order.<br/>search = search.sort('-likes', 'created_at')</span></pre><p id="778b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">给你一个快速测验😄，您可以在评论中提交您的答案👇</p><blockquote class="os"><p id="e127" class="ot ou iq bd ov ow ox oy oz pa pb kv dk translated">如何获取过去一周内发布的标题/内容中包含“使用”一词的帖子？</p></blockquote><h1 id="5f76" class="kw kx iq bd ky kz la lb lc ld le lf lg lh pc lj lk ll pd ln lo lp pe lr ls lt bi translated">就是这样！</h1><p id="2f51" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">老实说，这太长了。如果你有足够的耐心读完这篇文章，并且觉得它很有趣，那么请分享它。</p><blockquote class="lu lv lw"><p id="fda6" class="jy jz lx ka b kb kc kd ke kf kg kh ki ly kk kl km lz ko kp kq ma ks kt ku kv ij bi translated">本文最初发表于<a class="ae mu" href="https://www.obytes.com/blog/building-a-full-text-search-app-using-django-docker-and-elasticsearch" rel="noopener ugc nofollow" target="_blank">https://obytes.com/</a></p></blockquote></div></div>    
</body>
</html>