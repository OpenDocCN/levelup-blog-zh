<html>
<head>
<title>Custom DNS Configuration: AKS/Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自定义DNS配置:AKS/Kubernetes</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/custom-dns-configuration-aks-kubernetes-360e481afc1?source=collection_archive---------0-----------------------#2020-05-03">https://levelup.gitconnected.com/custom-dns-configuration-aks-kubernetes-360e481afc1?source=collection_archive---------0-----------------------#2020-05-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="331b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ko">在AKS Pods上使用本地DNS服务器进行域名解析</em></p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><p id="a154" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我和很多客户合作过，他们希望使用他们的定制DNS服务器来解析Azure Kubernetes服务上托管的pod的名称。</p><p id="c3fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些DNS服务器可以在本地，也可以在不同的虚拟网络中，或者在同一个虚拟网络中，用于解析自定义域。</p><p id="31cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我注意到许多人在配置上有困难，然而如果流量畅通的话，这是一个相当简单的问题。</p><p id="f132" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇文章中，我将讨论一种可以用来启用AKS Pods和解析自定义域名的方法。另一种流行的方法是修改CoreDNS配置，这在这里的另一篇文章中有所涉及:<a class="ae kw" href="https://medium.com/@rishasi/custom-dns-configuration-with-coredns-aks-kubernetes-599ecfb46b94" rel="noopener">https://medium . com/@ rish ASI/custom-DNS-configuration-with-CoreDNS-aks-kubernetes-599 ecfb 46 b 94</a></p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><p id="f900" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了使解决方案有效，简单来说，将所有DNS查询转发到自定义DNS服务器，并且:</p><ul class=""><li id="48a7" class="kx ky it js b jt ju jx jy kb kz kf la kj lb kn lc ld le lf bi translated">使用此自定义DNS服务器解析自定义域，以及</li><li id="810e" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn lc ld le lf bi translated">对于每个其他域，使用DNS转发器将请求转发到Azure DNS。</li></ul><p id="3d75" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">一个简单的示意图:</strong></p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi ll"><img src="../Images/47af3fec05b712ea4b34517e880365bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UAmVocvNHtgCzDakL-ByIg.jpeg"/></div></div></figure><p id="dd13" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">接近</strong>:</p><p id="239f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Pod请求DNS解析，然后将解析转发到在VNet设置中配置的DNS服务器，比如10.x.x.x。</p><p id="7c26" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个DNS服务器可以是本地的，或者在同一个VNet中，或者是对等的VNet。</p><p id="ac4e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">DNS服务器将会看到该请求，并且:</p><pre class="lm ln lo lp gt lx ly lz ma aw mb bi"><span id="73af" class="mc md it ly b gy me mf l mg mh"><em class="ko">a. If the DNS query is for it’s own custom domain,<br/></em>It will itself resolve the query and return the IP.</span><span id="f955" class="mc md it ly b gy mi mf l mg mh"><em class="ko">b. If it is any other domain, for example ubuntu.com,<br/></em>Then the DNS Server will forward the request to the Azure DNS.</span></pre><p id="ac95" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ko">要使其工作，您必须设置DNS转发器，将外部域的流量路由到公共DNS服务器。然而，应该注意的是，由于各种原因，AKS节点和pod可能需要解析其他外部域名，这也包括Azure的内部域，如cloudapp.net。因此，建议将外部查询转发到Azure DNS服务器(168.63.129.16)。</em></p><pre class="lm ln lo lp gt lx ly lz ma aw mb bi"><span id="5ded" class="mc md it ly b gy me mf l mg mh">Edit:<br/>The above approach works as long as the Custom DNS Server is in Azure. So, setting Azure DNS as the forwarder is straightforward using the Azure DNS IP: 168.63.129.16.</span><span id="feda" class="mc md it ly b gy mi mf l mg mh">However, if the Custom DNS Server is on-prem, or outside Azure, the Azure DNS cannot be reached from there.<br/>So setting Azure DNS as the forwarder will not be that straightforward.</span><span id="4448" class="mc md it ly b gy mi mf l mg mh">In that case, the Custom DNS, which is on-prem, can set the forwarder as:<br/>- another DNS Server configured on Azure VM,<br/>- or Azure Firewall<br/>- or a DNS Proxy on Azure<br/>.. and then that device can use Azure DNS as it's DNS Server.</span><span id="74a0" class="mc md it ly b gy mi mf l mg mh">Basically, we cannot reach Azure DNS IP directly from outside Azure, so we first forward queries to a VM/Firewall/DNS Proxy, which is on Azure, and then that device can forward requests to Azure DNS.</span><span id="0dbf" class="mc md it ly b gy mi mf l mg mh">A little tricky, but hopefully this helps.</span></pre><p id="6fa9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">这就是了</strong>。如果你理解这个设置，很好。如果没有，不要担心，后面还有更多。</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><p id="b3ad" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我准备了一个简单的设置来“模仿”所讨论的体系结构，其中AKS VNet使用VPN/ExpressRoute连接到内部环境。</p><p id="2f6a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于这种设置，</p><ul class=""><li id="88de" class="kx ky it js b jt ju jx jy kb kz kf la kj lb kn lc ld le lf bi translated">启动了AKS集群</li><li id="8b3d" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn lc ld le lf bi translated">在另一个虚拟网络中创建了DNS服务器</li><li id="daf4" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn lc ld le lf bi translated">在DNS服务器的虚拟网络(VM1)中创建了一个虚拟机，我们将解析其名称</li><li id="56f6" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn lc ld le lf bi translated">在AKS虚拟网络和自定义虚拟网络之间创建了对等连接</li><li id="6443" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn lc ld le lf bi translated">更新了AKS VNet以使用自定义DNS服务器，而不是Azure提供的默认DNS服务器</li></ul><p id="3869" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我没有设置VPN/ExpressRoute，而是使用了VNet对等。基本思想是连接到定制的DNS服务器。因此，在这里，自定义虚拟网络可以被认为是本地网络。</p><p id="67dd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个DNS服务器是一个障碍，因为我很久很久以前就已经做过了。我使用了一个Windows 2016虚拟机，并引用了这篇简单的文章来在其上配置DNS服务器:<a class="ae kw" href="https://www.hostwinds.com/guide/how-to-setup-and-configure-dns-in-windows-server-2016/" rel="noopener ugc nofollow" target="_blank">https://www . host winds . com/guide/how-to-setup-and-configure-DNS-in-Windows-Server-2016/</a></p><p id="36fc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">设置的详细信息:</p><pre class="lm ln lo lp gt lx ly lz ma aw mb bi"><span id="8039" class="mc md it ly b gy me mf l mg mh">AKS VNet CIDR: 10.0.0.0/8</span><span id="4096" class="mc md it ly b gy mi mf l mg mh">AKS Node IP: 10.240.0.4</span><span id="5530" class="mc md it ly b gy mi mf l mg mh">Custom VNet CIDR: 172.16.0.0/16</span><span id="2d28" class="mc md it ly b gy mi mf l mg mh">Custom Domain: testabc.com</span><span id="5216" class="mc md it ly b gy mi mf l mg mh">DNS Server IP: 172.16.0.4</span><span id="8524" class="mc md it ly b gy mi mf l mg mh">VM1 IP: 172.16.0.5</span><span id="0f00" class="mc md it ly b gy mi mf l mg mh">Hostname for VM1: vm1.testabc.com</span></pre><p id="a79f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">DNS服务器设置:</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi mj"><img src="../Images/56ab8329a8719fb3f2bbd574f752fb6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KKKbXHTOW_MRP_Svo5nU_w.png"/></div></div></figure><p id="f1e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">DNS转发器设置为Azure DNS IP:</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi mk"><img src="../Images/6d2e1976f55fa79ad771117f3f6562be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YDmFucR63h8dYjLXawqBhw.png"/></div></div></figure><p id="9feb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">设置完成后，我首先确保VM1的主机名是从DNS服务器本身解析出来的。从DNS服务器内部的CMD:</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi ml"><img src="../Images/d092070438782d728c60bda8677b4b9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mc-MpF25oKOFKzRVtmrxVA.png"/></div></div></figure><p id="0ffb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后我检查了DNS是否从AKS节点得到解析。通过SSH连接到AKS节点，并通过CLI进行测试:</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi mm"><img src="../Images/45f5cccd70b80ef6e98f3ebd41de4b81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3A9I-n7bskuLDUCm8HwrEg.png"/></div></div></figure><p id="2561" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里的截图验证了两件事:</p><ol class=""><li id="f0ae" class="kx ky it js b jt ju jx jy kb kz kf la kj lb kn mn ld le lf bi translated">另一个VNet中的DNS服务器可以通过私有IP到达，因此对等工作正常，</li><li id="ecfd" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn mn ld le lf bi translated">并且VM1的主机名被解析为正确的IP</li></ol><p id="1feb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">到目前为止一切顺利。然而，目前我必须在nslookup命令中明确指定DNS服务器。我希望默认情况下引用自定义DNS服务器。</p><p id="c0e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，我更改了AKS VNet的DNS属性，以引用另一个VNet中的自定义DNS服务器(由于VNet对等，可以通过私有IP访问):</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi mo"><img src="../Images/51bfc320d9e8c2bfcffef40adb137753.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tzz7POxPxhk4IjpU2Dcphw.png"/></div></div></figure><p id="a255" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">必须重新启动AKS节点才能传播新设置。机器重启后，我核实了</p><ol class=""><li id="a273" class="kx ky it js b jt ju jx jy kb kz kf la kj lb kn mn ld le lf bi translated">AKS节点的DNS设置已更新</li></ol><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi mp"><img src="../Images/573a9482334859098fa3e5c29c2320fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JUmczVzDfL1IYAYIC4GK3A.png"/></div></div></figure><p id="ff45" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.AKS节点能够解析VM1的主机名:</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi mq"><img src="../Images/f11a1dff646a4309e591a89744c6f3f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TPs80lKa_qDh62tApk1X9w.png"/></div></div></figure><p id="aec8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不仅“testabc.com”的内部客户域得到解析，而且外部域也得到解析。</p><p id="01c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你仔细观察，URL google.com已被非权威服务器解析，这表明自定义dns将查询转发到其他DNS服务器，这验证了转发到Azure DNS的工作正常。</p><p id="abaf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一切正常！！</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><p id="8d2a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">现在的主要问题是，我的pods能够解析自定义和外部域名吗？</strong></p><p id="5e6c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了进行测试，我启动了一个简单的httpd pod，在其上安装了dnsutils并执行了测试:</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi mr"><img src="../Images/5a6cc7394e3b884dd4fb4889698ca036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*djJa4A-AivWNgroT6RqJBw.png"/></div></div></figure><p id="aa84" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ko">瞧！</em> </strong> <em class="ko">，就这么简单。</em></p><p id="431f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从pod内部，我能够将VM1主机名解析为正确的IP，并且还能够解析外部域。</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h2 id="703d" class="mc md it bd ms mt mu dn mv mw mx dp my kb mz na nb kf nc nd ne kj nf ng nh ni bi translated">脚注:</h2><p id="d0da" class="pw-post-body-paragraph jq jr it js b jt nj jv jw jx nk jz ka kb nl kd ke kf nm kh ki kj nn kl km kn im bi translated">应该注意，我没有为Pod指定任何<strong class="js iu"> dnsPolicy </strong>。因此，应用了默认策略，其中Pod从运行它的节点继承DNS配置。</p><p id="a6ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ko">关于用于pod的dnsPolicy的更多细节可以在这里找到:</em><a class="ae kw" href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy" rel="noopener ugc nofollow" target="_blank"><em class="ko">https://kubernetes . io/docs/concepts/services-networking/DNS-pod-service/# pod-s-DNS-policy</em></a></p><p id="7042" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">顺便说一下，将外部域名转发到Azure DNS的好处是，自定义DNS服务器将只负责解析自定义域，其他所有域名都由Azure DNS解析，减少了自定义DNS服务器的负载。</p><p id="4dbb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，这种设置可以在任何环境下工作，只需稍作调整，无论是Azure、AWS、Google Cloud还是其他环境。要求是确保:</p><pre class="lm ln lo lp gt lx ly lz ma aw mb bi"><span id="3cf5" class="mc md it ly b gy me mf l mg mh">a. Custom DNS Server(s) is/are reachable from the Kubernetes Nodes,</span><span id="48e7" class="mc md it ly b gy mi mf l mg mh">b. The Nodes have the Custom DNS Servers as the default DNS resolver, and</span><span id="c8dd" class="mc md it ly b gy mi mf l mg mh">c. the Pods have the default dnsPolicy.</span></pre><p id="d955" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望这解释了在Kubernetes集群中使用定制DNS服务器所需的配置。</p><p id="a8f6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">谢谢大家！</p></div></div>    
</body>
</html>