<html>
<head>
<title>NestJS: Microservices with gRPC, API Gateway, and Authentication — Part 1/2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NestJS:具有gRPC、API网关和认证的微服务—第1/2部分</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/nestjs-microservices-with-grpc-api-gateway-and-authentication-part-1-2-650009c03686?source=collection_archive---------0-----------------------#2022-03-18">https://levelup.gitconnected.com/nestjs-microservices-with-grpc-api-gateway-and-authentication-part-1-2-650009c03686?source=collection_archive---------0-----------------------#2022-03-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="19a6" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">以打字打的文件</h2><div class=""/><div class=""><h2 id="5064" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">分步指南:使用TypeScript、gRPC、API网关、身份验证和验证的NestJS应用程序</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/2b9467643786a71cc9ddc8fb6078ccf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AVGIX8wIVdasgd83azW2Vw.jpeg"/></div></div></figure><p id="5f5a" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">今天我要向大家介绍的是<strong class="lf jd"> NestJS (TypeScript) </strong>中的<strong class="lf jd">微服务</strong>结合Google的<strong class="lf jd"> gRPC框架</strong>，以及基于<strong class="lf jd"> JWT </strong>处理传入HTTP请求的<strong class="lf jd"> API网关</strong>和<strong class="lf jd">认证</strong>。这篇文章很长，所以我把它分成两部分。</p><ol class=""><li id="a869" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly me mf mg mh bi translated">介绍、准备、数据库、共享原型项目</li><li id="3c61" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated">认证微服务、产品微服务、订单微服务</li></ol><p id="85c0" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">您将在本文的每一节中找到每个存储库的链接。这里可以看第二部<a class="ae mn" rel="noopener ugc nofollow" target="_blank" href="/nestjs-microservices-with-grpc-api-gateway-and-authentication-part-2-2-d67dc8e3b86a">。</a></p><h1 id="651d" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">应用基础设施</h1><p id="2fd6" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">对于本文，我决定编写一个简单的电子商务微服务项目，该项目使用API网关管理传入的HTTP请求，并将它们转发给总共3个微服务。</p><ul class=""><li id="1609" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly nl mf mg mh bi translated">第一个<strong class="lf jd">服务</strong>将是<strong class="lf jd">认证</strong>，用户可以注册并登录，同时我们验证请求的授权。</li><li id="dff5" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly nl mf mg mh bi translated"><strong class="lf jd">第二个服务</strong>将处理<strong class="lf jd">产品</strong>来创建一个新的产品，但是也根据它的ID找到一个产品。</li><li id="2301" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly nl mf mg mh bi translated">这对第三个服务<strong class="lf jd">很重要，它为我们的小型电子商务应用程序处理传入的<strong class="lf jd">订单</strong>。</strong></li></ul><p id="b18f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">您将看到，这些服务中的每一个都尽可能地向您介绍NestJS和TypeScript中微服务的基础知识，同时不破坏我们的应用程序。</p><p id="04c5" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我们不会处理环境变量、截止日期、深度错误处理、docker和复杂配置。所以不要担心，<strong class="lf jd">我们保持简单！</strong></p><p id="ab53" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">每个服务将是一个独立的项目，所以请记住这一点。此外，我们将有一个共享的存储库，在那里我们存储和管理原型文件，这是使用gRPC时的常见做法。最后但同样重要的是，我们将创建另一个项目，这将是API网关。所以我们总共谈论5个项目。</p><p id="6605" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">在我们开始阅读本指南之前，让我们先简要讨论一下我们将在这里使用的框架和概念。这听起来可能很无聊，但是请继续关注我，了解接下来会发生什么以及理解我们将要构建的应用程序是非常重要的。</p><h2 id="cbc0" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">什么是NestJS？</h2><p id="dcd0" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">NestJS 是一个用于构建高效、可伸缩的Node.js web应用程序的框架。它使用现代JavaScript，并且是用TypeScript构建的。如果您开发一个用TypeScript构建的API，那么NestJS是一个不错的选择！它深受春天和棱角的启发。</p><h2 id="d80b" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">gRPC是什么？</h2><p id="4446" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">gRPC 是一个现代的、开源的、高性能的RPC框架，可以在任何环境下运行。借助对负载平衡、跟踪、运行状况检查和身份验证的可插拔支持，它可以高效地连接数据中心内和数据中心间的服务。</p><h2 id="5df5" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">什么是API网关？</h2><p id="761d" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">API网关是所有客户机的入口点，在我们的例子中，是所有基于HTTP的客户机请求的入口点，但它不需要仅限于HTTP。API网关以两种方式之一处理请求。一些请求被简单地代理/路由到适当的服务。它通过分散到多个服务来处理其他请求。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nx"><img src="../Images/f5bdffeaa09e7fa2978bdf232e82c0a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7Gak-Tz3MeZ6d8fr"/></div></div><figcaption class="ny nz gj gh gi oa ob bd b be z dk translated">照片由<a class="ae mn" href="https://unsplash.com/@mxhpics?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Maxime Horlaville </a>在<a class="ae mn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="02f5" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">逐步指南</h1><p id="628e" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">正如我所说的，我把这篇文章分成了两部分。覆盖范围将是这样的:</p><ol class=""><li id="f6a2" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly me mf mg mh bi translated">数据库，共享原型项目，API网关</li><li id="58f1" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated">认证微服务、产品微服务和订单微服务</li></ol><h1 id="a4ef" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">先决条件</h1><p id="e04c" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">它需要对你本地安装在机器上的TypeScript、RPC、Git (+ Github)、PostgreSQL有一个基本的了解。我会选择<a class="ae mn" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio代码</a>作为我的代码编辑器。你可以用你喜欢的任何东西。</p><h2 id="36d7" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">注意力</h2><p id="8bd7" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">在本文中，您会经常看到命令<code class="fe oc od oe of b">code .</code>。这是一个基于当前目录打开Visual Studio代码的Visual Studio代码命令。如果不使用Visual Studio代码，请确保在IDE或代码编辑器中打开了正确的目录。</p><h1 id="060f" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">数据库ˌ资料库</h1><p id="e38d" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">首先，我们需要创建3个PostgreSQL数据库。这是因为我们将遵循每服务的<a class="ae mn" href="https://microservices.io/patterns/data/database-per-service.html" rel="noopener ugc nofollow" target="_blank">数据库模式。当涉及到数据管理时，每一个微服务的数据库都将是独立的。</a></p><p id="bb68" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">每个人都有不同的处理方式，有些人使用某种图形用户界面，但我们将使用我们的终端。同样，您需要在您的机器上安装PostgreSQL。如果您安装了PostgreSQL，以下四个命令将在Linux、Mac和Windows机器上运行。</p><pre class="ks kt ku kv gt og of oh oi aw oj bi"><span id="70e9" class="nm mp it of b gy ok ol l om on">$ psql postgres<br/>$ CREATE DATABASE micro_auth;<br/>$ CREATE DATABASE micro_product;<br/>$ CREATE DATABASE micro_order;<br/>$ \l<br/>$ \q</span></pre><h2 id="ec13" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">命令解释:</h2><ul class=""><li id="7f5c" class="lz ma it lf b lg ng lj nh lm oo lq op lu oq ly nl mf mg mh bi translated">使用用户Postgres打开psql CLI</li><li id="6999" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly nl mf mg mh bi translated"><code class="fe oc od oe of b">CREATE DATABASE micro_auth;</code>创建数据库</li><li id="106a" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly nl mf mg mh bi translated"><code class="fe oc od oe of b">CREATE DATABASE micro_product;</code>创建数据库</li><li id="6834" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly nl mf mg mh bi translated"><code class="fe oc od oe of b">CREATE DATABASE micro_order;</code>创建数据库</li><li id="7c75" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly nl mf mg mh bi translated"><code class="fe oc od oe of b">\l</code>列出所有数据库</li><li id="c1a1" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly nl mf mg mh bi translated"><code class="fe oc od oe of b">\q</code>退出psql CLI</li></ul><p id="beb7" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">在我们成功地执行了所有四个命令之后，我的终端看起来应该是这样的。正如我们所看到的，这3个数据库创建成功。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi or"><img src="../Images/49afdbc428db96dfdb712784c768d420.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9SAWD6hmjLtGIGVBSbUmCA.png"/></div></div></figure><h1 id="d161" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">创建项目</h1><p id="b8f6" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">让我们继续讨论NestJS。我们将在全球范围内安装NestJS CLI。</p><pre class="ks kt ku kv gt og of oh oi aw oj bi"><span id="451c" class="nm mp it of b gy ok ol l om on">$ npm i -g @nestjs/cli</span></pre><p id="3b78" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我们用它的CLI初始化了4个新的NestJS项目。此外，我们为我们要通过Github共享的原型文件创建了一个项目。</p><blockquote class="os ot ou"><p id="5c05" class="ld le ov lf b lg lh kd li lj lk kg ll ow ln lo lp ox lr ls lt oy lv lw lx ly im bi translated">我建议创建一个文件夹作为工作空间，您可以在终端中执行以下命令，将所有项目放在一个地方，但这取决于您。因此它不是本指南的一部分。</p></blockquote><pre class="ks kt ku kv gt og of oh oi aw oj bi"><span id="0ec2" class="nm mp it of b gy ok ol l om on">$ mkdir grpc-nest-proto<br/>$ nest new grpc-nest-api-gateway -p npm<br/>$ nest new grpc-nest-auth-svc -p npm<br/>$ nest new grpc-nest-product-svc -p npm<br/>$ nest new grpc-nest-order-svc -p npm</span></pre><h1 id="1b5b" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">共享原型存储库</h1><p id="afc3" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">所以，正如我所说的，我们将从共享原型项目开始。我们需要这样做，因为我们必须在所有其他项目中使用这些文件。</p><p id="0b60" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">github:<a class="ae mn" href="https://github.com/hellokvn/grpc-nest-proto" rel="noopener ugc nofollow" target="_blank">https://github.com/hellokvn/grpc-nest-proto</a></p><p id="d521" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">首先，我们需要在我们的代码编辑器中打开项目，这个命令<code class="fe oc od oe of b">code .</code>在我们的VSCode编辑器中打开<code class="fe oc od oe of b">grpc-proto</code>项目。</p><pre class="ks kt ku kv gt og of oh oi aw oj bi"><span id="2f1f" class="nm mp it of b gy ok ol l om on">$ cd grpc-nest-proto<br/>$ npm init --y<br/>$ git init<br/>$ mkdir proto<br/>$ touch proto/auth.proto &amp;&amp; touch proto/product.proto &amp;&amp; touch proto/order.proto<br/>$ code .</span></pre><p id="96a4" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">该项目将如下所示:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oz"><img src="../Images/4d9b923b8add94a8d5ce354b8672ce09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5G9ctjWEz5Nrio4WVYbVrQ.png"/></div></div></figure><p id="353e" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">然后，我们将添加一些代码到我们的原型文件。跟我来。</p><h2 id="0d97" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">授权协议</h2><p id="786f" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">首先，我们将为我们的认证服务创建原型文件。我们将添加3个RPC端点:<code class="fe oc od oe of b">Register</code>、<code class="fe oc od oe of b">Login</code>和<code class="fe oc od oe of b">Validate</code></p><p id="554b" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们给<code class="fe oc od oe of b">proto/auth.proto</code>添加一些代码</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><h2 id="b709" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">订单原型</h2><p id="b3b6" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">其次，我们将为订单服务创建原型文件。我们将只添加一个名为<code class="fe oc od oe of b">CreateOrder</code>的RPC端点。</p><p id="c3a4" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们给<code class="fe oc od oe of b">proto/order.proto</code>添加一些代码</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><h2 id="32f0" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">产品原型</h2><p id="5c8e" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">最后但同样重要的是，我们将为我们的产品服务创建原型文件。我们将添加3个RPC端点:<code class="fe oc od oe of b">CreateProduct</code>、<code class="fe oc od oe of b">FineOne</code>和<code class="fe oc od oe of b">DecreaseStock</code></p><p id="4dac" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们给<code class="fe oc od oe of b">proto/product.proto</code>添加一些代码</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><h2 id="4e15" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">在Github上创建存储库</h2><p id="14f1" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">正如我所说，我们需要以某种方式分享这个项目。对于本指南，我选择Github。所以让我们在这里创建一个公共存储库<a class="ae mn" href="https://github.com/new" rel="noopener ugc nofollow" target="_blank">。顺便说一下，这是您在本教程中需要创建的唯一存储库。我们将在稍后的项目中把这个库作为NPM包安装。</a></p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pc"><img src="../Images/9699f433b4aaae9a709dbc945dc96be3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rqQ6TT17WL9L2Cm7mbmFnA.png"/></div></div></figure><p id="d871" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们回到我们的代码，因为我们需要提交和推动我们的项目。</p><blockquote class="os ot ou"><p id="d77a" class="ld le ov lf b lg lh kd li lj lk kg ll ow ln lo lp ox lr ls lt oy lv lw lx ly im bi translated"><em class="it">用你的Github用户名替换</em> <strong class="lf jd"> <em class="it">你的用户名</em> </strong> <em class="it">。</em></p></blockquote><pre class="ks kt ku kv gt og of oh oi aw oj bi"><span id="b6c6" class="nm mp it of b gy ok ol l om on">$ git remote add origin https://github.com/YOUR_USERNAME/grpc-nest-proto.git<br/>$ git add .<br/>$ git commit -m "chore(): init nestjs"<br/>$ git branch -M main<br/>$ git push -u origin main</span></pre><p id="c1c1" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">就是这样。现在我们的代码应该在Github上了。我们在这里不再做任何更改，让我们前进到API网关。</p></div><div class="ab cl pd pe hx pf" role="separator"><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi"/></div><div class="im in io ip iq"><h1 id="01fe" class="mo mp it bd mq mr pk mt mu mv pl mx my ki pm kj na kl pn km nc ko po kp ne nf bi translated">API网关</h1><p id="58f6" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">知识库:<a class="ae mn" href="https://github.com/hellokvn/grpc-nest-api-gateway" rel="noopener ugc nofollow" target="_blank">https://github.com/hellokvn/grpc-nest-api-gateway</a></p><p id="4ba7" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">在这个项目中，我们将把HTTP请求转发给我们的微服务。有时，需要对传入的请求进行授权，这是与我们稍后要编写的Auth服务结合在一起的部分情况。</p><p id="1ec5" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">首先，我们需要在我们的代码编辑器中打开项目，所以回到您的终端中存储项目的目录。</p><pre class="ks kt ku kv gt og of oh oi aw oj bi"><span id="e034" class="nm mp it of b gy ok ol l om on">$ cd grpc-nest-api-gateway<br/>$ code .</span></pre><h2 id="f13a" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">安装依赖项</h2><p id="76e7" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">让我们安装一些我们将需要的依赖项。</p><pre class="ks kt ku kv gt og of oh oi aw oj bi"><span id="d935" class="nm mp it of b gy ok ol l om on">$ npm i @nestjs/microservices @grpc/grpc-js @grpc/proto-loader<br/>$ npm i -D @types/node ts-proto</span></pre><h2 id="c9f4" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">项目结构</h2><p id="2506" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">像往常一样，我将继续创建最终的文件夹和文件结构。为了简单起见，我们这里只讨论一个模块。</p><pre class="ks kt ku kv gt og of oh oi aw oj bi"><span id="6bda" class="nm mp it of b gy ok ol l om on"><em class="ov">$ nest g mo auth &amp;&amp; nest g co auth </em>--no-spec<em class="ov"> &amp;&amp; nest g s auth </em>--no-spec<br/><em class="ov">$ nest g mo product &amp;&amp; nest g co product </em>--no-spec<br/><em class="ov">$ nest g mo order &amp;&amp; nest g co order </em>--no-spec<br/>$ touch src/auth/auth.guard.ts</span></pre><h2 id="c27f" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">添加脚本</h2><p id="5b9b" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">我们需要向我们的<code class="fe oc od oe of b">package.json</code>添加一些脚本，以基于我们刚刚完成的共享proto项目生成我们的protobuf文件。</p><p id="bf8c" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们简单地将这5行代码添加到我们的<code class="fe oc od oe of b">package.json</code>文件的<code class="fe oc od oe of b">scripts</code>属性中。</p><blockquote class="os ot ou"><p id="4dcb" class="ld le ov lf b lg lh kd li lj lk kg ll ow ln lo lp ox lr ls lt oy lv lw lx ly im bi translated"><em class="it">用你的Github用户名替换</em> <strong class="lf jd"> <em class="it">你的_用户名</em> </strong> <em class="it">。</em></p></blockquote><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div><figcaption class="ny nz gj gh gi oa ob bd b be z dk translated">package.json</figcaption></figure><p id="e321" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">这就是它将如何查看我的<code class="fe oc od oe of b">package.json</code>或者在我的存储库上检查这个<a class="ae mn" href="https://github.com/hellokvn/grpc-nest-api-gateway/blob/main/package.json" rel="noopener ugc nofollow" target="_blank">文件</a>。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pp"><img src="../Images/96b355f8324d71eeb86a86351ab9dc6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5GxGoadz16UjXooB_YItBQ.png"/></div></div></figure><p id="40fd" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们运行这些脚本吧！</p><pre class="ks kt ku kv gt og of oh oi aw oj bi"><span id="f1ca" class="nm mp it of b gy ok ol l om on">$ npm run proto:install &amp;&amp; npm run proto:all</span></pre><ul class=""><li id="7f71" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly nl mf mg mh bi translated"><code class="fe oc od oe of b">proto:install</code>将把我们共享的原型库作为NPM包安装</li><li id="cc16" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly nl mf mg mh bi translated"><code class="fe oc od oe of b">proto:all</code>将在我们的模块<code class="fe oc od oe of b">auth</code>、<code class="fe oc od oe of b">order</code>和<code class="fe oc od oe of b">product</code>中生成后缀为<code class="fe oc od oe of b">.pb.ts</code>的protobuf文件</li></ul><p id="6678" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">所以在这些步骤之后，项目应该是这样的:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pq"><img src="../Images/fa04b1f15c76969a75400e6fc0b995e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d40NM4MkxoWrfUEZ0R3Oiw.png"/></div></div></figure><p id="27a8" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">现在，让我们开始编码。</p></div><div class="ab cl pd pe hx pf" role="separator"><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi"/></div><div class="im in io ip iq"><h2 id="b4c1" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">AuthService</h2><p id="ffe6" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">因此，我们在这里要做的是让我们的身份验证服务调用它的validate方法，我们将在后面编写代码。但是，我们已经可以准备它了，因为我们有它的protobuf文件。我们知道它的反应和有效载荷。</p><p id="96a8" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们把<code class="fe oc od oe of b">src/auth/auth.service.ts</code>从</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><p id="ae30" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">到</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><h2 id="4a2d" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">授权保护</h2><p id="b264" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">我们的AuthGuard依赖于我们刚刚创建的服务。这里我们得到了不记名令牌，稍后我们会得到。然后我们验证这个令牌，如果它无效，我们抛出一个未授权的异常，所以我们阻止没有有效授权的用户的请求。</p><p id="16fa" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们把<code class="fe oc od oe of b">src/auth/auth.guard.ts</code>从</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><h2 id="4649" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">授权控制器</h2><p id="24ed" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">Auth微服务还将负责新用户和用户登录，因此我们还在API网关中添加了一个控制器，将这些请求转发给我们的Authentication微服务。</p><p id="503b" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们把<code class="fe oc od oe of b">src/auth/auth.controller.ts</code>从:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><p id="c829" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">到</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><h2 id="dd34" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">授权模块</h2><p id="6991" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">现在我们需要注册我们的认证服务。我们需要将这个模块全局化，并导出我们的AuthService，因为我们需要在其他模块中使用依赖于AuthService的AuthGuard。所以请记住这一点。</p><p id="224d" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们更改<code class="fe oc od oe of b">src/auth/auth.module.ts</code>文件</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><p id="500a" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">到</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><p id="ed0e" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">现在我们完成了API网关的auth模块。让我们继续订单模块。这比我们的认证模块简单多了。</p></div><div class="ab cl pd pe hx pf" role="separator"><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi"/></div><div class="im in io ip iq"><h2 id="a528" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">订单模块</h2><p id="5c9d" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">类似于我们的AuthModule，我们需要注册我们的订单微服务，以便稍后与之通信。</p><p id="e14f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">你可能会意识到，我们将使用与认证服务不同的端口，这是必要的，因为我们不能两次使用同一个端口。</p><p id="c5a9" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们改变<code class="fe oc od oe of b">src/order/order.module.ts</code>的形态</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><p id="4bcf" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">到</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><h2 id="bacb" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">订单控制器</h2><p id="9f5f" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">这里我们只需要编写1个端点，因为我们的订单微服务只拥有1个端点。请看，我们将在这里使用我们的AuthGuard服务，来验证我们现在要编码的POST请求的授权。</p><p id="cf9b" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">如果发出请求的用户得到授权，AuthGuard会将用户的ID添加到请求中，我们将在这里将其与请求主体合并，因为我们的protobuf文件<code class="fe oc od oe of b">order.pb.ts</code>需要一个用户ID。</p><p id="1e9d" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们改变<code class="fe oc od oe of b">src/order/order.controller.ts</code>形态</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><p id="2b8e" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">到</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure></div><div class="ab cl pd pe hx pf" role="separator"><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi"/></div><div class="im in io ip iq"><h2 id="ffe4" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">产品模块</h2><p id="ed3b" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">现在让我们为API网关的产品模块重复这个过程。</p><p id="a9ed" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们把<code class="fe oc od oe of b">src/product/product.module.ts</code>从</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><p id="7a10" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">到</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><h2 id="ae03" class="nm mp it bd mq nn no dn mu np nq dp my lm nr ns na lq nt nu nc lu nv nw ne iz bi translated">产品控制器</h2><p id="0a5e" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">产品微服务包含3个端点，但是DecreaseStock不应该从我们的API网关到达，这就是为什么要添加另外2个端点。</p><p id="ae7f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们改变<code class="fe oc od oe of b">src/product/product.controller.ts</code>形式</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><p id="29f2" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">到</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div></figure><p id="2891" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">太好了！就是这样。API网关已完成。现在我们可以运行它了。不幸的是，没有它的微服务，这个API网关就没用了，所以让我们继续本文的第2部分。</p><pre class="ks kt ku kv gt og of oh oi aw oj bi"><span id="52bf" class="nm mp it of b gy ok ol l om on">$ npm run start:dev</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pr"><img src="../Images/ad8395c6b6e02aa7c98e3350c97e558c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nkObiy6CzmS-PkZUXuASiw.png"/></div></div></figure></div><div class="ab cl pd pe hx pf" role="separator"><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi"/></div><div class="im in io ip iq"><p id="5428" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">感谢您阅读我关于NestJS微服务的文章的第一部分。点击<a class="ae mn" rel="noopener ugc nofollow" target="_blank" href="/nestjs-microservices-with-grpc-api-gateway-and-authentication-part-2-2-d67dc8e3b86a">此处</a>进入第2部分。</p><p id="6ad7" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">干杯！</p></div><div class="ab cl pd pe hx pf" role="separator"><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi"/></div><div class="im in io ip iq"><p id="3c68" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我希望你喜欢读这篇文章。如果你愿意支持我成为一名作家，可以考虑注册<a class="ae mn" href="https://medium.com/@hellokevinvogel/membership" rel="noopener">成为</a>的媒体成员。每月只需5美元，你就可以无限制地使用Medium。</p><p id="f64b" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">想支持我？<a class="ae mn" href="https://www.buymeacoffee.com/hellokevinvogel" rel="noopener ugc nofollow" target="_blank">给我买杯咖啡。</a></p></div><div class="ab cl pd pe hx pf" role="separator"><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi"/></div><div class="im in io ip iq"><h1 id="7c6c" class="mo mp it bd mq mr pk mt mu mv pl mx my ki pm kj na kl pn km nc ko po kp ne nf bi translated">接下来阅读</h1><div class="ps pt gp gr pu pv"><a rel="noopener  ugc nofollow" target="_blank" href="/nestjs-microservices-with-grpc-api-gateway-and-authentication-part-2-2-d67dc8e3b86a"><div class="pw ab fo"><div class="px ab py cl cj pz"><h2 class="bd jd gy z fp qa fr fs qb fu fw jc bi translated">NestJS:具有gRPC、API网关和身份验证的微服务—第2/2部分</h2><div class="qc l"><h3 class="bd b gy z fp qa fr fs qb fu fw dk translated">认证服务(grpc-nest-auth-svc)</h3></div><div class="qd l"><p class="bd b dl z fp qa fr fs qb fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="qe l"><div class="qf l qg qh qi qe qj lb pv"/></div></div></a></div></div><div class="ab cl pd pe hx pf" role="separator"><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi"/></div><div class="im in io ip iq"><h1 id="3fb0" class="mo mp it bd mq mr pk mt mu mv pl mx my ki pm kj na kl pn km nc ko po kp ne nf bi translated">分级编码</h1><p id="c981" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">感谢您成为我们社区的一员！<strong class="lf jd">在</strong> <a class="ae mn" href="https://jobs.levelup.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="lf jd">级别的工作平台</strong> </a> <strong class="lf jd">上雇佣不可思议的软件工程师。</strong></p><div class="ps pt gp gr pu pv"><a href="https://jobs.levelup.dev" rel="noopener  ugc nofollow" target="_blank"><div class="pw ab fo"><div class="px ab py cl cj pz"><h2 class="bd jd gy z fp qa fr fs qb fu fw jc bi translated">提升就业平台</h2><div class="qc l"><h3 class="bd b gy z fp qa fr fs qb fu fw dk translated">软件工程师、数据科学家、经理、设计师、建设者和程序员的最佳角色</h3></div><div class="qd l"><p class="bd b dl z fp qa fr fs qb fu fw dk translated">作业. levelup.dev</p></div></div><div class="qe l"><div class="qk l qg qh qi qe qj lb pv"/></div></div></a></div></div></div>    
</body>
</html>