<html>
<head>
<title>Basic Custom Cookie Authentication with .Net Core 3.1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基本自定义Cookie身份验证。网络核心3.1</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/basic-custom-cookie-authentication-with-net-core-3-1-a8ef1df11f8f?source=collection_archive---------1-----------------------#2020-09-23">https://levelup.gitconnected.com/basic-custom-cookie-authentication-with-net-core-3-1-a8ef1df11f8f?source=collection_archive---------1-----------------------#2020-09-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="20f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向. NET core 3.1应用程序添加简单的自定义基于cookie的身份验证</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/a0d1b6b6f943a6509ad485b6620c1051.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wBCznV-fjiL3r6FV"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/@randalynhill?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Randalyn Hill </a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="a933" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我订婚了！你不常在博客/教程上看到关于如何开发代码的开头，但是你看到了。</p><p id="d98b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我这样说是因为它提供了本教程来源的背景。我和我的未婚夫想要一个网站，让客人可以选择他们的膳食选择。预制网站有很多选择(有些甚至是免费的)，但我决定自己制作。</p><p id="26e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个想法是有一个密码保护的网站。然而，代替普通密码，这意味着客人必须输入他们的详细信息(姓名等。)，我们想要一个邀请特定的密码，然后使该网站能够识别客人并直接存储他们的RSVP。</p><p id="8bf0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终，我将能够构建一个“组织者”界面来查看所有的响应，很可能是由GraphQL API驱动的！(我有一个关于如何创建. NET GraphQL API的教程<a class="ae lb" href="https://mattlaw.dev/blog/graph-ql-with-net/" rel="noopener ugc nofollow" target="_blank">,如果你想学习如何做的话！)</a></p><p id="7fb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了实现这一点，我不想通过电子邮件来识别用户，然后检查提供的密码；我既不知道每个人的电子邮件，也不想输入它们。所以“开箱即用”的身份验证。网核是不够的。</p><p id="6013" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们现在可以进入教程的核心部分…自定义cookie身份验证。网芯！</p><p id="dbeb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设你已经有了某种形式的. NET核心web应用程序，我将直接跳到重要的部分。</p><p id="7280" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe lc ld le lf b">Startup.cs</code>中，您需要包含添加认证(特别是基于cookie的认证)的代码。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lg lh l"/></div></figure><p id="5dbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要编译这段代码，您还需要包含“Microsoft。AspNetCore . authentic ation . cookies " n获取包并将其添加到文件顶部的usings中。</p><p id="c386" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是做什么的？嗯:</p><ul class=""><li id="0513" class="li lj iq jp b jq jr ju jv jy lk kc ll kg lm kk ln lo lp lq bi translated">在<code class="fe lc ld le lf b">ConfigureServices</code>中它讲述了。NET包含处理请求的认证服务，并且应该使用<code class="fe lc ld le lf b">CookieAuthentication</code>方案。</li><li id="d9a2" class="li lj iq jp b jq lr ju ls jy lt kc lu kg lv kk ln lo lp lq bi translated">然后<code class="fe lc ld le lf b">AddCookie</code>调用允许您设置自己的参数，如<code class="fe lc ld le lf b">LoginPath</code>。默认情况下，登录路径将带您到<code class="fe lc ld le lf b">/Accont/Login</code>，并带有针对<code class="fe lc ld le lf b">ReturnUrl</code>的查询参数。</li><li id="9501" class="li lj iq jp b jq lr ju ls jy lt kc lu kg lv kk ln lo lp lq bi translated">我想自定义这一点，因为在这个网站上没有真正的“帐户”的概念。相反，一切都与“邀请”联系在一起。</li><li id="6689" class="li lj iq jp b jq lr ju ls jy lt kc lu kg lv kk ln lo lp lq bi translated">在<code class="fe lc ld le lf b">Configure</code>里面增加了两行:<code class="fe lc ld le lf b">app.UseAuthentication()</code> &amp; <code class="fe lc ld le lf b">app.UseAuthorization()</code>。这些将实际的中间件添加到请求管道中，请求管道自己处理请求。</li></ul><p id="e714" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要测试这一点，只需将<code class="fe lc ld le lf b">[Authorize]</code>属性添加到您的一个控制器动作中，它会将您重定向到您上面配置的登录路径(很可能是404，因为它还不存在)。</p><p id="230b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们需要处理登录！</p><p id="b1a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，我创建了一个名为“AccessController”的新控制器。它有两个动作处理程序:<code class="fe lc ld le lf b">public IActionResult Index()</code>和<code class="fe lc ld le lf b">public IActionResult Index(string passphrase)</code>。</p><p id="0b90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">无参数处理程序添加了一个HttpGet属性(这样它只能在Get请求时访问), HttpPost属性添加到了另一个。</p><p id="9ada" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">GET处理程序很简单:它返回一个包含单个输入(针对“密码短语”)的表单视图。</p><p id="8ebb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">POST处理程序稍微复杂一些:</p><ul class=""><li id="21f0" class="li lj iq jp b jq jr ju jv jy lk kc ll kg lm kk ln lo lp lq bi translated">它调用一个存储库(我使用的是存储库模式)来使用密码检索一个<code class="fe lc ld le lf b">Invite</code>。</li><li id="666f" class="li lj iq jp b jq lr ju ls jy lt kc lu kg lv kk ln lo lp lq bi translated">然后，如果返回一个邀请，它会创建一个新的<code class="fe lc ld le lf b">ClaimsPrincipal</code>，包含该邀请的一些基本细节。</li><li id="7e15" class="li lj iq jp b jq lr ju ls jy lt kc lu kg lv kk ln lo lp lq bi translated">最后，它“登录”用户，并将他们重定向回主页(这是您将使用<code class="fe lc ld le lf b">ReturnUrl</code>参数的地方，但是由于此时用户只能去一个地方，这是后来的改进)</li></ul><p id="cbb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一切看起来像什么？</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lg lh l"/></div></figure><p id="ed04" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样！简单吧？ID是根据声明主体存储的，因此我可以使用它在任何后续请求中快速方便地检索邀请。</p><p id="be03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为额外的收获，要做到这一点，您可以简单地在控制器内的任何处理程序方法中使用<code class="fe lc ld le lf b">HttpContext.User.Claims.FirstOrDefault(x =&gt; x.Type == ClaimTypes.Email)</code>。</p><p id="86a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来将是我如何设置。NET core和用于处理我的前端构建的<a class="ae lb" href="https://parceljs.org/" rel="noopener ugc nofollow" target="_blank"> ParcelJS </a>(提示:这是一个简短的构建，因为它非常简单就可以工作)。</p></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><p id="6199" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="md">原发布于</em><a class="ae lb" href="https://mattlaw.dev/blog/basic-custom-cookie-authentication-with-net-core-3-1/" rel="noopener ugc nofollow" target="_blank"><em class="md">https://mattlaw . dev</em></a><em class="md">。</em></p></div></div>    
</body>
</html>