<html>
<head>
<title>CI/CD With AWS CodePipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有AWS代码管道的CI/CD</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/ci-cd-with-aws-codepipeline-a452c5b88c60?source=collection_archive---------3-----------------------#2022-03-20">https://levelup.gitconnected.com/ci-cd-with-aws-codepipeline-a452c5b88c60?source=collection_archive---------3-----------------------#2022-03-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0df6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何使用AWS CodePipeline和GitHub为CDK应用程序创建部署管道</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/440781beb1bad4edf3ee94a128d75aa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YdsstOSFxmJHpf1e85OyGg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">作者为<a class="ae kv" href="https://pawara73.medium.com/" rel="noopener">的作品</a></figcaption></figure><p id="c5c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是另一篇“如何做”的文章，将描述使用AWS代码管道创建部署管道的过程。现在，项目的构建、测试和部署不再是手工进行的。借助各种云服务提供商提供的CI/CD技术，任何应用程序的整个部署流程都得到了简化，只需最少的人工干预。</p><p id="d9d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">AWS Codepipeline是AWS提供的一种服务，用于自动化项目的发布管道。在本文中，我们将自动化CDK项目的部署管道，并将AWS Codepipeline集成到GitHub存储库中。</p><p id="0d33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">【在本文末尾找到源代码】</em></p><h2 id="8542" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">什么是AWS代码管道？</h2><p id="aac4" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">根据AWS自己的说法，AWS CodePipeline是一种完全托管的连续交付服务，有助于实现发布管道的自动化，以实现快速可靠的应用程序和基础架构更新。当提交对代码库的更改时，您可以自动化您的CDK应用程序的整个构建、测试和部署过程(您可以在发布模型中定义特定的触发器)。因此，Codepipeline是用于持续交付AWS CDK应用程序的构造库模块。</p><p id="4633" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一项始终免费的服务，但在AWS免费层下，每月为您提供01个活动管道，之后则属于现收现付选项。CodePipeline的特点是它可以与AWS CodeCommit、CodeStar或GitHub等第三方服务以及自己的定制插件集成。</p><h2 id="a241" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">使用AWS CodePipeline、CDK和GitHub的部署管道</h2><p id="c4a1" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">我们将实现CI/CD管道，如图1所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mr"><img src="../Images/adc5510c878eeeaaf9223ead6b5359c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0W3UKwNHOkmp9PQl90eaqg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图01:部署管道的高层架构(来源:由<a class="ae kv" href="https://pawara73.medium.com/" rel="noopener">作者</a>用<a class="ae kv" href="https://app.diagrams.net/" rel="noopener ugc nofollow" target="_blank"> draw.io </a>设计)</figcaption></figure><p id="2de4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">CDK项目的代码库、lambda函数的源代码和发布管道都包含在GitHub库中。图01中间框中描绘的管道将在AWS账户中创建，并通过回购中的CDK代码进行定义。</p><p id="84f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将对它进行设置，以便每次我们提交对GitHub repo的更改时，它都会发布到测试环境中的AWS lambda函数。管道中的下一个主要步骤是需要手动批准，在将代码部署到生产环境之前，您必须检查更改并批准。生产阶段也采用了lambda函数。</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h1 id="8183" class="mz lu iq bd lv na nb nc ly nd ne nf mb jw ng jx me jz nh ka mh kc ni kd mk nj bi translated">步骤:01 —先决条件</h1><p id="bba9" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">您需要创建或安装一些先决条件(按照链接)，我不打算在本文中解释。您可以很容易地按照CDK研讨会的先决条件步骤来配置您的本地环境。(在Windows中，如果终端命令不适用于PowerShell，请使用命令提示符)。</p><blockquote class="nk nl nm"><p id="7297" class="kw kx ls ky b kz la jr lb lc ld ju le nn lg lh li no lk ll lm np lo lp lq lr ij bi translated">注:如果你对CDK不熟悉，强烈推荐关注<a class="ae kv" href="https://cdkworkshop.com/" rel="noopener ugc nofollow" target="_blank"> CDK工作坊</a>(免费)并参考这篇文章，下一篇。</p></blockquote><ol class=""><li id="7635" class="nq nr iq ky b kz la lc ld lf ns lj nt ln nu lr nv nw nx ny bi translated"><a class="ae kv" href="https://cdkworkshop.com/15-prerequisites/100-awscli.html" rel="noopener ugc nofollow" target="_blank">安装AWS-CLI </a></li><li id="9eba" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated"><a class="ae kv" href="https://cdkworkshop.com/15-prerequisites/200-account.html" rel="noopener ugc nofollow" target="_blank">创建AWS账户并配置凭证</a></li><li id="81d0" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated"><a class="ae kv" href="https://cdkworkshop.com/15-prerequisites/300-nodejs.html" rel="noopener ugc nofollow" target="_blank">安装节点j</a></li><li id="bfc6" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated"><a class="ae kv" href="https://cdkworkshop.com/15-prerequisites/500-toolkit.html" rel="noopener ugc nofollow" target="_blank">安装CDK </a>(全球)</li><li id="b6f4" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated">创建一个空的GitHub存储库并克隆它</li></ol><p id="0f49" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完成先决条件之后，您可以按照下面的步骤来设置您的第一个AWS部署管道。</p><h1 id="34a1" class="mz lu iq bd lv na oe nc ly nd of nf mb jw og jx me jz oh ka mh kc oi kd mk nj bi translated">步骤02:设置CDK项目</h1><h2 id="b970" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">1.建立CDK项目的初始代码库</h2><p id="b1e8" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">创建一个文件夹，并给出您偏好的名称(我的是<em class="ls">AWS-code pipeline-project</em>)。打开文件夹中的VS代码(或任何代码编辑器),运行以下命令来初始化CDK应用程序。</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="1e9d" class="lt lu iq ok b gy oo op l oq or">cdk init app --language typescript</span></pre><p id="621b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">(是的，我将使用typescript来实现CDK项目的代码库。)</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi os"><img src="../Images/3572cb5c70fd73d6f56e9b23a9639b40.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/format:webp/1*8Se2TeURWGcYZQSoiGdbfA.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图02:CDK项目的初始文件夹结构(来源:<a class="ae kv" href="https://pawara73.medium.com/" rel="noopener">作者</a>截图)</figcaption></figure><p id="1add" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦项目成功初始化，导航到“bin”目录并打开文件<em class="ls">“your-root-directory-name . ts”</em>并进行以下修改。我添加了一些注释来解释代码，以及哪里需要修改。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">bin/your-project-name.ts</figcaption></figure><p id="8bc0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，修改lib目录中的'<em class="ls">your-root-directory-name-stack . ts '</em>，如下所示。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">lib/您的项目名称堆栈. ts</figcaption></figure><p id="8f1a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在AwsCodepipelineProjectStack类中，我们创建了一个新的代码管道构造。可以用合适的名称(我的是CDKTestPipeline)来命名。接下来，添加一个新的合成“ShellStep ”,指向我们的GitHub库，CDK代码库就在这里。在那里，管道执行将在我们的存储库的主要分支发生任何变化时发生。最后，为管道中的构建步骤添加命令:</p><ul class=""><li id="e362" class="nq nr iq ky b kz la lc ld lf ns lj nt ln nu lr ov nw nx ny bi translated"><em class="ls"> npm ci </em> - (npm全新安装)，类似于在自动化环境中使用的npm安装。</li><li id="c517" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr ov nw nx ny bi translated">npm运行构建 -允许我们为项目执行任何必要的构建/准备任务。</li><li id="d833" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr ov nw nx ny bi translated">npx cdk synth  -合成我们在云形成堆栈中拥有的任何东西，以生成自变异管道。</li></ul><h2 id="39ef" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">2.将更改提交到远程GitHub存储库</h2><p id="f2aa" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">在将更改提交到远程存储库之前，首先检查配置。</p><p id="d6e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">设置远程原点。</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="0cb1" class="lt lu iq ok b gy oo op l oq or">git remote add origin https://github.com/aLLUPS/aws-codepipeline-project.git</span></pre><p id="84e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您的CDK项目中缺少一个. gitignore文件，那么请确保添加一个并在其中包含“node_modules”。</p><p id="52db" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后提交更改并将代码库推送到远程存储库。</p><h1 id="e5e0" class="mz lu iq bd lv na oe nc ly nd of nf mb jw og jx me jz oh ka mh kc oi kd mk nj bi translated">步骤03:在AWS中提供访问和配置</h1><h2 id="a6a3" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">1.生成GitHub个人访问令牌</h2><p id="6000" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">现在我们需要在GitHub存储库和AWS帐户之间创建一个连接。为此，我们需要一个访问令牌，该令牌允许AWS正确访问我们的GitHub存储库。</p><p id="3d28" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要做到这一点，在你的GitHub账户中进入开发者设置，在个人访问令牌下，点击“生成新令牌”(图03)。为新令牌提供一个合适的名称，并确保选中复选框:<em class="ls"> repo </em>和<em class="ls"> admin:repo_hook。</em>然后点击“生成令牌”。生成令牌后，将其保存在某个地方，因为您将无法再查看它。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/5c5b726524ed0dec5aa975c1d2e9c75a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*coREddyKc-7unkuHgeUKpg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图03:生成GitHub个人访问令牌(来源:<a class="ae kv" href="https://pawara73.medium.com/" rel="noopener">作者</a>截图)</figcaption></figure><h2 id="4a4a" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">2.配置AWS帐户</h2><p id="9118" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">转到AWS管理控制台，搜索“Secrets Manager”。这是一个30天的免费试用服务，在此之后，你将不得不支付每个秘密每月0.40美元，每10，000个API调用0.05美元。</p><p id="af76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，转到“存储新密码”和“<em class="ls">选择其他类型的密码</em>”。然后选择'<em class="ls">键/值对</em>'下的'<em class="ls">纯文本</em>选项，并粘贴GitHub个人访问令牌。然后给它起一个合适的名字(我的是<em class="ls"> github-token </em>)。最后，“存储”密钥。</p><blockquote class="nk nl nm"><p id="2f31" class="kw kx ls ky b kz la jr lb lc ld ju le nn lg lh li no lk ll lm np lo lp lq lr ij bi translated">注意:您必须将“秘密”存储在您在先决条件步骤2中配置AWS凭据的同一区域中。(即在AWS管理控制台中首先选择区域，然后存储秘密)。</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/3972d925c2a58e3e51b64f69838d0196.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*poHFTEX07fzJrnC2gXVdFg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图04:将GitHub个人访问令牌存储在“AWS Secrets Manager”中(来源:作者<a class="ae kv" href="https://pawara73.medium.com/" rel="noopener">截图</a></figcaption></figure><h1 id="9d50" class="mz lu iq bd lv na oe nc ly nd of nf mb jw og jx me jz oh ka mh kc oi kd mk nj bi translated">步骤04:部署具有基本阶段的管道</h1><h2 id="dc7e" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated"><strong class="ak"> 1。在本地存储库中引导CDK项目</strong></h2><p id="6594" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">如果你第一次在本地机器上运行CDK项目，在将CDK项目部署到codepipeline之前的另一个重要步骤是引导它。在根目录中打开的命令提示符下运行以下命令来引导您的项目环境。</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="d187" class="lt lu iq ok b gy oo op l oq or">cdk bootstrap</span></pre><p id="1baa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要成功运行该命令，首先，您必须在<a class="ae kv" href="#9eba" rel="noopener ugc nofollow">先决条件步骤2 </a>中正确配置凭证。该区域应与<em class="ls"/><a class="ae kv" href="#1add" rel="noopener ugc nofollow"><em class="ls">bin/your-project-name . ts</em></a>文件中环境变量下给定的区域相同。</p><p id="bfbc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果引导过程成功，您将能够看到在您的AWS帐户中创建的CloudFormation堆栈(图05)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/7716b81163c9fb641af38cafb1cfaeee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G4VocuIAbXwj3evGfCYL6Q.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图05:CDK项目的云形成堆栈(来源:<a class="ae kv" href="https://pawara73.medium.com/" rel="noopener">作者</a>截图)</figcaption></figure><h2 id="bd92" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">2.部署CDK项目</h2><p id="25b2" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">这一步将创建我们的代码管道的初始版本和部署项目所需的其他基础设施。为此，请在命令提示符下运行以下命令。</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="ce73" class="lt lu iq ok b gy oo op l oq or">cdk deploy</span></pre><p id="243d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您运行deploy命令时，它会询问您是否需要创建管道和其他必要的基础设施，并输入“yes”继续部署。如果部署失败，很可能是由于您的GitHub访问令牌有问题，将秘密存储在不同的区域等等。参考<a class="ae kv" href="https://docs.aws.amazon.com/cdk/api/v1/docs/pipelines-readme.html#troubleshooting" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> AWS CDK文档中给出的以下故障排除选项。</strong> </a> <strong class="ky ir"> </strong>如果部署成功，您可以看到完成的CloudFormation堆栈和创建的管道(图06)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/fcf59fc7331f25bb1909e8b75bbed1ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WooJfnSh5ukwrE7oyjyhRQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图07:部署管道成功创建(来源:作者截图)</figcaption></figure><p id="d1ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在图07中，您可以看到我们CDK项目的初始管道由03个主要阶段组成:源代码、构建和更新管道。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/c5bd55d3d04ed65097ac80bc3470ae2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*UgOxVwMRJ1iRoiO0UxboFg.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图07:初始管道中的步骤(来源:作者截图)</figcaption></figure><h1 id="da32" class="mz lu iq bd lv na oe nc ly nd of nf mb jw og jx me jz oh ka mh kc oi kd mk nj bi translated">步骤05:在管道中配置更多步骤</h1><h2 id="a83b" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">1.初始化Lambda</h2><p id="297a" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">转到lib目录并创建新文件“lambda-stack.ts ”,如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">lib/lambda-stack.ts</figcaption></figure><p id="ba34" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将有一个lambda函数的测试和生产环境。我们希望在lambda函数(stageName)中设置一个环境变量，以便它知道自己处于哪个阶段。例如，假设我们有两个数据库作为测试和生产。在这里，我们的lambda函数的测试版本知道它处于测试阶段，它将连接到测试数据库，而生产版本将知道它处于生产阶段，并将连接到生产数据库。</p><p id="8ee7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，在“lib”目录中创建一个名为“lambda”的新目录，并在其中创建一个新文件“handler.ts”。因为在lambda-stack.ts中，我们定义了一个处理程序文件，它带有一个名为“handler”的入口点函数，位于目录“lambda”中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">lib/λ/handler . ts</figcaption></figure><h2 id="e703" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">2.设置阶段</h2><p id="2817" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">下一步是搭建舞台。在lib目录中创建一个名为“stage.ts”的新文件，并对其进行如下修改。这里我们从lambda stack创建了一个新的lambda堆栈，并应该传递stageName。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">库/阶段. ts</figcaption></figure><p id="1951" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了将'<em class="ls"> stageName </em>'添加到stage.ts中，我们应该将以下代码行添加到' lib/your-project-name-stack.ts '文件中。在这里，也要确保使用与您之前配置的相同的帐户ID和“aws-region”。此外，在测试阶段之后，我还添加了一个手动审查步骤(第29行)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">lib/您的项目名称堆栈. ts</figcaption></figure><h2 id="90bf" class="lt lu iq bd lv lw lx dn ly lz ma dp mb lf mc md me lj mf mg mh ln mi mj mk ml bi translated">3.提交更改以更新管道</h2><p id="0cf4" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">最后，将代码更改提交到远程GitHub存储库。一旦repo更新，在codepipeline中，您将会看到添加的新阶段:测试、人工批准和生产，而不是初始阶段、源代码、构建和更新管道。管道的执行将被暂停，直到您对变更提供手动批准(图08)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/a240323c0b3262e26e4d0bdbe89f69db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vQ1bahcCI5nwwK-tdj6jRw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图08:人工审批步骤(来源:<a class="ae kv" href="https://pawara73.medium.com/" rel="noopener">作者</a>截图)</figcaption></figure><p id="8bad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完整的流水线如图09所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pc"><img src="../Images/ebb3e729104489db3ab0a3066bcd18fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*WcT7kluYdZ1MmYczuwQxgw.gif"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图09:完整的部署管道(来源:由<a class="ae kv" href="https://pawara73.medium.com/" rel="noopener">作者</a>创建的屏幕记录器)</figcaption></figure><p id="56b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，现在您已经成功地用AWS代码管道为您的CDK项目设置了CI/CD管道。</p><p id="d5a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个非常基本的AWS Codepipeline实现，使用GitHub连接到您的CDK项目。您可以添加单元测试并进一步修改它们。</p><ul class=""><li id="57f5" class="nq nr iq ky b kz la lc ld lf ns lj nt ln nu lr ov nw nx ny bi translated"><strong class="ky ir">https://github.com/aLLUPS/aws-cdk-codepipeline-public.git CDK项目的GitHub链接:</strong><a class="ae kv" href="https://github.com/aLLUPS/aws-cdk-codepipeline-public.git" rel="noopener ugc nofollow" target="_blank"/></li></ul><h1 id="b75b" class="mz lu iq bd lv na oe nc ly nd of nf mb jw og jx me jz oh ka mh kc oi kd mk nj bi translated"><strong class="ak">参考文献:</strong></h1><p id="88f9" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated"><a class="ae kv" href="https://docs.aws.amazon.com/cdk/v2/guide/cdk_pipeline.html" rel="noopener ugc nofollow" target="_blank">使用Amazon.com CDK管道— AWS云开发套件(CDK) v2的持续集成和交付(CI/CD)</a></p><p id="af3b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://aws.amazon.com/cdk/#:~:text=CDK%20allows%20you%20to%20use,needing%20to%20be%20an%20expert." rel="noopener ugc nofollow" target="_blank">AWS</a><a class="ae kv" href="https://aws.amazon.com/codepipeline/" rel="noopener ugc nofollow" target="_blank">AWS code pipeline |持续集成&amp;持续交付(Amazon.com)</a></p><p id="0a8b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://aws.amazon.com/cdk/#:~:text=CDK%20allows%20you%20to%20use,needing%20to%20be%20an%20expert." rel="noopener ugc nofollow" target="_blank">云开发工具包—亚马逊网络服务</a></p><p id="5d7e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://docs.aws.amazon.com/cdk/api/v1/docs/pipelines-readme.html#troubleshooting" rel="noopener ugc nofollow" target="_blank">@ AWS-CDK/管道模块AWS CDK(Amazon.com)</a></p></div></div>    
</body>
</html>