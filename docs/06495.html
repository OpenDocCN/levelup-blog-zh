<html>
<head>
<title>Manage your Terraform state</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理您的地形状态</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/manage-your-terraform-state-1be1eb8e16f4?source=collection_archive---------14-----------------------#2020-11-30">https://levelup.gitconnected.com/manage-your-terraform-state-1be1eb8e16f4?source=collection_archive---------14-----------------------#2020-11-30</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="bf33" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">或者我如何学会不再担心DevOps</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/61410242b7b1907007962b1a2703057a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jf1l_nA2J2SxG5Up"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">安德雷亚·波帕在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="6576" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi lw translated"><span class="l lx ly lz bm ma mb mc md me di">我</span>过去常常避免任何类型的DevOps工作。我不知道也不想学习如何配置服务器、管理负载平衡器或扩展数据库。我只想为最终用户编码。</p><p id="0adb" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">随着无服务器架构的兴起，我对DevOps的恐惧开始减少。我的许多痛苦都消失了。</p><p id="10e8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">然后我读到了<a class="ae kz" href="https://en.wikipedia.org/wiki/Infrastructure_as_code" rel="noopener ugc nofollow" target="_blank">infra structure as code(IaC)</a>，并迷上了DevOps可以更容易管理和更有趣的想法，因为所有这些都只是代码。</p><p id="b732" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我开始学习把Terraform作为我事实上的IaC工具，因为我们在我工作的地方使用它。我可以通过运行一个命令来定义我的资源并进行部署，而不是在AWS控制台中四处点击。为了实现完全自动化，我可以在每次推送回购时通过CI/CD管道运行它。</p><p id="a329" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">有了Terraform，DevOps对我来说变得更加容易和容易。</strong></p><p id="16b1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我唯一的问题是所有的东西都在我的本地机器上，我不能和我的团队或者其他人分享。我考虑过使用源代码控制，但是由于Terraform管理状态的方式，我可能会遇到一些安全问题。</p><p id="8721" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Terraform docs提供了一个实现后端的解决方案，在那里我可以<a class="ae kz" href="https://www.terraform.io/docs/state/index.html" rel="noopener ugc nofollow" target="_blank">存储</a>和<a class="ae kz" href="https://www.terraform.io/docs/state/locking.html" rel="noopener ugc nofollow" target="_blank">管理</a>我的基础设施的状态。</p></div><div class="ab cl mf mg hy mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="in io ip iq ir"><h1 id="dd73" class="mm mn iu bd mo mp mq mr ms mt mu mv mw ka mx kb my kd mz ke na kg nb kh nc nd bi translated">我该如何开始？</h1><p id="374b" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated"><em class="nj">以下是我使用Terraform设置项目的首选方式。</em></p><h2 id="1eba" class="nk mn iu bd mo nl nm dn ms nn no dp mw lj np nq my ln nr ns na lr nt nu nc nv bi translated">先决条件</h2><p id="a3aa" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">请确保您已完成以下步骤:</p><ul class=""><li id="7cc4" class="nw nx iu lc b ld le lg lh lj ny ln nz lr oa lv ob oc od oe bi translated">安装<a class="ae kz" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>和<a class="ae kz" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html" rel="noopener ugc nofollow" target="_blank">配置</a>它</li><li id="0bd6" class="nw nx iu lc b ld of lg og lj oh ln oi lr oj lv ob oc od oe bi translated">安装<a class="ae kz" href="https://learn.hashicorp.com/tutorials/terraform/install-cli?in=terraform/aws-get-started" rel="noopener ugc nofollow" target="_blank"> Terraform 0.13或以上</a></li></ul><h2 id="88d2" class="nk mn iu bd mo nl nm dn ms nn no dp mw lj np nq my ln nr ns na lr nt nu nc nv bi translated">项目结构</h2><p id="4023" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated"><em class="nj">您可能已经习惯了其他的代码组织方式，并且可以根据您的偏好或需求进行调整。</em></p><pre class="kk kl km kn gu ok ol om on aw oo bi"><span id="8d86" class="nk mn iu ol b gz op oq l or os">infrastructure<br/>│   <br/>└─── global<br/>│   │  <br/>│   └─── state_local<br/>│   │   │ main.tf<br/>│   │   │ output.tf<br/>│   │   │ variables.tf <br/>│   │  <br/>│   └─── state_remote<br/>│       │ main.tf<br/>│       │ output.tf<br/>│       │ variables.tf<br/>│<br/>└─── dev<br/>│<br/>└─── modules<br/>backend.hcl<br/>global.tfvars<br/>setup.sh<br/>teardown.sh</span></pre><h2 id="729e" class="nk mn iu bd mo nl nm dn ms nn no dp mw lj np nq my ln nr ns na lr nt nu nc nv bi translated">一切是什么意思？</h2><p id="8d09" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated"><code class="fe ot ou ov ol b">infrastructure</code>中的<code class="fe ot ou ov ol b">dev</code>文件夹是您项目中的所有环境。可能只有一个、五个或十个。</p><p id="80f7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe ot ou ov ol b">modules</code>是你定义项目基础设施的地方:木桶、VPC、兰姆达斯等等。这也支持项目中的代码可重用性。</p><p id="2203" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe ot ou ov ol b">global</code>文件夹将创建您的远程后端，在S3上存储您的状态，并管理DynamoDB上的锁，以防止与您的团队发生冲突或损坏。</p><h2 id="5d5c" class="nk mn iu bd mo nl nm dn ms nn no dp mw lj np nq my ln nr ns na lr nt nu nc nv bi translated">代码材料</h2><p id="a67e" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">配置文件的要点:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ow ox l"/></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">backend.hcl文件将用于设置您所在州的后端配置。您可以更改DynamoDB表的名称。确保名称以文件global.tfvars中的service_name开头。</figcaption></figure><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ow ox l"/></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">global.tfvars文件将用作命名资源的前缀。你也可以设置更多的变量。用您自己的名称更新service_name。</figcaption></figure><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ow ox l"/></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">setup.sh文件是一个bash脚本，用于初始化您的Terraform远程状态。更新STATE_BUCKET_NAME变量。这将是用于存储状态的S3存储桶的名称。</figcaption></figure><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ow ox l"/></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">teardown.sh文件是一个bash脚本，用于删除您的Terraform远程状态。更新STATE_BUCKET_NAME变量。这将是用于存储状态的S3存储桶的名称。</figcaption></figure><p id="5407" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下一步是开始在<code class="fe ot ou ov ol b">global</code>文件夹里面写东西。</p><p id="cddc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们将在<code class="fe ot ou ov ol b">state_local</code>文件夹中定义远程后端。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ow ox l"/></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">定义您的S3桶和DynamoDB表。</figcaption></figure><p id="0a85" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你用版本控制和加密来定义我们的S3存储桶，在那里你的地形状态文件将被存储。您还定义了一个DynamoDB表来管理您的状态中的锁定。将<code class="fe ot ou ov ol b">hash_key</code>定义为<code class="fe ot ou ov ol b">LockID</code>很重要；如果不这样做，将不会启用锁定。</p><p id="3cfa" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在您需要将本地后端同步到远程。您可以通过将其添加到<code class="fe ot ou ov ol b">state_remote</code>文件夹中来实现。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ow ox l"/></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">定义您的S3桶和DynamoDB表。</figcaption></figure><p id="29d5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如您所见，该文件与前一个文件几乎相同。主要区别在于您定义了一个后端配置。这将告诉Terraform在S3寻找州，而不是创建一个新的S3桶和DynamoDB表。</p><h1 id="7e02" class="mm mn iu bd mo mp oy mr ms mt oz mv mw ka pa kb my kd pb ke na kg pc kh nc nd bi translated">我如何让它工作？</h1><blockquote class="pd"><p id="598d" class="pe pf iu bd pg ph pi pj pk pl pm lv dk translated"><em class="pn">现在我得到了这一堆文件，但是我的后端没有处理任何状态。</em></p></blockquote><p id="047a" class="pw-post-body-paragraph la lb iu lc b ld po jv lf lg pp jy li lj pq ll lm ln pr lp lq lr ps lt lu lv in bi translated">为了真正开始一切，我们需要运行我们之前编写的<code class="fe ot ou ov ol b">setup.sh</code> bash脚本。</p><p id="92d2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">确保有权限运行它。<em class="nj"> </em>提示:</strong> <code class="fe ot ou ov ol b"><strong class="lc iv">chmod +x ./setup.sh</strong></code></p><p id="d061" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">运行该脚本后，将创建一个S3桶和一个DynamoDB表，并且您的Terraform状态有其远程后端。</p><p id="52f4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，当你开始添加你的模块时，唯一要记住的是用存储状态的S3桶初始化它们的后端。作为一个例子，让我们假设我们有一个<code class="fe ot ou ov ol b">dev</code>文件夹，其中有一个名为<code class="fe ot ou ov ol b">storage</code>的模块。在<code class="fe ot ou ov ol b">modules</code>文件夹中，我们定义了模块<code class="fe ot ou ov ol b">storage</code>。里面有一个S3桶的定义。</p><p id="ab2d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">好吧，这听起来可能有点复杂，但这会让你项目中的一切都井井有条。 <a class="ae kz" href="https://github.com/jagonzalr/terraform-remote-backend-example" rel="noopener ugc nofollow" target="_blank"> <strong class="lc iv">为了方便起见，这里有一个Github repo，它为这个项目提供了完全相同的设置。</strong>T11】</a></p><p id="a58f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">添加一个新文件<code class="fe ot ou ov ol b">deploy.sh</code>到你的项目的根目录。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ow ox l"/></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">确保在state bucket上使用与setup.sh中定义的相同的名称。</figcaption></figure><p id="738b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这个文件的作用是为我们的<code class="fe ot ou ov ol b">storage</code>模块设置后端，然后创建(或更新)我们的基础设施。</p><p id="15de" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv"> Kataboom！</strong>现在你已经准备好与你的团队合作，而不用担心冲突。</p><h1 id="93a6" class="mm mn iu bd mo mp oy mr ms mt oz mv mw ka pa kb my kd pb ke na kg pc kh nc nd bi translated"><strong class="ak">总结</strong></h1><p id="317e" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">要记住的事情:</p><ul class=""><li id="2779" class="nw nx iu lc b ld le lg lh lj ny ln nz lr oa lv ob oc od oe bi translated">DevOps现在比以往任何时候都更容易接近</li><li id="c601" class="nw nx iu lc b ld of lg og lj oh ln oi lr oj lv ob oc od oe bi translated">Terraform是一个不错的选择(<a class="ae kz" href="https://dzone.com/articles/the-top-7-infrastructure-as-code-tools-for-automat" rel="noopener ugc nofollow" target="_blank">但不是唯一的</a>)</li><li id="62da" class="nw nx iu lc b ld of lg og lj oh ln oi lr oj lv ob oc od oe bi translated">您应该定义一个远程后端以便于协作</li><li id="eeec" class="nw nx iu lc b ld of lg og lj oh ln oi lr oj lv ob oc od oe bi translated">从上面的所有代码中检查这个<a class="ae kz" href="https://github.com/jagonzalr/terraform-remote-backend-example" rel="noopener ugc nofollow" target="_blank">Github repo</a></li></ul><p id="84d5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">有一个好的，并继续建设真棒的东西🎉</p><div class="pt pu gq gs pv pw"><a href="https://blog.jagonzalr.com/membership" rel="noopener  ugc nofollow" target="_blank"><div class="px ab fp"><div class="py ab pz cl cj qa"><h2 class="bd iv gz z fq qb fs ft qc fv fx it bi translated">加入我的介绍链接媒体-何塞安东尼奥冈萨雷斯罗德里格斯</h2><div class="qd l"><h3 class="bd b gz z fq qb fs ft qc fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="qe l"><p class="bd b dl z fq qb fs ft qc fv fx dk translated">blog.jagonzalr.com</p></div></div><div class="qf l"><div class="qg l qh qi qj qf qk kt pw"/></div></div></a></div></div></div>    
</body>
</html>