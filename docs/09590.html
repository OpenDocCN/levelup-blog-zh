<html>
<head>
<title>Airflow for Data Pipeline 101</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据管道101的气流</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/airflow-for-data-pipeline-101-7a42cc28cf3a?source=collection_archive---------10-----------------------#2021-08-24">https://levelup.gitconnected.com/airflow-for-data-pipeline-101-7a42cc28cf3a?source=collection_archive---------10-----------------------#2021-08-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5b73" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何使用Apache Airflow设置自动化数据管道</h2></div><p id="0a55" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">想象一下这样一个场景，您必须运行多个日常作业来从数据湖中提取数据，对它们进行预处理，并将清理后的数据集存储到专用数据库中。如果我们必须每天运行流水线，不断检查可能的错误，那将是非常乏味的。这就是Airflow派上用场的地方:它为您提供了自动构建和监控多个数据管道的所有工具。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/2da652a86c030bb68a452c3376eef3a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SXmt6JSQk_hVbjxD"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">照片由<a class="ae lu" href="https://unsplash.com/@fabioha?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">法比奥</a>在<a class="ae lu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="569e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇文章是我最近开始的与气流相关的系列文章的一部分:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="c7df" class="ma mb it lw b gy mc md l me mf">1. <strong class="lw iu">Airflow for Data Pipeline 101</strong><br/>2. <a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/airflow-decorators-for-a-clean-data-pipeline-48ebdf12e9b0">Airflow: Decorators for a Clean Data Pipeline</a><br/>3. <a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/airflow-unit-testing-for-bug-free-data-pipeline-d96f87a3cc8f">Unit Testing Your Airflow Data Pipeline</a><br/>4. <em class="mg">TBD...</em></span></pre><p id="9307" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，我将介绍气流的基本原理，以及如何使用它们来构建一个干净、高效、自动化的数据管道。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="01c6" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">Table of Content:<br/></strong>1. Installing Airflow<br/>2. Initializing Database<br/>3. Creating data pipeline tasks<br/>4. Testing and monitoring</span></pre><p id="fc5c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">事不宜迟，我们进入正题吧！</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="127b" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">安装气流</h1><p id="7392" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">目前，Airflow仅支持通过以下命令安装的<code class="fe nk nl nm lw b">pip</code>模式:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="9d10" class="ma mb it lw b gy mc md l me mf">pip install apache-airflow</span></pre><p id="1410" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">默认情况下，您的整个气流目录位于<code class="fe nk nl nm lw b">~/airflow</code>。但是，如果您选择更改默认目录，只需运行以下命令:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="3e0e" class="ma mb it lw b gy mc md l me mf">export AIRFLOW_HOME="&lt;YOUR_AIRFLOW_DIRECTORY&gt;"</span></pre></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="32af" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">正在初始化数据库</h1><p id="6b7f" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">现在，我们需要设置数据库来存储我们的气流工作流程。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="d4ef" class="ma mb it lw b gy mc md l me mf">airflow db init</span></pre><p id="a3c1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们通过运行以下命令来可视化web服务器中的气流:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="7ec3" class="ma mb it lw b gy mc md l me mf">airflow webserver --port 8080</span></pre><p id="dbd5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在你的浏览器中，输入<code class="fe nk nl nm lw b">http://localhost:8080</code>,你会看到下面的网页界面。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nn"><img src="../Images/2e2e033e764f4c4f940b0e9ee337c2df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yKoi5IuiH7Y9KTp2pPyi9Q.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">气流网络用户界面(图片由作者提供)</figcaption></figure><p id="942c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在继续之前，我们需要通过运行以下命令来创建用户名和密码(记得将<strong class="kk iu">名字</strong>、<strong class="kk iu">姓氏</strong>和<strong class="kk iu">电子邮件</strong>字段更改为您的字段):</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="f31d" class="ma mb it lw b gy mc md l me mf">airflow users create \<br/>    --username admin \<br/>    --firstname &lt;YOUR_FIRST_NAME&gt; \<br/>    --lastname &lt;YOUR_LAST_NAME&gt; \<br/>    --role Admin \<br/>    --email &lt;YOUR_EMAIL&gt;@&lt;YOUR_EMAIL_HOST&gt;</span></pre><p id="7e84" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">命令行会提示您输入密码。请记住这一点作为您的登录凭证。</p><p id="4230" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">登录后，您现在可以看到您的气流网络用户界面。祝贺你走到这一步！</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi no"><img src="../Images/53dddb9a7468b32eaebf5b32b17eec57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e5_BQ10jLCcGxxyWv0pOaQ.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">气流网络用户界面(图片由作者提供)</figcaption></figure></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="4678" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">创建数据管道任务</h1><p id="bfe7" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">气流中的管道被定义为任务。任务被构造为有向非循环图(DAG ),其中:</p><ul class=""><li id="efe1" class="np nq it kk b kl km ko kp kr nr kv ns kz nt ld nu nv nw nx bi translated"><strong class="kk iu">定向</strong>是指按预定顺序发生的有序任务</li><li id="75ae" class="np nq it kk b kl ny ko nz kr oa kv ob kz oc ld nu nv nw nx bi translated"><strong class="kk iu">非循环的</strong>意味着一个终止的任务，没有进入一个永久循环的可能性</li><li id="17da" class="np nq it kk b kl ny ko nz kr oa kv ob kz oc ld nu nv nw nx bi translated"><strong class="kk iu">图</strong>表示可以建立多对多任务关系的结构</li></ul><p id="305a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下图说明了一个使用DAG结构的简单数据管道。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi od"><img src="../Images/b21e759e5b14e9d1d127977f93e154be.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/0*bVShpN75LRapzqxt.png"/></div></figure><p id="821e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于本教程，我们将定义一个简单的管道，如下所示:</p><ul class=""><li id="9bb3" class="np nq it kk b kl km ko kp kr nr kv ns kz nt ld nu nv nw nx bi translated">打印<code class="fe nk nl nm lw b">data</code></li><li id="e6cd" class="np nq it kk b kl ny ko nz kr oa kv ob kz oc ld nu nv nw nx bi translated">等待5秒钟</li><li id="8190" class="np nq it kk b kl ny ko nz kr oa kv ob kz oc ld nu nv nw nx bi translated">打印<code class="fe nk nl nm lw b">pipeline</code></li></ul><p id="b87b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">第一步:创建一个DAG文件</strong></p><p id="2e64" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，导航到你的气流目录<code class="fe nk nl nm lw b">~/airflow/dags</code>(或者找出你在<code class="fe nk nl nm lw b">~/airflow/airflow.cfg</code>中指定的默认DAG目录)并创建<code class="fe nk nl nm lw b">airflow_tutorial.py</code>文件。我们将默认参数定义如下:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="0e6d" class="ma mb it lw b gy mc md l me mf">import datetime as dt</span><span id="ccf9" class="ma mb it lw b gy oe md l me mf">default_args = {</span><span id="8a58" class="ma mb it lw b gy oe md l me mf">    'owner': 'me',<br/>    'start_date': dt.datetime(2021, 8, 23),<br/>    'retries': 1,<br/>    'retry_delay': dt.timedelta(minutes=5),<br/>}</span></pre><p id="a24c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">默认设置指示该管道的所有者是“我”，并且该管道自2021年8月23日起有效。如果管道失败，该进程将不会发送任何电子邮件，并且允许在第一次失败后延迟5分钟重试一次。</p><p id="6d51" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">第二步:创建任务</strong></p><p id="6333" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，您可以为您的管道指定一个<code class="fe nk nl nm lw b">BashOperator</code>或<code class="fe nk nl nm lw b">PythonOperator</code>。第一个将运行bash相关的命令，而后者运行用户指定的Python函数。让我们在我们的例子中使用这两者。</p><p id="f116" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们导入并定义一个Python函数<code class="fe nk nl nm lw b">print_data()</code>，它将打印一个简单的<code class="fe nk nl nm lw b">'data'</code>字符串。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="89a2" class="ma mb it lw b gy mc md l me mf">import datetime as dt<br/><br/>from airflow import DAG<br/>from airflow.operators.bash_operator import BashOperator<br/>from airflow.operators.python_operator import PythonOperator<br/><br/>def print_data():<br/>    print('data')</span></pre><p id="daaa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们定义包括<code class="fe nk nl nm lw b">sleep</code>操作和<code class="fe nk nl nm lw b">'pipeline'</code>回显的完整管道。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="e524" class="ma mb it lw b gy mc md l me mf">with DAG('airflow_tutorial_v01',<br/>         default_args=default_args,<br/>         schedule_interval='0 * * * *',<br/>         ) as dag:<br/><br/>    print_data = PythonOperator(task_id='print_data',<br/>                               python_callable=print_data)<br/>    <br/>    sleep = BashOperator(task_id='sleep',<br/>                         bash_command='sleep 5')<br/>    <br/>    print_pipeline = BashOperator(task_id='print_pipeline',<br/>                                 bash_command='echo pipeline')</span></pre><p id="1ed5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们将DAG任务连接在一起。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="b85b" class="ma mb it lw b gy mc md l me mf">print_data &gt;&gt; sleep &gt;&gt; print_pipeline</span></pre></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="fabc" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">测试和监控</h1><p id="0704" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated"><strong class="kk iu">第一步:测试</strong></p><p id="5d00" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们有了完整的管道，让我们检查Python脚本的有效性。</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="d09d" class="ma mb it lw b gy mc md l me mf">python airflow_tutorial.py</span></pre><p id="aa52" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者，您可以按如下方式手动检查工作流程</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="6401" class="ma mb it lw b gy mc md l me mf">airflow test airflow_tutorial_v01 print_data 2021-08-23</span></pre><p id="ecbe" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将加载您的<code class="fe nk nl nm lw b">print_data()</code>函数并测试管道，就像是在2021年8月23日一样。</p><p id="0e9e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mg">注意:如果您注意到任何警告，请尝试按照所写的说明解决它们(例如安装</em> <code class="fe nk nl nm lw b"><em class="mg">kubernetes</em></code> <em class="mg">)。否则，您的管道将发挥作用！</em></p><p id="f16f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">第二步:监控</strong></p><p id="8d4a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您对您的管道有信心，我们可以对其进行部署和监控！运行:</p><pre class="lf lg lh li gt lv lw lx ly aw lz bi"><span id="e9d7" class="ma mb it lw b gy mc md l me mf">airflow scheduler</span></pre><p id="60b9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您重新打开web服务器UI，您会注意到您的管道正在运行！</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi of"><img src="../Images/c929147caad7cfa9588ff151f1abed5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XVbRf2JUsWc2BT3DoZfEjw.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">新气流管道(图片由作者提供)</figcaption></figure></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="db4f" class="mo mb it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated"><strong class="ak">结论</strong></h1><p id="8b29" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">我们已经成功地利用气流建造了一条简单的自动化管道。如果你喜欢这个帖子，我会写更多的文章详细介绍更先进的气流概念！</p><p id="7a04" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mg">请订阅我的电子邮件简讯:</em><a class="ae lu" href="https://tinyurl.com/2npw2fnz" rel="noopener ugc nofollow" target="_blank"><em class="mg">https://tinyurl.com/2npw2fnz</em></a><em class="mg">在那里，我会定期用通俗易懂的英语和漂亮的可视化方式总结编程技巧和AI研究论文。</em></p></div></div>    
</body>
</html>