<html>
<head>
<title>Load Test your NodeJS app using K6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用K6对NodeJS应用程序进行负载测试</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/load-test-your-nodejs-app-using-k6-f7b2bd8fa5cf?source=collection_archive---------8-----------------------#2020-12-06">https://levelup.gitconnected.com/load-test-your-nodejs-app-using-k6-f7b2bd8fa5cf?source=collection_archive---------8-----------------------#2020-12-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7e7876ecb7e9917ae192484d1aff6b5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Za7giJ_9j5Gybk6ZNpM3hw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">使用k6的负载测试</figcaption></figure><h1 id="d28d" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">什么是负载测试？</h1><p id="107a" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated"><strong class="lc ir">负载测试</strong>是一种软件<strong class="lc ir">测试</strong>，用来了解应用在特定预期<strong class="lc ir">负载</strong>下的行为。<strong class="lc ir">执行负载测试</strong>以确定系统在正常和峰值条件下的行为(<a class="ae ly" href="http://tryqa.com/what-is-load-testing-in-software/#:~:text=A%20load%20test%20is%20type,normal%20and%20at%20peak%20conditions." rel="noopener ugc nofollow" target="_blank">参考</a>)。</p><p id="0ad3" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">如果你不熟悉这种类型的测试，你应该知道我们总是想知道我们的软件的能力和我们可以处理的在线用户的数量。负载测试的目标是给我们一个如何处理用户的估计，也许我们预计像<em class="me">黑色星期五这样的特殊事件会有10，000个用户，但是</em>我们不确定我们是否可以用我们现在拥有的资源或结构来处理所有的用户。</p><p id="11c5" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated"><strong class="lc ir">那么补救措施是什么？最好的补救办法是在灾难发生前对你的应用进行负载测试。</strong></p><h1 id="f234" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">k6是什么？</h1><p id="8533" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">k6是一个以开发人员为中心的免费开源负载测试工具，旨在让性能测试成为一种高效且愉快的体验。</p><p id="eda0" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">使用k6，您将能够更早地发现性能退化和问题，允许您构建弹性系统和健壮的应用程序(<a class="ae ly" href="https://k6.io/docs/" rel="noopener ugc nofollow" target="_blank">参考</a>)。</p><h1 id="eb10" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">其他的选择是什么？</h1><p id="9396" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated"><a class="ae ly" href="https://artillery.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lc ir">火炮</strong> </a> <strong class="lc ir"> </strong>是NodeJS应用的常用负载测试工具。还有其他一些强大的负载测试工具，你可以看看<a class="ae ly" href="https://www.softwaretestinghelp.com/performance-testing-tools-load-testing-tools/" rel="noopener ugc nofollow" target="_blank">这篇文章</a>了解更多细节。</p><h1 id="e48f" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">为什么是K6？</h1><ul class=""><li id="76af" class="mf mg iq lc b ld le lh li ll mh lp mi lt mj lx mk ml mm mn bi translated">JavaScript ES2015/ES6中的脚本—支持<a class="ae ly" href="https://k6.io/docs/using-k6/modules" rel="noopener ugc nofollow" target="_blank">本地和远程模块</a></li><li id="0389" class="mf mg iq lc b ld mo lh mp ll mq lp mr lt ms lx mk ml mm mn bi translated"><a class="ae ly" href="https://k6.io/docs/using-k6/checks" rel="noopener ugc nofollow" target="_blank">检查</a>和<a class="ae ly" href="https://k6.io/docs/using-k6/thresholds" rel="noopener ugc nofollow" target="_blank">阈值</a>——用于面向目标、自动化友好的负载测试</li><li id="9eab" class="mf mg iq lc b ld mo lh mp ll mq lp mr lt ms lx mk ml mm mn bi translated">在性能方面，我看了Gitlab的这一期以及他们为什么用K6代替火炮</li></ul></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="3a71" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">现在，我们将创建一个简单的express应用程序，并使用K6进行测试。</p><h1 id="6c9d" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">创建一个简单的快速应用程序</h1><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">一个简单的快递应用程序</figcaption></figure><p id="73cb" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">这是我们可以使用ExpressJS创建的最简单的应用程序。我们在第1行实例化了一个express应用程序，之后，我们实现了以下格式的请求:<em class="me"> localhost:3000/someId </em></p><h1 id="9a3f" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">K6安装</h1><p id="b6d8" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">如果您使用的是mac os，您可以使用<code class="fe ng nh ni nj b">brew install k6</code>简单地安装它</p><p id="0e1b" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">如果您使用的是Ubuntu，您可以使用以下方式安装它:</p><pre class="na nb nc nd gt nk nj nl nm aw nn bi"><span id="6d82" class="no kd iq nj b gy np nq l nr ns">sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 379CE192D401AB61<br/>echo "deb <a class="ae ly" href="https://dl.bintray.com/loadimpact/deb" rel="noopener ugc nofollow" target="_blank">https://dl.bintray.com/loadimpact/deb</a> stable main" | sudo tee -a /etc/apt/sources.list<br/>sudo apt-get update<br/>sudo apt-get install k6</span></pre><p id="cd25" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">另外，<em class="me"> K6 docker容器</em>可用，我们可以在CI管道中使用它。</p><p id="645b" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">如果您正在使用其他操作系统，请查看<a class="ae ly" href="https://k6.io/docs/getting-started/installation" rel="noopener ugc nofollow" target="_blank"> K6安装指南</a>。</p><h1 id="3b83" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">实现负载测试脚本</h1><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="1e9d" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">这是使用K6的简单负载测试的实现:</p><p id="b7a8" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated"><strong class="lc ir">导出一个默认函数</strong>:这是K6每次想要发送请求时要调用的函数。</p><p id="d92e" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated"><strong class="lc ir">发送HTTP请求:</strong>对于发送请求，我们使用来自<code class="fe ng nh ni nj b">k6/http</code>的<code class="fe ng nh ni nj b">http</code>模块。在第6行中，我们向express应用程序中的端点发送了一个HTTP请求。</p><p id="c951" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated"><strong class="lc ir">执行检查:</strong>如果你想确保收到你期望的响应，你可以使用<code class="fe ng nh ni nj b">check</code>模块。第一个参数是响应，第二个参数是对象，对象的键是<strong class="lc ir"><em class="me"/></strong>检查，值是<strong class="lc ir"> <em class="me">检查的实现是应该返回布尔值</em> </strong>的函数。<br/>我们实现的第一项检查是使用<code class="fe ng nh ni nj b">response.status</code>检查响应状态。<br/>在第二次检查中，我们检查了响应体中的<code class="fe ng nh ni nj b">id</code>。通过使用<code class="fe ng nh ni nj b">json</code>方法，我们可以访问响应体。使用<code class="fe ng nh ni nj b">json</code>方法的格式是这样的:<code class="fe ng nh ni nj b">response.json('fieldSelector')</code>。这里我们使用了<code class="fe ng nh ni nj b">id</code>字段，因为它是一个字符串，所以我们将这个字符串转换成一个数字，以便与我们期望的值进行比较。</p><h2 id="a1e0" class="no kd iq bd ke nt nu dn ki nv nw dp km ll nx ny kq lp nz oa ku lt ob oc ky od bi translated">选项:</h2><p id="3c17" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">我们可以在命令行中传递选项，也可以在脚本中导出选项。我们的选项包含<code class="fe ng nh ni nj b">vus</code>，这意味着虚拟用户的<strong class="lc ir">数量</strong>我们可以作为不同的用户发送请求，或者我们可以像这样发送请求，只有一个人发送这些请求。<code class="fe ng nh ni nj b">duration</code>是本次负载测试的持续时间。此外，我们还有另一个名为<code class="fe ng nh ni nj b">thresholds</code>的有用选项，它对于在CI中使用K6非常实用。如果结果不符合阈值，则失败。有关阈值的更多信息，请查看k6文档的这一部分<a class="ae ly" href="https://k6.io/docs/using-k6/thresholds" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="4757" class="no kd iq bd ke nt nu dn ki nv nw dp km ll nx ny kq lp nz oa ku lt ob oc ky od bi translated">运行负载测试</h2><p id="2072" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">为了运行负载测试，我们可以使用以下命令:</p><pre class="na nb nc nd gt nk nj nl nm aw nn bi"><span id="2c83" class="no kd iq nj b gy np nq l nr ns">k6 run load-test.js</span></pre><p id="9141" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">这是我的本地机器上的结果:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/614cce1c6cfade8fba009caf1acf050d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PLV8Y4Jb1ux8D-vw5_W5OA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">K6测试结果</figcaption></figure><p id="9114" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">正如您在结果中看到的，Express应用程序每秒处理了<em class="me"> 22962 </em>个请求和大约<em class="me"> 4574 </em>个请求。</p><h1 id="76a1" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">结论</h1><p id="8155" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">使用K6真的很容易，因为我们可以使用Javascript实现测试，而且K6对开发人员来说是友好的。</p></div></div>    
</body>
</html>