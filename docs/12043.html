<html>
<head>
<title>Circuit breaker pattern simplified. Why do you need one in your microservice?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">简化的断路器模式。为什么您的微服务中需要一个？</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/circuit-breaker-pattern-simplified-why-do-you-need-one-in-your-microservice-7d543052a3f?source=collection_archive---------10-----------------------#2022-05-10">https://levelup.gitconnected.com/circuit-breaker-pattern-simplified-why-do-you-need-one-in-your-microservice-7d543052a3f?source=collection_archive---------10-----------------------#2022-05-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c45e90128556d5cfb62c61c0c9037a87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FjSt9wyKQ6dFcv8OHRUQWw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@esptroy" rel="noopener ugc nofollow" target="_blank">特洛伊桥</a>在<a class="ae kc" href="https://unsplash.com/photos/maXnRLszYY0" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><blockquote class="kd ke kf"><p id="a49b" class="kg kh ki kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">及时缝一针可省九针</p></blockquote><p id="2ad9" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">Covid 19疫情导致许多国家实施封锁，试图控制疾病。只有基本服务向公众开放。我们大多数人不得不呆在家里几周甚至几个月。</p><p id="0d6b" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">它比以往任何时候都更严重地扰乱了正常生活。但是为什么政府要采取如此激烈的措施呢？</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi li"><img src="../Images/619538efd22a92f14a558ad3a9db33d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QrZF1kcLJzgvCCUfSWohlw.png"/></div></div></figure><p id="32e7" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">这一措施对于防止大规模疫情是不可避免的，否则疫情将会是毁灭性的。最终，随着covid病例的减少，封锁被分阶段解除。</p><p id="0ac0" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">整个场景类似于现实生活中的断路器。</p><p id="45d2" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">断路器的概念最初来自电子学。如果你查一下<a class="ae kc" href="https://en.wikipedia.org/wiki/Circuit_breaker" rel="noopener ugc nofollow" target="_blank">维基百科</a>，它被定义为一个自动开关，用于保护电路免受过流或短路造成的损坏。这是一种自动切断故障系统电源的方法。</p><p id="d3ec" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">一旦故障条件得到纠正，开关就会闭合，以恢复中断电路的供电。</p><p id="3d6d" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">那么，这如何适用于我们呢？</p><h2 id="c91f" class="ln lo iq bd lp lq lr dn ls lt lu dp lv lf lw lx ly lg lz ma mb lh mc md me mf bi translated">为什么我们的微服务需要断路器？</h2><p id="fc49" class="pw-post-body-paragraph kg kh iq kj b kk mg km kn ko mh kq kr lf mi ku kv lg mj ky kz lh mk lc ld le ij bi translated">让我们面对现实吧，所有的服务都可能在某个时间点失败或瘫痪。网络可能会变得脆弱，系统可能会资源匮乏，数据库可能会停机，GCs可能会停止工作，或者僵尸可能会攻击数据中心。好吧，可能不是最后一个😁。但是你说到点子上了！</p><p id="f2af" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">我们需要在服务中加入容错功能，以优雅地处理这些情况。</p><p id="248b" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">考虑这个例子。</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi li"><img src="../Images/935f0da81497f94f937548d577041980.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eqCIpNkXLxnmHCxNmXtJUA.png"/></div></div></figure><p id="24b3" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">从API服务器上，我们调用电影推荐服务来向用户推荐电影。假设电影数据库由于某种原因很慢，因此电影推荐服务也很慢。如果我们继续从API服务器发送请求，会发生什么？这会给区议会增加更多压力，并可能使情况进一步恶化。</p><p id="cf3c" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">此外，电影推荐服务的线程将忙于处理高响应请求，这将导致处理其他请求的空闲线程数量减少，最终导致服务中断。</p><p id="e9f3" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">与其不停地发送请求，让电影推荐服务负担过重，我们不如走一条更智能的路线。API服务器可以告诉推荐服务:“嘿，你为什么不休息一下？休息一下，从任何问题中恢复过来。过一段时间我会和你核实的”。</p><p id="5367" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">我们可以给API服务器一个开关，在一段时间内关闭和停止与电影推荐服务的所有通信。</p><p id="cb7b" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">API服务器将如何处理发送给推荐服务的请求？它有两个选择。如果出错的服务是关键服务，那么它会很快失败，并向用户显示错误消息。如果服务是非关键的，那么我们可以绕过它，为用户提供稍微降级的体验。</p><p id="67b5" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">之后，我们可以重试几个请求，以检查故障服务是否仍然不可用或很慢。</p><p id="27bc" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">这里有一个视频，展示了Hotstar如何在出现意外故障时绕过非关键服务，从而实现优雅降级。</p><figure class="lj lk ll lm gt jr"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="34b7" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">如果我们自己实现这个解决方案，它将会干扰代码库，并且会增加大量开销。这就是断路器可以帮助我们的地方。</p><p id="af0a" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">你希望断路器做的是:</p><ol class=""><li id="9316" class="mn mo iq kj b kk kl ko kp lf mp lg mq lh mr le ms mt mu mv bi translated">实时观察服务故障。查找过多的故障、不合理的缓慢响应时间等。</li><li id="89d0" class="mn mo iq kj b kk mw ko mx lf my lg mz lh na le ms mt mu mv bi translated">关闭并中断该流动，以防止系统其余部分过载。</li><li id="d11b" class="mn mo iq kj b kk mw ko mx lf my lg mz lh na le ms mt mu mv bi translated">定期检查故障服务是否已经恢复。</li></ol><h2 id="0baf" class="ln lo iq bd lp lq lr dn ls lt lu dp lv lf lw lx ly lg lz ma mb lh mc md me mf bi translated">用Resiliency4j实现弹簧靴中的断路器</h2><p id="06ce" class="pw-post-body-paragraph kg kh iq kj b kk mg km kn ko mh kq kr lf mi ku kv lg mj ky kz lh mk lc ld le ij bi translated">Hysterix、Resiliency4j和Sentinel是一些最流行的断路器库。Hysterix目前<a class="ae kc" href="https://github.com/Netflix/Hystrix" rel="noopener ugc nofollow" target="_blank">已弃用</a>并处于维护模式。与Sentinel相比，Resilience4j是非常轻量级的，并且有更多的控制粒度。在这个演示中，我们将使用Resilience4j。</p><p id="2fd9" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">我们的演示将使用基于spring-boot的电影仪表盘服务，向用户推荐电影。仪表板服务通过Eureka服务器与电影推荐服务对话。</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi li"><img src="../Images/30cd689af9d4c8a5178d4b30600c7865.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rFkzZoL0pGbMGxk7z0oVNg.png"/></div></div></figure><p id="faac" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">首先，让我们设置为用户返回推荐电影的电影推荐服务。</p><figure class="lj lk ll lm gt jr"><div class="bz fp l di"><div class="nb mm l"/></div></figure><p id="7921" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">我们现在配置电影仪表板服务，它将成为电影推荐服务的前端。</p><figure class="lj lk ll lm gt jr"><div class="bz fp l di"><div class="nb mm l"/></div></figure><p id="5981" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">完整的代码可以在<a class="ae kc" href="https://github.com/daleef-rahman/ciruit-breaker-demo" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="c8bc" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">现在运行服务和尤里卡服务器。我们现在可以访问我们的电影仪表板服务端口上的<code class="fe nc nd ne nf b">/dashboard</code>端点，并查看我们的电影推荐列表。</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/f0c526e4aee14fed72b97c2ec757dc35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bCrgRkBxw1rAqmyy0-56qQ.png"/></div></div></figure><p id="1c5b" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">我们已经准备好服务了。穿上你的工作靴，准备好断路器！</p><p id="a0cf" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">首先，我们需要添加Resilience4j断路器的电抗版本作为依赖项。</p><figure class="lj lk ll lm gt jr"><div class="bz fp l di"><div class="nb mm l"/></div></figure><p id="fd1e" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">一旦我们有了断路器，我们所要做的就是呼叫<code class="fe nc nd ne nf b">run</code>。运行需要一个<code class="fe nc nd ne nf b">Mono</code>或<code class="fe nc nd ne nf b">Flux</code>和一个可选功能。可选的<code class="fe nc nd ne nf b">Function</code>参数在原始请求出现问题时充当我们的后备。在我们的示例中，我们将退回到<code class="fe nc nd ne nf b">getDefaultMovies()</code>。</p><figure class="lj lk ll lm gt jr"><div class="bz fp l di"><div class="nb mm l"/></div></figure><p id="f3ca" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">就是这样。我们的断路器准备好了。</p><p id="168e" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">现在让我们关闭电影推荐服务。我们的源服务没有了，但多亏了Resilience4J，我们可以退回到默认电影，让我们的用户满意。</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/c11f54074ee621fe1709a6e54148d621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*tfg17Tm6NavR9NDsFJbNhw.gif"/></div></div></figure><h2 id="0e81" class="ln lo iq bd lp lq lr dn ls lt lu dp lv lf lw lx ly lg lz ma mb lh mc md me mf bi translated">Resiliency4j配置</h2><p id="7255" class="pw-post-body-paragraph kg kh iq kj b kk mg km kn ko mh kq kr lf mi ku kv lg mj ky kz lh mk lc ld le ij bi translated">Resiliency4j提供了许多粒度配置来改变断路器的默认行为。</p><ul class=""><li id="9d2a" class="mn mo iq kj b kk kl ko kp lf mp lg mq lh mr le ni mt mu mv bi translated">您可以在基于计数的滑动窗口和基于时间的滑动窗口之间选择。例如，我们可以配置一个基于计数的断路器，以便在最近25次呼叫中有70%失败时“打开电路”。类似地，如果过去30秒内80%的呼叫失败，我们可以告诉基于时间的断路器打开电路。</li><li id="7fd6" class="mn mo iq kj b kk mw ko mx lf my lg mz lh na le ni mt mu mv bi translated">您可以为故障率配置一个阈值，高于该阈值时，断路器将转换为打开状态并开始短路呼叫。</li><li id="242f" class="mn mo iq kj b kk mw ko mx lf my lg mz lh na le ni mt mu mv bi translated">您可以配置持续时间阈值，超过该阈值的呼叫将被视为慢速呼叫，并增加慢速呼叫的比率。</li><li id="d372" class="mn mo iq kj b kk mw ko mx lf my lg mz lh na le ni mt mu mv bi translated">您可以定义一个应该算作失败的异常列表。</li></ul><p id="bfcd" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">点击查看配置的完整列表<a class="ae kc" href="https://resilience4j.readme.io/docs/circuitbreaker" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="6326" class="ln lo iq bd lp lq lr dn ls lt lu dp lv lf lw lx ly lg lz ma mb lh mc md me mf bi translated">离别的思绪</h2><p id="f761" class="pw-post-body-paragraph kg kh iq kj b kk mg km kn ko mh kq kr lf mi ku kv lg mj ky kz lh mk lc ld le ij bi translated">我希望这篇文章能够阐明断路器在创建容错系统中的重要性，以及如何实现容错系统。</p><p id="e11f" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">断路器只是为系统建立容错能力的一部分。此外，Resiliency4J还提供了其他一些容错机制，比如bulkheads、ratelimiters、retries和time limits。但这是另一个博客的话题！</p></div></div>    
</body>
</html>