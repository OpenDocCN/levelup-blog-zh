# é€šè¿‡å®ä¾‹äº†è§£é…¸ä¿è¯

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/understanding-acid-guarantees-through-practical-example-3fe806628580>

![](img/0dd58541d28ca9a09b7956faa2fd2e54.png)

# è®®ç¨‹

è¿™ç¯‡æ–‡ç« è¯•å›¾é€šè¿‡ä»£ç å’Œå®é™…ä¾‹å­æ¥ç†è§£æ•°æ®åº“ ACID ä¿è¯æ„å‘³ç€ä»€ä¹ˆã€‚

ACID æ˜¯æ•°æ®åº“æä¾›çš„ä¸€ç»„ä¿è¯ã€‚å¤§å¤šæ•°æ•°æ®åº“ä½¿ç”¨ä¸€ç§å«åš**äº‹åŠ¡**çš„æœºåˆ¶æ¥æä¾›è¿™äº›ä¿è¯ã€‚

å› æ­¤ï¼Œæ•°æ®åº“äº‹åŠ¡æä¾›äº†ä»¥ä¸‹ä¿è¯:
-åŸå­æ€§
-ä¸€è‡´æ€§
-éš”ç¦»æ€§
-æŒä¹…æ€§

# è®¾ç½®

è®©æˆ‘ä»¬è€ƒè™‘æˆ‘ä»¬æ­£åœ¨å»ºç«‹ä¸€ä¸ªé£Ÿå“è®¢è´­å¹³å°ã€‚å› æ­¤ï¼Œå¯èƒ½æ¶‰åŠä¸¤ä¸ªè¡¨ï¼Œå³*å®¢æˆ·*å’Œ*è®¢å•*ã€‚
ä¸€ä¸ªè®¢å•å±äºä¸€ä¸ªå®¢æˆ·ã€‚å› æ­¤ä»*å®¢æˆ·*åˆ°*è®¢å•*æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚

è®©æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªè¡¨ã€‚

```
mysql> create database frodo;mysql> use frodo;mysql> create table customers (id int not null auto_increment, name char(20), address char(20), primary key (id));mysql> create table orders(id int not null auto_increment, total int, primary key (id), customer_id int, foreign key (customer_id) references customers(id));
```

æˆ‘ä»¬å°†åˆ—çš„æ•°é‡ä¿æŒåœ¨å°½å¯èƒ½å°‘çš„æ°´å¹³ï¼Œå¹¶ç‰¹æ„ä¿ç•™äº†åŠŸèƒ½åº”ç”¨ç¨‹åºæ‰€éœ€çš„è®¸å¤šå…¶ä»–åˆ—ã€‚

# åŸå­æ•°

åŸå­æ€§ç¡®ä¿ä¸€ç»„è¯­å¥æˆ–æ“ä½œè¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆæ ¹æœ¬ä¸æäº¤ã€‚

åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼ŒæœŸæœ›çš„è¡Œä¸ºæ˜¯å½“ä»»ä½•äººä¸‹è®¢å•æ—¶ï¼Œå¿…é¡»åœ¨ä¸¤ä¸ªè¡¨ä¸­æ’å…¥ä¸€è¡Œã€‚

ä»ç¬¬ä¸€ä¸ªç»ˆç«¯å¼€å§‹ï¼Œè®©æˆ‘ä»¬ç§°å®ƒä¸ºç»ˆç«¯ Aï¼Œè®©æˆ‘ä»¬å¼€å§‹ä¸€ä¸ª myql è¿æ¥ã€‚

```
$ mysql -u root -pmysql> use frodo;
```

è®©æˆ‘ä»¬éªŒè¯æœ€åˆæ²¡æœ‰å®¢æˆ·æˆ–è®¢å•å‡ºç°ã€‚

```
mysql> select * from customers;
Empty set (0.00 sec)mysql> select * from orders;
Empty set (0.00 sec)
```

è®©æˆ‘ä»¬å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶å‘å‡ºä¸¤ä¸ªå¯¹åº”äºå®¢æˆ·å’Œè®¢å•çš„ insert è¯­å¥ã€‚

```
mysql> begin;mysql> insert into customers(name, address) values(â€˜Jon Snowâ€™, â€˜001, Winterfellâ€™);mysql> select last_insert_id();
+ â€” â€” â€” â€” â€” â€” â€” â€” â€” +
| last_insert_id()  |
+ â€” â€” â€” â€” â€” â€” â€” â€” â€” +
| 1                 |
+ â€” â€” â€” â€” â€” â€” â€” â€” â€” +
1 row in set (0.00 sec)
```

å› æ­¤ï¼Œåˆ›å»ºçš„å®¢æˆ·çš„ id æ˜¯ 1ã€‚è®©æˆ‘ä»¬åœ¨æ’å…¥è®¢å•æ—¶ä½¿ç”¨ç›¸åŒçš„ idã€‚

```
mysql> insert into orders(total, customer_id) values(400, 1);
```

è®©æˆ‘ä»¬æäº¤äº‹åŠ¡ã€‚

```
mysql> commit;
```

è®©æˆ‘ä»¬æŒ‰ Ctrl+D é€€å‡ºè¿æ¥ã€‚

```
mysql> ^DBye
```

è®©æˆ‘ä»¬å†æ¬¡è¿æ¥ MySQLã€‚

```
$ mysql -u root -p
```

è®©æˆ‘ä»¬æ£€æŸ¥æ˜¯å¦åœ¨ customers å’Œ orders è¡¨ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ¡ç›®ã€‚

```
mysql> use frodo;mysql> select * from customers;
+ â€” â€” + â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” -+
| id  | name      | address          |
+ â€” â€” + â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” -+
| 1   | Jon Snow  | 001, Winterfell  |
+ â€” â€” + â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” -+
1 row in set (0.00 sec)mysql> select * from orders;
+ â€” â€” + â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” -+
| id  | total  | customer_id  |
+ â€” â€” + â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” -+
| 1   | 400    | 1            |
+ â€” â€” + â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” -+
1 row in set (0.00 sec)
```

è¿™å°†éªŒè¯æ˜¯å¦æ’å…¥äº†å®¢æˆ·å’Œè®¢å•æ•°æ®ã€‚

è®©æˆ‘ä»¬å¼€å§‹å¦ä¸€ä¸ªäº‹åŠ¡æ¥åˆ›å»ºå¦ä¸€ç»„å®¢æˆ·å’Œè®¢å•ã€‚

```
mysql> begin;mysql> insert into customers(name, address) values(â€˜Ned Starkâ€™, â€˜002, Winterfellâ€™);Query OK, 1 row affected (0.00 sec)mysql> select last_insert_id();
+ â€” â€” â€” â€” â€” â€” â€” â€” â€” +
| last_insert_id()  |
+ â€” â€” â€” â€” â€” â€” â€” â€” â€” +
| 3                 |
+ â€” â€” â€” â€” â€” â€” â€” â€” â€” +
1 row in set (0.01 sec)
```

è®©æˆ‘ä»¬å‡è®¾æ­¤æ—¶æœ‰ä¸€ä¸ªæ•°æ®åº“å´©æºƒã€‚è®©æˆ‘ä»¬é€šè¿‡é€€å‡ºæ•°æ®åº“æ¥æ¨¡æ‹Ÿä¸€ä¸‹ã€‚

```
mysql> ^DBye
```

è®©æˆ‘ä»¬å†æ¬¡è¿æ¥ MySQLã€‚

```
$ mysql -u root -p
```

è®©æˆ‘ä»¬æ£€æŸ¥ customers è¡¨ä¸­çš„æ¡ç›®ã€‚

```
mysql> use frodo;mysql> select * from customers;
+ â€” â€” + â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” -+
| id  | name      | address          |
+ â€” â€” + â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” -+
| 1   | Jon Snow  | 001, Winterfell  |
+ â€” â€” + â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” -+
1 row in set (0.00 sec)
```

å› æ­¤ï¼Œç”±äºæ•°æ®åº“å´©æºƒï¼Œæ²¡æœ‰åˆ›å»ºç›¸åº”çš„è®¢å•ï¼Œå› æ­¤åˆ›å»ºçš„å®¢æˆ·ä¿¡æ¯ä¹Ÿè¢«å›æ»šã€‚

å› æ­¤ï¼ŒåŸå­æ€§ä¿è¯å¾—åˆ°äº†åŠ å¼ºã€‚

# ä¸€è‡´æ€§

ä¸€è‡´æ€§ç¡®ä¿äº†ä¸¤ä»¶äº‹

*   ä¸å¾—è¿åæ•°æ®åº“çº¦æŸ
*   è¿æ¥åˆ°è¯¥æ•°æ®åº“çš„å…¶ä»–å®¢æˆ·æœºå¿…é¡»èƒ½å¤Ÿç«‹å³çœ‹åˆ°æ¯ä¸ªæäº¤çš„äº‹åŠ¡

æ•°æ®åº“çº¦æŸçš„ä¸€ä¸ªä¾‹å­æ˜¯å¤–é”®çº¦æŸã€‚
æ•°æ®åº“å°†ç¡®ä¿å¼•ç”¨è¡¨åªèƒ½æœ‰ä¸€ä¸ªå­˜åœ¨äºè¢«å¼•ç”¨è¡¨ä¸­çš„å¤–é”®ã€‚è¿™ä¸ªçº¦æŸç¡®ä¿äº†æ•°æ®çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚

ç›®å‰ï¼Œæ•°æ®åº“åªåŒ…å«ä¸€ä¸ªå®¢æˆ·ï¼Œè¯¥å®¢æˆ·çš„ä¸»é”®æ˜¯ 1ã€‚

è®©æˆ‘ä»¬å°è¯•æ’å…¥ä¸€ä¸ª *customer_id* ä¸º 2 çš„è®¢å•ã€‚

```
mysql> insert into orders(total, customer_id) values(500, 2);
```

æ‚¨ä¼šæ³¨æ„åˆ°ä»¥ä¸‹è¾“å‡º:

```
ERROR 1452 (23000): Cannot add or update a child row: a foreign key constraint fails (`frodo`.`orders`, CONSTRAINT `orders_ibfk_1` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`))
```

å› æ­¤ï¼Œæ•°æ®åº“æ­£åœ¨å®æ–½å¤–é”®çº¦æŸï¼Œä»è€Œç¡®ä¿æ•°æ®åº“çš„ä¸€è‡´æ€§ã€‚

æ•°æ®åº“çº¦æŸçš„å¦ä¸€ä¸ªä¾‹å­æ˜¯ï¼Œåœ¨åˆ é™¤å¼•ç”¨è¡¨ä¹‹å‰ï¼Œä¸èƒ½åˆ é™¤è¢«å¼•ç”¨è¡¨ã€‚

è®©æˆ‘ä»¬å°è¯•åˆ é™¤ customers è¡¨ã€‚

```
mysql> drop table customers;
```

è¾“å‡ºå¦‚ä¸‹æ‰€ç¤º:

```
ERROR 3730 (HY000): Cannot drop table â€˜customersâ€™ referenced by a foreign key constraint â€˜orders_ibfk_1â€™ on table â€˜ordersâ€™.
```

å› æ­¤ï¼Œä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­æ¼”ç¤ºäº†æ•°æ®åº“å¦‚ä½•æä¾›å’Œå®æ–½ä¸€è‡´æ€§ä¿è¯ã€‚

ä¸€è‡´æ€§è¿˜æ„å‘³ç€ä¸€æ—¦äº‹åŠ¡è¢«æäº¤ï¼Œå®ƒåº”è¯¥ç«‹å³å¯¹è¿æ¥åˆ°æ•°æ®åº“çš„æ¯ä¸ªå…¶ä»–å®¢æˆ·æœºå¯è§ã€‚å› æ­¤ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯éƒ½å¯ä»¥è·å¾—ä¸€è‡´çš„æ•°æ®è§†å›¾ã€‚

è®©æˆ‘ä»¬ä»å¦ä¸€ä¸ªç»ˆç«¯å¼€å§‹å¦ä¸€ä¸ª mysql è¿æ¥ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºç»ˆç«¯ bã€‚

```
$ mysql -u root -p
```

è®©æˆ‘ä»¬åˆ—å‡ºé¡¾å®¢ã€‚

```
mysql> select * from customers;
+ â€” â€” + â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” -+
| id  | name      | address          |
+ â€” â€” + â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” -+
| 1   | Jon Snow  | 001, Winterfell  |
+ â€” â€” + â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” -+
1 row in set (0.00 sec)
```

åˆ‡æ¢å›ç»ˆç«¯ aï¼Œå¹¶ä»ç»ˆç«¯ a æ’å…¥ä¸€ä¸ªå®¢æˆ·ã€‚

```
mysql> insert into customers(name, address) values(â€˜Ned Starkâ€™, â€˜002, Winterfellâ€™);
Query OK, 1 row affected (0.00 sec)mysql> select last_insert_id();
+ â€” â€” â€” â€” â€” â€” â€” â€” â€” +
| last_insert_id()  |
+ â€” â€” â€” â€” â€” â€” â€” â€” â€” +
| 4                 |
+ â€” â€” â€” â€” â€” â€” â€” â€” â€” +
1 row in set (0.00 sec)mysql> insert into orders(total, customer_id) values(500, 4);
Query OK, 1 row affected (0.00 sec)
```

è®©æˆ‘ä»¬åˆ‡æ¢åˆ°ç»ˆç«¯ Bï¼Œå³å¦ä¸€ä¸ªå®¢æˆ·ç«¯/è¿æ¥ã€‚å¹¶åˆ—å‡ºå®¢æˆ·ã€‚

```
mysql> select * from customers;
+ â€” â€” + â€” â€” â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” â€” â€” -+
| id  | name       | address          |
+ â€” â€” + â€” â€” â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” â€” â€” -+
| 1   | Jon Snow   | 001, Winterfell  |
| 4   | Ned Stark  | 002, Winterfell  |
+ â€” â€” + â€” â€” â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” â€” â€” -+
2 rows in set (0.00 sec)
```

å› æ­¤ï¼Œæ— è®ºæ’å…¥æˆ–æ›´æ–°å‘ç”Ÿåœ¨å“ªé‡Œï¼Œæ¯ä¸ª mysql å®¢æˆ·ç«¯éƒ½å¯ä»¥è·å¾—ä¸€è‡´çš„æ•°æ®è§†å›¾ã€‚

# éš”ç¦»

æ¯ä¸ªäº‹åŠ¡å¿…é¡»ä¸å…¶ä»–äº‹åŠ¡éš”ç¦»å¤„ç†ã€‚

éš”ç¦»ç¡®ä¿å®¢æˆ·ç«¯ä¸ä¼šå› ä¸ºå…¶ä»–å¹¶å‘è¿è¡Œçš„äº‹åŠ¡è€Œçœ‹åˆ°ä¸å‡†ç¡®ã€ä¸æ­£ç¡®æˆ–ä¸å®Œæ•´çš„æ•°æ®ã€‚

äº‹åŠ¡ A ä¸ä¼šçœ‹åˆ°æœªæäº¤çš„äº‹åŠ¡ b å½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»ä½•äº‹æƒ…ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºäº‹åŠ¡ A æ˜¯å­¤ç«‹å‘ç”Ÿçš„ï¼Œä¸å—äº‹åŠ¡ b çš„å½±å“ã€‚

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ã€‚

è®©æˆ‘ä»¬åœ¨å®¢æˆ·æœº a ä¸Šå¼€å§‹ä¸€ä¸ªäº‹åŠ¡ã€‚

```
mysql> begin;
Query OK, 0 rows affected (0.00 sec)mysql> insert into customers(name, address) values(â€˜Catelyn Starkâ€™, â€˜002, Winterfellâ€™);
Query OK, 1 row affected (0.01 sec)
```

åˆ‡æ¢åˆ°å®¢æˆ·ç«¯ B å¹¶åˆ—å‡ºå®¢æˆ·ã€‚

```
mysql> select * from customers;
+ â€” â€” + â€” â€” â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” â€” â€” -+
| id  | name       | address          |
+ â€” â€” + â€” â€” â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” â€” â€” -+
| 1   | Jon Snow   | 001, Winterfell  |
| 4   | Ned Stark  | 002, Winterfell  |
+ â€” â€” + â€” â€” â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” â€” â€” -+
2 rows in set (0.00 sec)
```

å› æ­¤ï¼Œå®¢æˆ·ç«¯ B çœ‹ä¸åˆ°å®¢æˆ·ç«¯ a çš„æœªæäº¤äº‹åŠ¡ã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯ B ä¸å®¢æˆ·ç«¯ a éš”ç¦»

å› æ­¤ï¼Œå®¢æˆ·ç«¯ B åªèƒ½åœ¨å…¶ä»–å®¢æˆ·ç«¯æäº¤æ›´æ”¹åæ‰èƒ½çœ‹åˆ°è¿™äº›æ›´æ”¹ã€‚

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ç§è¡Œä¸ºæ˜¯å¯ä»¥æ”¹å˜çš„ã€‚æ•°æ®åº“æä¾›ä¸åŒçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚å¦‚æœæˆ‘ä»¬å°†éš”ç¦»çº§åˆ«è®¾ç½®ä¸º **READ UNCOMMITTED** ï¼Œé‚£ä¹ˆä¸€ä¸ªå®¢æˆ·ç«¯ä¹Ÿä¼šçœ‹åˆ°å…¶ä»–å®¢æˆ·ç«¯çš„æœªæäº¤äº‹åŠ¡ã€‚

# æŒä¹…æ€§

æŒä¹…æ€§ç¡®ä¿æäº¤çš„äº‹åŠ¡è¢«æ°¸ä¹…å†™å…¥ç£ç›˜ï¼Œå³ä½¿æœåŠ¡å™¨å´©æºƒä¹Ÿä»ç„¶å¯ç”¨ã€‚

å½“æœåŠ¡å™¨åœ¨å´©æºƒåé‡æ–°å¯åŠ¨æ—¶ï¼Œç›´åˆ°å´©æºƒç‚¹æäº¤çš„æ‰€æœ‰äº‹åŠ¡éƒ½åœ¨æ•°æ®åº“ä¸­å¯è§ã€‚

å› æ­¤ï¼Œäº‹åŠ¡ç¡®ä¿äº†æŒä¹…æ€§ï¼Œå¹¶ä¸”æ•°æ®æ˜¯æŒä¹…çš„å’Œæ°¸ä¹…çš„ï¼Œå¹¶ä¸”åœ¨å´©æºƒå’Œé‡å¯ä¹‹åä¹Ÿæ˜¯æŒä¹…çš„ã€‚

# å…¶ä»–å‘˜é¢

æˆ‘ä»¬å›´ç»• MySQL å†™äº†ä»¥ä¸‹å¸–å­ï¼Œæ‚¨ä¼šå‘ç°è¿™äº›å¸–å­å†…å®¹ä¸°å¯Œ:

*   MySQL ç£ç›˜ä½¿ç”¨åˆ†æ:[https://medium . com/@ raaj . AK shar/MySQL-disk-usage-analysis-CBF 7597 b 2836](https://medium.com/@raaj.akshar/mysql-disk-usage-analysis-cbf7597b2836)
*   å»ºç«‹å¯¹æ•°æ®åº“æ­»é”çš„ç†è§£:[https://level up . git connected . com/understanding-why-a-database-deadlock-occurs-8 bbd 32 be 8026](/understanding-why-a-database-deadlock-occurs-8bbd32be8026)

å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« ä¿¡æ¯ä¸°å¯Œï¼Œè¯·å‘é€ä¸€äº›æŒå£°æ¥è¡¨è¾¾ä½ çš„çˆ±:)

# åˆ†çº§ç¼–ç 

æ„Ÿè°¢æ‚¨æˆä¸ºæˆ‘ä»¬ç¤¾åŒºçš„ä¸€å‘˜ï¼åœ¨ä½ ç¦»å¼€ä¹‹å‰:

*   ğŸ‘ä¸ºæ•…äº‹é¼“æŒï¼Œè·Ÿç€ä½œè€…èµ°ğŸ‘‰
*   ğŸ“°æŸ¥çœ‹[çº§ç¼–ç å‡ºç‰ˆç‰©](https://levelup.gitconnected.com/?utm_source=pub&utm_medium=post)ä¸­çš„æ›´å¤šå†…å®¹
*   ğŸ””å…³æ³¨æˆ‘ä»¬:[æ¨ç‰¹](https://twitter.com/gitconnected) | [LinkedIn](https://www.linkedin.com/company/gitconnected) | [æ—¶äº‹é€šè®¯](https://newsletter.levelup.dev)

ğŸš€ğŸ‘‰ [**åŠ å…¥å‡çº§äººæ‰é›†ä½“ï¼Œæ‰¾åˆ°ä¸€ä»½æƒŠè‰³çš„å·¥ä½œ**](https://jobs.levelup.dev/talent/welcome?referral=true)