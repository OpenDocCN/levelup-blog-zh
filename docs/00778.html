<html>
<head>
<title>How I Embedded Resources in Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何在Go中嵌入资源</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-i-embedded-resources-in-go-514b72f6ef0a?source=collection_archive---------1-----------------------#2019-07-26">https://levelup.gitconnected.com/how-i-embedded-resources-in-go-514b72f6ef0a?source=collection_archive---------1-----------------------#2019-07-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/599596fc6a32c3dd9098babc13228efd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ig3iBEzTcnXV1ZGnj91_Dw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">地鼠看起来很饿</figcaption></figure><p id="a6ad" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi la translated"><span class="l lb lc ld bm le lf lg lh li di"> D </span>在我在<a class="lj lk ep" href="https://medium.com/u/4571d92b14fa?source=post_page-----514b72f6ef0a--------------------------------" rel="noopener" target="_blank"> WSO2，Inc </a>实习期间，我参与了一个为WSO2 API Manager开发CI/CD管道的项目。工具大部分是在Golang完成的。</p><p id="a2cb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当我们开发工具时，我们希望通过CLI工具进行项目初始化。这确实涉及到大量的代码生成。</p><p id="6c54" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一开始，一切都很好。我们只有很少的文件，我们把它们保存为字节片并访问它们，这完全没问题。</p><figure class="ll lm ln lo gt jr"><div class="bz fp l di"><div class="lp lq l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">结尾一塌糊涂</figcaption></figure><h1 id="adbd" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">backticks的噩梦</h1><p id="2f00" class="pw-post-body-paragraph kc kd iq ke b kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz ij bi translated">项目在扩大，我们想要存储的内容也在增加。管理这些内容非常困难，因为它们基本上都在Go包中，每次都必须手动编辑。</p><p id="31c4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">有一天<em class="mu">我想对我们的自述文件</em>使用Markdown，该文件是在项目的初始化阶段由工具生成的，在此之前我们一直在生成一个简单的文本文件。</p><p id="76e6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> Markdown对代码块使用反勾号</strong>而<strong class="ke ir"> Go对原始字符串使用反勾号</strong>，<em class="mu">我找不到更好的方法来避开它们</em>。这完全是一场灾难！</p><p id="2f56" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们不能单独运送这些文件，因为这是一个小型CLI工具，所以我一直在寻找将资源嵌入Go的方法。</p><h1 id="2c85" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">现有解决方案</h1><p id="f37b" class="pw-post-body-paragraph kc kd iq ke b kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz ij bi translated">是的，对于像<a class="ae mv" href="https://github.com/GeertJohan/go.rice" rel="noopener ugc nofollow" target="_blank"> Go.rice </a>这样的确切问题已经有了解决方案，但是对于我的任务来说，我认为它们太复杂和臃肿了。我只想把我的资源转换成Go文件并访问它们。</p><h1 id="01c7" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">去生成救援</h1><p id="ad53" class="pw-post-body-paragraph kc kd iq ke b kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz ij bi translated">Go太棒了，包括电池。默认情况下，该语言能够生成代码。所以为什么不用呢。如果你不熟悉go generate是什么，读官方的<a class="ae mv" href="https://blog.golang.org/generate" rel="noopener ugc nofollow" target="_blank">博客</a>。Go generate使用一个特殊的神奇字符串来标识需要生成的文件</p><pre class="ll lm ln lo gt mw mx my mz aw na bi"><span id="4d04" class="nb ls iq mx b gy nc nd l ne nf">//go:generate &lt;command&gt; &lt;args&gt;</span></pre><p id="222c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当你执行<code class="fe ng nh ni mx b">go generate filename.go</code>时，编译器将检查神奇的字符串并执行提供的命令。<code class="fe ng nh ni mx b">go generate ./...</code>将在整个项目中运行该命令，查找包含神奇字符串的文件，并执行您提供的命令。</p><blockquote class="nj nk nl"><p id="ae32" class="kc kd mu ke b kf kg kh ki kj kk kl km nm ko kp kq nn ks kt ku no kw kx ky kz ij bi translated"><em class="iq"> Go generate运行给定的命令，该命令相对于包含带有魔术字符串的文件的目录。</em></p><p id="fd3b" class="kc kd mu ke b kf kg kh ki kj kk kl km nm ko kp kq nn ks kt ku no kw kx ky kz ij bi translated">既然我们需要让自己的代码生成通用化，为什么不应该用go本身来进行代码生成呢？</p></blockquote><h1 id="3830" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">设置</h1><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div class="gh gi np"><img src="../Images/157a0fd9e99dc2e45f4b41f3cbf87a5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*IZ3sMqu1fNNZ517hvqjRvA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">我们资源箱的架构</figcaption></figure><p id="7735" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我的主要需求是将文件存储为字节，并在我的Go文件中访问它们。为了满足同样的需求，我创建了一个名为<code class="fe ng nh ni mx b">box</code> <strong class="ke ir">的包。</strong>它充当消费者和数据源之间的代理。我们将所有文件存储在一个名为资源的特殊目录中。它还可以包含目录来组织内容。</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/358ff99262a9b26b0bb6afac65a9c143.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*GMAu7w8DFz9Tvc_u_foi0w.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">包含我们需要的所有文件的资源目录</figcaption></figure><blockquote class="nj nk nl"><p id="a8ad" class="kc kd mu ke b kf kg kh ki kj kk kl km nm ko kp kq nn ks kt ku no kw kx ky kz ij bi translated">这使得编辑内容更容易和更干净，因为它们只是系统中的文件。</p></blockquote><figure class="ll lm ln lo gt jr"><div class="bz fp l di"><div class="lp lq l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">box/defaults .前往救援</figcaption></figure><p id="f0b5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这是一个非常简单的Go文件，它所做的就是将我们的地图包装在一个漂亮的<code class="fe ng nh ni mx b">ResourceBox</code>中，在包级别公开所有方法，这样你就可以在任何地方使用<code class="fe ng nh ni mx b">box.Get('filename')</code>来调用它们——超级酷。</p><p id="05b4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe ng nh ni mx b">resource</code>对象在包中扮演了一个关键的角色，作为单例来保存我们的盒子的所有资源。</p><p id="1b37" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在神奇的是，它与<code class="fe ng nh ni mx b">//go:generate go run gen.go</code>有一个特别的注释。</p><p id="a160" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当您调用<code class="fe ng nh ni mx b">go generate ./…</code>时，该文件将被检测到，并运行另一个go程序。</p><h1 id="a1e1" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">发电机</h1><p id="6aac" class="pw-post-body-paragraph kc kd iq ke b kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz ij bi translated">现在有趣的部分是，我们想读取我们的资源目录并将文件内容存储在一个<code class="fe ng nh ni mx b">ResourceBox</code>中。为此，我们运行另一个名为<code class="fe ng nh ni mx b">gen.go</code>的Go文件，它在同一个<code class="fe ng nh ni mx b">package box</code>中。</p><p id="4c10" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">正如我上面所描述的，<code class="fe ng nh ni mx b">go generate</code>足够聪明，可以运行相对于它找到神奇字符串的目录的给定程序，所以<code class="fe ng nh ni mx b">go run gen.go </code>将在box目录中运行。这意味着我们可以毫无问题地轻松读取资源目录中的所有文件。</p><p id="c6e6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们将创建一个名为<code class="fe ng nh ni mx b">blob.go</code>的文件，在同一个包中包含我们需要的所有内容。</p><p id="538c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">因为<code class="fe ng nh ni mx b">gen.go</code>是一个程序，我们需要告诉Go这不是我们构建的一部分。否则，它会抱怨在同一个目录中声明多个包。</p><p id="de05" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所以只要加上</p><pre class="ll lm ln lo gt mw mx my mz aw na bi"><span id="30ea" class="nb ls iq mx b gy nc nd l ne nf">//+build ignore</span></pre><p id="503a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通知编译器在编译时忽略这一点。所以它不会抱怨。</p><p id="1c52" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在我们需要遍历资源目录中的所有文件，并将它们转换成go文件。</p><figure class="ll lm ln lo gt jr"><div class="bz fp l di"><div class="lp lq l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">gen.go的一部分，遍历文件树，读取每个文件并存储它们</figcaption></figure><p id="455d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Go提供了一个很好的方法来使用<code class="fe ng nh ni mx b">filepath.Walk</code>方法处理这个问题。我们只是迭代resources目录中的所有文件(包括所有的<strong class="ke ir">子目录以及</strong>)并将它们存储在一个名为<code class="fe ng nh ni mx b">resources</code>的映射中。我们将使用资源目录的相对路径来访问文件。</p><p id="c1c8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">例如，要访问<em class="mu">resources/init/sample . YAML</em>中的文件，我们可以非常直观地使用<code class="fe ng nh ni mx b">box.Get('/init/sample.yaml')</code>。但是如果我们在Windows机器上运行这一代呢？</p><p id="1c9b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了克服这个问题，我们将在<code class="fe ng nh ni mx b">filepath</code>包中使用一个名为<code class="fe ng nh ni mx b">ToSlash</code>的特性，它将把平台原生路径分隔符转换成斜杠。</p><pre class="ll lm ln lo gt mw mx my mz aw na bi"><span id="e683" class="nb ls iq mx b gy nc nd l ne nf">filepath.ToSlash(strings.TrimPrefix(path, "resources"))</span></pre><p id="da24" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">接下来，我们需要用我们拥有的所有数据创建<code class="fe ng nh ni mx b">blob.go</code>。我们只需要将所有数据添加到box包中的resources对象。</p><p id="be4b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们只需要打电话给<code class="fe ng nh ni mx b">resources.Add('/file/path', data)</code>。我们所能做的是把它放在<code class="fe ng nh ni mx b">blob.go</code>上的<code class="fe ng nh ni mx b">init()</code>方法中，它将立刻为整个包初始化。</p><pre class="ll lm ln lo gt mw mx my mz aw na bi"><span id="941e" class="nb ls iq mx b gy nc nd l ne nf">package box<br/><br/>func init() {<br/>   resources.Add("/init/README.md", []byte{50, 70, 80, })<br/>   resources.Add("/init/api_params.tmpl", []byte{100, 110, 125,})<br/>   ...<br/>}</span></pre><p id="a13a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要做到这一点，我们只需使用如下Go模板</p><figure class="ll lm ln lo gt jr"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="810d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">它只是迭代并创建包含文件名和数据的实际文件，稍后我们将把它写到磁盘，允许在代码中访问。</p><p id="08da" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以看到有一个函数映射传递给了模板引擎。我用它将切片的字节表示创建为一个字符串，并在模板中使用它。这是一个非常简单的函数，如下所示。它获取一部分字节，并返回一个逗号分隔的值字符串，其中包含所有字节的数字。</p><figure class="ll lm ln lo gt jr"><div class="bz fp l di"><div class="lp lq l"/></div></figure><blockquote class="nj nk nl"><p id="6cb9" class="kc kd mu ke b kf kg kh ki kj kk kl km nm ko kp kq nn ks kt ku no kw kx ky kz ij bi translated">如果你有任何back-tick现在他们都已经被转换成一些数字，所以不用担心</p></blockquote><p id="ab3d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，我们将文件写入磁盘，准备就绪</p><h1 id="40bd" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">但是等等，我的棉绒不行了</h1><p id="3035" class="pw-post-body-paragraph kc kd iq ke b kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz ij bi translated">这是因为代码格式不正确，生成后可以自己做。</p><p id="8ce5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">不，我们不会这样做，go本身提供了格式化任何Go代码的格式化程序，我们可以在将文件保存到磁盘之前调用它</p><pre class="ll lm ln lo gt mw mx my mz aw na bi"><span id="1cac" class="nb ls iq mx b gy nc nd l ne nf">data, err := format.Source(builder.Bytes())<br/>if err != nil {<br/>	log.Fatal("Error formatting generated code", err)<br/>}</span></pre><p id="5197" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">就这么简单。</p><figure class="ll lm ln lo gt jr"><div class="bz fp l di"><div class="lp lq l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">gen.go与goodies的来源</figcaption></figure><h1 id="0c6d" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">运行它</h1><p id="a576" class="pw-post-body-paragraph kc kd iq ke b kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz ij bi translated">现在只需在您的应用程序中运行<code class="fe ng nh ni mx b">go generate ./…</code>，您就可以找到一个名为<code class="fe ng nh ni mx b">box/blob.go</code>的文件，它将包含您的<code class="fe ng nh ni mx b">box/resources</code>目录中资源的所有数据。</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/07761d7f1dd44c909448daaa5ee516c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OnvadzVX6pOyReAVwnVLcQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">生成的blob文件</figcaption></figure><p id="4227" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在你要做的就是调用</p><pre class="ll lm ln lo gt mw mx my mz aw na bi"><span id="12a6" class="nb ls iq mx b gy nc nd l ne nf">box.Get('/sample/sample_config.yaml')</span></pre><p id="8e40" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从你的文件中获取数据。现在，它已经嵌入到您的Go二进制文件中。</p><h1 id="0e15" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">包裹</h1><p id="2283" class="pw-post-body-paragraph kc kd iq ke b kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz ij bi translated">有许多现有的解决方案可以解决嵌入高级功能的问题。但是我想实现一个简单的解决方案来解决我们的问题。</p><p id="240f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Go是一种强大的语言，它有很多特性是每个程序员都想要的。它在标准库中有模板、代码生成和更多功能。</p><p id="6ec7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这个解决方案将内容从代码中分离出来，使它们更直观、更易于管理。</p><p id="1058" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">例如，如果内容作者想要纠正您的自述文件中的一些问题，他们可以简单地编辑该文件并构建程序，而无需考虑实现。这对双方都是双赢。</p><p id="41b5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">整个项目的代码:</p><div class="ns nt gp gr nu nv"><a href="https://github.com/wso2/product-apim-tooling" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">wso2/产品-apim-工具</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div></div></a></div></div><div class="ab cl oe of hu og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="ij ik il im in"><div class="ll lm ln lo gt nv"><a href="https://gitconnected.com/learn/golang" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">学习围棋-最佳围棋教程(2019) | gitconnected</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">Go是一种静态类型的命令式编译语言。然而，与许多编译编程语言不同，Go是…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">gitconnected.com</p></div></div><div class="ol l"><div class="om l on oo op ol oq jw nv"/></div></div></a></div></div></div>    
</body>
</html>