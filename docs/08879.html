<html>
<head>
<title>How to Make Video Calls with SwiftUI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用SwiftUI进行视频通话</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-make-video-calls-with-swiftui-8e93ce71fbb1?source=collection_archive---------5-----------------------#2021-06-14">https://levelup.gitconnected.com/how-to-make-video-calls-with-swiftui-8e93ce71fbb1?source=collection_archive---------5-----------------------#2021-06-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e6204c80ee8f5377cb1fd8db6fb33f27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BOSskbM8Jk7BrDhygkV3GQ.png"/></div></div></figure><p id="d16d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本教程中，您将使用iOS版Vonage <a class="ae kw" href="https://tokbox.com/developer/sdks/ios/" rel="noopener ugc nofollow" target="_blank">视频客户端SDK </a>在SwiftUI中构建一对一的视频聊天。</p><h1 id="7c6a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">先决条件</h1><ul class=""><li id="3509" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated">一个<a class="ae kw" href="https://tokbox.com/account/user/signup" rel="noopener ugc nofollow" target="_blank"> Vonage视频API账号</a>。</li><li id="7936" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">Xcode 12和Swift 5或更高版本。</li></ul><h1 id="218f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建一个Vonage视频API项目</h1><p id="d47c" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">打开您的<a class="ae kw" href="https://tokbox.com/account/#/" rel="noopener ugc nofollow" target="_blank"> Vonage视频API仪表板</a>并创建一个新的API项目。你可以把它叫做任何你想叫的名字，但是把编解码器保持为VP8。在项目工具部分下，创建一个路由的<a class="ae kw" href="https://tokbox.com/developer/guides/create-session/" rel="noopener ugc nofollow" target="_blank">会话</a> ID。您可以将会话想象成参与者会面和聊天的房间。就在下面，使用会话ID创建一个<a class="ae kw" href="https://tokbox.com/developer/guides/create-token/" rel="noopener ugc nofollow" target="_blank">令牌</a>；您可以将其余字段保留为默认值。令牌是一种用于验证用户身份的方法。记下您的会话ID、令牌和项目API密钥，以备将来使用。</p><h1 id="1734" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建iOS应用程序</h1><p id="0970" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">下一步是安装iOS应用程序。一旦您创建了应用程序，您需要安装视频客户端SDK并请求麦克风和摄像机权限。</p><h2 id="e079" class="mo ky iq bd kz mp mq dn ld mr ms dp lh kj mt mu ll kn mv mw lp kr mx my lt mz bi translated">创建Xcode项目</h2><p id="3bb9" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">若要开始，请打开Xcode，然后通过前往“文件”&gt;“新建”&gt;“项目”来创建一个新项目。选择iOS作为模板的平台和应用程序，并为其命名。</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/c7e0328fe237b65ec7934435ef5b723a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yctBIiThfB69Zp-oYtUHww.png"/></div></div></figure><p id="9e59" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为界面选择SwiftUI，为生命周期选择SwiftUI App，为语言选择Swift。最后，保存项目的位置。</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/e71adf122126bd849a330212830e672e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ivKJRfg9-1bWN5TmfUGHQQ.png"/></div></div></figure><h2 id="f33f" class="mo ky iq bd kz mp mq dn ld mr ms dp lh kj mt mu ll kn mv mw lp kr mx my lt mz bi translated">安装客户端SDK</h2><p id="72fe" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">现在您已经创建了项目，您可以添加视频客户端SDK作为依赖项。关闭Xcode项目，导航到您在终端中保存项目的位置，然后运行以下命令:</p><ol class=""><li id="0eed" class="lv lw iq ka b kb kc kf kg kj nf kn ng kr nh kv ni md me mf bi translated">运行pod init命令为您的项目创建一个新的Podfile。</li><li id="664a" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv ni md me mf bi translated">使用open -a Xcode Podfile在Xcode中打开Podfile。</li><li id="05d9" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv ni md me mf bi translated">更新Podfile，将<code class="fe nj nk nl nm b">OpenTok</code>作为依赖项。</li></ol><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><ol class=""><li id="4475" class="lv lw iq ka b kb kc kf kg kj nf kn ng kr nh kv ni md me mf bi translated">使用<code class="fe nj nk nl nm b">pod install</code>安装SDK。</li><li id="7e0f" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv ni md me mf bi translated">使用<code class="fe nj nk nl nm b">open VideoChat.xcworkspace</code>在Xcode中打开新的<em class="np"> xcworkspace </em>文件。</li></ol><h2 id="aa8a" class="mo ky iq bd kz mp mq dn ld mr ms dp lh kj mt mu ll kn mv mw lp kr mx my lt mz bi translated">许可</h2><p id="5815" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">由于应用程序将使用麦克风和摄像头进行视频聊天，您需要添加说明，说明您需要权限的原因，这将在运行应用程序时显示在提示中。</p><p id="3f78" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编辑<code class="fe nj nk nl nm b">Info.plist</code>文件。<code class="fe nj nk nl nm b">Info.plist</code>是一个包含应用程序所需的所有元数据的文件。将鼠标悬停在列表中的最后一个条目上，然后单击出现的小<code class="fe nj nk nl nm b">+</code>按钮，向文件中添加一个新条目。从下拉列表中，选择<code class="fe nj nk nl nm b">Privacy - Microphone Usage Description</code>并添加<code class="fe nj nk nl nm b">Microphone access required to video chat</code>作为其值。重复<code class="fe nj nk nl nm b">Privacy - Camera Usage Description</code>的步骤。</p><h1 id="9667" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">视频客户端SDK</h1><p id="6266" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">视频客户端SDK使用您在视频API仪表板中创建的凭据连接到Vonage服务器。</p><h2 id="e88f" class="mo ky iq bd kz mp mq dn ld mr ms dp lh kj mt mu ll kn mv mw lp kr mx my lt mz bi translated">连接客户端SDK</h2><p id="771b" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">转到<em class="np">文件&gt;新文件(CMD + N) </em>创建一个名为<code class="fe nj nk nl nm b">OpenTokManager.swift</code>的新文件，并添加以下内容，用您的凭证替换空字符串:</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="0bda" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除了凭证之外，还有用于<a class="ae kw" href="https://tokbox.com/developer/guides/basics/#session" rel="noopener ugc nofollow" target="_blank">会话</a>、<a class="ae kw" href="https://tokbox.com/developer/guides/basics/#publish" rel="noopener ugc nofollow" target="_blank">发布者</a>和<a class="ae kw" href="https://tokbox.com/developer/guides/basics/#subscribe" rel="noopener ugc nofollow" target="_blank">订阅者</a>的变量。如前所述，您可以将会话视为客户端连接到的房间；SDK为此提供了<code class="fe nj nk nl nm b">OTSession</code>类。发布者<code class="fe nj nk nl nm b">OTPublisher</code>允许客户端在连接到会话时发布音频和视频。订户<code class="fe nj nk nl nm b">OTSubscriber</code>允许客户端从会话中的其他客户端订阅音频和视频。还有使用<code class="fe nj nk nl nm b">@Published</code>属性包装器的变量，这是<code class="fe nj nk nl nm b">OpenTokManager</code>类稍后与视图代码通信的方式。</p><p id="d35f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在属性已经就绪，向<code class="fe nj nk nl nm b">OpenTokManager</code>类添加以下函数:</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="4219" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nj nk nl nm b">doConnect</code>函数将客户端连接到会话，<code class="fe nj nk nl nm b">doPublish</code>开始发布，<code class="fe nj nk nl nm b">doSubscribe</code>开始订阅。然后，当客户端与订阅者(<code class="fe nj nk nl nm b">cleanupSubscriber</code>)和发布者(<code class="fe nj nk nl nm b">cleanupPublisher</code>)断开连接时，会有一些函数来清理订阅者和发布者，然后是一个处理错误的函数(<code class="fe nj nk nl nm b">processError</code>)。</p><h2 id="f99c" class="mo ky iq bd kz mp mq dn ld mr ms dp lh kj mt mu ll kn mv mw lp kr mx my lt mz bi translated"><code class="fe nj nk nl nm b">OTSessionDelegate</code></h2><p id="e1f6" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated"><code class="fe nj nk nl nm b">OTSessionDelegate</code>是视频客户端SDK通过会话向您反馈更改的方式。在同一文件中添加扩展名:</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="f414" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当会话连接时，<code class="fe nj nk nl nm b">doPublish</code>被调用，当流被创建时，<code class="fe nj nk nl nm b">doSubscribe</code>被调用，当流被销毁时，<code class="fe nj nk nl nm b">cleanupSubscriber</code>被调用。</p><h2 id="5a64" class="mo ky iq bd kz mp mq dn ld mr ms dp lh kj mt mu ll kn mv mw lp kr mx my lt mz bi translated"><code class="fe nj nk nl nm b">OTPublisherDelegate</code></h2><p id="c38a" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated"><code class="fe nj nk nl nm b">OTPublisherDelegate</code>是视频客户端SDK将发布到会话的更改传达给您的方式。在同一文件中添加扩展名:</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="28f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">与<code class="fe nj nk nl nm b">OTSessionDelegate</code>类似，当流被销毁时，调用<code class="fe nj nk nl nm b">cleanupPublisher</code>，如果存在对流的活动订阅，则调用<code class="fe nj nk nl nm b">cleanupSubscriber</code>。</p><h2 id="060d" class="mo ky iq bd kz mp mq dn ld mr ms dp lh kj mt mu ll kn mv mw lp kr mx my lt mz bi translated"><code class="fe nj nk nl nm b">OTSubscriberDelegate</code></h2><p id="138c" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated"><code class="fe nj nk nl nm b">OTSubscriberDelegate</code>是视频客户端SDK通过订阅会话向您反馈更改的方式。在同一文件中添加扩展名:</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="4362" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">类似于何时发布到会话，如果订阅成功，您将返回一个<code class="fe nj nk nl nm b">UIView</code>对象。在<code class="fe nj nk nl nm b">subscriberDidConnect</code>的情况下，返回的视图对象是针对订户的。</p><h1 id="49dd" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">构建视频聊天用户界面</h1><p id="0ec6" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">随着<code class="fe nj nk nl nm b">OpenTokManager</code>类的完成，您现在可以构建UI了。视频客户端SDK为您提供了不能在SwiftUI中直接使用的发布者和订阅者视图的<code class="fe nj nk nl nm b">UIView</code>对象。<code class="fe nj nk nl nm b"><a class="ae kw" href="https://developer.apple.com/documentation/swiftui/uiviewrepresentable" rel="noopener ugc nofollow" target="_blank">UIViewRepresentable</a></code>协议允许SwiftUI从<code class="fe nj nk nl nm b">UIView</code>对象桥接到<code class="fe nj nk nl nm b">View</code>对象。在<code class="fe nj nk nl nm b">ContentView.swift</code>文件中，添加以下结构:</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="4274" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">符合<code class="fe nj nk nl nm b">UIViewRepresentable</code>的<code class="fe nj nk nl nm b">OTView</code>结构有一个<code class="fe nj nk nl nm b">UIView</code>对象作为属性。当系统调用<code class="fe nj nk nl nm b">makeUIView</code>时，返回该视图。因为SwiftUI中视图的生命周期是由系统控制的，所以您还需要实现<code class="fe nj nk nl nm b">updateUIView</code>来处理这个问题。<code class="fe nj nk nl nm b">OTErrorWrapper</code>结构允许错误符合<code class="fe nj nk nl nm b">Identifiable</code>，这是使用SwiftUI警报所需要的。</p><p id="46dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，用以下内容替换<code class="fe nj nk nl nm b">ContentView</code>结构:</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="b4bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这段代码为前面的<code class="fe nj nk nl nm b">OpenTokManager</code>类的一个实例添加了一个属性。因为<code class="fe nj nk nl nm b">OpenTokManager</code>发布的视图是可选的，所以使用了<code class="fe nj nk nl nm b">.flatmap</code>。所以当视图为零时，它们被忽略，当有值时，它们被展开。如果<code class="fe nj nk nl nm b">OpenTokManager</code>发布一个错误，警报将自动显示，因为它正在观察发布的<code class="fe nj nk nl nm b">.error</code>值的变化。</p><p id="266d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您构建并运行了项目，您现在应该能够开始视频聊天了！您可以使用另一个设备或<a class="ae kw" href="https://tokbox.com/developer/tools/playground/" rel="noopener ugc nofollow" target="_blank"> OpenTok Playground </a>从笔记本电脑连接到会话。</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/e1d91c9a785f5100d56a938f1fb4b7e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*fOFPA_38V55c5jzBhBXAxg.png"/></div></figure><p id="c999" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成的项目可以在<a class="ae kw" href="https://github.com/opentok/opentok-swiftui-basic-video-chat" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得，你可以通过我们的<a class="ae kw" href="https://tokbox.com/developer/guides/" rel="noopener ugc nofollow" target="_blank">文档</a>阅读更多关于Vonage视频API的内容。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="496e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="np">最初发布于</em><a class="ae kw" href="https://learn.vonage.com/blog/2021/05/26/how-to-make-video-calls-with-swiftui/" rel="noopener ugc nofollow" target="_blank"><em class="np">https://learn . vonage . com/blog/2021/05/26/how-to-make-video-calls-with-swift ui/</em></a></p></div></div>    
</body>
</html>