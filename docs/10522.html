<html>
<head>
<title>Trigger notification based on anomalies detected in AWS EKS Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于在AWS EKS集群中检测到的异常触发通知</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/trigger-notification-based-on-anomalies-detected-in-aws-eks-cluster-62d8979c4b98?source=collection_archive---------2-----------------------#2021-12-18">https://levelup.gitconnected.com/trigger-notification-based-on-anomalies-detected-in-aws-eks-cluster-62d8979c4b98?source=collection_archive---------2-----------------------#2021-12-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="0e7b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ko translated"><span class="l kp kq kr bm ks kt ku kv kw di">在</span>这篇博客中，我们将了解如何设置和使用<strong class="js iu">AWS cloud watch Container Insights</strong>来运行代理，作为<strong class="js iu"> Kubernetes </strong>集群或<strong class="js iu"> AWS EKS(弹性Kubernetes服务)</strong>中的守护进程，以检测异常并触发对<strong class="js iu"> AWS SNS(简单通知服务)主题</strong>的警报，从而向您的支持团队发送电子邮件通知，以便采取必要的措施。</p><p id="822c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Container Insights设置需要两个pods <strong class="js iu"> cloudwatch-agent </strong>和<strong class="js iu"> fluent-bit </strong>作为守护程序在集群中名为<strong class="js iu"> amazon-cloudwatch </strong>的名称空间中运行，以收集与集群、节点、服务、pods等相关的所有必要指标，并作为日志组提交给cloudwatch日志。</p><h1 id="ae45" class="kx ky it bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">建筑:-</h1><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi lv"><img src="../Images/cc836a85d85e4aad1949980786613ee0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OfybzkAGrvEtxio3zYlgiw.jpeg"/></div></div></figure><h2 id="0196" class="mh ky it bd kz mi mj dn ld mk ml dp lh kb mm mn ll kf mo mp lp kj mq mr lt ms bi translated">步骤1:创建EKS集群</h2><p id="c259" class="pw-post-body-paragraph jq jr it js b jt mt jv jw jx mu jz ka kb mv kd ke kf mw kh ki kj mx kl km kn im bi translated">使用下面的集群配置创建一个名为<strong class="js iu">001-create-cluster . YAML</strong>的YAML文件</p><pre class="lw lx ly lz gt my mz na nb aw nc bi"><span id="682d" class="mh ky it mz b gy nd ne l nf ng">apiVersion: eksctl.io/v1alpha5<br/>kind: ClusterConfig<br/>metadata:<br/>  name: my-karpenter<br/>  region: us-west-2<br/>  version: '1.21'<br/>managedNodeGroups:<br/>  - instanceType: t3.medium<br/>    amiFamily: AmazonLinux2<br/>    name: my-karpenter-ng<br/>    desiredCapacity: 1<br/>    minSize: 1<br/>    maxSize: 10<br/>iam:<br/>  withOIDC: true</span></pre><p id="6572" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">运行命令创建群集。</p><pre class="lw lx ly lz gt my mz na nb aw nc bi"><span id="25b3" class="mh ky it mz b gy nd ne l nf ng">eksctl create cluster -f 001-create-cluster.yaml</span></pre><p id="3cfc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">输出:</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nh"><img src="../Images/3cb0a4aa8ec983bd56147dee49bca762.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U2sY_PYGvhqz74XMZNwpnw.png"/></div></div></figure><h2 id="c1e2" class="mh ky it bd kz mi mj dn ld mk ml dp lh kb mm mn ll kf mo mp lp kj mq mr lt ms bi translated">步骤2:通过在本地终端上执行以下命令，在EKS集群中设置Container Insights</h2><pre class="lw lx ly lz gt my mz na nb aw nc bi"><span id="b73e" class="mh ky it mz b gy nd ne l nf ng">ClusterName=my-karpenter<br/>RegionName=us-west-2<br/>FluentBitHttpPort='2020'<br/>FluentBitReadFromHead='Off'</span><span id="e1d5" class="mh ky it mz b gy ni ne l nf ng">[[ ${FluentBitReadFromHead} = 'On' ]] &amp;&amp; FluentBitReadFromTail='Off'|| FluentBitReadFromTail='On'<br/>[[ -z ${FluentBitHttpPort} ]] &amp;&amp; FluentBitHttpServer='Off' || FluentBitHttpServer='On'</span><span id="a145" class="mh ky it mz b gy ni ne l nf ng">curl https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/quickstart/cwagent-fluent-bit-quickstart.yaml | sed 's/{{cluster_name}}/'${ClusterName}'/;s/{{region_name}}/'${RegionName}'/;s/{{http_server_toggle}}/"'${FluentBitHttpServer}'"/;s/{{http_server_port}}/"'${FluentBitHttpPort}'"/;s/{{read_from_head}}/"'${FluentBitReadFromHead}'"/;s/{{read_from_tail}}/"'${FluentBitReadFromTail}'"/' | kubectl apply -f -</span></pre><p id="375a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，您需要根据您的需求适当地传递ClusterName和RegionName。在我的例子中，集群名和区域分别是'<strong class="js iu"> my-karpenter </strong>和'<strong class="js iu"> us-west-2 </strong>。</p><p id="9581" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">输出:</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nj"><img src="../Images/2559c749319fcada4edeb4a1aa382ad7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jtHHGYlKyvS0-0FC5VcWjg.png"/></div></div></figure><p id="31db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您尝试在名为<strong class="js iu"> amazon-cloudwatch </strong>的名称空间中获取守护进程集，那么您会看到新的pods作为cloudwatch代理和fluent-bit在那里运行</p><pre class="lw lx ly lz gt my mz na nb aw nc bi"><span id="b0fb" class="mh ky it mz b gy nd ne l nf ng">kubectl get ds -n amazon-cloudwatch</span><span id="7afe" class="mh ky it mz b gy ni ne l nf ng">NAME               DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE<br/>cloudwatch-agent   1         1         1       1            1           &lt;none&gt;          6m22s<br/>fluent-bit         1         1         1       1            1           &lt;none&gt;          6m13s<br/></span><span id="f724" class="mh ky it mz b gy ni ne l nf ng">kubectl get po -n amazon-cloudwatch</span><span id="b4c3" class="mh ky it mz b gy ni ne l nf ng">NAME                     READY   STATUS    RESTARTS   AGE<br/>cloudwatch-agent-sgf9b   1/1     Running   0          4m5s<br/>fluent-bit-bpmds         1/1     Running   0          3m56s</span></pre><p id="4679" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">检查名为'<strong class="js iu"> amazon-cloudwatch </strong>'的名称空间中的fluent-bit pod的日志，查看是否有错误(<strong class="js iu"> AccessDeniedException </strong>)</p><pre class="lw lx ly lz gt my mz na nb aw nc bi"><span id="aaf3" class="mh ky it mz b gy nd ne l nf ng">kubectl logs fluent-bit-bpmds -n amazon-cloudwatch -f</span><span id="35cf" class="mh ky it mz b gy ni ne l nf ng">[2021/12/18 02:42:15] [ info] [output:cloudwatch_logs:cloudwatch_logs.0] Sent 17 events to CloudWatch<br/>[2021/12/18 02:42:15] [ info] [engine] flush chunk '1-1639795323.399393566.flb' succeeded at retry 1: task_id=1, input=tail.1 &gt; output=cloudwatch_logs.0<br/>[2021/12/18 02:42:18] [ info] [output:cloudwatch_logs:cloudwatch_logs.0] Sent 10 events to CloudWatch<br/>[2021/12/18 02:42:18] [ info] [output:cloudwatch_logs:cloudwatch_logs.1] Creating log group /aws/containerinsights/my-karpenter/dataplane<br/>[2021/12/18 02:42:18] [ info] [output:cloudwatch_logs:cloudwatch_logs.1] Created log group /aws/containerinsights/my-karpenter/dataplane<br/>[2021/12/18 02:42:18] [ info] [output:cloudwatch_logs:cloudwatch_logs.1] Creating log stream ip-192-168-61-230.us-west-2.compute.internal-dataplane.systemd.kubelet.service in log group /aws/containerinsights/my-karpenter/dataplane<br/>[2021/12/18 02:42:18] [ info] [output:cloudwatch_logs:cloudwatch_logs.1] Created log stream ip-192-168-61-230.us-west-2.compute.internal-dataplane.systemd.kubelet.service<br/>[2021/12/18 02:42:18] [ info] [output:cloudwatch_logs:cloudwatch_logs.1] Sent 1 events to CloudWatch</span></pre><p id="7d71" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(注意:如果您得到了AccessDeniedException，那么您需要确保与节点相关联的IntanceRole附加了策略(<strong class="js iu"> CloudWatchFullAccess </strong>)。在我的例子中，NodeInstance角色名是<a class="ae nk" href="https://us-west-2.console.aws.amazon.com/iam/home?region=us-east-1#roles/eksctl-my-karpenter-nodegroup-my-NodeInstanceRole-1282VU8Z0TG2S" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">eks CTL-my-kar penter-nodegroup-my-NodeInstanceRole-1282 vu8z 0 TG 2s</strong></a>，但它会因人而异。您可以通过访问AWS控制台上的EC2实例并参考附加到它的IAM角色来找到正确的角色名，如下所示:-</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nl"><img src="../Images/1a95aa6cd7616fb405940f346c7210bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qtzdclP5jiMoiNuvH5ETRQ.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">AWS EC2-IAM角色</figcaption></figure><p id="282c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">单击角色并将策略<strong class="js iu"> CloudWatchFullAccess </strong>添加到IAM角色部分下。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nq"><img src="../Images/2d881cd0c0492b367e34aa778c418817.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L5kcS1R6pYBL2XFVYSOBQw.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">AWS IAM角色</figcaption></figure><p id="2c54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，前往AWS控制台-&gt; CloudWatch -&gt; Logs Groups，您将看到在那里创建了新的日志组</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nr"><img src="../Images/d1c766f2ea02e3b850f654289132d864.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wjt5sDzKcRb2PCClp_ImeA.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">AWS云观察—日志组</figcaption></figure><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi ns"><img src="../Images/31f4d22f197078d5a6a774cfa4118c7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j2zbvCEDgOUdNkkm0VK8gA.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">AWS CloudWatch —容器洞察</figcaption></figure><p id="3b4f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">日志可能需要几分钟才能到达这里。</p><h2 id="6085" class="mh ky it bd kz mi mj dn ld mk ml dp lh kb mm mn ll kf mo mp lp kj mq mr lt ms bi translated">步骤3:设置CloudWatch警报以检测异常情况:-</h2><p id="148c" class="pw-post-body-paragraph jq jr it js b jt mt jv jw jx mu jz ka kb mv kd ke kf mw kh ki kj mx kl km kn im bi translated">有多种指标可用于设置CloudWatch警报，如<strong class="js iu">cluster _ failed _ node _ count</strong>、<strong class="js iu"> pod_cpu_utilization </strong>、<strong class="js iu">pod _ number _ of _ container _ restarts</strong>等。完整的列表可以在AWS文档<a class="ae nk" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-metrics-EKS.html" rel="noopener ugc nofollow" target="_blank">页面</a>找到。在这篇博客中，我将演示如何使用名为<strong class="js iu">pod _ number _ of _ container _ restarts</strong>的指标，通过计算容器重启的总数来检测pod是否有任何问题，然后向<strong class="js iu"> AWS SNS(简单通知服务)主题</strong>发送电子邮件通知。</p><p id="717d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个新的CloudWatch警报，其指标名称为<strong class="js iu">pod _ number _ of _ container _ restarts、</strong>您适当的Pod名称(如果适用于您，在我的情况下是<strong class="js iu"> my-nginx </strong>)、您适当的EKS集群名称等，静态阈值为<strong class="js iu"> 2 </strong>，这意味着如果总的容器重启次数超过此值，它将被通知SNS Topic，后者最终会发送一封电子邮件。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nt"><img src="../Images/d0479e6716a3b62db513074b62adfa1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WSeU89YbCs6yqRgJZuDbCw.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">AWS CloudWatch警报</figcaption></figure><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nu"><img src="../Images/75a08308e59dc88b4520a334b3d5ea68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j8ewIpfpjl8qUdkgWo0RNQ.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">AWS CloudWatch警报</figcaption></figure><p id="cc5b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">瞧啊。！！现在都做完了。</p><h2 id="6c83" class="mh ky it bd kz mi mj dn ld mk ml dp lh kb mm mn ll kf mo mp lp kj mq mr lt ms bi translated">测试:</h2><p id="ad34" class="pw-post-body-paragraph jq jr it js b jt mt jv jw jx mu jz ka kb mv kd ke kf mw kh ki kj mx kl km kn im bi translated">要复制容器重启，您可以<strong class="js iu"> ssh </strong>到运行Pod的worker节点，然后识别它的容器id并停止它，这将通知Kubernetes服务器重启另一个容器，如下所示</p><pre class="lw lx ly lz gt my mz na nb aw nc bi"><span id="2b90" class="mh ky it mz b gy nd ne l nf ng">sudo docker ps | grep &lt;pod name&gt;<br/>sudo docker stop &lt;container id&gt;</span></pre><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nv"><img src="../Images/48d663971adc9ae21c3c1ab0cd11c98c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BLFeXb8jzX1mGGuIPUJ_Vg.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">EKS工人节点</figcaption></figure><p id="f36e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它重新启动了容器，您可以通过在终端上运行以下命令进行验证:-</p><pre class="lw lx ly lz gt my mz na nb aw nc bi"><span id="2e73" class="mh ky it mz b gy nd ne l nf ng">kubectl get po</span><span id="9082" class="mh ky it mz b gy ni ne l nf ng">NAME                                               READY   STATUS    RESTARTS   AGE<br/>my-nginx-6b74b79f57-s524r                          1/1     Running   3          13h</span></pre><p id="82d7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">CloudWatch Alarm现在处于<strong class="js iu"> in-alarm </strong>状态，我们也成功收到了邮件通知。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nw"><img src="../Images/440f9113f02b9137a7839506c0daaa0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JXFQB5qtfL4cvcvB9ufnEQ.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">AWS CloudWatch警报—处于警报状态</figcaption></figure><p id="c0f3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你喜欢这篇文章:-)</p><h1 id="8026" class="kx ky it bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">总结:</h1><p id="afd7" class="pw-post-body-paragraph jq jr it js b jt mt jv jw jx mu jz ka kb mv kd ke kf mw kh ki kj mx kl km kn im bi translated">在这篇博客中，我们学习了如何使用AWS CloudWatch Container Insights从AWS EKS集群获取指标，并创建CloudWatch Alarm来检测异常情况，并通过SNS主题发送电子邮件通知。</p><p id="72af" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">像往常一样，完整的源代码可以在GitHub存储库中找到。请随意分享您自己的IaC(基础设施代码)</p><p id="2625" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae nk" href="https://github.com/vinod827/k8s-nest/tree/main/iac/aws/container-insights" rel="noopener ugc nofollow" target="_blank">https://github . com/vinod 827/k8s-nest/tree/main/IAC/AWS/container-insight</a>s</p></div></div>    
</body>
</html>