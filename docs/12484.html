<html>
<head>
<title>How to use Yarn 3 with React Native</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将纱线3与React Native配合使用</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-use-yarn-3-with-react-native-and-how-to-migrate-c5f108108533?source=collection_archive---------8-----------------------#2022-06-14">https://levelup.gitconnected.com/how-to-use-yarn-3-with-react-native-and-how-to-migrate-c5f108108533?source=collection_archive---------8-----------------------#2022-06-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/421eb9a665e4f4fb99dcbac0a61ad458.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wRh31tyOmDKZ3-w5zwE6sQ.jpeg"/></div></div></figure><p id="813f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Yarn Berry(又名Modern Yarn或Yarn 2+)是经典Yarn的替代品，它提供了性能改进、对工作区的更好支持以及更干净的开发人员体验。</p><p id="ed36" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它最显著的特性之一是即插即用(以下简称“PnP”)，这是一种全新的依赖性管理方法，它消除了运行<code class="fe kw kx ky kz b">yarn install</code>和抛弃<code class="fe kw kx ky kz b">node_modules</code>文件夹的需要。</p><p id="7a43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，React Native是唯一不支持PnP的著名项目之一，而且这种情况不太可能很快改变。</p><p id="6be6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文将解释什么是PnP，为什么React Native不支持它，以及我们如何解决这个问题以享受Yarn 3的大部分优势。</p><h1 id="ad90" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">PnP是什么？</h1><p id="c6e3" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">在经典的Yarn(和<code class="fe kw kx ky kz b">npm</code>)中，我们在一个名为<code class="fe kw kx ky kz b">package.json</code>的清单文件中定义我们的依赖关系。我们称之为直接依赖。然而，我们的依赖性也可以有自己的依赖性。这些是我们的<a class="ae la" href="https://en.wikipedia.org/wiki/Transitive_dependency" rel="noopener ugc nofollow" target="_blank">传递依赖</a>。</p><p id="7db8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">每个依赖项都有许多自己的依赖项，形成一棵“依赖树”，这很正常。这个树结构存储在<code class="fe kw kx ky kz b">yarn.lock</code>中，以防止不同版本的包管理器创建不同的树，这可能会导致各种各样的意外行为。</p><p id="9cda" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们运行yarn install时，使用文件和文件夹重新创建完整的依赖树，并存储在名为<code class="fe kw kx ky kz b">node_modules</code>的文件夹中。</p><p id="78b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在PnP中，我们没有<code class="fe kw kx ky kz b">node_modules</code>文件夹。相反，每个直接的和可传递的依赖项被压缩成一个zip文件，然后存储在<code class="fe kw kx ky kz b">.yarn/cache</code>中。一个名为<code class="fe kw kx ky kz b">.pnp.js</code>的文件包含了<a class="ae la" href="https://yarnpkg.com/features/pnp#fixing-node_modules" rel="noopener ugc nofollow" target="_blank">‘魔法’</a>，它允许node从这个新结构中读取依赖关系。由于其大小和复杂性(<a class="ae la" href="https://byjoeybaker.com/why-you-should-never-commit-node-modules-in-nodejs" rel="noopener ugc nofollow" target="_blank">和所有其他原因</a>)，我们不应该提交我们的<code class="fe kw kx ky kz b">node_modules</code>文件夹，但是提交这些zip文件很简单:每个依赖项一个文件。</p><p id="ab7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">既然我们有了一个提交依赖关系的存储库，那么在切换分支或检出项目时就不需要运行<code class="fe kw kx ky kz b">yarn install</code>。因此，PnP也被称为“零安装”。</p><h1 id="a4f8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">为什么PnP不能和React Native一起使用？</h1><p id="be65" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">简单来说:React Native做出依赖于<code class="fe kw kx ky kz b">node_modules</code>文件夹存在的假设。由于PnP中没有<code class="fe kw kx ky kz b">node_modules</code>，这些引用需要更新。</p><p id="2e5f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2018年末，Github问题在<code class="fe kw kx ky kz b">react-native-community/cli</code>上开放，以跟踪PnP支持的进展。然而——差不多四年过去了— <a class="ae la" href="https://github.com/react-native-community/cli/issues/27#issuecomment-819320665" rel="noopener ugc nofollow" target="_blank">,进展并不大。</a></p><p id="6609" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">前Meta工程师<a class="ae la" href="https://twitter.com/cpojer" rel="noopener ugc nofollow" target="_blank">克里斯托夫·中泽友秀</a> <a class="ae la" href="https://twitter.com/cpojer/status/1495511984330412034" rel="noopener ugc nofollow" target="_blank">今年早些时候发推文</a>称，内部曾尝试过switch Yarn Berry，但由于技术问题而被放弃。似乎PnP支持不是Meta的优先考虑事项，所以我们现在能做的最好的事情就是解决它。</p><h1 id="9572" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">引入节点链接器</h1><p id="f648" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">为了让反应土著高兴，我们需要带回<code class="fe kw kx ky kz b">node_modules</code>。幸运的是，Yarn 3包括一个单线配置选项，使这变得简单。</p><p id="73c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">配置是通过一个<code class="fe kw kx ky kz b">.yarnrc.yml</code>文件完成的，该文件通常位于项目的根目录下。向该文件添加<code class="fe kw kx ky kz b">nodeLinker: node-modules</code>指示Yarn在我们运行<code class="fe kw kx ky kz b">yarn install</code>时创建<code class="fe kw kx ky kz b">node_modules</code>文件夹，就像经典Yarn一样。这意味着我们仍然可以在<code class="fe kw kx ky kz b">.yarn/cache</code>中缓存我们的依赖项，并将它们提交给repo，同时也满足React Native的要求。</p><p id="001c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">显然我们不能再称之为‘零安装’了，但这一步最多需要几秒钟。由于依赖关系树是预先计算的，并且所有的依赖关系都存在于磁盘上的<code class="fe kw kx ky kz b">.yarn/cache</code>中，当我们从缓存中组装巨大的<code class="fe kw kx ky kz b">node_modules</code>文件夹时，唯一限制这一步速度的是磁盘写入速度。</p><h1 id="831f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">迁移</h1><p id="d465" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">以下是如何迁移您的项目。</p><blockquote class="me mf mg"><p id="a120" class="jy jz mh ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated">这是<a class="ae la" href="https://yarnpkg.com/getting-started/migration/#gatsby-focus-wrapper" rel="noopener ugc nofollow" target="_blank">官方移民指南</a>的摘要，你也应该看一下。</p><p id="3e03" class="jy jz mh ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated">本指南假设您没有使用新的选择加入<a class="ae la" href="https://nodejs.org/api/corepack.html" rel="noopener ugc nofollow" target="_blank">节点核心包</a>功能。尽管这是Yarn团队安装新版本的首选方式，但它在Node中仍被标记为“实验性的”,因此我们将暂时退出。</p></blockquote><ol class=""><li id="420b" class="ml mm iq ka b kb kc kf kg kj mn kn mo kr mp kv mq mr ms mt bi translated"><strong class="ka ir">在你的资源库中运行</strong> <code class="fe kw kx ky kz b"><strong class="ka ir">yarn set version berry</strong></code> <strong class="ka ir">。<br/> </strong>该命令将下载最新的Yarn 3二进制文件，存储在<code class="fe kw kx ky kz b">.yarn/releases</code>并创建一个<code class="fe kw kx ky kz b">.yarnrc.yml</code>文件。</li><li id="dcc4" class="ml mm iq ka b kb mu kf mv kj mw kn mx kr my kv mq mr ms mt bi translated"><strong class="ka ir">添加</strong> <code class="fe kw kx ky kz b"><strong class="ka ir">nodeLinker</strong></code> <strong class="ka ir">选项。<br/> </strong>在<code class="fe kw kx ky kz b">.yarnrc.yml</code>中，加上<code class="fe kw kx ky kz b">nodeLinker: node-modules</code></li><li id="19e3" class="ml mm iq ka b kb mu kf mv kj mw kn mx kr my kv mq mr ms mt bi translated"><strong class="ka ir">更新你的</strong> <code class="fe kw kx ky kz b"><strong class="ka ir">.gitignore</strong></code> <strong class="ka ir">。<br/> </strong>添加以下几行:<br/> <code class="fe kw kx ky kz b">.yarn/*<br/> !.yarn/cache<br/> !.yarn/patches<br/> !.yarn/plugins<br/> !.yarn/releases<br/> !.yarn/sdks<br/> !.yarn/versions</code></li><li id="5f9d" class="ml mm iq ka b kb mu kf mv kj mw kn mx kr my kv mq mr ms mt bi translated"><strong class="ka ir">更新脚本。<br/> </strong>用<code class="fe kw kx ky kz b">yarn dlx</code> <a class="ae la" href="https://github.com/yarnpkg/berry/issues/821" rel="noopener ugc nofollow" target="_blank">代替<code class="fe kw kx ky kz b">yarn global</code>为什么？</a> <br/>用<code class="fe kw kx ky kz b">yarn --immutable</code>替换<code class="fe kw kx ky kz b">yarn --frozen-lockfile</code></li><li id="bd3e" class="ml mm iq ka b kb mu kf mv kj mw kn mx kr my kv mq mr ms mt bi translated"><strong class="ka ir">更新自定义注册表设置。<br/> </strong>在经典纱线中，<code class="fe kw kx ky kz b">.npmrc</code>用于定义自定义注册表设置。在Yarn Berry中，它们必须在<code class="fe kw kx ky kz b">.yarnrc.yml</code>中定义。<br/>请注意，您可以同时拥有全局和特定于项目的<code class="fe kw kx ky kz b">.yarnrc.yml</code>。<br/>此步骤仅适用于使用需要自定义配置的私有托管包的情况。</li><li id="ab16" class="ml mm iq ka b kb mu kf mv kj mw kn mx kr my kv mq mr ms mt bi translated"><strong class="ka ir">安装。<br/> </strong>运行<code class="fe kw kx ky kz b">yarn</code>。您的锁定文件将被迁移，并且您的所有依赖项将被缓存在<code class="fe kw kx ky kz b">.yarn/cache</code>中。</li><li id="74a1" class="ml mm iq ka b kb mu kf mv kj mw kn mx kr my kv mq mr ms mt bi translated"><strong class="ka ir">提交</strong>。Git添加所有新缓存的依赖项。最初的差异将是数百个文件，但将来添加和更新包时，每次只会更改几个。</li><li id="ba9c" class="ml mm iq ka b kb mu kf mv kj mw kn mx kr my kv mq mr ms mt bi translated"><strong class="ka ir">推。<br/> </strong>当其他贡献者退出回购时，他们会自动开始使用comitted Yarn 3二进制。不再有管理工具版本！🚀</li></ol><h1 id="763b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">🫐浆果时光</h1><p id="e080" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">现在，即使没有React Native的一流支持，您也可以享受Yarn 3的(大部分)优势。在我看来，仅性能改进一项就使它成为绿地项目的明确选择，安装时间的减少可以在CI方面为您节省大量资金。</p><p id="8609" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你觉得纱莓怎么样？Meta应该更加关注对PnP的支持吗，或者他们现在忽略它是正确的做法吗？有想法就留言评论吧。</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><p id="a978" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我的名字是汤姆·麦金托什，我喜欢打造完美的用户体验。如果你正在开发一个应用程序，需要有人帮助你把想法从草图变成真正的设备，我很乐意和你聊聊。我还致力于现有应用的重构、性能改进和升级。</p><p id="00b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以通过<a class="ae la" href="https://tjmc.dev" rel="noopener ugc nofollow" target="_blank"> tjmc.dev </a>联系到我。</p></div></div>    
</body>
</html>