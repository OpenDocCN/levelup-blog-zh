<html>
<head>
<title>AWS: Run an S3 triggered Lambda Locally Using LocalStack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS:使用LocalStack在本地运行S3触发的Lambda</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/aws-run-an-s3-triggered-lambda-locally-using-localstack-ac05f03dc896?source=collection_archive---------0-----------------------#2022-01-31">https://levelup.gitconnected.com/aws-run-an-s3-triggered-lambda-locally-using-localstack-ac05f03dc896?source=collection_archive---------0-----------------------#2022-01-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2f79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在不离开本地环境的情况下测试您的代码</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/5ff0054014ff687626241a7a929358c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fuwE_hnM0N5BxJZ6"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Jan Canty 在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h2 id="186a" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated"><strong class="ak">简介</strong></h2><p id="d3de" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在本教程中，我们将创建一个AWS Lambda —带有一个S3桶的文件上传调用。此外，我们将在本地测试它，而不需要使用LocalStack的AWS帐户。</p><p id="e39f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一些先决条件:</p><ul class=""><li id="7242" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated">码头工人</li><li id="8a25" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">docker-撰写</li></ul><p id="0045" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们的机器安装了Docker桌面，应该不错。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h2 id="f795" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated"><strong class="ak">概述</strong></h2><p id="0c92" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">使用LocalStack，我们将只使用三种服务:Lambda、S3和日志。可选地，我们还可以包括IAM来创建角色和策略；然而，考虑到在使用LocalStack时它不会影响我们在Lambda和S3之间的集成，为了简洁起见，我们将跳过它。</p><p id="9ee5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们将采取以下几个步骤:</p><ol class=""><li id="c3bb" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mv mg mh mi bi translated">使用docker-compose设置本地堆栈</li><li id="d6ca" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mv mg mh mi bi translated">用LocalStack的端点url创建Lambda函数</li><li id="3e38" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mv mg mh mi bi translated">创建S3桶。同样，使用LocalStack的端点url</li><li id="ebd0" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mv mg mh mi bi translated">创建S3时段通知配置</li><li id="bdf9" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mv mg mh mi bi translated">上传一个虚拟文件到S3桶</li><li id="3741" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mv mg mh mi bi translated">通过日志检查Lambda的调用</li></ol><p id="6808" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们详细介绍一下每个步骤。毕竟，大多数步骤(如果不是全部的话)只是使用来自LocalStack和AWS的现有模板进行配置和设置。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h2 id="8ad8" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated"><strong class="ak">使用docker-compose设置本地堆栈</strong></h2><p id="f133" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">下面是我们的docker-compose.yml，我们将把它放在项目的根目录下:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="cf92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从上面的配置中我们可以看到，我们已经通过一个环境变量列出了服务。此外，我们使用<code class="fe my mz na nb b">4566</code>作为我们的边缘端口。</p><p id="495d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，使用我们项目根目录上的终端，让我们运行这个:<br/> <code class="fe my mz na nb b">docker-compose up</code>。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h2 id="06c9" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">创建Lambda函数</h2><p id="df19" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在做任何事情之前，还是在我们项目的根目录下，让我们为lambda函数的源代码创建一个目录:<code class="fe my mz na nb b">mkdir lambda-src</code></p><p id="eeed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们可以直接从AWS获得模板，而不是从头开始创建代码；然而，为了节省我们更多的时间，下面是index.js的要点:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="28ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意到上面的两行注释了吗？S3客户端的这些参数:<code class="fe my mz na nb b">endpoint</code>和<code class="fe my mz na nb b">s3ForcePathStyle</code>，只有LocalStack才需要。如果我们将这个Lambda部署到AWS，不要忘记删除它。</p><p id="d627" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们使用npm快速安装AWS-SDK:<code class="fe my mz na nb b">npm i aws-sdk</code></p><p id="8300" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们看看我们的package.json:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="9b60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好像不错。现在，让我们确保<code class="fe my mz na nb b">node_modules</code>存在。如果没有，让我们安装依赖项:<code class="fe my mz na nb b">npm install</code></p><p id="6e8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设一切就绪，同样在lambda-src目录中，让我们将源文件和node_modules一起压缩:<code class="fe my mz na nb b">zip -r function.zip .</code></p><p id="39f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，有了function.zip文件，让我们用LocalStack的端点url创建Lambda函数:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mw mx l"/></div></figure></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h2 id="26db" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">创建S3 <strong class="ak">桶及其通知配置</strong></h2><p id="0d5c" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">类似于我们前面的Lambda函数，让我们用LocalStack的端点url创建S3桶:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="0a68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们为S3存储桶创建一个通知配置JSON文件。这里，我们将<code class="fe my mz na nb b">LambdaFunctionArn</code>和S3 <code class="fe my mz na nb b">events</code>一起设置为触发器。让我们将这个文件命名为<code class="fe my mz na nb b">s3-notif-config.json</code>:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="af17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们运行这个命令来附加实际的触发器:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="7ccd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在已经完成了所有必要的设置和配置。让我们调用Lambda，将文件上传到S3存储桶。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h2 id="a467" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">将文件上传到S3存储桶</h2><p id="5e6a" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">为了简单起见，让我们创建一个虚拟文件:<code class="fe my mz na nb b">touch dummyfile.txt</code></p><p id="dca9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们将虚拟文件上传到S3存储桶:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mw mx l"/></div></figure></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h2 id="02d2" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated"><strong class="ak">检查Lambda函数的日志</strong></h2><p id="4160" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">现在，下面是查看日志的命令:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="847e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，让我们通过Lambda函数的内容来验证它的调用:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nd"><img src="../Images/3d13a72eedb371492f13d2ba6aed4863.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dq4_XVWltkKLeS3ZlgyyOg.png"/></div></div></figure><p id="6e03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不错！我们现在确信祈祷成功了。</p><p id="47fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">和往常一样，这个演示的源代码可以在<a class="ae lb" href="https://github.com/emyasa/medium-articles/tree/master/aws-localstack/s3-triggered-lambda" rel="noopener ugc nofollow" target="_blank"> Github </a>上获得。此外，这里的<a class="ae lb" href="https://github.com/emyasa/medium-articles/tree/master/aws-localstack/s3-triggered-lambda#readme" rel="noopener ugc nofollow" target="_blank"> TLDR版本</a>。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><p id="7409" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您正在寻找更多与AWS相关的有趣文章，请随意查看:</p><div class="ne nf gp gr ng nh"><a rel="noopener  ugc nofollow" target="_blank" href="/create-features-toggles-using-aws-appconfig-in-spring-boot-7454b122bf91"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">在Spring Boot使用AWS AppConfig创建要素切换</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">无需重新启动服务器即可更改配置。</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv kv nh"/></div></div></a></div><div class="ne nf gp gr ng nh"><a href="https://medium.com/javarevisited/spring-boot-externalized-database-configuration-with-aws-secrets-manager-605f5ea3006a" rel="noopener follow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">使用AWS Secrets Manager的Spring Boot外部化数据库配置</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">实现高可用性、可扩展性和简单性</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">medium.com</p></div></div><div class="nq l"><div class="nw l ns nt nu nq nv kv nh"/></div></div></a></div></div></div>    
</body>
</html>