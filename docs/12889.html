<html>
<head>
<title>Working With SQL’s Window Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SQL的窗口函数</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/working-with-sqls-window-functions-c70a2c308e9b?source=collection_archive---------19-----------------------#2022-07-18">https://levelup.gitconnected.com/working-with-sqls-window-functions-c70a2c308e9b?source=collection_archive---------19-----------------------#2022-07-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1d33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi kl translated"><span class="l km kn ko bm kp kq kr ks kt di"> S </span> QL对于软件工程师来说是一项至关重要的技能，无论是数据科学家、数据工程师还是其他任何人。在这篇博客中，我将讲述如何使用SQL的窗口函数。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ku"><img src="../Images/6b7e022b6d59863c29789288e62807ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GWmlTfux3LKolz8VibYUpw.jpeg"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">劳拉·克莱夫曼在<a class="ae lk" href="https://unsplash.com/s/photos/windows?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="f818" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">窗口功能:</h1><p id="9f2b" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">窗口函数——这个名字可能会吓到你，但你不需要担心。窗口函数是处理一组行而不是单个行的函数。“窗口功能”中的“窗口”是指一组行。</p><p id="5189" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它们可以用于许多不同的事情，其中一个例子就是执行聚合。通常，当我们聚合时，我们需要按非聚合列进行分组，否则，我们会得到一个错误。当使用窗口函数时，我们不需要担心这个。</p><p id="9ba8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在来看语法，我们通过使用<strong class="jp ir"> OVER() </strong>来定义一个窗口函数。</p><h2 id="e93d" class="mo lm iq bd ln mp mq dn lr mr ms dp lv jy mt mu lz kc mv mw md kg mx my mh mz bi translated">语法:</h2><p id="cfd9" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated"><code class="fe na nb nc nd b">function() OVER(...) AS alias</code></p><p id="0c75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上述语法可以解释如下:</p><blockquote class="ne"><p id="41a1" class="nf ng iq bd nh ni nj nk nl nm nn kk dk translated">一个函数被应用到一个窗口上。</p></blockquote><p id="eb5a" class="pw-post-body-paragraph jn jo iq jp b jq no js jt ju np jw jx jy nq ka kb kc nr ke kf kg ns ki kj kk ij bi translated">现在举个例子。假设我们有一个<strong class="jp ir">匹配</strong>表。我们想做的是找出<em class="nt">“每场比赛进了多少球，与2011/2012赛季的总体平均水平相比如何”</em></p><p id="17cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该查询如下所示:</p><pre class="kv kw kx ky gt nu nd nv nw aw nx bi"><span id="1c4d" class="mo lm iq nd b gy ny nz l oa ob">SELECT date, <br/>       (home_goals + away_goals) AS goals, <br/>        AVG(home_goals + away_goals) OVER() AS overall_avg<br/>FROM match<br/>WHERE season = '2011/2012';</span></pre><p id="3ced" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的查询中，<em class="nt"> home_goals </em>表示主队进球，而<em class="nt"> away_goals </em>表示客队进球，如果您发现我们没有按日期分组，因为我们使用了窗口函数。</p><h1 id="4010" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">生成等级:</h1><p id="ae7b" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">顾名思义它会生成一个<strong class="jp ir">等级</strong>。但是我们将在<strong class="jp ir"> OVER() </strong>中添加一个<strong class="jp ir"> ORDER BY </strong>子句。如果两个值相同，那么它将这些值绑定在一起，并跳过等级中的下一个值(当您看一看这个示例时，您就明白了)。</p><p id="66d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">例如:</strong></p><p id="68d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用相同的比赛表格，我们将对总进球数进行排名。</p><pre class="kv kw kx ky gt nu nd nv nw aw nx bi"><span id="3876" class="mo lm iq nd b gy ny nz l oa ob">SELECT date,<br/>       (home_goal + away_goal) AS goals,<br/>       RANK() OVER(ORDER BY home_goal + away_goal) AS goal_rank<br/>FROM match<br/>WHERE season = '2011/2012';</span></pre><p id="2617" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的结果会是这样的:</p><pre class="kv kw kx ky gt nu nd nv nw aw nx bi"><span id="e68d" class="mo lm iq nd b gy ny nz l oa ob">Goals    goal_rank<br/> 10         1<br/> 10         1<br/> 10         1<br/> 10         1<br/>  9         5<br/>  8         6<br/>  8         6<br/>  7         8</span></pre><p id="89be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，如果目标是相同的，它们都得到了相同的值，但当涉及到下一个目标时，它会直接跳到下一个计数级别(如1重复4次，所以下一个是5)，我们也可以通过在<strong class="jp ir"> ORDER BY中的列名后提到<strong class="jp ir"> DESC </strong>来按降序排列。</strong></p><p id="3b51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想避免跳过等级，那么你可以使用<strong class="jp ir"> DENSE_RANK() </strong>，它和RANK一样，只是不跳过等级。除了<strong class="jp ir"> ORDER BY之外，在查询的每个部分之后都处理<strong class="jp ir"> RANK() </strong>函数。</strong>这意味着它使用结果中的信息，而不是表格中的信息。</p><h1 id="0d46" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">分区:</h1><p id="fc2b" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">假设您想要计算每个季节的AVG()。在这种情况下，可以在<strong class="jp ir"> OVER()中使用<strong class="jp ir"> PARTITION BY </strong>子句。</strong></p><p id="9c84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看一下这个例子。"每场比赛进了多少个球，与赛季平均水平相比如何？"</p><pre class="kv kw kx ky gt nu nd nv nw aw nx bi"><span id="0eab" class="mo lm iq nd b gy ny nz l oa ob">SELECT date,<br/>       (home_goal+away_goal) AS goals,<br/>        AVG(home_goals+away_goal) OVER(PARTITION BY season) AS                  season_avg<br/>FROM match;</span></pre><p id="b9f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的查询返回一个表，其中包含每场比赛的进球以及赛季平均值。</p><pre class="kv kw kx ky gt nu nd nv nw aw nx bi"><span id="1d71" class="mo lm iq nd b gy ny nz l oa ob">date  goals   season_avg<br/>2010   4         4.55<br/>2010   5         4.55<br/>2010   1         4.55<br/>2011   3         6.55<br/>2011   6         6.55<br/>2011   2         6.55</span></pre><p id="b8fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果可能是这样的。现在，如果我们想用多列对T10进行分区，我们可以用“，”来分隔列。</p><h1 id="9431" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">滑动窗口:</h1><p id="ab1f" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">它是一种窗口功能，基本上是基于时间或基于行的窗口。您可以对给定的一组行进行分析。</p><p id="33d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这也使用了<strong class="jp ir"> OVER() </strong>，但唯一额外的是它使用了以下内容:</p><blockquote class="ne"><p id="9a1f" class="nf ng iq bd nh ni nj nk nl nm nn kk dk translated"><start>和<finish>之间的行</finish></start></p></blockquote><p id="4c23" class="pw-post-body-paragraph jn jo iq jp b jq no js jt ju np jw jx jy nq ka kb kc nr ke kf kg ns ki kj kk ij bi translated">我们用一些关键字代替开始和结束。这些关键词是:</p><ul class=""><li id="0658" class="oc od iq jp b jq jr ju jv jy oe kc of kg og kk oh oi oj ok bi translated">前一行—当前行之前的行。</li><li id="c89b" class="oc od iq jp b jq ol ju om jy on kc oo kg op kk oh oi oj ok bi translated">后续—当前行之后的行。</li><li id="6795" class="oc od iq jp b jq ol ju om jy on kc oo kg op kk oh oi oj ok bi translated">未绑定的前一行—滑动到当前行之前的边缘。</li><li id="575e" class="oc od iq jp b jq ol ju om jy on kc oo kg op kk oh oi oj ok bi translated">无界跟随—滑动到当前行之后的边缘行</li><li id="c858" class="oc od iq jp b jq ol ju om jy on kc oo kg op kk oh oi oj ok bi translated">当前行—指当前行。</li></ul><p id="6d80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我将向您展示一个查询，让我知道它在评论部分做什么。</p><pre class="kv kw kx ky gt nu nd nv nw aw nx bi"><span id="9d6a" class="mo lm iq nd b gy ny nz l oa ob">SELECT date,<br/>       home_goal,<br/>       away_goal,<br/>       SUM(home_goal) <br/>            OVER( ORDER BY date ROWS BETWEEN UNBOUNDED  PRECEDING AND CURRENT ROW) AS running_total<br/>FROM match<br/>WHERE hometeam_id = 8456 AND season = '2011/2012';</span></pre><p id="8113" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我知道你的答案。在评论区互相帮助。</p><h1 id="39ad" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">结论:</h1><p id="0515" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">在这篇博客中，我们看了看:</p><ul class=""><li id="dd5b" class="oc od iq jp b jq jr ju jv jy oe kc of kg og kk oh oi oj ok bi translated">什么是窗口函数？</li><li id="3612" class="oc od iq jp b jq ol ju om jy on kc oo kg op kk oh oi oj ok bi translated">如何与他们合作？</li><li id="7978" class="oc od iq jp b jq ol ju om jy on kc oo kg op kk oh oi oj ok bi translated">如何排名？</li><li id="142a" class="oc od iq jp b jq ol ju om jy on kc oo kg op kk oh oi oj ok bi translated">如何划分结果？</li><li id="58a4" class="oc od iq jp b jq ol ju om jy on kc oo kg op kk oh oi oj ok bi translated">什么是推拉窗？</li></ul><p id="e42b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望这篇博客对你有所帮助。在LinkedIn上关注我。如果你喜欢我的作品，那就请我喝杯咖啡:<strong class="jp ir"> <em class="nt"> dataguy6@ybl </em> </strong></p><p id="41db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，看看我最近的作品:</p><div class="oq or gp gr os ot"><a href="https://medium.datadriveninvestor.com/perfect-roadmap-to-becoming-a-devops-engineer-along-with-resources-d2285dd2bfb3" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ir gy z fp oy fr fs oz fu fw ip bi translated">成为DevOps工程师的完美路线图以及资源</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">对SRE/云工程也很有用</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">medium.datadriveninvestor.com</p></div></div><div class="pc l"><div class="pd l pe pf pg pc ph le ot"/></div></div></a></div><div class="oq or gp gr os ot"><a href="https://medium.datadriveninvestor.com/roadmap-to-becoming-a-game-developer-in-2022-128fed2df6c5" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ir gy z fp oy fr fs oz fu fw ip bi translated">2022年成为游戏开发者的路线图</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">如何成为一名游戏开发者</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">medium.datadriveninvestor.com</p></div></div><div class="pc l"><div class="pi l pe pf pg pc ph le ot"/></div></div></a></div></div><div class="ab cl pj pk hu pl" role="separator"><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po"/></div><div class="ij ik il im in"><h1 id="12e3" class="ll lm iq bd ln lo pq lq lr ls pr lu lv lw ps ly lz ma pt mc md me pu mg mh mi bi translated">分级编码</h1><p id="7ed6" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">感谢您成为我们社区的一员！更多内容见<a class="ae lk" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">级编码出版物</a>。<br/>跟随:<a class="ae lk" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank"> Twitter </a>，<a class="ae lk" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>，<a class="ae lk" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">迅</a> <br/>升一级就是转型科技招聘👉<a class="ae lk" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">加入我们的人才集体</strong> </a></p></div></div>    
</body>
</html>