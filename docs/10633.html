<html>
<head>
<title>How to use .includes? in Rails 7</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用。包括？在Rails 7中</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-use-includes-in-rails-7-643b5e1451c4?source=collection_archive---------3-----------------------#2021-12-28">https://levelup.gitconnected.com/how-to-use-includes-in-rails-7-643b5e1451c4?source=collection_archive---------3-----------------------#2021-12-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="65aa" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">渴望加载关联基础知识以优化您的下一个应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e91a0154bcd4f23e229fc258d542aeb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HjxYFodTSF1gLy9T"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@mikaylamallek?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米卡拉·马莱克</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h2 id="0ddd" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">什么是急切加载，为什么它很重要？</h2><p id="c990" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">想象一下:你已经完成了你的编码训练营。您已经学习了面向对象编程、JavaScript和Ruby on Rails的基础知识。你是垃圾的主人。现在，您已经准备好构建您的第一个应用程序，将您学到的一切付诸实践，用您的创业想法颠覆世界，就像您一直梦想的那样。</p><p id="f5e1" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">然而，随着您的应用程序开始增长，您的数据库也会随之增长。突然感觉每一页每一行代码都慢得像在爬行。数据库关系和SQL查询不断扩展，管理不断增长的数据变得越来越困难。心烦意乱的你突然意识到一周的数据库是不够的。您找到的每个StackOverflow答案都提到了一个叫做N+1查询的东西。有常规连接，左外连接，内连接，但是没有一个真正有意义。</p><p id="f282" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">这就是渴望装载来拯救。</p><h2 id="fa5e" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">TL；速度三角形定位法(dead reckoning)</h2><ul class=""><li id="6b9e" class="mt mu it lx b ly lz mb mc li mv lm mw lq mx mn my mz na nb bi translated">使用控制器中的<code class="fe nc nd ne nf b">:includes</code>获取加载记录，以便立即加载。</li><li id="ce7d" class="mt mu it lx b ly ng mb nh li ni lm nj lq nk mn my mz na nb bi translated">当获取子代的子代时，在模型中使用<code class="fe nc nd ne nf b">:includes</code>(多态关联)。</li><li id="8794" class="mt mu it lx b ly ng mb nh li ni lm nj lq nk mn my mz na nb bi translated">不要用得太多。预加载大量数据会降低页面速度。</li></ul><h2 id="d270" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">1.如何用<code class="fe nc nd ne nf b">:includes</code>解决N+1问题</h2><p id="86c3" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">让我们开始吧。假设您正在构建一个列出并评论餐馆的应用程序——一个<a class="ae ky" href="https://www.yelp.com/" rel="noopener ugc nofollow" target="_blank"> Yelp </a>或<a class="ae ky" href="https://www.thefork.com/" rel="noopener ugc nofollow" target="_blank"> The Fork </a>的克隆。通常，会有一个简单的餐馆数据库，每个餐馆会有许多用户可以留下的评论(当然也会有用户，但对于这个例子来说这是不必要的)。</p><p id="9ad2" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">restaurant和review的模型如下所示:</p><pre class="kj kk kl km gt nl nf nm nn aw no bi"><span id="114a" class="kz la it nf b gy np nq l nr ns">#app/models/restaurant.rb<br/>Class Restaurant &lt;&lt; ActiveRecord::Base<br/>   has_many :reviews<br/>end</span><span id="1adf" class="kz la it nf b gy nt nq l nr ns">#app/models/review.rb<br/>Class Review &lt;&lt; ActiveRecord::Base<br/>   belongs_to :restaurant<br/>end</span></pre><p id="47bd" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">为了展示一家餐馆并显示它的评论列表，控制器和视图应该是这样的:(我们保持简单并排除了HTML格式，但您已经明白了)</p><pre class="kj kk kl km gt nl nf nm nn aw no bi"><span id="c353" class="kz la it nf b gy np nq l nr ns">#app/controllers/restaurants_controller.rb<br/>  def show<br/>    @restaurant = Restaurant.find(params[:id])<br/>  end</span><span id="90fe" class="kz la it nf b gy nt nq l nr ns"><br/>#app/views/restaurants/show.html.erb<br/>&lt;%= @restaurant.name %&gt;</span><span id="c89c" class="kz la it nf b gy nt nq l nr ns">&lt;% @restaurant.reviews.each do |review| %&gt;<br/>&lt;p&gt;&lt;%= review.content %&gt;&lt;/p&gt;<br/>&lt;% end %&gt;</span></pre><p id="5f8d" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">页面加载时的情况是这样的:将从数据库加载餐馆，然后对于<code class="fe nc nd ne nf b">@restaurant.reviews</code>中的每个评论，将调用另一个数据库查询。这意味着一个有十条评论的餐馆需要11次数据库调用来显示所有信息。呀!..</p><p id="4834" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">这是一个可怕的N+1问题——对于每一个<code class="fe nc nd ne nf b">has_many</code>关系实例，数据库都被称为额外时间。服务器日志看起来像这样，加载一个餐馆，然后加载多个评论。</p><pre class="kj kk kl km gt nl nf nm nn aw no bi"><span id="9f83" class="kz la it nf b gy np nq l nr ns">Started GET "/restaurants/65" for ::1 at 2020-04-09 15:09:21 +0800<br/>Processing by RestaurantsController#show as HTML<br/>  Parameters: {"id"=&gt;"65"}<br/>  Restaurant Load (0.2ms)  SELECT  "restaurants".* FROM "restaurants" WHERE "restaurants"."id" = ? LIMIT ?  [["id", 65], ["LIMIT", 1]]<br/>  ↳ app/controllers/restaurants_controller.rb:64<br/>  Rendering restaurants/show.html.erb within layouts/application<br/>  Review Load (0.1ms)  SELECT "reviews".* FROM "reviews" WHERE "reviews"."restaurant_id" = ?  [["restaurant_id", 65]]<br/>  ↳ app/views/restaurants/show.html.erb:16<br/>  Rendered restaurants/show.html.erb within layouts/application (8.2ms)<br/>Completed 200 OK in 40ms (Views: 30.7ms | ActiveRecord: 0.6ms)</span></pre><p id="6769" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">通过在表上创建一个左外连接，在一个查询中返回所有数据，快速装载解决了这个问题。添加一个急切的加载就像向控制器添加一个<code class="fe nc nd ne nf b">:includes</code>语句一样简单。瞧啊。</p><pre class="kj kk kl km gt nl nf nm nn aw no bi"><span id="01a2" class="kz la it nf b gy np nq l nr ns">#app/controllers/restaurants_controller.rb<br/>  def show<br/>    @restaurant = Restaurant.includes(:reviews).find(params[:id])<br/>  end</span><span id="1de2" class="kz la it nf b gy nt nq l nr ns">#app/views/restaurants/show.html.erb<br/>&lt;%= @restaurant.name %&gt;</span><span id="1350" class="kz la it nf b gy nt nq l nr ns">&lt;% @restaurant.reviews.each do |review| %&gt;<br/>&lt;p&gt;&lt;%= review.content %&gt;&lt;/p&gt;<br/>&lt;% end %&gt;</span></pre><h2 id="b0fd" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">2.preload()和eager_load()呢？</h2><p id="b662" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">实际上，在Rails中有三种方式可以进行急切加载。</p><ol class=""><li id="360f" class="mt mu it lx b ly mo mb mp li nu lm nv lq nw mn nx mz na nb bi translated">使用<code class="fe nc nd ne nf b">preload()</code>通过一个单独的数据库查询获取数据(尽管只有一个，避免了N+1个查询)</li><li id="85a8" class="mt mu it lx b ly ng mb nh li ni lm nj lq nk mn nx mz na nb bi translated">使用<code class="fe nc nd ne nf b">eager_load()</code>通过一个大型查询和一个外部连接获取数据</li><li id="5c84" class="mt mu it lx b ly ng mb nh li ni lm nj lq nk mn nx mz na nb bi translated">使用<code class="fe nc nd ne nf b">includes()</code>动态寻找最佳解决方案并预加载或渴望加载数据。</li></ol><p id="2254" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">简而言之，如果您使用的是急切加载，就不需要担心哪种情况更合适。要更深入地了解每个查询背后发生了什么，我建议查看这篇博文。</p><h2 id="31ad" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">3.如何知道何时需要急切装载？</h2><p id="581c" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">因此，如果不使用急切加载会导致N+1次查询，会降低应用程序的速度，并且使用过多的急切加载会不必要地增加应用程序的容量，那么您如何知道何时使用(或不使用)它呢？</p><p id="45cf" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">一种简单的方法是检查服务器日志。一个页面调用五个以上的sql WHERE查询就足以证明出了问题。另一种方法是检查子模型何时被调用。如果一个餐馆有很多评论，并且餐馆和它的评论都在同一个页面上被调用，那么急切的加载很可能会提高页面的性能。</p><p id="6bbf" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">到目前为止，最简单的(也是我最喜欢的)检查方法是使用<a class="ae ky" href="https://github.com/flyerhzm/bullet" rel="noopener ugc nofollow" target="_blank"> Bullet </a> gem，尤其是对初学者来说。Bullet不仅会检查代码中的N+1个查询，还会检查调用紧急加载的地方，但这并不十分必要。然而，在使用gem时，要确保只在开发环境中调用它，以免在生产环境中收到关于恶意N+1查询的警告。</p><h2 id="e20b" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">4.结论</h2><p id="aab3" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">承蒙<a class="ae ky" href="https://gist.github.com/johncip/17c496f04dcd032d594a785e2ad09824" rel="noopener ugc nofollow" target="_blank"> johncip </a>的好意，我给你们留下一份简短的备忘单:</p><pre class="kj kk kl km gt nl nf nm nn aw no bi"><span id="c4e5" class="kz la it nf b gy np nq l nr ns">eager_load()<br/>- single query (left outer join)<br/>- can reference the other table’s columns in <!-- -->where</span><span id="78e5" class="kz la it nf b gy nt nq l nr ns">preload()<br/>- a few queries (one per table)<br/>- typically faster</span><span id="d32f" class="kz la it nf b gy nt nq l nr ns">includes()<br/>- acts like <!-- -->preload<!-- --> by default<br/>- falls back on <!-- -->eager_load<!-- --> if you reference the associated tables</span></pre><p id="adcc" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated"><em class="ny">你最喜欢的优化Rails应用的方法是什么？如果你想让我在评论中写一篇关于它的文章，请告诉我！</em></p></div></div>    
</body>
</html>