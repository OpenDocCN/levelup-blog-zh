# 库伯内特可观测性

> 原文：<https://levelup.gitconnected.com/kubernetes-observability-425fe60bcdc1>

## 日志和度量工具

![](img/e8425dc958db6168878529b16f12a9de.png)

肖恩·豪泽在 Unsplash[上拍摄的照片](https://unsplash.com/s/photos/binoculars?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

识别生产系统中的问题并进行故障排除的能力至关重要。在本文中，我们将讨论一些工具，它们可以帮助我们理解生产 Kubernetes 集群中正在发生的事情。

# 可观察性

可观察性是理解生产系统中正在发生的事情的能力。我们可以处理低可观测性系统(无法理解正在发生的事情)或高可观测性系统(可以通过工具从外部推断事件和内部状态)。

可观察性是系统本身的一个属性。通常，监控是获取关于系统当前或过去状态的信息的操作。一切都是命名的争论，但是你监视系统来收集它的可观察部分。在大多数情况下，监控很容易。有许多伟大的工具可以帮助我们捕捉和分析信息，并以各种方式呈现出来。但是，系统需要公开相关信息，以便收集。披露正确的信息量是非常困难的。过多的信息会产生大量噪声，从而掩盖相关信号。太少的信息不足以发现问题。

分布式系统(比如遵循微服务架构的系统)也有问题，因为系统的复杂性可能使其难以理解其内部状态。在某些情况下，行为也是不可预测的。这样的系统在本质上永远不会完全健康；到处都会有小问题。您需要开发一个优先级系统来确定哪些问题需要立即采取行动，哪些问题可以稍后解决。

微服务可观察性的主要工具是**日志**和**度量**。社区很好地理解和使用了它们，并且有许多工具可以极大地简化它们的使用。它们可以用作本地安装的软件包或云服务，帮助保留数据并降低维护成本。

在 Kubernetes 中，可以通过`kubectl`查看集群状态的最重要细节。这将包括详细的信息，如部署版本，重新启动，拉映像等。日志和指标有不同的目标，而且都很复杂。

## 日志

日志只跟踪系统中发生的事件。每个日志存储一条消息，该消息是在执行代码的特定部分时生成的。日志可以是完全通用的(调用函数 X)，也可以包含特定的细节(使用参数 A 调用函数 X)。日志最常见的格式是生成纯字符串。这是非常灵活的，通常，与日志相关的工具可以用于文本搜索。每个日志都包含一些元数据，如谁生成了日志、何时创建的等等。

该日志还包括严重性级别。这允许分类，以便我们可以捕捉信息的重要性。按照重要性的顺序，严重级别可以是*调试*、*信息*、*警告*或*错误*。这种严重性允许我们过滤掉不重要的日志，并确定应该采取什么措施。日志记录工具可以配置为设置阈值。不太严重的日志将被忽略。

在 web 服务环境中，大多数日志将作为 web 请求-响应的一部分生成。这意味着请求将到达系统，被处理并返回一个值。在这个过程中会生成几个日志。请记住，在负载较大的系统中，多个请求会同时发生，因此来自多个请求的日志也会同时生成。您可以添加一个公共请求 ID 来对为单个请求生成的所有相关日志进行分组。

每个单独的日志可能相对较大，总计将占用大量磁盘空间。在有负载的系统中，日志可能会很快超过该比率。不同的日志系统允许我们调整它们的保留时间，这意味着我们只保留它们一定的时间。在记录日志以查看过去发生的事情和使用合理数量的空间之间找到平衡是很重要的。

一些工具允许我们使用原始日志来生成聚合结果。它们可以计算特定日志出现的次数，并生成每分钟的平均次数或其他统计数据。然而，这是昂贵的，因为每个日志都要占用空间。要观察这种聚合行为，最好使用特定的度量系统。

## 韵律学

度量处理聚合数据。他们展示的信息不是单个事件，而是一个群体。这使我们能够以比使用日志更好的方式检查集群的一般状态。

关于每个事件的信息都保存在日志中，度量将信息减少到事件发生的次数，或者减少到可以以某种方式进行平均或聚合的值。这使得指标比日志轻得多，并允许我们基于时间来绘制它们。

度量显示信息，例如每分钟的请求数、一分钟内请求的平均时间、排队的请求数、每分钟的错误数等等。捕获和分析与性能相关的信息，例如平均请求时间，使我们能够发现可能的瓶颈，并采取快速措施来提高系统性能。一般来说，使用度量比使用日志更容易处理，因为单个请求可能无法捕获足够的信息让我们看到全局。它还帮助我们预测未来的瓶颈。

# 库伯内特和可观测性

ubernetes 是当今部署和维护容器的主要平台。随着它上升到行业意识的顶端，新技术也出现了，以提供有效的可观测性工具。

## 普罗米修斯

当您想同时监控 Kubernetes 基础设施和集群中运行的服务时， [Prometheus](https://prometheus.io/) 是最好的起点。它提供了您需要的一切，包括客户端工具库、存储后端、可视化 UI 和警报框架。运行 Prometheus 还可以立即提供大量的基础设施指标。尽管数据交换并非在所有情况下都是双向的，但它也提供了与第三方存储提供商的集成。

## 公开普查

[OpenCensus](https://opencensus.io/) 是谷歌开发的普查库的开源版本。它提供测量和跟踪检测功能，并支持许多后端将指标导出到 Prometheus。请注意，OpenCensus 不会监控您的基础设施，如果您选择使用 OpenCensus 进行自定义度量遥测，您仍需要确定最佳方法。

## 石墨

[Graphite](https://graphiteapp.org/) 源于 Orbitz 的内部开发工作，现在定位为可以在企业中使用的监视工具。它提供度量存储和检索机制，但不提供检测功能。因此，您仍然需要实现 Prometheus 或 OpenCensus 工具来收集指标。

## InfluxDB

InfluxDB 是另一个开源数据库，专门用于存储和检索时间序列指标。与 Graphite 不同，InfluxDB 由一家名为 InfluxData 的公司提供支持，该公司提供 InfluxDB 软件和一个名为 InfluxDB Cloud 的云托管版本。

## 流体 d

在 Kubernetes 生态系统中，fluentd 是事实上的开源标准，用于收集集群中发出的日志并将它们转发到指定的后端。您可以使用配置映射来修改 fluentd 的行为。

## 齐普金

Zipkin 是一个完整的分布式追踪解决方案，包括检测、存储和可视化。它是一套经过实践检验的真实工具。它已经存在了很多年，拥有强大的用户和开发者社区。它还可以用作 OpenCensus 等其他工具选项的后端。

## 贼鸥

[Jaeger](https://www.jaegertracing.io/) 是另一个开源追踪解决方案，包含你需要的所有组件。这是一个由云本地计算基金会(CNCF)孵化的新项目。最终选择使用 Zipkin 还是 Jaeger 可能最终取决于您使用它们的经验以及对您用来编写服务的语言的支持。

## 格拉夫纳

[Grafana](https://grafana.com/) 是多平台开源分析和交互式可视化 web 应用。当连接到支持的数据源时，它为 web 提供图表、图形和警报。这是目前开源可视化事实上的标准。

# 最后的想法

Kubernetes 上的可观察性针对每种需求类型有许多部分和许多选项。度量、日志和跟踪工具提供了做出服务决策所需的基础信息。

为系统中的指标找到正确的平衡不是一件容易的事情，需要时间和反复试验。然而，在线服务的四个指标始终是重要的。这些措施如下:

*   潜伏
*   交通
*   错误
*   浸透

这些指标可以在[谷歌 SRE 的书](https://sre.google/sre-book/monitoring-distributed-systems/#:~:text=The%20four%20golden%20signals%20of,system%2C%20focus%20on%20these%20four.&text=The%20time%20it%20takes%20to%20service%20a%20request.)中找到，作为*四个黄金信号*，并且被认为是成功监控的最重要的高级元素。