<html>
<head>
<title>AWS CDK — How you could configure your application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS CDK —如何配置您的应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/aws-cdk-how-you-could-parameterize-your-application-9dadb775da68?source=collection_archive---------3-----------------------#2021-01-24">https://levelup.gitconnected.com/aws-cdk-how-you-could-parameterize-your-application-9dadb775da68?source=collection_archive---------3-----------------------#2021-01-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f80955f15320fac81fa4b9a135ff2a19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TifTDG2gHa8CH4mz"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@denisseleon?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">丹尼斯·莱昂</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="00cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我已经在亚马逊网络服务公司工作了将近两年。大约8个月前，我从普通的CloudFormation模板开始，转而使用云开发工具包。这是一个非常简洁的工具，使得资源部署变得相当容易。我最喜欢的是你如何模块化你的代码，以及你如何轻松地在不同的栈间共享资源。然而，我鼓励你在马上进入CDK之前开始学习CloudFormation，因为CDK编译CloudFormation模板，有时你需要知道它们是如何工作的，否则你会遇到一些问题。让我给你看一个例子:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">CDK陷阱</figcaption></figure><p id="e81c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有人可能认为<code class="fe lh li lj lk b">myBucketArnParam</code>的值会被打印到控制台。但实际上它打印了:<code class="fe lh li lj lk b">${Token[TOKEN.575]}</code>因为SSM参数不是在编译时解析的，而是在执行模板时解析的。另一个问题是，<code class="fe lh li lj lk b">.grantRead()</code>应该允许“<em class="ll">使用这个密钥来解密bucket […] </em>的内容。如果桶和键在同一个堆栈中，这才是正确的，因为键策略必须与键一起创建。换句话说，你将不被允许解密数据。不管怎样，还是来说说这篇文章的主题吧。</p><p id="5781" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我一直在努力寻找正确参数化/配置我的应用程序的方法。有几种方法，每种都有自己的缺陷。我已经说过，代码模块化是CDK的主要优势之一。然而，有时你最终会得到一个堆栈，这个堆栈创建了一个构造，而这个构造本身又创建了一个构造。例如:您将API网关分离成自己的构造。它需要一个桶来存储用户的图像。这个桶是用KMS密钥加密的，并且有一些带条件的复杂策略，所以您将它放入自己的构造中。存储桶的名称必须是fix，因为您需要授予另一个帐户(b)中的角色跨帐户访问权限，因此不能在堆栈之间轻松共享存储桶名称。角色需要有bucket的名称，以便只授予对这个特定bucket的访问权限(<a class="ae kc" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege" rel="noopener ugc nofollow" target="_blank">授予最小特权</a>)。那么……在哪里存储桶名呢？</p><p id="efe6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面，我将向你展示我试图克服这个问题的方法，以及它们的缺陷和我今天正在使用的方法。然而，我还没有一个超级的，复杂的解决方案，所以请看看这个更多的建议。我们都还在学习如何使用CDK。</p><p id="2c8e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">*为简单起见，我只关注桶。</p><h2 id="f464" class="lm ln iq bd lo lp lq dn lr ls lt dp lu ko lv lw lx ks ly lz ma kw mb mc md me bi translated">首先，在堆栈/构造的属性中定义存储桶名称</h2><p id="db20" class="pw-post-body-paragraph kd ke iq kf b kg mf ki kj kk mg km kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">一种解决方案是扩展堆栈的构造器(或props ),并通过构造传递bucket名称，直到您需要它。那么它是如何工作的:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">应用程序</figcaption></figure><p id="017d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这很简单。您会看到bucket名称是在哪里定义的，以及它最终在哪里被使用。然而，这只是一个简单的用例，在现实世界的应用程序中，您有大量的配置，比如存储库名称、域名、存储库所有者(Github)等等。接口会很快变得非常冗长，当添加或删除新内容时，您必须适应几个地方。这可能是一个烂摊子。</p><h2 id="5ac0" class="lm ln iq bd lo lp lq dn lr ls lt dp lu ko lv lw lx ks ly lz ma kw mb mc md me bi translated">第二，在cdk.json中定义bucket名称</h2><p id="2bb8" class="pw-post-body-paragraph kd ke iq kf b kg mf ki kj kk mg km kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">另一个解决方案是使用作为<a class="ae kc" href="https://docs.aws.amazon.com/cdk/latest/guide/context.html" rel="noopener ugc nofollow" target="_blank">运行时上下文</a>公开的<code class="fe lh li lj lk b">cdk.json</code>，并通过使用<code class="fe lh li lj lk b">this.node.tryGetContext()</code>来使用bucket名称。那么代码看起来是什么样的呢:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">cdk.json</figcaption></figure><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">应用程序</figcaption></figure><p id="b52a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我省略了<code class="fe lh li lj lk b">StackA</code>和<code class="fe lh li lj lk b">ApiConstruct</code>，因为它们不再需要任何改编。正如您所看到的，我们用这个解决方案克服了冗长的接口。然而，我们不容易看到在哪里使用了bucket名称，必须手动搜索它。如果我们在某些情况下需要替换配置，比如部署到不同的阶段，该怎么办？我们不能在一个应用程序中有几个<code class="fe lh li lj lk b">cdk.json</code>文件。我们也没有合适的<a class="ae kc" href="https://code.visualstudio.com/docs/editor/intellisense" rel="noopener ugc nofollow" target="_blank">智能感知</a>，因为<code class="fe lh li lj lk b">tryGetContext()</code>不知道底层的<code class="fe lh li lj lk b">cdk.json</code>。这让我想到了第三种方法。</p><h2 id="a308" class="lm ln iq bd lo lp lq dn lr ls lt dp lu ko lv lw lx ks ly lz ma kw mb mc md me bi translated">3通过使用自定义配置来定义存储桶名称</h2><p id="659f" class="pw-post-body-paragraph kd ke iq kf b kg mf ki kj kk mg km kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">我今天使用的解决方案是一个自定义配置和一个加载配置的类。一切都是从那里进口的。同样，代码看起来像什么:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">配置. json</figcaption></figure><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">配置文件</figcaption></figure><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">应用程序</figcaption></figure><p id="d240" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看起来像以前的解决方案，但现在我们可以交换配置，并拥有适当的智能感知。像VS Code这样的现代ide可以向你展示某个东西在哪里被使用(<a class="ae kc" href="https://code.visualstudio.com/docs/getstarted/tips-and-tricks#_go-to-references" rel="noopener ugc nofollow" target="_blank">见</a>)，因此我们不需要手动搜索它。我不知道这是否是最好的方法。不过，用起来感觉还是不错的。我还没有在一个超级大的应用程序中尝试过，如果我这样做了，我会更新这篇文章。</p><p id="a86c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你的方法是什么？</p><p id="2a81" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">//BMA</p></div></div>    
</body>
</html>