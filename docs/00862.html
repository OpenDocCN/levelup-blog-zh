<html>
<head>
<title>Kubernetes: Change base YAML config for different environments prod/test using Kustomize</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:使用Kustomize更改不同环境生产/测试的基本YAML配置</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/kubernetes-change-base-yaml-config-for-different-environments-prod-test-6224bfb6cdd6?source=collection_archive---------2-----------------------#2019-08-28">https://levelup.gitconnected.com/kubernetes-change-base-yaml-config-for-different-environments-prod-test-6224bfb6cdd6?source=collection_archive---------2-----------------------#2019-08-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b22f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们希望有一个基本的配置YAML文件，然后我们希望根据环境的变化。我们将使用<em class="kl"> Kustomize </em>作为工具来完成这项工作。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/dce4062b032bb3b64943c8be42311cb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L9ouDUacHHE966611A8h1Q.png"/></div></div></figure><h2 id="78c6" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">内容</h2><ul class=""><li id="1bdc" class="lr ls iq jp b jq lt ju lu jy lv kc lw kg lx kk ly lz ma mb bi translated">第一部分:<a class="ae mc" rel="noopener ugc nofollow" target="_blank" href="/kubernetes-merge-multiple-yaml-into-one-e8844479a73a">将多个YAML文件合并成一个</a></li><li id="9f0f" class="lr ls iq jp b jq md ju me jy mf kc mg kg mh kk ly lz ma mb bi translated">第2部分(本文):为不同环境更改基本YAML配置</li></ul><h2 id="f9a1" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">安装Kustomize</h2><p id="de2c" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">确保安装最新的<code class="fe ml mm mn mo b">kubectl</code>，因为<em class="kl"> Kustomize </em>已经包含在内(<code class="fe ml mm mn mo b">kubectl kustomize</code>)。否则<a class="ae mc" href="https://github.com/kubernetes-sigs/kustomize" rel="noopener ugc nofollow" target="_blank">手动安装</a>。</p><h2 id="a9e7" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">Kustomize需要什么服务器端？</h2><p id="9bee" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">没什么。Kustomize所做的只是将各种YAML文件合并成一个。然后你可以<code class="fe ml mm mn mo b">kubectl apply -f merged.yaml</code>这个文件。无论您是手动创建<code class="fe ml mm mn mo b">merged.yaml</code>还是使用<em class="kl"> Kustomize </em>都没关系。</p><h2 id="a173" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">今天的场景</h2><p id="238b" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">我们将有三种环境:</p><ul class=""><li id="f64a" class="lr ls iq jp b jq jr ju jv jy mp kc mq kg mr kk ly lz ma mb bi translated"><strong class="jp ir"> base </strong>:包含一套YAML配置，其他环境可以基于该配置</li><li id="4635" class="lr ls iq jp b jq md ju me jy mf kc mg kg mh kk ly lz ma mb bi translated"><strong class="jp ir">测试</strong>:扩展基地，会改变基地部署的图像</li><li id="c41a" class="lr ls iq jp b jq md ju me jy mf kc mg kg mh kk ly lz ma mb bi translated">扩展基础，将改变形象，服务类型，并增加一个全新的资源</li></ul><h2 id="9753" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">Github项目</h2><p id="5684" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">整个例子在这个回购中完成:<a class="ae mc" href="https://github.com/wuestkamp/kubernetes-kustomize-example" rel="noopener ugc nofollow" target="_blank">https://github.com/wuestkamp/kubernetes-kustomize-example</a></p><h1 id="5711" class="ms kz iq bd la mt mu mv ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni bi translated"><strong class="ak">基础包络</strong></h1><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/d0f95573e69ca52530b170c23dd9673b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*ZMTyNvh1XNazwRJFQbXjxQ.png"/></div></figure><p id="a7ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个包含三个文件的文件夹<code class="fe ml mm mn mo b">base</code>:</p><p id="e9f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ml mm mn mo b">deployment.yaml</code>:</p><pre class="kn ko kp kq gt nk mo nl nm aw nn bi"><span id="f93e" class="ky kz iq mo b gy no np l nq nr"><strong class="mo ir">apiVersion: </strong>apps/v1<br/><strong class="mo ir">kind: </strong>Deployment<br/><strong class="mo ir">metadata:<br/>  name: </strong>app<br/><strong class="mo ir">spec:<br/>  replicas: </strong>1<br/>  <strong class="mo ir">selector:<br/>    matchLabels:<br/>      id: </strong>app<br/>  <strong class="mo ir">template:<br/>    metadata:<br/>      labels:<br/>        id: </strong>app<br/>    <strong class="mo ir">spec:<br/>      containers:<br/>      </strong>- <strong class="mo ir">image: </strong>XXX # needs to be overridden by environments<br/>        <strong class="mo ir">name: </strong>nginx</span></pre><p id="9771" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ml mm mn mo b">service.yaml</code>:</p><pre class="kn ko kp kq gt nk mo nl nm aw nn bi"><span id="e695" class="ky kz iq mo b gy no np l nq nr"><strong class="mo ir">apiVersion: </strong>v1<br/><strong class="mo ir">kind: </strong>Service<br/><strong class="mo ir">metadata:<br/>  labels:<br/>    app: </strong>service<br/>  <strong class="mo ir">name: </strong>service<br/><strong class="mo ir">spec:<br/>  ports:<br/>  </strong>- <strong class="mo ir">name: </strong>80-80<br/>    <strong class="mo ir">port: </strong>80<br/>    <strong class="mo ir">protocol: </strong>TCP<br/>    <strong class="mo ir">targetPort: </strong>80<br/>    <strong class="mo ir">nodePort: </strong>30080<br/>  <strong class="mo ir">selector:<br/>    id: </strong>app<br/>  <strong class="mo ir">type: </strong>NodePort</span></pre><p id="8cd4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ml mm mn mo b">kustomize.yaml</code>:</p><pre class="kn ko kp kq gt nk mo nl nm aw nn bi"><span id="7c1e" class="ky kz iq mo b gy no np l nq nr"><strong class="mo ir">apiVersion: </strong>kustomize.config.k8s.io/v1beta1<br/><strong class="mo ir">kind: </strong>Kustomization<br/><br/><strong class="mo ir">resources:<br/>  </strong>- deployment.yaml<br/>  - service.yaml</span></pre><p id="4018" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，当我们运行<code class="fe ml mm mn mo b">kubectl kustomize build base</code>时，它将输出一个包含服务和部署的多资源文件。但是部署它会非常失败，因为有一个错误的映像名称集:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="nu nv gj gh gi nw nx bd b be z dk translated">编译的基本环境yaml</figcaption></figure><h1 id="a538" class="ms kz iq bd la mt mu mv ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni bi translated">测试环境</h1><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/90a79c749d40a76a25cd78821b43ceec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*rA7k_PQ5OFMBKe6O6sG2sA.png"/></div></figure><p id="ef71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个新文件夹<code class="fe ml mm mn mo b">overlays</code>。在其中创建一个新的子文件夹<code class="fe ml mm mn mo b">test</code>和两个文件:</p><blockquote class="ny nz oa"><p id="6513" class="jn jo kl jp b jq jr js jt ju jv jw jx ob jz ka kb oc kd ke kf od kh ki kj kk ij bi translated">使用名为<code class="fe ml mm mn mo b">overlays</code>的文件夹似乎很常见，但是您可以根据自己的喜好命名和更改目录结构。</p></blockquote><p id="3c2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ml mm mn mo b">deployment.yaml</code>:</p><pre class="kn ko kp kq gt nk mo nl nm aw nn bi"><span id="7b2b" class="ky kz iq mo b gy no np l nq nr">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  <strong class="mo ir">name: app # necessary for Kustomize identification</strong><br/>spec:<br/>  template:<br/>    spec:<br/>      containers:<br/>      - <strong class="mo ir">image: nginx:1.17.3</strong><br/>        <strong class="mo ir">name: nginx # necessary for Kustomize identification</strong></span></pre><p id="e9c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ml mm mn mo b">kustomization.yaml</code>:</p><pre class="kn ko kp kq gt nk mo nl nm aw nn bi"><span id="b60b" class="ky kz iq mo b gy no np l nq nr"><strong class="mo ir">apiVersion: </strong>kustomize.config.k8s.io/v1beta1<br/><strong class="mo ir">kind: </strong>Kustomization<br/><br/><strong class="mo ir">bases:<br/></strong>- ../../base # relative path to the base folder<br/><br/><strong class="mo ir">patchesStrategicMerge:<br/>  </strong>- deployment.yaml</span></pre><p id="5fa2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行<code class="fe ml mm mn mo b">kubectl kustomize build overlays/test</code>现在将使用<strong class="jp ir">所有的</strong>基础资源，并只替换部署到nginx:1.17.3的映像名称，结果应该是:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="nu nv gj gh gi nw nx bd b be z dk translated">编译的测试环境yaml</figcaption></figure><p id="1190" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我们为部署定义了一个<strong class="jp ir"> patchesStrategicMerge </strong>条目，<em class="kl"> Kustomize </em>将查找文件<code class="fe ml mm mn mo b">deployment.yaml</code>并覆盖来自基础<code class="fe ml mm mn mo b">deployment.yaml</code>的指定值。name属性对于指定要被覆盖的资源标识非常重要。</p><h1 id="145a" class="ms kz iq bd la mt mu mv ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni bi translated">产品环境</h1><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/a1b8f95da1f65422ef7b6159a68435ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*AKsn0X7F1uhDDtzqfYSUOg.png"/></div></figure><p id="7ddd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在生产方面，我们希望做得更多。我们希望替换映像名称、副本数量、服务类型并添加新资源。为此，我们创建了四个文件:</p><p id="3f59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ml mm mn mo b">deployment.yaml</code>:</p><pre class="kn ko kp kq gt nk mo nl nm aw nn bi"><span id="0873" class="ky kz iq mo b gy no np l nq nr">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: app<br/>spec:<br/>  <strong class="mo ir">replicas: 3</strong><br/>  template:<br/>    spec:<br/>      containers:<br/>      - <strong class="mo ir">image: nginx:stable</strong><br/>        name: nginx</span></pre><p id="13e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ml mm mn mo b">service.yaml</code>:</p><pre class="kn ko kp kq gt nk mo nl nm aw nn bi"><span id="9c21" class="ky kz iq mo b gy no np l nq nr">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: service<br/>spec:<br/>  <strong class="mo ir">type: LoadBalancer</strong></span></pre><p id="5d7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ml mm mn mo b">storage.yaml:</code></p><pre class="kn ko kp kq gt nk mo nl nm aw nn bi"><span id="56b0" class="ky kz iq mo b gy no np l nq nr"><strong class="mo ir">apiVersion: </strong>v1<br/><strong class="mo ir">kind: </strong>PersistentVolumeClaim<br/><strong class="mo ir">metadata:<br/>  name: </strong>pvc<br/><strong class="mo ir">spec:<br/>  accessModes:<br/>    </strong>- ReadWriteOnce<br/>  <strong class="mo ir">resources:<br/>    requests:<br/>      storage: </strong>1Mi</span></pre><p id="c440" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ml mm mn mo b">kustomization.yaml</code>:</p><pre class="kn ko kp kq gt nk mo nl nm aw nn bi"><span id="b123" class="ky kz iq mo b gy no np l nq nr"><strong class="mo ir">apiVersion: </strong>kustomize.config.k8s.io/v1beta1<br/><strong class="mo ir">kind: </strong>Kustomization<br/><br/><strong class="mo ir">bases:<br/></strong>- ../../base<br/><br/><strong class="mo ir">resources:<br/>  </strong>- storage.yaml # a new resource<br/><br/><strong class="mo ir">patchesStrategicMerge:<br/>  </strong>- deployment.yaml<br/>  - service.yaml</span></pre><p id="a27a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在运行<code class="fe ml mm mn mo b">kubectl kustomize build overlays/prod</code>将编译生产yaml，看起来应该是这样的:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="nu nv gj gh gi nw nx bd b be z dk translated">编译产品环境yaml</figcaption></figure><h1 id="295f" class="ms kz iq bd la mt mu mv ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni bi translated">部署</h1><p id="38c8" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">要部署环境配置，您可以运行:</p><pre class="kn ko kp kq gt nk mo nl nm aw nn bi"><span id="80e4" class="ky kz iq mo b gy no np l nq nr">kubectl kustomize build overlays/prod | kubectl apply -f -</span></pre><p id="ff1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者</p><pre class="kn ko kp kq gt nk mo nl nm aw nn bi"><span id="00e1" class="ky kz iq mo b gy no np l nq nr">kubectl kustomize build overlays/prod &gt; tmp_prod.yaml<br/>kubectl apply -f tmp_prod.yaml</span></pre><h1 id="4cda" class="ms kz iq bd la mt mu mv ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni bi translated">总是有更多的</h1><p id="23f7" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">我们只用了一个补丁策略(patchesStrategicMerge)，但是还有一个<a class="ae mc" href="https://github.com/kubernetes-sigs/kustomize/blob/master/docs/glossary.md#patchjson6902" rel="noopener ugc nofollow" target="_blank"> JSON补丁一</a>。</p><h1 id="0c6a" class="ms kz iq bd la mt mu mv ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni bi translated">模板化与库斯托米化</h1><p id="4a4f" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">当使用<em class="kl"> Helm </em>作为模板引擎时，YAML文件很快会变得非常难看，看看这个例子。</p><p id="ed30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<em class="kl"> Kustomize </em>可以更容易地保持配置的整洁，当然这总是取决于用例。</p><h1 id="9132" class="ms kz iq bd la mt mu mv ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni bi translated">结束了。</h1><p id="10c5" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">您是否在生产中使用<em class="kl"> Kustomize </em>？</p><h1 id="2048" class="ms kz iq bd la mt mu mv ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni bi translated">成为Kubernetes认证</h1><figure class="kn ko kp kq gt kr gh gi paragraph-image"><a href="https://killer.sh"><div class="gh gi oe"><img src="../Images/cf3901a56841fcb55f9e4e17b9f07672.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Kbj17_6VncUuoBqNsAzzg.png"/></div></a><figcaption class="nu nv gj gh gi nw nx bd b be z dk translated"><a class="ae mc" href="https://killer.sh" rel="noopener ugc nofollow" target="_blank"> https://killer.sh </a></figcaption></figure></div></div>    
</body>
</html>