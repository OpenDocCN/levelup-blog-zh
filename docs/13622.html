<html>
<head>
<title>Basic SQL Optimization Suggestions that Programmers Should Know</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">程序员应该知道的基本SQL优化建议</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/basic-sql-optimization-suggestions-that-programmers-should-know-94de09fd131?source=collection_archive---------5-----------------------#2022-09-22">https://levelup.gitconnected.com/basic-sql-optimization-suggestions-that-programmers-should-know-94de09fd131?source=collection_archive---------5-----------------------#2022-09-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="f6bc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当我们谈到系统性能优化时，除了代码层面的各种有针对性的优化，还有一个非常重要的手段就是优化数据库的性能。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/be2cc91daf5dc4f8a990e03f95fe0729.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Dcdw3aJIoq88OEnDl5pwA.jpeg"/></div></div></figure><p id="0b56" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在一个互联网系统中，当系统访问量越来越大，数据量越来越多，数据库的压力就会越来越大。如果数据库表结构设计不当，SQL语句写得不好，代码性能可能极高，但系统却被数据库拖垮了。因此，我们程序员有必要了解数据库和数据库访问优化，以便设计高性能的系统。</p><p id="61e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">作为程序员，我们可能不了解生产环境的服务器硬件配置，无法像DBA那样专业地对数据库进行各种实际测试和总结。然而，我们应该很好地理解我们的SQL业务逻辑和我们访问的表和字段的数据。事实上，我们不想知道数据库的高可用架构以及如何访问数据。我们只关心我的SQL是否能尽快返回结果。那么程序员应该如何优化数据库呢？怎样才能快速定位SQL性能问题，找到正确的优化方向？面对这些问题，我给程序员总结了一些基础的优化知识(本文基于MySQL数据库)。</p><h2 id="718e" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">系统性能优化的基本方向</h2><p id="3807" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">为了优化计算机系统的性能，我们需要知道系统运行在哪里，并快速定位性能瓶颈。在大多数情况下，最慢的设备将成为瓶颈。众所周知，计算机系统的CPU运行速度比缓存快得多，缓存又比内存快得多。所以很多时候，磁盘IO和网络IO是系统的性能瓶颈。</p><p id="3adb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据数据库操作原理，这些设备在数据库操作过程中的主要工作内容如下:</p><ul class=""><li id="4e76" class="ly lz it js b jt ju jx jy kb ma kf mb kj mc kn md me mf mg bi translated">CPU:事务控制、并发控制、SQL解析、函数或逻辑计算。</li><li id="c025" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">内存:缓存数据的读/写。</li><li id="6149" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">网络:数据响应和查询结果传输。</li><li id="de32" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">磁盘:数据读写，日志记录，海量数据排序，表连接。</li></ul><p id="342c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于数据库，以上四点可以转化为以下四点优化建议:</p><ul class=""><li id="4fab" class="ly lz it js b jt ju jx jy kb ma kf mb kj mc kn md me mf mg bi translated">减少磁盘使用和数据访问(设计适当的表结构并创建高性能索引)</li><li id="3f99" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">减少网络访问(批量请求，返回更少的数据)</li><li id="c839" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">减少CPU开销(减少聚合函数调用，合理使用排序)</li></ul><h2 id="e6b3" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">适当的表结构设计</h2><p id="877b" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">良好的表结构设计是高数据库性能的基础。表结构设计的核心是字段数据类型的选择。选择正确的数据类型至关重要。选择数据类型有一些通用原则:</p><ul class=""><li id="9fd4" class="ly lz it js b jt ju jx jy kb ma kf mb kj mc kn md me mf mg bi translated">强烈建议为每个表创建一个自动递增的主键。自动增量主键可以将随机io提升为顺序io，并且可以申请索引页，以便使索引页紧凑，并减少页拆分对性能的影响</li><li id="b91d" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">如果长度符合要求，数据类型越小越好，使用的磁盘、内存和cpu缓存越少。对于数值数据，如果可以选择无符号类型，则可以选择无符号类型。无符号类型可以存储两倍于有符号类型的正数。</li><li id="cf21" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">确定字符类型长度。请使用char而不是varchar。相同字符长度的字符节省更多的存储空间。</li><li id="544b" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">如果可以使用时间戳，就不需要datetime了。时间戳只需要4个字节，日期时间需要8个字节。</li><li id="e659" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">尽量避免空字段。当MySQL中的字段为NULL时，仍然会占用空间，并使索引和索引统计更加复杂。更新空字段时很容易拆分索引页，这会影响性能。应该使用有意义的值，而不是NULL。</li></ul><h2 id="4bd7" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">创建高性能索引</h2><p id="09f6" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">顾名思义，数据库索引是用于优化查询的辅助数据结构。这可以看作是为了提高查询速度而创建的另一个冗余数据。索引相对简单。就MySQL的innodb引擎来说，是用B+树数据结构存储的。然而，尽管索引很简单，但很少有人能在复杂的表中正确使用索引。</p><p id="d6f6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">索引会大大增加表记录的DML(更新、插入、删除)成本。优秀的索引可以使数据库性能提升数百倍，而不合理的索引可能会使性能降低数百倍。因此，有必要平衡在表中创建索引的业务需求。一般来说，关于在哪些字段上创建索引，有一些经验:</p><ul class=""><li id="fb9a" class="ly lz it js b jt ju jx jy kb ma kf mb kj mc kn md me mf mg bi translated">经常用于查询的字段，该字段过滤出的记录约占总记录的10%。</li><li id="8f1a" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">建议为主键、表关联的外键以及具有标识意义的字段(如用户名、电子邮件等)创建索引。</li><li id="41de" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">状态标志就像order_ status、is_ Delete和gender字段不适合创建索引，大文本、大字段和描述字段不适合创建索引。</li></ul><p id="7c5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下列情况下，即使创建了索引，也不会使用该索引:</p><ul class=""><li id="580f" class="ly lz it js b jt ju jx jy kb ma kf mb kj mc kn md me mf mg bi translated">当索引字段使用<code class="fe mm mn mo mp b">&lt;&gt;</code>、<code class="fe mm mn mo mp b">not in</code>、<code class="fe mm mn mo mp b">is null</code>时，索引将不被使用，如<code class="fe mm mn mo mp b">Index_column &lt;&gt; ?</code>。你可以用<code class="fe mm mn mo mp b">union</code>代替<code class="fe mm mn mo mp b">&lt;&gt;</code>来聚合搜索结果。</li></ul><p id="f0ec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如<code class="fe mm mn mo mp b">select id, product_name from order where amount!=1000</code></p><p id="2242" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">到</p><p id="d008" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mm mn mo mp b">(select id, product_name from order where amount&gt;1000) union all (select id, product_name from order where amount&lt;1000)</code></p><ul class=""><li id="31e4" class="ly lz it js b jt ju jx jy kb ma kf mb kj mc kn md me mf mg bi translated">普通算术运算或函数运算后的索引字段不能使用索引，如<code class="fe mm mn mo mp b">function(Index_column)=?</code>、<code class="fe mm mn mo mp b">Index_column+1=?</code></li><li id="d79f" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">像带有前导模糊查询的语法不能使用索引，如<code class="fe mm mn mo mp b">index_column like '%?%'</code></li></ul><h2 id="ce88" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">分页查询</h2><p id="f095" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">当查询的数据量超过总量的30%时，MySQL就不会使用索引，所以分页查询非常重要。但是，您也应该小心分页查询。比如<code class="fe mm mn mo mp b">select * from table limit 100000 10;</code>，MySQL会查询前100010条记录，丢弃前100000条记录，所以在分页到比较的页面时查询速度会越来越慢。我们可以通过使用延迟相关来解决这个问题。</p><p id="be31" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mm mn mo mp b">select * from table where id in (select id from table limit 1000000 10)</code></p><p id="d97c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这种方法巧妙地利用聚集索引来减少大量回表查询的执行次数，从而提高执行效率。</p><h2 id="8edc" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">分类的合理使用</h2><p id="49ef" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">数据库排序一般在内存中进行。对于数据库，排序是一项消耗CPU的操作。因为现代CPU的高性能，上万个数据的排序可能对数据库影响不大。但是，如果一个表中有几十万个数据，就需要考虑如何处理排序。对大数据集进行排序不仅消耗内存和CPU，内存不够还会发生硬盘排序，导致排序性能急剧下降。所以一般来说，不排序可以不排序。如果必须排序，请尝试为排序字段创建一个索引，因为索引本身是有序的。</p><p id="8fb1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">还有一些简单的建议，比如只返回需要的数据，批量处理。本文旨在分析一些常见的数据库优化方法，并对面向程序员的SQL优化提出一些建议，希望能提高你的SQL优化能力。感谢您的阅读。</p><div class="mq mr gp gr ms mt"><a href="https://medium.com/javarevisited/five-api-performance-optimization-tricks-that-every-java-developer-must-know-75324ee1d244" rel="noopener follow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd iu gy z fp my fr fs mz fu fw is bi translated">每个Java开发人员都必须知道的五个API性能优化技巧</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">为什么你的API响应这么慢？也许你需要解决这些问题。</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">medium.com</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh ky mt"/></div></div></a></div><div class="mq mr gp gr ms mt"><a href="https://medium.com/javarevisited/5-best-java-libraries-every-java-developer-should-know-28a1c080bbf" rel="noopener follow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd iu gy z fp my fr fs mz fu fw is bi translated">每个Java开发人员都应该知道的5个最佳Java库</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">你知道这些优秀的Java库吗？</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">medium.com</p></div></div><div class="nc l"><div class="ni l ne nf ng nc nh ky mt"/></div></div></a></div><div class="mq mr gp gr ms mt"><a href="https://medium.com/javarevisited/use-spring-retry-to-implement-automatic-retry-742f4532620c" rel="noopener follow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd iu gy z fp my fr fs mz fu fw is bi translated">使用Spring Retry实现自动重试</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">使用spring retry来优雅地实现重试代码。</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">medium.com</p></div></div><div class="nc l"><div class="nj l ne nf ng nc nh ky mt"/></div></div></a></div></div><div class="ab cl nk nl hx nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="im in io ip iq"><h1 id="b395" class="nr lb it bd lc ns nt nu lf nv nw nx li ny nz oa ll ob oc od lo oe of og lr oh bi translated">分级编码</h1><p id="f1c0" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="d719" class="ly lz it js b jt ju jx jy kb ma kf mb kj mc kn md me mf mg bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="dd22" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">📰查看<a class="ae oi" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">级编码出版物</a>中的更多内容</li><li id="3819" class="ly lz it js b jt mh jx mi kb mj kf mk kj ml kn md me mf mg bi translated">🔔关注我们:<a class="ae oi" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a> | <a class="ae oi" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a> | <a class="ae oi" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="7573" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">🚀👉<a class="ae oi" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">将像你这样的开发人员安置在顶级创业公司和科技公司</strong> </a></p></div></div>    
</body>
</html>