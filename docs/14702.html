<html>
<head>
<title>Amazon ECS Service Connect</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">亚马逊ECS服务连接</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/amazon-ecs-service-connect-298680f65e9?source=collection_archive---------6-----------------------#2022-12-19">https://levelup.gitconnected.com/amazon-ecs-service-connect-298680f65e9?source=collection_archive---------6-----------------------#2022-12-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c99f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">AWS中的托管服务发现和网格配置</h2></div><p id="2a88" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">于2015年4月正式推出的<a class="ae le" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank">弹性容器服务</a> (ECS)是一个受欢迎的<a class="ae le" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank">亚马逊网络服务</a> (AWS)解决方案，用于在云中托管基于容器的应用程序。当我们大规模供应集装箱化系统时，我们创建的基础设施可能会快速增长，以包括许多<a class="ae le" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html" rel="noopener ugc nofollow" target="_blank">服务</a>、<a class="ae le" href="https://aws.amazon.com/elasticloadbalancing/" rel="noopener ugc nofollow" target="_blank">负载平衡器</a>和<a class="ae le" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/rrsets-working-with.html" rel="noopener ugc nofollow" target="_blank"> DNS记录</a>。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/59dc59e603fb47dc094c0959e1b008a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OigNoAIlGNKT7ZfyQ5L7UQ.jpeg"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">约翰·巴克利普通过Unsplash拍摄的照片</figcaption></figure><p id="85b4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这种服务/负载平衡器/ DNS记录模式下，每个新服务都会导致成本增加。<a class="ae le" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-discovery.html" rel="noopener ugc nofollow" target="_blank">通过<a class="ae le" href="https://aws.amazon.com/cloud-map/" rel="noopener ugc nofollow" target="_blank"> AWS云地图</a>的服务发现</a>消除了我们创建弹性负载平衡器的需要，而是要求我们提供<a class="ae le" href="https://docs.aws.amazon.com/cloud-map/latest/dg/working-with-services.html" rel="noopener ugc nofollow" target="_blank">云地图服务</a>。</p><p id="a9be" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最近，ECS推出了<a class="ae le" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-connect.html" rel="noopener ugc nofollow" target="_blank"> Service Connect </a>:一种新的互连方法，除了服务网格配置之外，还提供完全托管的服务发现。以前我们可能依赖<a class="ae le" href="https://aws.amazon.com/app-mesh/" rel="noopener ugc nofollow" target="_blank"> AWS App Mesh </a>进行标准化的服务对服务通信，现在我们可以采用Service Connect来减少我们的基础设施，并完全从ECS管理服务发现和Mesh配置。</p><h1 id="063d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">服务连接是如何工作的？</h1><p id="9756" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">假设我们有一个ECS应用程序(“客户机”)通过一个弹性负载均衡器接收来自互联网的请求。客户端希望从另一个ECS应用程序(“服务器”)请求信息，该应用程序本身从互联网获取信息。我们有流入客户端的流量、客户端和服务器之间的通信以及来自服务器的流出流量。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ms"><img src="../Images/2971449e9a80252f17cc94da48dc5709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ToJLsVUM89hjoo6NPpk7qA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">作者图表</figcaption></figure><p id="1294" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Service Connect特别支持单个<a class="ae le" href="https://docs.aws.amazon.com/cloud-map/latest/dg/working-with-namespaces.html" rel="noopener ugc nofollow" target="_blank">云地图名称空间</a>内的服务对服务通信。虽然它不支持入口和出口配置，但我们可以对客户端和服务器之间的流量采用Service Connect，只要我们将它们分配到同一个名称空间。服务连接分别将它们称为<strong class="kk iu">客户端</strong>和<strong class="kk iu">客户端-服务器</strong>服务:我们的客户端将只向服务连接端点发送流量，而我们的服务器(“客户端-服务器”)公开一个服务连接端点供请求使用。如果需要，服务器还可以向其他服务连接端点发送流量。</p><p id="f48f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于服务发现，每个服务连接应用程序都需要一个代理容器。当应用程序部署到ECS时，代理容器会自动配置，并在云地图命名空间中搜索活动端点。这仅在托管我们的应用程序的<a class="ae le" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html" rel="noopener ugc nofollow" target="_blank"> ECS任务</a>首次启动时发生，因此之后创建的任何其他服务连接端点都不会被发现，除非应用程序任务再次启动。</p><p id="92ea" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这种行为意味着我们部署Service Connect服务的顺序很重要:客户端希望向服务器端点发送流量，因此服务器必须在客户端之前启动，否则客户端的代理将无法识别服务器的Service Connect端点。</p><p id="5fcb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我们启动服务器时，我们为应用程序的容器端口定义一个端口映射名称。我们可以在我们的服务连接配置中指定这个映射，使它能够被客户端发现。在这个例子中，假设我们在端口5000上运行服务器应用程序，端口映射名为<code class="fe mt mu mv mw b">server</code>。</p><p id="7a26" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们的客户端代码中，假设我们配置了名称空间<code class="fe mt mu mv mw b">hello-world.com</code>中的所有内容，我们可以向<code class="fe mt mu mv mw b"><a class="ae le" href="http://hello-world-server:5000." rel="noopener ugc nofollow" target="_blank">http://server.hello-world.com:5000</a></code>发送服务器请求。客户机代理容器将在端点<code class="fe mt mu mv mw b">server</code>启动时检测它(在服务器之后),并知道将这些请求路由到相应的服务器代理容器。实现这一目标的所有底层代理和服务网格配置都完全由ECS管理。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi mx"><img src="../Images/dd5eacf099387d3ad1d80e41a7a86b04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SDG--UawazmgKR5C7NShPQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">作者图表</figcaption></figure><p id="c860" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过采用Service Connect，我们不再需要为每个ECS应用程序调配我们自己的负载平衡器或云服务，Service Connect会自动为我们管理负载平衡、超时和流量重试。这减少了我们所需的配置和基础设施的数量。</p><h1 id="d7bb" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">服务连接的限制和成本是什么？</h1><p id="84e3" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">《开发人员指南》中记录了Service Connect的价格<a class="ae le" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-discovery.html#service-discovery-pricing" rel="noopener ugc nofollow" target="_blank">。与服务发现类似，我们对</a><a class="ae le" href="https://aws.amazon.com/route53/" rel="noopener ugc nofollow" target="_blank"> Route53 </a>内的DNS资源以及云图API操作收费。默认的容器级健康检查是免费执行的。</p><p id="c4a5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">虽然Service Connect听起来很适合上面的例子，但是对于这个功能有几个限制需要记住。AWS <a class="ae le" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-discovery.html#service-discovery-considerations" rel="noopener ugc nofollow" target="_blank">在他们的开发人员指南中记录了一个全面的概念和考虑事项的列表</a>，值得进一步详细阅读。举几个关键点:</p><ul class=""><li id="e081" class="my mz it kk b kl km ko kp kr na kv nb kz nc ld nd ne nf ng bi translated">服务连接仅适用于ECS服务到服务的流量，</li><li id="3644" class="my mz it kk b kl nh ko ni kr nj kv nk kz nl ld nd ne nf ng bi translated">服务必须部署在相同的云地图命名空间中，并且</li><li id="f1ed" class="my mz it kk b kl nh ko ni kr nj kv nk kz nl ld nd ne nf ng bi translated">服务连接不支持Windows容器。</li></ul><h1 id="baa5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">我们如何配置服务连接？</h1><p id="7da3" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">在撰写本文时应用最新版本的AWS云开发工具包(CDK )( v 2 . 55 . 1 ),让我们浏览一下ECS Service Connect所需的不同配置。</p><p id="277a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先从<a class="ae le" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/clusters.html" rel="noopener ugc nofollow" target="_blank"> ECS集群</a>开始，我们可以设置<code class="fe mt mu mv mw b">defaultCloudMapNamespace</code>来指定服务连接名称空间的名称。命名空间<code class="fe mt mu mv mw b">hello-world.com</code>将作为我们CloudFormation堆栈的一部分，在集群旁边自动为我们创建。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="a27d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当集群被提供时，我们可以为服务连接名称空间创建客户机和客户机-服务器服务。首先从一个客户端开始，我们可以用我们的云地图名称空间的名称来设置属性<code class="fe mt mu mv mw b">serviceConnectConfiguration</code>。相同的配置适用于EC2和Fargate服务。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="0deb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于客户机-服务器服务，我们还需要设置端点名称供客户机发现。这需要额外的<code class="fe mt mu mv mw b">serviceConnectConfiguration</code>属性，通过名称指示我们希望客户端可以访问哪些容器端口映射。该设置将从容器端口映射定义中推断出正确的端口，在本例中为<code class="fe mt mu mv mw b">5000</code>。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="5c25" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们的客户机中，我们可以编写一个小脚本，向我们新配置的服务连接客户机-服务器提交请求。基于上面配置的端口映射，我们可以向<code class="fe mt mu mv mw b"><a class="ae le" href="http://server:5000." rel="noopener ugc nofollow" target="_blank">http://server.hello-world.com:5000</a></code>发送请求。</p><p id="b588" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，Service Connect的云地图名称空间确实需要很短的时间来提供，并且还需要一点时间来取消服务注册。因此，最好在独立的CDK /云架构堆栈中配置任何集群和名称空间，以便与Service Connect服务分开部署。</p><h1 id="a215" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">进一步阅读</h1><p id="685b" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">感谢您花时间阅读这篇博文。很高兴能更深入地探索在AWS 2022<a class="ae le" href="https://reinvent.awsevents.com/" rel="noopener ugc nofollow" target="_blank">re:Invent</a>之后推出的最新ECS功能。事实证明，以下链接对这篇博文非常有价值，可以作为有用的进一步阅读参考:</p><ul class=""><li id="d128" class="my mz it kk b kl km ko kp kr na kv nb kz nc ld nd ne nf ng bi translated"><a class="ae le" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-connect.html" rel="noopener ugc nofollow" target="_blank">服务连接的开发者指南</a></li><li id="2368" class="my mz it kk b kl nh ko ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><a class="ae le" href="https://aws.amazon.com/blogs/aws/new-amazon-ecs-service-connect-enabling-easy-communication-between-microservices/" rel="noopener ugc nofollow" target="_blank"> AWS新闻博客文章</a>宣布服务连接</li><li id="11e3" class="my mz it kk b kl nh ko ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><a class="ae le" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-service-serviceconnectconfiguration.html" rel="noopener ugc nofollow" target="_blank">云信息</a>和<a class="ae le" href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ecs.ServiceConnectProps.html" rel="noopener ugc nofollow" target="_blank"> CDK </a>的服务连接配置</li><li id="716e" class="my mz it kk b kl nh ko ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><a class="ae le" href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/interconnecting-services.html" rel="noopener ugc nofollow" target="_blank">ECS互连方法的用户指南</a>(如App Mesh)</li></ul><p id="b01d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您有使用ECS Service Connect的直接经验，请告诉我们您对这项新功能的想法。否则，如果您正在使用App Mesh等其他互连方法，了解Service Connect是否可以简化您的解决方案将是一件好事。</p></div></div>    
</body>
</html>