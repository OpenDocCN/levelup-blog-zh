<html>
<head>
<title>Write your own tools: python + slack webhook + crontab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自己写工具:python + slack webhook + crontab</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/write-your-own-tools-python-slack-webhook-crontab-b549dd7b85e?source=collection_archive---------5-----------------------#2021-05-02">https://levelup.gitconnected.com/write-your-own-tools-python-slack-webhook-crontab-b549dd7b85e?source=collection_archive---------5-----------------------#2021-05-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/344cc7be06d6ee90cf7e71f6aee5d7d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-YtJXpDAu9F0WE-DucOn_g.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">那些是机器人。机器人会替你做这项工作。</figcaption></figure><h1 id="ab59" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">目标</h1><p id="2fe2" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">在本文中，我将向您展示如何使用slack webhook、python脚本和crontab建立简单而强大的集成。我发现它非常有用，因为它允许我自动化不同的信息流。通常，您有一些数据源，访问这些数据源非常耗时，除此之外，通常还需要使用您的智能“动态”转换数据，最终您可能根本没有时间进行检查。</p><h1 id="0bd5" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">流动</h1><figure class="mc md me mf gt ju gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/9a743a4723c6314fd20f2052f8fcd336.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*HAZ9WoOV3qMXbvQ9v8TSBA.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">我们想在这篇文章中实现的流程。用https://sequencediagram.org/完成<a class="ae mg" href="https://sequencediagram.org/" rel="noopener ugc nofollow" target="_blank">(如果你还不知道这个工具，你应该让自己熟悉)。</a></figcaption></figure><p id="c849" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">这种集成的中心点是python脚本，您将在其中添加获取数据、转换数据然后使用Slack webhook发送数据的逻辑。这个流中的crontab是作业调度所需要的，手动运行脚本是次优的，因此您可以在脚本需要执行的给定时间设置一个cron作业，可以是每天一次，可以是每10分钟一次，也可以是每周日12:00一次，无论您怎么想。</p><h1 id="e72c" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">非常真实的例子</h1><p id="40e6" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">为了让这个流程工作，你需要具备一些先决条件——配置一个Slack webhook是必要的。进入你的slack的应用程序管理，点击自定义集成，搜索传入的Webhooks，然后按照步骤进行配置:</p><figure class="mc md me mf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mm"><img src="../Images/20a53bc365d2d849783de4a047d259cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DiL6sLHxe53nHHw7qSRrRQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在这里，您可以添加传入的WebHooks集成。</figcaption></figure><p id="4ba5" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">这个配置中最重要的工件是webhook URL，它应该是这样的:<br/> <code class="fe mn mo mp mq b"><a class="ae mg" href="https://hooks.slack.com/services/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" rel="noopener ugc nofollow" target="_blank">https://hooks.slack.com/services/T01ERXXXXXX/B020XXXXXX/rzrCkTvsXXXXXXXXXXXXXXXX</a></code></p><p id="05e1" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">把它保存在某个地方，我们将来会需要它。</p><p id="841a" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">现在，我们准备运行第一个示例，让我们创建一个简单的python脚本。</p><figure class="mc md me mf gt ju"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="971b" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">您可以使用simple: <code class="fe mn mo mp mq b">python3 slackwebhookcall.py</code>进行测试，结果应该是:</p><figure class="mc md me mf gt ju gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/ae33d35c30944d072dd2979ca9adb0ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:462/format:webp/1*iqenz5RKX_QYnTEewN8GnQ.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">万岁！我们在Slack上的第一条机器人信息。</figcaption></figure><p id="3b4a" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">现在，要运行这个脚本，您只需要<code class="fe mn mo mp mq b">requests</code>包，它可以通过pip安装:<code class="fe mn mo mp mq b">pip install requests</code>其余的已经在您的标准python库中可用。请注意脚本的第一行——我们将在接下来的阶段需要它，因为我们将使该文件可执行，以便crontab可以运行它。</p><p id="0f2f" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">格式化slack消息有很多种可能性，下面的例子是最简单的一个，看看<code class="fe mn mo mp mq b">payload</code>，<code class="fe mn mo mp mq b">channel</code>显然告诉我们要把消息发送到哪里，<code class="fe mn mo mp mq b">username</code>是将显示在消息上的用户名——你不需要在你的Slack工作区中定义这个用户，你可以在这里放置任何东西，<code class="fe mn mo mp mq b">text</code>是消息的文本，<code class="fe mn mo mp mq b">icon_emoji</code>是在消息附近显示为用户图片的表情符号，你可以添加一些有趣的东西，因为这一切都是为了开心。关于Slack消息格式的细节可以在Slack的官方文档中找到:<a class="ae mg" href="https://api.slack.com/messaging/composing" rel="noopener ugc nofollow" target="_blank">https://api.slack.com/messaging/composing</a></p><p id="7f6c" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">让我们的例子变得有用，假设你投资了一些股票或加密货币，你可以在你的slack通道中查看，而不是在web界面中查看当前价格。</p><p id="c061" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">去雅虎财经:<a class="ae mg" href="https://finance.yahoo.com/quote/BTC-USD?p=BTC-USD" rel="noopener ugc nofollow" target="_blank">https://finance.yahoo.com/quote/BTC-USD?p=BTC-USD</a>在那里使用开发工具深入了解一下通话内容:</p><figure class="mc md me mf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mu"><img src="../Images/22006ce731459db226c794068275a7c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ygH4w47uCMn0mVYOR-LWg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">突出显示的请求是我们感兴趣的请求。</figcaption></figure><blockquote class="mv mw mx"><p id="c4a6" class="ld le my lf b lg mh li lj lk mi lm ln mz mj lq lr na mk lu lv nb ml ly lz ma im bi translated">希望文章发表后雅虎不要屏蔽访问；)</p></blockquote><p id="e262" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">复制上面的网址:<a class="ae mg" href="https://query1.finance.yahoo.com/v7/finance/quote?&amp;symbols=BTC-USD&amp;fields=extendedMarketChange,extendedMarketChangePercent,extendedMarketPrice,extendedMarketTime,regularMarketChange,regularMarketChangePercent,regularMarketPrice,regularMarketTime,circulatingSupply,ask,askSize,bid,bidSize,dayHigh,dayLow,regularMarketDayHigh,regularMarketDayLow,regularMarketVolume,volume" rel="noopener ugc nofollow" target="_blank">https://query1.finance.yahoo.com/v7/finance/quote?&amp;symbols = BTC-美元&amp;fields = extendedMarketChange，extendedMarketChangePercent，extendedMarketPrice，extendedMarketTime，regularMarketChange，regularMarketChangePercent，regularMarketPrice，regularMarketTime，circulatingSupply，ask，askSize，bidSize，dayHigh，dayLow，regularMarketDayHigh，regularMarketDayLow，regularMarketVolume，volume </a></p><p id="470c" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">获取我们的python脚本中的数据(调用:<code class="fe mn mo mp mq b">python3 btcall.py</code>):</p><figure class="mc md me mf gt ju"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="770a" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">现在，我们需要解析数据:</p><pre class="mc md me mf gt nc mq nd ne aw nf bi"><span id="05d0" class="ng kg it mq b gy nh ni l nj nk">{<br/>    "quoteResponse": {<br/>        "result": [<br/>            {<br/>                "language": "en-US",<br/>                "region": "US",<br/>                "quoteType": "CRYPTOCURRENCY",<br/>                "quoteSourceName": "CoinMarketCap",<br/>                "triggerable": true,<br/>                "exchange": "CCC",<br/>                "exchangeTimezoneName": "Europe/London",<br/>                "exchangeTimezoneShortName": "BST",<br/>                "gmtOffSetMilliseconds": 3600000,<br/>                "market": "ccc_market",<br/>                "esgPopulated": false,<br/>                "marketState": "REGULAR",<br/>                "firstTradeDateMilliseconds": 1410908400000,<br/>                "circulatingSupply": 18696150,<br/>                "regularMarketChange": 352.47656,<br/>                "regularMarketChangePercent": 0.6182226,<br/>                "regularMarketTime": 1619887322,<br/>                "regularMarketPrice": 57367.05,<br/>                "regularMarketDayHigh": 58413.133,<br/>                "regularMarketDayRange": "57052.273 - 58413.133",<br/>                "regularMarketDayLow": 57052.273,<br/>                "regularMarketVolume": 44779245568,<br/>                "regularMarketPreviousClose": 57728.312,<br/>                "fullExchangeName": "CCC",<br/>                "fiftyTwoWeekLowChange": 314.77734,<br/>                "fiftyTwoWeekLowChangePercent": 0.0055173496,<br/>                "fiftyTwoWeekRange": "57052.273 - 58413.133",<br/>                "fiftyTwoWeekHighChange": -1046.082,<br/>                "fiftyTwoWeekHighChangePercent": -0.017908337,<br/>                "fiftyTwoWeekLow": 57052.273,<br/>                "fiftyTwoWeekHigh": 58413.133,<br/>                "sourceInterval": 15,<br/>                "exchangeDataDelayedBy": 0,<br/>                "tradeable": false,<br/>                "symbol": "BTC-USD"<br/>            }<br/>        ],<br/>        "error": null<br/>    }<br/>}</span></pre><p id="cbfc" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">正如你所看到的价格将在<code class="fe mn mo mp mq b">data["quoteResponse"]["result"][0]["regularMarketPrice"]</code>下，你也可以在那里找到日期，以及许多其他有用的信息。</p><p id="0827" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">让我们一起包装它。</p><figure class="mc md me mf gt ju"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="ee11" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">结果将会是:</p><figure class="mc md me mf gt ju gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/681eb20405e11a74f98899350ddee21f.png" data-original-src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*hqM3-YFDN3wTbqge2KIMBQ.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">耶！有用的webhook集成。</figcaption></figure><p id="9151" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">这里我们几乎完成了，我们需要的是与crontab的最终集成。</p><p id="17e5" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">去你的终端，我们需要运行一些命令。首先，我们需要使脚本可执行:</p><p id="4357" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated"><code class="fe mn mo mp mq b">chmod +x webhookcall.py</code></p><p id="7e35" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">其次，我们需要更新crontab:</p><p id="f6dd" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated"><code class="fe mn mo mp mq b">crontab -e</code></p><p id="052c" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">您应该将下面一行放入crontab配置中:</p><pre class="mc md me mf gt nc mq nd ne aw nf bi"><span id="e377" class="ng kg it mq b gy nh ni l nj nk">*/10 * * * * /path/to/your/webhook/file.py</span></pre><p id="faad" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">保存更改并观察奇迹是如何发生的。</p><p id="ce9f" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">如果你不熟悉crontab的设置，可以看看这个:【https://crontab.guru/every-10-minutes T2】</p><h1 id="7e95" class="kf kg it bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">可能的扩展</h1><p id="9f13" class="pw-post-body-paragraph ld le it lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma im bi translated">你可以想象这里有很多用例及扩展，比如:</p><ul class=""><li id="82d6" class="nm nn it lf b lg mh lk mi lo no ls np lw nq ma nr ns nt nu bi translated">更改输出—例如，脚本可以向您发送电子邮件(或发送给其他人)。</li><li id="e21e" class="nm nn it lf b lg nv lk nw lo nx ls ny lw nz ma nr ns nt nu bi translated">改变数据来源，它不需要是股票价格，例如，我从时间跟踪工具收集数据，并使用相同的方法在松弛通道上呈现摘要。</li><li id="9830" class="nm nn it lf b lg nv lk nw lo nx ls ny lw nz ma nr ns nt nu bi translated">越来越多你已经付费购买的工具拥有API访问权限，所以如果有些东西很难找到或者以一种你不满意的方式呈现，你可以写你自己的解决方案。</li><li id="fbbf" class="nm nn it lf b lg nv lk nw lo nx ls ny lw nz ma nr ns nt nu bi translated">您可以尝试宽松的消息格式，例如，对于BTC价格，当价格上涨时，您可以将其显示为绿色，否则显示为红色。</li></ul><p id="19f4" class="pw-post-body-paragraph ld le it lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma im bi translated">感谢阅读。</p></div></div>    
</body>
</html>