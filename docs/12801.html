<html>
<head>
<title>Kafka Primer for Docker: How to setup Kafka, start messaging and monitor broker metrics in Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker的Kafka初级读本:如何在Docker中设置Kafka、启动消息传递和监控代理指标</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/kafka-primer-for-docker-how-to-setup-kafka-start-messaging-and-monitor-broker-metrics-in-docker-b4e018e205d1?source=collection_archive---------6-----------------------#2022-07-11">https://levelup.gitconnected.com/kafka-primer-for-docker-how-to-setup-kafka-start-messaging-and-monitor-broker-metrics-in-docker-b4e018e205d1?source=collection_archive---------6-----------------------#2022-07-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7581" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章的重点是如何在docker环境中设置Kafka，我们在从Docker主机或远程机器连接到Kafka时经常犯的错误，以及如何通过Prometheus和Grafana监控Kafka指标。</p><h1 id="7c26" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated"><strong class="ak">概述</strong></h1><p id="7c34" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">Kafka是一个高度可用的分布式消息传递系统，设计为一个事件流平台。Docker是一个用于运行容器的应用容器化平台。Kafka可以作为docker服务运行，并通过监听器公开，这允许客户端与Kafka通信。</p><h1 id="b7e6" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">卡夫卡听众</h1><p id="6b39" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">有两种类型的监听器，我们需要从Docker的角度来理解。第一，<strong class="jp ir"> <em class="lo">听者，</em> </strong>是卡夫卡绑定的界面。这是为在docker上连接的客户准备的。其次，<strong class="jp ir"> <em class="lo"> ADVERTISED_LISTENERS，</em> </strong>是外部客户端如何连接到Kafka，这是针对在Docker机器外部连接的客户端。在下图中，监听器<em class="lo"> A </em>充当内部监听器，并向Docker主机上运行的客户端公开Kafka。监听器<em class="lo"> B </em>充当外部监听器，允许从Docker主机外部到远程客户端的Kafka连接。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/948e1bfcbc0313e34c8e264bf4dbfaae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V83dSwtI_HYtekCOzwXFdg.jpeg"/></div></div></figure><h1 id="3188" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">作为码头集装箱的卡夫卡</h1><p id="ae98" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">下面是一个将Kafka设置为Docker容器的标准示例。我们必须声明两个服务，一个是<em class="lo"> kafka </em>，另一个是<em class="lo"> zookeeper </em>，因为kafka依赖zookeeper进行元数据和领导者选举。我们对卡夫卡使用融合的图像。让我们看看每个属性。</p><blockquote class="mb mc md"><p id="f8ce" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">港口——向外界展示卡夫卡服务。</p><p id="5e95" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">图像— docker图像URL</p><p id="d565" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">代理id——代表Kafka代理实例的符号id。</p><p id="712e" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">动物园管理员连接—动物园管理员连接</p><p id="2d08" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">listeners —具有主机/IP和端口的监听器集，Kafka代理绑定到这些监听器进行监听。</p><p id="92e2" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">广告侦听器—一组侦听器及其主机/IP和端口，客户端将使用它们从内部或外部连接到代理。</p><p id="37f4" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">侦听器安全协议映射—为每个侦听器名称定义要使用的安全协议的键/值对。(SSL或无SSL)</p><p id="1ea7" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">代理间侦听器名称—代理内部用于连接的侦听器。</p></blockquote><pre class="lq lr ls lt gt mh mi mj mk aw ml bi"><span id="86fb" class="mm km iq mi b gy mn mo l mp mq"><em class="lo">services:<br/>  kafka:<br/>    ports:<br/>      - </em><strong class="mi ir"><em class="lo">29094:29092</em></strong><em class="lo"><br/>    image: confluentinc/cp-kafka:latest<br/>    environment:<br/>      KAFKA_BROKER_ID: 1<br/>      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181<br/>      </em><strong class="mi ir"><em class="lo">KAFKA_LISTENERS: PLAINTEXT://:9092,PLAINTEXT_HOST://:29092</em></strong><em class="lo"><br/>      </em><strong class="mi ir"><em class="lo">KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://127.0.0.1:29094</em></strong><em class="lo"><br/>      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT<br/>      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT<br/>      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1   <br/>    networks:<br/>      - kafka<br/>    depends_on:<br/>      - zookeeper<br/>  zookeeper:<br/>    ports:<br/>      - 32181:2181<br/>    environment:<br/>      ZOOKEEPER_CLIENT_PORT: 2181<br/>      ZOOKEEPER_TICK_TIME: 2000<br/>    image: confluentinc/cp-zookeeper:latest<br/>    networks:<br/>      - kafka<br/>networks:<br/>  kafka:<br/>    external: false</em></span></pre><p id="99c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了上面的配置，我们可以在支持Docker的机器上运行Kafka作为Docker服务。将上述文件另存为kafka.yml，并运行以下命令:</p><pre class="lq lr ls lt gt mh mi mj mk aw ml bi"><span id="590d" class="mm km iq mi b gy mn mo l mp mq"><em class="lo">---&gt; run<br/>docker-compose -f kafka.yml up -d</em></span><span id="537f" class="mm km iq mi b gy mr mo l mp mq"><em class="lo">---&gt; status<br/>docker-compose -f kafka.yml ps</em></span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ms"><img src="../Images/ebaeb41d82da5bc098bb96f2ef846ecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BCkoiMkssZSZJ50WHdRDEA.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">作为码头工人服务的卡夫卡</figcaption></figure><h1 id="fbde" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">与Kafka的客户端连接</h1><p id="e5e6" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">Kafka客户可能在经纪人网络的本地，也可能不在本地，正如前面所描述的，这就是听众发挥重要作用的地方。当连接上时，每个监听器将报告可以到达的地址。到达经纪人的地址取决于所使用的网络。如果您从内部网络连接到代理，那么它将是与外部连接时不同的主机/IP。基本上会出现三种情况:</p><ol class=""><li id="5474" class="mx my iq jp b jq jr ju jv jy mz kc na kg nb kk nc nd ne nf bi translated"><strong class="jp ir">Docker网络内的客户端</strong>—Docker网络内的客户端<em class="lo">使用监听器<em class="lo">明文</em>连接，端口<em class="lo"> 9092 </em>，主机名为<em class="lo"> kafka </em>。每个Docker容器将使用Docker的内部网络解析<em class="lo"> kafka </em>，并能够到达代理。客户端用来连接的引导服务器将是<em class="lo">【Kafka:9092】</em></em></li><li id="d897" class="mx my iq jp b jq ng ju nh jy ni kc nj kg nk kk nc nd ne nf bi translated"><strong class="jp ir">Docker网络外部但在同一Docker主机</strong>上的客户端<em class="lo">—客户端使用监听器<em class="lo"> PLAINTEXT_HOST </em>连接，端口<em class="lo"> 29092 </em>，主机名<em class="lo"> localhost </em>。端口29092由Docker容器公开，因此可以连接。客户端用来连接的引导服务器将是<em class="lo">【localhost:29092】</em></em></li><li id="2b3f" class="mx my iq jp b jq ng ju nh jy ni kc nj kg nk kk nc nd ne nf bi translated"><strong class="jp ir">Docker网络外部的客户端<em class="lo">和Docker主机— </em></strong>客户端使用监听器<em class="lo"> PLAINTEXT_HOST </em>连接，端口<em class="lo"> 29094 </em>，主机名<em class="lo"> localhost </em>。端口29094由Docker容器向外部客户端公开，并且端口被映射。请注意，为了访问它，您还需要在客户机上的putty中进行端口映射，这需要解析到这个docker主机。客户端用于连接的引导服务器将是[ <em class="lo"> localhost:29094]。</em></li></ol><h1 id="c86a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">端口映射(外部远程客户端)</h1><p id="3823" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">正如这里提到的，如果你看到如下描述的消息，大多数情况下我们确实会出错。首先，请确保Kafka代理正在运行，并检查日志以确保Kafka服务器成功启动。其次，如果您从远程客户机进行连接，那么请确保在连接隧道中更新端口映射，在连接隧道中，您已经将引导服务器端口映射到运行Kafka服务的docker-machine。例如，假设您的Docker机器IP是<em class="lo">62.96.231.219</em>，Kafka服务在端口29094上公开，然后在远程客户端机器上，将端口<em class="lo"> 29094 </em>映射到<em class="lo">62.96.239.219:29094，</em>，然后客户端可以通过引导服务器<em class="lo"> localhost:29094连接到Kafka。</em></p><blockquote class="mb mc md"><p id="0e3d" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">无法建立连接。经纪人可能不在。</p></blockquote><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nl"><img src="../Images/81f348570a3944328da08dd4b3508af4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8UzjGh_GBj92KqQvqjh9gQ.png"/></div></div></figure><h1 id="8f12" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">度量和监控</h1><p id="cfbd" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">可以使用prometheus和grafana监控Kafka经纪人。我们将使用JMX导出器向普罗米修斯展示Kafka的指标，然后在Grafana仪表板上显示这些指标。JMX导出器充当收集器，通过HTTP端点公开Kafka指标，然后可以被任何系统(如Prometheus)使用。</p><p id="ba44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经添加了<em class="lo"> EXTRA_ARGS </em>来使用JMX exporter来暴露Kafka指标，并添加了端口映射来暴露相同的指标供普罗米修斯目标使用。JMX出口商同样需要广口瓶。我们还需要提供Kafka度量配置(kafka-broker.yaml ),以便公开所需的度量。</p><p id="6b00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更新了docker-compose:(暴露了指标)</p><pre class="lq lr ls lt gt mh mi mj mk aw ml bi"><span id="fa7d" class="mm km iq mi b gy mn mo l mp mq"><em class="lo">services:<br/>  kafka:<br/>    logging:      <br/>      driver: local<br/>    ports:<br/>      - 29094:29092<br/>      - </em><strong class="mi ir"><em class="lo">29103:29101</em></strong><em class="lo"><br/>    image: confluentinc/cp-kafka:latest<br/>    environment:<br/>      KAFKA_BROKER_ID: 1<br/>      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181<br/>      KAFKA_LISTENERS: PLAINTEXT://:9092,PLAINTEXT_HOST://:29092<br/>      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://127.0.0.1:29094<br/>      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT<br/>      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT<br/>      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 <br/>      </em><strong class="mi ir"><em class="lo">EXTRA_ARGS: -javaagent:/usr/share/jmx_exporter/jmx_prometheus_javaagent-0.17.0.jar=29101:/usr/share/jmx_exporter/kafka-broker.yaml </em></strong><em class="lo"> <br/>    networks:<br/>      - kafka<br/>    </em><strong class="mi ir"><em class="lo">volumes:      <br/>      - ./jmx-exporter:/usr/share/jmx_exporter/      <br/>      - kafka-jmx-volume:/jmx-exporter</em></strong><em class="lo"><br/>    depends_on:<br/>      - zookeeper<br/>  zookeeper:<br/>    ports:<br/>      - 32181:2181<br/>    environment:<br/>      ZOOKEEPER_CLIENT_PORT: 2181<br/>      ZOOKEEPER_TICK_TIME: 2000<br/>    image: confluentinc/cp-zookeeper:latest<br/>    networks:<br/>      - kafka<br/>volumes:  <br/>  </em><strong class="mi ir"><em class="lo">kafka-jmx-volume:</em></strong><em class="lo"><br/>networks:<br/>  kafka:<br/>    external: false</em></span></pre><p id="b93a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将文件更新并保存为kafka.yml，然后运行以下命令:</p><pre class="lq lr ls lt gt mh mi mj mk aw ml bi"><span id="94b2" class="mm km iq mi b gy mn mo l mp mq"><em class="lo">---&gt; run<br/>docker-compose -f kafka.yml up -d</em></span><span id="ce02" class="mm km iq mi b gy mr mo l mp mq"><em class="lo">---&gt; status<br/>docker-compose -f kafka.yml ps</em></span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nm"><img src="../Images/936be865fd6924ce188149e3e47ab921.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n3Yk9cErswq9nm4bPrG7Lg.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">作为码头工人服务的卡夫卡、普罗米修斯和格拉法纳</figcaption></figure><blockquote class="mb mc md"><p id="9b6f" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">卡夫卡指数可以在:<a class="ae nn" href="http://localhost:29103/metrics" rel="noopener ugc nofollow" target="_blank">http://localhost:29103/metrics</a>找到</p><p id="d09d" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">普罗米修斯可以在:<a class="ae nn" href="http://localhost:9090/graph" rel="noopener ugc nofollow" target="_blank">http://localhost:9090/graph</a>找到</p><p id="a4a2" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">可以通过<a class="ae nn" href="http://localhost:3000/login" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/log in</a>(Kafka/Kafka)联系到Grafana</p></blockquote><p id="7d8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果Kafka metrics endpoint成功启动，并且Prometheus目标可以抓取它，它应该如下所示:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi no"><img src="../Images/a806fe03083c8f2f3354699541a5bcde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1XIXckKKYIeZ8H4bsPmxjw.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">暴露于普罗米修斯的卡夫卡式的度量</figcaption></figure><p id="ec6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kafka集群的Grafana仪表板:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi np"><img src="../Images/f43cadb27278ee27bd84d5459e1d9d2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D0_vnHyOB9VqC7VnOJsGUA.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">Kafka集群仪表板</figcaption></figure><p id="7999" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置普罗米修斯和格拉夫纳的详细配置可以在这里找到:</p><blockquote class="mb mc md"><p id="b289" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">https://github . com/RoHS in 47/Kafka-docker-kubernetes/tree/main/docker</p></blockquote><h1 id="344e" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">参考资料:</h1><div class="nq nr gp gr ns nt"><a href="https://www.confluent.io/blog/kafka-listeners-explained/" rel="noopener  ugc nofollow" target="_blank"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd ir gy z fp ny fr fs nz fu fw ip bi translated">卡夫卡听众-解释|汇合</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">您需要将advertised.listeners(或者KAFKA_ADVERTISED_LISTENERS，如果您使用Docker图像的话)设置为外部…</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">www.confluent.io</p></div></div><div class="oc l"><div class="od l oe of og oc oh lz nt"/></div></div></a></div><div class="nq nr gp gr ns nt"><a href="https://github.com/confluentinc/jmx-monitoring-stacks/tree/6.1.0-post/jmxexporter-prometheus-grafana" rel="noopener  ugc nofollow" target="_blank"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd ir gy z fp ny fr fs nz fu fw ip bi translated">JMX-monitoring-stacks/JMX exporter-Prometheus-grafana at 6 . 1 . 0-post…</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">Kafka要输出配额指标，至少需要一个配额配置。</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">github.com</p></div></div><div class="oc l"><div class="oi l oe of og oc oh lz nt"/></div></div></a></div></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><h1 id="29fb" class="kl km iq bd kn ko oq kq kr ks or ku kv kw os ky kz la ot lc ld le ou lg lh li bi translated">分级编码</h1><p id="ed1c" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">感谢您成为我们社区的一员！更多内容见<a class="ae nn" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>。<br/>跟随:<a class="ae nn" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a>，<a class="ae nn" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">领英</a>，<a class="ae nn" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">通迅</a> <br/> <strong class="jp ir">升一级正在改造理工大招聘➡️ </strong> <a class="ae nn" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">加入我们的人才集体</strong> </a></p></div></div>    
</body>
</html>