<html>
<head>
<title>My Google Run Cloud Build Setup for my Laravel app — migration + PostgreSQL and Secret ENV</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我的Laravel应用程序的Google Run云构建设置——migration+PostgreSQL和Secret ENV</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/my-google-run-cloud-build-setup-for-my-laravel-app-migration-postgresql-and-secret-env-79ce8b00a9b5?source=collection_archive---------9-----------------------#2022-12-16">https://levelup.gitconnected.com/my-google-run-cloud-build-setup-for-my-laravel-app-migration-postgresql-and-secret-env-79ce8b00a9b5?source=collection_archive---------9-----------------------#2022-12-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/401822219d161f273ebd34488439ef99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zrv12Ug3-jJ4MThv"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@wocintechchat?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯蒂娜@ wocintechchat.com</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="0dab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个故事是为那些已经在搜索如何使用Google Run Cloud Build使他们的Laravel应用程序工作的例子和提示的人准备的，包括如何设置PostgreSQL(因为大多数例子都是在MySQL:()中)，同时还想在构建过程中处理迁移。如果是你，我想我可以给你提供我个人的cloudbuild.yaml，可能还会帮你做好自己的设置。</p><p id="77d3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我假设您已经在Google Cloud-Cloud Run中部署了Laravel应用程序的最简单设置，这包括您已经有了一个生产docker文件，已经初步创建了Google Cloud Run服务，或者至少已经遵循了这个<a class="ae kc" href="https://www.youtube.com/watch?v=KCWGJV3x1Rs" rel="noopener ugc nofollow" target="_blank">视频教程</a>，因为我只想处理和分享部署的云构建部分。</p><p id="131d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是:</p><pre class="lb lc ld le gt lf lg lh bn li lj bi"><span id="884f" class="lk ll iq lg b be lm ln l lo lp">steps:<br/>  - name: gcr.io/cloud-builders/docker<br/>    args:<br/>      - build<br/>      - '--no-cache'<br/>      - '-t'<br/>      - '$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'<br/>      - .<br/>      - '-f'<br/>      - Dockerfile<br/>    id: Build<br/>    <br/>  - name: gcr.io/cloud-builders/docker<br/>    args:<br/>      - push<br/>      - '$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'<br/>    id: Push<br/><br/>  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'<br/>    args:<br/>      - run<br/>      - services<br/>      - update<br/>      - $_SERVICE_NAME<br/>      - '--platform=managed'<br/>      - '--image=$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'<br/>      - &gt;-<br/>        --labels=managed-by=gcp-cloud-build-deploy-cloud-run,commit-sha=$COMMIT_SHA,gcb-build-id=$BUILD_ID,gcb-trigger-id=$_TRIGGER_ID,$_LABELS<br/>      - '--region=$_DEPLOY_REGION'<br/>      - '--quiet'<br/>    id: Deploy<br/>    entrypoint: gcloud<br/><br/>  - name: 'gcr.io/google-appengine/exec-wrapper'<br/>    entrypoint: 'bash'<br/>    args:<br/>      - -c<br/>      - |<br/>        /buildstep/execute.sh \<br/>        -i $_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA \<br/>        -e DB_CONNECTION=$_DB_CONNECTION \<br/>        -e DB_SOCKET=$$DB_HOST \<br/>        -e DB_HOST=$$DB_HOST \<br/>        -e CLOUD_SQL_CONNECTION_NAME=$_INSTANCE_CONNECTION_NAME \<br/>        -e DB_DATABASE=$$DB_DATABASE \<br/>        -e DB_USERNAME=$$DB_USERNAME \<br/>        -e DB_PASSWORD=$$DB_PASSWORD <br/>        -s $_INSTANCE_CONNECTION_NAME \<br/>        -- php /app/artisan migrate --force<br/>    secretEnv: ['DB_PASSWORD', 'DB_DATABASE', 'DB_USERNAME', 'DB_HOST'] <br/>    waitFor:<br/>      - Build<br/>      - Push<br/>      - Deploy<br/>    id: Migrate<br/><br/>availableSecrets:<br/>  secretManager:<br/>    - versionName: projects/$_PROJECT_NUMBER/secrets/db_password/versions/2<br/>      env: 'DB_PASSWORD'<br/>    - versionName: projects/$_PROJECT_NUMBER/secrets/db_username/versions/1<br/>      env: 'DB_USERNAME'<br/>    - versionName: projects/$_PROJECT_NUMBER/secrets/db_database/versions/1<br/>      env: 'DB_DATABASE'<br/>    - versionName: projects/$_PROJECT_NUMBER/secrets/db_host/versions/1<br/>      env: 'DB_HOST'<br/><br/>timeout: 1200s<br/>images:<br/>  - '$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'<br/>options:<br/>  substitutionOption: ALLOW_LOOSE<br/>tags:<br/>  - gcp-cloud-build-deploy-cloud-run<br/>  - gcp-cloud-build-deploy-cloud-run-managed<br/>  - prod_deployment</span></pre><p id="7107" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以在我的cloudbuild.yaml中，有4个步骤——构建-&gt;推送-&gt;部署-&gt;迁移。你可能注意到了，这些步骤非常简单。前三个是部署主应用程序的主要步骤，包括构建容器映像(Dockerfile)，然后将映像推送到容器注册表，然后将容器映像部署到云运行。但是，我们最感兴趣的是迁移步骤，我们将在下面进一步讨论。</p><h1 id="f42e" class="lq ll iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">迁移步骤</h1><p id="57e4" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">迁移步骤使用App Engine exec包装器，这将帮助我们在云构建作业期间向数据库运行命令。与其他步骤相同，该作业将在使用<strong class="kf ir">云构建触发器</strong>在源代码控制中更新项目代码时自动运行。</p><p id="7328" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这一步的<code class="fe ms mt mu lg b">entrypoint</code>需要使用<code class="fe ms mt mu lg b">bash</code>,因为我们使用了exec包装器的<code class="fe ms mt mu lg b">/buildstep/execute.sh</code>脚本。然后，我们添加了我们最近构建的图像的URL<code class="fe ms mt mu lg b">-i $_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA</code>，并提供了所有带有<code class="fe ms mt mu lg b">e</code>选项的图像的PostgreSQL数据库连接所需的连接细节。还注意到<code class="fe ms mt mu lg b">CLOUD_SQL_CONNECTION_NAME</code>是必需的，你可以在使用云SQL服务时获得。添加完所有必需的选项后，我们运行laravel的迁移命令— <code class="fe ms mt mu lg b">-- php /app/artisan migrate — force</code>。</p><p id="4e2a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你也可以注意到，我们已经定义了<code class="fe ms mt mu lg b">secretEnv</code>。将这些信息作为秘密提供是可选的，但是非常推荐。Google有一个我们也可以使用的secret manager服务，你必须将这些数据库信息添加到你自己的Secret Manager中，这样你才能在云构建中使用它们(参见这个<a class="ae kc" href="https://cloud.google.com/run/docs/configuring/secrets" rel="noopener ugc nofollow" target="_blank">文档</a>，了解如何使用)。对于我的云构建，我选择使用它们。在迁移步骤中访问这些环境变量之前，我们需要在yaml中将它们定义为<code class="fe ms mt mu lg b">availableSecrets</code>选项。当您已经在Secret manager中设置了环境变量并在Google Run中设置了部署时，您可以检索这些版本名称。还要记住，在步骤部分访问secretEnv时，需要双美元符号。</p><p id="dc8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu lg b">waitFor</code>选项用于确保迁移步骤只在前3个步骤完成后才运行。</p><p id="a88a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我想这就是迁移步骤！</p><h2 id="9e41" class="mv ll iq bd lr mw mx dn lv my mz dp lz ko na nb md ks nc nd mh kw ne nf ml ng bi translated">额外提示！</h2><p id="9262" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">您在应用程序中需要的所有环境变量都可以在Google Run部署管理器中定义(参见<a class="ae kc" href="https://cloud.google.com/run/docs/configuring/environment-variables" rel="noopener ugc nofollow" target="_blank">文档</a>)。这些变量可以在云构建中使用<code class="fe ms mt mu lg b">$_</code>和变量名直接访问。但是，您可能想知道如何在迁移脚本中传递或访问环境变量。嗯，你可以简单地将它们添加为另一个<code class="fe ms mt mu lg b">e</code>选项，比如说<code class="fe ms mt mu lg b"> e APP_URL=$_APP_URL \</code>，然后在你的脚本中使用一个Laravel方法，比如<code class="fe ms mt mu lg b">env(‘APP_URL’)</code>或者<code class="fe ms mt mu lg b">config(‘APP_URL’)</code>，如果它是在你的配置中定义的话。</p><p id="bf1a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我想，我可能漏掉了一些你可能还不清楚的地方，请随意添加评论或问题。</p><p id="8eef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nh">如果你喜欢这篇文章并想表达爱意，如果你能……</em>那就太棒了</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><a href="https://www.buymeacoffee.com/dxcgrl"><div class="gh gi ni"><img src="../Images/c439ed2101f75de0f04c6b1910db7338.png" data-original-src="https://miro.medium.com/v2/resize:fit:464/format:webp/1*y5hX5SLEQ_G6x3ID_iA3jg.png"/></div></a></figure></div></div>    
</body>
</html>