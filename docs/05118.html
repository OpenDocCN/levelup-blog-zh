<html>
<head>
<title>Introduction to orjson</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">orjson简介</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/introduction-to-orjson-3d06dde79208?source=collection_archive---------6-----------------------#2020-08-05">https://levelup.gitconnected.com/introduction-to-orjson-3d06dde79208?source=collection_archive---------6-----------------------#2020-08-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="c0bf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一个替代的Python JSON库，支持数据类、日期时间和numpy</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/a84412bdb7f9f52407aacb3a2999316c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LNIQ-nr-F_GzNbRWZB7PdQ.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@iammrcup?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">杯先生/杨奇煜·巴勒</a>在<a class="ae le" href="https://unsplash.com/s/photos/file?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="9535" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">今天的主题是优化Python应用程序中的JSON序列化和反序列化。如果您经常使用内置的<code class="fe lf lg lh li b">json</code>模块，并且希望提高应用程序的性能或每秒事务处理量，那么您应该考虑使用<code class="fe lf lg lh li b">orjson</code>模块。根据<a class="ae le" href="https://github.com/ijl/orjson" rel="noopener ugc nofollow" target="_blank">官方文件</a> , <code class="fe lf lg lh li b">orjson</code>是</p><blockquote class="lj lk ll"><p id="9c2b" class="jq jr lm js b jt ju jv jw jx jy jz ka ln kc kd ke lo kg kh ki lp kk kl km kn im bi translated">“…一个快速而正确的Python JSON库，本机支持数据类、日期时间和数字”</p></blockquote><p id="0935" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们来看看与其他Python JSON库相比的优缺点。</p><ul class=""><li id="49ac" class="lq lr it js b jt ju jx jy kb ls kf lt kj lu kn lv lw lx ly bi translated">序列化数据类</li><li id="114e" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated">本机序列化日期时间对象，numpy.ndarry，UUID</li><li id="da68" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated">序列化为字节而不是字符串</li><li id="c534" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated">序列化字符串而不将unicode转义为ASCII</li><li id="07a3" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated">具有严格的UTF-8和JSON格式一致性</li><li id="a139" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated">序列化和反序列化的速度要快得多</li><li id="e0ee" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated">不提供<code class="fe lf lg lh li b">load()</code>或<code class="fe lf lg lh li b">dump()</code>函数来读取/写入类似文件的对象</li></ul><p id="cf71" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们继续下一部分，开始安装必要的模块</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="40f7" class="ml mm it bd mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni bi translated">设置</h1><h2 id="71e8" class="nj mm it bd mn nk nl dn mr nm nn dp mv kb no np mz kf nq nr nd kj ns nt nh nu bi translated">基本安装</h2><p id="ae53" class="pw-post-body-paragraph jq jr it js b jt nv jv jw jx nw jz ka kb nx kd ke kf ny kh ki kj nz kl km kn im bi translated">强烈建议您在继续安装之前创建一个虚拟环境。您可以通过<code class="fe lf lg lh li b">pip install</code>轻松安装<code class="fe lf lg lh li b">orjson</code>。在您的终端上运行以下命令:</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="7546" class="nj mm it li b gy oe of l og oh">pip install orjson</span></pre><h2 id="f3b1" class="nj mm it bd mn nk nl dn mr nm nn dp mv kb no np mz kf nq nr nd kj ns nt nh nu bi translated">升级现有包</h2><p id="12bc" class="pw-post-body-paragraph jq jr it js b jt nv jv jw jx nw jz ka kb nx kd ke kf ny kh ki kj nz kl km kn im bi translated">如果您已经有一个现有的<code class="fe lf lg lh li b">orjson</code>包，并且想要升级它，运行下面的命令</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="aa7f" class="nj mm it li b gy oe of l og oh">pip install -U orjson</span></pre></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="8652" class="ml mm it bd mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni bi translated">履行</h1><h2 id="070c" class="nj mm it bd mn nk nl dn mr nm nn dp mv kb no np mz kf nq nr nd kj ns nt nh nu bi translated">导入</h2><p id="9161" class="pw-post-body-paragraph jq jr it js b jt nv jv jw jx nw jz ka kb nx kd ke kf ny kh ki kj nz kl km kn im bi translated">在Python文件的顶部添加以下导入声明。</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="17cb" class="nj mm it li b gy oe of l og oh">import orjson</span></pre><h2 id="fe4d" class="nj mm it bd mn nk nl dn mr nm nn dp mv kb no np mz kf nq nr nd kj ns nt nh nu bi translated">序列化和反序列化</h2><p id="c116" class="pw-post-body-paragraph jq jr it js b jt nv jv jw jx nw jz ka kb nx kd ke kf ny kh ki kj nz kl km kn im bi translated">让我们看看下面的例子，它序列化和反序列化字符串、列表和字典。</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="ff49" class="nj mm it li b gy oe of l og oh">data = {<br/>"emoji_tears": "😂",<br/>"emoji_clock": "⏰",<br/>"integer": 123,<br/>"float": 10.4,<br/>"boolean": False,<br/>"list": ["element1", "element2"],<br/>"dict": {"key1": "value1", "key2": "value2"},<br/>"russian": "Привет",<br/>"chinese": "您好",<br/>"japanese": "こんにちは"<br/>}</span><span id="740c" class="nj mm it li b gy oi of l og oh"># serialize, returns byte instead of string<br/>json_byte = orjson.dumps(data)</span><span id="dfb8" class="nj mm it li b gy oi of l og oh"># de-serialize<br/>orjson.loads(json_byte)</span></pre><p id="d698" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于序列化，可以指定以下输入参数:</p><ul class=""><li id="a5b6" class="lq lr it js b jt ju jx jy kb ls kf lt kj lu kn lv lw lx ly bi translated"><code class="fe lf lg lh li b">default</code> —返回支持类型的可调用函数。可用于序列化子类或任意类型。此外，您可以通过引发一个像<code class="fe lf lg lh li b">TypeError</code>这样的异常来执行一个规则来处理不支持的日期类型。</li><li id="08ec" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated"><code class="fe lf lg lh li b">option</code> —通过<code class="fe lf lg lh li b">orjson</code>中整数常量修改数据的序列化方式。</li></ul><h2 id="f621" class="nj mm it bd mn nk nl dn mr nm nn dp mv kb no np mz kf nq nr nd kj ns nt nh nu bi translated">默认</h2><p id="9943" class="pw-post-body-paragraph jq jr it js b jt nv jv jw jx nw jz ka kb nx kd ke kf ny kh ki kj nz kl km kn im bi translated">让我们来看看下面的例子，如果输入数据包含<code class="fe lf lg lh li b">Decimal</code>数据类型，这个例子会产生一个错误。</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="6fcc" class="nj mm it li b gy oe of l og oh">import decimal</span><span id="93b9" class="nj mm it li b gy oi of l og oh">orjson.dumps(decimal.Decimal("3.141592653"))</span></pre><p id="3cbc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">运行它时，您将得到以下输出</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="7d42" class="nj mm it li b gy oe of l og oh">TypeError: Type is not JSON serializable. decimal.Decimal</span></pre><p id="fae5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了支持<code class="fe lf lg lh li b">Decimal</code>序列化，您需要创建一个可调用的函数或lambda，并将其作为<code class="fe lf lg lh li b">default</code>参数传递。</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="3072" class="nj mm it li b gy oe of l og oh">import decimal</span><span id="967d" class="nj mm it li b gy oi of l og oh">def default(obj):<br/>    if isinstance(obj, decimal.Decimal):<br/>        return str(obj)<br/>    raise TypeError</span><span id="645f" class="nj mm it li b gy oi of l og oh">orjson.dumps(decimal.Decimal("3.141592653"), default=default)</span></pre><h2 id="6827" class="nj mm it bd mn nk nl dn mr nm nn dp mv kb no np mz kf nq nr nd kj ns nt nh nu bi translated">[计]选项</h2><p id="b5b0" class="pw-post-body-paragraph jq jr it js b jt nv jv jw jx nw jz ka kb nx kd ke kf ny kh ki kj nz kl km kn im bi translated"><code class="fe lf lg lh li b">option</code>参数决定序列化方法。让我们来看看下面序列化<code class="fe lf lg lh li b">datetime</code>对象和<code class="fe lf lg lh li b">numpy.array</code>的代码。</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="3d7d" class="nj mm it li b gy oe of l og oh">import orjson<br/>import datetime<br/>import numpy as np</span><span id="3223" class="nj mm it li b gy oi of l og oh">data = {<br/>"datetime": datetime.datetime.now(),<br/>"numpy": np.array([[1, 2], [3, 4]])<br/>}</span><span id="7d04" class="nj mm it li b gy oi of l og oh">json_byte = orjson.dumps(data, option=orjson.OPT_NAIVE_UTC | orjson.OPT_SERIALIZE_NUMPY)</span><span id="d9fc" class="nj mm it li b gy oi of l og oh">orjson.loads(json_byte)</span></pre><p id="7366" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面的列表包含了一些最常用的整型常量:</p><ul class=""><li id="7497" class="lq lr it js b jt ju jx jy kb ls kf lt kj lu kn lv lw lx ly bi translated"><code class="fe lf lg lh li b">OPT_APPEND_NEWLINE</code> —将<code class="fe lf lg lh li b">\n</code>追加到输出中。</li><li id="908b" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated"><code class="fe lf lg lh li b">OPT_INDENT_2</code> —漂亮的打印输出，缩进两个空格。</li><li id="8bac" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated"><code class="fe lf lg lh li b">OPT_NAIVE_UTC </code> —将不带<code class="fe lf lg lh li b">tzinfo</code>的<code class="fe lf lg lh li b">datetime.datetime</code>对象序列化为UTC。这对设置了<code class="fe lf lg lh li b">tzinfo</code>的<code class="fe lf lg lh li b">datetime.datetime</code>对象没有影响。</li><li id="d849" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated"><code class="fe lf lg lh li b">OPT_NON_STR_KEYS</code> —序列化字符串以外类型的字典键。对于字符串键，此选项比默认选项慢。</li><li id="ed82" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated"><code class="fe lf lg lh li b">OPT_OMIT_MICROSECONDS</code> —不序列化<code class="fe lf lg lh li b">datetime.datetime</code>和<code class="fe lf lg lh li b">datetime.time</code>实例上的微秒字段。</li><li id="1054" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated"><code class="fe lf lg lh li b">OPT_SERIALIZE_NUMPY</code> —序列化<code class="fe lf lg lh li b">numpy.ndarray</code>实例。</li><li id="9bb2" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated"><code class="fe lf lg lh li b">OPT_SORT_KEYS</code> —按排序顺序对字典键进行序列化。默认情况下，以未指定的顺序进行序列化。</li><li id="340f" class="lq lr it js b jt lz jx ma kb mb kf mc kj md kn lv lw lx ly bi translated"><code class="fe lf lg lh li b">OPT_STRICT_INTEGER </code> —对整数实施53位限制，而不是标准的64位。Q</li></ul><h2 id="9ada" class="nj mm it bd mn nk nl dn mr nm nn dp mv kb no np mz kf nq nr nd kj ns nt nh nu bi translated">数据类</h2><p id="3370" class="pw-post-body-paragraph jq jr it js b jt nv jv jw jx nw jz ka kb nx kd ke kf ny kh ki kj nz kl km kn im bi translated">供您参考，<code class="fe lf lg lh li b">orjson</code>将<code class="fe lf lg lh li b">dataclass</code>序列化为映射，每个属性按照类定义中给定的顺序序列化。让我们看看下面的例子:</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="9f30" class="nj mm it li b gy oe of l og oh">import dataclasses, orjson, typing</span><span id="55ac" class="nj mm it li b gy oi of l og oh">@dataclasses.dataclass<br/>class Person:<br/>    id: int<br/>    name: str<br/>    status: bool = dataclasses.field(default=True)</span><span id="f93f" class="nj mm it li b gy oi of l og oh">@dataclasses.dataclass<br/>class Class:<br/>    id: int<br/>    name: str<br/>    students: typing.List[Person]</span><span id="ff56" class="nj mm it li b gy oi of l og oh">data = Class(1, "Class A", [Person(1, "John Doe", False), Person(2, "Mary Sue")])</span><span id="3b79" class="nj mm it li b gy oi of l og oh">json_byte = orjson.dumps(data)</span><span id="ecb3" class="nj mm it li b gy oi of l og oh">orjson.loads(json_byte)</span></pre><p id="eb28" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您打印出<code class="fe lf lg lh li b">json_byte</code>变量时，您应该得到以下输出。</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="7436" class="nj mm it li b gy oe of l og oh">b'{"id":1,"name":"Class A","students":[{"id":1,"name":"John Doe","status":false},{"id":2,"name":"Mary Sue","status":true}]}'</span></pre><h2 id="c080" class="nj mm it bd mn nk nl dn mr nm nn dp mv kb no np mz kf nq nr nd kj ns nt nh nu bi translated">文件读/写</h2><p id="694a" class="pw-post-body-paragraph jq jr it js b jt nv jv jw jx nw jz ka kb nx kd ke kf ny kh ki kj nz kl km kn im bi translated">您可以通过<code class="fe lf lg lh li b">write()</code>功能轻松地将字节内容正常保存到文件中。但是，您需要在模式参数中包含<code class="fe lf lg lh li b">b</code>。让我们看看下面的代码片段。</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="3ed9" class="nj mm it li b gy oe of l og oh">with open("example.json", "wb") as f:<br/>    f.write(orjson.dumps(data))</span></pre><p id="dcfc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">同样，从文件中读取数据也很简单，如下所示:</p><pre class="kp kq kr ks gt oa li ob oc aw od bi"><span id="a131" class="nj mm it li b gy oe of l og oh">with open("example.json", "rb") as f:<br/>    json_data = orjson.loads(f.read())</span></pre></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="536f" class="ml mm it bd mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni bi translated">结论</h1><p id="ac8b" class="pw-post-body-paragraph jq jr it js b jt nv jv jw jx nw jz ka kb nx kd ke kf ny kh ki kj nz kl km kn im bi translated">让我们回顾一下今天所学的内容。</p><p id="1e54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们首先简要介绍了<code class="fe lf lg lh li b">orjson</code>模块。与Python JSON库的其他部分相比，我们了解了这个模块的优点和缺点。</p><p id="df77" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们继续通过<code class="fe lf lg lh li b">pip install</code>安装它。还有一个通过<code class="fe lf lg lh li b">-U</code>输入升级现有包的选项。</p><p id="84b0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，我们通过loads和dumps函数尝试了不同的序列化和反序列化用例。为了序列化，<code class="fe lf lg lh li b">orjson</code>带有<code class="fe lf lg lh li b">default</code>和<code class="fe lf lg lh li b">option</code>参数来控制进程。</p><p id="bde1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，我们测试了如何将字节数据保存到文件中，并将其加载到Python应用程序中。</p><p id="3a86" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢你阅读这篇文章。希望在下一篇文章中再见到你！</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="e7ce" class="ml mm it bd mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni bi translated">参考</h1><ol class=""><li id="74a5" class="lq lr it js b jt nv jx nw kb oj kf ok kj ol kn om lw lx ly bi translated"><a class="ae le" href="https://github.com/ijl/orjson" rel="noopener ugc nofollow" target="_blank"> orjson Github页面</a></li></ol></div></div>    
</body>
</html>