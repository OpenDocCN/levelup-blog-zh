<html>
<head>
<title>How to load data in React with redux-thunk, redux-saga, suspense &amp; hooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用redux-thunk、redux-saga、suspense &amp; hooks在React中加载数据</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/loading-data-in-react-redux-thunk-redux-saga-suspense-hooks-666b21da1569?source=collection_archive---------0-----------------------#2019-01-31">https://levelup.gitconnected.com/loading-data-in-react-redux-thunk-redux-saga-suspense-hooks-666b21da1569?source=collection_archive---------0-----------------------#2019-01-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/548cbb86b7b9063c3effe6b55487be92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JL-AhMbl0HlP4Jr3YyaxbA.jpeg"/></div></div></figure><h1 id="372f" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">介绍</h1><p id="9dc5" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated"><a class="ae lu" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank"> React </a>是一个用于构建用户界面的JavaScript库。使用React通常意味着使用React和<a class="ae lu" href="https://redux.js.org/" rel="noopener ugc nofollow" target="_blank"> Redux </a>。<a class="ae lu" href="https://redux.js.org/" rel="noopener ugc nofollow" target="_blank"> Redux </a>是另一个用于管理全局状态的JavaScript库。遗憾的是，即使有了这两个库，也没有一种明确的方法来处理对API(后端)的异步调用或任何其他副作用。</p><p id="614d" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">在这篇文章中，我试图比较解决这个问题的不同方法。先定义一下问题。</p><p id="c4ad" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir"> <em class="ma">组件X是网站的众多组件之一(或者移动，或者桌面应用，也有可能)。x查询并显示从API加载的一些数据。x可以是页面或者只是页面的一部分。重要的是，X是一个独立的组件，应该尽可能与系统的其余部分松散耦合。x应该显示加载指示，而数据正在检索和错误，如果调用失败。</em>T9】</strong></p><p id="f8eb" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">本文假设您已经有了一些创建React/Redux应用程序的经验。</p><p id="7189" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">本文将展示解决这个问题的4种方法，并比较每种方法的优缺点。<strong class="ky ir">这不是一本关于如何使用thunk、saga、suspence或hooks </strong>的详细手册。</p><p id="8038" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">这些例子的代码可以在<a class="ae lu" href="https://github.com/ValeraT1982/react-data-load" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p><h1 id="3162" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">初始设置</h1><h2 id="897c" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">模拟服务器</h2><p id="dd29" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">出于测试目的，我们将使用<a class="ae lu" href="https://github.com/typicode/json-server" rel="noopener ugc nofollow" target="_blank"> json-server </a>。这是一个令人惊叹的项目，它允许您非常快速地构建假REST APIs。对于我们的例子，它看起来像这样。</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="d4a4" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">const jsonServer </strong>= require(<strong class="ms ir">'json-server'</strong>);<br/><strong class="ms ir">const </strong>server = <strong class="ms ir">jsonServer</strong>.create();<br/><strong class="ms ir">const </strong>router = <strong class="ms ir">jsonServer</strong>.<strong class="ms ir">router</strong>(<strong class="ms ir">'db.json'</strong>);<br/><strong class="ms ir">const </strong>middleware = <strong class="ms ir">jsonServer</strong>.<strong class="ms ir">defaults</strong>();</span><span id="04ce" class="mb jz iq ms b gy na mx l my mz">server.use((req, res, next) =&gt; {<br/>   <em class="ma">setTimeout</em>(() =&gt; next(), 2000);<br/>});<br/>server.use(middleware);<br/>server.use(router);<br/>server.listen(4000, () =&gt; {<br/>   <strong class="ms ir"><em class="ma">console</em></strong>.log(<strong class="ms ir">`JSON Server is running...`</strong>);<br/>});</span></pre><p id="acd9" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">我们的db.json文件包含json格式的测试数据。</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="406b" class="mb jz iq ms b gy mw mx l my mz">{<br/> <strong class="ms ir">"users"</strong>: [<br/>   {<br/>     <strong class="ms ir">"id"</strong>: 1,<br/>     <strong class="ms ir">"firstName"</strong>: <strong class="ms ir">"John"</strong>,<br/>     <strong class="ms ir">"lastName"</strong>: <strong class="ms ir">"Doe"</strong>,<br/>     <strong class="ms ir">"active"</strong>: <strong class="ms ir">true</strong>,<br/>     <strong class="ms ir">"posts"</strong>: 10,<br/>     <strong class="ms ir">"messages"</strong>: 50<br/>   },<br/>   ...<br/>   {<br/>     <strong class="ms ir">"id"</strong>: 8,<br/>     <strong class="ms ir">"firstName"</strong>: <strong class="ms ir">"Clay"</strong>,<br/>     <strong class="ms ir">"lastName"</strong>: <strong class="ms ir">"Chung"</strong>,<br/>     <strong class="ms ir">"active"</strong>: <strong class="ms ir">true</strong>,<br/>     <strong class="ms ir">"posts"</strong>: 8,<br/>     <strong class="ms ir">"messages"</strong>: 5<br/>   }<br/> ]<br/>}</span></pre><p id="dacd" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">启动服务器后，调用<a class="ae lu" href="http://localhost:4000/users" rel="noopener ugc nofollow" target="_blank"><em class="ma">http://localhost:4000/users</em></a>返回用户列表，延迟大约2秒。</p><h1 id="c484" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">项目和API调用</h1><p id="d1b9" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">现在我们准备开始编码。我假设您已经使用<a class="ae lu" href="https://github.com/facebook/create-react-app" rel="noopener ugc nofollow" target="_blank"> create-react-app </a>创建了一个React项目，并配置了Redux，可以使用了。</p><p id="c7cb" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">如果你有什么困难，你可以看看这个和这个。</p><p id="f481" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">下一步是创建一个函数来调用API ( <em class="ma"> api.js </em>):</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="0d9b" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">const </strong>API_BASE_ADDRESS = <strong class="ms ir">'http://localhost:4000'</strong>;</span><span id="60c7" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export default class </strong>Api {<br/>   <strong class="ms ir">static </strong><em class="ma">getUsers</em>() {<br/>       <strong class="ms ir">const </strong>uri = API_BASE_ADDRESS + <strong class="ms ir">"/users"</strong>;</span><span id="9108" class="mb jz iq ms b gy na mx l my mz">       <strong class="ms ir">return </strong><em class="ma">fetch</em>(uri, {<br/>           <strong class="ms ir">method</strong>: <strong class="ms ir">'GET'</strong><br/>       });<br/>   }<br/>}</span></pre><h1 id="9ea7" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">还原-thunk</h1><p id="46c0" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated"><a class="ae lu" href="https://github.com/reduxjs/redux-thunk" rel="noopener ugc nofollow" target="_blank"> Redux-thunk </a>是推荐用于基本Redux副作用逻辑的中间件，比如简单的异步逻辑(比如对API的请求)。Redux-thunk本身做的不多。只是<a class="ae lu" href="https://github.com/reduxjs/redux-thunk/blob/master/src/index.js" rel="noopener ugc nofollow" target="_blank"> 14！！！</a> <a class="ae lu" href="https://github.com/reduxjs/redux-thunk/blob/master/src/index.js" rel="noopener ugc nofollow" target="_blank">的</a> <a class="ae lu" href="https://github.com/reduxjs/redux-thunk/blob/master/src/index.js" rel="noopener ugc nofollow" target="_blank">行的</a> <a class="ae lu" href="https://github.com/reduxjs/redux-thunk/blob/master/src/index.js" rel="noopener ugc nofollow" target="_blank">代码</a>。它只是添加了一些“语法糖”，仅此而已。</p><p id="c7bf" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">下面的流程图有助于理解我们将要做的事情。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/12c920e9f396633cee42622d6e69ba45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CsRAws4zOuoi9jDr.Png"/></div></div></figure><p id="de87" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">每次执行一个动作，减速器相应地改变状态。该组件将状态映射到属性，并在<strong class="ky ir"> <em class="ma"> render() </em> </strong>方法中使用这些属性来确定用户应该看到什么:加载指示器、数据或错误消息。</p><p id="17d6" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">为了让它发挥作用，我们需要做5件事。</p><h2 id="64eb" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">1.安装tunk</h2><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="201b" class="mb jz iq ms b gy mw mx l my mz">npm install redux-thunk</span></pre><h2 id="17b4" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">2.配置store时添加thunk中间件(configureStore.js)</h2><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="0409" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>{ <em class="ma">applyMiddleware</em>, <em class="ma">compose</em>, createStore } <strong class="ms ir">from 'redux'</strong>;<br/><strong class="ms ir">import </strong>thunk <strong class="ms ir">from 'redux-thunk'</strong>;<br/><strong class="ms ir">import </strong>rootReducer <strong class="ms ir">from './appReducers'</strong>;</span><span id="1d27" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export function </strong><em class="ma">configureStore</em>(initialState) {<br/> <strong class="ms ir">const </strong>middleware = [thunk];</span><span id="5a18" class="mb jz iq ms b gy na mx l my mz"> <strong class="ms ir">const </strong>composeEnhancers = <strong class="ms ir"><em class="ma">window</em></strong>.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || <em class="ma">compose</em>;<br/> <strong class="ms ir">const </strong>store = createStore(rootReducer, initialState, composeEnhancers(<em class="ma">applyMiddleware</em>(...middleware)));</span><span id="5bbb" class="mb jz iq ms b gy na mx l my mz"> <strong class="ms ir">return </strong>store;<br/>}</span></pre><p id="9e32" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">在第12–13行，我们还配置了<a class="ae lu" href="https://github.com/zalmoxisus/redux-devtools-extension" rel="noopener ugc nofollow" target="_blank">redux</a>T18】dev tools。稍后，它将有助于显示这个解决方案的一个问题。</p><h2 id="c9bb" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">3.创建操作(redux-thunk/actions.js)</h2><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="8f15" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>Api <strong class="ms ir">from "../api"</strong></span><span id="93a5" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export const </strong>LOAD_USERS_LOADING = <strong class="ms ir">'REDUX_THUNK_LOAD_USERS_LOADING'</strong>;<br/><strong class="ms ir">export const </strong>LOAD_USERS_SUCCESS = <strong class="ms ir">'REDUX_THUNK_LOAD_USERS_SUCCESS'</strong>;<br/><strong class="ms ir">export const </strong>LOAD_USERS_ERROR = <strong class="ms ir">'REDUX_THUNK_LOAD_USERS_ERROR'</strong>;</span><span id="b8ec" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export const </strong><em class="ma">loadUsers </em>= () =&gt; dispatch =&gt; {<br/>   dispatch({ <strong class="ms ir">type</strong>: LOAD_USERS_LOADING });</span><span id="cc37" class="mb jz iq ms b gy na mx l my mz">   Api.<em class="ma">getUsers</em>()<br/>       .then(response =&gt; response.json())<br/>       .then(<br/>           data =&gt; dispatch({ <strong class="ms ir">type</strong>: LOAD_USERS_SUCCESS, data }),<br/>           error =&gt; dispatch({ <strong class="ms ir">type</strong>: LOAD_USERS_ERROR, <strong class="ms ir">error</strong>: error.<strong class="ms ir">message </strong>|| <strong class="ms ir">'Unexpected Error!!!' </strong>})<br/>       )<br/>};</span></pre><p id="6c50" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">还建议将你的动作创建者分开(这增加了一些额外的编码)，但是对于这个简单的例子，我认为“动态地”创建动作是可以接受的。</p><h2 id="80cb" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">4.创建reducer (redux-thunk/reducer.js)</h2><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="c00f" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>{LOAD_USERS_ERROR, LOAD_USERS_LOADING, LOAD_USERS_SUCCESS} <strong class="ms ir">from "./actions"</strong>;</span><span id="a1cd" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">const </strong>initialState = {<br/>   <strong class="ms ir">data</strong>: [],<br/>   <strong class="ms ir">loading</strong>: <strong class="ms ir">false</strong>,<br/>   <strong class="ms ir">error</strong>: <strong class="ms ir">''</strong><br/>};</span><span id="76fc" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export default function </strong>reduxThunkReducer(state = initialState, action) {<br/>   <strong class="ms ir">switch </strong>(action.<strong class="ms ir">type</strong>) {<br/>       <strong class="ms ir">case </strong>LOAD_USERS_LOADING: {<br/>           <strong class="ms ir">return </strong>{<br/>               ...state,<br/>               <strong class="ms ir">loading</strong>: <strong class="ms ir">true</strong>,<br/>               <strong class="ms ir">error</strong>:<strong class="ms ir">''</strong><br/>           };<br/>       }<br/>       <strong class="ms ir">case </strong>LOAD_USERS_SUCCESS: {<br/>           <strong class="ms ir">return </strong>{<br/>               ...state,<br/>               <strong class="ms ir">data</strong>: action.<strong class="ms ir">data</strong>,<br/>               <strong class="ms ir">loading</strong>: <strong class="ms ir">false</strong><br/>           }<br/>       }<br/>       <strong class="ms ir">case </strong>LOAD_USERS_ERROR: {<br/>           <strong class="ms ir">return </strong>{<br/>               ...state,<br/>               <strong class="ms ir">loading</strong>: <strong class="ms ir">false</strong>,<br/>               <strong class="ms ir">error</strong>: action.<strong class="ms ir">error</strong><br/>           };<br/>       }<br/>       <strong class="ms ir">default</strong>: {<br/>           <strong class="ms ir">return </strong>state;<br/>       }<br/>   }<br/>}</span></pre><h2 id="e1e1" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">5.创建连接到redux的组件(redux-thunk/userswithrudxthunk . js)</h2><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="a895" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>* <strong class="ms ir">as </strong>React <strong class="ms ir">from 'react'</strong>;<br/><strong class="ms ir">import </strong>{ connect } <strong class="ms ir">from 'react-redux'</strong>;<br/><strong class="ms ir">import </strong>{<em class="ma">loadUsers</em>} <strong class="ms ir">from "./actions"</strong>;</span><span id="7a30" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">class </strong>UsersWithReduxThunk <strong class="ms ir">extends </strong>React.Component {<br/>   componentDidMount() {<br/>       <strong class="ms ir">this</strong>.<strong class="ms ir">props</strong>.<strong class="ms ir">loadUsers</strong>();<br/>   };</span><span id="38bc" class="mb jz iq ms b gy na mx l my mz">   render() {<br/>       <strong class="ms ir">if </strong>(<strong class="ms ir">this</strong>.<strong class="ms ir">props</strong>.<strong class="ms ir">loading</strong>) {<br/>           <strong class="ms ir">return </strong>&lt;<strong class="ms ir">div</strong>&gt;Loading&lt;/<strong class="ms ir">div</strong>&gt;<br/>       }</span><span id="dba0" class="mb jz iq ms b gy na mx l my mz">       <strong class="ms ir">if </strong>(<strong class="ms ir">this</strong>.<strong class="ms ir">props</strong>.<strong class="ms ir">error</strong>) {<br/>           <strong class="ms ir">return </strong>&lt;<strong class="ms ir">div style=</strong>{{ <strong class="ms ir">color</strong>: <strong class="ms ir">'red' </strong>}}&gt;ERROR: {<strong class="ms ir">this</strong>.<strong class="ms ir">props</strong>.<strong class="ms ir">error</strong>}&lt;/<strong class="ms ir">div</strong>&gt;<br/>       }</span><span id="26a8" class="mb jz iq ms b gy na mx l my mz">       <strong class="ms ir">return </strong>(<br/>           &lt;<strong class="ms ir">table</strong>&gt;<br/>               &lt;<strong class="ms ir">thead</strong>&gt;<br/>                   &lt;<strong class="ms ir">tr</strong>&gt;<br/>                       &lt;<strong class="ms ir">th</strong>&gt;First Name&lt;/<strong class="ms ir">th</strong>&gt;<br/>                       &lt;<strong class="ms ir">th</strong>&gt;Last Name&lt;/<strong class="ms ir">th</strong>&gt;<br/>                       &lt;<strong class="ms ir">th</strong>&gt;Active?&lt;/<strong class="ms ir">th</strong>&gt;<br/>                       &lt;<strong class="ms ir">th</strong>&gt;Posts&lt;/<strong class="ms ir">th</strong>&gt;<br/>                       &lt;<strong class="ms ir">th</strong>&gt;Messages&lt;/<strong class="ms ir">th</strong>&gt;<br/>                   &lt;/<strong class="ms ir">tr</strong>&gt;<br/>               &lt;/<strong class="ms ir">thead</strong>&gt;<br/>               &lt;<strong class="ms ir">tbody</strong>&gt;<br/>               {<strong class="ms ir">this</strong>.<strong class="ms ir">props</strong>.<strong class="ms ir">data</strong>.map(u =&gt;<br/>                   &lt;<strong class="ms ir">tr key=</strong>{u.<strong class="ms ir">id</strong>}&gt;<br/>                       &lt;<strong class="ms ir">td</strong>&gt;{u.firstName}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                       &lt;<strong class="ms ir">td</strong>&gt;{u.lastName}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                       &lt;<strong class="ms ir">td</strong>&gt;{u.<strong class="ms ir">active </strong>? <strong class="ms ir">'Yes' </strong>: <strong class="ms ir">'No'</strong>}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                       &lt;<strong class="ms ir">td</strong>&gt;{u.posts}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                       &lt;<strong class="ms ir">td</strong>&gt;{u.<strong class="ms ir">messages</strong>}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                   &lt;/<strong class="ms ir">tr</strong>&gt;<br/>               )}<br/>               &lt;/<strong class="ms ir">tbody</strong>&gt;<br/>           &lt;/<strong class="ms ir">table</strong>&gt;<br/>       );<br/>   }<br/>}</span><span id="c203" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">const </strong><em class="ma">mapStateToProps </em>= state =&gt; ({<br/>   <strong class="ms ir">data</strong>: state.<em class="ma">reduxThunk</em>.<strong class="ms ir">data</strong>,<br/>   <strong class="ms ir">loading</strong>: state.<em class="ma">reduxThunk</em>.<strong class="ms ir">loading</strong>,<br/>   <strong class="ms ir">error</strong>: state.<em class="ma">reduxThunk</em>.<strong class="ms ir">error</strong>,<br/>});</span><span id="0abb" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">const </strong>mapDispatchToProps = {<br/>   <em class="ma">loadUsers</em><br/>};</span><span id="dc9b" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export default </strong>connect(<br/>   <em class="ma">mapStateToProps</em>,<br/>   mapDispatchToProps<br/>)(UsersWithReduxThunk);</span></pre><p id="903e" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">我试图使组件尽可能简单。我明白这看起来很糟糕:)</p><p id="0103" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">装载指示器</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/44f5df6246b199dd1ee8dee09530551e.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/0*RC-2TU3d-MxFu1qn.Png"/></div></figure><p id="1847" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">数据</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/203e85d24dbbf6b669a87064a91c474e.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/0*BOefY3HRsSvK1sj0.Png"/></div></figure><p id="06ae" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">错误</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/054799068bc10d0d970a94ed2ba4f763.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/0*7qK-gUUd9OuICJx0.Png"/></div></div></figure><p id="4d91" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">就这样:3个文件，109行代码(13(动作)+ 36(缩减器)+ 60(组件))。</p><h2 id="b32c" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">优点:</h2><ul class=""><li id="edd6" class="nf ng iq ky b kz la ld le lh nh ll ni lp nj lt nk nl nm nn bi translated">react/redux应用的“推荐”方法。</li><li id="e037" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">没有额外的依赖。差不多，thunk很小:)</li><li id="69ec" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">不需要学习新的东西。</li></ul><h2 id="b6a6" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">缺点:</h2><ul class=""><li id="167c" class="nf ng iq ky b kz la ld le lh nh ll ni lp nj lt nk nl nm nn bi translated">不同地方的大量代码</li><li id="cb9d" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">导航到另一个页面后，旧数据仍处于全局状态(见下图)。这些数据是消耗内存的过时和无用的信息。</li><li id="1526" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">在复杂的情况下(一个动作中的多个条件调用等)。)代码可读性不强</li></ul><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/f58507728cec69b236781cca33d60080.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1HECt374ZWSllcKr.Png"/></div></div></figure><h1 id="3f22" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">还原传奇</h1><p id="7fc6" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Redux-saga 是一个Redux中间件库，旨在使处理副作用变得容易和可读。它利用ES6生成器，允许我们编写看起来同步的异步代码。此外，该解决方案易于测试。</p><p id="5788" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">从高层次的角度来看，这个解决方案与thunk的工作原理相同。thunk示例中的流程图仍然适用。</p><p id="c885" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">为了让它发挥作用，我们需要做6件事。</p><h2 id="2660" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">1.安装saga</h2><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="20f0" class="mb jz iq ms b gy mw mx l my mz">npm install redux-saga</span></pre><h2 id="e7fb" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">2.添加saga中间件并添加所有saga(configure store . js)</h2><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="33eb" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>{ <em class="ma">applyMiddleware</em>, <em class="ma">compose</em>, createStore } <strong class="ms ir">from 'redux'</strong>;<br/><strong class="ms ir">import </strong><em class="ma">createSagaMiddleware </em><strong class="ms ir">from 'redux-saga'</strong>;<br/><strong class="ms ir">import </strong>rootReducer <strong class="ms ir">from './appReducers'</strong>;<br/><strong class="ms ir">import </strong><em class="ma">usersSaga </em><strong class="ms ir">from "../redux-saga/sagas"</strong>;</span><span id="5635" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">const </strong>sagaMiddleware = <em class="ma">createSagaMiddleware</em>();</span><span id="e8f1" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export function </strong><em class="ma">configureStore</em>(initialState) {<br/> <strong class="ms ir">const </strong>middleware = [sagaMiddleware];</span><span id="5452" class="mb jz iq ms b gy na mx l my mz"> <strong class="ms ir">const </strong>composeEnhancers = <strong class="ms ir"><em class="ma">window</em></strong>.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || <em class="ma">compose</em>;<br/> <strong class="ms ir">const </strong>store = createStore(rootReducer, initialState, composeEnhancers(<em class="ma">applyMiddleware</em>(...middleware)));</span><span id="3be1" class="mb jz iq ms b gy na mx l my mz"> sagaMiddleware.run(<em class="ma">usersSaga</em>);</span><span id="81fc" class="mb jz iq ms b gy na mx l my mz"> <strong class="ms ir">return </strong>store;<br/>}</span></pre><p id="0507" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">第4行的传奇将在第4步添加。</p><h2 id="62f8" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">3.创建操作(redux-saga/actions.js)</h2><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="5c79" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">export const </strong>LOAD_USERS_LOADING = <strong class="ms ir">'REDUX_SAGA_LOAD_USERS_LOADING'</strong>;<br/><strong class="ms ir">export const </strong>LOAD_USERS_SUCCESS = <strong class="ms ir">'REDUX_SAGA_LOAD_USERS_SUCCESS'</strong>;<br/><strong class="ms ir">export const </strong>LOAD_USERS_ERROR = <strong class="ms ir">'REDUX_SAGA_LOAD_USERS_ERROR'</strong>;</span><span id="1248" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export const </strong><em class="ma">loadUsers </em>= () =&gt; dispatch =&gt; {<br/>   dispatch({ <strong class="ms ir">type</strong>: LOAD_USERS_LOADING });<br/>};</span></pre><h2 id="ab45" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">4.创建传奇(redux-saga/sagas.js)</h2><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="8c3f" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>{ put, <em class="ma">takeEvery</em>, takeLatest } <strong class="ms ir">from 'redux-saga/effects'</strong><br/><strong class="ms ir">import </strong>{loadUsersSuccess, LOAD_USERS_ERROR, LOAD_USERS_LOADING, LOAD_USERS_SUCCESS} <strong class="ms ir">from "./actions"</strong>;<br/><strong class="ms ir">import </strong>Api <strong class="ms ir">from '../api'</strong></span><span id="1f03" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">async function </strong><em class="ma">fetchAsync</em>(func) {<br/>   <strong class="ms ir">const </strong>response = <strong class="ms ir">await </strong>func();</span><span id="f75e" class="mb jz iq ms b gy na mx l my mz">   <strong class="ms ir">if </strong>(response.<strong class="ms ir">ok</strong>) {<br/>       <strong class="ms ir">return await </strong>response.json();<br/>   }</span><span id="97a2" class="mb jz iq ms b gy na mx l my mz">   <strong class="ms ir">throw new <em class="ma">Error</em></strong>(<strong class="ms ir">"Unexpected error!!!"</strong>);<br/>}</span><span id="ca4e" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">function</strong>* <em class="ma">fetchUser</em>() {<br/>   <strong class="ms ir">try </strong>{<br/>       <strong class="ms ir">const </strong>users = <strong class="ms ir">yield </strong><em class="ma">fetchAsync</em>(Api.<em class="ma">getUsers</em>);</span><span id="5395" class="mb jz iq ms b gy na mx l my mz">       <strong class="ms ir">yield </strong>put({<strong class="ms ir">type</strong>: LOAD_USERS_SUCCESS, <strong class="ms ir">data</strong>: users});<br/>   } <strong class="ms ir">catch </strong>(e) {<br/>       <strong class="ms ir">yield </strong>put({<strong class="ms ir">type</strong>: LOAD_USERS_ERROR, <strong class="ms ir">error</strong>: e.<strong class="ms ir">message</strong>});<br/>   }<br/>}</span><span id="9bca" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export function</strong>* <em class="ma">usersSaga</em>() {<br/>   <em class="ma">// Allows concurrent fetches of users</em><br/>   <strong class="ms ir">yield </strong><em class="ma">takeEvery</em>(LOAD_USERS_LOADING, <em class="ma">fetchUser</em>);</span><span id="b89e" class="mb jz iq ms b gy na mx l my mz">   <em class="ma">// Does not allow concurrent fetches of users</em><br/><em class="ma">   // yield takeLatest(LOAD_USERS_LOADING, fetchUser);</em><br/>}</span><span id="28c6" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export default </strong><em class="ma">usersSaga</em>;</span></pre><p id="7e29" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">Saga有一个很陡的学习曲线，所以如果你从未使用过它，也从未读过关于这个框架的任何东西，你可能很难理解这里发生了什么。简而言之，在<strong class="ky ir"> <em class="ma"> userSaga </em> </strong>函数中，我们配置Saga监听<strong class="ky ir"> LOAD_USERS_LOADING </strong>动作并触发<strong class="ky ir"> <em class="ma"> fetchUsers </em> </strong>函数。<strong class="ky ir"> <em class="ma"> fetchUsers </em> </strong>函数调用API。如果调用成功，则调度<strong class="ky ir"> LOAD_USER_SUCCESS </strong>动作，否则调度<strong class="ky ir"> LOAD_USER_ERROR </strong>动作。</p><h2 id="2c3b" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">5.创建缩减器(redux-saga/reducer.js)</h2><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="c48b" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>{LOAD_USERS_ERROR, LOAD_USERS_LOADING, LOAD_USERS_SUCCESS} <strong class="ms ir">from "./actions"</strong>;</span><span id="119c" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">const </strong>initialState = {<br/>   <strong class="ms ir">data</strong>: [],<br/>   <strong class="ms ir">loading</strong>: <strong class="ms ir">false</strong>,<br/>   <strong class="ms ir">error</strong>: <strong class="ms ir">''</strong><br/>};</span><span id="59e3" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export default function </strong>reduxSagaReducer(state = initialState, action) {<br/>   <strong class="ms ir">switch </strong>(action.<strong class="ms ir">type</strong>) {<br/>       <strong class="ms ir">case </strong>LOAD_USERS_LOADING: {<br/>           <strong class="ms ir">return </strong>{<br/>               ...state,<br/>               <strong class="ms ir">loading</strong>: <strong class="ms ir">true</strong>,<br/>               <strong class="ms ir">error</strong>:<strong class="ms ir">''</strong><br/>           };<br/>       }<br/>       <strong class="ms ir">case </strong>LOAD_USERS_SUCCESS: {<br/>           <strong class="ms ir">return </strong>{<br/>               ...state,<br/>               <strong class="ms ir">data</strong>: action.<strong class="ms ir">data</strong>,<br/>               <strong class="ms ir">loading</strong>: <strong class="ms ir">false</strong><br/>           }<br/>       }<br/>       <strong class="ms ir">case </strong>LOAD_USERS_ERROR: {<br/>           <strong class="ms ir">return </strong>{<br/>               ...state,<br/>               <strong class="ms ir">loading</strong>: <strong class="ms ir">false</strong>,<br/>               <strong class="ms ir">error</strong>: action.<strong class="ms ir">error</strong><br/>           };<br/>       }<br/>       <strong class="ms ir">default</strong>: {<br/>           <strong class="ms ir">return </strong>state;<br/>       }<br/>   }<br/>}</span></pre><p id="1a8b" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">这里的缩减器与thunk示例中的完全相同。</p><h1 id="d213" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">6.创建连接到redux的组件(redux-saga/userswithrudxsaga . js)</h1><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="1240" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>* <strong class="ms ir">as </strong>React <strong class="ms ir">from 'react'</strong>;<br/><strong class="ms ir">import </strong>{connect} <strong class="ms ir">from 'react-redux'</strong>;<br/><strong class="ms ir">import </strong>{<em class="ma">loadUsers</em>} <strong class="ms ir">from "./actions"</strong>;</span><span id="5484" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">class </strong>UsersWithReduxSaga <strong class="ms ir">extends </strong>React.Component {<br/>   componentDidMount() {<br/>       <strong class="ms ir">this</strong>.<strong class="ms ir">props</strong>.<strong class="ms ir">loadUsers</strong>();<br/>   };</span><span id="f7b8" class="mb jz iq ms b gy na mx l my mz">   render() {<br/>       <strong class="ms ir">if </strong>(<strong class="ms ir">this</strong>.<strong class="ms ir">props</strong>.<strong class="ms ir">loading</strong>) {<br/>           <strong class="ms ir">return </strong>&lt;<strong class="ms ir">div</strong>&gt;Loading&lt;/<strong class="ms ir">div</strong>&gt;<br/>       }</span><span id="07c4" class="mb jz iq ms b gy na mx l my mz">       <strong class="ms ir">if </strong>(<strong class="ms ir">this</strong>.<strong class="ms ir">props</strong>.<strong class="ms ir">error</strong>) {<br/>           <strong class="ms ir">return </strong>&lt;<strong class="ms ir">div style=</strong>{{<strong class="ms ir">color</strong>: <strong class="ms ir">'red'</strong>}}&gt;ERROR: {<strong class="ms ir">this</strong>.<strong class="ms ir">props</strong>.<strong class="ms ir">error</strong>}&lt;/<strong class="ms ir">div</strong>&gt;<br/>       }</span><span id="c258" class="mb jz iq ms b gy na mx l my mz">       <strong class="ms ir">return </strong>(<br/>           &lt;<strong class="ms ir">table</strong>&gt;<br/>               &lt;<strong class="ms ir">thead</strong>&gt;<br/>                   &lt;<strong class="ms ir">tr</strong>&gt;<br/>                       &lt;<strong class="ms ir">th</strong>&gt;First Name&lt;/<strong class="ms ir">th</strong>&gt;<br/>                       &lt;<strong class="ms ir">th</strong>&gt;Last Name&lt;/<strong class="ms ir">th</strong>&gt;<br/>                       &lt;<strong class="ms ir">th</strong>&gt;Active?&lt;/<strong class="ms ir">th</strong>&gt;<br/>                       &lt;<strong class="ms ir">th</strong>&gt;Posts&lt;/<strong class="ms ir">th</strong>&gt;<br/>                       &lt;<strong class="ms ir">th</strong>&gt;Messages&lt;/<strong class="ms ir">th</strong>&gt;<br/>                   &lt;/<strong class="ms ir">tr</strong>&gt;<br/>               &lt;/<strong class="ms ir">thead</strong>&gt;<br/>               &lt;<strong class="ms ir">tbody</strong>&gt;<br/>                   {<strong class="ms ir">this</strong>.<strong class="ms ir">props</strong>.<strong class="ms ir">data</strong>.map(u =&gt;<br/>                       &lt;<strong class="ms ir">tr key=</strong>{u.<strong class="ms ir">id</strong>}&gt;<br/>                           &lt;<strong class="ms ir">td</strong>&gt;{u.firstName}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                           &lt;<strong class="ms ir">td</strong>&gt;{u.lastName}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                           &lt;<strong class="ms ir">td</strong>&gt;{u.<strong class="ms ir">active </strong>? <strong class="ms ir">'Yes' </strong>: <strong class="ms ir">'No'</strong>}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                           &lt;<strong class="ms ir">td</strong>&gt;{u.posts}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                           &lt;<strong class="ms ir">td</strong>&gt;{u.<strong class="ms ir">messages</strong>}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                       &lt;/<strong class="ms ir">tr</strong>&gt;<br/>                   )}<br/>               &lt;/<strong class="ms ir">tbody</strong>&gt;<br/>           &lt;/<strong class="ms ir">table</strong>&gt;<br/>       );<br/>   }<br/>}</span><span id="13ce" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">const </strong><em class="ma">mapStateToProps </em>= state =&gt; ({<br/>   <strong class="ms ir">data</strong>: state.<em class="ma">reduxSaga</em>.<strong class="ms ir">data</strong>,<br/>   <strong class="ms ir">loading</strong>: state.<em class="ma">reduxSaga</em>.<strong class="ms ir">loading</strong>,<br/>   <strong class="ms ir">error</strong>: state.<em class="ma">reduxSaga</em>.<strong class="ms ir">error</strong>,<br/>});</span><span id="ebc8" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">const </strong>mapDispatchToProps = {<br/>   <em class="ma">loadUsers</em><br/>};</span><span id="0705" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export default </strong>connect(<br/>   <em class="ma">mapStateToProps</em>,<br/>   mapDispatchToProps<br/>)(UsersWithReduxSaga);</span></pre><p id="3ea2" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">这里的组件与thunk示例中的组件几乎相同。</p><p id="002e" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">所以这里我们有4个文件，136行代码(7(actions)+36(reducer)+sagas(33)+60(component))。</p><h2 id="b332" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">优点:</h2><ul class=""><li id="c22a" class="nf ng iq ky b kz la ld le lh nh ll ni lp nj lt nk nl nm nn bi translated">更可读的代码(异步/等待)</li><li id="340d" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">适用于处理复杂场景(一个动作中有多个条件调用，一个动作可以有多个监听器，取消动作等)。)</li><li id="b158" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">易于单元测试</li></ul><h2 id="b7e0" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">缺点:</h2><ul class=""><li id="46aa" class="nf ng iq ky b kz la ld le lh nh ll ni lp nj lt nk nl nm nn bi translated">不同地方的大量代码</li><li id="d9a5" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">导航到另一个页面后，旧数据仍处于全局状态。这些数据是消耗内存的过时和无用的信息。</li><li id="e728" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">附加依赖性</li><li id="2bca" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">很多概念要学</li></ul><h1 id="7eca" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">焦虑</h1><p id="0c2b" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">悬念是React 16.6.0中的新特性。它允许我们推迟呈现组件的一部分，直到满足某些条件(例如从API加载数据)。</p><p id="5f1f" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">为了让它工作，我们需要做4件事(它肯定会变得更好:)。</p><h2 id="fdff" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">1.创建缓存(suspension/cache . js)</h2><p id="7838" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">对于缓存，我们将使用一个<a class="ae lu" href="https://www.npmjs.com/package/simple-cache-provider" rel="noopener ugc nofollow" target="_blank">简单缓存提供者</a>，它是react应用程序的一个基本缓存提供者。</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="0c76" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>{<em class="ma">createCache</em>} <strong class="ms ir">from 'simple-cache-provider'</strong>;</span><span id="b674" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export let </strong>cache;</span><span id="e992" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">function </strong><em class="ma">initCache</em>() {<br/> cache = <em class="ma">createCache</em>(<em class="ma">initCache</em>);<br/>}</span><span id="175f" class="mb jz iq ms b gy na mx l my mz"><em class="ma">initCache</em>();</span></pre><h2 id="e7dd" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">2.创建错误边界(suspension/Error Boundary . js)</h2><p id="701d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这是一个错误边界，用于捕捉由悬念引发的错误。</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="f5c9" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>React <strong class="ms ir">from 'react'</strong>;</span><span id="900c" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export class </strong>ErrorBoundary <strong class="ms ir">extends </strong>React.Component {<br/> <strong class="ms ir">state </strong>= {};</span><span id="1f5a" class="mb jz iq ms b gy na mx l my mz"> componentDidCatch(error) {<br/>   <strong class="ms ir">this</strong>.setState({ <strong class="ms ir">error</strong>: error.<strong class="ms ir">message </strong>|| <strong class="ms ir">"Unexpected error" </strong>});<br/> }</span><span id="6221" class="mb jz iq ms b gy na mx l my mz"> render() {<br/>   <strong class="ms ir">if </strong>(<strong class="ms ir">this</strong>.<strong class="ms ir">state</strong>.<strong class="ms ir">error</strong>) {<br/>     <strong class="ms ir">return </strong>&lt;<strong class="ms ir">div style=</strong>{{ <strong class="ms ir">color</strong>: <strong class="ms ir">'red' </strong>}}&gt;ERROR: {<strong class="ms ir">this</strong>.<strong class="ms ir">state</strong>.<strong class="ms ir">error </strong>|| <strong class="ms ir">'Unexpected Error'</strong>}&lt;/<strong class="ms ir">div</strong>&gt;;<br/>   }</span><span id="2dd1" class="mb jz iq ms b gy na mx l my mz">   <strong class="ms ir">return this</strong>.<strong class="ms ir">props</strong>.<strong class="ms ir">children</strong>;<br/> }<br/>}</span><span id="5d94" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export default </strong>ErrorBoundary;</span></pre><h2 id="8e34" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">3.创建用户表(暂记/用户表. js)</h2><p id="983a" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">对于这个例子，我们需要创建一个加载和显示数据的附加组件。这里我们创建一个资源来从API获取数据。</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="b1ce" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>* <strong class="ms ir">as </strong>React <strong class="ms ir">from 'react'</strong>;<br/><strong class="ms ir">import </strong>{<em class="ma">createResource</em>} <strong class="ms ir">from "simple-cache-provider"</strong>;<br/><strong class="ms ir">import </strong>{cache} <strong class="ms ir">from "./cache"</strong>;<br/><strong class="ms ir">import </strong>Api <strong class="ms ir">from "../api"</strong>;</span><span id="75c5" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">let </strong>UsersResource = <em class="ma">createResource</em>(<strong class="ms ir">async </strong>() =&gt; {<br/>   <strong class="ms ir">const </strong>response = <strong class="ms ir">await </strong>Api.<em class="ma">getUsers</em>();<br/>   <strong class="ms ir">const </strong>json = <strong class="ms ir">await </strong>response.json();</span><span id="023a" class="mb jz iq ms b gy na mx l my mz">   <strong class="ms ir">return </strong>json;<br/>});</span><span id="26c7" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">class </strong>UsersTable <strong class="ms ir">extends </strong>React.Component {<br/>   render() {<br/>       <strong class="ms ir">let </strong>users = UsersResource.read(cache);</span><span id="b3bc" class="mb jz iq ms b gy na mx l my mz">       <strong class="ms ir">return </strong>(<br/>           &lt;<strong class="ms ir">table</strong>&gt;<br/>               &lt;<strong class="ms ir">thead</strong>&gt;<br/>               &lt;<strong class="ms ir">tr</strong>&gt;<br/>                   &lt;<strong class="ms ir">th</strong>&gt;First Name&lt;/<strong class="ms ir">th</strong>&gt;<br/>                   &lt;<strong class="ms ir">th</strong>&gt;Last Name&lt;/<strong class="ms ir">th</strong>&gt;<br/>                   &lt;<strong class="ms ir">th</strong>&gt;Active?&lt;/<strong class="ms ir">th</strong>&gt;<br/>                   &lt;<strong class="ms ir">th</strong>&gt;Posts&lt;/<strong class="ms ir">th</strong>&gt;<br/>                   &lt;<strong class="ms ir">th</strong>&gt;Messages&lt;/<strong class="ms ir">th</strong>&gt;<br/>               &lt;/<strong class="ms ir">tr</strong>&gt;<br/>               &lt;/<strong class="ms ir">thead</strong>&gt;<br/>               &lt;<strong class="ms ir">tbody</strong>&gt;<br/>               {users.map(u =&gt;<br/>                   &lt;<strong class="ms ir">tr key=</strong>{u.<strong class="ms ir">id</strong>}&gt;<br/>                       &lt;<strong class="ms ir">td</strong>&gt;{u.firstName}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                       &lt;<strong class="ms ir">td</strong>&gt;{u.lastName}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                       &lt;<strong class="ms ir">td</strong>&gt;{u.<strong class="ms ir">active </strong>? <strong class="ms ir">'Yes' </strong>: <strong class="ms ir">'No'</strong>}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                       &lt;<strong class="ms ir">td</strong>&gt;{u.posts}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                       &lt;<strong class="ms ir">td</strong>&gt;{u.<strong class="ms ir">messages</strong>}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                   &lt;/<strong class="ms ir">tr</strong>&gt;<br/>               )}<br/>               &lt;/<strong class="ms ir">tbody</strong>&gt;<br/>           &lt;/<strong class="ms ir">table</strong>&gt;<br/>       );<br/>   }<br/>}</span><span id="e471" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export default </strong>UsersTable;</span></pre><h2 id="4804" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">4.创建组件(suspension/userswithstypension . js)</h2><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="1ed3" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>* <strong class="ms ir">as </strong>React <strong class="ms ir">from 'react'</strong>;<br/><strong class="ms ir">import </strong>UsersTable <strong class="ms ir">from "./UsersTable"</strong>;<br/><strong class="ms ir">import </strong>ErrorBoundary <strong class="ms ir">from "./ErrorBoundary"</strong>;</span><span id="6f26" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">class </strong>UsersWithSuspense <strong class="ms ir">extends </strong>React.Component {<br/>   render() {<br/>       <strong class="ms ir">return </strong>(<br/>           &lt;<strong class="ms ir">ErrorBoundary</strong>&gt;<br/>               &lt;<strong class="ms ir">React.Suspense fallback=</strong>{&lt;<strong class="ms ir">div</strong>&gt;Loading&lt;/<strong class="ms ir">div</strong>&gt;}&gt;<br/>                   &lt;<strong class="ms ir">UsersTable</strong>/&gt;<br/>               &lt;/<strong class="ms ir">React.Suspense</strong>&gt;<br/>           &lt;/<strong class="ms ir">ErrorBoundary</strong>&gt;<br/>       );<br/>   }<br/>}</span><span id="a609" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export default </strong>UsersWithSuspense;</span></pre><p id="b602" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir"> 4个文件，106行代码(9(缓存)+ 19(错误边界)+ UsersTable(33) + 45(组件))。</strong></p><p id="06a2" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir"> 3个文件，87行代码(9(缓存)+ UsersTable(33) + 45(组件))如果我们假设ErrorBoundary是一个可重用的组件。</strong></p><h2 id="abba" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">优点:</h2><ul class=""><li id="7027" class="nf ng iq ky b kz la ld le lh nh ll ni lp nj lt nk nl nm nn bi translated">不需要冗余。这种方法可以不使用redux。组件是完全独立的。</li><li id="bc91" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">没有额外的依赖关系(<a class="ae lu" href="https://www.npmjs.com/package/simple-cache-provider" rel="noopener ugc nofollow" target="_blank">简单缓存提供者</a>是React的一部分)</li><li id="ddba" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">通过设置dellayMs属性延迟显示加载指示器</li><li id="ed9f" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">与前面的示例相比，代码行更少</li></ul><h2 id="f8dd" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">缺点:</h2><ul class=""><li id="5be8" class="nf ng iq ky b kz la ld le lh nh ll ni lp nj lt nk nl nm nn bi translated">即使我们并不真正需要缓存，也需要缓存。</li><li id="22c0" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">需要学习一些新概念(这是React的一部分)。</li></ul><h1 id="ab8a" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">钩住</h1><p id="5e98" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在撰写本文时，钩子还没有正式发布，只能在“下一个”版本中使用。钩子无疑是即将到来的最具革命性的特性之一，它将很快改变React世界。关于钩子的更多细节可以在<a class="ae lu" href="https://reactjs.org/docs/hooks-intro.html" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae lu" href="https://reactjs.org/docs/hooks-overview.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="74f5" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">为了让它在我们的例子中发挥作用，我们需要做<strong class="ky ir"> one(！)</strong>事情:</p><h2 id="cfba" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">1.创建和使用钩子(hooks/UsersWithHooks.js)</h2><p id="03bf" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这里我们创建了3个挂钩(函数)来“挂钩”React状态。</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="f54d" class="mb jz iq ms b gy mw mx l my mz"><strong class="ms ir">import </strong>React, {useState, useEffect} <strong class="ms ir">from 'react'</strong>;<br/><strong class="ms ir">import </strong>Api <strong class="ms ir">from "../api"</strong>;</span><span id="438c" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">function </strong><em class="ma">UsersWithHooks</em>() {<br/>   <strong class="ms ir">const </strong>[data, setData] = useState([]);<br/>   <strong class="ms ir">const </strong>[loading, setLoading] = useState(<strong class="ms ir">true</strong>);<br/>   <strong class="ms ir">const </strong>[error, setError] = useState(<strong class="ms ir">''</strong>);</span><span id="44c9" class="mb jz iq ms b gy na mx l my mz"><em class="ma">   useEffect</em>(() =&gt; {<br/>       <strong class="ms ir">async function </strong><em class="ma">fetchData</em>() {<br/>           <strong class="ms ir">try </strong>{<br/>               <strong class="ms ir">const </strong>response = <strong class="ms ir">await </strong>Api.<em class="ma">getUsers</em>();<br/>               <strong class="ms ir">const </strong>json = <strong class="ms ir">await </strong>response.json();<br/><br/>            setData(json);<br/>           } <strong class="ms ir">catch </strong>(e) {<br/>               setError(e.<strong class="ms ir">message </strong>|| <strong class="ms ir">'Unexpected error'</strong>);<br/>           }<br/><br/>           setLoading(<strong class="ms ir">false</strong>);<br/>       }<br/><br/>       <em class="ma">fetchData</em>();<br/>   }, []);</span><span id="82be" class="mb jz iq ms b gy na mx l my mz">   <strong class="ms ir">if </strong>(loading) {<br/>       <strong class="ms ir">return </strong>&lt;<strong class="ms ir">div</strong>&gt;Loading&lt;/<strong class="ms ir">div</strong>&gt;<br/>   }</span><span id="8b33" class="mb jz iq ms b gy na mx l my mz">   <strong class="ms ir">if </strong>(error) {<br/>       <strong class="ms ir">return </strong>&lt;<strong class="ms ir">div style=</strong>{{<strong class="ms ir">color</strong>: <strong class="ms ir">'red'</strong>}}&gt;ERROR: {error}&lt;/<strong class="ms ir">div</strong>&gt;<br/>   }</span><span id="e729" class="mb jz iq ms b gy na mx l my mz">   <strong class="ms ir">return </strong>(<br/>       &lt;<strong class="ms ir">table</strong>&gt;<br/>           &lt;<strong class="ms ir">thead</strong>&gt;<br/>           &lt;<strong class="ms ir">tr</strong>&gt;<br/>               &lt;<strong class="ms ir">th</strong>&gt;First Name&lt;/<strong class="ms ir">th</strong>&gt;<br/>               &lt;<strong class="ms ir">th</strong>&gt;Last Name&lt;/<strong class="ms ir">th</strong>&gt;<br/>               &lt;<strong class="ms ir">th</strong>&gt;Active?&lt;/<strong class="ms ir">th</strong>&gt;<br/>               &lt;<strong class="ms ir">th</strong>&gt;Posts&lt;/<strong class="ms ir">th</strong>&gt;<br/>               &lt;<strong class="ms ir">th</strong>&gt;Messages&lt;/<strong class="ms ir">th</strong>&gt;<br/>           &lt;/<strong class="ms ir">tr</strong>&gt;<br/>           &lt;/<strong class="ms ir">thead</strong>&gt;<br/>           &lt;<strong class="ms ir">tbody</strong>&gt;<br/>           {data.map(u =&gt;<br/>               &lt;<strong class="ms ir">tr key=</strong>{u.<strong class="ms ir">id</strong>}&gt;<br/>                   &lt;<strong class="ms ir">td</strong>&gt;{u.firstName}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                   &lt;<strong class="ms ir">td</strong>&gt;{u.lastName}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                   &lt;<strong class="ms ir">td</strong>&gt;{u.<strong class="ms ir">active </strong>? <strong class="ms ir">'Yes' </strong>: <strong class="ms ir">'No'</strong>}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                   &lt;<strong class="ms ir">td</strong>&gt;{u.posts}&lt;/<strong class="ms ir">td</strong>&gt;<br/>                   &lt;<strong class="ms ir">td</strong>&gt;{u.<strong class="ms ir">messages</strong>}&lt;/<strong class="ms ir">td</strong>&gt;<br/>               &lt;/<strong class="ms ir">tr</strong>&gt;<br/>           )}<br/>           &lt;/<strong class="ms ir">tbody</strong>&gt;<br/>       &lt;/<strong class="ms ir">table</strong>&gt;<br/>   );<br/>}</span><span id="cf2a" class="mb jz iq ms b gy na mx l my mz"><strong class="ms ir">export default </strong><em class="ma">UsersWithHooks</em>;</span></pre><p id="1343" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">就是这样—仅仅1个文件，60行代码！！！</strong></p><h2 id="5a91" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">优点:</h2><ul class=""><li id="5db0" class="nf ng iq ky b kz la ld le lh nh ll ni lp nj lt nk nl nm nn bi translated">不需要冗余。这种方法可以不使用redux。组件是完全独立的。</li><li id="4c07" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">没有额外的依赖</li><li id="cecc" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">代码比其他解决方案少大约2倍</li></ul><h2 id="446c" class="mb jz iq bd ka mc md dn ke me mf dp ki lh mg mh km ll mi mj kq lp mk ml ku mm bi translated">缺点:</h2><ul class=""><li id="d2dd" class="nf ng iq ky b kz la ld le lh nh ll ni lp nj lt nk nl nm nn bi translated">乍一看，代码看起来很奇怪，难以阅读和理解。需要一段时间来适应钩子。</li><li id="7228" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">需要学习一些新概念(这是React的一部分)</li><li id="e652" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">尚未正式发布</li></ul><h1 id="86d4" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="671d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">让我们首先将这些指标组织成一个表格。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/d96e6e9f6ad4ecb73b2d8e4f24b8fd61.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*cmLDNTUJCiFczSPrMs_ohQ.png"/></div></figure><ul class=""><li id="4d33" class="nf ng iq ky b kz lv ld lw lh nv ll nw lp nx lt nk nl nm nn bi translated">Redux仍然是管理全局状态的一个很好的选择(如果你有的话)</li><li id="1397" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">每个选项都有利弊。哪种方法更好取决于项目:它的复杂性、用例、团队知识、项目何时投入生产等等。</li><li id="3a5f" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">Saga可以帮助处理复杂的用例</li><li id="910b" class="nf ng iq ky b kz no ld np lh nq ll nr lp ns lt nk nl nm nn bi translated">悬念和挂钩都值得考虑(或至少学习)，尤其是对于新项目</li></ul><p id="6b45" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">就这样——享受快乐的编码吧！</p></div></div>    
</body>
</html>