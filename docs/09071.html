<html>
<head>
<title>Solve the dreadful certificate issues in Python requests module</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解决Python请求模块中可怕的证书问题</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/solve-the-dreadful-certificate-issues-in-python-requests-module-2020d922c72f?source=collection_archive---------0-----------------------#2021-07-03">https://levelup.gitconnected.com/solve-the-dreadful-certificate-issues-in-python-requests-module-2020d922c72f?source=collection_archive---------0-----------------------#2021-07-03</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><h2 id="e402" class="is it iu bd b dl iv iw ix iy iz ja dk jb translated" aria-label="kicker paragraph">现实世界的问题并解决它们</h2><div class=""/><p id="b025" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">最近，我一直在使用Python请求模块来保护使用服务器证书的API调用。</p><p id="253b" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">我真的被困在了一个点上，了解到我做了什么来解决这个问题是很棒的，这让我在<a class="ae ky" href="https://medium.com/geekculture/story-of-ssl-certificates-161f29df8b65?sk=c0142802cc51cb91b2fda2dd607965c0" rel="noopener">带SSL证书的深度潜水</a>上创建了一个帖子。</p><figure class="la lb lc ld gu le gi gj paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gi gj kz"><img src="../Images/87f598c06348c82c9300f509177cca74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fGTQ3UIxFBgfdDokvJJ5_Q.jpeg"/></div></div><figcaption class="ll lm gk gi gj ln lo bd b be z dk translated">图片来自<a class="ae ky" href="https://www.pexels.com/photo/young-ethnic-male-with-laptop-screaming-3799830/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a>的<a class="ae ky" href="https://www.pexels.com/@olly?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">安德里亚·皮亚卡迪奥</a></figcaption></figure><h1 id="94a6" class="lp lq iu bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">问题是</h1><p id="e50a" class="pw-post-body-paragraph ka kb iu kc b kd mn kf kg kh mo kj kk kl mp kn ko kp mq kr ks kt mr kv kw kx in bi translated">我正在使用请求模块，这里是API调用。</p><pre class="la lb lc ld gu ms mt mu mv aw mw bi"><span id="c4ee" class="mx lq iu mt b gz my mz l na nb">response = requests.post(url, files=files, headers=headers)</span></pre><p id="9b72" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">并得到一个错误:</p><pre class="la lb lc ld gu ms mt mu mv aw mw bi"><span id="9721" class="mx lq iu mt b gz my mz l na nb"><strong class="mt je"><em class="nc">/ (Caused by SSLError(SSLCertVerification(1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1108)'))</em></strong></span></pre><h1 id="ee96" class="lp lq iu bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">试图</h1><h2 id="e548" class="mx lq iu bd lr nd ne dn lv nf ng dp lz kl nh ni md kp nj nk mh kt nl nm ml ja bi translated">1.使用verify=False进行不安全的调用</h2><p id="974f" class="pw-post-body-paragraph ka kb iu kc b kd mn kf kg kh mo kj kk kl mp kn ko kp mq kr ks kt mr kv kw kx in bi translated">我的第一次尝试是使用verify标志作为<code class="fe nn no np mt b">False</code>并尝试。</p><pre class="la lb lc ld gu ms mt mu mv aw mw bi"><span id="2b2d" class="mx lq iu mt b gz my mz l na nb">response = requests.post(url, files=files, headers=headers, verify=False)</span></pre><p id="cb30" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">虽然我得了200分，但我收到了一个令人不快的警告，确认我正在做一份糟糕的工作，没有提供证书。所以我必须找到正确的方法。</p><h2 id="ddc0" class="mx lq iu bd lr nd ne dn lv nf ng dp lz kl nh ni md kp nj nk mh kt nl nm ml ja bi translated">2.提供服务器证书</h2><p id="155b" class="pw-post-body-paragraph ka kb iu kc b kd mn kf kg kh mo kj kk kl mp kn ko kp mq kr ks kt mr kv kw kx in bi translated">首先，我想，如果我可以在验证密钥中提供服务器证书，就可以了。所以我做了，</p><pre class="la lb lc ld gu ms mt mu mv aw mw bi"><span id="62e5" class="mx lq iu mt b gz my mz l na nb">response = requests.post(url, files=files, headers=headers, verify='server.cer')</span></pre><blockquote class="nq nr ns"><p id="3388" class="ka kb nc kc b kd ke kf kg kh ki kj kk nt km kn ko nu kq kr ks nv ku kv kw kx in bi translated">这是一个<strong class="kc je"> DER </strong>编码的证书</p></blockquote><p id="38a4" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">我得到了另一个错误:</p><pre class="la lb lc ld gu ms mt mu mv aw mw bi"><span id="5457" class="mx lq iu mt b gz my mz l na nb"><strong class="mt je"><em class="nc">/ (Caused by SSLError(SSLError(136, '[X509] no certificate or crl found (_ssl.c:4232)'))</em></strong></span></pre><h2 id="5d7f" class="mx lq iu bd lr nd ne dn lv nf ng dp lz kl nh ni md kp nj nk mh kt nl nm ml ja bi translated">3.覆盖CA_REQUESTS_BUNDLE</h2><p id="ceab" class="pw-post-body-paragraph ka kb iu kc b kd mn kf kg kh mo kj kk kl mp kn ko kp mq kr ks kt mr kv kw kx in bi translated">模块requests使用<strong class="kc je"><em class="nc">certify</em></strong>来访问CA包并验证安全SSL连接，我们可以使用<strong class="kc je"> CA_REQUESTS_BUNDLE </strong>环境变量来覆盖CA包位置。于是我想，如果我能手动提供那个变量里的<strong class="kc je"> <em class="nc"> server.cer </em> </strong>我就实现开悟了。但令我绝望的是，这也失败了。</p><h2 id="53f5" class="mx lq iu bd lr nd ne dn lv nf ng dp lz kl nh ni md kp nj nk mh kt nl nm ml ja bi translated">4.转换为不同的证书编码</h2><p id="2cc3" class="pw-post-body-paragraph ka kb iu kc b kd mn kf kg kh mo kj kk kl mp kn ko kp mq kr ks kt mr kv kw kx in bi translated">然后我想请求模块一定没有接受DER编码的证书。所以我转换成了PEM，它是明文，但是是64进制编码的。</p><pre class="la lb lc ld gu ms mt mu mv aw mw bi"><span id="1e92" class="mx lq iu mt b gz my mz l na nb">openssl x509 -in server.cer -inform DER -outform PEM -out server.pem</span></pre><p id="e715" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">又打了一次电话</p><pre class="la lb lc ld gu ms mt mu mv aw mw bi"><span id="8ffa" class="mx lq iu mt b gz my mz l na nb">response = requests.post(url, files=files, headers=headers, verify='server.pem')</span></pre><p id="425a" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">又一个错误。</p><pre class="la lb lc ld gu ms mt mu mv aw mw bi"><span id="bb26" class="mx lq iu mt b gz my mz l na nb"><strong class="mt je"><em class="nc">/ (Caused by SSLError(SSLCertVerification(1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1108)'))</em></strong></span></pre><p id="a359" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">是的，这和<strong class="kc je">错误1 </strong>一样。所以我们又回到了起点。我试着在网上搜索，但没有人有一个有意义的解决方案。有人</p><p id="fd99" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">然后我想这不是办法，我会解决这个问题。所以我对证书做了很多研究，最后我拿到了。我写了《深潜》这篇文章，把所有东西都放在那里。</p></div><div class="ab cl nw nx hy ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="in io ip iq ir"><h1 id="1d46" class="lp lq iu bd lr ls od lu lv lw oe ly lz ma of mc md me og mg mh mi oh mk ml mm bi translated">回归基础</h1><p id="a158" class="pw-post-body-paragraph ka kb iu kc b kd mn kf kg kh mo kj kk kl mp kn ko kp mq kr ks kt mr kv kw kx in bi translated">这个问题以及互联网上所有类似的与证书相关的问题(在任何语言中，不仅仅是python)都需要对证书链有一个清晰明了的理解。我已经在我的深潜帖子中非常清楚地解释了一切。</p><p id="110d" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">通常，证书链由三方组成。</p><ol class=""><li id="7f07" class="oi oj iu kc b kd ke kh ki kl ok kp ol kt om kx on oo op oq bi translated">根证书颁发机构</li><li id="6edc" class="oi oj iu kc b kd or kh os kl ot kp ou kt ov kx on oo op oq bi translated">一个或多个中间认证机构</li><li id="628e" class="oi oj iu kc b kd or kh os kl ot kp ou kt ov kx on oo op oq bi translated">服务器证书，要求对证书进行签名。</li></ol><p id="a8fb" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">授权的责任是:</p><blockquote class="nq nr ns"><p id="116f" class="ka kb nc kc b kd ke kf kg kh ki kj kk nt km kn ko nu kq kr ks nv ku kv kw kx in bi translated">根癌标志→中间癌</p><p id="5e05" class="ka kb nc kc b kd ke kf kg kh ki kj kk nt km kn ko nu kq kr ks nv ku kv kw kx in bi translated">中间CA签名→服务器证书</p></blockquote><p id="f896" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">来自根CA的根证书通常具有很长的有效期(超过20年)，并且作为CA包捆绑在所有计算机和服务器中，并且在严格的规则下非常安全地保存，使得没有人能够在任何机器中更改它们。</p><p id="654d" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">因为根CA是非常非常神圣的，所以他们需要中介CA来委派责任，以便在任何人通过提供CSR来请求它时签署服务器证书。这些中介称为中间ca。证书链中可能有多个中间ca。</p></div><div class="ab cl nw nx hy ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="in io ip iq ir"><h1 id="5b12" class="lp lq iu bd lr ls od lu lv lw oe ly lz ma of mc md me og mg mh mi oh mk ml mm bi translated">解决办法</h1><p id="6903" class="pw-post-body-paragraph ka kb iu kc b kd mn kf kg kh mo kj kk kl mp kn ko kp mq kr ks kt mr kv kw kx in bi translated">在我们的例子中，当我们将证书文件转换为PEM格式时，我们犯了一个错误，</p><pre class="la lb lc ld gu ms mt mu mv aw mw bi"><span id="1f7e" class="mx lq iu mt b gz my mz l na nb"><strong class="mt je"><em class="nc">unable to get local issuer certificate (_ssl.c:1108)</em></strong></span></pre><p id="3d83" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">这有两个原因:</p><ul class=""><li id="083a" class="oi oj iu kc b kd ke kh ki kl ok kp ol kt om kx ow oo op oq bi translated">中间CA证书在<strong class="kc je"> server.pem </strong>文件中不可用</li><li id="6e81" class="oi oj iu kc b kd or kh os kl ot kp ou kt ov kx ow oo op oq bi translated">由于我们通过指定<strong class="kc je"><em class="nc">verify = server . PEM</em></strong><em class="nc">，</em>来手动指定使用哪个证书文件，因此python请求模块将不会使用已经存在的CA包，而是将只使用<strong class="kc je"> server.pem </strong>并且<strong class="kc je">期望它包含链中的所有证书、server.cer、中间证书和根证书</strong></li></ul><p id="2fc4" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">所以我像这样手工剥离了服务器证书:</p><figure class="la lb lc ld gu le gi gj paragraph-image"><div class="gi gj ox"><img src="../Images/f677d38a120de7280e3c8b3ba2a31405.png" data-original-src="https://miro.medium.com/v2/resize:fit:1138/1*quX54WqqjzUjWI7mOQqBxw.gif"/></div><figcaption class="ll lm gk gi gj ln lo bd b be z dk translated">如何从证书链中剥离所有证书的示例</figcaption></figure><p id="0004" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">这是在windows中完成的，但是类似的事情也可以在Mac或Linux中完成。</p><p id="999d" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">从server.cer中剥离所有证书后，我们将拥有不同的。所有ca的cer文件。所以对于上面的例子，我们有4个。cer文件。</p><ul class=""><li id="5b9d" class="oi oj iu kc b kd ke kh ki kl ok kp ol kt om kx ow oo op oq bi translated">根CA(Zeescalar根CA)</li><li id="12d5" class="oi oj iu kc b kd or kh os kl ot kp ou kt ov kx ow oo op oq bi translated">中间CA 1(Zscalar中间根CA)</li><li id="0678" class="oi oj iu kc b kd or kh os kl ot kp ou kt ov kx ow oo op oq bi translated">中间钙(Zscalar中间根钙)</li><li id="0792" class="oi oj iu kc b kd or kh os kl ot kp ou kt ov kx ow oo op oq bi translated">谷歌服务器。cer文件</li></ul><p id="b455" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">现在我们要做的就是把这些<strong class="kc je">全部转换过来。cer </strong>文件到<strong class="kc je">文件。pem </strong>文件，并将它们添加到一起，以创建一个合并的<strong class="kc je"> pem </strong>文件，并将其提供给python请求。</p><p id="2753" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">因此，对于所有cer文件，运行以下命令4次。</p><pre class="la lb lc ld gu ms mt mu mv aw mw bi"><span id="5109" class="mx lq iu mt b gz my mz l na nb">openssl x509 -in server.cer -inform DER -outform PEM  &gt;&gt; consolidate.pem</span></pre><blockquote class="nq nr ns"><p id="1d13" class="ka kb nc kc b kd ke kf kg kh ki kj kk nt km kn ko nu kq kr ks nv ku kv kw kx in bi translated">我们在这里所做的就是创建一个完全成熟的CA包，它拥有所有的证书，无论如何我们都可以做到这一点，这很好。</p></blockquote><p id="5ed6" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">就这样，我们将新的CA pem文件提供给python请求，它很高兴。</p><pre class="la lb lc ld gu ms mt mu mv aw mw bi"><span id="8e68" class="mx lq iu mt b gz my mz l na nb">response = requests.post(url, files=files, headers=headers, verify='consolidate.pem')</span><span id="0c80" class="mx lq iu mt b gz oy mz l na nb">&lt;Response [200]&gt;</span></pre></div><div class="ab cl nw nx hy ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="in io ip iq ir"><p id="6b5e" class="pw-post-body-paragraph ka kb iu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx in bi translated">如果你喜欢这个帖子，请分享或评论这个帖子。任何形式的互动都是非常受欢迎的。如果你想支持我，并获得所有伟大的事情，请加入并成为会员。这是我的推荐链接:</p><div class="oz pa gq gs pb pc"><a href="https://susamn.medium.com/membership" rel="noopener follow" target="_blank"><div class="pd ab fp"><div class="pe ab pf cl cj pg"><h2 class="bd je gz z fq ph fs ft pi fv fx jd bi translated">通过我的推荐链接加入媒体</h2><div class="pj l"><h3 class="bd b gz z fq ph fs ft pi fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pk l"><p class="bd b dl z fq ph fs ft pi fv fx dk translated">susamn.medium.com</p></div></div><div class="pl l"><div class="pm l pn po pp pl pq lj pc"/></div></div></a></div></div><div class="ab cl nw nx hy ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="in io ip iq ir"><h1 id="e168" class="lp lq iu bd lr ls od lu lv lw oe ly lz ma of mc md me og mg mh mi oh mk ml mm bi translated">分级编码</h1><p id="9489" class="pw-post-body-paragraph ka kb iu kc b kd mn kf kg kh mo kj kk kl mp kn ko kp mq kr ks kt mr kv kw kx in bi translated">感谢您成为我们社区的一员！升级正在改变技术招聘。<a class="ae ky" href="https://jobs.levelup.dev/talent" rel="noopener ugc nofollow" target="_blank"> <strong class="kc je">在最好的公司</strong>找到你最理想的工作 </a> <strong class="kc je">。</strong></p><div class="oz pa gq gs pb pc"><a href="https://jobs.levelup.dev/talent" rel="noopener  ugc nofollow" target="_blank"><div class="pd ab fp"><div class="pe ab pf cl cj pg"><h2 class="bd je gz z fq ph fs ft pi fv fx jd bi translated">提升——改变招聘流程</h2><div class="pj l"><h3 class="bd b gz z fq ph fs ft pi fv fx dk translated">🔥让软件工程师找到他们热爱的完美角色🧠寻找人才是最痛苦的部分…</h3></div><div class="pk l"><p class="bd b dl z fq ph fs ft pi fv fx dk translated">作业. levelup.dev</p></div></div><div class="pl l"><div class="pr l pn po pp pl pq lj pc"/></div></div></a></div></div></div>    
</body>
</html>