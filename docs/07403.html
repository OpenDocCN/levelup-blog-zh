<html>
<head>
<title>Optimize The Size Of Your Dockerized Go Application Down To 2MB!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的Dockerized Go应用程序的大小优化到2MB！</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/optimize-the-size-of-your-dockerized-go-application-down-to-2mb-7b826ecb062d?source=collection_archive---------14-----------------------#2021-02-15">https://levelup.gitconnected.com/optimize-the-size-of-your-dockerized-go-application-down-to-2mb-7b826ecb062d?source=collection_archive---------14-----------------------#2021-02-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="ea94" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">想象一下，有一个实际基本映像大小只有<strong class="js iu"> ~30KB </strong>的工作Docker映像，因此您几乎没有任何开销。让我们在这篇文章中实现它。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/914fd171020fffb5e1313a1f3c63eb66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fkANbtnwDv9qeWms"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Wolfgang Hasselmann 在<a class="ae le" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="5589" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">我们能走多远？</h1><p id="dd25" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">因此，您可能会问，是否真的有可能让您的应用程序在30KB的基础映像上运行。长话短说:“是的，它是！”尽管当然也有缺点。</p><p id="185b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以还是先查一些最终结果吧。在下图中，您可以看到三个不同的Docker图像。所有三个图像都包含相同的runnable Go应用程序，一个简单的Hello-World程序，没有什么特别的。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/94a60ec830063d032edc2e09b06f2808.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/format:webp/1*HXXaFMQ8g1OYir6mk2UNMg.png"/></div></figure><ul class=""><li id="f94a" class="mj mk it js b jt ju jx jy kb ml kf mm kj mn kn mo mp mq mr bi translated"><code class="fe ms mt mu mv b">pz/my-go-app-full</code> — <code class="fe ms mt mu mv b"><a class="ae le" href="https://hub.docker.com/_/golang" rel="noopener ugc nofollow" target="_blank">golang:1.15</a></code>被作为基础镜像→整个Go运行时+二进制，完全矫枉过正当然。在这里，更好的方法是使用alpine或slim变体。我还没有在这种特殊情况下测试它，但它应该已经减少了大约90%左右的大小。</li><li id="a447" class="mj mk it js b jt mw jx mx kb my kf mz kj na kn mo mp mq mr bi translated"><code class="fe ms mt mu mv b">pz/my-go-app-alpine</code> — <code class="fe ms mt mu mv b"><a class="ae le" href="https://hub.docker.com/_/alpine" rel="noopener ugc nofollow" target="_blank">alpine:3.13.1</a></code>被用作基础镜像→一个超小型的Linux发行版，只包含最重要的东西。这里没有额外的Go运行时，只是普通的Linux。</li><li id="328a" class="mj mk it js b jt mw jx mx kb my kf mz kj na kn mo mp mq mr bi translated"><code class="fe ms mt mu mv b">pz/my-go-app-scratch</code> — <code class="fe ms mt mu mv b"><a class="ae le" href="https://hub.docker.com/_/scratch" rel="noopener ugc nofollow" target="_blank">scratch</a></code>被用作基础图像→事实上它不是真正的基础图像，但我们告诉Docker我们真的想从<em class="nb">真正的</em>开始。本文稍后将详细介绍<code class="fe ms mt mu mv b">scratch</code>。</li></ul><p id="dd78" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下一张图中，您可以看到根文件夹中的文件，Docker图像是内置的。如你所见，我们的<code class="fe ms mt mu mv b">app</code>，这是我们通过Docker图像运行的Go应用程序，大小约为2MB。由于我们上面从头构建的映像只有2.03MB，与实际应用程序相比，我们可以估计Docker映像的开销只有30KB左右。很棒吧？</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/70082f1efbf317903c38f4bcd799563b.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/format:webp/1*uboAnra1ZBK9RFgTQY2VMw.png"/></div></figure><h1 id="5f85" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">“划痕”图像</h1><blockquote class="nd ne nf"><p id="2ded" class="jq jr nb js b jt ju jv jw jx jy jz ka ng kc kd ke nh kg kh ki ni kk kl km kn im bi translated">"我们能把<code class="fe ms mt mu mv b">FROM scratch</code>用于各种应用程序/语言吗？"</p></blockquote><p id="2b56" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">理论上是的，实际上我们永远不应该。😉</p><p id="db71" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是让我们先来看看这张<code class="fe ms mt mu mv b">scratch</code>图片是关于什么的。首先，根据Docker Hub上的描述，它是在构建仅包含单个二进制文件的基础映像或超最小映像的上下文中最有用的映像。</p><p id="66a8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，从Docker 1.5.0开始，<code class="fe ms mt mu mv b">FROM scratch</code>命令在<code class="fe ms mt mu mv b">Dockerfile</code>中不起作用，因此不会在图像中创建额外的层。尽管<code class="fe ms mt mu mv b">scratch</code>映像在Docker注册表中可用，但它既不能被提取也不能运行，只能在<code class="fe ms mt mu mv b">Dockerfile</code>中被引用。</p><blockquote class="nd ne nf"><p id="0088" class="jq jr nb js b jt ju jv jw jx jy jz ka ng kc kd ke nh kg kh ki ni kk kl km kn im bi translated">“好了好了我明白了。但是我现在可以用它运行我的Node.Js/Python/whatever应用程序吗？”</p></blockquote><p id="0294" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">长回答:</strong>除非你在上面装了Node.js/Python/whatever😐</p><p id="bab7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">很不满意吧？没错，但这是有原因的。如前所述,<code class="fe ms mt mu mv b">scratch</code>形象实际上意味着从零开始。所以里面已经什么都没有了。没有外壳，没有库，没有系统文件，什么都没有。</p><p id="8aa1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为<code class="fe ms mt mu mv b">scratch</code>图像实际上不包含任何内容，所以你也不能通过典型的<code class="fe ms mt mu mv b">docker exec -it CONTAINER /bin/bash</code>在容器中打开bash。因此，在许多情况下，一个至少包含一个shell的<code class="fe ms mt mu mv b">alpine</code>映像可能值额外的5.5MB。😉</p><p id="05b5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除此之外，像JavaScript (Node.js)和Python这样的语言是解释器语言，它们没有被预构建到二进制文件中，所以没有机会在<code class="fe ms mt mu mv b">scratch</code>映像上运行它们。对于JavaScript，您首先必须在那里安装Node.js，这样您的代码就可以在运行时被解释。在Node.js的情况下，我想参考我的另一篇文章<a class="ae le" href="https://medium.com/faun/decreasing-your-node-js-docker-image-size-by-90-84cc1b1093d9" rel="noopener">减少你的Node.js Docker图片大小90%！</a>。</p><div class="nj nk gp gr nl nm"><a href="https://medium.com/faun/decreasing-your-node-js-docker-image-size-by-90-84cc1b1093d9" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd iu gy z fp nr fr fs ns fu fw is bi translated">将Node.js Docker图像尺寸缩小90%！</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">我将通过几个简单的步骤向您展示如何将Node.js应用程序的docker图像大小减少90%左右。</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">medium.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa ky nm"/></div></div></a></div><h1 id="567a" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">实际的Dockerfile文件</h1><blockquote class="nd ne nf"><p id="d762" class="jq jr nb js b jt ju jv jw jx jy jz ka ng kc kd ke nh kg kh ki ni kk kl km kn im bi translated">“好吧，我明白了，使用‘scratch’创建了一个超级高度优化的Docker图像，使用它应该是一个有意识的决定…但我想使用它，所以请给我看代码！”</p></blockquote><p id="e3f2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">既然你问了，我们走吧。在<code class="fe ms mt mu mv b">Dockerfile</code>中直接描述了各个步骤:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="f38e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在让我们构建并运行这个Dockerfile文件，请记住，需要有一个使用<code class="fe ms mt mu mv b">app.go</code>作为入口点的样例Go应用程序。或者，您可以查看我的示例存储库，其中包含一个“Hello World”Go应用程序和上面的<code class="fe ms mt mu mv b">Dockerfile</code>:</p><div class="nj nk gp gr nl nm"><a href="https://github.com/Abszissex/medium-go-docker" rel="noopener  ugc nofollow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd iu gy z fp nr fr fs ns fu fw is bi translated">abszisex/中型码头工人</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">在GitHub上创建一个帐户，为abszisex/medium-go-docker开发做出贡献。</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">github.com</p></div></div><div class="nv l"><div class="od l nx ny nz nv oa ky nm"/></div></div></a></div><pre class="kp kq kr ks gt oe mv of og aw oh bi"><span id="4f91" class="oi lg it mv b gy oj ok l ol om">### Run into root application folder</span><span id="4bd1" class="oi lg it mv b gy on ok l ol om"># Build application in current directory<br/>$ docker build -t pz/my-go-app-scratch . </span><span id="3c18" class="oi lg it mv b gy on ok l ol om"># Run built container once.<br/># '--rm' indicates that the container should be removed aber run<br/>$ docker run --rm pz/my-go-app-scratch</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oo"><img src="../Images/658b7c4a5eed660d86a712c8e03d36c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sHByGDrso-rdTUW_i_pNxQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">构建并运行Docker映像</figcaption></figure><h1 id="bca9" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">最后的话</h1><p id="03fc" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">我希望我能给你一个小诀窍，告诉你如何对你的Go应用程序进行dockerize，并提供一些优化其大小的提示。请记住，从<code class="fe ms mt mu mv b">scratch</code>开始可能会有陷阱，我一般会推荐使用<code class="fe ms mt mu mv b">alpine</code>作为基础映像，因为开销非常小，而且你至少有可能将<code class="fe ms mt mu mv b">exec</code>放入你的运行容器。</p><p id="1c64" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢您花时间阅读我的文章。</p><h2 id="cf54" class="oi lg it bd lh op oq dn ll or os dp lp kb ot ou lt kf ov ow lx kj ox oy mb oz bi translated">你想联系吗？</h2><p id="6350" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">如果你想联系我，请通过<a class="ae le" href="https://www.linkedin.com/in/pascal-zwikirsch-3a95a1177/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我。</p><p id="c598" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另外，请随意查看<a class="ae le" href="https://medium.com/@mr-pascal/my-book-recommendations-4b9f73bf961b" rel="noopener">我的书籍推荐</a>📚。</p></div><div class="ab cl pa pb hx pc" role="separator"><span class="pd bw bk pe pf pg"/><span class="pd bw bk pe pf pg"/><span class="pd bw bk pe pf"/></div><div class="im in io ip iq"><div class="kp kq kr ks gt nm"><a href="https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd iu gy z fp nr fr fs ns fu fw is bi translated">我的书籍推荐</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">在接下来的章节中，你可以找到我对所有日常生活话题的书籍推荐，它们对我帮助很大。</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="nv l"><div class="ph l nx ny nz nv oa ky nm"/></div></div></a></div><div class="nj nk gp gr nl nm"><a href="https://mr-pascal.medium.com/membership" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd iu gy z fp nr fr fs ns fu fw is bi translated">通过我的推荐链接加入Medium—Pascal Zwikirsch</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="nv l"><div class="pi l nx ny nz nv oa ky nm"/></div></div></a></div></div></div>    
</body>
</html>