<html>
<head>
<title>Moving your Prefect flow from local to the cloud. Here’s how.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的完美流程从本地迁移到云。以下是方法。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/moving-your-prefect-flow-from-local-to-the-cloud-heres-how-64ba140172ae?source=collection_archive---------6-----------------------#2022-03-14">https://levelup.gitconnected.com/moving-your-prefect-flow-from-local-to-the-cloud-heres-how-64ba140172ae?source=collection_archive---------6-----------------------#2022-03-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="7b2d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从将测试从本地转移到云上的经验。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/1564e3e956a044249ec5a216496be2ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vOO8lkymrDB-h8bd"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">伯纳德·赫曼特在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="357f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我可爱的读者们。几周前，我写了一篇<a class="ae le" href="https://blog.devgenius.io/airflow-theres-a-new-competitor-in-town-d59b48a642ff" rel="noopener ugc nofollow" target="_blank">文章</a>，讲述了我是如何开始将Prefect视为我的工作流管理系统的。我没有意识到人们对perfect有多大兴趣，所以我决定继续展示我的进展，因为我正在开发从本地到生产的perfect工作流管理。在这篇特别的文章中，我将讨论我是如何从本地测试转向云中测试的。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="21dd" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">什么是提督？</h1><p id="b560" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">Prefect是一个开源的工作流管理系统，用户可以在其中将任务组织成流。有两种方法来设置它——自托管或云托管。Prefect的一个关键卖点是，它不需要访问您的代码，因为您将代码存储在存储中，无论是本地存储、云中的数据湖存储还是docker文件存储。</p><p id="d719" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在Prefect支持的所有集成中，它集成了dbt和great expectations，这两个非凡的工具将有助于提高数据质量。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="84ab" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">我如何开始使用提督？</h1><p id="7cb9" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">这是代码。我从Infinite Lambda创建的<a class="ae le" href="https://github.com/infinitelambda/prefect-pipeline" rel="noopener ugc nofollow" target="_blank"> git repo </a>开始；它将解释你将看到的相似之处。</p><p id="7da5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我做的一些改变</p><ol class=""><li id="3aaa" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">我把流程和任务放在一个文件夹里。</li><li id="1c95" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">添加了一个. pylintrc来将标准应用到我的python代码中</li><li id="d304" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">添加virtualenv和requirements.txt</li></ol><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="26eb" class="ni ln it ne b gy nj nk l nl nm"><strong class="ne iu">Folder Structure</strong><br/>.<br/>|-- virtualenv/<br/>|-- flows/<br/>|   |-- pokemon1<br/>|   |   |-- flow.py<br/>|   |   `-- task.py<br/>|   `-- utilities<br/>|       |-- config.py <br/>|-- Dockerfile<br/>|-- .pylintrc<br/>`-- requirements.txt</span></pre><p id="650c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是我开始在本地测试的流程。我只在最后加了flow.run()。</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="eb33" class="ni ln it ne b gy nj nk l nl nm">#flow.py<br/>from datetime import timedelta<br/>from prefect import Flow<br/><br/>from pokemon1.task import ExtractPokemon, TransformPokemon, LoadPokemon<br/><br/>extract_pokemon = ExtractPokemon()<br/>transform_pokemon = TransformPokemon()<br/>load_pokemon = LoadPokemon()<br/><br/><br/>with Flow("PokeFlow") as flow:<br/>     extracted_pokemon = extract_pokemon()<br/>     transformed_pokemon = transform_pokemon.map(extracted_pokemon)<br/>     loaded_pokemon = load_pokemon(transformed_pokemon)<br/>     flow.run()</span></pre><p id="7784" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">任务文件和<a class="ae le" href="https://github.com/infinitelambda/prefect-pipeline/blob/master/tasks/pokemontasks.py" rel="noopener ugc nofollow" target="_blank">口袋妖怪任务</a>一模一样。</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="455c" class="ni ln it ne b gy nj nk l nl nm">#task.py<br/>import requests<br/>import prefect<br/>from prefect import Task<br/><br/>class ExtractPokemon(Task):<br/>    def run(self, **kwargs):<br/>        logger = prefect.context.get("logger")<br/>        url = "https://pokeapi.co/api/v2/pokemon?limit=151"<br/>        response = requests.get(url)<br/>        if response.ok: <br/>            return response.json()<br/>        logger.warning(<br/>            "Could not load pokemon list! Error {}".format(response.status_code)<br/>        )<br/>        return {"results": []}<br/><br/><br/>class TransformPokemon(Task):<br/>    def run(self, pokemon):<br/>        logger = prefect.context.get("logger")<br/>        url = pokemon["url"]<br/>        name = pokemon["name"].title()<br/>        logger.info("Getting {} from {}".format(name, url))<br/>        response = requests.get(url)<br/>        if response.ok:<br/>            return response.json()<br/>        logger.warning(<br/>            "Could not load pokemon {}! Error {}".format(name, response.status_code)<br/>        )<br/>        return {} <br/>        <br/>        <br/>class LoadPokemon(Task):<br/>    def run(self, pokemon):<br/>        logger = prefect.context.get("logger")<br/>        logger.info(len(pokemon))</span></pre></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="5371" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated"><strong class="ak">云部署</strong></h1><p id="fd61" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated"><strong class="js iu">概述</strong></p><p id="4f69" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我设置我的代码来注册这个流，以便在Prefect Cloud中使用。下面是我打算如何从头到尾设置我的部署的简单概述。注意，我确实在微软Azure工作。不幸的是，我还没有接触到Github Actions和Azure Kubernetes。然而，我确实设置了Azure容器注册中心，并且可以将图像推送到该注册中心。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nn"><img src="../Images/d621b95362121df44cbafb091cd4cee1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vwFqWE-AJJY8Uj1HG7tD9w.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">作者已创建。</figcaption></figure><p id="76cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Github Actions构建Dockerfile并将该图像推送到Azure容器注册中心。这张图片随后被用于Kubernetes的工作中。</p><p id="b779" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">更新流程</strong></p><p id="92dc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我使用了与上面相同的flow.py，只是添加了storage_config变量，我用斜体显示了该变量。</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="f970" class="ni ln it ne b gy nj nk l nl nm">#flow.py<br/>from datetime import timedelta</span><span id="4b9d" class="ni ln it ne b gy no nk l nl nm">from prefect.run_configs import KubernetesRun<br/>from prefect.storage import Docker<br/>from prefect import Flow<br/><br/>from pokemon1.task import ExtractPokemon, TransformPokemon, LoadPokemon<br/><br/><em class="np">storage_config = Docker(registry_url</em><strong class="ne iu"><em class="np">=</em></strong><em class="np">"</em>&lt;registry name&gt;.azurecr.io<em class="np">", image_name</em><strong class="ne iu"><em class="np">=</em></strong><em class="np">"flow_utilities")</em></span><span id="8b85" class="ni ln it ne b gy no nk l nl nm">extract_pokemon = ExtractPokemon()<br/>transform_pokemon = TransformPokemon()<br/>load_pokemon = LoadPokemon()<br/><br/><br/>with Flow("PokeFlow",<br/>storage = storage<br/>) as flow:<br/>     extracted_pokemon = extract_pokemon()<br/>     transformed_pokemon = transform_pokemon.map(extracted_pokemon)<br/>     loaded_pokemon = load_pokemon(transformed_pokemon)<br/>     flow.run()</span></pre><p id="8e8a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">将Dockerfile推送到Azure容器注册表</strong></p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="0008" class="ni ln it ne b gy nj nk l nl nm">#Dockerfile<br/>FROM prefecthq/prefect:1.0.0-python3.8<br/>RUN /usr/local/bin/python -m pip install --upgrade pip<br/>WORKDIR /opt/prefect<br/>COPY flows/ /opt/prefect/flow_utilities/<br/>COPY requirements.txt .<br/>RUN pip install -r requirements.txt</span></pre><p id="d49e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有了上面的docker文件，我需要确保它能够构建。</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="e384" class="ni ln it ne b gy nj nk l nl nm">docker build -t flow_utilities .</span></pre><p id="b182" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">确保映像成功运行</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="e707" class="ni ln it ne b gy nj nk l nl nm">docker run --rm -it flow_utilities</span></pre><p id="68cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，让我们登录Azure容器注册中心。</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="620e" class="ni ln it ne b gy nj nk l nl nm">az acr login --name &lt;registry name&gt; #--user &lt;username&gt; --password &lt;password&gt;</span></pre><p id="7e37" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后一步。标记并推送到注册表。</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="4ad7" class="ni ln it ne b gy nj nk l nl nm">docker tag flow_utilities:latest &lt;registry name&gt;.azurecr.io/images/flow_utilities:latest<br/>docker push &lt;registry name&gt;.azurecr.io/images/flow_utilities:latest</span></pre><p id="ed77" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以从蓝色的一面出发。</p><p id="afad" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">设置提督云</strong></p><p id="9c5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后一步是从提督一方着手。</p><p id="baf8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们需要从UI中获取API密钥，方法是在UI中导航到帐户设置&gt; API密钥，然后单击“创建API密钥”。</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="1eb6" class="ni ln it ne b gy nj nk l nl nm">prefect auth login --key <strong class="ne iu">&lt;</strong>YOUR-KEY<strong class="ne iu">&gt;</strong></span></pre><p id="c6bd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">后端已经用云设置好了，所以我们不用担心这个。下一步是选择一个项目或使用cli创建一个新项目:</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="998d" class="ni ln it ne b gy nj nk l nl nm">prefect create project "&lt;your phenomenal project name&gt;"</span></pre><p id="7c5e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，我们需要启动本地代理。</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="0dcc" class="ni ln it ne b gy nj nk l nl nm">prefect agent <strong class="ne iu">local</strong> start</span></pre><p id="bc5a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以在UI中的“代理”下(在顶栏上)验证代理是否已向提督注册。然后，验证代理确实可以访问容器注册表。我们目前使用本地代理，所以你只需要确保你的计算机可以访问容器注册表。</p><p id="d817" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们将注册我们刚刚创建的流。</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="f09a" class="ni ln it ne b gy nj nk l nl nm">prefect register --project "&lt;your phenomenal project name&gt;" --path flows/pokemon1/flow.py --name "hello-flow"</span></pre><p id="adf3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你会在提督云UI看到这样的东西:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nq"><img src="../Images/f451152510e8f8d02ea05139e4131f8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*htbYu6r9sKD7jeVY.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">显示流程状态和日志记录的报告</figcaption></figure><p id="25da" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们触发流程运行。</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="e709" class="ni ln it ne b gy nj nk l nl nm">prefect run -n "hello-world" --watch</span></pre></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="fbf3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">事情我还想补充一下</strong></p><p id="079d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这只是实现提督的开始，所以下面是我的其他建议和/或我想实现的想法。</p><ol class=""><li id="3413" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">我想实现我今天在github actions CICD管道中使用的许多命令。</li><li id="a9b6" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">我想添加一个registry.py来注册一个目录中的所有流。</li><li id="27a0" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">获取要通过UI触发的流</li><li id="ae57" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">让流在Kubernetes集群上运行</li></ol></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="a284" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">随着我在这方面的进展，我将继续发帖。</p><pre class="kp kq kr ks gt nd ne nf ng aw nh bi"><span id="dcae" class="ni ln it ne b gy nj nk l nl nm"><strong class="ne iu">References<br/></strong>1. <a class="ae le" href="https://docs.prefect.io/orchestration/getting-started/registering-and-running-a-flow.html#register-a-flow" rel="noopener ugc nofollow" target="_blank">https://docs.prefect.io/orchestration/getting-started/registering-and-running-a-flow.html#register-a-flow</a><br/>2. <a class="ae le" href="https://github.com/anna-geller/packaging-prefect-flows" rel="noopener ugc nofollow" target="_blank">https://github.com/anna-geller/packaging-prefect-flows</a></span></pre></div></div>    
</body>
</html>