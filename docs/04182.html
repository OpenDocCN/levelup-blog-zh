<html>
<head>
<title>Multithreading in Python using mp.pool</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用mp.pool的Python多线程</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/multithreading-in-python-using-mp-pool-ddf8ddc9cf69?source=collection_archive---------3-----------------------#2020-06-13">https://levelup.gitconnected.com/multithreading-in-python-using-mp-pool-ddf8ddc9cf69?source=collection_archive---------3-----------------------#2020-06-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="95f8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Python中多线程的真实例子</h2></div><p id="c01f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不久前，我们的内容团队将图像上传到我们的图像服务器——将png转换为jpg。不幸的是，由于不正确的配置，PNG的背景(Alpha = 0，透明)被转换为黑色。花了很多天想办法识别这些图像并替换它们。总共有大约20，000张图像，每张图像都存储在一个层叠的文件夹结构中——消除了手工操作的可能性。</p><p id="ca0a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所有其他选择都用尽了。</p><p id="6645" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我认为解决这个问题的最好方法是通过Python。起初，逻辑似乎很简单——因为图像曾经是透明的图像背景，偏移像素读数将揭示背景是黑色还是白色。逻辑很简单:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/919445c5eaf87d9ba658f254df3098ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9IMJlv09napTNCg-4T8Qjw.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">从一组图像中提取单个像素信息的简单逻辑。</figcaption></figure><p id="2e8a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为代码:</p><pre class="lf lg lh li gt lu lv lw lx aw ly bi"><span id="85b6" class="lz ma it lv b gy mb mc l md me">###### single-threaded work #########<br/>import os<br/>from os import listdir<br/>from os.path import isfile, join<br/>from PIL import Image</span><span id="21e4" class="lz ma it lv b gy mf mc l md me">sep = ","<br/>mypath = "default/images"<br/>listOfPath = []<br/>new_file=open("newfile.txt",mode="w")</span><span id="b3d0" class="lz ma it lv b gy mf mc l md me">### for creating the list of images with their paths<br/>for r, d, f in os.walk(mypath):<br/>    for file in f:<br/>        if file.endswith(".jpg"):<br/>            listOfPath.append([file,r])</span><span id="4fab" class="lz ma it lv b gy mf mc l md me">#### generating data for each image<br/>for file, r in listOfPath:<br/> upc = r.replace(mypath + "/","")  ## product ID<br/> imgPath = os.path.join(r, file) <br/> im = Image.open(imgPath, 'r')<br/> width, height = im.size<br/> pixel_values = list(im.getdata())<br/> val = pixel_values[width*5+5]<br/> new_file.write(upc + sep + imgPath + sep + str(sum(list(val))) + "\n")<br/></span></pre><p id="72b1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我希望在2016年的MBP上加载和卸载20k张图片不会超过30分钟。不幸的是，在15分钟内，只有900张图像被处理，我真的等不了5个小时。查看活动监视器，我发现只有4个处理器是活动的！</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mg"><img src="../Images/0bb958b8fa88f0c48d26ea8a3308c067.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BIaHEojryyxUQM1Tlr1W5A.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">142幅图像的屏幕上限。为什么没有使用其他处理器？</figcaption></figure><p id="cf7f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我知道MBP有4个物理内核和8个逻辑内核，因此只有4个物理内核在使用，但我在Spotify上流式传输，并在旁边做了一些其他工作…注意，python进程是单线程。</p><p id="bb85" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">只有一个工人在工作，其他人都在休息。<strong class="kk iu">无法接受！</strong></p><h1 id="4ee5" class="mh ma it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">mp.pool和缺乏实际解释</h1><p id="270d" class="pw-post-body-paragraph ki kj it kk b kl my ju kn ko mz jx kq kr na kt ku kv nb kx ky kz nc lb lc ld im bi translated">我认为Python有多处理选项。然而，关于mp.pool的实用文档很少——特别是对于我的上下文。</p><p id="0c26" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">深入挖掘之后，我意识到我要使用<em class="nd"> pool.apply_async </em>方法。下面是逻辑流程(带有函数名):</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ne"><img src="../Images/b525f770138bdb30a89a365a40711b0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wO6-IPkgBbU3SjnUFlnlUg.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">多线程— pool.apply_async</figcaption></figure><p id="cb9d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">代码如下:</p><pre class="lf lg lh li gt lu lv lw lx aw ly bi"><span id="53db" class="lz ma it lv b gy mb mc l md me">######## Multi-thread image processing ########</span><span id="952f" class="lz ma it lv b gy mf mc l md me">from PIL import Image<br/>import os<br/>from os import listdir<br/>from os.path import isfile, join<br/>import multiprocessing as mp<br/>import func<br/>import time</span><span id="0c14" class="lz ma it lv b gy mf mc l md me">nprocs = mp.cpu_count()<br/>start = time.time()</span><span id="36c5" class="lz ma it lv b gy mf mc l md me">pool = mp.Pool(processes=(nprocs))<br/>results = []<br/>new_file=open("newfile.txt",mode="w")</span><span id="1963" class="lz ma it lv b gy mf mc l md me">#mypath = "Test"<br/>mypath = "Dev/"<br/>sep = ","<br/>i = 1<br/>listOfPath = []</span><span id="fd8c" class="lz ma it lv b gy mf mc l md me">def echoChamber(result):<br/>    new_file.write(result)</span><span id="5e98" class="lz ma it lv b gy mf mc l md me">### listOfPath Extract #####<br/>for r, d, f in os.walk(mypath):<br/>    for file in f:<br/>        if file.endswith(".jpg"):<br/>            ###xprintLine(file,r,i)<br/>            listOfPath.append([file,r])</span><span id="dc28" class="lz ma it lv b gy mf mc l md me">for i, row in listOfPath:<br/>    pool.apply_async(func.xprintLine2, args=(i,row), callback=echoChamber)</span><span id="b36e" class="lz ma it lv b gy mf mc l md me">pool.close()<br/>pool.join()<br/>end = time.time()<br/>print(end - start)</span><span id="1312" class="lz ma it lv b gy mf mc l md me">######## Close File ############</span><span id="7da7" class="lz ma it lv b gy mf mc l md me">###### functions file - func.py #########<br/>import os<br/>from os import listdir<br/>from os.path import isfile, join<br/>from PIL import Image</span><span id="83d2" class="lz ma it lv b gy mf mc l md me">sep = ","<br/>replacePath = "default/images"</span><span id="40ec" class="lz ma it lv b gy mf mc l md me">def xprintLine2(file,r):<br/> file = str(file)<br/> r = str(r)<br/> <br/> upc = r.replace(replacePath + "/","") ## ignore - for internal use<br/> <br/> imgPath = os.path.join(r, file)<br/> im = Image.open(imgPath, 'r')<br/> width, height = im.size<br/> pixel_values = list(im.getdata())<br/> val = pixel_values[width*5+5]<br/> #new_file.write(upc + sep + imgPath + sep + str(sum(list(val))) + "\n")<br/> print("Ritten :" + upc)<br/> return (upc + sep + imgPath + sep + str(sum(list(val))) + "\n")</span><span id="c4a3" class="lz ma it lv b gy mf mc l md me">########### save this part separately #######</span></pre><p id="de1b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，有几件事你必须注意:</p><ol class=""><li id="b999" class="nf ng it kk b kl km ko kp kr nh kv ni kz nj ld nk nl nm nn bi translated">我不以编码为生——因此我的代码打破了常规。不良的编码实践在临时编码类型中泛滥。</li><li id="3ff6" class="nf ng it kk b kl no ko np kr nq kv nr kz ns ld nk nl nm nn bi translated">这只是mp.pool的方式之一，你可以在这里看到更多的<a class="ae nt" href="https://www.geeksforgeeks.org/multiprocessing-python-set-1/#:~:text=In%20Python%2C%20the%20multiprocessing%20module,dividing%20work%20between%20multiple%20processes.&amp;text=print%20(%20%22Done!%22%20)&amp;text=Square%3A%20100%20Cube%3A%201000%20Done!&amp;text=To%20create%20a%20process%2C%20we%20create%20an%20object%20of%20Process%20class." rel="noopener ugc nofollow" target="_blank"/></li><li id="18fa" class="nf ng it kk b kl no ko np kr nq kv nr kz ns ld nk nl nm nn bi translated">使用这段代码的速度提高了3.6倍——在127幅图像的样本中，单线程用了103秒，而多线程(@ 8)用了28秒。这意味着，我们有4个处理器来完成这项工作(假设一个处理器完成整个加载/卸载过程需要0.8秒，即103/127 ~ 1.2毫克/秒)</li></ol><p id="5c31" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是所有处理器启动时的样子:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mg"><img src="../Images/534b72e1dd1041b5de01a68cdff8b4bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wqCX_FVj7L229f5CE6_Q0A.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">所有处理器运行！</figcaption></figure><p id="aba3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最终的输出基本上是产品id、图像URL和像素值(0到765，因为我们正在合并RGB通道值)。我可以写“黑色”或“白色”,但不想假设，因为可能有(5，5)像素携带实际颜色值的图像。</p><h1 id="8558" class="mh ma it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">摘要</h1><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nu"><img src="../Images/90fd9419a84e1118a00c607feb5dd1e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MD_Gxlc4GyffwE-0vY45Fw.png"/></div></div></figure></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><p id="de57" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢您的阅读！如果这对你有帮助，请告诉我。</p></div></div>    
</body>
</html>