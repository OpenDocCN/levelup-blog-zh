<html>
<head>
<title>How To Import JSON From Amazon S3 to PostgreSQL on RDS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将JSON从亚马逊S3导入到RDS上的PostgreSQL</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-import-json-from-s3-to-postgresql-on-rds-b132357af39e?source=collection_archive---------1-----------------------#2020-12-20">https://levelup.gitconnected.com/how-to-import-json-from-s3-to-postgresql-on-rds-b132357af39e?source=collection_archive---------1-----------------------#2020-12-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d80b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">并包含在事件驱动工作流中</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/863078e49859f0b83b69512533e7d449.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*waqpA4V8swM5CJbvwo_93A.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">波洛卢山谷，照片由我拍摄</figcaption></figure><h1 id="6da4" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">介绍</h1><p id="7d7f" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">我一直在做一个项目，要求我将亚马逊S3桶中的分区JSON文件导入到亚马逊RDS上的PostgreSQL数据库中。我曾在另一个项目中做过类似的事情——将JSON与<a class="ae mj" href="https://aws.amazon.com/kinesis/data-streams/" rel="noopener ugc nofollow" target="_blank"> Kinesis数据流</a>一起带入S3，并执行ETL以填充亚马逊红移集群中的暂存表——所以我认为在同一云平台上定位不同的存储服务，以及最初作为另一个(红移)的基础的存储技术(PostgreSQL)会相当简单。毕竟，我可以使用同一个数据库适配器连接到Python的任何一个存储解决方案，所以也许我可以只替换一些连接字符串参数值并继续移动。呃，没那么快。</p><h1 id="9818" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">背景</h1><p id="3f81" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">红移是亚马逊的专有技术，S3也是，亚马逊经常为他们自己的技术之间的集成和通信提供直接的路径。另一方面，PostgreSQL是一个开源的关系数据库管理系统，亚马逊将其用于其云平台，并作为一种品牌化的托管服务提供，类似于其他操作系统技术，如Apache Hadoop、Kafka、Cassandra等。为了完成前面提到的将JSON从S3导入到RDS上的PostgreSQL的任务，我必须做一些研究，同时还要反复试验。在这个过程中，我注意到其他人也想做同样的事情，但我无法在网上找到直接的解决方案，所以我从各种资源中拼凑了一个解决方案，我想我应该分享一下在我的情况下行之有效的方法。</p><h1 id="20b8" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">战斗支援车</h1><p id="d01e" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">我还需要将CSV导入PostgreSQL，并做了另一个错误的假设——我可以使用COPY命令从任一文件类型中移动数据，并相应地更改FORMAT参数选项的值。我是说，红移也是这样的，为什么不呢？又错了。这篇文章主要是关于从S3引入JSON的，但是我也会简单地提到CSV需要什么，因为这有助于引出JSON的解决方案。</p><p id="e406" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">对于CSV，我们需要在PostgresSQL版本11.1或更高版本上，并在我们的数据库上安装<a class="ae mj" href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/PostgreSQL.Procedural.Importing.html#USER_PostgreSQL.S3Import.FileFormats" rel="noopener ugc nofollow" target="_blank"> aws_s3和aws_commons扩展</a>。两者都可以在使用pgAdmin或其他SQL客户端工具连接到RDS上的PostgreSQL数据库时执行一个命令来安装。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="e88c" class="mu kw iq mq b gy mv mw l mx my">CREATE EXTENSION aws_s3 CASCADE;</span></pre><p id="305d" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">下面是一个可用于从S3导入CSV数据的SQL示例:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="bfc6" class="mu kw iq mq b gy mv mw l mx my">SELECT aws_s3.table_import_from_s3(<br/>  'my_table', <br/>  'optional_column_list', <br/>  '(FORMAT CSV, HEADER true)', <br/>  'my_bucket', <br/>  '/path/my_file.csv', <br/>  'us-west-2'<br/>);</span></pre><p id="67b8" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">该语句要求数据库表中的列与' optional_column_list '中指定的列相对应。如果为该参数传递一个空字符串，则查询将期望CSV文件中的每个分隔值都有一列。</p><h1 id="5be0" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">JSON</h1><p id="e55b" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">对于JSON，一种方法是将文件转换成CSV格式，并使用aws_s3.table_import_from_s3函数来执行导入，如上所述。在我的例子中，我决定接受JSON的无模式特性，并利用Postgres 9.4引入的JSONB数据类型。第一步是创建一个带有JSONB数据类型字段的表。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="5645" class="mu kw iq mq b gy mv mw l mx my">CREATE TABLE IF NOT EXISTS json_table (<br/>  id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,<br/>  ingested_at timestamp DEFAULT CURRENT_TIMESTAMP,<br/>  data jsonb NOT NULL<br/>);</span></pre><p id="d7c0" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">我将从上面提到的<a class="ae mj" href="https://github.com/mikeacosta/florasense" rel="noopener ugc nofollow" target="_blank">项目</a>中导入IOT传感器数据。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="96fc" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">下面是将JSON从S3导入到RDS上的PostgreSQL的Python代码。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="2f9a" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">代码非常简单明了。我们正在从S3下载JSON文件并执行COPY语句</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/515615f9d09db4dae114d864f9c1d7b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ELqDlN9vxdMocAr7SqwwYw.png"/></div></div></figure><p id="7fd1" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">现在，我们可以利用PostgreSQL提供的许多JSONB <a class="ae mj" href="https://www.postgresql.org/docs/12/functions-json.html#FUNCTIONS-JSON-PROCESSING" rel="noopener ugc nofollow" target="_blank">操作符和函数</a>。</p><p id="04d4" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">对于我的用例，我将数据从S3导入到PostgreSQL，作为一个更大的ETL工作流的一部分，所以我在AWS上的一个<a class="ae mj" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> Lambda函数</a>中实现了导入功能。我还添加了一个<a class="ae mj" href="https://aws.amazon.com/sns" rel="noopener ugc nofollow" target="_blank"> SNS </a>通知，它会在每次调用函数时发布，还添加了一个<a class="ae mj" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank">云形成</a>模板，用于打包和部署函数以及AWS的所有依赖项。完整源代码在<a class="ae mj" href="https://github.com/mikeacosta/s3-json-to-postgresql" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上。</p><div class="nc nd gp gr ne nf"><a href="https://github.com/mikeacosta/s3-json-to-postgresql" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd ir gy z fp nk fr fs nl fu fw ip bi translated">Mike Costa/S3-JSON-to-PostgreSQL</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">AWS Lambda函数将JSON数据导入RDS上的PostgreSQL数据库，以响应亚马逊S3事件…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">github.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt kp nf"/></div></div></a></div><h1 id="56b9" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">结论</h1><p id="0917" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">这是一个如何将JSON数据从S3导入RDS上的PostgreSQL的例子。如果您需要数据符合特定的模式，JSONB提供了一些引人注目的特性来实现这一点。也许我们会在以后的文章中讨论这个问题。感谢阅读！</p></div></div>    
</body>
</html>