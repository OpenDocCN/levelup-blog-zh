<html>
<head>
<title>Single Model Approach in Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">围棋中的单模型方法</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/single-model-approach-in-go-27f5c2633bb8?source=collection_archive---------5-----------------------#2022-07-19">https://levelup.gitconnected.com/single-model-approach-in-go-27f5c2633bb8?source=collection_archive---------5-----------------------#2022-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/1521d72ff5163017f2de21dcd941d11f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RrW91E6uQGO3BKNA"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated"><a class="ae jd" href="https://unsplash.com/@courtwhim?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">法院</a>在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><div class=""/><p id="9748" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于许多应用程序API，大多数API调用最终都是围绕数据库记录的瘦CRUD(创建、读取、更新、删除)包装器。这意味着在代码中通常会有一个表示数据库记录的结构。您还需要将这些数据封送到网络，以便为您的API返回这些数据。在微服务环境中，您通常还有一个API客户端，用于将连接格式解析回结构以供使用。许多服务器架构模式建议隔离这些不同的关注点，包括为所有三个地方设置单独的对象。</p><p id="51f5" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在几个地方看到过这种模式。我最近管理了一个用Java编写这种模式代码的团队。经常会有由于忘记给一个对象添加新字段而导致的错误。它还需要维护许多方法来将字段从一种表示复制到另一种表示。我曾与一些优步的工程师交谈过，他们出于各种原因在他们的代码中做了同样的事情，比如在一个大型团队中协调客户机/服务器API更新的困难，或者使用gRPC生成的结构难以进行某些类型的修改。gRPC for Go将为服务器和客户机默认使用相同的对象生成存根，但是出于其他目的修改生成的代码并不是一个好主意。我还听说一些团队会从原型文件中生成他们自己的客户端，以锁定可能的更改，或者试图将代码从源代码中“分离”。这意味着许多结构都表示同一个数据对象。</p><p id="d9b9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我在Tonal看到同样的模式出现时，我质疑是否有必要拥有多个结构，或者是否可以对所有事情使用同一个结构。我总是认为最好是有一个单一的真理来源，所以有一个单一的结构对我来说很有吸引力。我们使用<a class="ae jd" href="https://gorm.io" rel="noopener ugc nofollow" target="_blank"> gorm </a>来包装postgres，并且我们有一个简单的REST JSON API，所以我们需要一个DB模型以及API的服务器和客户端。起初，我担心我错过了什么，如果我违背常识，这些东西会回来咬我们。但是考虑到我们的小团队，以及我希望这将防止我在过去看到的错误类型，我冒险决定我们只有一个模型结构。</p><p id="7dc5" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在系统内工作乍一看确实有点奇怪，因为这个结构既有gorm(数据库装饰器，如索引和主键)的标签，也有JSON的标签。这些都不会在特定的上下文中使用；进行客户端调用的其他服务不知道或不关心另一个服务如何存储/获取记录。而且数据库层不关心JSON。一旦我们习惯了这种模式，这种结构对我们非常有用。它完全去除了样板复制方法，单一的模型结构意味着数据只有一个真实的来源。</p><p id="5a6d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们使用gorm的<a class="ae jd" href="https://pkg.go.dev/gorm.io/gorm#DB.AutoMigrate" rel="noopener ugc nofollow" target="_blank"> AutoMigrate </a>特性，该特性基于struct中的字段创建和修改数据库结构。添加存储在数据库中并在API中返回的新字段只需一行代码。我们利用struct标记偶尔隐藏JSON序列化或DB存储中的字段。</p><p id="2ea9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">模特的位置也值得注意。我们遵循我在这里更广泛地谈到过的组织结构<a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/go-project-structure-5157f458c520"/>。TL；dr是我们有一个规定，不允许跨微服务导入包。执行服务器处理程序的控制器代码和执行数据库操作的存储库代码归微服务所有，它们从顶层共享包中导入模型结构。客户端代码在同一个顶层包中，因为客户端跨多个微服务使用。这里有一个例子:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="d3bf" class="lk ll jg lg b gy lm ln l lo lp">workouts/            // business logic shared lib<br/>    client.go        // client APIs for *Workout<br/>    models.go        // contains Workout struct<br/>cmd/<br/>    workouts-service/<br/>        main.go<br/>        app/         <br/>            setup.go      // gorm AutoMigrate for *workouts.Workout<br/>        workouts/    <br/>            controller.go // server APIs for *workouts.Workout<br/>            repo.go       // DB access for *workouts.Workout</span></pre><p id="867e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还有许多API，它们与数据库不是一一对应的，在这种情况下，我们有单独的模型。但是对于大多数人来说，这种方法在过去的4年里非常有效，没有严重的副作用。该解决方案干净、简单且易于维护，可能也非常适合您的Go微服务。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="e64c" class="lx ll jg bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">分级编码</h1><p id="f677" class="pw-post-body-paragraph kd ke jg kf b kg mu ki kj kk mv km kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="a231" class="mz na jg kf b kg kh kk kl ko nb ks nc kw nd la ne nf ng nh bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="adfd" class="mz na jg kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated">📰查看更多内容在<a class="ae jd" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">关卡升级编码</a></li><li id="8b92" class="mz na jg kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated">🔔关注我们:<a class="ae jd" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae jd" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae jd" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li><li id="56c7" class="mz na jg kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated">🚀👉<a class="ae jd" href="https://jobs.levelup.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf jh">软件工程师的热门职位</strong> </a></li></ul></div></div>    
</body>
</html>