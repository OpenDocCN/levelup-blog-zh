<html>
<head>
<title>Key Wrapping in Javascript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Javascript中的密钥包装</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/javascript-key-wrapping-188da1d6e9d0?source=collection_archive---------17-----------------------#2022-04-24">https://levelup.gitconnected.com/javascript-key-wrapping-188da1d6e9d0?source=collection_archive---------17-----------------------#2022-04-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8b8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我研究Javascript中的键包装时，我没有找到任何实现的具体例子。这就是为什么我写这篇文章来展示一个使用Javascript的键包装的例子。</p><p id="ffed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">密钥包装本身是用一个密钥加密另一个密钥的活动。这方面的一个例子是https中的SSL/TLS握手。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="e82d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">问题陈述</strong></p><ol class=""><li id="e24a" class="ks kt iq jp b jq jr ju jv jy ku kc kv kg kw kk kx ky kz la bi translated">使用纯Javascript代码的密钥包装</li><li id="5c66" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">包装密钥是AES，包装密钥使用RSA公钥</li></ol></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="4a14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">解决方案</strong></p><p id="f654" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该解决方案是利用网络加密API创建的。大多数现代浏览器中都有这个API。该解决方案的示例流程如图1所示。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/7eb0b12b3e3637fdba5e92bb690d1ccb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H8A-mzVaAJlyzmO805pjAw.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">图一。关键包装流程</figcaption></figure><p id="73a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如图1所示，发生了以下事件:</p><ol class=""><li id="936c" class="ks kt iq jp b jq jr ju jv jy ku kc kv kg kw kk kx ky kz la bi translated">Alice为包装密钥生成RSA密钥对</li><li id="b8a9" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">Bob为包装密钥生成AES密钥，</li><li id="f980" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">Alice将RSA公钥导出为JWK格式，</li><li id="8cbc" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">Bob将AES密钥导出为JWK格式，</li><li id="4604" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">Alice将RSA公钥JWK发送给Bob，</li><li id="eb43" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">Bob接收JWK并导入RSA公钥，</li><li id="c202" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">Bob用RSA公钥加密AES密钥并转换成JSON，</li><li id="633e" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">鲍勃把JSON发送给爱丽丝，</li><li id="7e4e" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">Alice将JSON数据转换成ArrayBuffer，</li><li id="b51a" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">Alice解密ArrayBuffer并将结果解析为object，</li><li id="2f5c" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">Alice使用no.10中的对象导入AES密钥，</li><li id="4472" class="ks kt iq jp b jq lb ju lc jy ld kc le kg lf kk kx ky kz la bi translated">现在Alice有了AES密钥，可以开始加密/解密她和Bob之间的数据</li></ol></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="feb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">代码片段</strong></p><ol class=""><li id="768f" class="ks kt iq jp b jq jr ju jv jy ku kc kv kg kw kk kx ky kz la bi translated">生成RSA密钥对</li></ol><pre class="lh li lj lk gt lw lx ly lz aw ma bi"><span id="7bef" class="mb mc iq lx b gy md me l mf mg">window.crypto.subtle.generateKey(</span><span id="e30b" class="mb mc iq lx b gy mh me l mf mg">{</span><span id="c3ec" class="mb mc iq lx b gy mh me l mf mg">name: "RSA-OAEP",</span><span id="9184" class="mb mc iq lx b gy mh me l mf mg">modulusLength: 4096,</span><span id="b164" class="mb mc iq lx b gy mh me l mf mg">publicExponent: new Uint8Array([1, 0, 1]),</span><span id="87ba" class="mb mc iq lx b gy mh me l mf mg">hash: "SHA-256"</span><span id="8a16" class="mb mc iq lx b gy mh me l mf mg">},</span><span id="5632" class="mb mc iq lx b gy mh me l mf mg">true,</span><span id="cf2e" class="mb mc iq lx b gy mh me l mf mg">["encrypt", "decrypt"]</span><span id="8083" class="mb mc iq lx b gy mh me l mf mg">).then(a =&gt; {</span><span id="2cb4" class="mb mc iq lx b gy mh me l mf mg">console.log("Public Key:", JSON.stringify(a.publicKey));</span><span id="3970" class="mb mc iq lx b gy mh me l mf mg">});</span></pre><p id="7e7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.生成AES密钥</p><pre class="lh li lj lk gt lw lx ly lz aw ma bi"><span id="5ca3" class="mb mc iq lx b gy md me l mf mg">window.crypto.subtle.generateKey(</span><span id="c7cd" class="mb mc iq lx b gy mh me l mf mg">{</span><span id="fd60" class="mb mc iq lx b gy mh me l mf mg">name: "AES-GCM",</span><span id="0c80" class="mb mc iq lx b gy mh me l mf mg">length: 256</span><span id="1327" class="mb mc iq lx b gy mh me l mf mg">},</span><span id="49b6" class="mb mc iq lx b gy mh me l mf mg">true,</span><span id="72e4" class="mb mc iq lx b gy mh me l mf mg">["encrypt", "decrypt"]</span><span id="cd9a" class="mb mc iq lx b gy mh me l mf mg">).then(result =&gt; {</span><span id="bf1b" class="mb mc iq lx b gy mh me l mf mg">}</span></pre><p id="abb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.将密钥导出到JWK</p><pre class="lh li lj lk gt lw lx ly lz aw ma bi"><span id="a6ba" class="mb mc iq lx b gy md me l mf mg">window.crypto.subtle.generateKey(</span><span id="7f1d" class="mb mc iq lx b gy mh me l mf mg">{</span><span id="08f6" class="mb mc iq lx b gy mh me l mf mg">name: "AES-GCM",</span><span id="a007" class="mb mc iq lx b gy mh me l mf mg">length: 256</span><span id="b8a3" class="mb mc iq lx b gy mh me l mf mg">},</span><span id="175e" class="mb mc iq lx b gy mh me l mf mg">true,</span><span id="a45c" class="mb mc iq lx b gy mh me l mf mg">["encrypt", "decrypt"]</span><span id="3e65" class="mb mc iq lx b gy mh me l mf mg">).then(a =&gt; {</span><span id="9a3c" class="mb mc iq lx b gy mh me l mf mg">window.crypto.subtle.exportKey("jwk", a).then(b =&gt; {</span><span id="8483" class="mb mc iq lx b gy mh me l mf mg">console.log(b);</span><span id="c626" class="mb mc iq lx b gy mh me l mf mg">})</span><span id="384e" class="mb mc iq lx b gy mh me l mf mg">});</span></pre><p id="5d26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.导入JWK密钥</p><pre class="lh li lj lk gt lw lx ly lz aw ma bi"><span id="12df" class="mb mc iq lx b gy md me l mf mg">window.crypto.subtle.importKey("jwk", CryptoKey, "AES-GCM", true,</span><span id="888e" class="mb mc iq lx b gy mh me l mf mg">["encrypt", "decrypt"]).then(result =&gt; {<br/> </span><span id="3edf" class="mb mc iq lx b gy mh me l mf mg">});</span></pre><p id="9bce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.用RSA密钥加密AES密钥并转换成JSON(检查finalResult变量)</p><pre class="lh li lj lk gt lw lx ly lz aw ma bi"><span id="dce3" class="mb mc iq lx b gy md me l mf mg">window.crypto.subtle.encrypt({</span><span id="fdd0" class="mb mc iq lx b gy mh me l mf mg">name: "RSA-OAEP"</span><span id="cfbe" class="mb mc iq lx b gy mh me l mf mg">}, publicKey, new TextEncoder().encode(JSON.stringify(symKey)))</span><span id="5fd2" class="mb mc iq lx b gy mh me l mf mg">.then(result =&gt; {</span><span id="476a" class="mb mc iq lx b gy mh me l mf mg">finalResult= JSON.stringify(Array.from(new Uint8Array(a)));</span><span id="9c3f" class="mb mc iq lx b gy mh me l mf mg">})</span></pre><p id="2f4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.将JSON转换成ArrayBuffer</p><pre class="lh li lj lk gt lw lx ly lz aw ma bi"><span id="08f0" class="mb mc iq lx b gy md me l mf mg">new Uint8Array(JSON.parse(JSONData)).buffer</span></pre><p id="52ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.解密并导入密钥</p><pre class="lh li lj lk gt lw lx ly lz aw ma bi"><span id="eff4" class="mb mc iq lx b gy md me l mf mg">window.crypto.subtle.decrypt(</span><span id="280b" class="mb mc iq lx b gy mh me l mf mg">{</span><span id="c1d7" class="mb mc iq lx b gy mh me l mf mg">name: "RSA-OAEP"</span><span id="d830" class="mb mc iq lx b gy mh me l mf mg">},</span><span id="3184" class="mb mc iq lx b gy mh me l mf mg">privateKey,</span><span id="e2e7" class="mb mc iq lx b gy mh me l mf mg">new Uint8Array(JSON.parse(encrypted2)).buffer</span><span id="51d1" class="mb mc iq lx b gy mh me l mf mg">).then(a =&gt; {<br/> window.crypto.subtle.importKey("jwk", JSON.parse(</span><span id="8eda" class="mb mc iq lx b gy mh me l mf mg"> new TextDecoder().decode(a)), "AES-GCM", true,</span><span id="e042" class="mb mc iq lx b gy mh me l mf mg">["encrypt", "decrypt"]).then(a =&gt; {</span><span id="c538" class="mb mc iq lx b gy mh me l mf mg">console.log("Extractable" + a.algorithm.name + " " + a.extractable);</span><span id="f214" class="mb mc iq lx b gy mh me l mf mg">})</span><span id="4ab0" class="mb mc iq lx b gy mh me l mf mg">});</span></pre></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="cc8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">代码示例</strong></p><p id="01ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在这个<a class="ae mi" href="https://github.com/rsatrio/Key-Wrapping-Encryption-Javascript/" rel="noopener ugc nofollow" target="_blank"> github </a>里做了个例子(别忘了给个星)。在该示例中，我们将尝试创建AES密钥RSA Keypair，使用RSA公钥加密AES密钥，并使用RSA私钥解密它。你也可以在<a class="ae mi" href="https://adorable-capybara-1fa6ff.netlify.app/" rel="noopener ugc nofollow" target="_blank">这里</a>试试live应用。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="9383" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">参考文献</strong></p><ol class=""><li id="889d" class="ks kt iq jp b jq jr ju jv jy ku kc kv kg kw kk kx ky kz la bi translated"><a class="ae mi" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/API/Web _ Crypto _ API</a></li></ol></div></div>    
</body>
</html>