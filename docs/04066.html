<html>
<head>
<title>Traefik 2 High Available Mode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Traefik 2高可用模式</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/traefik-2-high-available-mode-d09c9ec36295?source=collection_archive---------9-----------------------#2020-06-08">https://levelup.gitconnected.com/traefik-2-high-available-mode-d09c9ec36295?source=collection_archive---------9-----------------------#2020-06-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ad4d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">运行Traefik集群并将流量配置存储在键值存储中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/48e82e5aad0d1cd9504607d176cf7051.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dsH2vvWzjFns7XY5"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">阿德里安·施瓦兹在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><blockquote class="kz la lb"><p id="e794" class="lc ld le lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated"><em class="it"> Traefik是一款</em> <a class="ae ky" href="https://github.com/containous/traefik" rel="noopener ugc nofollow" target="_blank"> <em class="it">开源</em> </a> <em class="it"> </em>边缘路由器<em class="it">，让发布服务成为一种有趣而轻松的体验。它代表您的系统接收请求，并找出哪些组件负责处理这些请求。</em></p><p id="7f38" class="lc ld le lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated"><a class="ae ky" href="https://docs.traefik.io/" rel="noopener ugc nofollow" target="_blank"><em class="it">https://docs.traefik.io/</em></a></p></blockquote><p id="01b6" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">不建议在生产环境中运行单个Traefik实例，因为Traefik将成为环境的瓶颈，并且环境将具有高可用性。如果Traefik实例关闭，它后面的所有服务都将关闭。</p><p id="accb" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">因此，我开始探索在高可用性模式下托管Traefik的可用选项，由于我使用Docker Swarm来托管Traefik后端服务，我想到的第一个想法是用更多副本来扩展<strong class="lf iu">Traefik服务，或者以全局模式部署它(它将被部署到每个Swarm工作节点)。然而，使用这种设置运行Traefik会引入由不同实例多次生成SSL证书的风险(如果不需要生成SSL证书，这种想法足以在HA模式下托管Traefik)。</strong></p><p id="ed90" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">经过一番挖掘，我发现<a class="ae ky" href="https://docs.traefik.io/v1.7/user-guide/cluster/" rel="noopener ugc nofollow" target="_blank"> Traefik 1.7有一个使用键值存储的测试集群解决方案</a>。然而，我想在最新版本中使用它，但我在最新版本中找不到该解决方案的清晰文档。另一方面，在Redis、Consul和Etcd等键值存储中存储Traefik配置的文档是可用的。</p><p id="2414" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">在本文中，我将描述如何使用键值存储运行Traefik(以Redis为例),并强调将键值存储用于Traefik配置的局限性和优势。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><p id="522b" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated"><strong class="lf iu">我对解决方案的期望</strong></p><p id="1692" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">根据测试版的<a class="ae ky" href="https://docs.traefik.io/v1.7/user-guide/cluster/" rel="noopener ugc nofollow" target="_blank">文档</a>,我期望拥有与1.7版相同的特性和一些更高级的特性。下面是我一直在寻找的功能总结。</p><ul class=""><li id="0a14" class="mj mk it lf b lg lh lj lk lz ml ma mm mb mn ly mo mp mq mr bi translated">支持高可用模式。</li><li id="fd6d" class="mj mk it lf b lg ms lj mt lz mu ma mv mb mw ly mo mp mq mr bi translated">将Traefik CLI命令存储在键值存储中，并在Traefik实例启动时读取它们。</li><li id="3884" class="mj mk it lf b lg ms lj mt lz mu ma mv mb mw ly mo mp mq mr bi translated">将LetsEncrypt SSL证书存储在键值存储中，而不是文件中。</li></ul><p id="4f72" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated"><strong class="lf iu">现实&amp;现实&amp;局限</strong></p><p id="9b9f" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">原来Traefik 2。x版本不包括上述所有功能，其中一些功能被<a class="ae ky" href="https://community.containo.us/t/traefik-2-2-features/5078" rel="noopener ugc nofollow" target="_blank">转移到Traefik企业版</a>😢。为了更好地说明这一点，将CLI命令存储到键值存储中由于一些错误而被弃用。同时将SSL证书存储在仅包含在Traefik Enterprise Edition中的键值存储中。</p><p id="1725" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">如上所述，高可用模式仅支持存储以下Traefik配置类别</p><ul class=""><li id="e075" class="mj mk it lf b lg lh lj lk lz ml ma mm mb mn ly mo mp mq mr bi translated">中间件配置。</li><li id="a0d8" class="mj mk it lf b lg ms lj mt lz mu ma mv mb mw ly mo mp mq mr bi translated">路由器配置(HTTP、TCP和UDP)。</li><li id="c781" class="mj mk it lf b lg ms lj mt lz mu ma mv mb mw ly mo mp mq mr bi translated">服务配置。</li><li id="217a" class="mj mk it lf b lg ms lj mt lz mu ma mv mb mw ly mo mp mq mr bi translated">TLS配置。</li></ul><p id="2652" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">在下面的<a class="ae ky" href="https://docs.traefik.io/reference/dynamic-configuration/kv/" rel="noopener ugc nofollow" target="_blank">链接</a>中列出了键值存储可以存储和管理的所有配置项的完整列表。</p><p id="c8ef" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated"><strong class="lf iu">用Redis作为键值存储托管Traefik】</strong></p><p id="53b6" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">尽管我很失望😞由于Traefik v 2.2中并没有包含我需要的所有特性，为了评估该特性并检查该特性是否为托管Traefik增加了价值，我决定尝试使用键值存储来运行Traefik。在接下来的步骤中，我将描述使用Redis服务器运行Traefik的尝试。我选择Redis是因为它更易于部署，但是，下面的步骤也适用于其他键值存储。</p><p id="9225" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">我尝试用Redis托管Traefik的第一步是同时部署Traefik和Redis，并将它们连接在一起。幸运的是，这一步很简单，可以使用下面的docker堆栈文件来完成。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="bbe9" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">使用以下CLI命令可以连接Traefik和Redis</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="2d87" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">一旦这两个服务都启动，Traefik可以连接到Redis，我们将能够从Traefik日志中看到下面的日志消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/6bac05a55dc8fb13965172f56850e8ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qb09d2wYkF2KUyPtlEjJag.png"/></div></div></figure><p id="302a" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">此错误的根本原因是Redis服务器没有为Traefik存储任何配置。</p><p id="a957" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">下一步是尝试创建添加Traefik配置到Redis存储，并验证Traefik是否加载它们。可以使用"<strong class="lf iu"><em class="le">" Redis-CLI "</em></strong>命令向Redis服务器添加密钥，如下图所示。您可以连接到Redis容器中的一个shell，或者从远程服务器使用"<strong class="lf iu"> <em class="le"> redis-cli" </em> </strong>命令。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/3fc4c5c9fb5a9f98ca658749b4e2e836.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*je3fBxdRQkCopqjnyE5a6w.png"/></div></div></figure><p id="8bcd" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">一旦上述键被添加到Redis存储中，中间件定义就会出现在Traefik仪表板上，如下图所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/c1f1f933ff22e9a220a1b41e3a503145.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rBQWesa7dwjheuuKjVvgxg.png"/></div></div></figure><p id="363b" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">使用Redis命令行工具手动添加键是不方便的，并且会阻碍docker服务及其路由上的变更的自动化部署。因此，我开始寻找自动创建这些密钥的方法。以下是我想到的选择。</p><ul class=""><li id="a260" class="mj mk it lf b lg lh lj lk lz ml ma mm mb mn ly mo mp mq mr bi translated">一旦部署了Traefik，就创建这些密钥:这个想法要求我们每次更改这些配置时都要部署Traefik，而且我们还需要更新Redis docker映像以包含Redis命令行。所以，基于以上原因，我放弃了这个方法。</li><li id="e0ff" class="mj mk it lf b lg ms lj mt lz mu ma mv mb mw ly mo mp mq mr bi translated">创建一个服务来创建这些密钥:构建一个定制的服务来管理Traefik配置可能是一个好主意，但是这需要大量的工作，因此我也放弃了这个选项。</li><li id="40e1" class="mj mk it lf b lg ms lj mt lz mu ma mv mb mw ly mo mp mq mr bi translated">让Redis引导密钥:由于Redis Docker映像已经有了Redis命令行工具，它将能够使用回送IP与Redis服务器通信，我认为使用Redis的自定义Docker映像会更容易，因为它的入口点允许将数据引导到Redis服务器。</li></ul><p id="f074" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">要自动创建和维护Redis密钥，客户docker映像必须支持以下功能</p><ul class=""><li id="af3f" class="mj mk it lf b lg lh lj lk lz ml ma mm mb mn ly mo mp mq mr bi translated">为键值文件向Redis服务器添加键。为了简单起见，我决定文件中条目的格式应该如下所示。</li></ul><pre class="kj kk kl km gt nc nd ne nf aw ng bi"><span id="a0ae" class="nh ni it nd b gy nj nk l nl nm">key1,value1<br/>key2,value2</span></pre><p id="9df4" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">使用一个bash命令就可以很容易地在Redis服务器中从遵循上述模式的文件中导入或设置密钥。下面的函数可以通过读取文件内容并解析它来完成这项工作，然后将其传递给Redis命令行来创建密钥。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><ul class=""><li id="208a" class="mj mk it lf b lg lh lj lk lz ml ma mm mb mn ly mo mp mq mr bi translated">从Redis中删除所有不在键值文件中的项目。这在一些定义的路由或中间件被移除并且不再需要时是需要的。使用bash和rails命令行工具也可以完成这项任务，下面的函数通过比较Redis服务器中的所有条目和引导文件中的条目来完成这项任务，并删除文件中不包含的每个键。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><ul class=""><li id="c7b8" class="mj mk it lf b lg lh lj lk lz ml ma mm mb mn ly mo mp mq mr bi translated">更新Redis中的配置键需要一个Redis部署，以便通过入口点执行上述功能😢。为了改进这一点，我决定在Redis docker映像中添加一个后台进程，以不断检查引导文件的更新，并在发生任何变化时加载它们。此外，引导文件将作为卷添加，因此可以在Redis docker映像或容器之外修改它。下面是Redis Docker入口点的完整实现。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="9ea2" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">Traefik with Redis server的完整实现可以在Github的以下<a class="ae ky" href="https://github.com/wshihadeh/traefik_v2" rel="noopener ugc nofollow" target="_blank">资源库</a>中找到。要在本地部署堆栈，克隆存储库，并执行以下命令</p><pre class="kj kk kl km gt nc nd ne nf aw ng bi"><span id="781d" class="nh ni it nd b gy nj nk l nl nm">DEPLOY_VERSION=ha make deploy</span></pre><p id="a6df" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated"><strong class="lf iu">结论</strong></p><p id="4177" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll lz ln lo lp ma lr ls lt mb lv lw lx ly im bi translated">Traefik高可用性特性(如在键值存储中存储SSL证书)在企业版中可用，而在开源版本中不可用。但是，可以将一些Traefik配置存储在键值存储中，例如中间件、服务和TCP配置。</p></div></div>    
</body>
</html>