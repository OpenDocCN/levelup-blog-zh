<html>
<head>
<title>How to Pivot Data With Google BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Google BigQuery透视数据</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/pivot-on-steroids-with-google-bigquery-4289eec13569?source=collection_archive---------2-----------------------#2022-10-14">https://levelup.gitconnected.com/pivot-on-steroids-with-google-bigquery-4289eec13569?source=collection_archive---------2-----------------------#2022-10-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fc19" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从理论到实践，充分说明</h2></div><p id="ea9c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当您像在Excel或SQL中一样操作表格数据时，您可能需要通过将一列的值组织成行来汇总数据。</p><p id="06f6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为此，您必须“旋转”您的数据，并使用<strong class="kk iu">函数来聚合</strong>其他列的值。</p><p id="3097" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个操作叫做<strong class="kk iu">转</strong>，相反的过程叫做<strong class="kk iu">转</strong>。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/cc6279add14a2155de5a117f0c736ea2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vdMtdbdirg_pfVpnnv7nJA.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">演职员表:<a class="ae lu" href="https://medium.com/@mickael-andrieu/" rel="noopener">米凯尔·安德烈</a></figcaption></figure><p id="4082" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们看一个订单列表，上面有日期、类别和销售额:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/9b5c1b9f7af79d7c4289d1b72c976d65.png" data-original-src="https://miro.medium.com/v2/resize:fit:684/format:webp/1*5MHyQKlGRSjkZpb5-LK2ow.jpeg"/></div></figure><p id="3677" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果要汇总每个细分市场的平均销售额，一个<strong class="kk iu"> <em class="lw">透视运算</em> </strong> <em class="lw">会产生以下结果</em>:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/cccf59bd9fba80f97933dd342ecc9e6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*S4ICWgmjQcZk0UMGX20SWw.jpeg"/></div></figure><blockquote class="ly lz ma"><p id="924f" class="ki kj lw kk b kl km ju kn ko kp jx kq mb ks kt ku mc kw kx ky md la lb lc ld im bi translated">你可以查一下2022年10月12日的平均销售额确实是20美元，或者说(10 + 30)/2。</p></blockquote><h2 id="efac" class="me mf it bd mg mh mi dn mj mk ml dp mm kr mn mo mp kv mq mr ms kz mt mu mv mw bi translated">如何用Google BigQuery做一个简单的支点</h2><p id="a742" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">像大多数现代数据仓库解决方案一样，Google BigQuery有专门的数据分析操作功能。</p><p id="d585" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是官方文件中<strong class="kk iu">枢轴</strong>操作者的文件:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/3ec350d5b5fec710e3d8346692ced576.png" data-original-src="https://miro.medium.com/v2/resize:fit:898/format:webp/1*Upgmi5vYbUt5PWicgFDbYw.jpeg"/></div></figure><p id="b44b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们检索之前描述的主要概念:</p><ul class=""><li id="ce2b" class="nd ne it kk b kl km ko kp kr nf kv ng kz nh ld ni nj nk nl bi translated">一个<strong class="kk iu">聚合函数</strong>(又名“聚合函数调用”)</li><li id="78e0" class="nd ne it kk b kl nm ko nn kr no kv np kz nq ld ni nj nk nl bi translated"><strong class="kk iu">列来操作</strong>聚合(" input_column ")</li><li id="0e06" class="nd ne it kk b kl nm ko nn kr no kv np kz nq ld ni nj nk nl bi translated">本栏中的<strong class="kk iu">值要考虑</strong></li></ul><p id="cbdf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是Pivot操作符有一些你需要理解的约束。</p><blockquote class="ly lz ma"><p id="1c07" class="ki kj lw kk b kl km ju kn ko kp jx kq mb ks kt ku mc kw kx ky md la lb lc ld im bi translated">为了尝试本文中的每一个例子，<a class="ae lu" href="https://gist.github.com/mickaelandrieu/464f0851e68b2ca60bce8252bb6c267f" rel="noopener ugc nofollow" target="_blank">下载这个文件</a>并将其导入Google BigQuery。</p></blockquote><p id="230b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您遵循文档并使用Big Query透视数据，您最终会得到以下无效代码:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="7c9b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在BigQuery客户端中执行该查询将抛出一条错误消息:</p><pre class="lf lg lh li gt nt nu nv nw aw nx bi"><span id="e689" class="me mf it nu b gy ny nz l oa ob">Invalid field name "Office Supplies".</span></pre><p id="7230" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是因为列名不能有空格。</p><p id="8987" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是对列名(或“字段”)的约束列表:</p><ul class=""><li id="71b9" class="nd ne it kk b kl km ko kp kr nf kv ng kz nh ld ni nj nk nl bi translated">只能包含字母、数字和下划线。</li><li id="0196" class="nd ne it kk b kl nm ko nn kr no kv np kz nq ld ni nj nk nl bi translated">必须以字母或下划线开头:禁止以<em class="lw">数字开头</em>⛔)；</li><li id="68fe" class="nd ne it kk b kl nm ko nn kr no kv np kz nq ld ni nj nk nl bi translated">必须少于300个字符；</li></ul><p id="a59f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果只有一些列值包含空格，您可以像下面这个<em class="lw">有效的</em>查询一样单独处理它们:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nr ns l"/></div></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oc"><img src="../Images/dc300e6d85d0cf5a17f7b887fa6fe6c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*14kogXVkeREadL6ux-ZXMg.jpeg"/></div></div></figure><p id="9ecb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，如果当您不能准备转换或者有许多“无效”的列名候选项时，您考虑动态列表该怎么办呢？</p><p id="9272" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">考虑这个新示例，您希望根据每个子类别透视销售数据:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nr ns l"/></div></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi od"><img src="../Images/f63fc894e3d72cc463fec3b3d9948310.png" data-original-src="https://miro.medium.com/v2/resize:fit:410/format:webp/1*5dBJG11-SuGSyS7veZPUEw.jpeg"/></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">那里没那么有趣😓</figcaption></figure><p id="cfe4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此时，您最好使用正则表达式使用<strong class="kk iu"> REGEXP_REPLACE </strong>函数替换下划线的每个空格:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nr ns l"/></div></figure><blockquote class="oe"><p id="b2c3" class="of og it bd oh oi oj ok ol om on ld dk translated"><strong class="ak">下一个问题是将选择的值填入in操作符。</strong></p></blockquote><p id="1226" class="pw-post-body-paragraph ki kj it kk b kl oo ju kn ko op jx kq kr oq kt ku kv or kx ky kz os lb lc ld im bi translated">您需要准备值并动态填充它们。</p><h2 id="44d9" class="me mf it bd mg mh mi dn mj mk ml dp mm kr mn mo mp kv mq mr ms kz mt mu mv mw bi translated">如何创建列名的动态列表</h2><p id="f22c" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">遗憾的是，该列表包含其他无效字符:</p><ul class=""><li id="d385" class="nd ne it kk b kl km ko kp kr nf kv ng kz nh ld ni nj nk nl bi translated">管道操作员("<strong class="kk iu">| "</strong>)；</li><li id="6b62" class="nd ne it kk b kl nm ko nn kr no kv np kz nq ld ni nj nk nl bi translated">与号字符(<strong class="kk iu">&amp;</strong>)；</li><li id="b76b" class="nd ne it kk b kl nm ko nn kr no kv np kz nq ld ni nj nk nl bi translated">以及分号("<strong class="kk iu">，"</strong>)；</li></ul><p id="fc1b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此时，您有了一个更复杂但功能更强的替代品。此外，您需要使用<strong class="kk iu"> DISTINCT </strong>操作符来确保值是唯一的:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nr ns l"/></div></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/d22fbbbb38d542e80cf796f650874c3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:444/format:webp/1*tEwSyXX7kw7Xgu2mfFwx1w.jpeg"/></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">有点丑，但是很实用🙂</figcaption></figure><p id="92de" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您已经接近成功，但是BigQuery禁止在<strong class="kk iu"> IN </strong>操作符中执行查询，或者在同一个流程中使用前一个查询的结果。以下代码无效:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="2c71" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另外，操作符中的<strong class="kk iu">需要一个字符串值列表，而不是一个查询结果。</strong></p><p id="5ab5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您需要准备数据，并要求Google BigQuery在另一个查询中使用一个查询的即时结果。</p><h2 id="eada" class="me mf it bd mg mh mi dn mj mk ml dp mm kr mn mo mp kv mq mr ms kz mt mu mv mw bi translated"><strong class="ak">准备灌装作业动态清单</strong></h2><p id="2823" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">这一步很容易，因为我们已经准备好了有效值列表:</p><ul class=""><li id="3af0" class="nd ne it kk b kl km ko kp kr nf kv ng kz nh ld ni nj nk nl bi translated">声明一个类型为<strong class="kk iu">字符串</strong>的变量，比如说“<em class="lw">子类</em>”；</li><li id="a374" class="nd ne it kk b kl nm ko nn kr no kv np kz nq ld ni nj nk nl bi translated">用前一个查询的结果填充它，连接成一个字符串；</li></ul><blockquote class="ly lz ma"><p id="eb5a" class="ki kj lw kk b kl km ju kn ko kp jx kq mb ks kt ku mc kw kx ky md la lb lc ld im bi translated">我们试图生成最终的“完整”查询，并要求Google BigQuery执行它。</p></blockquote><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="11ff" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们使用<strong class="kk iu"> CONCAT </strong>和<strong class="kk iu"> STRING_AGG </strong>函数来构建我们想要放入最终查询的操作符中的内容！</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ou"><img src="../Images/fc0e1e76bbabb11b5b73de2a8e7e5f01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IJeYwM9m1hrGJq4IlB53fQ.jpeg"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">这是您在最终查询中需要的:令人敬畏的✨</figcaption></figure><p id="df46" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一步也是最后一步是让BigQuery使用这个变量，并在同一个流程中执行一个新的查询。</p><h2 id="41f8" class="me mf it bd mg mh mi dn mj mk ml dp mm kr mn mo mp kv mq mr ms kz mt mu mv mw bi translated">使用Google BigQuery立即执行</h2><p id="0019" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">按照设计，BigQuery会“逐个”处理每一个查询，你不能在同一个“批处理”中使用一个变量的结果作为需要它的查询。</p><blockquote class="ly lz ma"><p id="ca83" class="ki kj lw kk b kl km ju kn ko kp jx kq mb ks kt ku mc kw kx ky md la lb lc ld im bi translated">您可以使用Python或任何其他编程语言来实现这一点，但我想与您分享另一个更智能的解决方案。</p></blockquote><p id="000c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以让BigQuery使用相同的流程，用<a class="ae lu" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/procedural-language#execute_immediate" rel="noopener ugc nofollow" target="_blank"><strong class="kk iu">EXECUTE IMMEDIATE</strong></a>操作符来处理以下查询:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ov"><img src="../Images/910df435fc6419e65b1222c4f84ac550.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rtev2MaANWLc5FVg224AtA.jpeg"/></div></div></figure><p id="4b29" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如您所看到的，这个操作符允许使用变量。</p><p id="1a1f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了帮助你理解它是如何工作的，你可以考虑一种介绍性的编程语言。例如:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="d717" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">BigQuery将在查询执行时用变量值替换问号。您也可以使用多个变量:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="0bf1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是如果你需要将一个字符串传递给一个SQL表达式，你应该使用<strong class="kk iu">格式的</strong>函数:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nr ns l"/></div></figure><blockquote class="oe"><p id="d82b" class="of og it bd oh oi oj ok ol om on ld dk translated">最后一个“技巧”是将立即执行和<strong class="ak">格式化</strong>结合起来。</p></blockquote><p id="327c" class="pw-post-body-paragraph ki kj it kk b kl oo ju kn ko op jx kq kr oq kt ku kv or kx ky kz os lb lc ld im bi translated"><strong class="kk iu"> <em class="lw">子类别</em> </strong>变量被视为任何其他字符串，并在运算符中填充为<strong class="kk iu">的值:</strong></p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="4cab" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您将在Google BigQuery UI客户端的<strong class="kk iu">结果</strong>面板中找到执行的查询:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ow"><img src="../Images/c2298fae0aa4849e7775d94d088e3069.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*POtrEis9BIHsgEX45Evbtw.jpeg"/></div></div></figure><p id="ac14" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当您点击“<strong class="kk iu">时，您的数据透视表显示本程序的结果</strong>:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ox"><img src="../Images/fe570f44a644c576b1c532603a540e6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DLSlzwChKqE6L26IoE5-fA.jpeg"/></div></div></figure><p id="01ca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇文章写完了🚀🚀！</p><p id="9999" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢您阅读到最后，希望这些内容对您有所帮助。</p><h1 id="c04e" class="oy mf it bd mg oz pa pb mj pc pd pe mm jz pf ka mp kc pg kd ms kf ph kg mv pi bi translated">你可能也喜欢</h1><div class="pj pk gp gr pl pm"><a href="https://medium.com/learning-sql/static-and-dynamic-pivot-in-mysql-8-9bef25d83d4b" rel="noopener follow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd iu gy z fp pr fr fs ps fu fw is bi translated">如何用SQL汇总数据</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">了解如何透视数据。理论和实践充分说明！</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">medium.com</p></div></div><div class="pv l"><div class="pw l px py pz pv qa lo pm"/></div></div></a></div></div><div class="ab cl qb qc hx qd" role="separator"><span class="qe bw bk qf qg qh"/><span class="qe bw bk qf qg qh"/><span class="qe bw bk qf qg"/></div><div class="im in io ip iq"><p id="b544" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您有任何问题，请随时发表评论，如果您喜欢这篇文章，<a class="ae lu" href="https://mickael-andrieu.medium.com/" rel="noopener">关注我</a>，当我下一次发布时，您会收到通知。</p></div></div>    
</body>
</html>