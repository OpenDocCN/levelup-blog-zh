<html>
<head>
<title>What is a Goroutine? Find the right way to implement goroutines 🔥</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">什么是Goroutine？找到实现goroutines的正确方法🔥</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/what-is-a-goroutine-find-the-right-way-to-implement-goroutines-f6ef15d1c32b?source=collection_archive---------6-----------------------#2022-06-22">https://levelup.gitconnected.com/what-is-a-goroutine-find-the-right-way-to-implement-goroutines-f6ef15d1c32b?source=collection_archive---------6-----------------------#2022-06-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3f780fa18b0cc28fa0782593226702a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w0h6PGJJ5Zd03ve4zd04xA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">go routines-主题</figcaption></figure><h1 id="0a0d" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">为什么要去？</h1><p id="c4bd" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">Go已经广泛应用于Kubernetes、Docker、influence DB等大多数流行的制作系统中。如此大规模地采用围棋主要有四个原因。</p><ul class=""><li id="d4d6" class="ly lz iq lc b ld ma lh mb ll mc lp md lt me lx mf mg mh mi bi translated">它简单而优雅</li><li id="3c9e" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">提供大规模内置并发</li><li id="3cc1" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">旨在多核上运行</li><li id="5c4d" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">这是超快的性能🚀</li></ul><p id="7dd3" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">Goroutine是Go中实现并发的一种方式🔥。</p><h1 id="14b1" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">什么是goroutine？</h1><p id="5c54" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">goroutine是由Go运行时管理的轻量级线程。不像操作系统线程通常在<strong class="lc ir"> MBs范围内消耗内存才能正常工作，</strong>这些goroutines只在<strong class="lc ir">KBs范围内消耗内存</strong>。所以对于go运行时来说，创建goroutines比创建并发线程更容易、更快。go routine不是实际的线程，它们被复用到实际的OS线程中，甚至你可以假设这些go routine是OS线程上的一种抽象层。</p><p id="7c42" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">由于其<strong class="lc ir">非常小的内存占用</strong>，go运行时很容易在几毫秒内创建<strong class="lc ir">数千个goroutines。但是创建数以千计的操作系统线程严重依赖于<strong class="lc ir">内存和CPU </strong>，所以与goroutines相比，它显然很慢。</strong></p><p id="0eb6" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">此外，Goroutine没有本地存储，因此go routine的实现比OS线程更便宜，因此<strong class="lc ir">go routine在启动时间方面要快得多</strong>。</p><p id="11c2" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">在<code class="fe mr ms mt mu b">go</code>的情况下，上下文切换也比OS线程上下文切换更快，因为OS线程是大量资源。</p><p id="776f" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">除此之外<strong class="lc ir"> Go还有另一个最酷的功能，即频道</strong>🔥。通道是与goroutines通信的内置方式。在OS线程的情况下，这种通信是你能想到的最困难的事情。</p><p id="a016" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">这就是go如何实现比传统编程语言更好的并发性，这使得<strong class="lc ir"> go成为大多数用例</strong>的默认选择语言。</p><h1 id="b367" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">goroutine的语法</h1><p id="5db2" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">goroutine最难的部分是理解它，而不是它的真正实现。因此，在深入实际实现之前，请花时间去理解它。</p><p id="7c49" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">在其他编程语言中，您可能会使用<code class="fe mr ms mt mu b">async await</code>模式来实现并发(Node.js和python - async await)。但是在这里它甚至比那更简单。只需在函数前缀中添加<code class="fe mr ms mt mu b">go</code>关键字(例如:<code class="fe mr ms mt mu b">go someFunctionName</code>，现在go runtime在并发模式下执行相同的函数。看看这有多酷😆。</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="0fb3" class="nd kd iq mu b gy ne nf l ng nh">go addTwoNumbers(1, 2)</span></pre><h1 id="d752" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">实现一个没有例程的程序</h1><p id="7aa5" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">下面是将两个数字相加的代码片段。<code class="fe mr ms mt mu b">addition</code>功能有一个<code class="fe mr ms mt mu b">sleep</code>命令来模拟加工时间。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="1079" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">如果你使用<code class="fe mr ms mt mu b">go run sequential.go</code>命令执行程序，你将得到如下输出(2个数相加的结果)。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/a68a1782c7e8d23f09195e12622a1e46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9yiU_WturK77WWotk_vclg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">顺序输出</figcaption></figure><h1 id="bcb0" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">用程序实现一个程序</h1><p id="c210" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">现在让我们通过将<code class="fe mr ms mt mu b">go</code>添加到调用者的前缀来将这种顺序执行转换为并发执行。下面是片段。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="c02a" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">如果您现在使用此<code class="fe mr ms mt mu b">go run concurrency_without_wg.go</code>命令执行，您会立即注意到<strong class="lc ir">加法功能的输出没有显示。</strong></p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/80dc55419f3b807437870e1b1e6405d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hxY7iMwUjMqNCRgEP0QDmg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">无等待并发组</figcaption></figure><p id="71af" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">如果您已经做到了这一步，那么您已经成功地在并发模式下执行了第一个程序🔥。</p><blockquote class="nm nn no"><p id="5ba0" class="la lb np lc b ld ma lf lg lh mb lj lk nq mo ln lo nr mp lr ls ns mq lv lw lx ij bi translated">但是为什么输出会有出入呢？</p></blockquote><p id="3c72" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">这是因为go runtime没有等待goroutines完成它们的执行。所以您需要显式地更新goroutines的细节以运行时运行。这就是<code class="fe mr ms mt mu b">wait groups</code>发挥作用的地方。这正是等待小组要解决的问题。</p><h1 id="f453" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">什么是等待组？</h1><p id="d52b" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">WaitGroup( <code class="fe mr ms mt mu b">sync.WaitGroup</code>)是一种机制，用于等待goroutines集合完成它们的任务。golang中主要有3个助手函数来实现这个特性。</p><ul class=""><li id="440a" class="ly lz iq lc b ld ma lh mb ll mc lp md lt me lx mf mg mh mi bi translated">添加()</li><li id="d8c2" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">等待()</li><li id="55a8" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">完成()</li></ul><p id="99cd" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated"><code class="fe mr ms mt mu b">Add(5)</code>方法接受一个整数作为参数。这个整数表示go运行时在这个集合中可用的goroutines的数量。<code class="fe mr ms mt mu b">Wait()</code>告诉go运行时在这个位置等待，直到goroutines集合完成执行。方法用于通知go运行时这个特定的goroutine已经完成了它的执行。</p><p id="8b14" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">下面是带有1个goroutine的代码片段。更深入的理解请参考评论。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="febc" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">如果您现在执行，您将得到如下所示的输出。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/2349619bf39e5839403342b0ab32188e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zoZ77a4ZvHHIV77dRz8HYg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">并发输出</figcaption></figure><h1 id="6e36" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">摘要</h1><p id="91fd" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">您已经成功实现了goroutines🔥，但是如果没有通道(一种与goroutines交流的方式),这个主题将永远不会完成。</p><p id="3956" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">要了解<code class="fe mr ms mt mu b">Channels</code>的最新消息，你可以关注这个博客。</p><p id="06c3" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">我会💝听听你的反馈和意见，看看你能用它做些什么。如果你突然想到什么地方，请随意评论。我随时都有空。</p><p id="a356" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">如果你觉得这篇文章对其他人有帮助，那么请考虑点赞。</p><p id="85fa" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">你可以在<a class="ae nu" href="https://github.com/rahul-yr/learn-go-concepts.git" rel="noopener ugc nofollow" target="_blank"> github </a>找到完整的代码</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><h1 id="0b22" class="kc kd iq bd ke kf oc kh ki kj od kl km kn oe kp kq kr of kt ku kv og kx ky kz bi translated">分级编码</h1><p id="96e4" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">感谢您成为我们社区的一员！更多内容见<a class="ae nu" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">级编码出版物</a>。<br/>跟随:<a class="ae nu" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a>，<a class="ae nu" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">领英</a>，<a class="ae nu" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">通迅</a> <br/> <strong class="lc ir">升一级正在改造理工大招聘➡️ </strong> <a class="ae nu" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="lc ir">加入我们的人才集体</strong> </a></p></div></div>    
</body>
</html>