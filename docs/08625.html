<html>
<head>
<title>Moving from Azure App Services to Azure Kubernetes Service (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Azure应用服务转移到Azure Kubernetes服务(第2部分)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/moving-from-azure-app-services-to-azure-kubernetes-service-part-2-9a76439a0640?source=collection_archive---------7-----------------------#2021-05-18">https://levelup.gitconnected.com/moving-from-azure-app-services-to-azure-kubernetes-service-part-2-9a76439a0640?source=collection_archive---------7-----------------------#2021-05-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div class="gh gi ir"><img src="../Images/17980e514a5d1ff45580450c2d93edf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/0*rm3nXFrVVRc4b_48.png"/></div></figure><div class=""/><p id="8f93" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz jb">使用Azure Active Directory管理Kubernetes访问</strong></p><p id="cd47" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><em class="kv">这是我上一篇文章的后续:</em></p><div class="is it gp gr iu kw"><a rel="noopener  ugc nofollow" target="_blank" href="/moving-from-azure-app-services-to-azure-kubernetes-service-part-1-e489857c6440"><div class="kx ab fo"><div class="ky ab kz cl cj la"><h2 class="bd jb gy z fp lb fr fs lc fu fw iz bi translated">从Azure应用服务转移到Azure Kubernetes服务(第1部分)</h2><div class="ld l"><h3 class="bd b gy z fp lb fr fs lc fu fw dk translated">我建立AKS集群的经验，以及在Kubernetes和App Services上运行应用程序的比较。</h3></div><div class="le l"><p class="bd b dl z fp lb fr fs lc fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="lf l"><div class="lg l lh li lj lf lk iw kw"/></div></div></a></div><p id="5fe7" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在我工作的公司，任何种类的PaaS或SaaS解决方案的集中认证都是投入生产的必要条件。对于Azure应用服务，这是默认内置于平台中的——为了访问任何应用服务基础设施(例如，应用设置、Kudu、配置)，你需要登录Azure门户或Azure CLI。</p><p id="a423" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">不幸的是，对于AKS，情况并非如此——如果您使用默认设置，AKS将使用客户端证书来控制通过<em class="kv"> kubectl </em>的访问。</p><p id="7353" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">为了让我更进一步，让AKS成为我们运行web应用程序的首选平台，我需要确保它与Azure Active Directory集成。</p><p id="7846" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在这篇文章中，我将介绍认证过程的具体情况，以及如何进行设置。</p></div><div class="ab cl ll lm hx ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="im in io ip iq"><h1 id="7d22" class="ls lt ja bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">AKS管理的Azure活动目录集成</h1><p id="f52e" class="pw-post-body-paragraph jx jy ja jz b ka mq kc kd ke mr kg kh ki ms kk kl km mt ko kp kq mu ks kt ku im bi translated">所需工具:</p><ul class=""><li id="a9b0" class="mv mw ja jz b ka kb ke kf ki mx km my kq mz ku na nb nc nd bi translated"><a class="ae ne" href="https://docs.microsoft.com/en-us/cli/azure/" rel="noopener ugc nofollow" target="_blank"> az cli </a>:用于设置kubectl的配置</li><li id="9031" class="mv mw ja jz b ka nf ke ng ki nh km ni kq nj ku na nb nc nd bi translated">kubectl :与kubernetes交互的cli</li></ul><p id="d020" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">正如您将在下面看到的，设置kubectl的过程与非AAD集成的AKS完全相同。然而，一个关键的区别是，集成AAD的集群强制您在运行任何kubectl命令之前执行AAD认证。</p><p id="69b2" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">下面让我们来看看这是如何工作的:</p><p id="8e91" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们首先表演一个<code class="fe nk nl nm nn b">az login</code> …</p><pre class="no np nq nr gt ns nn nt nu aw nv bi"><span id="4931" class="nw lt ja nn b gy nx ny l nz oa">PS C:\&gt; az login<br/>The default web browser has been opened at <a class="ae ne" href="https://login.microsoftonline.com/common/oauth2/authorize" rel="noopener ugc nofollow" target="_blank">https://login.microsoftonline.com/common/oauth2/authorize</a>. Please continue the login in the web browser. If no web browser is available or if the web browser fails to open, use device code flow with `az login --use-device-code`.<br/>You have logged in. Now let us find all the subscriptions to which you have access...</span></pre><p id="1ae3" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">然后我们可以得到我们的kubectl凭证<code class="fe nk nl nm nn b">az aks get-credentials</code>:</p><figure class="no np nq nr gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ob"><img src="../Images/02fe96bfb09f3648832b73b321665203.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tAqp_4HXGRpxH2X3p7m0Jw.png"/></div></div></figure><p id="83a0" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在，当我第一次尝试运行kubectl命令时，系统提示我执行AAD登录:</p><figure class="no np nq nr gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi og"><img src="../Images/f9bd3bc90bed43bb2f316341f8613e7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TQSW-UxcivusGvediGOghw.png"/></div></div></figure><figure class="no np nq nr gt iv gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/f26f8fc079ebb0c81e0206ea758b293c.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/1*diyuCXpmqU0ozDGMwtkDNg.png"/></div></figure><figure class="no np nq nr gt iv gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/42a1e38e37cdb65493597864e83a6d03.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*U7Zf5GbiueZvvmUFTWtoyQ.png"/></div></figure><figure class="no np nq nr gt iv gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/1d63f62fd9ce1b573174f587eeba83ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/1*hOFXFsCs-JulHgUnfRRv3w.png"/></div></figure><p id="261b" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">只有在完成登录后，我才能从<code class="fe nk nl nm nn b">kubectl</code>获得任何输出:</p><figure class="no np nq nr gt iv gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/19f705f2496de8e24600ac54e979781c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*qIy-ptkJDYvREmkEW07nUA.png"/></div></figure><h2 id="3dee" class="nw lt ja bd lu ok ol dn ly om on dp mc ki oo op mg km oq or mk kq os ot mo ou bi translated">kubectl AAD凭证是什么样子的？</h2><p id="8caa" class="pw-post-body-paragraph jx jy ja jz b ka mq kc kd ke mr kg kh ki ms kk kl km mt ko kp kq mu ks kt ku im bi translated">如果您想知道有AAD集成的AKS集群和没有AAD集成的AKS集群之间的kubectl凭证有什么不同，那就来吧！</p><p id="787a" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><em class="kv">没有AAD:您使用证书来认证AKS </em></p><figure class="no np nq nr gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ov"><img src="../Images/ac1c555f140c7fdaa5ef27f7fcc40b9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yT3XGbZBiW8xdJa4raRJ8Q.png"/></div></div><figcaption class="ow ox gj gh gi oy oz bd b be z dk translated">不带AAD</figcaption></figure><p id="58bd" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><em class="kv">使用AAD:当您第一次运行</em> <code class="fe nk nl nm nn b"><em class="kv">az aks get-credentials</em></code> <em class="kv">时，kubectl config最初会填充AAD auth-provider配置:</em></p><figure class="no np nq nr gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi pa"><img src="../Images/d1dc48461629e35c803782013e9a7397.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WloZJZSQ4DjoGAVCTxHsmQ.png"/></div></div><figcaption class="ow ox gj gh gi oy oz bd b be z dk translated">带AAD(在AAD认证之前)</figcaption></figure><p id="f4c7" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><em class="kv">一旦您实际上通过了AAD的认证，kubectl配置就会用一个访问令牌进行更新:</em></p><figure class="no np nq nr gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi pb"><img src="../Images/9a68f297ceede42e32b384b7cac455c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zUXYt-5ttIWrJxHq3qPMww.png"/></div></div><figcaption class="ow ox gj gh gi oy oz bd b be z dk translated">使用AAD(在成功的AAD认证之后)</figcaption></figure><p id="38c8" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这要好得多(从网络安全的角度来看)，因为如果有人离开公司，你不必担心他们会带走任何Kubernetes证书。</p></div><div class="ab cl ll lm hx ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="im in io ip iq"><h1 id="7553" class="ls lt ja bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">设置它</h1><p id="c864" class="pw-post-body-paragraph jx jy ja jz b ka mq kc kd ke mr kg kh ki ms kk kl km mt ko kp kq mu ks kt ku im bi translated">下面是使用AAD集成创建新的AKS实例的步骤。<br/> <em class="kv">注意:所有这些步骤都可以从微软</em> <a class="ae ne" href="https://docs.microsoft.com/en-us/azure/aks/managed-aad" rel="noopener ugc nofollow" target="_blank"> <em class="kv">文档</em> </a>中获得</p><ul class=""><li id="954a" class="mv mw ja jz b ka kb ke kf ki mx km my kq mz ku na nb nc nd bi translated">创建资源组</li><li id="d58a" class="mv mw ja jz b ka nf ke ng ki nh km ni kq nj ku na nb nc nd bi translated">创建AD组(用于分配AKS权限)</li><li id="31a9" class="mv mw ja jz b ka nf ke ng ki nh km ni kq nj ku na nb nc nd bi translated">创建AKS管理的AD群集</li></ul><pre class="no np nq nr gt ns nn nt nu aw nv bi"><span id="481e" class="nw lt ja nn b gy nx ny l nz oa"><strong class="nn jb"># Login to Azure</strong><br/>az login<br/>az account set -s "Your Subscription Name"</span><span id="27c1" class="nw lt ja nn b gy pc ny l nz oa"><strong class="nn jb"># Set up variables</strong><br/>$RG="digital-aks"<br/>$AKSCLUSTER="digital-aks"<br/>$AKSADMINGROUP="AKS Admins"</span><span id="3100" class="nw lt ja nn b gy pc ny l nz oa"><strong class="nn jb"># Create an Azure AD group for cluster admins</strong><br/>az ad group create --display-name $AKSADMINGROUP --mail-nickname digitalaksadmins</span><span id="74bc" class="nw lt ja nn b gy pc ny l nz oa"><strong class="nn jb"># Create resource groups for AKS</strong><br/>az group create --name DefaultResourceGroup-EAU --location australiaEast </span><span id="ce58" class="nw lt ja nn b gy pc ny l nz oa">az group create --name $RG --location australiaEast </span><span id="254c" class="nw lt ja nn b gy pc ny l nz oa"><strong class="nn jb"># Create an AKS-managed Azure AD cluster</strong><br/>$AKS_GROUP_ID=$(az ad group show -g $AKSADMINGROUP --query objectId -o tsv)</span><span id="d775" class="nw lt ja nn b gy pc ny l nz oa">az aks create -g $RG -n $AKSCLUSTER --enable-aad --aad-admin-group-object-ids $AKS_GROUP_ID</span><span id="4880" class="nw lt ja nn b gy pc ny l nz oa"><strong class="nn jb"># Assign cluster admin role to AD group</strong><br/>$AKS_ID=$(az aks show --resource-group $RG --name $AKSCLUSTER --query id -o tsv)</span><span id="b88c" class="nw lt ja nn b gy pc ny l nz oa">az role assignment create --assignee $AKS_GROUP_ID --role "Azure Kubernetes Service Cluster Admin Role" --scope $AKS_ID</span><span id="e503" class="nw lt ja nn b gy pc ny l nz oa"><strong class="nn jb"># Assign users to the AKS admin group</strong><br/>$MEMBER_ID=$(az ad user show --id <a class="ae ne" href="mailto:jordan.lee@alintaenergy.com.au" rel="noopener ugc nofollow" target="_blank">jordan.lee@y</a>ourdomain.com --query objectId -o tsv)<br/>az ad group member add --group $AKS_GROUP_ID --member-id $MEMBER_ID</span></pre></div><div class="ab cl ll lm hx ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="im in io ip iq"><h1 id="8303" class="ls lt ja bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">结论</h1><p id="f958" class="pw-post-body-paragraph jx jy ja jz b ka mq kc kd ke mr kg kh ki ms kk kl km mt ko kp kq mu ks kt ku im bi translated">App Services的一大优点是与Azure AD的集成内置于平台中(我特别指的是基础设施层)。获得像Kudu或应用服务设置这样的东西都需要通过Azure门户，这迫使你进行AAD认证。</p><p id="bab9" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">默认情况下，AKS使用证书管理身份验证——虽然这很方便，但它往往会引发网络安全危险信号(谁拥有证书副本，证书如何保存，当人们离开时证书如何轮换等)。</p><p id="efdf" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">AAD是许多运行在Azure上的企业的首选IDP，所以如果你试图将AKS作为公司的首选平台，安全人员可能会希望你实现AAD集成。</p><p id="7a70" class="pw-post-body-paragraph jx jy ja jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">幸运的是，微软已经使这变得非常容易，那么为什么不使用它呢？不用担心每次有人退出时都要轮换证书，这绝对是件好事！</p></div></div>    
</body>
</html>