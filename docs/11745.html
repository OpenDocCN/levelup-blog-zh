<html>
<head>
<title>How To Enable Versioning In S3 Using Terraform and LocalStack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Terraform和LocalStack在S3启用版本控制</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-enable-versioning-in-s3-using-terraform-and-localstack-b387a4ab453b?source=collection_archive---------9-----------------------#2022-04-12">https://levelup.gitconnected.com/how-to-enable-versioning-in-s3-using-terraform-and-localstack-b387a4ab453b?source=collection_archive---------9-----------------------#2022-04-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="9322" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">保护S3存储桶不被意外删除</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/3165a9482f04ed8c580548c82631adbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*idE-t4GTE1Coo6b1dmU4Kw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</figcaption></figure><p id="7167" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">AWS S3允许对象的版本控制从意外删除和应用程序故障中恢复。默认情况下，任何S3时段都禁用版本控制。</p><p id="55c0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以从任何意外删除中恢复，这是通过S3启用的特殊标记完成的，我们将在本文后面讨论。</p><p id="630f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们首先遵循一些初始步骤来开始版本化工作。<br/>请参考我之前关于使用terraform和本地堆栈创建S3存储桶的文章，我将使用相同的示例来创建一个具有版本控制的存储桶</p><div class="le lf gp gr lg lh"><a rel="noopener  ugc nofollow" target="_blank" href="/how-to-test-s3-with-terraform-using-localstack-585d2366fa13"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd iu gy z fp lm fr fs ln fu fw is bi translated">如何使用LocalStack用Terraform测试S3</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">LocalStack简化了AWS服务的测试</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="lq l"><div class="lr l ls lt lu lq lv ky lh"/></div></div></a></div><h2 id="3bc4" class="lw lx it bd ly lz ma dn mb mc md dp me kb mf mg mh kf mi mj mk kj ml mm mn mo bi translated">步骤#1在S3启用版本控制</h2><p id="9ca9" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated"><code class="fe mu mv mw mx b">versioning_configuration</code>添加<code class="fe mu mv mw mx b">status</code>属性为<code class="fe mu mv mw mx b">enabled</code>的版本信息</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="my mz l"/></div></figure><h2 id="f4a7" class="lw lx it bd ly lz ma dn mb mc md dp me kb mf mg mh kf mi mj mk kj ml mm mn mo bi translated">第二步运行地形计划</h2><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="20bc" class="lw lx it mx b gy ne nf l ng nh">terraform init<br/>terraform plan</span><span id="29d0" class="lw lx it mx b gy ni nf l ng nh">Output :</span><span id="dedf" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu"># aws_iam_role.invocation_role</strong> will be created</span><span id="b799" class="lw lx it mx b gy ni nf l ng nh">+ resource "aws_iam_role" "invocation_role" {</span><span id="2ab9" class="lw lx it mx b gy ni nf l ng nh">+ arn                   = (known after apply)</span><span id="c2de" class="lw lx it mx b gy ni nf l ng nh">+ assume_role_policy    = jsonencode(</span><span id="dc14" class="lw lx it mx b gy ni nf l ng nh">{</span><span id="4a7d" class="lw lx it mx b gy ni nf l ng nh">+ Statement = {</span><span id="116c" class="lw lx it mx b gy ni nf l ng nh">+ Action   = "s3:ListBucket"</span><span id="1513" class="lw lx it mx b gy ni nf l ng nh">+ Effect   = "Allow"</span><span id="1284" class="lw lx it mx b gy ni nf l ng nh">+ Resource = "arn:aws:s3:::test-bucket"</span><span id="a397" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="21b8" class="lw lx it mx b gy ni nf l ng nh">+ Version   = "2012-10-17"</span><span id="5d0a" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="d973" class="lw lx it mx b gy ni nf l ng nh">)</span><span id="3ac5" class="lw lx it mx b gy ni nf l ng nh">+ create_date           = (known after apply)</span><span id="fff2" class="lw lx it mx b gy ni nf l ng nh">+ force_detach_policies = false</span><span id="4f9a" class="lw lx it mx b gy ni nf l ng nh">+ id                    = (known after apply)</span><span id="3320" class="lw lx it mx b gy ni nf l ng nh">+ managed_policy_arns   = (known after apply)</span><span id="a566" class="lw lx it mx b gy ni nf l ng nh">+ max_session_duration  = 3600</span><span id="5a14" class="lw lx it mx b gy ni nf l ng nh">+ name                  = "s3_api_gateway_auth_invocation"</span><span id="3df9" class="lw lx it mx b gy ni nf l ng nh">+ name_prefix           = (known after apply)</span><span id="3949" class="lw lx it mx b gy ni nf l ng nh">+ path                  = "/"</span><span id="7f27" class="lw lx it mx b gy ni nf l ng nh">+ tags_all              = (known after apply)</span><span id="09c4" class="lw lx it mx b gy ni nf l ng nh">+ unique_id             = (known after apply)</span><span id="420c" class="lw lx it mx b gy ni nf l ng nh">+ inline_policy {</span><span id="b626" class="lw lx it mx b gy ni nf l ng nh">+ name   = (known after apply)</span><span id="de0c" class="lw lx it mx b gy ni nf l ng nh">+ policy = (known after apply)</span><span id="9a93" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="b45d" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="e822" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu"># aws_s3_bucket.test-bucket</strong> will be created</span><span id="4b3a" class="lw lx it mx b gy ni nf l ng nh">+ resource "aws_s3_bucket" "test-bucket" {</span><span id="98de" class="lw lx it mx b gy ni nf l ng nh">+ acceleration_status                  = (known after apply)</span><span id="fe57" class="lw lx it mx b gy ni nf l ng nh">+ acl                                  = (known after apply)</span><span id="0b20" class="lw lx it mx b gy ni nf l ng nh">+ arn                                  = (known after apply)</span><span id="285c" class="lw lx it mx b gy ni nf l ng nh">+ bucket                               = "my-bucket"</span><span id="56ef" class="lw lx it mx b gy ni nf l ng nh">+ bucket_domain_name                   = (known after apply)</span><span id="d65c" class="lw lx it mx b gy ni nf l ng nh">+ bucket_regional_domain_name          = (known after apply)</span><span id="3a7f" class="lw lx it mx b gy ni nf l ng nh">+ cors_rule                            = (known after apply)</span><span id="caf0" class="lw lx it mx b gy ni nf l ng nh">+ force_destroy                        = false</span><span id="4119" class="lw lx it mx b gy ni nf l ng nh">+ grant                                = (known after apply)</span><span id="29b2" class="lw lx it mx b gy ni nf l ng nh">+ hosted_zone_id                       = (known after apply)</span><span id="9116" class="lw lx it mx b gy ni nf l ng nh">+ id                                   = (known after apply)</span><span id="7184" class="lw lx it mx b gy ni nf l ng nh">+ lifecycle_rule                       = (known after apply)</span><span id="2125" class="lw lx it mx b gy ni nf l ng nh">+ logging                              = (known after apply)</span><span id="e59c" class="lw lx it mx b gy ni nf l ng nh">+ object_lock_enabled                  = (known after apply)</span><span id="2cc7" class="lw lx it mx b gy ni nf l ng nh">+ policy                               = (known after apply)</span><span id="97aa" class="lw lx it mx b gy ni nf l ng nh">+ region                               = (known after apply)</span><span id="4968" class="lw lx it mx b gy ni nf l ng nh">+ replication_configuration            = (known after apply)</span><span id="3b73" class="lw lx it mx b gy ni nf l ng nh">+ request_payer                        = (known after apply)</span><span id="6260" class="lw lx it mx b gy ni nf l ng nh">+ server_side_encryption_configuration = (known after apply)</span><span id="614b" class="lw lx it mx b gy ni nf l ng nh">+ tags_all                             = (known after apply)</span><span id="b652" class="lw lx it mx b gy ni nf l ng nh">+ versioning                           = (known after apply)</span><span id="0c14" class="lw lx it mx b gy ni nf l ng nh">+ website                              = (known after apply)</span><span id="e7b7" class="lw lx it mx b gy ni nf l ng nh">+ website_domain                       = (known after apply)</span><span id="57bb" class="lw lx it mx b gy ni nf l ng nh">+ website_endpoint                     = (known after apply)</span><span id="a75a" class="lw lx it mx b gy ni nf l ng nh">+ object_lock_configuration {</span><span id="c901" class="lw lx it mx b gy ni nf l ng nh">+ object_lock_enabled = (known after apply)</span><span id="d154" class="lw lx it mx b gy ni nf l ng nh">+ rule                = (known after apply)</span><span id="9e94" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="104b" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="a626" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu"># aws_s3_bucket_versioning.versioning_example</strong> will be created</span><span id="6166" class="lw lx it mx b gy ni nf l ng nh">+ resource "aws_s3_bucket_versioning" "versioning_example" {</span><span id="aaf2" class="lw lx it mx b gy ni nf l ng nh">+ bucket = (known after apply)</span><span id="08ee" class="lw lx it mx b gy ni nf l ng nh">+ id     = (known after apply)</span><span id="51bc" class="lw lx it mx b gy ni nf l ng nh">+ versioning_configuration {</span><span id="2e70" class="lw lx it mx b gy ni nf l ng nh">+ mfa_delete = (known after apply)</span><span id="045f" class="lw lx it mx b gy ni nf l ng nh">+ status     = "Enabled"</span><span id="1074" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="2e08" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="507b" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">Plan:</strong> 3 to add, 0 to change, 0 to destroy.</span><span id="7d01" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">Do you want to perform these actions?</strong></span><span id="fe13" class="lw lx it mx b gy ni nf l ng nh">Terraform will perform the actions described above.</span><span id="42f9" class="lw lx it mx b gy ni nf l ng nh">Only 'yes' will be accepted to approve.</span><span id="9939" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">Enter a value:</strong> yes</span><span id="83cb" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">aws_iam_role.invocation_role: Creating...</strong></span><span id="9789" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">aws_s3_bucket.test-bucket: Creating...</strong></span><span id="0771" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">aws_s3_bucket.test-bucket: Creation complete after 1s [id=my-bucket]</strong></span><span id="9429" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">aws_s3_bucket_versioning.versioning_example: Creating...</strong></span><span id="6edf" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">aws_iam_role.invocation_role: Creation complete after 1s [id=s3_api_gateway_auth_invocation]</strong></span><span id="08cc" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">aws_s3_bucket_versioning.versioning_example: Creation complete after 1s [id=my-bucket]</strong></span><span id="45ef" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">Apply complete! Resources: 3 added, 0 changed, 0 destroyed.</strong></span></pre><p id="b3e4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们现在看到我们有三个变更<strong class="js iu"><em class="nj"/></strong>，因为我们从一开始就在创建存储桶。如果我只添加版本控制部分，那么将只添加一个资源<strong class="js iu"><em class="nj"/></strong>。</p><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="d6e6" class="lw lx it mx b gy ne nf l ng nh">terraform apply</span></pre><h2 id="b7bc" class="lw lx it bd ly lz ma dn mb mc md dp me kb mf mg mh kf mi mj mk kj ml mm mn mo bi translated"><strong class="ak"> <em class="nk">步骤#3验证桶并添加一个文件</em> </strong></h2><p id="23d3" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">让我们先添加一个带有简单文本的文件</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="eda4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们创建一个别名，并将其添加到我们的<code class="fe mu mv mw mx b">.zshrc</code></p><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="5cfb" class="lw lx it mx b gy ne nf l ng nh">alias awss3api="aws --endpoint-url=http://localhost:4566 s3api"<br/>alias awss3="aws --endpoint-url=http://localhost:4566 s3"<br/></span></pre><p id="53a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">找到<code class="fe mu mv mw mx b">.zshrc</code>并验证桶中的内容</p><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="b538" class="lw lx it mx b gy ne nf l ng nh">source ~/.zshrc</span><span id="f9e4" class="lw lx it mx b gy ni nf l ng nh">awss3 cp test.txt s3://my-bucket</span><span id="6f13" class="lw lx it mx b gy ni nf l ng nh">awss3 ls s3://my-bucket</span><span id="992c" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">Output:</strong><br/>2022-04-10 15:17:39         65 test.txt</span></pre><p id="0560" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们试着看看文件的版本是否被创建</p><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="879e" class="lw lx it mx b gy ne nf l ng nh">awss3api list-object-versions --bucket my-bucket --key test.txt</span><span id="6ab9" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">Output:</strong><br/>{</span><span id="92f4" class="lw lx it mx b gy ni nf l ng nh">"IsTruncated": false,</span><span id="9034" class="lw lx it mx b gy ni nf l ng nh">"KeyMarker": "test.txt",</span><span id="1b09" class="lw lx it mx b gy ni nf l ng nh">"Versions": [</span><span id="1230" class="lw lx it mx b gy ni nf l ng nh">{</span><span id="3f17" class="lw lx it mx b gy ni nf l ng nh">"ETag": "\"44100b5ed6d5128ca6b705a29c489c29\"",</span><span id="34ba" class="lw lx it mx b gy ni nf l ng nh">"Size": 22,</span><span id="909d" class="lw lx it mx b gy ni nf l ng nh">"StorageClass": "STANDARD",</span><span id="5802" class="lw lx it mx b gy ni nf l ng nh">"Key": "test.txt",</span><span id="6f44" class="lw lx it mx b gy ni nf l ng nh">"VersionId": "f43ce36e-baaa-46ea-b44f-437b6e61758b",</span><span id="01a9" class="lw lx it mx b gy ni nf l ng nh">"IsLatest": true,</span><span id="1368" class="lw lx it mx b gy ni nf l ng nh">"LastModified": "2022-04-10T10:03:04+00:00",</span><span id="acb4" class="lw lx it mx b gy ni nf l ng nh">"Owner": {</span><span id="4bb6" class="lw lx it mx b gy ni nf l ng nh">"DisplayName": "webfile",</span><span id="79e7" class="lw lx it mx b gy ni nf l ng nh">"ID": "75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a"</span><span id="e4fc" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="85bd" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="3f95" class="lw lx it mx b gy ni nf l ng nh">],</span><span id="5443" class="lw lx it mx b gy ni nf l ng nh">"Name": "my-bucket",</span><span id="7db3" class="lw lx it mx b gy ni nf l ng nh">"Prefix": "",</span><span id="75f3" class="lw lx it mx b gy ni nf l ng nh">"Delimiter": "",</span><span id="ae21" class="lw lx it mx b gy ni nf l ng nh">"MaxKeys": 1000</span><span id="7e68" class="lw lx it mx b gy ni nf l ng nh">}</span></pre><p id="8f7c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建版本<strong class="js iu">f 43 ce 36 e-baaa-46ea-b44f-437 B6 e 61758 b</strong>并用键<code class="fe mu mv mw mx b">test.txt</code>将<code class="fe mu mv mw mx b">isLatest</code>设置为<code class="fe mu mv mw mx b">true</code></p><h2 id="ea77" class="lw lx it bd ly lz ma dn mb mc md dp me kb mf mg mh kf mi mj mk kj ml mm mn mo bi translated"><strong class="ak"> <em class="nk">步骤#4添加与修改</em> </strong>相同的文件</h2><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="my mz l"/></div></figure><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="26d6" class="lw lx it mx b gy ne nf l ng nh">awss3 cp test.txt s3://my-bucket</span><span id="4559" class="lw lx it mx b gy ni nf l ng nh">awss3api list-object-versions --bucket my-bucket --key test.txt</span><span id="8ece" class="lw lx it mx b gy ni nf l ng nh">Output :<br/>{</span><span id="f1c1" class="lw lx it mx b gy ni nf l ng nh">"IsTruncated": false,</span><span id="8a47" class="lw lx it mx b gy ni nf l ng nh">"KeyMarker": "test.txt",</span><span id="67cc" class="lw lx it mx b gy ni nf l ng nh">"Versions": [</span><span id="7b9b" class="lw lx it mx b gy ni nf l ng nh">{</span><span id="51c0" class="lw lx it mx b gy ni nf l ng nh">"ETag": "\"6a26de2e122c69d94ff12e03b9b7498f\"",</span><span id="db1d" class="lw lx it mx b gy ni nf l ng nh">"Size": 65,</span><span id="5b1d" class="lw lx it mx b gy ni nf l ng nh">"StorageClass": "STANDARD",</span><span id="e9e4" class="lw lx it mx b gy ni nf l ng nh">"Key": "test.txt",</span><span id="261c" class="lw lx it mx b gy ni nf l ng nh">"VersionId": "7548306c-dfd3-4d3a-a994-28e790c479a6",</span><span id="ec03" class="lw lx it mx b gy ni nf l ng nh">"IsLatest": true,</span><span id="d4b9" class="lw lx it mx b gy ni nf l ng nh">"LastModified": "2022-04-10T10:08:28+00:00",</span><span id="918e" class="lw lx it mx b gy ni nf l ng nh">"Owner": {</span><span id="9777" class="lw lx it mx b gy ni nf l ng nh">"DisplayName": "webfile",</span><span id="64d2" class="lw lx it mx b gy ni nf l ng nh">"ID": "75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a"</span><span id="e025" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="6b20" class="lw lx it mx b gy ni nf l ng nh">},</span><span id="31b0" class="lw lx it mx b gy ni nf l ng nh">{</span><span id="1938" class="lw lx it mx b gy ni nf l ng nh">"ETag": "\"44100b5ed6d5128ca6b705a29c489c29\"",</span><span id="8e22" class="lw lx it mx b gy ni nf l ng nh">"Size": 22,</span><span id="86e7" class="lw lx it mx b gy ni nf l ng nh">"StorageClass": "STANDARD",</span><span id="9c30" class="lw lx it mx b gy ni nf l ng nh">"Key": "test.txt",</span><span id="58a8" class="lw lx it mx b gy ni nf l ng nh">"VersionId": "f43ce36e-baaa-46ea-b44f-437b6e61758b",</span><span id="4f50" class="lw lx it mx b gy ni nf l ng nh">"IsLatest": false,</span><span id="0020" class="lw lx it mx b gy ni nf l ng nh">"LastModified": "2022-04-10T10:03:04+00:00",</span><span id="eee3" class="lw lx it mx b gy ni nf l ng nh">"Owner": {</span><span id="07d0" class="lw lx it mx b gy ni nf l ng nh">"DisplayName": "webfile",</span><span id="0830" class="lw lx it mx b gy ni nf l ng nh">"ID": "75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a"</span><span id="cf10" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="ef25" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="09a8" class="lw lx it mx b gy ni nf l ng nh">],</span><span id="40bc" class="lw lx it mx b gy ni nf l ng nh">"Name": "my-bucket",</span><span id="59cd" class="lw lx it mx b gy ni nf l ng nh">"Prefix": "",</span><span id="3031" class="lw lx it mx b gy ni nf l ng nh">"Delimiter": "",</span><span id="9df5" class="lw lx it mx b gy ni nf l ng nh">"MaxKeys": 1000</span><span id="e19d" class="lw lx it mx b gy ni nf l ng nh">}</span></pre><p id="33a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建版本<strong class="js iu">7548306 c-DFD 3–4d3a-a994–28e 790 c 479 a6</strong>并用键<code class="fe mu mv mw mx b">test.txt</code>将<code class="fe mu mv mw mx b">isLatest</code>设置为<code class="fe mu mv mw mx b">true</code>，同时将<strong class="js iu">f 43 ce 36 e-baaa-46ea-b44f-437 B6 e 61758 b</strong>设置为<code class="fe mu mv mw mx b">false</code>。</p><p id="a3b5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="nj">版本维护，可以认为是堆栈后进先出。</em> </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nl"><img src="../Images/fef1147fabdb323ef728d35bfab68954.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-6hhJv0sawsB0j_l3gEkfA.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae nm" href="https://unsplash.com/@holly_buildalifeyoulove?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">霍利·斯特拉顿</a>在<a class="ae nm" href="https://unsplash.com/s/photos/stack?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="3918" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以使用<code class="fe mu mv mw mx b">get-object</code>获得最新版本的内容</p><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="bb46" class="lw lx it mx b gy ne nf l ng nh">awss3api get-object --bucket my-bucket --key test.txt --range bytes=0-10000 /dev/stdout</span><span id="66db" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">Ouptput:</strong><br/>Hello I am s3 bucket.</span><span id="4975" class="lw lx it mx b gy ni nf l ng nh">The versioning is enabled for this bucket.</span><span id="3043" class="lw lx it mx b gy ni nf l ng nh">{</span><span id="d886" class="lw lx it mx b gy ni nf l ng nh">"AcceptRanges": "bytes",</span><span id="580b" class="lw lx it mx b gy ni nf l ng nh">"LastModified": "2022-04-10T13:17:39+00:00",</span><span id="1fab" class="lw lx it mx b gy ni nf l ng nh">"ContentLength": 65,</span><span id="16cf" class="lw lx it mx b gy ni nf l ng nh">"ETag": "\"6a26de2e122c69d94ff12e03b9b7498f\"",</span><span id="7678" class="lw lx it mx b gy ni nf l ng nh">"VersionId": "8832c9db-0cd3-42bb-b88c-082c7e4ebb49",</span><span id="208b" class="lw lx it mx b gy ni nf l ng nh">"ContentLanguage": "en-US",</span><span id="1fca" class="lw lx it mx b gy ni nf l ng nh">"ContentRange": "bytes 0-64/65",</span><span id="8091" class="lw lx it mx b gy ni nf l ng nh">"ContentType": "text/plain",</span><span id="7424" class="lw lx it mx b gy ni nf l ng nh">"Metadata": {}</span><span id="92c6" class="lw lx it mx b gy ni nf l ng nh">}</span></pre><h2 id="e66b" class="lw lx it bd ly lz ma dn mb mc md dp me kb mf mg mh kf mi mj mk kj ml mm mn mo bi translated"><strong class="ak">步骤#5在存储桶上执行删除</strong></h2><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="5d24" class="lw lx it mx b gy ne nf l ng nh">awss3api delete-object --bucket my-bucket --key test.txt</span><span id="dbd7" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">Output:</strong></span><span id="68a0" class="lw lx it mx b gy ni nf l ng nh">awss3 delete-object --bucket my-bucket --key test.txt</span><span id="607f" class="lw lx it mx b gy ni nf l ng nh">{</span><span id="590b" class="lw lx it mx b gy ni nf l ng nh">"VersionId": "a1098f60-95e4-4007-8c15-b66e5dcf53f9"</span><span id="4a30" class="lw lx it mx b gy ni nf l ng nh">}</span></pre><p id="e72f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">运行以下命令将不会返回任何内容</strong></p><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="8620" class="lw lx it mx b gy ne nf l ng nh">awss3 ls s3://my-bucket</span></pre><p id="2830" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们试着找出原因</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/5ab836d2217ded2ca2317181452f424c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dfh_Ib78U68mkc1mseIsKg.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</figcaption></figure><h1 id="a57a" class="nn lx it bd ly no np nq mb nr ns nt me nu nv nw mh nx ny nz mk oa ob oc mn od bi translated">删除标记</h1><ul class=""><li id="4b3e" class="oe of it js b jt mp jx mq kb og kf oh kj oi kn oj ok ol om bi translated">当删除存储桶内的对象时，会添加它</li><li id="5a9a" class="oe of it js b jt on jx oo kb op kf oq kj or kn oj ok ol om bi translated">它带有一个密钥和版本Id</li><li id="f248" class="oe of it js b jt on jx oo kb op kf oq kj or kn oj ok ol om bi translated">这是对象的最新版本，即它们位于版本堆栈的顶部。</li></ul><p id="304b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们看到在<code class="fe mu mv mw mx b">DeleteMarkers</code>部分创建了一个新版本</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/ff7474bc6b68057a19297a1af39676e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lyj1UDWEii6j-auuOOFPIA.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">作者图片</figcaption></figure><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="ca3d" class="lw lx it mx b gy ne nf l ng nh">awss3api list-object-versions — bucket my-bucket — key test.txt</span><span id="b4e0" class="lw lx it mx b gy ni nf l ng nh">Ouput:<br/>{</span><span id="8589" class="lw lx it mx b gy ni nf l ng nh">"IsTruncated": false,</span><span id="e134" class="lw lx it mx b gy ni nf l ng nh">"KeyMarker": "test.txt",</span><span id="fd73" class="lw lx it mx b gy ni nf l ng nh">"Versions": [</span><span id="41bc" class="lw lx it mx b gy ni nf l ng nh">{</span><span id="36ac" class="lw lx it mx b gy ni nf l ng nh">"ETag": "\"6a26de2e122c69d94ff12e03b9b7498f\"",</span><span id="a463" class="lw lx it mx b gy ni nf l ng nh">"Size": 65,</span><span id="5414" class="lw lx it mx b gy ni nf l ng nh">"StorageClass": "STANDARD",</span><span id="0a65" class="lw lx it mx b gy ni nf l ng nh">"Key": "test.txt",</span><span id="c635" class="lw lx it mx b gy ni nf l ng nh">"VersionId": "7548306c-dfd3-4d3a-a994-28e790c479a6",</span><span id="ff71" class="lw lx it mx b gy ni nf l ng nh">"IsLatest": false,</span><span id="076d" class="lw lx it mx b gy ni nf l ng nh">"LastModified": "2022-04-10T10:08:28+00:00",</span><span id="5af5" class="lw lx it mx b gy ni nf l ng nh">"Owner": {</span><span id="51c8" class="lw lx it mx b gy ni nf l ng nh">"DisplayName": "webfile",</span><span id="66ba" class="lw lx it mx b gy ni nf l ng nh">"ID": "75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a"</span><span id="37eb" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="56aa" class="lw lx it mx b gy ni nf l ng nh">},</span><span id="ec9b" class="lw lx it mx b gy ni nf l ng nh">{</span><span id="50dd" class="lw lx it mx b gy ni nf l ng nh">"ETag": "\"44100b5ed6d5128ca6b705a29c489c29\"",</span><span id="99bb" class="lw lx it mx b gy ni nf l ng nh">"Size": 22,</span><span id="7a22" class="lw lx it mx b gy ni nf l ng nh">"StorageClass": "STANDARD",</span><span id="297b" class="lw lx it mx b gy ni nf l ng nh">"Key": "test.txt",</span><span id="1853" class="lw lx it mx b gy ni nf l ng nh">"VersionId": "f43ce36e-baaa-46ea-b44f-437b6e61758b",</span><span id="90f2" class="lw lx it mx b gy ni nf l ng nh">"IsLatest": false,</span><span id="46f2" class="lw lx it mx b gy ni nf l ng nh">"LastModified": "2022-04-10T10:03:04+00:00",</span><span id="97f0" class="lw lx it mx b gy ni nf l ng nh">"Owner": {</span><span id="2921" class="lw lx it mx b gy ni nf l ng nh">"DisplayName": "webfile",</span><span id="2eee" class="lw lx it mx b gy ni nf l ng nh">"ID": "75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a"</span><span id="b366" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="3044" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="aa21" class="lw lx it mx b gy ni nf l ng nh">],</span><span id="e9c9" class="lw lx it mx b gy ni nf l ng nh">"<strong class="mx iu">DeleteMarkers</strong>": [</span><span id="5510" class="lw lx it mx b gy ni nf l ng nh">{</span><span id="deff" class="lw lx it mx b gy ni nf l ng nh">"Owner": {</span><span id="a5c7" class="lw lx it mx b gy ni nf l ng nh">"DisplayName": "webfile",</span><span id="1c9d" class="lw lx it mx b gy ni nf l ng nh">"ID": "75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a"</span><span id="2889" class="lw lx it mx b gy ni nf l ng nh">},</span><span id="6dcb" class="lw lx it mx b gy ni nf l ng nh">"Key": "test.txt",</span><span id="c701" class="lw lx it mx b gy ni nf l ng nh">"VersionId": "a1098f60-95e4-4007-8c15-b66e5dcf53f9",</span><span id="ee9a" class="lw lx it mx b gy ni nf l ng nh">"IsLatest": true,</span><span id="8101" class="lw lx it mx b gy ni nf l ng nh">"LastModified": "2022-04-10T13:09:56+00:00"</span><span id="dd0f" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="cee1" class="lw lx it mx b gy ni nf l ng nh">],</span><span id="295f" class="lw lx it mx b gy ni nf l ng nh">"Name": "my-bucket",</span><span id="bc77" class="lw lx it mx b gy ni nf l ng nh">"Prefix": "",</span><span id="2817" class="lw lx it mx b gy ni nf l ng nh">"Delimiter": "",</span><span id="9483" class="lw lx it mx b gy ni nf l ng nh">"MaxKeys": 1000</span><span id="88d3" class="lw lx it mx b gy ni nf l ng nh">}</span></pre><h2 id="465d" class="lw lx it bd ly lz ma dn mb mc md dp me kb mf mg mh kf mi mj mk kj ml mm mn mo bi translated">步骤#6执行第二次删除</h2><p id="559b" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">执行另一个删除将添加另一个删除标记，让我们尝试运行一个命令</p><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="1a75" class="lw lx it mx b gy ne nf l ng nh">awss3api delete-object --bucket my-bucket --key test.txt</span><span id="844c" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">Output:</strong><br/>{</span><span id="5d6d" class="lw lx it mx b gy ni nf l ng nh">"VersionId": "60a67a37-15cd-453c-a0cb-a3d387b64d24"</span><span id="bba4" class="lw lx it mx b gy ni nf l ng nh">}</span></pre><p id="3287" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">我们看到现在有两个删除标记</strong></p><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="722e" class="lw lx it mx b gy ne nf l ng nh">awss3api list-object-versions --bucket my-bucket --key test.txt</span><span id="4f28" class="lw lx it mx b gy ni nf l ng nh"><strong class="mx iu">Output:</strong><br/>............</span><span id="41ea" class="lw lx it mx b gy ni nf l ng nh">"DeleteMarkers": [</span><span id="ba0d" class="lw lx it mx b gy ni nf l ng nh">{</span><span id="c588" class="lw lx it mx b gy ni nf l ng nh">"Owner": {</span><span id="755b" class="lw lx it mx b gy ni nf l ng nh">"DisplayName": "webfile",</span><span id="72ca" class="lw lx it mx b gy ni nf l ng nh">"ID": "75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a"</span><span id="4d93" class="lw lx it mx b gy ni nf l ng nh">},</span><span id="f31a" class="lw lx it mx b gy ni nf l ng nh">"Key": "test.txt",</span><span id="411c" class="lw lx it mx b gy ni nf l ng nh">"VersionId": "60a67a37-15cd-453c-a0cb-a3d387b64d24",</span><span id="c79e" class="lw lx it mx b gy ni nf l ng nh">"IsLatest": true,</span><span id="a756" class="lw lx it mx b gy ni nf l ng nh">"LastModified": "2022-04-10T13:10:29+00:00"</span><span id="1b48" class="lw lx it mx b gy ni nf l ng nh">},</span><span id="4486" class="lw lx it mx b gy ni nf l ng nh">{</span><span id="f466" class="lw lx it mx b gy ni nf l ng nh">"Owner": {</span><span id="d16f" class="lw lx it mx b gy ni nf l ng nh">"DisplayName": "webfile",</span><span id="9047" class="lw lx it mx b gy ni nf l ng nh">"ID": "75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a"</span><span id="6eb8" class="lw lx it mx b gy ni nf l ng nh">},</span><span id="3004" class="lw lx it mx b gy ni nf l ng nh">"Key": "test.txt",</span><span id="e6d4" class="lw lx it mx b gy ni nf l ng nh">"VersionId": "a1098f60-95e4-4007-8c15-b66e5dcf53f9",</span><span id="1a4c" class="lw lx it mx b gy ni nf l ng nh">"IsLatest": false,</span><span id="1072" class="lw lx it mx b gy ni nf l ng nh">"LastModified": "2022-04-10T13:09:56+00:00"</span><span id="6a7f" class="lw lx it mx b gy ni nf l ng nh">}</span><span id="081f" class="lw lx it mx b gy ni nf l ng nh">],</span><span id="c9bc" class="lw lx it mx b gy ni nf l ng nh">"Name": "my-bucket",</span><span id="04d6" class="lw lx it mx b gy ni nf l ng nh">"Prefix": "",</span><span id="da66" class="lw lx it mx b gy ni nf l ng nh">"Delimiter": "",</span><span id="f419" class="lw lx it mx b gy ni nf l ng nh">"MaxKeys": 1000</span><span id="7dd1" class="lw lx it mx b gy ni nf l ng nh">}</span></pre><h2 id="72f5" class="lw lx it bd ly lz ma dn mb mc md dp me kb mf mg mh kf mi mj mk kj ml mm mn mo bi translated">步骤7:移除删除标记</h2><p id="3f0d" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated"><strong class="js iu"> <em class="nj">先说第一个。</em>T12】</strong></p><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="99b6" class="lw lx it mx b gy ne nf l ng nh">awss3api delete-object --bucket my-bucket --key test.txt --version-id 60a67a37-15cd-453c-a0cb-a3d387b64d24</span><span id="ac13" class="lw lx it mx b gy ni nf l ng nh">Output:<br/>{</span><span id="b1ee" class="lw lx it mx b gy ni nf l ng nh">"DeleteMarker": true</span><span id="0fb3" class="lw lx it mx b gy ni nf l ng nh">}<br/></span></pre><p id="5f80" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="nj">第二个</em> </strong></p><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="0221" class="lw lx it mx b gy ne nf l ng nh">awss3api delete-object --bucket my-bucket --key test.txt --version-id a1098f60-95e4-4007-8c15-b66e5dcf53f9</span><span id="3bda" class="lw lx it mx b gy ni nf l ng nh">Output:<br/>{</span><span id="c7cd" class="lw lx it mx b gy ni nf l ng nh">"DeleteMarker": true</span><span id="1fbc" class="lw lx it mx b gy ni nf l ng nh">}</span></pre><p id="eef1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">再次列出桶中的对象，您应该能够看到文件<code class="fe mu mv mw mx b">test.txt</code>并使用<code class="fe mu mv mw mx b">list-object-versions</code>列出版本</p><pre class="kp kq kr ks gt na mx nb nc aw nd bi"><span id="6ee5" class="lw lx it mx b gy ne nf l ng nh">awss3 ls s3://my-bucket<br/>awss3api list-object-versions --bucket my-bucket --key test.txt</span></pre><p id="f236" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请参考我的<a class="ae nm" href="https://github.com/pgolani28/terraform_localstack_demo" rel="noopener ugc nofollow" target="_blank"> Github repo </a>获取代码，也请参考我的博客来创建你自己的公共库</p><div class="le lf gp gr lg lh"><a href="https://faun.pub/how-to-create-your-first-git-hub-repo-mac-f3df63398c94" rel="noopener  ugc nofollow" target="_blank"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd iu gy z fp lm fr fs ln fu fw is bi translated">如何创建你的第一个Git Hub Repo — Mac</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">通往Git Hub仓库的5个简单步骤</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">faun.pub</p></div></div><div class="lq l"><div class="os l ls lt lu lq lv ky lh"/></div></div></a></div><h1 id="749a" class="nn lx it bd ly no np nq mb nr ns nt me nu nv nw mh nx ny nz mk oa ob oc mn od bi translated"><strong class="ak">结论</strong></h1><p id="8300" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">感谢您阅读这篇文章，它对理解S3版本控制特性非常有用。</p><p id="c6ba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="nj">走之前</em></strong>……<em class="nj">如果你喜欢我的故事，想支持我的写作，</em> <a class="ae nm" href="https://medium.com/@prernagolani21/membership" rel="noopener"> <strong class="js iu"> <em class="nj">就在这里</em> </strong> </a> <em class="nj">成为中等会员。一个月5美元，你就可以获得无限的故事，我会赚一点佣金，不需要你额外付费。谢谢你看我的故事，支持我对写作的热爱。</em></p><p id="11c8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请<strong class="js iu">关注我</strong>/<a class="ae nm" href="https://medium.com/subscribe/@prernagolani21" rel="noopener">/<strong class="js iu">订阅电子邮件</strong> </a>，这样我的下一篇文章一出来你就会知道。</p><h1 id="6bfc" class="nn lx it bd ly no np nq mb nr ns nt me nu nv nw mh nx ny nz mk oa ob oc mn od bi translated"><strong class="ak">参考文献</strong></h1><p id="d892" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated"><a class="ae nm" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/versioning-workflows.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/Amazon S3/latest/user guide/versioning-workflows . html</a><br/><a class="ae nm" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket" rel="noopener ugc nofollow" target="_blank">https://registry . terraform . io/providers/hashi corp/AWS/latest/docs/resources/S3 _ bucket</a></p></div></div>    
</body>
</html>