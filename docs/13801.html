<html>
<head>
<title>Execute Scripts through Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Terraform执行脚本</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/execute-scripts-through-terraform-4885e62e6cda?source=collection_archive---------11-----------------------#2022-10-06">https://levelup.gitconnected.com/execute-scripts-through-terraform-4885e62e6cda?source=collection_archive---------11-----------------------#2022-10-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="05ee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如何在terraform中执行power-shell或cli脚本</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/378efb3356a892749811b3b866eaa3b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zZY9bAKDTqzeyC52WUMjJg.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated"><a class="ae le" href="https://unsplash.com/@mitchel3uo?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">米切尔·罗</a>在<a class="ae le" href="https://unsplash.com/s/photos/code?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="5b90" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Terraform是供应云基础设施的一个很好的工具，也是编写代码的一种声明式方式。但有时它会遗漏一些您的云提供商支持的功能。例如，当我写这篇博客时，terraform在创建Azure AD应用程序时无法设置默认值<code class="fe lf lg lh li b">identifier_uris</code>以及这里提到的一个未解决的问题<a class="ae le" href="https://github.com/hashicorp/terraform-provider-azuread/issues/428" rel="noopener ugc nofollow" target="_blank"> azuread_application:默认identifier_uris字段为“api://application_id ”,因为门户发布了#428 </a></p><h2 id="f672" class="lj lk it bd ll lm ln dn lo lp lq dp lr kb ls lt lu kf lv lw lx kj ly lz ma mb bi translated">地形上的脚本</h2><p id="f541" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">那么我们能做什么呢？是的，有一个解决办法！！是的，这是你开发生涯中最喜欢的词。因此，要解决这个问题，有很多工作要做，我已经在这里写了一篇博客<a class="ae le" href="https://rollendxavier.medium.com/how-to-use-powershell-files-in-azure-devops-pipelines-88e0ec801d1d" rel="noopener">在Azure DevOps管道中使用PowerShell文件</a>。但是对于这个场景，将尝试使用terraform资源本身使用<code class="fe lf lg lh li b">null_resource </code> &amp; <code class="fe lf lg lh li b">provisioner</code>的组合来执行外部脚本。</p><p id="1282" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了运行脚本，我们将使用Terraform中的<code class="fe lf lg lh li b">null_resource </code>，并在这里找到更多关于它的信息<a class="ae le" href="https://www.terraform.io/docs/provisioners/null_resource.html" rel="noopener ugc nofollow" target="_blank">。使用null_resource，我们将调用<code class="fe lf lg lh li b">local_exec</code> provisioner，它指定脚本将在运行Terraform配置的代理上运行。更多信息请点击</a><a class="ae le" href="https://www.terraform.io/docs/provisioners/local-exec.html" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><h2 id="2b15" class="lj lk it bd ll lm ln dn lo lp lq dp lr kb ls lt lu kf lv lw lx kj ly lz ma mb bi translated"><strong class="ak">例子</strong></h2><p id="ea39" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">因此，我们上面提到的限制，让我们尝试通过terraform本身来解决</p><pre class="kp kq kr ks gt mh li mi mj aw mk bi"><span id="b088" class="lj lk it li b gy ml mm l mn mo">resource "azuread_application" "app1" {<br/>  display_name = "test-app1"<br/>}</span><span id="de29" class="lj lk it li b gy mp mm l mn mo">locals {<br/>  identifier_uri          = "api://${azuread_application.app1.application_id}"<br/>}</span><span id="a134" class="lj lk it li b gy mp mm l mn mo">resource "null_resource" "app_identifier_uri" {<br/>  provisioner "local-exec" {<br/>    command = "az ad app update --id $APP_OBJECT_ID --identifier-uris $IDENTIFIER_URI"<br/>    environment = {<br/>      APP_OBJECT_ID           = azuread_application.app1.object_id<br/>      IDENTIFIER_URI          = local.identifier_uri<br/>    }<br/>  }</span><span id="e954" class="lj lk it li b gy mp mm l mn mo">depends_on = [<br/>    azuread_application.app1<br/>  ]<br/>}</span></pre><p id="857d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们深入了解上面的代码发生了什么，第一部分是创建一个名为“test-app1”的示例广告应用程序。下一步是创建一个局部变量，然后通过一个<code class="fe lf lg lh li b">null_resource</code>更新<code class="fe lf lg lh li b">identifier_uri</code>。</p><h2 id="b2d6" class="lj lk it bd ll lm ln dn lo lp lq dp lr kb ls lt lu kf lv lw lx kj ly lz ma mb bi translated"><strong class="ak">地形补给者</strong></h2><p id="5b58" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">terraform中有两种供应器，<code class="fe lf lg lh li b">local-exec</code> &amp; <code class="fe lf lg lh li b">remote-exec</code></p><blockquote class="mq mr ms"><p id="4e99" class="jq jr mt js b jt ju jv jw jx jy jz ka mu kc kd ke mv kg kh ki mw kk kl km kn im bi translated"><strong class="js iu">本地执行供应器在创建资源后调用本地可执行文件</strong>。这将在运行Terraform的机器上调用一个进程，而不是在资源上</p></blockquote><p id="7446" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">是的，没错，local exec不对资源做任何事情，但是对于我们的场景，要执行外部脚本，这是可行的。我们需要一个适当的Azure连接已启用，terraform服务主体已定义所需的角色和访问。</p><h2 id="faa1" class="lj lk it bd ll lm ln dn lo lp lq dp lr kb ls lt lu kf lv lw lx kj ly lz ma mb bi translated">结论</h2><p id="89ad" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">大多数时候，我都是在DevOps管道中编写外部脚本，而terraform创建脚本的能力很方便，我觉得这很容易参考。还有其他需要考虑的事情，比如空资源状态、脚本执行的生命周期等等，这些都留给你了:)。</p></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/802615e8f0b0af65ea502e62a59c49f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*GmYQcOEQAMarSzEG.gif"/></div></figure></div></div>    
</body>
</html>