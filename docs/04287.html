<html>
<head>
<title>Making Golang Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让Golang前进</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/making-golang-go-43c800b4b754?source=collection_archive---------11-----------------------#2020-06-18">https://levelup.gitconnected.com/making-golang-go-43c800b4b754?source=collection_archive---------11-----------------------#2020-06-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2786" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">学习新语言的冒险经历</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c01c22228a70d02d90377099c423c686.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CGVXG6BaktIkpbfIXsO0RQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">亚历克斯·金在<a class="ae ky" href="/s/photos/green-light?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="3e35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上次有人问我最喜欢的编程语言是什么，我的回答是‘英语’。这只是部分玩笑，因为我遇到的大多数编程语言只是英语的方言，散布着一些基于数学的符号。学习新的编程语言并不难，难的是学习使用工具、最佳实践，以及在已经为该语言建立的框架和库中工作。在我的日常工作中，我不怎么写应用程序，而是把开源库和少量的业务逻辑粘在一起。所以我更多地处理库和框架的协同工作，而不是花太多时间处理语言语法。</p><p id="4fdc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">围棋已经存在了一段时间(10年对计算机来说是一段时间)，我一直对它很感兴趣。但是我从来没有深入研究过，因为它缺乏工具和依赖管理。像Java和JavaScript这样的语言有用于依赖性管理的Maven和NPM，以及一套健壮的用于构建软件的成熟工具。最新版本的Go支持模块，但是首选的构建系统仍然是Makefiles，这似乎有点过时了。如果Go的首选IDE不是vi，我不会感到惊讶。</p><p id="6725" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然Go已经尝试用模块解决了它的依赖危机，我就要用最新版本的Go再来一次，寻找Go的思维定势。我将创建一个RESTful web服务，因为这是新的hello world。我还将尝试模仿流行的模式和实践。但是首先，关于我和我所使用的语言，我将比较去。如果你不想读我的历史，只想直接进入编程，你可以跳过几段。</p><p id="d0bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在80年代中期开始用C语言编程，我很喜欢它，因为它简单明了。这本钻石般锋利的书<em class="lv">C编程语言</em>让我养成了许多我至今仍保留的品质。C++出来的时候，我全身心投入。我花时间将世界划分为对象层次，并学习如何在C/C++固有的不安全世界中安全地游戏。</p><p id="1897" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当Java问世时，我有些怀疑，因为它用性能换取了安全性，而我已经花了十年时间学习如何安全地穿越C/C++语言的火圈。它也促进了可移植性，但我当时的工作主要是为Windows编写GUI应用程序。最终，我开始关注Java。现在我几乎完全用Java来写，我怀疑如果不付出相当大的努力，我是否能有效地用C/C++来写。</p><p id="557b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">JavaScript出来的时候，我也是持怀疑态度的，主要是因为它是严格意义上的GUI。但是我正在脱离面向对象的思维，所以它的功能方面很吸引人。然后当Node.js和NPM出来的时候，我就被吸引住了。最后，一种在前端和后端都同样得心应手的本地语言。不幸的是，后端工作仍然主要是Java，这就是我在过去二十年中一直坚持的地方。</p><p id="4a1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我说够了，我们来谈谈围棋。我的历史已经让你厌烦了，就不拿围棋的历史来烦你了。我将马上着手一个新项目。我将假设您有最新版本的Go(在撰写本文时是1.14)。我也将使用Docker，因为现在一切都是集装箱化的。除此之外，我将使用一个基本的代码编辑器和命令行。在本文的最后一部分，我将在Kubernetes集群中运行我的应用程序。</p><p id="be89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我正在用<a class="ae ky" href="https://github.com/moovweb/gvm" rel="noopener ugc nofollow" target="_blank"> GVM </a>安装和使用最新版本的Go。GVM工具允许我改变Go的版本(和依赖项)来匹配我想要构建的东西。因为我正在构建新的东西，所以我将使用最新的版本</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="d50e" class="mb mc it lx b gy md me l mf mg">gvm install go1.14.3<br/>gvm use go1.14.3 --default<br/>go version # check to make sure go 1.14.3 is the version</span></pre><p id="f3ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就建立了必要的环境。请注意，如果您从未安装过Go，1.4之后的版本将需要安装Go，因此您必须先安装1.4，然后才能安装新版本，并且必须先安装C环境，然后才能安装1.4。在macOS上使用Xcode，你应该有一个C环境。</p><p id="570d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们建立一个项目。在我与音乐组合<a class="ae ky" href="https://www.youtube.com/playlist?list=OLAK5uy_kFjcTE_ft7hcCWfvOqqk2Yxd5kS3Z211c" rel="noopener ugc nofollow" target="_blank">海蓝宝石太空独角兽</a>(不要脸的插头)的第一张专辑后，我把我的歌叫作go-go-go。首先，我将在GitHub上创建存储库。Go模块使用git(或mercurial或bazaar)作为依赖库，还有什么比GitHub更好的git库呢？一旦你在GitHub上创建了新的资源库，你就可以克隆它。</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="a5dd" class="mb mc it lx b gy md me l mf mg">git clone <a class="ae ky" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:rkamradt/go-go-go.git<br/>cd go-go-go</span></pre><p id="74c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将它初始化为Go模块:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="f3cd" class="mb mc it lx b gy md me l mf mg">go mod init github.com/rkamradt/go-go-go</span></pre><p id="63be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那应该已经为你创建了一个<code class="fe mh mi mj lx b">go.mod</code>，内容如下:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="0fc6" class="mb mc it lx b gy md me l mf mg">module github.com/rkamradt/go-go-go</span><span id="83d5" class="mb mc it lx b gy mk me l mf mg">go 1.14</span></pre><p id="c99d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">很简单。现在我们冲进去开始编码？没有。我想考虑我将构建什么，我将需要什么模块。在之前的一篇帖子<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-kubernetes-cron-jobs-to-periodically-read-the-news-8b3b4513f8b7">如何使用Kubernetes Cron Jobs定期读取新闻</a>中，我构建了一个读取新闻API的微服务，将其添加到一个MongoDB数据库中，以及另一个读取数据库的微服务。我仍然在我的Kubernetes集群中运行所有这些服务，所以我将在Go中创建另一个read服务，然后我可以将它与用Java编写的read服务进行比较。</p><p id="5a6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我需要一个MongoDB驱动模块和一个REST接口模块。理论上，我可以为REST调用使用内置的net库，但这是对Go模块的探索，所以我将找到一个添加到内置库中的模块。哪里可以找到Go模块？幸运的是，这里有一个精选列表:【https://github.com/avelino/awesome-go<a class="ae ky" href="https://github.com/avelino/awesome-go" rel="noopener ugc nofollow" target="_blank">。从那里我找到了官方的MongoDB驱动程序https://github.com/mongodb/mongo-go-driver</a><a class="ae ky" href="https://github.com/mongodb/mongo-go-driver" rel="noopener ugc nofollow" target="_blank">和一个合适的web框架https://github.com/gin-gonic/gin</a><a class="ae ky" href="https://github.com/gin-gonic/gin" rel="noopener ugc nofollow" target="_blank">。让我们“去拿”那些模块:</a></p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="1ba6" class="mb mc it lx b gy md me l mf mg">go get go.mongodb.org/mongo-driver/mongo<br/>go get -u github.com/gin-gonic/gin</span></pre><p id="40ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将创建一个go.sum文件，其中包含所有依赖项和临时依赖项的校验和。</p><p id="e2c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我将从gin-gonic GitHub页面获取示例代码，进行一些简单的修改，并确保我可以运行它。这是我的第一次迭代:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="44dc" class="mb mc it lx b gy md me l mf mg">package main</span><span id="fdec" class="mb mc it lx b gy mk me l mf mg">import "github.com/gin-gonic/gin"</span><span id="19ca" class="mb mc it lx b gy mk me l mf mg">func main() {<br/> r := gin.Default()<br/> r.GET("/test", func(c *gin.Context) {<br/>  c.JSON(200, gin.H{<br/>   "message": "test",<br/>  })<br/> })<br/> r.Run() // listen and serve localhost:8080<br/>}</span></pre><p id="bede" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以运行它了:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="e767" class="mb mc it lx b gy md me l mf mg">Fuji:go-go-go randalkamradt$ go run main.go<br/>[GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.</span><span id="f3b5" class="mb mc it lx b gy mk me l mf mg">[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.<br/> - using env: export GIN_MODE=release<br/> - using code: gin.SetMode(gin.ReleaseMode)</span><span id="477a" class="mb mc it lx b gy mk me l mf mg">[GIN-debug] GET    /test                     --&gt; main.main.func1 (3 handlers)<br/>[GIN-debug] Environment variable PORT is undefined. Using port :8080 by default<br/>[GIN-debug] Listening and serving HTTP on :8080</span></pre><p id="8ee1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有点啰嗦，我得想办法把它关小。但是现在让我们来测试一下。打开另一个终端窗口并尝试:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="b55e" class="mb mc it lx b gy md me l mf mg">Fuji:~ randalkamradt$ curl <a class="ae ky" href="http://localhost:8080/test" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/test</a><br/>{"message":"test"}Fuji:~ randalkamradt$</span></pre><p id="2df8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到目前为止，一切顺利。我总是喜欢尽可能快地做一些小的改变和测试。Control-C来停止服务器。</p><p id="669c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是从数据库中读取它。由于我的目标数据库是MongoDB，并且我不想在我的笔记本电脑上安装MongoDB，所以我将使用docker-compose进行一个简单的测试。但这意味着我需要为我的新程序创建一个docker映像。现在，我将创建一个非常简单的docker文件，不过以后我可能会对它进行扩展。这是我想到的:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="38d4" class="mb mc it lx b gy md me l mf mg">FROM golang:alpine</span><span id="074f" class="mb mc it lx b gy mk me l mf mg">ENV GO111MODULE=on \<br/>    CGO_ENABLED=0 \<br/>    GOOS=linux \<br/>    GOARCH=amd64</span><span id="1270" class="mb mc it lx b gy mk me l mf mg">WORKDIR /build</span><span id="f0f7" class="mb mc it lx b gy mk me l mf mg">COPY go.mod .<br/>COPY go.sum .<br/>RUN go mod download</span><span id="b769" class="mb mc it lx b gy mk me l mf mg">COPY . .</span><span id="9301" class="mb mc it lx b gy mk me l mf mg">RUN go build -o main .</span><span id="96b1" class="mb mc it lx b gy mk me l mf mg">WORKDIR /dist</span><span id="5854" class="mb mc it lx b gy mk me l mf mg">RUN cp /build/main .</span><span id="5613" class="mb mc it lx b gy mk me l mf mg">CMD ["/dist/main"]</span></pre><p id="3d49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在建立一个图像:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="68cf" class="mb mc it lx b gy md me l mf mg">docker build . -t go-go-go</span></pre><p id="3783" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们添加数据库之前，让我们将它作为docker映像运行，以确保一切仍然正常工作:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="ef27" class="mb mc it lx b gy md me l mf mg">Fuji:go-go-go randalkamradt$ docker run -p 8080:8080 go-go-go<br/>[GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.</span><span id="5071" class="mb mc it lx b gy mk me l mf mg">[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.<br/> - using env: export GIN_MODE=release<br/> - using code: gin.SetMode(gin.ReleaseMode)</span><span id="a5c5" class="mb mc it lx b gy mk me l mf mg">[GIN-debug] GET    /test                     --&gt; main.main.func1 (3 handlers)<br/>[GIN-debug] Environment variable PORT is undefined. Using port :8080 by default<br/>[GIN-debug] Listening and serving HTTP on :8080</span></pre><p id="15b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并使用相同的curl命令再次进行测试(记住在每次小迭代后进行测试)。Control-C再次停止服务器。</p><p id="2c98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们有了一个可以在docker-compose中运行的图像，我们可以添加一些数据库方法并在数据库中运行它。同样，我将直接从MongoDB示例中复制。这是第二次迭代:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="68c6" class="mb mc it lx b gy md me l mf mg">package main</span><span id="b422" class="mb mc it lx b gy mk me l mf mg">import (<br/>  "os"<br/>  "context"<br/>  "log"<br/>  "time"<br/>  "github.com/gin-gonic/gin"<br/>  "go.mongodb.org/mongo-driver/bson"<br/>  "go.mongodb.org/mongo-driver/mongo"<br/>  "go.mongodb.org/mongo-driver/mongo/options"<br/>)</span><span id="147c" class="mb mc it lx b gy mk me l mf mg">func main() {<br/> mongoUser := os.Getenv("MONGO_USER")<br/> mongoPassword := os.Getenv("MONGO_PASS")</span><span id="7d08" class="mb mc it lx b gy mk me l mf mg">client, err := mongo.NewClient(options.Client().ApplyURI("mongodb://" +<br/>     mongoUser +<br/>     ":" +<br/>     mongoPassword +<br/>     "<a class="ae ky" href="http://twitter.com/mongodb" rel="noopener ugc nofollow" target="_blank">@mongodb</a>:27017"))<br/> ctx, _ := context.WithTimeout(<br/>  context.Background(),<br/>  10*time.Second)<br/> err = client.Connect(ctx)</span><span id="3093" class="mb mc it lx b gy mk me l mf mg">ctx, _ = context.WithTimeout(<br/>  context.Background(),<br/>  5*time.Second)<br/> collection := client.Database("news").Collection("inserts")<br/> res, err := collection.InsertOne(<br/>  ctx,<br/>  bson.M{"name": "pi", "value": 3.14159})<br/> if err != nil {<br/>  log.Fatal(err)<br/>  return<br/> }<br/> if(res != nil) {<br/>  log.Printf("Inserted a single document: ", res.InsertedID)<br/> }</span><span id="1029" class="mb mc it lx b gy mk me l mf mg">r := gin.Default()<br/> r.GET("/test", func(c *gin.Context) {<br/>  var result struct {<br/>      Value float64<br/>  }<br/>  filter := bson.M{"name": "pi"}<br/>  ctx, _ = context.WithTimeout(<br/>   context.Background(),<br/>   5*time.Second)<br/>  err = collection.FindOne(ctx, filter).Decode(&amp;result)<br/>  if err != nil {<br/>      log.Fatal(err)<br/>  }<br/>  c.JSON(200, gin.H{<br/>   "pi": result.Value,<br/>  })<br/> })<br/> r.Run() // listen and serve localhost:8080<br/>}</span></pre><p id="cbcb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它有点大，我在服务器启动之前添加了一个insert，这样我们就可以在请求中读取一些内容。同样，代码几乎直接取自MongoDB Go驱动程序页面，因此它可能会使用一些重构来使它在我们的特定上下文中最有效地工作。</p><p id="a689" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在是docker-compose文件。我们有两件事情需要提到，MongoDB数据库和应用程序。以下是我所知道的:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="8d1c" class="mb mc it lx b gy md me l mf mg">version: '3'<br/>services:<br/>  mongodb:<br/>    image: mongo:3.6.18<br/>    restart: always<br/>    ports:<br/>      - 27017:27017<br/>    environment:<br/>      MONGO_INITDB_ROOT_USERNAME: admin<br/>      MONGO_INITDB_ROOT_PASSWORD: admin<br/>  app:<br/>    build: .<br/>    ports:<br/>      - 8080:8080<br/>    environment:<br/>      MONGO_USER: admin<br/>      MONGO_PASS: admin<br/>    depends_on:<br/>      - "mongodb"</span></pre><p id="0d7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们需要启动数据库，因为启动需要几秒钟时间:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="6c49" class="mb mc it lx b gy md me l mf mg">docker-compose up -d mongodb</span></pre><p id="8caa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们需要构建:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="00ae" class="mb mc it lx b gy md me l mf mg">docker-compose build app</span></pre><p id="a1d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们提出应用程序。这里我没有使用<code class="fe mh mi mj lx b">-d</code>标志，这样我可以直接看到日志:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="cee7" class="mb mc it lx b gy md me l mf mg">Fuji:go-go-go randalkamradt$ docker-compose up app<br/>go-go-go_mongodb_1 is up-to-date<br/>Recreating go-go-go_app_1 ... done<br/>Attaching to go-go-go_app_1<br/>app_1      | [GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.<br/>app_1      | <br/>app_1      | [GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.<br/>app_1      |  - using env: export GIN_MODE=release<br/>app_1      |  - using code: gin.SetMode(gin.ReleaseMode)<br/>app_1      | <br/>app_1      | [GIN-debug] GET    /test                     --&gt; main.main.func1 (3 handlers)<br/>app_1      | [GIN-debug] Environment variable PORT is undefined. Using port :8080 by default<br/>app_1      | [GIN-debug] Listening and serving HTTP on :8080<br/>app_1      | 2020/06/16 18:52:13 Inserted a single document: %!(EXTRA primitive.ObjectID=ObjectID("5ee914ddf6db654a5ce871da"))</span></pre><p id="1277" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以使用相同的curl命令再次进行测试，但这一次的输出会略有不同:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="d844" class="mb mc it lx b gy md me l mf mg">Fuji:~ randalkamradt$ curl <a class="ae ky" href="http://localhost:8080/test" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/test</a><br/>{"pi":3.14159}Fuji:~ randalkamradt$</span></pre><p id="59a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">成功！Control-C停止docker-compose进程，并运行<code class="fe mh mi mj lx b">docker-compose down</code>删除停止的docker进程。</p><p id="f2de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们看看这一切在Kubernetes世界中是如何运作的。但是首先，我们将转移到最后一次迭代(至少对于本文来说)。我将更改应用程序，使其与Java版本完全一致，这样当我在Kubernetes中部署它时，它就能很好地适应。下面的代码应该可以完成这个任务:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="1f19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我应该指出，这不是最有效的程序，它流过整个数据集并过滤日期。我这样做有很多原因，其中之一是我不想写这篇关于MongoDB的多功能查询的文章。此外，我可能会像在文章<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/non-blocking-java-beyond-the-hype-dfdc405848d7">非阻塞Java </a>中那样比较性能，我不想放弃不公平的优势。感谢我的同事Jacob Cleaveland审查代码，以确保它“可以运行”。</p><p id="c6f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">构建代码并推送:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="e037" class="mb mc it lx b gy md me l mf mg">docker build . -t go-go-go<br/>docker tag go-go-go rlkamradt/go-go-go<br/>docker push</span></pre><p id="42e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将把它推到DockerHub注册表。我应该提到，我们可以通过使用多级docker文件来大大减小图像的大小。这将删除Go构建时命令，只留下编译后的程序。但我会留到下一次。</p><p id="c1e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以在Kubernetes使用它。但是首先，让我们把现有的东西推回GitHub:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="821c" class="mb mc it lx b gy md me l mf mg">git add .<br/>git commit -m "initial commit"<br/>git push</span></pre><p id="3d82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想继续阅读下一部分，我建议你先阅读我的文章<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-kubernetes-cron-jobs-to-periodically-read-the-news-8b3b4513f8b7">如何使用Kubernetes Cron Jobs定期阅读新闻</a>。那篇文章的最后一部分将向您展示如何设置Kubernetes中的所有组件来运行它。</p><p id="d09b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我现在要切换GitHub存储库，我有一个单独的库用于需要的Kubernetes部署文件。然后，我将能够复制一个旧的部署文件，以允许它使用新的映像。你可以将我的GitHub库<a class="ae ky" href="https://github.com/rkamradt/news-deploy/tree/v1.2" rel="noopener ugc nofollow" target="_blank">https://github.com/rkamradt/news-deploy</a>克隆到一个你可以访问<code class="fe mh mi mj lx b">kubectl</code>命令的主机上。<code class="fe mh mi mj lx b">README.md</code>有关于如何启动一切的基本说明。我将现有的<code class="fe mh mi mj lx b">readnewsblock.yaml</code>复制到readnewsgo.yaml(我在比较<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/non-blocking-java-beyond-the-hype-dfdc405848d7">非阻塞Java中的阻塞与非阻塞I/O时创建了<code class="fe mh mi mj lx b">readnewsblock.yaml</code>——超出了宣传的范围</a>)。编辑新的<code class="fe mh mi mj lx b">readnewsgo.yaml</code>，我通篇用<code class="fe mh mi mj lx b">readnewsgo</code>替换了<code class="fe mh mi mj lx b">readnewsblock</code>，更改了镜像名称，并删除了健康检查(我没有在Go版本中添加健康检查端点)。这是我想到的:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="f5e1" class="mb mc it lx b gy md me l mf mg">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: readnewsgo-deployment<br/>  labels:<br/>    app: readnewsgo<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: readnewsgo<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: readnewsgo<br/>    spec:<br/>      containers:<br/>      - name: readnewsgo<br/>        image: docker.io/rlkamradt/go-go-go:latest<br/>        ports:<br/>        - containerPort: 8080<br/>        env:<br/>          - name: MONGO_USER<br/>            valueFrom:<br/>              secretKeyRef:<br/>                name: mongo-secret<br/>                key: username<br/>          - name: MONGO_PASS<br/>            valueFrom:<br/>              secretKeyRef:<br/>                name: mongo-secret<br/>                key: password<br/>          - name: MONGO_HOST<br/>            value: mongodb-0.mongodb           <br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: readnewsgo-service<br/>spec:<br/>  type: ClusterIP<br/>  selector:<br/>    app: readnewsgo<br/>  ports:<br/>  - port: 8080<br/>    targetPort: 8080</span></pre><p id="2346" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还为<code class="fe mh mi mj lx b">vhosts-ingress.yaml</code>中的<code class="fe mh mi mj lx b">readnewsgo.local</code>添加了一个虚拟主机，如下所示:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="ecd5" class="mb mc it lx b gy md me l mf mg">apiVersion: networking.k8s.io/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: readnews-ingress<br/>  annotations:<br/>    cert-manager.io/issuer: ca-issuer <br/>spec:<br/>  rules:<br/>  - host: readnews.local<br/>    http:<br/>      paths:<br/>      - backend:<br/>          serviceName: readnews-service<br/>          servicePort: 8080<br/>        path: /<br/>  - host: readnewsblock.local<br/>    http:<br/>      paths:<br/>      - backend:<br/>          serviceName: readnewsblock-service<br/>          servicePort: 8080<br/>        path: /<br/>  - host: readnewsgo.local<br/>    http:<br/>      paths:<br/>      - backend:<br/>          serviceName: readnewsgo-service<br/>          servicePort: 8080<br/>        path: /<br/>  tls:<br/>  - hosts:<br/>    - readnewsblock.local<br/>    secretName: readnewsblock-cert<br/>  - hosts:<br/>    - readnewsgo.local<br/>    secretName: readnewsgo-cert<br/>  - hosts:<br/>    - readnews.local<br/>    secretName: readnews-cert</span></pre><p id="c6b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，关于这些文件做什么的信息，请参考我以前的文章。</p><p id="7a45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我应用了新的和修改过的文件:</p><pre class="kj kk kl km gt lw lx ly lz aw ma bi"><span id="4f68" class="mb mc it lx b gy md me l mf mg">kubectl apply -n nr -f readnewsgo.yaml<br/>kubectl apply -n nr -f vhost-ingress.yaml</span></pre><p id="5406" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我可以在我的笔记本电脑上的<code class="fe mh mi mj lx b">/etc/hosts</code>中添加<code class="fe mh mi mj lx b">readnewsgo.local</code>的别名，我可以浏览<a class="ae ky" href="https://readnewsgo.local/v1/headlines" rel="noopener ugc nofollow" target="_blank">https://readnewsgo.local/v1/headlines</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/204015660d63190b1193ca79a3fbb4ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wNd32uQhaHVSTPY3HV5Pzg.png"/></div></div></figure><p id="6c3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以我觉得围棋怎么样？我并不急于赶时髦。显然，我在这里创建的小程序很可能不会为任何语言提供很好的展示，我编写它的方式可能反映了我的经验不足。我当然想知道更多关于Go使用的并发模型的信息，因为这应该是它的强项之一。但除此之外，它似乎是一种非常普通的语言，并没有太多吸引我去提倡它的地方。</p><p id="e6ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我又浪费了几个小时编写了另一个毫无用处的程序。但当我的日常工作突然决定围棋是有史以来最好的东西，并想在其中写下一切时，我对围棋有了更多的了解，也有了更多的准备。感谢您加入我的旅程！</p><p id="c416" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文中使用的GitHub存储库:</p><div class="mo mp gp gr mq mr"><a href="https://github.com/rkamradt/go-go-go/tree/v1.0" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">rkamradt/go-go-go</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">go中一个简单的RESTful webservice。在GitHub上创建一个帐户，为rkamradt/go-go-go开发做贡献。</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div><div class="na l"><div class="nb l nc nd ne na nf ks mr"/></div></div></a></div><div class="mo mp gp gr mq mr"><a href="https://github.com/rkamradt/news-deploy/tree/v1.2" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">rkamradt/新闻-部署</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">用于部署新闻阅读器/readnews微服务的脚本- rkamradt/news-deploy</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div><div class="na l"><div class="ng l nc nd ne na nf ks mr"/></div></div></a></div><p id="5d67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">提到的其他文章:</p><div class="mo mp gp gr mq mr"><a rel="noopener  ugc nofollow" target="_blank" href="/how-to-use-kubernetes-cron-jobs-to-periodically-read-the-news-8b3b4513f8b7"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">如何使用Kubernetes Cron Jobs定期阅读新闻</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">阅读新闻的微服务。</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="na l"><div class="nh l nc nd ne na nf ks mr"/></div></div></a></div><div class="mo mp gp gr mq mr"><a rel="noopener  ugc nofollow" target="_blank" href="/non-blocking-java-beyond-the-hype-dfdc405848d7"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">非阻塞Java——超越宣传</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">集装箱化世界中阻塞与非阻塞的比较</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="na l"><div class="ni l nc nd ne na nf ks mr"/></div></div></a></div></div></div>    
</body>
</html>