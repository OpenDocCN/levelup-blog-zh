<html>
<head>
<title>Create a Jenkins Pipeline with GitLab for Java Projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用GitLab为Java项目创建一个Jenkins管道</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/jenkins-pipeline-with-gitlab-for-java-projects-d2e10c08e255?source=collection_archive---------0-----------------------#2020-04-13">https://levelup.gitconnected.com/jenkins-pipeline-with-gitlab-for-java-projects-d2e10c08e255?source=collection_archive---------0-----------------------#2020-04-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/c7326adbeaee550e4ab69fd0dcf18d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*zxRWg_D0NSuRYD38rX64AA.png"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">图片来源:https://qautomation.blog/2019/05/28/jenkins-pipeline/</figcaption></figure><p id="f1ef" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这篇文章将向您展示如何配置一个Jenkins管道，当您将代码推送到GitLab库时，该管道将自动构建您的项目。我们将使用一个<strong class="kd iu"> Jenkinsfile </strong>来定义我们的管道，这是最佳实践。</p><p id="60dc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">工作流程如下:</p><p id="0921" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">推送至GitLab → Jenkins管道触发→运行构建(Maven) →运行JUnit测试(Maven) →从管道发送电子邮件结果</strong></p><p id="4fa3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你还没有安装GitLab和Jenkins，你可以按照<a class="ae kz" href="https://medium.com/@gyfdev/install-gitlab-jenkins-on-centos-7-504df77fae4" rel="noopener">这篇文章</a>中的说明，然后回到这里。</p><p id="b039" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这篇文章还假设您已经安装了Java、Git和Maven，以及一个至少有一个JUnit测试的简单Maven项目。在继续之前，确保您能够成功地在您的项目上运行<code class="fe la lb lc ld b">mvn clean install </code>和<code class="fe la lb lc ld b">mvn test </code>。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="73c2" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">步骤1:创建GitLab存储库</h1><p id="fec1" class="pw-post-body-paragraph kb kc it kd b ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku mn kw kx ky im bi translated">在GitLab中，点击<strong class="kd iu">组</strong>下拉菜单，然后点击<strong class="kd iu">新建组</strong>按钮，创建一个组。为您的群组命名，然后点击<strong class="kd iu">创建群组</strong>。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mo"><img src="../Images/fd0a3bdb84e68d08159ca9a5e5c54e7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RGqRiQAh0oldwqAErdhASw.png"/></div></div></figure><p id="495d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">点击<strong class="kd iu">新建项目</strong>创建一个新项目。给它起个名字，然后点击<strong class="kd iu">创建项目</strong>。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mx"><img src="../Images/2b14bd64d73bc424718be5b6b2054e57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B_2gzjgzVCdWZhCtHEK6-Q.png"/></div></div></figure><p id="b37c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">初始化您的本地Maven项目，并将其推送到您的新存储库:</p><pre class="mp mq mr ms gt my ld mz na aw nb bi"><span id="f902" class="nc lm it ld b gy nd ne l nf ng">cd existing_folder<br/>git init<br/>git remote add origin <a class="ae kz" href="http://localhost/my-group/my-project.git" rel="noopener ugc nofollow" target="_blank">http://localhost/my-group/my-project.git</a><br/>git add .<br/>git commit -m "Initial commit"<br/>git push -u origin master</span></pre><p id="5696" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在GitLab中刷新您的项目，您应该会看到您的代码。如果你看到一个横幅写着“Auto DevOps pipeline已启用…”进入设置并禁用它。</p><h1 id="03f8" class="ll lm it bd ln lo nh lq lr ls ni lu lv lw nj ly lz ma nk mc md me nl mg mh mi bi translated">步骤2:在GitLab中创建一个Jenkins用户</h1><p id="24d6" class="pw-post-body-paragraph kb kc it kd b ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku mn kw kx ky im bi translated">我们需要在GitLab中创建一个Jenkins用户，以便Jenkins可以通过我们将在步骤4中安装的插件与GitLab的API进行通信。</p><p id="1ba2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在GitLab中，点击顶部工具栏中的扳手图标进入管理区。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nm"><img src="../Images/c9b9b52be408d13fbb8aa5573af1410e.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*OomTngy2TR6sCZ9qdzfAHw.png"/></div></div></figure><p id="6df6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在左侧菜单中，点击<strong class="kd iu">用户</strong>，然后点击右上角的<strong class="kd iu">新用户</strong>。适当填写必填字段，并确保选择<strong class="kd iu">访问级别</strong>下的<strong class="kd iu">管理</strong>单选按钮:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nn"><img src="../Images/db196796575621cf5c1b5dbfe8505afe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZRTdQCBRsiXHW1sB8WZM5Q.png"/></div></div></figure><p id="3507" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">返回到<strong class="kd iu">用户</strong>页面，编辑您刚刚创建的Jenkins用户。给用户一个密码，以便您可以作为该用户登录。完成后，退出当前会话，以Jenkins用户身份登录。</p><p id="c7e5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以Jenkins用户身份登录后，转到您的设置并点击左侧菜单栏中的<strong class="kd iu">访问令牌</strong>。确保给你的令牌起一个名字，并在<strong class="kd iu">范围</strong>下选择<strong class="kd iu"> api </strong>。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi no"><img src="../Images/910dbe11cc22d40a1594119ebd27ee36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cau3JzuTX5cKYSlwmg41QA.png"/></div></div></figure><p id="8e16" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦你创建了访问令牌，<strong class="kd iu">将令牌复制并粘贴到临时的某个地方</strong>——你将不能再从这里访问它。我们稍后将使用这个令牌。</p><p id="26bb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注销并以<strong class="kd iu"> root </strong>用户的身份重新登录。</p><h1 id="2896" class="ll lm it bd ln lo nh lq lr ls ni lu lv lw nj ly lz ma nk mc md me nl mg mh mi bi translated">步骤3:在Jenkins中创建一个GitLab用户</h1><p id="166c" class="pw-post-body-paragraph kb kc it kd b ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku mn kw kx ky im bi translated">现在，我们需要在Jenkins中创建一个GitLab用户，以便GitLab可以通过webhooks通知Jenkins资源库的更新。</p><p id="c30d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从Jenkins主页进入<strong class="kd iu">管理Jenkins →管理用户→创建用户</strong>并填写表格。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div class="gh gi np"><img src="../Images/c0d3b321293448e3799bf82ad58dfffb.png" data-original-src="https://miro.medium.com/v2/resize:fit:752/format:webp/1*h6iPjC-4b7Kbk30csafyeA.png"/></div></figure><p id="6f67" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建用户后，注销并作为“gitlab”用户重新登录。</p><p id="0bed" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">进入<strong class="kd iu">管理Jenkins →管理用户</strong>，点击gitlab用户旁边的齿轮图标进行配置。在<strong class="kd iu"> API令牌</strong>下，点击<strong class="kd iu">添加新令牌</strong>并为其命名，然后点击<strong class="kd iu">生成</strong>。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nq"><img src="../Images/eae95fdb6e8765e5ff4f761e558fbdae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aq0KlMJPnYDkPMCz_Ul-1w.png"/></div></div></figure><p id="8494" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">生成令牌后，<strong class="kd iu">将令牌复制并粘贴到某个临时位置</strong> —您将无法再从这里访问它。我们稍后将使用这个令牌。</p><p id="afdc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注销并作为<strong class="kd iu">管理员</strong>用户重新登录。</p><h1 id="4cd3" class="ll lm it bd ln lo nh lq lr ls ni lu lv lw nj ly lz ma nk mc md me nl mg mh mi bi translated">步骤4:为Jenkins安装和配置GitLab插件</h1><p id="9cee" class="pw-post-body-paragraph kb kc it kd b ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku mn kw kx ky im bi translated">我们需要为Jenkins安装GitLab插件，这样他们就可以互相交流了。</p><p id="e4c3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在Jenkins主页上，点击<strong class="kd iu">管理Jenkins →管理插件</strong>。点击<strong class="kd iu">可用的</strong>标签，搜索“gitlab”并安装GitLab插件。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nr"><img src="../Images/e4f1eeba6e0a02e5ceb49d4f6d3f5251.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DmXrE5yjMZZRnoMuEsdwNQ.png"/></div></div></figure><p id="a6d0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">选中“安装完成后重启Jenkins…”复选框，如果您错过了，您也可以在下载完成后用<code class="fe la lb lc ld b">sudo systemctl restart jenkins</code>重启Jenkins。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/925e2ad8de7962f1f15423783ddab80a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*q3H7M4GTq7Cz8uA4wvohfg.jpeg"/></div></figure><p id="1c6c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">大约一分钟后，刷新页面并再次以管理员用户身份登录。</p><p id="2c15" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在Jenkins中，转到<strong class="kd iu">管理Jenkins </strong> → <strong class="kd iu">配置系统</strong>并向下滚动到<strong class="kd iu"> Gitlab </strong>部分。输入连接的名称、GitLab实例的URL，然后在<strong class="kd iu">凭证</strong>旁边，点击<strong class="kd iu">添加→ Jenkins </strong>。这是您将在步骤2中添加GitLab令牌的地方。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nt"><img src="../Images/b65cfafc697c72319dd4c488e60fd900.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5wBEBvOFM8umC9uuhgP-Cw.png"/></div></div></figure><p id="4532" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<strong class="kd iu">种类</strong>旁边，选择<strong class="kd iu"> GitLab API令牌</strong>。粘贴您的GitLab API令牌并给它一个ID和描述，然后单击<strong class="kd iu"> Add </strong>将令牌添加到Jenkins:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nu"><img src="../Images/8803bfe6b6ec4149aaecb51df267bc49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3G72OilRB69NSCQwPEb6jw.png"/></div></div></figure><p id="74e5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">点击<strong class="kd iu">凭证</strong>旁边的下拉菜单，选择令牌。然后点击<strong class="kd iu">测试连接</strong>——之后你应该会看到“成功”:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nv"><img src="../Images/ccaa1eac268d5dca62276bc0a49044cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fTE2XG_QkAMoIxGwL-9J0Q.png"/></div></div></figure><p id="2d4b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">点击屏幕底部的<strong class="kd iu">保存</strong>保存您的更改。您可以在<strong class="kd iu">管理詹金斯</strong> → <strong class="kd iu">凭证</strong>查看您新创建的凭证。</p><p id="b708" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在Jenkins已经准备好与GitLab API进行通信了。</p><h1 id="20f8" class="ll lm it bd ln lo nh lq lr ls ni lu lv lw nj ly lz ma nk mc md me nl mg mh mi bi translated">步骤5:创建一个Jenkins管道</h1><p id="b0fe" class="pw-post-body-paragraph kb kc it kd b ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku mn kw kx ky im bi translated">在Jenkins主页上，点击左侧菜单栏中的<strong class="kd iu">新项目</strong>。输入项目名称并选择<strong class="kd iu">管道</strong>。点击<strong class="kd iu">确定</strong>创建:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nw"><img src="../Images/976537787ea46c51bfc4f2f0fb12edc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SGIwwmgJF7ZadvlRXGO1mA.png"/></div></div></figure><p id="2d64" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，您将看到管道配置页面。选中<strong class="kd iu">放弃旧构建</strong>的复选框，并设置<strong class="kd iu">最大构建数以保持</strong>为一个合理的数字(在本教程中我选择了3):</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nx"><img src="../Images/763e8457d7dacf44f1ad26b257929e05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c7fZWOIzruYaFXUT9ZHWzg.png"/></div></div></figure><p id="521b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">确保在<strong class="kd iu"> GitLab连接</strong>旁边选择您在步骤4中创建的连接:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/6d4a8d0cd1deb86f8454f4ff2b568420.png" data-original-src="https://miro.medium.com/v2/resize:fit:676/format:webp/1*DOCwZJYBHhA9XvGlfcQEEA.png"/></div></figure><p id="8bbe" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<strong class="kd iu"> Build Triggers </strong>部分下，当一个变更被推送到GitLab 时，选中<strong class="kd iu"> Build的复选框，并复制它旁边的GitLab webhook URL以备后用。保持<strong class="kd iu">启用GitLab触发器</strong>部分不变:</strong></p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nz"><img src="../Images/83664d6f3042c77e2d42974b037e73de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xHMNSRGy0l8MV6B2P2nckQ.png"/></div></div></figure><p id="7f52" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<strong class="kd iu">管道</strong>部分，从<strong class="kd iu">定义</strong>下拉列表中选择<strong class="kd iu">来自SCM </strong>的管道脚本(这将是后面描述的Jenkinsfile ),并从<strong class="kd iu"> SCM </strong>下拉列表中选择<strong class="kd iu"> Git </strong>。输入存储库URL(与您在<code class="fe la lb lc ld b">git clone</code>中使用的相同)。您应该会看到一个验证错误，因为我们还没有提供可以访问您的GitLab存储库的用户名/密码:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi oa"><img src="../Images/4d8e6841226dde099af75b4023f21201.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4WshKFBNdq80y_LiyDR3Sw.png"/></div></div></figure><p id="2113" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<strong class="kd iu">凭证</strong>旁边，点击<strong class="kd iu">添加→ Jenkins </strong>，填写您的GitLab用户名/密码，点击<strong class="kd iu">添加</strong>:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ob"><img src="../Images/59fdcefbef6c61dfcd915f09f235bb34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P7PEcXWUKYuDBydgsaiESg.png"/></div></div></figure><p id="fe64" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从<strong class="kd iu">凭证</strong>下拉列表中选择您的凭证，认证错误应该会消失。如果没有，请确保您有正确的用户名/密码，并且该用户有访问存储库的权限。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi oc"><img src="../Images/c5cc091632e5f0b3f472795d477f9d43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p8d96s1Qo2PQpeI0QKXOPA.png"/></div></div></figure><p id="103e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">点击屏幕底部的<strong class="kd iu">保存</strong>。</p><h1 id="ba7c" class="ll lm it bd ln lo nh lq lr ls ni lu lv lw nj ly lz ma nk mc md me nl mg mh mi bi translated">步骤6:在GitLab中配置一个Webhook</h1><p id="1cb9" class="pw-post-body-paragraph kb kc it kd b ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku mn kw kx ky im bi translated">我们需要一种方法让GitLab告诉Jenkins什么时候代码已经被推送到一个存储库——这就是webhooks的用途。</p><p id="7d90" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="od">注意:如果您的Jenkins实例运行在localhost上，请按照以下步骤允许GitLab在本地发送请求:</em></p><ol class=""><li id="d0e7" class="oe of it kd b ke kf ki kj km og kq oh ku oi ky oj ok ol om bi translated"><em class="od">进入</em> <strong class="kd iu"> <em class="od">管理区</em> </strong></li><li id="66c5" class="oe of it kd b ke on ki oo km op kq oq ku or ky oj ok ol om bi translated"><em class="od">将鼠标悬停在</em> <strong class="kd iu"> <em class="od">设置</em> </strong> <em class="od">上，点击</em> <strong class="kd iu"> <em class="od">网络</em> </strong></li><li id="78af" class="oe of it kd b ke on ki oo km op kq oq ku or ky oj ok ol om bi translated"><em class="od">展开</em> <strong class="kd iu"> <em class="od">出库请求</em> </strong></li><li id="2bb2" class="oe of it kd b ke on ki oo km op kq oq ku or ky oj ok ol om bi translated"><em class="od">勾选</em> <strong class="kd iu"> <em class="od">复选框，允许来自网络钩子和服务</em> </strong>的本地网络请求</li><li id="e126" class="oe of it kd b ke on ki oo km op kq oq ku or ky oj ok ol om bi translated"><em class="od">点击</em> <strong class="kd iu"> <em class="od">保存修改</em> </strong></li></ol><p id="dbd2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在GitLab中，转到你的项目，然后悬停在左侧菜单栏底部的<strong class="kd iu">设置</strong>，然后点击<strong class="kd iu"> Webhooks </strong>。</p><p id="6a3d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">输入Jenkins管道(从上一步复制的管道)的URL，并对其进行修改，使其遵循以下方案:</p><pre class="mp mq mr ms gt my ld mz na aw nb bi"><span id="ecc3" class="nc lm it ld b gy nd ne l nf ng">http://&lt;gitlab-user-in-jenkins&gt;:&lt;token&gt;@&lt;host&gt;/project/&lt;project-name&gt;</span></pre><p id="e4a4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将<strong class="kd iu">秘密令牌</strong>字段留空，并确保勾选<strong class="kd iu">推送事件</strong>。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi os"><img src="../Images/3e724870e8db6daa14e62c834b260c3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X7BK7kbAEh1Mncne14DOVw.png"/></div></div></figure><p id="266b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">点击<strong class="kd iu">添加webhook </strong>，然后向下滚动到底部查看您的webhook。点击<strong class="kd iu">测试→推送事件</strong>进行测试。您应该会看到200状态代码:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ot"><img src="../Images/bef43cdd686d567f91b6f58afa7c328f.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*HZGst0u12uP1YShYqkr8nw.png"/></div></div></figure><p id="d214" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你回到Jenkins，你应该看到一个失败的构建——这是一个好消息，因为这意味着webhook工作了，Jenkins能够监听到你的GitLab库的推送。</p><p id="00bb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您检查Jenkins构建控制台输出，您将看到类似于以下错误的内容:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/9eef81ee7f609e38268541f469a0e6af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*T2h9N3QMq5vaUraeIzeb4w.png"/></div></figure><p id="042c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下一步，我们将添加一个Jenkinsfile到我们的存储库中，告诉Jenkins如何构建我们的项目。</p><h1 id="3641" class="ll lm it bd ln lo nh lq lr ls ni lu lv lw nj ly lz ma nk mc md me nl mg mh mi bi translated">步骤7:添加一个Jenkinsfile</h1><p id="71a5" class="pw-post-body-paragraph kb kc it kd b ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku mn kw kx ky im bi translated">在git存储库中，在根级别创建一个名为“Jenkinsfile”的文件。</p><p id="80a0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将以下内容粘贴到Jenkinsfile中，并将其推送到存储库:</p><pre class="mp mq mr ms gt my ld mz na aw nb bi"><span id="9052" class="nc lm it ld b gy nd ne l nf ng">pipeline {<br/>    agent any<br/>    <br/>    stages {<br/>        stage('Build') {<br/>            steps {<br/>                sh 'mvn clean install -DskipTests'<br/>            }<br/>        }<br/>        stage('Test') {<br/>            steps {<br/>                sh 'mvn test'<br/>            }<br/>        }<br/>    }   <br/>}</span></pre><p id="0910" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个Jenkinsfile告诉Jenkins将构建分成几个阶段——首先是构建Maven项目的“构建”阶段，然后是通过Maven运行JUnit测试的“测试”阶段。</p><p id="6cc8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">假设您在Jenkins运行的同一台机器上安装并配置了Maven，那么当您在Jenkins中查看您的管道项目时，您应该会看到如下内容:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/b1b043054084579c87bf3af0818dd9ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*Omr8diPglypKPE07GUjkwQ.png"/></div></figure><p id="9962" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您在构建或测试阶段看到红色矩形而不是绿色矩形，这意味着您的代码构建失败或者您的某个单元测试失败。您可以通过点击<strong class="kd iu">构建历史</strong>部分中的构建，然后点击<strong class="kd iu">控制台输出</strong>来检查整个过程。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/005f1de512c46d28b3f65e2e1e902e28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*lqHfBc-DN4_Jl0b7Gw-reA.png"/></div></figure><h1 id="fe5a" class="ll lm it bd ln lo nh lq lr ls ni lu lv lw nj ly lz ma nk mc md me nl mg mh mi bi translated">步骤8:电子邮件通知</h1><p id="c32a" class="pw-post-body-paragraph kb kc it kd b ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku mn kw kx ky im bi translated">通常的做法是让管道向推送代码的用户发送电子邮件，让他们知道他们的构建是通过了还是失败了。</p><p id="7cf3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您尚未安装“电子邮件扩展插件”,请先安装该插件，然后再继续。</p><p id="9dd5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="od">注意:确保您推送的GitLab帐户具有有效的电子邮件地址——这是您的管道将向其发送电子邮件的地址。</em></p><p id="4e40" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">通过转到<strong class="kd iu">管理Jenkins </strong> → <strong class="kd iu">配置系统</strong>并向下滚动到<strong class="kd iu">扩展电子邮件通知</strong>来配置插件。</p><p id="8fab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">填写您的SMTP服务器，点击<strong class="kd iu">高级… </strong>并勾选<strong class="kd iu">使用SMTP认证</strong>复选框。填写您的用户名(电子邮件地址)和密码，然后勾选<strong class="kd iu">使用SSL </strong>复选框。输入465作为SMTP端口:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ox"><img src="../Images/7d3511bcafeb740228331c0b57ff2c98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Y1uLCVr-dX6TyzHlJTuXw.png"/></div></div></figure><p id="e893" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">向上滚动到顶部，在<strong class="kd iu"> Jenkins Location </strong>下，将<strong class="kd iu">系统管理员电子邮件地址</strong>更改为“Jenkins&lt;Jenkins @ Jenkins&gt;”—这将作为发件人姓名出现在您将收到的电子邮件中。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/9c017dbedec9c4fbe8684aebb65b972f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*d6_i2skZkr7y-CWZYE7PHw.png"/></div></figure><p id="389d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">点击底部的<strong class="kd iu">保存</strong>。</p><p id="8129" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在您的Jenkinsfile中，在“stages”部分之后添加下面的“post”部分，并将其推送到您的存储库。</p><pre class="mp mq mr ms gt my ld mz na aw nb bi"><span id="7466" class="nc lm it ld b gy nd ne l nf ng">pipeline {<br/>    agent any<br/>    <br/>    stages {<br/>        stage('Build') {<br/>            steps {<br/>                sh 'mvn clean install -DskipTests'<br/>            }<br/>        }<br/>        stage('Test') {<br/>            steps {<br/>                sh 'mvn test'<br/>            }<br/>        }<br/>    }<br/>    <br/>    post {<br/>        always {<br/>            emailext subject: "Jenkins Build ${currentBuild.currentResult}: Job \"${env.JOB_NAME}\"",<br/>                body: "${currentBuild.currentResult}: Job \"${env.JOB_NAME}\" build ${env.BUILD_NUMBER}.\nMore info at: ${env.BUILD_URL}",<br/>                recipientProviders: [[$class: 'DevelopersRecipientProvider'], [$class: 'RequesterRecipientProvider']]<br/>        }<br/>    }<br/>}</span></pre><p id="67cd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里，我们告诉Jenkins在构建完成后总是给用户发送一封电子邮件，并给它一个如何显示信息的模板。</p><p id="33fe" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">回到你的詹金斯管道去看它运行。如果一切顺利，您应该会看到类似下面的内容，还应该会收到一封电子邮件。</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi oz"><img src="../Images/c9982bb083e3457903313e8f551642d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V3nwYMmky_tN7yg-42x5yQ.png"/></div></div></figure><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi pa"><img src="../Images/e99c6f262152fd536a14c376a230e1ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cbi7Auiu-Ni4L15NHuIRBA.png"/></div></div></figure></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="4142" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">恭喜你！您已经成功地建立了一个Jenkins管道来从GitLab自动构建Java项目。</p></div></div>    
</body>
</html>