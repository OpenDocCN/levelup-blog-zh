<html>
<head>
<title>Serverless GraphQL with Hasura on AWS ECS over Aurora PostgreSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS ECS over Aurora PostgreSQL上带Hasura的无服务器GraphQL</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/serverless-graphql-with-hasura-on-aws-ecs-over-aurora-postgresql-6c4e1eb09282?source=collection_archive---------6-----------------------#2019-11-11">https://levelup.gitconnected.com/serverless-graphql-with-hasura-on-aws-ecs-over-aurora-postgresql-6c4e1eb09282?source=collection_archive---------6-----------------------#2019-11-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/86def6379ec05947863b992e719c29e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*XfRPYCuguZdtjPS6oOH4gg.png"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">ECS + Hasura =惊人的后端</figcaption></figure><p id="08fe" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将构建一个水平可伸缩的GraphQL API，它运行在由AWS的无服务器Aurora产品支持的PostgreSQL数据库上。我们将为GraphQL API、AWS ECR和ECS使用Hasura来运行docker映像，并使用AWS Cloudformation来部署资源。</p><p id="335a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先，在<a class="ae kz" href="https://hasura.io/" rel="noopener ugc nofollow" target="_blank">哈苏拉</a>向团队大声喊出来。他们的产品让任何专业人士感觉他们是GraphQL热潮的一部分，并为任何项目提供了难以置信的价值。</p><p id="c9f0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了完成本文的标题，我们需要假设一些AWS资源已经到位。</p><ol class=""><li id="f32b" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">你应该拥有一个域名，并在53号公路上有一个托管区。</li><li id="0014" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">您应该在AWS Certificate manager上拥有一个SSL证书，该证书覆盖了您想要提供API的域或子域。证书必须位于您将部署ECS的同一区域。</li></ol><p id="097b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们还需要假设您已经在本地机器上配置了一些东西。</p><ol class=""><li id="d30d" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">Docker已安装</li><li id="81a5" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">您已经正确设置了AWS CLI</li><li id="d186" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">您有IAM权限使用所有必需的资源</li></ol><p id="f09f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将分三步完成我们的目标。首先，将Hasura映像推送到一个弹性容器注册中心(ECR)。其次，收集Cloudformation模板参数，并演示它的功能。第三，使用AWS CLI部署Cloudformation模板。</p><p id="bb1a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">本文的所有参考资料都可以在这个<a class="ae kz" href="https://github.com/joninsky/ECS-and-Hasura" rel="noopener ugc nofollow" target="_blank"> git hub repo </a>上找到。</p><h2 id="a1e6" class="lo lp it bd lq lr ls dn lt lu lv dp lw km lx ly lz kq ma mb mc ku md me mf mg bi translated">弹性容器注册设置</h2><p id="e588" class="pw-post-body-paragraph kb kc it kd b ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku ml kw kx ky im bi translated">要在AWS弹性容器服务上运行Hasura，您需要在ECR上存储Hasura映像。</p><p id="cbc2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这些是步骤:</p><ol class=""><li id="52ba" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">注册表认证</li><li id="b48c" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">图像拉动</li><li id="551b" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">ECR容器创建</li><li id="196c" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">图像推送</li></ol><p id="030b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用AWS CLI获取<a class="ae kz" href="https://docs.aws.amazon.com/en_pv/AmazonECR/latest/userguide/registries.html#registry_auth" rel="noopener ugc nofollow" target="_blank">认证命令</a>，如下所示:<code class="fe mm mn mo mp b">aws ecr get-login --region &lt;region&gt; --no-include-email</code> <strong class="kd iu">。</strong>将CLI输出复制到您的剪贴板，然后运行它。在接下来的12个小时里你已经通过了认证。</p><p id="9785" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来要做的事情是将Hasura映像拉到您的本地机器上。你跑<code class="fe mm mn mo mp b">docker pull hasura/graphql-engine</code></p><p id="d902" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，要创建存储库，请转到AWS ECR控制台，创建一个名为<code class="fe mm mn mo mp b">hasura-development</code>的存储库</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mq"><img src="../Images/4d5264dd1f6fda4f9d7ba7187c9fff63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VljoYtQW7_TK2up3rtyg0Q.png"/></div></div></figure><p id="faf5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建存储库后，复制ECR的URI值(这看起来像一个ARN)。</p><p id="b028" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">回到您的CLI。运行<code class="fe mm mn mo mp b">docker images</code>并注意您提取的Hasura图像的<code class="fe mm mn mo mp b">IMAGE ID</code>。你用回购协议的URI标记哈苏拉<code class="fe mm mn mo mp b">IMAGE ID</code>，就像这样:<code class="fe mm mn mo mp b">docker tag &lt;hasura-image-ID&gt; &lt;ECR-URI&gt;</code>，然后用<code class="fe mm mn mo mp b">docker push &lt;ECR-URI&gt;</code>推动新标记的回购协议。</p><p id="d64a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你现在在ECR上有了哈苏拉的图像。请注意，当Hasura发布新版本时，这些也是更新图像的步骤，他们会定期进行更新。</p><h2 id="608c" class="lo lp it bd lq lr ls dn lt lu lv dp lw km lx ly lz kq ma mb mc ku md me mf mg bi translated">收集云形成的参数</h2><p id="9a67" class="pw-post-body-paragraph kb kc it kd b ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku ml kw kx ky im bi translated">如上所述，应该有两个AWS资源。在Route 53上具有托管区域的域名，以及AWS证书管理器中的SSL证书，用于您要提供GraphQL API的域或子域。</p><p id="3b88" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">看一下提供的回购中的<code class="fe mm mn mo mp b">parameters.json</code>文件</p><p id="6aa2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们一个一个地检查参数。</p><p id="5667" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mm mn mo mp b">DNSRecordSetName</code></p><p id="bc49" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这应该是您希望为GraphQL API提供服务并访问Hasura控制台的域。你可以有一个顶级域名，比如<code class="fe mm mn mo mp b">mydomain.io</code>，或者你可以传入一个子域，比如<code class="fe mm mn mo mp b">api.mydomain.io</code>。只要确保<code class="fe mm mn mo mp b">SSLCertARN</code>参数的ARN设置覆盖您选择的域。</p><p id="6c9c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mm mn mo mp b">HostedZoneID</code></p><p id="d352" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在AWS Route 53控制台上，单击“托管区域”后，您可以清楚地看到您想要的托管区域的ID。</p><p id="69f6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mm mn mo mp b">SSLCertARN</code></p><p id="b8d4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您应该能够在AWS证书管理器控制台中找到您想要的SSL证书的ARN</p><p id="92aa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mm mn mo mp b">ECRImage</code></p><p id="acc9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">本文中我们做的第一件事是将Hasura图像放在ECR上。这将是ECR图像的URI。</p><p id="a675" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mm mn mo mp b">DBMasterUsername</code></p><p id="97e5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您的无服务器PostgreSQL DB仍然需要一个老式的管理员用户名和密码组合。这是用户名部分。</p><p id="2f23" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mm mn mo mp b">DBMasterUserPassword</code></p><p id="3d56" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">补充您的用户名的密码</p><p id="ffb2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mm mn mo mp b">DBName</code></p><p id="129f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">任何新的PostgreSQL实例都需要一个实际数据库的名称。在这里提供。</p><p id="6a19" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mm mn mo mp b">HasuraAccesskey</code></p><p id="8c9b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">哈苏拉在<code class="fe mm mn mo mp b">&lt;your-domain&gt;/console</code>上方担任控制台。对于一些轻量级的安全性，控制台隐藏在一个需要这个密码的对话框后面。这也是签署管理请求的<code class="fe mm mn mo mp b">X-Hasura-Admin-Secret</code>密钥的密钥。</p><p id="0458" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦你收集了所有这些变量，我们将需要把它们放到<code class="fe mm mn mo mp b">parameters.json</code>文件中。<a class="ae kz" href="https://github.com/joninsky/ECS-and-Hasura" rel="noopener ugc nofollow" target="_blank">这里又是回购的链接。</a></p><h2 id="958f" class="lo lp it bd lq lr ls dn lt lu lv dp lw km lx ly lz kq ma mb mc ku md me mf mg bi translated">使用云信息</h2><p id="5536" class="pw-post-body-paragraph kb kc it kd b ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku ml kw kx ky im bi translated">您需要为这个堆栈命名一个对您有意义的名称。出于演示的目的，我将调用这个堆栈<code class="fe mm mn mo mp b">MyProduct-GraphQL-Stack</code>。</p><p id="c570" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将目录(<code class="fe mm mn mo mp b">cd</code>)更改为填写好的<code class="fe mm mn mo mp b">parameter.json</code>文件和<code class="fe mm mn mo mp b">Stack.yaml</code>文件所在的目录。从AWS CLI中，您将需要一个相当详细的语句。</p><p id="ef11" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mm mn mo mp b">aws cloudformation create-stack --stack-name MyProduct-GraphQL-Stack --template-body file://./Stack.yaml --parameters file://./parameters.json --capabilities CAPABILITY_NAMED_IAM</code></p><p id="fabe" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该堆栈大约需要5-10分钟完成部署。</p><h2 id="4b07" class="lo lp it bd lq lr ls dn lt lu lv dp lw km lx ly lz kq ma mb mc ku md me mf mg bi translated"><strong class="ak">结论</strong></h2><p id="d189" class="pw-post-body-paragraph kb kc it kd b ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku ml kw kx ky im bi translated">如果您的堆栈由于任何原因未能创建，请查看AWS Cloudformation控制台中的堆栈事件。寻找失败的原因，并尝试从那里除错。如果你成功了，恭喜你！您已经创建了一个非常强大和可伸缩的GraphQL API！如果你发现错误，请尽情享受并随时评论或纠正。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><div class="mr ms mt mu gt ng"><a href="https://skilled.dev" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd iu gy z fp nl fr fs nm fu fw is bi translated">编写面试问题</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">一个完整的平台，在这里我会教你找到下一份工作所需的一切，以及…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">技术开发</p></div></div><div class="np l"><div class="nq l nr ns nt np nu jv ng"/></div></div></a></div></div></div>    
</body>
</html>