# 在生产中运行 Swarm 集群的六个技巧

> 原文：<https://levelup.gitconnected.com/six-tips-for-running-swarm-cluster-in-production-e0f2ef367694>

## 码头集群

## 在生产环境中以高可用性模式运行群集群的技巧

![](img/7f9c1ecee3d724bce77e67538a08783a.png)

亚历克斯·伊比在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

用 Docker Swarm 开始运行 Docker 容器是一项简单的任务，特别是如果你有使用 docker-compose 文件的知识和经验。创建 Docker Swarm 集群可以通过执行一个命令行来轻松完成。此外，使用一个命令行就可以用更多的服务器来扩展集群。

另一方面，在生产环境的集群上运行 Docker 服务可能是一项具有挑战性的任务，因为生产环境应该是稳定的，并保持一定的质量水平。例如，生产服务器上的服务应该以高可用性模式托管。

在这篇文章中，我将强调在 Docker Swarm 集群中运行生产服务需要解决的一些问题。

## **虫群集群设置**

从基础架构和集群设置的角度出发，生产环境应该以高可用性模式托管。这意味着为这些环境建立的群集群必须确保集群和服务的可用性，即使在可能发生故障的情况下也是如此。

举例来说，可以创建一个只有一个节点的群集群。但是，这种设置的可用性不高。如果由于任何原因出现节点故障，整个集群和其中运行的服务都将停止运行。

很明显，为了能够减轻这种风险，群集群的生产应该由多个节点(管理人员和工人)组成。然而，工作者和主节点的确切数量以及集群的架构并不固定，它们取决于项目的需求。下面是一些在构建 Swarm 集群时可以考虑的技巧。

→主节点的数量必须是奇数。否则，领导者选举将不会像预期的那样进行，因此群集将会以一种意想不到的方式运行。根据托管服务的数量和项目预算，您可以选择主节点的数量。

→主节点应放置在不同的数据中心(理想情况下是三个不同的数据中心，配备三名管理人员)。这将有助于即使在一个管理器节点关闭、一个数据中心关闭(即停电)或网络分区，其中一个数据中心无法与其他数据中心通信。

→主节点应在排出模式下运行(不托管任何 Docker 容器)。

→工人数量没有限制(需要多少就有多少)。然而，工作节点需要分布在多个数据中心。

→在负载平衡器后面将多个独立的群集群连接在一起，不仅可以实现高可用性，还可以支持 canary 部署。例如，如果生产环境由两个独立的集群组成，我们可以关闭其中一个集群并升级 Docker，然后群集部署新的服务，而服务仍然可供最终客户使用。一旦我们完成了第一个集群，我们就启动它，并对第二个集群重复该任务。这种方法的唯一缺点是我们需要将相同的服务部署到多个集群中(也可以是自动化的)。

## **服务可用性**

Docker Swarm 服务的部署服务或滚动更新需要在零停机时间内完成。否则，最终用户的体验将会受到影响，群服务(尤其是那些公开 web 或 API 接口的服务)将会关闭，并且对客户端不可用。

幸运的是，为群服务实现高可用性和零停机部署是一项简单的任务，只需更新相应服务的堆栈文件即可完成。

下面是一篇博文，详细描述了如何实现 Docker Swarm 服务的零停机部署。

[](https://medium.com/faun/zero-downtime-deployment-with-docker-swarm-d84d8d9d9a14) [## Docker Swarm 实现零停机部署

### 部署 Docker 服务，无需维护通知，也不会影响最终用户

medium.com](https://medium.com/faun/zero-downtime-deployment-with-docker-swarm-d84d8d9d9a14) 

## **处理服务日志**

默认情况下，Docker 使用`json-file`日志驱动程序。这个驱动程序将把容器日志存储在主节点`/lib/docker/containers/${id}/${id}-json.log`上的以下路径下的文件系统中。只要容器在运行，这个文件就会被使用，并且它的大小会不断增长。如果日志文件耗尽了主机节点上的所有可用空间，这种行为会使 Docker 群节点面临停机。作为这种情况的解决方案，可以实施以下选项之一。

→使用另一个日志驱动程序:Docker 支持几个[日志驱动程序](https://docs.docker.com/config/containers/logging/configure/)，如 Syslog、Fluentd 或 Gelf。这些日志驱动程序支持将容器日志传送到集中的日志服务器。因此，Docker 群节点空间不会被用来存储容器日志。

→旋转日志文件:Docker 支持旋转容器日志文件，以控制日志文件的大小并保持群节点健康。通过在服务定义中添加下面几行，可以简单地实现群服务的日志轮换。

```
logging:
      driver: json-file
      options:
        "max-size": "10m"
        "max-file": "5"
```

上面的配置将 Docker 配置为一旦日志文件的大小超过 10MB，就对其进行循环，并保留最后 5 个循环的文件。这种方法的缺点是旧的日志会自动从服务器上删除，并且会丢失。因此，需要复制旋转的文件，并在需要时实现它们。

## **资源使用情况**

资源管理和限制是每个 Docker 集群都需要处理的一个非常重要的主题。在群集集群中运行服务而不限制这些服务的附加资源(RAM 和 CPU)可能会使整个群集集群和其中运行的服务面临停机。例如，如果一个服务出现内存泄漏，并一直消耗主机上的可用内存，则同一主机上运行的其他服务可能会因为主机上没有足够的内存而无法执行其任务。此外，管理器不会在主机上安排服务，因为没有内存可用于新服务。关于管理群服务资源限制的更多细节可以在下面的博客文章中找到。

[](https://medium.com/faun/limit-resources-for-swarm-services-249dcebed833) [## 限制群服务的资源

### 开始控制 Docker 服务和容器的资源消耗

medium.com](https://medium.com/faun/limit-resources-for-swarm-services-249dcebed833) 

## **网络极限:几家 vs 大网**

将所有 Docker 群服务托管在一个 Docker 网络中更容易且需要更少的努力，因为默认情况下所有服务将能够彼此通信，并且不需要管理它们之间的通信。服务。然而，在单一网络中运行 Docker Swarm 服务之前，需要考虑以下事项

→每个服务都可以访问其他服务，这可能会带来不必要的通信或未授权操作的风险。例如，如果一个连接者获得了对一个服务访问，他可能能够访问其他服务。

→默认覆盖网络的规模由`/24`子网决定，这意味着这些网络只能有 265 个 IP。Swarm 中的服务可以使用不止一个 IP。服务需要一个 IP，每个副本或任务都需要一个 IP。底线是在单个网络中运行的服务和容器的数量是有限制的。如果单个网络中运行的服务和容器的总数超过此限制，新的 Docker 容器将无法启动，并将处于挂起状态。为了解决这个问题并能够在一个网络中运行更多的服务，我们需要使用具有更大子网的网络。以下命令可用于创建一个更大的 Docker 覆盖网络。

```
docker network create --driver overlay --subnet=192.168.0.0/16 bignt
```

关于这个问题的更多信息可以在这个[链接](https://success.docker.com/article/how-to-identify-ip-exhaustion)中找到。

## **集群清理:Docker 系统修剪**

创建 Docker 容器的第一步是在运行容器的主机上本地下载 Docker 映像。这些 Docker 映像消耗了 Docker 主机的一些空闲空间。部署这些服务的多个版本将下载新的 Docker 映像，并将消耗 Docker 节点上的更多空间，同时不再需要旧的 Docker 映像，因为新的容器正在使用新的 Docker 映像。这种行为的结果是，存在 Docker Swarm 由于空间问题而无法安排新容器或服务的风险。为了防止这种情况，建议在 Docker 节点上执行清理，以删除旧的 Docker 映像。幸运的是，这个任务可以通过执行下面的命令轻松完成。

```
docker image prune -a --filter "until=24h"
```

以上命令将删除超过 24 小时前创建的所有 docker 映像。更多关于修剪命令的信息可以在[这里](https://docs.docker.com/config/pruning/)找到。

## **结论**

在开发环境中使用 Docker Swarm 托管服务是一项简单的任务，可以在几分钟内完成。然而，在生产环境中使用 Docker Swarm 更加复杂，需要关注许多领域和主题，以保持集群的健康和高可用性。