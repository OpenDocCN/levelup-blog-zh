<html>
<head>
<title>REST API end-to-end test automation in Nestjs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Nestjs中REST API端到端测试自动化</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/rest-api-end-to-end-test-automation-in-nestjs-9064be1b89b1?source=collection_archive---------8-----------------------#2022-09-18">https://levelup.gitconnected.com/rest-api-end-to-end-test-automation-in-nestjs-9064be1b89b1?source=collection_archive---------8-----------------------#2022-09-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/87a0cc0e0b55ab3da535fd971ef67629.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xy7BjyOh_-9GZTCt9vmFOA.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">图片<a class="ae jg" href="https://pixabay.com/pl/users/mohamed_hassan-5229782/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=7281686" rel="noopener ugc nofollow" target="_blank">来自<a class="ae jg" href="https://pixabay.com/pl//?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=7281686" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的穆罕默德·哈桑</a></figcaption></figure><div class=""/><p id="8f19" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你好！如果你读过我以前的文章，你可能会发现我喜欢e2e测试中的自动化。自动化保护我和我的团队免受挫折。另外，当编写测试非常简单时，每个人都可以编写它们！</p><h1 id="6ad8" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">问题</h1><p id="beee" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">编写端到端测试需要大量的检查。使用什么URL，服务器期望什么，服务器返回什么？当你改变一些东西而不使用应用程序源代码中的接口时，你就有了一个bug，直到你启动它们时你才知道。随着时间的推移，这变得混乱、耗时，并阻碍团队编写测试。</p><h1 id="725f" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">想法</h1><p id="16aa" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在上一篇文章中，我写了当我们使用GraphQL时的自动化测试。但是GraphQL并不是在我们的应用程序中创建API的唯一方法！</p><p id="2d17" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这次我们将看看REST APIs。在这种情况下，我们没有像GraphQL中那样的静态契约。因此，我们需要小心并生成文档，以便能够解释它并生成SDK。为了我们的目的，我们将使用swagger。多亏了Nestjs，它很容易使用。我们需要做的就是增加一些装饰者。此外，这个文档可以帮助我们的团队在使用我们API的程序员之间共享知识。</p><h1 id="daac" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">解决办法</h1><p id="d1f5" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">由于我们想要使用swagger，首先要做的是安装所需的依赖项:</p><p id="53ab" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mh mi mj mk b">yarn add @nestjs/swagger swagger-ui-express</code></p><p id="50af" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一步是在bootstrap方法中注册我们的API。所以我们需要转到main.ts文件并添加一些代码。这一步允许我们从swagger的角度检查我们的API看起来如何。如果你愿意，你可以跳过这一步。稍后，我将向您展示如何将开放API规范生成到文件中。</p><figure class="ml mm mn mo gt iv"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">主页面</figcaption></figure><p id="bf9a" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要生成SDK，我们需要在文件中有一个规范。所以现在是时候生成一次了！只需在src文件夹中创建<code class="fe mh mi mj mk b">generate-open-api.ts</code>文件并粘贴代码:</p><figure class="ml mm mn mo gt iv"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated"><code class="fe mh mi mj mk b">generate-open-api.ts</code></figcaption></figure><p id="819d" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了简化新生成器的使用，我们将向package.json添加一个脚本。</p><pre class="ml mm mn mo gt mr mk ms mt aw mu bi"><span id="bff6" class="mv lf jj mk b gy mw mx l my mz">{</span><span id="25d9" class="mv lf jj mk b gy na mx l my mz">  "scripts": {</span><span id="32fc" class="mv lf jj mk b gy na mx l my mz">    "build:open-api-spec": "nest start —-entryFile generate-open-api",</span><span id="7d79" class="mv lf jj mk b gy na mx l my mz">  }</span><span id="a8a6" class="mv lf jj mk b gy na mx l my mz">}</span></pre><p id="9b2c" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在是施展魔法的时候了。我们可以在<code class="fe mh mi mj mk b">nest-cli.json</code>注册插件，节省一些添加装饰者的时间！</p><figure class="ml mm mn mo gt iv"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated"><code class="fe mh mi mj mk b">nest-cli.json</code></figcaption></figure><h1 id="da79" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">设置测试</h1><p id="0767" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为了从JSON文件生成SDK，我们将使用npmjs.com上可用的库。</p><p id="90c0" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mh mi mj mk b">yarn add -D oazapfts</code></p><p id="5844" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该库提供了一个CLI来生成所有所需类型的ts文件。我们将向package.json文件添加另一个命令。</p><pre class="ml mm mn mo gt mr mk ms mt aw mu bi"><span id="bca3" class="mv lf jj mk b gy mw mx l my mz">{<br/>  "scripts": {<br/>    "build:open-api-spec": "nest start --entryFile generate-open-api",<br/>    "test:build-test-sdk": "oazapfts open-api.json test/temp/sdk.ts",<br/>    "test:generate-sdk": "yarn build:open-api-spec &amp;&amp; yarn test:build-test-sdk"<br/>    ...<br/>  }<br/>}</span></pre><p id="44c4" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，当我们运行命令<code class="fe mh mi mj mk b">test:generate-sdk</code>时，我们将得到ts文件类型！此外，我们可以将该文件添加到<code class="fe mh mi mj mk b">.gitignore</code>中，每次更改后，我们将节省格式化该文件的时间。</p><p id="c544" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们前面步骤的结果是一个文件，其中的类型和函数都可以使用。现在，我们将在此基础上添加抽象，并为我们的用户创建会话。</p><p id="e690" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将创建工厂，命名为SessionFactory。这个类将负责创建api客户端。</p><figure class="ml mm mn mo gt iv"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">会话生成器. ts</figcaption></figure><p id="e0e4" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">简短的帮助方法来准备我们的应用程序进行测试，我们已经准备好测试我们的API了！</p><p id="4807" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的测试看起来像这样:</p><figure class="ml mm mn mo gt iv"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">示例测试</figcaption></figure><p id="e09f" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在generate-open-api.ts中，通过覆盖operationIdFactory选项，可以很容易地更改我们方法的名称。</p><h1 id="8ed6" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">摘要</h1><p id="9092" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在本文中，我向您展示了如何测试REST API。希望你喜欢这个教程！</p><p id="c390" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki jk">链接到资源库</strong>:<a class="ae jg" href="https://github.com/adziok/nestjs-graphql-testing/tree/rest-api" rel="noopener ugc nofollow" target="_blank">https://github . com/adziok/nestjs-graph QL-testing/tree/rest-API</a></p></div></div>    
</body>
</html>