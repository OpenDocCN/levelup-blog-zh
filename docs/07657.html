<html>
<head>
<title>How to Get Your Firewall Rules to Stick on ESXi v7</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何让您的防火墙规则适用于ESXi v7</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-get-your-firewall-rules-to-stick-on-esxi-v7-961efcb58d8d?source=collection_archive---------5-----------------------#2021-03-03">https://levelup.gitconnected.com/how-to-get-your-firewall-rules-to-stick-on-esxi-v7-961efcb58d8d?source=collection_archive---------5-----------------------#2021-03-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/af2271c155f523edc94ed9464fcf6aa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7L6q2HjbPIhXv9z0T4urKw.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来源:<a class="ae kf" href="https://davejansen.com/homelab-re-organization-project-conclusions/" rel="noopener ugc nofollow" target="_blank">戴夫·詹森</a></figcaption></figure><p id="3f26" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为什么我要写一个关于这个的帖子。我无法告诉你，拥有一个看起来无所不能的漂亮网络界面是多么令人沮丧。奋斗不再是朋友，以下是如何在没有vCenter的ESXi vSphere 7.0主机上创建永久防火墙规则。</p><h1 id="0fb8" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">启用SSH</h1><p id="8827" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">第一步是在您的服务器中启用SSH。在浏览器中导航到您的主机。然后从左上方的菜单中选择主机。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mh"><img src="../Images/418ea0283446428e95caf73a75209915.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W6TgnoalbZrGUa0Ab9uk0w.png"/></div></div></figure><p id="0b46" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，您将转到操作→服务→启用安全外壳(SSH)。关于这一点需要注意的是，除非您需要进行这样的更改，否则您应该禁用SSH。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mm"><img src="../Images/d93282e371c89a1bf20590e615f67f23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E51p1nbKTCDaeuYGCgU7SQ.png"/></div></div></figure><h1 id="e68d" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">SSH进入主机</h1><p id="d539" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">接下来，您需要通过SSH连接到您的ESXi主机。我不会讨论如何做到这一点，但对于windows，你通常会使用putty或WSL。对于其他人，打开一个终端并SSH进入。</p><pre class="mi mj mk ml gt mn mo mp mq aw mr bi"><span id="e580" class="ms lf it mo b gy mt mu l mv mw">ssh &lt;username&gt;@&lt;host ip&gt;</span></pre><h1 id="453d" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">设置防火墙规则</h1><p id="d8aa" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">这才是真正令人沮丧的事情。向/etc/vmware/firewall添加新的防火墙XML文件将为您创建规则，但是这些文件不会在重新启动时保留。这就是为什么我们必须创建一个shell脚本，在每次启动时创建这些文件。为此，使用以下命令打开local.sh shell文件:</p><pre class="mi mj mk ml gt mn mo mp mq aw mr bi"><span id="2b8d" class="ms lf it mo b gy mt mu l mv mw">vi /etc/rc.local.d/local.sh</span></pre><p id="0aa5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">小注意:这是世界上最不适合初学者的友好文本编辑器，所以如果你是新手，这里是你需要知道的。按“I”键进入插入模式。这允许您在文档中键入内容。你打完字后，需要按“退出”键。现在您不再处于插入模式，但是您仍然在文件中。要退出文件，您需要按':'然后按' wq '来写入您的更改并退出文件，或者按':q '来退出而不保存您的更改。</p><p id="4257" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在让我们讨论这个文件的内容。在这里，我配置了两组不同的防火墙规则(第14行的logging.xml和第43行的k8s.xml)。正如你所看到的，每一组都需要设置。标签<id>表示它将如何在网络界面中显示。每个规则都需要一个唯一的规则id。不过，这些只需要在ConfigRoot标记中是唯一的(参见第19行和第48行具有相同的规则id)。</id></p><p id="0c94" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，您需要指定esxi的入站/出站方向、协议(tcp/udp)、端口类型(目标或源(dst/src))以及端口开始/结束范围。最后，添加第72行，用新规则重启防火墙。</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="c54d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有点遗憾的是，我们不能仅仅从GUI中做到这一点，但是通过这些步骤，您可以在每次启动时可靠地正确设置您的网络规则。编辑完文件后，不要忘记“escape”then:wq。此外，仔细检查你的工作，因为在这里犯一个错误会锁定主机。如果发生这种情况，您将需要拔出一个显示器并连接，看看是什么问题。</p><h1 id="2e17" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">包扎</h1><p id="f062" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">完成这些步骤后，就该重启主机了。请记住，ESXi需要几分钟才能启动，请耐心等待。我对我的主机运行了一个ping命令，然后在它重启的时候离开了。我认为它花了大约5分钟重新启动。当我回来时，我能够重新登录到web界面并关闭ssh。就像这样，虽然我的防火墙规则启动并运行。</p><p id="c832" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">检查以确保与使用您打开的端口运行以下命令一样简单:</p><pre class="mi mj mk ml gt mn mo mp mq aw mr bi"><span id="e00e" class="ms lf it mo b gy mt mu l mv mw">nmap -p &lt;port&gt; &lt;ip&gt;</span></pre></div></div>    
</body>
</html>