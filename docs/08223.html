<html>
<head>
<title>Build a WhatsApp and Messenger GraphQL Bot To Find Hospital Beds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建一个WhatsApp和Messenger GraphQL机器人来查找医院床位</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/build-a-whatsapp-and-messenger-graphql-bot-to-find-hospital-beds-a30cbaaf8261?source=collection_archive---------5-----------------------#2021-04-12">https://levelup.gitconnected.com/build-a-whatsapp-and-messenger-graphql-bot-to-find-hospital-beds-a30cbaaf8261?source=collection_archive---------5-----------------------#2021-04-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/30e3f986144e75eae5785ee3c96c1354.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L4v8hy0UuqQ4cZpPZaQEtw.png"/></div></div></figure><p id="dd6b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">COVID影响了我们所有人，但有些人比其他人影响更大。人们曾经面临并将继续面临的一个主要问题是医院床位的短缺。几个月前，我创建了一个<a class="ae kw" href="https://bedav.org/playground" rel="noopener ugc nofollow" target="_blank"> GraphQL API，它返回印度多个城市和地区</a>的床位可用性。这些数据是从官方网站上刮下来的，并被规范化为统一的格式，然后以GraphQL API的形式公开。</p><p id="3c45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kx">请注意，该数据仅适用于印度的部分城市。</em></p><p id="503e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还可以在<a class="ae kw" href="https://bedav.org/playground" rel="noopener ugc nofollow" target="_blank"> GraphQL Playground </a>中探索API。</p><p id="1085" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用Bedav API和Vonage Messages API，我们将构建一个聊天机器人，使用JavaScript与WhatsApp和Facebook Messenger一起工作。这个聊天机器人的功能是帮助用户在一个城市中搜索医院，找到一家有空床位的医院，并提供关于该医院的其他信息，如电话号码和地址。我们还将创建一个命令，用户可以用它来获得去医院的方向。</p><h1 id="7651" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">先决条件</h1><ol class=""><li id="eb13" class="lw lx iq ka b kb ly kf lz kj ma kn mb kr mc kv md me mf mg bi translated"><a class="ae kw" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank">节点和npm </a></li><li id="b7ec" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated"><a class="ae kw" href="https://dashboard.nexmo.com/sign-up" rel="noopener ugc nofollow" target="_blank">一个Vonage账户</a></li></ol><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/941d1ebad7252085aa9c1e88f9dc18f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9RUNrmWVrhuK9uZKQ1igZA.png"/></div></div></figure><h1 id="5725" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">项目设置</h1><p id="cfac" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">尽管可以在<a class="ae kw" href="https://github.com/shreyas44/bedav-vonage" rel="noopener ugc nofollow" target="_blank">GitHub库</a>中找到这方面的代码，但还是建议您遵循本教程，并将该库仅用作参考。</p><h2 id="e4f2" class="mt kz iq bd la mu mv dn le mw mx dp li kj my mz lm kn na nb lq kr nc nd lu ne bi translated">初始化NPM并安装依赖项</h2><p id="999f" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">首先创建一个新文件夹，初始化npm并在其中创建一个<code class="fe nf ng nh ni b">src</code>文件夹:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="a5ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将使用Express创建我们的webhooks和服务器。<a class="ae kw" href="https://www.npmjs.com/package/axios" rel="noopener ugc nofollow" target="_blank"> Axios </a>将用于向消息API发送请求，而<code class="fe nf ng nh ni b">graphql-request</code>将用于向Bedav GraphQL API发送请求。您可以通过运行以下命令将它们与其他实用程序一起安装:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="ba4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，将Nodemon作为一个dev依赖项安装，这样我们就不必在每次进行更改时重启节点服务器:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="c623" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们也给我们的<code class="fe nf ng nh ni b">package.json</code>添加一个脚本来启动我们的Nodemon dev服务器:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h1 id="e2d7" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">创建网页挂钩</h1><p id="ce53" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">在我们进入任何代码之前，什么是webhooks？Webhooks本质上是一个URL，每次执行某个动作或事件时都会调用它。Webhooks可以被认为类似于回调，然而，它们最常用于分离和独立的应用程序之间的交互。在我们的例子中，我们需要公开两个webhooks:一个在用户发送消息时触发，另一个在来自API的消息有状态更新时触发(例如，当用户阅读您发送的消息时)。</p><p id="ab6c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们在<code class="fe nf ng nh ni b">src/app.js</code>中设置Express，这里有我们的主要Express应用程序和负责处理命令的主要函数:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="2342" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，让我们添加两个端点，一个用于消息webhook，另一个用于状态webhook:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h1 id="faee" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">安装和设置Ngrok</h1><p id="abb2" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">Ngrok 让你通过使用一个临时的URL将你的webhooks暴露在互联网上来测试它们。要开始使用ngrok，你可以去他们的网站<a class="ae kw" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank">创建一个账户</a>。完成并登录后，您应该会在他们的仪表板上看到安装和连接您的帐户的说明。</p><p id="5727" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们已经安装并配置了ngrok，让我们通过运行<code class="fe nf ng nh ni b">npm run dev</code>来启动我们的开发服务器。通过运行<code class="fe nf ng nh ni b">./ngrok http 3000</code>，使用ngrok为我们的本地服务器创建一个公共URL。这个命令告诉ngrok为运行在<code class="fe nf ng nh ni b">localhost:3000</code>上的服务器创建一个HTTP代理。</p><h1 id="9599" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">配置消息沙箱</h1><p id="e0f5" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">登录到Vonage仪表板，前往<em class="kx">消息下的<em class="kx">沙箱</em>部分，发送</em>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/661089d7f1e4d656c0a26d206065c16b.png" data-original-src="https://miro.medium.com/v2/resize:fit:546/format:webp/1*OrpLsbxqJ43MDlO_-PE-5Q.png"/></div></figure><p id="3c46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要创建WhatsApp沙盒，请在WhatsApp部分点击<em class="kx">添加到沙盒</em>。Vonage沙盒需要验证您的身份，为此，您可以按照仪表板中给出的步骤进行操作。您可以按照类似的步骤为Facebook Messenger创建沙箱。</p><p id="424b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您现在已经成功激活了WhatsApp沙盒！但是等等，我们还没完呢。我们仍然需要为Vonage提供webhooks所在的URL。如果您向下滚动沙盒页面，您应该会看到类似下面的Webhooks部分:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/81d7c9a8fec86f66eefb87e20c2f48c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CJCQoFk0rqwb_vpYRx6Rog.png"/></div></div></figure><p id="7bc9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一个是将位于路线<code class="fe nf ng nh ni b">webhooks/inbound</code>上的<code class="fe nf ng nh ni b">inbound</code> webhook，因此将该字段设置为<code class="fe nf ng nh ni b">https://&lt;your-ngrok-https-url&gt;/webhooks/inbound</code>。类似地，将<code class="fe nf ng nh ni b">status</code> webhook的URL设置为<code class="fe nf ng nh ni b">https://&lt;your-ngrok-https-url&gt;/webhooks/status</code>。我们现在已经完成了沙盒和测试环境的设置！</p><blockquote class="nn no np"><p id="d463" class="jy jz kx ka b kb kc kd ke kf kg kh ki nq kk kl km nr ko kp kq ns ks kt ku kv ij bi translated">注意:每次重启ngrok，你都会得到一个新的不同的URL，你必须在Vonage仪表板中手动更改。</p></blockquote><h1 id="ff81" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">向用户发回消息</h1><p id="aeac" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">我们将需要一个助手函数，它将用于向用户发回消息。</p><p id="43f7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们需要设置我们的Vonage API凭证，以便我们可以使用Messages API。这些凭证将存储在环境变量中。在文件夹的根目录下创建一个<code class="fe nf ng nh ni b">.env</code>文件。为了将环境变量加载到节点环境中，我们将使用<code class="fe nf ng nh ni b">dotenv</code>包。添加下列字段:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="bf29" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成后，将以下代码添加到<code class="fe nf ng nh ni b">app.js</code>的顶部，以添加环境变量:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="2b9c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nf ng nh ni b">src</code>文件夹中创建一个名为<code class="fe nf ng nh ni b">utils.js</code>的新文件。这将包含我们的实用功能，如格式化和发送消息给用户。</p><p id="d4a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将请求Messages REST API发送一条消息。在消息沙箱的情况下，API的URL将是<code class="fe nf ng nh ni b">https://messages-sandbox.nexmo.com/v0.1/messages</code>。我们将使用Axios来发送请求。我们可以使用<code class="fe nf ng nh ni b">auth</code>选项来添加我们的API凭证，如下所示:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="b0ab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">消息类型是动态的，因为当用户请求去医院的方向时，我们将发送类型为<code class="fe nf ng nh ni b">location</code>的消息。在WhatsApp上，类型为<code class="fe nf ng nh ni b">location</code>的消息会附上谷歌地图上该地点的缩略图以及提供的姓名和地址。</p><h1 id="95f8" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">创建命令</h1><p id="47bf" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">现在我们可以开始创建我们的命令了:</p><ol class=""><li id="5682" class="lw lx iq ka b kb kc kf kg kj nt kn nu kr nv kv md me mf mg bi translated"><code class="fe nf ng nh ni b">help</code> -获得所有可用命令的菜单</li><li id="2799" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated"><code class="fe nf ng nh ni b">cities</code> -获取所有可用城市的列表</li><li id="3439" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated"><code class="fe nf ng nh ni b">search &lt;hospital-name&gt; in &lt;location&gt;</code> -搜索特定位置的医院。例如，<code class="fe nf ng nh ni b">search sakra in bangalore</code>在班加罗尔搜索名为Sakra的医院。</li><li id="7dfe" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated"><code class="fe nf ng nh ni b">get directions to &lt;hospital-id&gt;</code> -使用特定ID获取去医院的路线。比如<code class="fe nf ng nh ni b">get directions to 87</code>会发送ID为87的医院的位置。</li></ol><h1 id="b9b2" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">入站消息处理程序</h1><p id="c0fa" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">让我们创建一个在<code class="fe nf ng nh ni b">/webhooks/inbound</code>处理对<code class="fe nf ng nh ni b">inbound</code> webhook的请求的函数。这个函数解析用户发送的消息，并将消息传递给用户试图使用的命令的处理程序。它发回适当的消息并返回状态代码200。</p><blockquote class="nn no np"><p id="28cd" class="jy jz kx ka b kb kc kd ke kf kg kh ki nq kk kl km nr ko kp kq ns ks kt ku kv ij bi translated">注意，webhook必须用状态码200来响应，否则Messages API将继续向webhook发送请求，直到它得到200响应。</p></blockquote><p id="aba9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们使用正则表达式来检查用户是否试图使用<code class="fe nf ng nh ni b">search</code>或<code class="fe nf ng nh ni b">directions</code>命令，然后将消息传递给适当的处理程序。如果消息是<code class="fe nf ng nh ni b">help</code>、<code class="fe nf ng nh ni b">hi</code>或<code class="fe nf ng nh ni b">hello</code>，则向用户发送帮助消息。如果消息是<code class="fe nf ng nh ni b">cities</code>，则将可用城市列表发送给用户。最后，如果消息与任何命令都不匹配，将向用户发送一条无效消息。</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="4819" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们修改入站webhook端点处理程序以使用<code class="fe nf ng nh ni b">handleInbound</code>函数。</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h1 id="c252" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">帮助和欢迎命令</h1><p id="52f0" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">当用户第一次给我们的服务发消息时，我们需要一条消息来问候他们。这个消息应该包含关于我们的机器人做什么和可以使用的不同命令的信息。我们还需要一条帮助消息，每当用户不知道该做什么并键入<code class="fe nf ng nh ni b">help</code>时，就会发送这条消息。这些消息可以是相似的。</p><p id="95a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Bedav API只有某些地区的医院信息。我们还需要一条消息来给出信息可用的地区列表。</p><p id="c11f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如在<code class="fe nf ng nh ni b">handleInbound</code>函数中实现的，当用户键入<em class="kx"> hi </em>、<em class="kx"> hello </em>或<em class="kx"> help </em>时，发送帮助消息，当用户键入<em class="kx">city</em>时，发送关于可用城市的消息。</p><p id="1fc0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为这两个消息都是常量，所以我们可以在顶层创建一个常量对象来定义所有的固定消息。我们还使用<code class="fe nf ng nh ni b">outdent</code>删除字符串中多余的空格，这些空格在代码中应该是缩进的。将代码追加到<em class="kx"> utils.js </em>:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h1 id="6fa5" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">设置GraphQL客户端</h1><p id="613f" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">为了简化对GraphQL API的查询，我们将使用<code class="fe nf ng nh ni b">graphql-request</code>库。为了设置GraphQL客户端，我们创建了一个<code class="fe nf ng nh ni b">GraphQLClient</code>实例，并提供了GraphQL API的URL。</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h1 id="34c1" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">创建一些实用函数</h1><p id="e37d" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">API文档中对<code class="fe nf ng nh ni b">hospitalId</code>字段的描述中提到，这是一个Base64编码的字符串，可以解码成<code class="fe nf ng nh ni b">Hospital:&lt;hospitalId&gt;</code>，其中<code class="fe nf ng nh ni b">hospitalId</code>是医院唯一的整数。出于您将在下一节中看到的原因，让我们创建两个实用函数:一个用于获取医院ID的号码，另一个用于将一个整数编码成形式为<code class="fe nf ng nh ni b">Hospital:&lt;hospitalId&gt;</code>的Base64字符串。我们将使用之前添加到项目中的<code class="fe nf ng nh ni b">js-base64</code>库来处理<code class="fe nf ng nh ni b">base64</code>编码的字符串。</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h1 id="7781" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">搜索命令</h1><h2 id="abc9" class="mt kz iq bd la mu mv dn le mw mx dp li kj my mz lm kn na nb lq kr nc nd lu ne bi translated">格式化字符串的实用函数</h2><p id="e74d" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">让我们再创建两个实用函数来格式化医院数据，一个用于格式化单个医院，另一个使用该函数来格式化一组医院。</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="c678" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不是每个医院都有ICU、HDU和普通病房的床位，也不是所有医院都有氧气和呼吸机。如果医院没有这些可用的，我们可以从消息中省略这些信息。如果可用总量为零或可用字段的值为空，则医院没有特定类型的可用床位、氧气或呼吸机。</p><p id="0d91" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还打印医院ID，因为用户必须在get directions命令中提供医院的ID。我们还向用户显示了括号中的床位占用百分比。</p><p id="70dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果没有床、呼吸机或氧气，则仍留有空白行。为了解决这个问题，我们创建了另一个助手函数来删除这些空行。</p><p id="6467" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了检查空行，我们使用一个简短的正则表达式来检查该行是否有多个空格字符:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="a89e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，创建用于格式化医院列表的函数，方法是遍历所有医院，获取该医院的格式化字符串，并在每个医院之间添加一个空行:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h2 id="e395" class="mt kz iq bd la mu mv dn le mw mx dp li kj my mz lm kn na nb lq kr nc nd lu ne bi translated">命令处理程序</h2><p id="ccf4" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">所有的GraphQL查询都将存储在<code class="fe nf ng nh ni b">src</code>文件夹中的<code class="fe nf ng nh ni b">queries.js</code>文件中。</p><p id="6fe2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们使用下面的GraphQL查询来搜索某个位置的医院，并检索所需的数据。locality字段的<code class="fe nf ng nh ni b">name</code>参数用于告诉API我们正在查询哪个位置的数据。<code class="fe nf ng nh ni b">hospitals</code>字段的<code class="fe nf ng nh ni b">first</code>参数指定我们希望API返回多少家医院，而<code class="fe nf ng nh ni b">searchQuery</code>参数提供搜索查询。</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><blockquote class="nn no np"><p id="70fa" class="jy jz kx ka b kb kc kd ke kf kg kh ki nq kk kl km nr ko kp kq ns ks kt ku kv ij bi translated">注意，我们不需要用<code class="fe nf ng nh ni b">gql</code>标签包装我们的GraphQL查询。但是，使用正确的扩展和工具，我们可以得到一些漂亮的语法高亮和类型检查。</p></blockquote><p id="54fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们需要将位置名称映射到形式为<code class="fe nf ng nh ni b">&lt;city/district_name&gt;-&lt;state_name&gt;</code>的<code class="fe nf ng nh ni b">locality</code>字段的<code class="fe nf ng nh ni b">name</code>参数。<a class="ae kw" href="https://bedav.org/locality_mapping.json" rel="noopener ugc nofollow" target="_blank">从<code class="fe nf ng nh ni b">city/district</code>到地区<code class="fe nf ng nh ni b">name</code>的映射</a>可以用JavaScript转换成下面的对象:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="1123" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用户为搜索某个位置的医院而输入的文本将采用以下格式。让我们创建<code class="fe nf ng nh ni b">handleSearch</code>函数，它从用户的消息中获取搜索查询和位置。该函数负责运行搜索查询并将适当的响应发送回用户:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h1 id="0dbb" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">获取方向命令</h1><p id="2f8c" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">剩下要实现的最后一个命令是get directions命令。命令的格式是<code class="fe nf ng nh ni b">get directions to &lt;hospital-id&gt;</code>。</p><p id="34c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，创建将获取医院信息的查询，该信息是向用户发送医院位置所必需的:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="3063" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们创建一个<code class="fe nf ng nh ni b">handleDirections</code>函数，它将根据用户的请求向医院发送路线。如果用户正在使用WhatsApp，我们会发送一条类型为<code class="fe nf ng nh ni b">location</code>的消息，其中包含医院的名称和地址。由于Messenger上没有类型为<code class="fe nf ng nh ni b">location</code>的消息，我们发送类型为<code class="fe nf ng nh ni b">text</code>的消息，其中包含一个指向医院位置的Google Maps链接:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="5e3c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就这样，我们结束了！你可以在沙盒中自己尝试所有的命令，它应该看起来像下面这样！</p><h1 id="c0e0" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">下一步是什么</h1><ul class=""><li id="3b25" class="lw lx iq ka b kb ly kf lz kj ma kn mb kr mc kv nw me mf mg bi translated">现在，我们的webhook对整个互联网开放。我们需要一种方法来确保只有Vonage消息API可以访问端点。阅读更多关于使用JWT令牌限制访问的信息。</li><li id="efc3" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv nw me mf mg bi translated">如果你对机器学习感兴趣，你可以使用自然语言处理让机器人使用起来更自然。</li><li id="ffa1" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv nw me mf mg bi translated">在获取路线命令中使用医院ID不是最佳的用户体验。取而代之的是，尝试执行一个命令，让用户输入他想去的医院的名称。如果有多家医院名称相似，则返回一个医院列表及其ID，并要求用户输入他们想要获取路线的医院的ID。</li></ul><p id="e0af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">教程的最终代码可以在GitHub 上找到<a class="ae kw" href="https://github.com/shreyas44/bedav-vonage" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl nx ny hu nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="ij ik il im in"><p id="6599" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kx">最初发布于</em><a class="ae kw" href="https://learn.vonage.com/blog/2021/03/25/build-a-whatsapp-and-messenger-graphql-bot-to-find-hospital-beds/" rel="noopener ugc nofollow" target="_blank"><em class="kx">https://learn . vonage . com/blog/2021/03/25/build-a-whatsapp-and-messenger-graph QL-bot-to-find-hospital-beds/</em></a></p></div></div>    
</body>
</html>