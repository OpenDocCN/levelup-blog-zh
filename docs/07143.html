<html>
<head>
<title>Automate Your Automation with CloudFormation Macros</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CloudFormation宏实现自动化</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/automate-your-automation-with-cloudformation-macros-e3dc36f62ade?source=collection_archive---------22-----------------------#2021-01-26">https://levelup.gitconnected.com/automate-your-automation-with-cloudformation-macros-e3dc36f62ade?source=collection_archive---------22-----------------------#2021-01-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/428c96a71c228006dda8616059a10bdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-CKI_WQ8lSiFl9m3cOMzIg.jpeg"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">图片由<a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=3885331" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a>的Gerd Altmann 提供</figcaption></figure><div class=""/><div class=""><h2 id="6950" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">作为代码的基础设施已经改变了云世界的游戏规则。但是您知道可以自动创建AWS资源吗？</h2></div><p id="7e8b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我在2019年初第一次开始了我的无服务器之旅。我着迷于你能很快拼凑起来的所有东西，无法相信我在整个软件生涯中错过了什么。</p><p id="aa36" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对我来说特别的是CloudFormation，特别是<a class="ae jg" href="https://aws.amazon.com/serverless/sam/" rel="noopener ugc nofollow" target="_blank">无服务器应用模型(SAM) </a>。SAM允许您快速、轻松地定义无服务器函数、API和事件源映射。</p><p id="b668" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当您在后台部署SAM应用程序时，它会将您的无服务器引用转换为CloudFormation资源，并将它们推入AWS。</p><p id="4881" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我喜欢这个想法，我可以通过代码定义架构，并让它成功地部署到任何AWS帐户。在某种意义上，它有点像一个容器。如果我知道它能工作，我可以在任何地方运行它。</p><p id="c63d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">随着时间的推移，我的用例开始变得越来越高级。我开始为特定类型的资源设置模式，并对资源进行“拷”——这意味着当我创建这种类型的资源时，我也需要创建另一种资源。</p><p id="e063" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这些都不难，但容易出错。有人可能会忘记添加资源或弄错命名约定。</p><p id="4789" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后我发现了CloudFormation宏。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><figure class="mc md me mf gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mb"><img src="../Images/e3669d72f5cab47305e42d5bc1e2db50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7Xheb3qyAmutdlO0.jpg"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated"><em class="mg">图片由</em> <a class="ae jg" href="https://pixabay.com/users/robinhiggins-1321953/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2681507" rel="noopener ugc nofollow" target="_blank"> <em class="mg">罗宾希金斯</em> </a> <em class="mg">从</em> <a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2681507" rel="noopener ugc nofollow" target="_blank"> <em class="mg"> Pixabay </em> </a></figcaption></figure><h1 id="ae87" class="mh mi jj bd mj mk ml mm mn mo mp mq mr kp ms kq mt ks mu kt mv kv mw kw mx my bi translated">什么是宏？</h1><p id="2047" class="pw-post-body-paragraph ky kz jj la b lb mz kk ld le na kn lg lh nb lj lk ll nc ln lo lp nd lr ls lt im bi translated">一个<a class="ae jg" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html" rel="noopener ugc nofollow" target="_blank"> CloudFormation宏</a>是一个在部署上运行的函数，它转换模板中定义的资源。它可以做任何事情—添加新资源、删除特定资源或操纵现有资源。</p><p id="1145" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你使用SAM，那么你已经在使用一个宏，甚至可能不知道它。在每个SAM模板中都定义了一个指向无服务器的<code class="fe ne nf ng nh b">Transform</code>属性.....AWS里的东西。嗯，那个“东西”实际上是一个宏，它将把SAM中定义的快捷方式转化为CloudFormation资源。</p><p id="e453" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当您开始寻找构建资源的模式时，宏就派上了用场。当你构建一个新的lambda函数时，有没有一个资源总是被创建的？每当实现一个新的API端点时，是否有一个手动过程发生？</p><p id="4686" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将人的因素从任何手动过程中去除应该是一个目标，因为它消除了出错的机会。机器每次都会以相同的方式执行任务。人类不会。我们会分心或懒惰，或认为有些事情是不必要的，不会去做。</p><p id="3119" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你能自动化你的自动化，从长远来看，你就为自己的成功做好了准备。一次又一次地，开发会做得更快，更一致。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="d2fb" class="mh mi jj bd mj mk ni mm mn mo nj mq mr kp nk kq mt ks nl kt mv kv nm kw mx my bi translated">构建一个示例</h1><p id="4541" class="pw-post-body-paragraph ky kz jj la b lb mz kk ld le na kn lg lh nb lj lk ll nc ln lo lp nd lr ls lt im bi translated">假设您有一个场景，每次创建带有特定环境变量的lambda函数时，您都希望创建一个SSM参数来跟踪该值。这将允许您从SSM控制台查看整个应用程序中该环境变量的所有值。</p><p id="6a7a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这可以用宏来完成。因此，让我们建立一个自动化的过程。</p><p id="e2a4" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们知道我们的宏有两个目标:</p><ul class=""><li id="05a6" class="nn no jj la b lb lc le lf lh np ll nq lp nr lt ns nt nu nv bi translated">λ函数</li><li id="05e0" class="nn no jj la b lb nw le nx lh ny ll nz lp oa lt ns nt nu nv bi translated">特定的环境变量。</li></ul><p id="738d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当CloudFormation宏运行时，它们在具有以下属性的事件中传递:</p><pre class="mc md me mf gt ob nh oc od aw oe bi"><span id="5850" class="of mi jj nh b gy og oh l oi oj">{ <br/> "accountId": "", // AWS Account Id<br/> "fragment": {}, // JSON representation of your SAM/CloudFormation template<br/> "transformId": "", // Id of the specific transform<br/> "requestId": "", // Id of this run<br/> "region": "", // Region being deployed into<br/> "params": {}, // Parameters used in the transform<br/> "templateParameterValues": { } // Parameter values used in the template<br/>}</span></pre><p id="2084" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">包含在<code class="fe ne nf ng nh b">fragment.Resources</code>中的值是由您的模板生成的所有资源。因此，对于我们的示例，我们需要将资源过滤到具有特定环境变量的lambda函数。这个变量将被称为<code class="fe ne nf ng nh b">LAMBDA_VALUE</code>。</p><p id="fb17" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们的宏将被写成NodeJS函数。为了在SAM模板中找到lambda资源，我们需要编写以下javascript:</p><pre class="mc md me mf gt ob nh oc od aw oe bi"><span id="ff8a" class="of mi jj nh b gy og oh l oi oj">const lambdas = []; <br/>const resourceKeys = Object.keys(resources); <br/>for (let i = 0; i &lt; resourceKeys.length; i++) { <br/>  const resource = resources[resourceKeys[i]]; <br/>  if (resource.Type === 'AWS::Serverless::Function' <br/>    &amp;&amp; resource.Properties.Environment.Variables.LAMBDA_VALUE) {<br/>   lambdas.push({ <br/>      name: resourceKeys[i],<br/>      details: resource <br/>   }); <br/>  } <br/>}</span></pre><p id="1844" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个代码片段生成了一个数组，其中包含所有具有我们的环境变量的lambda函数。现在我们想用环境变量中的数据构建SSM参数。</p><pre class="mc md me mf gt ob nh oc od aw oe bi"><span id="910a" class="of mi jj nh b gy og oh l oi oj">lambdas.forEach((lambda) =&gt; { event.fragment.Resources[`${lambda.name}Parameter`] = { <br/>  Type: 'AWS::SSM::Parameter', <br/>  Properties: { <br/>    Name: `${lambda.name}Parameter`, <br/>    Type: 'String', <br/>    Value: lambda.details.Properties.Environment.Variables.LAMBDA_VALUE<br/>   } <br/>  }; <br/>});</span></pre><p id="dd9b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这会将新的SSM参数资源直接添加到要创建的AWS资源列表中。最后，我们需要以宏期望响应的格式返回更新的资源。</p><p id="b7a2" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所以在我们的函数中我们返回:</p><pre class="mc md me mf gt ob nh oc od aw oe bi"><span id="25f2" class="of mi jj nh b gy og oh l oi oj">return { <br/>  requestId: event.requestId, <br/>  status: 'success', <br/>  fragment: event.fragment <br/>};</span></pre><p id="05d7" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们已经写好了源代码(<a class="ae jg" href="https://gist.github.com/allenheltondev/1281088e952ef428e7971ffd0b7ec1af#file-function-js" rel="noopener ugc nofollow" target="_blank">在这里查看完整源代码</a>)，我们需要创建宏资源。在我们的SAM/CloudFormation模板中，我们需要创建一个类型为<code class="fe ne nf ng nh b">AWS::CloudFormation::Macro</code>的资源，它指向我们刚刚创建的函数。</p><pre class="mc md me mf gt ob nh oc od aw oe bi"><span id="bb76" class="of mi jj nh b gy og oh l oi oj">AddSSMParametersMacro: <br/>  Type: AWS::CloudFormation::Macro <br/>  Properties: <br/>    Name: AddSSMParameters <br/>    Description: Adds SSM Parameters for lambdas with the LAMBDA_VALUE env var <br/>    FunctionName: <br/>      Ref: AddSSMParametersFunction</span></pre><p id="a782" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">宏是简单的资源，它们接受名字和对函数的引用。一旦我们构建了它并将其部署到我们的AWS帐户中，我们将能够在我们的其他SAM或CloudFormation模板中使用它。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="987c" class="mh mi jj bd mj mk ni mm mn mo nj mq mr kp nk kq mt ks nl kt mv kv nm kw mx my bi translated">使用宏</h1><p id="807d" class="pw-post-body-paragraph ky kz jj la b lb mz kk ld le na kn lg lh nb lj lk ll nc ln lo lp nd lr ls lt im bi translated">此时，宏已经构建好，可以使用了。要将其添加到SAM或CloudFormation模板中以供使用，请将其添加到<code class="fe ne nf ng nh b">Transform</code>属性中。</p><pre class="mc md me mf gt ob nh oc od aw oe bi"><span id="f237" class="of mi jj nh b gy og oh l oi oj">Transform: [AWS::Serverless-2016-10-31, AddSSMParametersMacro]</span></pre><p id="70c5" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该属性是一个数组，可以运行任意多的宏。<em class="ok">只要宏在您部署到的同一个AWS帐户</em>中，它就可以正常工作。</p><p id="fd21" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在部署模板的幕后，它将按照模板中指定的顺序遍历所有的转换。在我们的示例中，它将首先运行SAM转换，将快速简单的SAM快捷方式转换为成熟的CloudFormation。然后，它将运行我们的自定义宏，分析所有的函数，并添加任何新的SSM参数。</p><p id="9962" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">运行转换后，它会将所有资源部署到AWS中。</p><p id="815b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">很简单，对吧？</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><figure class="mc md me mf gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mb"><img src="../Images/f56f4c154eda1678b5d7439afa498d4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Wnldzb17B-M6zQi0.jpg"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated"><em class="mg">图片由</em><a class="ae jg" href="https://pixabay.com/users/comfreak-51581/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2380009" rel="noopener ugc nofollow" target="_blank"><em class="mg">combreak</em></a><em class="mg">转自</em> <a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2380009" rel="noopener ugc nofollow" target="_blank"> <em class="mg"> Pixabay </em> </a></figcaption></figure><h1 id="ea4a" class="mh mi jj bd mj mk ml mm mn mo mp mq mr kp ms kq mt ks mu kt mv kv mw kw mx my bi translated">尝试</h1><p id="3a01" class="pw-post-body-paragraph ky kz jj la b lb mz kk ld le na kn lg lh nb lj lk ll nc ln lo lp nd lr ls lt im bi translated">宏非常适合在您的管道中添加另一层自动化。对于包含手动过程的场景，宏是完美的。</p><p id="9a0a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请记住，宏是lambda函数。你可以让他们做任何事。写入DynamoDB，调用一个外部API，<a class="ae jg" href="https://medium.com/better-programming/how-to-integrate-your-app-with-webhooks-using-amazon-sns-a36aad22f3b1" rel="noopener">触发一个webhook事件</a>，可能性无穷无尽。</p><p id="c288" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以在这里找到我们代码演练<a class="ae jg" href="https://gist.github.com/allenheltondev/1281088e952ef428e7971ffd0b7ec1af" rel="noopener ugc nofollow" target="_blank">的完整例子。AWS还在GitHub上提供了一个完整的宏</a>库来帮助你的自动化之旅。</p><p id="007b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我希望您能找到一些宏的伟大用例，并使您的管道更加高效。</p><p id="2050" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">继续自动化！</p></div></div>    
</body>
</html>