<html>
<head>
<title>1000 Docker Containers Start with One Command — Ultra Pro Scalability</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">1000个Docker容器从一个命令开始— Ultra Pro可扩展性</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/1000-docker-containers-start-with-one-command-ultra-pro-scalability-9b69305459f7?source=collection_archive---------6-----------------------#2022-09-20">https://levelup.gitconnected.com/1000-docker-containers-start-with-one-command-ultra-pro-scalability-9b69305459f7?source=collection_archive---------6-----------------------#2022-09-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a8a09118d631a0526f7a0a8b0491f9b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j5unTYbwQ6okkAeKz9X2IA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">可伸缩码头</figcaption></figure><p id="3678" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我假设你目前已经了解了Docker和NodeJS的基础知识，因为这个故事并不关注于此，而是展示了专业级别的可伸缩性。</p><p id="6f30" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了让我们所有人都站在同一水平线上，我创建了一个<a class="ae la" href="https://github.com/Guneetsinghtuli/1000-docker" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>，你可以克隆它，它有让我们所有人一起开始并把我们带到同一水平线上的基本代码。</p><h2 id="2467" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated">是时候准备好你的枪了…</h2><figure class="lu lv lw lx gt jr"><div class="bz fp l di"><div class="ly lz l"/></div></figure><p id="2585" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们从基本的<strong class="ke ir"> Dockerfile开始，作为一个梳理</strong>。如果你对它有信心，你可以跳过它。</p><pre class="lu lv lw lx gt ma mb mc md aw me bi"><span id="c7a1" class="lb lc iq mb b gy mf mg l mh mi">FROM node:14<br/>WORKDIR /app<br/>COPY package.json .<br/>RUN npm install<br/>COPY . .<br/>CMD ["npm", "start"]<br/>EXPOSE 3000</span></pre><p id="289f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">从</strong>这从docker hub中调出了一个节点的基本映像，我们将对其进行处理。</p><p id="9953" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在我们将要处理应用程序的容器中创建一个名为app的文件夹。</p><p id="3b43" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">复制</strong>只需将主机(你的电脑)上的package.json文件夹复制到容器内的app文件夹即可。</p><p id="1dec" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">运行</strong>这将运行上面提到的命令，在容器中安装所有的依赖项，以使我们的应用程序运行</p><p id="bb78" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">复制</strong>再次复制。(点)第一个点表示您的主机pc的当前位置，第二个点表示您的<strong class="ke ir">工作目录的位置。只需将每个文件夹从主机复制到容器中。</strong></p><p id="3e83" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> CMD </strong>命令启动应用程序</p><p id="d865" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> EXPOSE </strong>它将从容器向主机公开一个端口。</p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><h2 id="0218" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated">让我们从一个容器开始</h2><p id="d983" class="pw-post-body-paragraph kc kd iq ke b kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv mu kx ky kz ij bi translated">要使用dockerfile构建映像，可以使用以下命令</p><pre class="lu lv lw lx gt ma mb mc md aw me bi"><span id="4248" class="lb lc iq mb b gy mf mg l mh mi">docker build --tag nodeImage .</span></pre><p id="ed4c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">构建完映像后，现在使用我们构建的映像启动容器，命令如下</p><pre class="lu lv lw lx gt ma mb mc md aw me bi"><span id="28a0" class="lb lc iq mb b gy mf mg l mh mi">docker run -p 3000:3000 -d --name nodeContainer nodeImage</span></pre><p id="b379" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要检查是否一切顺利，请转到localhost:3000/如果您看到的响应是<strong class="ke ir">嘿，我认识你，你是——</strong></p><p id="efe6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">哇，一切都很顺利。</p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><h1 id="bd57" class="mv lc iq bd ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni nj nk ls nl bi translated">现在让我们使用多个容器</h1><p id="cdde" class="pw-post-body-paragraph kc kd iq ke b kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv mu kx ky kz ij bi translated">您已经看到，启动一个容器需要2个步骤，所以要启动1000个容器，我当然不会键入2000个命令。</p><p id="c340" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了让使用多个容器变得更容易，我会使用<strong class="ke ir"> docker-compose(一种制作图像+启动容器的简单方法)</strong></p><p id="19a9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建一个名为<strong class="ke ir"> docker-compose.yaml的文件</strong></p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/1e9d6ce33b30777adaf5f98c7de45727.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-dUsn1Iq5cg9hhVS_XM62Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">docker-compose的代码片段</figcaption></figure><p id="6c2b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，docker-compose将负责构建和运行容器。服务下面提到的<strong class="ke ir">节点</strong>是服务的<strong class="ke ir">名称</strong>你想怎么命名都行。</p><p id="8f32" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们试着用它来启动一个容器</p><pre class="lu lv lw lx gt ma mb mc md aw me bi"><span id="b7c6" class="lb lc iq mb b gy mf mg l mh mi">docker-compose up -d</span></pre><p id="d7f6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">再次转到localhost:3000/来检查容器是否正在运行。<strong class="ke ir">如果是工作时间就去秤吧。</strong></p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><h1 id="952c" class="mv lc iq bd ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni nj nk ls nl bi translated">让我们扩大规模</h1><p id="d240" class="pw-post-body-paragraph kc kd iq ke b kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv mu kx ky kz ij bi translated">首先用以下方法取下旧容器</p><pre class="lu lv lw lx gt ma mb mc md aw me bi"><span id="8d7b" class="lb lc iq mb b gy mf mg l mh mi">docker-compose down -v</span></pre><p id="3287" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">告诉过你docker-compose是❤️.</strong>现在，对于启动程序，只需将其扩展到2个容器。您可以使用scale标志启动两个容器，并为docker-compose中提到的服务名指定容器的数量。</p><pre class="lu lv lw lx gt ma mb mc md aw me bi"><span id="6c57" class="lb lc iq mb b gy mf mg l mh mi">docker-compose up -d --scale node=2</span></pre><p id="d2f6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">不要在没有尝试过这个之前就继续，如果你已经尝试过了<strong class="ke ir">恭喜</strong>。</p><figure class="lu lv lw lx gt jr"><div class="bz fp l di"><div class="nn lz l"/></div></figure><p id="6c14" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">很有趣，我知道你面临一个错误。但是你可能已经猜到了问题所在。</p><p id="5ff4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> 2 docker-container不能与我们在docker-compose文件中指定的名字</strong>相同，所以让<strong class="ke ir"> docker </strong>随意命名我们的容器，我个人喜欢docker容器有趣的名字，它自己命名。</p><p id="2555" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">只需对指定名称<strong class="ke ir"><em class="no">container _ name:node container的行进行注释。</em>T11】</strong></p><p id="24bc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果容器已经在工作，就把它拿下来，让我们再试一次。</p><pre class="lu lv lw lx gt ma mb mc md aw me bi"><span id="3dfd" class="lb lc iq mb b gy mf mg l mh mi">docker-compose up -d --scale node=2</span></pre><figure class="lu lv lw lx gt jr"><div class="bz fp l di"><div class="np lz l"/></div></figure><p id="d76d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">又是一个错误😂😂现在再想一想，两个不同的容器如何连接到主机的同一个3000端口。如果你在没有docker的情况下尝试运行两个应用程序，你可能会遇到同样的错误。</p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><h1 id="e98d" class="mv lc iq bd ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni nj nk ls nl bi translated">对此的解决方案</h1><p id="4cb0" class="pw-post-body-paragraph kc kd iq ke b kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv mu kx ky kz ij bi translated">所以我们需要一个中间人，他在主机的一个端口上工作，并自己处理所有其他节点容器。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/8336ed439764ac5141ccc04ca98f345e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/1*kb5pYQ2Ube9vc1L0qiMYNA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Nginx作为反向代理</figcaption></figure><p id="2953" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">是的，我们需要Nginx作为<a class="ae la" href="https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/?utm_source=pocket_mylist" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir">一个反向代理服务器</strong> </a> <strong class="ke ir">和负载均衡</strong>。所以Nginx将是我们的节点服务器和主机之间的中间人。</p><p id="f10f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果您以前没有使用过Nginx，请不要担心，尝试让它成为您的第一次。</p><p id="bbeb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所以是时候为Nginx再设置一个服务了，你可能猜对了，这是docker-compose.yaml 文件中的一个服务。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/bb53448ea596595e52df3d08f8fe99bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ReGpaJ_9r1ixo-HqJWKpbg.png"/></div></div></figure><p id="120a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在Nginx容器将通过<strong class="ke ir"> 3000 </strong> :3000中提到的一个单端口3000端口连接到我们的主机，下一个3000是在告诉Nginx已经打开了一个连接节点容器的端口3000。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/c6be56a60e7749e23df01885b8563e91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/1*TpmzEw7PxMj_s_Gl5fCAIg.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">nginx端口配置</figcaption></figure><p id="1075" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在是时候配置我们的Nginx了，如果你是第一次使用它，不要太投入配置，很可能你会有点困惑。</p><p id="a135" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建一个名为conf.d的文件夹，并在这个<strong class="ke ir">中创建一个名为nginx_conf.conf的文件，然后复制下面几行或者自己写。</strong></p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/cd07470146266ba34d30de54b5166e08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z3JwzIJtfs7f635GJUW-mw.png"/></div></div></figure><p id="6446" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">但是要在docker Nginx容器<strong class="ke ir">中发送这个文件，我们需要一个卷来附加我们的本地文件夹conf.d。这就是docker-compose中的卷的目的。</strong></p><p id="90b0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在我们准备好了，让我们旋转2个容器。</p><pre class="lu lv lw lx gt ma mb mc md aw me bi"><span id="6b84" class="lb lc iq mb b gy mf mg l mh mi">docker-compose up -d --scale node=2</span></pre><p id="29aa" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在转到localhost:3000/来检查是否一切正常，你将会看到类似于<strong class="ke ir">嘿，我认识你，你是&lt;容器ID &gt; </strong></p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/cdcb710827d635d5a46314184a782091.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*zByc0I5MMiYxe7X7fa-8YQ.png"/></div></figure><p id="edb4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果您现在刷新它，您将看到第二个节点容器的不同容器id，因为我们已经将其扩展到2个容器。和负载平衡器使请求在每个容器上均衡。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/33faa703be7cd23b7931c338b86b0e8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*Fqt3iD67LJGJZf92bv2KcQ.png"/></div></figure><h1 id="35e8" class="mv lc iq bd ld mw nu my lg mz nv nb lj nc nw ne lm nf nx nh lp ni ny nk ls nl bi translated">是时候享受真正的乐趣了</h1><p id="dc44" class="pw-post-body-paragraph kc kd iq ke b kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv mu kx ky kz ij bi translated">运行1000个容器时，确保你准备好灭火器以防万一。我当然不会冒险，但是您可以使用扩展到1000个容器</p><pre class="lu lv lw lx gt ma mb mc md aw me bi"><span id="ae7c" class="lb lc iq mb b gy mf mg l mh mi">docker-compose up -d --scale node=1000</span></pre></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="6cde" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你的电脑幸存下来，恭喜你。</p><figure class="lu lv lw lx gt jr"><div class="bz fp l di"><div class="np lz l"/></div></figure><blockquote class="nz oa ob"><p id="3d01" class="kc kd no ke b kf kg kh ki kj kk kl km oc ko kp kq od ks kt ku oe kw kx ky kz ij bi translated"><em class="iq">我希望你喜欢它，并从这个故事中学到很多，如果你不想错过我发布另一个故事的任何时间，请确保关注我并订阅以获得电子邮件更新。</em></p></blockquote><p id="5c40" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你可以在<a class="ae la" href="https://twitter.com/Guneetsingh02" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir"> Twitter </strong> </a>和<a class="ae la" href="https://www.linkedin.com/in/guneetsinghtuli/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir"> LinkedIn </strong> </a>上关注我，我会分享更多信息。</p><p id="2967" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你认为你对这篇文章有更好的或不同的观点，不要忘了评论，我可能会把它和你的名字放在一起。</p></div></div>    
</body>
</html>