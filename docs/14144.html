<html>
<head>
<title>Lessons learned while moving from a multi- to a mono-repo architecture with dbt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用dbt从多回购架构迁移到单回购架构的经验教训</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/lessons-learned-while-moving-from-a-multi-to-a-mono-repo-architecture-with-dbt-95e2982bd49c?source=collection_archive---------4-----------------------#2022-11-04">https://levelup.gitconnected.com/lessons-learned-while-moving-from-a-multi-to-a-mono-repo-architecture-with-dbt-95e2982bd49c?source=collection_archive---------4-----------------------#2022-11-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/aec3e334bad5d4b27801358ce9d76fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lOHGjhL8reGY1r_6"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">这显然是Joel Filipe在T2 Unsplash T3上解释什么是“单块”架构的方式。</figcaption></figure><p id="c138" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几个月前，我加入了目前的组织，担任数据主管。我的首要任务是建立一个强大可靠的数据平台。数据团队中的公分母是SQL，而不是Python。因此，选择dbt来帮助我们完成这项任务是显而易见的。</p><p id="b797" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">数据团队(4人)是最近才成立的，没有人对dbt有太多的经验。那时，来自dbt实验室的关于如何构建dbt项目的著名的<a class="ae kf" href="https://docs.getdbt.com/guides/best-practices/how-we-structure/1-guide-overview" rel="noopener ugc nofollow" target="_blank">帖子</a>还没有发布。作为一名数据科学背景的人，我觉得围绕独立的回购组织我们的dbt项目是很自然的。</p><p id="20c0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">仅仅过了8个月，我们就获得了多达33次回购。我们开始遇到维护清晰的数据谱系和最新文档的严重问题。简而言之，我们无法恰当地利用dbt最重要的特性。</p><p id="3810" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我决定进行一次大的飞跃，在积累太多技术债务之前，围绕单个回购协议彻底重组我们的dbt代码。</p><p id="fb47" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我会在这篇文章中讲述我们的旅程。虽然我认为这种迁移100%值得，但本文并不讨论每种方法的优缺点。相反，它解释了如何最好地从多回购dbt架构转移到单回购dbt架构。这篇文章的重点是项目管理方面，但也注入了技术技巧。它的目标是领导这一计划的数据工作者。</p><blockquote class="le"><p id="abaf" class="lf lg it bd lh li lj lk ll lm ln ld dk translated">本文讨论的是如何最好地从多回购dbt架构迁移到单回购dbt架构，而不是权衡每种方法的利弊。</p></blockquote><h1 id="0329" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">📆在日程中安排时间</h1><p id="db5e" class="pw-post-body-paragraph kg kh it ki b kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">迁移许多回购很可能需要团队成员之间的积极协作。事实上，回购往往相互依赖，而他们的所有权往往分散在整个团队。换句话说，在进行迁移时，人们需要相互交流。我不认为你能通过把它分成星期五下午的票来处理这样一个任务。</p><p id="abd1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为您的团队提供受保护的时间对于该计划的成功至关重要。你在驾驶席上，你的工作是让你的利益相关者明白他们的请求会被暂时搁置。</p><p id="bf63" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一般来说，做两件事更容易获得管理团队的认可:</p><ul class=""><li id="c217" class="mr ms it ki b kj kk kn ko kr mt kv mu kz mv ld mw mx my mz bi translated">列出迁移的业务优势(例如:对PII数据的更好治理，因为单一回购架构将使跟踪数据谱系变得更加容易)</li><li id="d58c" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">提出一组您想要达到的明确目标，而不仅仅是一个模糊的提议(例如:在第2天，与核心数据模型相关的所有回购都被迁移，在第4天，与业务应用程序相关的所有回购都被迁移)</li></ul><p id="472d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们的案例中，我们有整整一周的时间专注于迁移。你需要的时间当然取决于你的团队的规模和你的业务流程的复杂性。</p><h1 id="a0d1" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ng mb mc md nh mf mg mh ni mj mk ml bi translated">👩‍💻提前做好准备</h1><p id="4fe5" class="pw-post-body-paragraph kg kh it ki b kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">你希望你的团队在第一天就全速前进。这需要你方做相当多的准备。</p><p id="9eb3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在搬迁的前一周，准备一个追踪器，列出所有需要迁移的回购。区分列表的优先次序，这很重要。您可能有一些构建核心数据模型的dbt项目，这些项目可能必须在与业务仪表板或分析相关联的项目之前移动。最后，将每个回购分配给一名团队成员，以便您的同事确切知道从哪里开始。</p><blockquote class="le"><p id="47dd" class="lf lg it bd lh li lj lk ll lm ln ld dk translated">你应该为搬家制定明确的指导方针。</p></blockquote><p id="0c83" class="pw-post-body-paragraph kg kh it ki b kj nj kl km kn nk kp kq kr nl kt ku kv nm kx ky kz nn lb lc ld im bi translated">您还应该为搬迁制定明确的指导方针，这些指导方针必须至少包括:</p><ul class=""><li id="2e9f" class="mr ms it ki b kj kk kn ko kr mt kv mu kz mv ld mw mx my mz bi translated">单一回购结构的详细视图(即什么去哪里)。米罗思维导图是一个方便的工具来起草文件夹的结构。</li><li id="9976" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">关于如何迁移现有回购协议的说明</li><li id="f070" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">团队惯例的列表(模型名称、文件夹名称等)</li></ul><p id="e478" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">指南所需的详细程度取决于团队的成熟度。但是经验告诉我，更规范一点通常更好。初级团队成员会找到他们需要的指导，而高级团队成员会跳过细节。</p><p id="962f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我强烈建议在搬迁前两三天组织一次启动会议。利用这次会议来调查团队是否对推荐的指导方针感到满意，并收集反馈。如果团队没有完全一致，最好在这个阶段进行辩论，而不是进行长时间的讨论，这可能会在迁移的第一天延迟实施。</p><h1 id="a9a1" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ng mb mc md nh mf mg mh ni mj mk ml bi translated">在开始迁移之前，🧪酸测试您的指导方针</h1><p id="396a" class="pw-post-body-paragraph kg kh it ki b kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">你现在有了一套漂亮的指导方针，整个团队似乎都很满意。从理论上来说，这一切都很好，但是如果你想在移动过程中按预期运行，你最好测试一下你的指令。</p><p id="2bd8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我将用对我有效的方法来说明上面的观点。迁移开始前的那个星期五，我创建了与我们新的独立dbt repo相关联的远程。迁移我们的一个高优先级dbt项目允许我检查:</p><ul class=""><li id="9f96" class="mr ms it ki b kj kk kn ko kr mt kv mu kz mv ld mw mx my mz bi translated">提议的文件夹结构确实是相关的</li><li id="9abc" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">在保留git历史记录的同时，可以很容易地引入现有的文件夹(稍后将详细介绍)</li><li id="d79a" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">CI渠道正常工作(我还会回到这一点)</li></ul><h1 id="0d09" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ng mb mc md nh mf mg mh ni mj mk ml bi translated">⚔️明智地选择你的战斗</h1><p id="7b91" class="pw-post-body-paragraph kg kh it ki b kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">在这种类型的练习中，很容易偏离你的主要焦点。这是一个常见的陷阱。</p><p id="95bf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你和你的团队基本上要重组所有的dbt模型。您可能会看到一些蹩脚的代码片段经过。不要陷入重构一切的陷阱。否则，您将面临无法实现关键目标的严重风险，即拥有一个正在运行的单一回购dbt项目。</p><p id="167b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">相反，建立一个无论如何都必须重构的3-4点的简短列表。其余的必须保持不变。</p><p id="50e5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们的案例中，必须勾选以下项目:</p><ul class=""><li id="eba1" class="mr ms it ki b kj kk kn ko kr mt kv mu kz mv ld mw mx my mz bi translated">所有模型都有记录。</li><li id="4295" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">所有型号都经过测试。测试应至少检查相应表的主键</li><li id="a632" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">只有暂存文件夹中的模型可以链接到<code class="fe no np nq nr b">{{ sources() }}</code>，所有剩余的模型只能依赖于<code class="fe no np nq nr b">{{ ref() }}</code>。</li></ul><p id="1424" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后一点实际上是需要大部分重构的地方。通过设计，多回购架构所需的许多资源现在可以转化为参考。你最喜欢的想法的搜索功能肯定会有所帮助。请注意，您也可以使用<code class="fe no np nq nr b">grep -rnw models/ -e "{{ sources(&lt;source-to-move-to-ref&gt;) }}"</code>命令直接在终端中搜索文件夹树</p><h1 id="2f4c" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ng mb mc md nh mf mg mh ni mj mk ml bi translated">⏳迁移仓库，同时保留git历史记录</h1><p id="e1a5" class="pw-post-body-paragraph kg kh it ki b kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">有两种方法可以把旧的回购文件带到你的单声道回购。</p><ul class=""><li id="19f5" class="mr ms it ki b kj kk kn ko kr mt kv mu kz mv ld mw mx my mz bi translated">选项1:强力复制粘贴文件到它们的新位置。也许这不是最好的主意，因为您将丢失git历史记录。</li><li id="aef3" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">选项2:合并回购协议，同时保留git历史记录。</li></ul><p id="912c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选项2只需要几个额外的步骤，但是要安全得多。下面的食谱对我们很有效</p><pre class="ns nt nu nv gt nw nr nx ny aw nz bi"><span id="52d8" class="oa lp it nr b gy ob oc l od oe">## checkout to a new branch on the mono repo<br/>git checkout -b &lt;migrate-old-repo&gt;</span><span id="a302" class="oa lp it nr b gy of oc l od oe">## add the &lt;old-repo&gt; remote to the mono repo<br/>git remote add &lt;old-repo&gt; git@github.com:&lt;old-repo&gt;.git</span><span id="76e9" class="oa lp it nr b gy of oc l od oe">## get the &lt;old-repo&gt; files<br/>git fetch &lt;old-repo&gt;</span><span id="de97" class="oa lp it nr b gy of oc l od oe">## merge the old and mono repo branches<br/>git merge remotes/&lt;old-repo&gt;/main --allow-unrelated-histories</span><span id="6c58" class="oa lp it nr b gy of oc l od oe">## ... you will then move the new files to the desired location and <br/>## open a pull request</span></pre><p id="b898" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这样做时，合并冲突将不可避免地出现。你可能会在一些常见的文件上有冲突，比如<code class="fe no np nq nr b">dbt_project.profile</code>、<code class="fe no np nq nr b">README.md</code>、<code class="fe no np nq nr b">gitignore</code>，当然还有<code class="fe no np nq nr b">_sources.yml</code>。</p><p id="69d2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">保持冷静，解决冲突。</p><p id="e66d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">起初，手动修复每个冲突可能是好的。在迁移了一些回购之后，您可能只想保留文件的mono回购版本。这可以用一个简单的<code class="fe no np nq nr b">git checkout --ours &lt;my-file&gt;</code>来完成。</p><h1 id="2bf7" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ng mb mc md nh mf mg mh ni mj mk ml bi translated">🩺有严格的审查程序</h1><p id="3ea5" class="pw-post-body-paragraph kg kh it ki b kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">迁移许多repos都与协作和协调有关。因此，你需要一个首要任务是协调团队成员努力的人。</p><p id="9e3a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个人(可能是团队领导或者准备迁移的人)应该主要关注于确保贡献符合指导方针。只有这个特定的人有批准的权限来确保合并的PRs的一致性是一个好主意。</p><p id="0216" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你是这样的人，在回顾一份简历时，问自己以下几个问题:</p><ul class=""><li id="c9da" class="mr ms it ki b kj kk kn ko kr mt kv mu kz mv ld mw mx my mz bi translated">团队惯例(即命名惯例、文件夹结构等)是否得到尊重？</li><li id="0788" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">关键<a class="ae kf" href="#0d09" rel="noopener ugc nofollow">要求</a>是否得到满足？</li></ul><p id="414f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你还需要扮演一点飞行控制员的角色。因为你的团队非常活跃，公关会像蘑菇一样冒出来。当一些PRs被合并时，其他合并冲突将出现在剩余的PRs上。为了避免陷入长期合并冲突的无限循环，您的工作是协调合并，并为Bob的合并开绿灯，同时让Alice和Joe等待一分钟。</p><h1 id="25be" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ng mb mc md nh mf mg mh ni mj mk ml bi translated">🍻Slim CI管道是您的朋友</h1><p id="44c8" class="pw-post-body-paragraph kg kh it ki b kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">因为你是一个谨慎的人，你要确保公关没有破坏下游的任何模型。dbt提供了这个漂亮的webhook，它可以在打开PR时触发CI管道。由于您的mono repo的规模将会增长，为每个PR执行完整构建可能不是最好的主意，这将花费太长时间。</p><p id="aaa0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">相反，你应该利用所谓的<a class="ae kf" href="https://docs.getdbt.com/docs/deploy/cloud-ci-job#configuring-a-dbt-cloud-ci-job" rel="noopener ugc nofollow" target="_blank">瘦CI </a>功能。它允许您仅运行已修改的模型及其下游从属模型。唯一的缺点是，你需要一个最初的成功运行被用作延期(即运行用于进行比较)。请注意，您可以使用以前的CI作业作为延期。然而，这个选项对我们来说并不那么有效。当并行打开太多PRs时，dbt不知道使用哪个临时数据集作为参考。作为替代，我建议尽快执行mono-repo的生产运行(如果您想确保不破坏生产数据中的某些内容，可能只需更改目标数据库)，并以此作为参考。</p><h1 id="1295" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ng mb mc md nh mf mg mh ni mj mk ml bi translated">总结想法</h1><p id="05bf" class="pw-post-body-paragraph kg kh it ki b kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">在开始迁移之前，对于单一回购方法的好处仍有一些疑问。合并冲突会不会变得有些频繁以至于每次公关都变成噩梦？我们要永远等着CI管道完工吗？<br/>搬家几周后，我必须说这些问题并没有变成具体的问题。单一回购的好处显然是值得投资的，dbt有充分的理由强烈支持这一方法。<br/>话虽如此，但在数据世界里，往往没有放之四海而皆准的东西。对我的团队(只有4个人，大部分使用中等大小的桌子，但是来自很多不同的来源)来说效果很好的东西对你来说可能并不理想。在开始这种迁移之前，最好先进行尽职调查。</p></div></div>    
</body>
</html>