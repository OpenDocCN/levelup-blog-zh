<html>
<head>
<title>Learn advanced MongoDB queries for nested documents from practical examples</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从实际例子中学习嵌套文档的高级MongoDB查询</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/learn-advanced-mongodb-queries-for-nested-documents-using-elemmatch-from-practical-examples-ec432efc2c0f?source=collection_archive---------3-----------------------#2022-02-27">https://levelup.gitconnected.com/learn-advanced-mongodb-queries-for-nested-documents-using-elemmatch-from-practical-examples-ec432efc2c0f?source=collection_archive---------3-----------------------#2022-02-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="12da" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">学习MongoDB中的elemMatch操作符</h2></div><p id="37bf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">MongoDB是一个开源的面向文档的NoSQL数据库。我们已经介绍了<a class="ae le" href="https://medium.com/codex/learn-the-essentials-and-get-started-with-mongodb-8380026642d5" rel="noopener">如何使用</a> <code class="fe lf lg lh li b"><a class="ae le" href="https://medium.com/codex/learn-the-essentials-and-get-started-with-mongodb-8380026642d5" rel="noopener">mongosh</a></code> <a class="ae le" href="https://medium.com/codex/learn-the-essentials-and-get-started-with-mongodb-8380026642d5" rel="noopener">在控制台中运行基本的CRUD命令</a>。此外，我们还介绍了如何使用<a class="ae le" href="https://medium.com/codex/how-to-use-mongodb-atlas-to-manage-your-server-and-data-d97a6e7663c5" rel="noopener"> MongoDB Atlas </a>来托管您的MongoDB服务器和数据。在本文中，我们将更进一步，从实际例子中学习使用<code class="fe lf lg lh li b">$elemMatch</code>操作符对嵌套文档进行高级MongoDB查询。我们仍将使用<code class="fe lf lg lh li b">mongosh</code>在控制台中运行查询，因此您不需要额外安装任何东西。但是，如果您喜欢在可视化环境中工作，您可以使用MongoDB 的<a class="ae le" href="https://medium.com/codex/how-to-use-mongodb-with-graphical-ides-420597ede80e" rel="noopener">图形IDE。</a></p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lj"><img src="../Images/6c6e3118e20e36ec069290acafe7cf28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7wd-p1K6-jFhW17G.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">图片来自<a class="ae le" href="https://pixabay.com/vectors/mango-funny-alive-the-fruit-juicy-1431418/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>。</figcaption></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="4877" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们开始这个高级旅程之前，我们应该有一个可用的MongoDB服务器。您可以<a class="ae le" href="https://medium.com/codex/learn-the-essentials-and-get-started-with-mongodb-8380026642d5" rel="noopener">使用Docker </a>在容器中启动一个MongoDB服务器，或者<a class="ae le" href="https://medium.com/codex/how-to-use-mongodb-atlas-to-manage-your-server-and-data-d97a6e7663c5" rel="noopener">使用MongoDB Atlas </a>启动一个由Atlas托管和维护的服务器。为了简单起见，我们将在本文中使用Docker容器，但是您可以自由选择您喜欢的容器。为MongoDB启动Docker容器的命令是:</p><pre class="lk ll lm ln gt mg li mh mi aw mj bi"><span id="7d57" class="mk ml it li b gy mm mn l mo mp">$ docker network create mongo-net</span><span id="14a1" class="mk ml it li b gy mq mn l mo mp">$ docker run --detach --network mongo-net --name mongo-server \<br/>    --env MONGO_INITDB_ROOT_USERNAME=admin \<br/>    --env MONGO_INITDB_ROOT_PASSWORD=pass \<br/>    --env MONGO_INITDB_ROOT_DATABASE=admin \<br/>    --volume mongo-data:/data/db \<br/>    --publish 27017:27017 \<br/>    mongo:5.0.6</span></pre><p id="1490" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以在你的电脑上安装 <code class="fe lf lg lh li b"><a class="ae le" href="https://docs.mongodb.com/mongodb-shell/install/#std-label-mdb-shell-install" rel="noopener ugc nofollow" target="_blank">mongosh</a></code>或者使用Docker容器自带的:</p><pre class="lk ll lm ln gt mg li mh mi aw mj bi"><span id="f53f" class="mk ml it li b gy mm mn l mo mp">$ docker exec -it mongo-server bash<br/>$ mongosh "mongodb://admin:pass@localhost:27017"</span></pre><p id="9875" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们可以使用<code class="fe lf lg lh li b">mongosh</code>开始使用MongoDB数据库了。如果这是你第一次使用<code class="fe lf lg lh li b">mongosh</code>，建议你<a class="ae le" href="https://medium.com/codex/learn-the-essentials-and-get-started-with-mongodb-8380026642d5" rel="noopener">先查看这篇介绍性文章</a>，这样你就不会迷失在高级查询中。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="1330" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇文章中，我们将使用一些笔记本电脑网上商店的产品数据，如Elasticsearch 的<a class="ae le" href="https://medium.com/codex/learn-elasticsearch-from-practical-examples-495f2f8db83e" rel="noopener">文章所示。您可以下载这个JSON文件</a>来获得将要使用的原始数据。</p><p id="6cd9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你像我一样使用Docker容器内部的<code class="fe lf lg lh li b">mongosh</code>，你需要将JSON文件复制到容器中:</p><pre class="lk ll lm ln gt mg li mh mi aw mj bi"><span id="8970" class="mk ml it li b gy mm mn l mo mp">$ <strong class="li iu">docker cp ./laptops_demo_for_mongodb.json mongo-server:/</strong></span></pre><p id="2199" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你使用安装在你电脑上的<code class="fe lf lg lh li b">monosh</code>，你需要在你当前的工作目录中有这个JSON文件。然后，我们可以加载这个文件，并将所有文档插入到一个集合中:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="434c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上述代码的要点:</p><ul class=""><li id="1be4" class="mt mu it kk b kl km ko kp kr mv kv mw kz mx ld my mz na nb bi translated">我们使用<code class="fe lf lg lh li b">use products</code>来声明一个名为<code class="fe lf lg lh li b">products</code>的MongoDB数据库，当一个文档被插入其中的一个集合时，就会创建这个数据库。</li><li id="131c" class="mt mu it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">JSON数据由<code class="fe lf lg lh li b">require</code>命令加载。并且加载的数据是可以被<code class="fe lf lg lh li b">insertMany()</code>方法直接使用的格式。笔记本电脑的数据被插入到一个名为<code class="fe lf lg lh li b">laptops</code>的集合中。</li><li id="41dd" class="mt mu it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated"><code class="fe lf lg lh li b">countDocuments()</code>用于检查集合中的文档数量，而<code class="fe lf lg lh li b">findOne()</code>方法用于显示集合中的第一个文档。</li></ul><p id="86c7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在数据已经准备好了，我们可以开始为它编写一些查询。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="3853" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如我们所见，<code class="fe lf lg lh li b">laptops</code>集合中的笔记本文档有一个<code class="fe lf lg lh li b">attributes</code>字段，它是一个嵌入文档的数组。查询和更新这样的字段比简单的非嵌套字段更复杂。</p><p id="85e5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们来找出所有CPU为<code class="fe lf lg lh li b">Intel Core i7–8550U</code>的笔记本电脑。这应该很简单，因为CPU是明确的:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="12b7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，嵌套字段是用点符号查询的，必须用引号括起来。如果你喜欢用图形IDE编写跨多行的查询，请参考<a class="ae le" href="https://medium.com/codex/how-to-use-mongodb-with-graphical-ides-420597ede80e" rel="noopener">这篇关于MongoDB IDE的文章</a>。</p><p id="8209" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们应该得到我们想要的结果，因为在<code class="fe lf lg lh li b">attributes</code>数组中只有一个嵌套文档具有CPU型号的值:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="ea8a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在让我们找出所有内存为16GB的笔记本电脑。凭直觉，您可能希望使用如下查询:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="b55f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当执行上述查询时，似乎返回了所有内存为16GB的笔记本电脑:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="e11a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然而，这是许多MongoDB初学者犯错误的地方，也是一些bug被引入您的代码的地方。如果您在<code class="fe lf lg lh li b">mongosh</code>中输入“it”以显示更多结果，或者使用IDE向下滚动到结果页面的底部并仔细检查，您会发现一些奇怪的事情:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="7510" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过上面的查询，我们得到了16GB的笔记本电脑！这是因为上面的查询找到的文档中，<code class="fe lf lg lh li b">attributes</code>数组至少有一个包含字段<code class="fe lf lg lh li b">attribute_name</code>等于<code class="fe lf lg lh li b">memory</code>的嵌入文档，以及至少有一个包含字段<code class="fe lf lg lh li b">attribute_value</code>等于<code class="fe lf lg lh li b">16GB</code>的嵌入文档(但不一定是同一个嵌入文档)。</p><p id="73b7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于所有的<code class="fe lf lg lh li b">attributes</code>数组都有一个<code class="fe lf lg lh li b">attribute_name</code>为<code class="fe lf lg lh li b">memory</code>的嵌入文档，上面的查询给出了错误的结果。我们想要的是，对于同一个嵌入文档，这两个条件都应该满足。为了实现这一点，我们不能按如上所示的点符号进行查询，而是需要使用<code class="fe lf lg lh li b">$elemMatch</code>操作符:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="a7bb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这一次存储为16GB但内存不是16GB的笔记本电脑将不会被退回。如果您不相信，您可以计算两个查询返回的文档数:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="bdaa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在让我们尝试一个更复杂的例子，找出所有内存为16GB、存储容量为1TB的笔记本电脑。我们需要使用<code class="fe lf lg lh li b">$and</code>操作符来指定两个嵌套文档的条件，这非常类似于<code class="fe lf lg lh li b">bool</code>和<code class="fe lf lg lh li b">must</code>关键字在<a class="ae le" href="https://lynn-kwong.medium.com/learn-advanced-crud-and-search-queries-for-nested-objects-in-elasticsearch-from-practical-examples-7aebc1408d6f" rel="noopener">嵌套文档</a>查询中的用法。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="acf2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该查询将返回我们想要的结果:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="b497" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意，尽管<code class="fe lf lg lh li b">$and</code>操作符是MongoDB中的默认操作符，但它在这里是强制的，因为我们在两种不同的条件下查询同一个字段。否则，我们将只按第二个条件进行查询，并将得到不正确的结果:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="aa00" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这种情况下，您将得到一个不正确的结果。如果你尝试其他条件，你会得到更多不正确的结果。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="1bb0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦您知道如何查询包含嵌套文档的数组，更新它应该相当容易。请注意，嵌套文档在数组中是有序的，因此您可以通过索引位置来访问嵌套文档。</p><p id="efe3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们将笔记本电脑的内存更新为16GB，其中<code class="fe lf lg lh li b">_id</code>等于1:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="b57b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们现在检查这台笔记本电脑，它的属性应该已经更新:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="c5e3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里我们使用投影来显示文档的<code class="fe lf lg lh li b">attributes</code>字段:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="4330" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">干杯！嵌套文档更新成功！</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="88e7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇文章中，我们介绍了如何在MongoDB中查询和更新一组嵌套文档。这是一种高级用法，但在实践中很常见。我相信你现在对在工作中处理这类问题相当有信心。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="d326" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">相关文章:</p><ul class=""><li id="862b" class="mt mu it kk b kl km ko kp kr mv kv mw kz mx ld my mz na nb bi translated"><a class="ae le" href="https://lynn-kwong.medium.com/learn-the-essentials-and-get-started-with-mongodb-8380026642d5?source=your_stories_page----------------------------------------" rel="noopener">学习基础知识并开始使用MongoDB </a></li><li id="67d8" class="mt mu it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated"><a class="ae le" href="https://lynn-kwong.medium.com/all-you-need-to-know-about-using-mongodb-in-python-caa077c9a20f?source=your_stories_page----------------------------------------" rel="noopener">关于在Python中使用MongoDB你需要知道的一切</a></li></ul></div></div>    
</body>
</html>