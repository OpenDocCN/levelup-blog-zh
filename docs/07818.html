<html>
<head>
<title>Lesser-Known Superpowers of SSH</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">宋承宪鲜为人知的超能力</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/lesser-known-superpowers-of-ssh-cda63b35d576?source=collection_archive---------1-----------------------#2021-03-13">https://levelup.gitconnected.com/lesser-known-superpowers-of-ssh-cda63b35d576?source=collection_archive---------1-----------------------#2021-03-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="367a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">壳牌超级英雄</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/33f691422a9c61f7300c195aa50b2d7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FhagLHJWgTvk-InHAYxR8w.png"/></div></div></figure><p id="28a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你正在读这篇文章，你可能以前用过<code class="fe kx ky kz la b">ssh</code>。您<em class="lb">可能</em>使用它安全地登录到远程机器。毕竟，这是<code class="fe kx ky kz la b">ssh</code>最初的用例，也是它名字的由来——为<code class="fe kx ky kz la b">telnet</code>提供一个安全的替代方案。</p><p id="f038" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它在公共互联网的蛮荒西部，通过最令人震惊的公司代理，在家庭网络的围墙花园内，甚至在<code class="fe kx ky kz la b">lo</code>界面的内省渴望中执行这一重要任务。它是开源的，受欢迎的，由软件领域中最有安全意识的项目之一拥有和开发。它已经经历了超过25年的历史、安全审计和多种平台。当您使用<code class="fe kx ky kz la b">[user@]server:project.git</code>作为遥控器与<code class="fe kx ky kz la b">git</code>库交互时，也会用到它。</p><p id="d7f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太酷了。它做它的工作。</p><p id="c4b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，我在这里讨论它的其他超能力，你可能不知道。</p><h1 id="7d4e" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">超能力:从服务器复制文件</h1><p id="f568" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">如果你是软件开发人员，你可能已经用过<code class="fe kx ky kz la b">scp</code>和<code class="fe kx ky kz la b">sftp</code>。这些包含在大多数OpenSSH安装中，并且是您的工具包中的基本项目。</p><p id="d5e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe kx ky kz la b">scp</code>安全地来回复制文件与使用<code class="fe kx ky kz la b">cp</code>非常相似。唯一的区别是为服务器目标添加了一些语法。</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="6327" class="mj ld iq la b gy mk ml l mm mn">scp local/file.txt user@server:/remote/directory/</span><span id="e03c" class="mj ld iq la b gy mo ml l mm mn">scp user@server:/remote/directory/file.txt local/file.txt</span></pre><p id="9e4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Pro提示:</strong>第一次使用<code class="fe kx ky kz la b">scp</code>将您的公钥复制到远程服务器。下面将确保远程服务器创建了具有适当权限的源目录，然后将您的公钥复制到其中。此后，如果服务器支持，您在以后的登录中将不再需要您的密码。</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="101a" class="mj ld iq la b gy mk ml l mm mn">ssh user@server -- install -dm 700 ~/.ssh</span><span id="afa9" class="mj ld iq la b gy mo ml l mm mn">scp ~/.ssh/id_rsa.pub user@server:~/.ssh/authorized_keys</span></pre><p id="3c5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Pro提示:</strong>如果您使用较新的terminfo文件，如<code class="fe kx ky kz la b">TERM=tmux-256color</code>或<code class="fe kx ky kz la b">TERM=alacritty</code>，远程服务器可能不知道如何识别您终端的功能。打开<code class="fe kx ky kz la b">less</code>或<code class="fe kx ky kz la b">vim</code>时，您可能会得到错误提示，提示“未使用全功能终端”使用下面的一行程序来纠正它:</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="ab3c" class="mj ld iq la b gy mk ml l mm mn">infocmp | ssh user@host -- tic -</span></pre><p id="a4d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注销远程服务器并重新登录，它应该能正确识别您的终端模拟器。<code class="fe kx ky kz la b">infocmp</code>将获取当前终端的能力，并将它们转储到STDOUT。<code class="fe kx ky kz la b">tic -</code>将从STDIN中读取终端能力并编译到<code class="fe kx ky kz la b">$HOME/.terminfo</code>中。这两个工具都包含在<code class="fe kx ky kz la b">ncurses</code>中，默认情况下，它安装在几乎所有基于Unix的系统上。</p><h1 id="2d11" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">超级大国:轻量级浏览器VPN</h1><p id="9f25" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">如果你被困在禁止性的公司防火墙后面(但是SSH是允许的)，或者你想要一个穷人的VPN通过远程服务器，有一个有用的规避措施。</p><p id="b153" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，使用<code class="fe kx ky kz la b">ssh</code>设置一个通过远程服务器的本地SOCKS代理:</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="0f10" class="mj ld iq la b gy mk ml l mm mn">ssh -NTD 1080 user@server</span></pre><ul class=""><li id="a123" class="mp mq iq jp b jq jr ju jv jy mr kc ms kg mt kk mu mv mw mx bi translated"><code class="fe kx ky kz la b">-N</code>为非交互式。这使得Ctrl-C和结束它变得很容易。</li><li id="b8dc" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated"><code class="fe kx ky kz la b">-T</code>防止在遥控器上分配不需要的伪终端。</li><li id="b04c" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated"><code class="fe kx ky kz la b">-D</code>指定SOCKS代理在本地监听的端口。本例中使用了<code class="fe kx ky kz la b">1080</code>。</li></ul><p id="0ec6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在应该有一个SOCKS代理运行在您的本地机器上，您可以配置您的web浏览器来引导所有流量通过。您在浏览器中的internet状态将显示为来自您在命令中使用的服务器。本地网络环境看到的只是通过SSH离开机器的加密流量。</p><p id="323d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">火狐</strong></p><p id="326f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要配置Firefox使用您的代理，请前往<strong class="jp ir">首选项&gt;网络设置&gt;设置… </strong></p><p id="7cde" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将打开一个<strong class="jp ir">连接设置</strong>模式。您需要选择<strong class="jp ir">手动代理配置</strong>单选按钮。除了以下内容之外，将所有内容留空:</p><ul class=""><li id="e171" class="mp mq iq jp b jq jr ju jv jy mr kc ms kg mt kk mu mv mw mx bi translated"><strong class="jp ir">袜子主持人</strong> : <code class="fe kx ky kz la b">localhost</code></li><li id="a85f" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated"><strong class="jp ir">端口</strong> : <code class="fe kx ky kz la b">1080</code></li><li id="ab55" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">检查<strong class="jp ir"> SOCKS v5 </strong>单选按钮</li><li id="7548" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">使用SOCKS v5 时检查<strong class="jp ir">代理DNS。</strong></li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nd"><img src="../Images/d01842d3d0adeaf8073249cb4553a41a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uB1AHNlRRyV-zGyO9zf1IA.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">网络设置模式</figcaption></figure><p id="ed18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样！刷新任何标签并继续在Firefox中浏览，所有的网络流量都将通过SSH进行代理。如果你有SSH代理，返回<strong class="jp ir">网络设置</strong>配置并选择<strong class="jp ir">无代理</strong>。</p><p id="2f11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Chrome、Edge、Safari等其他浏览器的代理设置比较复杂，这里不做介绍。</p><h1 id="5c98" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">超级大国:通过公司代理导航</h1><p id="3c08" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">一些工作环境已经实施了互联网代理。它们可能允许端口80和443用于常规的浏览器流量，但默认情况下会阻止其他所有流量。很多时候，如果你友好地请求他们，这些公司代理会让你通过，而默认情况下SSH不知道怎么做。</p><p id="5629" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们假设您的工作场所在<code class="fe kx ky kz la b">proxyport</code>的<code class="fe kx ky kz la b">proxyhost</code>有一个公司代理。当你试图单独使用<code class="fe kx ky kz la b">ssh</code>时，它要么挂起，要么给你一个无法连接到你的服务器的错误。但是让我们告诉宋承宪如何礼貌地请求公司代理让我们通过。</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="dee2" class="mj ld iq la b gy mk ml l mm mn">ssh -o ProxyUseFdpass=yes \<br/>    -o ProxyCommand="nc -F -X 5 proxyhost:proxyport %h %p" \<br/>    user@server</span></pre><p id="de4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将告诉<code class="fe kx ky kz la b">ssh</code>在<code class="fe kx ky kz la b">proxyhost:proxyport</code>请求<code class="fe kx ky kz la b">nc</code>通过公司代理执行连接请求，并将结果隧道传递回<code class="fe kx ky kz la b">ssh</code>。</p><p id="6d5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想让这个对这台机器上特定主机的所有SSH命令永久有效，你可以把它添加到<code class="fe kx ky kz la b">~/.ssh/config</code>中，以避免每次都使用<code class="fe kx ky kz la b">-o</code>选项。</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="4d7d" class="mj ld iq la b gy mk ml l mm mn">Host example.com<br/>  ProxyUserFdpass yes<br/>  ProxyCommand    nc -F -X 5 proxyhost:proxyport %h %p</span></pre><p id="cff7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果需要，这种超能力可以与这里的许多其他超能力结合起来。</p><h1 id="414e" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated"><strong class="ak">超能力:远程</strong> <code class="fe kx ky kz la b"><strong class="ak">sudo</strong></code> <strong class="ak">一次性命令</strong></h1><p id="fce4" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">这是一种常见的模式</p><ol class=""><li id="f0d9" class="mp mq iq jp b jq jr ju jv jy mr kc ms kg mt kk ni mv mw mx bi translated"><code class="fe kx ky kz la b">ssh</code>远程服务器上</li><li id="cd5d" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk ni mv mw mx bi translated"><code class="fe kx ky kz la b">sudo</code>单一命令</li><li id="cc13" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk ni mv mw mx bi translated">输入你的密码</li><li id="e068" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk ni mv mw mx bi translated"><code class="fe kx ky kz la b">logout</code>或<code class="fe kx ky kz la b">exit</code>之后</li></ol><p id="b339" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以组合这些步骤，并使用<code class="fe kx ky kz la b">-tt</code>跳过调用和退出shell</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="f8a9" class="mj ld iq la b gy mk ml l mm mn">ssh -tt user@server -- sudo some-command</span></pre><p id="c734" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将从遥控器的<code class="fe kx ky kz la b">sudo</code>得到密码提示，但之后它将完成并退出。</p><h1 id="9255" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">超级大国:本地可用的远程服务</h1><p id="0bfc" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">假设您有一个运行在远程服务器上的服务，比如web服务器，但是它只在<code class="fe kx ky kz la b">localhost:80</code>可用。您可以使用<code class="fe kx ky kz la b">ssh</code>通过端口转发使该服务在您本地机器上可用。</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="d01d" class="mj ld iq la b gy mk ml l mm mn">ssh -L 8080:localhost:80 user@server</span></pre><p id="873b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">格式为<code class="fe kx ky kz la b">-L &lt;tunnel port&gt;:&lt;destination&gt;:&lt;destination port&gt;</code>。在这种情况下，我们希望服务器上的<code class="fe kx ky kz la b">localhost:80</code>在使用相同端口号的本地机器上可用。你现在应该能够对本地机器的<code class="fe kx ky kz la b">localhost:8080</code>执行操作，就像你在远程服务器上点击<code class="fe kx ky kz la b">localhost:80</code>一样！</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="3aa4" class="mj ld iq la b gy mk ml l mm mn"> ┌──────────────────────┐<br/> │        localhost:80  │<br/> │               ▲      │<br/> │server         │      │<br/> └────────────┬──┼──┬───┘<br/>              │  │  │<br/>   ssh tunnel │  │  │<br/>              │  │  │<br/> ┌────────────┴──┼──┴───┐<br/> │local          │      │<br/> │               |      │<br/> │ ────► localhost:8080 │<br/> └──────────────────────┘</span></pre><h1 id="5cfa" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">超级能力:将本地服务转发到远程</h1><p id="cf95" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">反过来也是可能的。您可以将仅在本地计算机上可用的服务转发到远程服务器。在这种情况下，请使用<code class="fe kx ky kz la b">-R</code>标志。在这种情况下，假设我们想要从端口<code class="fe kx ky kz la b">8888</code>上的远程服务器到达本地机器上监听<code class="fe kx ky kz la b">localhost:8080</code>的web服务器。</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="9fba" class="mj ld iq la b gy mk ml l mm mn">ssh -R 8888:localhost:8080 user@server</span></pre><p id="9825" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的语法是<code class="fe kx ky kz la b">-R &lt;tunnel port&gt;:&lt;destination&gt;:&lt;destination port&gt;</code></p><p id="cfb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，当我们在远程服务器上时，我们可以点击<code class="fe kx ky kz la b">localhost:8888</code>，就像我们在本地机器上点击端口<code class="fe kx ky kz la b">8080</code>一样。</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="95b6" class="mj ld iq la b gy mk ml l mm mn">┌──────────────────────┐<br/>│ ─────► localhost:8888│<br/>│               │      │<br/>│remote         │      │<br/>└────────────┬──┼──┬───┘<br/>             │  │  │<br/>  ssh tunnel │  │  │<br/>             │  │  │<br/>┌────────────┴──┼──┴───┐<br/>│local          │      │<br/>│               ▼      │<br/>│       localhost:8080 │<br/>└──────────────────────┘</span></pre><h1 id="e406" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">超级大国:修改已建立的连接</h1><p id="0b86" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">SSH支持一些交互式命令来修改现有的连接。一个常见的例子是一个连接已经冻结，您无法断开。可以打<code class="fe kx ky kz la b">&lt;ENTER&gt;~.</code>；这三个键，按照这个顺序，强制断开连接！您还可以将<code class="fe kx ky kz la b">ssh</code>放在后台，列出、添加和删除端口转发。下面是SSH手册页的一个子集。</p><pre class="km kn ko kp gt mf la mg mh aw mi bi"><span id="8bb6" class="mj ld iq la b gy mk ml l mm mn">~.      Disconnect.<br/>~^Z     Background ssh.<br/>~#      List forwarded connections.<br/>~?      Display a list of escape characters.</span><span id="63c0" class="mj ld iq la b gy mo ml l mm mn">~C      Open command line.  Currently this allows the addition of<br/>        port forwardings using the -L, -R and -D options. It also<br/>        allows the cancellation of existing port-forwardings with<br/>        -KL[bind_address:]port for local, -KR[bind_address:]port for<br/>        remote and -KD[bind_address:]port for dynamic port<br/>        -forwardings. !command allows the user to execute a local<br/>        command if the PermitLocalCommand option is enabled in<br/>        ssh_config(5).  Basic help is available, using the -h<br/>        option.</span></pre><h1 id="2ee1" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">结论</h1><p id="dd20" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">使用<code class="fe kx ky kz la b">ssh</code>你还可以做其他的事情，还有很多其他的系统和工具利用它的能力来创建安全的连接。本文坚持使用OpenSSH包含的特性，但是一个这样的例子是<a class="ae nj" href="https://github.com/libfuse/sshfs" rel="noopener ugc nofollow" target="_blank"> sshfs </a>来挂载远程文件系统；它在大多数Linux发行版、BSD版本和MacOS中都可用(通过<code class="fe kx ky kz la b">brew</code>)。</p><p id="8af2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">黑客快乐！</p></div></div>    
</body>
</html>