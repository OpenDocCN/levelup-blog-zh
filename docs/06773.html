<html>
<head>
<title>Concurrency, Bugs and Databases</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">并发性、错误和数据库</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/concurrency-bugs-and-databases-e798596e083b?source=collection_archive---------3-----------------------#2020-12-30">https://levelup.gitconnected.com/concurrency-bugs-and-databases-e798596e083b?source=collection_archive---------3-----------------------#2020-12-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/805c176f3839b94d602b9e8a0198b065.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*Yp2SBVJ_Nj3erNruo3gJyQ.jpeg"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">鸣谢:谷歌</figcaption></figure><p id="916d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi kw translated"><span class="l kx ky kz bm la lb lc ld le di"> D </span>数据库有许多隔离级别，每一个都提供某种保证。例如，<em class="lf">快照隔离</em>保护我们免受幻影读取。然而，隔离级别并不能保护我们免受任何攻击。让我们讨论几个现实世界中并发可能导致错误的场景及其可能的解决方案。</p><blockquote class="lg lh li"><p id="52e1" class="jy jz lf ka b kb kc kd ke kf kg kh ki lj kk kl km lk ko kp kq ll ks kt ku kv ij bi translated">READ_COMMIT是postgres中默认的隔离级别。你可以在这里阅读隔离级别<a class="ae lm" href="https://blog.gojekengineering.com/on-concurrency-control-in-databases-1e34c95d396e" rel="noopener ugc nofollow" target="_blank"/></p></blockquote><blockquote class="ln"><p id="7ebe" class="lo lp iq bd lq lr ls lt lu lv lw kv dk translated">案例1:假设你正在<em class="lx">预定我的节目</em>试图预定你下一部电影的门票。你和X先生为一场演出选择了相同的座位，然后去结账。理想情况下，你们中只有一个人可以订票。然而，有没有可能你们两个都能订到一模一样的座位？</p></blockquote><figure class="lz ma mb mc md jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ly"><img src="../Images/eabe34aceddbfb066f0c9bf2a0872ab9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q5bMIoU4wnbd2jC7FuDD-A.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">座位安排视图</figcaption></figure><h1 id="6c5a" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated"><strong class="ak"> <em class="lx">所涉及的步骤</em> </strong></h1><ol class=""><li id="558d" class="ng nh iq ka b kb ni kf nj kj nk kn nl kr nm kv nn no np nq bi translated">检查一下座位是否有空</li><li id="ee6f" class="ng nh iq ka b kb nr kf ns kj nt kn nu kr nv kv nn no np nq bi translated">如果是，将它们分配给当前用户并通知用户</li></ol><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nw"><img src="../Images/d793c805930699c6dff80f88fbaad55d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RrmheWvxCzWFLKoQ06yorg.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">预订系统</figcaption></figure><blockquote class="lg lh li"><p id="b4d8" class="jy jz lf ka b kb kc kd ke kf kg kh ki lj kk kl km lk ko kp kq ll ks kt ku kv ij bi translated">这个模型只是为了演示手头的问题</p></blockquote><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="878d" class="og mj iq oc b gy oh oi l oj ok">## Psuedo code for booking </span><span id="0927" class="og mj iq oc b gy ol oi l oj ok">if (seatsAvailable(List&lt;Seats&gt; selectedSeats)) {<br/>    bookTickets(selectedSeats);<br/>    sendEmailNotification(customer_id);<br/>}</span><span id="9d08" class="og mj iq oc b gy ol oi l oj ok">// These are two individual transactions from db point of view</span><span id="61e9" class="og mj iq oc b gy ol oi l oj ok">seatsAvailable() {<br/>  Select booked from booking where seats = 'H3';<br/>  return !booked;<br/>}</span><span id="733d" class="og mj iq oc b gy ol oi l oj ok">bookTickets() {<br/>  update booking set customer_id = '123' and booked = 't' where<br/>  seats = 'H3';<br/>}</span></pre><h1 id="fefd" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">问题</h1><p id="bccc" class="pw-post-body-paragraph jy jz iq ka b kb ni kd ke kf nj kh ki kj om kl km kn on kp kq kr oo kt ku kv ij bi translated">如果两个并发事务试图更新预订，那么它们都会成功。这将是一个问题，因为我们最终会通知多个用户预订成功。</p><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi op"><img src="../Images/f95641241c26b9eab6a41dec448e4ac1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rpRq1XZpkKlLxIPuZjkEuw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">并发事务1成功更新预订</figcaption></figure><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi op"><img src="../Images/0711a8fb99282179882c54bc33e1137b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z8OqjzfMR8RMiWqjXpqH_A.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">并发事务2成功更新预订</figcaption></figure><h1 id="c918" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated"><strong class="ak"> <em class="lx">解</em> </strong></h1><ol class=""><li id="8d65" class="ng nh iq ka b kb ni kf nj kj nk kn nl kr nm kv nn no np nq bi translated">将<em class="lf"> SELECT </em>替换为<em class="lf">select for update—</em>SELECT和SELECT FOR UPDATE的区别在于，SELECT FOR UPDATE锁定作为查询响应返回的行。这意味着在持有锁的事务提交/中止之前，任何其他事务都不能对这些行进行任何更改。</li></ol><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="a4b7" class="og mj iq oc b gy oh oi l oj ok">// This is a single transaction from db point of view</span><span id="8c57" class="og mj iq oc b gy ol oi l oj ok">begin;<br/>seatsAvailable() -&gt; Select * from booking where seats = 'H3' FOR UPDATE;</span><span id="3b1d" class="og mj iq oc b gy ol oi l oj ok">bookTickets() -&gt; update booking set customer_id = '123' and booked = 't' where seats = 'H3';<br/>commit;</span></pre><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi oq"><img src="../Images/667eb6a9de52dac383309345126a1a82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JK2kN71Ow5ZxJWZvQzRnIg.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">并发事务1更新预订</figcaption></figure><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi or"><img src="../Images/0562f56973274c80812697b6d9d2cd94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z8ZDGzTTP36fTnARTS3e8Q.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">并发事务2将无法更新预订</figcaption></figure><p id="4810" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二个事务将在应用层失败，因为当我们检查将返回false的条件<code class="fe os ot ou oc b">if booked = false</code>时。</p><blockquote class="lg lh li"><p id="93ca" class="jy jz lf ka b kb kc kd ke kf kg kh ki lj kk kl km lk ko kp kq ll ks kt ku kv ij bi translated">在两个不同的事务中使用SELECT FOR UPDATE和UPDATE将产生与使用SELECT and UPDATE相同的结果</p></blockquote><p id="2a0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.使它成为原子的--这将涉及到用一个更新语句代替get和update。</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="66bf" class="og mj iq oc b gy oh oi l oj ok">update booking set user_id = '123' and booked = 't' where seats = 'H3' and booked = 'f';</span></pre><blockquote class="lg lh li"><p id="1cfd" class="jy jz lf ka b kb kc kd ke kf kg kh ki lj kk kl km lk ko kp kq ll ks kt ku kv ij bi translated">他的方法可能不适用于每一个用例。</p></blockquote><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ov"><img src="../Images/7ad123a5cecccea417f4ec457f063b03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BmjiLjOR2Ce1UEEDmBiY-g.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">并发事务1未能更新预订</figcaption></figure><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ow"><img src="../Images/fce75acd7ed1c0543cf01300d87fee18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ojtK0W895PCBhpVBks4iMw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">并发事务2成功更新预订</figcaption></figure><p id="7199" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您想知道为什么这样做，这是因为当多个事务试图更新同一行时，它们会对该行进行独占锁定，只有在其中一个事务提交/中止后，下一个事务才有机会运行。</p></div><div class="ab cl ox oy hu oz" role="separator"><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc"/></div><div class="ij ik il im in"><blockquote class="ln"><p id="d56d" class="lo lp iq bd lq lr pe pf pg ph pi kv dk translated">情况2:考虑这样一种情况，您正试图购买价值超过您当前电子钱包余额的商品。是否有可能成功完成交易，从而使您的余额为负？</p></blockquote><h1 id="12fe" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt pj mv mw mx pk mz na nb pl nd ne nf bi translated"><strong class="ak"> <em class="lx">所涉及的步骤</em> </strong></h1><ol class=""><li id="3360" class="ng nh iq ka b kb ni kf nj kj nk kn nl kr nm kv nn no np nq bi translated">检查是否有足够的余额</li><li id="dca7" class="ng nh iq ka b kb nr kf ns kj nt kn nu kr nv kv nn no np nq bi translated">如果是，从用户余额中扣除金额</li></ol><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="3855" class="og mj iq oc b gy oh oi l oj ok">## Psuedo code for balance updates</span><span id="84f8" class="og mj iq oc b gy ol oi l oj ok">if(currentBalance() - cartAmount &gt; 0) {<br/>   deductBalance(); <br/>}</span><span id="b173" class="og mj iq oc b gy ol oi l oj ok">// These are two individual transactions from db point of view</span><span id="9aa1" class="og mj iq oc b gy ol oi l oj ok">currentBalance() -&gt; Select balance from account where custotmer_id = '1234';</span><span id="914f" class="og mj iq oc b gy ol oi l oj ok">deductBalance() -&gt; update account set balance = balance-cartAmount where customer_id = '1234';</span></pre><h1 id="7065" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">问题</h1><p id="81b0" class="pw-post-body-paragraph jy jz iq ka b kb ni kd ke kf nj kh ki kj om kl km kn on kp kq kr oo kt ku kv ij bi translated">如果有同时发生的交易，那么余额有可能变成负数。如你所见，你可以在350英镑的余额上花费460英镑，因为个人花费150英镑和310英镑比当时的当前余额少。</p><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi pm"><img src="../Images/685015a42360de6a609f5d55eb37fb6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xexX8FiNJANGy2NrGj-Jsg.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">在350英镑的余额上花费150英镑</figcaption></figure><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi pn"><img src="../Images/29353aac18ce2a33a5c855ed231c64b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ejmiR_56WvHYI57E3HoqFQ.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">在350英镑的余额上花费310英镑</figcaption></figure><h1 id="14bd" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">解决办法</h1><ol class=""><li id="1cc5" class="ng nh iq ka b kb ni kf nj kj nk kn nl kr nm kv nn no np nq bi translated">添加<em class="lf">列约束</em> —处理这个问题的一种方法是在balance列上添加一个约束，防止它变成负数。</li></ol><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="6d34" class="og mj iq oc b gy oh oi l oj ok">alter table account add constraint greater_than_0 check (balance &gt;= 0);</span><span id="2fc9" class="og mj iq oc b gy ol oi l oj ok">abc=# \d account<br/>                      Table "public.account"<br/>   Column    |       Type        | Collation | Nullable | Default<br/>-------------+-------------------+-----------+----------+---------<br/> customer_id | character varying |           |          |<br/> balance     | numeric           |           |          |<br/>Check constraints:<br/>    "greater_than_0" CHECK (balance &gt;= 0::numeric)<br/></span></pre><blockquote class="lg lh li"><p id="3af9" class="jy jz lf ka b kb kc kd ke kf kg kh ki lj kk kl km lk ko kp kq ll ks kt ku kv ij bi translated">这个模型只是为了演示手头的问题</p></blockquote><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi pn"><img src="../Images/51c3d760eec8f3cb2409aa78e4243d29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bFf3dpDkudkctaTHLnJ-0A.png"/></div></div></figure><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi po"><img src="../Images/8dc00ee152890d36288148174bd861e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xrz07uA38DpuVqKX1FgYbg.png"/></div></div></figure><p id="62c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用这种方法，您也可以用一条update语句替换select和update语句。</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="75ad" class="og mj iq oc b gy oh oi l oj ok">update account set balance = balance-cartAmount where customer_id = '1234';</span></pre><p id="463a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，如果余额为负，您可以处理应用层抛出的异常。这可能不是最好的方法，因为它会将域逻辑泄露给数据库，而且您可能会遇到这样的情况，即拥有一个负余额是可以的，就像以后支付功能一样。</p><p id="6ec3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.<em class="lf">分布式锁定</em> —在执行任何操作之前锁定客户id。一旦我们获得了锁，我们就可以执行DB操作，并在操作完成时释放锁。这样，一次只能对该客户的钱包执行一个DB操作。这可能有点矫枉过正，但我们已经大大降低了问题的复杂性。现实生活中的应用程序在存钱方面有很多复杂性。</p><figure class="nx ny nz oa gt jr"><div class="bz fp l di"><div class="pp pq l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">使用Redis获取锁</figcaption></figure><p id="09ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.将<em class="lf"> SELECT </em>替换为<em class="lf">SELECT FOR UPDATE</em>—类似于案例1，我们可以将SELECT替换为SELECT FOR UPDATE，它锁定作为查询响应返回的行。</p><blockquote class="lg lh li"><p id="f2c5" class="jy jz lf ka b kb kc kd ke kf kg kh ki lj kk kl km lk ko kp kq ll ks kt ku kv ij bi translated"><em class="iq"> SELECT FOR UPDATE </em> <strong class="ka ir">不会</strong>阻止SELECT语句，只会阻止SELECT FOR UPDATE，UPDATE语句。</p></blockquote></div><div class="ab cl ox oy hu oz" role="separator"><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc"/></div><div class="ij ik il im in"><blockquote class="ln"><p id="50e8" class="lo lp iq bd lq lr pe pf pg ph pi kv dk translated">案例3:假设你的团队正在进行为期一周的生产支持。要求是至少有一个人应该始终支持。有没有可能，如果你和队友试图取消分配自我(假设另一个仍然可用)，那么就没有人支持了？</p></blockquote><h1 id="cfd0" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt pj mv mw mx pk mz na nb pl nd ne nf bi translated">涉及的步骤</h1><ol class=""><li id="70b1" class="ng nh iq ka b kb ni kf nj kj nk kn nl kr nm kv nn no np nq bi translated">检查支架上是否至少有2名成员</li><li id="563f" class="ng nh iq ka b kb nr kf ns kj nt kn nu kr nv kv nn no np nq bi translated">如果是，删除当前用户</li></ol><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="c8a8" class="og mj iq oc b gy oh oi l oj ok">## Psuedo code</span><span id="cf0c" class="og mj iq oc b gy ol oi l oj ok">if(totalMembersOnSupport() &gt; 1) {<br/>  removeFromSupport(user_id);<br/>}</span><span id="fe1f" class="og mj iq oc b gy ol oi l oj ok">totalMembersOnSupport() -&gt; Select count(user_id) from support where on_support = 't';</span><span id="de87" class="og mj iq oc b gy ol oi l oj ok">removeFromSupport() -&gt; update support set on_support = 'f' where user_id = '234';</span></pre><p id="8583" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种情况与前面讨论的情况之间的一个区别是，在前面的情况中，并发事务试图更新同一行。但是在这种情况下，他们正在更新两个不同的行。<br/>这被称为<em class="lf">写偏斜</em></p><h1 id="ac95" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated"><strong class="ak">解决方案</strong></h1><p id="bb68" class="pw-post-body-paragraph jy jz iq ka b kb ni kd ke kf nj kh ki kj om kl km kn on kp kq kr oo kt ku kv ij bi translated">这个问题的解决方案仍然是一样的，用更新的<em class="lf">选择替换<em class="lf">选择</em></em></p><blockquote class="lg lh li"><p id="9fa8" class="jy jz lf ka b kb kc kd ke kf kg kh ki lj kk kl km lk ko kp kq ll ks kt ku kv ij bi translated">您实际上可以通过切换到可序列化隔离级别来解决这些问题，但这也有其自身的问题。</p></blockquote></div><div class="ab cl ox oy hu oz" role="separator"><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc"/></div><div class="ij ik il im in"><p id="953e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">差不多就是这样！感谢您的阅读，我希望您喜欢这篇文章。如果你真的为它鼓掌了:)</p><p id="14dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">也可以在<a class="ae lm" href="https://medium.com/@mohak1712" rel="noopener"> Medium </a>和<a class="ae lm" href="https://github.com/mohak1712" rel="noopener ugc nofollow" target="_blank"> Github </a>上关注我。🙂</p></div></div>    
</body>
</html>