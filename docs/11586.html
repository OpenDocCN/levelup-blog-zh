<html>
<head>
<title>Keycloak in Angular Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">角度应用中的键锁</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/keycloak-in-angular-application-980260b4b196?source=collection_archive---------1-----------------------#2022-03-29">https://levelup.gitconnected.com/keycloak-in-angular-application-980260b4b196?source=collection_archive---------1-----------------------#2022-03-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="aa12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">逐步地</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/627eb83df538bb783fc6f253cf9353a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9Hxc3_b2E2qO9zjK.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">角度和键锁</figcaption></figure><p id="332c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些是在angular中的应用程序中执行Keycloak集成的要求。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="112b" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">1.安装Node.js</h1><p id="a204" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">Node.js是一个在服务器上使用JavaScript的开源服务器环境。我们必须安装LTS版本，因为它是推荐给大多数用户的。目前最新的LTS版本是17.8.0(包括npm 8.5.5)。</p><pre class="km kn ko kp gt ml mm mn mo aw mp bi"><span id="aa47" class="mq lj iq mm b gy mr ms l mt mu">curl -sL <a class="ae mv" href="https://deb.nodesource.com/setup_17.x" rel="noopener ugc nofollow" target="_blank">https://deb.nodesource.com/setup_17.x</a> | sudo -E bash -<br/>sudo apt install -y nodejs</span></pre><p id="29c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最新的Node.js LTS版本信息可以在<a class="ae mv" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank"> Node.js网站</a>上找到。</p><h1 id="5052" class="li lj iq bd lk ll mw ln lo lp mx lr ls lt my lv lw lx mz lz ma mb na md me mf bi translated">2.安装npm</h1><p id="2d65" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">通常，NPM会和Node.js一起安装。但是，我们可以使用下面的命令将其更新到最新版本。</p><pre class="km kn ko kp gt ml mm mn mo aw mp bi"><span id="c3b3" class="mq lj iq mm b gy mr ms l mt mu">sudo npm install npm@latest-g</span></pre><h1 id="5d63" class="li lj iq bd lk ll mw ln lo lp mx lr ls lt my lv lw lx mz lz ma mb na md me mf bi translated">3.安装Angular CLI和其他组件包</h1><p id="1f71" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">这里我们使用sudo来避免任何可能发生的权限问题。</p><pre class="km kn ko kp gt ml mm mn mo aw mp bi"><span id="4215" class="mq lj iq mm b gy mr ms l mt mu">sudo npm install @angular/cli<br/>sudo npm install @angular-devkit/architect<br/>sudo npm install @angular-devkit/build-angular<br/>sudo npm install @angular-devkit/core<br/>sudo npm install @angular-devkit/schematics<br/>sudo npm install @schematics/angular<br/>sudo npm install rxjs<br/>sudo npm install typescripts</span></pre></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="8b36" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">4.创建我的应用程序的工作空间</h1><pre class="km kn ko kp gt ml mm mn mo aw mp bi"><span id="77f6" class="mq lj iq mm b gy mr ms l mt mu">sudo ng new mi-aplicacion</span></pre><p id="660c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的angular项目中安装keycloak库和包，我们进入我们的目录mi-aplicacion</p><pre class="km kn ko kp gt ml mm mn mo aw mp bi"><span id="fefd" class="mq lj iq mm b gy mr ms l mt mu">cd mi-aplicacion</span></pre><p id="0cf5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们安装我们的keycloak-angular和keycloak-js库和包</p><pre class="km kn ko kp gt ml mm mn mo aw mp bi"><span id="93a2" class="mq lj iq mm b gy mr ms l mt mu">sudo npm install keycloak-angular keycloak-js</span></pre><p id="e296" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在示例中，我们将配置keycloak来使用silent-check-sso-redirect-uri。启用此功能后，您的浏览器将不会执行完全重定向到Keycloak服务器并返回到您的应用程序，而是在隐藏的iframe中执行此操作，因此您的应用程序资源只需在应用程序初始化时在浏览器中加载和解析一次，而无需在Keycloak重定向到您的应用程序后再次加载和解析。</p><p id="f5fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了确保Keycloak可以通过iframe进行通信，您需要在silentCheckSsoRedirectUri中提供的位置提供来自应用程序的静态HTML。</p><p id="9335" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在应用程序的资产目录中创建一个名为verify-sso.html<strong class="jp ir">的文件，并粘贴如下所示的内容:</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/9b5f8980842fe7fed5ad90639bd230f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*If4lAdy8Hc1JL7I6G9IcKw.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">../src/assets/verify-sso.html</figcaption></figure><p id="bfb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">验证<strong class="jp ir"> app-routing.module.ts </strong>文件是否在..src/app目录</p><p id="7fde" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，我们可以构建我们的项目来检查关于keycloak-js的任何错误配置，如果编译时出现以下<strong class="jp ir">allowSyntheticDefaultImport</strong>错误。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nc"><img src="../Images/27bfc5f2e6baab4719c69cbc5a4f671b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ePzMweCyvxA2Xt6LUjWWNw.png"/></div></div></figure><p id="724c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们必须通过更新下面的<strong class="jp ir"> tsconfig.ts </strong>文件来解决这个问题</p><p id="b5c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">修改tsconfig.json文件，添加编译器选项<br/><strong class="jp ir">“allowSyntheticDefaultImports”:true</strong></p><h1 id="c768" class="li lj iq bd lk ll mw ln lo lp mx lr ls lt my lv lw lx mz lz ma mb na md me mf bi translated">5.我们进行编译，构建</h1><pre class="km kn ko kp gt ml mm mn mo aw mp bi"><span id="7ee1" class="mq lj iq mm b gy mr ms l mt mu">ng build</span></pre><p id="26e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在项目开发和配置的这一阶段，您的控制台中应该会出现以下输出。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nd"><img src="../Images/606a24a7b8c52d75690db9003a381829.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Av6a1TcHFewCV0EDnHkJ8Q.png"/></div></div></figure><h1 id="c171" class="li lj iq bd lk ll mw ln lo lp mx lr ls lt my lv lw lx mz lz ma mb na md me mf bi translated">6.在Keycloak中创建客户端mi-aplicacion-angular</h1><p id="6061" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">现在有趣的部分来了，我们很清楚，至少您已经安装并配置了keycloak服务器…作为继续这个开发示例的先决条件，我将跳过keycloak的安装…我将只展示如何在keycloak管理控制台中创建和配置客户端的部分。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ne"><img src="../Images/f3cf85f87b3a047aafd1a311e11f5a5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WcAN7irz3TDuTVvF.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">首先，您需要在keycloak中创建客户端</figcaption></figure><p id="43e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后配置客户端</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nf"><img src="../Images/47ac3b9e114b165c71dd64c6f794ed43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zmXKZQKCLRx0PvdG.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">在keycloak中配置客户端</figcaption></figure><p id="b868" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后按下save按钮，我们已经在Keycloak工具中配置了我们的客户端…所以我们继续返回到我们的mi-aplicacion项目Angular中，抛出下面的Angular组件中的代码。</p><h1 id="4b3c" class="li lj iq bd lk ll mw ln lo lp mx lr ls lt my lv lw lx mz lz ma mb na md me mf bi translated">7.修改应用程序模块</h1><p id="9571" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">创建函数initialize keycloak，在这一部分，我们必须配置在前面步骤中已经完成的客户端的keycloak配置，例如指定keycloak服务器的url、领域和clientId</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/208cce363bcc9aa774cba866b33123b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*3lNtagXQbzlihGcdgLs8Cw.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">../src/app/app.module.ts</figcaption></figure><p id="ea85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，要进行身份验证，您需要调用<code class="fe nh ni nj mm b">login</code>函数。但是，有两个选项可以让适配器自动进行身份验证。您可以将<code class="fe nh ni nj mm b">login-required</code>或<code class="fe nh ni nj mm b">check-sso</code>传递给init函数。<code class="fe nh ni nj mm b">login-required</code>如果用户已登录{project_name}，将对客户端进行身份验证，否则将显示登录页面。<code class="fe nh ni nj mm b">check-sso</code>将只在用户已经登录的情况下对客户端进行身份验证，如果用户没有登录，浏览器将被重定向回应用程序并保持未经身份验证。</p><p id="e4d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以配置一个<em class="nk">静音</em>T5】选项。启用此功能后，您的浏览器不会完全重定向到{project_name}服务器并返回到您的应用程序，但此操作将在隐藏的iframe中执行，因此您的应用程序资源只需在应用程序初始化时由浏览器加载和解析一次，而无需在从{project_name}重定向回您的应用程序后再次加载和解析。这在SPAs(单页应用程序)的情况下特别有用。</p><p id="ff45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要启用<em class="nk">静默</em> <code class="fe nh ni nj mm b">check-sso</code>，您必须在init方法中提供一个<code class="fe nh ni nj mm b">silentCheckSsoRedirectUri</code>属性。此URI必须是应用程序中的有效端点(当然，它必须在{project_name}管理控制台中配置为客户端的有效重定向):</p><p id="ec0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们在<a class="ae mv" href="http://twitter.com/NgModule" rel="noopener ugc nofollow" target="_blank">@ ng module</a>approving module、KeycloakAngularModule及其keycloakService依赖项中执行以下导入</p><h1 id="0d22" class="li lj iq bd lk ll mw ln lo lp mx lr ls lt my lv lw lx mz lz ma mb na md me mf bi translated">8.修改，app . component . ts</h1><p id="536d" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">这里，为了方便起见，我们修改了我们的组件，并添加了一些业务逻辑，例如，我们询问用户是否登录了<strong class="jp ir"> "isLogueado" </strong>会话，以及他是否启动了会话，然后要求keycloak返回用户配置文件<strong class="jp ir">" profilusario "</strong>，并且我们创建了两个公共方法，在这两个方法中，它向我们返回登录信息<strong class="jp ir"> "iniciarSession" </strong>和注销信息<strong class="jp ir"> "cerrarSesion" </strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/df35a39afdae3386abc09126b5aa6bec.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*tyghTGO4b-IjAVJaMsqmCA.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">../src/app/app.componet.ts</figcaption></figure><h1 id="82f5" class="li lj iq bd lk ll mw ln lo lp mx lr ls lt my lv lw lx mz lz ma mb na md me mf bi translated">9.修改，app.componet.html</h1><p id="2978" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">我们用html组件中的代码替换所有默认的内容</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/5694cd0b5e56f363b8345bc6d32b1b68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*i1pHhjNc5U5TLQNW0YjKYw.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">../src/app/app.component.html</figcaption></figure><h1 id="d9ad" class="li lj iq bd lk ll mw ln lo lp mx lr ls lt my lv lw lx mz lz ma mb na md me mf bi translated">开发服务器</h1><p id="87cc" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">最后，我们在Angular中部署了我们的应用</p><pre class="km kn ko kp gt ml mm mn mo aw mp bi"><span id="9799" class="mq lj iq mm b gy mr ms l mt mu">ng serve --host=0.0.0.0</span></pre><p id="713b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以从GitHub资源库下载源代码</p><p id="50e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae mv" href="https://github.com/ecollado1/keycloak-angular-application/tree/master/mi-aplicacion" rel="noopener ugc nofollow" target="_blank">https://github . com/ecol lado 1/key cloak-angular-application/tree/master/mi-aplicacion</a></p></div></div>    
</body>
</html>