<html>
<head>
<title>How to run a Docker command in the background after TTY input</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TTY输入后如何在后台运行Docker命令</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-run-a-docker-command-in-background-after-tty-input-616b5ffad444?source=collection_archive---------12-----------------------#2020-06-10">https://levelup.gitconnected.com/how-to-run-a-docker-command-in-background-after-tty-input-616b5ffad444?source=collection_archive---------12-----------------------#2020-06-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c0b5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">为需要输入的命令附加TTY，然后将其分离以在后台运行</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b90d1eb93b9f9470884e3d31727eb3d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5EOq-qMGIr7hTd9exoxd-g.png"/></div></div></figure><p id="07c0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">几天前，我为<a class="ae lq" href="https://tezos.com/" rel="noopener ugc nofollow" target="_blank"> Tezos区块链</a>创建了自己的<a class="ae lq" href="https://tezos.gitlab.io/user/key-management.html#signer" rel="noopener ugc nofollow" target="_blank">远程签名者</a>。对于那些不熟悉Tezos的人来说，签名者是一个持有用户凭证并代表用户签署所有事务的进程。多亏了Tezos的docker库，安装进行得很顺利。我要做的是提取docker图像，并运行它的命令。</p><pre class="kj kk kl km gt lr ls lt lu aw lv bi"><span id="3803" class="lw lx it ls b gy ly lz l ma mb">$ docker run --net=host tezos/tezos:carthagenet tezos-signer launch socket signer -a 127.0.0.1 -p 22000 -W</span></pre><p id="d0e8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当我以纯文本方式添加一个测试密钥时，测试环境中的一切都很顺利。对于生产，我需要引入一些加密。一个简单的方法是使用Tezos的默认加密，这将要求我在启动该过程时输入密码。执行过程是这样的:</p><pre class="kj kk kl km gt lr ls lt lu aw lv bi"><span id="66ca" class="lw lx it ls b gy ly lz l ma mb">$ docker run --net=host -it tezos/tezos:carthagenet tezos-signer launch socket signer -a 127.0.0.1 -p 22000 -W </span><span id="868e" class="lw lx it ls b gy mc lz l ma mb">Enter password for encrypted key "my_account": (I enter my password here) </span><span id="2736" class="lw lx it ls b gy mc lz l ma mb">Jun 9 02:58:39 - client.signer: Accepting TCP requests on 127.0.0.1:22000 &lt;-- (this line means signer process started)</span></pre><p id="25ad" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意，我在<code class="fe md me mf ls b">docker run</code>命令中添加了<code class="fe md me mf ls b">-it</code>参数。这些参数<a class="ae lq" href="https://stackoverflow.com/questions/22272401/what-does-it-mean-to-attach-a-tty-std-in-out-to-dockers-or-lxc" rel="noopener ugc nofollow" target="_blank">将TTY附加到docker执行</a>以支持密码提示。听起来不错？还剩一件事。我如何在后台运行这个命令？我运行脚本时输入密码就可以了。但是我希望它在那之后在后台运行，而不是在前台作为一个阻塞进程在我的终端上运行(如果我的会话终止，它就会终止)。</p><h1 id="db21" class="mg lx it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">不工作:使用<code class="fe md me mf ls b">yes</code>命令</h1><p id="b275" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">我曾经使用<a class="ae lq" href="https://www.howtogeek.com/415535/how-to-use-the-yes-command-on-linux/" rel="noopener ugc nofollow" target="_blank"> yes </a>命令来预先提供输入。该命令将为下一个命令所需的所有输入发送<code class="fe md me mf ls b">y</code>。请看下面的例子(我们可以用<code class="fe md me mf ls b">rm -rf</code>来代替，我只是想在这里展示一下<code class="fe md me mf ls b">yes</code>是如何工作的):</p><p id="1d66" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe md me mf ls b">yes</code>也可以支持自定义输入。在下一个示例中，我创建了一个<code class="fe md me mf ls b">test.sh</code>文件，它要求输入名称并打印出一条欢迎消息。</p><pre class="kj kk kl km gt lr ls lt lu aw lv bi"><span id="e27f" class="lw lx it ls b gy ly lz l ma mb">$ vi test.sh </span><span id="90d7" class="lw lx it ls b gy mc lz l ma mb">#!/bin/bash <br/>read -p "Enter Your Name: " username <br/>echo "Welcome $username!" </span><span id="6464" class="lw lx it ls b gy mc lz l ma mb">$ chmod +x ./test.sh </span><span id="7917" class="lw lx it ls b gy mc lz l ma mb">$ yes Huy | test.sh <br/>Welcome Huy!</span></pre><p id="5a40" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我想<code class="fe md me mf ls b">yes</code>可以帮我填写上面命令的密码。如果是这样，我可以在尾部添加<code class="fe md me mf ls b">&amp;</code>来在后台运行。但事实并非如此。</p><p id="452a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果我保留<code class="fe md me mf ls b">-it</code> params，docker不会接受输入。它抱怨<code class="fe md me mf ls b">input device is not a TTY</code>。</p><pre class="kj kk kl km gt lr ls lt lu aw lv bi"><span id="04e9" class="lw lx it ls b gy ly lz l ma mb">$ yes (my-password) | docker run --net=host -it tezos/tezos:carthagenet tezos-signer launch socket signer -a 127.0.0.1 -p 22000 -W </span><span id="af82" class="lw lx it ls b gy mc lz l ma mb">the input device is not a TTY</span></pre><p id="a3e3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果我删除了<code class="fe md me mf ls b">-i</code>，似乎Docker接收到了错误格式的输入。它导致签名者抛出一个错误(Unix。ENOTTY)。</p><pre class="kj kk kl km gt lr ls lt lu aw lv bi"><span id="c863" class="lw lx it ls b gy ly lz l ma mb">$ yes (my-password) | docker run --net=host -t tezos/tezos:carthagenet tezos-signer launch socket signer -a 127.0.0.1 -p 22000 -W </span><span id="b6e2" class="lw lx it ls b gy mc lz l ma mb">Enter password for encrypted key "my_account": <br/>Fatal error: Unix.Unix_error(Unix.ENOTTY, "tcgetattr", "")</span></pre><p id="bb07" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果我删除了<code class="fe md me mf ls b">-t</code>，Docker确实要求我输入，但是之后就挂起了，而且我的进程似乎无法工作。</p><pre class="kj kk kl km gt lr ls lt lu aw lv bi"><span id="a667" class="lw lx it ls b gy ly lz l ma mb">$ yes (my-password) | docker run --net=host -i tezos/tezos:carthagenet tezos-signer launch socket signer -a 127.0.0.1 -p 22000 -W </span><span id="2faa" class="lw lx it ls b gy mc lz l ma mb">Enter password for encrypted key "my_account": (hang here &gt; &lt;! )</span></pre><p id="8ebb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以，<code class="fe md me mf ls b">yes</code>命令不能帮忙。</p><h1 id="7b4b" class="mg lx it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">不起作用:使用<code class="fe md me mf ls b">mkfifo</code></h1><p id="2a4f" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">我能想到的另一个解决方案是使用<code class="fe md me mf ls b">mkfifo</code>创建一个<a class="ae lq" href="https://www.networkworld.com/article/3251853/why-use-named-pipes-on-linux.html" rel="noopener ugc nofollow" target="_blank">输入管道</a>。让我们回来看看我在上面创建的<code class="fe md me mf ls b">test.sh</code>。</p><pre class="kj kk kl km gt lr ls lt lu aw lv bi"><span id="f939" class="lw lx it ls b gy ly lz l ma mb">$ vi test.sh </span><span id="2323" class="lw lx it ls b gy mc lz l ma mb">#!/bin/bash <br/>read -p "Enter Your Name: " username <br/>echo "Welcome $username!" </span><span id="b761" class="lw lx it ls b gy mc lz l ma mb">$ chmod +x ./test.sh </span><span id="8cda" class="lw lx it ls b gy mc lz l ma mb">$ mkfifo ./myname </span><span id="5c9a" class="lw lx it ls b gy mc lz l ma mb">$ ./test.sh &lt; ./myname &amp; </span><span id="9694" class="lw lx it ls b gy mc lz l ma mb">$ echo "Huy" &gt; ./myname <br/>Welcome Huy!</span></pre><p id="0a69" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当我的命令需要输入时，它会一直等到有人向管道中添加内容。管道现在将取代传统的输入TTY。</p><p id="d6c5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是这个解决方案在Docker上也不起作用。我得到的很像<code class="fe md me mf ls b">yes</code> : <code class="fe md me mf ls b">Unix.Unix_error(Unix.ENOTTY, "tcgetattr", "")</code>或者<code class="fe md me mf ls b">the input device is not a TTY</code></p><h1 id="e923" class="mg lx it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">工作解决方案:运行TTY，输入，然后分离TTY</h1><p id="30c9" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">我找到解决办法了(耶)！幸运的是，这个解决方案比上面的两个简单得多。Docker支持<a class="ae lq" href="https://stackoverflow.com/questions/19688314/how-do-you-attach-and-detach-from-dockers-process" rel="noopener ugc nofollow" target="_blank">将TTY从附加的会话中分离</a>。现在的解决方案非常简单:</p><ul class=""><li id="952e" class="nc nd it kw b kx ky la lb ld ne lh nf ll ng lp nh ni nj nk bi translated">运行我的命令</li><li id="694a" class="nc nd it kw b kx nl la nm ld nn lh no ll np lp nh ni nj nk bi translated">如果需要，键入输入</li><li id="a757" class="nc nd it kw b kx nl la nm ld nn lh no ll np lp nh ni nj nk bi translated"><strong class="kw iu">按</strong> <code class="fe md me mf ls b"><strong class="kw iu">Ctrl+P, Ctrl+Q</strong></code> <strong class="kw iu">(我用的是MacOS) </strong>将TTY从正在运行的会话中分离</li></ul><p id="c214" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">撞！默认情况下，分离的会话是后台进程。</p></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><p id="2a5c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><em class="nx">原载于</em><a class="ae lq" href="https://huynvk.dev/blog/how-to-run-a-docker-command-in-background-after-tty-input" rel="noopener ugc nofollow" target="_blank"><em class="nx">https://huynvk . dev</em></a><em class="nx">。</em></p></div></div>    
</body>
</html>