<html>
<head>
<title>Common Kubernetes Misconfigurations and How to Fix Them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">常见的Kubernetes错误配置以及如何修复它们</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/common-kubernetes-misconfigurations-and-how-to-fix-them-172054f66ee9?source=collection_archive---------10-----------------------#2022-02-21">https://levelup.gitconnected.com/common-kubernetes-misconfigurations-and-how-to-fix-them-172054f66ee9?source=collection_archive---------10-----------------------#2022-02-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/94360fd7659b731f2876b0def2f24946.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ljmr8dLhkrP8ERqd"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@carrier_lost?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">伊恩·泰勒</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="e4c4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">越来越多的组织开始在网上开展业务。随着竞争的加剧，组织保持服务更新并提供比竞争对手更多的优势至关重要。由于推送的更新数量不断增加，有效部署和管理基础架构变得更加困难。这就是为什么大多数组织正在转向Kubernetes。</p><p id="810d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kubernetes是一个开源平台，用于管理容器和与容器相关的服务。使用Kubernetes，很容易在生产环境中复制与开发环境相同的计算环境。因此，始终确保无故障部署。</p><p id="d510" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">虽然Kubernetes非常有用，但由于其陡峭的学习曲线，学习起来非常复杂。这导致了错误配置的Kubernetes环境的部署。</p><p id="a50c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据<a class="ae kf" href="https://www.stackrox.com/post/2020/02/5-surprising-findings-from-stackroxs-latest-kubernetes-security-report/" rel="noopener ugc nofollow" target="_blank"> StackRox </a>的报告，错误配置是Kubernetes安全事件的最大原因。在本文中，我们将回顾Kubernetes中常见的错误配置，并讨论最佳实践。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="68fb" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Kubernetes错误配置</h1><h2 id="9c5c" class="mj lm it bd ln mk ml dn lr mm mn dp lv kr mo mp lz kv mq mr md kz ms mt mh mu bi translated">特许集装箱</h2><p id="564a" class="pw-post-body-paragraph kg kh it ki b kj mv kl km kn mw kp kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">Kubernetes为用户提供了部署一个具有最高许可和特权的容器的功能。拥有所有可能权限的容器称为特权容器。特权容器拥有主机的所有根功能。因此，特权容器可以访问普通容器无法访问的所有资源。</p><p id="5b9a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">特权容器应该只在容器需要直接访问硬件时使用。特权容器的其他用例包括在docker容器中运行docker守护进程，以及在Jenkins中自动执行CI/CD任务。如果容器使用特权标志运行，用户将对主机的所有资源拥有关键访问权。如果该容器遭到破坏，攻击者将能够使用所有可用功能运行命令。</p><p id="afd3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在Kubernetes中，可以通过在YAML文件中指定“privileged: true”标志来部署特权容器。这样的YAML文件看起来会像这样:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="c275" class="mj lm it nf b gy nj nk l nl nm">apiVersion: v1</span><span id="c760" class="mj lm it nf b gy nn nk l nl nm">kind: Pod</span><span id="b5fe" class="mj lm it nf b gy nn nk l nl nm">metadata:</span><span id="9093" class="mj lm it nf b gy nn nk l nl nm">    name: &lt;Pod name&gt;</span><span id="4683" class="mj lm it nf b gy nn nk l nl nm">spec:</span><span id="bec1" class="mj lm it nf b gy nn nk l nl nm">    containers:</span><span id="7965" class="mj lm it nf b gy nn nk l nl nm">    - name: &lt;container name&gt;</span><span id="e3eb" class="mj lm it nf b gy nn nk l nl nm">    image: &lt;image&gt;</span><span id="1f86" class="mj lm it nf b gy nn nk l nl nm">    securityContext:</span><span id="5234" class="mj lm it nf b gy nn nk l nl nm">        - privileged: true</span></pre><p id="3b51" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">虽然这个“privileged: true”标志在一个简单的YAML文件中很容易发现，但是在一个有许多行配置的YAML文件中发现这种错误配置就变得很难了。这就是开源工具像Kubescape可以让我们更容易发现错误配置的地方。</p><p id="fd0c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kubescape是一个工具，它提供了各种安全相关功能的工具集，如风险分析、安全合规、RBAC可视化工具和图像漏洞扫描。</p><p id="6b24" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用提供的脚本安装Kubescape很容易。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="7a54" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">装置</h1><p id="3394" class="pw-post-body-paragraph kg kh it ki b kj mv kl km kn mw kp kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">在您的终端中运行以下bash一行程序</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="654f" class="mj lm it nf b gy nj nk l nl nm">curl -s <a class="ae kf" href="https://raw.githubusercontent.com/armosec/kubescape/master/install.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/armosec/kubescape/master/install.sh</a> | /bin/bash</span></pre><p id="67cf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">安装后，运行以下命令扫描易受攻击的YAML文件。</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="14b3" class="mj lm it nf b gy nj nk l nl nm">kubescape scan framework nsa vulernable_file.yaml</span></pre><p id="f9b3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，我们指定了Kubescape的几个参数。</p><p id="0bc2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们指定要执行扫描。由于Kubescape提供了多种扫描框架——<a class="ae kf" href="https://www.armosec.io/blog/kubescape-the-first-tool-for-running-nsa-and-cisa-kubernetes-hardening-tests/" rel="noopener ugc nofollow" target="_blank">MITRE和NSA</a>——我们明确指定要使用NSA框架。</p><p id="640c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们传递想要扫描的YAML文件的名称。</p><p id="34eb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成后，我们可以看到输出表明此YAML文件易受攻击，权限提升是可能的。</p><p id="2231" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您还可以测试容器上的特定控件。</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="24bf" class="mj lm it nf b gy nj nk l nl nm">kubescape scan control “Privileged container”</span></pre><p id="04df" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您的容器是安全的，不会受到特权容器错误配置的影响，您应该会看到下面的输出。</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/81e53fccdc54c6c32b204b9e2f8aa7e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YlXXoaTvp0Otd9z3"/></div></div></figure></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="d9a6" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">来自私有存储库的图像</h1><p id="8893" class="pw-post-body-paragraph kg kh it ki b kj mv kl km kn mw kp kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">许多开发人员将他们的图像存储在云提供商中，如Azure Container Registry(<a class="ae kf" href="https://azure.microsoft.com/en-us/services/container-registry/" rel="noopener ugc nofollow" target="_blank">ACR</a>)或Amazon Elastic Container Registry(<a class="ae kf" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank">ECR</a>)。要访问这些云提供商，需要使用云凭据来认证和提取映像。</p><p id="23bf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果攻击者获得了对集群的访问权，他们可以使用<a class="ae kf" href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/" rel="noopener ugc nofollow" target="_blank"> imagePullSecrets </a>提取凭证，然后使用该凭证从注册表中提取所有映像。</p><p id="75cd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这种错误的配置可以用kubescape控件“来自私有注册表的图像”来测试。</p><p id="9a01" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要运行此测试，请在终端中键入以下命令:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="1c04" class="mj lm it nf b gy nj nk l nl nm">kubescape scan control ‘Images from private registry’</span></pre><p id="5ee8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您正在运行的集群存在这种错误配置，将会显示类似图像的输出。</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/5c2ff3a4c608e12c18730e2c394ece51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*w0NsOLhS0H_EUAqT"/></div></div></figure></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="1f40" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Bash/Cmd在容器内部</h1><p id="ccd5" class="pw-post-body-paragraph kg kh it ki b kj mv kl km kn mw kp kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">如果攻击者拥有在容器中运行外壳脚本或一组外壳命令的权限，他们就可以使用它来执行恶意软件。补救这种错误配置的最好方法是从容器中移除cmd.exe或bash。</p><p id="298f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">可以运行以下命令来检查您的容器是否有这种错误配置。</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="6565" class="mj lm it nf b gy nj nk l nl nm">kubescape scan control ‘Bash/cmd inside container’</span></pre><p id="b378" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行时，该控件将在漏洞扫描数据库中搜索产品规格中指定的映像。如果容器有bash或cmd，它将返回不满意。</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/13093201111fe5bdd613e8d6b06dcb5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2fMjfgfUf_B1ky6d"/></div></div></figure></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="8671" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">结论</h1><p id="887c" class="pw-post-body-paragraph kg kh it ki b kj mv kl km kn mw kp kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">现在，几乎所有的组织都在使用容器来尽可能提高云基础设施和部署的效率。然而，尽管容器技术的部署有所增加，但仍然缺乏熟悉容器配置的人员。这导致攻击数量不断增加。这就是为什么建议借助自动化容器安全框架(如“kubescape ”)来保持最新的容器安全，并确保您遵守MITRE和NSA规定的所有控制措施。</p></div></div>    
</body>
</html>