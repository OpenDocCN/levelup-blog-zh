<html>
<head>
<title>VS Code Remote Containers with Nix</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">VS用Nix编码远程容器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/vs-code-remote-containers-with-nix-2a6f230d1e4e?source=collection_archive---------11-----------------------#2021-08-31">https://levelup.gitconnected.com/vs-code-remote-containers-with-nix-2a6f230d1e4e?source=collection_archive---------11-----------------------#2021-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b0c1469771732caf52e137fdf522e4a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sox1gxzzZ0MlzdGzvcMVJA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@helloitsammiel?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> ammiel jr </a>在<a class="ae kc" href="https://unsplash.com/s/photos/container?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="372c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://nixos.org/learn.html" rel="noopener ugc nofollow" target="_blank"> Nix </a>已经提供了一种简洁的方式来创建一个在可再现性方面有强大保证的开发环境。然而，它仍然需要开发者在他们的电脑上安装它，即使Nix没有在诸如<code class="fe lb lc ld le b">/usr</code>这样的目录中安装任何东西，也会遇到一些阻力。</p><p id="0532" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">另一方面，VS Code的<a class="ae kc" href="https://code.visualstudio.com/docs/remote/devcontainerjson-reference" rel="noopener ugc nofollow" target="_blank"> devcontainers </a>允许开发者在没有太多麻烦的情况下开始一个项目，只要他们使用VS Code并运行Docker。他们也可能对在容器中运行的东西感觉更好，不会污染他们的主机系统。</p><p id="c2e3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这里，我将描述如何将这两种解决方案结合在一起，并获得两个世界的最佳效果。人们可以在他们的主机系统上直接使用Nix，或者使用VS代码，在Nix环境的容器中进行开发。</p><p id="f0e4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我在一些项目中已经使用了几个月的设置。最初，我担心集装箱的开销可能会成为一个问题，但事实证明这种担心是没有根据的。</p><h1 id="8840" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">Nix环境</h1><p id="59af" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">这个设置使用Nix Flakes创建一个开发环境。入口点在项目根的<code class="fe lb lc ld le b">flake.nix</code>中。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="2c6a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">薄片输出一个<code class="fe lb lc ld le b">devShell</code>，其在<code class="fe lb lc ld le b">nix/shell.nix</code>中定义如下。为了便于演示，这只是一个带有Haskell编译器的虚拟开发环境。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">nix/shell.nix</figcaption></figure><p id="b9d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一次运行<code class="fe lb lc ld le b">nix flake upgrade</code>会创建一个新文件<code class="fe lb lc ld le b">flake.lock</code>，包含Nixpkgs和<code class="fe lb lc ld le b">flake-utils</code>的固定版本。这个文件应该与项目的其余部分一起进行版本控制。</p><p id="cef3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些基本文件对于那些愿意在主机上而不是在容器中运行Nix的人来说已经很有用了。命令<code class="fe lb lc ld le b">nix develop</code>让您进入一个具有Nix开发环境的shell。</p><h1 id="3ea5" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">Docker图像</h1><p id="9aa1" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们现在需要一个带有Nix的Docker映像和一些其他配置，以便在启动时自动加载开发环境。</p><p id="90a0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于这依赖于Nix Flakes，我们需要Nix 2.4(在撰写本文时是预发行版)而不是最新的“官方”版本。</p><p id="dec1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Dockerfile与远程容器的配置一起放在<code class="fe lb lc ld le b">.devcontainer/</code>中，因为它特定于这种用法。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">。开发容器/docker文件</figcaption></figure><p id="8bfa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个Dockerfile在容器内部复制<code class="fe lb lc ld le b">.devcontainer/nix.conf</code>。它用于设置一些使Nix 2.4工作所需的选项，但它也是一种在开发人员之间共享配置的便捷方式。例如，您可以设置<code class="fe lb lc ld le b">substituters</code>和<code class="fe lb lc ld le b">trusted-public-keys</code>来添加一些Nix缓存。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">。devcontainer/nix.conf</figcaption></figure><p id="ddb0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，<code class="fe lb lc ld le b">.devcontainer/profile.sh</code>如下加载Nix开发环境。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">。devcontainer/profile.sh</figcaption></figure><p id="010b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不要忘记通过运行以下命令使该文件可执行。</p><pre class="mi mj mk ml gt mo le mp mq aw mr bi"><span id="7161" class="ms lg iq le b gy mt mu l mv mw">chmod +x .devcontainer/profile.sh</span></pre><p id="c85a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">文件<code class="fe lb lc ld le b">.devcontainer/.profile</code>可以添加到<code class="fe lb lc ld le b">.gitignore</code>或等效文件中。它只是为了确保在运行<code class="fe lb lc ld le b">nix store gc</code>时开发环境不会被垃圾收集。</p><h1 id="7803" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">容器的配置</h1><p id="2c73" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">最后一步是告诉VS代码如何加载devcontainer。这是通过在<code class="fe lb lc ld le b">.devcontainer/devcontainer.json</code>添加一个配置来实现的。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">。devcontainer/devcontainer.json</figcaption></figure><p id="5c14" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">名为<code class="fe lb lc ld le b">yourproject_nix</code>的卷将被创建并挂载到<code class="fe lb lc ld le b">/nix</code>。这意味着在重新构建容器后，您不需要重新编译所有的Nix派生。</p><p id="cc90" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这个例子中，VS代码的扩展<code class="fe lb lc ld le b">bbenoist.nix</code>被自动安装在容器中。您可能想要添加特定于项目技术堆栈的其他扩展。</p></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><p id="8861" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你喜欢这样的故事，可以考虑成为媒体会员，或者订阅。</p></div></div>    
</body>
</html>