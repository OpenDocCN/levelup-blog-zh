<html>
<head>
<title>Testing Vue.js in Rails with Webpacker and Jest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Webpacker和Jest在Rails中测试Vue.js</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/testing-vue-js-in-rails-with-webpacker-and-jest-1b307979eb1f?source=collection_archive---------8-----------------------#2020-05-06">https://levelup.gitconnected.com/testing-vue-js-in-rails-with-webpacker-and-jest-1b307979eb1f?source=collection_archive---------8-----------------------#2020-05-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/6100377b5b6d9660a9f607520195fd98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h8XIYuM98cjOS24u"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com/@flowforfrank?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Ferenc Almasi </a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="771e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我正在做的项目中，我的任务是研究如何将<a class="ae kf" href="https://vuejs.org/" rel="noopener ugc nofollow" target="_blank"> Vue.js </a>与我们现有的Rails应用程序集成。于是我开始看官方指南，看教程，看各种帖子，直到最后得到一个完全可以工作的Vue组件。</p><p id="da50" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后是时候写一些测试了，但是不幸的是，web packer gem不包括测试配置，所以我不得不自己做。</p><p id="dce9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">令我惊讶的是，我发现没有多少关于如何设置的文档。所以我想我应该发这个帖子来和你分享我是如何最终让它工作起来的。</p><h1 id="057e" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">1.安装Jest</h1><p id="ebc0" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我决定用<a class="ae kf" href="https://facebook.github.io/jest/" rel="noopener ugc nofollow" target="_blank"> Jest </a>并不是出于个人喜好，我只是注意到<a class="ae kf" href="https://github.com/vuejs/vue-cli" rel="noopener ugc nofollow" target="_blank"> vue-cli </a>与它同在，于是就去用它了。</p><p id="464b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要安装Jest，你所要做的就是从你的项目根目录运行<code class="fe mh mi mj mk b">yarn add — dev jest</code>。<br/>然后，向您的<code class="fe mh mi mj mk b">package.json</code>添加一个测试脚本:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="f9c4" class="mt lf it mk b gy mu mv l mw mx">{<br/> “scripts”: {<br/> “test”: “jest”,<br/> …<br/> },<br/> …<br/>}</span></pre><p id="e6f1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在你可以用<code class="fe mh mi mj mk b">yarn test</code>运行你的测试了。</p><h1 id="014a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">2.定义测试的位置</h1><p id="d4dd" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果您试图在此时运行<code class="fe mh mi mj mk b">yarn test</code>，您会看到<code class="fe mh mi mj mk b">config/webpack/test.js</code>失败了。这是因为<a class="ae kf" href="https://facebook.github.io/jest/docs/en/configuration.html#testmatch-array-string" rel="noopener ugc nofollow" target="_blank"> Jest在项目</a>中寻找测试文件的方式。它基本上执行整个项目中所有匹配<code class="fe mh mi mj mk b">.spec.js</code>或<code class="fe mh mi mj mk b">.test.js</code>的文件。在这种情况下，文件与<code class="fe mh mi mj mk b">*.test.js</code>匹配，所以它试图将其作为测试运行。</p><p id="74d1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为我们不希望Webpack配置文件以及项目中满足这个标准的其他文件与我们的测试一起运行，所以我们需要告诉Jest在哪里可以找到它们。</p><p id="113f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我的例子中，由于我正在使用<a class="ae kf" href="http://rspec.info/" rel="noopener ugc nofollow" target="_blank"> Rspec </a>，我决定将它指向<code class="fe mh mi mj mk b">spec/javascripts</code>目录。但是您可以自由选择最适合您的项目的目录。</p><p id="99b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为此，您只需将<a class="ae kf" href="https://facebook.github.io/jest/docs/en/configuration.html#roots-array-string" rel="noopener ugc nofollow" target="_blank">根</a>添加到您的<code class="fe mh mi mj mk b">package.json</code>中:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="64cd" class="mt lf it mk b gy mu mv l mw mx">“jest”: {<br/> “roots”: [<br/> “spec/javascript”<br/> ]<br/>},</span></pre><p id="d3cd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">___ <br/> <strong class="ki iu">注:</strong> <em class="my">如果你的</em> <code class="fe mh mi mj mk b"><em class="my">package.json</em></code> <em class="my">已经相当大了，你又不想继续往里面添加更多的东西，可以通过</em> <code class="fe mh mi mj mk b"><em class="my">— config &lt;path/to/js|json&gt;;</em></code> <em class="my">选项定义jest配置。如果你选择这样做，你的</em> <code class="fe mh mi mj mk b"><em class="my">package.json</em></code> <em class="my">现在应该是这样的:</em></p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="2786" class="mt lf it mk b gy mu mv l mw mx">{<br/> “scripts”: {<br/> “test”: “jest — config spec/javascript/jest.conf.js”,<br/> …<br/> },<br/> …<br/>}</span></pre><p id="16ec" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi">___</p><p id="770b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了验证它的工作，您可以通过一个简单的测试创建一个<code class="fe mh mi mj mk b">spec/javascript/team.spec.js</code>文件，如下所示:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="58e7" class="mt lf it mk b gy mu mv l mw mx">test(‘there is no I in team’, () =&gt; {<br/> expect(‘team’).not.toMatch(/I/);<br/>});</span></pre><p id="8d69" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在再次运行<code class="fe mh mi mj mk b">yarn test</code>,您应该会在输出中看到一个绿色的“PASS ”,这意味着它工作了🎉。</p><h1 id="6a33" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">3.巴别塔来救援了</h1><p id="121f" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">既然我们的第一个测试已经运行了，让我们更进一步，试着测试一个Vue组件。</p><p id="9699" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可能尝试的第一件事是在<code class="fe mh mi mj mk b">spec/javascript/</code>目录下创建一个文件，并将其命名为类似于<code class="fe mh mi mj mk b">my_component.spec.js</code>的名称。然后尝试使用<a class="ae kf" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import" rel="noopener ugc nofollow" target="_blank"> import </a>语句从您的规范中导入您的组件，如下所示:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="3804" class="mt lf it mk b gy mu mv l mw mx">import MyComponent from ‘../../app/javascript/my_component.vue’;</span></pre><p id="fa90" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您确实尝试过这种方法，请继续运行您的测试。您将在输出中看到一个<code class="fe mh mi mj mk b">SyntaxError: Unexpected token import</code>。</p><p id="95ff" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里的问题是<code class="fe mh mi mj mk b">import</code>是ECMAScript 6的一部分，所以我们需要像<a class="ae kf" href="https://babeljs.io/" rel="noopener ugc nofollow" target="_blank"> Babel </a>这样的transpiler的帮助。</p><p id="1fee" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要让它工作，你需要通过运行<code class="fe mh mi mj mk b">yarn add — dev babel-jest babel-preset-es2015</code>安装两个包，并将“es2015”预置添加到你的<code class="fe mh mi mj mk b">.babelrc</code>文件中:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="0528" class="mt lf it mk b gy mu mv l mw mx">{<br/> “presets”: [“es2015”,<br/>   [“env”, {<br/> …</span></pre><p id="ba8a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您想更进一步，您可以将<a class="ae kf" href="https://facebook.github.io/jest/docs/en/configuration.html#moduledirectories-array-string" rel="noopener ugc nofollow" target="_blank">module directory</a>添加到您的<code class="fe mh mi mj mk b">.package.json</code>中，这样您就不必键入模块的完整路径:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="94d3" class="mt lf it mk b gy mu mv l mw mx">“jest”: {<br/> …<br/> “moduleDirectories”: [<br/>   “node_modules”,<br/>   “app/javascript”<br/> ]<br/>}</span></pre><p id="42ef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所以我们之前看到的是</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="3860" class="mt lf it mk b gy mu mv l mw mx">import MyComponent from ‘../../app/javascript/my_component.vue’;</span></pre><p id="101e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在可以写成</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="b274" class="mt lf it mk b gy mu mv l mw mx">import MyComponent from ‘my_component.vue’;</span></pre><h1 id="34a2" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">4.Vue在哪？</h1><p id="0459" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果您遵循了每一步，那么在尝试运行您的测试时，您应该会得到一个<code class="fe mh mi mj mk b">SyntaxError</code>。这意味着它成功地导入了您的组件，但是它还不能理解<code class="fe mh mi mj mk b">.vue</code>文件的格式。</p><p id="e6d5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">幸运的是，我们有一个包可以帮我们解决这个问题。<br/>所以继续运行<code class="fe mh mi mj mk b">yarn add — dev vue-jest</code>并添加“moduleFileExtensions”、“transform”和“mapCoverage”，如<a class="ae kf" href="https://github.com/eddyerburgh/vue-jest/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>中所述。<br/>你的<code class="fe mh mi mj mk b">package.json</code>应该是这样的:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="84ef" class="mt lf it mk b gy mu mv l mw mx">“jest”: {<br/> …<br/> “moduleFileExtensions”: [<br/>   “js”,<br/>   “json”,<br/>   “vue”<br/> ],<br/> “transform”: {<br/>   “^.+\\.js$”: “&lt;rootDir&gt;/node_modules/babel-jest”,<br/>   “.*\\.(vue)$”: “&lt;rootDir&gt;/node_modules/vue-jest”<br/> },<br/> “mapCoverage”: true<br/>}</span></pre><p id="dca2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有了<a class="ae kf" href="https://facebook.github.io/jest/docs/en/configuration.html#modulefileextensions-array-string" rel="noopener ugc nofollow" target="_blank"> moduleFileExtensions </a>我们在导入单个文件组件时不再需要<code class="fe mh mi mj mk b">.vue</code>。所以我们之前看到的是</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="7c1f" class="mt lf it mk b gy mu mv l mw mx">import MyComponent from ‘my_component.vue’;</span></pre><p id="50eb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在可以写成</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="589e" class="mt lf it mk b gy mu mv l mw mx">import MyComponent from ‘my_component’;</span></pre><p id="3998" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你现在应该可以无缝地使用<code class="fe mh mi mj mk b">import</code>了。</p><p id="f0f7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://facebook.github.io/jest/docs/en/configuration.html#transform-object-string-string" rel="noopener ugc nofollow" target="_blank">转换</a>部分中的规则指出了哪个包负责测试文件的转换。在我们的例子中，我们希望<code class="fe mh mi mj mk b">vue-jest</code>处理我们所有的<code class="fe mh mi mj mk b">.vue</code>文件，所以它们在被Jest处理之前被转换成普通的javascript。</p><p id="89d0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://facebook.github.io/jest/docs/en/configuration.html#mapcoverage-boolean" rel="noopener ugc nofollow" target="_blank">设置mapCoverage </a>是为了使用变压器发出的源地图。Jest将在编写报告和检查阈值时使用它们来尝试和映射原始源代码的代码覆盖率。</p><p id="8370" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，让我们添加Vue的官方单元测试实用程序库，<a class="ae kf" href="https://vue-test-utils.vuejs.org/en/" rel="noopener ugc nofollow" target="_blank"> vue-test-utils </a>。只要运行<code class="fe mh mi mj mk b">yarn add — dev @vue/test-utils</code>就可以了。</p><p id="faa9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您现在可以开始为您的Vue组件编写测试了🎉</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><p id="7c75" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="my">原载于2018年1月16日</em><a class="ae kf" href="https://dev.to/mariiio/testing-vuejs-in-rails-with-webpacker-and-jest-374a" rel="noopener ugc nofollow" target="_blank"><em class="my">https://dev . to</em></a><em class="my">。</em></p></div></div>    
</body>
</html>