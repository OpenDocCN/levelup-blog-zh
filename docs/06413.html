<html>
<head>
<title>Using Word Documents or “.docx” files to gain unauthorised access to private server resources</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Word文档或”。docx”文件来获得对私有服务器资源的未授权访问</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-word-documents-or-docx-files-to-gain-unauthorised-access-to-server-private-resources-2477b3eafb7b?source=collection_archive---------7-----------------------#2020-11-23">https://levelup.gitconnected.com/using-word-documents-or-docx-files-to-gain-unauthorised-access-to-server-private-resources-2477b3eafb7b?source=collection_archive---------7-----------------------#2020-11-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="973d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我很高兴能参加2020年11月19日至21日由cybertalents.com举办的CTF网络安全大会。我很乐意与像我一样的web开发爱好者分享一些经验。本文演示了如何实现。docx文件可能被滥用来限制对服务器上敏感资源的访问，如密码或网站源代码。</p><p id="e309" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我将在本文中提出的挑战叫做“笔记本”。这是一个简单的网页，包含一个表格来上传MSWord文档或"。docx "文件传送到服务器。在表单的右侧，页面呈现3个字段:标题、主题和描述。在该表单下，有一个指向空的“sample.docx”文件的链接，我们可以下载该文件。<br/>所以实际上，用户把笔记写在一个docx文件中(他可以使用提供的sample.docx)，上传到服务器，然后在屏幕上看到笔记的标题、主题和描述。<br/>在托管该应用程序的服务器中，有一个隐藏的标志，我们需要检索它才能成功完成挑战。</p><p id="f7a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">简单…</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><p id="575d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了检查除了主页之外是否还有其他隐藏的路径，我向/robots.txt发出了一个简单的请求，显示了/home/目录中一个名为“flag”的文件。这个提示告诉我们，这个标志存储在以前的受限目录中。挑战变得很明显，<strong class="js iu">我们</strong> <strong class="js iu">需要使用上传表单来执行服务器端代码，并从给定的受限目录</strong>中检索标志。</p><p id="ab6a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我开始尝试上传。txt，。php和。html文件，而不是word文件，试图崩溃的应用程序，但它只允许。docx文件—运气不好！<br/>反应快，我决定装糊涂。下的php文件。docx扩展。这款应用比预期的更智能。显然，它是在检查文件结构以验证文档，而不仅仅是扩展名。在尝试了许多技术来欺骗服务器接受非docx文件并惨遭失败后，我得出结论，我们需要利用这些MSWord文档来利用服务器。</p><p id="5f88" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下一个明显的步骤是理解什么是. docx文件，以及为什么它不同于其他扩展名，如。多克和。txt？docx文件是一个归档文件(。zip文件)，该文件具有XML结构。不像。多克和。txt文件，如果您尝试使用文本编辑器打开. docx文件，您会发现一长串十六进制字符。<br/>这个。docx archive包含非常具体的XML文件，这些文件负责定义文档的布局、字体、元数据、内容(文本和照片)以及许多其他属性。<br/>换句话说，每个docx文件都是一个zip文件。但是，只有当zip文件包含必要的XML元素(这些元素是docx的构建块)时，它才是docx。<br/>让我们试着仔细观察一个典型的docx文件。我选择查看web应用程序提供的sample.docx文件:<br/> <em class="kw">在mac/linux上尝试:<br/>—% unzip[/path/to/]sample . docx-d[/path/to/]sample/<br/>—% CD[/path/to/]sample/<br/>—% ls-l<br/></em>创建了一个“sample”目录，我们可以在其中看到我们解压缩的docx的内容:<em class="kw"><br/>/rels/<br/>/custom XML/。xml </em></p><p id="a316" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">好了，让我们回到我们的web应用程序。让我们试着在屏幕上打印一些东西。请记住，在表单的右侧，可以打印三个字段:标题、主题和描述。比如，我们写一张纸条，上面写着:<br/> <em class="kw">标题:午餐<br/>主题:餐厅选择<br/>描述:我今天想吃一个汉堡。</em></p><p id="2456" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们该怎么做呢？我们打开sample.docx，把上面写的一模一样，保存后上传到服务器。屏幕上什么也没有显示。我的第一直觉是，服务器将寻找关键字“标题、主题和描述”，相应地解析输入文本，并在屏幕上显示这些值。但是很明显页面做了一些不同的事情:无论我们用MSWord在docx文件中写什么，在屏幕上都不会改变。所以从技术上来说，webapp想要从docx中的其他地方获得“标题、主题和描述”。</p><p id="bebd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用一个简单的文本编辑器，我开始研究解压缩后的sample.docx文件。在查看了里面的所有xml文件后，我在/docProps/core.xml中找到了这段代码:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi kx"><img src="../Images/9778b5e97673fb12753c523bb5e9525b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qCXRr015LR6xN0H_1zP30Q.png"/></div></div></figure><p id="84ef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">core.xml是定义sample.docx核心属性的文档。我们可以清楚地看到标题、主题和描述标签！让我们在相应的标签之间写下午餐笔记文本并保存。<br/>我们现在需要将我们的新文档转换回docx:<br/><em class="kw">—% zip-r sample _ updated . docx *</em><br/>上传新的docx现在会将我们的注释打印到屏幕上！</p><p id="0560" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们挑战的最后一部分是在屏幕上写下/home/flag的内容，而不是随机的午餐笔记。</p><p id="b508" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> /home/是一个受限目录。这意味着我们需要非法地从网站目录(默认为/var/www/website-name)遍历到所需的/home/flag。</strong></p><p id="ccbb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这让我想到了在XML解析器<strong class="js iu">中发现的<strong class="js iu"> XXE或XML外部实体</strong>漏洞。</strong></p><p id="b131" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在XML文档中，实体是可以在文件顶部定义并在文件内部任何地方重用的常量，就像任何其他编程语言中的常量一样。<br/>我们修改core.xml，如下所示，以包含一个“标题”实体:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi kx"><img src="../Images/ed5e8fdc96c90164b04d60906a0a0b78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S5OnRzn4rtfFePKlEy7Mug.png"/></div></div></figure><p id="c44d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">&amp;title指的是上面的“Hello World”。</p><p id="6900" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用XML实体是危险的。在某些情况下，XML解析器被配置为允许实体引用外部资源，比如受限文件的内容。让我们试着利用这个漏洞。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi lj"><img src="../Images/8f41f53359ba2b4e444ed26052f4e791.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cf5NDCH7hUzFUXXLRRtODg.png"/></div></div></figure><p id="330b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的“flag”实体指的是/home/flag文件的内容。我们将它打印在<title>标签之间。如果我们保存文档，转换回。docx格式并上传到服务器，我们会看到国旗印在屏幕上！</title></p><p id="23cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个简单的例子显示了XXE漏洞到底有多危险。<br/> <strong class="js iu">如果我们将“file:///home/flag”替换为“file:///etc/passwd”就可以检索到存储在服务器</strong>上的所有用户和密码，或者“file:///var/www/[secure bank]/[transfer funds . PHP]”，就可以得到网站源代码。</p><p id="3662" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，如果加载了“expect”PHP模块，我们可能会在服务器上执行随机代码，从而危及整个系统。</p><p id="5ae6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">如何预防XXE？</strong></p><p id="bb9e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">开发人员培训对于识别和减轻XXE至关重要。除此之外，预防XXE需要:</p><ul class=""><li id="b225" class="lk ll it js b jt ju jx jy kb lm kf ln kj lo kn lp lq lr ls bi translated">尽可能使用不太复杂的数据格式，如JSON，并避免敏感数据的序列化。</li><li id="b2dc" class="lk ll it js b jt lt jx lu kb lv kf lw kj lx kn lp lq lr ls bi translated">修补或升级应用程序使用的或底层操作系统上的所有XML处理器和库。使用依赖检查器。将SOAP更新到SOAP 1.2或更高版本。</li><li id="2fb7" class="lk ll it js b jt lt jx lu kb lv kf lw kj lx kn lp lq lr ls bi translated">在应用程序的所有XML解析器中禁用XML外部实体和DTD处理。</li></ul><p id="13d7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">其他方法包括使用虚拟补丁、API安全网关、Web应用程序防火墙(WAF)或交互式应用程序安全测试(IAST)工具来检测、监控和阻止XXE攻击。</p></div></div>    
</body>
</html>