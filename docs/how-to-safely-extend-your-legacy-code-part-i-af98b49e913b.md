# 如何安全地扩展您的遗留代码

> 原文：<https://levelup.gitconnected.com/how-to-safely-extend-your-legacy-code-part-i-af98b49e913b>

## 干净的代码和重构

## 你正在使用**遗留代码**吗？你得到了一份扩展现有功能的工作吗？你害怕改变是因为代码太脆弱了吗？让我告诉你安全的方法。

![](img/179f57ff21699c057538fa80905aeab9.png)

照片由 H [itesh Choudhary](https://www.pexels.com/@hiteshchoudhary?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels) 从 [Pexels](https://www.pexels.com/photo/adult-apple-device-business-code-340152/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels) 拍摄

## **简介**

**本文假设了重构和单元测试的基本知识。如果你是第一次接触这些话题，我们也欢迎你，但是我建议你先读一些关于你自己的东西。**

## 使冷静的

实话实说吧。你已经听说过**重构**、**单元测试、**以及它们的**重要性**。但你认为这是额外的工作。但是他们是吗？他们不是正好相反吗？

想象一下这种情况。你在做新任务。它是现有功能的扩展。你刚刚完成了。在更好的情况下，您还可以从用户体验的角度测试应用程序。过了一会儿，测试人员批准任务完成，但是在扩展特性的公共部分报告了另外两个新的 bug。有多沮丧？听起来耳熟吗？

难道你不认为**花在修复 bug 上的时间** **可以等同于花在编写单元测试**上的时间吗？自己去发现一个新的 bug 不是更好吗？答案是一套很好的测试。

但是，当你负责一个大型的生产项目时，你会怎么做呢？嗯，有很多关于这个话题的书。可能最著名的是迈克尔·c·费格斯的**“有效地使用遗留代码”。我最近在读一本有名字的书，我发现它非常吸引人和鼓舞人心。**

## 动机

我相信我们中的许多人都想重构，但不能无缘无故地停止开发。没有客户会同意延期半年，因为我们提出了一个叫做重构的东西。在这篇文章中，我想介绍你可以在提到的情况下应用的技术。

## 发芽法

当您扩展一个新指令序列的代码时，您还应该将新指令提取到新方法中。引人注目的修改方法被称为**发芽法**。

当你必须扩展一个大的方法，但是你害怕碰到一个纠结的怪物时，这个技术是引人注目的。**萌芽方法**允许你用测试覆盖一个新的指令序列。让我们看一个例子。

现有代码

现在，一个新任务要求筛选出不在 TransactionBundle 对象中的订单项。这听起来像是一个很容易的改变。我们编码吧。

对现有代码的简单更改

没什么大不了的，对吧？我们违反了什么程序？

1.  我们引入了新的职责。 [**单一责任原则**](https://en.wikipedia.org/wiki/Single_responsibility_principle) 说，“**方法应该做一件事并且只做一件事**”更多的责任意味着更脆弱的代码。
2.  我们仍然没有任何测试，因为我们扩展了部分代码，这很难用测试来覆盖。
3.  我们让代码变得更加脆弱。

这次不同了。

发芽法代码

我们创建了一个带有一个参数的方法 GetUniqueOrderItems 订单项目列表。我们改变了现有的代码。首先，我们调用新方法，并将其结果引入一个变量。然后，我们更改了 Foreach 语句中使用的变量。**这些变化都没有增加现有代码的复杂性。**

现在我们可以初始化类并为新代码编写测试。我推荐使用 [**测试驱动开发**](https://en.wikipedia.org/wiki/Test-driven_development) 开发一个**萌芽方法**。

**发芽法**并不总是合适的方法。有时你可能会遇到有很多依赖项的类。嘲笑他们所有人并用测试覆盖整个类的功能可能是浪费时间。记住，我们在赶时间。是时候给大家呈现**萌班**了。

## 萌芽类

当您必须用一系列指令扩展一个大型方法，并且该类严重依赖于不同的对象时，最好将指令序列提取到一个新的类方法中。新类允许您更容易地初始化对象，这意味着您将更容易地用单元测试覆盖新功能。这个班叫**萌班。请看下面的一个例子。**

您应该看到至少有三个职责，并且您甚至不能看到所有的代码。

让我们假设这是一个很大的类，需要一天的时间来完成测试。我们知道我们在赶时间。我们希望在订单价格中增加增值税，但前提是客户不是公司。听起来不像是一个持久的操作。

让我们开发一个完全独立的类，最好使用 **TDD** 。

我肯定你在想:“他疯了吗？为这么少的代码创建一个类？”在你绞死我之前，听着。

为什么不呢？你做过多任务处理吗？你过得怎么样？**如果你做一件简单的事情，你认为你能做得更好吗？随着多任务处理而来的是更多的责任，更多的责任意味着出错的可能性更大。同样的规则也适用于代码。**

新的指令被测试所覆盖，并且**只有一个责任。**非常容易阅读和维护。

最后，让我们在现有代码中初始化一个 Sprout 类的对象，将参数传入它的方法，让一个方法做所需的表达式。

[](https://www.danielrusnok.com/daniel-rusnoks-newsletter) [## 丹尼尔·鲁斯诺克的时事通讯

### 每个月我都会给你发一封电子邮件，列出我的最新文章。这当然是友好的联系…

www.danielrusnok.com](https://www.danielrusnok.com/daniel-rusnoks-newsletter) [![](img/88f0e07ab6797fc4fcd13ed7410af039.png)](https://www.buymeacoffee.com/danielrusnok)[![](img/f3d94d9b86b4ee7080bab6d72172b50a.png)](https://itixo.com)