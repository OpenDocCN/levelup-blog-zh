<html>
<head>
<title>Enable CORS using Fiddler — Make API calls to a remote server via localhost</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Fiddler启用CORS—通过本地主机对远程服务器进行API调用</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/enable-cors-using-fiddler-making-api-call-to-a-remote-server-via-localhost-b78277cf9c48?source=collection_archive---------0-----------------------#2019-03-23">https://levelup.gitconnected.com/enable-cors-using-fiddler-making-api-call-to-a-remote-server-via-localhost-b78277cf9c48?source=collection_archive---------0-----------------------#2019-03-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b575" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将localhost指向测试或生产环境的更简单的方法。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/3b09457da6c61bfbc97b0549ecf359c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3FbPg4vxxf1WfsAG4FeSXg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">用Fiddler监控HTTP(s)请求。</figcaption></figure><p id="a222" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">想象你有一个愉快的工作日，享受你最喜欢的咖啡。不知从哪里，您被告知在生产环境中报告了JavaScript代码抛出错误的问题，而在您的本地主机上一切正常。</p><p id="f20c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，也许这一天不会再令人愉快了。</p><p id="82a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在生产环境中调试JS代码通常不是一件容易的事情。简化的JavaScript很难理解，这个问题可能是驻留在生产环境中的数据所特有的。追根究底可能非常具有挑战性。</p><p id="34d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解决方案的一个可能途径是尝试在您的本地主机上重新创建相同的场景。这可能是一项单调乏味的任务，可能需要复制大量数据，甚至需要试凑法。</p><p id="24ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您能够将API调用从本地主机客户端定向到生产/测试服务器，岂不是更简单。这将使您能够在本地机器上调试JS代码，并从所需的环境中获取数据。为了做到这一点，我们需要启用<a class="ae lb" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" rel="noopener ugc nofollow" target="_blank">跨源资源共享</a> (CORS)。</p><blockquote class="lc ld le"><p id="229a" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated">跨源资源共享(<a class="ae lb" href="https://developer.mozilla.org/en-US/docs/Glossary/CORS" rel="noopener ugc nofollow" target="_blank"> CORS </a>)是一种机制，它使用额外的<a class="ae lb" href="https://developer.mozilla.org/en-US/docs/Glossary/HTTP" rel="noopener ugc nofollow" target="_blank"> HTTP </a>报头来告诉浏览器，让在一个源(域)上运行的web应用程序有权访问来自不同源的服务器的选定资源。</p></blockquote><p id="d6db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">出于安全原因，浏览器限制从脚本内部发起跨源HTTP请求。这就是Fiddler出现的原因。</p><h1 id="a213" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">什么是Fiddler，它是如何工作的？</h1><p id="54a8" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">Fiddler是一个Web调试代理，它记录你的计算机和互联网之间的所有HTTP(S)流量。它允许您检查流量，设置断点，并“摆弄”传入或传出的数据。</p><p id="1da6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当Fiddler开始捕获流量时，它向<a class="ae lb" href="https://docs.microsoft.com/windows/desktop/wininet/about-wininet" rel="noopener ugc nofollow" target="_blank"> Windows Internet (WinINet) </a>网络组件注册，并请求所有应用程序(如Chrome、Firefox、IE等)开始将它们的请求定向到Fiddler。Fiddler然后位于您的客户机和服务器之间，监听HTTP(s)流量的端口，为它提供记录流量的能力，并充当修改HTTP请求和响应的代理。</p><p id="414b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该应用程序是免费的，可以在提琴手网站<a class="ae lb" href="https://www.fiddler2.com/" rel="noopener ugc nofollow" target="_blank">上的所有主要操作系统上获得，同时还有大量的文档和教程视频。</a></p><h1 id="eccf" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">让我们把手弄脏吧。</h1><p id="a866" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">您首先需要安装和设置Fiddler。相关说明可在<a class="ae lb" href="https://www.fiddler2.com/" rel="noopener ugc nofollow" target="_blank">提琴手网站</a>上找到。</p><p id="d120" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动应用程序，导航到<code class="fe mm mn mo mp b">Tools</code> &gt; <code class="fe mm mn mo mp b">Fiddler Options</code> &gt; <code class="fe mm mn mo mp b">HTTPS</code> &gt; <code class="fe mm mn mo mp b">Decrypt HTTPS traffic</code>，安装认证。</p><p id="1058" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe mm mn mo mp b">CTRL + R</code>或在<code class="fe mm mn mo mp b">Rules</code>菜单下找到<code class="fe mm mn mo mp b">Customize Rules...</code>选项来打开Fiddler使用的自定义规则脚本。</p><p id="d399" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Handlers类下添加以下代码以及其他<code class="fe mm mn mo mp b">RulesOption</code>声明。</p><pre class="km kn ko kp gt mq mp mr ms aw mt bi"><span id="34a3" class="mu lk iq mp b gy mv mw l mx my">public static RulesOption("Force CORS")<br/>var m_ForceCORS: boolean = true;</span></pre><p id="c415" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，在<code class="fe mm mn mo mp b">OnBeforeRequest</code>方法中添加以下代码</p><pre class="km kn ko kp gt mq mp mr ms aw mt bi"><span id="9416" class="mu lk iq mp b gy mv mw l mx my">if (m_ForceCORS &amp;&amp; oSession.oRequest.headers.HTTPMethod == "OPTIONS") { <br/>	oSession.utilCreateResponseAndBypassServer();<br/>	<br/>	oSession.oResponse.headers.Add("Access-Control-Allow-Origin", oSession.oRequest.headers["Origin"]) ;<br/>	oSession.oResponse.headers.Add("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");			<br/>	oSession.oResponse.headers.Add("Access-Control-Allow-Headers", "Content-Type, Authorization, Accept, Csrf-Token, X-Requested-With, cloudSession, WbeSession, Cookie");<br/>	oSession.oResponse.headers.Add("Access-Control-Max-Age", "1728000");<br/>	oSession.oResponse.headers.Add("Access-Control-Allow-Credentials", "true");<br/>	<br/>	oSession.responseCode = 200;<br/>}</span></pre><p id="c875" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们使用fiddler创建一个响应对象，并添加特定于CORS的头。您可能希望根据您的要求更改上面提到的标题。</p><blockquote class="lc ld le"><p id="995a" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated">在Fiddler从客户端读取完整的HTTP(S)请求后调用。如果需要，您应该使用此方法来更新请求标头或请求正文。</p><p id="8e44" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><code class="fe mm mn mo mp b">utilCreateResponseAndBypassServer: </code>在OnBeforeRequest内部调用，创建一个响应对象，绕过服务器。</p></blockquote><p id="c361" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，在<code class="fe mm mn mo mp b">OnBeforeResponse</code>方法中添加以下代码</p><pre class="km kn ko kp gt mq mp mr ms aw mt bi"><span id="9fd4" class="mu lk iq mp b gy mv mw l mx my">if (m_ForceCORS &amp;&amp; oSession.oRequest.headers.Exists("Origin")) { <br/>	oSession.oResponse.headers.Remove("Access-Control-Allow-Origin");<br/>	oSession.oResponse.headers.Add("Access-Control-Allow-Origin", oSession.oRequest.headers["Origin"]) ;<br/>	<br/>	oSession.oResponse.headers.Remove("Access-Control-Allow-Methods");<br/>	oSession.oResponse.headers.Add("Access-Control-Allow-Methods", oSession.oRequest.headers["Access-Control-Allow-Methods"]);<br/>	<br/>	oSession.oResponse.headers.Remove("Access-Control-Allow-Headers"); <br/>	oSession.oResponse.headers.Add("Access-Control-Allow-Headers", oSession.oRequest.headers["Access-Control-Allow-Headers"]);<br/>	<br/>	oSession.oResponse.headers.Remove("Access-Control-Max-Age");<br/>	oSession.oResponse.headers.Add("Access-Control-Max-Age", oSession.oRequest.headers["Access-Control-Max-Age"]);<br/>	<br/>	oSession.oResponse.headers.Remove("Access-Control-Allow-Credentials");<br/>	oSession.oResponse.headers.Add("Access-Control-Allow-Credentials", oSession.oRequest.headers["Access-Control-Allow-Credentials"]);<br/>}</span></pre><blockquote class="lc ld le"><p id="40e2" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><code class="fe mm mn mo mp b"><em class="iq">OnBeforeResponse:</em></code>从服务器读取完整响应后触发。此事件在响应返回到客户端之前触发。如果需要，您应该使用此方法来更新响应标头或响应正文。</p></blockquote><p id="828d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的代码将修改从服务器接收的HTTP响应对象，以包含所需的CORS报头。</p><p id="3965" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成所有修改后，检查规则菜单下的<code class="fe mm mn mo mp b">Force CORS</code>选项是否已启用。</p><p id="1fed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按下<code class="fe mm mn mo mp b">F12</code>或使用<code class="fe mm mn mo mp b">Capture Traffic</code>选项开始通过Fiddler拦截HTTP请求。现在，您应该能够从本地主机为您的测试/生产环境创建API了。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mz"><img src="../Images/c5da6d0d8b28d3a02aecae8d2886334f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PVKvfnhThpOR0zcUV1pY1w.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">200拨弄响应与CORS启用。</figcaption></figure></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h2 id="e2b0" class="mu lk iq bd ll nh ni dn lp nj nk dp lt jy nl nm lx kc nn no mb kg np nq mf nr bi translated">如果你喜欢这个故事，请点击👏按钮并分享，帮助其他人找到它！欢迎在下方留言评论。</h2></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><figure class="km kn ko kp gt kq gh gi paragraph-image"><a href="https://levelup.gitconnected.com"><div class="gh gi ns"><img src="../Images/9914c5dd23ac08b70eea6f4f9ba6fed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E6CoI_MRyZ1JInNPsBSHtA.png"/></div></a></figure><div class="nt nu gp gr nv nw"><a href="https://gitconnected.com/learn/javascript" rel="noopener  ugc nofollow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd ir gy z fp ob fr fs oc fu fw ip bi translated">学习JavaScript -最佳JavaScript教程(2019) | gitconnected</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">50大JavaScript教程-免费学习JavaScript。课程由开发人员提交并投票，从而实现…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">gitconnected.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok kv nw"/></div></div></a></div></div></div>    
</body>
</html>