<html>
<head>
<title>Deploying a React/Rails app with Netlify and Heroku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Netlify和Heroku部署React/Rails应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploying-a-react-rails-app-with-netlify-and-heroku-ed588e122b8d?source=collection_archive---------1-----------------------#2019-10-09">https://levelup.gitconnected.com/deploying-a-react-rails-app-with-netlify-and-heroku-ed588e122b8d?source=collection_archive---------1-----------------------#2019-10-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/3df6860fc789881ea3aac39640ea0f54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CHSi71VUY_d9gn4-eHBq7Q.jpeg"/></div></div></figure><p id="820e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我开始之前，让我给你介绍一下"<a class="ae kz" href="https://pet-roulette.com/" rel="noopener ugc nofollow" target="_blank">宠物轮盘赌的背景知识！</a>“成立即将进入部署。首先，我有两个独立的存储库。其次，我从一开始就用Postgres数据库创建了我的Rails API，如果您计划部署您的应用程序，这是非常可取的。最后，我使用<code class="fe la lb lc ld b">create-react-app</code>来启动我的React应用程序。</p><p id="d063" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">关于我为什么选择使用Netlify而不是Heroku的几点说明。第一——向Heroku部署双重回购要复杂得多。第二，Heroku是一个很棒的免费的Rails应用程序托管解决方案，但是它在30分钟不活动后会进入“睡眠”，重启需要整整30秒。加载一个网页的30秒等待感觉像是几十年。</p><p id="1841" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Netlify只能用于静态站点，没有“睡眠”或停机时间。网站会立即加载，这是一种更好的用户体验。如果要从Rails API获取数据并显示在应用程序中，最好在<code class="fe la lb lc ld b">componentDidMount</code>生命周期方法中有获取请求，并将其放在<code class="fe la lb lc ld b">App.js</code>中。这样，一旦页面被访问，API就会从空闲状态被唤醒。您还可以利用<code class="fe la lb lc ld b">loading</code>状态来显示一个灰色框或某种短暂延迟的消息，而您的SPA的其余部分已经被渲染。</p><p id="b349" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">第一部分——将React应用程序部署到Netlify </strong></p><ul class=""><li id="40d7" class="lf lg it kd b ke kf ki kj km lh kq li ku lj ky lk ll lm ln bi translated">创建一个Netlify帐户，并选择“新站点来自”。按照提示链接您的GitHub帐户，并选择您希望部署的repo。您将有机会选择哪个分支，指定构建命令<code class="fe la lb lc ld b">npm run build</code>(如果您使用npm)和发布目录，默认为“构建”。</li><li id="3534" class="lf lg it kd b ke lo ki lp km lq kq lr ku ls ky lk ll lm ln bi translated">我还建议安装<a class="ae kz" href="https://www.netlify.com/docs/cli/" rel="noopener ugc nofollow" target="_blank"> Netlify CLI </a>。使用CLI，您可以创建新的构建版本<code class="fe la lb lc ld b">npm run build</code>，然后进行部署并查看预览<code class="fe la lb lc ld b">netlify deploy</code>，然后再部署到生产环境<code class="fe la lb lc ld b">netlify deploy --prod</code>。</li><li id="171b" class="lf lg it kd b ke lo ki lp km lq kq lr ku ls ky lk ll lm ln bi translated">Netlify还使转发到自定义域变得非常容易——它会提示您输入您的域，要求您验证您是否是所有者，然后给您四台域名服务器与您的域提供商共享，就这样！</li></ul><p id="6ebf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您在SPA中使用React Router进行客户端路由，有几个额外的步骤来防止您的生产应用程序中出现错误，因为如果用户试图从根目录以外的任何位置加载页面，Netlify将显示“Page Not Found”错误。要解决这个问题:</p><ul class=""><li id="bf7b" class="lf lg it kd b ke kf ki kj km lh kq li ku lj ky lk ll lm ln bi translated">在公共文件夹或React应用程序中，创建一个名为<code class="fe la lb lc ld b">_redirects</code>的新文件，并添加以下代码:</li></ul><pre class="lt lu lv lw gt lx ld ly lz aw ma bi"><span id="f09b" class="mb mc it ld b gy md me l mf mg">/*    /index.html   200</span></pre><p id="8b32" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">第二部分—将Rails API部署到Heroku </strong></p><ul class=""><li id="e4b8" class="lf lg it kd b ke kf ki kj km lh kq li ku lj ky lk ll lm ln bi translated">将<code class="fe la lb lc ld b">gem 'rails_12factor'</code>和<code class="fe la lb lc ld b">gem 'foreman'</code>添加到您的gemfile并运行<code class="fe la lb lc ld b">bundle</code>。</li><li id="49db" class="lf lg it kd b ke lo ki lp km lq kq lr ku ls ky lk ll lm ln bi translated">在应用程序的根目录中创建一个Procfile，并包含以下代码:</li></ul><pre class="lt lu lv lw gt lx ld ly lz aw ma bi"><span id="8d86" class="mb mc it ld b gy md me l mf mg">web: bundle exec rails s<br/>release: bundle exec bin/rake db:migrate</span></pre><ul class=""><li id="61e2" class="lf lg it kd b ke kf ki kj km lh kq li ku lj ky lk ll lm ln bi translated">更新CORS设置，将您的网络URL列入白名单。如果您还没有，将<code class="fe la lb lc ld b">gem 'rack-cors'</code>添加到您的gemfile并运行<code class="fe la lb lc ld b">bundle</code>。如果你已经在开发过程中使用了CORS，你只需要添加Netlify url和/或你的自定义域到<code class="fe la lb lc ld b">cors.rb</code>。如果不是，在<code class="fe la lb lc ld b">cors.rb</code>中，取消注释或添加以下内容:</li></ul><pre class="lt lu lv lw gt lx ld ly lz aw ma bi"><span id="2114" class="mb mc it ld b gy md me l mf mg">Rails.application.config.middleware.insert_before 0, Rack::Cors do<br/>  allow do<br/>    origins 'YOUR-NETLIFY_URL', 'YOUR-CUSTOM-DOMAIN'</span><span id="ad25" class="mb mc it ld b gy mh me l mf mg">    resource '*',<br/>      headers: :any,<br/>      methods: [:get, :post, :put, :patch, :delete, :options, :head]<br/>  end<br/>end</span></pre><p id="cc31" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将允许您的React前端向您的API发送和获取数据。</p><ul class=""><li id="6415" class="lf lg it kd b ke kf ki kj km lh kq li ku lj ky lk ll lm ln bi translated">提交所有更改，并推送到GitHub。</li><li id="3eb1" class="lf lg it kd b ke lo ki lp km lq kq lr ku ls ky lk ll lm ln bi translated">接下来，创建一个Heroku账号，并安装<a class="ae kz" href="https://devcenter.heroku.com/articles/heroku-cli" rel="noopener ugc nofollow" target="_blank"> Heroku工具带和CLI </a>。</li><li id="b6f4" class="lf lg it kd b ke lo ki lp km lq kq lr ku ls ky lk ll lm ln bi translated">在命令行中输入<code class="fe la lb lc ld b">heroku create YOUR-APP-NAME</code>。如果您以前从未使用过Heroku CLI，它会提示您使用用户名和密码登录。</li><li id="1e4c" class="lf lg it kd b ke lo ki lp km lq kq lr ku ls ky lk ll lm ln bi translated">如果使用主分支，输入<code class="fe la lb lc ld b">$ git push heroku</code>，如果使用其他分支，输入<code class="fe la lb lc ld b">git push heroku BRANCH-NAME</code>。</li></ul><p id="7845" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这一点上，你应该准备好了——任何更新都可以通过重复最后一步来推送。但是，在我最近的两次部署中，我遇到了以下错误:</p><pre class="lt lu lv lw gt lx ld ly lz aw ma bi"><span id="cba9" class="mb mc it ld b gy md me l mf mg">remote:        Removing bundler (2.0.1)<br/>remote:        Bundle completed (47.21s)<br/>remote:        Cleaning up the bundler cache.<br/>remote: -----&gt; Installing node-v10.14.1-linux-x64<br/>remote:        Detected manifest file, assuming assets were compiled locally<br/>remote: -----&gt; Detecting rails configuration<br/>remote: -----&gt; Detecting rake tasks<br/>remote: <br/>remote:  !<br/>remote:  !     Could not detect rake tasks<br/>remote:  !     ensure you can run `$ bundle exec rake -P` against your app<br/>remote:  !     and using the production group of your Gemfile.<br/>remote:  !     Activating bundler (2.0.1) failed:<br/>remote:  !     Could not find 'bundler' (2.0.1) required by your /tmp/build_94d6a4f5d4fbb862672998d5d06d2506/Gemfile.lock.<br/>remote:  !     To update to the latest version installed on your system, run `bundle update --bundler`.<br/>remote:  !     To install the missing version, run `gem install bundler:2.0.1`<br/>remote:  !     Checked in 'GEM_PATH=/tmp/build_94d6a4f5d4fbb862672998d5d06d2506/vendor/bundle/ruby/2.7.0', execute `gem env` for more information<br/>remote:  !     <br/>remote:  !     To install the version of bundler this project requires, run `gem install bundler -v '2.0.1'`<br/>remote:  !<br/>remote: /app/tmp/buildpacks/b7af5642714be4eddaa5f35e2b4c36176b839b4abcd9bfe57ee71c358d71152b4fd2cf925c5b6e6816adee359c4f0f966b663a7f8649b0729509d510091abc07/lib/language_pack/helpers/rake_runner.rb:106:in `load_rake_tasks!': Could not detect rake tasks (LanguagePack::Helpers::RakeRunner::CannotLoadRakefileError)</span></pre><p id="1fbf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">作为回应，我跑了<code class="fe la lb lc ld b">bundle exec rake -P</code>，还好。我更新了bundler，移除了bundler，然后用指定的版本重新安装。我谷歌了一下这个错误，看了几十个公开的罚单和Stackoverflow帖子。最终，我解决了这个问题，删除了<code class="fe la lb lc ld b">Gemfile.lock</code>中的最后两行。</p><pre class="lt lu lv lw gt lx ld ly lz aw ma bi"><span id="bbe4" class="mb mc it ld b gy md me l mf mg">BUNDLED WITH<br/>   2.0.1</span></pre><p id="97aa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Heroku开发中心有大量关于托管rails应用程序的文档，如果您遇到其他错误的话！</p></div></div>    
</body>
</html>