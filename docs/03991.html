<html>
<head>
<title>Integrating New Relic APM with UWSGI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">集成新遗迹APM和UWSGI</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/integrating-new-relic-apm-with-uwsgi-1dedcd0f92ff?source=collection_archive---------21-----------------------#2020-06-04">https://levelup.gitconnected.com/integrating-new-relic-apm-with-uwsgi-1dedcd0f92ff?source=collection_archive---------21-----------------------#2020-06-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a9b1bebc0a7c4e9a88ac9d5160c3667c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ZXIZNxPk7mZmmxZB_yzYw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">信用——scnsoft.com</figcaption></figure><p id="03c8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">APM(应用程序性能管理)用于监控和管理软件应用程序的性能和可用性。</p><p id="612b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以使用它来计算诸如API花费的时间、运行数据库查询花费的时间、运行函数花费的时间等等。</p><p id="5029" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要提高系统的性能，首先需要以某种方式测量性能，而APM正好可以用来做这件事。</p><p id="ed26" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">市场上有不同的APM，但在这里我们将讨论如何为您的Django/Flask应用程序集成New Relic APM和UWSGI，所以让我们开始吧。</p><h2 id="dadd" class="la lb iq bd lc ld le dn lf lg lh dp li kn lj lk ll kr lm ln lo kv lp lq lr ls bi translated">安装新的遗迹python库</h2><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="30cb" class="la lb iq ly b gy mc md l me mf">pip install newrelic</span></pre><h2 id="7b0b" class="la lb iq bd lc ld le dn lf lg lh dp li kn lj lk ll kr lm ln lo kv lp lq lr ls bi translated"><strong class="ak">创建一个新的遗迹配置文件</strong></h2><p id="ac84" class="pw-post-body-paragraph kc kd iq ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">您可以使用以下命令来生成一个新的Relic配置命令，只需用您帐户的许可证密钥替换您的-LICENSE-KEY。</p><p id="98da" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe ml mm mn ly b">newrelic-admin generate-config YOUR-LICENSE-KEY newrelic.ini</code></p><h2 id="bc00" class="la lb iq bd lc ld le dn lf lg lh dp li kn lj lk ll kr lm ln lo kv lp lq lr ls bi translated">定义环境</h2><p id="cf24" class="pw-post-body-paragraph kc kd iq ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">现在，是时候定义您想要监控的不同环境了。例如，生产应用服务器、生产芹菜服务器、暂存服务器等。</p><p id="33d9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为此，打开<code class="fe ml mm mn ly b">newrelic.ini</code>文件并滚动到底部。您应该会看到一些虚拟环境，如开发和测试。</p><p id="7500" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在这里，您可以这样定义您的环境:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="6288" class="la lb iq ly b gy mc md l me mf">[newrelic:production-app]<br/>app_name = myapp (production)<br/>monitor_mode = true</span><span id="8615" class="la lb iq ly b gy mo md l me mf">[newrelic:production-celery]<br/>app_name = myapp (celery)<br/>monitor_mode = true</span></pre><p id="7b9f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这里，<code class="fe ml mm mn ly b">production-app</code>是您将作为环境变量<code class="fe ml mm mn ly b">NEW_RELIC_ENVIRONMENT</code>传递给UWSGI配置的内容</p><p id="cec9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe ml mm mn ly b">app_name</code>是您将在New Relic APM仪表板中看到的应用程序的名称，而<code class="fe ml mm mn ly b">monitor_mode</code>表示New Relic是否会将有关您的应用程序的数据发送到New Relic收集器。</p><p id="cc07" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在您已经完成了新的Relic配置，是时候对您的UWSGI配置进行更改了。在这里，我将介绍运行UWSGI的两种流行方式的集成。</p><h1 id="0d3c" class="mp lb iq bd lc mq mr ms lf mt mu mv li mw mx my ll mz na nb lo nc nd ne lr nf bi translated">使用systemd</h1><p id="8335" class="pw-post-body-paragraph kc kd iq ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">您需要在systemctl配置中进行两项更改。</p><figure class="lt lu lv lw gt jr"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">systemd的uwsgi.service文件</figcaption></figure><p id="0f75" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在<strong class="ke ir">环境</strong>选项中，您需要定义两个环境变量，如上面的配置文件所示:</p><ol class=""><li id="dae2" class="ni nj iq ke b kf kg kj kk kn nk kr nl kv nm kz nn no np nq bi translated"><strong class="ke ir">新遗留配置文件</strong> —新遗留配置文件的绝对路径。</li><li id="8bbe" class="ni nj iq ke b kf nr kj ns kn nt kr nu kv nv kz nn no np nq bi translated"><strong class="ke ir">NEW _ RELIC _ ENVIRONMENT</strong>—配置文件中指定的环境名称。</li></ol><p id="930c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在<strong class="ke ir"> ExecStart </strong>选项中，您只需要在UWSGI命令前面加上<code class="fe ml mm mn ly b">newrelic-admin run-program</code></p><p id="0823" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，因为这是一个systemctl配置，所以您需要给出<code class="fe ml mm mn ly b">newrelic-admin</code>的绝对路径(一旦您用pip安装了New Relic，New Relic admin就可以作为二进制文件获得)。</p><p id="c4a0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，使用以下命令重新加载配置，并重新启动uwsgi服务:</p><p id="b960" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe ml mm mn ly b">sudo systemctl daemon-reload<br/>sudo systemctl restart uwsgi</code></p><h1 id="3df6" class="mp lb iq bd lc mq mr ms lf mt mu mv li mw mx my ll mz na nb lo nc nd ne lr nf bi translated">使用主管</h1><p id="b791" class="pw-post-body-paragraph kc kd iq ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">像这里的systemctl一样，您也需要做两处更改。</p><figure class="lt lu lv lw gt jr"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">主管的uwsgi.conf文件</figcaption></figure><p id="1591" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在<strong class="ke ir">环境</strong>选项中，您需要像上面的配置文件一样定义两个环境变量— <strong class="ke ir"> NEW_RELIC_CONFIG_FILE </strong>和<strong class="ke ir"> NEW_RELIC_ENVIRONMENT </strong></p><p id="d6df" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在<strong class="ke ir">命令</strong>选项中，您只需要在UWSGI命令前面加上<code class="fe ml mm mn ly b">newrelic-admin run-program</code>(指定绝对路径)</p><p id="2f87" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，使用以下命令重新启动supervisor:</p><p id="22d9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe ml mm mn ly b">sudo systemctl restart supervisor</code></p><p id="9692" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您也可以使用<strong class="ke ir"> supervisorctl </strong>命令。</p></div><div class="ab cl nw nx hu ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="ij ik il im in"><p id="cf8c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">可能需要15-20分钟才能看到New Relic APM仪表板中的数据。如果没有收到任何数据，请检查UWSGI日志进行调试。</p><p id="1e05" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果您使用管理程序运行<strong class="ke ir"> celery </strong>,那么您可以遵循管理程序配置的相同步骤(定义环境变量和前置New Relic Admin ),它应该可以很好地工作。</p><p id="bc56" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我希望你能够配置新遗物，而不是像我一样花两个小时挣扎:P <br/>如果你正面临一些问题，请在评论中告诉我！</p></div><div class="ab cl nw nx hu ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="ij ik il im in"><p id="8c5f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">非常感谢你阅读这篇文章。如果你喜欢它，请给它一些掌声，让更多的人从中受益！</p></div></div>    
</body>
</html>