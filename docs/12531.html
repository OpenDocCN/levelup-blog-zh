<html>
<head>
<title>Rescheduling a Lambda when the target data outside of AWS isn’t available</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当AWS之外的目标数据不可用时，重新调度Lambda</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/rescheduling-a-lambda-when-target-data-outside-of-aws-isnt-currently-available-d14590b7db32?source=collection_archive---------4-----------------------#2022-06-17">https://levelup.gitconnected.com/rescheduling-a-lambda-when-target-data-outside-of-aws-isnt-currently-available-d14590b7db32?source=collection_archive---------4-----------------------#2022-06-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e213" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">问题:</strong> <br/>您希望lambda通过AWS Glue工作流触发从AWS之外的数据源获取数据。数据可以在X小时和Y小时之间的任何时间获得，但是您需要尽快接收。</p><p id="d838" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下面的例子中，我将使用BigQuery中的一个表作为AWS外部的数据源。</p><p id="c7ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">注意:本文假设读者了解如何在AWS上创建和配置lambda，因此不会一步一步地介绍。它将包括所需的权限和lambda的代码示例。</em></p><p id="b95a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可用示例代码:<a class="ae km" href="https://github.com/MurrayCode/Reschedule-Lambda-Example" rel="noopener ugc nofollow" target="_blank">https://github.com/MurrayCode/Reschedule-Lambda-Example</a></p><p id="9d5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">解决方案:</strong></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi kn"><img src="../Images/3a67e1095eb2a8a6643e425984d923b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:940/format:webp/1*KX6Qo2s3NvpaaXGe8-dTSw.png"/></div></figure><p id="216f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了解决这个问题，可以使用Cron scheduled EventBridge规则来触发lambda，然后Lambda可以使用AWS SDK沿着各种路径前进。lambda将会发现预期的数据存在并触发粘合工作流，或者创建一个新的规则，目标是lambda在X分钟内重新触发。<em class="kl">注意:在这个例子中，X将是5分钟。</em></p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><p id="f055" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先创建一个lambda，使用Cron Scheduled EventBridge规则触发器在数据可用的最早时间进行调度。然后，lambda需要以下权限，以允许它执行所有必要的操作。</p><p id="d905" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">所需的IAM权限:</strong></p><p id="f505" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">“胶水:StartWorkflowRun”</em></p><p id="9d11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">"事件:移除目标"</em></p><p id="ca3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">“事件:put rule”</em></p><p id="da99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">“事件:删除规则”</em></p><p id="c547" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">“lambda:GetFunctionConfiguration”</em></p><p id="1337" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">所需的基于资源的政策</strong></p><p id="76a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">允许lambda:InvokeFunction在初始lambda cron规则和由lambda处理的重新计划规则上运行的策略</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi lc"><img src="../Images/040cf8f9f7591932cac09f68f605df45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3QzOHXd1yccaQ6dqeXHzIg.png"/></div></div></figure></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><p id="e17c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">λ代码:</strong></p><p id="89d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">注意:以下代码示例展示了该解决方案所需的所有SDK调用。</em></p><p id="b214" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">阶段1 </strong> — <strong class="jp ir">使用AWS SDK从lambda中删除重新计划规则。</strong></p><p id="2a90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最初，在我们的lambda中，如果这不是Lambda在那天第一次运行，我们希望尝试删除将存在的规则。如果这个规则还不存在，那么我们捕获并记录错误，但是允许Lambda继续。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi lh"><img src="../Images/6005e72254d3683dbcaf5605bbca61fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*qVWozfXkonT-WQX3yfaW4g.png"/></div></figure></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><p id="ef8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">阶段2 —检查数据是否存在:</strong></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi li"><img src="../Images/23984a3872c30a8cd7c944e03e0669a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1098/format:webp/1*I6QexFTgteEpFU7AvSPwIA.png"/></div></figure><p id="4690" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本例中，我们将检查BigQuery中每天创建的表。首先，我们通过Google Cloud SDK创建一个BigQuery客户端，接下来检索数据集，并在数据集中获取表。</p><p id="dd6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在try/catch中，我们尝试获取该表，如果它存在，我们返回true，如果我们捕获到错误，我们检查错误代码是否为404(未找到),这意味着数据当前不可用，然后我们返回false。否则我们会抛出一个新的错误。</p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/b171b726f601081efca461d926977930.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*ntjGNhF3k9C-gYIMwATumw.png"/></div></figure><p id="66d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们调用我们的函数并设置lambda可以通过的两条路径。</p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><p id="7443" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">路径1 —表格存在:</strong></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/764a5d9f29ae40d1659e1fa1e74c38ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*ofB8WGfuSIxs9LN2xLGTNg.png"/></div></figure><p id="14bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果表格存在，我们创建一个新的glue客户机并运行预期的工作流。</p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><p id="554a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">路径2 —表格不存在:</strong></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi ll"><img src="../Images/1b9b843b4a480cf02b924a80f3cbaf02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*Nt_CIE-rSDHO5gAVqB-Llw.png"/></div></figure><p id="36b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在该表不存在的情况下，我们使用CloudWatchEvents客户端函数putRule创建一个具有所需重新计划时间的新规则，在本例中为5分钟，并将状态设置为“ENABLED”。</p><p id="a42a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们通过SDK创建一个新的lambda客户端，并使用getFunctionConfiguration函数传递我们在AWS上创建lambda时给它的名称。然后我们从这个带有<em class="kl">数据的结果中提取出λARN。并为下一个CloudWatchEvents客户端SDK调用putTargets提供参数，该调用接受规则名称、目标lambda ARN和一个Id。</em></p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><p id="ba95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是示例Lambda代码的完整图像:</p><p id="ef3e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae km" href="https://github.com/MurrayCode/Reschedule-Lambda-Example" rel="noopener ugc nofollow" target="_blank">https://github.com/MurrayCode/Reschedule-Lambda-Example</a></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi lm"><img src="../Images/a0e71ae9a51d990da56adfb6c2d9bc0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*T_XgoFszSU6KyRM3LbjsEQ.png"/></div></figure></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="c13e" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">分级编码</h1><p id="c881" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">感谢您成为我们社区的一员！更多内容见<a class="ae km" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>。<br/>跟随:<a class="ae km" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a>，<a class="ae km" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">领英</a>，<a class="ae km" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">通迅</a> <br/> <strong class="jp ir">升一级正在改造理工大招聘➡️ </strong> <a class="ae km" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">加入我们的人才集体</strong> </a></p></div></div>    
</body>
</html>