<html>
<head>
<title>Setting Up a High Availability Redis Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">设置高可用性Redis集群</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/setting-up-redis-cluster-6a1012155868?source=collection_archive---------3-----------------------#2021-01-28">https://levelup.gitconnected.com/setting-up-redis-cluster-6a1012155868?source=collection_archive---------3-----------------------#2021-01-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1443ef79b11a4a5b5b7626bba697b905.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qGh6_B7lnNTrMHDi.jpeg"/></div></div></figure><h1 id="4c81" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">1.概观</h1><p id="27c6" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在本文中，我们将在基于docker的环境中建立一个Redis集群。首先，我们将设置3个redis实例并启用数据复制，然后，我们将为集群设置3个sentinel服务。我们还将设置一个客户端应用程序来与Redis集群进行交互。</p><blockquote class="lu lv lw"><p id="3209" class="kw kx lx ky b kz ly lb lc ld lz lf lg ma mb lj lk mc md ln lo me mf lr ls lt ij bi translated"><strong class="ky ir">查看我的</strong> <a class="ae mg" href="https://www.udemy.com/course/learn-to-deploy-hyperledger-fabric-v22-on-multihost/?referralCode=8AF12D11DDC9A3D5B636" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">课程，了解多主机上的Hyperledger Fabric部署</strong> </a></p></blockquote><h1 id="52b5" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">2.分身术</h1><p id="34db" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在Redis复制的基础上(不包括Redis集群或Redis Sentinel作为附加层提供的高可用性特性)，有一个使用和配置非常简单的<em class="lx"> leader follower </em>(主从)复制:它允许副本Redis实例成为主实例的精确副本。每当链接断开时，副本将自动重新连接到主服务器，并尝试成为其精确副本<em class="lx">而不管主服务器发生了什么</em>。</p><h1 id="4451" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak"> 3。认证</strong></h1><p id="87d5" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">使用强密码运行redis非常重要，因为默认情况下，redis没有配置为使用密码，因此任何人都可以作为复制的一部分连接到它。我们必须为每个副本配置一个强密码，还必须为每个副本配置主节点密码。</p><p id="df80" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">这是使用配置文件<code class="fe mh mi mj mk b">redis.conf</code>配置的</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="810f" class="mt jz iq mk b gy mu mv l mw mx">#redis-1 configuration<br/>protected-mode no<br/>port 6379<br/>slaveof redis-0 6379<br/><br/>#authentication<br/>masterauth a-very-complex-password-here<br/>requirepass a-very-complex-password-here</span></pre><p id="fda3" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated"><code class="fe mh mi mj mk b">slaveof</code>属性定义该实例是<code class="fe mh mi mj mk b">redis-0</code>实例的从实例。而这个<code class="fe mh mi mj mk b">slaveof</code>属性让<code class="fe mh mi mj mk b">redis-0</code>主和复制工作。而<code class="fe mh mi mj mk b">requirepass</code>是认证这个节点的密码，任何想要连接到这个实例的人都必须有这个密码。我们还必须使用<code class="fe mh mi mj mk b">masterauth</code>属性指定主节点密码。</p><h1 id="4fa7" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">4.集群设置</h1><p id="3223" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">为了设置redis集群，我们需要一个网络，所有redis实例、sentinel服务和客户端应用程序都可以通过这个网络进行通信。</p><p id="213d" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">创建<code class="fe mh mi mj mk b">redis</code>网络运行:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="dcb9" class="mt jz iq mk b gy mu mv l mw mx">docker network create redis</span></pre><p id="cc99" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">一旦创建了网络，我们就可以设置redis实例:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="f945" class="mt jz iq mk b gy mu mv l mw mx">docker run -d --rm --name redis-0 \<br/> --net redis \<br/> -v ${PWD}/redis-0:/etc/redis/ \<br/> redis:6.0-alpine redis-server /etc/redis/redis.conf</span><span id="b2eb" class="mt jz iq mk b gy my mv l mw mx">docker run -d --rm --name redis-1 \<br/>--net redis \<br/>-v ${PWD}/redis-1:/etc/redis/ \<br/>redis:6.0-alpine redis-server /etc/redis/redis.conf</span><span id="d7e1" class="mt jz iq mk b gy my mv l mw mx">docker run -d --rm --name redis-2 \<br/>--net redis \<br/>-v ${PWD}/redis-2:/etc/redis/ \<br/>redis:6.0-alpine redis-server /etc/redis/redis.conf</span></pre><h1 id="b3c3" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">5.高可用性</h1><p id="274f" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Redis <strong class="ky ir"> Sentinel </strong>为Redis提供高可用性。实际上，这意味着使用Sentinel我们可以创建一个Redis部署，在没有人工干预的情况下抵御某些类型的故障。</p><p id="405b" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">Redis Sentinel提供了类似于<strong class="ky ir">监控</strong>、<strong class="ky ir">通知</strong>、<strong class="ky ir">自动故障转移和配置提供者</strong>的特性。</p><p id="0802" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">要建立sentinel，我们至少需要3个Redis节点，以便获得法定人数的大多数选票。</p><h1 id="8f32" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">6.配置哨兵</h1><p id="17da" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">为了设置sentinel流程，我们需要一些配置文件。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="64a7" class="mt jz iq mk b gy mu mv l mw mx">port 5000</span><span id="6d53" class="mt jz iq mk b gy my mv l mw mx">sentinel monitor mymaster redis-0 6379 2</span><span id="f478" class="mt jz iq mk b gy my mv l mw mx">sentinel down-after-milliseconds mymaster 5000</span><span id="96f2" class="mt jz iq mk b gy my mv l mw mx">sentinel failover-timeout mymaster 60000</span><span id="875f" class="mt jz iq mk b gy my mv l mw mx">sentinel parallel-syncs mymaster 1</span><span id="f6f2" class="mt jz iq mk b gy my mv l mw mx">sentinel auth-pass mymaster a-very-complex-password-here</span></pre><p id="4534" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated"><code class="fe mh mi mj mk b">port 5000</code>定义sentinel进程运行的端口。<code class="fe mh mi mj mk b">mymaster</code>是<strong class="ky ir">主群名称。</strong> <code class="fe mh mi mj mk b">redis-0</code>是redis-0的DNS名称，<code class="fe mh mi mj mk b">6379</code>是redis-0运行的端口，数字<code class="fe mh mi mj mk b">2</code>是法定人数，因此该设置要求至少2票才能做出任何决定。</p><p id="68be" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">之后，我们将down-after-milliseconds定义为5 <code class="fe mh mi mj mk b">000</code>毫秒，这意味着如果主节点在5000毫秒内没有响应，那么它将被认为是死的，或者sentinel将等待主节点初始化故障转移多长时间。</p><p id="c708" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated"><code class="fe mh mi mj mk b">parallel-syncs</code>设置故障转移后可以重新配置为同时使用新主服务器的副本服务器的数量。</p><p id="b33b" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">最后，我们使用<code class="fe mh mi mj mk b">auth-pass</code>定义认证密码。</p><h1 id="394b" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak"> 7。启动哨兵服务</strong></h1><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/4fe1456fd7b48dfc10784361b32cfcf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:710/format:webp/1*bvyECbFlV-SBMjMb9fX30Q.png"/></div></figure><p id="15f9" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">要启动sentinel服务运行:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="3b5b" class="mt jz iq mk b gy mu mv l mw mx">docker run -d --rm --name sentinel-0 --net redis \<br/>-v ${PWD}/sentinel-0:/etc/redis/ \<br/>redis:6.0-alpine \<br/>redis-sentinel /etc/redis/sentinel.conf</span><span id="c18d" class="mt jz iq mk b gy my mv l mw mx">docker run -d --rm --name sentinel-1 --net redis \<br/>-v ${PWD}/sentinel-1:/etc/redis/ \<br/>redis:6.0-alpine \<br/>redis-sentinel /etc/redis/sentinel.conf</span><span id="bdce" class="mt jz iq mk b gy my mv l mw mx">docker run -d --rm --name sentinel-2 --net redis \<br/>-v ${PWD}/sentinel-2:/etc/redis/ \<br/>redis:6.0-alpine \<br/>redis-sentinel /etc/redis/sentinel.conf</span></pre><p id="5d76" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">验证日志，在日志中，我们应该可以看到其他sentinel节点，如果看不到，则意味着存在一些配置问题。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="0cfe" class="mt jz iq mk b gy mu mv l mw mx">docker logs sentinel-0</span></pre><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/03303d9b3bc684ef5b515ae252193c52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vfu6XGcxWs90KpdffBlS_Q.png"/></div></div></figure><h1 id="86be" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">8.客户应用程序</h1><p id="7331" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我在nodejs上编写了一个客户端应用程序，它将当前时间戳存储在Redis集群上。客户端应用程序与sentinel服务通信，而不是直接与Redis实例通信，这确保了如果我们的主Redis实例死亡，我们的应用程序仍将正常运行，因为我们的读/写请求将被转发到从仲裁中选出的当前主Redis实例。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="f6b3" class="mt jz iq mk b gy mu mv l mw mx"><strong class="mk ir"><em class="lx">const</em></strong> redis <strong class="mk ir">=</strong> <strong class="mk ir">new</strong> Redis({<br/>db: 0,<br/>password: "a-very-complex-password-here",<br/>sentinels: [<br/>{ host: host1, port: port },<br/>{ host: host2, port: port },<br/>{ host: host3, port: port },<br/>],<br/>name: "mymaster",<br/>});</span></pre><p id="4494" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">要构建客户端应用程序，请运行:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="d51d" class="mt jz iq mk b gy mu mv l mw mx">docker build ./applications/client/ -t aditya/redis-client:v1.0.0</span></pre><p id="d56d" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">运行客户端应用程序:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="d915" class="mt jz iq mk b gy mu mv l mw mx">docker run -it --net redis \<br/>--env-file .env \<br/>-p 80:80 \<br/>aditya/redis-client:v1.0.0</span></pre><p id="3c76" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">现在打开浏览器并访问<code class="fe mh mi mj mk b"><a class="ae mg" href="http://localhost:80" rel="noopener ugc nofollow" target="_blank">http://localhost:80</a></code>，每次刷新页面时，我们都会将值存储到redis中。</p><p id="bb4f" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">为了测试高可用性，我们可以通过以下方式终止主redis实例</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="ad50" class="mt jz iq mk b gy mu mv l mw mx">docker rm -f redis-0</span></pre><p id="6c3c" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">现在，如果您尝试访问客户端应用程序，我们仍然可以看到该应用程序正在工作。</p><p id="d71f" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">为了检查哪个实例是当前的主节点，我们可以运行以下命令:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="10e2" class="mt jz iq mk b gy mu mv l mw mx">docker logs sentinel-0<br/>docker exec -it sentinel-0 sh<br/>redis-cli -p 5000<br/>info<br/>sentinel master mymaster</span></pre><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/ba2560b41d438ca30700bb93237aede2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zFVFAfFBal2-Grq2E9Zp_A.png"/></div></div></figure><h1 id="38ae" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">摘要</h1><p id="22c4" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在本文中，我们学习了如何设置3节点Redis集群，首先设置身份验证和应用程序，然后设置sentinel服务，最后设置客户端应用程序并测试高可用性。你可以在这里找到<a class="ae mg" href="https://github.com/adityajoshi12/redis-clustering" rel="noopener ugc nofollow" target="_blank">的源代码。</a></p><p id="b008" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">如果你觉得这篇文章很有帮助，请点击拍手按钮，并跟随我阅读更多这样的信息丰富的文章。</p><p id="189a" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh mb lj lk ll md ln lo lp mf lr ls lt ij bi translated">你可以在<a class="ae mg" href="https://linkedin.com/in/adityajoshi12" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>上找到我或者在<a class="ae mg" href="https://github.com/adityajoshi12" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上跟踪我？如果这对你来说太社交化了，如果你想和我讨论技术，就给adityaprakashjoshi1@gmail.com发封邮件。</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/0012f12dfe9855414bbcb6f4f7c3e132.png" data-original-src="https://miro.medium.com/v2/resize:fit:292/0*Th-XUs3Z9-1jV5SG.gif"/></div></div></figure></div></div>    
</body>
</html>