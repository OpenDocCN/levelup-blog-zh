<html>
<head>
<title>Creating a Custom VPC with AWS CDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS CDK创建自定义VPC</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/creating-a-custom-vpc-with-aws-cdk-52f8788cb2d5?source=collection_archive---------1-----------------------#2021-01-11">https://levelup.gitconnected.com/creating-a-custom-vpc-with-aws-cdk-52f8788cb2d5?source=collection_archive---------1-----------------------#2021-01-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/fc95d706743c3d43d619397075dc2c43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*Y8mZrGlxZr-Bmi1VU-pCJg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">AWS CDK标志。信用——aws.amazon.com</figcaption></figure><p id="0463" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS CDK或云开发工具包允许您使用流行的语言(如Java、Python、JavaScript、TypeScript和C#)以编程方式创建和管理AWS资源。</p><p id="e476" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这一概念也被称为<strong class="ka ir"> IaC(基础设施即代码)，即</strong>将您的基础设施作为代码来管理，以促进自动化并最大限度地减少手动错误。</p><p id="e086" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以把CDK看作是创建云形成模板的一个替代方案。</p><h2 id="b52e" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated"><strong class="ak">为什么CDK上空有云形成？</strong></h2><ol class=""><li id="7de4" class="lp lq iq ka b kb lr kf ls kj lt kn lu kr lv kv lw lx ly lz bi translated">有了Cloudformation，您就有了一个JSON或YAML文件，您可以在其中定义资源的完整配置。该文件可能会很快变得过大而无法有效管理。<br/>有了CDK，你可以像任何应用程序一样，用多个文件和结构来管理你的资源。</li><li id="65d4" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">您可以利用编程语言的特性，如循环、库、if-else构造，来编写更少的代码，做更多的工作。干的原则(不要重复自己)。</li><li id="bd2f" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">更容易在团队中工作，并在ide中获得代码完成支持。</li><li id="758d" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">用面向对象的风格写代码，而不是JSON或YAML。</li><li id="d13d" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">在同一个CDK项目中，您可以保留脚本来创建非AWS资源，如RabbitMQ、Redis等。因此，您可以编写脚本来管理整个基础架构以及AWS资源。</li></ol><p id="5461" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在幕后，CDK从代码中生成了一个Cloudformation模板，并使用该模板在AWS中启动资源。只是省去了我们直接创建的麻烦。这样，您可以验证将要创建的基础结构。</p><p id="58b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我们将使用以下资源创建一个自定义VPC—</p><ul class=""><li id="5bde" class="lp lq iq ka b kb kc kf kg kj mf kn mg kr mh kv mi lx ly lz bi translated">一个VPC</li><li id="d6a9" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv mi lx ly lz bi translated">两个子网—一个公共子网和一个私有子网</li><li id="92f0" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv mi lx ly lz bi translated">两个EC2实例—每个子网一个</li><li id="258e" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv mi lx ly lz bi translated">一个NACL(网络访问控制列表)—我们将使用创建VPC时自动创建的默认列表。</li><li id="4920" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv mi lx ly lz bi translated">一个自定义路由表</li><li id="93b9" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv mi lx ly lz bi translated">一个安全组</li></ul><h1 id="dea7" class="mj kx iq bd ky mk ml mm lb mn mo mp le mq mr ms lh mt mu mv lk mw mx my ln mz bi translated">先决条件</h1><p id="d0e2" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj na kl km kn nb kp kq kr nc kt ku kv ij bi translated">要开始使用CDK，请确保您已经—</p><ol class=""><li id="7e96" class="lp lq iq ka b kb kc kf kg kj mf kn mg kr mh kv lw lx ly lz bi translated">AWS帐户</li><li id="c265" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated"><a class="ae nd" href="https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html" rel="noopener ugc nofollow" target="_blank">安装CDK CLI，配置访问键</a></li><li id="7e9f" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">在北弗吉尼亚地区生成了名为<strong class="ka ir"> us-east-1-key </strong>的EC2密钥对。此密钥将用于启动实例。</li></ol><p id="fbcd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">注意—本文中创建的所有资源都包含在AWS免费层中，因此，如果您的免费层处于活动状态，并且您在完成教程后删除了这些资源，您将不会被收费。</strong></p><h1 id="4e62" class="mj kx iq bd ky mk ml mm lb mn mo mp le mq mr ms lh mt mu mv lk mw mx my ln mz bi translated">创建新的CDK项目</h1><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="f2e8" class="kw kx iq nj b gy nn no l np nq">mkdir vpc<br/>cd vpc</span><span id="c907" class="kw kx iq nj b gy nr no l np nq">cdk init app --language python</span><span id="3a9c" class="kw kx iq nj b gy nr no l np nq"># create new virtual environment<br/>python3 -m venv .env</span><span id="6a46" class="kw kx iq nj b gy nr no l np nq"># for Mac/Linux<br/>source .env/bin/activate</span><span id="3fe4" class="kw kx iq nj b gy nr no l np nq"># for Windows<br/>.env\Scripts\activate.bat</span><span id="40e8" class="kw kx iq nj b gy nr no l np nq"># install required dependencies<br/>pip install -r requirements.txt<br/>pip install aws_cdk.aws_ec2</span><span id="d590" class="kw kx iq nj b gy nr no l np nq"># to add the newly installed dependency to requirements file<br/>pip freeze &gt; requirements.txt</span></pre><p id="7838" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上述命令执行以下操作—</p><ol class=""><li id="94f7" class="lp lq iq ka b kb kc kf kg kj mf kn mg kr mh kv lw lx ly lz bi translated">用<strong class="ka ir"> python </strong>语言的<strong class="ka ir"> app </strong>模板创建一个新的CDK项目。</li><li id="1f06" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">创建一个新的虚拟环境并切换到它。</li><li id="46dc" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">安装创建AWS资源所需的依赖项。</li><li id="984e" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">将新安装的依赖项添加到需求文件中。</li></ol><p id="ad91" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行上述命令后，您的项目结构应该如下所示</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/8a9d2ace90e1e6587646118a01c2358a.png" data-original-src="https://miro.medium.com/v2/resize:fit:514/format:webp/1*O0JlnvfauHARtigTQu1k8w.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">项目结构</figcaption></figure><p id="67b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">与CDK合作有多种方式。我更喜欢使用CDK的Cloudformation构造来创建资源和配置文件，以存储我的资源的配置。</p><p id="5114" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为什么要使用Cloudformation构造？因为它们为您提供了对资源配置的更多控制(至少目前是这样，但随着CDK的更新，这种情况可能会改变)。</p><h1 id="ab5e" class="mj kx iq bd ky mk ml mm lb mn mo mp le mq mr ms lh mt mu mv lk mw mx my ln mz bi translated">存储资源配置</h1><p id="69c6" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj na kl km kn nb kp kq kr nc kt ku kv ij bi translated">我们将把资源的配置存储在内部<strong class="ka ir"> vpc </strong>目录中的一个名为<code class="fe nt nu nv nj b">config.py</code>的文件中。</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">CDK资源配置</figcaption></figure><p id="d39f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上述配置包含以下信息—</p><ol class=""><li id="369c" class="lp lq iq ka b kb kc kf kg kj mf kn mg kr mh kv lw lx ly lz bi translated">VPC、互联网网关、路由表、子网、实例、密钥对、安全组和区域等实体名称。</li><li id="78cc" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">自定义路由表的路由。我们的自定义路由表中只有一条允许流量通过互联网网关的路由。</li><li id="dabe" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">安全组配置。我们允许从互联网到SSH (22)、HTTP (80)和HTTPS (443)的入站访问。</li><li id="3790" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">子网配置。我们在AZ <code class="fe nt nu nv nj b">us-east-1a</code>启动公共子网，在AZ <code class="fe nt nu nv nj b">us-east-1b</code>启动私有子网</li><li id="f39d" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">实例配置。我们在每个子网中启动一个EC2实例。</li><li id="35fb" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated">对于这个例子，我使用位于北弗吉尼亚地区的Bitnami WordPress AMI。</li></ol><h1 id="2210" class="mj kx iq bd ky mk ml mm lb mn mo mp le mq mr ms lh mt mu mv lk mw mx my ln mz bi translated">创建资源</h1><p id="e996" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj na kl km kn nb kp kq kr nc kt ku kv ij bi translated">是时候编写代码来从上面的配置中创建资源了。我们将在<code class="fe nt nu nv nj b">vpc_stack.py</code> <strong class="ka ir"> </strong>文件中编写创建资源的代码。</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">使用配置创建资源的代码</figcaption></figure><p id="81cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在上面嵌入的文件中，您可以看到使用我们的配置定义了不同的方法来创建不同类型的资源。</p><p id="ec8f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了创建资源，将调用<code class="fe nt nu nv nj b">__init__</code>方法。注意在<code class="fe nt nu nv nj b">__init__</code>方法中调用其他方法的顺序。这个顺序很重要，因为必须先创建VPC，然后才能在其中创建资源。同样，在子网内创建实例之前，必须先创建子网。</p><p id="69ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这只是众多创造CDK资源的方法之一，你可以选择其他最适合你的方法。</p><p id="8051" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以查看<a class="ae nd" href="https://docs.aws.amazon.com/cdk/api/latest/" rel="noopener ugc nofollow" target="_blank"> CDK文档</a>来确定使用哪个类来创建哪个资源。</p><h1 id="870a" class="mj kx iq bd ky mk ml mm lb mn mo mp le mq mr ms lh mt mu mv lk mw mx my ln mz bi translated">部署项目</h1><p id="4378" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj na kl km kn nb kp kq kr nc kt ku kv ij bi translated">CDK CLI提供了一些工具，可以帮助您调试、部署和销毁CDK资源。</p><h2 id="04aa" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">cdk synth</h2><p id="30a3" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj na kl km kn nb kp kq kr nc kt ku kv ij bi translated">这个命令创建一个对应于你的CDK代码的云形成模板。在调试代码时，它会非常方便。</p><h2 id="7f18" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">cdk差异</h2><p id="8b63" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj na kl km kn nb kp kq kr nc kt ku kv ij bi translated">如果您部署了当前代码，此命令将向您展示基础架构的当前状态与新状态之间的差异。在部署之前，请始终运行该命令！</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi ny"><img src="../Images/70a7135c872cd8551352c40ce2e5f91c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*udn_tWtm1aFGxYchIjXdTw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">cdk diff的输出(底部调整)</figcaption></figure><h2 id="a5c1" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">cdk部署</h2><p id="fb9f" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj na kl km kn nb kp kq kr nc kt ku kv ij bi translated">该命令用于从您的代码生成Cloudformation模板，并部署Cloudformation堆栈来创建资源。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi od"><img src="../Images/e4f2f8c2d41f7516e4d93c6fdef39e67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qLevqtEx5zTrLAQUUuKKyQ.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">cdk deploy的输出(在底部修剪)</figcaption></figure><h2 id="d328" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">cdk销毁</h2><p id="ca3a" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj na kl km kn nb kp kq kr nc kt ku kv ij bi translated">正如您已经猜到的，这个命令用于销毁您的Cloudformation堆栈中的所有资源。</p><p id="4085" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要更新您的基础架构，请使用<code class="fe nt nu nv nj b">cdk deploy</code>命令。</p><p id="ff68" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">注意——完成本教程后，不要忘记运行该命令。</strong></p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi ny"><img src="../Images/375dcce31e4dfe20403efd2c632afa1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c46hgk6XBwKsJxM2dWhPHw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">cdk销毁命令的输出</figcaption></figure><p id="92c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您可以通过控制台在AWS帐户中验证资源的创建。</p><p id="79ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在<a class="ae nd" href="https://github.com/abkunal/custom-vpc-cdk" rel="noopener ugc nofollow" target="_blank"> Github </a>上查看这个项目。</p><div class="oe of gp gr og oh"><a href="https://github.com/abkunal/custom-vpc-cdk" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd ir gy z fp om fr fs on fu fw ip bi translated">abkunal/custom-vpc-cdk</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">这是一个在Python中创建自定义VPC的cdk项目。cdk.json文件告诉CDK工具包如何执行你的应用程序…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">github.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov js oh"/></div></div></a></div><h2 id="0a22" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated"><strong class="ak">参考文献</strong></h2><ol class=""><li id="fa12" class="lp lq iq ka b kb lr kf ls kj lt kn lu kr lv kv lw lx ly lz bi translated"><a class="ae nd" href="https://docs.aws.amazon.com/cdk/latest/guide/hello_world.html" rel="noopener ugc nofollow" target="_blank">你的第一个AWS CDK应用</a></li><li id="90d3" class="lp lq iq ka b kb ma kf mb kj mc kn md kr me kv lw lx ly lz bi translated"><a class="ae nd" href="https://docs.aws.amazon.com/cdk/api/latest/" rel="noopener ugc nofollow" target="_blank"> CDK文件</a></li></ol></div><div class="ab cl ow ox hu oy" role="separator"><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb"/></div><div class="ij ik il im in"><p id="7c62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我希望你从这篇文章中学到了一些东西，如果你有疑问或反馈，请在下面评论！</p><p id="53a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">非常感谢你阅读这篇文章。如果你喜欢它，请给它一些掌声，让更多的人从中受益！</p></div></div>    
</body>
</html>