# 成功采用 GraphQL 的 5 个技巧

> 原文：<https://levelup.gitconnected.com/5-tips-for-successful-graphql-adoption-c5c548d1bf98>

## 来自战场的观察和故事

![](img/f77ec9d232579576a55ad23dacc813fb.png)

[‏摄🌸🙌فی عین الله](https://unsplash.com/@mhrezaa?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 开[退溅](https://unsplash.com/s/photos/architecture?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

## **简介**

我已经在产品中使用 GraphQL 将近两年了。截至 2020 年 1 月，该技术已经相当成熟，用户比以往任何时候都多，GraphQL 正在迅速成为新的互联网标准。现在是您的公司或组织采用 GraphQL 的大好时机。

GraphQL 生态系统已经有了巨大的发展，今天，有更多的选项可供选择，强大的框架、开发人员工具和实用程序，因此，它可能是势不可挡的，并且很难知道从哪里开始。

在本文中，我将讲述一些我将 GraphQL 投入生产的经历，我将评论我的观察并谈论不同的框架。我会指出一些你可能没有意识到的特质。我还会建议新用户，用简单的术语描述事情，我还会提出一些重要的建议，并讨论一些“问题”/可能违反直觉和/或不合理的事情。

## **1。消除对 GraphQL 的误解**

有人说过，如果你问 10 个人 GraphQL 是什么，你会得到 10 个不同的答案。这个术语可能确实很模糊，我见过将其描述为“客户端”技术的演示，我听说过将其与 SQL 进行比较，我也读过许多模糊的描述。

[graph QL 基金会](https://graphql.org/)有一个体面的轮廓:

> GraphQL 是一种用于 API 的查询语言，是用现有数据完成这些查询的运行时语言。GraphQL 为 API 中的数据提供了完整且易于理解的描述，使客户能够准确地要求他们需要的东西，使 API 更容易随时间发展，并支持强大的开发工具。

问题可能源于试图找到一个能引起大多数人共鸣的总括性陈述。我喜欢说:

> *“graph QL 是一种语言，它描述你拥有什么，你想要什么，并提供一种算法来解决这些请求”，*

我发现根据不同的背景和听众给出不同的解释是很有帮助的。如果我和开发人员或产品经理谈话，我会用不同的方式来阐述，也许会强调文档和领域建模的优势。

…另一个流行的问题是 GraphQL 取代了什么，人们会问它是否取代了 REST，他们还会问与客户端相关的问题，比如它是否取代了 Redux。弄清楚 GraphQL 是什么和不是什么很重要…我发现将其描述为替代品可能过于简单，有时会吓到人。

如果你打算向你的公司推销 GraphQL，尽可能地去神秘化，减少混乱。请记住，许多软件老手很快会对任何被认为“流行”的技术不屑一顾。

## **2。采取有原则的方法**

这听起来可能很奇怪，但是曾经有一段时间许多 web 开发人员没有使用最佳实践——当 web 是新的时候，最佳实践还没有被开发出来。

如今，最佳实践风靡一时，开发人员寻求“正确”的做事方式……我见过经验丰富的工程师和初学者犯同样的错误，用基本原则处理问题。

……我所说的基本原则是什么意思？，[这是一篇关于这个主题的好文章](https://fs.blog/2018/04/first-principles/)。实际上，这是一个对问题进行逆向工程的过程，通常采用苏格拉底式提问来重新思考、重新考虑或重新猜测某事。这种情况发生在低年级学生身上，因为他们没有意识到工作已经完成了；这种情况发生在年长的老兵身上，因为这种方法在过去更为普遍。

这本身并不是一个坏的实践，实际上，这是一种很好的创新方式，但是有一个时间和地点…它在 web 开发中变得不太合适，特别是在企业领域…重要的是要认识到软件现在在一个不同的地方，大型项目是由世界各地的许多聪明人合作开发的。

在许多方面，REST 的开放本质是它失败的原因，缺乏标准契约意味着没有标准契约。GraphQL 得到了大公司的支持，在定义使用它的“正确”方式方面已经进行了大量的思考和工程设计。

令人惊讶的是，我遇到过这样的工程师，他们认为“GraphQL 是*只是*等等等等，所以……我会写我自己的栈”，我不会告诉你他们是新手还是老手；)

用基本原则来处理 GraphQL 是错误的，你应该尽可能遵循最佳实践，并积极寻求意见和有见解的软件。如果需要扩展，可以跳到现有的开源实现上。

由阿波罗团队的 [Geoff Schmidt](https://twitter.com/GeoffQL) 和 [Matt DeBergalis](https://twitter.com/debergalis) 撰写的 Principled GraphQL 是一个受[十二因素应用](https://12factor.net/config)启发的指南(另一个你应该阅读的伟大的最佳实践指南)，它是一个很好的起点，让你了解如何利用来自该领域的经验来处理你的 GraphQL 应用。

固执己见的软件最酷的一点是，你不必浪费时间来阐述你自己的观点并与你的同事争论，通常你的问题的解决方案已经被考虑了。

## **3。引入新技术时要小心**

如果你正在考虑向你的公司介绍 GraphQL，或者任何颠覆性的技术，你应该小心你的方法。

我在一个大型的应用程序中工作，年长的开发人员和年轻的开发人员一起工作，他们的能力从初学者到专家都有。该公司在基于 REST 的 ES5 JavaScript 客户端系统上投入了大量资金，该系统拥有面向数百个客户端的接口。

这段代码“工作正常”(在一些工作之后)，但从一开始就有问题，主要是因为它是使用大约 2005 年的语法编写的，而且只有一名专家对系统了如指掌。

老开发人员更喜欢这种老式的代码，他们不愿意改变它。争论的焦点是这个系统“有效”,当你做了重大投资时，扩展你的代码通常是个好主意，而不是重写它。有一点重构是必要的，但即便如此，也很难证明这一点。JavaScript 是世界上最流行的语言。简单的论点，或者说我是这样认为的…让我的团队转向现代 JavaScript 花了好几年时间。这些资深开发者的影响力非常大。

我阅读 GraphQL 已经有一段时间了，并意识到它是我们问题的合适解决方案，它为在 API 网关上实现安全性提供了一个坚实的基础，它还提供了一种解决溢出的方法。它也带来了许多其他不太明显的好处；文档、数据标准化、端到端打字等。

我学到的经验是，尽管 GraphQL 是一项伟大的技术，而且确实是正确的解决方案，但许多人害怕改变，如果你试图改变他们的工作，其他人会感到被冒犯。不要忘记，如果你引入了新技术，你就要为此负责……你可以就文档和入职事宜进行争论，但你仍然可能会在没有意识到的情况下被冒犯。

…也许我见过的 50%的开发人员不喜欢改变，这和其他人差不多。我不推荐这种态度，我也不认为这种做法会走得很远，但如果你在一家大型机构工作，这仍然是一个需要考虑的因素，尤其是如果你的上层管理人员可能被认为做出了一个糟糕的决定，或者公司已经进行了一项重大投资。

…在介绍 GraphQL 时要小心，用数据证明你的观点，确保 QA 在改造之前正确测试系统，以便你可以与你正在修复的系统进行比较…使用 Git 历史分析器来帮助识别代码热点，识别关键问题区域。

尽量确保 GraphQL 的引入被视为一种增强而不是替代……记住，尽管开发人员同事欣赏重构，但上层管理人员倾向于反对重构(注意:定期重构*是*一件**好事情**)，他们倾向于更关心面向客户的特性，仅仅争论更高的生产率是不够的。感知就是一切。

确保你有数据证明你的情况，警惕消极进取的同事，无论出于什么原因，不管是不安全感还是对未知的恐惧，他们都会让你的工作变得很糟糕。

如果你的公司在你做了一个很好的案例后不愿意改变，问问你自己你是否能接受你所拥有的开发经验，一些公司会接受你的态度，并对现代技术持开放态度，特别是当他们提出新的解决方案时…使用过时的系统确实会阻碍你的职业发展，并阻止你及时取得进步，但你不希望与你的同事，尤其是经理发生摩擦。

考虑到你的公司可能不关心你的技能现代化，因为害怕培训你继续前进，用传统技能构建的定制系统是将某人锁定在公司的一个好方法。

## **4。为工作选择合适的工具**

好了，现在你已经确信可以将 GraphQL 引入你的公司，那么你使用什么框架呢？你如何决定？

选择正确的框架取决于您的应用程序，以及您是需要内部的还是托管的。如果你使用的是无服务器架构，你可能会看到托管的 GraphQL 服务，如 [AWS AppSync](https://aws.amazon.com/appsync/) 或 [Prisma Cloud](https://www.prisma.io/cloud) 。托管服务有一个主要缺点，它们不太容易定制。

最流行的 GraphQL 框架是 [Apollo](https://www.apollographql.com/) 。Airbnb、Twitch、纽约时报、荷航和 Medium 都使用它。

Apollo 是我最喜欢的项目之一，团队理解采纳的重要性，你需要用户使用你的产品..你需要开发者达成共识，你需要贡献者。Apollo 已经采取了重大举措来确保大公司采用 GraphQL 并将其用于生产。他们有优秀的文档和一个很棒的 T2 YouTube 频道。

Apollo 是一个全功能的 GraphQL 框架，为状态管理提供了优秀的客户端工具，他们有开源组件，也有闭源企业服务，他们不提供任何数据库层，你必须添加自己的 ORM，很多用户发现为数据库连接添加样板文件很麻烦。几个可选的框架自动添加数据库功能。

> [对象关系映射](https://en.wikipedia.org/wiki/Object-relational_mapping) (ORM)是一种让你使用面向对象的范例从数据库中查询和操作数据的技术。

Prisma 打算用 GraphQL 作为接口来取代传统的 ORM，这可以使数据库访问变得极其简单。CRUD 操作通过 GraphQL API 公开，Prisma 将 GraphQL 服务器和数据库粘合在一起

[Hasura](https://hasura.io/) 是一个[开源](https://github.com/hasura/graphql-engine)引擎，它连接到你的数据库&微服务，并立即给你一个生产就绪的 GraphQL API。

Prisma 和 Hasura 都是基于 [Postgres](https://www.postgresql.org/) 的，并且都支持数据库事件上的 [webhook 触发器](https://github.com/hasura/graphql-engine/blob/master/event-triggers.md)。

Hasura 和 Prisma 之间的一个关键区别是 Hasura 为您的前端提供 GraphQL，而 Prisma 是为您的 GraphQL 服务器提供的 GraphQL ORM。您可以将[阿波罗服务器](https://www.apollographql.com/docs/apollo-server/)与 Prisma 配合使用。Hasura 有一些很好的伸缩特性，Apollo 和 Hasura 都支持类似实现的联邦/模式拼接。

我喜欢与 Apollo 一起工作，因为我可以定制它，但我必须添加自己的 ORM，通常是 [Sequelize](https://sequelize.org/) 或 [TypeORM](https://typeorm.io/#/) ，这意味着许多重复的样板代码，也很难找到真实的来源。

[Warthog](https://github.com/goldcaddy77/warthog) 是一个新的框架，它有一个代码优先的模式生成方法，你编写熟悉的 [TypeORM](https://typeorm.io/#/) 模型(拥有 TypeORM 的所有功能), Warthog CLI 为你生成你的 GraphQL 模式和解析器。这使您能够专注于一个清晰事实来源，即您的代码。它是用[类型脚本](https://www.typescriptlang.org/)编写的企业友好的。你还可以获得免费的 CRUD，这可以节省很多时间。

Warthog 是一个自以为是的框架，有很强的约定，它生成干净、可接近的代码，但是你可以很容易地编写修改和以复杂的方式迁移数据…在许多方面，Warthog 是两个世界中最好的，因为你可以访问你的代码来修改你认为合适的代码，同时有很多工作为你做。这是一个很好的例子，说明了如何使用 GraphQL 和代码生成。

## **5。做好准备**

*   **早点搞清楚真相的来源。**graph QL 开发有两种主要方法，**模式优先，**和**代码优先**。在你开始开发之前，找出不同之处是很重要的。如果您正在与各种前端和后端团队合作，Apollo 建议您采用**模式优先**。这意味着将模式设计作为最高优先级。**代码优先**(有时也称为*解析器优先*)是一个以编程方式实现 GraphQL 模式的过程*。疣猪和 Prisma 都提倡代码优先的方法，因为它减少了膨胀和所需的工具。*
*   不要试图构建完美的模式。这很重要。Principled GraphQL 谈到使用[敏捷方法进行模式开发](https://principledgraphql.com/agility#5-use-an-agile-approach-to-schema-development)。GraphQL 提供了如此美观、功能强大的数据图，以至于制作“完美”的模式非常诱人，尤其是从 REST 开始的时候……但是根据我的经验，这可能是一个非常耗时的过程，并且不可避免地会比您预期的要长，以敏捷的方式进行增量开发。
*   **联邦/模式拼接实现不完整。GraphQL 图的梦想是将不同的图“缝合”在一起，形成单一的“联邦”图。将所有内容放在一个图表中的方法存在一些问题，存在挥之不去的单一趋势，并且订阅支持不可用。我相信这些问题会得到解决，但这似乎是一个难题。**
*   **避免多态性**。从 REST 开始，您可能会尝试重载您的类型并重新创建超取场景。GraphQL 的一个重要属性是特定的字段必须总是返回相同的类型。GraphQL 字段可以返回几个对象类型的联合，使用联合来提供同类功能。
*   **别忘了抽象建模。**来自传统的 REST 和 ORM 系统，您可能想将您的 GraphQL 模型映射到数据库模型，但是重要的是要记住您的字段可以用来表示更抽象的东西，例如“me”字段，它返回当前登录的用户。
*   **使用 Typescript，使用代码生成。** TypeScript 已经在企业领域大放异彩，它减少了 bug，并为您的代码添加了智能+文档。GraphQL 和 TypeScript 配合得非常好，但是您应该使用代码生成器来自动生成您的类型和其他代码片段。有不同的生成器可以尝试: [GraphQL 代码生成器](https://graphql-code-generator.com/)、 [TypeGraphQL](https://typegraphql.ml/) 和 [Apollo code-gen](https://github.com/apollographql/apollo-tooling) 。
*   注意请求开销。 GraphQL 增加了请求的开销，因为每个请求都要进行运行时类型检查和子选择。不同的包都或多或少地进行了优化，如果你加载了大量的请求和大量的查询，你可能会受到影响。众所周知，GraphQL 应用程序会遇到 N+1 问题，这超出了本文的范围，但实际上这是一个问题，查询会对返回的记录执行额外的查询，有各种解决方案，但这是您应该知道的。

## **结论**

GraphQL 是一项令人惊叹的技术，您应该考虑使用它。我希望这篇文章是有帮助的，谢谢你的阅读，祝你的项目好运！

## **资源:**

框架:[阿波罗](https://www.apollographql.com/) / [疣猪](https://github.com/goldcaddy77/warthog) / [哈苏鲁](https://hasura.io/) / [普里斯马](https://www.prisma.io/) / [AWS AppSync](https://aws.amazon.com/appsync/)

ORMs: [类型化 ORM](https://typeorm.io/#/) / [顺序化](https://sequelize.org/)

代码生成器: [GraphQL 代码生成器](https://graphql-code-generator.com/)/[typegraph QL](https://typegraphql.ml/)/[阿波罗工具](https://github.com/apollographql/apollo-tooling)

[第一原理](https://fs.blog/2018/04/first-principles/)

[graph QL 基金会](https://graphql.org/)

YouTube 上的阿波罗

[打字稿](https://www.typescriptlang.org/)

[原理图 QL](https://principledgraphql.com/)

[十二因素 App](https://12factor.net/config)