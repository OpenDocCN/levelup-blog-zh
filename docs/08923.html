<html>
<head>
<title>Metrics: Reliably Configuring Prometheus and Grafana with Docker.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">度量:用Docker可靠地配置Prometheus和Grafana。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/metrics-reliably-configuring-prometheus-and-grafana-with-docker-2077541c8e6d?source=collection_archive---------1-----------------------#2021-06-19">https://levelup.gitconnected.com/metrics-reliably-configuring-prometheus-and-grafana-with-docker-2077541c8e6d?source=collection_archive---------1-----------------------#2021-06-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="db7a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">技术堆栈:普罗米修斯，格拉夫纳，码头工人，码头工人-组成。</h2></div><p id="1a75" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于如何将指标集成到您的应用程序中，有很多很好的指南，因此您可以在Prometheus中使用它们，例如，有一个优秀的<a class="ae lb" href="https://github.com/prometheus/client_java" rel="noopener ugc nofollow" target="_blank"> Java客户端</a>和来自流行web框架的一级支持，如<a class="ae lb" href="https://docs.spring.io/spring-metrics/docs/current/public/prometheus" rel="noopener ugc nofollow" target="_blank"> Spring </a>。然而，我很难找到如何收集这些指标的信息，以及一旦设置好仪表板，您将如何可靠地进行版本控制和部署。</p><p id="533a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，本指南将带您了解Prometheus如何收集指标，然后再用Grafana可视化它们。随着事情的进展，我们将关注如何存储和版本化这个配置，这样它就可以用Docker可靠地部署。</p><h1 id="6239" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">步骤1:了解如何收集指标</h1><blockquote class="lu lv lw"><p id="9953" class="kf kg lx kh b ki kj jr kk kl km ju kn ly kp kq kr lz kt ku kv ma kx ky kz la ij bi translated">本指南将运行一个显示主机和端口指标的应用程序:<strong class="kh ir">http://yak-server:9001/metrics</strong>。</p></blockquote><p id="d8af" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设您的应用程序正在运行，并且您已经将一些指标集成到其中，首先要理解的是Prometheus是如何访问这些信息的。</p><p id="6dbe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当你运行普罗米修斯，你配置它“刮”某些目的地。这意味着普罗米修斯，比方说每15秒，将调用您的指标端点，然后存储结果；这就是所谓的拉式架构(Prometheus正在将指标拉向它)。因此，您的应用程序只需要提供一个获取指标的位置，剩下的工作Prometheus会完成(图1)。</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi mb"><img src="../Images/0adb61d2496e4b3a45da26fee0d4fd6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qRiDHz4LMKdIrNoG9JURFw.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">图1: Prom每隔15秒查询您的应用程序，以获取新的指标。</figcaption></figure><p id="e7c7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦Prometheus收集了您的指标，它会将它们存储在一个时间序列数据库中，以供查询。为了查询它们，Prometheus提供了一种强大的查询语言，您可以通过API或在Prometheus UI中使用。这些查询就是您随后在Grafana中配置以在仪表板中显示图形和信息的内容(图2)。</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi mr"><img src="../Images/b105aa907ab55970766b0c96e6c732e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oMIC1WltPWdbBH6-wwiO0A.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">图2: Grafana根据您在仪表板中的设置查询PromQL。</figcaption></figure><p id="83de" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，对于这种架构，为了可靠地部署它，我们需要:</p><ul class=""><li id="4a7c" class="ms mt iq kh b ki kj kl km ko mu ks mv kw mw la mx my mz na bi translated">配置Prometheus scrape配置，告诉它我们的应用程序位于何处，以及从它那里获取指标的频率。</li><li id="ceef" class="ms mt iq kh b ki nb kl nc ko nd ks ne kw nf la mx my mz na bi translated">将指标存储在持久卷中，这样，如果Prometheus Docker映像停止，我们就不会丢失它们。</li><li id="e9fb" class="ms mt iq kh b ki nb kl nc ko nd ks ne kw nf la mx my mz na bi translated">配置Grafana以找到Prometheus实例，这样我们就可以可视化我们正在收集的指标。</li><li id="6c0b" class="ms mt iq kh b ki nb kl nc ko nd ks ne kw nf la mx my mz na bi translated">用我们想要显示的查询/图形配置Grafana仪表板。</li><li id="2fff" class="ms mt iq kh b ki nb kl nc ko nd ks ne kw nf la mx my mz na bi translated">存储这些仪表板，以便我们可以在Grafana Docker映像停止时再次部署它们。</li></ul><h1 id="a8d0" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">步骤2:使用Docker Compose部署度量管道</h1><p id="11e5" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">获得该架构的可靠部署的第一步是简单地获得我们需要在本地运行的映像。创建以下文件夹结构:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="3577" class="nq ld iq nm b gy nr ns l nt nu">your-folder-location/<br/>┣ grafana/<br/>┃ ┣ dashboards/<br/>┃ ┃ ┗ my-dashboard.json<br/>┃ ┗ provisioning/<br/>┃   ┣ dashboards/<br/>┃ ┃ ┃ ┗ all.yml<br/>┃   ┣ datasources/<br/>┃ ┃ ┃ ┗ all.yml<br/>┃   ┗ config.ini<br/>┣ prom/<br/>┃ ┣ prometheus.yml<br/>┃ ┗ rules.yml<br/>┗ docker-compose.yml</span></pre><p id="6b33" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个结构包含了我们在本文中需要的所有东西，当我们将它合并到我们的部署中时，我们将仔细检查每个文件。如果您想跳过这篇文章，只看一个示例部署，请访问这里的。</p><p id="22f6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">打开<strong class="kh ir"> docker-compose.yml </strong>复制启动配置:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="f6b1" class="nq ld iq nm b gy nr ns l nt nu">version: '3.7'<br/><br/>services:<br/><br/>  yak-server:<br/>    image: guardiandevelopment/yak-server:1.0.0.SNAPSHOT<br/>    ports:<br/>      - 9000:9000<br/>      - 9001:9001<br/>    deploy:<br/>      resources:<br/>        limits:<br/>          cpus: '1'<br/>          memory: 250M<br/><br/>  prom:<br/>    image: prom/prometheus:v2.27.1<br/>    ports:<br/>      - 9090:9090<br/><br/>  grafana:<br/>    image: grafana/grafana:7.5.7<br/>    ports:<br/>      - 3000:3000<br/><br/>volumes:<br/>  <em class="lx"># store prom metrics between runs<br/>  </em>prometheus_data: {}<br/><br/>networks:<br/>  default:<br/>    name: metrics-network</span></pre><p id="11bd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了这个存储，您应该能够运行以下命令:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="bf15" class="nq ld iq nm b gy nr ns l nt nu">docker-compose up</span></pre><p id="4cd9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后访问以下链接:</p><ul class=""><li id="3a43" class="ms mt iq kh b ki kj kl km ko mu ks mv kw mw la mx my mz na bi translated">普罗米修斯:<a class="ae lb" href="http://localhost:9090/graph" rel="noopener ugc nofollow" target="_blank">T5 http://localhost:9090/graphT7】</a></li><li id="20eb" class="ms mt iq kh b ki nb kl nc ko nd ks ne kw nf la mx my mz na bi translated">grafana:<a class="ae lb" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">http://localhost:3000/</strong></a><strong class="kh ir"/>登录默认为admin:admin。登录后，只需跳过设置另一个用户，因为这超出了本指南的范围。</li><li id="0185" class="ms mt iq kh b ki nb kl nc ko nd ks ne kw nf la mx my mz na bi translated">来自应用程序的指标:<a class="ae lb" href="http://localhost:9001/metrics" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">http://localhost:9001/metrics</strong></a>这将是我们告诉Prometheus要收集的内容，但它会让您了解本指南中可用的指标的格式和类型。</li></ul><p id="647e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们已经完成了，我们将从第一步开始合并每个配置文件来构建我们的架构。现在，您可以运行以下命令来停止一切:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="6b1a" class="nq ld iq nm b gy nr ns l nt nu"># turn off all images and volumes, remove the -v <br/># if you want volumes persisted between between runs<br/>docker-compose down -v</span></pre><h2 id="6e89" class="nq ld iq bd le nv nw dn li nx ny dp lm ko nz oa lo ks ob oc lq kw od oe ls of bi translated">配置普罗米修斯刮擦目标</h2><p id="4ba5" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">为了让Prometheus从我们的应用程序中收集指标，我们需要配置它的抓取目标。这将告诉Prometheus收集指标的频率，以及在哪里找到我们应用程序的端点。将以下配置添加到<strong class="kh ir">。/prom/prometheus.yml: </strong></p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="aba9" class="nq ld iq nm b gy nr ns l nt nu">global:<br/>  scrape_interval: 15s<br/>  evaluation_interval: 15s<br/>  external_labels:<br/>    monitor: 'yak-monitor'<br/><br/><em class="lx"># extra: include rules for alerting<br/></em>rule_files:<br/>  - rules.yml<br/><br/><em class="lx"># IMPORTANT BIT HERE: targets for scraping metrics from<br/></em><strong class="nm ir">scrape_configs</strong>:<br/><br/>  - job_name: 'prometheus'<br/>    scrape_interval: 5s<br/>    static_configs:<br/>      - targets: [ 'prom:9090' ]<br/><br/>  - job_name: 'yak-server'<br/>    scrape_interval: 5s<br/>    static_configs:<br/>      - targets: [ 'yak-server:9001' ]</span></pre><p id="2a82" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个配置的重要部分是<strong class="kh ir"> scrape_configs </strong>部分。这将配置2个目标:</p><ol class=""><li id="951f" class="ms mt iq kh b ki kj kl km ko mu ks mv kw mw la og my mz na bi translated">它从<strong class="kh ir">自身</strong>中寻找度量标准。这是非常标准的，允许您查看Prometheus实例的性能和健康指标。</li><li id="21ad" class="ms mt iq kh b ki nb kl nc ko nd ks ne kw nf la og my mz na bi translated">我们设置了<strong class="kh ir"> yak-server:9001 </strong>，它抓取我们的应用程序。由于这是在docker-compose中运行的，yak-server DNS条目将对Prometheus可用。如果你已经运行了你自己的应用程序，确保更新它以与之匹配。</li></ol><p id="cb30" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了这个配置，将以下内容添加到docker-compose中的Prometheus映像:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="567f" class="nq ld iq nm b gy nr ns l nt nu">prom:<br/>  image: prom/prometheus:v2.27.1<br/>  ports:<br/>    - 9090:9090<br/>  volumes:<br/>    - <strong class="nm ir">./prom/prometheus.yml:/etc/prometheus/prometheus.yml</strong><br/>    - <strong class="nm ir">./prom/rules.yml:/etc/prometheus/rules.yml</strong></span></pre><p id="4274" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将把我们刚刚配置的<strong class="kh ir"> prometheus.yml </strong>文件挂载到容器中的一个位置，在启动时可以在这个位置找到它。如果您想添加警报，这还会挂载<strong class="kh ir"> rules.yml </strong>文件(如果您对此感兴趣，请参见本文底部的附加部分)。</p><p id="9a73" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要对此进行测试，请运行以下命令并导航到Prometheus UI。</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="0bd1" class="nq ld iq nm b gy nr ns l nt nu">docker-compose up</span></pre><p id="5737" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您随后运行以下查询，您应该看到Prom已经成功地从应用程序获得了JVM信息，表明它已经成功地收集了指标:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi oh"><img src="../Images/a5d093fadb51329458c312d4689e258e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5s1oeIcmLzS7bx6Knw8W_A.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">图3:显示了一个PromQL查询来获取由yak-server metrics端点发布的jvm_info。</figcaption></figure><p id="fbc2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！现在，您已经有了从应用程序中提取到Prometheus的指标。</p><h2 id="b3a2" class="nq ld iq bd le nv nw dn li nx ny dp lm ko nz oa lo ks ob oc lq kw od oe ls of bi translated">将普罗米修斯度量存储在持久卷中</h2><p id="b474" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">在大多数设置中，最好将指标保持在Prometheus容器生命周期之外。幸运的是，Prometheus将其所有时间序列数据放在一个已知的文件夹中，这意味着我们可以将其作为一个卷来装载，并在应用程序运行之间保存指标。将以下内容添加到docker-compose文件中:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="b603" class="nq ld iq nm b gy nr ns l nt nu">prom:<br/>  image: prom/prometheus:v2.27.1<br/>  ports:<br/>    - 9090:9090<br/>  volumes:<br/>    - ./prom/prometheus.yml:/etc/prometheus/prometheus.yml<br/>    - ./prom/rules.yml:/etc/prometheus/rules.yml<br/>    - <strong class="nm ir">prometheus_data:/prometheus</strong></span></pre><p id="5cf2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以看到它引用了compose文件中的卷，并将它挂载在<strong class="kh ir">/普罗米修斯。</strong>这保持了docker-compose down/up操作之间的度量。但是，如果您想从头开始，只需运行:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="2534" class="nq ld iq nm b gy nr ns l nt nu">docker-compose down -v</span></pre><p id="0f3f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该命令不仅会关闭容器，还会删除所有卷。</p><p id="5e2b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这样，我们现在有了指标收集和存储，是时候使用它们在Grafana中绘制图表了！</p><h2 id="3a5a" class="nq ld iq bd le nv nw dn li nx ny dp lm ko nz oa lo ks ob oc lq kw od oe ls of bi translated">配置格拉夫纳寻找普罗米修斯</h2><p id="d151" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">现在，让我们使用新的指标来创建一个控制面板。为此，我们需要告诉Grafana如何找到普罗米修斯服务。转到<strong class="kh ir">。/grafana/provisioning/data sources/all . yml</strong>并添加以下配置:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="49f7" class="nq ld iq nm b gy nr ns l nt nu">apiVersion: 1<br/><br/><em class="lx"># tells grafana where to find the prom connection<br/></em>datasources:<br/>  - name: 'prometheus'<br/>    type: 'prometheus'<br/>    access: 'proxy'<br/>    url: '<strong class="nm ir">http://prom:9090</strong>'</span></pre><p id="6e0e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这告诉Grafana我们的Prometheus实例的确切位置，它等于docker-compose文件中的容器名。为了让Grafana选择这个配置，您需要将以下内容添加到<strong class="kh ir">。/grafana/config.ini </strong></p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="bb0e" class="nq ld iq nm b gy nr ns l nt nu"># place to find startup config<br/>[paths]<br/>provisioning = <strong class="nm ir">/etc/grafana/provisioning</strong><br/><br/>[server]<br/>enable_gzip = true</span></pre><p id="583d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们需要通过用以下内容更新docker-compose文件来使这个配置对Grafana docker映像可用:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="764e" class="nq ld iq nm b gy nr ns l nt nu">grafana:<br/>  image: grafana/grafana:7.5.7<br/>  ports:<br/>    - 3000:3000<br/>  volumes:<br/>    - <strong class="nm ir">./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources<br/>    - ./grafana/config.ini:/etc/grafana/config.ini</strong></span></pre><p id="329f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">准备就绪后，重启您的应用程序:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="bcf5" class="nq ld iq nm b gy nr ns l nt nu">docker-compose down -v<br/>docker-compose up</span></pre><p id="aa49" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后转到Grafana UI。登录后，您应该能够执行以下操作:</p><p id="2307" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">转到管理仪表板:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/08783322ca1abece6d5f78f1457733d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*UbfKmbXNQ27C6Jvk9UCgkA.png"/></div></figure><p id="eda7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后点击“新仪表板”:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi oj"><img src="../Images/1bf55c13117defa3d679c0225ee165f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1zuhpA-JUb0MYA5riVM75w.png"/></div></div></figure><p id="183d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，选择添加一个空面板:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi ok"><img src="../Images/beb862adccefdf63e89361f343dfc15f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h1IUOyvRqfyezW45uprioQ.png"/></div></div></figure><p id="51db" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">选择Prometheus数据源，它现在连接到我们的Prometheus docker容器:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi ol"><img src="../Images/76d72aff35cf922c74d51ef641ebaf74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tfr4Qhu7MsjQ3JyFZ-pf4w.png"/></div></div></figure><p id="d386" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后为<strong class="kh ir"> jvm_info </strong>添加与之前相同的测试查询。确保在查询文本输入之外单击，您应该看到以下内容:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi om"><img src="../Images/d0449349676ba0d7a4ba11a94450a150.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cxf7L9eS3kCP7JJEw_N_nA.png"/></div></div></figure><p id="5978" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这并不是一个非常有用的面板，但是它显示了Grafana正在查询Prometheus，它正在从我们的应用程序中抓取信息！本指南的最后一部分将向您展示如何创建一个简单的仪表板，并保存它以便您可以将其签入到版本控制中。</p><h2 id="c898" class="nq ld iq bd le nv nw dn li nx ny dp lm ko nz oa lo ks ob oc lq kw od oe ls of bi translated">创建Grafana仪表板</h2><p id="6330" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">继续上一节，让我们将一个有用的面板添加到我们的仪表板中。输入以下查询，而不是jvm_info:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="b56f" class="nq ld iq nm b gy nr ns l nt nu">sum(rate(thread_heartbeat_total[$__rate_interval])) by (thread_name)</span></pre><p id="8e38" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在图例框中添加以下内容:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="b7d9" class="nq ld iq nm b gy nr ns l nt nu">{{ thread_name }}</span></pre><p id="ea19" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个指标直接来自我们的应用程序。这是应用程序运行的每个线程的计数器，显示它完成所有必须做的工作的时间。这个指标可以让你看到每个线程的速度，以及它们在应用程序中完成工作的速度。点击右上角的“应用”保存面板，给它一个标题，比如“线程心跳率”。</p><p id="43f5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您现在将进入一个类似于以下内容的页面:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi on"><img src="../Images/77e44213f06489d32d96c3f7aef074ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t8nIvLYeuySOUtdv7xTK1A.png"/></div></div></figure><p id="07eb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们有了一个仪表板，让我们保存它，这样它在启动时总是可以在我们的Grafana容器中使用。</p><h2 id="8096" class="nq ld iq bd le nv nw dn li nx ny dp lm ko nz oa lo ks ob oc lq kw od oe ls of bi translated">存储Grafana仪表板</h2><p id="ab7e" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">在“dashboard”页面上，转到右上角并单击“save”按钮。</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi oo"><img src="../Images/1c81cd0d7311cb8128a8ec08023e96f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ag1TXsdU7qlScONdyhi33A.png"/></div></div></figure><p id="536e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">给它起一个好名字，然后点击保存。不要担心文件夹，因为它会自动控制仪表板的下一个位置。保存后，转到右上角的设置轮。</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi op"><img src="../Images/72388fca3117a36b50b9f8b8e05420a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-VLvyKxPeoWqvscnccq15w.png"/></div></div></figure><p id="7cbb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后转到JSON模型:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi oq"><img src="../Images/11f9559e7a67f7782ad573b0fcfc02dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fnYP_WXVdZAg4ELzLlMYDQ.png"/></div></div></figure><p id="391a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个模型代表我们已经创建的仪表板，并且是我们需要存储以便再次创建它的内容。将这个JSON模型的内容复制到文件<strong class="kh ir">中。/grafana/dashboards/my-dashboard . JSON</strong>文件。现在你有了你的仪表板，让我们告诉Grafana如何在启动时加载它，这样我们就不需要重新制作了。</p><p id="3faa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">转到。<strong class="kh ir">/grafana/provisioning/dashboards/all . yml</strong>，并添加以下配置:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="d5e3" class="nq ld iq nm b gy nr ns l nt nu">apiVersion: 1<br/><br/><em class="lx"># tells grafana where to find the pre-created dashboards<br/></em>providers:<br/>  - name: 'default'<br/>    folder: 'yak-dashboards'<br/>    type: 'file'<br/>    options:<br/>      path: '/var/lib/grafana/dashboards'</span></pre><p id="2e09" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这告诉Grafana在启动时从哪里加载仪表板，以及要使用的文件夹的名称。我们现在需要在docker容器中提供这些文件夹。为此，请使用以下内容更新docker-compose.yml文件:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="edf8" class="nq ld iq nm b gy nr ns l nt nu">grafana:<br/>  image: grafana/grafana:7.5.7<br/>  ports:<br/>    - 3000:3000<br/>  volumes:<br/>    - <strong class="nm ir">./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards<br/>    - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources<br/>    - ./grafana/config.ini:/etc/grafana/config.ini<br/>    - ./grafana/dashboards:/var/lib/grafana/dashboards</strong></span></pre><p id="8cb6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以看到这将dashboard JSON文件映射到容器中我们在<strong class="kh ir">中指定的位置。/grafana/provisioning/dashboards/all . YAML</strong>。保存仪表板后，重新启动容器:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="285f" class="nq ld iq nm b gy nr ns l nt nu">docker-compose down -v <br/>docker-compose up</span></pre><p id="4041" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您返回Grafana UI，将会要求您再次登录。但是，这一次当您进入仪表板页面时，您应该会看到一个文件夹:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi or"><img src="../Images/ab8226c230b6eb838daedcbc51e10622.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*16ECPQEx9yVBuvyjzN1C9w.png"/></div></div></figure><p id="7bcb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您单击它，然后在其中打开控制面板，您应该会看到您之前创建的控制面板:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi os"><img src="../Images/f69aedb20eb8338041d7d447b2553c48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E-Vi3n2gzMZ31005v9MJmg.png"/></div></div></figure><p id="0b9f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从这里开始，您现在有了端到端的指标、仪表板和一种可靠的方式来版本化和配置您的仪表板，以便您可以将它们部署到不同的环境中。</p><p id="5dd6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是总结文章的一个很好的观点。我希望这已经向您展示了一些可用的现代度量工具的威力，以及它们的设置和可靠配置是多么简单。在现实世界中，您可以签入我们在某处创建的文件，并在它们发生变化时构建和发布它们；为您提供对仪表板和警报的版本控制和控制。如果您想查看集成在yak-server应用程序中的完整示例，请访问这里的<a class="ae lb" href="https://github.com/Guardian-Development/yak/tree/main/yak-server/src/main/docker" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="51bf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们来总结最后一条信息。如果您以前使用过Prometheus，您会知道它还可以提供警报和查询。如果您对警报感兴趣，这最后一节简单地完成了设置。</p><h1 id="81f7" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">附加信息:在Prometheus中配置警报</h1><p id="dd2f" class="pw-post-body-paragraph kf kg iq kh b ki ng jr kk kl nh ju kn ko ni kq kr ks nj ku kv kw nk ky kz la ij bi translated">如果您转到Prometheus UI，并单击“警报”选项卡:</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi ot"><img src="../Images/9dbaf902260132e4a75b49e49fbbbb02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PGGSZHpSUCfeyCbAHP0Kmw.png"/></div></div></figure><p id="85d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将看到当前没有配置任何警报。然而，我们只需要添加一个文件来启用自动警报(我不会展示集成一个警报管理器来接收这些警报，因为这超出了本文的范围)。</p><p id="9111" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">转到<strong class="kh ir">。/prom/rules.yml </strong>文件，并添加以下内容:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="ad75" class="nq ld iq nm b gy nr ns l nt nu">groups:<br/>  - name: Yak Server Health<br/>    rules:<br/>      - alert: unable to gather metrics<br/>        expr: scrape_samples_scraped{instance=~"yak-server.*"} == 0<br/>        for: 1m<br/>        labels:<br/>          severity: page<br/>        annotations:<br/>          summary: "{{ $labels.instance }} has not provided metrics in 1m"<br/>          description: "{{ $labels.instance }} may be offline as prom has been unable to gather metrics from it in over 1m"</span></pre><p id="df35" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一个警报，它使用Prometheus度量来检测我们在超过1分钟的时间内无法从任何带有“yak-server”标签的实例收集度量。如果应用程序没有运行，Prometheus配置不正确，网络中断，就会触发此警报。有很多理由想知道这是什么时候发生的。</p><p id="83c9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">准备就绪后，重新启动docker实例:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="88a6" class="nq ld iq nm b gy nr ns l nt nu">docker-compose down -v<br/>docker-compose up</span></pre><p id="cbf6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">返回到Prometheus UI中的alerts页面，您应该看到您的警报处于未触发状态。</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi ou"><img src="../Images/fd4b56220c48b97d7916f605b6b27cf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cgbwr5JA7SR1umb-6sVYVg.png"/></div></div></figure><p id="161a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，如果您停止yak-server docker容器:</p><pre class="mc md me mf gt nl nm nn no aw np bi"><span id="b014" class="nq ld iq nm b gy nr ns l nt nu">docker ps # find the container for yak app<br/>docker stop &lt;container id&gt;</span></pre><p id="9dc9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您等待大约1分钟，这是我们在警报配置中配置的，您应该会看到警报进入挂起状态，然后触发。这将通知您已配置的任何警报管理器，或者如果您想要手动检查警报，则直接显示在Prom UI中。</p><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi ov"><img src="../Images/f094a1138544322af19c66073e97adc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4jb_1qvEawmgqZR7HNbeoQ.png"/></div></div></figure><figure class="mc md me mf gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi ow"><img src="../Images/046f4c1abe5f3c03d85291d0d4a848dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0R4bidTkJMzUcyu-yjm58A.png"/></div></div></figure><p id="fd80" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这应该包含了您需要了解的所有端到端指标和警报。</p><p id="8649" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您有任何问题，请随时联系我:</p><div class="ox oy gp gr oz pa"><a href="https://www.linkedin.com/in/joe-honour-8693029a/" rel="noopener  ugc nofollow" target="_blank"><div class="pb ab fo"><div class="pc ab pd cl cj pe"><h2 class="bd ir gy z fp pf fr fs pg fu fw ip bi translated">Joe Honour -高级软件工程师-和数字| LinkedIn</h2><div class="ph l"><h3 class="bd b gy z fp pf fr fs pg fu fw dk translated">我是AND Digital公司的高级软件工程师。在我的职业生涯中，我曾在许多领域工作过，最近的工作是交付…</h3></div><div class="pi l"><p class="bd b dl z fp pf fr fs pg fu fw dk translated">www.linkedin.com</p></div></div><div class="pj l"><div class="pk l pl pm pn pj po ml pa"/></div></div></a></div></div></div>    
</body>
</html>