<html>
<head>
<title>Developing a 3-tier Serverless web application using AWS Serverless Application Model (SAM) framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS无服务器应用程序模型(SAM)框架开发三层无服务器web应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/developing-a-3-tier-serverless-web-application-using-aws-serverless-application-model-sam-1c8b03dfef8e?source=collection_archive---------4-----------------------#2022-01-01">https://levelup.gitconnected.com/developing-a-3-tier-serverless-web-application-using-aws-serverless-application-model-sam-1c8b03dfef8e?source=collection_archive---------4-----------------------#2022-01-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="90ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ko translated"><span class="l kp kq kr bm ks kt ku kv kw di"> W </span>借助<strong class="js iu"> AWS SAM(无服务器应用程序模型)</strong>，我们可以在AWS上创建无服务器资源来构建&amp;开发无服务器应用程序，例如无服务器资源，如<strong class="js iu"> AWS Lambda、AWS API Gateway、</strong>等。不仅如此，在Lambda被推送到AWS Cloud之前，我们可以使用SAM在本地开发、构建和测试Lambda，而不是直接在AWS控制台上编写Lambda，这节省了在本地系统本身调试Lambda的大量时间，并确保了生产率。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/1d4b6ae67f4445305f73e4289b6d9fd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:298/format:webp/1*ifdu1OUPk3M0MSSpDdGF7Q.jpeg"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">AWS无服务器应用程序模型</figcaption></figure><p id="8c75" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我们将了解如何使用AWS SAM构建一个简单的3层无服务器web应用程序，并借助一些<strong class="js iu"> CLI(命令行界面)</strong>命令，我们如何从本地系统将它部署到AWS Cloud，然后在这个域<a class="ae lj" href="https://acloudtiger.com" rel="noopener ugc nofollow" target="_blank">https://acloudtiger.com</a>访问它。</p><p id="27cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(<em class="lk">请注意，我将在本博客上线时停用资源，因此我们的无服务器应用程序将无法在该给定域访问</em>)</p><h1 id="9c3a" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">使用AWS的优势SAM:-</h1><ol class=""><li id="9dae" class="mj mk it js b jt ml jx mm kb mn kf mo kj mp kn mq mr ms mt bi translated">自动气象站云系的扩展</li><li id="89c4" class="mj mk it js b jt mu jx mv kb mw kf mx kj my kn mq mr ms mt bi translated">本地开发、构建、调试和测试</li><li id="49f3" class="mj mk it js b jt mu jx mv kb mw kf mx kj my kn mq mr ms mt bi translated">支持集成CI/CD服务器，如Jenkins、Atlassian Bamboo等，作为单个部署配置YAML文件</li><li id="e100" class="mj mk it js b jt mu jx mv kb mw kf mx kj my kn mq mr ms mt bi translated">对其他AWS工具/资源的本机支持，如AWS Cloud9 IDE、代码构建、代码部署和代码管道</li></ol><h1 id="e6f5" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">我们的三层无服务器Web应用程序架构:-</h1><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/c535ddd8ecb08a6365eeb2c00190a9ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LjubjSHXzMSr47A3hgsb_Q.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated"><strong class="bd ln">AWS 3层典型无服务器Web架构</strong></figcaption></figure><h2 id="235c" class="ne lm it bd ln nf ng dn lr nh ni dp lv kb nj nk lz kf nl nm md kj nn no mh np bi translated">步骤1:确保安装并配置了AWS CLI和SAM CLI</h2><p id="b6af" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb nq kd ke kf nr kh ki kj ns kl km kn im bi translated">在此访问AWS文档<a class="ae lj" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/server less-application-model/latest/developer guide/server less-Sam-CLI-install . html</a>并根据您的操作系统在您的本地系统中安装二进制文件。您还需要确保在AWS CLI中为IAM用户配置了访问密钥和秘密访问密钥。</p><p id="4338" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(要使用您的CLI配置IAM用户的访问/秘密访问密钥，您可以参考<a class="ae lj" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/CLI/latest/User guide/CLI-configure-quick start . html</a></p><h2 id="8c17" class="ne lm it bd ln nf ng dn lr nh ni dp lv kb nj nk lz kf nl nm md kj nn no mh np bi translated"><strong class="ak">步骤2:初始化SAM应用程序</strong></h2><p id="6110" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb nq kd ke kf nr kh ki kj ns kl km kn im bi translated">使用以下命令初始化SAM应用程序:-</p><pre class="ky kz la lb gt nt nu nv nw aw nx bi"><span id="8892" class="ne lm it nu b gy ny nz l oa ob">sam init --runtime nodejs14.x --name &lt;application name&gt;</span></pre><p id="dfa7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里，我选择了NodeJS作为运行时，但是您可以自由选择任何其他运行时，如Python等。您还需要在名为name的标志中给出一个应用程序名称。</p><p id="a53f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦执行，它将在终端上为您提供一些选项，作为一个基本的启动项目。你可以选择基本的hello world作为例子。</p><p id="188e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦完成，它就用一个<strong class="js iu">模板在本地生成一个框架项目结构。YAML </strong>文件。</p><h2 id="d132" class="ne lm it bd ln nf ng dn lr nh ni dp lv kb nj nk lz kf nl nm md kj nn no mh np bi translated">步骤3:使用SAM模板创建AWS资源。YAML文件</h2><p id="7061" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb nq kd ke kf nr kh ki kj ns kl km kn im bi translated">要使用模板创建Lambda函数，请在Resources标记中添加以下配置，如下所示</p><pre class="ky kz la lb gt nt nu nv nw aw nx bi"><span id="d1a0" class="ne lm it nu b gy ny nz l oa ob"># -------------------------------------------------------------- #<br/>#                                  Resources                                   #<br/># -------------------------------------------------------------- #<br/><br/>Resources:<br/>MyAppFunction:<br/>    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction<br/>    Properties:<br/>      CodeUri: my-app/<br/>      Handler: app.lambdaHandler<br/>      Runtime: nodejs14.x<br/>      MemorySize: !Ref DefaultLambdaMemory<br/>      Timeout: !Ref DefaultLambdaTimeout<br/>      Role: !GetAtt MyAppLambdaExecutionRole.Arn<br/>      Environment:<br/>        Variables:<br/>          RUNTIME_DDB_TABLE_NAME: !Ref DynamoDBTable<br/>      Architectures:<br/>        - x86_64<br/>      Events:<br/>        MyApp:<br/>          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api<br/>          Properties:<br/>            Path: /hello<br/>            Method: get</span></pre><p id="8520" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lk">注，</em><strong class="js iu"><em class="lk">myapp function</em></strong><em class="lk">是给Lambda的逻辑名。</em>您可以给它起任何名字，并且可以通过使用ARN (Amazon Resource Name)将这些资源引用到任何其他AWS资源，例如<strong class="js iu">！GetAtt MyAppFunction。Arn </strong></p><p id="b7e1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">my Lambda的文件名是<strong class="js iu"> <em class="lk"> app.js </em> </strong>在名为<strong class="js iu"> my-app </strong>的文件夹内(参考上面template.yaml定义中的<strong class="js iu"> CodeUri: my-app/ </strong>)。您可以在Lambda函数中编写自己逻辑。<strong class="js iu">出于演示的目的，我在下面列出了每当这个Lambda第一次被调用时向DynamoDB表写入一个项目的逻辑，如下所示</strong> :-</p><pre class="ky kz la lb gt nt nu nv nw aw nx bi"><span id="5f5c" class="ne lm it nu b gy ny nz l oa ob">const AWS = require("aws-sdk");<br/><br/>//All Cold Start Code of Lambda goes here<br/>const dynamodb = new AWS.DynamoDB.DocumentClient();<br/>const ddbTable = process.env.RUNTIME_DDB_TABLE_NAME;<br/><br/>//All Warm Start Code of Lambda goes withing LambdaHandler<br/>exports.lambdaHandler = async (event, context) =&gt; {<br/>    let body;<br/>    let statusCode = 200;<br/>    const headers = {<br/>      'Content-Type': 'application/json',     <br/>      'Access-Control-Allow-Headers': 'Content-Type',<br/>      'Access-Control-Allow-Origin': '*',<br/>      'Access-Control-Allow-Methods': 'GET'<br/>    };<br/><br/>    try {<br/>        // Adding random data to DynamoDB table - Adding static data just for this Sample App otherwise data will be populated based on parsing the Request<br/>        await dynamodb<br/>          .put({<br/>            TableName: ddbTable,<br/>            Item: {<br/>              'id': 'E1001',             <br/>              'name': 'Vinod Kumar',<br/>              'company': 'My Company',<br/>              'email': 'vinod827@yahoo.com'<br/>            }<br/>          })<br/>          .promise();<br/><br/>        // Retrieving data from DynamoDB table - Just from demo purpose only otherwise data will be fetched based on given employee id sent dynamically through headers<br/>        body = await dynamodb.get({ TableName: ddbTable, Key: { id: 'E1001' }}).promise(); // To retrive 1 item<br/>       <br/>    } catch (err) {<br/>        console.log(err);<br/>        statusCode = 400;<br/>        body = err.message;<br/>        return err;<br/><br/>    } finally {<br/>        body = JSON.stringify(body);<br/>    <br/>    }<br/><br/>    //return response<br/>    return {<br/>        statusCode,<br/>        body,<br/>        headers<br/>    };<br/><br/>};</span></pre><p id="e2fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">类似地，要添加另一个无服务器资源，如DynamoDB表，请在同一个模板中添加以下内容</p><pre class="ky kz la lb gt nt nu nv nw aw nx bi"><span id="88e8" class="ne lm it nu b gy ny nz l oa ob"># ------------------------------------------------------------ #<br/>#                        DynamoDB Table                              #<br/># ------------------------------------------------------------ #<br/>  DynamoDBTable:<br/>      Type: AWS::DynamoDB::Table<br/>      Properties: <br/>        AttributeDefinitions: <br/>          - AttributeName: id<br/>            AttributeType: S<br/>        KeySchema: <br/>          - AttributeName: id<br/>            KeyType: HASH<br/>        ProvisionedThroughput: <br/>          ReadCapacityUnits: 5<br/>          WriteCapacityUnits: 5<br/>        Tags: # Optional<br/>          - Key: Namespace<br/>            Value: '@MyApp'<br/>          - Key: Name<br/>            Value: !Sub<br/>            - '${ExportPrefix_}DynamoDBTable'<br/>            - ExportPrefix_: !If<br/>              - HasExportPrefix<br/>              - !Join ['-', [!Ref ExportPrefix, !Ref Environment, '']]<br/>              - !Join ['-', [!Select [0, !Split ["-", !Ref "AWS::StackName"]], !Ref Environment, '']]<br/>          - Key: Environment<br/>            Value: !FindInMap [Environment, FullForm, !Ref Environment]<br/>        TimeToLiveSpecification: !If<br/>          - HasTTLAttribute<br/>          - AttributeName: !Ref TTLAttribute<br/>            Enabled: true<br/>          - !Ref 'AWS::NoValue'</span></pre><p id="90d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了完成我们的3层无服务器web应用架构，下面是模板的完整版本。YAML文件，它将创建AWS资源，如Lambda、DynamoDB、API网关、CloudFront分发、Route 53公共托管区域等。您可以简单地将下面的内容复制并粘贴到您自己的模板中。YAML档案。</p><pre class="ky kz la lb gt nt nu nv nw aw nx bi"><span id="1606" class="ne lm it nu b gy ny nz l oa ob">AWSTemplateFormatVersion: '2010-09-09'<br/>Transform: AWS::Serverless-2016-10-31<br/>Description: &gt;<br/>  AWS Serverless Application Model app<br/>  Sample application<br/><br/>Globals:<br/>  Function:<br/>    Timeout: !Ref DefaultLambdaTimeout # Limit 900 seconds (15 minutes)<br/>    MemorySize: !Ref DefaultLambdaMemory # Limit 128 MB to 3,008 MB, in 64 MB increments<br/><br/>  Api:<br/>    Cors:<br/>      AllowMethods: "'DELETE,GET,HEAD,OPTIONS,PATCH,POST,PUT'"<br/>      AllowHeaders: "'Content-Type,X-Amz-Date,X-Amz-Security-Token,Authorization,X-Api-Key,X-Requested-With,Accept,Access-Control-Allow-Methods,Access-Control-Allow-Origin,Access-Control-Allow-Headers'"<br/>      AllowOrigin: "'*'"    <br/><br/>Parameters:<br/>  Environment:<br/>    Type: String<br/>    Default: dev<br/>    Description: Deployment Environment<br/>    AllowedValues:<br/>      - sbx<br/>      - dev<br/>      - qa<br/>      - stage<br/>      - prod<br/>  ExportPrefix:<br/>    Type: String<br/>    Default: 'myapp'<br/>    Description: &gt;-<br/>      Prefix for the managed resources and cloudformation exports.<br/>      Provide it in `namespace-environment` format,<br/>      where namespace can be product UPI or leave blank for defaults.<br/>    AllowedPattern: ^[a-zA-Z]+(-?[a-zA-Z0-9]+)*$<br/>    ConstraintDescription: &gt;-<br/>      Only hyphen (-) separated alphanumeric string is allowed. Should start with a letter.<br/>    MinLength: 3<br/>    MaxLength: 30<br/>  BillingMode:<br/>    AllowedValues:<br/>    - PAY_PER_REQUEST<br/>    - PROVISIONED<br/>    Default: 'PROVISIONED'<br/>    Description: &gt;-<br/>      Specify how you are charged for read and write throughput and how you manage capacity.<br/>      Set to PROVISIONED for predictable workloads and PAY_PER_REQUEST for unpredictable workloads.<br/>      PAY_PER_REQUEST sets the billing mode to On-Demand Mode<br/>    Type: String<br/>  DefaultLambdaTimeout:<br/>    Default: 3<br/>    MinValue: 3<br/>    MaxValue: 900<br/>    Description: &gt;-<br/>      The amount of time that Lambda allows a function to run before stopping it.<br/>      The default is 3 seconds.<br/>      The maximum allowed value is 900 seconds.<br/>    Type: Number<br/>  DefaultLambdaMemory:<br/>    Default: 128<br/>    MinValue: 128<br/>    MaxValue: 3008<br/>    Description: &gt;-<br/>      The amount of memory that your function has access to.<br/>      Increasing the function's memory also increases its CPU allocation.<br/>      The default value is 128 MB. The value must be a multiple of 64 MB.<br/>    Type: Number<br/>  TTLAttribute:<br/>    Default: None<br/>    Description: &gt;-<br/>      Attribute name for time to live. Provide None or leave blank for if not required.<br/>    Type: String<br/>  CDNHostedZoneId:<br/>    Default: 'Z2FDTNDATAQYW2'<br/>    Description: &gt;-<br/>      CloudFront hosted zone id. <br/>      Always Static Value. <br/>      Refer AWS Documentation here<br/>      https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-route53-aliastarget.html#cfn-route53-aliastarget-hostedzoneid<br/>    Type: String<br/>  DomainName:<br/>    Default: 'acloudtiger.com'<br/>    Description: &gt;-<br/>      Registered domain name with Top Level Domain as .com<br/>    Type: String<br/><br/><br/># --------------------------------------------------------------- #<br/>#                                   Mappings                                   #<br/># --------------------------------------------------------------- #<br/><br/>Mappings:<br/>  Environment:<br/>    FullForm:<br/>      sbx: sandbox<br/>      dev: development<br/>      stage: staging<br/>      qa: qa<br/>      prod: production<br/><br/><br/><br/># ------------------------------------------------------------ #<br/>#                                  Conditions                                  #<br/># ------------------------------------------------------------ #<br/><br/>Conditions:<br/>  HasExportPrefix: !Not [!Equals [!Ref ExportPrefix, '']]<br/>  HasNoTTLAttribute: !Or [!Equals [!Ref TTLAttribute, ''], !Equals [!Ref TTLAttribute, 'None']]<br/>  HasTTLAttribute: !Not [!Condition HasNoTTLAttribute]<br/><br/># -------------------------------------------------------------- #<br/>#                                  Resources                                   #<br/># -------------------------------------------------------------- #<br/><br/>Resources:<br/># ---------------------------------------------------------------- #<br/>#  MyApp Lambda Execution Role for reading writing to DynamoDB, CloudWatch, etc #<br/># ---------------------------------------------------------------- #<br/>  MyAppLambdaExecutionRole:<br/>    Type: AWS::IAM::Role<br/>    Properties:<br/>      AssumeRolePolicyDocument:<br/>        Statement:<br/>          - Action:<br/>              - "sts:AssumeRole"<br/>            Effect: Allow<br/>            Principal:<br/>              Service:<br/>                - lambda.amazonaws.com<br/>        Version: 2012-10-17<br/>      Path: /<br/>      ManagedPolicyArns:<br/>        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole<br/>        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess<br/>        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole<br/>      Policies:<br/>        - PolicyName: !Sub<br/>          - "${ExportPrefix_}MyAppGetLambdaPolicy"<br/>          - ExportPrefix_: !If<br/>            - HasExportPrefix<br/>            - !Join ['-', [!Ref ExportPrefix, !Ref Environment, '']]<br/>            - !Join ['-', [!Select [0, !Split ["-", !Ref "AWS::StackName"]], !Ref Environment, '']]<br/>          PolicyDocument:<br/>            Version: 2012-10-17<br/>            Statement:<br/>              - Sid: MyAppLambdaExecutionAndXRayTracing<br/>                Effect: Allow<br/>                Action:<br/>                  - cloudwatch:PutMetricData<br/>                  - dynamodb:UpdateItem<br/>                  - dynamodb:ConditionCheckItem<br/>                  - dynamodb:Scan<br/>                  - dynamodb:BatchWriteItem<br/>                  - dynamodb:PutItem<br/>                  - dynamodb:GetItem<br/>                  - dynamodb:DescribeTable<br/>                  - dynamodb:Query<br/>                  - dynamodb:BatchGetItem<br/>                  - dynamodb:DeleteItem<br/>                  - s3:*<br/>                  - lambda:*<br/>                Resource: "*"<br/><br/># -------------------------------------------------------------- #<br/>#                          MyApp Lambda Function                                #<br/># -------------------------------------------------------------- #<br/>  MyAppFunction:<br/>    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction<br/>    Properties:<br/>      CodeUri: my-app/<br/>      Handler: app.lambdaHandler<br/>      Runtime: nodejs14.x<br/>      MemorySize: !Ref DefaultLambdaMemory<br/>      Timeout: !Ref DefaultLambdaTimeout<br/>      Role: !GetAtt MyAppLambdaExecutionRole.Arn<br/>      Environment:<br/>        Variables:<br/>          RUNTIME_DDB_TABLE_NAME: !Ref DynamoDBTable<br/>      Architectures:<br/>        - x86_64<br/>      Events:<br/>        MyApp:<br/>          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api<br/>          Properties:<br/>            Path: /hello<br/>            Method: get           <br/><br/><br/># ------------------------------------------------------------ #<br/>#                        DynamoDB Table                              #<br/># ------------------------------------------------------------ #<br/>  DynamoDBTable:<br/>      Type: AWS::DynamoDB::Table<br/>      Properties: <br/>        AttributeDefinitions: <br/>          - AttributeName: id<br/>            AttributeType: S<br/>        KeySchema: <br/>          - AttributeName: id<br/>            KeyType: HASH<br/>        ProvisionedThroughput: <br/>          ReadCapacityUnits: 5<br/>          WriteCapacityUnits: 5<br/>        Tags: # Optional<br/>          - Key: Namespace<br/>            Value: '@MyApp'<br/>          - Key: Name<br/>            Value: !Sub<br/>            - '${ExportPrefix_}DynamoDBTable'<br/>            - ExportPrefix_: !If<br/>              - HasExportPrefix<br/>              - !Join ['-', [!Ref ExportPrefix, !Ref Environment, '']]<br/>              - !Join ['-', [!Select [0, !Split ["-", !Ref "AWS::StackName"]], !Ref Environment, '']]<br/>          - Key: Environment<br/>            Value: !FindInMap [Environment, FullForm, !Ref Environment]<br/>        TimeToLiveSpecification: !If<br/>          - HasTTLAttribute<br/>          - AttributeName: !Ref TTLAttribute<br/>            Enabled: true<br/>          - !Ref 'AWS::NoValue'<br/><br/># --------------------------------------------------------------- #<br/>#             S3 bucket for static website hosting                             #<br/># ---------------------------- ---------------------------------- #<br/>  FEStaticWebsiteS3Bucket:<br/>    Type: AWS::S3::Bucket<br/>    Properties:<br/>      BucketName: acloudtiger.com<br/>      Tags: # Optional<br/>          - Key: Namespace<br/>            Value: '@MyApp'<br/>          - Key: Name<br/>            Value: !Sub<br/>            - '${ExportPrefix_}FEStaticWebsiteS3Bucket'<br/>            - ExportPrefix_: !If<br/>              - HasExportPrefix<br/>              - !Join ['-', [!Ref ExportPrefix, !Ref Environment, '']]<br/>              - !Join ['-', [!Select [0, !Split ["-", !Ref "AWS::StackName"]], !Ref Environment, '']]<br/>          - Key: Environment<br/>            Value: !FindInMap [Environment, FullForm, !Ref Environment]<br/><br/>  S3BucketPolicy:<br/>    Type: AWS::S3::BucketPolicy<br/>    Properties:<br/>      Bucket: !Ref FEStaticWebsiteS3Bucket<br/>      PolicyDocument:<br/>        Statement:<br/>          - Effect: Allow<br/>            Action: 's3:GetObject'<br/>            Resource:<br/>              - !Sub "arn:aws:s3:::${FEStaticWebsiteS3Bucket}/*"<br/>            Principal:              <br/>              AWS: !Sub "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity ${MyCDNOAI}"<br/><br/><br/># ------------------------------------------------------------- #<br/>#                       CDN and its distribution                    #<br/># ------------------------------------------------------------- #<br/>  MyCDNOAI:<br/>    Type: 'AWS::CloudFront::CloudFrontOriginAccessIdentity'<br/>    Properties:<br/>      CloudFrontOriginAccessIdentityConfig:<br/>        Comment: 'Serverless website OA'<br/><br/>  MyCDN:<br/>    Type: 'AWS::CloudFront::Distribution'<br/>    Properties:<br/>      Tags: # Optional<br/>          - Key: Namespace<br/>            Value: '@MyApp'<br/>          - Key: Name<br/>            Value: !Sub<br/>            - '${ExportPrefix_}MyCDN'<br/>            - ExportPrefix_: !If<br/>              - HasExportPrefix<br/>              - !Join ['-', [!Ref ExportPrefix, !Ref Environment, '']]<br/>              - !Join ['-', [!Select [0, !Split ["-", !Ref "AWS::StackName"]], !Ref Environment, '']]<br/>          - Key: Environment<br/>            Value: !FindInMap [Environment, FullForm, !Ref Environment]<br/>      DistributionConfig:<br/>        Comment: "CDN configuration for s3 static website"<br/>        ViewerCertificate:<br/>          AcmCertificateArn: arn:aws:acm:us-east-1:195725532069:certificate/742155d5-0040-4a85-a24d-ac248d93324e #Cert for my personal domain acloudtiger.com<br/>          MinimumProtocolVersion: TLSv1.1_2016<br/>          SslSupportMethod: sni-only<br/>        DefaultRootObject: 'index.html'<br/>        Aliases:<br/>          - !Ref DomainName<br/>          #- !Sub '*.${DomainName}'<br/>          - !Sub 'www.${DomainName}'<br/>        Enabled: true<br/>        HttpVersion: http2<br/>        IPV6Enabled: true<br/>        Origins:<br/>          - Id: my-s3-static-website<br/>            DomainName: !GetAtt FEStaticWebsiteS3Bucket.DomainName<br/>            S3OriginConfig:<br/>              OriginAccessIdentity: <br/>                Fn::Sub: 'origin-access-identity/cloudfront/${MyCDNOAI}'<br/>        DefaultCacheBehavior:<br/>          Compress: 'true'<br/>          AllowedMethods: <br/>            - DELETE<br/>            - GET<br/>            - HEAD<br/>            - OPTIONS<br/>            - PATCH<br/>            - POST<br/>            - PUT<br/>          CachedMethods: <br/>            - GET<br/>            - HEAD<br/>            - OPTIONS<br/>          ForwardedValues:<br/>            QueryString: false<br/>          TargetOriginId: my-s3-static-website<br/>          ViewerProtocolPolicy : redirect-to-https<br/><br/># ---------------------------------------------------#<br/>#  Zone file for TLD - Public Hosted Zone            #<br/># ---------------------------------------------------#<br/><br/>  # PublicHostedZoneForZoneFile:<br/>  #   Type: AWS::Route53::HostedZone<br/>  #   Properties: <br/>  #     HostedZoneConfig: <br/>  #       Comment: Hosted zone acloudtiger.com<br/>  #     Name: !Ref DomainName<br/><br/># -------------------------------------------------------------#<br/>#                Record sets for Public Hosted Zone            #<br/># -------------------------------------------------------------#<br/>  # DNSAliasRecordForIPV4:<br/>  #   Type: AWS::Route53::RecordSet<br/>  #   DependsOn: MyCDN<br/>  #   Properties:<br/>  #     HostedZoneId: !Ref PublicHostedZoneForZoneFile<br/>  #     Name: !Ref DomainName<br/>  #     Type: A<br/>  #     AliasTarget:<br/>  #       DNSName: !GetAtt MyCDN.DomainName<br/>  #       HostedZoneId: !Ref CDNHostedZoneId<br/><br/>  # DNSAliasRecordForIPV6:<br/>  #   Type: AWS::Route53::RecordSet<br/>  #   DependsOn: MyCDN<br/>  #   Properties:<br/>  #     HostedZoneId: !Ref PublicHostedZoneForZoneFile<br/>  #     Name: !Ref DomainName<br/>  #     Type: AAAA<br/>  #     AliasTarget:<br/>  #       DNSName: !GetAtt MyCDN.DomainName<br/>  #       HostedZoneId: !Ref CDNHostedZoneId<br/><br/>  # DNSIP4RecordForMyApp:<br/>  #   Type: AWS::Route53::RecordSet<br/>  #   DependsOn: MyCDN<br/>  #   Properties:<br/>  #     HostedZoneId: !Ref PublicHostedZoneForZoneFile<br/>  #     Name: www.acloudtiger.com<br/>  #     Type: A<br/>  #     AliasTarget:<br/>  #       DNSName: !GetAtt MyCDN.DomainName<br/>  #       HostedZoneId: !Ref CDNHostedZoneId<br/><br/>  # DNSIPV6RecordForMyApp:<br/>  #   Type: AWS::Route53::RecordSet<br/>  #   DependsOn: MyCDN<br/>  #   Properties:<br/>  #     HostedZoneId: !Ref PublicHostedZoneForZoneFile<br/>  #     Name: www.acloudtiger.com<br/>  #     Type: AAAA<br/>  #     AliasTarget:<br/>  #       DNSName: !GetAtt MyCDN.DomainName<br/>  #       HostedZoneId: !Ref CDNHostedZoneId  <br/><br/># ------------------------------------------------------------#<br/>#                          Outputs                                             #<br/># ----------------------------------------------------------- #<br/>Outputs:<br/>  MyAppApi:<br/>    Description: "API Gateway endpoint URL for Prod stage for this function"<br/>    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/hello/"<br/>  <br/>  MyAppFunction:<br/>    Description: "Lambda Function ARN"<br/>    Value: !GetAtt MyAppFunction.Arn<br/><br/>  # MyAppFunctionIamRole:<br/>  #   Description: "Implicit IAM Role created for function"<br/>  #   Value: !GetAtt MyAppFunctionRole.Arn<br/><br/>  DynamoDBTable:<br/>    Description: Dynamodb table<br/>    Export:<br/>      Name: !Sub<br/>        - ${ExportPrefix_}:${AWS::Region}:myapp:DynamoDBTable<br/>        - ExportPrefix_: !If<br/>          - HasExportPrefix<br/>          - !Join ['-', [!Ref ExportPrefix, !Ref Environment]]<br/>          - !Join ['-', [!Select [0, !Split ["-", !Ref "AWS::StackName"]], !Ref Environment]]<br/>    Value: !Ref DynamoDBTable<br/>  <br/>  DynamoDBTableArn:<br/>    Description: Dynamodb table Arn<br/>    Export:<br/>      Name: !Sub<br/>        - ${ExportPrefix_}:${AWS::Region}:myapp:DynamoDBTable:Arn<br/>        - ExportPrefix_: !If<br/>          - HasExportPrefix<br/>          - !Join ['-', [!Ref ExportPrefix, !Ref Environment]]<br/>          - !Join ['-', [!Select [0, !Split ["-", !Ref "AWS::StackName"]], !Ref Environment]]<br/>    Value: !GetAtt DynamoDBTable.Arn</span></pre><p id="ddb3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">现在开始部署吧:)</strong></p><p id="e1c6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">部署您的资源有两种方式，<strong class="js iu">交互模式</strong>(如果您是新手，建议使用)或<strong class="js iu">非交互模式</strong>(如果您是专业人员或希望像Jenkins一样与您的CI/CD服务器集成)。</p><p id="f464" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">运行以下命令并按照所有提示<strong class="js iu">执行基于交互模式的部署</strong> :-</p><pre class="ky kz la lb gt nt nu nv nw aw nx bi"><span id="9f25" class="ne lm it nu b gy ny nz l oa ob">sam build</span><span id="9035" class="ne lm it nu b gy oc nz l oa ob">sam deploy --guided</span></pre><p id="d205" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">或者，对于<strong class="js iu">非交互模式</strong>，在您的终端中执行以下命令:-</p><pre class="ky kz la lb gt nt nu nv nw aw nx bi"><span id="ff21" class="ne lm it nu b gy ny nz l oa ob">sam build</span><span id="0fa7" class="ne lm it nu b gy oc nz l oa ob">sam package --template-file template.yaml --output-template-file deploy.yaml --s3-bucket acloudtiger-sam-template-cli<br/><br/>sam deploy --template-file deploy.yaml --stack-name acloudtiger-sam-stack</span></pre><p id="99ab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lk">请注意，有了上面的步骤，你需要确保S3桶(在我的例子中是</em><strong class="js iu"><em class="lk">acloudttiger-Sam-template-CLI</em></strong><em class="lk">)存在。</em></p><h2 id="2828" class="ne lm it bd ln nf ng dn lr nh ni dp lv kb nj nk lz kf nl nm md kj nn no mh np bi translated">输出:</h2><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi od"><img src="../Images/5c22e2127085ba318edd49a370e50f8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T982kdxyZrFnAukp-KUN2Q.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">AWS SAM CLI —输出</figcaption></figure><p id="265c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您将看到资源在您的终端上创建，一旦完成，您将有一个应用程序准备好在您在template.YAML中提到的公共托管区域域中访问。在我的情况下，它在https://acloudtiger.com的<a class="ae lj" href="https://acloudtiger.com" rel="noopener ugc nofollow" target="_blank"/></p><p id="f98f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除了上述步骤，如果您想在将Lambda函数部署到AWS Cloud之前在本地测试或调试它们，您可以执行以下命令并随时使用它们。</p><p id="f167" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你想用一个预先配置的事件来执行你的Lambda函数</p><pre class="ky kz la lb gt nt nu nv nw aw nx bi"><span id="368c" class="ne lm it nu b gy ny nz l oa ob">sam local invoke &lt;Lambda function name&gt; --event &lt;event.json&gt;</span></pre><p id="5f39" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您不想将任何事件传递给Lambda函数:-</p><pre class="ky kz la lb gt nt nu nv nw aw nx bi"><span id="aaf6" class="ne lm it nu b gy ny nz l oa ob">sam local invoke &lt;Lambda function name&gt; --no-event</span></pre><p id="1c5a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果在您的IDE中配置了一个调试器(比如，<strong class="js iu"> VS代码</strong>)并监听特定的端口(在我的例子中是1391)，那么执行下面的命令:-</p><pre class="ky kz la lb gt nt nu nv nw aw nx bi"><span id="ba43" class="ne lm it nu b gy ny nz l oa ob">sam local invoke &lt;Lambda function name&gt; -d 1391 --event ./events/event_sqs.json</span></pre><p id="802e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你喜欢这篇文章:)</p><h1 id="0b36" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">总结:</h1><p id="f912" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb nq kd ke kf nr kh ki kj ns kl km kn im bi translated">在这篇博客中，我们看到了如何使用AWS SAM来构建和创建无服务器资源，如AWS Lambda、AWS API Gateway和AWS DynamoDB表，以及其他AWS全球服务，如Route 53 public hosted zone及其记录集和CloudFront分发。</p><p id="986d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，我们可以将此SAM模板(无服务器YAML文件)与CI/CD服务器(如Atlassian Bamboo或Jenkins)配合使用，构建一个端到端的集成管道，以自动完成临时设置无服务器应用程序的整个过程。</p><p id="b72a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">像往常一样，您可以在GitHub存储库中找到代码:</p><p id="65c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">【https://github.com/vinod827/k8s-nest/tree/main/iac/aws/sa】T2米</p></div></div>    
</body>
</html>