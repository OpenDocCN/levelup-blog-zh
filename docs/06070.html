<html>
<head>
<title>A chatbot for Asset Control</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于资产控制的聊天机器人</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-chatbot-for-asset-control-19e6606b7d9c?source=collection_archive---------11-----------------------#2020-10-22">https://levelup.gitconnected.com/a-chatbot-for-asset-control-19e6606b7d9c?source=collection_archive---------11-----------------------#2020-10-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7b1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我将为资产控制构建一个聊天机器人，作为一个有趣的小项目。为什么？因为我早就想实现一个聊天机器人了——如果只是为了理解如何实现的话——而且在AC领域这样做似乎很自然。我还将把它与Slack集成在一起，看看它如何与我现有的工具和工作流程相适应。</p><h1 id="466f" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">聊天机器人做什么？</h1><p id="5bcf" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">到现在为止，你应该已经在很多地方遇到过聊天机器人了。它们可能在公司网站上，帮助你得到常见问题的答案，允许你预订等等。</p><p id="c4ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，我想实现一个聊天机器人的原型来与Slack集成，这允许我与资产控制进行通信。我可能想向它询问我的AC env的状态信息或请求数据。</p><p id="d051" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了指导实现，我使用了机器人应该能够回答的以下问题:</p><ul class=""><li id="5d22" class="lo lp iq jp b jq jr ju jv jy lq kc lr kg ls kk lt lu lv lw bi translated">到XYZ的最后价格是多少？</li><li id="b9aa" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk lt lu lv lw bi translated">XYZ这个月的高点是多少？</li><li id="3136" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk lt lu lv lw bi translated">今天有多少嫌疑犯？</li><li id="b5f5" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk lt lu lv lw bi translated">复制是否是最新的？</li></ul><p id="dc05" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们会看到，一旦我们有了第一个问题，其他问题只是同一模式的变体。</p><p id="20e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，我们是从零开始实现这个机器人吗？当然不是。有很多解决方案，我很快就选择了Google Dialogflow。让我们看看这是如何工作的。</p><h1 id="ff6c" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">在Dialogflow中构建bot</h1><p id="85bf" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">为了在<a class="ae mc" href="https://dialogflow.com/" rel="noopener ugc nofollow" target="_blank"> Google Dialogflow </a>中构建我们的机器人，我们需要理解几个概念:</p><ul class=""><li id="72b1" class="lo lp iq jp b jq jr ju jv jy lq kc lr kg ls kk lt lu lv lw bi translated">意图</li><li id="b76b" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk lt lu lv lw bi translated">实体</li><li id="bb16" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk lt lu lv lw bi translated">完成</li></ul><p id="bc3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将回到第一个问题<em class="md">“XYZ的最终价格是多少？”</em>来解释这些。</p><p id="e418" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">意图捆绑了属于机器人应该处理的某个狭义定义的主题的所有内容。在我们的例子中，这是从我们的系统中检索一只股票最近的价格。我们将使用Dialogflow通过给机器人训练短语来训练它理解什么时候对话是关于这样一个意图的。我们一会儿就能看到。</p><p id="818b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么实体就是构成我们对话的构件，并且是我们特别感兴趣的，所以我们想把它们作为参数来捕捉。现在，在我们的例子中，当我们问问题<em class="md">“AAPL的最后价格是多少？”时，这将是股票代码AAPL</em></p><p id="9835" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，履行概念允许我们通过webhooks来访问聊天机器人背后的服务。也就是说，我们将与资产控制进行通信，以查询给定的股票并检索最近的可用价格。</p><p id="b295" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们来建造我们的机器人。</p><h1 id="3e9c" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">第一步:设置你的机器人。</h1><p id="c7cd" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">前往https://dialogflow.cloud.google.com/#/login并签到。然后创建一个代理AcChatBot:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/9513c2af66d1539dd92be0da1f7e97e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gxzm0deLLHwnglrNdrXzkw.jpeg"/></div></div></figure><h1 id="95a4" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤2:创建股票实体</h1><p id="4575" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">从左边的菜单中，单击Entities旁边的加号，将其命名为Stock，并输入<code class="fe mq mr ms mt b">[A-Z][A-Z0-9]{1,6}</code>作为正则表达式。虽然不完全匹配ticker符号，但对于我们的示例来说已经足够了，并且可以与Dialogflow本身执行的正则表达式检查一起工作(例如，不要太宽泛等等。).那就省省吧。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mu"><img src="../Images/a9b4f87b1e15bbb06586e0b077ee0cfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EzZBnQYXIJhHiFA6MFJUow.jpeg"/></div></div></figure><h1 id="9c7d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤3:创建最后的价格意向</h1><p id="cff0" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">是我们最后一次价格意向的时候了。同样，从左侧菜单中选择Intents旁边的加号，将其命名为<code class="fe mq mr ms mt b">Last price</code>,然后单击ADD TRAINING PHRASES:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mv"><img src="../Images/71a94a98d0fb2629cef4136060de25ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oCRLxIiGm9LZwigzLfssjg.jpeg"/></div></div></figure><p id="310c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输入<code class="fe mq mr ms mt b">What is the last price for AAPL?</code>。然后用鼠标高亮显示<code class="fe mq mr ms mt b">AAPL</code>。这将弹出一个弹出窗口。搜索<code class="fe mq mr ms mt b">Stock</code>，然后选择显示的选项:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mw"><img src="../Images/5db64f3ad355a2693175be54a6480e41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fyR0tUlyvROYhauUjKcZhA.jpeg"/></div></div></figure><p id="5914" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果操作正确，结果将如下所示，以确保Dialogflow正确捕获股票实体:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mx"><img src="../Images/253b1517010a72fee82a3b2593811755.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uGHKYkZv2QYtAhJ2gaYjrA.jpeg"/></div></div></figure><p id="1e0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">重要！</strong>然后向下滚动，打开履行部分，点击启用履行，然后切换到<code class="fe mq mr ms mt b">Enable webhook call for this intent</code>，如下所示:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi my"><img src="../Images/b44ae30f60d57cfdecd783dfd7f2165b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jo8AxfPr558eSP9bGwyjyA.jpeg"/></div></div></figure><p id="da11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这允许我们调用自己的后端功能，并与资产控制进行通信。</p><p id="80eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确保在继续之前保存意图。</p><h1 id="b77c" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤4:实现REST服务来检索资产控制数据</h1><p id="f217" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">同样，有许多方法可以做到这一点。我们将使用Spring Boot，因为它为我们做了所有繁重的工作，我们留在Java中，因此可以立即使用与Adetta使用的相同的资产控制Java API。</p><p id="19a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你还不知道，Adetta是我们用于资产控制的测试自动化软件。请务必在这里看一下<a class="ae mc" href="https://terrafino-solutions.com/blog/adetta/adetta-introduction/" rel="noopener ugc nofollow" target="_blank">Adetta简介。</a></p><p id="5221" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有趣的是一个类<code class="fe mq mr ms mt b">AcBotController</code>和它的<code class="fe mq mr ms mt b">handleIntent</code>方法，如下所示:</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="3152" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以看到用于Dialogflow实现的webhook正在处理POST请求。它的输入和输出都是JSON。我们使用<code class="fe mq mr ms mt b">GoogleCloudDialogflowV2Webhook*</code>类来处理JSON的请求和响应。</p><p id="1233" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">意图的实际处理被传递给我们通过调用<code class="fe mq mr ms mt b">AcBotIntents.getHandlerFor(request)</code>获得的AcBotIntentHandler。让我们来看看这个类:</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="bf8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们建立了意图到处理程序的映射(还记得我们的<code class="fe mq mr ms mt b">Last price</code>意图吗？)并实现一个方法，在给定编码在请求对象中的意图的情况下检索合适的处理程序。我们还定义了一个默认的处理程序，以防我们找不到实际的处理程序:</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="6c98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，为了得到给定股票的最后价格，让我们看看<code class="fe mq mr ms mt b">AcBotLastPriceIntentHandler</code>:</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="670f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以看到我们如何使用<code class="fe mq mr ms mt b">request.getQueryResult().getParameters().getOrDefault("Stock", "")</code>从请求对象中检索股票实体参数，然后调用<code class="fe mq mr ms mt b">getLastPriceMessageForStock</code>，如下所示:</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="91d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们防止存货价值的丢失。否则，我们浏览我们的资产控制系统，寻找给定代码的股票。如果我们没有任何这样的ADO，我们显示相应的消息。否则，我们将继续检索我们找到的每个ADO的价格数据(虽然这应该只是单个ADO，但如果需要的话，实现将只返回多条消息。)</p><p id="66d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我们如何找到最后的价格:</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="af46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们加载ADO的时间序列，获取最后一条记录，如果存在的话，创建一条消息，读为<code class="fe mq mr ms mt b">The last price for AAPL (C0.EQY.100101) is from 2020-06-12 at $338.00</code>。我们再次警惕那些找不到价格的情况。</p><p id="1295" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Spring Boot，我们可以启动它，让我们的REST服务在localhost:8080/ac-bot上运行。接下来呢？</p><p id="0ffb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很明显，我们有一点欺骗，因为我们没有在任何地方部署这个服务，所以为了让它从外部可用，我们将使用<a class="ae mc" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank"> ngrok </a>为我们建立一个隧道:</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mz na l"/></div></figure><h1 id="1aee" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">第五步:建立我们自己的履行网钩</h1><p id="4d48" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">接下来，我们必须让Dialogflow知道我们的REST服务在哪里，所以回到那里，从左边的菜单中单击Fulfillment:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nb"><img src="../Images/2b1292edf2872e2d9908ae1494d7a387.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pz_CN0TwU6CUV-M9yjLxcQ.jpeg"/></div></div></figure><p id="cb64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后输入ngrok给出的<code class="fe mq mr ms mt b">https://...</code>地址，并确保在末尾加上<code class="fe mq mr ms mt b">/ac-bot</code>。</p><p id="7998" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，关键时刻到了。在右上角显示<code class="fe mq mr ms mt b">Try it now</code>的地方，我们可以键入<code class="fe mq mr ms mt b">What is the last price for AAPL?</code>，如果一切正常，我们应该会得到以下答案:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nc"><img src="../Images/dd7660e42b415f71c3e9765aaf53f05c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v1nWDGhaCszzcHJiWtA3UQ.jpeg"/></div></div></figure><p id="d77b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这太令人兴奋了！</p><h1 id="3474" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤6:将我们的聊天机器人与Slack整合</h1><p id="9871" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">现在，我们不打算继续使用Dialogflow控制台来玩我们的bot。相反，我们将把它与Slack整合。因此，从左边的菜单中选择Integrations，找到Slack并启动一个测试机器人:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nd"><img src="../Images/012a16e9f9bd4193e280aa60e822072c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L1kKRYyroBXUJZmlolRtMA.jpeg"/></div></div></figure><p id="69fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后前往Slack并开始与机器人聊天:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ne"><img src="../Images/347b35da2a49e2eeebf5983cc4c94e07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*LfPzobTKefKf4uw-65Zzcg.gif"/></div></div></figure><p id="e0c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们可以重复这个循环来实现文章开头列出的其他问题/意图。</p><h1 id="f7b0" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">结束语</h1><p id="bdbc" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我觉得这样做很有趣。也比我想象的容易。当然，我走了很多捷径:</p><ul class=""><li id="0711" class="lo lp iq jp b jq jr ju jv jy lq kc lr kg ls kk lt lu lv lw bi translated">仅在本地运行服务。</li><li id="1a1d" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk lt lu lv lw bi translated">没有考虑安全性、访问控制和资产控制环境的选择。</li><li id="6da0" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk lt lu lv lw bi translated">对机器人的使用非常有限。</li></ul><p id="3f58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是它显示了基本的概念，可以很容易地扩展。实际上，我很想尽快研究一个更强大的资产控制Slack集成。</p><p id="f7cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你喜欢这篇文章。保持联系，分享您的想法，提出问题等。我们是来帮忙的。</p></div></div>    
</body>
</html>