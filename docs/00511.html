<html>
<head>
<title>How to implement data polling with React, Redux, and Thunk</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用React、Redux和Thunk实现数据轮询</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-implement-data-polling-with-react-redux-and-thunk-33cd1e47f89c?source=collection_archive---------3-----------------------#2019-04-03">https://levelup.gitconnected.com/how-to-implement-data-polling-with-react-redux-and-thunk-33cd1e47f89c?source=collection_archive---------3-----------------------#2019-04-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/9b1c78799efd1364737bbdc8269d6a19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*klkJzqlPXCAjyjv9"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@rawpixel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> rawpixel </a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="f06e" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">介绍</h1><p id="18b4" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在我之前的文章<a class="ae kf" href="https://medium.freecodecamp.org/loading-data-in-react-redux-thunk-redux-saga-suspense-hooks-666b21da1569" rel="noopener ugc nofollow" target="_blank">如何用Redux-Thunk、Redux-Saga、suspension&amp;Hooks</a>加载数据中，我比较了从API加载数据的不同方式。在web应用程序中，数据经常需要更新，以便向用户显示相关信息。短轮询是实现这一点的方法之一。查看<a class="ae kf" href="https://codeburst.io/polling-vs-sse-vs-websocket-how-to-choose-the-right-one-1859e4e13bd9" rel="noopener" target="_blank">这篇</a>文章，了解更多细节和备选方案。</p><p id="0b91" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">简而言之，我们将每隔<strong class="lg iu"> N </strong>毫秒请求一次新数据。然后，我们显示这个新数据，而不是以前加载的数据。本文给出了一个使用React、Redux和Thunk实现这一点的例子。</p><p id="51bf" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">先定义一下问题。</p><p id="c4ad" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><strong class="lg iu"><em class="mh">web站点的很多组件从API中轮询数据(对于这个例子，我使用</em></strong><a class="ae kf" href="https://iextrading.com/developer/docs/#getting-started" rel="noopener ugc nofollow" target="_blank"><strong class="lg iu">iextrading.com</strong></a><strong class="lg iu">的公共API来显示股票价格<em class="mh">)并将这些数据显示给用户。轮询逻辑应该与组件分离，并且应该是可重用的。如果调用失败，组件应该显示一个错误，如果调用成功，则隐藏以前显示的错误。</em> </strong></p><p id="f8eb" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">本文假设您已经有了一些创建React/Redux应用程序的经验。</p><p id="965d" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">该示例的代码可在<a class="ae kf" href="https://github.com/ValeraT1982/react-data-polling-thunk" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p><h1 id="3ce4" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">项目设置</h1><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mi"><img src="../Images/781721aee4109f86bbee36855c34d899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CUCno0aLg6dlbNfu"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@mattartz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马特·阿特兹</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="ec47" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我假设您已经使用<a class="ae kf" href="https://github.com/facebook/create-react-app" rel="noopener ugc nofollow" target="_blank"> create-react-app </a>创建了一个React项目，并配置了Redux，可以使用了。如果你有任何困难，你可以检查一下<a class="ae kf" href="https://facebook.github.io/create-react-app/" rel="noopener ugc nofollow" target="_blank">这个</a>和/或<a class="ae kf" href="https://medium.com/backticks-tildes/setting-up-a-redux-project-with-create-react-app-e363ab2329b8" rel="noopener">这个</a>。</p><p id="817c" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><a class="ae kf" href="https://github.com/diegoddox/react-redux-toastr" rel="noopener ugc nofollow" target="_blank"> React-redux-toastr </a>用于显示带有错误的弹出窗口。</p><h1 id="1978" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">商店配置</h1><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mn"><img src="../Images/b409214837d31aedced9472ed7451d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AQYKcMVorpRR5tcE"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@drewpatrickmiller?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">德鲁·帕特里克·米勒</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="233b" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">使用thunk中间件减少存储配置。</p><p id="137a" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><em class="mh"> configureStore.js </em></p><pre class="mj mk ml mm gt mo mp mq mr aw ms bi"><span id="cc8b" class="mt kh it mp b gy mu mv l mw mx">import { applyMiddleware, createStore, compose } from 'redux';<br/>import thunk from 'redux-thunk';<br/>import rootReducer from './rootReducer';</span><span id="a5b8" class="mt kh it mp b gy my mv l mw mx">export function configureStore(initialState) {<br/>  return createStore(rootReducer, initialState, compose(applyMiddleware(thunk)));<br/>}</span></pre><h1 id="cc60" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">根部减速器</h1><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/e2b3346667b69791f44d7beb0fa3f2e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UDuoMCnAcUEEnujh"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@photoholgic?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">霍尔格连杆</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="90de" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在<strong class="lg iu"> <em class="mh"> rootReducer </em> </strong>中，我们将Reducer与应用数据(稍后创建)以及<a class="ae kf" href="https://github.com/diegoddox/react-redux-toastr" rel="noopener ugc nofollow" target="_blank"> react-redux-toastr </a>中的<strong class="lg iu"><em class="mh">toastr</em></strong>reducer结合起来。</p><p id="14fb" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><em class="mh"> rootReducer.js </em></p><pre class="mj mk ml mm gt mo mp mq mr aw ms bi"><span id="3eb0" class="mt kh it mp b gy mu mv l mw mx">import {combineReducers} from 'redux';<br/>import data from './reducer';<br/>import {reducer as toastr} from 'react-redux-toastr'</span><span id="d150" class="mt kh it mp b gy my mv l mw mx">const rootReducer = combineReducers({<br/>    data,<br/>    toastr<br/>});</span><span id="22cb" class="mt kh it mp b gy my mv l mw mx">export default rootReducer;</span></pre><h1 id="3ed0" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">行动</h1><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/b33ac9501230b128d5e4c2a40e64694a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aKVnYTUScutfTgOp"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">罗伯特·尼克森在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="41c1" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们只需要一个动作来加载股票价格。如果调用成功，则<strong class="lg iu"><em class="mh">LOAD _ DATA _ SUCCESS</em></strong>动作被调度以更新全局状态并移除错误(如果先前的调用失败)，否则，显示错误。</p><p id="7f06" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><em class="mh"> actions.js </em></p><pre class="mj mk ml mm gt mo mp mq mr aw ms bi"><span id="b000" class="mt kh it mp b gy mu mv l mw mx">import {toastr} from "react-redux-toastr";</span><span id="18db" class="mt kh it mp b gy my mv l mw mx">export const LOAD_DATA_SUCCESS = "LOAD_DATA_SUCCESS";</span><span id="b885" class="mt kh it mp b gy my mv l mw mx">export const loadPrices = () =&gt; dispatch =&gt; {<br/>    return fetch(<br/>        '<a class="ae kf" href="https://api.iextrading.com/1.0/stock/market/batch?symbols=aapl,fb,tsla,msft,googl,amzn&amp;types=quote'" rel="noopener ugc nofollow" target="_blank">https://api.iextrading.com/1.0/stock/market/batch?symbols=aapl,fb,tsla,msft,googl,amzn&amp;types=quote'</a>)<br/>        .then(response =&gt; {<br/>            if (response.ok) {<br/>                return response.json();<br/>            }</span><span id="380a" class="mt kh it mp b gy my mv l mw mx">            throw new Error(response.statusText);<br/>        })<br/>        .then(<br/>            data =&gt; {<br/>                toastr.removeByType('error');<br/>                dispatch({type: LOAD_DATA_SUCCESS, data});<br/>            },<br/>            error =&gt; {<br/>                toastr.error(`Error loading data: ${error.message}`);<br/>            })<br/>};</span></pre><h1 id="66bf" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">应用还原剂</h1><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/fa9ad095c721ff53be722888319fb0b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WTsVH4tOMyNBALhL"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">扎克·赖纳在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="ac17" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">Reducer更新全局状态。</p><p id="8621" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><em class="mh"> reducer.js </em></p><pre class="mj mk ml mm gt mo mp mq mr aw ms bi"><span id="7b2f" class="mt kh it mp b gy mu mv l mw mx">import {LOAD_DATA_SUCCESS} from "./actions";</span><span id="7575" class="mt kh it mp b gy my mv l mw mx">const initialState = {<br/>    prices: []<br/>};</span><span id="4cb8" class="mt kh it mp b gy my mv l mw mx">export default function reducer(state = initialState, action) {<br/>    switch (action.type) {<br/>        case LOAD_DATA_SUCCESS: {<br/>            return {<br/>                ...state,<br/>                prices: action.data<br/>            }<br/>        }<br/>        default: {<br/>            return state;<br/>        }<br/>    }<br/>}</span></pre><h1 id="0bec" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">用于查询数据的高阶组件(HOC)</h1><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nb"><img src="../Images/c37a92dec4940f5ac3dd700775208898.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VZpApoNLQxF0lM1a"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">杰克·斯洛普在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="4947" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">这可能是最棘手的部分。像Redux中的<strong class="lg iu"> <em class="mh">连接</em> </strong>一样，可以修饰另一个组件来添加一些附加功能。在这种情况下，<strong class="lg iu"> <em class="mh"> withPolling </em> </strong>接收<strong class="lg iu"><em class="mh">polling action</em></strong>和<strong class="lg iu"> <em class="mh"> duration </em> </strong>作为属性。在<strong class="lg iu"> <em class="mh">上，componentdimount</em></strong>组件调用<strong class="lg iu"><em class="mh">polling action</em></strong>并调度每隔<strong class="lg iu"><em class="mh"/></strong>毫秒调用相同的动作(默认为2000)。在<strong class="lg iu"> <em class="mh">组件上将卸载</em> </strong>组件停止轮询。更多关于HOC <a class="ae kf" href="https://reactjs.org/docs/higher-order-components.html" rel="noopener ugc nofollow" target="_blank">的细节在这里</a>。</p><p id="2f7f" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><em class="mh"> withPolling.js </em></p><pre class="mj mk ml mm gt mo mp mq mr aw ms bi"><span id="2558" class="mt kh it mp b gy mu mv l mw mx">import * as React from 'react';<br/>import {connect} from 'react-redux';</span><span id="4b33" class="mt kh it mp b gy my mv l mw mx">export const withPolling = (pollingAction, duration = 2000) =&gt; Component =&gt; {<br/>    const Wrapper = () =&gt; (<br/>        class extends React.Component {<br/>            componentDidMount() {<br/>                this.props.pollingAction();<br/>                this.dataPolling = setInterval(<br/>                    () =&gt; {<br/>                        this.props.pollingAction();<br/>                    },<br/>                    duration);<br/>            }</span><span id="7f56" class="mt kh it mp b gy my mv l mw mx">componentWillUnmount() {<br/>                clearInterval(this.dataPolling);<br/>            }</span><span id="044e" class="mt kh it mp b gy my mv l mw mx">render() {<br/>                return &lt;Component {...this.props}/&gt;;<br/>            }<br/>        });</span><span id="1649" class="mt kh it mp b gy my mv l mw mx">const mapStateToProps = () =&gt; ({});</span><span id="34bd" class="mt kh it mp b gy my mv l mw mx">const mapDispatchToProps = {pollingAction};</span><span id="6140" class="mt kh it mp b gy my mv l mw mx">return connect(mapStateToProps, mapDispatchToProps)(Wrapper())<br/>};</span></pre><h1 id="cef5" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">用法示例(价格组件)</h1><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nc"><img src="../Images/74f4c77aeadbaa8ddec926728306ae9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DPxYQD2zF3LdlOgS"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Bobby Rodriguezz 在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="2622" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><strong class="lg iu"> <em class="mh">价格组件</em> </strong>使用<strong class="lg iu"> <em class="mh"> withPolling </em> </strong>，将价格从状态映射到道具并显示数据。</p><p id="38d9" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><em class="mh"> PricesComponent.js </em></p><pre class="mj mk ml mm gt mo mp mq mr aw ms bi"><span id="5740" class="mt kh it mp b gy mu mv l mw mx">import * as React from 'react';<br/>import {connect} from 'react-redux';<br/>import {loadPrices} from "./actions";<br/>import {withPolling} from "./withPolling";</span><span id="9caf" class="mt kh it mp b gy my mv l mw mx">class PricesComponent extends React.Component {<br/>    render() {<br/>        return (<br/>            &lt;div&gt;<br/>                &lt;table&gt;<br/>                    &lt;thead&gt;<br/>                    &lt;tr&gt;<br/>                        &lt;th&gt;Symbol&lt;/th&gt;<br/>                        &lt;th&gt;Company Name&lt;/th&gt;<br/>                        &lt;th&gt;Sector&lt;/th&gt;<br/>                        &lt;th&gt;Open&lt;/th&gt;<br/>                        &lt;th&gt;Close&lt;/th&gt;<br/>                        &lt;th&gt;Latest&lt;/th&gt;<br/>                        &lt;th&gt;Updated&lt;/th&gt;<br/>                    &lt;/tr&gt;<br/>                    &lt;/thead&gt;<br/>                    &lt;tbody&gt;<br/>                    {Object.entries(this.props.prices).map(([key, value]) =&gt; (<br/>                        &lt;tr key={key}&gt;<br/>                            &lt;td&gt;{key}&lt;/td&gt;<br/>                            &lt;td&gt;{value.quote.companyName}&lt;/td&gt;<br/>                            &lt;td&gt;{value.quote.sector}&lt;/td&gt;<br/>                            &lt;td&gt;{value.quote.open}&lt;/td&gt;<br/>                            &lt;td&gt;{value.quote.close}&lt;/td&gt;<br/>                            &lt;td&gt;{value.quote.latestPrice}&lt;/td&gt;<br/>                            &lt;td&gt;{(new Date(Date(value.quote.latestUpdate))).toLocaleTimeString()}&lt;/td&gt;<br/>                        &lt;/tr&gt;<br/>                    ))}<br/>                    &lt;/tbody&gt;<br/>                &lt;/table&gt;<br/>            &lt;/div&gt;<br/>        );<br/>    }<br/>}</span><span id="0c27" class="mt kh it mp b gy my mv l mw mx">const mapStateToProps = state =&gt; ({<br/>    prices: state.data.prices<br/>});</span><span id="b49a" class="mt kh it mp b gy my mv l mw mx">const mapDispatchToProps = {};</span><span id="c0dc" class="mt kh it mp b gy my mv l mw mx">export default withPolling(loadPrices)(<br/>    connect(mapStateToProps, mapDispatchToProps)(PricesComponent));</span></pre><h1 id="36a8" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">应用</h1><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nd"><img src="../Images/8231293c368ea666d171cf186f3f8cda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j4xNy38DuJdggNNE"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@jaywennington?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">杰伊·温宁顿</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="0f30" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">该应用程序由<strong class="lg iu">价格组件</strong>和<strong class="lg iu"> <em class="mh"> ReduxToastr </em> </strong>(显示错误的组件)组成</p><p id="45d3" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><em class="mh"> App.js </em></p><pre class="mj mk ml mm gt mo mp mq mr aw ms bi"><span id="52fb" class="mt kh it mp b gy mu mv l mw mx"><strong class="mp iu">import </strong>React, {Component} <strong class="mp iu">from 'react'</strong>;<br/><strong class="mp iu">import </strong>ReduxToastr <strong class="mp iu">from 'react-redux-toastr'<br/>import 'react-redux-toastr/lib/css/react-redux-toastr.min.css'<br/>import </strong>PricesComponent <strong class="mp iu">from "./PricesComponent"</strong>;<br/><br/><strong class="mp iu">class </strong>App <strong class="mp iu">extends </strong>Component {<br/>    render() {<br/>        <strong class="mp iu">return </strong>(<br/>            &lt;<strong class="mp iu">div</strong>&gt;<br/>                &lt;<strong class="mp iu">PricesComponent text='My Text'</strong>/&gt;<br/>                &lt;<strong class="mp iu">ReduxToastr<br/>                    transitionIn="fadeIn"<br/>                    transitionOut="fadeOut"<br/>                    preventDuplicates=</strong>{<strong class="mp iu">true</strong>}<br/>                    <strong class="mp iu">timeOut=</strong>{99999}<br/>                /&gt;<br/>            &lt;/<strong class="mp iu">div</strong>&gt;<br/>        );<br/>    }<br/>}<br/><br/><strong class="mp iu">export default </strong>App;</span></pre><p id="40b9" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">这个应用程序看起来是这样的，没有错误。</p><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ne"><img src="../Images/9674dbd9b8849c757f00c3e27aa42d5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D45BE51QP89MwQ-Hp2nQQw.jpeg"/></div></div></figure><p id="4d53" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">像这样有误差。仍显示先前加载的数据。</p><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nf"><img src="../Images/a5faab986d191d1701627c248d0fd8a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WIH55Wglp3udEXPq57PPGw.jpeg"/></div></div></figure><h1 id="67c9" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">带轮询随机测试</h1><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/d74b0e0f59317e69f7afa5d94e6644fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XzdId5hdr6TY1xZQ"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@_louisreed?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">路易斯·里德</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="7657" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><a class="ae kf" href="https://github.com/airbnb/enzyme" rel="noopener ugc nofollow" target="_blank">带有酶-接头-反应-16的酶</a>用于测试。这里比较棘手的部分是使用jest的假计时器，创建<strong class="lg iu"><em class="mh">testAction</em></strong><em class="mh"/>和<em class="mh"/><strong class="lg iu"><em class="mh">wrapper component</em></strong><em class="mh">。</em></p><p id="3a79" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><em class="mh"> setupTests.js </em></p><pre class="mj mk ml mm gt mo mp mq mr aw ms bi"><span id="92d3" class="mt kh it mp b gy mu mv l mw mx">import Enzyme from 'enzyme';<br/>import Adapter from 'enzyme-adapter-react-16';</span><span id="7a4b" class="mt kh it mp b gy my mv l mw mx">// React 16 Enzyme adapter<br/>Enzyme.configure({ adapter: new Adapter() });</span></pre><p id="1363" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><em class="mh"> withPolling.test.js </em></p><pre class="mj mk ml mm gt mo mp mq mr aw ms bi"><span id="4d9d" class="mt kh it mp b gy mu mv l mw mx">import * as React from 'react';<br/>import {mount} from 'enzyme';<br/>import {withPolling} from './withPolling';<br/>import {configureStore} from "./configureStore";<br/>import {Provider} from "react-redux";</span><span id="3d67" class="mt kh it mp b gy my mv l mw mx">jest.useFakeTimers();</span><span id="bc8b" class="mt kh it mp b gy my mv l mw mx">describe('withPolling HOC Tests', () =&gt; {<br/>    let store;<br/>    let wrapper;</span><span id="53a9" class="mt kh it mp b gy my mv l mw mx">    const TestComponent = () =&gt; (<br/>        &lt;div id='test-component'&gt;<br/>            Test Component<br/>        &lt;/div&gt;<br/>    );</span><span id="a95a" class="mt kh it mp b gy my mv l mw mx">    beforeEach(() =&gt; {<br/>        store = configureStore();<br/>    });</span><span id="4e49" class="mt kh it mp b gy my mv l mw mx">    afterEach(() =&gt; {<br/>        wrapper.unmount();<br/>    });</span><span id="04b0" class="mt kh it mp b gy my mv l mw mx">    it('function is called on mount', () =&gt; {<br/>        const mockFn = jest.fn();<br/>        const testAction = () =&gt; () =&gt; {<br/>            mockFn();<br/>        };</span><span id="60b0" class="mt kh it mp b gy my mv l mw mx">        const WrapperComponent = withPolling(testAction)(TestComponent);</span><span id="beee" class="mt kh it mp b gy my mv l mw mx">        wrapper = mount(&lt;Provider store={store}&gt;&lt;WrapperComponent/&gt;&lt;/Provider&gt;);</span><span id="9972" class="mt kh it mp b gy my mv l mw mx">        expect(wrapper.find('#test-component')).toHaveLength(1);<br/>        expect(mockFn.mock.calls.length).toBe(1);<br/>    });</span><span id="5de9" class="mt kh it mp b gy my mv l mw mx">    it('function is called second time after duration', () =&gt; {<br/>        const mockFn = jest.fn();<br/>        const testAction = () =&gt; () =&gt; {<br/>            mockFn();<br/>        };</span><span id="f5d0" class="mt kh it mp b gy my mv l mw mx">        const WrapperComponent = withPolling(testAction, 1000)(TestComponent);</span><span id="5b04" class="mt kh it mp b gy my mv l mw mx">        wrapper = mount(&lt;Provider store={store}&gt;&lt;WrapperComponent/&gt;&lt;/Provider&gt;);</span><span id="ce0a" class="mt kh it mp b gy my mv l mw mx">        expect(wrapper.find('#test-component')).toHaveLength(1);<br/>        expect(mockFn.mock.calls.length).toBe(1);</span><span id="f956" class="mt kh it mp b gy my mv l mw mx">        jest.runTimersToTime(1001);</span><span id="b261" class="mt kh it mp b gy my mv l mw mx">        expect(mockFn.mock.calls.length).toBe(2);<br/>    });<br/>});</span></pre><h1 id="d52d" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">结论</h1><p id="16ae" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这个例子展示了如何使用React、Redux和Thunk实现数据轮询。</p><p id="13be" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">作为另一种解决方案，带轮询的<strong class="lg iu"/>可以是一个类组件(例如轮询)。在这种情况下<strong class="lg iu"><em class="mh">&lt;Polling/&gt;</em></strong>将需要添加到<strong class="lg iu"><em class="mh">price component</em></strong>中。我认为本文提供的解决方案稍好一些，因为我们不需要向JSX添加假组件(不添加任何可见内容的组件)，而HOC是一种添加可重用组件逻辑的技术。</p><p id="d1bd" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">就是这样。喜欢这篇文章就欣赏鼓掌吧！</p><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ng"><img src="../Images/c48363a3de87c0b159db0ecdc805946a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n32x90iiJHWbhl4FitGaow.jpeg"/></div></div></figure></div></div>    
</body>
</html>