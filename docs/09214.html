<html>
<head>
<title>Build AWS Athena Look-Alike in Grafana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Grafana中构建AWS Athena外观</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/build-aws-athena-look-alike-in-grafana-f6da6e3473c5?source=collection_archive---------1-----------------------#2021-07-17">https://levelup.gitconnected.com/build-aws-athena-look-alike-in-grafana-f6da6e3473c5?source=collection_archive---------1-----------------------#2021-07-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="28b5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ko translated"><span class="l kp kq kr bm ks kt ku kv kw di">一个</span> WS Athena允许用户使用简单的SQL查询分析来自S3的数据。另一方面，当您查询大量数据时，成本会更高。在本文中，我将详细阐述我们如何实现一个经济高效的Athena模仿程序来分析我们的负载平衡器通过Grafana存储在S3的访问日志。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/a4f3e05650a094cdeed797a424048102.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*3xrV_VIVy8Y4O6tS63URCA.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">体系结构</figcaption></figure><p id="caf4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如图所示，我们在ALB后面运行一个监视器节点。ALB将访问日志发送到S3，监控节点提取日志并将其发送到Grafana进行可视化。</p><p id="f821" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">监视节点有足够的IAM权限从S3提取日志。我们使用一个简单的bash脚本来完成这项任务。该脚本提取日志，将它们存储在给定的路径中，并删除超过给定持续时间的日志。它已被配置为cron作业。</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="lj lk l"/></div></figure><pre class="ky kz la lb gt ll lm ln lo aw lp bi"><span id="0525" class="lq lr it lm b gy ls lt l lu lv">*/2,7,12,17,22,27,32,37,42,47,52,57 * * * * /bin/get_alblogs.sh</span></pre><p id="5824" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">crontab配置背后的基本原理是，ALB每5分钟将访问日志推送到S3(每个可用性区域一个日志文件)。cron在2分钟后运行，并获取最新的日志。</p><p id="acc8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们应该将这些日志插入到一个关系数据库中，以便以后查询。这里我们使用了SQLite3。</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="lj lk l"/></div></figure><p id="3f98" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的python脚本从本地路径读取日志文件，并将它们插入到SQLite3 DB中。你可以参考<a class="ae lw" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html" rel="noopener ugc nofollow" target="_blank">这里的</a>来了解更多关于AWS ALB访问日志的字段。该脚本比<code class="fe lx ly lz lm b">get_alblogs.sh</code>晚运行一分钟。</p><pre class="ky kz la lb gt ll lm ln lo aw lp bi"><span id="0f1e" class="lq lr it lm b gy ls lt l lu lv">*/3,8,13,18,23,28,33,38,43,48,53,58 * * * * python3 /bin/alb_logs_executor.py</span></pre><p id="7f71" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下一步将是将SQLite3 DB与Grafana集成，通过Grafana查询和可视化数据。在这里你可以找到如何为Grafana安装SQLite3插件。</p><p id="399c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">安装完成后，在Grafana中配置SQLite3数据源。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi ma"><img src="../Images/cd52ab6eb4ad4b37ea1ad230b94c866f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wijozyUjaE23T00eIlwPvA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">SQLite3数据源</figcaption></figure><p id="5cfa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来在Grafana中导航到Explore，选择数据源为SQLite3，输入下面给出的查询(更改域名)并单击“运行查询”。</p><pre class="ky kz la lb gt ll lm ln lo aw lp bi"><span id="8caf" class="lq lr it lm b gy ls lt l lu lv">WITH converted AS (<br/>   SELECT *, time AS datetime FROM alb_logs<br/>)<br/>SELECT domain_name, COUNT(*) FROM converted WHERE time BETWEEN ('2021-07-17T00:00:00') AND ('2021-07-17T23:59:59')<br/>AND domain_name = "kite47.com";</span></pre><p id="e84d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这就是全部，现在您将能够在表格部分下查看结果。同样，您可以运行任何SQL查询。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mf"><img src="../Images/4a10fce1d3564ab3a8f4806d1f44f16a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*usTa4nuF42KafsE6mizxKA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">SQLite3数据查询</figcaption></figure><p id="3368" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">欢迎反馈！</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mg"><img src="../Images/ad2c9a3a4b838bb7203f94730cceefaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fypmK7aCWEt9acR6fPR1bQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">参观kite47.com</figcaption></figure></div></div>    
</body>
</html>