<html>
<head>
<title>Reducing a Visual Studio Extension (VSIX) File Size</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">减小Visual Studio扩展(VSIX)文件的大小</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/reducing-a-visual-studio-extension-vsix-file-size-86ed72fbcf39?source=collection_archive---------7-----------------------#2021-01-04">https://levelup.gitconnected.com/reducing-a-visual-studio-extension-vsix-file-size-86ed72fbcf39?source=collection_archive---------7-----------------------#2021-01-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="4ed6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">并解决格式错误的Azure DevOps扩展包错误</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/8c71b0dde22e7533e33098387e1b1252.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j1AHMO_vBeHBwKwoufRdTw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated"><a class="ae le" href="https://docs.microsoft.com/en-us/visualstudio/extensibility/shipping-visual-studio-extensions" rel="noopener ugc nofollow" target="_blank"> VSIX </a>标志放置在来自<a class="ae le" href="https://unsplash.com/photos/v7WyjiyXNr4" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>的背景图片上</figcaption></figure><h1 id="47d2" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">介绍</h1><p id="c926" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">我最近更新了我在Visual Studio Marketplace上发布的Azure DevOps扩展。我上次对这个扩展进行更新是在2019年，但我已经做好了一切，包括DevOps管道，所以我认为这应该很容易。嗯，差不多了。当我开始发布扩展时，我遇到了一个错误。本文旨在揭示这个错误以及解决这个问题的方法。</p><h1 id="009b" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">问题</h1><p id="4c9a" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">我做了修改，所有的单元测试都通过了，甚至构建管道生成了一个VSIX包——到目前为止一切顺利。但是，当发布管道启动时，它在尝试将VSIX包部署到Visual Studio Marketplace时失败，并出现以下错误。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mi"><img src="../Images/141706963dc0fcf20df68099c9e79da4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PlQ3v4NYeYq9ua3BCzOXjg.png"/></div></div></figure><p id="2c5b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果上面的截图不是很清楚，文本版本如下:</p><pre class="kp kq kr ks gt mj mk ml mm aw mn bi"><span id="3a3a" class="mo lg it mk b gy mp mq l mr ms">error: Extension package is malformed/corrupted 0 [ 'error: Extension package is malformed/corrupted', '' ]</span><span id="d9a3" class="mo lg it mk b gy mt mq l mr ms">[error]tfx failed with error: Error: The process 'C:\hostedtoolcache\windows\tfx\0.7.11\x64\tfx.cmd' failed with exit code 4294967295</span></pre><p id="2dcc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对这个问题进行快速搜索后，我转到了<a class="ae le" href="https://github.com/microsoft/vscode-vsce/issues/153#issuecomment-281347656" rel="noopener ugc nofollow" target="_blank">对一个<a class="ae le" href="https://github.com/microsoft/vscode-vsce/issues/153" rel="noopener ugc nofollow" target="_blank"> GitHub问题</a>的评论</a>。尽管它是针对VS代码扩展的，但潜在的问题似乎是当VSIX发布到市场上时有一个文件大小限制。<a class="ae le" href="https://developercommunity.visualstudio.com/solutions/299439/view.html" rel="noopener ugc nofollow" target="_blank">在<a class="ae le" href="https://developercommunity.visualstudio.com/content/problem/292454/the-extension-package-size-exceeds-the-maximum-pac.html" rel="noopener ugc nofollow" target="_blank">开发者社区论坛</a>上的这个评论</a>也确认了一个文件大小限制，尽管大小值略有不同。</p><p id="e5c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我看了一下由build pipeline生成的VSIX的文件大小，你瞧，它是26.6MB！这意味着尝试和解决这个错误的第一步是减小VSIX包的文件大小。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/158e11f63c343c538ce9912dbf0944f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:572/format:webp/1*fnVLcgc-igVpmcjyfzGTTw.png"/></div></figure><h1 id="f533" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">解决办法</h1><p id="67c8" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">那么，如何减小VSIX文件的大小呢？让我们一步一步来看看。</p><h2 id="9d8b" class="mo lg it bd lh mv mw dn ll mx my dp lp kb mz na lt kf nb nc lx kj nd ne mb nf bi translated">第一步:看看包装的是什么</h2><p id="7242" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">在我们开始减小文件大小之前，理解VSIX文件中实际包含的内容是很重要的。要解包，只需下载生成的VSIX文件，并像解压缩zip文件一样解压缩内容。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/aac29338fd4b34fbff2fa99fe8a4ed4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*A7mkKtLNbGx34FTIkNw3GQ.png"/></div></figure><p id="2d85" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<code class="fe nh ni nj mk b">buildAndReleaseTask</code>文件夹中，我可以看到我所有的开发文件和<code class="fe nh ni nj mk b">node_nodules</code>文件夹。我不明白为什么这个任务需要打包的VSIX文件中的tests文件夹，例如，才能在Azure DevOps中准确运行，所以这需要调查。凭记忆，我还知道<code class="fe nh ni nj mk b">node_modules</code>文件夹一般会占用很多磁盘空间。快速的谷歌搜索将会显示关于一个大的node_modules文件夹的多个问题和减小文件夹大小的建议。这给了我一个很好的起点。</p><h2 id="73bd" class="mo lg it bd lh mv mw dn ll mx my dp lp kb mz na lt kf nb nc lx kj nd ne mb nf bi translated">步骤2:让我们处理node_modules文件夹</h2><p id="bee0" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">在我们做任何事情之前，如果我检查node_modules文件夹的大小，它是一个巨大的126MB的磁盘。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/ef01ad0d568f4a0eab1b7303121eb474.png" data-original-src="https://miro.medium.com/v2/resize:fit:616/format:webp/1*JKEbvKJFgeNmd1iqhVq9_w.png"/></div></figure><p id="aad4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在研究如何减小这个巨大文件夹的文件大小时，我偶然发现了这篇令人惊叹的博文，其中描述了一些你可以尝试的方法。引起我注意的是node-prune和modclean的使用。我决定尝试modclean，因为他们通过npm 提供了他们的<a class="ae le" href="https://www.npmjs.com/package/modclean" rel="noopener ugc nofollow" target="_blank"> CLI工具。</a></p><p id="213a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个<a class="ae le" href="https://github.com/ModClean/modclean/wiki/CLI" rel="noopener ugc nofollow" target="_blank"> CLI文档</a>之后，我做了以下事情:</p><ol class=""><li id="4a63" class="nl nm it js b jt ju jx jy kb nn kf no kj np kn nq nr ns nt bi translated">我用VS代码打开了终端窗口，并全局安装了CLI工具。我用<code class="fe nh ni nj mk b">npm install -g modclean</code>做到了这一点。</li><li id="897e" class="nl nm it js b jt nu jx nv kb nw kf nx kj ny kn nq nr ns nt bi translated">尽管如此，在终端窗口中，我将目录更改为<code class="fe nh ni nj mk b">Src\buildAndReleaseTask</code>，这是<code class="fe nh ni nj mk b">node_modules</code>文件夹所在的位置，并键入命令<code class="fe nh ni nj mk b">modclean -r</code>。这将在<code class="fe nh ni nj mk b">node_modules</code>文件夹上执行modclean，指定<code class="fe nh ni nj mk b">-r</code>选项将在不提示任何警告或使其交互的情况下运行该实用程序。</li></ol><p id="5f0c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将node_modules文件夹在磁盘上的大小减少到97.3MB。不太激烈，但现在还好。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/1b08c0eaa820d397c19ed898cea7b3fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:634/format:webp/1*AZXgFpIwKnb19uZDug0LWw.png"/></div></figure><p id="d357" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后我运行<a class="ae le" href="https://github.com/ClydeDz/meta-tag-analyzer/blob/master/Src/buildAndReleaseTask/package.json#L18" rel="noopener ugc nofollow" target="_blank">命令</a> <code class="fe nh ni nj mk b">npm run devtest</code>来运行我的测试，包括执行扩展和使用Azure Pipelines模拟运行器生成Excel报告。所有的单元测试都通过了，最终报告也准确地生成了。这给了我信心，即使从node_modules文件夹中删除了一些文件，任务仍然可以像预期的那样工作。</p><p id="1c09" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，为了检查VSIX包的文件大小，我在我的开发机器上运行了以下命令。点击查看tfs-cli <a class="ae le" href="https://github.com/microsoft/tfs-cli/blob/master/docs/extensions.md" rel="noopener ugc nofollow" target="_blank">的完整文档。</a></p><pre class="kp kq kr ks gt mj mk ml mm aw mn bi"><span id="cd00" class="mo lg it mk b gy mp mq l mr ms">tfx extension create --manifest-globs .\vss-extension.json</span></pre><p id="5d8a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最终的VSIX包大小已经有了很大的改进，从26.6MB减少到了19.8MB。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/a28ae5ed858e91706fac3b43b4a2bde1.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/1*paEBn_EYabTvP4orgvOOPQ.png"/></div></figure><h2 id="c607" class="mo lg it bd lh mv mw dn ll mx my dp lp kb mz na lt kf nb nc lx kj nd ne mb nf bi translated">步骤3:删除开发文件</h2><p id="c0bc" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">当任务在Azure管道中运行时，它执行<code class="fe nh ni nj mk b">index.js</code>文件中的<code class="fe nh ni nj mk b">run()</code>方法。task.json文件中的<a class="ae le" href="https://github.com/ClydeDz/meta-tag-analyzer/blob/master/Src/buildAndReleaseTask/task.json#L34-L38" rel="noopener ugc nofollow" target="_blank">执行代码块</a>告诉管道这样做。这意味着，我们并不真正需要最终包中的TypeScript文件。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/820c7a06930153b7f60a4a6c32ac011a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*IWoQmI6ngeS-AfGxmCe0Bg.png"/></div></figure><p id="bef8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了删除所有的TypeScript文件，我打开了解压VSIX包内容的<code class="fe nh ni nj mk b">buildAndReleaseTask</code>文件夹，打开了一个命令提示符，然后执行命令<code class="fe nh ni nj mk b">del /S *.ts</code>(在Windows上)递归删除所有的TypeScript文件。</p><p id="5ff9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">类似地，我执行命令<code class="fe nh ni nj mk b">del /S *.xlsx</code>递归删除所有Excel文件，执行命令<code class="fe nh ni nj mk b">del /S *.xml</code>递归删除所有XML文件。我还使用命令<code class="fe nh ni nj mk b">rmdir /S “tests” /q</code>删除tests文件夹的内容，因为我们不再需要它了。选项<code class="fe nh ni nj mk b">/q</code>静默执行该命令。</p><p id="9856" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个练习之后，解压缩后的<code class="fe nh ni nj mk b">buildAndReleaseTask</code>文件夹的大小减少了26.82%。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/efb0ee40e8fffdda5d41942da2737e11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*hOP5plCyV-NGNcIoTynfew.png"/></div></figure><h2 id="db26" class="mo lg it bd lh mv mw dn ll mx my dp lp kb mz na lt kf nb nc lx kj nd ne mb nf bi translated">步骤4:在Azure DevOps中测试</h2><p id="0aa1" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">现在是时候在为我生成VSIX包的Azure DevOps构建管道中测试这些步骤了。就在单元测试结果发布到管道之后，VSIX打包之前，我添加了三个命令行任务——全局安装npm包modclean，执行modclean命令，最后是删除开发文件的命令。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oc"><img src="../Images/5ab3eb2b66a331123ff00e5d14727d68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y7qeRvbQdyL36boOTAepiw.png"/></div></div></figure><p id="0e41" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于“删除开发文件”步骤，我将所有四个命令合并成一行，用一个“与”符<code class="fe nh ni nj mk b">&amp;</code>分隔每个命令。</p><p id="9853" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">保存更改后，我运行管道并比较结果。VSIX软件包的文件大小已经减少了8MB，降至20MB以下。太好了！</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi od"><img src="../Images/a1df63830933a6afdcc5c96aad7fe690.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6VZTrxNrwh6-tF8G7wSMgA.png"/></div></div></figure><h2 id="5204" class="mo lg it bd lh mv mw dn ll mx my dp lp kb mz na lt kf nb nc lx kj nd ne mb nf bi translated">第五步:家务</h2><p id="c93d" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">让我们将所有命令移到<a class="ae le" href="https://github.com/ClydeDz/meta-tag-analyzer/blob/master/Src/buildAndReleaseTask/package.json#L20-L21" rel="noopener ugc nofollow" target="_blank"> package.json文件</a>的脚本部分，而不是将所有命令直接写入构建管道的GUI。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oe"><img src="../Images/3fdc7c8988a4ddddfb47af58ea0ff404.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MkDrEQvGJA_wnUJSSS1sXQ.png"/></div></div></figure><p id="885e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我现在可以使用命令<code class="fe nh ni nj mk b">npm run modclean</code>和<code class="fe nh ni nj mk b">npm run clean-dir</code>从构建管道中执行这些命令。</p><p id="4136" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">注意:</strong>如果您使用YAML作为您的管道，您可能不需要执行这个步骤，因为整个管道都是基于YAML文件的，并且与其余的代码一起受源代码控制。</p><h1 id="4d47" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="7644" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">最后，我在构建包的主分支上运行构建管道，这触发了成功发布VSIX的发布管道。</p><p id="8fe0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你想看看Azure DevOps扩展，<a class="ae le" href="https://marketplace.visualstudio.com/items?itemName=clydedsouza.meta-tag-analyzer" rel="noopener ugc nofollow" target="_blank">这里有一个链接</a>指向Visual Studio Marketplace中的Meta Tag Analyzer。这个扩展的源代码在<a class="ae le" href="https://github.com/ClydeDz/meta-tag-analyzer" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上。</p><p id="9619" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你喜欢这本书。如果你经历过类似的旅程，请在下面的评论中告诉我。就是这样。感谢阅读！</p></div></div>    
</body>
</html>