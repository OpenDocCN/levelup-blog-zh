<html>
<head>
<title>How to Integrate Elastic APM Java Agent with Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将弹性APM Java代理与Spring Boot集成</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-integrate-elastic-apm-java-agent-with-spring-boot-7ce8388a206e?source=collection_archive---------0-----------------------#2021-06-20">https://levelup.gitconnected.com/how-to-integrate-elastic-apm-java-agent-with-spring-boot-7ce8388a206e?source=collection_archive---------0-----------------------#2021-06-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d656" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">春天的路</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/bb6c310dcd18b52bebbdf21271f978bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SKJx7ElROou4KgfbqfHPIA.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@5tep5?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">亚历山大·波波夫</a>在<a class="ae kv" href="https://unsplash.com/s/photos/performance?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="a712" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="f5ad" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">应用程序性能监控(APM)可以让您深入了解应用程序在速度和错误方面的表现。在Spring上下文中，这围绕着事务(API调用或预定事件)和错误或异常。</p><p id="838f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">虽然不是唯一可用的APM解决方案，但Elastic APM提供了一种相当方便的方式来集成一些最流行的框架和技术，如Spring、React和Angular。另一方面，APM服务器与弹性堆栈的其余部分配合良好；它直接提供给Elasticsearch，Kibana的仪表盘在<code class="fe mp mq mr ms b">Observability -&gt; APM</code>下显示出良好的开箱即用的可视化效果。</p><p id="8d73" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们来看一种用弹性APM Java代理检测Spring应用程序的方法。</p><h1 id="23e6" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">先决条件</h1><p id="426f" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在这篇文章中，我主要关注集成部分，而不是基础设施。所以，我假设您已经安装了Elasticsearch、Kibana和APM服务器，或者能够轻松运行提供的<code class="fe mp mq mr ms b">docker-compose</code>文件。</p><p id="fd21" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">更具体地说，从APM服务器，您将需要它的URL和一个秘密令牌来授权到它的连接。</p><h1 id="f8ac" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">不同的整合方式</h1><p id="d863" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">从历史上看，你可以将代理作为自己的<code class="fe mp mq mr ms b">jar</code>单独运行。当运行你的主应用程序时，你也可以通过APM <code class="fe mp mq mr ms b">jar</code>作为<code class="fe mp mq mr ms b">javaagent</code>参数。在容器上下文中，您可以将代理作为主容器旁边的副容器来运行。</p><p id="1152" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">也就是说，我发现将代理添加为依赖项并通过Spring的配置来配置它是一种更好、更“有弹性”的方法。它也不需要改变您的<code class="fe mp mq mr ms b">Dockerfile</code>或部署配置和脚本。这种自连接方法仍处于测试阶段，但到目前为止还没有遇到任何问题。关于<a class="ae kv" href="https://www.elastic.co/guide/en/apm/agent/java/current/setup-attach-api.html" rel="noopener ugc nofollow" target="_blank"> Elastic文档</a>的更多详情。</p><h1 id="c234" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">春天的路</h1><p id="7e02" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">那么，如何以Spring方式添加弹性APM Java代理呢？简单地说，通过执行这三个步骤:</p><p id="1887" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">1-添加依赖关系:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="07a4" class="mx kx iq ms b gy my mz l na nb">&lt;!--Elastic APM --&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;co.elastic.apm&lt;/groupId&gt;<br/>    &lt;artifactId&gt;apm-agent-attach&lt;/artifactId&gt;<br/>    &lt;version&gt;1.20.0&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="eb90" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">2-当Spring应用程序启动时，添加<code class="fe mp mq mr ms b">@Configuration</code>类来“附加”代理:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="bd32" class="mx kx iq ms b gy my mz l na nb">package io.sayadi.elasticapmspringbootintegration;<br/><br/>import co.elastic.apm.attach.ElasticApmAttacher;<br/>import lombok.Setter;<br/>import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;<br/>import org.springframework.boot.context.properties.ConfigurationProperties;<br/>import org.springframework.context.annotation.Configuration;<br/><br/>import javax.annotation.PostConstruct;<br/>import java.util.HashMap;<br/>import java.util.Map;<br/><br/>@Setter<br/>@Configuration<br/>@ConfigurationProperties(prefix = "elastic.apm")<br/>@ConditionalOnProperty(value = "elastic.apm.enabled", havingValue = "true")<br/>public class ElasticApmConfig {<br/><br/>    private static final String <em class="nc">SERVER_URL_KEY </em>= "server_url";<br/>    private String serverUrl;<br/><br/>    private static final String <em class="nc">SERVICE_NAME_KEY </em>= "service_name";<br/>    private String serviceName;<br/><br/>    private static final String <em class="nc">SECRET_TOKEN_KEY </em>= "secret_token";<br/>    private String secretToken;<br/><br/>    private static final String <em class="nc">ENVIRONMENT_KEY </em>= "environment";<br/>    private String environment;<br/><br/>    private static final String <em class="nc">APPLICATION_PACKAGES_KEY </em>= "application_packages";<br/>    private String applicationPackages;<br/><br/>    private static final String <em class="nc">LOG_LEVEL_KEY </em>= "log_level";<br/>    private String logLevel;<br/><br/>    @PostConstruct<br/>    public void init() {<br/><br/>        Map&lt;String, String&gt; apmProps = new HashMap&lt;&gt;(6);<br/>        apmProps.put(<em class="nc">SERVER_URL_KEY</em>, serverUrl);<br/>        apmProps.put(<em class="nc">SERVICE_NAME_KEY</em>, serviceName);<br/>        apmProps.put(<em class="nc">SECRET_TOKEN_KEY</em>, secretToken);<br/>        apmProps.put(<em class="nc">ENVIRONMENT_KEY</em>, environment);<br/>        apmProps.put(<em class="nc">APPLICATION_PACKAGES_KEY</em>, applicationPackages);<br/>        apmProps.put(<em class="nc">LOG_LEVEL_KEY</em>, logLevel);<br/><br/>        ElasticApmAttacher.<em class="nc">attach</em>(apmProps);<br/>    }<br/>}</span></pre><p id="6d27" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">3-将值添加到您希望代理运行的所有概要文件的<code class="fe mp mq mr ms b">properties</code>文件中:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="0400" class="mx kx iq ms b gy my mz l na nb"># Elastic APM<br/>elastic.apm.enabled=true<br/>elastic.apm.server-url=http://localhost:8200<br/>elastic.apm.service-name=elastic-apm-spring-boot-integration<br/>elastic.apm.secret-token=xxVpmQB2HMzCL9PgBHVrnxjNXXw5J7bd79DFm6sjBJR5HPXDhcF8MSb3vv4bpg44<br/>elastic.apm.environment=dev<br/>elastic.apm.application-packages=io.sayadi.elasticapmspringbootintegration<br/>elastic.apm.log-level=DEBUG</span></pre><h1 id="daac" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">逐步演练</h1><p id="6eaf" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">按照下面的步骤创建将在下一节中运行的代码库。<strong class="lq ir">或者，您可以克隆与本文</strong>关联的 <a class="ae kv" href="https://github.com/sayadi/elastic-apm-spring-boot-integration" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> GitHub资源库</strong> </a> <strong class="lq ir">。</strong></p><p id="9609" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">1-从一个来自<a class="ae kv" href="https://start.spring.io" rel="noopener ugc nofollow" target="_blank"> Spring Initializer </a>的全新Spring Boot应用程序开始，至少带有<code class="fe mp mq mr ms b">Spring Web</code>依赖项。</p><p id="97c2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">2-将<code class="fe mp mq mr ms b">Elastic APM</code>的依赖关系添加到<code class="fe mp mq mr ms b">pom.xml</code>:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="0fb9" class="mx kx iq ms b gy my mz l na nb">&lt;!--Elastic APM--&gt;<br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;co.elastic.apm&lt;/groupId&gt;<br/>   &lt;artifactId&gt;apm-agent-attach&lt;/artifactId&gt;<br/>   &lt;version&gt;1.20.0&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="8138" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">3-添加<code class="fe mp mq mr ms b">@Configuration</code>类:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="6b07" class="mx kx iq ms b gy my mz l na nb">package io.sayadi.elasticapmspringbootintegration;<br/><br/>import co.elastic.apm.attach.ElasticApmAttacher;<br/>import lombok.Setter;<br/>import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;<br/>import org.springframework.boot.context.properties.ConfigurationProperties;<br/>import org.springframework.context.annotation.Configuration;<br/><br/>import javax.annotation.PostConstruct;<br/>import java.util.HashMap;<br/>import java.util.Map;<br/><br/>@Setter<br/>@Configuration<br/>@ConfigurationProperties(prefix = "elastic.apm")<br/>@ConditionalOnProperty(value = "elastic.apm.enabled", havingValue = "true")<br/>public class ElasticApmConfig {<br/><br/>    private static final String <em class="nc">SERVER_URL_KEY </em>= "server_url";<br/>    private String serverUrl;<br/><br/>    private static final String <em class="nc">SERVICE_NAME_KEY </em>= "service_name";<br/>    private String serviceName;<br/><br/>    private static final String <em class="nc">SECRET_TOKEN_KEY </em>= "secret_token";<br/>    private String secretToken;<br/><br/>    private static final String <em class="nc">ENVIRONMENT_KEY </em>= "environment";<br/>    private String environment;<br/><br/>    private static final String <em class="nc">APPLICATION_PACKAGES_KEY </em>= "application_packages";<br/>    private String applicationPackages;<br/><br/>    private static final String <em class="nc">LOG_LEVEL_KEY </em>= "log_level";<br/>    private String logLevel;<br/><br/>    @PostConstruct<br/>    public void init() {<br/><br/>        Map&lt;String, String&gt; apmProps = new HashMap&lt;&gt;(6);<br/>        apmProps.put(<em class="nc">SERVER_URL_KEY</em>, serverUrl);<br/>        apmProps.put(<em class="nc">SERVICE_NAME_KEY</em>, serviceName);<br/>        apmProps.put(<em class="nc">SECRET_TOKEN_KEY</em>, secretToken);<br/>        apmProps.put(<em class="nc">ENVIRONMENT_KEY</em>, environment);<br/>        apmProps.put(<em class="nc">APPLICATION_PACKAGES_KEY</em>, applicationPackages);<br/>        apmProps.put(<em class="nc">LOG_LEVEL_KEY</em>, logLevel);<br/><br/>        ElasticApmAttacher.<em class="nc">attach</em>(apmProps);<br/>    }<br/>}</span></pre><p id="5511" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">4-添加<code class="fe mp mq mr ms b">TestController</code>以通过各种性能模拟展示一些端点:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="0e61" class="mx kx iq ms b gy my mz l na nb">package io.sayadi.elasticapmspringbootintegration;<br/><br/>import org.springframework.context.annotation.Profile;<br/>import org.springframework.web.bind.annotation.GetMapping;<br/>import org.springframework.web.bind.annotation.RestController;<br/><br/>@RestController<br/>public class TestController {<br/><br/>    @GetMapping("/super-fast")<br/>    public String getSuperFastApi() {<br/><br/>        return "I'm super fast.";<br/>    }<br/><br/>    @GetMapping("/fast")<br/>    public String getFastApi() throws InterruptedException {<br/><br/>        Thread.<em class="nc">sleep</em>(20); // sleep for 20 milliseconds<br/>        return "I'm fast!";<br/>    }<br/><br/>    @GetMapping("/slow")<br/>    public String getSlowApi() throws InterruptedException {<br/><br/>        Thread.<em class="nc">sleep</em>(3000); // sleep for 3 seconds<br/>        return "I'm slow :(";<br/>    }<br/><br/>    @GetMapping("/super-slow")<br/>    @Profile({"predev", "dev", "staging"})<br/>    public String getSuperSlowApi() throws InterruptedException {<br/><br/>        Thread.<em class="nc">sleep</em>(60000); // sleep for 1 minute!<br/>        return "I'm super slow. Refactor me before moving to production!! :)";<br/>    }<br/>}</span></pre><p id="6afd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">5-创建<code class="fe mp mq mr ms b">application-predev.properties</code>文件:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="e93f" class="mx kx iq ms b gy my mz l na nb">server.port=8081<br/><br/># Elastic APM<br/>elastic.apm.enabled=false</span></pre><p id="c61e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">6-创建<code class="fe mp mq mr ms b">application-dev.properties</code>文件:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="60d1" class="mx kx iq ms b gy my mz l na nb">server.port=8082<br/><br/># Elastic APM<br/>elastic.apm.enabled=true<br/>elastic.apm.server-url=http://localhost:8200<br/>elastic.apm.service-name=elastic-apm-spring-boot-integration<br/>elastic.apm.secret-token=xxVpmQB2HMzCL9PgBHVrnxjNXXw5J7bd79DFm6sjBJR5HPXDhcF8MSb3vv4bpg44<br/>elastic.apm.environment=dev<br/>elastic.apm.application-packages=io.sayadi.elasticapmspringbootintegration<br/>elastic.apm.log-level=DEBUG</span></pre><p id="292b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">7-创建<code class="fe mp mq mr ms b">application-staging.properties</code>文件:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="068c" class="mx kx iq ms b gy my mz l na nb">server.port=8082<br/><br/># Elastic APM<br/>elastic.apm.enabled=true<br/>elastic.apm.server-url=http://localhost:8200<br/>elastic.apm.service-name=elastic-apm-spring-boot-integration<br/>elastic.apm.secret-token=xxVpmQB2HMzCL9PgBHVrnxjNXXw5J7bd79DFm6sjBJR5HPXDhcF8MSb3vv4bpg44<br/>elastic.apm.environment=staging<br/>elastic.apm.application-packages=io.sayadi.elasticapmspringbootintegration<br/>elastic.apm.log-level=INFO</span></pre><p id="48a5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">8-创建<code class="fe mp mq mr ms b">application-prod.properties</code>文件:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="2615" class="mx kx iq ms b gy my mz l na nb">server.port=8083<br/><br/># Elastic APM<br/>elastic.apm.enabled=true<br/>elastic.apm.server-url=http://localhost:8200<br/>elastic.apm.service-name=elastic-apm-spring-boot-integration<br/>elastic.apm.secret-token=xxVpmQB2HMzCL9PgBHVrnxjNXXw5J7bd79DFm6sjBJR5HPXDhcF8MSb3vv4bpg44<br/>elastic.apm.environment=prod<br/>elastic.apm.application-packages=io.sayadi.elasticapmspringbootintegration<br/>elastic.apm.log-level=ERROR</span></pre><p id="a0aa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">9-创建<code class="fe mp mq mr ms b">docker-compose.yaml</code>文件:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="cf38" class="mx kx iq ms b gy my mz l na nb">version: '2.2'<br/><br/>services:<br/>  elasticsearch:<br/>    image: docker.elastic.co/elasticsearch/elasticsearch:7.7.1<br/>    environment:<br/>    - "cluster.routing.allocation.disk.threshold_enabled=false"<br/>    - "discovery.type=single-node"<br/>    - xpack.security.enabled=false<br/>    - ES_JAVA_OPTS=-Xms512m -Xmx512m<br/>    ports:<br/>    - 9200:9200<br/>    healthcheck:<br/>      test: ['CMD', 'curl', '-f', 'http://localhost:9200']<br/>      interval: 10s<br/>      timeout: 5s<br/>      retries: 3<br/><br/>  kibana:<br/>    image: docker.elastic.co/kibana/kibana:7.7.1<br/>    environment:<br/>    - "SERVER_HOST=0.0.0.0"<br/>    ports:<br/>    - 5601:5601<br/>    healthcheck:<br/>      test: ['CMD', 'curl', '-f', 'http://localhost:5601']<br/>      interval: 10s<br/>      timeout: 5s<br/>      retries: 3<br/>    depends_on:<br/>      elasticsearch:<br/>        condition: service_healthy<br/><br/>  apm-server:<br/>    image: docker.elastic.co/apm/apm-server:7.7.1<br/>    ports:<br/>    - 8200:8200<br/>    environment:<br/>    - output.elasticsearch.hosts=['http://elasticsearch:9200']<br/>    - apm-server.host="0.0.0.0:8200"<br/>    - apm-server.secret_token="xxVpmQB2HMzCL9PgBHVrnxjNXXw5J7bd79DFm6sjBJR5HPXDhcF8MSb3vv4bpg44"<br/>    - setup.kibana.host="kibana:5601"<br/>    - setup.template.enabled=true<br/>    - logging.to_files=false<br/>    depends_on:<br/>      elasticsearch:<br/>        condition: service_healthy<br/>      kibana:<br/>        condition: service_healthy</span></pre><p id="3c7c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">10-创建<code class="fe mp mq mr ms b">test-apis.sh</code>脚本:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="cfdc" class="mx kx iq ms b gy my mz l na nb"><strong class="ms ir">#!/bin/bash<br/><br/></strong>api_base_url_predev=http://localhost:8081<br/>api_base_url_dev=http://localhost:8082<br/>api_base_url_staging=http://localhost:8083<br/>api_base_url_prod=http://localhost:8084<br/><br/><br/>for i in {0..10}<br/>  do<br/>    printf "Iteration # %s...\n" "${i}"<br/>    curl "${api_base_url_predev}/super-fast"<br/>    curl "${api_base_url_dev}/super-fast"<br/>    curl "${api_base_url_staging}/super-fast"<br/>    curl "${api_base_url_prod}/super-fast"<br/>    printf "\n"<br/>    curl "${api_base_url_predev}/fast"<br/>    curl "${api_base_url_dev}/fast"<br/>    curl "${api_base_url_staging}/fast"<br/>    curl "${api_base_url_prod}/fast"<br/>    printf "\n"<br/>    curl "${api_base_url_predev}/slow"<br/>    curl "${api_base_url_dev}/slow"<br/>    curl "${api_base_url_staging}/slow"<br/>    curl "${api_base_url_prod}/slow"<br/>    printf "\n"<br/>    curl "${api_base_url_predev}/super-slow" &amp;<br/>    curl "${api_base_url_dev}/super-slow" &amp;<br/>    curl "${api_base_url_staging}/super-slow" &amp;<br/>    # The super-slow api is not on prod<br/>    printf "\n\n"<br/>done</span></pre><h1 id="cb24" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">运行演示</h1><p id="a3b2" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">1-启动<code class="fe mp mq mr ms b">predev</code>环境【终端1】:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="d011" class="mx kx iq ms b gy my mz l na nb">mvn spring-boot:run -Dspring-boot.run.profiles=predev</span></pre><p id="4c3e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">由于<code class="fe mp mq mr ms b">predev</code>环境的<code class="fe mp mq mr ms b">elastic.apm.enabled</code>属性被设置为<code class="fe mp mq mr ms b">false</code>并且<code class="fe mp mq mr ms b">ElasticApmConfig</code>被注释为<code class="fe mp mq mr ms b">@ConditionalOnProperty(value = “elastic.apm.enabled”, havingValue = “true”)</code>，所以这个<code class="fe mp mq mr ms b">@Config</code>类不会被注入到Spring的上下文中，并且弹性APM代理也不会被附加。注意，我们甚至还没有运行弹性APM服务器。</p><p id="133b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">2-启动Elasticsearch、Kibana和Elastic APM服务器[终端2]:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="df47" class="mx kx iq ms b gy my mz l na nb">docker compose up</span></pre><p id="9857" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一旦下载了所有的图像，并且启动了容器，在浏览器中导航到<code class="fe mp mq mr ms b">http://localhost:5601</code>以访问Kibana。</p><p id="d5cf" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">3-启动<code class="fe mp mq mr ms b">dev</code>环境【终端3】:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="78f1" class="mx kx iq ms b gy my mz l na nb">mvn spring-boot:run -Dspring-boot.run.profiles=dev</span></pre><p id="0de1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">请注意这个环境中日志的详细程度，因为我们已经将Elastic的代理日志级别设置为<code class="fe mp mq mr ms b">DEBUG</code>。</p><p id="b931" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">4-启动<code class="fe mp mq mr ms b">staging</code>环境【端子4】:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="dec7" class="mx kx iq ms b gy my mz l na nb">mvn spring-boot:run -Dspring-boot.run.profiles=staging</span></pre><p id="d0b1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在这种环境中，日志级别被设置为<code class="fe mp mq mr ms b">INFO</code>，并且明显不那么详细。</p><p id="8e69" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">5-启动<code class="fe mp mq mr ms b">prod</code>环境【终端5】:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="8f8e" class="mx kx iq ms b gy my mz l na nb">mvn spring-boot:run -Dspring-boot.run.profiles=prod</span></pre><p id="5346" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">至此，如果您前往Kibana上的APM仪表板，您应该会发现一个名为<code class="fe mp mq mr ms b"><a class="ae kv" href="http://localhost:5601/app/apm#/services/elastic-apm-spring-boot-integration/transactions?rangeFrom=now-24h&amp;rangeTo=now&amp;refreshPaused=true&amp;refreshInterval=0" rel="noopener ugc nofollow" target="_blank">elastic-apm-spring-boot-integration</a></code>的服务，它有三个环境:<code class="fe mp mq mr ms b">dev</code>、<code class="fe mp mq mr ms b">staging</code>和<code class="fe mp mq mr ms b">prod</code>，如下图所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/db0f22018c9e05a6e7bc5ac29799c998.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ad0awbxQgSFt0kQV2FQX5g.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">APM仪表板图1</figcaption></figure><p id="2c7d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">6-使用<code class="fe mp mq mr ms b">test-apis.sh</code>脚本在不同的环境中生成一些流量。该脚本将在每个环境中调用<code class="fe mp mq mr ms b">TestController</code> ( <code class="fe mp mq mr ms b">/super-fast</code>、<code class="fe mp mq mr ms b">/fast</code>、<code class="fe mp mq mr ms b">/slow</code>和<code class="fe mp mq mr ms b">/super-slow</code>)中定义的每个端点十次。注意，<code class="fe mp mq mr ms b">prod</code>环境没有公开<code class="fe mp mq mr ms b">/super-slow</code>端点。这是为了模拟一个场景，在这个场景中，一个新特性正在被测试，还没有被部署到生产中。</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="6ac8" class="mx kx iq ms b gy my mz l na nb">chmod +x test-apis.sh<br/>./test-apis.sh</span></pre><p id="8a23" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">等待脚本记录<code class="fe mp mq mr ms b">Iteration 10</code>，然后再等待大约几分钟，直到<code class="fe mp mq mr ms b">super-slow</code>API返回。</p><p id="deef" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">再次前往Kibana上的APM仪表板，点击<code class="fe mp mq mr ms b">elastic-apm-spring-boot-integration</code>服务以获得更多详细信息:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/bc0d5535c91035d4521b7c1288f448af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L96oJBhhw8pIlo2Oacleqg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">APM仪表板图2</figcaption></figure><p id="d339" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在<code class="fe mp mq mr ms b">prod</code>和<code class="fe mp mq mr ms b">staging</code>之间来回过滤:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/bce0a525347bd5d5e7b1c1a7a2f9f69c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vJ9LTWLJjqur5rd9Xz_z1w.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">APM仪表板图3</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/96a3bd86f69bfeb72c372744f48e24e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N3UTAqPlJouBQjMS4frZBw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">APM仪表板图4</figcaption></figure><p id="254c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">平均花费<code class="fe mp mq mr ms b">60,000 ms</code>返回的一个API在<code class="fe mp mq mr ms b">staging</code>上的出现应该引起注意。</p><p id="52b0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">7-清理干净！回到这五个终端，停止所有这些进程。不然你的电脑会不高兴的！</p><h1 id="22d5" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">GitHub知识库</h1><p id="718f" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">如上所述，运行这个演示所需的所有代码和配置都在这个<a class="ae kv" href="https://github.com/sayadi/elastic-apm-spring-boot-integration" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>中。</p><h1 id="5c0c" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">最后的想法</h1><p id="6800" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">感谢你的阅读，请在评论中告诉我你对这个设置的想法。特别是，我对这种beta附件方法可能不起作用的场景以及可以使用的任何缓解措施感兴趣。</p></div></div>    
</body>
</html>