# å¦‚ä½•ç”¨ Docker å®‰è£… Apache Airflow

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/how-to-install-apache-airflow-with-docker-7902be3301b8>

## å…«æ­¥æŒ‡å—åœ¨ Windowsã€Ubuntu å’Œ Mac OS X ä¸Šæµ‹è¯•

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Docker æ¥ä»‹ç» Apache Airflow çš„æœ¬åœ°å®‰è£…ã€‚æˆ‘ä¼šè¯¦ç»†è§£é‡Šæ¯ä¸€æ­¥ï¼Œè®©ä½ å‡†ç¡®æ— è¯¯åœ°é‡ç°ã€‚

**å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥æ›´æ–°å†…å®¹ï¼Œå°½å¯èƒ½é•¿æ—¶é—´ä¿æŒè¿™ç¯‡æ–‡ç« çš„æ­£ç¡®æ€§ğŸ™**

![](img/8580716f7862e5f0f17df7bda4ba58c3.png)

**å¦‚ä½•ç”¨ Docker å®‰è£…æ°”æµï¼Œ**æ‘„å½±[å‡¯åˆ©Â·è¥¿å…‹ç›](https://unsplash.com/@kellysikkema?utm_source=medium&utm_medium=referral)

## 1.æ£€æŸ¥ Docker çš„å®‰è£…

é¦–å…ˆï¼Œæ£€æŸ¥ Docker æ˜¯å¦æ­£ç¡®å®‰è£…åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šã€‚

ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥é”®å…¥ä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤:

```
docker --version
Docker version 20.10.12, build e91ed57docker-compose --version
Docker Compose version v2.2.3
```

**ä½ è‡³å°‘éœ€è¦ Docker Compose v1.29+ã€‚**

å¦‚æœä¸æ˜¯è¿™æ ·ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å®‰è£… [Docker æ¡Œé¢](https://www.docker.com/products/docker-desktop/)(å®ƒä¹Ÿæœ‰ä¸€ä¸ªæ–¹ä¾¿çš„å›¾å½¢ç•Œé¢)å¹¶å®‰è£…ä¸ä½ çš„æ“ä½œç³»ç»Ÿå¯¹åº”çš„ç‰ˆæœ¬ã€‚

> æˆ‘åœ¨ Windows 10ã€Ubuntu 20.04 å’Œ Mac OS XÂ·è’™ç‰¹é‡Œä¸Šæµ‹è¯•äº†æè®®çš„æ“ä½œã€‚

## 2.æ£€ç´¢é˜¿å¸•å¥‡æ°”æµç å¤´é£Ÿè°±

è®¿é—® [Apache Airflow æ–‡æ¡£ç½‘ç«™](https://airflow.apache.org/docs/apache-airflow/stable/index.html)å’Œé¡¶éƒ¨çš„ç‰ˆæœ¬é€‰æ‹©å™¨ã€‚ç„¶åé€‰æ‹©é€‚åˆè‡ªå·±çš„ç‰ˆæœ¬ï¼Œåœ¨ **Docker** éƒ¨åˆ†çš„**å¿«é€Ÿå¯åŠ¨>è¿è¡Œæ°”æµ**ä¸­æ‰¾åˆ°æ–‡ä»¶ä¸‹è½½ã€‚

å¦‚æœæ‚¨éœ€è¦å®‰è£… Apache Airflow 2.4.1:

```
curl -LfO 'https://airflow.apache.org/docs/apache-airflow/2.4.1/docker-compose.yaml'
```

â€œæˆ‘åœ¨ Windows ä¸Šæ²¡æœ‰ curl è½¯ä»¶ã€‚â€

å–å‰ä¸€ä¸ªé“¾æ¥ï¼Œæ”¾å…¥æµè§ˆå™¨ï¼Œå°†å†…å®¹ä¿å­˜åœ¨â€œ *docker-compose.yaml* æ–‡ä»¶ä¸­ã€‚

## 3.åˆ›å»ºé€‚å½“çš„æ–‡ä»¶å¤¹/æ–‡ä»¶ç»“æ„

å¦‚æœæ‚¨çš„ç›®æ ‡æ˜¯èƒ½å¤Ÿåœ¨æœ¬åœ°å¼€å‘è„šæœ¬ï¼Œç„¶åéƒ¨ç½²å®ƒä»¬ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥å°† Docker æ˜ åƒä¸­çš„æ–‡ä»¶å¤¹ä¸æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶å¤¹åŒæ­¥ã€‚

æˆ‘ä»¬å°†è®¡åˆ’åŒæ­¥ *dag* å’Œ *plugin* å¼€å‘ï¼Œèƒ½å¤Ÿè®¿é—®æ—¥å¿—æ€»æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨åŒ…å« Apache Airflow å®ä¾‹çš„æ–‡ä»¶å¤¹ä¸­ï¼Œæ‚¨å°†åˆ›å»ºä»¥ä¸‹ä¸‰ä¸ªæ–‡ä»¶å¤¹:

```
mkdir ./dags ./logs ./plugins
```

åœ¨ Windows ä¸Šï¼Œæ‚¨å¯èƒ½æ— æ³•è®¿é—® **mkdir** ï¼Œè¯·ä½¿ç”¨ [PowerShell](https://learn.microsoft.com/en-us/powershell/scripting/overview?view=powershell-7.2) :

```
New-Item "dags" -ItemType "directory"
New-Item "logs" -ItemType "directory"
New-Item "plugins" -ItemType "directory"
```

ç„¶åå†åŠ ä¸€ä¸ª**ã€‚åŒ…å« Docker æ˜ åƒä½¿ç”¨çš„ç¯å¢ƒå˜é‡çš„ env** æ–‡ä»¶:

```
# Ubuntu / Mac OSX
touch .env# Windows (PowerShell)
ni .env
```

åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œéœ€è¦é…ç½®ä¸€ä¸ªåä¸º **AIRFLOW_UID** çš„ç¯å¢ƒå˜é‡ï¼Œå®ƒå¯¹åº”äºè¿è¡Œ Docker å®¹å™¨çš„ç”¨æˆ·çš„ [UID](https://fr.wikipedia.org/wiki/User_identifier) ã€‚

> è¿˜è®°å¾—æ‚¨åœ¨ä¸€äº› Docker æ˜ åƒä¸Šçš„è®¿é—®/æƒé™ç®¡ç†é—®é¢˜å—ï¼Ÿè¿™å¯èƒ½æ˜¯å› ä¸ºé”™è¯¯é…ç½®çš„ UIDã€‚

åœ¨åƒ Mac OSX æˆ– GNU/Linux è¿™æ ·çš„ç±» UNIX ç³»ç»Ÿä¸Šï¼Œè¿™éå¸¸ç®€å•:

```
echo -e "AIRFLOW_UID=$(id -u)" > .env
```

ä½†æ˜¯åœ¨ Windows ä¸Šï¼Œç”¨æˆ·çš„ç®¡ç†æ˜¯å¤æ‚çš„ğŸ™ƒã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ*å› ä¸º Windows éå¸¸å®½å®¹*ï¼Œä½ ä¸å¿…é…ç½®å®ƒã€‚ä½†æ˜¯ä½œä¸ºå›æŠ¥ï¼Œæ¯æ¬¡ Docker æ˜ åƒå¯åŠ¨æ—¶ï¼Œæ‚¨éƒ½ä¼šæ”¶åˆ°ä¸€æ¡å°å°çš„è­¦å‘Šæ¶ˆæ¯:æ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ã€‚

å¦‚æœè¿™å›°æ‰°ç€ä½ ï¼Œåœ¨**ä¸­æ·»åŠ ä¸‹é¢ä¸€è¡Œã€‚env** æ–‡ä»¶:

```
AIRFLOW_UID=50000
```

## 4.ç§»é™¤æ ·æœ¬ Dag

Apache Airflow å°†é»˜è®¤å®‰è£…ä¸€å † DAGs ç¤ºä¾‹æµã€‚

å¦‚æœæ‚¨ä¸éœ€è¦å®ƒä»¬(æ‚¨å·²ç»äº†è§£äº† Airflow)ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»åœ¨ *docker-compose.yaml* æ–‡ä»¶ä¸­å°†**Airflow _ _ CORE _ _ LOAD _ EXAMPLES**å˜é‡è®¾ç½®ä¸ºâ€˜false â€™,è€Œä¸æ˜¯ true:

![](img/5d5fb5294a36b421465bc55d5920a8c1.png)

## 5.å®‰è£…å¹¶å¯åŠ¨ Docker é•œåƒ

ç°åœ¨ï¼Œè¯· Docker å®‰è£… Apache Airflow:

```
docker-compose up airflow-init
```

è¦æ£€æŸ¥ Docker å®ˆæŠ¤ç¨‹åºæ˜¯å¦å†æ¬¡å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:

```
docker ps
```

å¦‚æœä½ èƒ½çœ‹åˆ°ä¸ä¸Šé¢ç±»ä¼¼çš„ä¿¡æ¯ï¼Œè¿™æ„å‘³ç€ä½ éœ€è¦å¯åŠ¨ Docker æ¡Œé¢åº”ç”¨ç¨‹åº:

```
error during connect: This error may indicate that the docker daemon is not running.: Get "[http://%2F%2F.%2Fpipe%2Fdocker_engine/v1.24/containers/json](http://%2F%2F.%2Fpipe%2Fdocker_engine/v1.24/containers/json)": open //./pipe/docker_engine: The specified file can't be found.
```

> åœ¨ Mac OSX å’Œ Windows 10 ç‰ˆæœ¬ä¸­ï¼Œæ‚¨éƒ½å¯ä»¥å°†å…¶é…ç½®ä¸ºåœ¨å¯åŠ¨æ—¶å¯åŠ¨ã€‚æˆ‘æ²¡æœ‰åœ¨ Ubuntu ä¸Šä½¿ç”¨ Docker æ¡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä¸èƒ½ç¡®å®šâ€¦ *ğŸ˜•*

æœ€åï¼Œä½ ä¹Ÿå¯ä»¥çœ‹çœ‹ Docker æ¡Œé¢ UI å®¢æˆ·ç«¯çš„å†…éƒ¨:å¦‚æœçŠ¶æ€æ æ˜¯ç»¿è‰²çš„ï¼Œè¯´æ˜å¼•æ“å·²ç»å¯åŠ¨å¹¶æŒ‰é¢„æœŸå·¥ä½œï¼

![](img/085ec9167658302c4ba0e4d34bf5e3ef.png)

ç»¿è‰²= âœ…

> ä¸€æ—¦å®‰è£…äº†é•œåƒï¼Œå°†æ¥ä½ åªéœ€è¦æŒ‡ä»¤ **docker-compose up** â€œç…§å¸¸â€ã€‚

![](img/e7f740e0aadb845a50e5bc937a263d52.png)

åœ¨ Windows ä¸Šï¼Œæ¯æ¬¡å¯åŠ¨âœ…æ—¶éƒ½ä¼šå‡ºç°è­¦å‘Šæ¶ˆæ¯

## 6.å¯¹ Web åº”ç”¨ç¨‹åºçš„è®¿é—®

è¦ä½¿ç”¨æµè§ˆå™¨è®¿é—®åº”ç”¨ç¨‹åºï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‡­æ®ç‚¹å‡»[æ­¤é“¾æ¥](http://localhost:8080/home)([http://localhost:8080/home](http://localhost:8080/home)):**air flow**/*air flowã€‚*

è¿™æ˜¯æˆ‘åœ¨ Apache Airflow 2.4.1 ä¸Šçœ‹åˆ°çš„ç”»é¢:

![](img/e0bf81dd9d08d5ed1760bf14f6b0eb97.png)

Apache Airflow ä¸»é¡µ(2.4.1 ç‰ˆ)

> æ­¤æ—¶ï¼Œå®ƒæ˜¯ç©ºçš„ï¼Œå› ä¸ºæˆ‘å·²ç»åœ¨ Docker Compose æ–‡ä»¶ä¸­å°†**air flow _ _ CORE _ _ LOAD _ EXAMPLES**å˜é‡è®¾ç½®ä¸ºâ€˜falseâ€™ã€‚

å¦‚æœæ‚¨éœ€è¦å°†è¿™ä¸ªå®¹å™¨åº”ç”¨ç¨‹åºä¸æœåŠ¡å™¨ä¸­çš„ DNS ç›¸åŒ¹é…ï¼Œä»¥ä¾¿åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ Airflow çš„ Dockerized å®ä¾‹ï¼Œè¯·ä½¿ç”¨ç±»ä¼¼ Nginx ä»£ç†ç®¡ç†å™¨çš„å·¥å…·ã€‚

ç„¶åå°†æ‚¨çš„æœåŠ¡å™¨çš„ IP æ˜ å°„åˆ°åŸŸåï¼Œå¹¶ä½¿ç”¨ 8080 ä½œä¸º HTTP ç«¯å£:è¿™æ˜¯åœ¨æˆ‘çš„æœåŠ¡å™¨ä¸Šå®Œæˆ[çš„æ–¹æ³•ã€‚](https://airflow.solvolabs.com/)

![](img/d947fc0b7d7b1b52cb86ea3780f22bd3.png)

æˆ‘å°†å¾ˆå¿«å‘è¡¨ä¸€ç¯‡å…³äº Nginx ä»£ç†ç®¡ç†å™¨çš„æ–‡ç« ğŸ•—

## 7.æ·»åŠ å¹¶æ‰§è¡Œ DAG

è®©æˆ‘ä»¬ä»‹ç»ä¸€ä¸ªæœ€å°çš„ä¾‹å­ï¼Œè¿™æ ·æ‚¨å¯ä»¥æ£€æŸ¥ Apache Airflow æ˜¯å¦å¯ä»¥æ‰§è¡Œ Dagã€‚

åœ¨ **dags** æ–‡ä»¶å¤¹ä¸­ï¼Œæ–°å»ºä¸€ä¸ªåä¸º **demo.py** çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

ç„¶åç­‰å¾… 20 ç§’å¹¶é‡æ–°åŠ è½½æ‚¨çš„ web æµè§ˆå™¨ï¼ŒDAG ç°åœ¨åº”è¯¥åˆ—åœ¨ Apache Airflow ä¸»é¡µä¸Š:

![](img/eae5b539a258e4f660072efbbb232eeb.png)

æ‚¨å¯ä»¥è§¦å‘å¹¶æŸ¥çœ‹è¾“å‡ºï¼Œä»¥ç¡®è®¤ Apache Airflow å®Œå…¨æ­£å¸¸å·¥ä½œã€‚

![](img/e731b314e0e30dac6fc2b33f9dba5a8a.png)

è¯¥ä»»åŠ¡è¢«è§¦å‘å¹¶è¿”å›é¢„æœŸçš„è¾“å‡ºâœ…

## 8.è®¿é—® CLI åº”ç”¨ç¨‹åº

é»˜è®¤æƒ…å†µä¸‹ï¼Œweb æœåŠ¡å™¨å’Œä½œä¸šç¼–æ’å™¨éå¸¸æ´»è·ƒï¼Œå“åº”é€Ÿåº¦è¶³ä»¥è®©æ‚¨åˆ›å»ºå’Œæµ‹è¯• Dagã€‚ä½†æ˜¯æœ‰äº›åŠŸèƒ½æ— æ³•é€šè¿‡ Web å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œæ‚¨å¯èƒ½éœ€è¦è®¿é—® Apache Airflow çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ã€‚

ç”±äº Docker ç®¡ç†ä¸€åˆ‡ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Docker Composer è®¿é—®åŒ…å«åœ¨æ‚¨é¢å‰è¿è¡Œçš„ airflow å®ä¾‹çš„ **airflow-worker** å®¹å™¨ã€‚

ä¾‹å¦‚ï¼Œè¦æ˜¾ç¤ºå®ä¾‹çš„ä¸»è¦ä¿¡æ¯:

```
docker-compose run airflow-worker airflow info
```

> æ–‡æ¡£ä¸­åˆ—å‡ºäº†æ‰€æœ‰å¯ç”¨çš„[å‘½ä»¤](https://airflow.apache.org/docs/apache-airflow/stable/cli-and-env-variables-ref.html)ã€‚

![](img/da7f194b5cb1a3710019c2d6ab179ba6.png)

å¯¼æ¸¸ç»“æŸäº†ï¼æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼Œå¸Œæœ›å®ƒçš„å†…å®¹å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ã€‚

ç°åœ¨è½®åˆ°æ‚¨é€šè¿‡æŸ¥é˜…å®˜æ–¹æ–‡æ¡£æˆ–äº’è”ç½‘ä¸Šçš„æ•™ç¨‹æ¥åˆ›å»ºå¼ºå¤§çš„ Dag äº†ğŸ˜‰

[](https://dataforeveryone.medium.com/membership) [## åŠ å…¥æˆ‘çš„æ¨èé“¾æ¥åª’ä½“-æ•°æ® 4 æ¯ä¸ªäººï¼

### ä½œä¸ºä¸€ä¸ªåª’ä½“ä¼šå‘˜ï¼Œä½ çš„ä¼šå‘˜è´¹çš„ä¸€éƒ¨åˆ†ä¼šç»™ä½ é˜…è¯»çš„ä½œå®¶ï¼Œä½ å¯ä»¥å®Œå…¨æ¥è§¦åˆ°æ¯ä¸€ä¸ªæ•…äº‹â€¦

dataforeveryone.medium.com](https://dataforeveryone.medium.com/membership) 

å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶å‘è¡¨è¯„è®ºï¼Œå¦‚æœæ‚¨å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œ[å…³æ³¨æˆ‘](https://dataforeveryone.medium.com/)ï¼Œå½“æˆ‘ä¸‹ä¸€æ¬¡å‘å¸ƒæ—¶ï¼Œæ‚¨ä¼šæ”¶åˆ°é€šçŸ¥ã€‚