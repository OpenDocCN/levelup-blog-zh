<html>
<head>
<title>A Suggestion on Managing Data Changes in Spring Boot Using Flyway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Flyway管理Spring Boot数据变更的建议</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-suggestion-on-managing-data-changes-in-spring-boot-using-flyway-b87cf87f8e88?source=collection_archive---------7-----------------------#2020-08-17">https://levelup.gitconnected.com/a-suggestion-on-managing-data-changes-in-spring-boot-using-flyway-b87cf87f8e88?source=collection_archive---------7-----------------------#2020-08-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/3cb942548e7d28d913e6a0f7a4462002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*tSY4rKFDkqvnlVR2QwPcdw.jpeg"/></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">foter.com上的照片</figcaption></figure><div class=""/><div class=""><h2 id="788c" class="pw-subtitle-paragraph jz jb jc bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">如何使用Flyway的版本化和可重复迁移应用全局模式更改和特定于环境的数据更改？</h2></div><h1 id="0c51" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">介绍</h1><p id="36d4" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">数据库迁移对于应用程序的开发以任何有意义的方式进行和扩展都是必不可少的。</p><p id="b5bb" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">除此之外，迁移保持对数据库的变更<em class="mk">在版本控制中记录</em>，<em class="mk">自动化，有状态</em>，也许最重要的是，<em class="mk">可再现</em>。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><blockquote class="ms mt mu"><p id="4663" class="lj lk mk ll b lm mf kd lo lp mg kg lr mv mh lu lv mw mi ly lz mx mj mc md me ij bi translated">[1]:我不确定stateful是不是这个的通用术语。对我来说，有状态迁移意味着查看任何数据库，您都可以知道数据库处于什么“状态”；也就是说，到目前为止应用了哪些迁移。Flyway通过创建历史表来记录所有尝试的迁移来实现这一点。</p></blockquote><h1 id="fd86" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">问题</h1><figure class="mz na nb nc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi my"><img src="../Images/eda48a1dd95deb64e2d5b27d84280513.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F02k4DUXNqAAWujUO5rD2Q.jpeg"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">Arthur Yeti 在<a class="ae iz" href="https://unsplash.com/s/photos/respect?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="2ca6" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">虽然<em class="mk">模式</em>的变化被开发人员“尊重”到足以进行迁移，但是<em class="mk">数据</em>的变化通常没有那么幸运；数据更改更有可能在个别环境中临时执行。</p><p id="dd52" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">本质上，这种方法的缺点与迁移方法的优点相反；这些数据变更[经常]没有提交到版本控制中，不是自动化部署管道的一部分，无状态，并且难以跟踪和重现。</p><p id="9b40" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">当这种数据变更涉及到通常被称为<em class="mk">主数据</em>的数据时，这些缺点尤其明显；也就是说，应用程序假定、依赖并且可能没有适当的方式来处理它们的缺失的记录。这些数据可能包括用户类型(用户、管理员等)、内容类别或与本地化相关的记录等等。</p><blockquote class="nh"><p id="11eb" class="ni nj jc bd nk nl nm nn no np nq me dk translated">数据更改对最终结果的重要性不亚于应用程序代码或模式的更改，因此应该同等对待。</p></blockquote></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><blockquote class="ms mt mu"><p id="d763" class="lj lk mk ll b lm mf kd lo lp mg kg lr mv mh lu lv mw mi ly lz mx mj mc md me ij bi translated">[2]:从某种意义上说，查看迁移的历史表，无法判断是否应用了某些数据更改。</p></blockquote><h1 id="0523" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">我们能做什么</h1><p id="c6a2" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">一个快速的解决方法是将通过SQL完成的任何数据更改提交到代码库中的一个专用位置，并手动应用它们。</p><p id="9e66" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">虽然这并不完全是有状态的或可自动再现的，但它确实有助于将这样的更改纳入版本控制，并可能使跟踪和再现它们变得更易于管理。</p><p id="b3bc" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">但是我们能做得更好吗？</p><h1 id="c38b" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">这个建议</h1><p id="c1e9" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">一种更干净的方法是将数据更改视为类似于模式更改；一流的数据库迁移。毕竟，数据更改与应用程序代码或模式更改一样对最终结果至关重要，因此应该同等对待。</p><p id="59e1" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在<em class="mk"> Flyway </em>的上下文中，这转化为将数据更改与其他迁移一起放入SQL文件中，无论是<em class="mk">版本化</em>还是<em class="mk">可重复</em>。</p><figure class="mz na nb nc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nr"><img src="../Images/97b787b20f37362e5dc76fc5b7bfa49d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZEUbiwU5y0bsyuE3YC_1Pg.jpeg"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">照片由<a class="ae iz" href="https://unsplash.com/@williamrouse?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">威廉·劳斯</a>在<a class="ae iz" href="https://unsplash.com/s/photos/crash?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><h2 id="ee19" class="ns ks jc bd kt nt nu dn kx nv nw dp lb ls nx ny ld lw nz oa lf ma ob oc lh od bi translated">飞行路线迁移速成班</h2><p id="5457" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在Flyway中，<em class="mk">版本化的</em>迁移是这样的:1-以V开头，2-应用一次，3-应用后不能修改。这种类型是最常见的，通常用于模式迁移。</p><p id="55d4" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">另一方面，<em class="mk">可重复</em>迁移是这样的，1-以R开始，2-可以应用多次，3-在应用后可以修改。这种类型不太为人所知，建议用于创建视图、过程、函数等。</p><p id="6b09" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">可重复迁移的挑战是编写SQL代码。这种迁移中的代码应该可以安全地多次重新运行，而不会产生意外的副作用，如出错或复制记录。</p><h2 id="1e69" class="ns ks jc bd kt nt nu dn kx nv nw dp lb ls nx ny ld lw nz oa lf ma ob oc lh od bi translated">共享数据迁移的选择</h2><p id="d1f3" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">对于跨所有环境的共享数据迁移，选择在很大程度上是实际的和个人的。</p><p id="5357" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">编写<em class="mk">版本化的</em>迁移意味着您的主数据可能会被分割到多个文件中，而模式迁移文件位于它们之间。但是，它确实将您从编写可重复的代码中解放出来。</p><p id="ba7b" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">另一方面，编写<em class="mk">可重复的</em>迁移意味着您的主数据可以全部放在一个文件或多个数据文件中。这也意味着数据更改不会妨碍模式更改，并且与模式更改有很大的区别。然而，它确实需要你编写可重复的代码(这对于insert语句来说是很容易管理的，至少我们将在后面看到对于<em class="mk"> MySQL </em>。</p><h2 id="9370" class="ns ks jc bd kt nt nu dn kx nv nw dp lb ls nx ny ld lw nz oa lf ma ob oc lh od bi translated">特定于环境的数据迁移选择</h2><p id="9fb5" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">对于只应用于特定环境的数据迁移(考虑测试环境的测试数据或开发的虚拟登录凭证)，版本化和可重复迁移之间的权衡同样适用。然而，在这种情况下，版本化迁移还有一个缺点；除了接收版本化迁移的环境之外，其他环境似乎已经“跳过”了一些版本。</p><figure class="mz na nb nc gt is gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/d746ef018f8dc31bce025f00e8d4f351.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*WMGLzuBHFz5hydCjWeYQPA.jpeg"/></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">foter.com<a class="ae iz" href="https://foter.com" rel="noopener ugc nofollow" target="_blank">上的照片</a></figcaption></figure><h2 id="a8ae" class="ns ks jc bd kt nt nu dn kx nv nw dp lb ls nx ny ld lw nz oa lf ma ob oc lh od bi translated">我的建议</h2><p id="4b38" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">如果我还没有放弃的话，我更喜欢对所有数据变更进行<em class="mk">可重复的</em>迁移，以保持它们明显不同，在所有环境中保持模式变更的连续版本控制，并保持共享和特定于环境的数据迁移的一致性。</p><h1 id="3854" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">细节</h1><p id="5bc0" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">关于如何在三种环境中准确地实现这一建议的细节；<em class="mk"> Spring Boot 2.x </em>中的<code class="fe of og oh oi b">dev</code>、<code class="fe of og oh oi b">staging</code>、<code class="fe of og oh oi b">prod</code>可以概括为:</p><p id="0c7f" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">1-创建以下<em class="mk">属性</em>文件:<br/><em class="mk">* application . properties<br/>* application-non-prod . properties<br/>* application-dev . properties<br/>* application-staging . properties<br/>* application-prod . properties</em></p><p id="b379" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">2-在类路径中创建下面的<em class="mk">目录</em>。在Spring Boot，您可能知道，<code class="fe of og oh oi b">/src/main/resources</code>下的任何内容都被添加到类路径中:<br/><em class="mk">* db/migration/shared<br/>* db/migration/non-prod<br/>* db/migration/dev<br/>* db/migration/staging<br/>* db/migration/prod</em></p><p id="fb27" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">3-在每个环境的<em class="mk">属性</em>文件中，覆盖<code class="fe of og oh oi b">spring.flyway.locations</code>属性，该属性接受逗号分隔的位置列表。在Spring Boot，默认位置是<code class="fe of og oh oi b">db/migration</code>。</p><p id="0796" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">我们希望以这样的方式修改迁移位置:<br/> <code class="fe of og oh oi b">dev</code>从<em class="mk">共享</em>、<em class="mk">非生产</em>和<em class="mk">开发</em>目录中读取迁移。<br/> <code class="fe of og oh oi b">staging</code>从<em class="mk">共享</em>、<em class="mk">非生产</em>和<em class="mk">暂存</em>目录中读取迁移。<br/> <code class="fe of og oh oi b">prod</code>仅从<em class="mk">共享</em>和<em class="mk">生产</em>目录中读取迁移。</p><p id="c3ff" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这可以通过如下设置locations属性来实现:</p><p id="b669" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">*在<code class="fe of og oh oi b">application-dev.properties</code>中，设置:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="6906" class="ns ks jc oi b gy on oo l op oq">spring.flyway.locations=classpath:/db/migration/shared,classpath:/db/migration/non-prod,classpath:/db/migration/dev</span></pre><p id="185d" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">*在<code class="fe of og oh oi b">application-staging.properties</code>中，设置:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="40a0" class="ns ks jc oi b gy on oo l op oq">spring.flyway.locations=classpath:/db/migration/shared,classpath:/db/migration/non-prod,classpath:/db/migration/staging</span></pre><p id="7312" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">*在<code class="fe of og oh oi b">application-prod.properties</code>中，设置:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="b824" class="ns ks jc oi b gy on oo l op oq">spring.flyway.locations=classpath:/db/migration/shared,classpath:/db/migration/prod</span></pre><p id="a95d" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">4-对于任何数据库更改，遵循以下约定:<br/> *是模式更改吗？在<em class="mk">共享</em>目录中创建一个<em class="mk">版本化的</em>迁移。<br/> *是主数据变更吗？在<em class="mk">共享</em>目录中创建一个<em class="mk">可重复</em>迁移或更新一个现有的迁移。<br/> *这是一种不应该进入生产环境但在其他环境中却可以的数据更改吗？在<em class="mk">非生产</em>目录中创建一个<em class="mk">可重复</em>迁移或更新一个现有的迁移。<br/> *是特定于<code class="fe of og oh oi b">dev</code>、<code class="fe of og oh oi b">staging</code>还是<code class="fe of og oh oi b">prod</code>环境的数据变更？分别在<em class="mk"> dev </em>、<em class="mk"> staging </em>或<em class="mk"> prod </em>目录中创建一个<em class="mk">可重复</em>迁移或更新一个现有的迁移。</p><figure class="mz na nb nc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi or"><img src="../Images/4f229f2988db291187f6ad6fe734011c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yL9ZNFnbwADWiyWl8mxxtg.jpeg"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">foter.com<a class="ae iz" href="https://foter.com" rel="noopener ugc nofollow" target="_blank">上的照片</a></figcaption></figure><h1 id="8247" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">一个示例实现</h1><p id="ab13" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">为了创建一个最小的应用程序来测试这个设置，我们可以从一个空的Spring Boot项目开始，这个项目至少包含以下依赖项:<code class="fe of og oh oi b">spring-boot-starter-web</code>、<code class="fe of og oh oi b">spring-boot-starter-data-jpa</code>、<code class="fe of og oh oi b">flyway-core</code>和<code class="fe of og oh oi b">mysql-connector-java</code>，并完成以下步骤:</p><p id="cb13" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">1-确保您有一个在默认端口<em class="mk"> 3306 </em>上本地运行的<em class="mk"> MySQL </em>服务器，用户名为<em class="mk"> root </em>，没有密码，或者根据您的个人设置在本教程中更改值。</p><p id="0298" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">1.1-访问<em class="mk"> MySQL </em>服务器:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="e210" class="ns ks jc oi b gy on oo l op oq">mysql -u root</span></pre><p id="a43d" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">1.2-然后使用以下内容创建<code class="fe of og oh oi b">dev</code>、<code class="fe of og oh oi b">staging</code>和<code class="fe of og oh oi b">prod</code>数据库:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="1655" class="ns ks jc oi b gy on oo l op oq">CREATE DATABASE managing_flyway_migrations_dev;<br/>CREATE DATABASE managing_flyway_migrations_staging;<br/>CREATE DATABASE managing_flyway_migrations_prod;</span></pre><p id="a562" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">2-在<code class="fe of og oh oi b">/src/main/resources</code>下创建<em class="mk">属性</em>文件。<br/> 2.1-创建一个名为<code class="fe of og oh oi b">application.properties</code>的文件，内容如下:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="183f" class="ns ks jc oi b gy on oo l op oq">spring.jpa.open-in-view=false</span><span id="bff4" class="ns ks jc oi b gy os oo l op oq"># Change this value to 1.2 for the Third Run or remove all together<br/>spring.flyway.target=1.1</span></pre><p id="65ae" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">2.2-创建一个名为<code class="fe of og oh oi b">application-non-prod.properties</code>的空文件。</p><p id="28c0" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">2.3-创建一个名为<code class="fe of og oh oi b">application-dev.properties</code>的文件，内容如下:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="ca81" class="ns ks jc oi b gy on oo l op oq">spring.profiles.include=non-prod</span><span id="dcb9" class="ns ks jc oi b gy os oo l op oq">server.port=8081</span><span id="99f3" class="ns ks jc oi b gy os oo l op oq">spring.datasource.url=jdbc:mysql://localhost:3306<br/>spring.datasource.username=root<br/>spring.datasource.password=<br/>spring.datasource.name=managing_flyway_migrations_dev</span><span id="06f2" class="ns ks jc oi b gy os oo l op oq">spring.flyway.locations=classpath:/db/migration/shared,classpath:/db/migration/non-prod,classpath:/db/migration/dev<br/>spring.flyway.schemas=${spring.datasource.name}</span></pre><p id="8ac1" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">2.4-创建一个名为<code class="fe of og oh oi b">application-staging.properties</code>的文件，内容如下:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="2fc0" class="ns ks jc oi b gy on oo l op oq">spring.profiles.include=non-prod</span><span id="7679" class="ns ks jc oi b gy os oo l op oq">server.port=8082</span><span id="3b49" class="ns ks jc oi b gy os oo l op oq">spring.datasource.url=jdbc:mysql://localhost:3306<br/>spring.datasource.username=root<br/>spring.datasource.password=<br/>spring.datasource.name=managing_flyway_migrations_staging</span><span id="19f4" class="ns ks jc oi b gy os oo l op oq">spring.flyway.locations=classpath:/db/migration/shared,classpath:/db/migration/non-prod,classpath:/db/migration/staging<br/>spring.flyway.schemas=${spring.datasource.name}</span></pre><p id="4d8b" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">2.5-创建一个名为<code class="fe of og oh oi b">application-prod.properties</code>的文件，内容如下:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="5f3c" class="ns ks jc oi b gy on oo l op oq">server.port=8083</span><span id="2b41" class="ns ks jc oi b gy os oo l op oq">spring.datasource.url=jdbc:mysql://localhost:3306<br/>spring.datasource.username=root<br/>spring.datasource.password=<br/>spring.datasource.name=managing_flyway_migrations_prod</span><span id="82d3" class="ns ks jc oi b gy os oo l op oq">spring.flyway.locations=classpath:/db/migration/shared,classpath:/db/migration/prod<br/>spring.flyway.schemas=${spring.datasource.name}</span></pre><p id="ebe6" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">3-在<code class="fe of og oh oi b">src/main/resources/db/migration</code>下创建迁移文件。<br/> 3.1-在<code class="fe of og oh oi b">shared</code>下，创建一个名为<code class="fe of og oh oi b">V1_1__Initial_Schema.sql</code>的文件，内容如下:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="d812" class="ns ks jc oi b gy on oo l op oq">CREATE TABLE roles (<br/>    id   BIGINT NOT NULL AUTO_INCREMENT,<br/>    name VARCHAR(100),</span><span id="1a56" class="ns ks jc oi b gy os oo l op oq">PRIMARY KEY (id)<br/>);</span><span id="5fba" class="ns ks jc oi b gy os oo l op oq">CREATE TABLE users (<br/>    id   BIGINT NOT NULL AUTO_INCREMENT,<br/>    name VARCHAR(255),<br/>    role_id BIGINT NOT NULL,</span><span id="e954" class="ns ks jc oi b gy os oo l op oq">PRIMARY KEY (id),</span><span id="8a64" class="ns ks jc oi b gy os oo l op oq">FOREIGN KEY (role_id) REFERENCES roles (id)<br/>);</span><span id="1f6a" class="ns ks jc oi b gy os oo l op oq">CREATE TABLE content_categories (<br/>    id BIGINT NOT NULL,<br/>    name VARCHAR(255) NOT NULL,</span><span id="1c55" class="ns ks jc oi b gy os oo l op oq">PRIMARY KEY (id)<br/>);</span><span id="64c6" class="ns ks jc oi b gy os oo l op oq">CREATE TABLE content (<br/>    id BIGINT NOT NULL AUTO_INCREMENT,<br/>    name VARCHAR(255),<br/>    category_id BIGINT NOT NULL,</span><span id="3173" class="ns ks jc oi b gy os oo l op oq">PRIMARY KEY (id),</span><span id="c267" class="ns ks jc oi b gy os oo l op oq">FOREIGN KEY (category_id) REFERENCES content_categories(id)<br/>);</span></pre><p id="63a1" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">3.2-在<code class="fe of og oh oi b">shared</code>下，创建一个名为<code class="fe of og oh oi b">V1_2__Add_content_topic.sql</code>的文件，内容如下:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="72db" class="ns ks jc oi b gy on oo l op oq">CREATE TABLE content_topics (<br/>    id BIGINT NOT NULL,<br/>    name VARCHAR(255) NOT NULL,</span><span id="a451" class="ns ks jc oi b gy os oo l op oq">PRIMARY KEY (id)<br/>);</span><span id="76ae" class="ns ks jc oi b gy os oo l op oq">ALTER TABLE content<br/>    ADD COLUMN topic_id BIGINT,<br/>    ADD CONSTRAINT FOREIGN KEY (topic_id) REFERENCES content_topics(id);</span></pre><p id="94b2" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">3.3-在<code class="fe of og oh oi b">shared</code>下，创建一个名为<code class="fe of og oh oi b">R__1_Master_Data.sql</code>的文件，内容如下:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="b5b6" class="ns ks jc oi b gy on oo l op oq">INSERT INTO<br/>    roles (id, name)<br/>    VALUES (1, 'System'), (2, 'Admin'), (3, 'User')<br/>    ON DUPLICATE KEY UPDATE id=id, name=<em class="mk">VALUES</em>(`name`);</span><span id="f2d0" class="ns ks jc oi b gy os oo l op oq">INSERT INTO<br/>    content_categories (id, name)<br/>    VALUES (1, 'Category 1'), (2, 'Category 2')<br/>    ON DUPLICATE KEY UPDATE id=id, name=<em class="mk">VALUES</em>(`name`);</span><span id="50b4" class="ns ks jc oi b gy os oo l op oq"># INSERT statements for the First Run<br/># Comment out for the Third Run<br/>####################################################################<br/>INSERT INTO<br/>    content (id, name, category_id)<br/>VALUES (1, 'Content 1.1', 1), (2, 'Content 1.2', 1),<br/>       (3, 'Content 2.1', 2), (4, 'Content 2.2', 2)<br/>ON DUPLICATE KEY UPDATE id=id, name=<em class="mk">VALUES</em>(`id`), category_id=<em class="mk">VALUES</em>(`category_id`);<br/>####################################################################</span><span id="e9eb" class="ns ks jc oi b gy os oo l op oq"># INSERT statements for the Third Run<br/># Uncomment for the Third Run<br/>####################################################################<br/># INSERT INTO<br/>#     content_topics (id, name)<br/>#     VALUES (1, 'Topic 1'), (2, 'Topic 2')<br/>#     ON DUPLICATE KEY UPDATE id=id, name=VALUES(`name`);<br/>#<br/># INSERT INTO<br/>#     content (id, name, category_id, topic_id)<br/># VALUES (1, 'Content 1.1', 1, 1), (2, 'Content 1.2', 1, 2),<br/>#        (3, 'Content 2.1', 2, 2), (4, 'Content 2.2', 2, 1)<br/># ON DUPLICATE KEY UPDATE id=id, name=VALUES(`name`), category_id=VALUES(`category_id`), topic_id=VALUES(`topic_id`);<br/>####################################################################</span></pre><p id="ca71" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd">注意</strong>:注意这个迁移是以<code class="fe of og oh oi b">R.</code>开始的，这就是为什么它是一个<em class="mk">可重复的</em>迁移。</p><p id="2a3c" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd">注2 </strong>:注意，迁移名称中的数字既不必要，也不表示特定的版本。我在数据迁移的<em class="mk">描述</em>中使用数字只是为了对它们的执行进行排序。<em class="mk"> Flyway </em>首先根据版本执行<em class="mk">版本化</em>迁移，然后根据<em class="mk">描述</em>按字母顺序执行<em class="mk">可重复</em>迁移。</p><p id="19ef" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">3.4-在<code class="fe of og oh oi b">non-prod</code>下，创建一个名为<code class="fe of og oh oi b">R__2_Non_prod_login.sql</code>的文件，内容如下:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="020a" class="ns ks jc oi b gy on oo l op oq">INSERT INTO<br/>    users (id, name, role_id)<br/>    VALUES (201, 'SuperAdmin', 1)<br/>    ON DUPLICATE KEY UPDATE id=id, name=<em class="mk">VALUES</em>(`name`), role_id=<em class="mk">VALUES</em>(`role_id`);</span></pre><p id="76b1" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">3.5-在<code class="fe of og oh oi b">dev</code>下，创建一个名为<code class="fe of og oh oi b">R__3_Dev_login.sql</code>的文件，内容如下:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="985c" class="ns ks jc oi b gy on oo l op oq">INSERT INTO<br/>    users (id, name, role_id)<br/>    VALUES (301, 'Developer 1', 2), (302, 'Developer 2', 2)<br/>    ON DUPLICATE KEY UPDATE id=id, name=<em class="mk">VALUES</em>(`name`), role_id=<em class="mk">VALUES</em>(`role_id`);</span></pre><p id="bd9c" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">3.6-在<code class="fe of og oh oi b">staging</code>下，创建一个名为<code class="fe of og oh oi b">R__3_Staging_login.sql</code>的文件，内容如下:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="4ade" class="ns ks jc oi b gy on oo l op oq">INSERT INTO<br/>    users (id, name, role_id)<br/>    VALUES (301, 'QA 1', 3), (302, 'QA 2', 3)<br/>    ON DUPLICATE KEY UPDATE id=id, name=<em class="mk">VALUES</em>(`name`), role_id=<em class="mk">VALUES</em>(`role_id`);</span></pre><p id="c97b" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">到目前为止，我们已经拥有了第一次运行所需的所有代码和配置。</p><figure class="mz na nb nc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi ot"><img src="../Images/ce516e5dd11d5c950c3a23b30220bf1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7z8xyn5WzPCa-fSrZ1Ys4A.jpeg"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">照片由<a class="ae iz" href="https://unsplash.com/@intothefab?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">法比奥·康帕雷利</a>在<a class="ae iz" href="https://unsplash.com/s/photos/run?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="dfa3" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">首轮放映</h1><p id="14a6" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在第一次运行中，我们将执行<code class="fe of og oh oi b">1.1</code> <em class="mk">版本化的</em>迁移以及其他<em class="mk">重复的</em>迁移，以模拟具有初始数据库模式和数据的部署。</p><p id="86fe" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在这些测试中区分<em class="mk">运行</em>的两个重要位置是<code class="fe of og oh oi b">application.properties</code>中的<em class="mk">飞行路线</em>目标和<code class="fe of og oh oi b">R__1_Master_Data.sql</code>中的<em class="mk">插入</em>语句。如果你使用附带的<a class="ae iz" href="https://github.com/sayadi/managing-flyway-migrations-spring-boot" rel="noopener ugc nofollow" target="_blank"> <em class="mk"> GitHub </em> </a>库，确保你在<code class="fe of og oh oi b">first-run</code>分支上。</p><h2 id="973f" class="ns ks jc bd kt nt nu dn kx nv nw dp lb ls nx ny ld lw nz oa lf ma ob oc lh od bi translated">测试“开发”概况</h2><p id="1386" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在<code class="fe of og oh oi b">dev</code>配置文件激活的情况下运行应用程序:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="de47" class="ns ks jc oi b gy on oo l op oq">mvn spring-boot:run -Dspring.profiles.active=dev</span></pre><p id="636a" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">到目前为止，我们期待一些事情:<br/> *应用了<em class="mk">版本化的</em>迁移<code class="fe of og oh oi b">V1_1__Initial_Schema.sql</code>。<br/> *未应用<em class="mk">版本化的</em>迁移<code class="fe of og oh oi b">V1_2__Add_content_topic.sql</code>(因为我们将目标设置为<code class="fe of og oh oi b">1.1</code>)。<br/> *共享<em class="mk">重复</em>迁移<code class="fe of og oh oi b">R__1_Master_Data.sql</code>被应用。<br/> *非生产<em class="mk">重复</em>迁移<code class="fe of og oh oi b">R__2_Non_prod_login.sql</code>被应用。<br/>* dev<em class="mk">重复</em>迁移<code class="fe of og oh oi b">R__3_Dev_login.sql</code>被应用。</p><p id="6b54" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">使用开发数据库</em> </strong></p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="caa2" class="ns ks jc oi b gy on oo l op oq">USE  managing_flyway_migrations_dev;</span></pre><p id="67f6" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">查看历史表</em> </strong></p><p id="ad27" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">为了验证这一点，我们检查了Flyway <em class="mk"> </em>通过在我们的数据库服务器中运行以下命令而创建的<code class="fe of og oh oi b">flyway_schema_history</code>:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="35bf" class="ns ks jc oi b gy on oo l op oq">SELECT installed_rank, version, description, success FROM flyway_schema_history;</span></pre><p id="14b3" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">上面的<em class="mk">选择</em>语句的输出应该如下所示:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="9966" class="ns ks jc oi b gy on oo l op oq">+----------------+---------+------------------+---------+<br/>| installed_rank | version | description      | success |<br/>+----------------+---------+------------------+---------+<br/>|              1 | 1.1     | Initial Schema   |       1 |<br/>|              2 | NULL    | 1 Master Data    |       1 |<br/>|              3 | NULL    | 2 Non prod login |       1 |<br/>|              4 | NULL    | 3 Dev login      |       1 |<br/>+----------------+---------+------------------+---------+</span></pre><p id="e972" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">检查内容表</em> </strong></p><p id="965e" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="mk">内容</em>表<em class="mk"> </em>应包含我们插入<em class="mk">主数据</em>中的记录，如下所示:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="9971" class="ns ks jc oi b gy on oo l op oq">SELECT * FROM content;</span></pre><p id="41c8" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这应该会输出:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="2cb0" class="ns ks jc oi b gy on oo l op oq">+----+-------------+-------------+<br/>| id | name        | category_id |<br/>+----+-------------+-------------+<br/>|  1 | Content 1.1 |           1 |<br/>|  2 | Content 1.2 |           1 |<br/>|  3 | Content 2.1 |           2 |<br/>|  4 | Content 2.2 |           2 |<br/>+----+-------------+-------------+</span></pre><p id="d1ae" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">查看用户表</em> </strong></p><p id="63c1" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在<em class="mk">用户</em>表中，我们应该看到来自我们定义的<em class="mk">非生产登录</em>(超级管理员)以及<em class="mk">开发登录</em>迁移的记录。运行命令:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="4276" class="ns ks jc oi b gy on oo l op oq">SELECT * FROM users;</span></pre><p id="b8fc" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这应该会输出:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="c80b" class="ns ks jc oi b gy on oo l op oq">+-----+-------------+---------+<br/>| id  | name        | role_id |<br/>+-----+-------------+---------+<br/>| 201 | SuperAdmin  |       1 |<br/>| 301 | Developer 1 |       2 |<br/>| 302 | Developer 2 |       2 |<br/>+-----+-------------+---------+</span></pre><p id="9da3" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">我将测试<code class="fe of og oh oi b">staging</code>概要文件的工作留给读者，因为它与本节中描述的测试几乎相同。</p><p id="867b" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">现在，让我们继续测试生产！</p><h2 id="e061" class="ns ks jc bd kt nt nu dn kx nv nw dp lb ls nx ny ld lw nz oa lf ma ob oc lh od bi translated">测试“<code class="fe of og oh oi b">prod</code>”配置文件</h2><p id="ca5e" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在<code class="fe of og oh oi b">prod</code>配置文件激活的情况下运行应用程序:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="b16e" class="ns ks jc oi b gy on oo l op oq">mvn spring-boot:run -Dspring.profiles.active=prod</span></pre><p id="4b17" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">到目前为止，我们期望一些事情:<br/> *应用了<em class="mk">版本化的</em>迁移<code class="fe of og oh oi b">V1_1__Initial_Schema.sql</code>。<br/> *未应用<em class="mk">版本化的</em>迁移<code class="fe of og oh oi b">V1_2__Add_content_topic.sql</code>。<br/> *共享<em class="mk">重复</em>迁移<code class="fe of og oh oi b">R__1_Master_Data.sql</code>被应用。</p><p id="6d95" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">使用Prod数据库</em> </strong></p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="ad92" class="ns ks jc oi b gy on oo l op oq">USE  managing_flyway_migrations_prod;</span></pre><p id="751e" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">查看历史表</em> </strong></p><p id="ee2a" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">为了验证这一点，我们检查了Flyway <em class="mk"> </em>通过在我们的数据库服务器中运行以下代码创建的<code class="fe of og oh oi b">flyway_schema_history</code>:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="90c0" class="ns ks jc oi b gy on oo l op oq">SELECT installed_rank, version, description, success FROM flyway_schema_history;</span></pre><p id="3b67" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">上面的<em class="mk"> SELECT </em>语句的输出应该如下所示:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="fcb6" class="ns ks jc oi b gy on oo l op oq">+----------------+---------+----------------+---------+<br/>| installed_rank | version | description    | success |<br/>+----------------+---------+----------------+---------+<br/>|              1 | 1.1     | Initial Schema |       1 |<br/>|              2 | NULL    | 1 Master Data  |       1 |<br/>+----------------+---------+----------------+---------+</span></pre><p id="534a" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">请注意，在生产中，我们没有在非生产、开发或试运行中定义任何测试凭证。</p><p id="204a" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">检查内容表</em> </strong></p><p id="e165" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="mk">内容</em>表<em class="mk"> </em>应包含我们在<em class="mk">主数据</em>中插入的记录，类似于我们在<code class="fe of og oh oi b">dev</code>中看到的:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="c6c2" class="ns ks jc oi b gy on oo l op oq">SELECT * FROM content;</span></pre><p id="7227" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这应该会输出:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="07dc" class="ns ks jc oi b gy on oo l op oq">+----+-------------+-------------+<br/>| id | name        | category_id |<br/>+----+-------------+-------------+<br/>|  1 | Content 1.1 |           1 |<br/>|  2 | Content 1.2 |           1 |<br/>|  3 | Content 2.1 |           2 |<br/>|  4 | Content 2.2 |           2 |<br/>+----+-------------+-------------+</span></pre><p id="2f9f" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">查看用户表</em> </strong></p><p id="d595" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="mk">用户</em>表应该为空:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="3058" class="ns ks jc oi b gy on oo l op oq">SELECT * FROM users;</span></pre><p id="fc12" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这应该会输出:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="68dc" class="ns ks jc oi b gy on oo l op oq">Empty set (0.00 sec)</span></pre><figure class="mz na nb nc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi ou"><img src="../Images/6c99653607ce5e6b942652870782648f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dN_JuXbkNx4UatbJtk3WZw.jpeg"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated"><a class="ae iz" href="https://unsplash.com/@chanderr?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">钱德尔R </a>在<a class="ae iz" href="https://unsplash.com/s/photos/run?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><h1 id="c8cd" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">二轮放映</h1><p id="6a52" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在这次运行中，我们模拟应用程序重启或不包含迁移更改的部署。在这里，我们真正测试的是<em class="mk"> Flyway的</em>行为。</p><h2 id="f674" class="ns ks jc bd kt nt nu dn kx nv nw dp lb ls nx ny ld lw nz oa lf ma ob oc lh od bi translated">测试“开发”概况</h2><p id="33b1" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">停止并重新运行<code class="fe of og oh oi b">dev</code>应用程序:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="107a" class="ns ks jc oi b gy on oo l op oq">mvn spring-boot:run -Dspring.profiles.active=dev</span></pre><h2 id="c860" class="ns ks jc bd kt nt nu dn kx nv nw dp lb ls nx ny ld lw nz oa lf ma ob oc lh od bi translated">测试“T2”的档案</h2><p id="e45d" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">停止并重新运行<code class="fe of og oh oi b">prod</code>应用程序:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="a6ad" class="ns ks jc oi b gy on oo l op oq">mvn spring-boot:run -Dspring.profiles.active=prod</span></pre><h2 id="fa1b" class="ns ks jc bd kt nt nu dn kx nv nw dp lb ls nx ny ld lw nz oa lf ma ob oc lh od bi translated">结果</h2><p id="bbea" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在Spring每次运行时生成的日志流中，查找包含以下内容的行:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="da2e" class="ns ks jc oi b gy on oo l op oq">Schema `managing_flyway_migrations_dev` is up to date. No migration necessary.</span></pre><p id="a2f0" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这告诉我们<em class="mk"> Flyway </em>检测到没有对迁移进行更改，因此它没有采取任何行动。请注意，即使是<em class="mk">可重复的</em>迁移也被<em class="mk"> Flyway </em>重新应用；这是因为文件及其校验和没有改变。</p><p id="e68d" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">重启后，在继续进行<em class="mk">第三次运行</em>之前，随意浏览表中的记录，以验证实际上没有任何变化。</p><figure class="mz na nb nc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi ov"><img src="../Images/79a28cdc75bef94ec3eb1a14129a5e8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*koqifJWAOSE3JbqyccEOhg.jpeg"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated"><a class="ae iz" href="https://unsplash.com/@andrewtanglao?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">安德鲁·唐劳</a>在<a class="ae iz" href="https://unsplash.com/s/photos/run?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="b6fa" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">第三轮</h1><p id="f94d" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">现在，让我们模拟一个对<em class="mk">版本化</em>和<em class="mk">可重复</em>迁移都进行了更改的部署。</p><p id="4f7d" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在<code class="fe of og oh oi b">application.properties</code>文件中，将<code class="fe of og oh oi b">spring.flyway.target</code>属性改为<code class="fe of og oh oi b">1.2</code>或将其全部删除。这将导致<em class="mk"> Flyway </em>应用我们拥有的第二个<em class="mk">版本化的</em>迁移；<code class="fe of og oh oi b">V1_2__Add_content_topic.sql</code>。</p><p id="2c7f" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在<code class="fe of og oh oi b">R__1_Master_Data.sql</code>中，注释掉第一次运行<em class="mk">、</em>的程序块，并取消注释第三次运行<em class="mk">、</em>的程序块。请注意，在实际的应用程序中，您实际上是在修改现有的代码，而不是注释内容。</p><p id="9d22" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">如果您使用的是<em class="mk"> GitHub </em>库，只需<em class="mk">签出</em>分支<code class="fe of og oh oi b">third-run</code>即可。</p><h2 id="3a2c" class="ns ks jc bd kt nt nu dn kx nv nw dp lb ls nx ny ld lw nz oa lf ma ob oc lh od bi translated">测试“开发”概况</h2><p id="013a" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">与前面的步骤类似，停止并重新运行<code class="fe of og oh oi b">dev</code>应用程序:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="9542" class="ns ks jc oi b gy on oo l op oq">mvn spring-boot:run -Dspring.profiles.active=dev</span></pre><p id="3008" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">到目前为止，我们预计会发生很多事情:<br/> *版本化的<em class="mk">迁移<code class="fe of og oh oi b">V1_1__Initial_Schema.sql</code>没有被<strong class="ll jd">重新应用。<br/> *应用了<em class="mk">版本化</em>迁移<code class="fe of og oh oi b">V1_2__Add_content_topic.sql</code>。<br/> *共享<em class="mk">重复</em>迁移<code class="fe of og oh oi b">R__1_Master_Data.sql</code>被重新应用(因为它被更改)。<br/> *非生产<em class="mk">重复</em>迁移<code class="fe of og oh oi b">R__2_Non_prod_login.sql</code>被<strong class="ll jd">未</strong>重新应用(因为它未被更改)。<br/>* dev<em class="mk">重复</em>迁移<code class="fe of og oh oi b">R__3_Dev_login.sql</code>被<strong class="ll jd">未</strong>重新应用。</strong></em></p><p id="ff58" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">使用Dev数据库</em> </strong></p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="6f2c" class="ns ks jc oi b gy on oo l op oq">USE  managing_flyway_migrations_dev;</span></pre><p id="c603" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">查看历史表</em> </strong></p><p id="0e39" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">与前面的测试类似，运行:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="0301" class="ns ks jc oi b gy on oo l op oq">SELECT installed_rank, version, description, success FROM flyway_schema_history;</span></pre><p id="9d37" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">上面的<em class="mk">选择</em>语句的输出应该如下所示:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="e12c" class="ns ks jc oi b gy on oo l op oq">+----------------+---------+-------------------+---------+<br/>| installed_rank | version | description       | success |<br/>+----------------+---------+-------------------+---------+<br/>|              1 | 1.1     | Initial Schema    |       1 |<br/>|              2 | NULL    | 1 Master Data     |       1 |<br/>|              3 | NULL    | 2 Non prod login  |       1 |<br/>|              4 | NULL    | 3 Dev login       |       1 |<br/>|              5 | 1.2     | Add content topic |       1 |<br/>|              6 | NULL    | 1 Master Data     |       1 |<br/>+----------------+---------+-------------------+---------+</span></pre><p id="0626" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">请注意等级为<code class="fe of og oh oi b">5</code>的<code class="fe of og oh oi b">1.2</code> <em class="mk">版本化</em>迁移，以及修改后的<em class="mk">主</em> <em class="mk">数据</em>迁移在<code class="fe of og oh oi b">6</code>的重新应用。</p><p id="7377" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">检查内容表</em> </strong></p><p id="cd0a" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="mk">内容</em>表<em class="mk"> </em>应包含我们在修改后的<em class="mk">主数据中插入的记录，</em>包括新迁移引入的新<em class="mk"> topic_id </em>列:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="36c1" class="ns ks jc oi b gy on oo l op oq">SELECT * FROM content;</span></pre><p id="9eb2" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这应该会输出:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="2af9" class="ns ks jc oi b gy on oo l op oq">+----+-------------+-------------+----------+<br/>| id | name        | category_id | topic_id |<br/>+----+-------------+-------------+----------+<br/>|  1 | Content 1.1 |           1 |        1 |<br/>|  2 | Content 1.2 |           1 |        2 |<br/>|  3 | Content 2.1 |           2 |        2 |<br/>|  4 | Content 2.2 |           2 |        1 |<br/>+----+-------------+-------------+----------+</span></pre><p id="61c6" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">查看用户表</em> </strong></p><p id="35e3" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">自上次运行以来，<em class="mk">用户</em>表不会发生变化:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="1df5" class="ns ks jc oi b gy on oo l op oq">SELECT * FROM users;</span></pre><p id="a747" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这应该会输出:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="67ad" class="ns ks jc oi b gy on oo l op oq">+-----+-------------+---------+<br/>| id  | name        | role_id |<br/>+-----+-------------+---------+<br/>| 201 | SuperAdmin  |       1 |<br/>| 301 | Developer 1 |       2 |<br/>| 302 | Developer 2 |       2 |<br/>+-----+-------------+---------+</span></pre><h2 id="91dd" class="ns ks jc bd kt nt nu dn kx nv nw dp lb ls nx ny ld lw nz oa lf ma ob oc lh od bi translated">测试“<code class="fe of og oh oi b">prod</code>”配置文件</h2><p id="4966" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">同样，停止并重新运行<code class="fe of og oh oi b">prod</code>应用程序:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="2de5" class="ns ks jc oi b gy on oo l op oq">mvn spring-boot:run -Dspring.profiles.active=prod</span></pre><p id="7ee7" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">到目前为止，我们预期如下:<br/> *版本化的<em class="mk">迁移<code class="fe of og oh oi b">V1_1__Initial_Schema.sql</code>未被<strong class="ll jd">重新应用。<br/> *应用了<em class="mk">版本化的</em>迁移<code class="fe of og oh oi b">V1_2__Add_content_topic.sql</code>。<br/> *共享<em class="mk">重复</em>迁移<code class="fe of og oh oi b">R__1_Master_Data.sql</code>被重新申请。</strong></em></p><p id="9bb2" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">使用Prod数据库</em> </strong></p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="6f89" class="ns ks jc oi b gy on oo l op oq">USE  managing_flyway_migrations_prod;</span></pre><p id="11f7" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">查看历史表</em> </strong></p><p id="cda8" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">两个新记录应该显示在<code class="fe of og oh oi b">flyway_schema_history</code>表中:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="e16e" class="ns ks jc oi b gy on oo l op oq">SELECT installed_rank, version, description, success FROM flyway_schema_history;</span></pre><p id="247c" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">上面的<em class="mk">选择</em>语句的输出应该如下所示:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="1084" class="ns ks jc oi b gy on oo l op oq">+----------------+---------+-------------------+---------+<br/>| installed_rank | version | description       | success |<br/>+----------------+---------+-------------------+---------+<br/>|              1 | 1.1     | Initial Schema    |       1 |<br/>|              2 | NULL    | 1 Master Data     |       1 |<br/>|              3 | 1.2     | Add content topic |       1 |<br/>|              4 | NULL    | 1 Master Data     |       1 |<br/>+----------------+---------+-------------------+---------+</span></pre><p id="e9f3" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">检查内容表</em> </strong></p><p id="7249" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">与<code class="fe of og oh oi b">dev</code>类似，<em class="mk">内容</em>记录应该包含新的<code class="fe of og oh oi b">topic_id</code>列:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="0503" class="ns ks jc oi b gy on oo l op oq">SELECT * FROM content;</span></pre><p id="b31d" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这应该会输出:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="6066" class="ns ks jc oi b gy on oo l op oq">+----+-------------+-------------+----------+<br/>| id | name        | category_id | topic_id |<br/>+----+-------------+-------------+----------+<br/>|  1 | Content 1.1 |           1 |        1 |<br/>|  2 | Content 1.2 |           1 |        2 |<br/>|  3 | Content 2.1 |           2 |        2 |<br/>|  4 | Content 2.2 |           2 |        1 |<br/>+----+-------------+-------------+----------+</span></pre><p id="f836" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">查看用户表</em> </strong></p><p id="4ca8" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="mk">用户</em>表应该仍然是空的:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="3158" class="ns ks jc oi b gy on oo l op oq">SELECT * FROM users;</span></pre><p id="cd99" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这应该会输出:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="65f5" class="ns ks jc oi b gy on oo l op oq">Empty set (0.00 sec)</span></pre><figure class="mz na nb nc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi ow"><img src="../Images/66d2404fd34c3ca230ac90fb1ceb6d8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FFlYHkOc0r3pYXimrwD5ag.jpeg"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">照片由<a class="ae iz" href="https://unsplash.com/@awcreativeut?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Aw创意</a>在<a class="ae iz" href="https://unsplash.com/s/photos/finish-line?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="0109" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">干净运行</h1><p id="4bd6" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">最后，让我们在这个阶段模拟应用程序的全新安装。这模拟了在一个新的环境中，在一个空的数据库中，或者在一个新的<em class="mk">本地</em>开发机器上刚刚建立项目时，迁移是如何工作的。</p><p id="9762" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">让我们改变一下这里的<code class="fe of og oh oi b">staging</code>环境。我们将假设我们刚刚用当前代码和一个新数据库设置了<code class="fe of og oh oi b">staging</code>:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="382c" class="ns ks jc oi b gy on oo l op oq">DROP DATABASE managing_flyway_migrations_staging;<br/>CREATE DATABASE managing_flyway_migrations_staging;</span></pre><p id="3774" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">现在运行<code class="fe of og oh oi b">staging</code>应用程序:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="77da" class="ns ks jc oi b gy on oo l op oq">mvn spring-boot:run -Dspring.profiles.active=staging</span></pre><p id="02b6" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">由此，我们期望如下:<br/> *应用了<em class="mk">版本化的</em>迁移<code class="fe of og oh oi b">V1_1__Initial_Schema.sql</code>。<br/> *应用了<em class="mk">版本化的</em>迁移<code class="fe of og oh oi b">V1_2__Add_content_topic.sql</code>。<br/> *应用了<em class="mk">共享</em> <em class="mk">重复</em>迁移<code class="fe of og oh oi b">R__1_Master_Data.sql</code>。<br/> *应用了<em class="mk">非生产</em> <em class="mk">重复</em>迁移<code class="fe of og oh oi b">R__2_Non_prod_login.sql</code>。<br/> *应用了<em class="mk">暂存</em> <em class="mk">重复</em>迁移<code class="fe of og oh oi b">R__3_Staging_login.sql</code>。</p><p id="87aa" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">使用暂存数据库</em> </strong></p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="a28a" class="ns ks jc oi b gy on oo l op oq">USE  managing_flyway_migrations_staging;</span></pre><p id="e2ed" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd">查历史表<em class="mk"/>查历史表</strong></p><p id="e031" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">两个新记录应该显示在<code class="fe of og oh oi b">flyway_schema_history</code>表中:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="3d3e" class="ns ks jc oi b gy on oo l op oq">SELECT installed_rank, version, description, success FROM flyway_schema_history;</span></pre><p id="15a1" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">上面的<em class="mk"> SELECT </em>语句的输出应该如下所示:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="d118" class="ns ks jc oi b gy on oo l op oq">+----------------+---------+-------------------+---------+<br/>| installed_rank | version | description       | success |<br/>+----------------+---------+-------------------+---------+<br/>|              1 | 1.1     | Initial Schema    |       1 |<br/>|              2 | 1.2     | Add content topic |       1 |<br/>|              3 | NULL    | 1 Master Data     |       1 |<br/>|              4 | NULL    | 2 Non prod login  |       1 |<br/>|              5 | NULL    | 3 Staging login   |       1 |<br/>+----------------+---------+-------------------+---------+</span></pre><p id="c47a" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd">注意</strong> <em class="mk"> : </em>注意<em class="mk">主数据</em>迁移应用一次。此外，请注意，这工作得很好，因为<em class="mk">重复的</em>迁移总是在 <strong class="ll jd">应用了所有</strong> <em class="mk">版本化的</em>迁移之后<strong class="ll jd">运行。</strong></p><p id="c330" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">检查内容表</em> </strong></p><p id="91e4" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="mk">内容</em>表应该已经有了所有的修改，包括<code class="fe of og oh oi b">topic_id</code>列:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="d718" class="ns ks jc oi b gy on oo l op oq">SELECT * FROM content;</span></pre><p id="1d83" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这应该会输出:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="ff3d" class="ns ks jc oi b gy on oo l op oq">+----+-------------+-------------+----------+<br/>| id | name        | category_id | topic_id |<br/>+----+-------------+-------------+----------+<br/>|  1 | Content 1.1 |           1 |        1 |<br/>|  2 | Content 1.2 |           1 |        2 |<br/>|  3 | Content 2.1 |           2 |        2 |<br/>|  4 | Content 2.2 |           2 |        1 |<br/>+----+-------------+-------------+----------+</span></pre><p id="2839" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll jd"> <em class="mk">检查用户表</em> </strong></p><p id="b3db" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="mk">用户</em>表应包含来自<em class="mk">非生产登录</em>和<em class="mk">临时登录</em>迁移的记录:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="9edd" class="ns ks jc oi b gy on oo l op oq">SELECT * FROM users;</span></pre><p id="2d11" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这应该会输出:</p><pre class="mz na nb nc gt oj oi ok ol aw om bi"><span id="c41f" class="ns ks jc oi b gy on oo l op oq">+-----+------------+---------+<br/>| id  | name       | role_id |<br/>+-----+------------+---------+<br/>| 201 | SuperAdmin |       1 |<br/>| 301 | QA 1       |       3 |<br/>| 302 | QA 2       |       3 |<br/>+-----+------------+---------+</span></pre><h1 id="52dd" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">代码</h1><p id="1987" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">如果你想轻松地进行测试，我已经在GitHub上准备了相同的设置:<a class="ae iz" href="https://github.com/sayadi/managing-flyway-migrations-spring-boot/branches" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/saya di/managing-fly way-migrations-spring-boot</a>。</p><h1 id="f63c" class="kr ks jc bd kt ku kv kw kx ky kz la lb ki lc kj ld kl le km lf ko lg kp lh li bi translated">最后一句话</h1><p id="37ad" class="pw-post-body-paragraph lj lk jc ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">虽然这种设置有效，但它是我为这篇文章构思的，作为我看到的一个重复问题的解决方案。然而，我们还没有机会在生产应用程序上测试这一点。</p><p id="f9f4" class="pw-post-body-paragraph lj lk jc ll b lm mf kd lo lp mg kg lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">如果你最终在实际设置中使用它，请在下面的评论中让我知道哪些对你有效，哪些无效，以及你可能需要做哪些改变。感谢阅读！</p></div></div>    
</body>
</html>