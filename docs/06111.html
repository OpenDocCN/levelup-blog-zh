<html>
<head>
<title>Change Azure DevOps Variables from Within the Build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从内部版本中更改Azure DevOps变量</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/change-devops-variables-from-within-the-build-fb22b06eab62?source=collection_archive---------0-----------------------#2020-10-27">https://levelup.gitconnected.com/change-devops-variables-from-within-the-build-fb22b06eab62?source=collection_archive---------0-----------------------#2020-10-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3df5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在这篇博客中，我将解释如何从管道内部调整Azure DevOps管道变量。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/69e8d7cc4a6f0f84552c76022a5e1f6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kF89WckMo_4RW7gl"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">昆腾·德格拉夫在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="90d2" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="00f2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在我的<a class="ae ky" href="https://www.koenvanzeijl.nl" rel="noopener ugc nofollow" target="_blank">个人博客</a>上工作时，我发现获取你的feed的Instagram API被改变了。真扫兴！所以我找到了一种方法来获取你的Instagram feed(我下一篇博客的主题)。不幸的是，这要求您使用有效期仅为60天的令牌。您可以在脸书门户网站申请新令牌，但这也有另一个缺点。您需要每60天提交一次，以保持您的订阅源正常工作。这让我很好奇，是否有可能在构建期间自动获取一个新的令牌，以便您的提要保持活动状态。</p><p id="8682" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这种方法的缺点是必须保存从脸书门户返回的令牌，因为必须再次使用它来检索下一个(新的)令牌。毕竟，当前有效的令牌在60天后不能用于生成新令牌。我将通过向我的<a class="ae ky" href="https://azure.microsoft.com/en-us/services/devops/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps </a>管道添加一个变量来实现这一点，我将在每次构建被触发时更新这个变量。</p><p id="70eb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这篇博客中，我将解释如何从管道内部调整Azure DevOps管道变量。为了阐明我的方法，我将使用Instagram示例。</p><h1 id="1d02" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">我们需要什么？</h1><p id="744d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">要关注这个博客，你只需要一个Azure DevOps管道。在这个管道中，我们将使用<a class="ae ky" href="https://github.com/sleeuwen/dotnet-json" rel="noopener ugc nofollow" target="_blank">‘dot net-json’</a>工具来读写JSON。</p><h1 id="690c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">管道变量</h1><p id="2e60" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">您是否已经有了要在管道中更改的变量？那么你可以跳过这一步，进入下一章。</p><p id="3d27" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果没有，可以边调整管道边这样做。按右上方的变量按钮打开变量概述。然后单击添加变量以添加新变量。您将看到以下表单:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/843a62c0c1caf0d216c9a5767d7cd358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pslebi0RxJQWCLM_tleicg.png"/></div></div></figure><p id="6e1f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">记住你的变量的名字，你以后会用到它。</p><h1 id="5a43" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">编辑管道</h1><p id="5d51" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在管道中，我们将使用bash任务。Azure DevOps托管代理将默认安装此任务。你自己有代理吗？那么你可能需要先安装bash。</p><p id="2985" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">以下管道调整将更新令牌变量:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="11b3" class="my la it mu b gy mz na l nb nc">- task: Bash@3<br/>  inputs:<br/>    targetType: 'inline'<br/>    script: |<br/>      dotnet tool update -g dotnet-json</span><span id="2691" class="my la it mu b gy nd na l nb nc">      access_token=$(curl -s "https://graph.instagram.com/refresh_access_token?grant_type=ig_refresh_token&amp;access_token=$(instatoken)" | dotnet json get - access_token)</span><span id="071e" class="my la it mu b gy nd na l nb nc">      pipeline=$(curl -H "Authorization: Bearer $(System.AccessToken)" "$(System.TeamFoundationCollectionUri)/$(System.TeamProject)/_apis/build/definitions/$(System.DefinitionId)?api-version=5.0" | dotnet json set - variables:instatoken:value $access_token)</span><span id="d8bd" class="my la it mu b gy nd na l nb nc">      curl -X PUT -H "Authorization: Bearer $(System.AccessToken)" -H "Content-Type: application/json" --data "$pipeline" "$(System.TeamFoundationCollectionUri)/$(System.TeamProject)/_apis/build/definitions/$(System.DefinitionId)?api-version=5.0"</span><span id="b85a" class="my la it mu b gy nd na l nb nc">      sed -i "s/placeholder_token/$access_token/" '$(Build.SourcesDirectory)/nuxt.config.js'</span></pre><h1 id="f3be" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">解释</h1><p id="eda8" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">但是它到底是做什么的呢？下面我解释每一步。</p><p id="03a9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">设置</strong></p><p id="3f94" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">前4行表示需要运行一个bash脚本，管道<code class="fe ne nf ng mu b">|</code>后面的代码表示需要运行哪个脚本。</p><p id="7d2f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">安装dotnet-json </strong></p><p id="6916" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng mu b">dotnet tool update -g dotnet-json</code>:确保安装了最新版本的dotnet-json。这是读取和更新JSON对象所需要的。</p><p id="9fbc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">获取变量</strong></p><p id="9f13" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">下一行用于从Instagram API获取新的令牌。</p><p id="0dc8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">向Instagram API发出curl请求的命令如下所示，<code class="fe ne nf ng mu b">curl -s “https://graph.instagram.com/refresh_access_token?grant_type=ig_refresh_token&amp;access_token=$(instatoken)</code> <br/>旧的管道变量<code class="fe ne nf ng mu b">$(instatoken)</code>用于获取新的令牌。</p><p id="ef06" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">从API收到结果后，我使用<code class="fe ne nf ng mu b">dotnet json get</code>从这个结果中提取我的令牌。通过在get之后放置一个<code class="fe ne nf ng mu b">-</code>，默认输入被用作dotnet-json的输入。curl请求后的<code class="fe ne nf ng mu b">|</code>确保API结果被视为默认输入。最后，您需要指出想要获得JSON结果的哪个值，在我的例子中是<code class="fe ne nf ng mu b">access_token</code>。</p><p id="cff8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了使代码更容易阅读，我将把<code class="fe ne nf ng mu b">access_token</code>的值存储在一个bash变量中。这可以很容易地通过将curl请求和结果解析放在<code class="fe ne nf ng mu b">$(...)</code>中并将其分配给变量<code class="fe ne nf ng mu b">access_token</code>来完成。</p><h2 id="f8f9" class="my la it bd lb nh ni dn lf nj nk dp lj ma nl nm ll me nn no ln mi np nq lp nr bi translated">获取当前管道</h2><p id="4dd2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">当前的管道可以很容易地通过URL检索，其中管道的令牌(<code class="fe ne nf ng mu b">$ (System.AccessToken)</code>，这是一个默认的DevOps变量)用于授权。以下字符串中的所有其他令牌也是每个Azure DevOps管道中的默认令牌，因此您可以将其复制并粘贴到您的管道中。<code class="fe ne nf ng mu b">curl -H “Authorization: Bearer $(System.AccessToken)” “$(System.TeamFoundationCollectionUri)/$(System.TeamProject)/_apis/build/definitions/$(System.DefinitionId)?api-version=5.0”</code>。</p><p id="9abc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">收到来自API的结果后，我通过用新令牌替换当前变量来调整这个管道。这又是在dotnet-json的帮助下完成的。为此，我使用了下面的字符串:<code class="fe ne nf ng mu b">dotnet json set -variables:instatoken:value $access_token</code>。在我的例子中,<code class="fe ne nf ng mu b">instatoken</code>是所选变量的名称。我将再次使用bash变量保存我的新管道。</p><h2 id="4eee" class="my la it bd lb nh ni dn lf nj nk dp lj ma nl nm ll me nn no ln mi np nq lp nr bi translated">更新管道</h2><p id="ecb3" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在我们只需要更新Azure DevOps中存储的管道。这次我们需要做一个curl PUT请求，将它发送回Azure DevOps。<code class="fe ne nf ng mu b">curl -X PUT -H “Authorization: Bearer $(System.AccessToken)” -H “Content-Type: application/json” --data “$pipeline” “$(System.TeamFoundationCollectionUri)/$(System.TeamProject)/_apis/build/definitions/$(System.DefinitionId)?api-version=5.0”</code>。</p><p id="c365" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">变量<code class="fe ne nf ng mu b">$(System.AccessToken)</code>作为头部提供，以授权请求。第二个头<code class="fe ne nf ng mu b">Content-Type: application/json</code>表示JSON将作为数据类型发送。<code class="fe ne nf ng mu b">$pipeline</code>变量被提供给<code class="fe ne nf ng mu b">--data</code>参数来发送新的管道JSON。最后，URL用于定义将PUT请求发送到哪里。</p><h2 id="cffc" class="my la it bd lb nh ni dn lf nj nk dp lj ma nl nm ll me nn no ln mi np nq lp nr bi translated">使用您的变量</h2><p id="e16d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在我的脚本的最后一行，我通过用令牌修改文件来利用新获得的令牌，以便它可以在管道的发布步骤中使用。当然，这不是每个人的目标，所以用您的管道需要的脚本替换那一行。</p><h1 id="e251" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="cba8" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">所以绝对有可能从管道本身内部调整你的管道。如果你试图自己调整管道，并且遇到了问题，请让我知道，也许我可以帮你解决。</p><p id="cfe3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">换管道成功了吗？超级酷，在评论里让我知道你用它做什么。</p></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/095d3d82a769bfc84cc3b54b1e73c6d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hVfgU40RCMeP9Wq-HfSUlg@2x.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://ko-fi.com/koenvanzeijl" rel="noopener ugc nofollow" target="_blank">https://ko-fi.com/koenvanzeijl</a></figcaption></figure><p id="08f2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><em class="oa">原贴于</em><a class="ae ky" href="https://www.koenvanzeijl.nl/blog/devops-variables" rel="noopener ugc nofollow" target="_blank"><em class="oa">www . koenvanzeijl . nl</em></a><em class="oa">。</em></p></div></div>    
</body>
</html>