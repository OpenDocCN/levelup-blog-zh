<html>
<head>
<title>How to create Hans Rosling’s famous animated bubble chart in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在R中创建汉斯·罗斯林著名的动画泡泡图</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-create-hans-roslings-famous-animated-bubble-chart-in-r-e89607dbf73a?source=collection_archive---------4-----------------------#2022-08-31">https://levelup.gitconnected.com/how-to-create-hans-roslings-famous-animated-bubble-chart-in-r-e89607dbf73a?source=collection_archive---------4-----------------------#2022-08-31</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><div class=""/><div class=""><h2 id="a3f1" class="pw-subtitle-paragraph js iu iv bd b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj dk translated">一个很棒的小学习练习，展示了R语言的范围和灵活性</h2></div><p id="5652" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">在我学习编程的早期，我决定尝试从零开始在r . com上创建汉斯·罗斯林的Gapminder气泡图——因他极具娱乐性的讲座和TED演讲而闻名。</p><p id="d774" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">当我继续下去的时候，我心中有几个标准:</p><ol class=""><li id="9d8c" class="lg lh iv km b kn ko kq kr kt li kx lj lb lk lf ll lm ln lo bi translated">我是否可以直接使用世界银行的经济数据，而不需要使用可能不是最新的本地数据文件或打包数据？</li><li id="06dd" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">我能让它看起来更接近罗斯林的图表吗？</li><li id="b21d" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">在R中用一个管道命令就能做到吗？</li></ol><p id="90f4" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">我能够满足我所有的标准，这样做之后，我意识到这对那些希望更多地从事动画图形工作的人来说是一个很好的学习练习，也让我意识到R中的<code class="fe lu lv lw lx b">wbstats</code>包，这是我以前从来不知道的。所以我在这里分享一下。</p><p id="d266" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">如果你懒得看这个，可以直接去<a class="ae ly" href="https://github.com/keithmcnulty/hans_rosling_bubble/blob/master/rosling.R" rel="noopener ugc nofollow" target="_blank"> Github </a>上看代码。</p><p id="57d3" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">作为预防措施，这不是做这件事的捷径。您可以用更少的字符来完成这项工作，但这将意味着没有命名空间功能(为了代码读者的利益，我总是试图这样做)，或者从中间源提取数据。但我认为这是一个很好的、独立的、面向未来的方法，既干净又高效。</p><h2 id="43e0" class="lz ma iv bd mb mc md dn me mf mg dp mh kt mi mj mk kx ml mm mn lb mo mp mq mr bi translated">设置和获取数据</h2><p id="969f" class="pw-post-body-paragraph kk kl iv km b kn ms jw kp kq mt jz ks kt mu kv kw kx mv kz la lb mw ld le lf io bi translated">为此，您需要以下R包:<code class="fe lu lv lw lx b">dplyr</code>、<code class="fe lu lv lw lx b">ggplot2</code>、<code class="fe lu lv lw lx b">gganimate</code>、<code class="fe lu lv lw lx b">viridis</code>来帮助着色，以及<code class="fe lu lv lw lx b">wbstats</code>来从世界银行获取数据。如果你想让它看起来和我的一模一样，你可能还需要安装谷歌字体的<code class="fe lu lv lw lx b">Oswald</code>字体系列，但这并不重要。</p><p id="ab63" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">对你想要的最终产品有一个计划总是好的，尤其是在使用<code class="fe lu lv lw lx b">ggplot2</code>的时候。这是我的计划:</p><ol class=""><li id="31f8" class="lg lh iv km b kn ko kq kr kt li kx lj lb lk lf ll lm ln lo bi translated">x轴:对数人均GDP(使用对数有助于传播渐进数据)</li><li id="b37b" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">y轴:出生时的预期寿命</li><li id="6f97" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">气泡大小与人口成比例</li><li id="f648" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">按照世界银行区域，按经济区域进行气泡颜色编码</li><li id="63c2" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">从1960年开始逐年过渡到最新可用数据(写这篇文章时是2020年)。</li></ol><p id="9e97" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">这意味着我需要从世界银行获得三种类型的数据:人均GDP、出生时预期寿命和人口。</p><p id="9efb" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated"><code class="fe lu lv lw lx b">wbstats</code>包是一个非常棒的实用程序，它允许您使用它的API直接插入世界银行的数据库，并将数据直接下载到您的R会话中。你可以访问世界银行开放数据网站<a class="ae ly" href="https://data.worldbank.org/" rel="noopener ugc nofollow" target="_blank">这里</a>浏览你想要的指标。一旦找到一个，你只需要记下它的指示器ID代码。例如，如果您搜索“人均GDP(当前美元)”，您将被带到<a class="ae ly" href="https://data.worldbank.org/indicator/NY.GDP.PCAP.CD" rel="noopener ugc nofollow" target="_blank">此页面</a> —然后单击“详细信息”图标，您将看到ID。在本例中是NY.GDP.PCAP.CD。</p><p id="8243" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">使用这些指标ID代码，您可以使用<code class="fe lu lv lw lx b">wbstats</code>包，使用我们的第一个命令立即获取您需要的三个指标的数据:</p><pre class="mx my mz na gt nb lx nc nd aw ne bi"><span id="31eb" class="lz ma iv lx b gy nf ng l nh ni">rosling &lt;-<br/># pull the country data down from the World Bank - three indicators<br/>wbstats::wb_data(<br/>  indicator = c("SP.DYN.LE00.IN", "NY.GDP.PCAP.CD", "SP.POP.TOTL"), <br/>  country = "countries_only", <br/>  start_date = 1960, <br/>  end_date = 2020<br/>)</span></pre><p id="85cc" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated"><code class="fe lu lv lw lx b">country = "countries_only"</code>的论点很重要——世界银行的数据也包括地区和世界范围的平均值，这是你在分析中不想要的。</p><p id="6161" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">这几乎是我们所需要的全部数据。但是对于我们的颜色编码，我们需要将我们的国家分配到世界银行区域。<code class="fe lu lv lw lx b">wbstats</code>有一个方便的功能叫做<code class="fe lu lv lw lx b">wb_countries()</code>，在这里你可以选择iso3c国家代码及其地区，并加入到前面的表格中，将国家分配到地区，如下所示:</p><pre class="mx my mz na gt nb lx nc nd aw ne bi"><span id="08aa" class="lz ma iv lx b gy nf ng l nh ni">rosling &lt;-<br/># pull the country data down from the World Bank - three indicators<br/>wbstats::wb_data(<br/>  indicator = c("SP.DYN.LE00.IN", "NY.GDP.PCAP.CD", "SP.POP.TOTL"), <br/>  country = "countries_only", <br/>  start_date = 1960, <br/>  end_date = 2020<br/>) |&gt; <br/>  # pull down mapping of countries to regions and join   <br/>  dplyr::left_join(<br/>    wbstats::wb_countries()  |&gt;  <br/>      dplyr::select(iso3c, region)<br/>  )</span></pre><p id="5074" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">这将为您提供如下所示的数据帧:</p><figure class="mx my mz na gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi nj"><img src="../Images/09aa718d1f43929d5c06054b1d56b38e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SIIXCyYRRVVFFcq88PKqXg.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">作者生成的图像</figcaption></figure><h2 id="213a" class="lz ma iv bd mb mc md dn me mf mg dp mh kt mi mj mk kx ml mm mn lb mo mp mq mr bi translated">创建一年的静态图表</h2><p id="8f11" class="pw-post-body-paragraph kk kl iv km b kn ms jw kp kq mt jz ks kt mu kv kw kx mv kz la lb mw ld le lf io bi translated">由于动画是静态图表之间的简单移动，我们的大部分图形工作将是使用<code class="fe lu lv lw lx b">ggplot2</code>创建一年的静态样式的图表。</p><p id="6b49" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">在<code class="fe lu lv lw lx b">ggplot2</code>中绘图非常直观:以下是我想做的事情:</p><ol class=""><li id="4d09" class="lg lh iv km b kn ko kq kr kt li kx lj lb lk lf ll lm ln lo bi translated">定义我的审美:x是对数人均GDP，y是预期寿命，大小是人口，颜色是使用<code class="fe lu lv lw lx b">ggplot()</code>的地区</li><li id="0c11" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">使用<code class="fe lu lv lw lx b">geom_point()</code>将它设置为一个阿尔法值为0.5的散射，以确保气泡的半透明性</li><li id="c72d" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">使用<code class="fe lu lv lw lx b">scale_size()</code>缩放气泡大小，以确保它们对于图表的外观和感觉是合理的</li><li id="fb0e" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">使用<code class="fe lu lv lw lx b">scale_x_continuous()</code>和<code class="fe lu lv lw lx b">scale_y_continuous()</code>设置轴的边界</li><li id="53a3" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">使用<code class="fe lu lv lw lx b">viridis::scale_color_viridis()</code>设置漂亮的泡泡配色方案</li><li id="8842" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">使用<code class="fe lu lv lw lx b">labs()</code>设置轴标签</li><li id="54cd" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">使用<code class="fe lu lv lw lx b">theme_classic()</code>给图表一个漂亮干净的主题</li><li id="f190" class="lg lh iv km b kn lp kq lq kt lr kx ls lb lt lf ll lm ln lo bi translated">最后，按照罗斯林的原图，我们希望日期以浅灰色显示在背景中央，以免过多干扰视觉效果——你可以用<code class="fe lu lv lw lx b">geom_text()</code>来设置</li></ol><p id="f6dd" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">下面是实现这一切的代码—您只需将数据输入该代码，即可创建图表的静态版本:</p><pre class="mx my mz na gt nb lx nc nd aw ne bi"><span id="4ba4" class="lz ma iv lx b gy nf ng l nh ni"># plot the data (pipe in previous code using |&gt;)<br/>ggplot2::ggplot(<br/>  aes(x = log(NY.GDP.PCAP.CD), <br/>      y = SP.DYN.LE00.IN,                      <br/>      size = SP.POP.TOTL)<br/>) +  <br/>ggplot2::geom_point(alpha = 0.5, aes(color = region)) +  ggplot2::scale_size(range = c(.1, 16), guide = "none") +  ggplot2::scale_x_continuous(limits = c(2.5, 12.5)) +  ggplot2::scale_y_continuous(limits = c(30, 90)) +  viridis::scale_color_viridis(<br/>  discrete = TRUE, <br/>  name = "Region", <br/>  option = "viridis"<br/>) +  <br/>ggplot2::labs(<br/>  x = "Log GDP per capita",                <br/>  y = "Life expectancy at birth"<br/>) +  <br/>ggplot2::theme_classic() +  <br/>ggplot2::geom_text(<br/>  aes(x = 7.5, y = 60, label = date), <br/>  size = 14, <br/>  color = 'lightgrey', <br/>  family = 'Oswald'<br/>)</span></pre><h2 id="4242" class="lz ma iv bd mb mc md dn me mf mg dp mh kt mi mj mk kx ml mm mn lb mo mp mq mr bi translated">制作图表动画</h2><p id="35ee" class="pw-post-body-paragraph kk kl iv km b kn ms jw kp kq mt jz ks kt mu kv kw kx mv kz la lb mw ld le lf io bi translated">现在是工作的最后也是最简单的部分。现在你已经设置好了静态动画，你只需要使用包<code class="fe lu lv lw lx b">gganimate</code>来制作动画。所有<code class="fe lu lv lw lx b">gganimate</code>需要知道的是转换变量是什么(在这个例子中是日期列)，以及一些关于转换的时间和样式的细节。您可以通过在上面的代码中添加这个简单的动画命令来实现这一点:</p><pre class="mx my mz na gt nb lx nc nd aw ne bi"><span id="22fc" class="lz ma iv lx b gy nf ng l nh ni"># animate it over years (add to all previous code using +) <br/>gganimate::transition_states(<br/>  date, <br/>  transition_length = 1, <br/>  state_length = 1<br/>) +  <br/>gganimate::ease_aes('cubic-in-out')</span></pre><p id="6f1d" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">瞧，如果你已经有效地组合了你的代码，你可以通过在控制台中键入<code class="fe lu lv lw lx b">rosling</code>来看到成品(这里为了更好的效果，我去掉了颜色图例——你可以通过在上面的<code class="fe lu lv lw lx b">scale_color_viridis()</code>命令中添加参数<code class="fe lu lv lw lx b">guide = "none"</code>来做到这一点):</p><figure class="mx my mz na gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi nv"><img src="../Images/5bf299af4a339403ca3a6277db336e7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*zpS1Z1yoTnnn33_vjrEEYg.gif"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">作者生成</figcaption></figure><p id="1f7c" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">您可以将您的<code class="fe lu lv lw lx b">rosling</code>动画对象保存为gif文件，并使用<code class="fe lu lv lw lx b">anim_save()</code>设置一些参数，例如:</p><pre class="mx my mz na gt nb lx nc nd aw ne bi"><span id="2e23" class="lz ma iv lx b gy nf ng l nh ni"># save animation as a gif<br/>anim_save(<br/>  "rosling_noguide.gif", <br/>  rosling, <br/>  nframes = 125, <br/>  height = 600, <br/>  width = 1000<br/>)</span></pre><p id="720d" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">还有各种其他渲染选项，包括视频渲染，假设您的系统上安装了FFMPEG之类的渲染，您可以随意使用。</p></div><div class="ab cl nw nx hz ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="io ip iq ir is"><p id="0449" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">你可以在Github <a class="ae ly" href="https://github.com/keithmcnulty/hans_rosling_bubble/blob/master/rosling.R" rel="noopener ugc nofollow" target="_blank">这里</a>找到完整的代码(在介质上很难保持代码格式良好)。请随意抓取代码并添加其他功能，如命名感兴趣的国家，如果你有什么有趣的东西，请在评论中添加链接。</p></div></div>    
</body>
</html>