<html>
<head>
<title>Spring Boot Event-Driven Programming with AWS EventBridge</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS EventBridge的Spring Boot事件驱动编程</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/spring-boot-event-driven-programming-with-aws-eventbridge-aa0d8d65f8a8?source=collection_archive---------2-----------------------#2022-02-02">https://levelup.gitconnected.com/spring-boot-event-driven-programming-with-aws-eventbridge-aa0d8d65f8a8?source=collection_archive---------2-----------------------#2022-02-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f0cf40e3cede4a07862f6d89a298c22f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4flB2V6rkOgRx61VI_wBVw.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">图片由<a class="ae kf" href="https://pixabay.com/users/12019-12019/" rel="noopener ugc nofollow" target="_blank"> 12019 </a>来自<a class="ae kf" href="https://pixabay.com/photos/brooklyn-bridge-river-illuminated-1791001/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></figcaption></figure><p id="0c27" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">AWS EventBridge是一种无服务器事件总线，使用从您的应用程序、集成的软件即服务(SaaS)应用程序和AWS服务生成的事件，可以更轻松地构建大规模事件驱动的应用程序。EventBridge使用预定义的事件模式，并允许您设置路由规则来确定将数据发送到何处，以构建应用程序架构，该架构通过完全分离的事件发布者和使用者对数据源做出实时反应。</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi le"><img src="../Images/a01eb1f59760aad0bd099736b6482177.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-a9g-Lza3bsjCi892reNTg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">图片来源:<a class="ae kf" href="https://aws.amazon.com/eventbridge/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/eventbridge/</a></figcaption></figure><p id="55ef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">EventBridge的一些主要优势包括:</p><ul class=""><li id="a373" class="lj lk it ki b kj kk kn ko kr ll kv lm kz ln ld lo lp lq lr bi translated">处理AWS事件、授权SaaS合作伙伴事件或自定义事件</li><li id="24da" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld lo lp lq lr bi translated">跨帐户或跨应用程序集成</li><li id="90a6" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld lo lp lq lr bi translated">邮件过滤</li><li id="5284" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld lo lp lq lr bi translated">消息转换</li><li id="3b14" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld lo lp lq lr bi translated">内置分布式可用性和容错</li><li id="54d9" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld lo lp lq lr bi translated">事件存档和重放</li><li id="f2f5" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld lo lp lq lr bi translated">大量的目标AWS服务(尽管您仍然可以通过API网关路由或Lambda函数调用向外部服务发送事件)</li><li id="a3c2" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld lo lp lq lr bi translated">用于检查事件结构的模式注册表</li><li id="4689" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld lo lp lq lr bi translated">基于模式定义自动生成代码的代码绑定，加速开发！</li><li id="9b22" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld lo lp lq lr bi translated">具有内置的IAM支持，可以跨客户工作。轻松实现帐户对帐户的事件共享。</li></ul><p id="3be1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我们将探讨在两个Spring Boot微服务之间使用AWS EventBridge进行发布/订阅所需的步骤。</p><h1 id="886e" class="lx ly it bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">高层架构</h1><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mv"><img src="../Images/19172296a63acb92dea4b5126e90ccce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iia6JhMAeneejrvIsQ5NhQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">作者图表</figcaption></figure><p id="1cb1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">事件发布者是Customer-Service，它将CustomerCreatedEvent发布到EventBridge。我们在订户端定义了两个目标，一个API网关指向使用CustomerCreatedEvent的Order-Service，另一个目标是一个Lambda函数，用于打印事件的详细信息，这仅仅是为了演示我们可以在订户端定义多个目标。</p><h1 id="04f4" class="lx ly it bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">步骤1:发布者端的实现</h1><p id="f2ab" class="pw-post-body-paragraph kg kh it ki b kj mw kl km kn mx kp kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">首先，在pom中添加以下依赖项:</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="c428" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在发布者端，我们需要实现下面的代码片段来调用AmazonEventBridgeClient将事件放到EventBridge的事件总线上。</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="57cc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">提供AWS凭证</strong></p><p id="1490" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">默认情况下，AWS SDK将尝试从以下位置查找AWS凭据:</p><ol class=""><li id="f0d8" class="lj lk it ki b kj kk kn ko kr ll kv lm kz ln ld nd lp lq lr bi translated">Java系统属性:<code class="fe ne nf ng nh b">aws.accessKeyId</code>和<code class="fe ne nf ng nh b">aws.secretAccessKey</code>。</li><li id="7bd1" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld nd lp lq lr bi translated">环境变量:<code class="fe ne nf ng nh b">AWS_ACCESS_KEY_ID</code>和<code class="fe ne nf ng nh b">AWS_SECRET_ACCESS_KEY</code>。</li><li id="2f9b" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld nd lp lq lr bi translated">默认的凭证配置文件:<code class="fe ne nf ng nh b">~/.aws/credentials</code>。</li><li id="1f64" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld nd lp lq lr bi translated">Amazon ECS容器凭证，如果设置了环境变量<code class="fe ne nf ng nh b">AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</code>，则从Amazon ECS加载。</li><li id="ea27" class="lj lk it ki b kj ls kn lt kr lu kv lv kz lw ld nd lp lq lr bi translated">实例配置文件凭证，在Amazon EC2实例上使用，通过Amazon EC2元数据服务交付。</li></ol><p id="fc3d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">出于简化演示的目的，让我们通过<code class="fe ne nf ng nh b">application.yml, </code>指定凭证，这也是自动识别的:</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h1 id="48f4" class="lx ly it bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">步骤2:在订户端实现</h1><p id="6210" class="pw-post-body-paragraph kg kh it ki b kj mw kl km kn mx kp kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">2020年7月，AWS宣布在Amazon EventBridge中支持Amazon API Gateway作为事件目标。这个特性为web应用程序和服务提供了新的集成场景。在本例中，我们将通过API Gateway公开我们的订户端点，而API Gateway又由EventBridge作为事件目标触发。</p><p id="0747" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了使订阅者应用程序能够监听事件总线，我们首先在pom中添加以下依赖项，就像我们对发布者应用程序所做的那样:</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="d868" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们创建一个事件类，根据EventBridge AWS事件模式定义属性(我希望这个类属于<code class="fe ne nf ng nh b">aws-java-sdk-eventbridge</code>依赖项，但是没有)。这个事件类充当订户端点的输入，它的<code class="fe ne nf ng nh b">detail </code>属性保存从事件总线传递过来的实际事件的有效负载。</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="24b6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有了事件类，我们现在可以在客户端的<code class="fe ne nf ng nh b">SubscriberController</code>中实现我们的逻辑，公开端点<code class="fe ne nf ng nh b">consumeCustomerCreatedEvent</code>:</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h1 id="b754" class="lx ly it bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">第三步。目标的API网关配置</h1><p id="b1e7" class="pw-post-body-paragraph kg kh it ki b kj mw kl km kn mx kp kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">现在让我们通过API Gateway公开我们的订阅者应用程序。一旦在AWS中部署了订阅者应用程序，比如EC2，定义其部署阶段，通过API网关公开其端点。</p><h1 id="fead" class="lx ly it bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">步骤4: EventBridge配置</h1><p id="664f" class="pw-post-body-paragraph kg kh it ki b kj mw kl km kn mx kp kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">现在让我们把这些点串起来。</p><ul class=""><li id="84a3" class="lj lk it ki b kj kk kn ko kr ll kv lm kz ln ld lo lp lq lr bi translated"><strong class="ki iu">创建自定义事件总线</strong></li></ul><p id="90d6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">访问AWS服务下的“Event bridge”→单击左侧导航菜单“Event bus”→单击“Create event bus”按钮创建事件总线，在本例中为“test-event-bus”。<strong class="ki iu">确保该事件总线名称必须与步骤1中发布者应用程序上定义的名称相匹配。</strong></p><ul class=""><li id="6368" class="lj lk it ki b kj kk kn ko kr ll kv lm kz ln ld lo lp lq lr bi translated"><strong class="ki iu">创建自定义规则</strong></li></ul><p id="94e0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">访问AWS服务下的“event bridge”→单击左侧导航菜单“Rules”→在下拉菜单中选择自定义事件总线，然后单击“Create rule”按钮创建新规则。</p><p id="9d95" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在“定义模式”部分，需要确保为发布者应用程序定义一个自定义模式，以便正确过滤要消费的事件。<strong class="ki iu">注意“source”和“detail-type”需要与步骤1中发布者代码中定义的内容完全匹配，否则，事件将不会被传递到目标。</strong>事件模式部分也是定义事件过滤规则的地方，比如说，如果我们只想处理姓“Smith”的事件，我们可以将<code class="fe ne nf ng nh b">"detail":["lastName": "Smith"</code>添加到事件模式中。</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ni"><img src="../Images/da3a261259bf5a9c63eec5e77a2e12d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*glcUDvAbzANtOBGE9HgvbQ.png"/></div></div></figure><p id="73f7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在“选择目标”下，确保为指向我们的订户应用程序的API网关添加一个目标，指定其部署阶段、集成目标，请参见下面的示例:</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nj"><img src="../Images/cf0dfe248be6411c05001c06362a5c9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q41YKkiVyQUWSuYV0ITc-g.png"/></div></div></figure><p id="4ce6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">每条规则限制5个目标。</strong>附加目标如Lambda函数可以添加到此规则中。这个例子定义了两个目标，一个API Gateway，另一个Lambda只是打印事件细节，两个目标都按预期工作。</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/f5d4bffeca2de96172a825518a1dcb0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hTwIMUFXQkDbiTxzu_CNsg.png"/></div></div></figure><p id="b5d8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这两个使用EventBridge的微服务的源代码可以在我的GitHub资源库下找到:<a class="ae kf" href="https://github.com/wenqiglantz/spring-boot-aws-eventbridge" rel="noopener ugc nofollow" target="_blank">https://github.com/wenqiglantz/spring-boot-aws-eventbridge</a>。</p><p id="a457" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">编码快乐！手工制作快乐！</p></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><p id="bcc3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">参考文献:</strong></p><p id="02f7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://aws.amazon.com/eventbridge/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/eventbridge/</a></p><p id="da98" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://aws.amazon.com/event-driven-architecture/" rel="noopener ugc nofollow" target="_blank">事件驱动架构(Amazon.com)</a></p><p id="1b69" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://lumigo.io/blog/choosing-the-right-event-routing-on-aws-eventbridge-sns-or-sqs/" rel="noopener ugc nofollow" target="_blank">为无服务器选择合适的事件路由服务:EventBridge、SNS或SQS-lumi go</a></p><p id="158a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://micronaut-projects.github.io/micronaut-aws/latest/guide/" rel="noopener ugc nofollow" target="_blank">https://micro naut-projects . github . io/micro naut-AWS/latest/guide/</a></p><p id="329b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-api-gateway-target.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/event bridge/latest/user guide/e b-API-gateway-target . html</a></p><p id="ffa6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://www.youtube.com/watch?v=TEuuPFxyTKg" rel="noopener ugc nofollow" target="_blank"> AWS EventBridge Java示例EventBridge Java演示应用程序| EventBridge Lambda Java演示— YouTube </a></p></div></div>    
</body>
</html>