<html>
<head>
<title>Golang Fantasy Hunting App, 3: Use your Lambda as an HTTP Backend with API Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang Fantasy Hunting App，3:使用你的Lambda作为带有API网关的HTTP后端</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/golang-fantasy-hunting-app-3-use-your-lambda-as-an-http-backend-with-api-gateway-dfe05ef0c5a4?source=collection_archive---------21-----------------------#2020-08-24">https://levelup.gitconnected.com/golang-fantasy-hunting-app-3-use-your-lambda-as-an-http-backend-with-api-gateway-dfe05ef0c5a4?source=collection_archive---------21-----------------------#2020-08-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/3674832b5a0f108d39df98ca309c52e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QGwWOQObSu4q0K-v43h-hg.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">安妮·尼加德在<a class="ae kf" href="https://unsplash.com/s/photos/monster?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="1c46" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">这是我的“Golang奇幻狩猎应用”系列的第三篇文章。建议你从第一个帖子开始，这里。</em></p><p id="9570" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在前一篇文章的结尾，我们已经成功地开发了一个保存并更新lambda和dynamo之间的工作集成。最后一步是使用AWS API Gateway将HTTP请求代理到lambda，这样我们就可以将它用作web服务。</p><p id="ee1e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要做到这一点，我们需要做五件事:</p><ol class=""><li id="5a1f" class="lf lg it ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated">通过API网关控制台创建新的API</li><li id="8fa2" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">创建新的端点</li><li id="6c34" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">将所有请求代理到我们的lambda</li><li id="9df5" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">测试API</li><li id="fb1f" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">部署API</li></ol><p id="66c7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">创建新的API </strong></p><p id="32c1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">HTTP API就像一组描述用户如何与你的后端交互的规则。API与一个基本URL相关联，例如<code class="fe lt lu lv lw b">www.example.com</code>和一个或多个表示不同域、进程、区域等的<code class="fe lt lu lv lw b">paths</code>。你的API所拥有的。例如，<code class="fe lt lu lv lw b">www.example.com/users</code>可能会返回属于<code class="fe lt lu lv lw b">example.com</code>的用户列表。然后，<code class="fe lt lu lv lw b">www.example.com/user/create</code>可能用于访问创建新用户的后端功能。通过在浏览器中点击这些URL并提供可能需要的任何数据，您就可以启动后端操作来完成您想要完成的任何事情。目前，我们的API将做一件事，那就是<code class="fe lt lu lv lw b">save</code>一个巨大的记录。在我们的例子中，<code class="fe lt lu lv lw b">save</code>意味着创建<em class="le">或</em>更新，这取决于所提供的ID是否已经在我们的数据库中定义。我们将有一个<code class="fe lt lu lv lw b">path</code>，<code class="fe lt lu lv lw b">/monsters</code>，它将接收一个包含我们想要保存的monster对象的JSON有效载荷。</p><p id="2ab8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">前往<a class="ae kf" href="https://eu-west-1.console.aws.amazon.com/apigateway/main" rel="noopener ugc nofollow" target="_blank"> AWS API网关控制台</a>。您将看到如下所示的内容。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lx"><img src="../Images/580b154e4763e099d60eff587c1d1049.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IjF9aTdNKRKsZhkh6e51aQ.png"/></div></div></figure><p id="10ba" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">点击“创建API”开始。在下一页，点击‘REST API’下的‘构建’<strong class="ki iu">；不是那种只能在VPC内部使用的。</strong></p><p id="d150" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">填写名称，忽略其他所有内容，然后单击“创建API”。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mc"><img src="../Images/55ec218f03d598cfb60ae41c55a5a3aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XPLc-6Tkd7_qVTTpIgjDWg.png"/></div></div></figure><p id="dec4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">创建端点和代理请求</strong></p><p id="ad55" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您应该会看到如下所示的页面。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi md"><img src="../Images/97b410a66f0daae76ed5bed3b606de9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vX5uljOO5txMh0p8ZCY9VQ.png"/></div></div></figure><p id="aa3e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe lt lu lv lw b">/</code>表示您的API的根。您可以针对这个根创建一个方法(GET、POST、PUT、DELETE等)并从那里开始，但是为了保持整洁，我将首先创建一个资源。</p><p id="10b1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">点击<code class="fe lt lu lv lw b">Actions</code>下拉菜单，然后点击“创建资源”。资源是您的API公开的特定路径。你可以有任意数量的这些，并对它们进行配置，当它们被加载到用户的浏览器中时做不同的事情。</p><p id="51bf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是您将看到的页面。称你的资源为“怪物”，然后是<code class="fe lt lu lv lw b">Create Resource</code>。我们不需要启用CORS，因为我们的lambda已经返回了CORS所需的标头。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi me"><img src="../Images/ec20434ac28b61fc7c5362b876c0352d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HpoXWddQCdAb5K6-sQINSQ.png"/></div></div></figure><p id="0d64" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦创建了资源，它就会出现在<code class="fe lt lu lv lw b">/</code>下的层次结构中。确保新资源被选中，然后再次使用<code class="fe lt lu lv lw b">Actions</code>下拉菜单，点击“创建方法”。</p><p id="d172" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当你这样做的时候，一个临时的选择框会出现在“怪物”的下面。点击并选择<code class="fe lt lu lv lw b">Post</code>。然后打勾确认。</p><p id="04d4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">HTTP方法定义了一种特定的方式，人们可以通过这种方式与您的API进行交互。例如，GET方法通常意味着API将只返回数据。POST方法通常意味着API将接收新数据并对其进行处理，比如将数据保存到数据库中。因为我们将把怪物唱片插入迪纳摩，所以使用POST是有意义的。</p><p id="634c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您现在应该会看到如下所示的内容。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mf"><img src="../Images/ed54602aef0af9aba911c52984178897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s-9hhonET2KhCLUamZySxA.png"/></div></div></figure><p id="543c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从这个页面中，您可以看到lambda集成是默认选择的。既然这是我们想要的，我们所要做的就是在<code class="fe lt lu lv lw b">Lambda Function</code>框中选择相关的lambda，并将其设置为代理集成。<strong class="ki iu">确保选中代理集成框，否则会有问题</strong>。一旦你完成了，开始在lambda函数框中输入你的Lambda的名字，它应该会出现在一个下拉列表中。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mg"><img src="../Images/f8b4bf710a4f7e239c12918fed9e7ac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dUvLb0xZNBKBaVgJB1ULjA.png"/></div></div></figure><p id="76d9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成后，点击<code class="fe lt lu lv lw b">Save</code>。一个模态会弹出警告，你要给你的API权限，让它调用你的lambda。我们想要这个，所以只需点击<code class="fe lt lu lv lw b">OK</code>。</p><p id="b094" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们有一个API、一个路径和一个方法，都指向我们的λ。</p><p id="5e2f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">测试API </strong></p><p id="26db" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在左边，你应该看到下面有一个闪电粗体字<code class="fe lt lu lv lw b">Test</code>。点击那个。</p><p id="dfc7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在下一页的底部，您会看到一个<code class="fe lt lu lv lw b">Request Body</code>文本框。我们把我们的怪物JSON放在这里。这是lambda将从传递给我们的处理函数的<code class="fe lt lu lv lw b">req</code>参数的<code class="fe lt lu lv lw b">Body</code>属性中提取的内容。</p><p id="48df" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们再看一下代码，检查一下我们的monster struct，我们会发现它应该像下面这样:</p><pre class="ly lz ma mb gt mh lw mi mj aw mk bi"><span id="df18" class="ml mm it lw b gy mn mo l mp mq">{<br/>    "id": "123",<br/>    "name": "Gorgon",<br/>    "hunted": true<br/>}</span></pre><p id="8fd2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，将它粘贴到<code class="fe lt lu lv lw b">Request Body</code>文本框中。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mr"><img src="../Images/fa379902bef6ea6f764b2c0a32186d3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LDpvZE5zTWsHUIhjSAONLQ.png"/></div></div></figure><p id="c312" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后点击测试。你应该看到一些东西出现在屏幕的右边，如果你滚动到顶部，你会看到你的lambda的HTTP响应。一旦部署了API，这也是web浏览器和专用HTTP客户端将会看到的。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ms"><img src="../Images/fcb2a1286769b7b70cebc16fc20be9fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jr5O_N9ktNLA95A8O-9DPQ.png"/></div></div></figure><p id="44fc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您去检查dynamo，您应该会看到一个与您刚才发送的请求体相对应的新记录。</p><p id="4e82" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">部署API </strong></p><p id="a956" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要做的最后一件事是部署API，这将使它可以在AWS控制台之外访问。为此，再次点击<code class="fe lt lu lv lw b">Actions</code>下拉菜单并选择“部署API”。将打开一个模态。</p><p id="6361" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于部署阶段，您需要选择新阶段。阶段是区分同一API部署的方法。例如，您可能想要一个可以随意摆弄和破坏的测试部署。您可能还希望实时部署成为您的用户将与之交互的官方API。我们真的不关心阶段，因为这不是一个真正的项目，所以我就叫我的生活。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mt"><img src="../Images/a856458e302dac906aa4ee841a6ba615.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Oq5xbB9iKtv_WdVe_nKVw.png"/></div></div></figure><p id="6498" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成后，部署它。</p><p id="d528" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您将被带到一个页面，在那里您可以看到所有已部署的阶段和API的基本URL。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mu"><img src="../Images/abc586e7ac78866935fdf4f962c21984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PHXhr_35MhLf2QUlReMiHg.png"/></div></div></figure><p id="ee10" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过将该URL输入HTTP客户端，添加您的<code class="fe lt lu lv lw b">/monsters</code>路径并发送一个带有一些怪物数据的<code class="fe lt lu lv lw b">POST</code>请求，您现在可以将怪物保存并更新到您的幻想日志中。</p></div><div class="ab cl mv mw hx mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="im in io ip iq"><p id="05dc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">至此，你已经准备好创建<code class="fe lt lu lv lw b">get-all</code> lambda了。您可能不知道从dynamo数据库中检索所有记录的具体代码，但是您知道如何创建和部署新的lambda，导入您需要的内容，编组和解组数据，连接到dynamo，并使用API gateway代理它。所以另一点就是看文档。</p><p id="18a1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">简单地说，您已经拥有了使用Golang、Lambda、Dynamo和API gateway创建HTTP服务所需的一切。</p><p id="d4d1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然而，如果你觉得你还需要一点整合，将会有最后一篇文章再次为λ做所有这些事情，但是在更高的层次上，解释也更少。所以如果你感兴趣的话，请留意一下。</p></div></div>    
</body>
</html>