<html>
<head>
<title>Gitlab Installation, Registry and Runner with Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Gitlab安装、注册和运行</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/gitlab-installation-registry-and-runner-with-docker-700549b93803?source=collection_archive---------4-----------------------#2019-11-12">https://levelup.gitconnected.com/gitlab-installation-registry-and-runner-with-docker-700549b93803?source=collection_archive---------4-----------------------#2019-11-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2dd994097eeb4cef0aec3e16ae28f774.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*o7p5nQoRXKDG1XNy.png"/></div></div></figure><p id="efd5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是我们与Gitlab和Kubernetes一起构建CI生态系统以部署基本Go服务的系列文章的第一部分。</p><p id="6c11" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意:您需要安装docker。</p><p id="82ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这一部分，我们首先为https访问创建自签名证书，然后利用这些证书安装一个归档的gitlab和一个集成的注册表。然后，我们添加了一个runner和一个自定义docker映像，以允许在CI管道中运行docker命令。</p><h1 id="a3d3" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">自签名证书</h1><p id="fc92" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated"><code class="fe lz ma mb mc b">openssl req -x509 -newkey rsa:4096 -sha256 -nodes -keyout gitlab.lightphos.com.key -out gitlab.lightphos.com.crt -subj "/CN=gitlab.lightphos.com" -days 3600</code> <em class="md">注意:如果/CN不起作用(如在windows git bash中)，请省略它，然后在CN提示符下输入域名</em></p><h2 id="ad4b" class="me kx iq bd ky mf mg dn lc mh mi dp lg kj mj mk lk kn ml mm lo kr mn mo ls mp bi translated">IP地址(ipconfig/ifconfig)</h2><p id="e8dc" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">向/etc/hosts添加条目</p><pre class="mq mr ms mt gt mu mc mv mw aw mx bi"><span id="3718" class="me kx iq mc b gy my mz l na nb">{host ip} gitlab.lightphos.com</span></pre><h1 id="2972" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">Gitlab和注册表安装</h1><p id="34f2" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">详细内容详见:<br/><em class="md"/><a class="ae nc" href="https://gitlab.com/lightphos/gitlabops" rel="noopener ugc nofollow" target="_blank"><em class="md">https://gitlab.com/lightphos/gitlabops</em></a></p><p id="8898" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">克隆上述repo或创建目录gitlabops/gitlab，并根据需要进行复制。</p><p id="b311" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将上述自签名证书步骤中的gitlab密钥和crt文件复制到目录gitlabops/gitlab/ssl中</p><p id="68cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在gitlabops中，使用以下内容创建文件<strong class="ka ir"/></p><pre class="mq mr ms mt gt mu mc mv mw aw mx bi"><span id="79dc" class="me kx iq mc b gy my mz l na nb">version: '2' <br/>services: <br/>  gitlab: <br/>    image: 'gitlab/gitlab-ce:latest' <br/>    restart: always <br/>    hostname: 'gitlab.lightphos.com' <br/>    container_name: gitlab <br/>    environment: <br/>      GITLAB_OMNIBUS_CONFIG: | <br/>        external_url 'https://gitlab.lightphos.com:30080' <br/>        registry_external_url 'https://gitlab.lightphos.com:5555' <br/>        gitlab_rails['gitlab_shell_ssh_port']=30022 <br/>        registry_nginx['enable'] = true <br/>        registry_nginx['listen_port'] = 5555 <br/>        registry_nginx['ssl_certificate'] = "/etc/gitlab/ssl/gitlab.lightphos.com.crt" <br/>        registry_nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/gitlab.lightphos.com.key" <br/>    ports: <br/>      - '30080:30080' <br/>      - '5555:5555' <br/>      - '30022:22' <br/>    volumes: <br/>      - './gitlab/config:/etc/gitlab' <br/>      - 'gitlab-logs:/var/log/gitlab' <br/>      - 'gitlab-data:/var/opt/gitlab' <br/>      - './gitlab/ssl:/etc/gitlab/ssl' </span><span id="dd10" class="me kx iq mc b gy nd mz l na nb">volumes: <br/>  gitlab-logs: <br/>    external: true <br/>  gitlab-data: <br/>    external: true</span></pre><p id="5e34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上述码头工人撰写文件包括建立综合码头工人登记处(端口5555)和添加正确的证书和密钥。按如下方式启动它(注意在重启之间使用docker卷来保持持久性)。</p><pre class="mq mr ms mt gt mu mc mv mw aw mx bi"><span id="13bf" class="me kx iq mc b gy my mz l na nb">cd gitlabops<br/>docker volume create gitlab-logs<br/>docker volume create gitlab-data <br/>docker-compose -f docker-compose-gitlab.yml up -d</span></pre><p id="b5f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">需要一段时间才能开始，请检查进度</p><p id="c518" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe lz ma mb mc b">docker logs -f gitlab</code></p><p id="6585" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="md"> (Ctrl+C退出)</em></p><p id="0cb1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，您可以使用在浏览器上导航</p><p id="c9b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae nc" href="https://gitlab.lightphos.com:30080" rel="noopener ugc nofollow" target="_blank">https://gitlab.lightphos.com:30080</a></p><p id="73e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加主密码，注册(我选择的用户名是sr，稍后使用)并创建一个项目。</p><p id="e0a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将ssh密钥添加到gitlab:</p><p id="b7e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae nc" href="https://subscription.packtpub.com/book/application_development/9781783986842/2/ch02lvl1sec20/adding-your-ssh-key-to-gitlab" rel="noopener ugc nofollow" target="_blank"><em class="md">https://subscription . packtpub . com/book/application _ development/9781783986842/2/ch02 ll1 sec 20/add-you-ssh-key-to-git lab</em></a></p><p id="7e87" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，您可以像往常一样使用git ssh添加或更改文件等。</p><h2 id="10db" class="me kx iq bd ky mf mg dn lc mh mi dp lg kj mj mk lk kn ml mm lo kr mn mo ls mp bi translated">多个遥控器</h2><p id="580f" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">如果您愿意，您可以拥有多个遥控器(除了原点):</p><p id="5308" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在gitlab.lightphos.com:30080上创建相同的项目，然后添加另一个遥控器:</p><pre class="mq mr ms mt gt mu mc mv mw aw mx bi"><span id="270d" class="me kx iq mc b gy my mz l na nb">$ git remote add local ssh://git@gitlab.lightphos.com:30022/sr/gitlabops.git <br/>$ git pull local master --allow-unrelated-histories <br/>$ git push local master</span></pre><h1 id="688e" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">码头工人登记处访问</h1><p id="162b" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">对于linux/mac: <br/>将<code class="fe lz ma mb mc b">gitlab.lightphos.crt</code>文件复制到~/。<code class="fe lz ma mb mc b">docker/certs.d/gitlab.lightphos.com:5555/ca.crt</code></p><p id="6ed7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在窗口中:右键单击证书，安装-&gt;本地-&gt;可信存储。</p><p id="7c1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在ubuntu:</p><p id="16b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe lz ma mb mc b">sudo cp gitlab.lightphos.com.crt /usr/local/share/ca-certificates/gitlab.lightphos.com.crt</code> <code class="fe lz ma mb mc b">sudo update-ca-certificates</code></p><p id="f419" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">重启docker。检查您是否可以登录:</p><pre class="mq mr ms mt gt mu mc mv mw aw mx bi"><span id="0e90" class="me kx iq mc b gy my mz l na nb">docker login gitlab.lightphos.com:5555 # username/password of gitlab account <br/>$ Login successful</span></pre><h1 id="229c" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">Gitlab Runner</h1><p id="e6a6" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">这是在mac上的(/Users/Shared是一个mac目录，其他操作系统见下文)</p><pre class="mq mr ms mt gt mu mc mv mw aw mx bi"><span id="40b2" class="me kx iq mc b gy my mz l na nb">docker run -d --name gitlab-runner --restart always \ <br/>-v /Users/Shared/gitlab-runner/config:/etc/gitlab-runner \ <br/>-v /Users/Shared/gitlab-runner/certs:/etc/gitlab-runner/certs \ <br/>-v /var/run/docker.sock:/var/run/docker.sock gitlab/gitlab-runner:latest</span></pre><p id="0fb0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注册一个docker runner(注意这个到主机的兄弟连接使用docker.sock，也不使用共享目录/Users/Shared)</p><pre class="mq mr ms mt gt mu mc mv mw aw mx bi"><span id="3ca0" class="me kx iq mc b gy my mz l na nb">docker run --rm -ti -v /Users/Shared/gitlab-runner/config:/etc/gitlab-runner \ <br/>gitlab/gitlab-runner register \ <br/>--url https://gitlab.lightphos.com:30080/ \ <br/>--registration-token REGISTRATION_TOKEN \ <br/>--executor docker \ <br/>--description "Runner" \ <br/>--docker-image "docker:19.03.1" \ <br/>--docker-volumes /var/run/docker.sock:/var/run/docker.sock</span></pre><p id="c064" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">url和令牌的详细信息可以在您的gitlab项目-&gt;设置-&gt; CI/CD -&gt; Runners中找到。</p><p id="5255" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您应该在设置中看到一个活跃的(绿色)跑步者:</p><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/6b456187343aadefb5927cdf615cb0c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/0*ow9Kc3tJq7Dx_mCs.png"/></div></figure><p id="0b8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置runner运行未标记的作业:<br/>点击铅笔:</p><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/a6b03116f813ad7be290369723999a12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gZVe5po38rHEejBh.png"/></div></div></figure><h1 id="4113" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">检查CI管道</h1><p id="4295" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">创建一个. gitlab-ci.yml文件。</p><pre class="mq mr ms mt gt mu mc mv mw aw mx bi"><span id="e1cf" class="me kx iq mc b gy my mz l na nb">variables: <br/> CONTAINER_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_BUILD_REF_NAME}_${CI_BUILD_REF}<br/> CONTAINER_IMAGE_LATEST: ${CI_REGISTRY}/${CI_PROJECT_PATH}:latest DOCKER_DRIVER: overlay2 </span><span id="8c87" class="me kx iq mc b gy nd mz l na nb">docker-build-master: <br/>  image: docker:19.03.1 <br/>  stage: build <br/>  before_script: <br/>    - echo $CI_BUILD_TOKEN | docker login -u gitlab-ci-token --password-stdin ${CI_REGISTRY} <br/>  script: <br/>    - docker images</span></pre><p id="cdf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">提交和推送。Docker登录和图像应该在管道控制台中可见。</p><p id="3486" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于其他操作系统，您需要复制到相应的目录，如下所示:</p><pre class="mq mr ms mt gt mu mc mv mw aw mx bi"><span id="76d4" class="me kx iq mc b gy my mz l na nb">VirtualBox	Linux	/home	        /hosthome <br/>VirtualBox	macOS	/Users	        /Users <br/>VirtualBox	Windows	C://Users	/c/Users</span></pre><p id="d0cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">删除已退出的docker进程的有用命令:</p><p id="bd2b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe lz ma mb mc b">docker rm -f $(docker ps -aq -f status=exited)</code></p><p id="5b77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae nc" href="https://blog.ramjee.uk/deploying-a-go-service-to-the-integrated-docker-registry-in-gitlab/" rel="noopener ugc nofollow" target="_blank">的下一篇</a>文章中，我们将看看如何将Go服务部署到我们构建的gitlab CI/registry基础设施中。</p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><p id="f7b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="md">原载于2019年11月12日</em><a class="ae nc" href="https://blog.ramjee.uk/docker-desktop-gitlab-and-kubernetes/" rel="noopener ugc nofollow" target="_blank"><em class="md">https://blog . ram JEE . uk</em></a><em class="md">。</em></p></div></div>    
</body>
</html>