<html>
<head>
<title>Calling external REST Service from AWS Lambda? (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从AWS Lambda调用外部REST服务？(第二部分)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/calling-external-rest-service-from-aws-lambda-part-2-c83f87b1e88a?source=collection_archive---------3-----------------------#2020-11-27">https://levelup.gitconnected.com/calling-external-rest-service-from-aws-lambda-part-2-c83f87b1e88a?source=collection_archive---------3-----------------------#2020-11-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e914" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">小巧、简单，并且在包装方面没有任何开销。</h2></div><p id="30d8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在第一部分之后的<a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/calling-external-rest-service-from-aws-lambda-1890a521a3f1">，这里现在是第二部分的一部分。</a></p><blockquote class="lc"><p id="bf3f" class="ld le iq bd lf lg lh li lj lk ll la dk translated"><strong class="ak">还是不用<em class="lm"> request.js、</em> Axios </strong>、<strong class="ak">或者深入<em class="lm"> Node.js HTTP。</em>T9】</strong></p></blockquote><figure class="lo lp lq lr ls lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ln"><img src="../Images/3e11b6345a726b10a63d469bcb8f6311.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lJY40rXesiQcFigt"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/@jgrotego?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">jrg Grote</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="8c1f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，我想给一些更多的好处和提示的概述</p><ul class=""><li id="a8c9" class="me mf iq kh b ki kj kl km ko mg ks mh kw mi la mj mk ml mm bi translated">OAuth承载令牌的使用</li><li id="861d" class="me mf iq kh b ki mn kl mo ko mp ks mq kw mr la mj mk ml mm bi translated">REST方法和Uri</li><li id="771f" class="me mf iq kh b ki mn kl mo ko mp ks mq kw mr la mj mk ml mm bi translated">数据类型</li><li id="d802" class="me mf iq kh b ki mn kl mo ko mp ks mq kw mr la mj mk ml mm bi translated">URL参数的用法</li><li id="a5fd" class="me mf iq kh b ki mn kl mo ko mp ks mq kw mr la mj mk ml mm bi translated">车身有效载荷</li><li id="dc85" class="me mf iq kh b ki mn kl mo ko mp ks mq kw mr la mj mk ml mm bi translated">请求验证和使用“形状”</li><li id="1e50" class="me mf iq kh b ki mn kl mo ko mp ks mq kw mr la mj mk ml mm bi translated">响应验证，以及如何避免问题</li><li id="1ed4" class="me mf iq kh b ki mn kl mo ko mp ks mq kw mr la mj mk ml mm bi translated">动态更改端点</li></ul></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h1 id="d115" class="mz na iq bd nb nc nd ne nf ng nh ni nj jw nk jx nl jz nm ka nn kc no kd np nq bi translated">OAuth承载令牌的使用</h1><p id="869d" class="pw-post-body-paragraph kf kg iq kh b ki nr jr kk kl ns ju kn ko nt kq kr ks nu ku kv kw nv ky kz la ij bi translated">作为示例，我在这里使用TIBCO云服务在案例管理系统中创建新的TIBCO Cloud Live Apps案例实例。</p><figure class="nw nx ny nz gt lt"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="dfef" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所见，该服务需要使用不记名令牌来针对TIBCO云执行请求。</p><p id="dec7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">令牌可以在以下位置生成:</p><figure class="nw nx ny nz gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi oc"><img src="../Images/1b0113b58cc6b0b71352bfc2875ddc3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*28__9SCaEcCy6ho4w431bw.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">TIBCO云—设置— OAuth访问令牌生成</figcaption></figure><blockquote class="od oe of"><p id="50a1" class="kf kg og kh b ki kj jr kk kl km ju kn oh kp kq kr oi kt ku kv oj kx ky kz la ij bi translated"><strong class="kh ir">注意:</strong> <a class="ae lb" href="https://account.cloud.tibco.com/signup/tci" rel="noopener ugc nofollow" target="_blank">注册30天TIBCO云集成免费试用</a></p></blockquote><p id="25f0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在AWS Lambda中，可以使用纯AWS SDK核心功能调用API，如下所示:</p><figure class="nw nx ny nz gt lt"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="b69f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该示例流畅地展示了如何使用OAuth、REST类型、URI定义、输入接口处理(包括验证),以及如何处理响应数据以返回新创建的Case instance id“Case reference”</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h1 id="516b" class="mz na iq bd nb nc nd ne nf ng nh ni nj jw nk jx nl jz nm ka nn kc no kd np nq bi translated">REST方法和Uri</h1><p id="34b8" class="pw-post-body-paragraph kf kg iq kh b ki nr jr kk kl ns ju kn ko nt kq kr ks nu ku kv kw nv ky kz la ij bi translated">在示例中，您可以在apiConfig部分中找到这里指定的REST操作方法，后面直接跟有URI</p><pre class="nw nx ny nz gt ok ol om on aw oo bi"><span id="bec7" class="op na iq ol b gy oq or l os ot">http: {<br/>         method: 'POST',<br/>         requestUri: '/process/v1/processes'<br/>}</span></pre><p id="7516" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">AWS SDK支持所有类型的方法，例如获取、发布、修补、上传、删除等。</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h1 id="92c7" class="mz na iq bd nb nc nd ne nf ng nh ni nj jw nk jx nl jz nm ka nn kc no kd np nq bi translated">数据类型</h1><p id="8a0b" class="pw-post-body-paragraph kf kg iq kh b ki nr jr kk kl ns ju kn ko nt kq kr ks nu ku kv kw nv ky kz la ij bi translated">要在操作定义中使用的受支持数据类型的列表</p><pre class="nw nx ny nz gt ok ol om on aw oo bi"><span id="8dac" class="op na iq ol b gy oq or l os ot">'string'<br/>'integer'<br/>'float'<br/>'boolean'<br/>'timestamp'<br/>'structure'<br/>'list'<br/>'map'<br/>'base64'<br/>'binary'</span></pre></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h1 id="a77a" class="mz na iq bd nb nc nd ne nf ng nh ni nj jw nk jx nl jz nm ka nn kc no kd np nq bi translated">URI参数的使用</h1><p id="1057" class="pw-post-body-paragraph kf kg iq kh b ki nr jr kk kl ns ju kn ko nt kq kr ks nu ku kv kw nv ky kz la ij bi translated">URI参数可以这样定义，在成员下，位置属性定义参数必须在URI中替换。</p><pre class="nw nx ny nz gt ok ol om on aw oo bi"><span id="350c" class="op na iq ol b gy oq or l os ot">http: {<br/>        method: 'GET',<br/>        requestUri: '/item/{id}'<br/>}</span></pre><p id="0273" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输入成员部分</p><pre class="nw nx ny nz gt ok ol om on aw oo bi"><span id="ab55" class="op na iq ol b gy oq or l os ot">members: {<br/>       'Id': {<br/>       // all kinds of validators are available<br/>       type: 'string',<br/>       // include it in the call URI<br/>       location: 'uri',<br/>       // this is the name of the placeholder in the URI<br/>       locationName: 'Id'<br/>}</span></pre></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h1 id="d89f" class="mz na iq bd nb nc nd ne nf ng nh ni nj jw nk jx nl jz nm ka nn kc no kd np nq bi translated">车身有效载荷</h1><p id="ea9f" class="pw-post-body-paragraph kf kg iq kh b ki nr jr kk kl ns ju kn ko nt kq kr ks nu ku kv kw nv ky kz la ij bi translated">要将JSON有效负载作为请求体发送，可以定义一个输入有效负载</p><pre class="nw nx ny nz gt ok ol om on aw oo bi"><span id="7c38" class="op na iq ol b gy oq or l os ot">payload: 'body',</span></pre><p id="7025" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，主体可以被定义为例如具有一些成员的结构</p><pre class="nw nx ny nz gt ok ol om on aw oo bi"><span id="4f44" class="op na iq ol b gy oq or l os ot">'body': {<br/>         type: 'structure',<br/>         required: [ 'id', 'fname', 'lname' ],<br/>         members: {<br/>                    'id': {<br/>                       type: 'integer'<br/>                    },<br/>                    'fname': {},<br/>                    'lname': {}<br/>                  }<br/>         }</span></pre></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h1 id="20cd" class="mz na iq bd nb nc nd ne nf ng nh ni nj jw nk jx nl jz nm ka nn kc no kd np nq bi translated">请求验证和使用“形状”</h1><p id="4298" class="pw-post-body-paragraph kf kg iq kh b ki nr jr kk kl ns ju kn ko nt kq kr ks nu ku kv kw nv ky kz la ij bi translated">在发送请求之前，所有请求都需要验证必填字段和数据类型。</p><p id="6fac" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你有一个重复出现的数据结构，形状的概念是非常有用的，你需要为请求定义复杂的结构。</p><pre class="nw nx ny nz gt ok ol om on aw oo bi"><span id="ab6f" class="op na iq ol b gy oq or l os ot">apiConfig: {<br/>        metadata: {<br/>            protocol: 'rest-json' // API is JSON-based<br/>        },<br/>        operations: {<br/>            complexPost: {<br/>                http: {<br/>                    method: 'POST',<br/>                    requestUri: '/v1/complexPost'<br/>                },<br/>                input: {<br/>                    "shape": "complexPostRequest"<br/>                }<br/>            }<br/>        },<br/>        'shapes': {<br/>            'complexPostRequest': {<br/>                type: 'structure',<br/>                required: [ 'auth' ],<br/>                payload: 'body',<br/>                members: {<br/>                   ...</span></pre><p id="2b53" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">形状可以作为输入的一部分在操作中使用，形状甚至可以在其他形状中使用。比如这里的“形状”:“收件人”</p><pre class="nw nx ny nz gt ok ol om on aw oo bi"><span id="0daa" class="op na iq ol b gy oq or l os ot">members: {<br/>       'recipients': { <br/>             type: 'list', member: { 'shape': 'recipient'} <br/>    } <br/>   }<br/>  }<br/> }<br/>}, // &lt;- back main shapes level<br/>'recipient': {<br/>     "type": "string"<br/>}</span></pre></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h1 id="e0df" class="mz na iq bd nb nc nd ne nf ng nh ni nj jw nk jx nl jz nm ka nn kc no kd np nq bi translated">响应验证，以及如何避免问题</h1><p id="435c" class="pw-post-body-paragraph kf kg iq kh b ki nr jr kk kl ns ju kn ko nt kq kr ks nu ku kv kw nv ky kz la ij bi translated">甚至可以使用响应验证，但这意味着甚至需要为每个操作定义响应类型。</p><p id="8df3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在某些情况下，您可能希望只获得来自REST服务的数据的子集，因此您可以通过使用。</p><pre class="nw nx ny nz gt ok ol om on aw oo bi"><span id="f714" class="op na iq ol b gy oq or l os ot">const service = new AWS.Service({</span><span id="bf19" class="op na iq ol b gy ou or l os ot">    // the API base URL<br/>    endpoint: &lt;url&gt;,</span><span id="c270" class="op na iq ol b gy ou or l os ot">    // don't parse all API responses<br/>    convertResponseTypes: false,</span></pre><p id="8259" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意:这也有助于避免版本问题，因为您可能只依赖底层服务的基本细节。</p><h2 id="9ea6" class="op na iq bd nb ov ow dn nf ox oy dp nj ko oz pa nl ks pb pc nn kw pd pe np pf bi translated">返回none JSON的REST服务</h2><p id="c411" class="pw-post-body-paragraph kf kg iq kh b ki nr jr kk kl ns ju kn ko nt kq kr ks nu ku kv kw nv ky kz la ij bi translated">有些服务不返回有效的JSON，比如只返回一个id，但是AWS-SDK总是试图返回一个数据对象。</p><p id="476a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一个从响应体返回有效JSON的解决方法。</p><figure class="nw nx ny nz gt lt"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="3342" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">的”。on('success ')”变通方法并返回“httpResponse.body”就完美地完成了这个任务！</p><h1 id="94a2" class="mz na iq bd nb nc pg ne nf ng ph ni nj jw pi jx nl jz pj ka nn kc pk kd np nq bi translated">动态更改端点</h1><p id="ac29" class="pw-post-body-paragraph kf kg iq kh b ki nr jr kk kl ns ju kn ko nt kq kr ks nu ku kv kw nv ky kz la ij bi translated">有时需要调整端点URL，因为需要选择不同的区域。在调用服务之前，只需动态地重新配置AWS SDK服务端点对象就可以做到这一点。</p><pre class="nw nx ny nz gt ok ol om on aw oo bi"><span id="3c6c" class="op na iq ol b gy oq or l os ot">var region="eu.";</span><span id="ea66" class="op na iq ol b gy ou or l os ot">service.endpoint.host=<a class="ae lb" href="https://liveapps.cloud.tibco.com/" rel="noopener ugc nofollow" target="_blank">region+</a>"example.com";<br/>service.endpoint.hostname=<a class="ae lb" href="https://liveapps.cloud.tibco.com/" rel="noopener ugc nofollow" target="_blank">region+</a>"example.com";<br/>service.endpoint.href="<a class="ae lb" href="https://liveapps.cloud.tibco.com/" rel="noopener ugc nofollow" target="_blank">https://"+region+"example.com/</a>";<br/>       <br/>service.getSomething({<br/>...</span></pre></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h1 id="c385" class="mz na iq bd nb nc nd ne nf ng nh ni nj jw nk jx nl jz nm ka nn kc no kd np nq bi translated">TIBCO实验室</h1><p id="778c" class="pw-post-body-paragraph kf kg iq kh b ki nr jr kk kl ns ju kn ko nt kq kr ks nu ku kv kw nv ky kz la ij bi translated">本文是在TIBCO实验室的倡议下撰写的，完整的可重用源代码可以在公共<a class="ae lb" href="https://github.com/TIBCOSoftware/TIBCO-LABS/tree/master/src/Calling%20external%20REST%20Service%20from%20AWS%20Lambda%20(Part%C2%A02)" rel="noopener ugc nofollow" target="_blank"> TIBCO实验室GitHub资源库</a> <br/>下找到，包括BSD 3条款许可证。</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h1 id="fc72" class="mz na iq bd nb nc nd ne nf ng nh ni nj jw nk jx nl jz nm ka nn kc no kd np nq bi translated">下一步是什么</h1><p id="a4b3" class="pw-post-body-paragraph kf kg iq kh b ki nr jr kk kl ns ju kn ko nt kq kr ks nu ku kv kw nv ky kz la ij bi translated">这只是一个后续，目前正在制作更多的内容<br/>——敬请期待！</p><blockquote class="lc"><p id="1f32" class="ld le iq bd lf lg lh li lj lk ll la dk translated"><em class="lm">感谢阅读和掌声！</em></p></blockquote></div></div>    
</body>
</html>