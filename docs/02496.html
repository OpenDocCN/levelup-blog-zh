<html>
<head>
<title>How We Reduced Our App Size By 50% With Split APKs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何通过拆分apk将我们的应用规模减少了50%</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-we-reduced-our-app-size-by-50-with-split-apks-c71196bbdde5?source=collection_archive---------7-----------------------#2020-03-17">https://levelup.gitconnected.com/how-we-reduced-our-app-size-by-50-with-split-apks-c71196bbdde5?source=collection_archive---------7-----------------------#2020-03-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="72d9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">你不需要Android应用捆绑包。领域用户听好了！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/27faff6a95841a202096a999ca34331a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mewncSQkiWTY9vaQlLWQDg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@paulathevalley?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">宝拉·拉瓦莱</a>在<a class="ae ky" href="https://unsplash.com/s/photos/person-using-phone?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="fb6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们最近达到了谷歌Play商店的应用大小上传限制，即100 mb。我们没有使用Android应用捆绑包，而是想看看我们是否可以在没有它的情况下减少我们的应用大小。</p><p id="998a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以我们分析了我们的APK:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/c01e27d873177c132c85c2a1eb7735c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JNdgLDa9tb9Zs5Uk"/></div></div></figure><p id="c297" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意<code class="fe lw lx ly lz b">lib</code>文件夹中的五个文件夹。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ma"><img src="../Images/eb33c318e56f9699c3280f45c1fe59af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AD0IxYPNsI8xxac09EtS0g.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mb"><img src="../Images/c8504125f648610ec7190e11de6d4067.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*20AHf3A_fqN76vrOYPkarg.png"/></div></div></figure><p id="477e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它们占了很多空间！原来这些文件夹都是编译好的<a class="ae ky" href="https://developer.android.com/ndk/guides/abis" rel="noopener ugc nofollow" target="_blank"> ABIs </a>，基本上只是Android机器码。这就是你写的代码在你设备的CPU上实际运行的方式。您的设备需要这些文件夹中的一个来实际运行您的代码。</p><p id="90b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，为什么在我们的APK中有五个ABI，而一个设备只需要一个？简而言之，我们使用Realm开发我们的应用程序，Realm使用NDK或本地开发工具包。因此，当我们创建我们的APK时，我们得到了构建到我们的APK中的每个平台的编译代码。真不敢相信</p><p id="9f26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按照<a class="ae ky" href="https://developer.android.com/studio/build/apk-analyzer" rel="noopener ugc nofollow" target="_blank">这些步骤</a>来分析你的APK，检查你的应用程序是否被这些库弄得臃肿不堪。如果是这样，请继续…</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h2 id="c8a1" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">一个APK来统治他们所有人…？</h2><p id="7826" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">因此，我们可以做的是将我们的“通用”APK拆分成多个apk，在ABI上拆分。这里的代码很简单并且有很好的文档<a class="ae ky" href="https://developer.android.com/studio/build/configure-apk-splits" rel="noopener ugc nofollow" target="_blank"/>。将此代码添加到您的应用程序gradle文件中:</p><pre class="kj kk kl km gt nh lz ni nj aw nk bi"><span id="51c6" class="mj mk it lz b gy nl nm l nn no">android {<br/>    splits {<em class="np"><br/>        </em>abi {<em class="np"><br/>            </em>enable <em class="np">true<br/><br/>            </em>reset()<br/><br/>            include 'armeabi-v7a','arm64-v8a', 'x86', 'x86_64', 'armeabi'<br/><br/>            universalApk <em class="np">false<br/>        </em>}<br/>    }<br/>...<br/>}</span></pre><p id="79fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在文件的下面添加这个:</p><pre class="kj kk kl km gt nh lz ni nj aw nk bi"><span id="a9c6" class="mj mk it lz b gy nl nm l nn no">ext.abiCodes = ["armeabi":1, "x86":2, "armeabi-v7a":3, "arm64-v8a":4, "x86_64":5] <em class="np">// this order matters<br/><br/>import </em>com.android.build.<em class="np">OutputFile</em></span><span id="902d" class="mj mk it lz b gy nq nm l nn no">android.applicationVariants.all { variant <strong class="lz iu">-&gt;</strong><em class="np"><br/>    </em>variant.outputs.each { output <strong class="lz iu">-&gt;<br/><br/></strong><em class="np">﻿<br/>﻿        def </em>baseAbiVersionCode =<em class="np">             </em>project.ext.abiCodes.get(output.getFilter(<em class="np">OutputFile</em>.<em class="np">ABI</em>))<br/><em class="np"><br/>        if </em>(baseAbiVersionCode != <em class="np">null</em>) {<em class="np"><br/>            </em>output.versionCodeOverride =<br/>                    baseAbiVersionCode * 1000 + variant.versionCode<br/>        }<br/>    }<br/>}</span></pre><p id="611d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是有据可查的，但是这里有一个问题。<code class="fe lw lx ly lz b">abiCodes</code>的顺序很重要。这个订单对我们有效。基本上，ABI类型的32位版本必须是比64位版本更低的版本代码。<code class="fe lw lx ly lz b">x86</code>必须是比<code class="fe lw lx ly lz b">x86_64</code>更低的版本代码。<code class="fe lw lx ly lz b">armeabi</code>必须是比<code class="fe lw lx ly lz b">armeabi-v7a</code>和<code class="fe lw lx ly lz b">arm64-v8a</code>更低的版本代码。</p><p id="6ef0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">说到这些ABI代码，这些值是从哪里来的呢？好问题。有x86 (32和64位)，ARM和MIPS ABIs三个版本。有很多首字母缩略词。我需要包括哪些内容？</p><p id="1925" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们读过这方面的资料，但并不清楚。有些只包含64位ABI。有人说要摆脱MIPS ABIs，我们做到了(没有现代的Android设备运行MIPS)。我们使用了<a class="ae ky" href="https://developer.android.com/ndk/guides/abis" rel="noopener ugc nofollow" target="_blank"> Android的官方文档</a>和Google Play控制台的设备目录。</p><p id="4b71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">设备目录允许我按ABI过滤支持的设备。我们有使用五个ABI的设备:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/09f0b7f08987683c1df5f511883f355c.png" data-original-src="https://miro.medium.com/v2/resize:fit:556/format:webp/1*2Sbm9f-pexVz87ZMp2To3w.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">可过滤ABIs</figcaption></figure><p id="fa96" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们决定包括所有这五个ABI。根据Android文档，我认为我们可以从上传到Play Store的apk中删除<code class="fe lw lx ly lz b">armeabi</code>,而不会失去设备支持。但没有理由不上传它，我宁愿安全而不是遗憾。</p><p id="cdcb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以现在，建立您的签名的apk并上传所有五个！它应该是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/8015434b57611a5b0a479763106f7a03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pclg2abQxgjQ_RQtNt7M2A.png"/></div></div></figure><p id="90ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以看到每个APK大约只有一半大。这太棒了！那现在怎么办？我如何确保每个用户获得正确的APK？实际上，你不必为此做任何事情。该游戏商店完全处理APK的交付。它会计算出用户拥有什么设备，需要什么ABI，并下载正确的ABI！</p><p id="5ad4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是收益实际上比上面提到的下载量要大得多。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/53eef7b0daea6abc1143b14e702fe5df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uvnjnz7a50khnPfZ-VPygw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">分割apk之前</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi gj"><img src="../Images/60fad68bfd99a4ec2220df8a2bb27f0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ov4xJuLvYilrlVrc5PNC8g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">拆分apk后</figcaption></figure><p id="5d0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下载您的应用程序时，它会大于Play Store中显示的“应用程序下载大小”。</p><p id="ce11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些是类似的像素设备在拆分apk之前和之后的截图。“应用程序大小”的收益约为50%，但我们在Pixel设备上节省了超过100mb！</p><p id="ad14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">谷歌Play商店对您的最终用户来说看起来完全一样，他们不需要任何功能上的不同。下次更新时，他们的应用程序将只有原来的一半大小！</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><p id="7ac6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我们将应用规模缩减了50%，您的最终用户什么也不用做。太好了。但是让我们来解决房间里的大象。为什么我们没有安卓应用捆绑？它做着同样的事情，这个GIF很好地总结了这一点:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/a3f8be0372715669735bf9dbd3231cdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*sCY-E6Z8DpnTNrOOBgLOSA.gif"/></div></div></figure><p id="4c58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会注意到，只有一个ABI会出现在右边的设备上。这就是我们刚刚做的！它也只将一种语言和一个资源集打包到设备上。实际上，您也可以像我们使用ABIs一样自己完成这项工作。在这里阅读更多<a class="ae ky" href="https://developer.android.com/studio/build/configure-apk-splits" rel="noopener ugc nofollow" target="_blank"/>。我们没有这样做，因为ABI是在这个时候真正膨胀我们的应用程序的原因。</p><p id="dd5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们找出了使用AABs所需的工作，而不是自己拆分。两者的成本都很低，但我们不想把签约交给谷歌。这并不仅仅局限于谷歌Play商店。我们也已经解决了所有CI中的签名问题，因此由我们来处理签名并不是一个大胜利。</p><p id="9fdd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在还可以单独测试每个APK。每个APK预成型的方式不应该有任何差异，但如果有一个非常低级的错误，你可以单独安装和调试APK，而不是依赖整个AAB捆绑APK。</p><p id="de64" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，去AAB是一个不可逆的过程。一旦你选择加入，你就不能退出。你的应用程序现在由谷歌签名，你不能再自己签名了。Google拥有您的应用程序签名密钥。</p><p id="5e5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们将承认，这些理由中的大部分是相当“锡箔帽”y。但是自己做的成本是如此之低，以至于它真的不是一个大的权衡。老实说，这很有趣！</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><p id="c21a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">额外的举动:现在你已经打开了多个apk的闸门，你可以用动态交付做一些非常酷的事情。</p><p id="6f23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设您有一个测试程序，并且您正在向一部分新用户推出一项新功能。典型的流程是将功能打包到应用程序中，并限制某些用户使用某些功能。但是这使你的应用程序膨胀了一个不是每个用户都能看到的特性。</p><p id="8da3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你能做的就是上传你的基地APK和上传一个特色APK。然后，通过动态交付，您可以将功能APK仅分发给需要它的用户。这里有一篇关于这个<a class="ae ky" href="https://medium.com/mindorks/dynamic-feature-modules-the-future-4bee124c0f1" rel="noopener">写的很棒的文章。</a></p><p id="d101" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读，如果这篇文章对你有帮助，请鼓掌！</p></div></div>    
</body>
</html>