<html>
<head>
<title>Tracking User Streaks in Ruby</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Ruby中跟踪用户条纹</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/tracking-user-streaks-in-ruby-a49e90ce46a1?source=collection_archive---------7-----------------------#2020-02-02">https://levelup.gitconnected.com/tracking-user-streaks-in-ruby-a49e90ce46a1?source=collection_archive---------7-----------------------#2020-02-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f7eb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过日常习惯跟踪保持用户参与度</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/278e88f1f7db4fd7908f39550b4fd29c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ov0UdO8OowCzTX37bVraVg.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">来自<a class="ae kv" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/</a>的习惯追踪日志图片</figcaption></figure><p id="af85" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从Duolingo到Headspace，如今许多最受欢迎的应用程序都在追踪用户的“条纹”。通过记录用户连续登录并完成任务的天数，这些应用旨在为用户创造有益的习惯，同时确保活跃的日常用户群。随着习惯追踪应用程序的流行，似乎有证据表明，保持连胜的愿望确实会激励一个人去做一件他们可能不会做的事情。</p><p id="7e2d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">随着条纹成为如此受欢迎的特征，我和一个朋友决定试着把它整合到我们最近的一个项目中。该应用程序引导用户完成一个<a class="ae kv" href="https://www.wimhofmethod.com/" rel="noopener ugc nofollow" target="_blank">维姆·霍夫</a>呼吸周期的步骤，我们希望显示他们至少完成一个周期的连续天数。</p><h1 id="a647" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">目标</h1><p id="5f66" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">跟踪登录用户完成一个呼吸周期的连续天数，并在我们的应用程序的主页上显示该数字。当用户连续一天第一次完成一个新的会话时，该数字应该立即更新。</p><h1 id="4ac2" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">解决方案</h1><p id="a4cf" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在几次使用gems或代码片段的失败尝试后，我们认为编写自己的代码会更容易，也是更好的学习体验。我们还选择跟踪后端的条纹，因为Ruby使得日期和时间的处理更加简单。以下是最终版本:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/25800916fe3175e3dbf17e04123a946f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9r1Rh0-7t5LwEVqtH1jEeg.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">代码示例截图<a class="ae kv" href="https://gist.github.com/shanelonergan/b86a6704ca1e7d7c9a4a610c8f363ee6" rel="noopener ugc nofollow" target="_blank">(https://gist . github . com/shanelonergan/b 86 a 6704 ca 1 e 7d 7 c 9 a 4 a 610 c 8 f 363 ee 6</a>)</figcaption></figure><h1 id="5f1d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">崩溃</h1><p id="fa51" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们的应用程序构建在ruby-on-rails后端上，前端是普通的JavaScript。有两种型号:<code class="fe mq mr ms mt b">User</code>和<code class="fe mq mr ms mt b">Session</code>。一个<code class="fe mq mr ms mt b">Session</code>T16属于一个<code class="fe mq mr ms mt b">User</code>，一个<code class="fe mq mr ms mt b">User</code>T18有很多个T5。</p><h2 id="4bad" class="mv lt iq bd lu mw mx dn ly my mz dp mc lf na nb me lj nc nd mg ln ne nf mi ng bi translated">第一步:建立关系</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/659d79e8881a12ece15ffdaee993dad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L9lErb0cDmPKl_-63YJ4Fw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">代码示例的屏幕截图，第1–2行</figcaption></figure><p id="98d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们需要创建一个用户的Ruby类，它继承自<code class="fe mq mr ms mt b">ApplicationRecord</code>，一个包含<a class="ae kv" href="https://guides.rubyonrails.org/active_record_basics.html" rel="noopener ugc nofollow" target="_blank">活动记录</a> ORM的rails模型(更多关于对象关系映射器<a class="ae kv" href="https://blog.bitsrc.io/what-is-an-orm-and-why-you-should-use-it-b2b6f75f5e2a" rel="noopener ugc nofollow" target="_blank">的信息，请点击</a>)。然后，我们可以添加一个多对多关系的ActiveRecord语法，如第2行所示。这允许我们通过在一个<code class="fe mq mr ms mt b">User</code>的实例中简单地调用<code class="fe mq mr ms mt b">.sessions</code>来访问一个用户的所有会话。此外，活动记录关系可以接受第二个参数，<a class="ae kv" href="https://edgeguides.rubyonrails.org/association_basics.html#scopes-for-belongs-to" rel="noopener ugc nofollow" target="_blank"> scope </a>，这允许我们定制SQL查询。我们希望我们的数组从最近的日期到最近的日期排序，这可以通过查询<strong class="ky ir"> <em class="mu">降序</em> </strong>来实现:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h2 id="c663" class="mv lt iq bd lu mw mx dn ly my mz dp mc lf na nb me lj nc nd mg ln ne nf mi ng bi translated">步骤2:定义一个实例方法</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/f9e71ae59fff3ec4ac9d2cc6804e7928.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pjsMF8o4vXdd3Q6Vq-ibkg.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">代码示例的屏幕截图，第1-10行</figcaption></figure><p id="f0e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们需要创建一个实例方法<code class="fe mq mr ms mt b">streak</code>，我们可以调用一个<code class="fe mq mr ms mt b">User</code>的实例来获得它们的条纹。在这个方法中，我们将声明一对局部变量，我们将在函数中用到它们。首先，让我们将<code class="fe mq mr ms mt b">streak_count</code>设置为0。为了可读性，我们还应该定义<code class="fe mq mr ms mt b">today</code>。Ruby允许我们使用<code class="fe mq mr ms mt b">Time.now.to_date</code>轻松找到并格式化当天。<code class="fe mq mr ms mt b">Time.now</code>将以长格式返回日期:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="20ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我们只想记录天数，所以我们可以使用<code class="fe mq mr ms mt b">to_date</code>去掉所有无关的信息。这将返回一个简单易读的日期格式。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h2 id="74e2" class="mv lt iq bd lu mw mx dn ly my mz dp mc lf na nb me lj nc nd mg ln ne nf mi ng bi translated">步骤3:创建日期数组</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/1f0ca1ad555392a8a73684955c9bfdd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G0mfIdoeOIVMCtyi8XbKrw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">代码示例屏幕截图，第16行</figcaption></figure><p id="86e8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了确保同一天的多个会话不会计入连续记录，我们希望创建一个只包含唯一日期的数组。我们将分两步进行:</p><ol class=""><li id="3f2f" class="nl nm iq ky b kz la lc ld lf nn lj no ln np lr nq nr ns nt bi translated">使用可枚举方法<code class="fe mq mr ms mt b">.map</code>，我们可以为每个会话创建一个从<code class="fe mq mr ms mt b">created-at</code>时间戳转换而来的日期数组。</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="da72" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.对该数组应用<code class="fe mq mr ms mt b">.uniq</code>以确保它只包含唯一的日期。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="d653" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们需要为<code class="fe mq mr ms mt b">streak_count</code>、<code class="fe mq mr ms mt b">0</code>建立一个默认值。我们现在有了计算条纹所需的大部分变量！</p><h2 id="078e" class="mv lt iq bd lu mw mx dn ly my mz dp mc lf na nb me lj nc nd mg ln ne nf mi ng bi translated">步骤3:计算条纹</h2><p id="8c73" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">对于这一步，我们将利用Ruby的可枚举方法<code class="fe mq mr ms mt b">reduce</code>。如果你不熟悉reduce，我推荐你看看这篇<a class="ae kv" href="https://mixandgo.com/learn/what-is-a-ruby-reducer" rel="noopener ugc nofollow" target="_blank">很棒的文章</a>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/9e5675d2bebe3aafec995515b79ccbb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8FPG-bbI8ffi-1mNEDsVjw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">代码示例的屏幕截图，第1–34行</figcaption></figure><p id="dd19" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们浏览一下这个方法。伪代码中reducer的基本结构如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="996b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常，累加器(习惯上称为<code class="fe mq mr ms mt b">memo</code>)是方法的返回值。例如，如果您正在计算一组数字的总和，它看起来会像这样:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="17db" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，对于我们的方法，我们需要跟踪两个不同的变量:当前条纹值，以及<em class="mu">最后一次连续会话的日期</em>。这是因为我们从今天的日期开始，按时间倒序计数。让我们来分解一下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="5ea4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里，我们对唯一日期数组调用reduce，并传入我们在步骤2中定义的<code class="fe mq mr ms mt b">today</code>，作为备忘录的起始值。然后我们定义一个本地变量<code class="fe mq mr ms mt b">yesterday</code>，作为备忘录前一天的重新格式化日期。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="83ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们希望创建一个<em class="mu"> if </em>语句，确定何时增加条纹计数。如果用户今天完成了一个会话，那么在数组的第一次迭代中，<code class="fe mq mr ms mt b">date</code>将等于今天；我们会想要增加。对于接下来的每次迭代，我们想要检查<code class="fe mq mr ms mt b">date</code>是否等于<code class="fe mq mr ms mt b">yesterday</code>。如果是，这意味着用户已经连续三天完成了一个会话，因此我们应该再次递增。只要数组中的下一个日期是我们正在迭代的当前日期的前一天，这个值就会继续增加。这是因为我们根据<code class="fe mq mr ms mt b">created_at</code>属性对<code class="fe mq mr ms mt b">sessions</code>数组进行了降序排序，如上所述。</p><p id="b445" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">重要提示:</strong>不要忘记在<code class="fe mq mr ms mt b">streak method</code>结束时返回条纹计数，否则返回值将是我们减速器的最终备忘录。</p><h2 id="6103" class="mv lt iq bd lu mw mx dn ly my mz dp mc lf na nb me lj nc nd mg ln ne nf mi ng bi translated">恭喜你。现在可以在rails应用程序中计算用户条数了</h2><p id="ea14" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">这段代码应该是可修改的，以便与任何具有<em class="mu"> has_many </em>关系的活动记录模型一起工作。祝你好运跟踪所有这些条纹！</p><p id="be58" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是最终的代码，包括注释，你可以在这里查看这个为<a class="ae kv" href="https://shanelonergan.github.io/breathe/" rel="noopener ugc nofollow" target="_blank">编写的应用程序。</a></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/32cf7e78580a136a24cc70387f3c000b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pWCoOLTUWXR1jNEEKUEdQw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">带有注释的代码示例的屏幕截图</figcaption></figure><h1 id="fb72" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">GitHub Gist</h1><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure></div><div class="ab cl nw nx hu ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="ij ik il im in"><p id="58d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢您的阅读！如果你喜欢这篇文章，请随时在medium或twitter上关注我。</p></div><div class="ab cl nw nx hu ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="ij ik il im in"><h1 id="6b2c" class="ls lt iq bd lu lv od lx ly lz oe mb mc jw of jx me jz og ka mg kc oh kd mi mj bi translated">参考</h1><ul class=""><li id="2c0b" class="nl nm iq ky b kz mk lc ml lf oi lj oj ln ok lr ol nr ns nt bi translated"><a class="ae kv" href="https://www.vox.com/the-goods/2019/1/2/18158989/habit-tracking-apps-new-years-resolutions" rel="noopener ugc nofollow" target="_blank">习惯追踪应用是最新的自我提升趋势。但是它们有用吗？</a></li><li id="0a71" class="nl nm iq ky b kz om lc on lf oo lj op ln oq lr ol nr ns nt bi translated"><a class="ae kv" href="https://www.wimhofmethod.com/" rel="noopener ugc nofollow" target="_blank">维姆·霍夫法</a></li><li id="2fce" class="nl nm iq ky b kz om lc on lf oo lj op ln oq lr ol nr ns nt bi translated"><a class="ae kv" href="https://guides.rubyonrails.org/active_record_basics.html" rel="noopener ugc nofollow" target="_blank">活动记录基础知识</a></li><li id="088f" class="nl nm iq ky b kz om lc on lf oo lj op ln oq lr ol nr ns nt bi translated"><a class="ae kv" href="https://blog.bitsrc.io/what-is-an-orm-and-why-you-should-use-it-b2b6f75f5e2a" rel="noopener ugc nofollow" target="_blank">什么是ORM，为什么要使用它</a></li><li id="c2c3" class="nl nm iq ky b kz om lc on lf oo lj op ln oq lr ol nr ns nt bi translated"><a class="ae kv" href="https://mixandgo.com/learn/what-is-a-ruby-reducer" rel="noopener ugc nofollow" target="_blank">什么是红宝石减速器？</a></li><li id="02c0" class="nl nm iq ky b kz om lc on lf oo lj op ln oq lr ol nr ns nt bi translated"><a class="ae kv" href="https://edgeguides.rubyonrails.org/association_basics.html#scopes-for-Belongs-to" rel="noopener ugc nofollow" target="_blank">所属范围_归属于</a></li></ul></div></div>    
</body>
</html>