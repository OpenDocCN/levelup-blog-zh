<html>
<head>
<title>A Geographic Microservice</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">地理微服务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-geographic-microservice-d7634bd060ac?source=collection_archive---------13-----------------------#2021-03-02">https://levelup.gitconnected.com/a-geographic-microservice-d7634bd060ac?source=collection_archive---------13-----------------------#2021-03-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="95d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第2部分:无服务器、AWS API网关、Lambda和Mapbox</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/79cbd0dd9232eab302e8e8acb7271660.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jdvxNWStSVu65s6Pud3yzQ.png"/></div></div></figure><h2 id="537a" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">快速回顾</h2><p id="b6ec" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">在<a class="ae lv" rel="noopener ugc nofollow" target="_blank" href="/a-geographic-microservice-43408dd8f012">第1部分</a>中，我们完成了AWS微服务的后端，包括一个<a class="ae lv" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> PostGreSQL </strong> </a>关系数据库，并启用了<a class="ae lv" href="https://postgis.net/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> PostGIS </strong> </a>地理空间扩展。<a class="ae lv" href="https://postgis.net/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> PostGIS </strong> </a>扩展允许新的云数据库存储地理数据，并能够执行地理SQL查询。</p><p id="40c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">记住，基于矢量的地理数据可以作为<a class="ae lv" href="https://www.igismap.com/gis-tutorial-basic-spatial-elements-points-lines-and-polygons/" rel="noopener ugc nofollow" target="_blank">点、线和多边形</a>存储在数据库中。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/3b0a8e4599eaff1d6192882a635a88f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*TaID5vtnzOYkkKSb-VQNpg.png"/></div></figure><p id="b88c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上次我们成功导入了来自美国人口普查局的<strong class="jp ir"> </strong> <a class="ae lv" href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">美国国会选区多边形</strong> </a>数据。多边形构成了每个地区的边界线。我们使用<a class="ae lv" href="https://qgis.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> QGIS </strong> </a>连接到新的AWS云数据库，并将地区数据导入到云中。</p><p id="f2a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦填充完毕，我们就可以查询<a class="ae lv" href="https://www.pgadmin.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> pgAdmin </strong> </a>中的数据。以下是从<strong class="jp ir"> cb_2018_us_cd116_20m </strong>表中查询到的前100个区。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="0beb" class="kx ky iq ly b gy mc md l me mf">SELECT id, geom, statefp, cd116fp, affgeoid, geoid, lsad, cdsessn<br/>FROM public.<strong class="ly ir">cb_2018_us_cd116_20m</strong><br/>limit 100;</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mg"><img src="../Images/6435bbc8b1efa9b2142c029ce5a59256.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vJ4jfzZnkuf62x_R2EnQIA.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">从云AWS RDS查询地理国会选区数据</figcaption></figure><p id="a646" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于地区边界线数据由<strong class="jp ir">多边形</strong>表示，我们可以看到它们在<strong class="jp ir"> pgAdmin </strong>中用<a class="ae lv" href="https://www.compose.com/articles/geofile-pgadmin-4-and-the-geometry-viewer/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">几何查看器</strong></a><strong class="jp ir"/>直观地显示在地图上，这是对<strong class="jp ir"> pgAdmin </strong>非常有用的补充。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ml"><img src="../Images/be22060c0dac16a0c7905a22c38d8485.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eyIt1mtTK9XdYBUX3LV8tQ.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">直观显示在地图上的地区查询结果</figcaption></figure></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><p id="716f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从这里开始，我们想向上移动堆栈，通过一个RESTful微服务API 公开这个地区的数据，这个API也将使用<strong class="jp ir"> AWS Lambda函数托管。</strong>来自<a class="ae lv" href="https://docs.aws.amazon.com/lambda" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> AWS Lambda </strong>文档</a> …</p><blockquote class="mt mu mv"><p id="5e2b" class="jn jo mw jp b jq jr js jt ju jv jw jx mx jz ka kb my kd ke kf mz kh ki kj kk ij bi translated">有了<strong class="jp ir"> AWS Lambda </strong>，你可以运行代码<strong class="jp ir">而无需供应或管理服务器</strong>。你只为你消耗的计算时间付费——当你的代码不运行时<strong class="jp ir">不收费。您可以为几乎任何类型的应用程序或后端服务运行代码—所有这些都无需管理。只需上传你的代码，Lambda就会为你的代码提供高可用性的运行和扩展。你可以从任何网络或手机应用程序中直接调用它。</strong></p></blockquote><p id="3940" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种类型的设置，其中我们有一个<strong class="jp ir">自包含服务</strong>，是弹性应用程序的构建块。在这种情况下，<strong class="jp ir">微服务</strong>将返回国会选区<strong class="jp ir"> GeoJSON </strong>，这是一个地理数据的开放标准，随时可以显示在网络地图上。</p><p id="d7bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在做了一些研究之后，<a class="ae lv" href="https://github.com/serverless/serverless" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>被推荐为使用<strong class="jp ir"> AWS Lambda </strong>函数的有用工具。有了<strong class="jp ir">无服务器框架</strong>，我们将能够轻松地…</p><blockquote class="mt mu mv"><p id="1e1e" class="jn jo mw jp b jq jr js jt ju jv jw jx mx jz ka kb my kd ke kf mz kh ki kj kk ij bi translated">…开发和部署您的<strong class="jp ir"> AWS Lambda </strong>功能，以及它们所需的<strong class="jp ir"> AWS </strong>基础设施资源。这是一个CLI，<strong class="jp ir">提供了现成的结构、自动化和最佳实践</strong>，允许您专注于构建复杂的、事件驱动的、无服务器的架构，由函数和事件组成。</p></blockquote><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi na"><img src="../Images/e4f7bd1ec8280fdc931724b447370b33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1xQxOOAcITOr7UULBL3McQ.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">无服务器框架</figcaption></figure><p id="0081" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望<strong class="jp ir">无服务器</strong>能够帮助<strong class="jp ir"> AWS </strong>尽可能顺利地部署，我们将使用它提供的结构和功能模板。</p><p id="ef2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，全局安装<strong class="jp ir">无服务器</strong> it:</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="e91e" class="kx ky iq ly b gy mc md l me mf">$ npm install serverless -g</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nb"><img src="../Images/510a9daa9fa9d21ab5008200935094b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JCSU66zQ1NG0uuw8OTe-oQ.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">安装无服务器框架</figcaption></figure><p id="43b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，通过在终端提示符下输入以下内容，创建一个名为<strong class="jp ir">AWS-postgres-server less</strong>的新模板。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="4888" class="kx ky iq ly b gy mc md l me mf">$ serverless</span></pre><p id="265e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当询问项目类型时，选择<strong class="jp ir"> AWS Node.js </strong>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/45b1b4dac5e90dda447bf06242aa86d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*CZij-BsVVpIXQEnrMvmSTw.png"/></div></figure><p id="f6cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，初始化项目。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="5c35" class="kx ky iq ly b gy mc md l me mf">$ cd aws-postgres-serverless<br/>$ npm init</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/de039101fe805e993a85e4c284702de7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*ddyCzbi1z77uC2_XFeYrDw.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">初始化无服务器项目</figcaption></figure><p id="d022" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，该项目有4个文件:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/0fdc903d8fafd06535b52084b695868d.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*ACfxiVvEicGyGeTrDyLWFw.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">初始模板</figcaption></figure><p id="3a6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir"> handler.js </strong>中，我们可以看到一个为我们预先编写的<strong class="jp ir"> Lambda </strong>函数。看起来这是一个“hello world”函数，它传递了一条消息，表明该函数执行成功。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="e0c3" class="kx ky iq ly b gy mc md l me mf">module.exports.hello = async (event) =&gt; {<br/>  return {<br/>    statusCode: 200,<br/>    body: JSON.stringify(<br/>      {<br/>        <strong class="ly ir">message</strong>: 'Go Serverless v1.0! Your function executed    <br/>        successfully!',<br/>        input: event,<br/>      },null,2),<br/>  };<br/>};</span></pre><p id="b0b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们稍微改变一下消息，这样我们就可以确定我们的代码正在更新。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="ac80" class="kx ky iq ly b gy mc md l me mf">module.exports.hello = async (event) =&gt; {<br/>  return {<br/>    statusCode: 200,<br/>    body: JSON.stringify(<br/>      {<br/>        <strong class="ly ir">message</strong>: '<strong class="ly ir">Hooray! It works!</strong>',<br/>        input: event,<br/>      },null,2),<br/>  };<br/>};</span></pre><p id="c12f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，看看这个项目的配置文件<strong class="jp ir">。它为微服务将响应的</strong>的<strong class="jp ir">路线提供了许多定制和定义。</strong></p><p id="c14c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意这个函数条目是如何引用<strong class="jp ir"> handler.js </strong>中的<strong class="jp ir"> hello </strong>函数的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/eed95b5efacb74e69e91f9abe39d1279.png" data-original-src="https://miro.medium.com/v2/resize:fit:406/format:webp/1*hWvR_uhHD5YonpAvlM6dOg.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">serverless.yml函数条目</figcaption></figure><p id="f7bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了测试服务和<strong class="jp ir"> hello函数</strong>，我们需要安装另一个npm包<strong class="jp ir"> serverless-offline </strong>。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="fbde" class="kx ky iq ly b gy mc md l me mf">$ npm install --save serverless-offline</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/0685bf622481ee79510cc696ae29407c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*i6pdRLF9WmeczoOYIieoFA.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">安装无服务器-脱机</figcaption></figure><p id="d772" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，替换(或注释掉)serverless.yml中的文本，并添加以下配置设置。<em class="mw">server less . yml中的缩进很重要，所以要小心。</em></p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="6d78" class="kx ky iq ly b gy mc md l me mf">service: aws-postgres-serverless</span><span id="adf8" class="kx ky iq ly b gy nh md l me mf">frameworkVersion: '2'</span><span id="3ea0" class="kx ky iq ly b gy nh md l me mf">provider:<br/>  name: aws<br/>  runtime: nodejs12.x<br/>  lambdaHashingVersion: 20201221</span><span id="c41b" class="kx ky iq ly b gy nh md l me mf">functions:</span><span id="e9cd" class="kx ky iq ly b gy nh md l me mf">  hello:<br/>    handler: handler.hello<br/>      events:<br/>        - http:<br/>          method: get<br/>          path: /hello</span><span id="422d" class="kx ky iq ly b gy nh md l me mf">plugins:<br/>  - serverless-offline</span></pre><p id="691a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此处全文<strong class="jp ir"> serverless.yml </strong>至此。该服务将公开一个名为<strong class="jp ir"> hello </strong>的函数。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/a762c53fe90c2075dca636a573a9ae02.png" data-original-src="https://miro.medium.com/v2/resize:fit:612/format:webp/1*Cd-tKmg5iT7PLlI9q7CT2g.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">无服务器. yml</figcaption></figure><p id="c0aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在终端的测试环境中启动服务。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="80a7" class="kx ky iq ly b gy mc md l me mf">$ serverless offline</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/ab0d0b32ab884ba66c11589a30dfe550.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*Wb3QbbX93Zemki8rAfMjCQ.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">测试服务</figcaption></figure><p id="2841" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们在hello路线上访问本地服务…</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="066f" class="kx ky iq ly b gy mc md l me mf"><a class="ae lv" href="http://localhost:3000/dev/hello" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/dev/hello</a></span></pre><p id="4063" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到它在我们的网络浏览器中工作。万岁！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/65798ab530e96d888fc80d4bd7f28223.png" data-original-src="https://miro.medium.com/v2/resize:fit:698/format:webp/1*Ht5jMAouaImuUGJlCZ2Z_Q.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">你好世界！</figcaption></figure><p id="e8d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，在我们将功能部署到<strong class="jp ir"> AWS </strong>云之前，我们需要在<strong class="jp ir"> AWS </strong>中设置一个<strong class="jp ir">用户</strong>，该用户有权与我们的<strong class="jp ir"> AWS </strong>生态系统的其他部分进行交互，特别是在<a class="ae lv" rel="noopener ugc nofollow" target="_blank" href="/a-geographic-microservice-43408dd8f012">第1部分</a>中讨论和设置的<strong class="jp ir"> AWS RDS Postgres/PostGIS </strong>云数据库。</p><h2 id="713b" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">配置AWS IAM</h2><p id="f2c4" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">要创建用户，请访问<strong class="jp ir"> AWS </strong>控制台，并使用您的帐户和密码登录。登录后，导航至<a class="ae lv" href="https://console.aws.amazon.com/iam" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> AWS IAM </strong>控制台</a>。在这里，我们将创建一个新的<strong class="jp ir">用户</strong>，并将该用户添加到一个新的<strong class="jp ir">组</strong>，授予与<strong class="jp ir"> AWS RDS </strong>、<strong class="jp ir"> API网关</strong>和<strong class="jp ir"> Lambda </strong>交互所需的权限。</p><p id="70fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，创建<strong class="jp ir"> aws-postgres-users </strong>组，并赋予它必要的权限。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nl"><img src="../Images/bf19165eef1ce85ea943e82fd8bcd288.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5eGlWc6v5T0ddy1cjd3PBg.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">创建AWS-postgres-用户组</figcaption></figure><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="0a48" class="kx ky iq ly b gy mc md l me mf">Grant the following policies:<a class="ae lv" href="https://console.aws.amazon.com/iam/home?region=us-east-1#policies/arn:aws:iam::aws:policy/AmazonRDSFullAccess" rel="noopener ugc nofollow" target="_blank"><br/></a>AmazonRDSFullAccess<br/>AWSLambdaFullAccess<br/>IAMFullAccess<br/>AmazonAPIGatewayAdministrator<br/>AWSCloudFormationFullAccess</span></pre><p id="1e53" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，创建一个名为<strong class="jp ir"> aws-postgres </strong>的新<strong class="jp ir">用户</strong>，并将该用户添加到<strong class="jp ir"> aws-postgres-users组</strong>。您将看到用户的<strong class="jp ir">访问密钥ID </strong>和<strong class="jp ir">秘密访问密钥</strong>。</p><p id="d0ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">此信息只向您显示一次，因此请务必注意。</strong></p><p id="437c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，回到终端，用下面的命令配置您的安全凭证，在适当的地方用上面提到的值替换您的值。这将允许服务使用提供的凭据进行操作。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="aad3" class="kx ky iq ly b gy mc md l me mf">$ serverless config credentials --provider aws --key <strong class="ly ir">&lt;your_access_key&gt;</strong> --secret <strong class="ly ir">&lt;your_secret_key&gt;</strong></span></pre><h2 id="b31a" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">部署！</h2><p id="72f5" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">现在，我们已经准备好部署到云了，这是通过以下命令完成的:</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="f92f" class="kx ky iq ly b gy mc md l me mf">$ serverless deploy</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/5e2c4339846a094ef5a222661a624750.png" data-original-src="https://miro.medium.com/v2/resize:fit:1098/format:webp/1*DnwZgZGN3xD9Gk-gTCQp7A.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">部署微服务！</figcaption></figure><p id="5bff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，如果我们在浏览器中访问该服务，我们可以看到hello功能正常工作！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/d7f273ad6aed885717099ac5ee933afb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*C0_xFqvktFBg765Rd-HXqg.png"/></div></figure></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi no"><img src="../Images/32b318e855b6dd5f9dd2d8e346ff8896.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*meyI1LC032O13Mhi.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">来自云端的你好</figcaption></figure><p id="2e67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">微服务<strong class="jp ir">中的hello world功能是一个不错的开始。然而，这篇文章的真正目的是公开在第1部分中创建的<strong class="jp ir"> AWS RDS PostgreSQL </strong>后端的地理空间数据。</strong></p><p id="8536" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，首先我们需要安装<a class="ae lv" href="https://www.npmjs.com/package/pg" rel="noopener ugc nofollow" target="_blank"> pg </a> npm包，这是一个用于<strong class="jp ir"> Node.js、</strong>的非阻塞<strong class="jp ir"> PostgreSQL </strong>客户端，允许连接到我们的<strong class="jp ir"> AWS RDS PostgreSQL </strong>数据库。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="d8e2" class="kx ky iq ly b gy mc md l me mf">$ npm install --save pg</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi np"><img src="../Images/1d33e5ee36c62e1b18903aab35856e01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*aBPq4Hfe1OqiEL3RIuz_ig.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">安装pg</figcaption></figure><p id="f64c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们需要在一个名为<strong class="jp ir"> db.js </strong>的新文件中定义我们与数据库的连接，其内容如下。这是我们在<a class="ae lv" rel="noopener ugc nofollow" target="_blank" href="/a-geographic-microservice-43408dd8f012"> <em class="mw">第1部分</em> </a>中创建的<strong class="jp ir"> AWS RDS </strong>数据库的连接。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="b319" class="kx ky iq ly b gy mc md l me mf">module.exports = {<br/>  database: 'carto_boundaries',<br/>  host: 'aws-postgres-postgis.x.us-east-1.rds.amazonaws.com',<br/>  user: 'awspostgres',<br/>  password: 'XXXXXX'<br/>}</span></pre><p id="6d59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据创建的数据库，用实际值替换这些值。</p><p id="ccbd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:如果你把这段代码提交给github，别忘了。git忽略这个db.js文件。它包含数据库凭据。</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi no"><img src="../Images/ddb0a04736ca0f76329211479fd2b1b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*n7ccJXBzkxg3xlSy.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">隐藏你的证件！！！</figcaption></figure><p id="0d96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，在<strong class="jp ir"> handler.js </strong>中，让我们添加一个名为<strong class="jp ir"> getDistricts </strong>的新方法，它连接到数据库并返回第一个区。以下是该查询的SQL语句。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="e01c" class="kx ky iq ly b gy mc md l me mf">SELECT id, geom, statefp, cd116fp, affgeoid, geoid, lsad, cdsessn,<br/>aland, awater<br/>FROM public.cb_2018_us_cd116_20m <br/><strong class="ly ir">limit 1;</strong></span></pre><p id="18e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的SQL驱动下面的<strong class="jp ir"> getDistricts </strong>函数:</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="112e" class="kx ky iq ly b gy mc md l me mf">module.exports.getDistricts = (event, context, callback) =&gt; {</span><span id="26b0" class="kx ky iq ly b gy nh md l me mf">  const client = new Client(dbConfig)<br/>  client.connect()<br/>  <br/>  let sql = `<br/>  SELECT id, geom, statefp, cd116fp, affgeoid, geoid, lsad, cdsessn,<br/>  aland, awater<br/>  FROM public.cb_2018_us_cd116_20m <br/>  <strong class="ly ir">limit 1</strong>`.trim()</span><span id="6dc8" class="kx ky iq ly b gy nh md l me mf">  client<br/>    .query(sql, null)<br/>      .then((res) =&gt; {<br/>        const response = {<br/>          statusCode: 200,<br/>          body: JSON.stringify(res.rows),<br/>        }<br/>        callback(null, response)<br/>        client.end()<br/>      })<br/>      .catch((error) =&gt; {<br/>        const errorResponse = {<br/>          statusCode: error.statusCode || 500,<br/>          body: `${error}`,<br/>        }<br/>        callback(null, errorResponse)<br/>        client.end()<br/>      })<br/>}</span></pre><p id="093a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了公开这个新的<strong class="jp ir"> getDistricts </strong>函数，我们需要更新<strong class="jp ir"> serverless.yml </strong>为新函数添加一个http方法和路径。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="df55" class="kx ky iq ly b gy mc md l me mf">getDistricts:<br/>  handler: handler.getDistricts<br/>    events:<br/>    - http:<br/>      method: get<br/>      path: /getDistricts</span></pre><p id="6f34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，如果我们在网络浏览器中访问我们的新路线:</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="5624" class="kx ky iq ly b gy mc md l me mf"><a class="ae lv" href="http://localhost:3000/dev/getDistricts" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/dev/getDistricts</a></span></pre><p id="1810" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到连接工作正常，这是数据库中第一个地区返回的数据！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/2722ee9538cb8fa3cc63a01848408450.png" data-original-src="https://miro.medium.com/v2/resize:fit:804/format:webp/1*0lakKsBNc6TO4mCRS4gPWw.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">数据库中的结果</figcaption></figure></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/65eb2b68dc5a444d3f3d8e574b670a4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:790/format:webp/1*erz68GigXXGXGpUrnxKRDA.png"/></div></figure><p id="2738" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目前情况看起来不错。</p><p id="feee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，上面输出中的<strong class="jp ir"> geom列值对于我们的前端web地图来说没有用</strong>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ns"><img src="../Images/1e232444bb634c182567afc2c74ea96e.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*QljwlVjpYB0dA4RXNoKwKA.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">原始几何列</figcaption></figure><p id="e6db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">幸运的是，<strong class="jp ir"> PostGIS </strong>允许以<strong class="jp ir"> GeoJSON </strong>格式返回结果，方法是将查询包装在函数中，将结果转换成<strong class="jp ir"> GeoJSON </strong>。这个<strong class="jp ir"> getGeoJsonSQL </strong>助手函数将接受一个非geo <strong class="jp ir"> SQL </strong>语句，并返回一个<strong class="jp ir"> SQL </strong>语句，该语句将返回<strong class="jp ir"> GeoJSON </strong>作为结果。所有原始的<strong class="jp ir"> SQL </strong>查询列都包含在返回的<strong class="jp ir"> GeoJSON </strong>中。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/126dda0d6a12535149cf5e7583dbcae3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/1*ZQ_kYWpGYmaCNzhABQWFHw.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">从PostGIS中选择GeoJSON</figcaption></figure><p id="84a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，在<strong class="jp ir"> getDistricts </strong>函数中，我们将<strong class="jp ir"> SQL </strong>传递给<strong class="jp ir"> getGeoJsonSqlFor </strong>函数。当我们这次在响应体中返回结果时，我们从geo查询结果的第一行返回<strong class="jp ir"> jsonb_build_object </strong>，这将是一个描述地区边界的<strong class="jp ir"> GeoJSON </strong>字符串。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/49a69bdb73eb60eb7ce91f81ad17b02a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*iyOntJexH0ulWCChgByjVg.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">从SQL结果返回GeoJSON</figcaption></figure><p id="f382" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再次访问/getDistricts路径，我们看到返回的是<strong class="jp ir"> GeoJSON </strong> <strong class="jp ir">多多边形</strong>数据，而不是之前的原始geom数据。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/7d91e1ca3db448cfe681f2154fe36584.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/1*FmJ3UIzysCYoB7pVplN3AQ.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">国会选区的GeoJSON</figcaption></figure><p id="b626" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过更仔细地检查<strong class="jp ir"> GeoJSON </strong>结果，注意它由一个<strong class="jp ir">特征</strong>数组组成，每个特征包含一个<strong class="jp ir">坐标</strong>数组。<strong class="jp ir">坐标</strong>数组<strong class="jp ir"> </strong>包含一系列的经纬度坐标，这些坐标沿着地区边界的轮廓，为每个地区形成一个<strong class="jp ir">多边形</strong>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/a95678f971cf82eee13e5df556436a75.png" data-original-src="https://miro.medium.com/v2/resize:fit:490/format:webp/1*EgKMLeZ_EeWa0EFbqZ4pdQ.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">GeoJSON由经纬度坐标组成</figcaption></figure></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><p id="658b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以现在，<strong class="jp ir">微服务</strong>返回单个地区的<strong class="jp ir"> GeoJSON </strong>。我们可以很容易地在此基础上完成我们在第1部分结束时的目标，返回特定州的选区。</p><p id="7aa4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在<a class="ae lv" rel="noopener ugc nofollow" target="_blank" href="/a-geographic-microservice-43408dd8f012">第1部分</a>中导入的districts表有一个<strong class="jp ir"> statefp </strong>列，但是这不是一个可以传递到API中的用户友好的值，因为<strong class="jp ir"> statefp </strong>值并不常见。我们希望能够接受来自用户的两个字母的州缩写，并让它驱动下面查询中的<strong class="jp ir"> statefp </strong>参数。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nx"><img src="../Images/42b1fe95e3ca235c4fefc2dac0ae0bba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7RDNyxwzN7VUEhEI33IFug.png"/></div></div></figure><p id="3d24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了进行这样的查询，我们需要向服务背后的数据库添加额外的数据，特别是美国的州数据。这个数据需要有<strong class="jp ir"> statefp </strong>以及<strong class="jp ir"> stusps </strong>(两个字母的州缩写列)来完成连接。</p><p id="9c69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">方便的是，从<a class="ae lv" href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">美国人口普查</strong> </a>中获得的美国州界线数据具有所需的<strong class="jp ir"> statefp </strong>、<strong class="jp ir"> stusps </strong>和<strong class="jp ir"> name </strong>列。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ny"><img src="../Images/49b343320fcfc35505533f31e7a5dc15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u9vWqarbs725AmzkykT7ow.png"/></div></div></figure><p id="08c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，让我们将美国的州数据(包括州界地理数据)导入到云数据库中的一个新表中，就像我们之前使用<strong class="jp ir"> QGIS </strong>处理地区数据一样。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nz"><img src="../Images/dbc8cb3f6c29faa44f4cbb4c8851361e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aPIs168FXDeQDrBl_2PmrA.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">将美国各州数据导入云中</figcaption></figure><p id="b26f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了新表，我们可以通过两个字母的州名缩写(<strong class="jp ir"> stusps </strong>)来查询<strong class="jp ir"> pgAdmin </strong>中的特定州名。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oa"><img src="../Images/0835d305f7824a0213977824e0359df4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EostU47CYJL9TW2c26BkBg.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">状态数据在云中</figcaption></figure><p id="9fc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，我们可以使用连接来获取特定州缩写的地区。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="5204" class="kx ky iq ly b gy mc md l me mf">SELECT districts.*, states.stusps as state_abbrev, states.name as state_name<br/>FROM cb_2018_us_state_20m states<br/>JOIN cb_2018_us_cd116_20m districts on districts.statefp = states.statefp<br/>WHERE stusps = $1;</span></pre><p id="7439" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的SQL驱动了一个新的<strong class="jp ir">getdistricsforstate</strong>函数。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/3a0f344baf9d6663a414a3c41c2f217b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*sqGHyr6zblbyXk4Rqw_OWw.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">getDistrictsForState函数</figcaption></figure><p id="a4cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了将<strong class="jp ir">getdistricsforstate</strong>公开为新的<strong class="jp ir"> AWS Lambda </strong>函数，我们必须再次在<strong class="jp ir"> serverless.yml </strong>中添加对的引用。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/d7623b33bc83341553049ffef67b3ad8.png" data-original-src="https://miro.medium.com/v2/resize:fit:712/format:webp/1*ZMnfj8bFPY7ihgeOls_Pzg.png"/></div></figure><p id="e436" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，如果我们再次启动实例并为Indiana传递“in ”,我们将在<strong class="jp ir"> GeoJSON </strong>中获得Indiana的所有地区。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi od"><img src="../Images/0c84efaac79d2495b744c97c55654390.png" data-original-src="https://miro.medium.com/v2/resize:fit:886/format:webp/1*C4s8WEcjMJhec12ejpTTqA.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">GeoJSON的印第安纳国会选区</figcaption></figure><h2 id="8648" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">调整微服务访问</h2><p id="9dba" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">在这一点上，为了使我们的服务可以在<strong class="jp ir"> AWS </strong>上从生产中访问，还需要一个快速添加。</p><p id="c75a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在返回的响应对象中，添加<strong class="jp ir">头</strong>键，并使用以下对象作为其值。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="6580" class="kx ky iq ly b gy mc md l me mf"><strong class="ly ir">headers</strong>: {<br/>  "Access-Control-Allow-Origin": '*',<br/>  "Access-Control-Allow-Methods": 'GET'<br/>}</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/8cfe88a97b66036307d34f3976fbffab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*MT5y8QH-Q3tdflhqGRQVFg.png"/></div></figure><p id="cff0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将允许从任何地方连接到我们的服务。</p><p id="9fc3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果熟悉下面的<strong class="jp ir"> CORS </strong>策略错误，您就会理解为什么需要headers值。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi of"><img src="../Images/bfcc3e94e36a05488b7601434d1d4f7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*h3ju1k0ndfQ4WuqgnIdRsg.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">不要被CORS政策阻挡</figcaption></figure><p id="76d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们把最新的<strong class="jp ir"> AWS Lambda </strong>函数(<strong class="jp ir">getdistricsforstate</strong>)推送给AWS云微服务。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="5a04" class="kx ky iq ly b gy mc md l me mf">$ serverless deploy</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi og"><img src="../Images/7da22719d4c2cc39c6c41f832fc44da1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*cp5l8HZmum5NHWsjAbL11g.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">部署微服务</figcaption></figure><p id="07a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署服务后，我们可以在浏览器中访问生产路线。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/4f10287686651ca2cd25ca217313ea3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*8wc9JnbWcu1cYDvIlXB26w.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">印第安纳地区，来自AWS微服务</figcaption></figure><p id="ea03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果需要CA，则更改URL中的参数。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/06ef8ffafc7ed6f1e0035644f2cf41f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*SyWRUmdY9fC7c_IHRYkSpw.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">加利福尼亚地区，来自AWS微服务</figcaption></figure></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><p id="06c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">地图</strong></p><p id="513e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们有了一个能够动态返回美国每个州的国会选区GeoJSON数据的微服务，在地图上显示选区有多容易？非常。</p><p id="32ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir"> QGIS </strong>中，我们可以很容易地从源代码中添加一个区图层。导航到图层&gt;添加图层&gt;添加矢量图层。选择<strong class="jp ir">协议HTTP(S) </strong>。确保选择<strong class="jp ir"> GeoJSON </strong>作为类型。对于<strong class="jp ir"> URI </strong>，将IN for Indiana追加到源url中，以检索该州的地区。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oj"><img src="../Images/2971f80f94174be0ecd2af92d3864996.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ApQX69S_4HOXcON3obfqw.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">将区域从云中添加到QGIS中</figcaption></figure><p id="7ae2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">网络地图怎么样？当然可以。</p><p id="36c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lv" href="https://docs.mapbox.com/mapbox-gl-js/api/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Mapbox GL JS </strong> </a>是一个非常强大的开源库，用于创建地图并在其上显示地理数据。<strong class="jp ir"> GeoJSON </strong>是一种常见的web地图源格式。</p><p id="5ade" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是一个基于地图框的网络地图的<a class="ae lv" href="https://fergusdevelopmentllc.github.io/awsmap/index.html?state=IN" rel="noopener ugc nofollow" target="_blank">演示，它调用微服务并根据URL中传递的州值显示相应的地区。</a></p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="1171" class="kx ky iq ly b gy mc md l me mf"><a class="ae lv" href="https://fergusdevelopmentllc.github.io/awsmap/index.html?state=IN" rel="noopener ugc nofollow" target="_blank">https://fergusdevelopmentllc.github.io/awsmap/index.html?state=IN</a></span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi of"><img src="../Images/38b4ea38444b3134fa164a248d52301b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*l8BllUa4crwNy1VV98GxHg.png"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">印第安纳国会选区</figcaption></figure><p id="332b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是生成上面地图的HTML和JavaScript。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="517d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第48行，您将看到服务被调用的位置，传递了state abbreviation参数。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi om"><img src="../Images/f4752de86f0df814300eb49e71996b64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LK90mcCCxR4h9PbycwaoIg.png"/></div></div></figure><p id="955d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要查看其他州的地区，请更改URL。比如这里的<a class="ae lv" href="https://fergusdevelopmentllc.github.io/awsmap/index.html?state=CA" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">加州</strong> </a>。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="4554" class="kx ky iq ly b gy mc md l me mf"><a class="ae lv" href="https://fergusdevelopmentllc.github.io/awsmap/index.html?state=CA" rel="noopener ugc nofollow" target="_blank">https://fergusdevelopmentllc.github.io/awsmap/index.html?state=CA</a></span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi on"><img src="../Images/b1312259fc7752701a7d2a95efdcd01f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9IUJjFGbYBKBOnZrG3oIXA.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">加州国会选区</figcaption></figure></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><p id="2611" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本项目的第3部分中，我们将探索<strong class="jp ir"> PostGIS </strong>的更多功能，旨在找到一种基于美国各县人口的感兴趣区域的方法。</p><p id="e451" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里是本文讨论的无服务器代码的<a class="ae lv" href="https://github.com/FergusDevelopmentLLC/aws-postgress-serverless" rel="noopener ugc nofollow" target="_blank"> github库</a>。</p></div></div>    
</body>
</html>