<html>
<head>
<title>Using NVIDIA GPU’s with K3’s</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将NVIDIA GPU与K3配合使用</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-nvidia-gpus-with-k3-s-76acbc1106ef?source=collection_archive---------20-----------------------#2022-09-26">https://levelup.gitconnected.com/using-nvidia-gpus-with-k3-s-76acbc1106ef?source=collection_archive---------20-----------------------#2022-09-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/41601aa521076cb63ee90b22bc5fd022.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LQTML9eBVzXND1wgqI6IKQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来源:<a class="ae kf" href="https://developer.nvidia.com/blog/deploying-a-natural-language-processing-service-on-a-kubernetes-cluster-with-helm-charts-from-ngc/" rel="noopener ugc nofollow" target="_blank">英伟达开发者</a></figcaption></figure><p id="1614" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我希望我不必写一篇关于这个的文章。如果Nvidia(完全)开源他们的驱动程序，那么他们就可以成为linux和Kubernetes的一等公民了。然而，目前情况并非如此，所以这里是你将需要采取的旅程，让Nvidia GPU与Linux一起工作(我特别是在Ubuntu 22.04)。</p><h1 id="9ab8" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">安装驱动程序</h1><p id="d7b3" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">第一步当然是安装合适的驱动程序。我假设你想修补驱动程序。修补驱动程序会移除当前强加给它们的artificial 2代码转换限制。我们将建立驱动程序，因为为什么不。</p><p id="7783" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们开始之前，我们需要确保新的驱动程序被禁用。我们这样做是因为Nvidia驱动程序与我们稍后将使用的K3模块兼容。如果你想进一步了解这一步的细节，你可以看看<a class="ae kf" href="https://linuxconfig.org/how-to-disable-blacklist-nouveau-nvidia-driver-on-ubuntu-22-04-jammy-jellyfish-linux" rel="noopener ugc nofollow" target="_blank">这篇linuxconfig.org</a>的文章，这些说明就是从那里摘录的。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="f155" class="mq lf it mm b gy mr ms l mt mu"># Add Nouveau to the modprobe blacklist<br/>sudo bash -c "echo blacklist nouveau &gt; /etc/modprobe.d/blacklist-nvidia-nouveau.conf"</span><span id="7831" class="mq lf it mm b gy mv ms l mt mu"># If the module is in the kernel, disable it<br/>sudo bash -c "echo options nouveau modeset=0 &gt;&gt; /etc/modprobe.d/blacklist-nvidia-nouveau.conf"</span><span id="4fd0" class="mq lf it mm b gy mv ms l mt mu"># Persist these settings on each boot<br/>sudo update-initramfs -u</span></pre><p id="1e5a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们可以开始构建和应用驱动程序了。为了使过程更简单，让我们安装dkms。这将有助于收集构建驱动程序所需的依赖关系。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="e191" class="mq lf it mm b gy mr ms l mt mu">sudo apt install dkms</span></pre><p id="f071" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们需要下载并安装适当的驱动程序。关于显示驱动程序和支持哪些补丁的更新列表，请查看<a class="ae kf" href="https://github.com/keylase/nvidia-patch" rel="noopener ugc nofollow" target="_blank"> keylase/nvidia-patch </a>(下面的代码就是从这里提取的)。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="fabc" class="mq lf it mm b gy mr ms l mt mu"># Create a driver directory<br/>sudo mkdir /opt/nvidia &amp;&amp; cd /opt/nvidia</span><span id="5a91" class="mq lf it mm b gy mv ms l mt mu"># Download the files (this example uses driver 515.57)<br/>sudo wget https://international.download.nvidia.com/XFree86/Linux-x86_64/515.57/NVIDIA-Linux-x86_64-515.57.run</span><span id="0343" class="mq lf it mm b gy mv ms l mt mu"># Make the build script executable <br/>sudo chmod +x ./NVIDIA-Linux-x86_64-515.57.run</span><span id="e696" class="mq lf it mm b gy mv ms l mt mu"># Build the driver<br/>sudo ./NVIDIA-Linux-x86_64-515.57.run</span></pre><p id="4f55" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">安装驱动程序后，我们应该能够用<code class="fe mw mx my mm b">nvidia-smi</code>检查它，它应该产生如下输出:</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/d7a0c6566be78b59fee2a383eafaec32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9g4KCSsjfZ_MnV4jU1tXHA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来源:我</figcaption></figure><h1 id="9b9d" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">修补驱动程序</h1><p id="c1d2" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">现在，我们可以修补驱动程序，以便解锁代码转换限制。要做到这一点，你需要在你的服务器上安装Git(sudo apt安装Git)。如果你在下面的步骤中遇到问题，你应该检查源repo:<a class="ae kf" href="https://github.com/keylase/nvidia-patch" rel="noopener ugc nofollow" target="_blank">keylase/NVIDIA-patch</a>。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="5429" class="mq lf it mm b gy mr ms l mt mu"># Optional if you want to start in your home directory<br/>cd ~</span><span id="b787" class="mq lf it mm b gy mv ms l mt mu"># Clone down the patch scripts<br/>git clone <a class="ae kf" href="https://github.com/keylase/nvidia-patch.git" rel="noopener ugc nofollow" target="_blank">https://github.com/keylase/nvidia-patch.git</a></span><span id="bbd4" class="mq lf it mm b gy mv ms l mt mu"># Navigate into the repo folder with the patches<br/>cd nvidia-patch</span><span id="376e" class="mq lf it mm b gy mv ms l mt mu"># Ensure the patch is executable<br/>sudo chmod +x patch.sh</span><span id="1ae9" class="mq lf it mm b gy mv ms l mt mu"># Execute the patch (needs to be done in a bash shell)<br/>sudo bash ./patch.sh</span></pre><h1 id="bfa0" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">安装Nvidia容器运行时</h1><p id="9d2a" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">Nvidia的容器运行时现在包含在他们的工具项目中。为此，我们必须将签名密钥添加到我们的系统包管理器(apt)中。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="bad3" class="mq lf it mm b gy mr ms l mt mu"># Adding the signing key to apt<br/>curl -s -L https://nvidia.github.io/nvidia-container-runtime/gpgkey | \<br/>  sudo apt-key add -</span><span id="3e20" class="mq lf it mm b gy mv ms l mt mu"># Create a variable with our distribution string<br/>distribution<strong class="mm iu">=</strong>$(. /etc/os-release;echo $ID$VERSION_ID)</span><span id="b4d3" class="mq lf it mm b gy mv ms l mt mu"># Install the appropriate package list for our distribution<br/>curl -s -L https://nvidia.github.io/nvidia-container-runtime/$distribution/nvidia-container-runtime.list | \<br/>  sudo tee /etc/apt/sources.list.d/nvidia-container-runtime.list</span></pre><p id="1c31" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在它已经被添加到我们的apt源列表中，我们可以运行下面的命令来安装它。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="ad56" class="mq lf it mm b gy mr ms l mt mu">sudo apt-get update <strong class="mm iu">\</strong><br/>    &amp;&amp; sudo apt-get install -y nvidia-container-toolkit</span></pre><p id="33cb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">安装完成后，您已经成功安装了容器运行时！我们就要到达终点了！到目前为止，我们已经安装了我们的Nvidia驱动程序，安装了我们的特殊容器运行时，这将允许我们使用GPU的容器。现在我们必须配置K3来使用这个容器运行时和containerd CRI(容器运行时接口)。</p><h1 id="8c3d" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">配置containerd以使用Nvidia-Container-Runtime</h1><p id="06bf" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">最后，让我们的GPU与Kubernetes协同工作的最后一步。在这里，我们将对containerd的CRI做一些修改，以便它将使用我们新的nvidia-contianer-runtime。要查看原始文档，请查看Nvidia的指南<a class="ae kf" href="https://github.com/NVIDIA/k8s-device-plugin" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="5a92" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将首先在您选择的文本编辑器(如vi、vim、nano)中打开/etc/containerd/config.toml。打开它后，我们将添加以下块:</p><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="908c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，如果有一个包含“disabled_plugins = ["cri"]”的long，我们需要在它前面加上#来注释掉它。现在我们可以重新启动containerd服务了，比赛开始了！</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="da6a" class="mq lf it mm b gy mr ms l mt mu">sudo systemctl restart containerd</span></pre><p id="be96" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您应该能够调度节点来请求GPU资源了！确保跟随更多的指南，如果你喜欢这种类型的内容，请查看我的YouTube！</p><div class="nc nd gp gr ne nf"><a href="https://www.youtube.com/channel/UC3brzz477MWmsEBefKQukcA" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">大卫·蒂皮特</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">与朋友、家人和全世界分享您的视频</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">www.youtube.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt jz nf"/></div></div></a></div></div></div>    
</body>
</html>