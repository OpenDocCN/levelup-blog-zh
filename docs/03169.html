<html>
<head>
<title>Internal DNS Using Route53 And Wireguard</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Route53和Wireguard的内部DNS</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/internal-dns-using-route53-and-wireguard-a4d6196f9481?source=collection_archive---------6-----------------------#2020-04-23">https://levelup.gitconnected.com/internal-dns-using-route53-and-wireguard-a4d6196f9481?source=collection_archive---------6-----------------------#2020-04-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/4bcd13a3b0ebf6c9798ab284ae9e99d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ynMbUejWaiDfVs-gJylmwA.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@scienceinhd?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">科学高清照片</a>在<a class="ae kf" href="https://unsplash.com/s/photos/servers?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="6132" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Wireguard棒极了。很好用，很容易配置，而且<a class="ae kf" href="https://medium.com/@hkdb/wireguard-vs-openvpn-910c3558184c" rel="noopener">超快</a>。自从Wireguard第一次被引入以来，它就越来越受欢迎，随着它被纳入Linux内核，使用量也在不断增加。</p><p id="5c60" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您在家中或小型办公室使用Wireguard，则可以轻松地手动管理隧道两端的端点和主机。如果您在大型企业中实施Wireguard，您可能希望使用某种形式的内部DNS来处理许多主机名条目。</p><p id="cfc1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用像Bind或Windows Server DNS这样的本地DNS服务器对于那些本地资源来说是很好的，但是如果您没有<em class="le">本地服务器呢？</em></p><p id="4d91" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在AWS中实现带有Wireguard的内部DNS解析器非常简单，并且使管理所有这些资源变得更加容易。让我们看看如何使用Wireguard和AWS Route53 DNS进行设置。</p><h2 id="bcf7" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">先决条件</h2><p id="eedf" class="pw-post-body-paragraph kg kh it ki b kj ly kl km kn lz kp kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">本文假设您已经在客户端主机和AWS EC2中的至少一个实例上实现了Wireguard。您应该能够通过Wireguard隧道到达EC2实例和该实例所在的VPC。</p><p id="0850" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您目前只能到达终止于隧道另一端的EC2实例，那么您可能需要在该实例上启用路由。通过编辑<code class="fe md me mf mg b">/etc/sysctl.conf</code>并添加:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="5d51" class="lf lg it mg b gy mp mq l mr ms">net.ipv4.ip_forward = 1</span></pre><p id="053d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您需要帮助从头开始设置Wireguard，Wireguard团队有一个很好的快速入门工具<a class="ae kf" href="https://www.wireguard.com/quickstart/" rel="noopener ugc nofollow" target="_blank">在这里</a>。</p><h2 id="e3fe" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">创建私有托管区域</h2><p id="b20d" class="pw-post-body-paragraph kg kh it ki b kj ly kl km kn lz kp kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">为了在Route53中添加内部DNS条目，您需要创建一个私有托管区域。访问Route53控制台并选择<em class="le">托管区域</em>开始。</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/2f2fc63c0c11d697f8c23229bb5dcd67.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/1*mc-71dnAUrZj2B1A7ama6w.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在Route53控制台中创建私有托管区域。</figcaption></figure><p id="6355" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择一个新域名(仅限内部),并给它一个TLD，以区别于其他公共区域。的”。“内部”域经常用于此目的。这是有趣的部分，你可以选择任何你想要的内部域名，因为它不会公开解析。</p><p id="426d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确保您选择了“<em class="le">亚马逊VPC的私人托管区域</em>”作为类型，然后输入您想要与该区域关联的VPC ID。</p><p id="d964" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦创建了新的区域，您可以随意向其中添加一些记录。您可以添加一些"<em class="le"> A </em>记录或"<em class="le"> CNAMEs </em>"指向VPC内部的实例或服务。</p><p id="d99b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">关于配置私有托管区域的更多细节可以从Amazon <a class="ae kf" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-creating.html" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><h2 id="5b71" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">添加入站VPC端点</h2><p id="00e6" class="pw-post-body-paragraph kg kh it ki b kj ly kl km kn lz kp kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">为了实际解析您新创建的DNS名称，您需要指向一个解析器IP。为了进行内部解析，您需要一个“<em class="le">入站解析器端点</em>”。</p><p id="2398" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">端点实际上是您选择的VPC内的一个IP地址，充当专用区域的解析器。这类似于当你改变一个客户端的DNS设置到谷歌的<em class="le">8.8.8.8</em>解析器，但是你却指向你自己的云解析器。</p><p id="6823" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">继续创建一个新的入站端点(<em class="le">入站</em>意味着解析器请求将来自您的私有网络，指向VPC)。</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mu"><img src="../Images/e1d25351905587cb2bf9d71191331c26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e0Ny3KOg9XThZU3PqWgBlw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在Route53控制台中创建新的入站端点。</figcaption></figure><p id="f17e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在命名新端点、选择它应该驻留的VPC并分配安全组之后，我们需要为端点提供IP地址。您可以选择自动生成IP，但是因为我们希望始终将客户端指向同一个解析器，所以我们在这里选择一些静态IP。</p><p id="a965" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确保使用每个子网和可用性区域内的有效IP地址，并且不要与其他正在使用的地址重叠。</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mv"><img src="../Images/09ef3b9a097426451777ddf01afc8d68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rPQ_jwtkzNc3ti1hi8t6TA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在Route53控制台中向入站端点添加IP地址。</figcaption></figure><p id="79e0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成IP地址部分后，您应该准备好完成端点设置过程。单击“提交”后，您需要等待，直到终端完全运行。</p><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/777b8966730fddd393618a4a10381c27.png" data-original-src="https://miro.medium.com/v2/resize:fit:454/format:webp/1*Mm4OrWAEcFNX79T84_z-vw.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Route53控制台中的VPC端点状态。</figcaption></figure><p id="3d50" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦获得许可，就该继续前进，配置Wireguard客户端使用新端点进行解析了。</p><h2 id="1e8b" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">将端点添加到Wireguard配置</h2><p id="2444" class="pw-post-body-paragraph kg kh it ki b kj ly kl km kn lz kp kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">如果你在Mac上工作，并且使用App Store 中可用的<a class="ae kf" href="https://apps.apple.com/us/app/wireguard/id1451685025?mt=12" rel="noopener ugc nofollow" target="_blank"> Wireguard应用程序(你应该这样做)，配置很简单。打开Wireguard应用程序，在您现有的VPN隧道上单击“<em class="le">编辑</em>”。</a></p><p id="2b09" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您需要在<em class="le">接口</em>部分下添加一个DNS条目。将<code class="fe md me mf mg b">&lt;INBOUND_RESOLVER_ENDPOINT&gt;</code>替换为新端点的IP地址，如下所示:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="4035" class="lf lg it mg b gy mp mq l mr ms">DNS = &lt;INBOUND_RESOLVER_ENDPOINT&gt;</span></pre><figure class="mh mi mj mk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mx"><img src="../Images/e6b454f96998805e35bcc7c54fa66ea4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s37W2DerI4lt3KimZFkNIg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在Mac OS上配置Wireguard。</figcaption></figure><p id="a0d0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">配置更新后，继续保存。隧道应该会自动重新建立连接。</p><p id="c9d2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您在Linux上工作，配置会根据您如何建立隧道而变化。要使用DNS密钥，您需要使用<code class="fe md me mf mg b">wg-quick</code>来建立连接。如果你正在开发基于Debian的发行版，这里的指南<a class="ae kf" href="https://wiki.debian.org/WireGuard?action=show&amp;redirect=Wireguard#Step_2_-_Alternative_A_-_Manual_Configuration" rel="noopener ugc nofollow" target="_blank"/>概述了必要的步骤。参考<em class="le">步骤2:备选D </em>应提供正确的连接方法。</p><h2 id="e0e0" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">测试一下</h2><p id="e8ca" class="pw-post-body-paragraph kg kh it ki b kj ly kl km kn lz kp kq kr ma kt ku kv mb kx ky kz mc lb lc ld im bi translated">更新Wireguard配置并重启通道后，您现在应该能够执行查询了。尝试在私有区域的DNS记录上运行<code class="fe md me mf mg b">dig</code>或<code class="fe md me mf mg b">ping</code>，以确保正确进行解析。</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="260f" class="lf lg it mg b gy mp mq l mr ms">dig host.mydomain.internal</span><span id="3091" class="lf lg it mg b gy my mq l mr ms">ping host.mydomain.internal</span></pre><p id="ccfe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者，您也可以尝试通过SSH使用FQDN直接连接到实例。</p><p id="3052" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果一切正常，你应该能够通过Wireguard隧道从你的私有区域解析DNS记录。现在，您可以将任何仅供内部使用的资源添加到该区域，客户端只有在连接到隧道时才能解析这些资源。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><p id="698c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">感谢阅读！如果你喜欢学习更多关于配置Wireguard的知识，请查看</em><a class="ae kf" href="https://www.wireguard.com/" rel="noopener ugc nofollow" target="_blank"><em class="le">wireguard.com</em></a><em class="le">了解最新消息和更新。</em></p></div></div>    
</body>
</html>