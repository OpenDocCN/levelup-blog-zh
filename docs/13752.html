<html>
<head>
<title>First Try on Java Operator SDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">先试试Java Operator SDK</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/first-try-on-java-operator-sdk-5a07f30771de?source=collection_archive---------5-----------------------#2022-10-03">https://levelup.gitconnected.com/first-try-on-java-operator-sdk-5a07f30771de?source=collection_archive---------5-----------------------#2022-10-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6e46" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">java-operator-sdk上的演示，并与Kubebuilder进行比较</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0f4eaab4140aebeba4becdfe7171d8c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fF0ym-ohfQUBqNUNypQX2A.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">按作者</figcaption></figure><p id="f47a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我一直致力于Kubernetes操作符的开发，以促进集群管理。当开发一个操作符时，我们通常关注两点</p><ul class=""><li id="973b" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated"><strong class="la iu">定义一个CRD </strong>来管理需要的信息<code class="fe md me mf mg b">spec</code>，以及需要返回给用户的状态信息<code class="fe md me mf mg b">status</code>。</li><li id="c45e" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated"><strong class="la iu">定义一个自定义控制器</strong>，它是操作员的核心，可以在集群中自动运行，监视资源，执行<code class="fe md me mf mg b">create</code>、<code class="fe md me mf mg b">edit</code>等操作，并响应删除。</li></ul><blockquote class="mm mn mo"><p id="bd89" class="ky kz mp la b lb lc ju ld le lf jx lg mq li lj lk mr lm ln lo ms lq lr ls lt im bi translated">不需要编程。用户可以为CRD控制器选择任何语言。</p><p id="b652" class="ky kz mp la b lb lc ju ld le lf jx lg mq li lj lk mr lm ln lo ms lq lr ls lt im bi translated">—来自<a class="ae mt" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#choosing-a-method-for-adding-custom-resources" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/concepts/extend-kubernetes/API-extension/custom-resources/# chopping-a-method-for-adding-custom-resources</a></p></blockquote><p id="e0f0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我在上一篇文章<a class="ae mt" href="https://medium.com/swlh/kubernetes-operator-for-beginners-what-why-how-21b23f0cb9b1?source=your_stories_page-------------------------------------" rel="noopener"> <strong class="la iu"> <em class="mp">中详细介绍了操作符的实现——Kubernetes Operator for初学者——什么，为什么，如何</em> </strong> </a> <em class="mp">，</em>，其中我们在<a class="ae mt" href="https://github.com/kubernetes-sigs/kubebuilder" rel="noopener ugc nofollow" target="_blank"> Kubebuilder </a>框架之上构建了一个操作符。</p><p id="78e5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Go是开发操作符最常用的语言，但不是唯一的语言。Java在<a class="ae mt" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/#writing-operator" rel="noopener ugc nofollow" target="_blank">开发操作符</a>方面工作得很好，有自己的长处，这将在下面的演示中展示。读完这篇文章后，我希望你能了解如何用Java开发一个操作符，如何用Java操作符实现测试，以及Java与Go Kubebuilder的不同体验。</p><h1 id="04e8" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">开发一个Java运算符</h1><h2 id="c004" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated">Java运算符SDK</h2><blockquote class="mm mn mo"><p id="9adc" class="ky kz mp la b lb lc ju ld le lf jx lg mq li lj lk mr lm ln lo ms lq lr ls lt im bi translated">无论您是想构建自己运行的应用程序，还是想从Java代码中提供基础设施，Kubernetes操作符都是不错的选择。JAVA-OPERATOR-SDK基于Kubernetes客户端，将使JAVA开发者更容易接受这种新的自动化方式。</p></blockquote><p id="89d1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们的Java operator将基于<a class="ae mt" href="https://javaoperatorsdk.io/docs/getting-started" rel="noopener ugc nofollow" target="_blank"> Java Operator SDK </a> (JOSDK)框架，该框架有一个成熟的客户端库(fabric8)与Kubernetes API服务器进行交互。这是一个关键部分，因为运营商非常依赖API与集群进行交互。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/61fee48099624a7b067b9be803fcad2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NTZlQ2ws7virq-qr"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">–来自<a class="ae mt" href="https://javaoperatorsdk.io/docs/architecture-and-internals" rel="noopener ugc nofollow" target="_blank">架构和内部构件(javaoperatorsdk.io) </a></figcaption></figure><p id="6cd9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">JOSDK依赖于Kubernetes事件的观察和分发机制，有四个主要特性是在框架的引擎盖下完成的。</p><ul class=""><li id="a930" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">包装fabric8并对其进行配置，以侦听指定定制资源上的更改。</li><li id="8425" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">提供一个接口来实现特定资源类型的协调循环。</li><li id="11d1" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">以高效的方式安排变更事件的执行，并使用过滤器过滤掉不需要的事件。</li><li id="34c4" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">重试失败的协调。</li></ul><p id="c3d3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从图中我们可以看到，资源控制器是由框架实现的，<strong class="la iu">用户只需要实现业务逻辑相关的协调器</strong>。</p><h2 id="539f" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated">演示</h2><p id="9885" class="pw-post-body-paragraph ky kz it la b lb nz ju ld le oa jx lg lh ob lj lk ll oc ln lo lp od lr ls lt im bi translated">为了更好的比较，我将重现用Kubebuilder构建的<code class="fe md me mf mg b"><a class="ae mt" href="https://github.com/slaise/operator-test/blob/master/kubebuilder-test/api/v1/useridentity_types.go" rel="noopener ugc nofollow" target="_blank">UserIdentityV1</a></code>。</p><p id="0c34" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">构造代码</strong></p><p id="82e2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一般我们需要maven来构造一个Java项目，生成类似<code class="fe md me mf mg b">src/main/java, src/test</code>等文件结构。并且依赖项将由用户添加，因为JOSDK没有为快速生成提供maven架构。</p><p id="8a48" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我从<a class="ae mt" href="https://github.com/java-operator-sdk/java-operator-sdk/tree/main/sample-operators" rel="noopener ugc nofollow" target="_blank">样本操作符</a>中复制了一个“干净”的帧以节省我的精力。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/7bb15158a091c7e1aeb25531c2ef688e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/0*4Sr65VpD7OSN9hmW"/></div></figure><p id="8248" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">而<code class="fe md me mf mg b">pom</code>文件如下图，是我解开所有心结后的最终版本。例如，我添加了几个fabric8依赖项，这在文档中没有给出。如果您不熟悉fabric8开发，搜索它们需要时间。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="ea03" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">定义CRD </strong></p><p id="1404" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我已经通读了<code class="fe md me mf mg b">java-operator-sdk</code>的<a class="ae mt" href="https://javaoperatorsdk.io/docs/getting-started" rel="noopener ugc nofollow" target="_blank">入门</a>文档，但是没有找到脚手架工具。所以我参考sample-controller中的例子一步一步地添加代码。</p><ul class=""><li id="1b26" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">分别定义<code class="fe md me mf mg b">spec</code>和<code class="fe md me mf mg b">status</code>。所需的<code class="fe md me mf mg b">Role</code>信息在<code class="fe md me mf mg b">spec</code>中声明，运行状态和错误信息在<code class="fe md me mf mg b">status</code>中返回。</li><li id="44bc" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">定义CRD，扩展<code class="fe md me mf mg b">CustomResource</code>，实现<code class="fe md me mf mg b">Namespaced</code>接口。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="7878" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意以下几点。</p><ul class=""><li id="cb87" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated"><code class="fe md me mf mg b">fabric8</code>提供了一组元数据相关的注释。</li><li id="7578" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">验证可以添加到带有<code class="fe md me mf mg b">jsonProperty</code>和<code class="fe md me mf mg b">javax.validation.constraints</code>库的字段中，最终反映在CRD定义中，比如<code class="fe md me mf mg b">@NotNull</code>使得字段在CRD中被标记为<code class="fe md me mf mg b">required</code></li><li id="fa5c" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated"><code class="fe md me mf mg b">Namespaced</code>将CRD标记为<code class="fe md me mf mg b">namespace scope</code>或<code class="fe md me mf mg b">cluster scope</code>。</li></ul><p id="b8d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于一些Kubernetes的本土资源，可以参考fabric8提供的这张<a class="ae mt" href="https://github.com/fabric8io/kubernetes-client/blob/master/doc/CHEATSHEET.md" rel="noopener ugc nofollow" target="_blank">备忘单</a>。</p><p id="1975" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">生成CRD YAML </strong></p><p id="431a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了解决这个难题，在我没有找到用Java生成CRD·YAML的工具后，我花了大量时间阅读文档，以避免自己编写YAML。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/04cfa2714ff6214a1dd8bc29083975b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ADdG8jlXoQVJAg_e"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来自Unsplash，<a class="ae mt" href="https://unsplash.com/photos/eQ2Z9ay9Wws" rel="noopener ugc nofollow" target="_blank">@ rocinate _ 11</a></figcaption></figure><p id="f7f9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">幸运的是，我成功地在Java中找到了<a class="ae mt" href="https://github.com/fabric8io/kubernetes-client/blob/master/doc/CRD-generator.md" rel="noopener ugc nofollow" target="_blank">生成CRD</a>，在<code class="fe md me mf mg b">kubernetes-client/java</code>中找到了<a class="ae mt" href="http://java/generate-model-from-third-party-resources.md%20at%20master%20%C2%B7%20kubernetes-client/java%20(github.com)" rel="noopener ugc nofollow" target="_blank">反之亦然</a>。</p><ul class=""><li id="a69d" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">将以下依赖项添加到pom。</li></ul><pre class="kj kk kl km gt oi mg oj ok aw ol bi"><span id="2a88" class="nm mv it mg b gy om on l oo op">&lt;dependency&gt;<br/>    &lt;groupId&gt;io.fabric8&lt;/groupId&gt;<br/>    &lt;artifactId&gt;crd-generator-apt&lt;/artifactId&gt;<br/>    &lt;scope&gt;provided&lt;/scope&gt;<br/>&lt;/dependency&gt;</span></pre><ul class=""><li id="d857" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">运行<code class="fe md me mf mg b">mvn compile</code>。</li><li id="365f" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">将<code class="fe md me mf mg b">target/class/META-INF/fabric8/</code>下的<code class="fe md me mf mg b">&lt;plural&gt;.&lt;group&gt;-&lt;CRD spec version&gt;.yml</code>文件复制到<code class="fe md me mf mg b">k8s/</code>中。</li></ul><p id="47a9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">定义调解器</strong></p><p id="66f0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">到了这一段就放心了，轻松多了。</p><ul class=""><li id="caa2" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">实现<code class="fe md me mf mg b">Reconciler</code>接口的协调器方法。每次更新资源都会触发协调器的执行。这里我需要更新资源，生成相应的<code class="fe md me mf mg b">ClusterRoleBinding</code>并用<code class="fe md me mf mg b">fabric8</code>客户端保存，最后更新资源状态。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><ul class=""><li id="e14e" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">实现<code class="fe md me mf mg b">Cleaner</code>接口来处理删除。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="7a41" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">除了上面的两个基本功能，框架还提供了一些API和注释来帮助提高效率。</p><ul class=""><li id="a37f" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">实现<code class="fe md me mf mg b">ErrorStatusHandler</code>接口来处理错误状态，比如设置集群错误的解析，根据场景返回易于理解的错误消息。</li><li id="015d" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">通过<code class="fe md me mf mg b">MaxReconciliationInterval</code>界面控制对账间隔，避免过于频繁的调用。该注释需要加载到类中。</li><li id="7b92" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">使用<code class="fe md me mf mg b">GradualRetry</code>控制失败时的最大尝试次数，避免由于配置错误导致的APIServer过载。</li><li id="8570" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">用<code class="fe md me mf mg b">ObservedGenerationAware</code>接口设置<code class="fe md me mf mg b">ObservedGeneration</code>字段，这是对Kubernetes资源进行乐观锁定的有效控制方法。</li><li id="f519" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">使用<code class="fe md me mf mg b">RateLimited</code>注释控制更新频率，例如<code class="fe md me mf mg b">RateLimited(maxReconciliations = 2, within = 3, unit = TimeUnit.SECONDS)</code>限制调解器在3秒内最多更新两次。</li><li id="3fad" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">实现录取webhook。</li></ul><p id="3e2f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">更多功能请参考<a class="ae mt" href="https://javaoperatorsdk.io/docs/features" rel="noopener ugc nofollow" target="_blank">官方文档</a>及源代码。</p><p id="1607" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">定义主方法</strong></p><p id="862f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在到了最后一步，初始化协调器并定义Java main方法。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><h1 id="1a7b" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">测试Java操作符</h1><h2 id="8ce9" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated"><strong class="ak">单元测试</strong></h2><p id="6ca6" class="pw-post-body-paragraph ky kz it la b lb nz ju ld le oa jx lg lh ob lj lk ll oc ln lo lp od lr ls lt im bi translated">端到端测试需要5个步骤。</p><ul class=""><li id="f737" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">初始化一个<code class="fe md me mf mg b">KubernetesClient</code></li><li id="f288" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">执行一个<code class="fe md me mf mg b">AbstractOperatorExtension</code>，并注册协调</li><li id="f274" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">加载一个<code class="fe md me mf mg b">Role</code>到本地Kubernetes</li><li id="12d8" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">创建一个新的<code class="fe md me mf mg b">UserIdentity</code>，然后由客户端提交</li><li id="1f27" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">过一会儿验证</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="47e6" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated">部署测试</h2><p id="75d5" class="pw-post-body-paragraph ky kz it la b lb nz ju ld le oa jx lg lh ob lj lk ll oc ln lo lp od lr ls lt im bi translated">分6步将操作员部署到一个种类集群。</p><ul class=""><li id="bee1" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">创建一个类簇并切换kubecontext</li><li id="beca" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">用<code class="fe md me mf mg b">kubectl apply -f k8s/useridentities.identity.company.org-v1.yml</code>向集群提交本地CRD</li><li id="8b2a" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">用maven生成操作符图像。这里的<code class="fe md me mf mg b">jib-maven-plugin</code>用于在运行<code class="fe md me mf mg b">mvn install</code>或<code class="fe md me mf mg b">mvn jib:dockerBuilder</code>时将图像推送到docker</li><li id="0643" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">手动创建<code class="fe md me mf mg b">Deployment</code>并提交</li><li id="ebad" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">创建<code class="fe md me mf mg b">test-ns</code>名称空间，并将<code class="fe md me mf mg b">k8s/roles-test.yml</code>提交给集群创建<code class="fe md me mf mg b">Role</code></li><li id="a830" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">提交一个<code class="fe md me mf mg b">UserIdentity.yaml</code>来查看集群中创建的<code class="fe md me mf mg b">ClusterRolebinding</code></li></ul><h1 id="3858" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">Java操作符VS Kubebuilder操作符</h1><h2 id="53ae" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated">语言</h2><p id="63aa" class="pw-post-body-paragraph ky kz it la b lb nz ju ld le oa jx lg lh ob lj lk ll oc ln lo lp od lr ls lt im bi translated">JOSDK&lt;= Kubebuilder</p><p id="30df" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">The JOSDK enjoys the whole Java ecosystem, which has been established by many Internet companies due to Java’s 20-year prevalence. There is a complete set of processes, from maven parent, the test frameworks, to the integration of CI/CD, etc., and far richer third-party libraries. But, JOSDK relies mostly on fabric8, and cannot work well if the Kubernetes APIs are not encapsulated in fabric8.</p><p id="f0af" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">On the other hand, Kubebuilder is the first-class in the Kubernetes ecosystem, which is mainly built in Go. And it can quickly integrate various Kubernetes packages like  【T9】 , enabling the concentration on function development.</p><h2 id="769d" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated">Tools</h2><p id="bd17" class="pw-post-body-paragraph ky kz it la b lb nz ju ld le oa jx lg lh ob lj lk ll oc ln lo lp od lr ls lt im bi translated">JOSDK ** &lt; Kubebuilder *****</p><p id="fc80" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">JOSDK is weaker in this aspect. No code-generator was found, but only a <a class="ae mt" href="https://github.com/operator-framework/java-operator-plugins" rel="noopener ugc nofollow" target="_blank">Java-operator-plugin</a>，基于<a class="ae mt" href="https://github.com/operator-framework/operator-sdk" rel="noopener ugc nofollow" target="_blank"> operator-sdk </a>的工具。虽然我们可以按照<a class="ae mt" href="https://github.com/operator-framework/java-operator-plugins/blob/main/docs/tutorial.md" rel="noopener ugc nofollow" target="_blank">教程</a>快速启动一个项目来开发一个操作符，但是操作符只关注<code class="fe md me mf mg b">quarkus</code>，而不是我想要的原始Java操作符。</p><p id="c50f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Kubebuilder比JOSDK成熟得多，尽管JOSDK也提供了一些maven插件和fabric8生成器。从下表可以直接看出来。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="6123" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated">CRD定义</h2><p id="5d83" class="pw-post-body-paragraph ky kz it la b lb nz ju ld le oa jx lg lh ob lj lk ll oc ln lo lp od lr ls lt im bi translated">JOSDK*** &lt; Kubebuilder *****<br/> JOSDK在自动化方面做的很差。虽然提供了类似<code class="fe md me mf mg b">CustomResource</code>的接口，但是创建CRD对应的Java类仍然需要手动创建<code class="fe md me mf mg b">spec</code>和<code class="fe md me mf mg b">status</code>，即使没有特殊字段。由于缺少生成注释的工具，需要为<code class="fe md me mf mg b">APIGroup</code>和<code class="fe md me mf mg b">Version</code>添加注释。唯一的好处是一些注释很方便。</p><p id="39b6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">相反，Kubebuilder在生成CRD时需要较少的编码，因为代码生成和默认字段完全受Kubernetes原生包的支持。</p><h2 id="4625" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated"><strong class="ak">支持的功能</strong></h2><p id="b8ce" class="pw-post-body-paragraph ky kz it la b lb nz ju ld le oa jx lg lh ob lj lk ll oc ln lo lp od lr ls lt im bi translated">JOSDK **** &lt;= Kubebuilder *****</p><p id="a70a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">As to the functions supported, their biggest difference lies in what they actually implement: JOSDK implements the reconciler, and the controller is built into the framework and distributes requests according to events.</p><p id="1b89" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">While, Kubebuilder implements the controller, which runs automatically at intervals.</p><p id="1041" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Besides, their support for the following operations should also be noted.</p><ul class=""><li id="47d0" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated"><strong class="la iu">资源更新</strong>。它们基本上是相同的，框架做得最多。而<strong class="la iu"> JOSDK跳过</strong> <code class="fe md me mf mg b"><strong class="la iu">Get</strong></code>。</li><li id="be83" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated">Kubernetes本地资源的<strong class="la iu">读写</strong>。区别在于fabric8 API和Kubernetes原生API，尤其是控制器运行时API。Java需要更多的代码来创建和更新对象，比如getters和setters。</li><li id="751b" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated"><strong class="la iu">删除</strong>。JOSDK用独立的<code class="fe md me mf mg b">Cleaner</code>接口更优雅，而Kubebuilder用<code class="fe md me mf mg b">DeletionTimeStamp</code>和<code class="fe md me mf mg b">Finializer</code>处理。</li><li id="5cc1" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated"><strong class="la iu">调和控制</strong>。JOSDK有一个优秀的带有注释的设计；而Kubebuilder在控制器中处理它，比如使用<code class="fe md me mf mg b">ratelimit</code>。</li><li id="f3b2" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated"><strong class="la iu">依赖关系管理</strong>。maven的设计使得JOSDK所依赖的库很分散，从operator-framework到fabric8，再到testing，所需的许多API在文档中都找不到。而Kubebuilder的依赖性更少，一旦代码生成，基本上不需要额外的包。</li><li id="d410" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated"><strong class="la iu">错误处理</strong>。JOSDK有一个集中的异常处理，这使得协调逻辑更容易编写和测试。而Kubebuilder依赖于Go的错误处理，我们需要在调和过程中一步一步的处理。</li><li id="9565" class="lu lv it la b lb mh le mi lh mj ll mk lp ml lt lz ma mb mc bi translated"><strong class="la iu">网钩</strong>。JOSDK没有足够的权限支持webhooks。我们需要用拦截器实现webhook功能，除了一些CRD字段的验证。阅读此<a class="ae mt" href="https://github.com/java-operator-sdk/java-operator-sdk/issues/370" rel="noopener ugc nofollow" target="_blank">问题单</a>了解更多信息。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="998c" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated">测试支持</h2><p id="30eb" class="pw-post-body-paragraph ky kz it la b lb nz ju ld le oa jx lg lh ob lj lk ll oc ln lo lp od lr ls lt im bi translated">JOSDK ***** &gt; Kubebuilder</p><p id="0696" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">JOSDK为您提供了非常好的测试体验:模拟单元测试和E2E测试都得到完美支持；不需要使用容器或Kubernetes本地集群；IDE完美支持断点调试。况且Java更擅长远程调试。</p><p id="5440" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">相比较而言，Kubebuilder的测试支持较差，更依赖于其他Go包如<code class="fe md me mf mg b">ginkgo</code>。而且在调试和模仿方面也不如Java。</p><h2 id="5bda" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated">文件</h2><p id="a8c4" class="pw-post-body-paragraph ky kz it la b lb nz ju ld le oa jx lg lh ob lj lk ll oc ln lo lp od lr ls lt im bi translated">JOSDK * &lt; Kubebuilder ****</p><p id="2bdc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">JOSDK documentation lacks the information for developing an operator step by step. Instead, I have to search in Google to find what I need, especially the integration with other tools like  【T1】  and  【T2】 .</p><p id="8b6a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Kubebuilder has a super nice <a class="ae mt" href="https://kubebuilder.io/" rel="noopener ugc nofollow" target="_blank">步步doc </a>，这几乎涵盖了方方面面。</p><h1 id="1fe7" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">结论</h1><p id="1ce7" class="pw-post-body-paragraph ky kz it la b lb nz ju ld le oa jx lg lh ob lj lk ll oc ln lo lp od lr ls lt im bi translated">JOSDK的应用并不是那么广泛，主要是在Java社区内部的一些工具的操作员版本，比如Tomcat、Spark、Flink等。</p><p id="d059" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我个人会坚持使用Kubebuilder，不仅仅是因为来自Kubernetes社区的一流支持，还有代码和配置生成的有效性。但我也会密切关注JOSDK，看它如何演变。我相信一个完整的基于Kubernetes-Java的生态系统正在形成。</p><p id="607a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读！</p><h1 id="ced2" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">参考</h1><p id="21c5" class="pw-post-body-paragraph ky kz it la b lb nz ju ld le oa jx lg lh ob lj lk ll oc ln lo lp od lr ls lt im bi translated"><a class="ae mt" href="https://javaoperatorsdk.io/docs/features" rel="noopener ugc nofollow" target="_blank">https://javaoperatorsdk.io/docs/features</a></p><p id="2580" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae mt" href="https://github.com/fabric8io/kubernetes-client/blob/master/doc/CRD-generator.md" rel="noopener ugc nofollow" target="_blank">https://github . com/fabric 8 io/kubernetes-client/blob/master/doc/CRD-generator . MD</a></p><p id="c67b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae mt" href="https://github.com/fabric8io/kubernetes-client/blob/master/doc/CRD-generator.md" rel="noopener ugc nofollow" target="_blank">https://github . com/fabric 8 io/kubernetes-client/blob/master/doc/CRD-generator . MD</a></p><p id="6ad0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae mt" href="https://github.com/kubernetes-client/java/blob/master/docs/generate-model-from-third-party-resources.md" rel="noopener ugc nofollow" target="_blank">Java/generate-model-from-third-party-resources . MD at master kubernetes-client/Java(github.com)</a></p><p id="4dec" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae mt" href="https://developers.redhat.com/articles/2022/02/15/write-kubernetes-java-java-operator-sdk" rel="noopener ugc nofollow" target="_blank">https://developers . red hat . com/articles/2022/02/15/write-kubernetes-Java-Java-operator-SDK</a></p><p id="3d29" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae mt" href="https://github.com/operator-framework/java-operator-plugins/blob/main/docs/tutorial.md" rel="noopener ugc nofollow" target="_blank">https://github . com/operator-framework/Java-operator-plugins/blob/main/docs/tutorial . MD</a></p></div></div>    
</body>
</html>