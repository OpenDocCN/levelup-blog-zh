<html>
<head>
<title>Create Memory and Type-Safe Node.js Modules with Rust</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Rust创建内存和类型安全的Node.js模块</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/create-memory-and-type-safe-node-js-modules-with-rust-2c10bba92013?source=collection_archive---------5-----------------------#2021-11-17">https://levelup.gitconnected.com/create-memory-and-type-safe-node-js-modules-with-rust-2c10bba92013?source=collection_archive---------5-----------------------#2021-11-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/35fe7d56d0dbf0af261fff7eb8c0e5e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gEFok5bvshK0PZUATSajIQ.png"/></div></div></figure><p id="f810" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Node是开发应用程序最著名的平台之一，它运行在<a class="ae kz" href="https://v8.dev/" rel="noopener ugc nofollow" target="_blank"> V8 </a>引擎上，在web浏览器之外执行JavaScript代码。尽管Nodejs很受欢迎，也有异步或非阻塞行为等很酷的特性，但与Go和Rust等语言或框架相比，Nodejs并没有那么快。</p><p id="0d74" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">另一方面，Rust是一种强类型的编译语言，它有很多优秀的特性，比如闭包和匿名函数、丰富的<a class="ae kz" href="https://doc.rust-lang.org/std/" rel="noopener ugc nofollow" target="_blank">标准库(std) </a>、强类型、多态性、出色的构建系统以及包管理器<a class="ae kz" href="https://doc.rust-lang.org/cargo/" rel="noopener ugc nofollow" target="_blank"> Cargo </a>。Rust也是一种内存安全语言，因为它在编译时会进行内存检查。有了Rust的这些优点，你有没有想过，你能不能写JavaScript，但是要有Rust的类型和内存安全？。这就是霓虹灯发挥作用的地方。Neon允许你用Rust写JavaScript。</p><h1 id="41ae" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">氖是什么</h1><p id="9d34" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">Neon是一个库和工具链，用于将<a class="ae kz" href="https://www.rust-lang.org/en-US/" rel="noopener ugc nofollow" target="_blank"> Rust </a>嵌入到你的<a class="ae kz" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>应用和库中。Neon允许你编写类型安全、内存安全、无崩溃的本地节点模块，保证Rust的并行性和线程安全性。</p><h1 id="60a3" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">使用氖的好处</h1><p id="5eea" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">除了内存和类型安全之外，还有更多原因让你应该在Node中使用Rust嵌入。</p><ul class=""><li id="1a23" class="md me it kd b ke kf ki kj km mf kq mg ku mh ky mi mj mk ml bi translated">并行编程和线程</li><li id="d518" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">表演</li><li id="943a" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">访问特定于本机操作系统的库</li><li id="3358" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">通过货物进入Rust的生态系统</li></ul><p id="e133" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Neon还提供了一个命令行界面和与约定绑定的工作流，消除了构建原生节点模块的麻烦。</p><h1 id="0c25" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">探索Neon API</h1><p id="1099" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">让我们探索Neon的API，看看如何用Rust编写一个原生节点模块。首先，让我们看看howlet的句柄类型。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mr"><img src="../Images/5458ebc06b3f449d2016d639933bdbfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ea5jftFjVT3UD2EyfmeiDQ.jpeg"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">Neon中的JavaScript类型层次结构</figcaption></figure><ul class=""><li id="6579" class="md me it kd b ke kf ki kj km mf kq mg ku mh ky mi mj mk ml bi translated"><strong class="kd iu"> JsValue </strong>位于类型层次的顶端，可以引用任何JavaScript值。</li><li id="f87e" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated"><strong class="kd iu"> JsObject </strong>位于对象类型层次的顶端。对象类型都实现了Object trait，它允许获取和设置属性。像<strong class="kd iu"> JsFunction </strong>、<strong class="kd iu"> JsArray </strong>、<strong class="kd iu"> JsDate </strong>和<strong class="kd iu"> JsError </strong>这样的类型都属于本节<strong class="kd iu">的范畴。</strong></li><li id="dbaf" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated"><strong class="kd iu"> JsNumber </strong>、<strong class="kd iu"> JsBoolean </strong>、<strong class="kd iu"> JsString </strong>、<strong class="kd iu"> JsNull </strong>和<strong class="kd iu"> JsUndefined </strong>是内置的JavaScript数据类型，不是对象类型(原语类型)</li></ul><p id="b97e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，让我们继续看入口点<code class="fe na nb nc nd b"><strong class="kd iu">src/lib.rs</strong></code>文件。它将由main函数组成，main函数有一个名为<code class="fe na nb nc nd b"><a class="ae kz" href="https://docs.rs/neon/0.9.1/neon/attr.main.html" rel="noopener ugc nofollow" target="_blank"><strong class="kd iu">#[neon::main]</strong></a></code>的特殊neon注释，在模块加载时执行(在Neon模块中初始化)。只要保留这个注释，您可以根据需要重命名该函数。它将是您的模块的入口点。</p><pre class="ms mt mu mv gt ne nd nf ng aw nh bi"><span id="5d7a" class="ni lb it nd b gy nj nk l nl nm"><strong class="nd iu">#[neon::main]</strong><br/>fn <strong class="nd iu">main</strong>(mut cx: <strong class="nd iu">ModuleContext</strong>) -&gt; <strong class="nd iu">NeonResult</strong>&lt;()&gt; {<br/>    cx.export_function("hello", hello)<strong class="nd iu">?</strong>;<br/>    Ok(())<br/>}</span><span id="12d4" class="ni lb it nd b gy nn nk l nl nm">fn <strong class="nd iu">hello</strong>(mut cx: <strong class="nd iu">FunctionContext</strong>) -&gt; <strong class="nd iu">JsResult</strong>&lt;<strong class="nd iu">JsString</strong>&gt; {<br/>    Ok(cx.string("hello node"))<br/>}</span></pre><p id="6d57" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由main方法导出的hello函数将接受一个名为<code class="fe na nb nc nd b"><a class="ae kz" href="https://docs.rs/neon/0.9.1/neon/context/type.FunctionContext.html" rel="noopener ugc nofollow" target="_blank"><strong class="kd iu">FunctionContext</strong></a></code>的参数(它为Neon函数提供了对JavaScript运行时的访问)并返回一个JavaScript字符串。你会注意到所有的neon函数都会返回一个名为<code class="fe na nb nc nd b"><a class="ae kz" href="https://docs.rs/neon/0.9.1/neon/result/type.JsResult.html" rel="noopener ugc nofollow" target="_blank"><strong class="kd iu">JsResult</strong></a></code>的类型，这是因为所有的Neon函数都有可能抛出一个JavaScript异常。</p><h1 id="31ed" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">构建Nodejs模块</h1><p id="dd7a" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">让我们通过构建一个节点模块来深入了解Neon。在这个例子中，让我们创建一个模块，它提供生成形状(正方形、圆形、三角形等)面积的函数。).但在我们开始之前，我们有一些先决条件，你需要Nodejs和Rust的最新版本或LTS版本(<a class="ae kz" href="http://visual studio build tools" rel="noopener ugc nofollow" target="_blank"> visual studio构建工具</a>如果你使用的是windows)。安装完所有的先决条件后，让我们继续初始化项目。</p><pre class="ms mt mu mv gt ne nd nf ng aw nh bi"><span id="4184" class="ni lb it nd b gy nj nk l nl nm">npm init <strong class="nd iu">neon</strong> neon-area</span></pre><p id="1ed5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以上命令将使用Cargo.toml和package.json文件初始化项目，这些文件包含Rust和Nodejs的包详细信息(依赖项、模块详细信息)。你会注意到在项目根目录下有一个名为<code class="fe na nb nc nd b"><strong class="kd iu">src/</strong></code>、<strong class="kd iu">、</strong>的新目录，它由一个名为lib.rs的文件组成，Rust的神奇之处就在这里。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div class="gh gi no"><img src="../Images/57528a9e12320586fb396574749fc7d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*RjrR66M8vyyNE7UqtU-gtg.png"/></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">霓虹灯项目结构</figcaption></figure><p id="10da" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个<code class="fe na nb nc nd b"><strong class="kd iu">src/lib.rs</strong></code>最初会是这样的。</p><pre class="ms mt mu mv gt ne nd nf ng aw nh bi"><span id="4ff9" class="ni lb it nd b gy nj nk l nl nm">use neon::prelude::*;</span><span id="204a" class="ni lb it nd b gy nn nk l nl nm">fn <strong class="nd iu">hello</strong>(mut cx: FunctionContext) -&gt; JsResult&lt;JsString&gt; {<br/>  Ok(cx.string("hello"))<br/>}</span><span id="4b12" class="ni lb it nd b gy nn nk l nl nm">#[neon::main]<br/>fn main(mut cx: ModuleContext) -&gt; NeonResult&lt;()&gt; {<br/> cx.export_function("hello", <strong class="nd iu">hello</strong>)?;<br/> Ok(())<br/>}</span></pre><p id="1ad5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在上面的代码中，您将导出一个函数，该函数返回一个字符串(在JavaScript中)作为一个名为“hello”的模块属性，稍后您可以通过javaScript导入该模块来访问它。要首先创建一个节点模块，您必须使用下面的命令构建上面的代码。</p><pre class="ms mt mu mv gt ne nd nf ng aw nh bi"><span id="6fbe" class="ni lb it nd b gy nj nk l nl nm">npm run build -- --release</span></pre><p id="d08e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将编译Rust代码，并在项目的根目录下创建一个名为index.node的本地节点模块。这些。节点文件是节点插件(二进制模块)，您应该能够使用JavaScript对它们使用“require()”来访问模块。</p><pre class="ms mt mu mv gt ne nd nf ng aw nh bi"><span id="15b1" class="ni lb it nd b gy nj nk l nl nm">const {<strong class="nd iu">hello</strong>} = require("./index.node");</span><span id="69b9" class="ni lb it nd b gy nn nk l nl nm">console.log(<strong class="nd iu">hello</strong>()); // logs "hello" to the console</span></pre><p id="451f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在让我们继续使用Neon构建我们的区域模块。首先，让我们创建一个名为Area的结构，然后继续实现这些方法。</p><pre class="ms mt mu mv gt ne nd nf ng aw nh bi"><span id="b0a5" class="ni lb it nd b gy nj nk l nl nm">struct Area {<br/> pub pi: f64,<br/>}</span><span id="b064" class="ni lb it nd b gy nn nk l nl nm">impl Area {<br/> <br/> fn circle(&amp;self, radius: f64) -&gt; f64 {<br/>   return 2.00 * self.pi * radius;<br/> }</span><span id="2492" class="ni lb it nd b gy nn nk l nl nm"> fn squar(&amp;self, length: f64, width: f64) -&gt; f64 {<br/>   return length * width;<br/> }</span><span id="b6c0" class="ni lb it nd b gy nn nk l nl nm"> fn traingle(&amp;self, length: f64, width: f64, height: f64) -&gt; f64 {<br/>  let s: f64 = (length + width + height) / 2.0;<br/>  let area: f64 = s * (s - length) * (s - width) * (s - height);<br/>  return area.sqrt();<br/> }</span><span id="b340" class="ni lb it nd b gy nn nk l nl nm"> fn pentagon(&amp;self, length: f64) -&gt; f64 {<br/>  return ((f64::sqrt(5.00 * (5.00 + (2.00 * f64::sqrt(5.00))))) /   4.00) * (length * length);<br/> }</span><span id="f92c" class="ni lb it nd b gy nn nk l nl nm"> fn hexagon(&amp;self, length: f64) -&gt; f64 {<br/>  return (3.00 * f64::sqrt(3.00)) / 2.00 * length;<br/> }</span><span id="d2b2" class="ni lb it nd b gy nn nk l nl nm"> fn trapezium(&amp;self, length: f64, base: f64, height: f64) -&gt; f64 {<br/>  return (length * base) / 2.00 * height;<br/> }</span><span id="7acd" class="ni lb it nd b gy nn nk l nl nm">}</span></pre><p id="8faa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，让我们通过main方法将这些函数导出为一个模块。让我们看看<code class="fe na nb nc nd b"><strong class="kd iu">src/lib.rc</strong></code>文件的最终代码。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="82e6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，是时候再次构建模块并在JavaScript应用程序中使用生成的模块了。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="8836" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">执行上面的代码会在终端中产生类似这样的结果。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nr"><img src="../Images/b96c1ee1f23c9d05081b9210dfc93cc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X7qU9ZjOt3TA_HkIxGunGg.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">执行上述代码的输出</figcaption></figure><p id="d829" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你可以通过这个<a class="ae kz" href="https://github.com/TRomesh/neon-area" rel="noopener ugc nofollow" target="_blank"> Github repo </a>找到上面的源代码。如果你想要更多关于neon用法的例子，也可以通过这个<a class="ae kz" href="https://github.com/neon-bindings/examples/tree/main/examples" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><h1 id="0037" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结论</h1><p id="9f9c" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">由于Rust带来的类型和内存安全，Neon是编写原生节点模块的最佳方式之一。Neon还公开了用于调度异步事件的JavaScript事件循环，因此您可以在后台线程中运行昂贵或长时间的计算，而不会阻塞JavaScript线程。Neon在slack有一个很好的活跃的社区，在这里你可以分享和学习neon社区。你可以用Neon做更酷的东西，确保你浏览了他们的文档以获得更多信息。最后，感谢您花时间阅读本文。我想看看你下面的问题和评论。</p><p id="4558" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">干杯！</p><h1 id="d8ff" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">了解更多信息</h1><div class="ns nt gp gr nu nv"><a rel="noopener  ugc nofollow" target="_blank" href="/lets-go-and-build-an-application-with-grpc-c5b754400f64"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">让我们开始用gRPC构建一个应用程序</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">REST(表述性状态转移)架构让我们“结合”这种方法来构建像web…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj jz nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a rel="noopener  ugc nofollow" target="_blank" href="/lets-go-and-build-graphql-api-with-gqlgen-bfea2f346ea1"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">让我们开始用gqlgen构建Graphql API</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">Golang是过去十年中最受欢迎的编程语言之一，主要是因为它的快速…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="oe l"><div class="ok l og oh oi oe oj jz nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a rel="noopener  ugc nofollow" target="_blank" href="/build-your-own-self-hosted-ci-cd-workflow-with-github-actions-ec9ee1dcd800"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">使用GitHub操作构建您自己的自托管CI/CD工作流</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">GitHub引入了GitHub Actions，使开发人员能够直接从他们的GitHub库自动化工作流…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="oe l"><div class="ol l og oh oi oe oj jz nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a rel="noopener  ugc nofollow" target="_blank" href="/hookstate-the-simplest-state-management-tool-b02f7d3b01a4"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">最简单的状态管理工具</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">小型、最小、简洁、可扩展、基于钩子的状态管理库</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="oe l"><div class="om l og oh oi oe oj jz nv"/></div></div></a></div></div></div>    
</body>
</html>