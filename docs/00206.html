<html>
<head>
<title>IKS ALB/Ingress Controller Timeouts, Dropped Websocket Connections; IBM IKS Cheat Sheet #3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">IKS ALB/入口控制器超时，Websocket连接掉线；IBM IKS备忘单#3</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/iks-alb-ingress-controller-timeouts-dropped-websocket-connections-ibm-iks-cheat-sheet-3-f82da6a8aeec?source=collection_archive---------1-----------------------#2018-09-06">https://levelup.gitconnected.com/iks-alb-ingress-controller-timeouts-dropped-websocket-connections-ibm-iks-cheat-sheet-3-f82da6a8aeec?source=collection_archive---------1-----------------------#2018-09-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b334b0c5c6de247c7fc5b8042d1fa41d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b7YXb2TYtIWTnpvT"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@nevenkrcmarek?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Neven Krcmarek </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="75df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我有超时问题，IKS ALB过早掉线。我如何调整超时？我看到我的websocket连接在大约60秒后掉线…</p><p id="ef0d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">IKS ALB / Ingress控制器支持保活和Websocket连接。如果您看到过早断开连接，可能有许多不同的原因，但通常您会在堆栈的某个地方遇到超时。</p><p id="5751" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">调试时，请确保:</p><ul class=""><li id="8457" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">您使用的Internet连接没有任何不支持长期连接的代理或防火墙，</li><li id="c92d" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">从多个位置进行调试和测试，如家庭ISP、电话共享等。隔离行为是否一致。</li></ul><h1 id="a49e" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">超时设定</h1><p id="acd4" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">当您通过ALB / Ingress控制器连接到您的应用程序时，有两个配置超时的位置:</p><ol class=""><li id="d16d" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la ms lh li lj bi translated"><code class="fe mt mu mv mw b">[Client] ===(*client-side-timeout*)=== [ALB]</code> -默认值为8秒，但仅针对HTTP保活请求，通常不会干扰WS，但您可以测试一下。一旦在<code class="fe mt mu mv mw b">[Client]</code>和<code class="fe mt mu mv mw b">[ALB]</code>之间建立了连接，<code class="fe mt mu mv mw b">[ALB]</code>将打开一个到运行您的应用程序的<code class="fe mt mu mv mw b">[POD]</code>的新连接，因此在两者之间也有一个超时</li><li id="cff0" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la ms lh li lj bi translated"><code class="fe mt mu mv mw b">[ALB] ===(*upstream-side-timeout*)=== [Application POD]</code> -默认为60秒</li></ol><p id="cd0f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通常Websocket (WS)连接的问题(当<code class="fe mt mu mv mw b">[Application POD]</code>运行WS时)是与<code class="fe mt mu mv mw b">*upstream-side-timeout*</code>有关的。确认的最佳方式<a class="ae kc" href="https://console.bluemix.net/docs/containers/cs_troubleshoot_debug_ingress.html#errors" rel="noopener ugc nofollow" target="_blank">是检查ALB日志</a>。</p><p id="eb8d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您有两个选择:启用心跳(Websocket)，增加超时。</p></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><h1 id="ef63" class="lp lq iq bd lr ls ne lu lv lw nf ly lz ma ng mc md me nh mg mh mi ni mk ml mm bi translated">启用心跳(Websocket)</h1><p id="8738" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">最简单和最安全的方法是确保在Websocket应用程序中设置某种<strong class="kf ir">心跳，以确保<strong class="kf ir"> TCP连接保持活动状态</strong>。没有明显流量的长期TCP连接通常会被更激进的超时丢弃，这不仅可以发生在<code class="fe mt mu mv mw b">ALB</code>中，也可以发生在位于客户端前面的透明代理防火墙中。使用像WAMP这样的框架，你可以启用心跳。为了安全起见，建议间隔时间为58秒或更短。</strong></p></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><h1 id="5dfe" class="lp lq iq bd lr ls ne lu lv lw nf ly lz ma ng mc md me nh mg mh mi ni mk ml mm bi translated">增加超时</h1><p id="98fe" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">另一种选择是增加超时，只有当您知道网络中没有任何东西现在或将来会以更低的超时运行(透明代理、防火墙等)时，才建议使用这种方法。).</p><h2 id="f32e" class="nj lq iq bd lr nk nl dn lv nm nn dp lz ko no np md ks nq nr mh kw ns nt ml nu bi translated">我如何改变<code class="fe mt mu mv mw b">client-side-timeout</code>？</h2><p id="e5a9" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">相关官方文档可在此处找到:<a class="ae kc" href="https://console.bluemix.net/docs/containers/cs_ingress.html#perf_tuning" rel="noopener ugc nofollow" target="_blank"> <em class="nv">增加保活连接时间</em> </a>:</p><p id="b4c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 1。)</strong>编辑入口配置图</p><pre class="nw nx ny nz gt oa mw ob oc aw od bi"><span id="34e0" class="nj lq iq mw b gy oe of l og oh">$ kubectl edit cm ibm-cloud-provider-ingress-cm -n kube-system</span></pre><p id="4a5e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 2。)</strong>添加/更改<code class="fe mt mu mv mw b">keep-alive</code>值至您想要的值。(默认值为8s，默认情况下，此行不出现在配置图中。)</p><p id="8453" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">配置图中的<code class="fe mt mu mv mw b">keep-alive:</code>设置将改变<code class="fe mt mu mv mw b">ALB nginx</code>配置中的<code class="fe mt mu mv mw b">keepalive_timeout</code>设置。</p><pre class="nw nx ny nz gt oa mw ob oc aw od bi"><span id="4672" class="nj lq iq mw b gy oe of l og oh">apiVersion: v1<br/>data:<br/>  keep-alive: "300s"<br/>kind: ConfigMap<br/>metadata:<br/>  name: ibm-cloud-provider-ingress-cm<br/>  namespace: kube-system</span></pre><p id="40f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 3。)</strong>保存并验证:</p><pre class="nw nx ny nz gt oa mw ob oc aw od bi"><span id="b8bf" class="nj lq iq mw b gy oe of l og oh">$ kubectl get cm ibm-cloud-provider-ingress-cm -n kube-system -o yaml</span></pre><p id="43ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">另一种验证的方法，只是用你的名字替换你的ALB pod名字(要知道你的ALB名字是什么<a class="ae kc" href="https://medium.com/@ArpadKun/ibm-cloud-kubernetes-service-ingress-alb-cheat-sheet-1-basics-4fbc1c86b886" rel="noopener">在这里阅读我之前的帖子</a>或<a class="ae kc" href="https://console.bluemix.net/docs/containers/cs_troubleshoot_debug_ingress.html#errors" rel="noopener ugc nofollow" target="_blank">参见官方文档</a>):</p><pre class="nw nx ny nz gt oa mw ob oc aw od bi"><span id="34fe" class="nj lq iq mw b gy oe of l og oh">$ kubectl exec -ti <em class="nv">public-cr24a9f2caf6554648836337d240064935-alb2-5cbb674fd5-tff54</em> -n kube-system -c nginx-ingress -- grep -H -R keepalive_timeout /etc/nginx/nginx.conf</span><span id="e949" class="nj lq iq mw b gy oi of l og oh">/etc/nginx/nginx.conf:  keepalive_timeout 300s; # &lt;-- Changed, good</span></pre></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><h2 id="f97d" class="nj lq iq bd lr nk nl dn lv nm nn dp lz ko no np md ks nq nr mh kw ns nt ml nu bi translated">我如何改变<code class="fe mt mu mv mw b">upstream-side-timeout</code>？</h2><p id="c128" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">相关文档在这里可以找到<a class="ae kc" href="https://console.bluemix.net/docs/containers/cs_annotations.html#connection" rel="noopener ugc nofollow" target="_blank">，在这里你也可以学习如何应用注释。</a></p><p id="f069" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 1。)</strong>向入口资源添加以下注释，将60秒的默认值增加到300秒:</p><pre class="nw nx ny nz gt oa mw ob oc aw od bi"><span id="f8f7" class="nj lq iq mw b gy oe of l og oh">ingress.bluemix.net/proxy-read-timeout: "serviceName=&lt;YOUR SERVICE NAME&gt; timeout=300s"</span></pre><p id="a19f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mw b">proxy-read-timeout</code>注释将改变<code class="fe mt mu mv mw b">ALB nginx</code>配置中的<code class="fe mt mu mv mw b">proxy_ready_timeout</code>设置。</p><p id="29f0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 2。)</strong>如何检查配置是否生效？</p><pre class="nw nx ny nz gt oa mw ob oc aw od bi"><span id="32c9" class="nj lq iq mw b gy oe of l og oh">$ kubectl exec -ti public-cr24a9f2caf6554648836337d240064935-alb2-5cbb674fd5-tff54 -n kube-system -c nginx-ingress -- grep -H -R timeout /etc/nginx/conf.d/</span><span id="347f" class="nj lq iq mw b gy oi of l og oh">/etc/nginx/conf.d/default-source-ip-ingress.conf:              proxy_connect_timeout 60s;  # &lt;-- This stayed 60s, good and expected<br/>/etc/nginx/conf.d/default-source-ip-ingress.conf:              proxy_read_timeout 300s;    # &lt;-- Changed, we are good.</span></pre><p id="b00b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">更多有用的文章:<br/>—<a class="ae kc" href="https://medium.com/@ArpadKun/ibm-cloud-kubernetes-service-ingress-alb-cheat-sheet-1-basics-4fbc1c86b886" rel="noopener">IKS入口/ALB备忘单</a>上的有用命令。<br/> - <a class="ae kc" href="https://medium.com/@ArpadKun/how-can-i-isolate-do-maintenance-and-debug-an-alb-ingress-controller-ibm-iks-cheat-sheet-2-29dab86b9c7d" rel="noopener">如何隔离、维护和调试ALB/Ingress控制器</a></p></div></div>    
</body>
</html>