<html>
<head>
<title>Continuous integration and delivery in Azure Databricks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Databricks中的持续集成和交付</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/continuous-integration-and-delivery-in-azure-databricks-1ba56da3db45?source=collection_archive---------4-----------------------#2020-05-10">https://levelup.gitconnected.com/continuous-integration-and-delivery-in-azure-databricks-1ba56da3db45?source=collection_archive---------4-----------------------#2020-05-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="76eb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，您已经在Databricks工作区创建了笔记本，与您的同事进行了协作，现在您已经准备好实施您的工作了。以下是完整CI/CD工作流要执行的步骤。</p><ol class=""><li id="828c" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">在开发分支中开发并提交您的代码。</li><li id="8b16" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">将代码从开发分支推送到→测试分支→主分支。</li><li id="cedf" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">在不同的环境中部署笔记本电脑；在Azure DevOps中使用CI/CD管道进行开发→测试→生产。</li></ol><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/b83fb3722b3a39eb861e13d409344888.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BbsdIRaLlngO7yA9MsmlPA.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">0.1 Azure Databricks DevOps工作流</figcaption></figure><p id="9e2c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ls translated">根据需求，这里可以有不同种类的工作流程。在上面的工作流程中，我们直接在开发数据块工作区上工作，并将每个笔记本链接到git中用户特定的分支。一旦用户对变更感到满意，他们就可以从开发→测试分支创建一个拉请求。</p><p id="c70c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">最佳实践</strong></p><ol class=""><li id="827d" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">在开发数据块中的<strong class="js iu">用户</strong>工作区进行开发，并将每个笔记本链接到一个单独的特性分支。这样，多个开发人员可以在一个笔记本上工作，并且可以在创建从特性分支到开发分支的拉请求时解决合并冲突。如果只有一个开发人员在笔记本上工作，那么我们可以直接在development Databricks工作区上工作，如上面的工作流程图所示。</li><li id="eeaf" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">在开发、测试和主分支中设置<strong class="js iu">分支策略</strong>,以限制任何直接提交，并为拉请求批准添加自动审查者。</li><li id="7aac" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">启用发布管道中的<strong class="js iu">预部署批准</strong>，以限制在测试和生产工作区中未经批准的直接部署。</li><li id="f2ee" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">使用Azure KeyVault存储Azure Databricks帐户的个人访问令牌。</li><li id="f80e" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">在Azure DevOps管道中使用<strong class="js iu"> Linux托管代理</strong>。用户可以在Databricks workspace中拥有两个名为xyz和Xyz的笔记本，但Windows将它们视为单个文件(不区分大小写),并且无法区分它们，这可能会在使用Windows代理处理管道中的笔记本时造成问题。</li><li id="0242" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">参数化在不同环境中具有不同值的notebook变量，例如config值，以便在合并不同分支时值不会被覆盖。</li></ol></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="bece" class="mi mj it bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">1.开发并提交您的代码</h1><p id="cb36" class="pw-post-body-paragraph jq jr it js b jt ng jv jw jx nh jz ka kb ni kd ke kf nj kh ki kj nk kl km kn im bi translated">设计CI/CD管道的第一步是决定代码提交和分支策略，以管理新代码和更新代码的开发和集成，而不会对当前生产中的代码产生负面影响。这里，我们将使用<a class="ae nl" href="https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow" rel="noopener ugc nofollow" target="_blank"> GitFlow </a>分支模型。<br/>假设已经创建了Azure DevOps项目，并且我们在Databricks工作区中有一个笔记本的工作副本，让我们按照下面的步骤操作。</p><ol class=""><li id="aee5" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">Azure Databricks与Azure DevOps Repos的集成- <a class="ae nl" href="https://docs.microsoft.com/en-us/azure/databricks/notebooks/azure-devops-services-version-control" rel="noopener ugc nofollow" target="_blank"> Azure Databricks配置</a></li><li id="c240" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn kt ku kv kw bi translated">将Azure Repos git与Databricks workspace链接。<br/> <strong class="js iu">注:</strong>在修改历史时，笔记本不能编辑。</li></ol><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nm"><img src="../Images/5cafcae24cc565ddc3a780e0117cf585.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S6OANh-hRuHVvmMqinxjkA.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">1.1转到Azure Repos并复制存储库链接</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nn"><img src="../Images/67ae11b5ba9342a99589769064ac0504.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3crv7rqMyTYB1s4dIn6swQ.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">1.2转到Databricks笔记本，点击修订历史→ Git:未链接</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi no"><img src="../Images/49d8d4541a20d05f9ab18ccb4b6c2221.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jnElPA7-GWvt5RMGNaOS5w.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">1.3粘贴Azure Repos链接，在git repo中选择工作分支并填充绝对路径</figcaption></figure><blockquote class="np nq nr"><p id="6123" class="jq jr ns js b jt ju jv jw jx jy jz ka nt kc kd ke nu kg kh ki nv kk kl km kn im bi translated"><strong class="js iu"> <em class="it">注意:</em> </strong> <em class="it">第一次做这个的时候你不会看到所有的分支。所以，只需粘贴链接并点击</em> <strong class="js iu"> <em class="it">保存</em> </strong> <em class="it">按钮即可。不要向git提交任何提示。再次打开</em><strong class="js iu"><em class="it">Git:Synced</em></strong><em class="it">现在你将能够看到Azure Repos中的所有分支。<br/>使用</em><strong class="js iu"><em class="it">dev.azure.com/&lt;organization _ name&gt;</em></strong><em class="it">参观项目。您通过访问</em><strong class="js iu"><em class="it">&lt;organization _ name&gt;. visual studio . com</em></strong><em class="it">获得的克隆链接将无法与Azure Databricks git syncup一起使用。所以遵循这个URL模式</em><strong class="js iu"><em class="it">https://dev.azure.com/&lt;组织_名称&gt; / &lt;项目_名称&gt; /_git/ &lt;仓库_名称&gt; </em> </strong></p></blockquote><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nw"><img src="../Images/81d6a46227af26cea66a95ba57a8a22a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UDEZpoM9AqGT_4kk6XdXVw.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">1.4点击修订历史侧面板中的Save All并填写描述以提交给git</figcaption></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="f873" class="mi mj it bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">2.使用CI/CD管道将版本控制的笔记本部署到数据块上</h1><p id="d8ac" class="pw-post-body-paragraph jq jr it js b jt ng jv jw jx nh jz ka kb ni kd ke kf nj kh ki kj nk kl km kn im bi translated">既然提交的变更已经被推送到git存储库中，这意味着构建管道将被触发。通过一点点进一步的配置，我们实际上可以更新构建管道，将这个笔记本打包到一个可部署的包中，并使用它来触发部署管道。<br/>根据不同的使用案例，在构建流程中可以有不同的笔记本电脑打包方式。</p><p id="1ffe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">案例1: </strong> <strong class="js iu">完成笔记本部署<br/> </strong>将源分支中所有的笔记本打包。</p><p id="fba2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">案例2:仅部署最近提交中已更改的笔记本<br/> </strong>仅打包那些在源分支的最近提交中新添加或更改的笔记本。这将减少部署时间，不会覆盖未更改的笔记本电脑。</p><p id="9abd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">案例3:笔记本的自定义部署<br/> </strong>仅打包用户指定的笔记本，其绝对路径在构建时由逗号分隔的路径提供。</p><h1 id="1849" class="mi mj it bd mk ml nx mn mo mp ny mr ms mt nz mv mw mx oa mz na nb ob nd ne nf bi translated">在Azure DevOps中创建构建管道</h1><ul class=""><li id="437d" class="ko kp it js b jt ng jx nh kb oc kf od kj oe kn of ku kv kw bi translated">转到项目→生成→新生成管道</li></ul><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi og"><img src="../Images/615634244bac3072f3d7609c71300584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*60lGmooCbeTrtTBMovBPmg.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.1转到+新建→新建构建管道→使用经典编辑器</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi oh"><img src="../Images/c62258217a3a2d2752f58368a9904ada.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-RY3SRiXHT_a7W-6SQtsOw.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.2选择源→存储库名称→源分支</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi oi"><img src="../Images/1f2c1eb8ba4a576475ecf758d13ef59d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mtJ3cRISLygLhxyUFMNKEQ.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.3在可视化编辑器中选择空作业</figcaption></figure><p id="5510" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">案例1:笔记本电脑的完全部署</strong></p><ul class=""><li id="ba5c" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn of ku kv kw bi translated">添加发布构建项目任务。</li><li id="9ee3" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">提供笔记本的完整路径和工件名称(包含笔记本的可部署包)。</li><li id="3577" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">源分支中的所有笔记本都将作为工件发布。</li></ul><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi oj"><img src="../Images/7ed8c6796724e4b77985986146d9c921.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H87PNe2wmLVh8W6DKZmT9w.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.4使用托管代理Ubuntu 18.04</figcaption></figure><p id="89a6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">案例2:在最近一次提交中仅部署已更改的笔记本</strong></p><ul class=""><li id="c8f9" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn of ku kv kw bi translated">添加Bash脚本任务。</li><li id="8945" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">添加以下脚本。</li></ul><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="f365" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ls translated"><span class="l lt lu lv bm lw lx ly lz ma di"> T </span>他的脚本过滤出在最近一次提交中发生改变的文件的绝对路径，即在头0(最后一次提交)和头1(最后一次提交的父文件)之间的改变，然后将所有路径放入一个文本文件中，用新的一行隔开。它将从文本文件中读取绝对路径，并将其复制到托管代理计算机的临时目录中。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi om"><img src="../Images/ada670db076831c7a0f041f6d198110f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RC3HQPI5S8Laxw1PWm513w.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.5添加bash任务并编写Bash脚本</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi on"><img src="../Images/2e1146b9f4f7f241ab3121f4e609eb0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gWvmEpheSF9Vn-sDfZyp1g.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.6添加复制文件任务，将文件从源目录复制到工件暂存目录</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi om"><img src="../Images/f94b38274a62158f9e0ff44d52aad7be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pmle-Yxrd0YCVzp_riKcFw.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.7添加发布构建工件任务以发布可部署组件</figcaption></figure><p id="f04a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">案例3:笔记本电脑的定制部署</strong></p><ul class=""><li id="af7e" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn of ku kv kw bi translated">所有步骤将与情况2相同。唯一的区别将是下面提到的脚本。该脚本将从用户处获取一个以逗号分隔的绝对路径作为构建时变量，并将这些文件复制到托管代理计算机的临时目录中。</li></ul><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="ok ol l"/></div></figure><ul class=""><li id="cc49" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn of ku kv kw bi translated">转到构建管道中的变量选项卡，添加<strong class="js iu"><em class="ns">absolute path</em></strong><em class="ns"/>变量，并选择<strong class="js iu"> <em class="ns">可在队列时间设置</em> </strong>复选框。</li></ul><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi oo"><img src="../Images/85585fc14e9eb1a610e66290141fe7fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CA5JJFwShWDqU2khdMxMiA.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.8添加absolutePath变量，并选中“排队时可设置”复选框</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi op"><img src="../Images/40af117992a6cc68fe76413f93ef2875.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V7qsH7U7UPdZ70mSS8SJfA.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.9将构建管道排队→单击变量</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi oq"><img src="../Images/15d69e6b381412f6d7f45454a17e461e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zt5UTQp4w7QO2exJJZ3rhw.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.10选择absolutePath变量进行编辑。在此构建之后，它将恢复为默认值。它是一个运行时变量</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi or"><img src="../Images/bc4e74be741f4153c7fc79f8fcd8f5c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*itMQ0vSxU7ZX5pyFdjk1hA.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.11提供逗号分隔的绝对路径，然后单击更新</figcaption></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="57ea" class="mi mj it bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">在Azure DevOps中创建发布管道</h1><ul class=""><li id="2472" class="ko kp it js b jt ng jx nh kb oc kf od kj oe kn of ku kv kw bi translated">转到项目→发布→新发布管道</li></ul><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi os"><img src="../Images/cfa6bad0a0206675432a065162a90c5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Aazgb-FstpkS5lTOb15Uw.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.12点击+新建→新发布管道</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ot"><img src="../Images/3cb8f07707bb913de0013a48f6724539.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gY3Kq4A8BlhpyglUZ3sKKQ.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.13选择空作业并编辑发布管道的名称</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ou"><img src="../Images/4fb745f37f6d84d241d049bf1a0e0698.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N5bVivnbo8EkBf15q6YbfA.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.14添加工件→构建管道→默认版本为最新版本→给出任何源别名(将在后面的步骤中使用)</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ov"><img src="../Images/73e8f06e775979e79c9848f302cd258f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k97UcZ8t7JsQ6wErj60JGQ.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.15启用连续部署触发器</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ow"><img src="../Images/ddaf1d3216898d32150ba781110f12f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UF2lEQhIO_EdVTm_V8bTxQ.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.16添加预部署批准</figcaption></figure><blockquote class="np nq nr"><p id="1473" class="jq jr ns js b jt ju jv jw jx jy jz ka nt kc kd ke nu kg kh ki nv kk kl km kn im bi translated">我们将使用<a class="ae nl" href="https://docs.databricks.com/dev-tools/cli/index.html" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">Databricks CLI</strong></a>将data bricks笔记本从托管代理机器(Ubuntu 18.04)导入我们的Azure Databricks资源。Databricks CLI要求在代理计算机上安装python。因此，我们将首先安装python，然后安装Databricks CLI。</p></blockquote><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi og"><img src="../Images/ee5f39d5f55537fc29bf1ad6d7455009.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iyE899PPd7aQp8ziK0GKsQ.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.17添加使用Python版本任务→选中添加到路径复选框</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ox"><img src="../Images/dbffbf1e918e026d82efb543a5b0f888.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FR1uQbI3bBe2-0Rghmzg0w.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.18添加bash任务并编写Bash脚本来安装Databricks CLI</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi oy"><img src="../Images/ce370615284e4665a18ca7a4981ff215.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bBIa5H2px-Fz1sI16tpaGA.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.19添加Bash任务并编写脚本来使用个人访问令牌配置数据块(将在后面的步骤中创建PAT)</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi oz"><img src="../Images/c189b2cf112e5c890a30ca619a94e95c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9nvuZjhfXvZdMAMt2phhfA.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.20添加Bash任务并编写import_dir CLI命令来导入数据块笔记本</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi pa"><img src="../Images/55d06a3bb98d766a378c8af21c356fab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hQusnkot03g3InjWdvAB0A.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">2.21转到变量选项卡，添加PAT和Databricks区域URL。使用锁定按钮来锁定密码</figcaption></figure><h1 id="f9ba" class="mi mj it bd mk ml nx mn mo mp ny mr ms mt nz mv mw mx oa mz na nb ob nd ne nf bi translated">上述Bash任务中使用的脚本</h1><ul class=""><li id="4d03" class="ko kp it js b jt ng jx nh kb oc kf od kj oe kn of ku kv kw bi translated">安装Databricks CLI</li></ul><pre class="ld le lf lg gt pb pc pd pe aw pf bi"><span id="6f48" class="pg mj it pc b gy ph pi l pj pk">python -m pip install --upgrade pip setuptools wheel databricks-cli</span></pre><ul class=""><li id="ad1d" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn of ku kv kw bi translated">使用个人访问令牌配置Databricks CLI</li></ul><pre class="ld le lf lg gt pb pc pd pe aw pf bi"><span id="af0e" class="pg mj it pc b gy ph pi l pj pk">databricks configure — token &lt;&lt;EOF<br/>$(databricks-url)<br/>$(ADB-Token)<br/>EOF</span></pre><ul class=""><li id="3e0b" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn of ku kv kw bi translated">将笔记本从托管代理计算机导入到Databricks工作区</li></ul><pre class="ld le lf lg gt pb pc pd pe aw pf bi"><span id="f7c8" class="pg mj it pc b gy ph pi l pj pk">databricks workspace import_dir — overwrite _Build_Pipeline_Alias/artifactName /FolderNameInDatabricksWorkspace</span></pre><p id="2903" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里，<strong class="js iu"> _Build_Pipeline_Alias </strong>是在发布管道工件中作为源别名给出的名称(参见2.14)；artifactName是发布构建工件任务中提供的名称(参见2.7)，而<strong class="js iu">foldernameindatabrickworkspace</strong>是DatabricksWorkspace中我们要部署笔记本的文件夹。</p><ul class=""><li id="6aa4" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn of ku kv kw bi translated">如果同名笔记本已经存在，它将覆盖所有笔记本。</li><li id="c2b4" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">如果不存在，它会添加笔记本。</li><li id="bba5" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">如果在Git中重命名笔记本，那么它只会添加一个新的笔记本，而不会删除旧的。</li><li id="6ca9" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">它会创建文件夹，如果它不存在。</li></ul></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="56b1" class="mi mj it bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">3.添加分支策略</h1><p id="80ad" class="pw-post-body-paragraph jq jr it js b jt ng jv jw jx nh jz ka kb ni kd ke kf nj kh ki kj nk kl km kn im bi translated">制定<a class="ae nl" href="https://docs.microsoft.com/en-us/azure/devops/repos/git/branch-policies?view=azure-devops" rel="noopener ugc nofollow" target="_blank">分支政策</a>以保护你的回购中的关键分支，团队依赖这些分支保持良好状态，比如你的<em class="ns">主</em>分支。需要拉请求来对这些分支进行任何更改。开发人员将变更直接推送到受保护的分支将会被拒绝。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ow"><img src="../Images/e076a241f59c38ef31b631ce86e82809.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iR9iA1DRIQZbmEMOQEJyFQ.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">3.1转到Azure回购→分行→分行政策</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi pl"><img src="../Images/82a963060a85bd3a5bfed02134882360.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1lxuUJcwTlNfrlbvdDKq9A.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">3.2选择要求最少数量的审阅者以限制受限分支中的直接提交</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi pm"><img src="../Images/17b7df28c8323e89cbf9d2af6fd3d72e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*geI4BSTZQFumk0PtmaJ6Iw.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">3.3添加自动审阅者在创建从任何分支到该分支的拉请求时自动添加他们</figcaption></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="4b17" class="mi mj it bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">4.生成个人访问令牌</h1><p id="4d2f" class="pw-post-body-paragraph jq jr it js b jt ng jv jw jx nh jz ka kb ni kd ke kf nj kh ki kj nk kl km kn im bi translated">将托管代理计算机与data brick工作区连接需要data brick个人访问令牌。</p><ul class=""><li id="ac8b" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn of ku kv kw bi translated">转到Azure Databricks工作区→用户设置</li></ul><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi pn"><img src="../Images/38d4903eb1912a5050f432bc449e6112.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nOsQ4ZkkL_DLsNNt2dmgtA.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">4.1转到Azure Databricks工作区中的用户设置</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi po"><img src="../Images/25ea7f434a1a613e45295b3882edef42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ktOfLrUBh_YlOEc5j5QXJA.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">4.2单击生成新令牌。令牌是用户特定的</figcaption></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi pp"><img src="../Images/8104fb0552702aa439e1ad9995eb35ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5UwWAY4ez3ESfcu-sEqWiQ.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">4.3为令牌提供一个有意义的名称和生命周期。如果未指定令牌寿命，令牌将无限期存在</figcaption></figure><ul class=""><li id="3b73" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn of ku kv kw bi translated">点击Generate，将生成的字符串复制到安全的地方(最好是Azure KeyVault)。一旦生成，就无法再次检索。微软不存储这些令牌。</li></ul></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="5845" class="mi mj it bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">5.如果我们已经有了一个正在运行的Databricks项目，并希望使用Azure DevOps为其设置CI/CD，该怎么办？</h1><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi pq"><img src="../Images/dca9466787c0b8f649616f029a345de2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vGTe4VVS91BivfKgdKXWOA.jpeg"/></div></div></figure><ul class=""><li id="4f50" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn of ku kv kw bi translated">我们有多个Databricks环境，即开发、UAT和prod，开发人员可以在其中直接提交他们的更改。</li><li id="34e9" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">从UAT和生产工作区中删除开发人员的访问权限，以便不允许提交。</li><li id="919a" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">使用Databricks CLI导出data brick笔记本</li><li id="ad10" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">使用git命令将导出的笔记本提交到Azure Repos。</li><li id="dbb8" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">从总分行创建UAT分行，并从UAT分行发展分行。如果不同的环境没有同步，那么我们必须在继续下一步之前手动同步它们。</li><li id="46c3" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">使用本文中提到的步骤将笔记本链接到开发分支。</li><li id="c3af" class="ko kp it js b jt kx jx ky kb kz kf la kj lb kn of ku kv kw bi translated">使用之前创建的CI/CD管道在UAT和生产环境中部署笔记本电脑。</li></ul></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><p id="29e6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">如果您需要任何帮助或有任何建议，请通过</strong> <a class="ae nl" href="https://www.linkedin.com/in/aniketprashar" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> LinkedIn </strong> </a>联系我</p></div></div>    
</body>
</html>