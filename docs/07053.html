<html>
<head>
<title>Find potential memory leaks with automated tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•å‘ç°æ½œåœ¨çš„å†…å­˜æ³„æ¼</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://levelup.gitconnected.com/find-potential-memory-leaks-with-automated-tests-7b8d78a5274f?source=collection_archive---------13-----------------------#2021-01-20">https://levelup.gitconnected.com/find-potential-memory-leaks-with-automated-tests-7b8d78a5274f?source=collection_archive---------13-----------------------#2021-01-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e816" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">å†…å­˜å¤„ç†å’Œå¼•ç”¨ç±»å‹</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/dfb29efedbbe676445899e23f61fbef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yo2nG22qI8-u3PdFCD46Ww.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">è±ªå°”èµ«Â·æ‹‰ç±³é›·æ–¯åœ¨<a class="ae kv" href="https://unsplash.com/s/photos/ram-memory?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šæ‹æ‘„çš„ç…§ç‰‡</figcaption></figure><p id="31f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å°±å†…å­˜å¤„ç†è€Œè¨€ï¼Œåœ¨æˆ‘ä»¬çš„iOSåº”ç”¨ä¸­å·¥ä½œå¯èƒ½éå¸¸å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦éå¸¸å°å¿ƒåˆ†é…åœ¨å†…å­˜ä¸­çš„<code class="fe ls lt lu lv b">object instances</code>,å¹¶ä¿è¯å®ƒä»¬çš„æ­£ç¡®é‡Šæ”¾ã€‚</p><p id="25ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ­£å¦‚ä½ å¯èƒ½çŸ¥é“çš„ï¼Œå®ä¾‹æ˜¯é€šè¿‡<strong class="ky ir"> ARC </strong>æˆ–<strong class="ky ir">è‡ªåŠ¨å¼•ç”¨è®¡æ•°</strong>ä»å†…å­˜ä¸­é‡Šæ”¾çš„ï¼Œåœ¨iOSä¸Šæœ‰ä¸¤ç§ç±»å‹çš„å¼•ç”¨:å¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨ã€‚</p><p id="fb18" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¼ºå¼•ç”¨æ˜¯é»˜è®¤çš„å¼•ç”¨ç±»å‹ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„å¯¹è±¡å£°æ˜ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º<code class="fe ls lt lu lv b">Person</code>çš„ç±»ï¼Œæˆ‘ä»¬å¦‚ä¸‹å£°æ˜ä¸€ä¸ªå¯¹è±¡:</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="2312" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">var</strong> person = Person()</span></pre><p id="88b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åœ¨å‰é¢çš„å£°æ˜ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¯¹<code class="fe ls lt lu lv b">Person</code>å¯¹è±¡çš„å¼ºå¼•ç”¨ã€‚æ¯æ¬¡æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œæˆ‘ä»¬å°±æŠŠ<em class="mg">å¯¹è±¡ä¿ç•™è®¡æ•°</em>åŠ 1ã€‚é‚£æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿè¿™ä¸ºä»€ä¹ˆæœ‰ç”¨ï¼Ÿè¿™å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºARCä¸ä¼šä»å†…å­˜ä¸­åˆ é™¤ä¸€ä¸ªå¯¹è±¡ï¼Œç›´åˆ°å®ƒçš„ä¿ç•™è®¡æ•°ç­‰äº0ã€‚</p><p id="76b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¦ä¸€æ–¹é¢ï¼Œå¼±å¼•ç”¨ä¸ä¼šå¢åŠ å¯¹è±¡ä¿ç•™è®¡æ•°ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­:</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="c50a" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">var</strong> person = Person()<br/><strong class="lv ir">weak</strong> <strong class="lv ir">var</strong> anotherPerson: Person? = person</span></pre><p id="0765" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¯¹åŒä¸€ä¸ªäººå¯¹è±¡çš„å¼±å¼•ç”¨ï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†å¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨ã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿æˆ‘ä»¬å¯¹åŒä¸€ä¸ªpersonå¯¹è±¡æœ‰ä¸¤ä¸ªå¼•ç”¨ï¼Œå®ƒçš„ä¿ç•™è®¡æ•°ä»ç„¶æ˜¯1ï¼Œå› ä¸ºå…¶ä¸­ä¸€ä¸ªæ˜¯å¼±å¼•ç”¨ã€‚å¼±å¼•ç”¨çš„å¦ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯å®ƒä»¬æ˜¯å¯é€‰çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½åœ¨å®ƒä»¬å·²ç»ä»å†…å­˜ä¸­é‡Šæ”¾çš„æ—¶å€™è®¿é—®å®ƒä»¬ã€‚</p><h1 id="640f" class="mh mb iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">é€šè¿‡æµ‹è¯•æ‰¾åˆ°ä¿ç•™å‘¨æœŸå’Œå†…å­˜æ³„æ¼</h1><p id="9f64" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">å½“ä¸¤ä¸ªå¯¹è±¡å½¼æ­¤å…·æœ‰å¼ºå¼•ç”¨æ—¶ï¼Œå°±ä¼šå‘ç”Ÿä¿ç•™å¾ªç¯ã€‚ç»“æœæ˜¯ä¸¤ä¸ªå¯¹è±¡éƒ½å°†è‡ªå·±ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œå› ä¸ºå®ƒä»¬çš„ä¿ç•™è®¡æ•°æ°¸è¿œä¸ä¼šä¸º0ã€‚ä½œä¸ºå¼€å‘äººå‘˜ï¼Œæˆ‘ä»¬éœ€è¦æ‰“ç ´è¿™ç§å¾ªç¯ï¼Œä»¥ä¾¿ARCèƒ½å¤Ÿé‡Šæ”¾é‚£äº›å¯¹è±¡å ç”¨çš„å†…å­˜ç©ºé—´ã€‚</p><p id="b1c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­ä¸€ä¸ªç±»å‹ä¸º<code class="fe ls lt lu lv b">HTTPClient</code>ï¼Œæ˜¯<code class="fe ls lt lu lv b">UserProfileLoader</code>å¯¹è±¡çš„åˆä½œè€…ã€‚</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="a3d1" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">class</strong> UserProfileLoader {</span><span id="ffa9" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   private</strong> <strong class="lv ir">let</strong> client: HTTPClient<br/>   <strong class="lv ir">private</strong> <strong class="lv ir">let</strong> url: URL</span><span id="8acf" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   init</strong>(url: URL, client: HTTPClient) {<br/>      <strong class="lv ir">self</strong>.url = url<br/>      <strong class="lv ir">self</strong>.client = client<br/>   }</span><span id="9661" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   enum</strong> Error: Swift.Error {<br/>      <strong class="lv ir">case</strong> invalidProfileData<br/>      <strong class="lv ir">case</strong> connectivity<br/>   }</span><span id="0fb6" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   enum</strong> Result: Equatable {<br/>      <strong class="lv ir">case</strong> success(UserProfile)<br/>      <strong class="lv ir">case</strong> failure(Error)<br/>   }</span><span id="439c" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   func</strong> loadProfile(completion: <strong class="lv ir">@escaping</strong> (Result) -&gt; Void) {<br/>      client.get(from: url) { data <strong class="lv ir">in<br/>         let</strong> result = <strong class="lv ir">self</strong>.map(data: data)<br/>         completion(result)<br/>      }<br/>   }</span><span id="69e0" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   func</strong> map(data: HTTPClientResult) -&gt; Result {<br/>      <strong class="lv ir">return</strong> .success(UserProfile(id: "an-user-id"))<br/>   }</span><span id="79ab" class="ma mb iq lv b gy nd md l me mf">}</span></pre></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><pre class="lw lv lx ly aw lz bi"><span id="f2a5" class="ma mb iq lv b gy nl nm nn no np md l me mf"><strong class="lv ir">enum</strong> HTTPClientResult {<br/>   <strong class="lv ir">case</strong> success(Data)<br/>   <strong class="lv ir">case</strong> failure(Error)<br/>}</span><span id="01bb" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">protocol</strong> HTTPClient {</span><span id="1564" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   func</strong> get(from url: URL, <br/>            completion: <strong class="lv ir">@escaping</strong> (HTTPClientResult) -&gt; Void)</span><span id="415b" class="ma mb iq lv b gy nd md l me mf">}</span><span id="58d4" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">class</strong> HTTPClientSpy: HTTPClient {</span><span id="ae1f" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   var</strong> completion: ((HTTPClientResult) -&gt; Void)? = <strong class="lv ir">nil</strong></span><span id="15f1" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   func</strong> get(from url: URL, <br/>            completion: <strong class="lv ir">@escaping</strong> (HTTPClientResult) -&gt; Void) {<br/>       <br/>       <strong class="lv ir">self</strong>.completion = completion<br/>   }</span><span id="8970" class="ma mb iq lv b gy nd md l me mf">}</span></pre></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><pre class="lw lv lx ly aw lz bi"><span id="92b0" class="ma mb iq lv b gy nl nm nn no np md l me mf"><strong class="lv ir">struct</strong> UserProfile: Equatable {<br/>   <strong class="lv ir">var</strong> id: String<br/>}</span></pre><p id="6948" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„<code class="fe ls lt lu lv b">UserProfileLoader</code>æœ‰ä¸€ä¸ªåä¸º<code class="fe ls lt lu lv b">loadProfile</code>çš„æ–¹æ³•ï¼Œå®ƒè°ƒç”¨ç±»å‹ä¸º<code class="fe ls lt lu lv b">HTTPClient</code>çš„ç»„åˆ<code class="fe ls lt lu lv b">client</code>ä¸­çš„<code class="fe ls lt lu lv b">get</code>æ–¹æ³•ã€‚æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬çš„<code class="fe ls lt lu lv b">HTTPClientSpy</code>ä¸­çš„<code class="fe ls lt lu lv b">get</code>çš„å®ç°åœ¨ä¸€ä¸ªåä¸º<code class="fe ls lt lu lv b">completion</code>çš„å±æ€§ä¸­å­˜å‚¨äº†ä¸€ä¸ªé—­åŒ…ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬çš„é—­åŒ…å¯ä»¥ä»æµ‹è¯•ä¸­è®¿é—®ã€‚</p><p id="7e7b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸Šé¢çš„å®ç°è‚¯å®šåŒ…å«äº†ä¿ç•™å‘¨æœŸï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Œåœ¨å“ªé‡Œå‘¢ï¼Ÿä¹ä¸€çœ‹å¹¶ä¸æ˜æ˜¾ï¼Œä¸æ˜¯å—ï¼Ÿï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ã€‚<code class="fe ls lt lu lv b">UserProfileLoader</code>å¯¹<code class="fe ls lt lu lv b">HTTPClient</code>å¯¹è±¡æœ‰å¼ºå¼•ç”¨ï¼Œåœ¨å“ªé‡Œï¼Ÿå¦ä¸€æ–¹é¢ï¼Œåœ¨<code class="fe ls lt lu lv b">client</code>å±æ€§ä¸Šï¼Œ<code class="fe ls lt lu lv b">HTTPClient</code>å®ç°ä¹Ÿå¼ºçƒˆå¼•ç”¨äº†<code class="fe ls lt lu lv b">UserProfileLoader</code>ï¼Œåœ¨å“ªé‡Œï¼Ÿä½ å¯èƒ½ä¼šè¯´æˆ‘ä»¬çš„<code class="fe ls lt lu lv b">HTTPClientSpy</code>ä¸­æ²¡æœ‰å­˜å‚¨ä»»ä½•<code class="fe ls lt lu lv b">UserProfileLoader</code>ï¼Œä½†è‚¯å®šæœ‰ä¸€ä¸ªã€‚è®©æˆ‘ä»¬å†çœ‹çœ‹æˆ‘ä»¬çš„<code class="fe ls lt lu lv b">get</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†æ¥æ”¶åˆ°çš„é—­åŒ…å­˜å‚¨åœ¨<code class="fe ls lt lu lv b">completion </code>å±æ€§ä¸­ï¼Œè¿™ä¸ªé—­åŒ…å¯¹æˆ‘ä»¬çš„<code class="fe ls lt lu lv b">UserProfileLoader</code>å¯¹è±¡æœ‰ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œåœ¨å“ªé‡Œï¼Ÿåœ¨<code class="fe ls lt lu lv b">map</code>æ–¹æ³•è°ƒç”¨ä¸­ã€‚å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬é€šè¿‡æ˜ç¡®ä½¿ç”¨<code class="fe ls lt lu lv b">self</code>æ·»åŠ äº†ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚</p><p id="ad7e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿™ç§é”™è¯¯é€šå¸¸ä¼šåœ¨å¾ˆå¤šä»£ç åº“ä¸­å‘ç°ï¼Œæœ‰æ—¶å®ƒä»¬å¹¶ä¸æ˜æ˜¾ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½é¿å…é™·å…¥å…¶ä¸­ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨è‡ªåŠ¨åŒ–æµ‹è¯•æ¥å‡å°‘è¿™ç§å¯èƒ½æ€§ï¼Œä½†æ˜¯æ€ä¹ˆåšå‘¢ï¼Ÿæˆ‘ä»¬å¿…é¡»ç¡®ä¿è¢«æµ‹ç³»ç»ŸåŠå…¶åˆä½œè€…<strong class="ky ir"> SUT </strong>æˆ–<strong class="ky ir">è¢«é€‚å½“åœ°è§£é™¤åˆ†é…ã€‚</strong></p><p id="f72e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è®©æˆ‘ä»¬ä»å†™å‡ºç¬¬ä¸€ä¸ªæµ‹è¯•å¼€å§‹ï¼Œè¿™ä¸ªæµ‹è¯•å°†è¦†ç›–æˆåŠŸçš„è·¯å¾„ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„SUTå°†æ˜¯æˆ‘ä»¬çš„<code class="fe ls lt lu lv b">UserProfileLoader</code>å®ä¾‹ã€‚</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="94d1" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">func</strong> test_load_withSuccesfulClientResponseDeliversSuccesLoadingResult() {</span><span id="1d52" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   let</strong> url = URL(string: "https://a-url.com")!<br/>   <strong class="lv ir">let</strong> client = HTTPClientSpy()<strong class="lv ir"><br/>   let</strong> sut = UserProfileLoader(url: url, client: client)</span><span id="684e" class="ma mb iq lv b gy nd md l me mf">}</span></pre><p id="1153" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘ä»¬å·²ç»æœ‰äº†ç»™å®šçš„ç»“æœï¼Œç°åœ¨æˆ‘ä»¬å¿…é¡»å°†åŠ è½½ç»“æœå­˜å‚¨åœ¨æŸä¸ªåœ°æ–¹ï¼Œä»¥åšå‡ºä¸€äº›æ–­è¨€ï¼Œæ­£å¦‚ä½ æ‰€è®°å¾—çš„é‚£æ ·ï¼Œ<code class="fe ls lt lu lv b">loadProfile</code>æ–¹æ³•å°†ä½¿ç”¨ç±»å‹ä¸º<strong class="ky ir"> (Result) - &gt; Void </strong>çš„é—­åŒ…æ¥å®Œæˆã€‚è®©æˆ‘ä»¬å°†ç»“æœå­˜å‚¨åœ¨æµ‹è¯•ä¸­ã€‚</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="2e50" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">func</strong> test_load_withSuccesfulClientResponseDeliversSuccesLoadingResult() {</span><span id="9b44" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   let</strong> url = URL(string: "https://a-url.com")!<br/>   <strong class="lv ir">let</strong> client = HTTPClientSpy()<strong class="lv ir"><br/>   let</strong> sut = UserProfileLoader(url: url, client: client)</span><span id="72fa" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   var</strong> capturedResults = [UserProfileLoader.Result]()<br/>   sut.loadProfile { capturedResults.append($0) }</span><span id="e599" class="ma mb iq lv b gy nd md l me mf">}</span></pre><p id="d78f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åœ¨æˆ‘ä»¬ä¹‹å‰çš„æµ‹è¯•ä¸­ï¼Œè´Ÿè½½é—­åŒ…æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæˆ‘ä»¬çš„<code class="fe ls lt lu lv b">loadProfile</code>åœ¨è°ƒç”¨<code class="fe ls lt lu lv b">get</code>çš„å®ç°ï¼Œä½ è¿˜è®°å¾—<code class="fe ls lt lu lv b">get</code>çš„å®ç°æ˜¯åšä»€ä¹ˆçš„å—ï¼Ÿåœ¨æˆ‘ä»¬çš„<code class="fe ls lt lu lv b">HTTPClientSpy</code>å®ä¾‹ä¸­ï¼Œ<code class="fe ls lt lu lv b">get</code>æ–¹æ³•å°†æ¥æ”¶åˆ°çš„é—­åŒ…å­˜å‚¨åœ¨ä¸€ä¸ªå±æ€§ä¸­ã€‚æˆ‘ä»¬å¿…é¡»åœ¨æµ‹è¯•ä¸­è°ƒç”¨å­˜å‚¨çš„å®Œæˆå—æ¥è·å¾—ç»“æœã€‚</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="7f61" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">func</strong> test_load_withSuccesfulClientResponseDeliversSuccesLoadingResult() {</span><span id="3657" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   let</strong> url = URL(string: "https://a-url.com")!<br/>   <strong class="lv ir">let</strong> client = HTTPClientSpy()<strong class="lv ir"><br/>   let</strong> sut = UserProfileLoader(url: url, client: client)</span><span id="b39c" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   var</strong> capturedResults = [UserProfileLoader.Result]()<br/>   sut.loadProfile { capturedResults.append($0) }</span><span id="b6bf" class="ma mb iq lv b gy nd md l me mf">   client.completion?(.success(Data()))</span><span id="bdab" class="ma mb iq lv b gy nd md l me mf">}</span></pre><p id="47a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ç”¨<code class="fe ls lt lu lv b">capturedResults</code>æ•°ç»„åšä¸€äº›æ–­è¨€äº†ã€‚æˆ‘ä»¬çš„<code class="fe ls lt lu lv b">loadProfile</code>æ–¹æ³•å°†æ€»æ˜¯ä»¥åŒ…å«<code class="fe ls lt lu lv b">UserProfile</code>å®ä¾‹çš„æˆåŠŸç»“æœå®Œæˆã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨æµ‹è¯•ä¸­æ‰€æœŸå¾…çš„ã€‚</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="b14f" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">class</strong> MemoryLeaksTests: XCTestCase {</span><span id="7f68" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   func</strong> test_load_withSuccesfulCallDeliversSuccesLoadingResult() {</span><span id="dc99" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">      let</strong> url = URL(string: "https://a-url.com")!<br/>      <strong class="lv ir">let</strong> client = HTTPClientSpy()<strong class="lv ir"><br/>      let</strong> sut = UserProfileLoader(url: url, client: client)</span><span id="a156" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">      let</strong> expectedResult: UserProfileLoader.Result =<br/>          .success(UserProfile(id: "an-user-id"))</span><span id="1f08" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">      var</strong> capturedResults = [UserProfileLoader.Result]()<br/>      sut.loadProfile { capturedResults.append($0) }<br/>      client.completion?(.success(Data()))</span><span id="2fcc" class="ma mb iq lv b gy nd md l me mf">      XCTAssertEqual(capturedResults, [expectedResult])</span><span id="da31" class="ma mb iq lv b gy nd md l me mf">   }</span><span id="bb23" class="ma mb iq lv b gy nd md l me mf">}</span></pre><p id="60ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¤ªå¥½äº†ï¼æˆ‘ä»¬æœ‰ä¸€ä¸ªé€šè¿‡æµ‹è¯•ï¼è¿™ä¸ªæµ‹è¯•èƒ½ç¡®ä¿æˆ‘ä»¬çš„SUTå’Œå®ƒçš„åˆä½œè€…çš„æ­£ç¡®é‡Šæ”¾å—ï¼Ÿè¿˜æ²¡æœ‰ã€‚è®©æˆ‘ä»¬æ·»åŠ ä¸€äº›æ–­è¨€æ¥ç¡®ä¿æˆ‘ä»¬çš„æµ‹è¯•æ˜¯ä»å†…å­˜ä¸­é‡Šæ”¾çš„ã€‚</p><p id="712d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘ä»¬çš„<code class="fe ls lt lu lv b">MemoryLeaksTests</code>ç±»ä»<code class="fe ls lt lu lv b">XCTestCase</code>ç±»æ‰©å±•è€Œæ¥ï¼Œ<code class="fe ls lt lu lv b">XCTestCase</code>ç±»ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªåä¸º<code class="fe ls lt lu lv b"><a class="ae kv" href="https://developer.apple.com/documentation/xctest/xctestcase/2887226-addteardownblock" rel="noopener ugc nofollow" target="_blank">addTearDownBlock</a></code>çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ªç±»å‹ä¸º<strong class="ky ir"> () - &gt; Void </strong>çš„å—ï¼Œæ¯æ¬¡æµ‹è¯•å‡½æ•°ç»“æŸæ—¶éƒ½ä¼šæ‰§è¡Œè¿™ä¸ªå—ã€‚æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªæ‹†é™¤å—åï¼Œæˆ‘ä»¬çš„SUTå’Œå®ƒçš„åˆä½œè€…åˆ›é€ çš„æƒåˆ©ã€‚</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="d2a2" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">class</strong> MemoryLeaksTests: XCTestCase {</span><span id="32c4" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   func</strong> test_load_withSuccesfulCallDeliversSuccesLoadingResult() {</span><span id="2e76" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">      let</strong> url = URL(string: "https://a-url.com")!<br/>      <strong class="lv ir">let</strong> client = HTTPClientSpy()<strong class="lv ir"><br/>      let</strong> sut = UserProfileLoader(url: url, client: client)</span><span id="5cdb" class="ma mb iq lv b gy nd md l me mf">      addTeardownBlock { [<strong class="lv ir">weak</strong> sut, <strong class="lv ir">weak</strong> client] <strong class="lv ir">in<br/>         </strong>XCTAssertNil(client, "Instance has not been deallocated")<br/>         XCTAssertNil(sut, "Instance has not been deallocated")<br/>      }</span><span id="b918" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">      let</strong> expectedResult: UserProfileLoader.Result =<br/>          .success(UserProfile(id: "an-user-id"))</span><span id="2a4e" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">      var</strong> capturedResults = [UserProfileLoader.Result]()<br/>      sut.loadProfile { capturedResults.append($0) }<br/>      client.completion?(.success(Data()))</span><span id="1ac9" class="ma mb iq lv b gy nd md l me mf">      XCTAssertEqual(capturedResults, [expectedResult])</span><span id="9a08" class="ma mb iq lv b gy nd md l me mf">   }</span><span id="f2eb" class="ma mb iq lv b gy nd md l me mf">}</span></pre><p id="5c19" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†æˆ‘ä»¬çš„ç§¯æœ¨ã€‚è¯·æ³¨æ„ï¼Œåœ¨æˆ‘ä»¬çš„å—ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†å¯¹<code class="fe ls lt lu lv b">sut</code>å’Œ<code class="fe ls lt lu lv b">client</code>å®ä¾‹çš„å¼±å¼•ç”¨ï¼Œä»¥é¿å…è¿›ä¸€æ­¥å¢åŠ å®ƒä»¬çš„ä¿ç•™è®¡æ•°ã€‚ç°åœ¨æˆ‘ä»¬çš„ç»¿è‰²æµ‹è¯•ä¸å†æ˜¯ç»¿è‰²çš„äº†ï¼Œå› ä¸ºæ‹†å¸å—æ–­è¨€å¤±è´¥äº†ã€‚</p><p id="fc24" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸ºäº†å»é™¤ä¿ç•™å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥é¿å…åœ¨æˆ‘ä»¬çš„<code class="fe ls lt lu lv b">loadProfile</code>æ–¹æ³•ä¸­æ˜¾å¼ä½¿ç”¨<code class="fe ls lt lu lv b">self</code>ã€‚æˆ‘ä»¬æœ‰ä¸€äº›é€‰æ‹©:</p><ol class=""><li id="ebfc" class="nq nr iq ky b kz la lc ld lf ns lj nt ln nu lr nv nw nx ny bi translated">åœ¨æˆ‘ä»¬çš„é—­åŒ…ä¸­ä½¿ç”¨ä¸€ä¸ª<strong class="ky ir">å¼±</strong>å¼•ç”¨ï¼Œå¹¶æ·»åŠ guard letå—æ¥è§£å¼€ç»“æœï¼›</li><li id="5334" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated">æŠŠæˆ‘ä»¬çš„<code class="fe ls lt lu lv b">map</code>æ–¹æ³•å˜æˆé™æ€æ–¹æ³•ï¼›æˆ–è€…</li><li id="0c9e" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated">å°†<code class="fe ls lt lu lv b">map</code>æ–¹æ³•ç§»åŠ¨åˆ°æ˜ å°„å™¨ç±»é™æ€æ–¹æ³•</li></ol><p id="c83d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨ç¬¬äºŒä¸ªé€‰é¡¹æ¥æ‰“ç ´ä¿ç•™å¾ªç¯å¹¶é€šè¿‡æµ‹è¯•ã€‚</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="1314" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">func</strong> loadProfile(completion: <strong class="lv ir">@escaping</strong> (Result) -&gt; Void) {<br/>   client.get(from: url) { data <strong class="lv ir">in<br/>      </strong>completion(UserProfileLoader.map(data: data))<br/>   }<br/>}</span><span id="9d28" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">static</strong> <strong class="lv ir">func</strong> map(data: HTTPClientResult) -&gt; Result {<br/>   <strong class="lv ir">return</strong> .success(UserProfile(id: "an-user-id"))<br/>}</span></pre><p id="537f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç°åœ¨æˆ‘ä»¬çš„æµ‹è¯•é€šè¿‡äº†ï¼Œä½†æ˜¯â€¦å®ƒçœ‹èµ·æ¥æœ‰ç‚¹ä¹±ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬é‡æ„æˆ‘ä»¬çš„æµ‹è¯•æ¥æ¸…ç†ä¸€ä¸‹ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦æ·»åŠ æ›´å¤šçš„æµ‹è¯•åŠŸèƒ½(ç›¸ä¿¡æˆ‘ï¼Œæˆ‘ä»¬ä¼šæƒ³è¦çš„ğŸ™‚)ï¼Œæˆ‘ä»¬å°†åˆ›å»ºæˆ‘ä»¬çš„SUTå’Œå®ƒçš„åˆä½œè€…ï¼Œå¹¶ä¸ºä»–ä»¬æ¯ä¸ªäººæ·»åŠ æ‹†é™¤å—ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å°†é‡å¤è‡ªå·±ã€‚</p><p id="441e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸ºäº†é‡æ„è¿™ä¸ªæµ‹è¯•ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€äº›å·¥å‚æ–¹æ³•ã€‚ç¬¬ä¸€ä¸ªå°†æ˜¯æˆ‘ä»¬çš„<code class="fe ls lt lu lv b">makeSUT</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†è¿”å›SUTåŠå…¶åˆä½œè€…ã€‚</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="4d26" class="ma mb iq lv b gy mc md l me mf"><strong class="lv ir">class</strong> MemoryLeaksTests: XCTestCase {</span><span id="5037" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   func</strong> test_load_withSuccesfulCallDeliversSuccesLoadingResult() {</span><span id="62a5" class="ma mb iq lv b gy nd md l me mf">      <strong class="lv ir">let</strong> (sut, client) = <br/>          makeSUT(url: URL(string: "https://a-url.com")!)<br/>      <strong class="lv ir">let</strong> expectedResult: UserProfileLoader.Result =<br/>          .success(UserProfile(id: "an-user-id"))</span><span id="0df2" class="ma mb iq lv b gy nd md l me mf">      <strong class="lv ir">var</strong> capturedResults = [UserProfileLoader.Result]()<br/>      sut.loadProfile { capturedResults.append($0) }<br/>      client.completion?(.success(Data()))</span><span id="22c2" class="ma mb iq lv b gy nd md l me mf">      XCTAssertEqual(capturedResults, [expectedResult])<br/>   }</span><span id="3a97" class="ma mb iq lv b gy nd md l me mf">   // MARK:<strong class="lv ir"> - Helpers</strong></span><span id="fd3b" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">   func</strong> makeSUT(url: URL,<br/>                file: StaticString = <strong class="lv ir">#filePath</strong>,<br/>                line: UInt = <strong class="lv ir">#line</strong>) -&gt; (sut: UserProfileLoader, client: HTTPClientSpy) {</span><span id="600a" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">      let</strong> client = HTTPClientSpy()<br/>      <strong class="lv ir">let</strong> sut = UserProfileLoader(url: url, client: client)<br/>      addTeardownBlock { [<strong class="lv ir">weak</strong> sut, <strong class="lv ir">weak</strong> client] <strong class="lv ir">in<br/>         </strong>XCTAssertNil(client, <br/>                      "Instance has not been deallocated", <br/>                      file: file, <br/>                      line: line)<br/>         XCTAssertNil(sut, <br/>                      "Instance has not been deallocated", <br/>                      file: file, <br/>                      line: line)<br/>      }</span><span id="772b" class="ma mb iq lv b gy nd md l me mf"><strong class="lv ir">      return</strong> (sut, client)</span><span id="52e3" class="ma mb iq lv b gy nd md l me mf">   }</span><span id="f92d" class="ma mb iq lv b gy nd md l me mf">}</span></pre><p id="a1a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªæ›´å¹²å‡€çš„æµ‹è¯•ï¼æˆ‘ä»¬çš„æµ‹è¯•å¯è¯»æ€§æ›´å¼ºï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿ï¼é™¤äº†æ¸…æ´å‰‚æµ‹è¯•è¿˜æœ‰å“ªä¸ªï¼Ÿä½ å¯èƒ½ä¼šè¯´ï¼Œå¦‚æœä½ çœ‹ä¸€çœ‹<code class="fe ls lt lu lv b">makeSUT</code>å·¥å‚æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ·»åŠ äº†æˆ‘ä»¬çš„åˆ†è§£å—ï¼Œè¿™æ„å‘³ç€ä¸€æ—¦æµ‹è¯•å®Œæˆï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•åˆ›å»ºSUTçš„æ¯ä¸ªæµ‹è¯•å°†è‡ªåŠ¨éªŒè¯SUTåŠå…¶åˆä½œè€…æ˜¯å¦è¢«æ­£ç¡®åœ°ä»å†…å­˜ä¸­é‡Šæ”¾ã€‚å¦‚æœSUTåŠå…¶åˆä½œè€…æ²¡æœ‰ä»å†…å­˜ä¸­é‡Šæ”¾ï¼Œæµ‹è¯•å°†åœ¨<code class="fe ls lt lu lv b">makeSUT</code>è°ƒç”¨ä¸­æ˜¾ç¤ºé”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨å°†<code class="fe ls lt lu lv b">file</code>å’Œ<code class="fe ls lt lu lv b">line</code>å‚æ•°ä¼ é€’ç»™<code class="fe ls lt lu lv b">XCTAssertNil</code>ã€‚</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/79b1629f6238f6b867da8cc264838774.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*OAiMyVvA0WIRf21eIpalVw.png"/></div></figure><p id="cdb6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">éµå¾ªè¿™ç§æ–¹æ³•å°†ç»™äºˆæˆ‘ä»¬é‡æ„çš„ä¿¡å¿ƒï¼Œå¹¶éªŒè¯æˆ‘ä»¬æ­£åœ¨è¿›è¡Œæ­£ç¡®çš„å†…å­˜ç®¡ç†ã€‚</p></div></div>    
</body>
</html>