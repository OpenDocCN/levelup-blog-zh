# åœ¨å‘½ä»¤æˆ–è„šæœ¬å‰æ·»åŠ æ—¶é—´æˆ³

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/prefixing-your-commands-or-scripts-with-a-timestamp-1eb408e92a1c>

![](img/4d82ab28818f8c0830b96511411f5a36.png)

ç”±[å¢å¡æ–¯Â·å¸ƒæ‹‰å¡å…‹](https://unsplash.com/@goumbik?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„çš„ç…§ç‰‡

å½“æ‚¨è¿è¡Œä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„å‘½ä»¤æˆ–è„šæœ¬æ—¶ï¼Œè®©å®ƒçš„æ‰€æœ‰è¾“å‡ºä»¥æ—¶é—´æˆ³ä¸ºå‰ç¼€å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³æ”¹å˜è¿™ä¸€ç‚¹:

```
foo
bar
baz
```

å¯¹æ­¤:

```
[2020-12-13 12:20:38] foo
[2020-12-13 12:21:32] bar
[2020-12-13 12:22:20] baz
```

è¿™æ˜¯ä½ å¯ä»¥åšåˆ°çš„ã€‚

# ç®¡é“è‡³ Awk

å…³é”®æ˜¯å°†è¾“å‡ºä¼ è¾“åˆ°å¦ä¸€ä¸ªå·¥å…·ï¼Œè¯¥å·¥å…·ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–æ‰€æœ‰å†…å®¹ï¼Œå¹¶æ‰“å°ç›¸åŒçš„å†…å®¹ï¼Œä½†æ·»åŠ äº†å‰ç¼€ã€‚

æˆ‘ä»¬ç”¨ä»€ä¹ˆå·¥å…·ï¼ŸAwk æ˜¯ä¸€ä¸ªå®Œç¾çš„å€™é€‰ï¼Œå› ä¸ºå®ƒå‡ ä¹å®‰è£…åœ¨ä»»ä½•åœ°æ–¹ã€‚Awk æ˜¯ä¸€ä¸ªå¤„ç†æ–‡æœ¬æµçš„å·¥å…·ã€‚

# å•ä¸ªå‘½ä»¤ä¸­çš„ç”¨æ³•

ä¸‹é¢æ˜¯ä¸€ä¸ªåŒ…å«å•ä¸ªå‘½ä»¤çš„ç¤ºä¾‹:

```
command | awk '{ print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }'
```

ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œä¸Šé¢åªæ˜¯å°†æ—¶é—´æˆ³å‰ç¼€æ·»åŠ åˆ°å†™å…¥æ ‡å‡†è¾“å‡ºçš„æ–‡æœ¬ä¸­ã€‚å¦‚æœæ‚¨å¸Œæœ›å†™å…¥æ ‡å‡†é”™è¯¯çš„æ–‡æœ¬ä¹Ÿå¸¦æœ‰æ—¶é—´æˆ³å‰ç¼€ï¼Œé‚£ä¹ˆè¯·ç¡®ä¿å°†æ ‡å‡†é”™è¯¯é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡ºï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
command 2>&1 | awk '{ print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }'
```

ç¥å¥‡çš„éƒ¨åˆ†æ˜¯`2>&1`ã€‚è¿™æ„å‘³ç€:å°†æ–‡ä»¶æè¿°ç¬¦ 2(æ ‡å‡†é”™è¯¯)é‡å®šå‘åˆ°æ–‡ä»¶æè¿°ç¬¦ 1(æ ‡å‡†è¾“å‡º)ã€‚

# Bash è„šæœ¬ä¸­çš„ç”¨æ³•

Bash è„šæœ¬é€šå¸¸è°ƒç”¨å¤šä¸ªå‘½ä»¤ã€‚æ‚¨ä¸å¸Œæœ›æ‰‹åŠ¨å°†æ¯ä¸ªå‘½ä»¤éƒ½ä¼ é€åˆ° awk:è„šæœ¬ä¼šå¾ˆå¿«è½¬å‘`awk`ã€‚ğŸ™ƒ

```
*#!/bin/bash*
set -e
set -o pipefail*# Yeah, no...*
apt-get update 2>&1 | awk '{ print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }'
apt-get install -y foo 2>&1 | awk '{ print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }'
systemctl restart foo.service 2>&1 | awk '{ print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }'
```

æˆ‘ä»¬èƒ½åšå¾—æ›´å¥½å—ï¼Ÿæ˜¯çš„:æ‚¨å¯ä»¥å‘Šè¯‰ Bashï¼Œå®ƒè‡ªå·±çš„æ‰€æœ‰è¾“å‡º(åŒ…æ‹¬ Bash è¿è¡Œçš„å‘½ä»¤çš„æ‰€æœ‰è¾“å‡º)éƒ½åº”è¯¥è¢«é‡å®šå‘åˆ°å¦ä¸€ä¸ªå‘½ä»¤:

```
exec **>** **>(**awk '{ print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }'**)** 2>&1
```

è¿™æ˜¯ä»€ä¹ˆè¯¡å¼‚çš„é­”æ³•ï¼Ÿï¼ï¼Ÿï¼

*   ä¸€ä¸ªèµ¤è£¸è£¸çš„`exec`è¯­å¥ï¼Œæ²¡æœ‰ç»™å‡ºè¿›ä¸€æ­¥çš„å‘½ä»¤ï¼Œæ„å‘³ç€:æˆ‘ä»¬ä¸æƒ³å®é™…æ‰§è¡Œä»»ä½•ä¸œè¥¿ï¼Œæˆ‘ä»¬åªæƒ³æ“çºµå½“å‰ Bash è¿›ç¨‹ä¸­çš„ä¸€äº›æ–‡ä»¶æè¿°ç¬¦(ç®¡é“)ã€‚
*   `>`è¡¨ç¤º:å°†æ ‡å‡†è¾“å‡º(ç°åœ¨åŒ…æ‹¬æ ‡å‡†é”™è¯¯)é‡å®šå‘åˆ°ç»™å®šçš„æ–‡ä»¶ã€‚
*   `>(some command)`æ˜¯ä¸€ä¸ª[è¿‡ç¨‹çš„æ›¿ä»£](https://www.linuxjournal.com/content/shell-process-redirection)ã€‚è¿™æ„å‘³ç€:åˆ›å»ºä¸€ä¸ªæ–°ç®¡é“ï¼Œç„¶åä½¿ç”¨è¿æ¥åˆ°è¯¥ç®¡é“çš„æ ‡å‡†è¾“å…¥è¿è¡Œ`some command`ï¼Œç„¶åå‘è¯¥ç®¡é“è¿”å›ä¸€ä¸ªæ–‡ä»¶åã€‚
*   æ‰€ä»¥`> >(some command)`çš„æ„æ€æ˜¯:å°†æ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°ç”±æµç¨‹æ›¿æ¢åˆ›å»ºçš„ç®¡é“ã€‚
*   `2>&1`çš„æ„æ€æ˜¯:åœ¨å½“å‰çš„ Bash è¿›ç¨‹ä¸­ï¼Œå°†æ ‡å‡†é”™è¯¯é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡ºã€‚

ç”±è¿›ç¨‹æ›¿æ¢åˆ›å»ºçš„ç®¡é“æ˜¯ä¸´æ—¶çš„ï¼Œå¹¶ä¸”åœ¨è¯¥è¡Œç»“æŸæ—¶ç«‹å³å…³é—­ã€‚åœ¨è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°å®ƒçš„ä½œç”¨:

```
$ echo The named pipe filename is >(true)
The named pipe filename is /dev/fd/63
```

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨å°è¯•åœ¨æ­¤åç«‹å³è®¿é—®å®ƒï¼Œæ‚¨ä¼šå‘ç°å®ƒå·²ç»æ¶ˆå¤±äº†:

```
$ ls /dev/fd/63
ls: /dev/fd/63: Bad file descriptor
```

å› æ­¤ï¼Œå°†æ‰€æœ‰è¿™äº›æ”¾åœ¨ä¸€èµ·ï¼Œä¸Šé¢è¿™ä¸ªå°´å°¬çš„è„šæœ¬å°±å˜æˆäº†:

```
*#!/bin/bash*
set -eexec **>** **>(**awk '{ print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }'**)** 2>&1apt-get update
apt-get install -y foo
systemctl restart foo.service
```

# è­¦å‘Š:è¿™æ˜¯ Bashï¼Œä¸æ˜¯ sh

`sh`ä¸æ˜¯è¿å¤´ç—›å‡»ã€‚`sh`æ˜¯ä¸€ä¸ªå†å²æ¯” Bash è¿˜è€çš„ shellã€‚å°½ç®¡`/bin/sh`å¯èƒ½æŒ‡å‘ä¸ Bash ç›¸åŒçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½†æ˜¯å½“ Bash ä½œä¸º`sh`è¿è¡Œæ—¶ï¼Œå®ƒå°†ä»¥ä¸€ç§â€œé—ç•™æ¨¡å¼â€æ‰§è¡Œï¼Œå¹¶ç¦ç”¨ä¸€äº›ç‰¹æ€§ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨çš„ shell è„šæœ¬ä½¿ç”¨äº†è¿™ç¯‡åšå®¢ä¸­æè¿°çš„æŠ€å·§ï¼Œè¯·ç¡®ä¿æ‚¨çš„ shebang è¡Œæ˜¯`#!/bin/bash`è€Œä¸æ˜¯`#!/bin/sh`ã€‚

# è­¦å‘Š:å—ç¼“å†²

å¦‚æœå‘½ä»¤çš„è¾“å‡ºè¢«é‡å®šå‘åˆ°ç®¡é“ï¼Œå‘½ä»¤çš„è¡Œä¸ºä¼šæœ‰ä¸€ç‚¹ä¸åŒã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œå‘½ä»¤ä½¿ç”¨*è¡Œç¼“å†²*ï¼Œè¿™æ„å‘³ç€æ¯å½“å®ƒä»¬æ‰“å°å®Œä¸€ä¸ªå®Œæ•´çš„è¡Œï¼Œè¯¥è¡Œå°†è¢«å†™å…¥ç»ˆç«¯ã€‚

ä½†æ˜¯å½“è¾“å‡ºè¢«é‡å®šå‘åˆ°ä¸æ˜¯ç»ˆç«¯çš„ä¸œè¥¿æ—¶ï¼Œé‚£ä¹ˆå‘½ä»¤å°†ä½¿ç”¨*å—ç¼“å†²*ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å®é™…ä¸Šå¹¶æ²¡æœ‰å†™å‡ºå®ƒä»¬æƒ³è¦æ‰“å°çš„å†…å®¹ï¼›ç›´åˆ°è¾¾åˆ°é˜ˆå€¼ï¼Œæˆ–è€…ç›´åˆ°å‘½ä»¤é€€å‡ºã€‚è¿™ä¸ªé˜ˆå€¼å¤§çº¦ä¸º 16 KBã€‚æ‚¨å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°å—ç¼“å†²çš„ä½œç”¨:

```
python -c 'import time; print("x" * (1024 * 15)); time.sleep(10)' | cat
```

è¿™ä¸ª Python å‘½ä»¤å°† 15 KB çš„æ•°æ®æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºï¼Œç„¶åä¼‘çœ  10 ç§’é’Ÿã€‚è¾“å‡ºé€šè¿‡ç®¡é“ä¼ è¾“åˆ° catã€‚è¯·æ³¨æ„ï¼Œåœ¨ 10 ç§’é’Ÿçš„ç¡çœ æœŸé—´ï¼Œä¸ä¼šæ‰“å°ä»»ä½•å†…å®¹ã€‚åªæœ‰åœ¨ 10 ç§’é’Ÿåï¼Œå®ƒæ‰ä¼šæ‰“å°ä¸€äº›ä¸œè¥¿ã€‚

å¦‚æœæ‚¨å°†`15`å¢åŠ åˆ°`16`ï¼Œé‚£ä¹ˆæ‚¨å°†ç«‹å³çœ‹åˆ°è¾“å‡ºã€‚

å¦‚æœè¿™ç§è¡Œä¸ºå¯¹æ‚¨æ¥è¯´æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆæœ‰å„ç§æ–¹æ³•æ¥å¼ºåˆ¶è¡Œç¼“å†²:

# Linuxï¼ŒFreeBSD

åœ¨ Linux å’Œ FreeBSD ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ [stdbuf](https://linux.die.net/man/1/stdbuf) ã€‚å°†å®ƒä½œä¸ºä»»ä½•è¦å¼ºåˆ¶è¡Œç¼“å†²çš„å‘½ä»¤çš„å‰ç¼€:

```
stdbuf -oL python -c 'import time; print("x" * (1024 * 15)); time.sleep(10)' | cat
```

# é©¬ç§‘æ–¯

åœ¨ macOS ä¸Šï¼Œå¯ä»¥ä» Homebrew å®‰è£… stdbufã€‚è¿™æ˜¯ã€Šå¤å…°ç»ã€‹çš„ä¸€éƒ¨åˆ†ã€‚

```
brew install coreutils
/usr/local/opt/coreutils/libexec/gnubin/stdbuf -oL python -c 'import time; print("x" * (1024 * 15)); time.sleep(10)' | cat
```

# è®¡ç®—æœºç¼–ç¨‹è¯­è¨€

å¯¹äº Python è„šæœ¬ï¼Œæ‚¨å¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡`PYTHONUNBUFFERED=1`ï¼Œå®ƒå‘Šè¯‰ Python å®Œå…¨ç¦ç”¨ä»»ä½•ç±»å‹çš„è¾“å‡ºç¼“å†²ã€‚

# Awk æ›¿ä»£æ–¹æ¡ˆçš„æ³¨æ„äº‹é¡¹

Awk æœ‰å¤šç§å®ç°ï¼Œå…·æœ‰ä¸åŒçš„ç‰¹æ€§ã€‚åœ¨ Linux ä¸Šï¼Œæ‚¨é€šå¸¸ä¼šä½¿ç”¨ GNU å®ç°ã€‚åœ¨ macOS ä¸Šï¼Œæ‚¨å°†ä½¿ç”¨ BSD å®ç°ã€‚å¦‚æœæ‚¨æ‰“ç®—ç¼–å†™è¿è¡Œåœ¨å¤šä¸ªæ“ä½œç³»ç»Ÿä¸Šçš„ shell è„šæœ¬ï¼Œé‚£ä¹ˆä¸€å®šè¦åœ¨æ‚¨æ‰“ç®—æ”¯æŒçš„æ‰€æœ‰å¹³å°ä¸Šè¿›è¡Œæµ‹è¯•ã€‚

äº‹å®ä¸Šï¼ŒmacOS ä¸Šçš„ Awk å®ç°å¹¶ä¸æ”¯æŒ`strftime`åŠŸèƒ½ï¼

```
$ echo hi | awk '{ print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }'
/usr/bin/awk: calling undefined function strftime
 input record number 1, file
 source line number 1
```

æ‚¨å¯ä»¥ä½¿ç”¨ Perl ä½œä¸ºæ›¿ä»£ã€‚Perl ä¹Ÿè¢«å¹¿æ³›å®‰è£…ã€‚

```
$ echo hi | perl -pe 'use POSIX strftime; print strftime "[%Y-%m-%d %H:%M:%S%z] ", localtime; STDOUT->flush()'
[2020-04-27 15:13:33+0200] hi
```

æˆ–è€…ä½ å¯ä»¥æ˜ç¡®åœ°å®‰è£… GNU å®ç°å¹¶ä½¿ç”¨å®ƒã€‚GNU å®ç°ä¹Ÿè¢«ç§°ä¸º`gawk`:

```
$ brew install gawk
$ echo hi | gawk '{ print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }'
[2020-04-27 15:15:51] hi
```

# å…³äº Awk çš„æ›´å¤šä¿¡æ¯

Awk æƒŠäººåœ°å¼ºå¤§ï¼Œå´åˆç®€æ´ï¼è¿™é‡Œæœ‰ä¸€ä¸ª [Awk æ•™ç¨‹](http://www.grymoire.com/Unix/Awk.html)ã€‚æ›´å¤šæ·±å…¥çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [GNU Awk ç”¨æˆ·æŒ‡å—](https://www.gnu.org/software/gawk/manual/gawk.html)ã€‚

ç¥ä½ å¥½è¿ï¼Œä¸è¦å®³æ€•è¢«`awk`ç—…æˆ¿ã€‚ğŸ™ƒ

*åŸè½½äº 2020 å¹´ 4 æœˆ 26 æ—¥ https://www.joyfulbikeshedding.com**[*ã€‚*](https://www.joyfulbikeshedding.com/blog/2020-04-26-prefixing-your-commands-or-scripts-with-a-timestamp.html)*