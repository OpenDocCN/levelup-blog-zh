<html>
<head>
<title>useOnlineStatus — A React hook to know when your app is offline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">useOnlineStatus——一个React钩子，知道你的应用程序何时离线</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/useonlinestatus-a-react-hook-to-know-when-your-app-is-offline-2d06e4e536a?source=collection_archive---------1-----------------------#2021-03-29">https://levelup.gitconnected.com/useonlinestatus-a-react-hook-to-know-when-your-app-is-offline-2d06e4e536a?source=collection_archive---------1-----------------------#2021-03-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/4ca749d813962ee405385a20a9833f24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qzJP3m353jRh1WXDajX1Lw.jpeg"/></div></div></figure><p id="230c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我最近在做一个客户的渐进式网络应用(PWA)项目，偶然发现了一个有趣的问题。我需要一种可重复使用的方法来知道应用程序是在线还是离线。该票有以下要求:</p><ul class=""><li id="aca2" class="kz la it kd b ke kf ki kj km lb kq lc ku ld ky le lf lg lh bi translated">我们需要能够直观地显示应用程序是在线还是离线</li><li id="d545" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky le lf lg lh bi translated">我们需要处理设备可能连接到网络，但互联网连接很弱或不存在的情况。</li></ul><p id="e0bd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你准备接受挑战，在阅读本文的其余部分之前，请随意尝试自己做这件事。</p><p id="c9f6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，所有代码示例都在Typescript中，但是在删除类型后，在Javascript中应该是一样的。</p><p id="a5cf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因为我们需要在应用程序的多个部分使用这种状态，所以我认为钩子是解决这个问题的好方法，同时还可以重用。如果你不熟悉react中的钩子，官方文档是一个很好的起点(<a class="ae ln" href="https://reactjs.org/docs/hooks-intro.html" rel="noopener ugc nofollow" target="_blank">https://reactjs.org/docs/hooks-intro.html</a>)。这个定制钩子有多种用途，作为用户的状态指示器，让用户知道是否应该进行API调用或者何时在应用程序中缓存信息。</p><p id="ab13" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们可以通过使用大多数浏览器(<a class="ae ln" href="https://developer.mozilla.org/en-US/docs/Web/API/NavigatorOnLine/onLine" rel="noopener ugc nofollow" target="_blank">导航器)中的<code class="fe lo lp lq lr b">window</code>上的<code class="fe lo lp lq lr b">navigator.onLine</code>属性轻松解决第一个问题。在线文档</a>)。它几乎可以在所有浏览器中广泛使用。我们从一个简单的钩子开始，看起来像这样。</p><figure class="ls lt lu lv gt ju"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="649a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">钩子使用React context使值在应用程序中可访问，并且在每次导入钩子时不会重复。你会看到我们从文件中导出了两个东西，一个<code class="fe lo lp lq lr b">OnlineStatusProvider</code>和一个<code class="fe lo lp lq lr b">useOnlineStatus</code>钩子。</p><p id="bf6c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们需要确保用我们的<code class="fe lo lp lq lr b">OnlineStatusProvider</code>包装将要使用我们的钩子的组件，以便我们的<code class="fe lo lp lq lr b">OnlineStatusContext</code>在所有子组件中都可用。如果我们要在应用程序的多个地方使用这个状态，我们可以把它放在我们的<code class="fe lo lp lq lr b">App.tsx</code>文件中，如下所示:</p><figure class="ls lt lu lv gt ju"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="8e71" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后我们可以像这样在我们的<code class="fe lo lp lq lr b">Home</code>组件中使用<code class="fe lo lp lq lr b">useOnlineStatus</code>。</p><figure class="ls lt lu lv gt ju"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="1ba4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">很好，现在我们有了一个钩子，它会告诉我们应用程序是否有网络连接。在很多应用程序中，这应该足够了，但是有些情况下我们需要更复杂的东西。我们只解决了第一个要求，这是因为:</p><ol class=""><li id="b158" class="kz la it kd b ke kf ki kj km lb kq lc ku ld ky ly lf lg lh bi translated">浏览器会告诉您您的设备是否连接到任何网络，而不是专门连接到互联网。这意味着，如果您的互联网连接断开，但网络保持连接，应用程序将仍然认为它是在线的。</li><li id="60d8" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky ly lf lg lh bi translated">移动设备通常会有一个问题，即它们连接网络的时间太长，这可能会导致网络看起来处于连接状态。但我相信我们都经历过连接的速度或可靠性使其无法使用。</li></ol><p id="a403" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你的应用可以解决上面的问题，你可以就此打住。但是，通过尝试定期接触网络，解决这些问题是相当容易的。</p><p id="7bd5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们可以向我们的应用程序添加一个非常小的文件<code class="fe lo lp lq lr b">ping.txt</code>,我们可以在我们的应用程序中随时获取它，以确定我们是否有网络连接。该文件甚至可以是空的。然后，我们可以将获取请求设置为在一定时间后超时，以确保我们能够处理超慢的网络。</p><p id="c0b3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">修改后，我们的钩子看起来像这样:</p><figure class="ls lt lu lv gt ju"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="194a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你可以看到我们做了几件事:</p><ol class=""><li id="6906" class="kz la it kd b ke kf ki kj km lb kq lc ku ld ky ly lf lg lh bi translated">我们添加了一个<code class="fe lo lp lq lr b">checkOnlineStatus</code>函数，我们可以调用它来检查我们的资源是否可以在网络上被访问。</li><li id="9e07" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky ly lf lg lh bi translated">我们每隔10000毫秒(10秒)调用这个<code class="fe lo lp lq lr b">checkOnlineStatus</code>函数来检查我们是否能获得这个资源。如果获取失败或耗时超过3秒，我们将中止请求并更新在线值。</li><li id="9aa4" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky ly lf lg lh bi translated">我们删除了网络联机时的事件侦听器，这是因为我们希望在再次连接时确保互联网连接，而不仅仅是网络连接。</li></ol><p id="191a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以根据自己的需要调整这些时间和值，只需更改文件顶部的常量即可。</p><p id="e563" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">至此，我们已经满足了所有最初的需求。</p><ol class=""><li id="6de7" class="kz la it kd b ke kf ki kj km lb kq lc ku ld ky ly lf lg lh bi translated">我们有一个钩子可以告诉我们应用程序是离线还是在线。</li><li id="50cf" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky ly lf lg lh bi translated">我们还解决了连接速度慢或无法连接到互联网的问题。</li><li id="b487" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky ly lf lg lh bi translated">钩子应该在状态改变时快速更新值，并触发我们的应用程序进行更新。</li></ol><p id="9bf5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你喜欢这篇文章，请随时给我一个👏，在Medium上关注我，或者与他人分享这篇文章。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="6373" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">大家好，我是Patrick，我指导开发人员如何为不断变化的世界构建现代Web应用程序。欢迎在<a class="ae ln" href="https://www.linkedin.com/in/patrick-czeczko/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或<a class="ae ln" href="https://patrickcze.medium.com/" rel="noopener"> Medium </a>上关注我，了解更多内容。</p></div></div>    
</body>
</html>