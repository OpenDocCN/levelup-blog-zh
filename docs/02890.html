<html>
<head>
<title>Implementing a REST API with AWS (API Gateway, Lambda, and DynamoDB)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用AWS实现REST API(API Gateway、Lambda和DynamoDB)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/implementing-a-rest-api-with-aws-api-gateway-lambda-and-dynamodb-c62b8a1f6182?source=collection_archive---------3-----------------------#2020-04-09">https://levelup.gitconnected.com/implementing-a-rest-api-with-aws-api-gateway-lambda-and-dynamodb-c62b8a1f6182?source=collection_archive---------3-----------------------#2020-04-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5265" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这只是一个关于如何实现REST API的简短教程，它使用AWS API Gateway将请求路由到可以查询数据库(DynamoDB)的Lambda函数(NodeJS)。这是我第一次使用所有这些AWS服务，所以我确信有“更好的”方法来实现它，但作为一名黑客，我选择了阻力最小的方法。当然欢迎反馈。</p><p id="d2f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 1。登录你的AWS账户并导航到DynamoDB </strong></p><p id="ceee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2。在Dynamo中创建一个表</strong></p><p id="e539" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们现在可以把所有的信息存储在一个表中。点击<strong class="jp ir">创建表格</strong>，然后使用这些设置:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/beeecf2bd4681dbd2340d20756b19f7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e4DJnGVXfpqQ8325pteUxw.png"/></div></div></figure><p id="be0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用<strong class="jp ir"> <em class="kx">下的<strong class="jp ir"> <em class="kx">默认设置页面的</em> </strong>部分。</em></strong></p><p id="e7cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 3。向我们创建的表中添加一条记录</strong></p><p id="0d8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Dynamo中创建表后，您将进入表管理页面。选择<strong class="jp ir">项目页签</strong> <em class="kx"> </em>然后点击<strong class="jp ir">创建项目</strong> <em class="kx">。用户界面包含了我们用来创建表的分区键。切换到左上角的<strong class="jp ir"> <em class="kx">文本</em> </strong>模式并创建该对象可能更容易:</em></p><p id="8e71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">{ <br/> "UserId": "id_12345 "，<br/> "FirstName": "Chris "，<br/> "LastName": "Spirito" <br/> }</p><p id="2e1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<strong class="jp ir">保存</strong>，您将在表格中看到新项目。这只是放在这里，这样一旦我们编写了示例代码，我们就有了查询的对象。</p><p id="a439" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 4。创建一个Lambda函数</strong></p><p id="6551" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是AWS将为我们运行的代码段。每当我们要求它。我们要做的是创建一个REST API端点，它调用Lambda函数来返回从DynamoDB查询的数据。点击左上角的<strong class="jp ir"> AWS </strong>图标，然后从服务列表中找到<strong class="jp ir"> Lambda </strong>并选择它。这将把你带到<strong class="jp ir"> Lambda Functions </strong>视图，但是如果它不只是从左边的选项中选择<strong class="jp ir">函数</strong>。点击<strong class="jp ir">创建功能</strong>并从头开始使用<strong class="jp ir"> <em class="kx">作者</em> </strong>选项。基本信息应该是这样的:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ky"><img src="../Images/d446e9949e1d985363d2df2acfde3b6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VndxaBcSiGVN7Jsbx36AIA.png"/></div></div></figure><p id="dee2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将分别更新权限，因此您可以暂时保留该部分。一旦你点击<strong class="jp ir">创建功能</strong>，你将进入Lambda功能的<strong class="jp ir"> <em class="kx">配置</em> </strong>部分。你应该在<strong class="jp ir"> <em class="kx">功能代码</em> </strong>窗口看到一些看起来有点大眼熟的代码。这是我们将更新的代码，以处理我们的请求。</p><p id="47fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 5。在IAM中创建一个角色</strong></p><p id="7090" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要创建一个AWS角色，它将允许<strong class="jp ir"> Lambda函数</strong>与<strong class="jp ir"> DynamoDB </strong>进行对话，并被允许运行。让我们创建一个具有这些权限的角色。再次点击<strong class="jp ir"> AWS </strong>图标，这次从AWS服务列表中搜索<strong class="jp ir"> IAM </strong>并选择它。从左侧选项中选择<strong class="jp ir">角色</strong>。点击<strong class="jp ir"> <em class="kx">创建角色</em> </strong>，确保顶部的<strong class="jp ir"> <em class="kx"> AWS服务</em> </strong>被选中。选择<strong class="jp ir"><em class="kx">λ</em></strong>作为用例，然后点击<strong class="jp ir"> <em class="kx">下一步:权限</em> </strong>。现在，我们有机会附加一些策略，规定允许哪个服务做什么以及它们可以与谁对话。我们需要添加两个服务:<strong class="jp ir"><em class="kx">awslambdabasiceexecutionrole</em></strong>和<strong class="jp ir"><em class="kx">AmazonDynamoDBFullAccess</em>。</strong>搜索这些角色，并勾选左侧的复选框。完成后，点击<strong class="jp ir"> <em class="kx">下一步:标签。</em> </strong>我们不会添加任何标签，因此您可以单击<strong class="jp ir"> <em class="kx">下一步:查看。</em> </strong></p><p id="f805" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">给角色起个名字。我选择了<strong class="jp ir"> <em class="kx"> CT_AWS_Role </em> </strong>作为<strong class="jp ir"> <em class="kx"> Rolle名称</em> </strong>。你应该看到我们添加的两个<strong class="jp ir"> <em class="kx">政策</em> </strong>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kz"><img src="../Images/de60c6a52d4c789669b4c3b1528ae74c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cIYDWr3d0FNZs4UMoWyrkg.png"/></div></div></figure><p id="4c8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">新角色现在应该在您的列表中:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi la"><img src="../Images/a7a547b6ac548c07f84089403ad61d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2mGQ1ewwZWGeXuo_QE2Q4w.png"/></div></div></figure><p id="9870" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 6。将角色应用于Lambda函数</strong></p><p id="0850" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过AWS控制台切换回<strong class="jp ir">λ</strong>，然后选择<strong class="jp ir"> <em class="kx">权限</em> </strong> <em class="kx"> </em>选项卡，在这里定义<strong class="jp ir"> <em class="kx">执行角色</em> </strong> <em class="kx"> </em>。当你创建λ函数时，AWS会自动为你创建一个角色，因此有了这个有趣的名字。这个角色允许Lambda函数将日志条目写入到<strong class="jp ir"> <em class="kx"> CloudWatch </em> </strong>中，这是我们以后可以考虑做的事情。将<strong class="jp ir"> <em class="kx">执行角色</em> </strong>更改为我们刚刚创建的角色<strong class="jp ir"> <em class="kx"> CT_AWS_Role </em> </strong>，这样我们就可以调用<strong class="jp ir"> DynamoDB </strong>。点击<strong class="jp ir">编辑</strong>，然后在<strong class="jp ir">现有角色</strong> <em class="kx">下选择您创建的角色。</em></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lb"><img src="../Images/df62c6260607f0b11864c70a25d6da9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WX7hr62-OTjPBokoM9GTMA.png"/></div></div></figure><p id="e00b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<strong class="jp ir">保存</strong>，你将回到<strong class="jp ir">配置</strong>选项卡。</p><p id="9ba9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 7。测试Lambda函数，看看它是否能与DynamoDB </strong>对话</p><p id="1be4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">终于我们可以写一些代码了！用这段代码替换index.js的内容。需要检查的一件事是您所连接的AWS区域。如果您查看AWS浏览器窗口的右上角，您会看到您所在的地区:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lc"><img src="../Images/9a43c5c44f907190200c010cbdc4193a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*waywwDwUN2utFeTI1Hn7bg.png"/></div></div></figure><p id="9962" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在代码的区域属性中使用相应的区域名称(例如us-east-1 ):</p><pre class="km kn ko kp gt ld le lf lg aw lh bi"><span id="610e" class="li lj iq le b gy lk ll l lm ln">const AWS = require (‘aws-sdk’);<br/>const TABLE = “CT_Contacts”</span><span id="7355" class="li lj iq le b gy lo ll l lm ln">const dynamoDb = new AWS.DynamoDB.DocumentClient({<br/>  region: ‘us-east-1’<br/>});</span><span id="4f9d" class="li lj iq le b gy lo ll l lm ln">exports.handler = async (event) =&gt; {<br/> <br/> const _id = “id_12345”;<br/> <br/> const params = {<br/>   TableName: TABLE,<br/>   Key: {<br/>     “UserId”: _id<br/>   }<br/> };<br/> <br/> const data = await dynamoDb.get(params).promise();</span><span id="eb4f" class="li lj iq le b gy lo ll l lm ln"> const response = {<br/>   isBase64Encoded: false,<br/>   headers: {“Content-Type”: “application/json”}<br/> };<br/> <br/> if ((typeof data) === “object”) {<br/>   response.statusCode = 200;<br/>   response.body = JSON.stringify(data);<br/> } else {<br/>   response.statusCode = 500;<br/> }</span><span id="2ae3" class="li lj iq le b gy lo ll l lm ln"> return response;<br/>};</span></pre><p id="61b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">按下<strong class="jp ir">保存</strong>按钮保存</strong>你的代码，然后让我们运行一个测试看看它是否工作。点击<strong class="jp ir">测试</strong>下拉箭头，选择<strong class="jp ir"> <em class="kx">配置事件</em> </strong>。给事件起一个名字，如<strong class="jp ir"> <em class="kx"> TestEvent </em> </strong>并保持输入不变，或者您可以完全删除输入并保持{}:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lp"><img src="../Images/e9e6fe732ed8e553cffc3531b1239499.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6xvoqsFHb4ThtOxfMkNj4g.png"/></div></div></figure><p id="0c21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<strong class="jp ir">创建</strong>，将返回代码编辑窗口。接下来点击<strong class="jp ir">测试</strong>，你会在<strong class="jp ir"> <em class="kx">执行结果</em> </strong>窗口中看到以下内容:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lq"><img src="../Images/5d8acf8c64487cfaf9d2fed4710cd257.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AOj6WCNIBfiPJsHj90L_kQ.png"/></div></div></figure><p id="dce0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你看到来自<strong class="jp ir"> DynamoDB </strong>的数据，万岁！否则，我们需要进行一些故障诊断，找出问题所在。</p><p id="9b11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8。现在让我们创建一个REST端点，我们可以用它来调用Lambda函数</p><p id="f196" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">导航到AWS -&gt; <strong class="jp ir"> <em class="kx"> API网关</em> </strong>，这样我们就可以创建我们的端点了。它应该会让你进入<strong class="jp ir">API</strong><em class="kx"/>配置屏幕，但是如果它没有从左侧栏中选择<strong class="jp ir">API</strong><em class="kx"/>。</p><p id="b38b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<strong class="jp ir">创建API </strong>按钮。</p><p id="1788" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向下滚动并找到<strong class="jp ir"> REST API </strong> <em class="kx"> </em>并点击<strong class="jp ir">构建</strong>。使用以下设置(确保选择<strong class="jp ir"> <em class="kx">边缘优化</em> </strong>)作为端点类型。这并不重要，但由于我们的应用程序是通过CloudFlare部署的，我们还可以使用边缘优化:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lr"><img src="../Images/a9a671346af232c8bea19474fe20641b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*efnENqCySJ0Ld6XTqCHbgQ.png"/></div></div></figure><p id="a190" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<strong class="jp ir">创建API </strong>，您将进入<strong class="jp ir"> API </strong>方法部分。</p><p id="9625" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<strong class="jp ir">动作</strong>，然后<strong class="jp ir">创建资源</strong>，这将允许您创建一个<em class="kx">新子资源</em> <strong class="jp ir"> : </strong></p><p id="7105" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下设置:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ls"><img src="../Images/6b8af7eb22210e84238214a77b4fcbc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vv6TAFOglgkV-cXU1Nfnxw.png"/></div></div></figure><p id="5836" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<strong class="jp ir">创建资源</strong></p><p id="9842" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将使你进入资源设置的<strong class="jp ir">部分。这是定义被调用的Lambda函数的地方。</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lt"><img src="../Images/55b03eb1bac3bfd0a8076b622a716931.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TK4Uxcsz_CF31OlPxW7lcw.png"/></div></div></figure><p id="aea3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您点击<strong class="jp ir">保存</strong>时，您必须确认您正在添加一个连接到API的Lambda函数的权限:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lu"><img src="../Images/2e584e86d5dd3dbcd531cf7f54d5b76d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SgxvhbNunc2Q1NOc3Y0AIg.png"/></div></div></figure><p id="3f25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将使您进入我们创建的资源，并向您显示<strong class="jp ir"> <em class="kx">方法执行</em> </strong>:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lv"><img src="../Images/af00d802f8409c61529eb60ac36a6d13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RhKcZe5ozJHpifZViR4kuA.png"/></div></div></figure><p id="7f2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们必须<strong class="jp ir">部署API </strong>，它将创建我们可以调用的端点来测试这个。点击<strong class="jp ir">动作</strong>，然后<strong class="jp ir">部署API </strong>。您将不得不创建一个新的<strong class="jp ir"> <em class="kx">部署阶段。</em> </strong>现在使用以下设置:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lw"><img src="../Images/43d6184cfda46a01e6c6ae91dccd870d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3W3eFwylLDeKF5NCcrsZkw.png"/></div></div></figure><p id="218f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<strong class="jp ir">部署</strong></p><p id="1115" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们有了URL端点:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ls"><img src="../Images/150443efe08bbce0fc937ec1392b242a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XUYAK9q3FosEBcvdqIiONg.png"/></div></div></figure><p id="a748" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们不需要设置这个API的任何其他属性。让我们来测试一下。在浏览器中打开URL:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lx"><img src="../Images/1927e2de2e3e105d82b3f8f6aeffc8d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F5mTRpuH3qLbSLGP48AjWg.png"/></div></div></figure><p id="047e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">哦不！不是我们所期待的！我希望能看到我们Lambda的数据。但这没什么大不了的，因为我们在创建资源时就被警告过，如果我们想让根/资源进行路由，我们就必须为此创建一个单独的资源。只需在url末尾添加任何内容，您就会看到我们所期待的内容:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ly"><img src="../Images/23b14d2b94b8dfb576728cd8b6a09e00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IY1ab4JsoOtkON_83ai4hA.png"/></div></div></figure><p id="d46c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">非常刺激！所以现在我们的<strong class="jp ir"> API </strong>正在传递给我们的<strong class="jp ir"> Lambda </strong>函数，该函数然后调用<strong class="jp ir"> DynamoDB </strong>来获取数据。我们现在正在巡航。</p><p id="d372" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">9。了解API URL: </p><pre class="km kn ko kp gt ld le lf lg aw lh bi"><span id="0df9" class="li lj iq le b gy lk ll l lm ln"><strong class="le ir">https://</strong> <a class="ae lz" href="http://uzrvpextp9.execute-api.us-east-1.amazonaws.com/" rel="noopener ugc nofollow" target="_blank"><strong class="le ir">uzrvpextp9.execute-api.us-east-1.amazonaws.com</strong></a><strong class="le ir"> /devel /contacts</strong></span></pre><p id="2cf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">https:// :这就是所谓的方案，所以在网络浏览器中通常是http://或https://取决于你是否安全。</p><p id="fc84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">uzrvpept 9 . execute-API . us-east-1。:</strong>子域。</p><p id="e8b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lz" href="http://amazonaws.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"/></a>:二级和顶级域名。</p><p id="297e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> /devel </strong>:这是我们在上一节中部署的API阶段。这允许我们有不同的阶段，以防我们想在推向生产或另一个用例(有很多)之前在开发中执行测试</p><p id="90e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> /contacts </strong>:这是我们在上一节中设置的{proxy+}，它将所有变量传递给我们的<strong class="jp ir"> Lambda </strong>函数供我们使用。另一个选择是将GET/PUT/DELETE/… API调用分别映射到不同的lambda函数，如果我们的应用程序更复杂，这可能是有意义的，但考虑到我们要完成的任务，这应该足够了。</p><p id="4949" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此处有记录:<a class="ae lz" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-set-up-simple-proxy.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/API gateway/latest/developer guide/API-gateway-set-up-simple-proxy . html</a></p><p id="6380" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 10。对通过</strong>传递的代理变量做一些事情</p><p id="0d17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是我们不得不戴上黑客开发者帽子的地方，因为文档对我来说不是很清楚，所以我做了以下事情。既然<strong class="jp ir"> Lambda </strong>函数正在工作，并且<strong class="jp ir"> API </strong>网关也正在工作，让我们回到Lambda代码并做两处修改:</p><pre class="km kn ko kp gt ld le lf lg aw lh bi"><span id="e409" class="li lj iq le b gy lk ll l lm ln"><strong class="le ir">Change export.hanlder to:</strong></span><span id="4ce8" class="li lj iq le b gy lo ll l lm ln">exports.handler = async (event, context, callback) =&gt; {</span><span id="c3d8" class="li lj iq le b gy lo ll l lm ln"><strong class="le ir">Add this line just before the return:</strong></span><span id="f8ac" class="li lj iq le b gy lo ll l lm ln">response.body = JSON.stringify(event);</span></pre><p id="d8a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将允许我们看到什么被传递到Lambda中，这样我们就知道如何获取我们需要的东西。我们通常会使用console.log消息来做到这一点，但这需要我们转到<strong class="jp ir"> CloudWatch </strong>日志，这是一种更简单的黑客方式。重新加载页面，您将看到以下内容:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ma"><img src="../Images/ad5068d23a806f57d8435f851f257389.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r6GlV3IoB_Ylwt7i-F28ZQ.png"/></div></div></figure><p id="456e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个很好的信息，对不对？但是格式是垃圾。所以只要在<strong class="jp ir">网络</strong>标签下打开这个，选择<strong class="jp ir"> <em class="kx">联系人？id=blah </em>从<strong class="jp ir">名称</strong>列，然后<strong class="jp ir">预览。</strong>这将为您提供以下观点:</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mb"><img src="../Images/fff2771df7a4a36e85eed7bfb31651b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NkjEhWp1fbykxzu3UOrbDQ.png"/></div></div></figure><p id="0320" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更容易处理，对吗？</p><p id="d101" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，让我们在lambda中实现一个GET to /contacts，如果用户传入一个Id，我们将在数据库中搜索它并返回结果。</p><p id="c4ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以把你的网址改成:</p><pre class="km kn ko kp gt ld le lf lg aw lh bi"><span id="9acd" class="li lj iq le b gy lk ll l lm ln">https://&lt;your_url&gt;/devel/contacts?id=blah</span></pre><p id="5b2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如你所见，我在<strong class="jp ir">中添加了？</strong>表示其余的URL都是以<strong class="jp ir"><em class="kx">variable _ name = value</em></strong>的形式传递的查询参数。我在上面使用<strong class="jp ir"> <em class="kx"> blah </em> </strong>的原因是为了让我可以在结果中轻松找到它。如果我选择id=1或id=a，考虑到重叠部分，可能会有点棘手。查看结果，我发现我们感兴趣的是:</p><p id="b7a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将对其进行测试，以确保它等于“GET”</p><p id="5ba3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">pathParameters.proxy 将从URL中给我们提供/xxx</p><p id="c291" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">query string parameters . id</strong>它将给出我们应该搜索的Id。</p><p id="5181" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们确保我们能正确地提取这些。在<strong class="jp ir"> Lambda </strong>函数中，将以下行添加到返回中:</p><pre class="km kn ko kp gt ld le lf lg aw lh bi"><span id="dc2d" class="li lj iq le b gy lk ll l lm ln"><strong class="le ir">add this line:</strong></span><span id="0c57" class="li lj iq le b gy lo ll l lm ln">var _myValues = `${event.httpMethod} — ${event.pathParameters.proxy} — ${event.queryStringParameters.id}`;</span><span id="242b" class="li lj iq le b gy lo ll l lm ln"><strong class="le ir">update this line:</strong></span><span id="92b2" class="li lj iq le b gy lo ll l lm ln">response.body = _myValues;</span></pre><p id="58fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">刷新页面，您应该会看到:</p><p id="32f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个挑战，下面是一个解决方案。将Lambda函数重写为:</p><ul class=""><li id="4f55" class="mc md iq jp b jq jr ju jv jy me kc mf kg mg kk mh mi mj mk bi translated">接受传入id变量的<strong class="jp ir"> /contacts </strong>的<strong class="jp ir"> GET </strong>请求。<strong class="jp ir">举例</strong>:/联系人？id=id_12345</li><li id="eb88" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">返回状态码<strong class="jp ir"> <em class="kx"> 200 OK </em> </strong></li><li id="c65f" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">从主体中的数据库返回对象</li><li id="2318" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">如果路径不是<strong class="jp ir">/触点</strong>返回状态码<strong class="jp ir"> <em class="kx"> 404未找到</em> </strong></li><li id="3e5f" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">如果路径是<strong class="jp ir">/触点</strong>但方法不是<strong class="jp ir">得到</strong>返回状态码<strong class="jp ir"> <em class="kx"> 405方法不允许</em> </strong></li><li id="b8be" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">如果有数据库错误(从数据库返回的数据不是object类型)，则返回状态代码<strong class="jp ir"> <em class="kx"> 500内部服务器错误</em> </strong></li></ul></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><p id="7708" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">一个解决方案:</strong></p><pre class="km kn ko kp gt ld le lf lg aw lh bi"><span id="815f" class="li lj iq le b gy lk ll l lm ln">const AWS = require ('aws-sdk');<br/>const TABLE = "CT_Contacts"<br/><br/>const dynamoDb = new AWS.DynamoDB.DocumentClient({<br/>    region: 'us-east-1'<br/>});<br/><br/>// Reference for HTTP Response Codes<br/>// https://developer.mozilla.org/en-US/docs/Web/HTTP/Status<br/><br/>exports.handler = async (event, context, callback) =&gt; {<br/>    <br/>    // Set variables<br/>    var _httpMethod = event.httpMethod;<br/>    var _proxyPath = event.pathParameters.proxy;<br/>    var _queryStringParameters = event.queryStringParameters == null ? {} : event.queryStringParameters;<br/>    <br/>    // Required format for data that is returned via a AWS API Proxy<br/>    // The four fields required are:<br/>    //   isBase64Encoded, headers, statusCode, body<br/>    <br/>    const response = {<br/>        isBase64Encoded: false,<br/>        headers: {"Content-Type": "application/json"},<br/>        body: ""<br/>    };<br/><br/>    // If _proxyPath is contacts proceed, else return 404 Not Found<br/>    <br/>    if (_proxyPath == "contacts") {<br/>        // Right now we only allow GET Requests for contacts path<br/>        // If the request is good return 200 OK<br/>        // If the request not a GET, return 405 Method not Allowed<br/>        if (_httpMethod == "GET") {<br/>            // Grab the Id<br/>            var _id = _queryStringParameters.hasOwnProperty("id") ? _queryStringParameters.id : "";<br/>            <br/>            // Setup the DynamoDB Input Variables<br/>            const params = {<br/>                TableName: TABLE,<br/>                Key: {<br/>                    "UserId": _id<br/>                }<br/>            };<br/>    <br/>            // Make the call to DynamoDB using await for the promise <br/>            // since the usual approach never executes for some      <br/>            // reason<br/>            <br/>            const data = await dynamoDb.get(params).promise();<br/><br/>            // Check to see that the DB returned something useful<br/>            <br/>            if ((typeof data) === "object") {<br/>                response.statusCode = 200;<br/>                response.body = JSON.stringify(data);<br/>            } else {<br/>                response.statusCode = 500;<br/>            }<br/>        } else {<br/>            response.statusCode = 405;<br/>        }<br/>    } else {<br/>        response.statusCode = 404;<br/>    }<br/><br/>    return response;<br/>};</span></pre></div></div>    
</body>
</html>