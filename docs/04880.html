<html>
<head>
<title>Moving CI from Jenkins to Drone</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将CI从Jenkins转移到Drone</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/moving-ci-from-jenkins-to-drone-deaf7b773583?source=collection_archive---------10-----------------------#2020-07-21">https://levelup.gitconnected.com/moving-ci-from-jenkins-to-drone-deaf7b773583?source=collection_archive---------10-----------------------#2020-07-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/43b76fac954dd4a258f916082176d05d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/1*8wdeljZa1OkThwlkt1JzTQ.png"/></div></figure><p id="f0bf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很长一段时间以来，我们一直使用Jenkins来做CI，没有太多的考虑，它是免费的，它有一个不错的UI和看起来最大的社区。别再找了，对吗？</p><p id="ddd9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">随着我们的代码库变得越来越复杂，CI流程变得越来越难以维护，因为每一位代码都需要自己的代码保姆、测试、报告、归档等，特别是对于我们的单存储库架构，它包括用不同语言编写的各种模块，这些模块需要用自己的工具链来构建。</p><h1 id="e4f2" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">动机</h1><p id="3146" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">我脑海中的一些痛点:</p><p id="7961" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> 1。环境变量。</strong></p><p id="512c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">许多构建任务依赖于一些环境变量来正常工作，每当我看到一些与它们相关的错误时，我会检查主机的值和Jenkins的值，比较并更新它们，调用任务管理器来重新启动进程以使其生效。是啊，这让我想起了98号窗口的美好回忆。</p><p id="67a6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> 2。深度导航</strong></p><p id="f2df" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我知道Jenkins是一个无所不能的CI产品，花一些时间和精力来学习它是有意义的，但迷失在所有这些页面、选项卡和控件中令人沮丧。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/87953743ac4ccd07a41927c844277a89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/0*t72gHMTCyZuyfZNZ.jpg"/></div></figure><p id="eabd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> 3。狂野外挂</strong></p><p id="0818" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">每个插件都有自己的UI组件、文档和问题，你必须经常去社区寻求帮助。</p><p id="f0ab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> 4。詹金斯配置的迁移</strong></p><p id="4a2f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从开发人员的角度来看，CI构建过程越快越好。在我们选择任何其他替代产品之前，我们试图将服务器移动到一台更强大的PC上，但Jenkin配置的迁移并没有带来愉快的回忆。</p><p id="26d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我试图寻找一些导出/导入按钮、配置文件或类似的东西，希望通过一些简单的点击来完成，但现实仍然很残酷，我按照文档中的工具备份和恢复其主文件夹，然后打开两个浏览器选项卡，比较我可能记得的配置项，以免不同的错误嘲笑我低估了任务。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi ma"><img src="../Images/021c498a410c629eb95c991589020747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eBitEWvfNjQuygse.jpg"/></div></div></figure><p id="9cbe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> 5。并行执行</strong></p><ul class=""><li id="7697" class="mf mg iq jw b jx jy kb kc kf mh kj mi kn mj kr mk ml mm mn bi translated">如何让一些步骤并行运行</li><li id="f86e" class="mf mg iq jw b jx mo kb mp kf mq kj mr kn ms kr mk ml mm mn bi translated">我如何确保它们实际上是并行运行的</li></ul><p id="a7a2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通读文档和摸索并行化的过程让我意识到让它们串行运行的想法并没有那么糟糕。</p><h1 id="54f5" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">冒险</h1><p id="373d" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">有一天我们遇到了无人机，它声称是忙碌开发者的CI，听起来很酷，我总是很忙，至少在冠状病毒疫情期间，我以非常忙碌的方式工作。</p><p id="61c4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，你需要对docker或container有一些基本的了解。<strong class="jw ir">图像和容器的关系有点像可执行文件和进程</strong>的关系，一个是静态文件，一个是动态运行的东西。使用相同映像创建的多个容器保证具有完全相同的环境(我指的是运行时库、命令等，当然不是IP、主机名)。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mt"><img src="../Images/c73eacd7f7726dac28cf3426264003fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OoZih93Kn1zysvbL.png"/></div></div></figure><h2 id="52e2" class="mu kt iq bd ku mv mw dn ky mx my dp lc kf mz na lg kj nb nc lk kn nd ne lo nf bi translated"><strong class="ak">服务器</strong></h2><p id="2332" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">整个产品都是围绕容器的概念来设计的，甚至无人机服务器本身也是作为轻量级Docker映像来分发的。该映像是独立的，没有任何外部依赖性。</p><p id="c274" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可以使用下面的命令启动服务器容器。容器是通过环境变量配置的。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi ng"><img src="../Images/3b0a7923e9d21780bb8022fb7d4090de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7O7SQkT-aFD-lJHo.png"/></div></div></figure><h2 id="c6cf" class="mu kt iq bd ku mv mw dn ky mx my dp lc kf mz na lg kj nb nc lk kn nd ne lo nf bi translated"><strong class="ak">亚军</strong></h2><p id="debd" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">无人机运行者轮询服务器以获得要执行的工作负载。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/a8a07077e8e1bbfbce75da86c3ef2a37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/format:webp/1*uSuig-4tHzDCCKr4mop56w.png"/></div></figure><h2 id="8e75" class="mu kt iq bd ku mv mw dn ky mx my dp lc kf mz na lg kj nb nc lk kn nd ne lo nf bi translated">管道</h2><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/23c83f0117b6e0b435a026df9a7c9d5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*1ydunXZyBJ3xI9erpmSZnA.png"/></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">.无人机. yml</figcaption></figure><p id="f621" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这只是一个简单的YAML文件。</p><p id="fd56" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您的配置可以有多个管道，一个管道有多个步骤，这些步骤有一系列命令来满足您的需求。</p><p id="40e5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">每一步都在一个用您指定的映像</strong>创建的隔离容器中运行，因此您不必再担心任何与环境相关的意外。Drone会自动创建一个临时卷，称为您的<strong class="jw ir">工作区</strong>，在那里克隆您的存储库。工作区是管道中每个步骤的当前工作目录。</p><p id="db15" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">默认情况下，管道步骤按顺序执行。<strong class="jw ir">您可以选择使用depends_on </strong>将您的构建步骤描述为一个有向无环图。在上面的例子中，我们扇出以并行执行前两步，然后一旦完成，我们扇入以执行最后一步。</p><p id="41f7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有了一流的容器支持和简单的并行语法，人们不得不设计它们并行运行，以尽可能榨出每一滴汁液。您可以在下面的UI部分轻松跟踪运行状态。</p><h2 id="bc2d" class="mu kt iq bd ku mv mw dn ky mx my dp lc kf mz na lg kj nb nc lk kn nd ne lo nf bi translated"><strong class="ak">用户界面</strong></h2><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nn"><img src="../Images/6d75e1e41441bf1455e5cba5b5104643.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v5aYrROef24bnCEhtsHmaA.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">作业运行状态</figcaption></figure><p id="ad4e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如上图所示，这个提交有两个管道，js-code-coverage和CSharp-code-coverage，每个管道都有自己的步骤。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi no"><img src="../Images/0cad522af27dc58dcc68f4d022e4cf50.png" data-original-src="https://miro.medium.com/v2/resize:fit:636/format:webp/1*firJnoeJxrI2J29OuKvdSg.png"/></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">开发和测试管道并行运行</figcaption></figure><h2 id="e8a1" class="mu kt iq bd ku mv mw dn ky mx my dp lc kf mz na lg kj nb nc lk kn nd ne lo nf bi translated">本地建造奖金</h2><p id="9b09" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">对于Jenkins，如果不将结果提交给服务器并至少去喝一杯咖啡，你就无法知道最终结果，这不再是Drone的情况，因为<strong class="jw ir">它带有一个命令行来运行本地构建</strong>。想象一下，如果你从不打破任何东西，我是说，在公共场合，这会给你带来多少自信和骄傲。</p><p id="9684" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，你可以在自己的电脑上犯任何愚蠢的错误，并在相对较短的时间内看到结果。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi np"><img src="../Images/b29924646aa9ad0d8fa6944a091fa993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*rrobHqtFfOKwsI0WDTtOYg.png"/></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">这个子命令执行本地构建。</figcaption></figure><h1 id="5723" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">高光</h1><p id="f9c4" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">所有的环境变量和插件配置都保存在管道YAML文件中，这使得它易于维护。</p><p id="369d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">足够简单的用户界面，没有太多的信息</p><p id="b225" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">借助一流的容器支持，轻松实现并行化</p><p id="643e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">本地构建和快速反馈</p><p id="b4f5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你真的喜欢编程CI步骤，而不是使用声明性的YAML文件，Drone也有适合你的东西，请查看<a class="ae nq" href="http://A data templating language" rel="noopener ugc nofollow" target="_blank"> Jsonnet </a>，这是一种类似javascript的数据模板语言，用于生成配置数据。</p><h1 id="70d5" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">已知问题</h1><p id="c6f4" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">很难在其仪表板上搜索历史提交，没有搜索框，没有分页。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nr"><img src="../Images/4f7f3d03524f94bcba132ae480f71940.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hFxO7eVdpQhBC5DljQ6TbQ.png"/></div></div></figure><p id="9d64" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果无人机本身或GitHub出现问题，无人机服务器可能会错过一些构建，用户无法在不调用其API端点或检入其他代码的情况下触发重建。</p><h1 id="046a" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">结论</h1><p id="65f1" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">我们对转向无人机的决定感到非常高兴。它使CI不再像以前那样沉重，并帮助我们充分利用容器技术，节省更多的头发在未来拔出。</p><h1 id="7af3" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">参考</h1><p id="474a" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">【https://docs.drone.io/ T2】号</p></div></div>    
</body>
</html>