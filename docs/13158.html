<html>
<head>
<title>Understanding PubSub with Combine in iOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解iOS中的PubSub和Combine</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/understanding-pubsub-with-combine-in-ios-136d1849698b?source=collection_archive---------2-----------------------#2022-08-13">https://levelup.gitconnected.com/understanding-pubsub-with-combine-in-ios-136d1849698b?source=collection_archive---------2-----------------------#2022-08-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="99ad" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解Combine的出版商和订户，把回电留在尘埃里</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/eef088fc58b5978d66b216f27f6b946f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GEbgZotbiGu3mxOt"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">阿卜杜勒拉赫曼·索比在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="21c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Combine是苹果针对像<a class="ae ky" href="https://github.com/ReactiveX/RxSwift" rel="noopener ugc nofollow" target="_blank"> RxSwift </a>这样的流行函数式反应式编程库的第一方解决方案。它使用发布者/订阅者(pub/sub)模式。让我们来分析一下这个模式到底是什么。</p><p id="e5e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你曾经使用过YouTube，你很有可能见过发布/订阅模式。比方说，你想了解苹果发布的最新视频。如果你去苹果的YouTube频道，你会看到一个“订阅”按钮。点击后，当苹果发布新视频时，你会收到提醒。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/3bb169fa4cfbcee4bd4b4ec05c994bc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8IDiNW7y5I3iwwx-Kyq2sw.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">用户可以订阅各种Youtube频道，了解最新视频</figcaption></figure><p id="5259" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是发布/订阅模式的本质。在这个例子中，出版商是苹果公司。希望了解苹果最新内容的用户是订阅者。发布者发布内容后，订阅者会收到通知。然后用户可以用最新的信息做他们想做的事情，比如在他们自己的时间观看最新的视频。订阅各种YouTube频道允许异步更新，因此用户下次启动YouTube时将立即看到最新内容。</p><h1 id="443d" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">为什么使用联合收割机？</h1><p id="6f20" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">有了Combine，我们不需要为每一次成功和每一个错误场景都有无数的嵌套回调。当在具有大量集成服务的真实应用程序中工作时，回调就成了一场噩梦。一个遗漏的错误场景和整个应用程序的用户体验都会被拖垮。</p><p id="49bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您以前使用SwiftUI做过一个项目，那么您有机会见证使用Combine的异步编程。当您将SwiftUI导入文件时，它实际上已经被导入了。然而，如果你的iOS应用程序在SwiftUI派对上迟到了，那也不用担心。我们肯定可以结合使用UIKit。</p><p id="230e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我将展示与纽约时报的图书API 结合使用的Combine。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">展示如何在视图模型中使用组合</figcaption></figure><p id="4d20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里我们有一个ViewModel类，包含我们的<strong class="lb iu"> publisher </strong>作品。发布者有两种相关类型，输入和失败。这里，我的输入是BookListResults，它是一个屏幕外定义的可解码结构，包含来自API响应的预期键/值对。失败是当发布者遇到一个<a class="ae ky" href="https://developer.apple.com/documentation/swift/error" rel="noopener ugc nofollow" target="_blank">错误</a>时。</p><p id="909e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们解释一下Combine中包含的内容:</p><h2 id="9092" class="mv lx it bd ly mw mx dn mc my mz dp mg li na nb mi lm nc nd mk lq ne nf mm ng bi translated"><a class="ae ky" href="https://developer.apple.com/documentation/combine/published" rel="noopener ugc nofollow" target="_blank">出版</a></h2><p id="6086" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">当我们将T类型的变量声明为Published属性时，<br/>要定义发布者，您需要@符号<br/>要访问发布者，您需要$符号</p><p id="57e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看这个ViewController中的<strong class="lb iu">订阅者</strong>工作中的发布者访问。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="c685" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">订阅方对从发布方收到的更改做出响应。在这个例子中，当从我们的NYTimes Book API服务接收到新数据时，我们的用户界面中的tableView被重新加载。让我们来分解一下这里显示的新功能:</p><h2 id="0a73" class="mv lx it bd ly mw mx dn mc my mz dp mg li na nb mi lm nc nd mk lq ne nf mm ng bi translated"><a class="ae ky" href="https://developer.apple.com/documentation/combine/anycancellable" rel="noopener ugc nofollow" target="_blank">任何可取消的</a></h2><p id="f483" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">订阅者有一个AnyCancellable对象的实例，以便能够在需要时取消调用发布者。这些实例会在取消初始化发布服务器时自动取消发布服务器。要将订阅存储到AnyCancellable实例中，您需要使用&amp;符号。</p><h2 id="ae51" class="mv lx it bd ly mw mx dn mc my mz dp mg li na nb mi lm nc nd mk lq ne nf mm ng bi translated"><a class="ae ky" href="https://developer.apple.com/documentation/combine/publisher/receive(on:options:)" rel="noopener ugc nofollow" target="_blank">接收&lt; S &gt;(开:S) </a></h2><p id="eb95" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">该函数接收来自发布者的结果，并在主线程上执行UI更新。</p><h2 id="5d1a" class="mv lx it bd ly mw mx dn mc my mz dp mg li na nb mi lm nc nd mk lq ne nf mm ng bi translated"><a class="ae ky" href="https://developer.apple.com/documentation/combine/just/sink(receivecompletion:receivevalue:)" rel="noopener ugc nofollow" target="_blank">接收(接收完成:接收值:)</a></h2><p id="18dc" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">接收器观察由发布者接收的值，然后使用您指定的闭包处理这些值。</p><h2 id="b49f" class="mv lx it bd ly mw mx dn mc my mz dp mg li na nb mi lm nc nd mk lq ne nf mm ng bi translated"><a class="ae ky" href="https://developer.apple.com/documentation/combine/anycancellable/store(in:)-3hyxs" rel="noopener ugc nofollow" target="_blank">存储(输入:输出设置&lt;任何可取消的&gt; ) </a></h2><p id="c1c6" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">当接收时，最新的数据存储在已定义的可取消实例中。现在，无论在哪里调用这些数据，都可以使用它们，如果有新的数据从发布者那里传来，存储的数据也可以再次改变。</p><p id="c125" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我承认，Combine的语法…很粗糙。这似乎不符合Swift一贯的“尽可能接近英语阅读”的语法。例如，如果您碰巧遗漏了publisher变量中的$符号，Xcode不会告诉您编译器出错的确切原因。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/1df8b622b5829cf96f965fb277585435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Z_JTlkAxIycF7NI9Alv2A.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">从发布的变量中删除$符号会导致Xcode中出现令人困惑的错误</figcaption></figure><p id="0b65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">函数式反应式编程(FRP)可能需要一些时间来适应。我建议在一个示例项目中尝试Combine，看看如何将它合并到一个更复杂的应用程序中。考虑在当前有许多嵌套闭包的地方使用Combine。</p><h1 id="95d5" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">结论</h1><p id="92de" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我文章中的例子并不是联合收割机被利用的唯一方式。用户界面中的交互元素可以是发布者。基于用户的输入，后端和UI可以相应地更新。对于特别高级的用例，您可以使用Combine来处理多个数据流。对于多个流，您可以使用将每个订阅者保存到可取消的集合中。这样的例子不胜枚举。这充分显示了联合收割机的强大功能。</p><h1 id="47c5" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">资源</h1><ul class=""><li id="2baa" class="ni nj it lb b lc mo lf mp li nk lm nl lq nm lu nn no np nq bi translated"><a class="ae ky" href="https://developer.apple.com/documentation/combine" rel="noopener ugc nofollow" target="_blank">关于联合收割机的苹果文档</a></li><li id="4c40" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated"><a class="ae ky" href="https://www.raywenderlich.com/7864801-combine-getting-started" rel="noopener ugc nofollow" target="_blank">雷·温德里希—联合收割机:入门</a></li><li id="99a6" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated"><a class="ae ky" href="https://www.avanderlee.com/swift/combine/" rel="noopener ugc nofollow" target="_blank"> SwiftLee —开始使用Swift中的Combine框架</a></li></ul></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><h1 id="f272" class="lw lx it bd ly lz od mb mc md oe mf mg jz of ka mi kc og kd mk kf oh kg mm mn bi translated">分级编码</h1><p id="cc7e" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="8973" class="ni nj it lb b lc ld lf lg li oi lm oj lq ok lu nn no np nq bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="857b" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">📰查看<a class="ae ky" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="bc24" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">🔔关注我们:<a class="ae ky" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae ky" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae ky" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="874f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">🚀👉<a class="ae ky" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>