<html>
<head>
<title>NestJS ⚡ Multiple DB Setup with TypeORM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用TypeORM的NestJS ⚡多数据库设置</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/nestjs-multiple-db-setup-with-typeorm-a78cb05a085?source=collection_archive---------0-----------------------#2022-05-07">https://levelup.gitconnected.com/nestjs-multiple-db-setup-with-typeorm-a78cb05a085?source=collection_archive---------0-----------------------#2022-05-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="0ea5" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">介绍</h1><p id="b238" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这篇文章中，我将通过一个简单的例子来描述如何设置和使用多个数据库连接。</p><p id="0a47" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><a class="ae lo" href="https://docs.nestjs.com/techniques/database#multiple-databases" rel="noopener ugc nofollow" target="_blank"> NestJS文档</a>大部分都很棒，但是在多数据库部分有一些重要的遗漏。</p><p id="f9a5" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我将假设您已经创建了一个NestJS应用程序，并且已经设置了2个或更多的数据库并准备好连接。让我们开门见山地说吧。</p><h1 id="1eb3" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">让我们开始吧</h1><h2 id="799a" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated">定义数据库连接选项</h2><p id="bcb2" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在NestJS文档之后，我们将找到直接在代码上设置的连接选项示例凭证。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="16db" class="lp jo iq mg b gy mk ml l mm mn">...<br/>@Module({<br/>  imports: [<br/>    TypeOrmModule.forRoot({<br/>      type: 'mysql',<br/>      host: 'localhost',<br/>      port: 3306,<br/>      username: 'root',<br/>      password: 'root',<br/>      database: 'test',<br/>      entities: [Customer],<br/>      synchronize: true,<br/>    }),<br/>  ],<br/>})<br/>...</span></pre><p id="732f" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们应该使用环境配置文件或类似的策略，而不是像那样在代码上公开凭证。</p><p id="f6c0" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">对于这个例子，我们将利用<code class="fe mo mp mq mg b">@nestjs/config</code>包从环境文件中获取数据库凭证。你可以在<a class="ae lo" href="https://docs.nestjs.com/techniques/configuration" rel="noopener ugc nofollow" target="_blank"> NestJS配置文档</a>中找到更多关于如何安装和使用配置包的信息。这是一个简单的过程。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="9cb4" class="lp jo iq mg b gy mk ml l mm mn">...<br/>@Module({<br/>  imports: [<br/>    ConfigModule.forRoot({<br/>      isGlobal: true,<br/>    }),<br/>    TypeOrmModule.forRootAsync({<br/>      imports: [ConfigModule],<br/>      inject: [ConfigService],<br/>      useFactory: async (configService: ConfigService) =&gt; {<br/>        return {<br/>          type: 'mssql',<br/>          host: configService.get('MAIN_DB_HOST'),<br/>          port: parseInt(configService.get('MAIN_DB_PORT')),<br/>          database: configService.get('MAIN_DB_DATABASE'),<br/>          username: configService.get('MAIN_DB_USERNAME'),<br/>          password: configService.get('MAIN_DB_PASSWORD'),<br/>          schema: configService.get('MAIN_DB_SCHEMA'),<br/>          entities: [Customer],<br/>          synchronize: false,<br/>        };<br/>      },<br/>    }),<br/>...</span></pre><p id="3148" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们不需要为我们的第一个连接定义一个连接名。默认情况下，它将被命名为“默认”😬。对于任何其他定义的连接，我们需要提供一个名称。</p><p id="49c3" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">NestJS docs告诉我们，<code class="fe mo mp mq mg b">name</code>属性应该添加到options对象中，与host、port等处于同一级别。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="c24d" class="lp jo iq mg b gy mk ml l mm mn">...<br/>@Module({<br/>  imports: [<br/>    TypeOrmModule.forRoot({<br/>      ...defaultOptions,<br/>      host: 'user_db_host',<br/>      entities: [User],<br/>    }),<br/>    TypeOrmModule.forRoot({<br/>      ...defaultOptions,<br/>      name: 'albumsConnection',<br/>      host: 'album_db_host',<br/>      entities: [Album],<br/>    }),<br/>  ],<br/>})<br/>...</span></pre><p id="2d90" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">现在，因为我们从<code class="fe mo mp mq mg b">.env</code>文件中获取凭证并使用<code class="fe mo mp mq mg b">forRootAsync</code> <strong class="kn ir">，我们需要在</strong> <code class="fe mo mp mq mg b"><strong class="kn ir">useFactory</strong></code> <strong class="kn ir">函数</strong>之外添加连接 <code class="fe mo mp mq mg b">name</code> <strong class="kn ir">属性👀。这是一个非常重要的细节，但在文件中却没有提到。</strong></p><p id="d712" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">最终的<code class="fe mo mp mq mg b">app.module.ts</code>文件应该是这样的。</p><figure class="mb mc md me gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h2 id="fa28" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated">实体</h2><p id="dadc" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了这个练习，我们创建了两个实体。客户实体将使用主数据库连接，AccessLog实体将使用辅助数据库连接。有关TypeOrm实体和存储库模式的更多信息，请查看<a class="ae lo" href="https://docs.nestjs.com/techniques/database" rel="noopener ugc nofollow" target="_blank"> NestJS TypeOrm文档</a>和<a class="ae lo" href="https://typeorm.io/entities" rel="noopener ugc nofollow" target="_blank"> TypeOrm文档</a>。</p><h2 id="b097" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated">使用主数据库连接</h2><p id="11b9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了访问客户实体TypeOrm功能，我们需要将TypeOrm导入到客户模块中。</p><figure class="mb mc md me gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="a5dc" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这是我们在客户服务中使用它的方式。</p><figure class="mb mc md me gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h2 id="92bb" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated">使用辅助数据库连接</h2><p id="7001" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">正如我们对主连接和客户实体所做的那样，我们需要将TypeOrm导入AccessLog模块，但是这一次我们还需要将一个连接名称传递给<code class="fe mo mp mq mg b">TypeOrmModule.forFeature([Entities, ...], connectionName)</code>方法。</p><figure class="mb mc md me gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="d8b5" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这就是我们在AccessLog服务中使用它的方式。</p><figure class="mb mc md me gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h1 id="fe5c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="7049" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">✅:我们设法用来自环境文件的凭证值设置了一个多数据库配置。✅定义了每个实体应该使用什么样的连接。<br/> ✅与如何添加一个二级连接的知识，我们应该能够添加更多的需要。<br/> ✅了解了异步初始化TypeOrm时的一些小技巧。</p><p id="ced2" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我真的希望这篇文章是有帮助的。</p><p id="9586" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">如果您有任何反馈或发现错误，请随时联系我。</p></div></div>    
</body>
</html>