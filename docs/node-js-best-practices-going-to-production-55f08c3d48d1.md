# Node.js 最佳实践—投入生产

> 原文：<https://levelup.gitconnected.com/node-js-best-practices-going-to-production-55f08c3d48d1>

![](img/cded0b32d1fa29027944c4577856d181.png)

Anukrati Omar 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

Node.js 是编写应用程序的流行运行时。这些应用程序通常是许多人使用的生产质量应用程序。为了使维护它们变得更容易，我们必须为人们设定一些准则来遵循。

在这篇文章中，我们将看看我们的节点应用程序在投入生产之前和之后应该做些什么。

# 使用类似生产的环境进行 E2E 测试

在类似生产的环境中运行端到端的测试确保了我们不会在生产中遇到我们预先发现的不同问题。

此外，我们应该用干净的数据在数据库中运行我们的测试，这样我们就可以重复我们的测试。

# 使用静态分析工具定期重构

在将我们的代码投入生产之前，我们应该重构我们的代码，以便它能在生产中快速运行。自动化测试将帮助我们确保重构不会破坏任何现有的功能。

糟糕的代码质量会产生更多难以修复的 bug 和性能问题。

# 谨慎选择我们的 CI 平台

Jenkins 和 CircleCI 是持续集成的流行平台。有了 CI(持续集成)管道，我们可以在后台自动运行测试和部署，而不是手动运行一切。它将我们从其他工作中解放出来，并将我们从手动管理基础架构中解放出来。

我们必须谨慎选择，因为从一个地方迁移到另一个地方会很痛苦。

# 监控我们的应用

我们应该监控我们的应用程序，这样我们的应用程序才能正常运行，不会占用太多资源。为此，我们可以使用监控工具并添加健康检查端点来检查我们的应用程序是否正在运行。

这样，我们就不必让客户告诉我们，我们的应用程序失败了。

# 使用智能日志记录增加透明度

日志记录让我们可以通过发现 lo 中可能导致问题的活动来轻松地解决问题。大多数日志平台可以控制如何收集、存储和分析日志，以确保只存储我们需要的数据。

# 将任何可能的事情委托给反向代理

如果一些事情可以通过反向代理来完成，那么它们就不属于我们的应用程序。CPU 密集型任务，如 SSL，Gzipping，终止都应该在一个反向代理上完成，以减轻我们的应用程序的负荷。

这对于 Node 应用程序尤其重要，因为它只运行在一个线程上，所以我们不想让它做属于反向代理的基础设施相关的任务。

# 锁定依赖关系

我们应该锁定我们的应用程序的依赖关系，这样它们就不会在不同的环境中改变版本。现在，这应该是自动完成的，因为如果不存在的话,`npm install`会生成一个`package-lock.json`。如果它确实存在，那么`npm install`将使用文件中的版本来安装依赖项。

如果它不存在于我们的回购协议中，或者如果我们使用细粒度的版本锁定控制，我们可以运行`npm shrinkwrap`。这个命令重新将`package-lock.json`变成一个可发布的`npm-shrinkwrap.json`或者创建一个新的。

它优先于`package-lock.json`。

# 使用正确的工具保障流程正常运行

我们的应用程序失败时必须重新启动。我们可以使用永久或 PM2 观看我们的应用程序，并在它崩溃时重新启动。如果我们有一个集群，那么我们也必须管理它。

# 利用所有 CPU 内核

我们应该使用所有的 CPU 内核，以最快的性能运行我们的应用程序。如果 CPU 内核处于闲置状态，它就毫无用处。如果是这样的话，我们应该复制节点进程并利用所有的 CPU。对于小型应用程序，我们可以使用节点集群或 PM2。否则，我们可能会使用像 ECS 这样的 Docker 集群。

![](img/b2687b85b8744d21e821cde8bb00fbe5.png)

Vincent van Zalinge 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

# 创建“维护端点”

我们可以使用它来安全地公开应用程序中的诊断信息，而无需登录到服务器。有些信息使用代码更容易获得。

在 Node 中，我们可以使用`os`模块来公开关于我们的服务器的信息。例如，我们可以如下获取应用程序的平台，并通过端点返回它:

```
const express = require('express');
const bodyParser = require('body-parser');
const os = require('os');const app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));app.get('/', (req, res, next) => {
  res.send(os.platform());
});app.listen(3000, () => console.log('server started'));
module.exports = app;
```

当然，在生产应用程序中，这应该通过身份验证来保护。

# 结论

在投入生产之前，我们应该有一套端到端的测试，在一个干净的类似生产的环境中运行。数据应该在每次测试运行时重置，这样它们才能正常运行。这也有助于重构后的测试。

我们应该确保我们已经实现了自动化部署，以便为其他任务腾出时间。

此外，确保我们的服务器的 CPU 核心都得到利用。

最后，我们可能希望创建一个安全的维护端点，在不登录服务器的情况下向我们公开一些信息。