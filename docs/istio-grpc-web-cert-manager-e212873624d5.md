# Istio + gRPC Web +è¯ä¹¦ç®¡ç†å™¨=ğŸ”¥(ç¬¬ 1/2 éƒ¨åˆ†)

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/istio-grpc-web-cert-manager-e212873624d5>

![](img/8b81430f3265ef79ec9597a4119b015b.png)

æˆ‘ç”¨ gRPC-Web å’Œ Istio æ„å»ºäº†ä¸€ä¸ªæ¦‚å¿µéªŒè¯ï¼Œä½†æ˜¯åœ¨å°†å®ƒä»¬ç»“åˆèµ·æ¥æ—¶ï¼Œæˆ‘å‡ ä¹æ²¡æœ‰æ‰¾åˆ°ä»»ä½•èµ„æºã€‚æ›´ä¸ç”¨è¯´å½“æˆ‘åœ¨å¯»æ‰¾ç”¨ HTTPs åŠ å¯†æµé‡çš„èµ„æºæ—¶ï¼Œæœç´¢ç»“æœå˜å¾—æ›´åŠ ç¨€ç¼ºã€‚è¿™ä¿ƒä½¿æˆ‘è‡ªå·±åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å—ã€‚

åœ¨ç¬¬ 1 éƒ¨åˆ†ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•ä½¿ç”¨ Istio åœ¨ gRPC åç«¯æœåŠ¡å™¨å’Œä½¿ç”¨ gRPC-web çš„å‰ç«¯ Web å®¢æˆ·ç«¯ä¹‹é—´å»ºç«‹é€šä¿¡ã€‚åœ¨ç¬¬ 2 éƒ¨åˆ†ä¸­ï¼Œæˆ‘å°†ä»‹ç»å¦‚ä½•é€šè¿‡ä½¿ç”¨ HTTPs åŠ å¯†å‰ç«¯å’Œåç«¯ä¹‹é—´çš„ç½‘ç»œæµé‡æ¥ä¿æŠ¤é€šä¿¡ã€‚

![](img/cbb787ce71db7f830ed9317f52040cd4.png)

æ¥æº: [VMware åšå®¢](https://blogs.vmware.com/networkvirtualization/2019/04/grpc-web-and-istio.html/)

åœ¨æˆ‘ä»¬æ·±å…¥æŠ€æœ¯ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘å…ˆä»‹ç»ä¸€ä¸‹ Istio å’Œ gRPC-Web åˆ°åº•æ˜¯ä»€ä¹ˆã€‚

[Istio](https://istio.io/latest/docs/concepts/what-is-istio/) æ˜¯ä¸€ä¸ªæœåŠ¡ç½‘æ ¼å®ç°ï¼Œå®ƒåˆ›å»ºã€ç®¡ç†å¹¶å¸®åŠ©ç†è§£å¾®æœåŠ¡ä¹‹é—´çš„ç½‘ç»œã€‚Istio åœ¨æœåŠ¡åˆ°æœåŠ¡çš„é€šä¿¡æ–¹é¢æœ‰å¾ˆå¤šä¼˜åŠ¿ï¼Œæ¯”å¦‚è´Ÿè½½å¹³è¡¡ã€è®¤è¯å’Œæˆæƒã€ç›‘æ§ã€å¯è¿½æº¯æ€§ç­‰ç­‰ã€‚

[gRPC-Web](https://grpc.io/blog/grpc-web-ga/) æ”¯æŒ Web åº”ç”¨ç›´æ¥ä¸ gRPC åç«¯æœåŠ¡é€šä¿¡ï¼Œæ— éœ€ HTTP æœåŠ¡å™¨ä½œä¸ºä¸­ä»‹ã€‚å’Œ gRPC ä¸€æ ·ï¼ŒgRPC-Web å…è®¸æ‚¨ä½¿ç”¨åè®®ç¼“å†²åŒºå®šä¹‰å®¢æˆ·ç«¯(Web)å’Œåç«¯ gRPC æœåŠ¡ä¹‹é—´çš„æœåŠ¡â€œå¥‘çº¦â€ã€‚
ç”±äºæˆ‘ä»¬ä¼¼ä¹ä¸ä¼šå¾ˆå¿«è·å¾—å¯¹ gRPC çš„æœ¬åœ°æµè§ˆå™¨æ”¯æŒï¼ŒgRPC-Web æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒä½¿ç”¨ä¸€ä¸ªä»£ç†ï¼Œå¦‚ Envoy æˆ– Nginxï¼Œå°†æ¥è‡ªæµè§ˆå™¨çš„ HTTP è°ƒç”¨è½¬æ¢ä¸ºå¯¹åç«¯çš„æœ¬åœ° gRPC è°ƒç”¨ã€‚Istio ä½¿ç”¨ Envoy ä½œä¸ºå…¶æœåŠ¡ç½‘æ ¼ä»£ç†ï¼›å› æ­¤ï¼Œæˆ‘ä»¬åœ¨è¯¥æ•™ç¨‹ä¸­ä½¿ç”¨ Istioã€‚

ä»‹ç»å®Œäº†ï¼Œè®©æˆ‘ä»¬ç›´æ¥è¿›å…¥æœ‰è¶£çš„éƒ¨åˆ†ã€‚

# **æˆ‘ä»¬å°†å®ç°çš„ç›®æ ‡:**

1.  éƒ¨ç½²å•èŠ‚ç‚¹ Kubernetes(k8s)é›†ç¾¤ã€‚ä¸ºäº†è¿™ä¸ªæ•™ç¨‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [K3s](https://k3s.io/) ã€‚
2.  åœ¨ k8s é›†ç¾¤ä¸­ä¸‹è½½å¹¶å®‰è£… Istio æœåŠ¡ç½‘æ ¼ã€‚
3.  ç¡®å®š Istio çš„å…¥å£ IP å’Œç«¯å£ã€‚
4.  å°†å‰ç«¯ã€gRPC åç«¯æœåŠ¡å’Œ Envoy gRPC web è¿‡æ»¤å™¨éƒ¨ç½²ä¸ºé›†ç¾¤ä¸­çš„ k8s å¯¹è±¡ã€‚
5.  åˆ›å»º Istio ç½‘å…³å’Œè™šæ‹ŸæœåŠ¡
6.  æµ‹è¯•åº”ç”¨ç¨‹åº

ç°åœ¨è®©æˆ‘ä»¬æŠŠæ‰‹å¼„è„å§ï¼

## 1)éƒ¨ç½²ä¸€ä¸ª k8s é›†ç¾¤:

*æˆ‘å°†åœ¨æœ¬æ•™ç¨‹ä¸­ä½¿ç”¨* [*K3s*](https://k3s.io/) *ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œå®ƒæ˜¯ K8s çš„ä¸€ä¸ªéå¸¸å¯é çš„è½»é‡çº§å‘è¡Œç‰ˆï¼Œéå¸¸é€‚åˆå¼€å‘å’Œ edge(èµ„æºæœ‰é™çš„ç¯å¢ƒ)éƒ¨ç½²ã€‚è¦å®‰è£…å®ƒï¼Œä½ åªéœ€è¦è¿è¡Œ* `$ curl -sfL https://get.k3s.io | sh -`

åœ¨æ’°å†™æœ¬æ•™ç¨‹æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ Kubernetes ç‰ˆæœ¬ã€‚

## 2)ä¸‹è½½å¹¶å®‰è£… Istio:

ä¸ºäº†[å®‰è£…](https://istio.io/latest/docs/setup/getting-started/) Istioï¼Œéœ€è¦å®Œæˆä»¥ä¸‹æ­¥éª¤:

*   `$ curl -L [https://istio.io/downloadIstio](https://istio.io/downloadIstio) | sh -`(æ’°å†™æœ¬æ•™ç¨‹æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ Istio 1 . 9 . 3 ç‰ˆæœ¬)
*   `$ cd istio-1.9.3`
*   `$ export PATH=$PWD/bin:$PATH`
*   `$ istioctl install â€” set profile=demo -y`(å¦‚æœè¿è¡Œè¯¥å‘½ä»¤æ—¶å‡ºç°è¿æ¥è¢«æ‹’ç»çš„é”™è¯¯ï¼Œè¯·æŒ‰ç…§æ­¤å¤„[æåˆ°çš„æ­¥éª¤](https://discuss.istio.io/t/solved-error-installing-istio-using-istioctl/5254)ï¼Œè¿™åº”è¯¥å¯ä»¥è§£å†³é—®é¢˜)
*   æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å¸Œæœ›æŒ‡ç¤º Istio åœ¨åº”ç”¨ç¨‹åºä¸­è‡ªåŠ¨æ³¨å…¥å…¶ Envoy sidecar ä»£ç†:
    `$ kubectl label namespace default istio-injection=enabled`

## 3)ç¡®å®šå…¥å£ IP å’Œç«¯å£

æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¯†åˆ« k8s é›†ç¾¤å…¥å£ä¸»æœºå’Œç«¯å£:(æœ‰å…³ä»¥ä¸‹æ­¥éª¤çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ Istio çš„[æ–‡æ¡£](https://istio.io/latest/docs/setup/getting-started/#determining-the-ingress-ip-and-ports)

```
$ export INGRESS_HOST=$(kubectl get po -l istio=ingressgateway -n istio-system -o jsonpath='{.items[0].status.hostIP}')$ export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].nodePort}')$ export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="https")].nodePort}')$ export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT$ echo "$GATEWAY_URL"
```

è¿™æ˜¯å°†åº”ç”¨ç¨‹åºæš´éœ²åœ¨é›†ç¾¤ä¹‹å¤–å¹¶å…è®¸æµè§ˆå™¨ä¸­çš„å‰ç«¯å®¢æˆ·ç«¯å’Œåç«¯ä¹‹é—´é€šä¿¡æ‰€å¿…éœ€çš„ã€‚è®°ä¸‹$GATEWAY_URLï¼Œæˆ‘ä»¬ä»¥åä¼šç”¨åˆ°å®ƒã€‚

## 4)éƒ¨ç½²å‰ç«¯ã€gRPC åç«¯æœåŠ¡å’Œ Envoy gRPC web è¿‡æ»¤å™¨

ç”±äºåç«¯å’Œå‰ç«¯çš„å®ç°ç»†èŠ‚ä¸æ˜¯æœ¬æ•™ç¨‹çš„èŒƒå›´ï¼Œæˆ‘å°†åœ¨è¿™é‡Œé‡ç”¨åç«¯å’Œå‰ç«¯å®ç°çš„ã€‚

æˆ‘ä¸ºåç«¯å’Œå‰ç«¯åˆ›å»ºäº†ä¸€ä¸ª docker æ˜ åƒï¼Œå¹¶å°†åœ¨ä¸‹é¢çš„ K8s éƒ¨ç½²æ¸…å•ä¸­ä½¿ç”¨å®ƒä»¬ã€‚

è¦è®©å®ƒä»¬è¿è¡Œï¼Œè¯·éµå¾ªä»¥ä¸‹æ­¥éª¤:

*   å¦‚æœæ‚¨è¿˜æ²¡æœ‰å¸æˆ·ï¼Œè¯·åœ¨ [dockerhub](https://hub.docker.com/) ä¸Šåˆ›å»ºä¸€ä¸ªå¸æˆ·ã€‚
*   åˆ›å»ºä¸€ä¸ª docker æ³¨å†Œè¡¨ç§˜å¯†èƒ½å¤Ÿæ‹‰å›¾ç‰‡:
    `$ kubectl create secret docker-registry regcred --docker-username=<your-name> --docker-password=<your-password>`
*   åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼Œå¹¶å°†ä¸‹é¢çš„ç›®å½•å¤åˆ¶åˆ°å…¶ä¸­ã€‚

ç‰¹ä½¿è¿‡æ»¤å™¨

åç«¯éƒ¨ç½²å’ŒæœåŠ¡

å‰ç«¯éƒ¨ç½²å’ŒæœåŠ¡

*   ç”¨æ­¥éª¤ 3 ä¸­ç¡®å®šçš„å€¼æ›¿æ¢ç¯å¢ƒå˜é‡`REACT_APP_GATEWAY_URL`çš„å€¼ã€‚
*   æŒ‰é¡ºåºè¿è¡Œä»¥ä¸‹å‘½ä»¤(æ³¨æ„ï¼Œéœ€è¦åœ¨åç«¯æœåŠ¡ä¹‹å‰åˆ›å»º envoy è¿‡æ»¤å™¨ï¼Œå› ä¸ºè¿‡æ»¤å™¨å°†å®‰è£…åœ¨åç«¯ pod ä¸­è¿è¡Œçš„ Istio çš„ sidecar ä¸Š)

```
$ kubectl create -f envoy-filter.yaml
$ kubectl create -f grpc-backend.yaml
$ kubectl create -f grpc-web-frontend.yaml
```

*   é€šè¿‡è¿è¡Œ`$ kubectl get pods`æ¥éªŒè¯éƒ¨ç½²ï¼Œåº”è¯¥ä¼šçœ‹åˆ°ä¸ä¸‹é¢ç±»ä¼¼çš„è¾“å‡º

```
NAME                      READY   STATUS    RESTARTS   AGE
server-xxxxxx-xxxxxxxxx   2/2     Running   0          xm
client-xxxxxx-xxxxxxxxx   2/2     Running   0          xm
```

## 5)åˆ›å»º Istio ç½‘å…³å’Œè™šæ‹ŸæœåŠ¡

æˆ‘ä»¬éœ€è¦æŒ‡ç¤º Istio é…ç½®é›†ç¾¤çš„å…¥å£æµé‡ï¼Œå¹¶å°† HTTP æµé‡è·¯ç”±åˆ°åç«¯ã€‚è¿™å¯ä»¥é€šè¿‡ä¸ºåç«¯å’Œå‰ç«¯åˆ›å»ºç›®çš„åœ°è§„åˆ™ï¼Œä»¥åŠåˆ›å»ºç½‘å…³å’Œè™šæ‹ŸæœåŠ¡æ¥å®ç°ã€‚

æ­£å¦‚æ‚¨åœ¨ä¸‹é¢çš„å¯¹è±¡å®šä¹‰ä¸­çœ‹åˆ°çš„ï¼Œè™šæ‹ŸæœåŠ¡å®šä¹‰åº”è¯¥æœ‰å°†æµé‡è·¯ç”±åˆ°åç«¯å’Œå‰ç«¯çš„è§„åˆ™ã€‚

åœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»ºä¸‹é¢çš„æ–‡ä»¶ï¼Œç„¶åè¿è¡Œ
`$ kubectl create -f gateway.yaml`

Istio çš„ç›®çš„åœ°è§„åˆ™ã€ç½‘å…³å’Œè™šæ‹ŸæœåŠ¡

## 6)æµ‹è¯•åº”ç”¨ç¨‹åº

æŒ‰ç…§å‰é¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬åº”è¯¥æˆåŠŸéƒ¨ç½²äº† gRPC åç«¯æœåŠ¡å’Œä½¿ç”¨ gRPC-web ä¸åç«¯é€šä¿¡çš„å‰ç«¯æœåŠ¡ã€‚Istio çš„ç½‘å…³å……å½“ä»£ç†ï¼Œå°†æ¥è‡ªæµè§ˆå™¨çš„ http è°ƒç”¨è½¬æ¢ä¸ºåç«¯çš„ gRPC è°ƒç”¨ã€‚

è¦éªŒè¯è¯¥æµç¨‹ï¼Œè¯·æ‰“å¼€ä¸€ä¸ªæ–°çš„æµè§ˆå™¨é€‰é¡¹å¡å¹¶è®¿é—®`http://$GATEWAY_URL/ui`

æ‚¨åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°ä¸€ä¸ªç®€å•çš„ UIï¼Œå®ƒå…·æœ‰å¦‚ä¸‹æ‰€ç¤ºçš„æ¸©åº¦å’Œæ¹¿åº¦è¯»æ•°ã€‚æ•°å­—åº”è¯¥æ¯ 5 ç§’æˆ–æ›´çŸ­æ—¶é—´å˜åŒ–ä¸€æ¬¡ã€‚

![](img/2da6e5ac7150c0de83e5b95f2a076d54.png)

ç”¨æˆ·ç•Œé¢ä¸­çš„é¢„æœŸè¾“å‡º

é‚£éƒ½æ˜¯ä¹¡äº²ä»¬ï¼ğŸ‰

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬èƒ½å¤Ÿ

*   éƒ¨ç½² gRPC åç«¯æœåŠ¡å’Œä½¿ç”¨ gRPC web ä¸åç«¯é€šä¿¡çš„å‰ç«¯æœåŠ¡ã€‚
*   åœ¨å‰ç«¯å’Œåç«¯ pod ä¸Šæ³¨å…¥ Istio çš„ sidecar ä»£ç†
*   ä½¿ç”¨ Istio å…¥å£ç½‘å…³å…¬å¼€æœåŠ¡
*   é…ç½® Istio çš„å…¥å£ç½‘å…³ï¼Œå°† HTTP æµé‡ä»£ç†åˆ° gRPC åç«¯

åœ¨**ç¬¬ 2 éƒ¨åˆ†**ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•ä½¿ç”¨**è¯ä¹¦ç®¡ç†å™¨ä¿æŠ¤ä¸ HTTPs çš„å‰ç«¯åˆ°åç«¯é€šä¿¡ã€‚**æ•¬è¯·æœŸå¾…ï¼

> *å…è´£å£°æ˜:æ‰€æœ‰ä½¿ç”¨çš„ yaml æ–‡ä»¶ä¸ä¸€å®šæ˜¯ä¸ºç”Ÿäº§ä½¿ç”¨è€Œåˆ›å»ºçš„ã€‚è¦åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œä¸€äº›æ›´æ”¹ã€‚*

## èµ„æº:

*   [https://istio.io/latest/docs/setup/getting-started/](https://istio.io/latest/docs/setup/getting-started/)
*   [https://medium . com/swlh/building-a-real time-dashboard-with-react js-go-grpc-and-envoy-7be 155 DFA FB](https://medium.com/swlh/building-a-realtime-dashboard-with-reactjs-go-grpc-and-envoy-7be155dfabfb)
*   [https://venil noroha . io/seamless-cloud-native-apps-with-grpc-web-and-istio](https://venilnoronha.io/seamless-cloud-native-apps-with-grpc-web-and-istio)