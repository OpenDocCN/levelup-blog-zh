<html>
<head>
<title>Speed up Python code up to 100x using Numba.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Numba将Python代码速度提高100倍。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/super-charge-your-python-code-upto-100x2-3ad359785872?source=collection_archive---------11-----------------------#2021-12-31">https://levelup.gitconnected.com/super-charge-your-python-code-upto-100x2-3ad359785872?source=collection_archive---------11-----------------------#2021-12-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/55d00b6252bb46a700a17208d8070602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lCiZnw64TtmVoFG5"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@chuttersnap?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> CHUTTERSNAP </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><blockquote class="kd ke kf"><p id="8e1b" class="kg kh ki kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">本文的主要目标是展示如何轻松地将代码速度提高到原生python的100倍。</p></blockquote><p id="90d7" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">查找代码:<a class="ae kc" href="https://www.kaggle.com/rudrasing/speed-up-python-code-up-to-100x-using-numba" rel="noopener ugc nofollow" target="_blank"><em class="ki">https://www . ka ggle . com/rudra sing/speed-up-python-code-up-to-100 x-using-numba</em></a></p><h2 id="d474" class="li lj iq bd lk ll lm dn ln lo lp dp lq lf lr ls lt lg lu lv lw lh lx ly lz ma bi translated">我们将研究4种编写代码的方法，并验证哪种方法相对于其他方法更好。</h2><blockquote class="mb"><p id="3415" class="mc md iq bd me mf mg mh mi mj mk le dk translated">1.普通香草蟒蛇皮</p><p id="275e" class="mc md iq bd me mf mg mh mi mj mk le dk translated">2.Numpy</p><p id="6ed0" class="mc md iq bd me mf mg mh mi mj mk le dk translated">3.农巴</p><p id="dc6c" class="mc md iq bd me mf mg mh mi mj mk le dk translated">4.Numba + Numpy</p></blockquote><h2 id="4e04" class="li lj iq bd lk ll ml dn ln lo mm dp lq lf mn ls lt lg mo lv lw lh mp ly lz ma bi translated">1.普通香草蟒蛇皮</h2><p id="13fd" class="pw-post-body-paragraph kg kh iq kj b kk mq km kn ko mr kq kr lf ms ku kv lg mt ky kz lh mu lc ld le ij bi translated"><code class="fe mv mw mx my b">example_function_python</code>函数将生成两个随机矩阵并将它们相乘。我们可以观察到这个函数有很高的时间和空间复杂度<em class="ki">请忽略这个函数的工作，因为它只是为了演示</em>。</p><figure class="mz na nb nc gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><figure class="mz na nb nc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/13cfa9fd6096e969716d8d4f43e09442.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ryA26kMEKC6HfC3nmYATAQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">简单的python执行</figcaption></figure><h2 id="893c" class="li lj iq bd lk ll lm dn ln lo lp dp lq lf lr ls lt lg lu lv lw lh lx ly lz ma bi translated">2.使用NumPy方法</h2><p id="6189" class="pw-post-body-paragraph kg kh iq kj b kk mq km kn ko mr kq kr lf ms ku kv lg mt ky kz lh mu lc ld le ij bi translated">正如我们所看到的，numpy中的代码是可爱的、简单的和超快的</p><figure class="mz na nb nc gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><figure class="mz na nb nc gt jr gh gi paragraph-image"><div class="ab gu cl ng"><img src="../Images/5a01dff5f426db25933081cb2d50da68.png" data-original-src="https://miro.medium.com/v2/format:webp/1*0Hb8e0PRakRBRDhwqVR9Mg.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">数字速度</figcaption></figure><h2 id="e8dd" class="li lj iq bd lk ll lm dn ln lo lp dp lq lf lr ls lt lg lu lv lw lh lx ly lz ma bi translated">3.用Numba这个节目的超级明星。</h2><ol class=""><li id="8ac8" class="nh ni iq kj b kk mq ko mr lf nj lg nk lh nl le nm nn no np bi translated">Numba是一个允许使用LLVM动态编译纯Python代码的包。一个简单例子中的应用程序，就像手边的这个，非常简单，而且是动态编译的函数</li><li id="a7a7" class="nh ni iq kj b kk nq ko nr lf ns lg nt lh nu le nm nn no np bi translated">Numba使用实时编译器，该编译器使用行业标准的LLVM编译器库在运行时将Python函数翻译成优化的机器代码。也就是说，所有的重环提升都由llvm处理。</li><li id="0117" class="nh ni iq kj b kk nq ko nr lf ns lg nt lh nu le nm nn no np bi translated">当调用一个Numba修饰的函数时，该函数被编译成“即时”执行的机器码，并且全部或部分代码随后可以以本机机器码速度运行！</li></ol><pre class="mz na nb nc gt nv my nw nx aw ny bi"><span id="43b3" class="li lj iq my b gy nz oa l ob oc"><strong class="my ir">import numba as nb<br/>@nb.jit()<br/>def example_function_numba(num):<br/>        pass</strong></span></pre><blockquote class="mb"><p id="ebf9" class="mc md iq bd me mf od oe of og oh le dk translated">使用Numba JIT编译器，我们可以观察到它只花了16秒就运行了，而python用了175秒。我推荐使用decorator而不是以这种方式调用函数，但是为了简单起见，为了不重复代码，我使用下面的方法调用函数。</p></blockquote><pre class="oi oj ok ol om nv my nw nx aw ny bi"><span id="588a" class="li lj iq my b gy nz oa l ob oc"><strong class="my ir">numba_jit = nb.jit(example_function_python)<br/>%time z = numba_jit(1000)</strong></span><span id="0862" class="li lj iq my b gy on oa l ob oc"><strong class="my ir">Wall time: 16.2 s</strong></span></pre><h2 id="45bc" class="li lj iq bd lk ll lm dn ln lo lp dp lq lf lr ls lt lg lu lv lw lh lx ly lz ma bi translated">在Numba中使用非Python模式</h2><ol class=""><li id="b3e3" class="nh ni iq kj b kk mq ko mr lf nj lg nk lh nl le nm nn no np bi translated">Numba @jit decorator基本上在两种编译模式下运行，nopython模式和对象模式。在下面的例子中，使用了相当于@jit(nopython-True)的@ njit decorator这是指示Numba在nopython模式下运行。nopython编译模式的行为实质上是编译修饰函数，这样它将完全在没有python解释器参与的情况下运行。这是使用Numba jit装饰器的推荐和最佳实践方式，因为它能带来最佳性能。</li></ol><blockquote class="mb"><p id="f2c5" class="mc md iq bd me mf od oe of og oh le dk translated">下面的@njit示例比@jit方法少用了1秒(15.00秒)。</p></blockquote><pre class="oi oj ok ol om nv my nw nx aw ny bi"><span id="88e6" class="li lj iq my b gy nz oa l ob oc"><strong class="my ir">numba_njit = nb.njit(example_function_python)<br/>numba_list = [timer(numba_njit,num) for num in range(0,1000,100)]<br/>plt.figure(dpi = 120)<br/>plt.plot(range(0,1000,100), numba_list)<br/>plt.xlabel("Number of Iterations")<br/>plt.ylabel("Seconds")</strong></span></pre><figure class="mz na nb nc gt jr gh gi paragraph-image"><div class="ab gu cl ng"><img src="../Images/c94fe5e01c3c35c44e3c3a91a2528d5e.png" data-original-src="https://miro.medium.com/v2/format:webp/1*qQ9sNulBB8q6B5nkphPgOQ.png"/></div></figure><blockquote class="kd ke kf"><p id="a8df" class="kg kh ki kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">使用并行=真</p></blockquote><ol class=""><li id="b555" class="nh ni iq kj b kk kl ko kp lf oo lg op lh oq le nm nn no np bi translated">为njit()设置parallel选项会启用Numba转换过程，该过程会尝试自动并行化一个函数，并对该函数(的一部分)执行其他优化。这个特性只对CPU有效。</li><li id="98db" class="nh ni iq kj b kk nq ko nr lf ns lg nt lh nu le nm nn no np bi translated">但是这个函数只有在代码是可并行的情况下才有效，但是下面的函数是不可并行的，因此Numba抛出了一个警告。</li></ol><pre class="mz na nb nc gt nv my nw nx aw ny bi"><span id="aed7" class="li lj iq my b gy nz oa l ob oc"><strong class="my ir">numba_njit = nb.njit(example_function_python, parallel = True)<br/>%time z = numba_njit(1000)</strong></span><span id="3a3c" class="li lj iq my b gy on oa l ob oc">C:\Users\siddharth_black_pred\anaconda3\lib\site-packages\numba\core\typed_passes.py:331: NumbaPerformanceWarning: [1m<br/>The keyword argument 'parallel=True' was specified but no transformation for parallel execution was possible.<br/><br/>To find out why, try turning on parallel diagnostics, see https://numba.pydata.org/numba-doc/latest/user/parallel.html#diagnostics for help.<br/>[1m<br/>File "C:\Users\SIDDHA~1\AppData\Local\Temp\ipykernel_10804\2232291569.py", line 23:[0m<br/>[1m&lt;source missing, REPL/exec in use?&gt;[0m<br/>[0m<br/>  warnings.warn(errors.NumbaPerformanceWarning(msg,<br/><br/><br/>Wall time: 16.4 s</span></pre><blockquote class="mb"><p id="b79b" class="mc md iq bd me mf od oe of og oh le dk translated">通过用NumPy向量替换python列表，代码得到了显著的改进，只需2秒钟就能执行。与之前的150秒相比，</p></blockquote><figure class="oi oj ok ol om jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><figure class="mz na nb nc gt jr gh gi paragraph-image"><div class="ab gu cl ng"><img src="../Images/082891f3135d5a1b85ec867c5b8c7e9a.png" data-original-src="https://miro.medium.com/v2/format:webp/1*-oFf91GW3nM9ErwFTeYI_Q.png"/></div></figure><blockquote class="kd ke kf"><p id="cea6" class="kg kh ki kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">让我们比较一下上面我们用来加速的方法</p></blockquote><p id="70de" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">我们观察到numba结合numpy向量表现最好。</p><pre class="mz na nb nc gt nv my nw nx aw ny bi"><span id="7b5e" class="li lj iq my b gy nz oa l ob oc"><strong class="my ir">import matplotlib.pyplot as plt <br/>plt.style.use('seaborn-dark')<br/>plt.figure(dpi = 120)<br/>plt.plot(range(0,1000,100), [0.0,<br/> 0.214097,<br/> 1.588295,<br/> 5.530069,<br/> 13.584038,<br/> 27.472998,<br/> 47.856996,<br/> 77.211966,<br/> 117.906999,<br/> 179.297997], label = 'plain python'<br/>)<br/><br/>plt.plot(range(0,1000,100), numba_numpy_list, label = 'numpy numba')<br/>plt.xlabel("Number of Iterations")<br/>plt.ylabel("Seconds")<br/><br/><br/>plt.plot(range(0,1000,100), numba_list, label = 'numba python')<br/>plt.xlabel("Number of Iterations")<br/>plt.ylabel("Seconds")<br/><br/>plt.xlabel("Number of Iterations")<br/>plt.ylabel("Seconds")<br/>plt.legend()</strong></span></pre><figure class="mz na nb nc gt jr gh gi paragraph-image"><div class="ab gu cl ng"><img src="../Images/1111d5092954401c9582a116eeb69893.png" data-original-src="https://miro.medium.com/v2/format:webp/1*U2i0Dt54GJsrRU69cUjgNQ.png"/></div></figure><h2 id="66d5" class="li lj iq bd lk ll lm dn ln lo lp dp lq lf lr ls lt lg lu lv lw lh lx ly lz ma bi translated">Numba的其他选项</h2><ol class=""><li id="83fb" class="nh ni iq kj b kk mq ko mr lf nj lg nk lh nl le nm nn no np bi translated">诺吉尔:试图释放编译函数内部的全局解释器锁。只有当Numba可以在nopython模式下编译该函数时，GIL才会被释放，否则会打印一个编译警告。</li><li id="d645" class="nh ni iq kj b kk nq ko nr lf ns lg nt lh nu le nm nn no np bi translated"><strong class="kj ir"> parallel </strong>:如果为true，parallel将启用大量公共Numpy构造的自动并行化，以及相邻并行操作的融合，以最大化缓存局部性。</li><li id="defc" class="nh ni iq kj b kk nq ko nr lf ns lg nt lh nu le nm nn no np bi translated"><strong class="kj ir"> fastmath </strong>:如果为真，fastmath将启用LLVM文档中描述的不安全的浮点转换</li></ol><h2 id="13fa" class="li lj iq bd lk ll lm dn ln lo lp dp lq lf lr ls lt lg lu lv lw lh lx ly lz ma bi translated">示例2计算EWMA</h2><ol class=""><li id="46a2" class="nh ni iq kj b kk mq ko mr lf nj lg nk lh nl le nm nn no np bi translated">指数加权移动平均(EWMA)是一种用于建模或描述时间序列的定量或统计方法。EWMA广泛应用于金融领域，主要应用于技术分析和波动性建模。</li><li id="b5f3" class="nh ni iq kj b kk nq ko nr lf ns lg nt lh nu le nm nn no np bi translated">EWMA是一个递归函数，这意味着当前观测值是使用之前的观测值计算的。EWMA的递归特性导致权重呈指数衰减，如下所示:</li></ol><figure class="mz na nb nc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi or"><img src="../Images/2db0fd7a8c26428f376778cf386aa141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xw7WGMJTUax-XQ8z4l-BBw.png"/></div></div></figure><p id="1e88" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">α=重量</p><p id="04fa" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">r =当前时间段内时间序列的值</p><figure class="mz na nb nc gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><blockquote class="mb"><p id="ad6f" class="mc md iq bd me mf od oe of og oh le dk translated">看看这个速度比普通代码快145倍。</p></blockquote><h2 id="5138" class="li lj iq bd lk ll ml dn ln lo mm dp lq lf mn ls lt lg mo lv lw lh mp ly lz ma bi translated">例3:用蒙特卡罗方法计算圆周率。</h2><p id="386d" class="pw-post-body-paragraph kg kh iq kj b kk mq km kn ko mr kq kr lf ms ku kv lg mt ky kz lh mu lc ld le ij bi translated">让我们考虑这个半径为1的圆内接于面积为4的正方形，即边长为2的正方形。</p><figure class="mz na nb nc gt jr gh gi paragraph-image"><div class="gh gi os"><img src="../Images/ec6a022b0ed2554beedad2a698fc3b9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*xhzBn-YCIwpu1HD2mWenvQ.png"/></div></figure><ol class=""><li id="b336" class="nh ni iq kj b kk kl ko kp lf oo lg op lh oq le nm nn no np bi translated">上面是一个半径为1的单位圆，因此圆的面积=π* 2</li><li id="be0c" class="nh ni iq kj b kk nq ko nr lf ns lg nt lh nu le nm nn no np bi translated">正方形的边长为2。因此它的面积= 4。</li></ol><figure class="mz na nb nc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ot"><img src="../Images/11dccf7884dade79c1a7e8e4ecb48b3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*79ubSGrShkQoS-MOqqal-g.png"/></div></div></figure><figure class="mz na nb nc gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="b6d6" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">然后嘣！！看看<code class="fe mv mw mx my b">monte_carlo_numba</code>的挂壁时间，那有多快。</p><p id="fcae" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">这只是冰山的一角。如果你想要更复杂的例子，只要给我发消息或ping我。</p><h2 id="0415" class="li lj iq bd lk ll lm dn ln lo lp dp lq lf lr ls lt lg lu lv lw lh lx ly lz ma bi translated">结论</h2><ol class=""><li id="190e" class="nh ni iq kj b kk mq ko mr lf nj lg nk lh nl le nm nn no np bi translated">虽然numba似乎是一个很好的替代品，但它不能用于所有的任务。</li><li id="9da9" class="nh ni iq kj b kk nq ko nr lf ns lg nt lh nu le nm nn no np bi translated">Numba只支持python核心数据结构和numpy数组。</li><li id="0ea1" class="nh ni iq kj b kk nq ko nr lf ns lg nt lh nu le nm nn no np bi translated">在nopython模式下，无法与python及其模块进行交互。</li><li id="f539" class="nh ni iq kj b kk nq ko nr lf ns lg nt lh nu le nm nn no np bi translated">对类的支持有限。</li></ol></div></div>    
</body>
</html>