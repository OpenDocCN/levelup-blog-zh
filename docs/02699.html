<html>
<head>
<title>Laying the Rails from AWS API Gateway to ECS Fargate | Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">é“ºè®¾ä»AWS APIç½‘å…³åˆ°ECS Fargateçš„è½¨é“|ç¬¬äºŒéƒ¨åˆ†</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://levelup.gitconnected.com/laying-the-rails-from-aws-api-gateway-to-ecs-fargate-part-ii-7b9294ead2e4?source=collection_archive---------6-----------------------#2020-03-30">https://levelup.gitconnected.com/laying-the-rails-from-aws-api-gateway-to-ecs-fargate-part-ii-7b9294ead2e4?source=collection_archive---------6-----------------------#2020-03-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/b5d02ee679be06352199bf39e4da8376.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CSruvb9Fm65k6QO5G-pirg.png"/></div></div></figure><p id="29e5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">å‰æƒ…æè¦ï¼Œæˆ‘æè¿°äº†ä»APIç½‘å…³åˆ°VPCé“¾æ¥çš„é›†æˆçº¿è·¯ã€‚</p><div class="la lb gp gr lc ld"><a href="https://medium.com/@lucjross/laying-the-rails-from-aws-api-gateway-to-ecs-fargate-part-i-debf754d6a8b" rel="noopener follow" target="_blank"><div class="le ab fo"><div class="lf ab lg cl cj lh"><h2 class="bd iu gy z fp li fr fs lj fu fw is bi translated">é“ºè®¾ä»AWS API Gatewayåˆ°ECS Fargateçš„è½¨é“|ç¬¬ä¸€éƒ¨åˆ†</h2><div class="lk l"><h3 class="bd b gy z fp li fr fs lj fu fw dk translated">åœ¨ä¸¤ä¸ªä¸å…¼å®¹çš„èµ„æºä¹‹é—´å»ºç«‹ç½‘ç»œè·¯å¾„çš„æŒ‡å—</h3></div><div class="ll l"><p class="bd b dl z fp li fr fs lj fu fw dk translated">medium.com</p></div></div><div class="lm l"><div class="ln l lo lp lq lm lr jz ld"/></div></div></a></div><p id="cd35" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">ç¬¬äºŒéƒ¨åˆ†å°†æ¶µç›–å…¶ä½™éƒ¨åˆ†ï¼Œä»ç½‘ç»œè´Ÿè½½å¹³è¡¡å™¨åˆ°ECSä»»åŠ¡ã€‚è®©æˆ‘ä»¬è·³è¿›æ¥ã€‚</p><h1 id="eb5c" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">ç½‘ç»œè´Ÿè½½å¹³è¡¡å™¨</h1><h2 id="d425" class="mq lt it bd lu mr ms dn ly mt mu dp mc km mv mw mg kq mx my mk ku mz na mo nb bi translated">åŸºæœ¬åŸç†</h2><p id="1a48" class="pw-post-body-paragraph kb kc it kd b ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku ng kw kx ky im bi translated">ä¸ºä»€ä¹ˆå°†API Gatewayè¿æ¥åˆ°ç½‘ç»œè´Ÿè½½å¹³è¡¡å™¨ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿æ¥åˆ°åº”ç”¨ç¨‹åºè´Ÿè½½å¹³è¡¡å™¨ï¼ŸåŸºæœ¬ä¸Šï¼Œè¿™æ˜¯å› ä¸ºVPCæœåŠ¡ç«¯ç‚¹åªè¿æ¥åˆ°NLBï¼Œè€ŒVPCæœåŠ¡ç«¯ç‚¹æ˜¯API Gatewayçš„â€”â€”å‘ƒï¼Œæ˜¯æˆ‘ä»¬VPCçš„ç½‘å…³ã€‚</p><p id="177d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">å‡è®¾ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›API Gatewayé€šè¿‡äº’è”ç½‘è®¿é—®æˆ‘ä»¬çš„æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå¸¦æœ‰å…¬å…±DNSåç§°çš„é¢å‘äº’è”ç½‘çš„ALBï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›ä»äº’è”ç½‘è®¿é—®æˆ‘ä»¬çš„ALBã€‚å¦‚æœæ˜¯çš„è¯ï¼Œæˆ‘ä»¬ä¼šæœ‰å¦ä¸€ä¸ªæ½œåœ¨çš„å®‰å…¨æ¼æ´ï¼Œç‰¹åˆ«æ˜¯è€ƒè™‘åˆ°æˆ‘ä»¬æ²¡æœ‰å°†èº«ä»½éªŒè¯ä¸ALBé›†æˆï¼Œè€Œåªæ˜¯ä¸ç½‘å…³é›†æˆã€‚æ‰€ä»¥ï¼Œæˆ‘æŠŠè´Ÿè½½å¹³è¡¡å™¨åšæˆäº†å†…éƒ¨çš„ï¼Œè¿™æ ·å°±é¿å…äº†ç»™å®ƒä»¬é™„åŠ å…¬å…±IPã€‚è¿™ä½¿å¾—VPC(æˆ–å¯¹ç­‰VPC)ä¹‹å¤–çš„ä»»ä½•è®¾å¤‡éƒ½æ— æ³•è®¿é—®å®ƒä»¬ã€‚ä½†æ˜¯ï¼ŒVPCæœåŠ¡ç«¯ç‚¹å¯ä»¥è¿æ¥åˆ°NLBï¼Œè€Œä¸è€ƒè™‘å…¶å­ç½‘å…³è”ã€‚</p><p id="834e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">å¦‚æœAmazonåšäº†ä¸€ä»¶å°äº‹ï¼Œæˆ‘ä»¬çš„å®ç°å¯èƒ½ä¼šç®€å•å¾—å¤š:åœ¨åº”ç”¨ç¨‹åºè´Ÿè½½å¹³è¡¡å™¨ä¾¦å¬å™¨è§„åˆ™ä¸­å…è®¸Cognitoå®¢æˆ·ç«¯å‡­è¯è®¤è¯ã€‚æ®æˆ‘æ‰€çŸ¥ï¼Œå®ƒåªä¸â€œæˆæƒä»£ç æˆæƒâ€å’Œâ€œéšå¼æˆæƒâ€æµé›†æˆï¼Œè¿™æ˜¯ä¸ºä½¿ç”¨webæµè§ˆå™¨çš„äººè®¾è®¡çš„ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå†…éƒ¨ALBç›´æ¥ä¸ECSä»»åŠ¡æ¥å£ã€‚å¦‚æœALBæ”¯æŒç®€å•çš„å®¢æˆ·ç«¯å‡­è¯OAuthæµï¼Œæˆ‘ä»¬å°†åªä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨ALBæ¥ä»£æ›¿ï¼Œç„¶åï¼ŒAPI Gatewayå°±ä¸å¿…æ·»åŠ å¤ªå¤šã€‚</p><h2 id="694f" class="mq lt it bd lu mr ms dn ly mt mu dp mc km mv mw mg kq mx my mk ku mz na mo nb bi translated">åŸºç¡€è®¾æ–½å®æ–½</h2><p id="f800" class="pw-post-body-paragraph kb kc it kd b ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku ng kw kx ky im bi translated">è®©æˆ‘ä»¬åˆ›å»ºNLBåŠå…¶éç‰¹å®šäºæœåŠ¡çš„èµ„æºã€‚</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="f7f7" class="mq lt it nm b gy nq nr l ns nt">resource "aws_lb" "network" {<br/>  name = "${var.stage}-nlb"<br/>  load_balancer_type = "network"<br/>  enable_cross_zone_load_balancing = true<br/>  internal = true<br/>  subnets = var.private_subnet_ids<br/>  access_logs {<br/>    enabled = true<br/>    bucket = var.nlb_logs_bucket_id<br/>    prefix = ""<br/>  }<br/>}<br/><br/>resource "aws_lb_target_group" "nlb_80" {<br/>  name = "nlb-80"<br/>  protocol = "TCP"<br/>  port = 80<br/>  target_type = "ip"<br/>  vpc_id = var.vpc_id<br/>  proxy_protocol_v2 = false<br/>}<br/><br/>resource "aws_lb_target_group" "nlb_443" {<br/>  name = "nlb-443"<br/>  protocol = "TLS"<br/>  port = 443<br/>  target_type = "ip"<br/>  vpc_id = var.vpc_id<br/>  proxy_protocol_v2 = false<br/>}<br/><br/>resource "aws_lb_listener" "nlb_80" {<br/>  load_balancer_arn = aws_lb.network.arn<br/>  protocol = "TCP"<br/>  port = 80<br/>  default_action {<br/>    type = "forward"<br/>    target_group_arn = aws_lb_target_group.nlb_80.arn<br/>  }<br/>}<br/><br/>resource "aws_lb_listener" "nlb_443" {<br/>  load_balancer_arn = aws_lb.network.arn<br/>  protocol = "TLS"<br/>  port = 443<br/>  certificate_arn = var.server_certificate_arn<br/>  default_action {<br/>    type = "forward"<br/>    target_group_arn = aws_lb_target_group.nlb_443.arn<br/>  }<br/>}</span></pre><p id="39cf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸¤ä¸ªç›®æ ‡ç»„ï¼Œä¸€ä¸ªç”¨äºç«¯å£80ä¸Šçš„TCPï¼Œå¦ä¸€ä¸ªç”¨äºç«¯å£443ä¸Šå¸¦æœ‰TLSçš„TCPã€‚API Gatewayå®é™…ä¸Šä¸å…è®¸ä¸å®‰å…¨çš„HTTPæµé‡ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºå¯¹äºå†…éƒ¨è´Ÿè½½å¹³è¡¡å™¨æ¥è¯´ï¼Œæä¾›ä¸€ä¸ªéTLSè·¯å¾„å¯¹äºVPCå†…éƒ¨ä¸æˆ‘ä»¬çš„ç¤ºä¾‹æœåŠ¡(<em class="kz"> ice-station-zebra </em>)çš„é›†æˆæ˜¯å¾ˆå¥½çš„ã€‚æ­¤å¤–ï¼Œè¿™æ˜¯æˆ‘æœ€åˆçš„é”™è¯¯è§‚å¿µçš„æ®‹ä½™ï¼Œå³API Gatewayç¡®å®å…è®¸ç«¯å£80ï¼Œæˆ‘æ˜¯ä¸€ä¸ªLBä¾¦å¬å™¨è´®è—è€…â€”â€”æˆ‘è¿˜æœ‰æ•°ç™¾ä¸ªï¼Œåªæ˜¯æ”¶é›†ç½‘ç»œç°å°˜ã€‚</p><p id="2a4b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">è¿™äº›ç›‘å¬å™¨æ²¡æœ‰<em class="kz">ç›‘å¬å™¨è§„åˆ™</em>ï¼Œå› ä¸ºæ¯ä¸ªç›‘å¬å™¨çš„<code class="fe nu nv nw nm b">default_action</code>å°†è¶³ä»¥è·¯ç”±åˆ°ç›®æ ‡ç»„ã€‚æ­¤å¤–ï¼Œ<code class="fe nu nv nw nm b">nlb_443</code>ç›‘å¬å™¨çš„æœåŠ¡å™¨è¯ä¹¦å¯ä»¥æ˜¯è‡ªç­¾åçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯çœŸå®è¯ä¹¦é¢å‘æœºæ„ç­¾åçš„ã€‚å®ƒä¸åƒå…¬å…±ç½‘ç«™ï¼Œå½“ä»–ä»¬å‡ºç¤ºè‡ªç­¾åæˆ–å…¶ä»–å¯ç–‘çš„SSLè¯ä¹¦æ—¶ï¼Œåº”è¯¥è¢«è§†ä¸ºéæ³•ã€‚æ¥è‡ªå·²ç»åœ¨APIç½‘å…³ç«¯æ¥å—è¯ä¹¦çš„å®¢æˆ·ç«¯çš„æµé‡åº”è¯¥èƒ½å¤Ÿå‡è®¾ç½‘å…³åé¢çš„ä»»ä½•ä¸œè¥¿éƒ½æ˜¯å¯ä¿¡çš„ï¼Œå› æ­¤å¯¹äºå†…éƒ¨ç»„ä»¶æ¥è¯´ï¼Œè¯ä¹¦åªæ˜¯ä¸€ä¸ªé€»è¾‘éœ€æ±‚ã€‚</p><h1 id="08cc" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">åº”ç”¨è´Ÿè½½å¹³è¡¡å™¨</h1><p id="67cd" class="pw-post-body-paragraph kb kc it kd b ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku ng kw kx ky im bi translated">æ‚¨å¯èƒ½æƒ³çŸ¥é“ï¼Œå½“NLBå¯ä»¥ç›´æ¥é’ˆå¯¹ECSä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨ALBã€‚ALBæ”¯æŒæ›´å¤æ‚çš„è·¯ç”±è§„åˆ™ï¼Œå¯ä»¥åœ¨å¤šä¸ªç«¯å£ä¸Šè½¬å‘æµé‡ã€‚NLBæä¾›äº†æ›´é«˜çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒä»¬åœ¨è¾ƒä½çš„çº§åˆ«ä¸Šè¿è¡Œï¼Œä½†å®ƒä»¬ä¸æä¾›æˆ‘ä»¬è¿›è¡Œè¿™ç§é›†æˆæ‰€éœ€çš„åŸºäºè·¯å¾„çš„è·¯ç”±åŠŸèƒ½ï¼Œæ— è®ºå¦‚ä½•ï¼ŒAmazonæ¨èå¹¶æ”¯æŒALBä¸ECS Fargateè¿›è¡Œè´Ÿè½½å¹³è¡¡ã€‚</p><h2 id="90b9" class="mq lt it bd lu mr ms dn ly mt mu dp mc km mv mw mg kq mx my mk ku mz na mo nb bi translated">åŸºç¡€è®¾æ–½</h2><p id="536d" class="pw-post-body-paragraph kb kc it kd b ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku ng kw kx ky im bi translated">åœ¨è°ƒé…ALBæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå…¶æŒ‡å®šä¸€ä¸ªå®‰å…¨ç»„ï¼Œè¿™ä¸NLBä¸åŒï¼Œåè€…ä¸é€‚ç”¨å®‰å…¨ç»„ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•åœ°å…è®¸æ‰€æœ‰ç«¯å£ä¸Šçš„æ‰€æœ‰å‡ºå£å’Œç«¯å£80ä¸Šçš„æ‰€æœ‰å…¥å£ï¼Œå› ä¸ºå®ƒæ˜¯VPCçš„å†…éƒ¨ç«¯å£ã€‚é»˜è®¤çš„ç›®æ ‡ç»„ä¸æ˜¯å¿…é¡»ä½¿ç”¨çš„ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”¨äºç›‘å¬å™¨çš„é»˜è®¤åŠ¨ä½œã€‚</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="9e89" class="mq lt it nm b gy nq nr l ns nt">resource "aws_security_group" "alb_internal" {<br/>  vpc_id = var.vpc_id<br/>  name = "alb-internal"<br/>}<br/><br/>resource "aws_security_group_rule" "alb_internal_egress" {<br/>  type = "egress"<br/>  from_port = "0"<br/>  to_port = "0"<br/>  protocol = "-1"<br/>  cidr_blocks = ["0.0.0.0/0"]<br/>  security_group_id = aws_security_group.alb_internal.id<br/>}<br/><br/>resource "aws_security_group_rule" "alb_internal_http_ingress" {<br/>  type = "ingress"<br/>  from_port = 80<br/>  to_port = 80<br/>  protocol = "tcp"<br/>  cidr_blocks = ["0.0.0.0/0"]<br/>  security_group_id = aws_security_group.alb_internal.id<br/>}<br/><br/>resource "aws_lb" "internal" {<br/>  name = local.internal_alb_name<br/>  internal = true<br/>  load_balancer_type = "application"<br/>  security_groups = [<br/>    aws_security_group.vpc.id,<br/>    aws_security_group.alb_internal.id,<br/>  ]<br/>  subnets = var.private_subnet_ids<br/>  idle_timeout = 60<br/>  ip_address_type = "ipv4"<br/>  access_logs {<br/>    enabled = true<br/>    bucket = var.alb_internal_access_logs_bucket_id<br/>    prefix = ""<br/>  }<br/>}<br/><br/>resource "aws_lb_target_group" "alb_internal_default" {<br/>  name = "alb-internal-default"<br/>  port = 80<br/>  protocol = "HTTP"<br/>  vpc_id = var.vpc_id<br/>  target_type = "ip"<br/>  deregistration_delay = 10<br/>  lifecycle {<br/>    create_before_destroy = true<br/>  }<br/>}<br/><br/>resource "aws_lb_listener" "alb_internal_http" {<br/>  load_balancer_arn = aws_lb.internal.arn<br/>  port = 80<br/>  protocol = "HTTP"<br/>  default_action {<br/>    target_group_arn = aws_lb_target_group.alb_internal_default.arn<br/>    type = "forward"<br/>  }<br/>}<br/><br/>resource "aws_lb_listener" "alb_internal_http_443" {<br/>  count = local.nlb_count<br/>  load_balancer_arn = aws_lb.internal.arn<br/>  port = 443<br/>  protocol = "HTTPS"<br/>  certificate_arn = var.server_certificate_arn<br/>  default_action {<br/>    target_group_arn = aws_lb_target_group.alb_internal_default.arn<br/>    type = "forward"<br/>  }<br/>}</span></pre><p id="4d85" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æ­£å¦‚æˆ‘çš„å›¾è¡¨æ‰€ç¤ºï¼Œè¿™ä¸ªè´Ÿè½½å¹³è¡¡å™¨æ˜¯TLSçš„ç»ˆç‚¹ã€‚è¯»è€…å¯¹ç»ˆæ­¢çš„éœ€æ±‚å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œæˆ–è€…å¯ä»¥åœ¨NLBæˆ–åœ¨ECSä»»åŠ¡ä¸­å®Œæˆã€‚æˆ‘é€‰æ‹©ç»ˆæ­¢äºALBï¼Œå› ä¸ºå®ƒå°½å¯èƒ½åœ°é è¿‘æœåŠ¡ï¼Œè€Œæ²¡æœ‰åœ¨æœåŠ¡ä¸Šå®‰è£…è¯ä¹¦çš„å¤æ‚æ€§ã€‚</p><h2 id="d808" class="mq lt it bd lu mr ms dn ly mt mu dp mc km mv mw mg kq mx my mk ku mz na mo nb bi translated">é™æ€IPs</h2><p id="216a" class="pw-post-body-paragraph kb kc it kd b ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku ng kw kx ky im bi translated">ä¸ºäº†åœ¨NLBä¹‹åç›´æ¥å¼•å…¥ALBï¼Œæˆ‘ä»¬å¿…é¡»è§£å†³å®ƒä»¬ä¹‹é—´çš„ä¸å…¼å®¹æ€§ã€‚ALBçš„IPåœ°å€æ˜¯åŠ¨æ€çš„ï¼Œè¿™å¯¹äºç”¨DNS CNAMEè®°å½•å¼•ç”¨å®ƒä»¬çš„é€šå¸¸æƒ…å†µæ¥è¯´æ˜¯å¾ˆå¥½çš„ï¼Œä½†æ˜¯NLBæ²¡æœ‰åŠæ³•è‡ªå·±è·Ÿä¸Šè¿™äº›å˜åŒ–ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å°†æä¾›AWSåšå®¢æ–‡ç« <a class="ae nx" href="https://aws.amazon.com/blogs/networking-and-content-delivery/using-static-ip-addresses-for-application-load-balancers/" rel="noopener ugc nofollow" target="_blank"> <em class="kz">çš„ä¸€ä¸ªå®ç°ï¼Œä¸ºåº”ç”¨ç¨‹åºè´Ÿè½½å¹³è¡¡å™¨ä½¿ç”¨é™æ€IPåœ°å€</em> </a>ã€‚</p><p id="0ee4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">é¦–å…ˆï¼Œæˆ‘ä»¬å°†åˆ›å»ºâ€œIPåˆ—è¡¨â€æ¡¶ã€‚</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="17cc" class="mq lt it nm b gy nq nr l ns nt">resource "aws_s3_bucket" "internal_alb_static_ips" {<br/>  bucket = "${var.stage}-internal-alb-static-ips"<br/>  acl = "private"<br/>  region = data.aws_region.this.name<br/><br/>  versioning {<br/>    enabled = true<br/>  }<br/>}</span></pre><p id="8c70" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">ç„¶åæˆ‘ä»¬å°†å‘Lambdaæä¾›IAMèµ„æºã€‚å®ƒéœ€è¦è®¿é—®CloudWatchã€S3å’Œå¼¹æ€§è´Ÿè½½å¹³è¡¡ã€‚</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="c77e" class="mq lt it nm b gy nq nr l ns nt">data "aws_iam_policy_document" "lambda_assume_role" {<br/>  statement {<br/>    actions = ["sts:AssumeRole"]<br/>    principals {<br/>      type = "Service"<br/>      identifiers = ["lambda.amazonaws.com"]<br/>    }<br/>  }<br/>}<br/><br/>resource "aws_iam_role" "nlb_tg_to_alb_lambda" {<br/>  name = "nlb-tg-to-alb-lambda"<br/>  assume_role_policy = data.aws_iam_policy_document.lambda_assume_role.json<br/>}<br/><br/>data "aws_iam_policy_document" "nlb_tg_to_alb_lambda" {<br/>  statement {<br/>    actions = [<br/>      "logs:CreateLogGroup",<br/>      "logs:CreateLogStream",<br/>      "logs:PutLogEvents",<br/>    ]<br/>    resources = ["arn:aws:logs:*:*:*"]<br/>  }<br/>  statement {<br/>    actions = [<br/>      "s3:GetObject",<br/>      "s3:PutObject",<br/>    ]<br/>    resources = ["${aws_s3_bucket.internal_alb_static_ips.arn}/*"]<br/>  }<br/>  statement {<br/>    actions = [<br/>      "elasticloadbalancing:RegisterTargets",<br/>      "elasticloadbalancing:DeregisterTargets",<br/>    ]<br/>    resources = [<br/>      aws_lb_target_group.nlb_80.arn,<br/>      aws_lb_target_group.nlb_443.arn,<br/>    ]<br/>  }<br/>  statement {<br/>    actions = ["elasticloadbalancing:DescribeTargetHealth"]<br/>    resources = ["*"]<br/>  }<br/>  statement {<br/>    actions = ["cloudwatch:putMetricData"]<br/>    resources = ["*"]<br/>  }<br/>}<br/><br/>resource "aws_iam_role_policy" "nlb_tg_to_alb_lambda" {<br/>  role = aws_iam_role.nlb_tg_to_alb_lambda.name<br/>  policy = data.aws_iam_policy_document.nlb_tg_to_alb_lambda.json<br/>}</span></pre><p id="aebb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æ¥ä¸‹æ¥ï¼Œä»AWSæ•™ç¨‹ä¸­çš„é“¾æ¥ä¸‹è½½Lambdaå‡½æ•°ï¼Œå¹¶å°†å…¶è§£å‹ç¼©åˆ°æ‚¨çš„åŸºç¡€è®¾æ–½é¡¹ç›®ä¸­ã€‚</p><p id="6d34" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">åœ¨æˆ‘ä»¬ç”¨Terraformåˆ›å»ºLambdaå‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¯¹Lambdaä»£ç åšä¸€ç‚¹å°å°çš„ä¿®æ”¹ã€‚å¦‚æœæ‚¨çš„NLBåªä½¿ç”¨ç«¯å£443ï¼Œæ‚¨ä¸éœ€è¦è¿™æ ·åšã€‚å¦‚æœæ‚¨å¸Œæœ›ç«¯å£80ä¸Šçš„æµé‡ä¹Ÿä»NLBè·¯ç”±ï¼Œåˆ™éœ€è¦ä¿®æ”¹Lambdaï¼Œä»¥ä¾¿å®ƒä¿å­˜å…¶IPåˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«ç‰¹å®šäºç›®æ ‡ç»„è€Œä¸ä»…ä»…æ˜¯ALBçš„å¯¹è±¡åç§°ã€‚ä¸ºæ­¤ï¼Œæ ¹æ®è¿™ä¸ªGit diffè¿›è¡Œæ›´æ”¹ã€‚(å›¾ç‰‡ä¸ºä¸Šä¸‹æ–‡ï¼Œæ–‡å­—ä¸ºå¤åˆ¶+ç²˜è´´ã€‚Mediumå¹¶ä¸æ˜¯å…±äº«ä»£ç çš„æœ€ä½³åª’ä»‹ã€‚)</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ny"><img src="../Images/793af14fb49b585eed7803fa6352385a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HFcppAMVVwgoPVqpccQJqQ.png"/></div></div></figure><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="663e" class="mq lt it nm b gy nq nr l ns nt">PENDING_DEREGISTRATION_FILENAME = 'Pending deregistration IP list of {}.json'.format(ALB_DNS_NAME)<br/>ACTIVE_IP_LIST_KEY = "{}/{}/{}"\<br/>       .format(NLB_TG_ARN, ALB_DNS_NAME, ACTIVE_FILENAME)<br/>PENDING_IP_LIST_KEY = "{}/{}/{}"\<br/>       .format(NLB_TG_ARN, ALB_DNS_NAME, PENDING_DEREGISTRATION_FILENAME)</span></pre><p id="8604" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªshellè„šæœ¬æ¥æ‰“åŒ…Lambdaï¼Œæˆ‘è¿™æ ·åšåªæ˜¯ä¸ºäº†é‡ç°æ€§â€”â€”å®ƒå¯èƒ½åªéœ€è¦è¿è¡Œä¸€æ¬¡ã€‚æ‰§è¡Œ<code class="fe nu nv nw nm b">cd</code>æ˜¯ä¸ºäº†è®©<code class="fe nu nv nw nm b">zip</code>åªæ‰“åŒ…å†…å®¹ï¼Œå› ä¸ºå¦‚æœå¤„ç†ç¨‹åºä»£ç ä¸åœ¨åŒ…çš„æ ¹ç›®å½•ä¸‹ï¼ŒLambdaä¸ä¼šæ¬£èµä¸Šä¼ ã€‚</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="2960" class="mq lt it nm b gy nq nr l ns nt"><strong class="nm iu">#!/bin/sh<br/></strong>set -e<br/><br/>(cd populate_NLB_TG_with_ALB &amp;&amp; zip -r -FS ../package/nlb-tg-to-alb-lambda.zip .)</span></pre><p id="41e1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">ç°åœ¨ï¼Œä¸€æ—¦è¿è¡Œäº†shellè„šæœ¬ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºLambdasäº†ã€‚</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="dced" class="mq lt it nm b gy nq nr l ns nt">locals {<br/>  alb_static_ips_lambda_zip_path = "${path.module}/package/nlb-tg-to-alb-lambda.zip"<br/>}<br/><br/>resource "aws_lambda_function" "nlb_tg_to_alb_80" {<br/>  filename = local.alb_static_ips_lambda_zip_path<br/>  function_name = "nlb-tg-to-alb-80"<br/>  role = aws_iam_role.nlb_tg_to_alb_lambda.arn<br/>  handler = "populate_NLB_TG_with_ALB.lambda_handler"<br/><br/>  source_code_hash = filebase64sha256(local.alb_static_ips_lambda_zip_path)<br/><br/>  runtime = "python2.7"<br/>  memory_size = 128<br/>  timeout = 300<br/><br/>  environment {<br/>    variables = {<br/>      ALB_DNS_NAME = aws_lb.internal.dns_name<br/>      ALB_LISTENER = "80"<br/>      S3_BUCKET = aws_s3_bucket.internal_alb_static_ips.id<br/>      NLB_TG_ARN = aws_lb_target_group.nlb_80.arn<br/>      MAX_LOOKUP_PER_INVOCATION = 50<br/>      INVOCATIONS_BEFORE_DEREGISTRATION = 10<br/>      CW_METRIC_FLAG_IP_COUNT = true<br/>    }<br/>  }<br/>}<br/><br/>resource "aws_lambda_function" "nlb_tg_to_alb_443" {<br/>  filename = local.alb_static_ips_lambda_zip_path<br/>  function_name = "nlb-tg-to-alb-443"<br/>  role = aws_iam_role.nlb_tg_to_alb_lambda.arn<br/>  handler = "populate_NLB_TG_with_ALB.lambda_handler"<br/><br/>  source_code_hash = filebase64sha256(local.alb_static_ips_lambda_zip_path)<br/><br/>  runtime = "python2.7"<br/>  memory_size = 128<br/>  timeout = 300<br/><br/>  environment {<br/>    variables = {<br/>      ALB_DNS_NAME = aws_lb.internal.dns_name<br/>      ALB_LISTENER = "443"<br/>      S3_BUCKET = aws_s3_bucket.internal_alb_static_ips.id<br/>      NLB_TG_ARN = aws_lb_target_group.nlb_443.arn<br/>      MAX_LOOKUP_PER_INVOCATION = 50<br/>      INVOCATIONS_BEFORE_DEREGISTRATION = 10<br/>      CW_METRIC_FLAG_IP_COUNT = true<br/>    }<br/>  }<br/>}</span></pre><p id="b2b6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">CloudWatch cronä½œä¸šè§¦å‘Lambdasçš„è°ƒç”¨ï¼ŒCloudWatchäº‹ä»¶æœåŠ¡è¢«å…è®¸è°ƒç”¨å®ƒä»¬ã€‚</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="d43c" class="mq lt it nm b gy nq nr l ns nt">resource "aws_cloudwatch_event_rule" "nlb_tg_to_alb_cron" {<br/>  name = "nlb-tg-to-alb-cron"<br/>  schedule_expression = "rate(1 minute)"<br/>  is_enabled = true<br/>}<br/><br/>resource "aws_cloudwatch_event_target" "nlb_tg_to_alb_cron_80" {<br/>  rule = aws_cloudwatch_event_rule.nlb_tg_to_alb_cron.name<br/>  target_id = "TriggerStaticPort80"<br/>  arn = aws_lambda_function.nlb_tg_to_alb_80.arn<br/>}<br/><br/>resource "aws_cloudwatch_event_target" "nlb_tg_to_alb_cron_443" {<br/>  rule = aws_cloudwatch_event_rule.nlb_tg_to_alb_cron.name<br/>  target_id = "TriggerStaticPort443"<br/>  arn = aws_lambda_function.nlb_tg_to_alb_443.arn<br/>}<br/><br/>resource "aws_lambda_permission" "allow_cloudwatch_80" {<br/>  statement_id = "AllowExecutionFromCloudWatch"<br/>  action = "lambda:InvokeFunction"<br/>  function_name = aws_lambda_function.nlb_tg_to_alb_80.function_name<br/>  principal = "events.amazonaws.com"<br/>  source_arn = aws_cloudwatch_event_rule.nlb_tg_to_alb_cron.arn<br/>}<br/><br/>resource "aws_lambda_permission" "allow_cloudwatch_443" {<br/>  statement_id = "AllowExecutionFromCloudWatch"<br/>  action = "lambda:InvokeFunction"<br/>  function_name = aws_lambda_function.nlb_tg_to_alb_443.function_name<br/>  principal = "events.amazonaws.com"<br/>  source_arn = aws_cloudwatch_event_rule.nlb_tg_to_alb_cron.arn<br/>}</span></pre><p id="0e28" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æ€»ç»“ä¸€ä¸‹ALBçš„è®¨è®º:æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ªåº”ç”¨ç¨‹åºè´Ÿè½½å¹³è¡¡å™¨ï¼Œå®ƒæœ‰ä¸¤ä¸ªç›‘å¬å™¨(443å’Œ80)å’Œä¸€ä¸ªè®©ç½‘ç»œè´Ÿè½½å¹³è¡¡å™¨ä¿æŒä¸ALBè¿æ¥çš„æœºåˆ¶ã€‚</p><h2 id="2877" class="mq lt it bd lu mr ms dn ly mt mu dp mc km mv mw mg kq mx my mk ku mz na mo nb bi translated">æœåŠ¡</h2><p id="6589" class="pw-post-body-paragraph kb kc it kd b ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku ng kw kx ky im bi translated">åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæˆ‘ä»¬çš„ç„¦ç‚¹å¸¦å›åˆ°ä¸ªä½“æœåŠ¡çš„é¢†åŸŸã€‚æ‚¨éœ€è¦ä¸ºæ¯ä¸€ä¸ªåˆ›å»ºè´Ÿè½½å¹³è¡¡å™¨ç›®æ ‡ç»„ã€‚å¦‚æœLBæä¾›çš„æœåŠ¡ä¸è¶…è¿‡50ä¸ªå·¦å³ï¼Œè¿™åº”è¯¥æ²¡é—®é¢˜<a class="ae nx" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-limits.html" rel="noopener ugc nofollow" target="_blank">ï¼Œå‡è®¾æ¯ä¸ªæœåŠ¡ä½¿ç”¨ä¸€å¯¹ç›®æ ‡ç»„(ç”¨äºHTTPå’ŒHTTPS)ã€‚æ›´å¤šæœåŠ¡ï¼Œæ·»åŠ æ›´å¤šLBsã€‚</a></p><p id="c4a7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">è¿™ä¸ªTerraformé…ç½®è‡³å°‘åˆ›å»ºä¸€ä¸ªç›®æ ‡ç»„ï¼Œæ¯ä¸ªç›®æ ‡ç»„éƒ½ç”¨æœåŠ¡åå’Œä¸€ä¸ªéšæœºçš„å…­å­—ç¬¦åå…­è¿›åˆ¶åç¼€å‘½åã€‚æˆ‘ä½¿ç”¨äº†ä¸€ä¸ª<code class="fe nu nv nw nm b">blue_green</code>å¸ƒå°”å˜é‡æ¥æ”¯æŒAWS CodeDeployï¼Œå®ƒé€šè¿‡å°†æµé‡(æˆ–éƒ¨åˆ†æµé‡)ä»ä¸€ä¸ªç›®æ ‡ç»„åˆ‡æ¢åˆ°å¦ä¸€ä¸ªç›®æ ‡ç»„æ¥å®ŒæˆECSä»»åŠ¡çš„è“ç»¿è‰²/é‡‘ä¸é›€å¼éƒ¨ç½²ã€‚è¿™å°±æ˜¯æˆ‘ä½¿ç”¨éšæœºTGåç§°è€Œä¸æ˜¯â€œè“è‰²â€/â€œç»¿è‰²â€æˆ–å°æ•´æ•°çš„åŸå› â€”â€”æˆ‘æƒ³é¿å…è®¤ä¸ºå®ƒä»¬æœ‰ä»»ä½•è‡ªç„¶é¡ºåºï¼Œæˆ–è€…å°†å®ƒä»¬ä¸æ´»åŠ¨/ä¸æ´»åŠ¨ç›¸å…³è”ï¼Œå› ä¸ºå®ƒä»¬ä¸­çš„ä»»ä½•ä¸€ä¸ªéƒ½å¯èƒ½åœ¨ä»»ä½•æ—¶å€™æä¾›æµé‡ï¼Œå¦‚æœä¸æŸ¥çœ‹ä¾¦å¬å™¨è§„åˆ™ï¼Œæ‚¨æ˜¯ä¸ä¼šçŸ¥é“çš„ã€‚æˆ‘ä¸ä¼šåœ¨è¿™é‡Œè®¨è®ºéƒ¨ç½²é—®é¢˜ï¼Œæ‰€ä»¥å°±å‡è£…ä½ æ²¡æœ‰çœ‹åˆ°<code class="fe nu nv nw nm b">count</code>çš„è®ºç‚¹ï¼Œä½†æ˜¯å¯¹äºä½ çš„ç”Ÿäº§ç¯å¢ƒæ¥è¯´ï¼Œè¿™æ˜¯å€¼å¾—è€ƒè™‘çš„ã€‚</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="9178" class="mq lt it nm b gy nq nr l ns nt">resource "random_id" "target_group_http_80" {<br/>  count = var.blue_green ? 2 : 1<br/>  byte_length = 3<br/>}</span><span id="6c1d" class="mq lt it nm b gy nz nr l ns nt">resource "aws_alb_target_group" "http_80" {<br/>  count = var.blue_green ? 2 : 1<br/>  name = "${substr(var.name, 0, 20)}-${random_id.target_group_http_80[count.index].hex}"<br/>  protocol = "HTTP"<br/>  port = 80<br/>  vpc_id = var.vpc_id<br/>  slow_start = 30<br/>  stickiness {<br/>    type = "lb_cookie"<br/>  }<br/>  target_type = "ip"<br/>  health_check {<br/>    path = local.health_checks.path<br/>    port = 8080<br/>    timeout = local.health_checks.timeout<br/>    interval = local.health_checks.interval<br/>    matcher = "200-299"<br/>  }<br/>}</span></pre><p id="f3a5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">å› ä¸º<em class="kz"> infra </em>åœ¨å¦ä¸€ä¸ªæ ¹æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æˆ‘ä»¬è®¾ç½®çš„ALBè¿›è¡Œæ¨æ–­ã€‚</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="a32f" class="mq lt it nm b gy nq nr l ns nt">data "aws_alb_listener" "http_80" {<br/>  load_balancer_arn = var.internal_alb_arn<br/>  port = 80<br/>}</span><span id="1ce6" class="mq lt it nm b gy nz nr l ns nt">data "aws_alb_listener" "https_443" {<br/>  load_balancer_arn = var.internal_alb_arn<br/>  port = 443<br/>}</span></pre><p id="1f5b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¸ºç«¯å£80åˆ›å»ºä¸€ä¸ªç›‘å¬å™¨è§„åˆ™ï¼Œå¹¶å®šä¹‰ç‰¹å®šçš„è¡Œä¸º:</p><ul class=""><li id="a2eb" class="oa ob it kd b ke kf ki kj km oc kq od ku oe ky of og oh oi bi translated">å¦‚æœæ˜¯ä»¥â€œhttp://API . abq . com/ice-station-zebra/â€å¼€å¤´çš„URLï¼Œå®ƒå°†åŒ¹é…ä¸€ä¸ªè¯·æ±‚ã€‚æ³¨æ„ï¼Œå¦‚æœæ‚¨è¿˜éœ€è¦ç²¾ç¡®åœ°æä¾›æ ¹è·¯å¾„â€œ/ice-station-zebraâ€ï¼Œé‚£ä¹ˆæ‚¨å°†éœ€è¦å¦ä¸€ä¸ªå…·æœ‰è¯¥è·¯å¾„æ¨¡å¼çš„ä¾¦å¬å™¨è§„åˆ™(åœ¨ä¸€ä¸ªè§„åˆ™ä¸­ï¼Œæ¯ç§æ¡ä»¶ç±»å‹åªå…è®¸ä¸€ä¸ª)ã€‚</li><li id="e1d3" class="oa ob it kd b ke oj ki ok km ol kq om ku on ky of og oh oi bi translated">å¦‚æœè¯·æ±‚åŒ¹é…ï¼ŒALBå°†ä½¿ç”¨301è¿›è¡Œå“åº”ï¼Œå¹¶å°†ç”¨æˆ·é‡å®šå‘åˆ°ç›¸åŒçš„URLï¼Œä½†åœ¨ç«¯å£443ä¸Šã€‚</li></ul><p id="aa2f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">åŒæ ·ï¼Œä¸ºäº†ä¸API Gatewayé›†æˆï¼Œå¹¶ä¸çœŸæ­£éœ€è¦ç«¯å£80ï¼Œæ‰€ä»¥è¿™åªæ˜¯ä¸€ç§ä¿æŠ¤æªæ–½ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›VPCä¸­çš„å¦ä¸€ä¸ªæœåŠ¡é€šè¿‡ç«¯å£80ç›‘å¬å™¨è°ƒç”¨<em class="kz"> ice-station-zebra </em>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¦ä¸€ä¸ªç›‘å¬å™¨è§„åˆ™ã€‚å®ƒä¸ä¼šæœ‰é‡å®šå‘ï¼Œä½†éœ€è¦å¦ä¸€ä¸ªæ¡ä»¶æ¥å…è®¸VPCå†…éƒ¨çš„æµé‡ï¼Œæ¯”å¦‚ä¸€ä¸ªå¸¦æœ‰VPC CIDRé˜»å¡çš„<code class="fe nu nv nw nm b">source-ip</code>ã€‚</p><p id="dcb2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æˆ‘ä»¬è¿˜å°†ä¸ºç«¯å£443åˆ›å»ºä¸€ä¸ªä¾¦å¬å™¨è§„åˆ™ï¼Œè¯¥ç«¯å£å…·æœ‰ç›¸åŒçš„è¯·æ±‚æ¡ä»¶ï¼Œä½†æ˜¯ä¼šå°†æµé‡ä¼ é€’ç»™ç›®æ ‡ç»„ã€‚443è§„åˆ™è½¬å‘åˆ°ç«¯å£80ç›®æ ‡ç»„ï¼Œè¿™ä½¿å…¶æˆä¸ºTLSç»ˆæ­¢ç¬¦(ğŸ˜).</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="0eb0" class="mq lt it nm b gy nq nr l ns nt">resource "aws_alb_listener_rule" "http_80" {<br/>  listener_arn = data.aws_alb_listener.http_80.arn</span><span id="37c3" class="mq lt it nm b gy nz nr l ns nt">  action {<br/>    type = "redirect"<br/>    redirect {<br/>      port = data.aws_alb_listener.https_443.port<br/>      protocol = data.aws_alb_listener.https_443.protocol<br/>      status_code = "HTTP_301"<br/>    }<br/>  }<br/>  <br/>  condition {<br/>    host_header {<br/>      values = ["api.abq.com"]<br/>    }<br/>  }<br/>  <br/>  condition {<br/>    path_pattern {<br/>      values = ["/ice-station-zebra/*"]<br/>    }<br/>  }<br/>}</span><span id="58a2" class="mq lt it nm b gy nz nr l ns nt">resource "aws_alb_listener_rule" "http_443" {<br/>  listener_arn = data.aws_alb_listener.http_443.arn</span><span id="c5f2" class="mq lt it nm b gy nz nr l ns nt">  action {<br/>    type = "forward"<br/>    target_group_arn = aws_alb_target_group.http_80.arn<br/>  }<br/>  <br/>  condition {<br/>    host_header {<br/>      values = ["api.abq.com"]<br/>    }<br/>  }<br/>  <br/>  condition {<br/>    path_pattern {<br/>      values = ["/ice-station-zebra/*"]<br/>    }<br/>  }<br/>}</span></pre><h1 id="4650" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">å¼¹æ€§é›†è£…ç®±æœåŠ¡â€¦æœåŠ¡</h1><p id="2dca" class="pw-post-body-paragraph kb kc it kd b ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku ng kw kx ky im bi translated">ç°åœ¨ï¼Œåœ¨ä¸æ¶‰åŠECSçš„å¤ªå¤šç»†èŠ‚çš„æƒ…å†µä¸‹ï¼Œè®©æˆ‘ä»¬ä¸ºè‡ªå·±åˆ›å»ºä¸€ä¸ªæœåŠ¡ï¼Œå¹¶å°†å…¶ä¸æˆ‘ä»¬çš„ALBç›¸å…³è”ã€‚å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªECSé›†ç¾¤ã€ä»»åŠ¡å®šä¹‰å’Œä»»ä½•é€‚å½“çš„å®‰å…¨ç»„ã€‚</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="1cfd" class="mq lt it nm b gy nq nr l ns nt">resource "aws_ecs_service" "non_blue_green" {<br/>  name = "ice-station-zebra"<br/>  task_definition = local.task_definition<br/>  desired_count = local.desired_task_instance_count<br/>  deployment_maximum_percent = 200<br/>  deployment_minimum_healthy_percent = 100<br/>  launch_type = "FARGATE"<br/>  platform_version = "1.3.0"<br/>  scheduling_strategy = "REPLICA"<br/><br/>  load_balancer {<br/>    container_name = "app"<br/>    container_port = 8080<br/>    elb_name = null<br/>    target_group_arn = aws_alb_target_group.http_80.arn<br/>  }<br/><br/>  cluster = var.ecs_cluster_arn<br/>  propagate_tags = "TASK_DEFINITION"<br/><br/>  deployment_controller {<br/>    type = "ECS"<br/>  }<br/><br/>  network_configuration {<br/>    security_groups = compact(concat(var.ecs_security_group_ids, [<br/>      aws_security_group.ecs_service.id,<br/>    ]))<br/>    subnets = var.private_subnet_ids<br/>    assign_public_ip = false<br/>  }<br/><br/>  depends_on = [aws_alb_listener_rule.http_80, aws_alb_listener_rule.https_443]<br/>}</span></pre><p id="5968" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æˆ‘ä»¬åˆšåˆšâ€¦æ˜¯è¿™æ ·å—ï¼Ÿæˆ‘æƒ³æ˜¯çš„ï¼</p><h1 id="fc6f" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">æ‘˜è¦</h1><p id="501f" class="pw-post-body-paragraph kb kc it kd b ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku ng kw kx ky im bi translated">è¯·æ±‚å°†é€šè¿‡â€œhttps://API . abq . com/ice-station-zebra/*â€è¿›å…¥API Gatewayï¼Œå¹¶å°†é€šè¿‡VPCæœåŠ¡ç«¯ç‚¹(æˆ‘åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­ä»‹ç»äº†æ‰€æœ‰è¿™äº›)ã€‚ç„¶åï¼Œæµé‡å°†é€šè¿‡NLBå’ŒALBï¼Œæœ€ç»ˆåˆ°è¾¾æˆ‘ä»¬çš„ECSä»»åŠ¡ã€‚ä»»åŠ¡çš„å“åº”å°†é‡‡å–ç›¸åæ–¹å‘çš„ç›¸åŒè·¯å¾„ã€‚</p><p id="749f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æˆ‘å¸Œæœ›è¿™å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚ä¸€å¦‚æ—¢å¾€ï¼Œæˆ‘å¾ˆé«˜å…´å¬åˆ°æ‚¨çš„åé¦ˆï¼Œå¹¶æ„Ÿè°¢æ‚¨çš„é˜…è¯»ã€‚</p></div></div>    
</body>
</html>