# Python ä¸­çš„çº¿ç¨‹å’Œå¤šå¤„ç†æ¨¡å—

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/threading-and-multiprocessing-modules-in-python-14363c13fe9d>

> æœ¬æ–‡æä¾›äº† python ä¸­çš„[çº¿ç¨‹](https://docs.python.org/3/library/threading.html)å’Œ[å¤šé‡å¤„ç†](https://docs.python.org/3/library/multiprocessing.html)æ¨¡å—èƒŒåçš„åŸºæœ¬æ€æƒ³ã€‚

![](img/72b2da25cb5a97e703e0ebdcc49ddbff.png)

çº¿ç¨‹èƒŒåçš„åŸºæœ¬æ€æƒ³æ˜¯åœ¨ç¨‹åºä¸­æ‰§è¡Œä¸€ç³»åˆ—è¿™æ ·çš„æŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤å¯ä»¥ç‹¬ç«‹äºå…¶ä»–ä»£ç æ‰§è¡Œã€‚

é‚£ä¹ˆçº¿ç¨‹åŒ–å’Œå¤šå¤„ç†æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿå½“æˆ‘ä»¬æƒ³è¦åŒæ—¶è¿è¡Œä¸åŒçš„ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨çº¿ç¨‹ï¼Œå½“æˆ‘ä»¬æƒ³è¦æ‰§è¡ŒåŸºäºè¿›ç¨‹çš„å¹¶è¡Œæ—¶ï¼Œåˆ™ä½¿ç”¨å¤šå¤„ç†ã€‚

## å—è®¡ç®—å’Œ I/O é™åˆ¶çš„ä»»åŠ¡

åœ¨è®¡ç®—èŒƒå›´å†…ï¼Œè®¡ç®—çš„è¿›å±•é€Ÿåº¦å®Œå…¨å–å†³äº CPU çš„æ€§èƒ½ï¼Œè€Œåœ¨ I/O èŒƒå›´å†…ï¼Œè¿›ç¨‹çš„è¿›å±•é€Ÿåº¦å—åˆ°è¾“å…¥å’Œè¾“å‡ºç³»ç»Ÿé€Ÿåº¦çš„é™åˆ¶ã€‚

åœ¨å—è®¡ç®—çº¦æŸçš„ä»»åŠ¡ä¸­ï¼Œç¨‹åºå¤§éƒ¨åˆ†æ—¶é—´åªæ˜¯ä½¿ç”¨ CPUï¼Œå³è¿›è¡Œè®¡ç®—ã€‚ä¸€ä¸ªæ²‰è¿·äºå¤„ç†æ•°å­—çš„ç¨‹åºæ›´æœ‰å¯èƒ½æ˜¯ä¸€ä¸ªè®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ã€‚

ä¸æ‰€éœ€çš„è®¡ç®—é‡ç›¸æ¯”ï¼Œå¤„ç†å¤§é‡ç£ç›˜æ•°æ®çš„ä»»åŠ¡(ä¾‹å¦‚ï¼Œè®¡ç®—æ–‡ä»¶ä¸­çš„è¡Œæ•°)å¾ˆå¯èƒ½ä¼šå—åˆ° I/O çš„é™åˆ¶ã€‚

## Python çš„ GIL é—®é¢˜

ä¸€èˆ¬æ¥è¯´ï¼ŒPython åªä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œå†™å¥½çš„è¯­å¥é›†ã€‚è¿™æ„å‘³ç€åœ¨ python ä¸­ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ã€‚python ä¸­å•çº¿ç¨‹è¿›ç¨‹å’Œå¤šçº¿ç¨‹è¿›ç¨‹çš„æ€§èƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ˜¯å› ä¸º python ä¸­çš„ [GIL](https://wiki.python.org/moin/GlobalInterpreterLock) (å…¨å±€è§£é‡Šå™¨é”)ã€‚æˆ‘ä»¬ä¸èƒ½åœ¨ python ä¸­å®ç°å¤šçº¿ç¨‹ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰ä¸€ä¸ªå…¨å±€è§£é‡Šå™¨é”ï¼Œå®ƒé™åˆ¶çº¿ç¨‹å¹¶ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹å·¥ä½œã€‚

**è¿›ç¨‹**åŠ é€Ÿ CPU å¯†é›†å‹çš„ Python æ“ä½œï¼Œå› ä¸ºå®ƒä»¬å—ç›Šäºå¤šæ ¸å¹¶é¿å…äº† GILï¼Œè€Œ**çº¿ç¨‹**æœ€é€‚åˆ IO ä»»åŠ¡æˆ–æ¶‰åŠå¤–éƒ¨ç³»ç»Ÿçš„ä»»åŠ¡ï¼Œå› ä¸ºçº¿ç¨‹å¯ä»¥æ›´æœ‰æ•ˆåœ°ç»„åˆå®ƒä»¬çš„å·¥ä½œã€‚æµç¨‹éœ€è¦å¤„ç†å®ƒä»¬çš„ç»“æœæ¥ç»„åˆå®ƒä»¬ï¼Œè¿™éœ€è¦æ—¶é—´ã€‚

**ç”±äº GILï¼Œçº¿ç¨‹**åœ¨ python ä¸­å¯¹ CPU å¯†é›†å‹ä»»åŠ¡æ²¡æœ‰æä¾›ä»»ä½•å¥½å¤„ã€‚

## ä¸ºä»€ä¹ˆæ˜¯ GILï¼Ÿ

çº¿ç¨‹æ¨¡å—ä½¿ç”¨çº¿ç¨‹ï¼Œå¤šå¤„ç†æ¨¡å—ä½¿ç”¨è¿›ç¨‹ã€‚åŒºåˆ«åœ¨äºçº¿ç¨‹è¿è¡Œåœ¨åŒä¸€ä¸ªå†…å­˜ç©ºé—´ï¼Œè€Œè¿›ç¨‹æœ‰å„è‡ªç‹¬ç«‹çš„å†…å­˜ã€‚è¿™ä½¿å¾—åœ¨å…·æœ‰å¤šé‡å¤„ç†çš„è¿›ç¨‹ä¹‹é—´å…±äº«å¯¹è±¡æœ‰ç‚¹å›°éš¾ï¼Œå› æ­¤é€šå¸¸é€šè¿‡é…¸æ´—å¯¹è±¡æ¥å®ç°ã€‚ç”±äºçº¿ç¨‹ä½¿ç”¨ç›¸åŒçš„å†…å­˜ï¼Œå› æ­¤å¿…é¡»é‡‡å–é¢„é˜²æªæ–½ï¼Œå¦åˆ™ä¸¤ä¸ªçº¿ç¨‹å°†åŒæ—¶å†™å…¥ç›¸åŒçš„å†…å­˜ã€‚è¿™å°±æ˜¯å…¨å±€è§£é‡Šå™¨é”çš„ç”¨é€”ã€‚

å¦‚æœæˆ‘ä»¬è¿è¡Œä¸€ä¸ª python è„šæœ¬ï¼Œå®ƒåªæ˜¯æ‰§è¡Œä¸€ä¸ªç®€å•çš„ç¡çœ ä»»åŠ¡(è¿™è‚¯å®šä¼šå¾ˆè€—æ—¶ï¼Œå“ˆå“ˆå“ˆï¼)é‚£ä¹ˆè„šæœ¬åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚

```
import timestart = time.perf_counter()def please_sleep(n):
    print("Sleeping for {} seconds".format(n))
    time.sleep(n)
    print("Done Sleeping")for i in range(1,5):
   please_sleep(i)finish = time.perf_counter()print("Finished in {} seconds".format(finish-start))
```

æˆ‘ä»¬å¾—åˆ°äº†æˆ‘ä»¬éƒ½æœŸæœ›çš„ç»“æœ

![](img/9d850efe5b0b59caff1fa142801411ce.png)

è¯¥è„šæœ¬çš„å·¥ä½œæµç¨‹å¦‚ä¸‹æ‰€ç¤º:

![](img/de779e36fecf320d28e190a6e933539f.png)

*è®©æˆ‘ä»¬ä»çº¿ç¨‹æ¨¡å—*å¼€å§‹

# çº¿ç¨‹æ¨¡å—

çº¿ç¨‹çš„å·¥ä½œæµç¨‹å¯ä»¥æè¿°å¦‚ä¸‹:

![](img/39853f862bd258c45c72c77d2dbd4334.png)

æˆ‘ä»¬é¦–å…ˆéœ€è¦å¯¼å…¥çº¿ç¨‹æ¨¡å—(æ˜¾ç„¶ï¼)

ä¸ºäº†ä½¿ç”¨çº¿ç¨‹å¤åˆ¶ä¸Šé¢æåˆ°çš„è„šæœ¬ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¿™å¯ä»¥é€šè¿‡å¤šæ¬¡æ‰§è¡Œç®€å•çš„**çº¿ç¨‹**æ–¹æ³•æ¥å®Œæˆã€‚å…¶è¯­æ³•å¦‚ä¸‹æ‰€ç¤º

```
thread1 = threading.Thread(target = method_name, args = [list of arguments])
```

ä¸€æ—¦æˆ‘ä»¬åˆ›å»ºäº†çº¿ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ **start** æ–¹æ³•æ¥å¯åŠ¨å®ƒä»¬

```
thread1.start()
```

è®©æˆ‘ä»¬ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå…ˆåˆ›å»º 2 ä¸ªçº¿ç¨‹ï¼Œç„¶åæˆ‘ä»¬å°†å°è¯•å¤åˆ¶ä¸Šé¢çš„è„šæœ¬

```
import time
import threadingstart = time.perf_counter()def please_sleep(n):
    print("Sleeping for {} seconds".format(n))
    time.sleep(n)
    print("Done Sleeping")t1 = threading.Thread(target = please_sleep, args = [1])
t2 = threading.Thread(target = please_sleep, args = [2])t1.start()
t2.start()finish = time.perf_counter()print("Finished in {} seconds".format(finish-start))
```

æ ¹æ®å·¥ä½œæµï¼Œæˆ‘ä»¬ç°åœ¨åº”è¯¥è®¤ä¸ºè¿™æ®µä»£ç åº”è¯¥æ‰§è¡Œå¤§çº¦ 2 ç§’é’Ÿã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹è¾“å‡ºã€‚

![](img/60e776e76a4dff00dce71412f013d809.png)

å“å‘€ï¼Œè¿™æ˜¯æ„æ–™ä¹‹å¤–çš„ï¼Œå¯¹å§ï¼Ÿå‘ç”Ÿè¿™ç§è¡Œä¸ºæ˜¯å› ä¸ºåœ¨ä¸¤ä¸ªçº¿ç¨‹éƒ½å¯åŠ¨åï¼Œå½“çº¿ç¨‹éƒ½åœ¨ä¼‘çœ æ—¶ï¼Œæˆ‘ä»¬çš„è„šæœ¬åŒæ—¶è¿è¡Œï¼Œå¹¶ç»§ç»­æ‰§è¡Œè„šæœ¬çš„å…¶ä½™éƒ¨åˆ†ã€‚ä»è€Œç«‹å³è®¡ç®—å‡ºç»“æŸæ—¶é—´ã€‚

ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ **join** æ–¹æ³•ã€‚å½“è°ƒç”¨ **join** æ–¹æ³•æ—¶ï¼Œè°ƒç”¨çº¿ç¨‹(åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ä¸»çº¿ç¨‹)è¢«é˜»å¡ï¼Œç›´åˆ°è°ƒç”¨å®ƒçš„çº¿ç¨‹å¯¹è±¡(please_sleep æ–¹æ³•)è¢«ç»ˆæ­¢ã€‚æˆ‘ä»¬å¯ä»¥ä»¥ç±»ä¼¼äº **start** æ–¹æ³•çš„æ–¹å¼è°ƒç”¨å®ƒ

```
thread1.join()
```

ç°åœ¨è®©æˆ‘ä»¬ç”¨æˆ‘ä»¬å­¦è¿‡çš„æ¦‚å¿µå¤åˆ¶ä¸»è„šæœ¬ã€‚

```
import time
import threadingstart = time.perf_counter()def please_sleep(n):
    print("Sleeping for {} seconds".format(n))
    time.sleep(n)
    print("Done Sleeping for {} seconds".format(n))threads = []for i in range(1,5):
    t = threading.Thread(target = please_sleep, args = [i])
    t.start()
    threads.append(t)for t in threads:
    t.join()finish = time.perf_counter()print("Finished in {} seconds".format(finish-start))
```

è¿™å°†æ‰“å°å‡ºé¢„æœŸçš„ç»“æœã€‚

![](img/e6d49b3c1606ffd929a1aaee5f48dd0e.png)

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨å°†è¿‘ 4 ç§’å†…æˆåŠŸåœ°æ‰§è¡Œäº†è¿™ 4 é¡¹ä»»åŠ¡ï¼Œè€Œè¿™äº›ä»»åŠ¡åŸæœ¬éœ€è¦å°†è¿‘ 10 ç§’ã€‚

*ä½¿ç”¨å¤šå¤„ç†æ¨¡å—å¯ä»¥å®Œæˆè¿™é¡¹ä»»åŠ¡å—ï¼Ÿæ˜¯çš„ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€çœ‹ã€‚*

# å¤šé‡å¤„ç†æ¨¡å—

æˆ‘çš„æœºå™¨ä¸Šæœ‰ 4 ä¸ªå†…æ ¸ï¼Œæ‰€ä»¥æˆ‘å°†å‚ç…§æˆ‘çš„æœºå™¨è¿›è¡Œè¯´æ˜ã€‚è¿™æ˜¯å¤šé‡å¤„ç†çš„å·¥ä½œæµç¨‹ã€‚

![](img/28885d680770d7d7b234be2a4e2fe70f.png)

å¼€å§‹ä¸€ä¸ªè¿‡ç¨‹çš„è¿‡ç¨‹ğŸ˜›ç±»ä¼¼äºèºçº¹ã€‚è¿™é‡Œæˆ‘ä»¬é¦–å…ˆå¯¼å…¥å¤šå¤„ç†æ¨¡å—ï¼Œç„¶åè°ƒç”¨ **Process** æ–¹æ³•ï¼Œåé¢è·Ÿç€ä¸€ä¸ª start æ–¹æ³•ã€‚

```
process1 = multiprocessing.Process(target = method_name, args = [list of arguments])
process1.start()
```

ä¸è¿›ç¨‹ç›¸æ¯”ï¼Œçº¿ç¨‹æ›´åŠ è½»é‡çº§ï¼Œå¼€é”€ä¹Ÿæ›´ä½ã€‚å› æ­¤ï¼Œç”Ÿæˆè¿›ç¨‹æ¯”ç”Ÿæˆçº¿ç¨‹è¦æ…¢ä¸€äº›ã€‚è®©æˆ‘ä»¬å€ŸåŠ©ä¸€ä¸ªä¾‹å­æ¥çœ‹çœ‹ã€‚

```
import time
import multiprocessingstart = time.perf_counter()def please_sleep(n):
    print("Sleeping for {} seconds".format(n))
    time.sleep(n)
    print("Done Sleeping for {} seconds".format(n))p1 = multiprocessing.Process(target = please_sleep, args = [1])
p2 = multiprocessing.Process(target = please_sleep, args = [2])p1.start()
p2.start()finish = time.perf_counter()print("Finished in {} seconds".format(finish-start))
```

ä¸‹é¢æè¿°çš„è¾“å‡ºæ˜¾ç¤ºï¼Œåœ¨æ•´ä¸ªè„šæœ¬è¿è¡Œä¹‹åï¼Œè¿›ç¨‹å·²ç»å¯åŠ¨ã€‚è¿™è¯æ˜äº†æˆ‘ä»¬çš„ä¸Šè¿°å£°æ˜ã€‚

![](img/44b36262eb72828ab6e5a1c434326fc6.png)

æ­¤å¤„çš„ **join** æ–¹æ³•è¿˜é˜²æ­¢åœ¨è°ƒç”¨åæ‰§è¡Œè¿›ä¸€æ­¥çš„è„šæœ¬ï¼Œç›´åˆ°æµç¨‹å®Œæˆã€‚å®ƒå¯ä»¥ä½œä¸º

```
process1.join()
```

ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè„šæœ¬ï¼Œå®ƒä½¿ç”¨å¤šçº¿ç¨‹æ¥å¹¶è¡ŒåŒ–è¯¥æ–¹æ³•ã€‚

```
import time
import multiprocessingstart = time.perf_counter()def please_sleep(n):
    print("Sleeping for {} seconds".format(n))
    time.sleep(n)
    print("Done Sleeping for {} seconds".format(n))processes = []for i in range(1,6):
    p = multiprocessing.Process(target = please_sleep, args = [i])
    p.start()
    processes.append(p)for p in processes:
    p.join()finish = time.perf_counter()print("Finished in {} seconds".format(finish-start))
```

è¾“å‡ºå°†æ ¹æ®å·¥ä½œæµç¨‹ã€‚

![](img/5402235e6b369ca700a67efd05d8e2a2.png)

ä½¿ç”¨å¹¶è¡Œæ€»æ˜¯ä¼´éšç€æ•ˆç‡çš„æŸå¤±ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒåˆ©ç”¨äº†æ›´å¤šçš„èµ„æºï¼Œå› æ­¤å¹¶è¡Œæ‰§è¡Œçš„è®¡ç®—çš„æ€»æ—¶é—´é€šå¸¸æ¯”ä¸²è¡Œæ›´å¿«ã€‚åœ¨[é˜¿å§†è¾¾å°”å®šå¾‹](https://en.wikipedia.org/wiki/Amdahl%27s_law)çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è¯´ï¼Œå¤šå¤„ç†å™¨å¹¶è¡Œè®¡ç®—åªå¯¹é«˜åº¦å¯å¹¶è¡ŒåŒ–çš„ç¨‹åºæœ‰ç”¨ã€‚

![](img/3a0ac841fad467f4d6c456401887f12a.png)

è¿™å¼ å›¾ç‰‡å–è‡ª[ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Amdahl%27s_law#/media/File:AmdahlsLaw.svg)

æˆ‘å¾ˆæ¬£èµä½ çš„è€å¿ƒï¼Œè°¢è°¢ä½ åšæŒåˆ°ç°åœ¨ã€‚

æ¬¢è¿å»ºè®®ï¼

è°¢è°¢ğŸ˜º