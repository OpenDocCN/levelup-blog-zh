<html>
<head>
<title>Terraform Deploy a Two Tier Architecture in AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform在AWS中部署两层架构</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/terraform-two-tier-architecture-66fa07c8e325?source=collection_archive---------2-----------------------#2022-08-03">https://levelup.gitconnected.com/terraform-two-tier-architecture-66fa07c8e325?source=collection_archive---------2-----------------------#2022-08-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/4bc564f4f41a4f508f316ea50b281107.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xhbNACK1l7q9g88nfDNL0g.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com/es/@lazycreekimages?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">迈克尔·泽兹奇</a>在<a class="ae kf" href="https://unsplash.com/s/photos/monolith?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="e5ca" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这个项目中，我们将潜入<strong class="ki iu">地形</strong>。Terraform是一个开源的<strong class="ki iu">基础设施，作为代码</strong>工具。它使您能够在云中构建、更改和版本化资源。您可以使用Terraform处理多个云。对于本文，我们将重点关注<strong class="ki iu"> AWS云</strong>。我们将构建一个由以下内容组成的<strong class="ki iu"> 2层架构</strong>:</p><ul class=""><li id="bfaf" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">有2个公共子网和2个私有子网的VPC。</li><li id="a2af" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">一个负载平衡器，将流量定向到公共子网和每个公共子网中的1个EC2实例。</li><li id="06a2" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">其中一个子网中的RDS MySQL实例。</li></ul><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/54112f3f9d34ceed011f5d3dd5399011.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*KJuP2yGKCNFrm5kfUmIpPA.jpeg"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">建筑示意图</figcaption></figure><p id="2805" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">先决条件</p><ul class=""><li id="f45a" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">具有凭据和密钥对的AWS帐户。</li><li id="657c" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">IDE，我将使用Visual Studio代码。</li><li id="fb7b" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">您需要安装Terraform和AWS并进行配置。</li></ul><p id="7a69" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们正在创建的项目将被视为一个整体<strong class="ki iu"/>，我们将在一个目录中拥有一个主配置文件。这是一个练习使用和理解Terraform的小项目。在某种程度上，打破这一整体可能更安全、更合理。但是现在，让我们继续前进。</p><h2 id="fb8c" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">写</h2><p id="e943" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">首先，我们需要使用HashiCorp配置语言(HCL)来创建代码。我将使用VSCode IDE输入我的代码。您将需要为您的Terraform项目创建一个新目录，我称之为我的双层项目。使用在<code class="fe mv mw mx my b">cd &lt;directory&gt;</code>中键入的VSCode中的终端导航到该目录。然后在该目录中创建一个新文件<code class="fe mv mw mx my b">main.tf</code>。您可以从下面的我的代码列表中复制并粘贴来创建一个文件。您也可以修改或创建自己的。我使用terraform注册表来帮助构建我的代码。现在让我们分解代码来详细解释每一部分。</p><figure class="lt lu lv lw gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="2874" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在第一段代码中，我们让Terraform知道我们将使用什么样的云提供商，并配置给该提供商，<em class="nb"> AWS </em>。接下来，我们正在创建资源。第一个资源是用CIDR 10.0.0.0/16创建一个定制的<em class="nb"> VPC </em>。接下来，它创建一个<em class="nb">互联网网关</em>来连接到VPC。接下来，我们使用CIDR 10.0.1.0/24和10.0.2.0/24创建<em class="nb"> 2个公共子网</em>。每个子网位于不同的可用性区域；美国东部-1a和美国东部-1b。为了高可用性。然后，我们使用CIDR 10.0.3.0/24和10.0.4.0/24创建<em class="nb"> 2个私有子网</em>，它们也位于2个不同的可用性分区中。请注意，公共子网在启动时会映射公共IP，而私有子网则不会，这就是它们是“私有”的原因。</p><figure class="lt lu lv lw gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="bcc1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，我们创建一个<em class="nb">路由表</em>，通过互联网网关将流量路由到VPC。然后，我们需要将子网与路由表相关联。仅授予对公共子网的访问权限。接下来，我们创建<em class="nb">安全组</em>。第一个安全组用于公共子网。它将允许端口80 (HTTP)上的传入web访问以及SSH访问。第二个安全组将用于私有子网，只允许安全组通过web层和SSH访问进行访问。端口3306是MYSQL的默认端口。</p><figure class="lt lu lv lw gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="d346" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个要点是关于<em class="nb">负载平衡器</em>的。这很难弄清楚。我的EC2实例不断出现运行状况检查错误。所以我为我的负载平衡器添加了一个安全组。然后，我们创建一个面向互联网的应用负载平衡器。使用负载平衡器，您需要:</p><ul class=""><li id="a437" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">目标群体。</li><li id="fbb4" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">目标附件，您的EC2实例。</li><li id="473a" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">端口80上的侦听器。</li></ul><figure class="lt lu lv lw gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="d01a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里我们创建了<em class="nb"> EC2实例</em>，它们将被启动到每个公共子网中。EC2实例有Amazon Linuz AMI和实例类型t2.micro。我还在user_data部分添加了一个引导程序。这将在启动时安装一个Apache服务器。这将结束web层。</p><figure class="lt lu lv lw gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="5b53" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后一部分是数据库层。我们将在其中一个私有子网中创建一个RDS MYSQL数据库实例。为此，我们需要添加一个数据库子网组，并放入我们的2个专用子网。然后将它与我们的数据库实例以及私有安全组相关联。注意,“标识符”命名数据库实例，而“db_name”实际上提示它创建一个数据库。您需要添加用户名和密码来访问数据库。我拥有它的方式不安全。您可以将秘密放在一个<code class="fe mv mw mx my b">tfvars</code>文件中，并在应用代码时引用它。主文件的创建到此结束。</p><p id="a17e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我将在我们的项目中再添加一个文件。在主文件所在的目录下创建一个名为<code class="fe mv mw mx my b">outputs.tf</code>的文件。在这里我们可以指出我们想要看到的输出。它们被用作与其他工具或自动化共享数据的一种方式。我将用它来收集访问实例所需的信息。将下面的要点复制并粘贴到你的文件中。</p><figure class="lt lu lv lw gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><h2 id="d48d" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">计划</h2><p id="442b" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">现在我们的代码已经写好了，我们可以继续到终端。输入命令<code class="fe mv mw mx my b">terraform init</code>。要下载所需的库和模块，请初始化包含Terraform代码的工作目录，并设置后端。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/f76c018b8b2a84e2c67fe6dba87817ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*p7mUOw0MsXVa44YDuCFQhw.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">成功初始化</figcaption></figure><p id="9ef3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一个输入<code class="fe mv mw mx my b">terraform plan</code>。这将读取代码，创建并向您展示一个行动计划。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/459f049e668f5de694751007a1e112d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:704/format:webp/1*EPj1LXgtqgTxfArMO5MsMA.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">增加21项资源和产出</figcaption></figure><p id="fd94" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">仔细审查计划。一旦你决定这是正确的，就进入下一阶段。</p><h2 id="8455" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">应用</h2><p id="194e" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">当您应用代码时，它会部署和供应您的基础架构。Terraform还更新了一种部署状态跟踪机制，称为“状态文件”。该文件将作为<code class="fe mv mw mx my b">terraform.tfstate</code>出现在您的目录中。输入命令<code class="fe mv mw mx my b">terraform apply</code>应用代码。系统将提示您接受Terraform将执行的操作，输入“是”。配置您的资源需要一些时间。</p><figure class="lt lu lv lw gt ju"><div class="bz fp l di"><div class="ne na l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">满怀期待地等待着…希望你的代码能够工作…希望所有的部分能够走到一起…</figcaption></figure><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/5d90bf31c4813882c560ef3d231233ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*tm-ZQ8uJuJTDMKk6AI-Cjw.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">注意输出</figcaption></figure><p id="9dfb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">而且成功了！相信我，这不是第一次尝试，我犯了很多错误。您可以在AWS控制台中签出所有新创建的资源！</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ng"><img src="../Images/edcf516c349aadaf3e5bb5ddf1ee72af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i9KdzdiyRyeQoFtQxx9NDQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">VPC</figcaption></figure><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nh"><img src="../Images/75f8f428b7339b6394fffad40202ff6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ue1RC9SoogafBWzhYPzjHQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">子网</figcaption></figure><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/c82cb5f55e7fa854ce454f242d80a520.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*n3u0-7oWECHwsuYmBOITlA.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">实例正在运行</figcaption></figure><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nj"><img src="../Images/e04a73d6e6e484a543411f787746d3fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rlms8bmu-XVpLpWTiVgJzg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">具有2个健康实例的ALB的目标</figcaption></figure><p id="a4c0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">真正了不起的是，我们的输出之一是负载平衡器的DNS名称。复制并粘贴到您的浏览器中。这将显示我们是否能够从web层访问互联网。</p><div class="lt lu lv lw gt ab cb"><figure class="nk ju nl nm nn no np paragraph-image"><img src="../Images/3dbdeb6c0682b04a63d64e548daf6c3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:830/format:webp/1*iuFC0kX6gH6mtD0zPHpHwg.png"/></figure><figure class="nk ju nq nm nn no np paragraph-image"><img src="../Images/33da4aff01c380d21b894dd0189eb350.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*Syr9WL018kusMxW7brRhjg.png"/><figcaption class="kb kc gj gh gi kd ke bd b be z dk nr di ns nt translated">单击刷新按钮在实例之间切换</figcaption></figure></div><p id="4fc8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">而且成功了！</p><p id="3903" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在让我们看看是否可以SSH到我们的实例中。输入下面的代码，包括EC2公共IP，您可以从您的输出中获取。图钉A连接您的密钥对。</p><pre class="lt lu lv lw gt nu my nv nw aw nx bi"><span id="1cea" class="lx ly it my b gy ny nz l oa ob">ssh -A ec2-user@35.173.245.130</span></pre><p id="a3ce" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你将被带到亚马逊linux AMI。所以我们成功地SSH到实例中。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/29dd5f6b701b166c828eee1cb152daef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*GFyBjB08etGcPQez0JeVyg.png"/></div></figure><p id="9739" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从这里，我们可以尝试访问数据库层。先安装mariadb <code class="fe mv mw mx my b">sudo yum install mariadb</code>。然后输入下面的代码。在<code class="fe mv mw mx my b">-h</code>之后的输出中包含数据库实例地址。</p><pre class="lt lu lv lw gt nu my nv nw aw nx bi"><span id="0bd6" class="lx ly it my b gy ny nz l oa ob">mysql -h db-instance.cm4bp7mgz27s.us-east-1.rds.amazonaws.com -P 3306 -u admin -p</span></pre><p id="4898" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">系统将提示您输入您创建的密码。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi od"><img src="../Images/326dd4638dacbcb1a730c132f1ce5543.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FT2gQUV1tYXjNd0rzbDXUQ.png"/></div></div></figure><p id="f39d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们联系上了。现在让我们看看我们的RDS MYSQL数据库是否在这里。输入<code class="fe mv mw mx my b">SHOW DATABASES;</code>。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/9a3ad9f93ee7448819064a4b24f1557b.png" data-original-src="https://miro.medium.com/v2/resize:fit:674/format:webp/1*n-GFgPo0daDiVVVcQsyVoQ.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">我们创建的数据库</figcaption></figure><p id="4279" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是我们在代码中命名的数据库。现在，我们看到一切都已启动、运行并协同工作，我们可以进入最后一步了。</p><h2 id="bfb9" class="lx ly it bd lz ma mb dn mc md me dp mf kr mg mh mi kv mj mk ml kz mm mn mo mp bi translated">破坏</h2><p id="0473" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">现在我们将毁掉我们为建造这个东西付出的所有努力，我有点激动。输入命令<code class="fe mv mw mx my b">terraform destroy</code>。它会问你是否真的要销毁所有资源，准备好后输入yes。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div class="gh gi of"><img src="../Images/82af3837ba0b5bd090af5d25a6df8d3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*ttLLCC5kBQVOm1JPbxL-Vw.png"/></div></figure><p id="c71a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这就结束了使用Terraform在AWS中创建两层架构。Terraform是一个令人惊叹的工具，我计划在未来打破这种垄断，使用变量和模块。请继续关注我的下一篇文章。</p></div></div>    
</body>
</html>