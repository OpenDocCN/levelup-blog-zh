<html>
<head>
<title>Simplifying Redux</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">简化冗余</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/simple-redux-implementation-4fb54b01704d?source=collection_archive---------1-----------------------#2019-05-05">https://levelup.gitconnected.com/simple-redux-implementation-4fb54b01704d?source=collection_archive---------1-----------------------#2019-05-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="618b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://redux.js.org/" rel="noopener ugc nofollow" target="_blank"> Redux </a>是不是让你很头疼？导航Redux的代码库时，你会感到沮丧吗？在本文中，我们将用大约30行代码实现Redux的核心功能！</p><p id="982e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">TL；DR </strong> -这是我们对<code class="fe km kn ko kp b">createStore</code>和<code class="fe km kn ko kp b">combineReducers</code>的实现，涵盖了Redux最常见的API。</p><p id="738b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe km kn ko kp b">createStore</code></p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="kv kw l"/></div></figure><p id="39bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe km kn ko kp b">combineReducers</code></p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="kv kw l"/></div></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="7d6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看Redux的<a class="ae kl" href="https://redux.js.org/api/api-reference" rel="noopener ugc nofollow" target="_blank"> API参考</a>。列表上的第一项是<a class="ae kl" href="https://redux.js.org/api/createstore" rel="noopener ugc nofollow" target="_blank"> createStore </a>，我们现在就要实现它！</p><h2 id="db17" class="le lf iq bd lg lh li dn lj lk ll dp lm jy ln lo lp kc lq lr ls kg lt lu lv lw bi translated">createStore接收3个参数:</h2><ol class=""><li id="91c2" class="lx ly iq jp b jq lz ju ma jy mb kc mc kg md kk me mf mg mh bi translated">还原剂</li><li id="0c80" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated">初态</li><li id="8223" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated">增强器(为了简单起见，我们将只使用中间件)</li></ol><h2 id="eb54" class="le lf iq bd lg lh li dn lj lk ll dp lm jy ln lo lp kc lq lr ls kg lt lu lv lw bi translated">createStore返回一个具有以下函数的对象:</h2><ol class=""><li id="5dd2" class="lx ly iq jp b jq lz ju ma jy mb kc mc kg md kk me mf mg mh bi translated"><code class="fe km kn ko kp b">getState</code></li><li id="99ae" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated"><code class="fe km kn ko kp b">dispatch</code></li><li id="3cde" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated"><code class="fe km kn ko kp b">subscribe</code></li></ol><p id="5382" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们将为<code class="fe km kn ko kp b">createStore</code>创建线框:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="kv kw l"/></div></figure><p id="f114" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，现在我们有了线框，我们可以开始一步一步地实现它。</p><p id="0a3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要添加一个名为<code class="fe km kn ko kp b">state</code>的局部变量，它是用传递给<code class="fe km kn ko kp b">createStore</code>函数的<code class="fe km kn ko kp b">initialState</code>初始化的。由于<code class="fe km kn ko kp b">getState</code>只是返回状态，我们可以很容易地实现它:</p><pre class="kq kr ks kt gt mn kp mo mp aw mq bi"><span id="afe7" class="le lf iq kp b gy mr ms l mt mu">let state = initialState;<br/>return {<br/>  getState: () =&gt; state,<br/>  ...<br/>}</span></pre><p id="3fe1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个简单的实现是<code class="fe km kn ko kp b">subscribe</code>:</p><p id="158a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe km kn ko kp b">subscribe</code>是一个接收侦听器并返回<code class="fe km kn ko kp b">unsubscribe</code>函数的函数，该函数将删除侦听器，以便在存储更改时不再调用它。</p><pre class="kq kr ks kt gt mn kp mo mp aw mq bi"><span id="2a2c" class="le lf iq kp b gy mr ms l mt mu">const listeners = [];<br/>return {<br/>  subscribe: (listener) =&gt; {<br/>    listeners.push(listener);<br/>    return () =&gt; {<br/>      listeners.splice(listeners.indexOf(listener), 1);}<br/>    }<br/>  },<br/>  ...<br/>}</span></pre><p id="0e28" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们继续进行<code class="fe km kn ko kp b">dispatch</code>之前，让我们实现Redux实现的最后一步，即评估缩减器、调用监听器并返回新状态:</p><pre class="kq kr ks kt gt mn kp mo mp aw mq bi"><span id="4c2b" class="le lf iq kp b gy mr ms l mt mu">let state = initialState;<br/>const listeners = [];</span><span id="1720" class="le lf iq kp b gy mv ms l mt mu">let dispatchAction = (action) =&gt; {<br/>  state = reducer(state, action);<br/>  listeners.forEach(listener =&gt; listener());<br/>  return state;<br/>}</span></pre><p id="e64a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，<code class="fe km kn ko kp b">dispatch</code>是一个接收动作并触发存储状态变化的函数。基本上，它用接收到的动作调用最后一步:</p><pre class="kq kr ks kt gt mn kp mo mp aw mq bi"><span id="e324" class="le lf iq kp b gy mr ms l mt mu">return {<br/>  dispatch: (action) =&gt; dispatchAction(action),<br/>  ...<br/>}</span></pre><p id="e9e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的实现中，我们只使用了reducer来触发存储的状态变化，但是我们的中间件呢？在Redux改变状态之前，我们想执行的所有副作用呢？在此之前，我们先来探索一下中间件的结构:</p><pre class="kq kr ks kt gt mn kp mo mp aw mq bi"><span id="026c" class="le lf iq kp b gy mr ms l mt mu">/* A */ (middlewareAPI) =&gt; /* B */ (next) =&gt; /* C */ (action) =&gt; { <br/>  ....<br/>  return next(action);<br/>}</span></pre><p id="dcea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个中间件是返回另一个函数的另一个函数，以此类推……但有趣的是，当前中间件的<strong class="jp ir">函数B，接收到数组</strong>中下一个中间件的函数C的引用。这种组合使我们能够从当前的中间件调用下一个中间件，以此类推，直到我们覆盖所有的中间件。只有这样，我们才能继续对减速器进行评估。我们这里实际上是一个中间件链！</p><p id="3678" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们深入到我们实现中最有趣的部分:</p><pre class="kq kr ks kt gt mn kp mo mp aw mq bi"><span id="bbf5" class="le lf iq kp b gy mr ms l mt mu">let state = initialState;<br/>const listeners = [];</span><span id="da4e" class="le lf iq kp b gy mv ms l mt mu">let finalMiddleware = (action) =&gt; {<br/>  state = reducer(state, action);<br/>  listeners.forEach(listener =&gt; listener());<br/>  return state;<br/>}</span><span id="62d9" class="le lf iq kp b gy mv ms l mt mu">const middlewareAPI = {<br/>  getState: () =&gt; state,<br/>  dispatch: (action) =&gt; finalMiddleware(action)<br/>}</span><span id="ffd0" class="le lf iq kp b gy mv ms l mt mu">const newMiddleWares = middlewares.map(middleware =&gt; middleware(middlewareAPI));</span><span id="de62" class="le lf iq kp b gy mv ms l mt mu">for(let i = newMiddleWares.length - 1; i &gt;= 0; i--) { <br/>  finalMiddleware = newMiddleWares[i](finalMiddleware);<br/>}</span></pre><p id="ac92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意我们把<code class="fe km kn ko kp b">dispatchAction</code>改成了<code class="fe km kn ko kp b">finalMiddleware</code>。不要担心，当我们完成所有的事情时，一切都会变得有意义！</p><p id="620c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们通过调用中间件API来评估每个中间件。现在<code class="fe km kn ko kp b">newMiddleWares</code>是一个具有以下结构的函数集合:</p><pre class="kq kr ks kt gt mn kp mo mp aw mq bi"><span id="b130" class="le lf iq kp b gy mr ms l mt mu">(next) =&gt; (action) =&gt; { <br/>  ....<br/>  return next(action);<br/>}</span></pre><p id="744c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在最后一步，我们反向检查新的中间件，用之前执行的值评估每个中间件。这部分有点混乱，所以让我们从最后一个中间件开始。</p><p id="5263" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一个中间件接收<code class="fe km kn ko kp b">finalMiddleware</code>的第一个值，这个值是为了评估reducer，它返回中间件结构中的最后一个函数。<code class="fe km kn ko kp b">finalMiddleware</code>现已更新该功能。</p><p id="7c49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之前的中间件将接收该函数并返回它在结构中的最后一个函数。我们重复这个过程，直到我们到达第一个中间件。</p><p id="866a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，<code class="fe km kn ko kp b">finalMiddleware</code>将是集合中的第一个中间件，所以当我们调用<code class="fe km kn ko kp b">dispatch</code>时，它将调用第一个中间件。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mw"><img src="../Images/3c16880494c3f4249da79f92552de57e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Id_JStBQSGCLlAIzWgNhPA.png"/></div></div></figure><p id="3dce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上图中，我们可以看到每个中间件中的<code class="fe km kn ko kp b">next</code>参数是对数组中下一个中间件中获取 <code class="fe km kn ko kp b">action</code> <strong class="jp ir">的函数的<strong class="jp ir">引用。</strong></strong></p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="4b71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们回顾一下createStore的最终实现:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="kv kw l"/></div></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="05bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们可以进入API参考中的下一部分，即- <code class="fe km kn ko kp b"><a class="ae kl" href="https://redux.js.org/api/combinereducers" rel="noopener ugc nofollow" target="_blank">combineReducers</a></code>:</p><h2 id="8676" class="le lf iq bd lg lh li dn lj lk ll dp lm jy ln lo lp kc lq lr ls kg lt lu lv lw bi translated"><code class="fe km kn ko kp b">combineReducers</code>接收1个参数:</h2><ol class=""><li id="7a07" class="lx ly iq jp b jq lz ju ma jy mb kc mc kg md kk me mf mg mh bi translated">减速器(对象)</li></ol><h2 id="2b3f" class="le lf iq bd lg lh li dn lj lk ll dp lm jy ln lo lp kc lq lr ls kg lt lu lv lw bi translated"><strong class="ak"> combineReducers返回:</strong></h2><ol class=""><li id="f57c" class="lx ly iq jp b jq lz ju ma jy mb kc mc kg md kk me mf mg mh bi translated">接收状态和动作并返回状态的函数</li></ol><p id="e7bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">线框非常简单:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="kv kw l"/></div></figure><p id="3202" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe km kn ko kp b">combineReducers</code>返回的函数其实是一个<strong class="jp ir">减速器</strong>本身！减速器是做什么的？它接受一个<code class="fe km kn ko kp b">state</code>和一个<code class="fe km kn ko kp b">action</code>并返回一个新的<code class="fe km kn ko kp b">state</code>！</p><p id="b38e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们需要做的就是检查所有的减速器，用它们相应的状态来评估它们。迭代完成后，我们返回新的状态！</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="kv kw l"/></div></figure><p id="055e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意我们还没有谈到的。Redux的核心部分是结构共享，这意味着如果状态树的某个部分没有改变，我们也不会改变它的引用。让我们看一个例子:</p><pre class="kq kr ks kt gt mn kp mo mp aw mq bi"><span id="dec7" class="le lf iq kp b gy mr ms l mt mu">state<br/> |-- part-a<br/> |-- part-b<br/> |    |-- part-b-1<br/> |    |-- part-b-2<br/> |-- part-c</span></pre><p id="f8b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，如果我们在我们的状态中改变<code class="fe km kn ko kp b">part-b-1</code>，我们不希望<code class="fe km kn ko kp b">part-a</code>或<code class="fe km kn ko kp b">part-c</code>或<code class="fe km kn ko kp b">part-b-2</code>丢失它们的原始引用，因为它们没有被改变。确实需要改变的是<code class="fe km kn ko kp b">part-b-1</code> <code class="fe km kn ko kp b">part-b</code>和<code class="fe km kn ko kp b">state</code>。这就是为什么我们有<code class="fe km kn ko kp b">hasChanged</code>，如果<em class="nd">树的某些</em>部分实际上发生了变化，我们就返回新创建的状态。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="6bca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我鼓励你去尝试自己去实现！不要看实现，只要看一看API，了解它们实际上是做什么的，然后一头扎进去。你会发现这并不像你想象的那么难:</p><ol class=""><li id="4db9" class="lx ly iq jp b jq jr ju jv jy ne kc nf kg ng kk me mf mg mh bi translated"><code class="fe km kn ko kp b">createStore</code>-<a class="ae kl" href="https://redux.js.org/api/createstore" rel="noopener ugc nofollow" target="_blank">https://redux.js.org/api/createstore</a></li><li id="1839" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated"><code class="fe km kn ko kp b">combineReducers</code>-<a class="ae kl" href="https://redux.js.org/api/combinereducers" rel="noopener ugc nofollow" target="_blank">https://redux.js.org/api/combinereducers</a></li><li id="f28b" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated"><code class="fe km kn ko kp b">store</code>-<a class="ae kl" href="https://redux.js.org/api/store" rel="noopener ugc nofollow" target="_blank">https://redux.js.org/api/store</a></li></ol><p id="4eaf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为练习，看看将<code class="fe km kn ko kp b">replaceReducer</code>和<code class="fe km kn ko kp b">bindActionCreators</code>添加到您的实现中有多难！</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="a210" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样！希望你喜欢它！</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><div class="kq kr ks kt gt nh"><a href="https://gitconnected.com/learn/redux" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">学习Redux -最佳Redux教程(2019) | gitconnected</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">8大Redux教程-免费学习Redux。课程由开发人员提交并投票，使您能够…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">gitconnected.com</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv nb nh"/></div></div></a></div></div></div>    
</body>
</html>