<html>
<head>
<title>Preventing and Handling Bugs with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python预防和处理bug</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/preventing-and-handling-bugs-with-python-562c78568166?source=collection_archive---------8-----------------------#2020-05-08">https://levelup.gitconnected.com/preventing-and-handling-bugs-with-python-562c78568166?source=collection_archive---------8-----------------------#2020-05-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/c739f053499ca45528134da0fd5f538f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EFFpoAJ1ZCNRiRZ1"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@davidclode?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">大卫·克洛德</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c9cb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Python是一种方便的语言，通常用于脚本编写、数据科学和web开发。</p><p id="e42b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我们将看看如何用Python来预防和处理错误。</p><h1 id="7fa3" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">引发异常</h1><p id="4ec9" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">当我们用<code class="fe mh mi mj mk b">raise</code>关键字遇到一些意外情况时，我们可以抛出异常。</p><p id="3472" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我们可以编写以下代码来引发异常:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="383f" class="mt lf it mk b gy mu mv l mw mx">print('What is your name?')<br/>name = input()<br/>if name != 'Joe':<br/>  raise Exception('Wrong name')</span></pre><p id="2561" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的代码中，如果输入的<code class="fe mh mi mj mk b">name</code>不是<code class="fe mh mi mj mk b">'Joe'</code>，我们会引发一个异常。</p><p id="afa7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们使用了<code class="fe mh mi mj mk b">raise</code>关键字和<code class="fe mh mi mj mk b">Exception</code>构造函数。</p><p id="e41c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于我们没有捕捉到异常，如果输入除了<code class="fe mh mi mj mk b">'Joe'</code>之外的任何内容，程序都会崩溃。</p><p id="d6d4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了优雅地处理异常，我们可以将引发异常的代码包装在一个<code class="fe mh mi mj mk b">try...except</code>块中，如下所示:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="1410" class="mt lf it mk b gy mu mv l mw mx">print('What is your name?')<br/>name = input()<br/>try:<br/>  if name != 'Joe':<br/>    raise Exception('Wrong name')<br/>except Exception as err:<br/>  print(str(err))</span></pre><p id="ad25" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的代码捕捉异常并打印出来自<code class="fe mh mi mj mk b">err</code>对象的错误消息。</p><h1 id="dc11" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">获取字符串形式的回溯</h1><p id="8a83" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们可以将堆栈跟踪记录为一个字符串，它列出了在异常出现之前运行的代码，并通过使用<code class="fe mh mi mj mk b">traceback</code>库将其写入一个文件。</p><p id="46a2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为此，我们可以使用<code class="fe mh mi mj mk b">traceback</code>模块获取字符串形式的堆栈跟踪。</p><p id="17bb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在下面的示例中，我们将捕获错误，获取错误的堆栈跟踪，并将其写入文件，如下所示:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="ccdd" class="mt lf it mk b gy mu mv l mw mx">import traceback</span><span id="cb24" class="mt lf it mk b gy my mv l mw mx">print('What is your name?')<br/>name = input()<br/>try:<br/>  if name != 'Joe':<br/>    raise Exception('Wrong name')<br/>except Exception as err:<br/>  error_file = open('error_info.txt', 'w')<br/>  error_file.write(traceback.format_exc())<br/>  error_file.close()<br/>  print(str(err))</span></pre><p id="1a5d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的代码中，我们使用了<code class="fe mh mi mj mk b">traceback.format_exec()</code>函数来获取字符串形式的堆栈跟踪。</p><p id="5612" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我们就用<code class="fe mh mi mj mk b">write</code>写了。</p><h1 id="6e31" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">断言</h1><p id="2c76" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在Python中，我们可以使用断言作为健全性检查来确保我们的代码没有出错。</p><p id="3195" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以用带条件的<code class="fe mh mi mj mk b">assert</code>语句做一个断言。</p><p id="d44e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果断言失败，如果在条件后添加错误消息字符串，则引发<code class="fe mh mi mj mk b">AssertionError</code>。</p><p id="26dd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我们可以写:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="11ec" class="mt lf it mk b gy mu mv l mw mx">print('What is your name?')<br/>name = input()<br/>try:<br/>  assert name == 'Joe', 'Wrong name'<br/>except AssertionError as err:<br/>  print(str(err))</span></pre><p id="f29f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的代码中，我们有:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="4567" class="mt lf it mk b gy mu mv l mw mx">assert name == 'Joe', 'Wrong name'</span></pre><p id="b82a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">哪个检查是<code class="fe mh mi mj mk b">name</code>哪个是<code class="fe mh mi mj mk b">'Joe'</code>。否则，通过<code class="fe mh mi mj mk b">'Wrong name'</code>消息引发<code class="fe mh mi mj mk b">AssertionError</code>。</p><p id="ea56" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要消息来引发异常。</p><p id="0e2c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我们像处理其他类型的异常一样捕捉<code class="fe mh mi mj mk b">AssertionError</code>。</p><h1 id="dd00" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">记录</h1><p id="2244" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们可以用<code class="fe mh mi mj mk b">logging</code>模块使日志记录变得容易。</p><p id="22b8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要将日志添加到我们的应用程序中，我们可以用一行代码来配置日志。</p><p id="7623" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我们可以编写以下内容:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="36a5" class="mt lf it mk b gy mu mv l mw mx">import logging<br/>logging.basicConfig(level=logging.DEBUG, format=' %(asctime)s -  %(levelname)s -  %(message)s')<br/>logging.debug('Start of program')</span><span id="b8da" class="mt lf it mk b gy my mv l mw mx">print('What is your name?')<br/>name = input()<br/>try:<br/>  assert name == 'Joe', 'Wrong name'<br/>except AssertionError as err:<br/>  logging.debug(str(err))</span></pre><p id="46bf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的代码导入了<code class="fe mh mi mj mk b">logging</code>模块，为日志记录设置配置。</p><p id="5045" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我们调用<code class="fe mh mi mj mk b">logging.debug</code>来记录应用程序的调试信息。</p><p id="9295" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我们在程序启动时添加一个，在程序崩溃时添加另一个。</p><p id="6904" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">格式字符串<code class="fe mh mi mj mk b">%(asctime)s</code>是事情发生的时间，<code class="fe mh mi mj mk b">%(levelname)s</code>是调试级别名称，<code class="fe mh mi mj mk b">%(message)s</code>是消息。</p><p id="95b2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其他格式字符串包括:</p><ul class=""><li id="2720" class="mz na it ki b kj kk kn ko kr nb kv nc kz nd ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(created)f</code> —创建日志记录的时间</li><li id="5bcb" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(filename)s</code> —代码的文件名</li><li id="853d" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(funcName)s</code> —正在运行的功能</li><li id="e783" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(levelno)s</code> —记录级别</li><li id="cca5" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(lineno)d</code> —行号</li><li id="d6d7" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(module)s</code> —模块名称</li><li id="8d70" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(msecs)d</code> —创建日志记录时的毫秒部分</li><li id="9113" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(pathname)s</code> —正在运行的文件的路径</li><li id="8714" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(process)d</code> —进程ID</li><li id="ca36" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(processName)s</code> —流程名称</li><li id="d644" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(relativeCreated)d</code> —创建日志记录的时间，以毫秒为单位</li><li id="613e" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(thread)d</code> —螺纹ID</li><li id="1635" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated"><code class="fe mh mi mj mk b">%(threadName)s</code> —线程名称</li></ul><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nn"><img src="../Images/6ebf8bc45414973dca714eee6b91b3aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sswl0YZYBNbzbNU5"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@honeyfangs?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">蜜牙</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="1b7f" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">日志记录级别</h1><p id="c48c" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">以下是可能的日志记录级别:</p><ul class=""><li id="2c02" class="mz na it ki b kj kk kn ko kr nb kv nc kz nd ld ne nf ng nh bi translated">调试—最低级别。用于小细节，用<code class="fe mh mi mj mk b">logging.debug()</code>记录</li><li id="32a4" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">信息—记录一般事件的信息，用<code class="fe mh mi mj mk b">logging.info()</code>记录</li><li id="673c" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">警告—指出潜在的问题，用<code class="fe mh mi mj mk b">logging.warning()</code>记录</li><li id="8690" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">错误—记录错误，用<code class="fe mh mi mj mk b">logging.error()</code>记录</li><li id="4819" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">CRITICAL —日志记录的最高级别，用于指示致命错误，用<code class="fe mh mi mj mk b">logging.critical()</code>记录</li></ul><h1 id="b941" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">禁用日志记录</h1><p id="4712" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们可以通过调用<code class="fe mh mi mj mk b">logging.disable</code>来禁用日志记录，并将日志记录的级别作为参数传入。</p><p id="8e37" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，如果我们有:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="f913" class="mt lf it mk b gy mu mv l mw mx">import logging<br/>logging.basicConfig(level=logging.DEBUG, format=' %(asctime)s -  %(levelname)s -  %(message)s')<br/>logging.debug('Start of program')<br/>print('What is your name?')<br/>name = input()<br/>try:<br/>  assert name == 'Joe', 'Wrong name'<br/>except AssertionError as err:<br/>  logging.debug(str(err))<br/>  logging.disable(logging.CRITICAL)<br/>  logging.critical('Critical error')</span></pre><p id="864e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们将不会在屏幕上看到<code class="fe mh mi mj mk b">Critical error</code>，因为我们禁用了临界日志记录级别。</p><h1 id="878f" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">记录到文件</h1><p id="c241" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们可以传入一个<code class="fe mh mi mj mk b">filename</code>参数来将我们的错误记录到一个文件中。例如，我们可以写:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="4864" class="mt lf it mk b gy mu mv l mw mx">import logging<br/>logging.basicConfig(filename='log.txt', level=logging.DEBUG, format=' %(asctime)s -  %(levelname)s -  %(message)s')<br/>logging.debug('Start of program')<br/>print('What is your name?')<br/>name = input()<br/>try:<br/>  assert name == 'Joe', 'Wrong name'<br/>except AssertionError as err:<br/>  logging.debug(str(err))</span></pre><p id="56f5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的代码中，我们将消息记录到<code class="fe mh mi mj mk b">log.txt</code>中，而不是在屏幕上。这更有帮助，因为我们可以稍后再看，而且消息不会塞满屏幕。</p><h1 id="e88e" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="eba2" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">当遇到意想不到的事情时，我们可以抛出异常。然后我们可以用<code class="fe mh mi mj mk b">try...except</code>滑车抓住它们。</p><p id="289f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，我们可以使用带有错误消息的<code class="fe mh mi mj mk b">assert</code>语句来检查预期的条件，如果遇到不期望的情况，就引发<code class="fe mh mi mj mk b">AssertionError</code>。</p><p id="9df2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们可以用<code class="fe mh mi mj mk b">logging</code>和<code class="fe mh mi mj mk b">traceback</code>模块记录事情，帮助我们调试错误。</p></div></div>    
</body>
</html>