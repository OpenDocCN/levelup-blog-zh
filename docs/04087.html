<html>
<head>
<title>How to download dynamic feature modules</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何下载动态功能模块</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-download-dynamic-feature-modules-a6f6036e183b?source=collection_archive---------30-----------------------#2020-06-08">https://levelup.gitconnected.com/how-to-download-dynamic-feature-modules-a6f6036e183b?source=collection_archive---------30-----------------------#2020-06-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f7fd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何在下载模块时显示自定义加载屏幕</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/63f452b9b119b12bb8ab02d4e1796adc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rD_O9Ru8WJJMm1TeIy-6lw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">截图来自Google IO 2018</figcaption></figure><h2 id="3c3f" class="ky kz it bd la lb lc dn ld le lf dp lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">从文章中删去</h2><p id="2ae4" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated">下载动态特征模块最简单的方法是通过动态导航器；简单有效。但是有一个问题—您不能显示自定义加载，因为它在导航组件的控制之下。</p><p id="93a9" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">还有另一种下载动态特性模块的方法——使用<code class="fe ms mt mu mv b">SplitInstallManager</code>监听器。通过这个监听器，我们可以在下载时显示我们的自定义加载。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="4c27" class="nd kz it bd la ne nf ng ld nh ni nj lg jz nk ka lk kc nl kd lo kf nm kg ls nn bi translated">介绍</h1><p id="3592" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated"><code class="fe ms mt mu mv b">SplitInstallStateUpdatedListener</code>用于下载点播模块；使用这个侦听器的好处是，我们可以在状态改变时得到回调，比如开始下载时、下载完成后，或者在某些情况下下载失败时。</p><p id="6377" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">现在，让我们来看看<code class="fe ms mt mu mv b">SplitInstallStateUpdatedListener</code>的一些回调状态，它们起着至关重要的作用，例如:</p><ul class=""><li id="928b" class="no np it lw b lx mn ma mo lh nq ll nr lp ns mm nt nu nv nw bi translated"><code class="fe ms mt mu mv b">DOWNLOADING</code> -点播模块当前正在下载。</li><li id="02fd" class="no np it lw b lx nx ma ny lh nz ll oa lp ob mm nt nu nv nw bi translated"><code class="fe ms mt mu mv b">REQUIRES_USER_CONFIRMATION</code> -当试图下载非常大的模块时，可能会出现这种情况。</li><li id="77a2" class="no np it lw b lx nx ma ny lh nz ll oa lp ob mm nt nu nv nw bi translated"><code class="fe ms mt mu mv b">INSTALLED</code> -请求的点播模块已经安装。</li><li id="3d1c" class="no np it lw b lx nx ma ny lh nz ll oa lp ob mm nt nu nv nw bi translated"><code class="fe ms mt mu mv b">INSTALLING</code> -按需模块已下载，正在安装</li><li id="6602" class="no np it lw b lx nx ma ny lh nz ll oa lp ob mm nt nu nv nw bi translated"><code class="fe ms mt mu mv b">FAILED</code> -下载或安装点播模块失败</li></ul><p id="a570" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">拆分安装侦听器可以同时下载多个模块，因此开发人员有责任检查哪个模块下载完成或失败，并采取适当的措施。</p><p id="190d" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">通过它们的名字来玩核心库解析模块，所以确保没有错别字是至关重要的。按照我的建议，在创建模块时，首先要保持名称简单，这样就不会有问题。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="c8c3" class="nd kz it bd la ne nf ng ld nh ni nj lg jz nk ka lk kc nl kd lo kf nm kg ls nn bi translated">检查模块安装状态</h1><p id="e23f" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated">在请求下载之前，我们需要确保所需的模块尚未安装。为此，我们需要创建一个<code class="fe ms mt mu mv b">SplitInstallManager</code>的实例，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="f307" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">然后使用<code class="fe ms mt mu mv b">SplitInstallManager </code>实例，我们可以调用<code class="fe ms mt mu mv b">installedModules </code>函数，该函数返回所有已安装的模块名称。如果所需的模块在列表中，那么我们可以继续我们的功能，而不是下载它。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="480b" class="nd kz it bd la ne nf ng ld nh ni nj lg jz nk ka lk kc nl kd lo kf nm kg ls nn bi translated">监听状态变化</h1><p id="c0df" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated">现在，如果我们在已安装的模块列表中没有找到该模块，那么我们需要立即下载它。在此之前，我们需要创建一个监听器来处理状态的变化。看一看:</p><pre class="kj kk kl km gt oe mv of og aw oh bi"><span id="8d10" class="ky kz it mv b gy oi oj l ok ol"><strong class="mv iu">private val </strong>listener2 = <br/>    <strong class="mv iu">SplitInstallStateUpdatedListener { </strong>state <strong class="mv iu">-&gt;<br/>        <br/>    }</strong></span></pre><p id="7b72" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">现在我们有了一个侦听器，是时候将它与您的UI组件绑定在一起了，这样您将只在生命周期有效时接收更新。因此，我们将在<code class="fe ms mt mu mv b">onResume </code>中注册监听器，并在<code class="fe ms mt mu mv b">onPause </code>中取消注册，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="264d" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">既然我们已经注册了侦听器，那么是时候处理状态更改了。正如我已经提到的，任何时候都可以下载多个模块。因此，在处理状态之前，我们需要确定我们是在处理单次下载还是多次下载，如下所示:</p><pre class="kj kk kl km gt oe mv of og aw oh bi"><span id="76da" class="ky kz it mv b gy oi oj l ok ol"><strong class="mv iu">private val </strong>listener2 =<br/>    <strong class="mv iu">SplitInstallStateUpdatedListener { </strong>state <strong class="mv iu">-&gt;<br/>        </strong>val <strong class="mv iu">multiInstall </strong>= state.moduleNames().size &gt; 1<br/>    <strong class="mv iu">}</strong></span></pre><p id="3730" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">一旦我们知道我们正在处理的是什么，就该适当地处理状态变化了，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="91d5" class="nd kz it bd la ne nf ng ld nh ni nj lg jz nk ka lk kc nl kd lo kf nm kg ls nn bi translated">开始下载</h1><p id="d426" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated">到目前为止，我们验证了是否下载了所需的模块，并启动了一个监听器来观察下载模块时的状态变化。现在我们已经插入了bullet，是时候扣动扳机了——开始下载。</p><p id="5b41" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">首先，我们需要创建一个<code class="fe ms mt mu mv b">SplitInstallRequest </code>，并添加所有需要通过<code class="fe ms mt mu mv b">addModule</code>功能下载的模块，如下图所示:</p><pre class="kj kk kl km gt oe mv of og aw oh bi"><span id="87ba" class="ky kz it mv b gy oi oj l ok ol">val request = <strong class="mv iu">SplitInstallRequest</strong>.newBuilder()<br/>            .<strong class="mv iu">addModule</strong>(name)<br/>            .build()</span></pre><p id="2e8d" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">现在我们需要通过将<code class="fe ms mt mu mv b"><strong class="lw iu">SplitInstallRequest </strong></code>作为参数传递来调用<code class="fe ms mt mu mv b">SplitInstallManager </code>实例上的<code class="fe ms mt mu mv b">startInstall </code>，如下所示:</p><pre class="kj kk kl km gt oe mv of og aw oh bi"><span id="bf73" class="ky kz it mv b gy oi oj l ok ol">manager.<strong class="mv iu">startInstall</strong>(request)</span></pre><p id="219b" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">现在，我们可以用之前附加的监听器观察下载中的变化。这就是你已经成功实现的自定义模块下载。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="81b9" class="nd kz it bd la ne nf ng ld nh ni nj lg jz nk ka lk kc nl kd lo kf nm kg ls nn bi translated">奖金</h1><p id="4d7a" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated">要了解更多关于动态交付和模块化编程的知识，请参考本系列以前的文章:</p><ul class=""><li id="80b1" class="no np it lw b lx mn ma mo lh nq ll nr lp ns mm nt nu nv nw bi translated"><a class="ae om" href="https://medium.com/android-dev-hacks/dynamic-delivery-in-android-part-1-634c686d7170" rel="noopener">“Android中的动态交付—第一部分”</a></li><li id="b3fb" class="no np it lw b lx nx ma ny lh nz ll oa lp ob mm nt nu nv nw bi translated"><a class="ae om" href="https://medium.com/android-dev-hacks/dynamic-delivery-in-android-part-2-b3999513bfc0" rel="noopener">“Android中的动态交付—第二部分”</a></li><li id="cde1" class="no np it lw b lx nx ma ny lh nz ll oa lp ob mm nt nu nv nw bi translated"><a class="ae om" href="https://medium.com/android-dev-hacks/dynamic-delivery-in-android-part-3-3e1201c4955b" rel="noopener">“Android中的动态交付—第三部分”</a></li></ul></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><p id="5b46" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">希望你学到有用的东西，感谢阅读。</p><p id="6096" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">你可以在<a class="ae om" href="https://medium.com/@sgkantamani" rel="noopener"> Medium </a>、<a class="ae om" href="https://twitter.com/SG5202" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae om" href="https://www.quora.com/profile/Siva-Ganesh-Kantamani-1" rel="noopener ugc nofollow" target="_blank"> Quora </a>和<a class="ae om" href="https://www.linkedin.com/in/siva-kantamani-bb59309b/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上找到我。</p></div></div>    
</body>
</html>