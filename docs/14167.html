<html>
<head>
<title>Metro Bundler : Under the hood</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">麦德龙·邦德勒:引擎盖下</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/metro-bundler-under-the-hood-ffa254b5ca9c?source=collection_archive---------17-----------------------#2022-11-06">https://levelup.gitconnected.com/metro-bundler-under-the-hood-ffa254b5ca9c?source=collection_archive---------17-----------------------#2022-11-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bfb5f1aa9ba0b6ab8c395b9e4e90d9ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G0llPjoGAP-GEOPxIon9iQ.png"/></div></div></figure><p id="51ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们先来试着了解一下什么是<strong class="ka ir">捆绑</strong>。</p><p id="090c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">捆绑是<strong class="ka ir">跟随导入的文件并将它们合并成一个文件</strong>:一个“捆绑包”的过程。这个包可以用来一次加载整个应用程序。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi kw"><img src="../Images/dcef641e69291bfee044c9dae02e638f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bCzRmK_XvTdXLxfmSuhSRA.png"/></div></div></figure><p id="fe55" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在来看看我们如何使用Metro为我们所有的<strong class="ka ir"> react-native </strong>应用生成一个包？</p><p id="df01" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Metro是一个JavaScript bundler。它接受一个入口文件和各种选项，并返回一个包含所有代码及其依赖项的JavaScript文件。</p><p id="b0d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">捆绑流程主要包括两个阶段:</p><h1 id="859e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">构建依赖图— </strong></h1><p id="20e1" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">构建依赖关系图时执行的主要任务有:</p><ol class=""><li id="1831" class="me mf iq ka b kb kc kf kg kj mg kn mh kr mi kv mj mk ml mm bi translated"><strong class="ka ir">转换模块</strong>:这一步负责<a class="ae mn" href="https://byby.dev/js-transpilers" rel="noopener ugc nofollow" target="_blank">将JS </a>转换成另一种形式，以便任何javascript虚拟机都能轻松理解，Metro使用babel来完成这一转换过程。</li><li id="640c" class="me mf iq ka b kb mo kf mp kj mq kn mr kr ms kv mj mk ml mm bi translated"><strong class="ka ir">收集依赖关系</strong>:在这一步中，Metro试图通过查看不同模块使用的所需导入来识别模块依赖关系，并帮助构建图。metro包含了捆绑包中需要的所有模块。</li><li id="a238" class="me mf iq ka b kb mo kf mp kj mq kn mr kr ms kv mj mk ml mm bi translated"><strong class="ka ir">解析依赖关系</strong>:在这一步中，Metro试图解析前面步骤中收集的所有依赖关系(因为模块中的require语句只是指向node_modules中的相对路径或文件)。你可以在这里了解更多信息<a class="ae mn" href="https://facebook.github.io/metro/docs/resolution" rel="noopener ugc nofollow" target="_blank">。</a></li></ol><p id="fa7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">文件的转换是一项缓慢的任务，因为它涉及到从Javascript构建一个AST(抽象语法树),并对其进行转换，然后从这些AST生成JS和sourcemaps。</p><p id="e365" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，为了快速完成这一过程，Metro采用了多种策略:</p><ul class=""><li id="dc04" class="me mf iq ka b kb kc kf kg kj mg kn mh kr mi kv mt mk ml mm bi translated"><strong class="ka ir">缓存系统</strong> —这用于尽可能避免转换文件，metro可以形成多个缓存并遍历它们以避免转换。你可以在这里了解更多。</li><li id="f471" class="me mf iq ka b kb mo kf mp kj mq kn mr kr ms kv mt mk ml mm bi translated"><strong class="ka ir">并行化</strong> —用于并行化CPU之间的文件转换，以提高序列化过程的速度。Metro使用包<a class="ae mn" href="https://www.npmjs.com/package/jest-worker" rel="noopener ugc nofollow" target="_blank"> jest-worker </a>来做这件事。你可以在这里了解更多。</li><li id="0aab" class="me mf iq ka b kb mo kf mp kj mq kn mr kr ms kv mt mk ml mm bi translated"><strong class="ka ir"> Delta Bundler </strong> —用于避免每次重新加载时重新生成依赖关系图，并且仅将更改/差异发送到设备。你可以在这里了解更多<a class="ae mn" href="https://youtu.be/tX2lg59Wm7g?t=849" rel="noopener ugc nofollow" target="_blank"/></li></ul><h1 id="6870" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">图形系列化— </strong></h1><p id="92e1" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">一旦从上面的步骤中生成了图形，这个过程就会发生。Metro有许多序列化器，可以执行不同的任务，例如可以用来创建包、sourcemaps*以及将资产存储到磁盘。</p><p id="6aff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一些串行化器就是<strong class="ka ir">普通JS包</strong>和<strong class="ka ir">索引RAM包</strong>串行化器。</p><p id="f685" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在普通JS包的情况下，包是通过简单地遍历依赖图并连接模块来创建的。在这种情况下，运行时和启动代码在启动时与模块一起传递给JS虚拟机。</p><p id="1f6b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在RAM包的情况下，所创建的包是二进制格式的，在这种情况下，只有运行时和启动代码在启动期间被注入到JS虚拟机中，并且模块被延迟加载，这就是它比普通JS包更快的原因。此外，您可以在这里阅读更多关于这个包如何以这种格式<a class="ae mn" href="https://facebook.github.io/metro/docs/bundling#file-ram-bundle" rel="noopener ugc nofollow" target="_blank">存储的信息。</a></p><h1 id="4506" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">为捆绑服务—</h1><p id="f315" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">metro在运行时通过http请求向应用程序提供捆绑包，应用程序自动运行捆绑包中的javascript。Metro运行https服务器，默认监听端口8081(这可以通过<a class="ae mn" href="https://reactnative.dev/docs/troubleshooting" rel="noopener ugc nofollow" target="_blank">配置</a>)</p><p id="84d0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当客户机在这种模式下需要一个包时，它会发出一个带有“包URL”的http请求，这只是一个带有查询参数的http请求。典型的捆绑包URL如下所示:</p><pre class="kx ky kz la gt mu mv mw mx aw my bi"><span id="0376" class="mz lc iq mv b gy na nb l nc nd"><a class="ae mn" href="http://localhost:8081/index.bundle?platform=windows&amp;dev=true&amp;hot=false&amp;inlineSourceMap=true" rel="noopener ugc nofollow" target="_blank">http://localhost:8081/index.bundle?<br/>platform=android&amp; <br/>dev=true&amp;<br/>hot=false&amp;<br/>inlineSourceMap=true</a>&amp;<br/>minify=true</span></pre><p id="dedf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些参数的含义如下:</p><ul class=""><li id="5c06" class="me mf iq ka b kb kc kf kg kj mg kn mh kr mi kv mt mk ml mm bi translated"><strong class="ka ir">平台</strong>:需要一个字符串，为其构建一个包的原生平台(例如:android /ios/ windows)</li><li id="0032" class="me mf iq ka b kb mo kf mp kj mq kn mr kr ms kv mt mk ml mm bi translated"><strong class="ka ir"> dev </strong>:可选布尔型字段，表示是否必须在开发模式(__DEV__)下构建bundle，默认值为false</li><li id="86cf" class="me mf iq ka b kb mo kf mp kj mq kn mr kr ms kv mt mk ml mm bi translated"><strong class="ka ir">热</strong>:如果为真，则开启热重装</li><li id="4d86" class="me mf iq ka b kb mo kf mp kj mq kn mr kr ms kv mt mk ml mm bi translated"><strong class="ka ir"> inlineSourceMap </strong>:它采用一个布尔值，并暗示SourceMap是否与bundle一起提供。默认值为false</li><li id="8104" class="me mf iq ka b kb mo kf mp kj mq kn mr kr ms kv mt mk ml mm bi translated"><strong class="ka ir"> minify </strong>:取一个布尔值，暗示代码是否应该缩小。</li><li id="b0d4" class="me mf iq ka b kb mo kf mp kj mq kn mr kr ms kv mt mk ml mm bi translated"><strong class="ka ir"> sourceMapUrl: </strong>它接受一个字符串，并提到可以找到sourcemap*的Url。(如果inlineSourceMap为true，则忽略此操作)</li></ul><p id="5830" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ne">*什么是</em><strong class="ka ir"><em class="ne">source map</em></strong><em class="ne">？</em></p><p id="53c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ne">A</em><strong class="ka ir"><em class="ne">source map</em></strong><em class="ne">是生成/编译/缩小的JavaScript文件与一个或多个原始源文件之间的映射。sourcemaps的主要目的是帮助调试。基本上，如果生成的代码文件中有错误，映射可以告诉您原始源文件的位置。</em></p><p id="4e31" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在这里阅读更多关于如何配置metro <a class="ae mn" href="https://facebook.github.io/metro/docs/configuration" rel="noopener ugc nofollow" target="_blank">的内容。</a></p><h1 id="95ea" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">参考文献:</strong></h1><ul class=""><li id="982b" class="me mf iq ka b kb lz kf ma kj nf kn ng kr nh kv mt mk ml mm bi translated"><a class="ae mn" href="https://facebook.github.io/metro/" rel="noopener ugc nofollow" target="_blank">地铁文件</a></li><li id="1176" class="me mf iq ka b kb mo kf mp kj mq kn mr kr ms kv mt mk ml mm bi translated"><a class="ae mn" href="https://github.com/microsoft/react-native-windows/wiki/Metro-Guide" rel="noopener ugc nofollow" target="_blank">Metro Guide</a>by react native windows</li><li id="b738" class="me mf iq ka b kb mo kf mp kj mq kn mr kr ms kv mt mk ml mm bi translated"><a class="ae mn" href="https://www.youtube.com/watch?v=tX2lg59Wm7g" rel="noopener ugc nofollow" target="_blank"> Rafael de Oleza —为React Native构建JavaScript包</a></li></ul><h1 id="bebc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">结论</strong></h1><p id="6576" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">本文主要总结metro bundler的内部工作方式，以及在react native应用程序中生成bundle所涉及的步骤。</p></div></div>    
</body>
</html>