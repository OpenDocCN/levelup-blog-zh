<html>
<head>
<title>Serverless Lambda storage options 🚀</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器Lambda存储选项🚀</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/serverless-lambda-storage-options-6c483d1fa990?source=collection_archive---------2-----------------------#2021-08-02">https://levelup.gitconnected.com/serverless-lambda-storage-options-6c483d1fa990?source=collection_archive---------2-----------------------#2021-08-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/cfe8a747b36ca7d284f1ef961a1f41c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5KYTvH4oNjB8h89f3laQAQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">弗拉德·戈尔什科夫在<a class="ae jd" href="https://unsplash.com/s/photos/fortnite?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><div class=""><h2 id="37ec" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">使用Lambda临时临时存储的实际示例，S3和EFS作为比较，利用无服务器框架和TypeScript，以及支持代码示例</h2></div><h1 id="3988" class="kv kw jg bd kx ky kz la lb lc ld le lf km lg kn lh kp li kq lj ks lk kt ll lm bi translated">介绍</h1><blockquote class="ln lo lp"><p id="1a90" class="lq lr ls lt b lu lv kh lw lx ly kk lz ma mb mc md me mf mg mh mi mj mk ml mm ij bi translated">当使用AWS Lambda时，在处理文件时有多种存储选项可用，但是在哪种情况下应该使用每一种呢？</p></blockquote><p id="d145" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">这篇博文涵盖了三个选项，并附有代码示例；以及关于何时使用每种方法、优缺点和相对速度的讨论:</p><p id="ec85" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">✔️AWS S3<br/>✔️AWS EFS<br/>✔️lambda短暂存储(<em class="ls"> tmp </em>)</p><p id="338d" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">Lambda层还有第四个选项，我不会在这里介绍，因为在这种情况下文件总是静态的，但会在下面的博客文章中介绍:</p><div class="ip iq gp gr ir mq"><a rel="noopener  ugc nofollow" target="_blank" href="/serverless-lambda-layers-d8f8374404e3"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd jh gy z fp mv fr fs mw fu fw jf bi translated">无服务器Lambda层🚀</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">在Lambda中使用无头浏览器使用AWS Lambda层生成屏幕截图的实际示例</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne ix mq"/></div></div></a></div><h2 id="8d2b" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">我们在建造什么？</h2><p id="7299" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">我们将构建一个解决方案，该解决方案包含一个API，该API有三个端点，通过Lambda与每种存储类型进行交互，出于好玩，我们正在处理堡垒之夜角色的图像😜</p><p id="3393" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">下面的步骤和图表显示了我们正在构建的内容(这里有<a class="ae jd" href="https://github.com/leegilmorecode/serverless-lambda-storage" rel="noopener ugc nofollow" target="_blank">代码回购</a>):</p><figure class="nx ny nz oa gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nw"><img src="../Images/71008d0fa64f3a1d861989d779a68ae2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kz6oE6ncbAUfM1FMMPCgqA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">博客文章的基本架构示例</figcaption></figure><ol class=""><li id="cadb" class="ob oc jg lt b lu lv lx ly mn od mo oe mp of mm og oh oi oj bi translated">在使用无服务器框架进行部署时，我们将四个<a class="ae jd" href="https://www.epicgames.com/fortnite/en-US/home" rel="noopener ugc nofollow" target="_blank">堡垒之夜</a>角色图像推送到一个S3桶中(<em class="ls">1.jpeg、2.jpeg、3.jpeg&amp;4.jpeg</em>)(<strong class="lt jh">设置</strong>)。</li><li id="a93a" class="ob oc jg lt b lu ok lx ol mn om mo on mp oo mm og oh oi oj bi translated">在成功部署时，我们还使用'<a class="ae jd" href="https://www.npmjs.com/package/serverless-plugin-scripts" rel="noopener ugc nofollow" target="_blank">挂钩</a>来调用一个<a class="ae jd" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank">λ</a>，它将相同的映像推送到<a class="ae jd" href="https://aws.amazon.com/efs/" rel="noopener ugc nofollow" target="_blank"> EFS </a> ( <strong class="lt jh">设置</strong>)。</li><li id="3356" class="ob oc jg lt b lu ok lx ol mn om mo on mp oo mm og oh oi oj bi translated">用户可以调用每种存储类型的三个端点中的任何一个。</li><li id="3868" class="ob oc jg lt b lu ok lx ol mn om mo on mp oo mm og oh oi oj bi translated">基于EFS的Lambda通过<a class="ae jd" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank"> API网关</a>调用，并从EFS ( <strong class="lt jh"> EFS </strong>)返回文件。</li><li id="cb77" class="ob oc jg lt b lu ok lx ol mn om mo on mp oo mm og oh oi oj bi translated">基于<a class="ae jd" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> S3 </a>的Lambda通过API网关调用，并从S3 ( <strong class="lt jh"> S3 </strong>)返回文件。</li><li id="7c01" class="ob oc jg lt b lu ok lx ol mn om mo on mp oo mm og oh oi oj bi translated">基于tmp的Lambda检查文件是否已经驻留在Lambda容器本身的<code class="fe op oq or os b">/tmp</code>文件夹中，如果不是，它缓存来自S3的相同文件。在通过API Gateway的后续调用中，这些文件已经在tmp中，可以从lambda ( <strong class="lt jh"> TMP </strong>)中提供服务。</li><li id="6964" class="ob oc jg lt b lu ok lx ol mn om mo on mp oo mm og oh oi oj bi translated">所有文件都以base64格式返回。(<em class="ls">下面的网站非常适合查看base64字符串图像:</em><a class="ae jd" href="https://codebeautify.org/base64-to-image-converter" rel="noopener ugc nofollow" target="_blank"><em class="ls">https://codebeautify.org/base64-to-image-converter</em></a>)</li></ol><p id="c08d" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">以下示例图片仅供参考:</p><figure class="nx ny nz oa gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ot"><img src="../Images/2b28c78b1fb5773857d8acfb669ccd75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eEfIJl3i4sopyUxSBFDLYA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">以上图片的版权归https://www.epicgames.com/fortnite/的堡垒之夜所有</figcaption></figure><blockquote class="ln lo lp"><p id="029e" class="lq lr ls lt b lu lv kh lw lx ly kk lz ma mb mc md me mf mg mh mi mj mk ml mm ij bi translated"><em class="jg">💡</em> <em class="jg">注意:这是演示三个存储选项使用的最少代码和架构，因此这不是生产就绪代码，也不符合所有编码和架构最佳实践</em></p></blockquote></div><div class="ab cl ou ov hu ow" role="separator"><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz"/></div><div class="ij ik il im in"><h1 id="39b8" class="kv kw jg bd kx ky pb la lb lc pc le lf km pd kn lh kp pe kq lj ks pf kt ll lm bi translated">那么有哪些不同的存储选项呢？</h1><p id="55cc" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">我们将讨论的三个选项详述如下:</p><h2 id="edda" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">AWS S3</h2><p id="8ffa" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">AWS S3是用于对象存储的无服务器选项，可根据您的项目需求无限扩展，具有11个9的耐用性，允许静态和传输时的各种加密选项，并且非常经济高效。在无服务器的世界里，这是存储和检索文件的一个极好的选择，尤其是有各种各样的存储类可用的情况下。</p><p id="23f7" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">下图显示了一些使用案例，包括构建数据湖、托管前端web应用程序、备份和检索、存储日志等:</p><figure class="nx ny nz oa gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pg"><img src="../Images/41eb4dc598a902b233f24b7fb16c0d8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pqpOf2NnFpiRoVYX.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">【https://aws.amazon.com/s3/】</figcaption></figure><h2 id="4052" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">AWS EFS</h2><p id="9c6f" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">亚马逊弹性文件系统(AWS EFS)提供了一个简单的弹性文件系统，让您无需配置或管理存储即可共享文件数据。它可以与AWS云服务和内部资源一起使用，并且可以按需扩展到Pb级，而不会中断应用程序。</p><p id="77bc" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">带有Lambda的EFS是另一个很棒的无服务器产品，它具有成本效益，具有各种<a class="ae jd" href="https://docs.aws.amazon.com/efs/latest/ug/storage-classes.html" rel="noopener ugc nofollow" target="_blank">存储类</a>(S3也是<em class="ls">)，自动扩展到您的应用程序需求，并且是另一个使用Lambda的持久文件存储的好方法:</em></p><figure class="nx ny nz oa gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ph"><img src="../Images/25c25dbda2bbf81ff31b5aa1fc2e347a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wp_igS6FaLt91LI2.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated"><a class="ae jd" href="https://aws.amazon.com/efs/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/efs/</a></figcaption></figure><h2 id="af0e" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">自动气象站λ(tmp)</h2><p id="bf05" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">第三个选项是利用第一次调用Lambda时在Lambda容器中创建的<code class="fe op oq or os b">/tmp</code>文件夹。这允许您直接在这个文件夹中读写文件，这个文件夹在特定的Lambda容器本身的生命周期中都存在。这意味着你不能保证文件总是在你的代码中。</p><p id="8545" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">当水平伸缩时，如果持久化的文件不需要在同一个Lambda的不同调用之间共享，这是一个很好的选择，但是这种方法有一些限制，本文将进一步讨论。</p></div><div class="ab cl ou ov hu ow" role="separator"><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz"/></div><div class="ij ik il im in"><h1 id="91e9" class="kv kw jg bd kx ky pb la lb lc pc le lf km pd kn lh kp pe kq lj ks pf kt ll lm bi translated">入门！</h1><blockquote class="ln lo lp"><p id="d2d2" class="lq lr ls lt b lu lv kh lw lx ly kk lz ma mb mc md me mf mg mh mi mj mk ml mm ij bi translated"><em class="jg"> 🛑 </em> <strong class="lt jh"> <em class="jg">注意</em> </strong> <em class="jg">:运行以下命令将在您的AWS帐户上产生费用，因此相应地更改配置。</em></p></blockquote><h2 id="a920" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">部署解决方案</h2><p id="cc98" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">在文件夹的根目录下运行<code class="fe op oq or os b">npm i</code>，然后运行<code class="fe op oq or os b">npm run deploy:develop</code>，这将安装所有的依赖项，然后部署到AWS。</p><p id="fa36" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">这将使用<a class="ae jd" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>为您生成资源，即API、计算层和存储资源。成功部署后，您将看到与以下内容类似的输出:</p><figure class="nx ny nz oa gt is gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/955b1940a57dec72aaa8da5ecee8ce25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*R_UFaesxsWGs16tCjTg1yQ.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">sls deploy的输出示例</figcaption></figure><h2 id="cf6e" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">部署时用映像自动填充S3和EFS</h2><p id="4eca" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">在部署资源的过程中，我们使用无服务器插件<code class="fe op oq or os b"><a class="ae jd" href="https://www.npmjs.com/package/serverless-s3-sync" rel="noopener ugc nofollow" target="_blank">serverless-s3-sync</a></code>，它获取<code class="fe op oq or os b">./assets</code>文件夹中的四个映像，并使用<code class="fe op oq or os b">serverless.yml</code>中的以下配置自动将它们推送到S3存储桶，这确保了当我们到达端点时，我们在成功部署后立即取回文件:</p><pre class="nx ny nz oa gt pj os pk pl aw pm bi"><span id="96d0" class="nf kw jg os b gy pn po l pp pq">s3Sync:<br/>   - bucketName: ${self:custom.bucketName}<br/>     localDir: ./assets/</span></pre><p id="bdc4" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">现在我们已经将图像部署到了一个S3桶中，在<code class="fe op oq or os b">sls deploy</code>结束时，我们自动运行一个Lambda，它从S3桶中提取图像，并将它们推送到EFS文件共享。这是使用无服务器插件<code class="fe op oq or os b"><a class="ae jd" href="https://www.npmjs.com/package/serverless-plugin-scripts" rel="noopener ugc nofollow" target="_blank">serverless-plugin-scripts</a></code>和下面的<code class="fe op oq or os b">serverless.yml</code>中的配置完成的(<em class="ls">再次确保我们直接从EFS端点获取文件</em>):</p><pre class="nx ny nz oa gt pj os pk pl aw pm bi"><span id="d188" class="nf kw jg os b gy pn po l pp pq">scripts:<br/>   hooks:<br/>      'deploy:finalize': sls invoke -f populate-efs</span></pre><figure class="nx ny nz oa gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pr"><img src="../Images/5988750d66d178202c2dd94388fa76cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JVRGp49rNKHo1BpSpGscGA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用无服务器部署将资产部署到EFS和S3的示例</figcaption></figure><p id="15d3" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">这就调用了<code class="fe op oq or os b">populate-efs</code> Lambda，它从S3获取图像，如果它们不在EFS，就把它们写到那里。<strong class="lt jh">现在，作为部署的一部分，我们已经在EFS和S3部署了完整的映像！</strong>😜</p><h2 id="1234" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">从tmp中提取图像</h2><p id="fe1d" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">我们将讨论的第一个lambda是从Lambda本身的<code class="fe op oq or os b">/tmp</code>文件夹中提取图像。显然，作为部署的一部分，我们只将映像推送到S3和EFS，而Lambda是短暂的(<em class="ls">寿命很短，只在需要时创建</em>，<strong class="lt jh">)，那么我们如何将映像放入tmp文件夹</strong>？</p><blockquote class="ln lo lp"><p id="0988" class="lq lr ls lt b lu lv kh lw lx ly kk lz ma mb mc md me mf mg mh mi mj mk ml mm ij bi translated"><strong class="lt jh">"</strong>Lambda执行环境提供了一个文件系统，供你的代码在/tmp下使用。该空间的固定大小为512 MB。多个Lambda调用可以重用同一个Lambda执行环境来优化性能。/tmp区域在执行环境的生命周期内被保留，并为调用之间的数据提供临时缓存。每次创建新的执行环境时，都会删除这个区域。</p><p id="48b3" class="lq lr ls lt b lu lv kh lw lx ly kk lz ma mb mc md me mf mg mh mi mj mk ml mm ij bi translated">因此，这是一个短暂的存储区域。虽然函数可以在调用之间缓存数据，但它应该只用于代码在一次调用中需要的数据。它不是一个永久存储数据的地方，最好用于支持代码所需的操作。<strong class="lt jh"/>——詹姆斯·贝斯威克</p></blockquote><p id="49d2" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">当lambda第一次调用时，我们检查图像是否已经驻留在tmp文件夹中，如果没有，我们从S3中取出它们，它们现在将被缓存在tmp文件夹中，以供这个lambda容器和进一步调用使用。</p><figure class="nx ny nz oa gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ps"><img src="../Images/9839638b313f194235f99e1490e74368.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L056KCEhei4JjS9IcXnEOw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">冷启动时从本地tmp文件夹提取lambda并从S3填充的示例</figcaption></figure><p id="2bae" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">这意味着第一次调用在冷启动时会稍慢一些，因为它从AWS S3获取图像，但随后的API调用却快如闪电！</p><blockquote class="ln lo lp"><p id="6019" class="lq lr ls lt b lu lv kh lw lx ly kk lz ma mb mc md me mf mg mh mi mj mk ml mm ij bi translated"><em class="jg">💡</em>使用NodeJS在lambda中进行缓存的另一个很好的例子是在lambda处理程序之外填充一个全局变量，它现在将在以后的调用中保留内存中的值。您不能假设它总是被填充，但是我过去曾使用它来存储在访问内部API时从客户端凭证授权流生成的令牌(即，而不是在每次调用时都生成新的令牌)。检查它是否被填充，如果没有，生成一个新的令牌并缓存它——类似于上面讨论的使用tmp的方法。</p></blockquote><h2 id="65c1" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">从S3调出图像</h2><p id="0c1b" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">接下来是一个相当简单的设置，直接从AWS S3存储桶中提取文件。</p><figure class="nx ny nz oa gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pt"><img src="../Images/c5ee5ac8089d0b8c9b2947dc2d658677.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DU8P7NVnhkVB2WoG20HSIw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">显示直接从AWS S3提取文件的示例</figcaption></figure><p id="e51d" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">这是三种方法中最慢的，但仍然非常快。</p><h2 id="eef1" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">从EFS调出图像</h2><p id="ff42" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">第三个Lambda直接从EFS获取文件，是三个中最复杂的设置。</p><p id="8ee3" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">这是因为要将EFS与Lambda一起使用，您的Lambda函数需要附加到VPC。与创建EFS文件系统相关的云信息非常多，所以我在<code class="fe op oq or os b">serverless.yml</code>文件中添加了详细的注释。</p><p id="f432" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">还有一个额外的复杂性，即我们在无服务器部署上从S3填充EFS的Lambda需要访问S3和EFS，并且Lambda位于没有互联网访问的私有子网中，这意味着我们需要引入一个<a class="ae jd" href="https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html" rel="noopener ugc nofollow" target="_blank"> VPC网关端点</a>，以允许该功能与AWS S3进行对话(<em class="ls">另一种方法可能是使用Nat网关</em>)。</p><figure class="nx ny nz oa gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pu"><img src="../Images/d0d09df4e0624ad24245310acdc29845.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gqkPLP_tWOxQsqq9laW9Ag.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">显示直接从EFS提取图像的示例</figcaption></figure><h2 id="9fa8" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">测试端点</h2><p id="4fa3" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">现在我们已经讨论了设置，您可以通过使用repo中的<code class="fe op oq or os b">./postman</code>文件夹中的Postman集合来测试端点。</p><blockquote class="ln lo lp"><p id="90d5" class="lq lr ls lt b lu lv kh lw lx ly kk lz ma mb mc md me mf mg mh mi mj mk ml mm ij bi translated"><em class="jg">💡</em>一旦<a class="ae jd" href="https://learning.postman.com/docs/getting-started/importing-and-exporting-data/" rel="noopener ugc nofollow" target="_blank">导入了</a>Postman集合，<a class="ae jd" href="https://learning.postman.com/docs/sending-requests/variables/" rel="noopener ugc nofollow" target="_blank">将url变量</a>修改为API网关URL，我们在成功部署后的截图中显示了该URL。</p></blockquote><p id="cbc3" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">示例屏幕截图显示了使用Postman调用端点:</p><figure class="nx ny nz oa gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pv"><img src="../Images/2a523605728abdb2078e620c111e3b83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LW5XW0cQgBNeJZ090T9Now.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">文件对象数组响应示例(名称和图像的base64正文)</figcaption></figure></div><div class="ab cl ou ov hu ow" role="separator"><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz"/></div><div class="ij ik il im in"><h1 id="2166" class="kv kw jg bd kx ky pb la lb lc pc le lf km pd kn lh kp pe kq lj ks pf kt ll lm bi translated">何时使用每个存储选项？</h1><p id="5650" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">现在我们已经看到了在同一个解决方案中编码和配置的三个选项，您何时会使用每个选项，在我看来每个方法的优缺点是什么？</p><h2 id="b7d2" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">AWS临时存储</h2><p id="51df" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">让我们先讨论Lambda上的<code class="fe op oq or os b">/tmp</code>文件夹。在您的解决方案中读写文件时，这是三个选项中最快的一个，但是在使用文件之前，您需要检查文件是否已经驻留在文件夹中，这增加了代码的复杂性。这实质上相当于在本地硬盘上读写数据。</p><p id="bd02" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">显然，您也不能在同一个lambda的不同调用之间共享文件(<em class="ls">，因为您通常不能在单独的机器上使用硬盘驱动器</em>)。</p><p id="9f3d" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">tmp存储也有512MB的上限，与其他选项相比，这是一个规模限制。然而，这具有成本效益，并且与其他选项相比需要更少的IaC(<em class="ls">即不需要创建文件共享或s3存储桶，不必担心配置和权限等问题</em>)。</p><p id="7340" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">我过去曾用这种方法在Lambda中缓存电子邮件模板，这种方法很少改变，但为我们的客户提高了速度。</p><h2 id="198a" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">AWS S3</h2><p id="59cb" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">AWS S3在读写文件时是三个选项中最慢的(<em class="ls">，但对于大多数应用来说仍然非常快</em>)；然而，这不像EFS那样需要VPC，所以如果您的完整解决方案不需要，这是一个很好的选择(<em class="ls">，即更少的IaC、配置、设置等</em>)。</p><p id="a6bc" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">在我看来，S3还拥有与其他AWS服务的最佳集成(例如，<em class="ls">当一个新对象上传到桶</em>时调用Lambda)，允许<a class="ae jd" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Versioning.html" rel="noopener ugc nofollow" target="_blank">对象版本</a>和标记，以及允许<a class="ae jd" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingMetadata.html" rel="noopener ugc nofollow" target="_blank">向对象</a>添加元数据。</p><blockquote class="ln lo lp"><p id="9c32" class="lq lr ls lt b lu lv kh lw lx ly kk lz ma mb mc md me mf mg mh mi mj mk ml mm ij bi translated">记住S3对象存储的某些特征是很重要的。虽然可以对S3对象进行版本控制，但不能像在文件系统中那样追加数据。你必须存储一个对象的全新版本。S3也有一个不同于文件系统的平面存储层次结构。通过在键名中添加前缀“foldername/”,您可以使用<a class="ae jd" href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/using-folders.html" rel="noopener ugc nofollow" target="_blank">文件夹</a>来逻辑地组织对象，而不是目录。—James Beswick—AWS无服务器团队的主要开发人员支持者</p></blockquote><p id="fc0b" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">一个很好的用例是允许您的客户生成或上传他们自己的需要版本化的文档和图像(<em class="ls">非结构化数据</em>)，这是我过去在一个企业应用程序中使用的一种方法，效果非常好。</p><p id="57a1" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">S3还允许你使用<a class="ae jd" href="https://aws.amazon.com/athena" rel="noopener ugc nofollow" target="_blank"> Amazon Athena </a>对数据进行查询，使用<a class="ae jd" href="https://aws.amazon.com/quicksight/" rel="noopener ugc nofollow" target="_blank"> Amazon QuickSight </a>运行报告，这些都是很棒的附加功能。</p><h2 id="c8e1" class="nf kw jg bd kx ng nh dn lb ni nj dp lf mn nk nl lh mo nm nn lj mp no np ll nq bi translated">AWS EFS</h2><p id="f033" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">AWS Lambda EFS允许您在第一次调用Lambda时将共享文件系统挂载到您的Lambda，这将在Lambda的生命周期内保留挂载。</p><p id="dbad" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">这对于在许多Lambda调用之间共享大量数据非常有用，而且像tmp方法一样，与S3相比，它是最快的。由于动态绑定，它还允许你非常容易地共享最新的大型二进制文件或代码库(<em class="ls">你可以用Lambda层做到这一点，但这有管理和部署层的开销，并且它不太动态</em>)。</p><p id="b145" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">使用此选项，您可以通过EFS文件共享拥有多达25K个并发Lambda连接，所有Lambda都使用最新的文件数据。</p><blockquote class="ln lo lp"><p id="1d81" class="lq lr ls lt b lu lv kh lw lx ly kk lz ma mb mc md me mf mg mh mi mj mk ml mm ij bi translated">由于其速度和支持标准的文件操作，EFS也是有益的摄取或写入大量文件持久。例如，这对于压缩或解压缩大型归档文件很有帮助。对于附加到现有文件，EFS也是使用S3的首选选项。—James Beswick—AWS无服务器团队的主要开发人员支持者</p></blockquote><p id="79c0" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">下图显示了AWS的官方比较，在我看来，它很好地突出了这些差异:</p><figure class="nx ny nz oa gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pw"><img src="../Images/650f356bd24d884ca4f3bbedfe1f9982.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J2flDpWMFDsEmP9SltRPmw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">摘自<a class="ae jd" href="https://aws.amazon.com/blogs/compute/choosing-between-aws-lambda-data-storage-options-in-web-apps/" rel="noopener ugc nofollow" target="_blank"> AWS博客文章</a>的存储选项比较</figcaption></figure><p id="c17f" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">希望你觉得这有用！</p></div><div class="ab cl ou ov hu ow" role="separator"><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz"/></div><div class="ij ik il im in"><h1 id="6d77" class="kv kw jg bd kx ky pb la lb lc pc le lf km pd kn lh kp pe kq lj ks pf kt ll lm bi translated">包扎</h1><p id="d840" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">我很乐意就以下任何一个问题与您联系:</p><p id="f893" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">【https://www.linkedin.com/in/lee-james-gilmore/】T3<br/>T5<a class="ae jd" href="https://www.linkedin.com/in/lee-james-gilmore/" rel="noopener ugc nofollow" target="_blank">https://twitter.com/LeeJamesGilmore</a></p><p id="3acb" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">如果你觉得这些文章鼓舞人心或有用，请随时用虚拟咖啡<a class="ae jd" href="https://www.buymeacoffee.com/leegilmore" rel="noopener ugc nofollow" target="_blank">https://www.buymeacoffee.com/leegilmore</a>来支持我，不管怎样，让我们联系和聊天吧！☕️</p><p id="2d41" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">如果你喜欢这些帖子，请关注我的简介<a class="ae jd" href="https://medium.com/u/2906c6def240?source=post_page-----39c4f4ae5aff----------------------" rel="noopener">李·詹姆斯·吉尔摩</a>以获取更多的帖子/系列，不要忘记联系我并打招呼👋</p><p id="310e" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">如果你喜欢，也请使用帖子底部的“鼓掌”功能！(<strong class="lt jh"> <em class="ls">可以不止一次鼓掌！！</em> </strong>)</p><p id="d993" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated"><strong class="lt jh">本文由</strong><a class="ae jd" href="https://www.sedai.io/" rel="noopener ugc nofollow" target="_blank"><strong class="lt jh">sedai . io</strong></a>赞助</p><figure class="nx ny nz oa gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi px"><img src="../Images/4c77bc2d275bd557dda90aa2fe842d2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LJqkQYFI-KAGHOI3cHWxJQ.png"/></div></div></figure></div><div class="ab cl ou ov hu ow" role="separator"><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz"/></div><div class="ij ik il im in"><h1 id="b449" class="kv kw jg bd kx ky pb la lb lc pc le lf km pd kn lh kp pe kq lj ks pf kt ll lm bi translated">关于我</h1><p id="b778" class="pw-post-body-paragraph lq lr jg lt b lu nr kh lw lx ns kk lz mn nt mc md mo nu mg mh mp nv mk ml mm ij bi translated">"<em class="ls">大家好，我是Lee，英国的AWS认证技术架构师和首席软件工程师，目前是技术云架构师和首席无服务器开发人员，过去5年主要从事AWS上的全栈JavaScript工作。</em></p><p id="c6c9" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">我认为自己是一个无服务器的布道者，热爱AWS、创新、软件架构和技术。”</p><p id="dfea" class="pw-post-body-paragraph lq lr jg lt b lu lv kh lw lx ly kk lz mn mb mc md mo mf mg mh mp mj mk ml mm ij bi translated">**所提供的信息是我个人的观点，我对这些信息的使用不承担任何责任。*** </p></div></div>    
</body>
</html>