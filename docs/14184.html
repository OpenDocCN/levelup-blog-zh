<html>
<head>
<title>Creation of a Highly Available 2-Tier Architecture using Terraform Cloud CI/CD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform Cloud CI/CD创建高度可用的2层架构</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/creation-of-a-highly-available-2-tier-architecture-using-terraform-cloud-ci-cd-4ae7d8f9f783?source=collection_archive---------8-----------------------#2022-11-07">https://levelup.gitconnected.com/creation-of-a-highly-available-2-tier-architecture-using-terraform-cloud-ci-cd-4ae7d8f9f783?source=collection_archive---------8-----------------------#2022-11-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6abcce43744fa666a3452fd783129588.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oikcN7Di1G9lmo0hb_Sx8Q.jpeg"/></div></div></figure><h1 id="8938" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">场景</strong></h1><p id="0e35" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">创建包含以下内容的高度可用的双层AWS体系结构:</p><ol class=""><li id="c85e" class="lu lv iq ky b kz lw ld lx lh ly ll lz lp ma lt mb mc md me bi translated">3个公共子网</li><li id="a674" class="lu lv iq ky b kz mf ld mg lh mh ll mi lp mj lt mb mc md me bi translated">3个私有子网</li><li id="f351" class="lu lv iq ky b kz mf ld mg lh mh ll mi lp mj lt mb mc md me bi translated">公共子网中的1台堡垒主机</li><li id="4d73" class="lu lv iq ky b kz mf ld mg lh mh ll mi lp mj lt mb mc md me bi translated">Web服务器的自动扩展组(在专用子网中)</li><li id="9d8c" class="lu lv iq ky b kz mf ld mg lh mh ll mi lp mj lt mb mc md me bi translated">面向Internet的应用程序负载平衡器，目标是Web服务器自动扩展组</li><li id="e8e8" class="lu lv iq ky b kz mf ld mg lh mh ll mi lp mj lt mb mc md me bi translated">使用Terraform Cloud作为CI/CD工具进行部署，以检查您的构建。</li><li id="d6ea" class="lu lv iq ky b kz mf ld mg lh mh ll mi lp mj lt mb mc md me bi translated">使用模块块便于使用和重复使用。</li></ol><h1 id="f70b" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">先决条件</strong></h1><ol class=""><li id="409e" class="lu lv iq ky b kz la ld le lh mk ll ml lp mm lt mb mc md me bi translated">地形云</li><li id="be2d" class="lu lv iq ky b kz mf ld mg lh mh ll mi lp mj lt mb mc md me bi translated">IAM用户密钥</li><li id="b0eb" class="lu lv iq ky b kz mf ld mg lh mh ll mi lp mj lt mb mc md me bi translated">地形登记处—【https://registry.terraform.io/ T4】</li></ol><p id="89e5" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">在之前的项目中，我们仅使用一个配置文件(main.tf)构建了一个2层架构。在本演练中，我们将更深入地使用模块来构建我们的代码，同时通过Terraform Cloud应用CI/CD管道</p><p id="9cf8" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">配置文件存储在我的<strong class="ky ir"> GitHub repo </strong>中。参见<a class="ae mn" href="https://github.com/Maze2022/Week21-2Tier-Arc-Terraform" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">链接</strong> </a></p><p id="1b82" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir">第一步:在配置文件中设置代码</strong></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/ccc4e7005c07b9f7046d4cd534af8844.png" data-original-src="https://miro.medium.com/v2/resize:fit:492/format:webp/1*35qvLDPFHGfQ25T2Pt71Jw.png"/></div></figure><p id="e929" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir">根模块</strong></p><p id="938a" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">这里的配置文件是main.tf、variables.tf、outputs.tf、terraform.tfvars、userdata.sh、状态文件以及子模块</p><p id="9ec2" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir">子模块</strong></p><p id="1326" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir">网络模块:</strong>它由与根模块类似的配置文件组成，根模块明确用于启动VPC、私有和公共子网、路由表、互联网和NAT网关等。<strong class="ky ir"> outputs.tf </strong>文件输出一些在根模块main.tf中使用的参数</p><p id="0338" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir">负载平衡模块:</strong>它由目标组和负载平衡资源块组成，将流量导向webserver自动扩展组</p><p id="5727" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir">计算模块:</strong>它由启动模板和包含堡垒主机(公共子网)和web服务器(私有子网)的自动扩展组组成</p><p id="f856" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">负载平衡和计算模块块通过outputs.tf文件中声明的输出变量引用网络模块</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="a070" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir">第二步:用GitHub配置Terraform Cloud】</strong></p><p id="3908" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">现在我们已经设置了代码，我们将设置一个Terraform云帐户，登录并创建一个新的工作空间。</p><p id="a846" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">工作空间决定了Terraform Cloud如何组织基础架构。工作空间由地形配置、变量和当前地形状态组成。</p><p id="648e" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">现在我们必须选择一个工作流程。将使用<strong class="ky ir"> <em class="my">版本控制工作流</em> </strong>，因为我们打算从存储库触发CI/CD管道</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/73ff95fe24146e6623b479fd48225ff6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pkPdcN4wfHjR0ibvMY-QfA.png"/></div></div></figure><p id="b0af" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">接下来，我们将选择一个<strong class="ky ir"> <em class="my">版本控制提供者</em> </strong>。在这种情况下，我们使用GitHub。点击GitHub下拉菜单，选择GitHub.com<strong class="ky ir">T5T7】</strong></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/cfa9014cd494d9e37522f88154c32bca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZFvSInXzLwXm-3kHWVOxeA.png"/></div></div></figure><p id="3b97" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">会弹出一个页面提示你授权Terraform Cloud访问你的GitHub账户。您需要禁用浏览器中的弹出窗口拦截器，因为这可能会阻止您继续操作</p><p id="47bb" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">在下一页上，从下拉列表中选择您希望Terraform cloud连接到的存储库，然后点击<strong class="ky ir"> <em class="my">安装</em> </strong>按钮。您的存储库将填充到Terraform云环境中</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/244a52ac3bfd83ce0ba3c4b0ad224ff4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OlGoYOGAJbBj0hzMTNi8Ug.png"/></div></div></figure><p id="5f0b" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">我们将从这里继续创建一个<strong class="ky ir"> <em class="my">工作区</em> </strong> <em class="my">，名称为</em><strong class="ky ir"><em class="my"/></strong><strong class="ky ir"><em class="my">2-Tier-dev。</em>T25】</strong></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/8ec3bc7002cfdc2cad510c2ffd5b31aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*boKbxfrkPbXVODpk3XsOjw.png"/></div></div></figure><p id="99ae" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">一旦创建了工作空间，我们将开始配置<strong class="ky ir"> <em class="my">工作空间变量。</em></strong><strong class="ky ir"><em class="my">access _ key、secret_key和region </em> </strong>将被设置为<strong class="ky ir"> <em class="my">环境变量。</em> </strong>由于某种原因，我遇到了变量错误，但我不得不使用<strong class="ky ir"> <em class="my"> TF_VAR </em> </strong>前缀，它允许Terraform通过查找变量的值来读取环境变量</p><p id="52ff" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">为了安全起见，记得将它们设置为<strong class="ky ir"> <em class="my">【敏感】</em> </strong> <em class="my"/></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/83dc83d0af1b5bd0674c72afda26bed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D_c6ZMaZoitDrYJ_CpRgdw.png"/></div></div></figure><p id="124e" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">在<strong class="ky ir"> <em class="my"> Providers.tf </em> </strong>文件中，为访问密钥、密钥和区域<strong class="ky ir">定义的变量必须</strong>与Terraform Cloud上的环境变量中定义的<strong class="ky ir"> <em class="my">密钥</em> </strong>名称相匹配。为了避免错误</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="9d4c" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">接下来，我们将使用<strong class="ky ir"> <em class="my"> backends.tf </em> </strong>文件设置后端配置。该文件定义了Terraform存储其状态文件的位置，并与Terraform Cloud集成，以允许执行远程操作</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="0de7" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir">步骤3:从Terraform Cloud部署配置</strong></p><p id="6231" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">我们将从<strong class="ky ir"> <em class="my">排队计划</em> </strong>开始</p><p id="d6e6" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">您可以开始一个新的运行，这将对所有要创建的资源进行排队</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/08f1ee9c1442242e59359bfce34c5ffe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*Fy_HiEblW1M7byKMnB1zlw.png"/></div></figure><p id="2e5b" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">完成后，您将看到下面的显示</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/c64d7d43a2494f8b03b31206466ec03f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qTvgh47J1FpBKz7_22RYJw.png"/></div></div></figure><p id="422a" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir"> <em class="my">应用</em> </strong>阶段要求您手动确认并应用代码。这允许您在最终运行代码之前检查代码</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/c5b37161202225936d4d4edff1fb09c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8kZjC_eF_9Es8j2iUpoVsw.png"/></div></div></figure><p id="94e9" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">点击<strong class="ky ir"> <em class="my">后确认&amp;应用</em> </strong>按钮，我们将得到如下所示的显示</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/a3117b592326e39f62fc77720de2223e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pCNKg0OzJCVEWbw2QUom7Q.png"/></div></div></figure><p id="77b9" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">让我们到AWS控制台看看创建了什么</p><p id="948e" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir"> <em class="my"> VPC，公网和私网</em> </strong></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/c731dc63cb674e52679468e453b07e99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ld9SMRoYwHkl3BDB0wykdw.png"/></div></div></figure><p id="ff0f" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir"> <em class="my">堡垒主机和web服务器实例</em> </strong></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/37744615fa55688c534fe31785dab4f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jVfxSqc3X7hb2iAAi9R6RA.png"/></div></div></figure><p id="43ff" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir">步骤4:触发CI/CD管道</strong></p><p id="d0ab" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">现在，我们将通过在配置文件中进行的更改触发CI/CD管道，并将其推送到GitHub repo</p><p id="62e0" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">让我们更改网络模块块中的私有和公共子网数量。我们每个人有3个，将把他们放在4个。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/fed9356d9e360a061ffb19f07a33b7f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QH84T2rptXSGn6RFTmVD8Q.png"/></div></div></figure><p id="c1db" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">保存更改，然后运行<strong class="ky ir"> <em class="my"> git add，git commit -m“测试CI/CD”以及git push</em>T5】通过主分支将代码发送到GitHub repo。<strong class="ky ir">注意:</strong>在生产环境中，代码将通过一个分支被推送到存储库，并在合并到主分支之前发起一个拉请求</strong></p><p id="19cd" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">在Terraform Cloud中，一个计划被排队，当它完成时，它会显示什么正在被创建，什么正在被更改</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/7902d8dde38fe57072ee9158861293ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dVcGZ4-byotfigq-EBegeA.png"/></div></div></figure><p id="3053" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">一旦应用了计划，它就会构建代码并显示完成情况，如下所示</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/2c7708aee06454f41293681430f1aedb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7d5MBS7FNzXF20FjqEurJQ.png"/></div></div></figure><p id="bacb" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">前往AWS控制台查看我们所做的更改</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/057190653e06e6135e64d7786fc5b609.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wynFdgbWKg2okgCUbqTzWQ.png"/></div></div></figure><p id="5436" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">太好了，我们创建了4个公共子网和4个私有子网</p><p id="8c77" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated"><strong class="ky ir">第四步:破坏资源</strong></p><p id="37dc" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">最后，我们将摧毁我们所有的资源。导航到您的工作区下的设置，向下滚动并点击<strong class="ky ir"> <em class="my">销毁和删除。</em> </strong>点击<strong class="ky ir"> <em class="my">队列销毁计划</em> </strong></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/8fe4f0ca1bf59cc6e23f181cb1d730e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u93YFh_8Fv4S3B2jrfJiXQ.png"/></div></div></figure><p id="976a" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">遵循提示并应用计划。</p><p id="baaa" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mo lj lk ll mp ln lo lp mq lr ls lt ij bi translated">感谢您的阅读。</p></div></div>    
</body>
</html>