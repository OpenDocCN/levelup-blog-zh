<html>
<head>
<title>React, Web Workers, and IndexedDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React、Web Workers和IndexedDB</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/react-web-workers-and-indexeddb-a973797e771b?source=collection_archive---------8-----------------------#2020-04-09">https://levelup.gitconnected.com/react-web-workers-and-indexeddb-a973797e771b?source=collection_archive---------8-----------------------#2020-04-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="dcf5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在带有Web Workers的React应用程序中使用IndexedDB</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ba5dc11a44e828e46fce237b1a381f0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ih6g24vTLWb_Zl-yiNOuNA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@pawankawan?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">帕万·卡万</a>在<a class="ae ky" href="https://unsplash.com/s/photos/free?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="5484" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我分享<a class="ae ky" href="https://medium.com/@david.dalbusco/one-trick-a-day-d-34-469a0336a07e" rel="noopener">一天一招</a>直到原定的2020年4月19日瑞士新冠肺炎隔离期结束。离第一个里程碑还有10天。希望更好的日子就在前面。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="deb8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本系列的前一篇博文<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/react-and-web-workers-c9b60b4b6ae8">中，我分享了我让</a><a class="ae ky" href="https://reactjs.org" rel="noopener ugc nofollow" target="_blank"> React </a>和<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers" rel="noopener ugc nofollow" target="_blank"> Web Workers </a>交互的解决方案。这是我在开发<a class="ae ky" href="https://tietracker.app.link/" rel="noopener ugc nofollow" target="_blank">领带追踪器</a>时尝试的一个小技巧，这是一个简单、开源、免费的时间追踪应用程序⏱。</p><p id="7bd3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这种结构和这个应用程序的另一个有趣的特性是使用<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API" rel="noopener ugc nofollow" target="_blank"> IndexedDB </a>在线程中处理数据的想法。</p><p id="b990" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">想法很简单:让用户在应用程序端(JavaScript单线程)输入和修改数据库中的数据，因为这样的操作花费的时间更少，但是为了不阻塞用户界面和交互，要将每一个计算或统计交给Web工作者。</p><p id="97a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是为什么我在这篇后续文章中与你分享这个食谱😁。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b34b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">idb-keyval</h1><p id="6817" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当涉及到第三方库时，我有点挑剔，因为我有点“捆绑恐惧症”，但是当涉及到与索引数据库交互时，我毫不犹豫，来自杰克·阿奇博尔德的<a class="ae ky" href="https://github.com/jakearchibald/idb-keyval" rel="noopener ugc nofollow" target="_blank"> idb-keyval </a>是我的首选库。</p><p id="9588" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">少于600字节，树摇友好，承诺为基础…停在那里，我都在！</p><p id="1f42" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，在这个解决方案中，我们当然要使用它😉。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="38f4" class="ne md it na b gy nf ng l nh ni">npm i idb-keyval --save</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="32fd" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">用户界面</h1><p id="b0c2" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在之前的帖子中，我们有一个“Tomate和Apple计数器”。我建议我们现在把自己的注意力集中在“番茄”上，并把计数器的总和的计算工作交给网络工作者。</p><p id="4882" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在与IndexedDB进行任何交互之前，我们修改后的组件代码如下所示。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="5014" class="ne md it na b gy nf ng l nh ni">import {<br/>    IonContent,<br/>    IonPage,<br/>    IonLabel,<br/>    IonButton<strong class="na iu"><em class="nj"><br/></em></strong>} from '@ionic/react';<br/>import React, {useEffect, useState} from 'react';<br/>import {RouteComponentProps} from 'react-router';<br/><br/>import './Page.css';<br/><br/>const Page: React.FC&lt;RouteComponentProps&lt;{ name: string; }&gt;&gt; = ({match}) =&gt; {<br/><br/>    const [countTomato, setCountTomato] = useState&lt;number&gt;(0);<br/>    const [sumTomato, setSumApple] = useState&lt;number&gt;(0);<br/><br/>    const tomatoWorker: Worker = new Worker('./workers/tomato.js');<br/><br/>    useEffect(() =&gt; {<br/>        tomatoWorker.onmessage = ($event: MessageEvent) =&gt; {<br/>            if ($event &amp;&amp; $event.data) {<br/>                setSumApple($event.data);<br/>            }<br/>        };<br/>    }, [tomatoWorker]);<br/><br/>    function doSumTomato() {<br/>        tomatoWorker<br/>         .postMessage({msg: 'sumTomato'});<br/>    }<br/><br/>    return (<br/>        &lt;IonPage&gt;<br/>            &lt;IonContent className="ion-padding"&gt;<br/>                &lt;IonLabel&gt;<br/>                   Tomato: {countTomato} | Sum: {sumTomato}<br/>                &lt;/IonLabel&gt;<br/><br/>                &lt;div className="ion-padding-top"&gt;<br/>                    &lt;IonButton<br/>                        onClick={() =&gt; <br/>                          setCountTomato(countTomato + 1)}<br/>                        color="primary"&gt;Tomato&lt;/IonButton&gt;<br/><br/>                    &lt;IonButton<br/>                        onClick={() =&gt; doSumTomato()}<br/>                        color="secondary"&gt;Sum now!&lt;/IonButton&gt;<br/>                &lt;/div&gt;<br/>            &lt;/IonContent&gt;<br/>        &lt;/IonPage&gt;<br/>    );<br/>};<br/><br/>export default Page;</span></pre><p id="3359" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，由于我们还没有实现sum部分，即Web Worker，它没有做太多工作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/0feedb68b9dd2d4103e56e1dd3bf79ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*0Qz6Y3scEzimJ--S7TTNgA.gif"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="89e0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">用户交互</h1><p id="cb97" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们的目标是在IndexDB中写一个关于用户交互的数据，这就是为什么为了演示和好玩，我建议我们在每次番茄计数器递增时在数据库中生成一个新条目。为此，我们注册一个新的<code class="fe nl nm nn na b">useEffect</code>到<code class="fe nl nm nn na b">set</code>条目。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="3e31" class="ne md it na b gy nf ng l nh ni">import {set} from 'idb-keyval';</span><span id="0edc" class="ne md it na b gy no ng l nh ni">useEffect(() =&gt; {<br/>    incTomato();<br/>}, [countTomato]);<br/><br/>async function incTomato() {<br/>    if (countTomato &gt; 0) {<br/>        await set(`tomato${countTomato}`, countTomato);<br/>    }<br/>}</span></pre><p id="01c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就这样了。每当计数器递增时，效果被触发，并且在扩展中，我们使用idb-keyval在数据库中添加一个值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/e42332529c348659fec8ea1cf5b83d89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*Upl2MW8HhjDarFAcOoOdUQ.gif"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6bc8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">网络工作者</h1><p id="5e75" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">对于本教程，我创建了一个新的工人文件<code class="fe nl nm nn na b">./public/workers/tomato.js</code>，它在任何IndexDB交互之前看起来如下。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="51b9" class="ne md it na b gy nf ng l nh ni">self.onmessage = async ($event) =&gt; {<br/>    if ($event &amp;&amp; $event.data &amp;&amp; $event.data.msg === 'sumTomato') {<br/>        const sum = await sumTomato();<br/>        self.postMessage(sum);<br/>    }<br/>};<br/><br/>async function sumTomato() {<br/>    // <em class="nj">TODO sum tomato<br/>    </em>return 0;<br/>}</span></pre><p id="0345" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在必须访问IndexedDB中的数据。为了解决这个问题，我们有两个选择，要么编码一切，要么使用一个库。作为idb-keyval的忠实粉丝，我也想在这里使用它。</p><p id="9e3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不幸的是，我们的Web Workers是作为资产交付的，因此无法访问我们的包及其依赖项。这就是为什么我们必须在<code class="fe nl nm nn na b">importScripts</code>的帮助下在我们的workers中执行设置和导入脚本。</p><p id="2e33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我猜一个很好的方法是用Rollup或Webpack来处理这种依赖性，可能是通过插件，但我不得不说我没有遵循那条路。</p><p id="d8c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是为什么我们还有两个选择。链接一个外部脚本或下载它，放在同一个文件夹中并在本地引用它。</p><p id="f2bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您希望遵循“本地方式”，您的导入将如下所示:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="5559" class="ne md it na b gy nf ng l nh ni">importScripts('./idb-keyval-iife.min.js');</span></pre><p id="3154" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，正如我们将要做的，下面是我们如何使用<a class="ae ky" href="https://unpkg.com/" rel="noopener ugc nofollow" target="_blank"> Unpkg </a>导入它。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="01b2" class="ne md it na b gy nf ng l nh ni">importScripts('https://unpkg.com/idb-keyval@latest/dist/idb-keyval-iife.min.js');</span></pre><p id="7770" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有设置，我们现在可以享受idb-keyval，并从我们的Web Worker访问IndexedDB中的数据。例如，我们可以列出数据库中的<code class="fe nl nm nn na b">keys()</code>，迭代这些到<code class="fe nl nm nn na b">get(key)</code>它们的值，并计算一个伪和。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="777f" class="ne md it na b gy nf ng l nh ni">importScripts('https://unpkg.com/idb-keyval@latest/dist/idb-keyval-iife.min.js');<br/><br/>self.onmessage = async ($event) =&gt; {<br/>    if ($event &amp;&amp; $event.data &amp;&amp; $event.data.msg === 'sumTomato') {<br/>        const sum = await sumTomato();<br/>        self.postMessage(sum);<br/>    }<br/>};<br/><br/>async function sumTomato() {<br/>    const keys = await idbKeyval.keys();<br/><br/>    let sum = 0;<br/>    for (const key of keys) {<br/>        const value = await idbKeyval.get(key);<br/>        sum += value;<br/>    }<br/><br/>    return sum;<br/>}</span></pre><p id="2f7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">瞧🎉。我们在所有线程中都使用了IndexedDB😃。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/cc689092cf9e323cf48cd148a0dacc84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*o4uSCTJUb9X253cdPmJJMA.gif"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4d3c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">摘要</h1><p id="84b4" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">网络太有趣了。</p><p id="be4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">呆在家里，注意安全。</p><p id="b23e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大卫</p></div></div>    
</body>
</html>