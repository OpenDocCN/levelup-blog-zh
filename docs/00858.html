<html>
<head>
<title>Adding extra claims in ASP.NET Core web applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在ASP.NET核心web应用程序中添加额外声明</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/add-extra-user-claims-in-asp-net-core-web-applications-1f28c98c9ec6?source=collection_archive---------0-----------------------#2019-08-27">https://levelup.gitconnected.com/add-extra-user-claims-in-asp-net-core-web-applications-1f28c98c9ec6?source=collection_archive---------0-----------------------#2019-08-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6b40e2bf8b8809ec1fff96d0b89d5468.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VrvS6Ky3clwfsf4llZMKnw.png"/></div></div></figure><p id="8a9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://docs.microsoft.com/en-us/aspnet/core/security/authorization/claims" rel="noopener ugc nofollow" target="_blank">ASP.NET核心文档</a>详细解释了什么是索赔以及如何检查索赔。但是，没有关于如何创建新声明并将其附加到用户对象的信息。</p><p id="b72d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，我们将填补这一空白，并为您提供一步一步的指导，告诉您如何添加新的索赔，并在视图(页面)或ASP.NET核心应用程序的任何其他部分使用它。</p><h1 id="b72f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">问题</h1><p id="0874" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">让我们描述一下我们要解决的任务。</p><ol class=""><li id="5c92" class="ma mb iq ka b kb kc kf kg kj mc kn md kr me kv mf mg mh mi bi translated">我们有一个ASP.NET核心(2.1+版)项目，它具有由ASP.NET身份库提供的默认认证/授权功能</li><li id="1559" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">在我们的身份模型类(假设是<code class="fe mo mp mq mr b">ApplicationUser</code>)中有一个用户名字段(例如<code class="fe mo mp mq mr b">ContactName</code>)。</li><li id="485d" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">我们希望将那个<code class="fe mo mp mq mr b">ContactName</code>列的值添加到用户声明中，然后在用户登录时显示在我们的主页上(而不是默认显示的用户电子邮件)。</li></ol><p id="d52a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是我们为实现目标将要执行的步骤。</p><h1 id="91b0" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤1:添加新索赔</h1><h2 id="1258" class="ms ky iq bd kz mt mu dn ld mv mw dp lh kj mx my ll kn mz na lp kr nb nc lt nd bi translated">1.1.创建一个定制的“声明原则”工厂</h2><p id="39e8" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们需要一个<code class="fe mo mp mq mr b">IUserClaimsPrincipalFactory</code>的实现，它将为用户的声明添加必要的信息(在我们的例子中是<code class="fe mo mp mq mr b">ContactName</code>)。最简单的方法是从默认实现<code class="fe mo mp mq mr b">IUserClaimsPrincipalFactory</code>中派生出我们的新类，并覆盖一个方法<code class="fe mo mp mq mr b">GenerateClaimsAsync</code>:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="df14" class="ms ky iq mr b gy nm nn l no np">public class MyUserClaimsPrincipalFactory : UserClaimsPrincipalFactory&lt;ApplicationUser&gt; <br/>{     <br/>    public MyUserClaimsPrincipalFactory(<br/>        UserManager&lt;ApplicationUser&gt; userManager,<br/>        IOptions&lt;IdentityOptions&gt; optionsAccessor)<br/>            : base(userManager, optionsAccessor)     <br/>    {<br/>    }<br/>      <br/>    protected override async Task&lt;ClaimsIdentity&gt;GenerateClaimsAsync(ApplicationUser user)<br/>    {<br/>         var identity = await base.GenerateClaimsAsync(user);<br/>         identity.AddClaim(new Claim("ContactName", user.ContactName ?? "[Click to edit profile]"));         <br/>         return identity;     <br/>    } <br/>}</span></pre><h2 id="3d68" class="ms ky iq bd kz mt mu dn ld mv mw dp lh kj mx my ll kn mz na lp kr nb nc lt nd bi translated">1.2在DI容器中注册新的类</h2><p id="12bc" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">然后我们需要在依赖注入容器中注册我们的新类。最好的方法是使用<code class="fe mo mp mq mr b">AddClaimsPrincipalFactory</code>扩展方法:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="be8d" class="ms ky iq mr b gy nm nn l no np">public void ConfigureServices(IServiceCollection services)  <br/>{     <br/>        .     .     .     .      . <br/>    services.AddDefaultIdentity&lt;ApplicationUser&gt;()<br/>        .AddDefaultUI(UIFramework.Bootstrap4)<br/>        .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;()<br/>        .AddClaimsPrincipalFactory&lt;MyUserClaimsPrincipalFactory&gt;();  //&lt;---- add this line <br/>}</span></pre><p id="95d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样。ID为<code class="fe mo mp mq mr b">ContactName</code>的新声明将被添加到代表当前用户的对象中。</p><p id="fe08" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们需要在Razor视图(第页)或应用程序中的任何其他地方获取新索赔的值。</p><h1 id="c1ce" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤2:获得新的索赔</h1><p id="7fac" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">为了获得任何声明的值，我们只需要引用代表当前登录用户的<code class="fe mo mp mq mr b">ClaimsPrincipal</code>对象。这个对象可以通过任何Razor视图(页面)的<code class="fe mo mp mq mr b">User</code>属性来访问，或者通过控制器类中的<code class="fe mo mp mq mr b">HttpContext.User</code>来访问，或者一般来说，在任何可以访问<code class="fe mo mp mq mr b">HttpContext</code>对象的地方。</p><p id="d1cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mo mp mq mr b">ClaimsPrincipal</code>包含与当前用户相关的所有声明的列表，您可以调用它的<code class="fe mo mp mq mr b">FindFirst</code>方法来获取必要的声明，然后读取该声明的<code class="fe mo mp mq mr b">Value</code>属性。</p><p id="7979" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，我们只需要打开<code class="fe mo mp mq mr b">Pages/Shared/</code>(或<code class="fe mo mp mq mr b">Views/Shared/</code>)文件夹中的<code class="fe mo mp mq mr b">_LoginPartical.cshtml</code>文件，替换下面一行:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="561c" class="ms ky iq mr b gy nm nn l no np">&lt;a asp-area="" asp-controller="Manage" asp-action="Index" title="Manage"&gt;Hello @User.Identity.Name!&lt;/a&gt;</span></pre><p id="a193" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有了这个:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="5c2c" class="ms ky iq mr b gy nm nn l no np">&lt;a asp-area="" asp-controller="Manage" asp-action="Index" title="Manage"&gt;Hello @(User.FindFirst("ContactName").Value)!&lt;/a&gt;</span></pre><h1 id="041c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">搞定了。</h1><p id="0e8e" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">现在，在你的网页顶部，你将看到这样的东西，而不是类似于<code class="fe mo mp mq mr b">Hello john.doe@yourcompany.com</code>的东西:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/6ed93b087d1d66455d8256d6dab86f32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ap3hmgz07NcDoncvHNtR1w.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">一个默认ASP.NET核心应用程序主页的示例，其用户名来自自定义声明</figcaption></figure><p id="6906" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nv">最初发表于</em> <a class="ae kw" href="https://korzh.com/blogs/dotnet-stories/add-extra-user-claims-aspnet-core-webapp" rel="noopener ugc nofollow" target="_blank"> <em class="nv">。NET stories博客</em></a><em class="nv">2019 . 5 . 14。</em></p></div><div class="ab cl nw nx hu ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="ij ik il im in"><div class="ne nf ng nh gt od"><a href="https://gitconnected.com/learn" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">了解如何编码-查找编码教程| gitconnected</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">从开发者提交和排名的教程中学习任何编程语言、框架或库。教程是…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">gitconnected.com</p></div></div><div class="om l"><div class="on l oo op oq om or jw od"/></div></div></a></div></div></div>    
</body>
</html>