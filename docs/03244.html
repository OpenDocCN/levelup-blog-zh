<html>
<head>
<title>Manage AppService slots with Azure YAML pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure YAML管道管理应用服务插槽</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/manage-appservice-slots-with-azure-yaml-pipelines-3fb2a2e5da9a?source=collection_archive---------12-----------------------#2020-04-27">https://levelup.gitconnected.com/manage-appservice-slots-with-azure-yaml-pipelines-3fb2a2e5da9a?source=collection_archive---------12-----------------------#2020-04-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/09292573c9cf7e921ec002947d426729.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2rzn4akdyWZKKoT4ZNBrLg.png"/></div></div></figure><div class=""/><p id="f76a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">YAML管道是在Azure DevOps中构建CI/CD管道的新方式。虽然它们没有经典管道所拥有的漂亮的GUI，但是这些YAML管道是你的源代码的一部分，可以很容易地被共享，这一事实完全补偿了这一点。</p><p id="2b5a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我将使用YAML管道来演示如何基于分支名称动态创建AppService槽，以及如何为合并回主服务器的分支清理槽。</p><h1 id="cd39" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">创建一个应用服务槽</h1><p id="d88b" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">第一步是创建插槽，但是为了能够做到这一点，我们需要知道插槽的名称应该是什么。所以第一步的第一步就是从分支名称中提取那个名称。在我的例子中，我使用下面的命名约定</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="6ed8" class="mi kx jb me b gy mj mk l ml mm">&lt;type&gt;/&lt;scope&gt;-&lt;keyword/description&gt;</span></pre><p id="b15b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其中<code class="fe mn mo mp me b">scope</code>是唯一的数字，并且是命名槽的理想候选。幸运的是，Azure通过向管道提供大量<a class="ae mq" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&amp;tabs=yaml%2Cbatch" rel="noopener ugc nofollow" target="_blank">信息</a>，比如分支名称的最后一段:<code class="fe mn mo mp me b"><a class="ae mq" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&amp;tabs=yaml" rel="noopener ugc nofollow" target="_blank">Build.SourceBranchName</a></code>，让我们的生活变得简单。有了这些信息，使用一个<a class="ae mq" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/bash?view=azure-devops" rel="noopener ugc nofollow" target="_blank"> bash任务</a>来提取名字并不困难。</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">从分支名称中提取插槽名称的模板</figcaption></figure><p id="3bd2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意,<code class="fe mn mo mp me b"><a class="ae mq" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&amp;tabs=yaml%2Cbatch" rel="noopener ugc nofollow" target="_blank">##vso</a></code>标签用于将提取的槽名放入一个变量中，使其对我们的管道可用。在本文的后面，我们必须再次提取插槽的名称，不是从分支名称，而是从提交消息。所以在我们继续之前，我已经将这个片段重写为一个可重用的Azure模板</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">确定Azure模板中的插槽名称</figcaption></figure><p id="e1c1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该模板需要两个参数，<code class="fe mn mo mp me b">input</code>是包含插槽名称的字符串，<code class="fe mn mo mp me b">slotRegexp</code>是可以提取该名称的正则表达式。该模板可以按如下方式使用</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">使用提取插槽名称模板的管道代码段</figcaption></figure><p id="a117" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，使用一个<a class="ae mq" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-cli?view=azure-devops" rel="noopener ugc nofollow" target="_blank"> Azure CLI任务</a>，可以如下创建插槽</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">创建应用服务插槽</figcaption></figure><p id="f4ec" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里棘手的部分可能是我如何引用插槽名称。其工作方式是在提取插槽名称的作业上添加一个依赖项(<code class="fe mn mo mp me b">dependsOn: setup</code>)，并使插槽名称再次可用(<code class="fe mn mo mp me b">slotName</code>)。同样值得注意的是，在这些示例代码片段中变量引用方式的细微差别，比如<code class="fe mn mo mp me b">$(..) ${{..}} $[..]</code>，在这里<a class="ae mq" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/expressions?view=azure-devops" rel="noopener ugc nofollow" target="_blank">会有更详细的解释</a>。</p><h1 id="8381" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">移除应用服务插槽</h1><p id="e6dc" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">当您将分支合并回主服务器时，就会出现清理插槽的情况。但是，当您压缩所有提交并进行合并时，关于源分支的所有信息都会在管道中丢失。所以这一次我们需要关注合并提交消息。我遵循<a class="ae mq" href="https://gist.github.com/joshbuchea/6f47e86d2510bce28f8e7f42ae84c716" rel="noopener ugc nofollow" target="_blank">语义提交消息</a>的指导方针，所以当我合并时，我写消息如下</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="c70e" class="mi kx jb me b gy mj mk l ml mm">test(1234): improve test quality</span></pre><p id="52d8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这与我们在上一节中所做的或多或少是相同的，除了我们必须稍微改变正则表达式并使用<code class="fe mn mo mp me b">Build.SourceVersionMessage</code>来代替。</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="dcb0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在可以用一个<a class="ae mq" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-cli?view=azure-devops" rel="noopener ugc nofollow" target="_blank"> Azure CLI任务</a>再次移除该插槽。下面我把这个任务写成一个模板，用槽名作为输入参数:</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mr ms l"/></div></figure><h1 id="bb97" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">管道</h1><p id="1abe" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">到目前为止，我只写了一些东西，当然是一个更大的过程的一部分，整个管道。这个主题对于一篇文章来说太大了，但是对于那些对如何将所有东西结合在一起感兴趣的人，我还是会在这里添加我的两条管道:</p><p id="62aa" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">分支部署到槽管线</strong>:</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">分支部署管道</figcaption></figure><p id="14f4" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">主部署和插槽清理管道</strong>:</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">主部署管道</figcaption></figure></div></div>    
</body>
</html>