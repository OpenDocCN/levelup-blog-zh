<html>
<head>
<title>AWS CLI — Automation for temporary MFA credentials</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS CLI —临时MFA凭据的自动化</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/aws-cli-automation-for-temporary-mfa-credentials-31853b1a8692?source=collection_archive---------3-----------------------#2020-01-29">https://levelup.gitconnected.com/aws-cli-automation-for-temporary-mfa-credentials-31853b1a8692?source=collection_archive---------3-----------------------#2020-01-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/84b4f698248694d590658a785857b5a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7nMyswfep-1mgq3MCU4R4A.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">进入齿轮，出来的是自动化！—来源:<a class="ae kf" href="https://pixabay.com/photos/gears-cogs-machine-machinery-1236578/" rel="noopener ugc nofollow" target="_blank"> pixabay </a>，作者:<a class="ae kf" href="https://pixabay.com/users/MustangJoe-2162920/" rel="noopener ugc nofollow" target="_blank"> MustangJoe </a></figcaption></figure><blockquote class="kg kh ki"><p id="1cde" class="kj kk kl km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">多因素身份验证(MFA)是解决安全二分法的灵丹妙药，在这种情况下，密码身份验证是单点故障。</p><p id="73a3" class="kj kk kl km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">那么，<code class="fe li lj lk ll b">awscli</code>会出什么问题呢？让我们来了解一下！</p></blockquote><p id="876d" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">最近，我开始更频繁地使用亚马逊网络服务(AWS)的产品。这主要与另一个团队的产品移交有关，其中基础设施的许多方面都在AWS上。</p><p id="82fa" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">当使用AWS时，我开始着手其MFA相关的工作流。这是因为，作为我工作的地方的安全政策的一部分，MFA/2FA已经成为我们运营的中心焦点。调用AWS的API，或者更准确地说，使用<code class="fe li lj lk ll b">awscli</code>，也不例外；所有帐户都必须启用MFA。</p></div><div class="ab cl lp lq hx lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="im in io ip iq"><h1 id="bfc1" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">“问题”</h1><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mu"><img src="../Images/ec48f580d548e05a63e67c83b667bd67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2CqZA1IjUtHTdUTeEi5iaw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">AWS CLI——参见此处的<a class="ae kf" href="https://github.com/aws/aws-cli" rel="noopener ugc nofollow" target="_blank"/>,了解其代码库</figcaption></figure><p id="a8e1" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">由于MFA已经作为访问我们的AWS资源的一个要求被启用，<code class="fe li lj lk ll b">awscli</code>的各种操作也受到影响。例如，如果我要通过<code class="fe li lj lk ll b">awscli</code>访问或删除EC2实例，我必须首先检索一些临时凭证。此过程需要我的MFA令牌设备的序列号以及临时生成的六位MFA代码。序列号可以在<a class="ae kf" href="https://console.aws.amazon.com/iam/home#/security_credentials" rel="noopener ugc nofollow" target="_blank">网络控制台</a>中找到，而六位数字的MFA码是从您的设备中生成的，必须在到期前输入。</p><p id="fa72" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">当使用<code class="fe li lj lk ll b">aws sts get-session-token</code>进行身份验证时，您将获得一组您可以使用的临时凭证，如下所示。</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/08dceea29abff837cb836fe87fd173ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O4-VsjfaLQyO3XCjb7cU9w.png"/></div></div></figure><p id="d1f5" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">与<code class="fe li lj lk ll b">aws configure </code> <a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html#cli-quick-configuration" rel="noopener ugc nofollow" target="_blank">命令</a>不同的是，它没有立即保存到我的机器的选项。因此，使用这些凭证需要一些手动复制和粘贴操作，导致生成和使用这组凭证的过程，总体上是一个麻烦的过程。</p><p id="2538" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">让我们看看<a class="ae kf" href="https://aws.amazon.com/premiumsupport/knowledge-center/authenticate-mfa-cli/" rel="noopener ugc nofollow" target="_blank">文档</a>建议的生成和使用这些凭证的两种方式，以及我们如何能做得更好。</p></div><div class="ab cl lp lq hx lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="im in io ip iq"><h2 id="bf04" class="na lx it bd ly nb nc dn mc nd ne dp mg lm nf ng mk ln nh ni mo lo nj nk ms nl bi translated"><strong class="ak">文档方法1 — </strong>使用带有环境变量的临时凭证</h2><p id="b7c4" class="pw-post-body-paragraph kj kk it km b kn nm kp kq kr nn kt ku lm no kx ky ln np lb lc lo nq lf lg lh im bi translated">第一种方法详细说明了环境变量的使用，以便与<code class="fe li lj lk ll b">awscli</code>一起使用。这被视为如下:</p><figure class="mv mw mx my gt ju"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="8e24" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">我对这种方法的主要不满有两点:</p><ol class=""><li id="e5dc" class="nt nu it km b kn ko kr ks lm nv ln nw lo nx lh ny nz oa ob bi translated">每次需要使用时，我们都必须从web控制台手动检索序列号。</li><li id="a8bf" class="nt nu it km b kn oc kr od lm oe ln of lo og lh ny nz oa ob bi translated">我们必须手动将凭证输出复制并粘贴到环境变量中</li><li id="7a1c" class="nt nu it km b kn oc kr od lm oe ln of lo og lh ny nz oa ob bi translated">一旦过期，我们必须手动“取消设置”环境变量。在不保存过期日期的情况下，知道它是否已过期的唯一方法是在使用临时凭证运行其他AWS命令时收到一个指示过期的错误。</li></ol><p id="abba" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">从上面可以看出，在每组临时凭证生命周期的开始和结束时，这个过程变得很麻烦。</p><h2 id="eb8f" class="na lx it bd ly nb nc dn mc nd ne dp mg lm nf ng mk ln nh ni mo lo nj nk ms nl bi translated">文档方法2 —对命名配置文件使用临时凭据</h2><p id="69ce" class="pw-post-body-paragraph kj kk it km b kn nm kp kq kr nn kt ku lm no kx ky ln np lb lc lo nq lf lg lh im bi translated">第二种方法是将凭证保存为另一个名为概要文件的<a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html" rel="noopener ugc nofollow" target="_blank">。命名配置文件本质上是不同的凭证范围，您可以从中选择一个用于任何<code class="fe li lj lk ll b">awscli</code>命令。</a></p><p id="7b30" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">要保存凭证，您可以使用各种<code class="fe li lj lk ll b">awscli</code>命令。我刚开始用MFA用<code class="fe li lj lk ll b">awscli</code>的时候用的是<code class="fe li lj lk ll b">aws configure</code>，这是我已经很熟悉的东西了。如下所示:</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oh"><img src="../Images/aaed7123c4bce0aa2424c98b91800884.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UWe0LdnWRsMo5hXmbUFDBg.png"/></div></div></figure><p id="0d14" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">如果您比较<code class="fe li lj lk ll b">aws configure</code>的上述提示(关于可以为之前发布的临时凭证设置什么值),您可能会意识到它缺少一个“会话令牌”参数。对此的直接解决方案是编辑凭证文件<code class="fe li lj lk ll b">.aws/credentials</code>，并直接在中添加属性:</p><figure class="mv mw mx my gt ju"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="593d" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">一段时间后，我发现了另一种方法，那就是使用<code class="fe li lj lk ll b"><strong class="km iu">aws configure set aws_session_token “temp-session-token”</strong></code>。这允许我们直接绕过编辑凭证文件的步骤，将所有步骤本地化到CLI，使其稍微容易一些。</p><p id="319a" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">不管怎样，我觉得这个方法对我来说也没有达到目标，原因如下:</p><ol class=""><li id="25ad" class="nt nu it km b kn ko kr ks lm nv ln nw lo nx lh ny nz oa ob bi translated">每次需要使用时，我们仍然需要从web控制台手动检索序列号。</li><li id="df13" class="nt nu it km b kn oc kr od lm oe ln of lo og lh ny nz oa ob bi translated">我们仍然需要手动复制和粘贴临时凭证输出。</li><li id="1be4" class="nt nu it km b kn oc kr od lm oe ln of lo og lh ny nz oa ob bi translated">也不知道证书何时到期。只有当从<code class="fe li lj lk ll b">awscli</code>运行的某个命令返回错误时，我们才能知道检索凭证的整个过程必须重新进行。</li><li id="cbfb" class="nt nu it km b kn oc kr od lm oe ln of lo og lh ny nz oa ob bi translated">运行任何<code class="fe li lj lk ll b">awscli</code>命令都有一个额外的复杂性，您必须指出命名的概要文件。例如，要用默认概要文件描述EC2实例，您可以使用下面的命令— <code class="fe li lj lk ll b"><strong class="km iu">aws ec2 describe-instances</strong></code> <strong class="km iu"> </strong>。但是，要使用命名的概要文件，您必须为每个命令附加一个额外的概要文件标志— <code class="fe li lj lk ll b"><strong class="km iu">aws ec2 describe-instances --profile mfa-user</strong></code> <strong class="km iu"> </strong>。这在整个MFA过程中增加了另一个手动步骤。写入缺省配置文件是避免在每个命令中添加该标志的一种选择，但是会产生另一个问题，即您的常规用户凭证必须保存在另一个配置文件中。</li></ol></div><div class="ab cl lp lq hx lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="im in io ip iq"><h1 id="3de5" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">DevOps之路——“编写脚本”是我的出路</h1><p id="0d5d" class="pw-post-body-paragraph kj kk it km b kn nm kp kq kr nn kt ku lm no kx ky ln np lb lc lo nq lf lg lh im bi translated">由于我觉得上面提到的方法太麻烦，有太多的手工步骤，我试图找到一种更好的方法来解决这个问题。请注意，这些是我希望通过这一努力实现的目标:</p><ol class=""><li id="2b3b" class="nt nu it km b kn ko kr ks lm nv ln nw lo nx lh ny nz oa ob bi translated">自动化整个过程—用户只需输入MFA设备序列号和MFA六位令牌码。</li><li id="b7fa" class="nt nu it km b kn oc kr od lm oe ln of lo og lh ny nz oa ob bi translated">如果代码验证失败(非数字输入、多于或少于6位数字、代码过期等)，则重新提示用户键入新的MFA六位令牌代码。).我们也可以对MFA设备序列号进行同样的操作。</li><li id="7ccf" class="nt nu it km b kn oc kr od lm oe ln of lo og lh ny nz oa ob bi translated">这个过程应该基于每个代码库。然而，这些脚本也可以在系统层面上工作。</li><li id="fd7c" class="nt nu it km b kn oc kr od lm oe ln of lo og lh ny nz oa ob bi translated"><strong class="km iu">(可选)</strong>摘要<code class="fe li lj lk ll b">awscli</code>远离开发者。如果开发人员需要在他们的虚拟机中执行一些操作，如外壳操作，提供一个脚本或一些应用程序来允许他们这样做，而不需要服务提供商或底层工具的上下文。<strong class="km iu">移除上下文是有利的，因为它允许我们为所有工具维护一个公共接口，并且还允许关于如何使用它们的更简洁的文档</strong> <em class="kl">(减少上下文切换和出站工具文档引用)</em>。在多云环境中，这对开发人员造成的干扰较少，尤其是因为系统的基础设施不应该影响他们的日常工作。</li></ol><p id="1cf2" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">记住以上目标，让我们开始吧！</p><h2 id="ddf5" class="na lx it bd ly nb nc dn mc nd ne dp mg lm nf ng mk ln nh ni mo lo nj nk ms nl bi translated">串行代码——自动化的第一步</h2><p id="eca2" class="pw-post-body-paragraph kj kk it km b kn nm kp kq kr nn kt ku lm no kx ky ln np lb lc lo nq lf lg lh im bi translated">首先要自动化的是“注册”MFA设备序列号的过程。这将构成我的MFA过程的一部分，其中这将是一次性的步骤，并用于临时凭证的每个后续生成，而不是每次都必须加载AWS web控制台并检索该号码。</p><p id="129c" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">以下脚本是为执行此“注册”而创建的:</p><figure class="mv mw mx my gt ju"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="a8b6" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">从终端运行时，提示符如下所示:</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oi"><img src="../Images/b3245572e5885aa706c3fa245de7449b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BfQUmEXQtIwGRaeZXJkrvQ.png"/></div></div></figure><p id="b048" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">如果开发人员输入了错误的输入，如空字符串，将重复提示:</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oj"><img src="../Images/ba22f6e70a00fe34adf08aed5ce38900.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sNayims7mh7iUYGVzksIjA.png"/></div></div></figure><p id="7eef" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">输入有效字符串将完成该过程:</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ok"><img src="../Images/43a3974e03da0260e339c3e2369899c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZwIeA1co8vcNqsUsMh_JVQ.png"/></div></div></figure><h2 id="1788" class="na lx it bd ly nb nc dn mc nd ne dp mg lm nf ng mk ln nh ni mo lo nj nk ms nl bi translated">下一步，获取MFA——并在后台缓存它，直到它过期</h2><p id="3ef3" class="pw-post-body-paragraph kj kk it km b kn nm kp kq kr nn kt ku lm no kx ky ln np lb lc lo nq lf lg lh im bi translated">在我们处理了设置序列号的配置过程之后，下一步将是自动输入六位令牌码。临时凭证将以以下JSON格式返回:</p><pre class="mv mw mx my gt ol ll om on aw oo bi"><span id="f01d" class="na lx it ll b gy op oq l or os">{</span><span id="83db" class="na lx it ll b gy ot oq l or os">  "Credentials": {</span><span id="743c" class="na lx it ll b gy ot oq l or os">    "AccessKeyId": "REDACTED",</span><span id="5735" class="na lx it ll b gy ot oq l or os">    "SecretAccessKey": "REDACTED",</span><span id="81f3" class="na lx it ll b gy ot oq l or os">    "SessionToken": "REDACTED",</span><span id="8857" class="na lx it ll b gy ot oq l or os">    "Expiration": "2020-01-23T19:27:32Z"</span><span id="026a" class="na lx it ll b gy ot oq l or os">  }</span><span id="6eb9" class="na lx it ll b gy ot oq l or os">}</span></pre><p id="6214" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">有两种方法可以实现这种自动化。一种方法是提取除过期之外的所有属性，并将它们作为环境变量应用于下一个需要凭证的<code class="fe li lj lk ll b">awscli</code>命令。</p><p id="170a" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">我实现的第二种方法是将临时凭证缓存在一个文件中(和。如果保存在项目的上下文中，gitignored)包含到期时间戳。通过这样做，我能够在逻辑中编写脚本，以便在每次需要临时凭证时检查该文件，并仅在它过期时给出提示。</p><figure class="mv mw mx my gt ju"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="9ddd" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">使用上面的，我<a class="ae kf" href="https://bash.cyberciti.biz/guide/Source_command" rel="noopener ugc nofollow" target="_blank">“来源”</a>来自所有其他脚本的脚本，它象征着一个开发者可以执行的不同功能。一个这样的例子是能够通过SSH连接到虚拟机:</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ou"><img src="../Images/09ddec526bdcb95cf2ca75cf0c41143d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FiOYA1CjNDQ-QXVOx4vBnw.png"/></div></div></figure><p id="99ed" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">如果凭据没有保存在系统中，我们将提示用户键入MFA令牌码。但是，如果用户已经完成了上述操作，并且临时凭证尚未过期，则会发生以下情况:</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ov"><img src="../Images/e6de55b2c6041cdf5d0160ca9fee7b10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9y9ktnTZyuoX6NGAE2e8AA.png"/></div></div></figure></div><div class="ab cl lp lq hx lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="im in io ip iq"><h2 id="fe18" class="na lx it bd ly nb nc dn mc nd ne dp mg lm nf ng mk ln nh ni mo lo nj nk ms nl bi translated">摘要</h2><p id="d965" class="pw-post-body-paragraph kj kk it km b kn nm kp kq kr nn kt ku lm no kx ky ln np lb lc lo nq lf lg lh im bi translated">通过执行上述操作，我能够将一个包含多个手动步骤的流程简化为一个包含一次性配置步骤的流程，以及一个仅在没有有效凭据时发生的定期MFA步骤。对于使用这些脚本的每个开发人员来说，这有助于减少计算每个命令上下文的时间，然后是复制+粘贴。</p><p id="d07d" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated">再见。</p></div><div class="ab cl lp lq hx lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="im in io ip iq"><p id="a954" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg lh im bi translated"><strong class="km iu">旁注:</strong>你可能也已经意识到我在使用<a class="ae kf" href="https://docs.npmjs.com/misc/scripts" rel="noopener ugc nofollow" target="_blank"> npm脚本</a>，为开发者提供不同功能的接口。这种集成所做的只是提供一个公共接口来调用实际的shell脚本。您也可以这样做，或者使用makefile来创建一个公共接口供所有人使用。</p></div></div>    
</body>
</html>