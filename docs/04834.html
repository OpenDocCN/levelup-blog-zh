<html>
<head>
<title>Creating a Lambda Layer via Docker: Python + Layers + Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Docker创建Lambda层:Python + Layers + Docker</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/creating-a-lambda-layer-via-docker-python-layers-docker-e4e318717822?source=collection_archive---------2-----------------------#2020-07-19">https://levelup.gitconnected.com/creating-a-lambda-layer-via-docker-python-layers-docker-e4e318717822?source=collection_archive---------2-----------------------#2020-07-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f70a152c6b06109982a1b702b0d0db20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vi2A8ouswb61c9WNhc1WDg.png"/></div></div></figure><h1 id="00f2" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">序言</h1><p id="c6d4" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">如果你读过<a class="ae lx" rel="noopener ugc nofollow" target="_blank" href="/deploying-to-aws-lambda-python-layers-cloudwatch-31c4119d3a69">Deploying to AWS Lambda:Python+Layers+cloud watch</a>，我们在RHEL8 EC2实例上创建了我们的Lambda Layer zip。请注意，我们这样做是因为我们需要在Linux操作系统上安装软件包，而不是我所在的Mac OS。如果您使用Linux，您可能不需要使用Docker或EC2实例，只需在本地安装和压缩即可。在本文的剩余部分，我们将假设您没有使用Linux操作系统。因此，如果您不想启动EC2实例，另一种创建zip的方法是通过Docker。</p><p id="d51d" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">对于这篇文章来说，一些关于Docker、Bash和Python的基础知识是一个先决条件，但是也许你仍然能够跟上。</p><h1 id="6eb3" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">步骤0:安装Docker</h1><p id="2c02" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">我将在Mac OS上继续这个教程，但是我认为即使你不在Mac OS上，这篇文章仍然应该给你指出正确的方向。</p><p id="0f69" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">继续在你的机器上安装Docker 。</p><h1 id="7cc5" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">步骤1:创建Dockerfile</h1><p id="a311" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">一旦您能够验证您已经正确安装了它，选择您本地机器上的任何目录来创建我们的包。例如，在我的Macbook上，我将在<code class="fe md me mf mg b">/Users/Nakul/Documents/Docker</code>中创建图层。现在，在这个目录中，我们将创建一个Dockerfile——为此，只需用<code class="fe md me mf mg b">vi Dockerfile</code>创建一个名为docker file的文件。</p><p id="4c0f" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">在这个Dockerfile文件中，我们将输入以下内容:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="83e2" class="mp kc it mg b gy mq mr l ms mt">FROM amazonlinux:2.0.20200602.0</span><span id="ab4e" class="mp kc it mg b gy mu mr l ms mt">RUN yum update -y</span><span id="70eb" class="mp kc it mg b gy mu mr l ms mt">RUN yum install -y \</span><span id="2dae" class="mp kc it mg b gy mu mr l ms mt">python3-pip \</span><span id="f007" class="mp kc it mg b gy mu mr l ms mt">zip \</span><span id="1533" class="mp kc it mg b gy mu mr l ms mt">RUN yum -y clean all</span><span id="1a5a" class="mp kc it mg b gy mu mr l ms mt">RUN python3.7 -m pip install --upgrade pip</span></pre><p id="4e4d" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">保存文件。</p><p id="52cd" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">我们不想也不需要在这个docker文件中做太多。FROM命令简单地指定了我们想要从Docker hub下载哪个映像，我们只想要任何Linux发行版，所以我选择了Amazon Linux(你也可以选择Debian，等等)。你看到的标签来自Docker hub上的亚马逊官方Linux页面。</p><p id="df3a" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">现在，一旦我们完成了这些，我们想要确保一旦我们构建并运行了这个映像，我们就可以安装我们的Python库，所以我们需要运行几个命令。您在上面看到的命令类似于您可能在EC2实例上运行的命令。</p><p id="88b0" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">参见本文末尾的参考资料，了解YUM和YUM命令。</p><h1 id="4c93" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">步骤2:构建并运行Docker映像</h1><p id="c8cf" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">现在，在该目录中，键入</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="f73c" class="mp kc it mg b gy mq mr l ms mt">docker build -t amzlinuxpy37 .</span></pre><p id="d3db" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">然后按回车键。这将从我们刚刚编写的Dockerfile文件构建图像(并且还将<em class="mv">标记</em>为amzlinuxpy37)。</p><p id="1c21" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">现在，要运行Docker映像，在同一个目录(<code class="fe md me mf mg b">/Docker</code>)中，键入</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="9c31" class="mp kc it mg b gy mq mr l ms mt">docker run -it amzlinuxpy37 bash</span></pre><p id="575e" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">我们在这里所做的是运行一个基于我们通过目录中的docker文件构建的映像的容器。<code class="fe md me mf mg b">-it</code>是为了标记我们想要立即打开一个交互式shell——所以您会看到命令提示符显示<code class="fe md me mf mg b">bash-4.2#</code>或类似的内容。</p><p id="d64b" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">你可以运行一个<code class="fe md me mf mg b">ls</code>来看看我们有什么目录，但是我们不会去打扰他们。我在容器的home ( <code class="fe md me mf mg b">/</code>)目录中做了一个名为<code class="fe md me mf mg b">layer_dir</code>的目录。我建议你也这样做，这样你就不会被顶层目录中的所有子目录分散注意力。</p><p id="0c57" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">接下来，只需用一个<code class="fe md me mf mg b">cd layer_dir</code>命令输入该目录。</p><h1 id="f541" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">步骤3:安装Python模块</h1><p id="35a8" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">现在，这里是我们构建包含所有模块的包的地方。由于除了创建Lambda层之外，我们不会将该容器用于任何其他用途，因此并不强制使用虚拟环境(但是请注意，在大多数情况下，这样做是一种最佳实践，可以保持项目依赖性的隔离和完整)。</p><p id="be77" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">考虑到这一点，我们应该停下来，想想我们为什么会在这个容器里。我们希望安装Python模块并将其压缩，这样我们就可以将压缩文件作为Lambda层上传。</p><p id="04f7" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">如果你<a class="ae lx" rel="noopener ugc nofollow" target="_blank" href="/deploying-to-aws-lambda-python-layers-cloudwatch-31c4119d3a69">读过我的Lambda Layers帖子</a>或者仔细阅读过<a class="ae lx" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html#configuration-layers-path" rel="noopener ugc nofollow" target="_blank"> AWS文档</a>，你会注意到为了让AWS理解我们的包，模块必须要么安装在<code class="fe md me mf mg b">python/*module installed here*</code>要么安装在<code class="fe md me mf mg b">python/lib/python3.x/site-packages/*module installed here*</code>中。</p><p id="1160" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">这里最快的(但不是唯一的)方法是用<code class="fe md me mf mg b">mkdir python</code>创建一个python目录。</p><p id="9c00" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">所以现在我们在容器上的目录结构应该是这样的:<code class="fe md me mf mg b">/layer_dir/python</code>。</p><p id="331b" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">我们可以留在<code class="fe md me mf mg b">layer_dir</code>中，用下面的命令将一个包直接安装到<code class="fe md me mf mg b">python</code>子目录中:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="225f" class="mp kc it mg b gy mq mr l ms mt">pip3 install requests -t /layer_dir/python</span></pre><p id="6b40" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">如果您导航到<code class="fe md me mf mg b">python</code>文件夹，您应该看到<code class="fe md me mf mg b">requests</code>和安装的相关模块。现在回到<code class="fe md me mf mg b">layer_dir</code>，让我们继续并压缩<code class="fe md me mf mg b">python</code>目录(当然，如果你有更多要安装的，继续，这只是一个简单的教程)。</p><p id="4047" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">运行以下命令:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="217b" class="mp kc it mg b gy mq mr l ms mt">zip -r docker_layer.zip .</span></pre><p id="38a2" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><code class="fe md me mf mg b">docker_layer.zip</code>参数可以更改为任何东西，它只是zip的名称。<code class="fe md me mf mg b">.</code>将压缩我们所在目录中的所有内容。因为我们在<code class="fe md me mf mg b">layer_dir</code>中，其中唯一的项目是<code class="fe md me mf mg b">python</code>子目录，这就是将要压缩的内容(所以当你上传zip文件时，顶层目录是<strong class="lb iu"> python </strong>)。</p><p id="0951" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">如果你在<code class="fe md me mf mg b">layer_dir,</code>中<code class="fe md me mf mg b">ls</code>，你会看到zip文件和<code class="fe md me mf mg b">python</code>子目录在同一层。您也可以用路径修改<code class="fe md me mf mg b">docker_layer.zip</code>,但是我们不关心zip位于哪里，只要我们有它就行。</p><p id="e1a9" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">好的，那么我们如何把这个压缩文件放到我们的本地机器上以便上传呢？</p><h1 id="becf" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">步骤4:将Zip从容器复制到本地机器</h1><p id="2d33" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated"><strong class="lb iu">打开另一个终端窗口</strong>，导航到你的Dockerfile所在的目录(对于我:<code class="fe md me mf mg b">Users/Nakul/Documents/Docker</code>)。</p><p id="1dee" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">在这里，我们将运行docker copy命令。</p><p id="6a48" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">基本语法如下:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="46c6" class="mp kc it mg b gy mq mr l ms mt">docker cp &lt;container ID&gt;:*source_path* *destination_path*</span></pre><p id="89f2" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">对我来说，那将是:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="d78c" class="mp kc it mg b gy mq mr l ms mt">docker cp &lt;container ID&gt;:/layer_dir/docker_layer.zip ./</span></pre><p id="beba" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">您必须使用容器ID，而不是图像标签。要获得容器ID，只需运行<code class="fe md me mf mg b">docker ps</code>列出所有正在运行的实例，然后复制/粘贴文本(如果您停留在另一个终端窗口——仍然在您的容器中——这个命令就不会起作用)。</p><p id="d5b1" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><code class="fe md me mf mg b">./</code>仅仅意味着目标路径将是我们已经在的目录。</p><p id="604f" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">运行该命令后，zip文件应该出现在您的本地目录中，如果您解压缩它，请随意仔细检查，顶级目录是<strong class="lb iu"> python。</strong>如果是，那太好了！</p><p id="2350" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">我不会深入研究如何实际上传图层并将其附加到Lambda函数，因为在后面的文章中已经介绍过了。</p><p id="03d9" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">但是，嘿，下次你需要上传一个层，你不需要旋转EC2实例，你可以在Docker中创建你的层！</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="26c1" class="kb kc it bd kd ke nd kg kh ki ne kk kl km nf ko kp kq ng ks kt ku nh kw kx ky bi translated">参考</h1><p id="796a" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated"><a class="ae lx" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank">安装对接器</a></p><p id="686d" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><a class="ae lx" href="https://hub.docker.com/_/amazonlinux" rel="noopener ugc nofollow" target="_blank">亚马逊Linux Docker图片</a></p><p id="7e88" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><a class="ae lx" href="https://en.wikipedia.org/wiki/Yum_(software)" rel="noopener ugc nofollow" target="_blank">什么是百胜？</a></p><p id="3d11" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><a class="ae lx" href="https://access.redhat.com/sites/default/files/attachments/rh_yum_cheatsheet_1214_jcs_print-1.pdf" rel="noopener ugc nofollow" target="_blank">百胜命令备忘单</a></p><p id="4b20" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><a class="ae lx" href="https://docker-curriculum.com/?utm_content=buffer1c144&amp;utm_medium=social&amp;utm_source=twitter.com&amp;utm_campaign=buffer#docker-images" rel="noopener ugc nofollow" target="_blank">码头工人基础知识</a></p><p id="7d67" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><a class="ae lx" href="https://stackify.com/docker-build-a-beginners-guide-to-building-docker-images/" rel="noopener ugc nofollow" target="_blank"> Docker Build:构建Docker图像的初学者指南</a></p><p id="c98f" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><a class="ae lx" href="https://stackify.com/docker-image-vs-container-everything-you-need-to-know/" rel="noopener ugc nofollow" target="_blank">码头工人图像vs集装箱:你需要知道的一切</a></p><p id="e4ef" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><a class="ae lx" rel="noopener ugc nofollow" target="_blank" href="/deploying-to-aws-lambda-python-layers-cloudwatch-31c4119d3a69">部署到AWS Lambda:Python+Layers+cloud watch</a></p><p id="6290" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated"><a class="ae lx" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html" rel="noopener ugc nofollow" target="_blank">λ层目录结构</a></p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><p id="f9fd" class="pw-post-body-paragraph kz la it lb b lc ly le lf lg lz li lj lk ma lm ln lo mb lq lr ls mc lu lv lw im bi translated">注意:Docker的官方文档非常广泛——如果你想继续使用Docker，最好的方法是通过谷歌搜索你想完成的事情。希望这篇文章是使用Docker的良好开端。</p><h2 id="e60d" class="mp kc it bd kd ni nj dn kh nk nl dp kl lk nm nn kp lo no np kt ls nq nr kx ns bi translated">感谢阅读！</h2></div></div>    
</body>
</html>