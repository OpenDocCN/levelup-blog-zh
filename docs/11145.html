<html>
<head>
<title>Serverless Python Bot using Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用谷歌云平台的无服务器Python Bot</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/serverless-python-bot-using-google-cloud-platform-ee724f4a6b1f?source=collection_archive---------1-----------------------#2022-02-19">https://levelup.gitconnected.com/serverless-python-bot-using-google-cloud-platform-ee724f4a6b1f?source=collection_archive---------1-----------------------#2022-02-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="46b8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">分步教程:从API到数据库</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9d208775396fdc1d9f75ea24e3089bfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CGi6XG4SF_OK77f9.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">(插图由<a class="ae ky" href="https://medium.com/@chaeyunkim" rel="noopener">金彩云</a>绘制)</figcaption></figure><p id="158c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用Python脚本作为提取、转换、加载数据的工具已经变得很普遍。为了正确地自动化Python脚本并作为“刮刀/机器人”运行，我们需要一种方法让它们在适当的时间自动执行。实现这种自动化的一个简单方法可能是在本地运行，但这意味着你必须一直打开你的电脑。</p><p id="ab98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，这不是唯一的方法。本文将向您展示一种使用Google平台的无服务器方法，特别是“Google Cloud Function”和“Google Cloud Scheduler”来自动化您的Python脚本。</p><h1 id="63d5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">循序渐进的教程</h1><h2 id="ef0b" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">用例:定期将天气数据存储到数据库中</h2><p id="db34" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated"><em class="ne">了解平均天气数据可以显示模式和趋势，并帮助研究人员弄清楚我们的大气是如何工作的。示例数据包括温度、风速、雨水、湿度和压力。</em></p><h2 id="0205" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">步骤0:理解结构</h2><p id="3401" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">在本例中，开源天气数据将使用无服务器方法保存到数据库中。Python脚本用于从OpenWeatherMap API请求(HTTP GET)数据，然后将其更新到PostgreSQL数据库。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/473e2c9f22c532a4d197548f64e24ef9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wNnxQawfmAIxjuKR6lqAWg.png"/></div></div></figure><p id="34e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">A —数据来源:<a class="ae ky" href="https://home.openweathermap.org/" rel="noopener ugc nofollow" target="_blank"> OpenWeatherMap API </a></p><p id="c3f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">B — Python流程:<a class="ae ky" href="https://cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">谷歌云功能</a></p><p id="6fd6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">C—作业调度:<a class="ae ky" href="https://cloud.google.com/scheduler" rel="noopener ugc nofollow" target="_blank">谷歌云调度</a></p><p id="39b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">D—数据库:<a class="ae ky" href="https://elements.heroku.com/addons/heroku-postgresql" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a></p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h2 id="0961" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">步骤1:准备Python脚本</h2><p id="68dd" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">我们可以创建一个简单的Python脚本，如下例所示。您可以根据您的数据集和数据库凭证进行跟踪和调整。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><ul class=""><li id="4245" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">第[5–9]行:将数据从API加载到Dataframe</li><li id="f2f9" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">第[11–17]行:连接到数据库</li><li id="81d6" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">行[20]:将数据帧发布到数据库</li></ul><p id="d0e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">提示:在进入下一步之前，不要忘记测试您的Python脚本。为此，您也可以使用<a class="ae ky" href="https://colab.research.google.com/" rel="noopener ugc nofollow" target="_blank">扳手</a>。</p><h2 id="64a4" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">第二步:上传Python脚本到谷歌云功能</h2><p id="cbf1" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">在将Python脚本上传到Google Cloud之前，如果你还没有帐户，你必须注册一个帐户。然后，在API <a class="ae ky" href="https://console.cloud.google.com/apis/dashboard" rel="noopener ugc nofollow" target="_blank">仪表板</a>创建一个项目并激活云构建/云功能/云调度器API。之后，前往云<a class="ae ky" href="https://console.cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">功能</a>，点击创建功能。选择您认为合适的功能名称和区域。</p><p id="cf85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">触发设置</strong>:这是您的功能被触发运行的方式。大多数教程将显示“HTTP”作为一个例子，但我宁愿推荐Cloud Pub/Sub，因为我们将安排它在Google Cloud中定期运行，稍后我们将使用Google Cloud Scheduler来执行此操作。通过选择云发布/订阅，系统将提示您创建或选择主题。如果这是您的第一个功能，只需创建一个新主题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/5ff647edcd0db8c40f1d974c15c3e9ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UxYFwBUtc6jz0E8XGBgpwQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</figcaption></figure><p id="a842" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以将其他设置保留为默认设置。在下一页，您可以选择运行时为“Python 3.8”或“Python 3.9”。将您的脚本复制并粘贴到main.py中，确保您的函数名与入口点名匹配。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/ba2a0ba19cd1157d68706b58f2a1409a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ltrik3SrulMCF4jcqL7cQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">在谷歌云功能上部署Python脚本(作者)</figcaption></figure><p id="8c6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在“requirements.txt”中输入脚本的所有依赖项。在我们的例子中，这些都是需求:</p><pre class="kj kk kl km gt of og oh oi aw oj bi"><span id="85f4" class="mn lw it og b gy ok ol l om on"><strong class="og iu">requests&gt;=2.23.0<br/>pandas&gt;=1.3.5<br/>sqlalchemy&gt;=1.4.31<br/>datetime&gt;=4.4<br/>psycopg2&gt;=2.8.6</strong></span></pre><p id="3ff3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击“部署”后，进入云<a class="ae ky" href="https://console.cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">功能</a>列表，您可以看到我们的功能正在显示。等到绿色按钮出现，表示所有依赖项都已安装。单击action- &gt; test，然后单击action- &gt; views logs，查看我们的函数是否成功运行，没有出现错误。</p><p id="23d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，您可以查询数据库来检查是否有新数据被更新。</p><h2 id="31b5" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">第三步:安排你的活动</h2><p id="c6f7" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">前往Google Cloud <a class="ae ky" href="https://console.cloud.google.com/cloudscheduler" rel="noopener ugc nofollow" target="_blank"> Scheduler </a>使用Pub/Sub定期触发您的功能。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/3f4a8b4ebbf33c46c1e655ba2e0480f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IGwiIZQDghftY6za-DEBVg.png"/></div></div></figure><p id="733b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">频率</strong>:指定以Unix-cron格式运行python脚本的频率。你可以使用<a class="ae ky" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank">https://crontab.guru/</a>来帮助构建cron频率。</p><p id="2267" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">发布/订阅主题</strong>:选择我们构建云函数时在步骤2中创建的主题。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><p id="f4a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就这样，现在您的Python脚本已经准备好并运行在GCP的云架构上了！</p><h2 id="4dca" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">结果</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/fa86ba14c775ffdade5ffcca1defbbc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BC120wXkTmL_wA6wj3NB5w.jpeg"/></div></div></figure><h2 id="41f3" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">未来改进</h2><p id="932d" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">这个例子只是为了展示如何使用谷歌云功能的整体过程，还有待改进的地方，如</p><ul class=""><li id="4852" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">在第二步中，您可以添加数据库凭证作为环境变量。</li><li id="719f" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">在Python中通过请求加载数据之后，建议在将数据存储到数据库之前进行数据清理。</li><li id="70a1" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">必须打开数据库端口，Google Cloud功能才能访问。您可能需要为云功能应用静态IP来提高数据库安全性。</li></ul><h2 id="f98d" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">成本呢？</h2><p id="e705" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">根据<a class="ae ky" href="https://cloud.google.com/pubsub/pricing#pubsub-pricing" rel="noopener ugc nofollow" target="_blank"> GCP </a>的说法，云功能为计算时间资源提供了一个永久的免费层，其中包括GB秒和GHz秒的分配。除了200万次调用之外，免费层每月还提供400，000 GB秒、200，000 GHz秒的计算时间和5GB的互联网出口流量。我们今天的例子是一个非常简单的过程，当然没有成本。</p><h2 id="0baa" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated"><strong class="ak">另类？</strong></h2><p id="d6b3" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">是的，有几个选项，我之前已经详细介绍过了。</p><ul class=""><li id="d4ac" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">使用<a class="ae ky" href="https://towardsdatascience.com/serverless-covid-19-data-scraper-with-python-and-aws-lambda-d6789a551b78" rel="noopener" target="_blank"> AWS Lambda </a>运行你的python机器人。</li></ul><div class="oq or gp gr os ot"><a href="https://towardsdatascience.com/serverless-covid-19-data-scraper-with-python-and-aws-lambda-d6789a551b78" rel="noopener follow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd iu gy z fp oy fr fs oz fu fw is bi translated">使用Python和AWS Lambda的无服务器新冠肺炎数据刮刀</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">分步教程:使用AWS Lambda调度Python脚本</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">towardsdatascience.com</p></div></div><div class="pc l"><div class="pd l pe pf pg pc ph ks ot"/></div></div></a></div><ul class=""><li id="3ab6" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">从Oracle Cloud 获得一个免费的VPS，并在您的服务器上定期运行<a class="ae ky" href="https://towardsdatascience.com/automate-your-python-script-with-pm2-463238ea0b65" rel="noopener" target="_blank"> Python Bot。</a></li></ul><div class="oq or gp gr os ot"><a href="https://towardsdatascience.com/automate-your-python-script-with-pm2-463238ea0b65" rel="noopener follow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd iu gy z fp oy fr fs oz fu fw is bi translated">用PM2自动化你的Python脚本</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">以新冠肺炎数据收集为例的分步指南</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">towardsdatascience.com</p></div></div><div class="pc l"><div class="pi l pe pf pg pc ph ks ot"/></div></div></a></div><div class="oq or gp gr os ot"><a rel="noopener  ugc nofollow" target="_blank" href="/a-powerful-server-from-oracle-cloud-always-free-cbc73d9fbfee"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd iu gy z fp oy fr fs oz fu fw is bi translated">来自Oracle Cloud的强大服务器—永远免费</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">4个CPUs | 24 GB内存🚀</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="pc l"><div class="pj l pe pf pg pc ph ks ot"/></div></div></a></div><p id="f80e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你喜欢这篇文章，并发现它对你的日常工作或项目有用。如果你有任何问题，请随时联系我。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><p id="35e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ne">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://medium.com/@joets/membership" rel="noopener"> <em class="ne">中等会员</em> </a> <em class="ne">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="oq or gp gr os ot"><a href="https://medium.com/@joets/membership" rel="noopener follow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd iu gy z fp oy fr fs oz fu fw is bi translated">通过我的推荐链接加入Medium-Joe t . Santhanavanich</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">medium.com</p></div></div><div class="pc l"><div class="pk l pe pf pg pc ph ks ot"/></div></div></a></div></div></div>    
</body>
</html>