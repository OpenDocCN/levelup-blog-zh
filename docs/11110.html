<html>
<head>
<title>Nginx: Automate Whitelists</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Nginx:自动化白名单</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/nginx-automatic-googlebot-whitelist-f1eca79adcd5?source=collection_archive---------12-----------------------#2022-02-16">https://levelup.gitconnected.com/nginx-automatic-googlebot-whitelist-f1eca79adcd5?source=collection_archive---------12-----------------------#2022-02-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/02e4072779ee00cd9f270ed23ff18821.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZugSB-GwDwo3Onvf"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@rajeshwerbatchu7?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Rajeshwar Bachu </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="f09e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在nginx配置中添加速率限制或分流规则是应对滥用或恶意bot流量的好方法。然而，当一个好的机器人陷入规则中时，SEO的价值就会下降，并且在它们被列入白名单之前，处理起来会很痛苦。</p><h1 id="1e01" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">供应商CIDR街区</h1><p id="2637" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">许多知名厂商会发布并定期更新IP地址阻止列表，或CIDR阻止列表，这些列表可用于更新白名单规则。比如谷歌在这里发布了这样一个列表:<br/><a class="ae kc" href="https://developers.google.com/search/apis/ipranges/googlebot.json" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/search/APIs/IP ranges/Google bot . JSON</a></p><p id="0ea6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于将谷歌列入白名单的完整指南可以在这里找到:<br/><a class="ae kc" href="https://developers.google.com/search/docs/advanced/crawling/verifying-googlebot" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/search/docs/advanced/crawling/vericking-Google bot</a></p><p id="a2d6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于本教程，googlebot列表将用于创建流程。</p><h1 id="3d83" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">重载方法—开源Nginx</h1><blockquote class="me mf mg"><p id="8d58" class="kd ke mh kf b kg kh ki kj kk kl km kn mi kp kq kr mj kt ku kv mk kx ky kz la ij bi translated">如果使用Nginx Plus，请参见本节下面的KeyVal方法。</p></blockquote><p id="8234" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果正在使用nginx的开源版本，创建一个脚本来生成一个包含map变量的nginx配置文件。nginx地图对比帖子提供了关于Nginx地图的信息。</p><p id="f6a5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">curl实用程序将用于检索解析列表。如果发布的列表是像Googlebot列表那样的json格式，那么可以使用<a class="ae kc" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> jq </strong> </a>实用程序将json解析成可用的格式。</p><p id="a8d7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">脚本:</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h2 id="de30" class="mr lc iq bd ld ms mt dn lh mu mv dp ll ko mw mx lp ks my mz lt kw na nb lx nc bi translated">脚本变量</h2><p id="872b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">有两个变量可以更新以满足目标环境的需求。</p><p id="48e8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nd ne nf ng b"><strong class="kf ir">GOOGLE_WHITELIST_CONF</strong></code></p><p id="d0d2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将此设置为应该写入配置文件的绝对路径。如果使用了默认的nginx配置，默认情况下会自动包含<code class="fe nd ne nf ng b"><strong class="kf ir">/etc/nginx/conf.d</strong></code>下的<code class="fe nd ne nf ng b"><strong class="kf ir">*.conf</strong></code>文件。最好将文件放在包含include <code class="fe nd ne nf ng b"><strong class="kf ir">conf.d/*.conf;</strong></code>指令的文件夹中。</p><p id="62da" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nd ne nf ng b"><strong class="kf ir">RELOAD_CMD</strong></code></p><p id="1827" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">更新该值以匹配重新加载nginx配置所需的命令。这将确保地图的任何更新都被激活。</p><h2 id="b590" class="mr lc iq bd ld ms mt dn lh mu mv dp ll ko mw mx lp ks my mz lt kw na nb lx nc bi translated">属国</h2><p id="483e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">运行脚本需要两个二进制依赖关系:<strong class="kf ir"> curl </strong>和<strong class="kf ir"> jq </strong>。确保在运行该脚本的系统上安装了这些程序。</p><h2 id="608b" class="mr lc iq bd ld ms mt dn lh mu mv dp ll ko mw mx lp ks my mz lt kw na nb lx nc bi translated">从语法上分析</h2><p id="777b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Googlebot列表的json格式允许进行简单的解析，以获取用双引号括起来的IP地址块。提取所有通过管道传输到<code class="fe nd ne nf ng b">.[]</code>的<code class="fe nd ne nf ng b">.prefixes[]</code>将输出所需的值。将它包装在一个<code class="fe nd ne nf ng b">while read</code>循环中可以格式化这些值。</p><h2 id="f2f5" class="mr lc iq bd ld ms mt dn lh mu mv dp ll ko mw mx lp ks my mz lt kw na nb lx nc bi translated">计划脚本</h2><p id="3de0" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">可以将该脚本添加到需要更新白名单的每个webtier主机上的crontab中，也可以从每个webtier主机上的CI/CD系统中运行该脚本来更新环境。白名单应该定期更新，一天一次可能很好，或者一天几次，以避免访问间隙，这取决于白名单中的源的变化。</p><h2 id="fa41" class="mr lc iq bd ld ms mt dn lh mu mv dp ll ko mw mx lp ks my mz lt kw na nb lx nc bi translated">配置文件解释</h2><p id="42cb" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">脚本创建的nginx映射使用<code class="fe nd ne nf ng b"><strong class="kf ir">$remote_addr</strong></code>作为源变量，并使用“geo”映射配置进行IP地址比较:</p><p id="c231" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nd ne nf ng b">geo $remote_addr $is_google { … }</code></p><blockquote class="me mf mg"><p id="09e3" class="kd ke mh kf b kg kh ki kj kk kl km kn mi kp kq kr mj kt ku kv mk kx ky kz la ij bi translated">默认情况下，geo map使用$remote_addr，在定义中不需要。为了完整起见，在示例中进行了设置。</p></blockquote><p id="7eef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">判断环境中的<code class="fe nd ne nf ng b"><strong class="kf ir">$remote_addr</strong></code>是什么的一个简单方法是记录它，并使用Googlebot用户代理检查来自请求的客户机IP地址值。如果remote_addr是私有IP或设置为防火墙、负载平衡器或CDN IP地址，则需要一个保存正确IP的不同变量。可能需要在geo map中设置代理配置或为环境配置realip实施，以可靠地获得此值。</p><blockquote class="me mf mg"><p id="d78f" class="kd ke mh kf b kg kh ki kj kk kl km kn mi kp kq kr mj kt ku kv mk kx ky kz la ij bi translated">如果$remote_addr包含意外的ip地址，则<a class="ae kc" href="http://nginx.org/en/docs/http/ngx_http_geo_module.html" rel="noopener ugc nofollow" target="_blank"> ngx_http_geo_module </a>或<a class="ae kc" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html" rel="noopener ugc nofollow" target="_blank"> ngx_http_realip_module </a>具有如何获取正确IP地址的信息。</p></blockquote><p id="f9c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">地理地图输出格式应如下所示:</p><pre class="ml mm mn mo gt nh ng ni nj aw nk bi"><span id="22c8" class="mr lc iq ng b gy nl nm l nn no">geo $remote_addr $is_google {<br/>…<br/>  "66.249.72.224/27"          1;<br/>…<br/>  default                     0;<br/>}</span></pre><h1 id="cdcd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用</h1><p id="a99b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><code class="fe nd ne nf ng b"><strong class="kf ir">$is_google</strong></code> geo map变量可以用在白名单中。创建白名单的一个好方法是构建一系列映射来形成一个<code class="fe nd ne nf ng b"><strong class="kf ir">$whitelist</strong></code>映射变量。以下是如何建立这种白名单的示例:</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="b7c7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由此产生的$whitelist变量可以用在排除规则中，或者作为其他变量或指令中的标志，以确保只对非白名单请求执行操作，反之亦然。</p><h1 id="d27e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">KeyVal方法— Nginx Plus版本</h1><p id="72b0" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果正在使用Nginx Plus，Nginx Plus可以使用keyval处理实时更新，而不需要更新配置和重新加载所有nginx webtier实例，而不是更新文件和重新加载配置。</p><blockquote class="me mf mg"><p id="a9fe" class="kd ke mh kf b kg kh ki kj kk kl km kn mi kp kq kr mj kt ku kv mk kx ky kz la ij bi translated">Nginx Plus配置中建议使用<a class="ae kc" href="https://docs.nginx.com/nginx/admin-guide/high-availability/zone_sync/" rel="noopener ugc nofollow" target="_blank"> zone_sync流配置</a>，否则需要在每个实例上运行脚本来为所有Nginx实例设置keyval数据。</p></blockquote><h2 id="be99" class="mr lc iq bd ld ms mt dn lh mu mv dp ll ko mw mx lp ks my mz lt kw na nb lx nc bi translated">KeyVal和流</h2><p id="ff34" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">本例中保存Googlebot IP地址的keyval配置使用了一个<code class="fe nd ne nf ng b">stream</code>配置来启用keyval数据同步。这个例子使用DNS解析来通知nginx集群中所有nginx实例的IP地址，但是如果需要的话，这可以调整为具有单独的nginx服务器实例。有关指南，请参见zone_sync_server 的<a class="ae kc" href="http://nginx.org/en/docs/stream/ngx_stream_zone_sync_module.html#zone_sync_server" rel="noopener ugc nofollow" target="_blank">文档。</a></p><p id="0dd0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">keyval_zone配置有10年的TTL，这是一个用于完全重启时恢复的状态文件，并且设置为类型<code class="fe nd ne nf ng b"><strong class="kf ir">ip</strong></code>，以便与CIDR块进行IP地址比较。如果有匹配，<code class="fe nd ne nf ng b"><strong class="kf ir">$is_google</strong></code>将被设置为“1”。</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="156f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">reload方法中的whitelist.conf文件将使用这种方法:</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h2 id="d9b9" class="mr lc iq bd ld ms mt dn lh mu mv dp ll ko mw mx lp ks my mz lt kw na nb lx nc bi translated">脚本</h2><p id="bd72" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">下面是更新keyval内存区域的脚本。如果nginx集群没有使用流配置进行数据同步，那么脚本将需要针对所有单独的nginx实例运行。建议使用zone_sync配置来简化共享数据的nginx操作。该脚本是为bash 3.x或更高版本编写的，它要求在脚本中设置或更新以下变量:</p><pre class="ml mm mn mo gt nh ng ni nj aw nk bi"><span id="6482" class="mr lc iq ng b gy nl nm l nn no">NGINX_CLUSTER_API_SCHEME - set to http or https (default)<br/>NGINX_CLUSTER_API_SERVER - set to an nginx ip or internal DNS<br/>NGINX_CLUSTER_API_PORT   - set to port number for the enabled API</span></pre><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="0831" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据需要，可以在构建作业中克隆或调度该脚本。</p><p id="fa2e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">祝你好运！</p></div></div>    
</body>
</html>