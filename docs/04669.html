<html>
<head>
<title>Kong API Security in Kubernetes with API Key and JWT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">孔API安全在Kubernetes与API密钥和JWT</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/kong-api-security-in-kubernetes-with-api-key-and-jwt-17985135a1a6?source=collection_archive---------18-----------------------#2020-07-08">https://levelup.gitconnected.com/kong-api-security-in-kubernetes-with-api-key-and-jwt-17985135a1a6?source=collection_archive---------18-----------------------#2020-07-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/849c431c5f5a8e3c4e07324bb65333cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LtL4C-8zLprY0ZyZ.png"/></div></div></figure><p id="1954" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://medium.com/@lightphos/kong-api-gateway-with-kubernetes-a1dab930a5ba" rel="noopener">以前</a>我们在Kubernetes建立了Kong和Konga。然后，我们将vadal-echo服务部署到K8s。现在，我们来看看如何保护对该服务的访问。</p><h1 id="9ce1" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">密钥认证</h1><p id="7f20" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Kong提供给我们的一个机制是Key-Auth插件。</p><p id="0754" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在下面的代码中，我们添加了插件(key-auth)，一个消费者，以及一个用于该消费者的秘密密钥“secret key”。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="c475" class="mj ky iq mf b gy mk ml l mm mn">echo "<br/>apiVersion: configuration.konghq.com/v1<br/>kind: KongPlugin<br/>metadata:<br/>  name: http-auth<br/>plugin: key-auth<br/><br/>---<br/>apiVersion: configuration.konghq.com/v1<br/>kind: KongConsumer<br/>metadata:<br/>  name: vadal<br/>username: vadal<br/><br/>---<br/>apiVersion: configuration.konghq.com/v1<br/>kind: KongCredential<br/>metadata:<br/>  name: vadalcred<br/>consumerRef: vadal<br/>type: key-auth<br/>config:<br/>  key: secretkey<br/>" | kubectl apply -f -</span></pre><p id="5e41" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行上面的。</p><p id="17ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我们将key-auth插件添加到vadal-echo的ingres中，由元数据名称http-auth引用。</p><p id="4fb2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将您的主机IP添加到/etc/host，作为虚拟主机，例如。</p><p id="958c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">192 . 168 . 0 . 111 vadal . cluster . local</p><p id="4114" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如下所示:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="6f8e" class="mj ky iq mf b gy mk ml l mm mn">echo "<br/>kind: Ingress<br/>apiVersion: extensions/v1beta1<br/>metadata:<br/>  name: vadal-cluster<br/>  annotations:<br/>    konghq.com/strip-path: "true"<br/>    konghq.com/plugins: http-auth<br/>spec:<br/>  rules:<br/>    - host: vadal.cluster.local<br/>      http:<br/>        paths:<br/>          - path: /echo<br/>            backend:<br/>              serviceName: vadal-echo<br/>              servicePort: 80<br/>" | kubectl apply -f -</span></pre><p id="5e4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试访问服务</p><blockquote class="mo mp mq"><p id="5cf6" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated">【http://vadal.cluster.local/echo】卷曲-I<a class="ae kw" href="http://vadal.cluster.local/echo" rel="noopener ugc nofollow" target="_blank">T5T7】</a></p><p id="e041" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq"> HTTP/1.1 401未授权<br/>日期:2020年7月6日星期一20:51:27 GMT <br/>内容类型:application/JSON；charset=utf-8 <br/>连接:keep-alive<br/>WWW-Authenticate:Key realm = " Kong "<br/>Content-Length:41<br/>X-Kong-Response-Latency:1<br/>服务器:kong/2.0.4 </em></p><p id="9347" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq"> {"message ":"请求中未找到API密钥" } </em></p></blockquote><p id="4ec4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在访问被阻止了。向请求中添加密钥。</p><blockquote class="mo mp mq"><p id="c3b4" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">卷曲-我</em>http://vadal.cluster.local/echo?apikey=secretkey<em class="iq">T21</em>T24】</p></blockquote><p id="a910" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">返回预期的响应。很好。</p><h1 id="e454" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">JWT认证</h1><p id="5937" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">另一种方法是使用JSON web令牌(JWT ),这种方法可以在以后使用通用的身份提供者。为此，我们使用站点<a class="ae kw" href="https://jwt.io" rel="noopener ugc nofollow" target="_blank"> https://jwt.io </a>来帮助创建我们的令牌。</p><h1 id="e8a8" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建JWT (RS256)</h1><p id="9a86" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><a class="ae kw" href="https://jwt.io/#debugger-io?token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6InZhZGFsIiwiaXNzIjoidmFkYWwtaXNzdWVyIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0.DJ0n_25h2kJN1oZZ8ObgXhv-yMZDfL6EtOMLVVKMC160egQpuPV943MxaliWEkfZ3yyrf5kOdkcbk2_daIyaKS_gBzX7AKSiCd44OGMhP7PeoovkYncND25W7mKyRBmTCRG_5VQAwtKPS2jpF0t3IqOVfG5klB9V_oAO-aIF8TOSlxE7WW_xgYoDnW0JSzh4V-VW9uFbmVnx86SeaBlVjH_cPcEDanwlUbIz1zY4_vyP4adSrEfH-chRxW6ewpjfIXTMfVj2sdtx3uabufgvVmFQ4QSQH6NKPcUWSUK58KmYJ0g-7G5BfyKCA1Lj7qLrmAHCCm-oC8OO7qdLrqcJTg&amp;publicKey=-----BEGIN%20PUBLIC%20KEY-----%0AMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAnzyis1ZjfNB0bBgKFMSv%0AvkTtwlvBsaJq7S5wA%2BkzeVOVpVWwkWdVha4s38XM%2Fpa%2Fyr47av7%2Bz3VTmvDRyAHc%0AaT92whREFpLv9cj5lTeJSibyr%2FMrm%2FYtjCZVWgaOYIhwrXwKLqPr%2F11inWsAkfIy%0AtvHWTxZYEcXLgAXFuUuaS3uF9gEiNQwzGTU1v0FqkqTBr4B8nW3HCN47XUu0t8Y0%0Ae%2Blf4s4OxQawWD79J9%2F5d3Ry0vbV3Am1FtGJiJvOwRsIfVChDpYStTcHTCMqtvWb%0AV6L11BWkpzGXSW4Hv43qa%2BGSYOD2QU68Mb59oSk2OB%2BBtOLpJofmbGEGgvmwyCI9%0AMwIDAQAB%0A-----END%20PUBLIC%20KEY-----" rel="noopener ugc nofollow" target="_blank">https://jwt.io/#debugger-io?token = eyjhbgcioijsuzi 1 NII SINR 5 CCI 6 ikpxvcj 9 . eyjzdwiiixmjm 0 nty 3 odkwiiwibmftzsi 6 inzhzgfsiiwiaxnzijoidmfkywwtaxnzdwvyiiwywrtaw 4 ionrydwusimlhdci 6 mtuxnjizotaymn 0 . dj0n _ 25 H2 kjn 1 ozz 8 obgxhv-ymzdfl 6 etomlvvvkmc 160 egqpuv 943 xaliwekfz 3 yyy</a></p><p id="dc7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有益的是，jwt.io还将为我们创建密钥对。我们不需要私钥，除非我们在Konga使用它来创建JWT授权。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="fcb5" class="mj ky iq mf b gy mk ml l mm mn">-----BEGIN PUBLIC KEY----- MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAnzyis1ZjfNB0bBgKFMSv vkTtwlvBsaJq7S5wA+kzeVOVpVWwkWdVha4s38XM/pa/yr47av7+z3VTmvDRyAHc aT92whREFpLv9cj5lTeJSibyr/Mrm/YtjCZVWgaOYIhwrXwKLqPr/11inWsAkfIy tvHWTxZYEcXLgAXFuUuaS3uF9gEiNQwzGTU1v0FqkqTBr4B8nW3HCN47XUu0t8Y0 e+lf4s4OxQawWD79J9/5d3Ry0vbV3Am1FtGJiJvOwRsIfVChDpYStTcHTCMqtvWb V6L11BWkpzGXSW4Hv43qa+GSYOD2QU68Mb59oSk2OB+BtOLpJofmbGEGgvmwyCI9 MwIDAQAB -----END PUBLIC KEY-----</span></pre><p id="ec70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用下面的内容创建一个文件jwt.yml，应用到k8s。</p><p id="b4a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一部分应用了JWT插件。</p><p id="8fa5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二部分在K8s中创建一个秘密，其中包括上面的公钥。</p><p id="596f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在第三部分中，我们有引用秘密的消费者。</p><p id="5f2c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第四入口段在服务上设置JWT限制app-jwt。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="79b1" class="mj ky iq mf b gy mk ml l mm mn">apiVersion: configuration.konghq.com/v1<br/>kind: KongPlugin<br/>metadata:<br/>  name: app-jwt<br/>plugin: jwt<br/><br/>---<br/>apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: vadal-jwt-k8s<br/>type: Opaque<br/>stringData:<br/>  kongCredType: jwt<br/>  key: vadal-issuer<br/>  algorithm: RS256<br/>  rsa_public_key: |-<br/>    -----BEGIN PUBLIC KEY-----<br/>    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAnzyis1ZjfNB0bBgKFMSv<br/>    vkTtwlvBsaJq7S5wA+kzeVOVpVWwkWdVha4s38XM/pa/yr47av7+z3VTmvDRyAHc<br/>    aT92whREFpLv9cj5lTeJSibyr/Mrm/YtjCZVWgaOYIhwrXwKLqPr/11inWsAkfIy<br/>    tvHWTxZYEcXLgAXFuUuaS3uF9gEiNQwzGTU1v0FqkqTBr4B8nW3HCN47XUu0t8Y0<br/>    e+lf4s4OxQawWD79J9/5d3Ry0vbV3Am1FtGJiJvOwRsIfVChDpYStTcHTCMqtvWb<br/>    V6L11BWkpzGXSW4Hv43qa+GSYOD2QU68Mb59oSk2OB+BtOLpJofmbGEGgvmwyCI9<br/>    MwIDAQAB<br/>    -----END PUBLIC KEY-----<br/><br/>---<br/>apiVersion: configuration.konghq.com/v1<br/>kind: KongConsumer<br/>metadata:<br/>  name: vadal-jwt-k8s<br/>username: vadal-jwt-k8s<br/>credentials:<br/>  - vadal-jwt-k8s<br/><br/>---<br/>kind: Ingress<br/>apiVersion: extensions/v1beta1<br/>metadata:<br/>  name: vadal-cluster<br/>  annotations:<br/>    konghq.com/strip-path: "true"<br/>    konghq.com/plugins: app-jwt<br/>spec:<br/>  rules:<br/>    - host: vadal.cluster.local<br/>      http:<br/>        paths:<br/>          - path: /echo<br/>            backend:<br/>              serviceName: vadal-echo<br/>              servicePort: 80</span></pre><blockquote class="mo mp mq"><p id="d308" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq"> kubectl apply -f jwt.yml </em></p></blockquote><p id="a130" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，当我们调用它时，我们没有被授权(我们已经从前面的api-key部分删除了http-auth，现在唯一的插件是app-jwt)。</p><blockquote class="mo mp mq"><p id="6b8c" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">curl-I</em><a class="ae kw" href="http://vadal.cluster.local/echo" rel="noopener ugc nofollow" target="_blank"><em class="iq">http://vadal.cluster.local/echo</em></a><em class="iq"><br/>HTTP/1.1 401未授权<br/>日期:2020年7月6日星期一21:33:58 GMT <br/>内容类型:application/JSON；charset=utf-8 <br/>连接:keep-alive<br/>Content-Length:26<br/>X-Kong-Response-Latency:0<br/>服务器:Kong/2 . 0 . 4<br/>{ " message ":" Unauthorized " }</em></p></blockquote><p id="2958" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将JWT令牌导出到变量中。</p><blockquote class="mo mp mq"><p id="deea" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">export VADAL _ JWT = eyjhbgcioijsuzi 1 nisinr 5 CCI 6 ikpxvcj 9 . eyjzdwiiioiixmjm 0 nty 3 odkwiiwibmftzsi 6 inzhzgfsiwiaxnzijoid mfkywwtaxnzdwvyiwiywrtaw 4 ionrydwusimlhdci 6 mtuxnjizotaymn 0 . dj0n _ 25 H2 kjn 1 ozz 8 obgxhv-ymzdfl 6 etomlvvvkmc 160 egqpuv 940</em></p></blockquote><p id="6ae4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">调用服务并将其传递给授权头。</p><blockquote class="mo mp mq"><p id="6823" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq"> curl -i -H "授权:来人$ { VADAL _ JWT } "</em><a class="ae kw" href="http://vadal.cluster.local/echo" rel="noopener ugc nofollow" target="_blank">【http://vadal.cluster.local/echo】</a><em class="iq"/></p></blockquote><p id="177b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果还显示了使用者和凭据头。</p><blockquote class="mo mp mq"><p id="1b76" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">{ " timestamp ":" 2020–07–07t 00:36:08.874 "，<br/>" headers ":{<br/>" host ":" vadal . cluster . local "，<br/> "connection":"keep-alive "，<br/>" kong-request-id ":" 17b 1274 c-0e9a-4c9e-bd21–42895 b9d 5702 # 26 "，【T29</em></p></blockquote><p id="f4cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在孔加看到JWT的背景。注意，已经从存储在vadal-jwt-k8s中的K8s secret获得了详细信息，在这里您可以轻松地管理这个秘密并更改密钥(vadal-issuer)。一个有趣的孔到K8s的整合。太酷了。</p><p id="f6a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还可以从GUI创建JWT令牌，尽管详细信息不会存储在k8s中，而是存储在Kong中。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/cac18d0ca87484eb47f421e5682db54f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-UAGuSyJgZH9ipOF.png"/></div></div></figure><p id="3016" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Kong API还显示了jwt，</p><p id="ae28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="http://localhost:31492/jwts" rel="noopener ugc nofollow" target="_blank">http://localhost:31492/jwts</a></p><p id="5444" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者消费者:</p><p id="7168" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="http://localhost:31492/consumers" rel="noopener ugc nofollow" target="_blank">http://localhost:31492/消费者</a></p><h1 id="1630" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">JWT经香港空气污染指数和高速公路256</h1><p id="50eb" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">一种JWT对称密钥算法。像这样创建它:</p><blockquote class="mo mp mq"><p id="2041" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">curl-X POST</em><a class="ae kw" href="http://localhost:31492/consumers/vadal-jwt-k8s/jwt" rel="noopener ugc nofollow" target="_blank"><em class="iq">http://localhost:31492/consumers/vadal-jwt-k8s/jwt</em></a></p><p id="cd23" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq"> {"rsa_public_key":null，" created_at":1594169412，" consumer ":{ " id ":" 74e 2 E3 b 6–36 F9–44cf-aa7d-f 82767 c 37672 " }，" id ":" 367 a5e 08-a904–4 ab1-a1da-7915 EC 9 BF 7 a 8 "，" tags":null，" key ":"</em><strong class="ka ir"><em class="iq">y1rkzx 1 oz</em></strong></p></blockquote><p id="57ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将下面的代码片段应用到<a class="ae kw" href="http://jwt.io" rel="noopener ugc nofollow" target="_blank"> http://jwt.io </a></p><p id="d889" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">还要在验证块中添加密码(epgbtpalkw4g 3 pkpnqyay 5 MEP 1 ed 0 kkq)</p><p id="8840" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您将得到一个类似这样的令牌:</p><p id="672e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">eyj 0 exaioijkv 1 qilcjhbgcioijiuzi 1 nij 9 . eyjpc 3 mioijzmxjlwlgxb 1 p 4 nzq 2 cgy 4 DTG 4 tkj 3 nfjos 3 M5 wkdqzyisimlhdci 6 bnvsbcwizzhwijpdwxslcjhwqioiiilcjzdwiiiiiiifq . coqjfjbfxie h0 oxih 5kg 4 _ nqdequlrhbqiqtmetyu</p><p id="6b8d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><blockquote class="mo mp mq"><p id="3996" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq"> curl -i </em></p></blockquote><p id="244f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应该也可以访问HS256令牌。</p><blockquote class="mo mp mq"><p id="a604" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">HTTP/1.1 200<br/>Content-Type:application/JSON<br/>Transfer-Encoding:chunked<br/>Connection:keep-alive<br/>Date:Wed，08 Jul 2020 15:33:05 GMT<br/>X-Kong-Upstream-Latency:9<br/>X-Kong-Proxy-Latency:1<br/>Via:Kong/2 . 0 . 4</em></p><p id="19bd" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">{ " timestamp ":" 2020–07–08t 15:33:05.483 "，" joined":["host: localhost "，" connection: keep-alive "，" kong-request-id:55d 28927–75 C5–44a 7-b656–3e 218054 ac04 # 2 "，" x-forwarded-proto: http "，" x-forwarded-host: localhost "，" x-forwarded-port: 8000 "，" x-real-ip: 1</em></p></blockquote><h1 id="664e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">使用ACL</h1><p id="d10e" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Kong中的访问控制列表由消费者内部的组来管理。消费者将具有带有某种授权方法的凭证。然后，ACL插件可以附加到路由或服务，以及白名单或黑名单中定义的组。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/eaa7d7adfb8f0b0690569160399805d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aMSV526kaoInmwy5.png"/></div></div></figure><p id="02d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">插件支持该特性。消费者凭证定义了要使用的授权细节。</p><p id="9eb9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这样，ACL允许/不允许消费者访问路由或服务。只有正确的消费者凭证才能访问定义的资源。</p><p id="7577" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们从同一个映像创建另一个部署，但是通过ACL限制对它的访问。</p><blockquote class="mo mp mq"><p id="2605" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq"> kubectl创建部署vadal-echo-admin-image = vadal-echo:0 . 0 . 1-快照</em></p><p id="328f" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">ku bectl expose deploy vadal-echo-admin-port = 80-target-port = 8080</em></p></blockquote><p id="1561" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用以下内容定义一个新的消费者并添加插件和入口。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="52bb" class="mj ky iq mf b gy mk ml l mm mn">apiVersion: configuration.konghq.com/v1<br/>kind: KongPlugin<br/>metadata:<br/>  name: vadal-acl<br/>plugin: acl<br/>config:<br/>  whitelist: ['vadal-admin']<br/><br/>---<br/>apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: vadal-acl-secret<br/>type: Opaque<br/>stringData:<br/>  kongCredType: acl<br/>  group: vadal-admin<br/><br/>---<br/>apiVersion: configuration.konghq.com/v1<br/>kind: KongConsumer<br/>metadata:<br/>  name: vadal-admin<br/>username: vadal-admin<br/>credentials:<br/>  - vadal-acl-secret<br/><br/>---<br/>kind: Ingress<br/>apiVersion: extensions/v1beta1<br/>metadata:<br/>  name: vadal-cluster<br/>  annotations:<br/>    kubernetes.io/ingress.class: "kong"<br/>    konghq.com/strip-path: "true"<br/>    konghq.com/plugins: app-jwt, vadal-acl<br/>spec:<br/>  rules:<br/>    - host: vadal.cluster.local<br/>      http:<br/>        paths:<br/>          - path: /echo-admin<br/>            backend:<br/>              serviceName: vadal-echo-admin<br/>              servicePort: 80<br/>          - path: /echo<br/>            backend:<br/>              serviceName: vadal-echo<br/>              servicePort: 80</span></pre><p id="7b1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面针对路由路径/echo-admin设置了一个ACL (vadal-acl)。此acl将组vadal-admin列入白名单。消费者vadal-admin由组vadal-admin组成。</p><p id="24f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用之前定义的JWT调用服务。</p><blockquote class="mo mp mq"><p id="c874" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated">vadal.cluster.local/echo-admin</p><p id="0396" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq"> HTTP/1.1 403禁止<br/>日期:2020年07月08日00:00:15 GMT <br/>内容类型:application/JSON；charset=utf-8 <br/>连接:keep-alive<br/>Content-Length:45<br/>X-Kong-Response-Latency:1<br/>服务器:kong/2.0.4 </em></p><p id="02d3" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq"> {"message ":"您不能消费该服务" } </em></p></blockquote><p id="ab5e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ACL不允许访问。很好。</p><p id="7621" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们针对这个新消费者定义一个JWT令牌，只有这个消费者的凭证应该被接受。</p><blockquote class="mo mp mq"><p id="0dbd" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">curl-X POST</em><a class="ae kw" href="http://localhost:31492/consumers/vadal-admin/jwt" rel="noopener ugc nofollow" target="_blank"><em class="iq">http://localhost:31492/consumers/vadal-admin/jwt</em></a></p><p id="bac7" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq"> {"rsa_public_key":null，" created_at":1594221350，" consumer ":{ " id ":" 45b 8094 b-5a 30–4285–9 c84–90b 106 f 4131 b " }，" id ":" 0 bffd 6 f 3-ced b-475 e-9958–9ea 005699d 17 "，" tags":null，" key ":" po 3 of 3 tmripdv 2 txv 3 gtspsp</em></p></blockquote><p id="f0de" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您需要密钥(iss)和密码来创建令牌。</p><p id="58d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://jwt.io/#debugger-io?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwbzNPZjNUbVJJcER2MnR4VjNHVFNwd2swRjZOWXZBMCJ9.1HrgMwzpGRlzy0mqcv1WN-enfiJcDNnISOM7LhQSEGg" rel="noopener ugc nofollow" target="_blank">https://jwt.io/#debugger-io?token = eyj 0 exaioijkv 1 qilcjhbgcioijuzi 1 nij 9 . ey jpc 3 mioiijwbznpzjnubvjjcer 2 mnr 4 vjnhvfnwd 2s wrjzowxzbmcj 9.1 hrgmwzpgrzy 0 mqcv 1 wn-enfijcdnnisom 7 lhqsegg</a></p><p id="ddaf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们现在有了该消费者/组的合法令牌。</p><blockquote class="mo mp mq"><p id="4cea" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">export VADAL _ JWT =</em><a class="ae kw" href="https://jwt.io/#debugger-io?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwbzNPZjNUbVJJcER2MnR4VjNHVFNwd2swRjZOWXZBMCJ9.1HrgMwzpGRlzy0mqcv1WN-enfiJcDNnISOM7LhQSEGg" rel="noopener ugc nofollow" target="_blank"><em class="iq">eyj 0 exaioijkv 1 qilcjhbgcioijiuzi 1 nij 9 . eyjpc 3 mioijwbznpzjnubvjjcer 2 mnr 4 vjnhvfnwd 2 swrjzowxzbmcj 9.1 hrgmwzpgrlzy 0 mqcv 1 wn-enfijcdnnxnouglhqsegg</em></a></p><p id="58fe" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">curl-I-H " Authorization:Bearer $ VADAL _ JWT " vadal.cluster.local/echo-admin<br/>HTTP/1.1 200<br/>Content-Type:application/JSON<br/>Transfer-Encoding:chunked<br/>Connection:keep-alive<br/>Date:Wed，08 Jul 2020 15:24:33 GMT<br/>X-Kong-Upstream-Latency:279<br/>X-Kong-Proxy-Latency:3<br/>Via:Kong/2</em></p><p id="6c44" class="jy jz mr ka b kb kc kd ke kf kg kh ki ms kk kl km mt ko kp kq mu ks kt ku kv ij bi translated"><em class="iq">{ " timestamp ":" 2020–07–08t 15:24:33.707 "，" joined ":[" host:vadal . cluster . local "，" connection: keep-alive "，" x-consumer-groups: vadal-admin "，" x-forwarded-proto: http "，" x-forwarded-host:vadal . cluster . local "，" x-forwarded-port: 8000 "，" x-real-ip: 192.168.65.3 "，" user-agent:curl/7.66</em></p></blockquote><p id="6d80" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用煤气做饭。请注意持有人、消费者用户名和凭据的详细信息。服务可以对此进行进一步的解密，以获得任何有状态的信息，但不需要担心验证这一点，因为这一切都由Kong负责。很好。</p><h1 id="23ea" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结论</h1><p id="9487" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们已经使用api密钥和jwt为我们的服务添加了授权访问。同一服务可以有由ACL控制的不同访问端点。授权问题已经很好地从服务本身中分离出来，让它专注于提供商业价值。孔很好地坐在前面保护和管理访问。所有这些都在弹性可扩展的K8s架构中。</p><p id="58a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">干净利落。</p></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><p id="5a75" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mr">原载于2020年7月8日</em><a class="ae kw" href="https://blog.ramjee.uk/kong-api-security-in-kubernetes/" rel="noopener ugc nofollow" target="_blank"><em class="mr">https://blog . ram JEE . uk</em></a><em class="mr">。</em></p></div></div>    
</body>
</html>