<html>
<head>
<title>A Complete Flow for Social Login with React Native, Expo, and Amplify</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React Native、Expo和Amplify社交登录的完整流程</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-complete-flow-for-social-login-with-react-native-expo-and-amplify-2c9eacc501fe?source=collection_archive---------2-----------------------#2020-03-23">https://levelup.gitconnected.com/a-complete-flow-for-social-login-with-react-native-expo-and-amplify-2c9eacc501fe?source=collection_archive---------2-----------------------#2020-03-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/14bd1df3c66c222ed386fec611b5ec15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zjdGPNICgUC6ITqpTpyytQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">在<a class="ae kc" href="https://unsplash.com/s/photos/computer-puzzle?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kc" href="https://unsplash.com/@bradneathery?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Brad Neathery </a>拍摄的照片</figcaption></figure><p id="4eca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们超越“Hello World ”,看看现实世界中的一个场景。我在AWS上的一个社区移动应用中一直使用Amplify，这是需要克服的障碍之一。</p><p id="b2ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我想要建立的流程。Guest: 1-&gt;2-&gt;3(登录登陆)，如果用户返回并已经登录，立即向他们显示登陆。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/ea374a79f5c045827c4d8f3de9a90e3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_CSaK6XVo5bRn6VHfy_imw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">将原生应用与认知和社交登录流程相结合</figcaption></figure><p id="fb92" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">移动应用程序应该同时包含访客内容和会员专用内容。我不喜欢那些只有在你注册后才允许你进入的应用程序。</p><p id="efe6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将所有AWS服务捆绑在一起是一项艰巨的任务，更不用说将社交登录融入其中了。</p><p id="f2b3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看看如何通过Expo for tooling、React Native作为框架以及AWS作为移动后端来实现这一点。一张图胜过千言万语。该图是不言自明的，放大文件是<a class="ae kc" href="https://aws-amplify.github.io/docs/js/authentication#authentication" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lg"><img src="../Images/d2652ce1ed3e95e13e6ac2ed25a5137d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vAt5bKrWnFAYHxjYj3bvYw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">扩大认知用户池与身份池</figcaption></figure><p id="37ec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">复杂性来自于怪异的AWS命名法。他们用相似的名字来称呼这两个服务。例如，联合和联合身份。起初，我将“联合身份”视为联合的一个自然组成部分。但它们是两条不同路径的一部分。</p><p id="a90e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于这个例子，我们将采用用户管理的第一个流程，其中我们将使用Cognito用户池来维护我们的用户信息，并使用Federation来连接脸书。这样，就为每个社交登录用户创建了一个cognito用户。</p><p id="039d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我假设读者很了解node.js和React Native生态系统。如果没有，这不是你应该读的文章。开玩笑！</p><p id="a689" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧，为了让生活更容易，让我们利用世博会，这样我们就可以避免让我们的生活变得痛苦。</p><p id="a5f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">先决条件:</p><ol class=""><li id="ca51" class="lh li iq kf b kg kh kk kl ko lj ks lk kw ll la lm ln lo lp bi translated">安装Expo和Expo CLI(我用的是SDK 36.0.0)</li><li id="ae94" class="lh li iq kf b kg lq kk lr ko ls ks lt kw lu la lm ln lo lp bi translated">使用Expo CLI制作一个示例应用程序</li><li id="be6a" class="lh li iq kf b kg lq kk lr ko ls ks lt kw lu la lm ln lo lp bi translated">安装Amplify CLI</li><li id="6c00" class="lh li iq kf b kg lq kk lr ko ls ks lt kw lu la lm ln lo lp bi translated">初始化放大项目</li><li id="b5ec" class="lh li iq kf b kg lq kk lr ko ls ks lt kw lu la lm ln lo lp bi translated">在脸书创建一个应用程序，并添加脸书登录</li></ol><h2 id="3f68" class="lv lw iq bd lx ly lz dn ma mb mc dp md ko me mf mg ks mh mi mj kw mk ml mm mn bi translated">正在准备验证</h2><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="ee1f" class="lv lw iq mp b gy mt mu l mv mw">amplify add auth</span></pre><p id="8252" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">设置身份验证配置以登录联盟。在我们的例子中，它是“脸书”</p><p id="a796" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于登录/注销URL，我们可以添加多个项目。我添加了3个选项:</p><p id="d322" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于本地主机，模拟器测试:</p><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="03db" class="lv lw iq mp b gy mt mu l mv mw">exp://127.0.0.1/</span></pre><p id="e711" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于Expo客户端的测试:</p><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="30e0" class="lv lw iq mp b gy mt mu l mv mw">exp://&lt;Lan Ip&gt;/</span></pre><p id="8ddf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于设备测试和生产使用:</p><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="576b" class="lv lw iq mp b gy mt mu l mv mw">expoamplifytest://</span></pre><p id="f924" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后一个选项很有趣，因为我们可以定义自己的“方案”。通常，人们会希望以他们的应用程序命名。只要确保你用类似这样的东西更新<em class="mx"> app.json </em>。<em class="mx">请注意，有</em> <em class="mx">结尾没有正斜杠</em>。</p><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="558d" class="lv lw iq mp b gy mt mu l mv mw">{</span><span id="fa38" class="lv lw iq mp b gy my mu l mv mw">  "expo": {</span><span id="2446" class="lv lw iq mp b gy my mu l mv mw">    "scheme": "expoamplifytest",</span><span id="7587" class="lv lw iq mp b gy my mu l mv mw">  }<br/>}</span></pre><p id="962b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Amplify生成一个OAuth域名，并将其存储在aws-exports.js和Cognito用户池中。在脸书应用程序脸书登录配置中添加它们。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/749e17acc02b67ed47e2e68095a80f6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bd3Vt8jSiJRjS-dKOFCTRw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">认知用户池Oauth域名</figcaption></figure><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/8578f0a49c13eac9b97dab6a52556f30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rCa8qq18PoExllVm9BYeow.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">aws-exports.js oauth域</figcaption></figure><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="c25b" class="lv lw iq mp b gy mt mu l mv mw">Add Cognito Pool Oauth domain with suffix “/oauth2/idpresponse”</span></pre><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/ad8369f14d703e263a2e15c43d1c2ff7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k6mpcRPzhfXF53GP9iEDLw.png"/></div></div></figure><h2 id="a36a" class="lv lw iq bd lx ly lz dn ma mb mc dp md ko me mf mg ks mh mi mj kw mk ml mm mn bi translated">步骤0:应用程序加载</h2><p id="1fd9" class="pw-post-body-paragraph kd ke iq kf b kg nc ki kj kk nd km kn ko ne kq kr ks nf ku kv kw ng ky kz la ij bi translated">在App.js或任何代码开始加载应用程序的地方，确定用户是否已经登录。在我们的例子中，我想知道我们是否需要去1-&gt;2流或A-B流。假设简单的StackNavigator应该可以达到这个目的。将这个登录放在App.js中的某个位置(假设react-navigation是导航处理程序)。</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="nh ni l"/></div></figure><h2 id="2ebd" class="lv lw iq bd lx ly lz dn ma mb mc dp md ko me mf mg ks mh mi mj kw mk ml mm mn bi translated">步骤1:连接逻辑以打开脸书Oauth</h2><p id="8643" class="pw-post-body-paragraph kd ke iq kf b kg nc ki kj kk nd km kn ko ne kq kr ks nf ku kv kw ng ky kz la ij bi translated">现在，让我们添加使用世博会内置网络浏览器打开脸书登录屏幕的逻辑。这是在应用程序上下文中打开浏览器的自定义逻辑。这很重要！否则，它只会切换到内置浏览器，可能会让用户觉得有恶意。此外，请注意，虽然我们配置了3个选项，但重定向URI仅设置为一个。这是Amplify或Cognito当前的局限性——它不知道将哪个URL发送到设备/客户端</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="nh ni l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">用世博浏览器打开脸书</figcaption></figure><h2 id="a5cc" class="lv lw iq bd lx ly lz dn ma mb mc dp md ko me mf mg ks mh mi mj kw mk ml mm mn bi translated">步骤2:从认证屏幕打开脸书·奥厄斯</h2><p id="4f0a" class="pw-post-body-paragraph kd ke iq kf b kg nc ki kj kk nd km kn ko ne kq kr ks nf ku kv kw ng ky kz la ij bi translated">为脸书按钮的<code class="fe nj nk nl mp b">onClick</code>事件添加一个函数。</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="nh ni l"/></div></figure><h2 id="1df5" class="lv lw iq bd lx ly lz dn ma mb mc dp md ko me mf mg ks mh mi mj kw mk ml mm mn bi translated">步骤3:实现注销</h2><p id="3537" class="pw-post-body-paragraph kd ke iq kf b kg nc ki kj kk nd km kn ko ne kq kr ks nf ku kv kw ng ky kz la ij bi translated">这就像在Auth上调用signout一样简单</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="nh ni l"/></div></figure><h2 id="2b2c" class="lv lw iq bd lx ly lz dn ma mb mc dp md ko me mf mg ks mh mi mj kw mk ml mm mn bi translated">最终输出</h2><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/eca10d9efbdf6ed47f8b7d20281af28c.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/1*7hKvvZpobyWF5V_aHApSng.gif"/></div></figure><p id="5a0c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果用户未登录或令牌已过期，它会将用户带到脸书登录。与脸书登录或任何登录一样，它将首先请求用户的许可。一旦完成，它将允许用户登录。收到OAuth响应后，Cognito Federation将根据Cognito Users中的用户属性映射创建一个用户以及用户详细信息。</p><p id="4d44" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果用户已经登录，它会将他们直接带到登录页面。</p><h2 id="a637" class="lv lw iq bd lx ly lz dn ma mb mc dp md ko me mf mg ks mh mi mj kw mk ml mm mn bi translated">结论</h2><p id="fc50" class="pw-post-body-paragraph kd ke iq kf b kg nc ki kj kk nd km kn ko ne kq kr ks nf ku kv kw ng ky kz la ij bi translated">在本文中，我试图设计一个端到端的流程来处理身份验证。通过AWS Cognito用户池使用身份验证的强大之处在于，所有其他服务都可以通过Cognito用户池访问轻松配置。这将为我们的应用提供最先进的安全墙，这是加快产品上市的一大优势。</p><p id="e33a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将用GitHub中发布的一整套代码创建一个视频教程。</p></div></div>    
</body>
</html>