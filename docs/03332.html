<html>
<head>
<title>A mysterious case of my PATH</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我道路上的一个神秘案例</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-mysterious-case-of-my-path-2d6a94b8e107?source=collection_archive---------16-----------------------#2020-05-03">https://levelup.gitconnected.com/a-mysterious-case-of-my-path-2d6a94b8e107?source=collection_archive---------16-----------------------#2020-05-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2c23" class="pw-subtitle-paragraph jr ip iq bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">对于每一个新的未登录的<code class="fe jn jo jp jq b">SHELL</code>，<code class="fe jn jo jp jq b">PATH</code>的内容随着重复输入而增加。</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/b17760af1564fd6e18d125bfa3099394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pa3Au5llmGggCFOW0xM42Q.png"/></div></div></figure><h2 id="4099" class="kv kw iq bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">主要学习内容</h2><p id="c54d" class="pw-post-body-paragraph lr ls iq lt b lu lv jv lw lx ly jy lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">✨ <code class="fe jn jo jp jq b">/etc/profile</code>在每次登录<code class="fe jn jo jp jq b">SHELL</code>时都会被执行，就像<code class="fe jn jo jp jq b">~/.bash_profile</code>、<code class="fe jn jo jp jq b">~/.zprofile</code>等等。</p><p id="5cad" class="pw-post-body-paragraph lr ls iq lt b lu mk jv lw lx ml jy lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">✨ <code class="fe jn jo jp jq b">/etc/bashrc</code>、<code class="fe jn jo jp jq b">/etc/zshrc</code>等人每次不登录<code class="fe jn jo jp jq b">SHELL</code>都会被执行，就像<code class="fe jn jo jp jq b">~/.bashrc</code>、<code class="fe jn jo jp jq b">~/.zshrc</code>等人一样。</p><p id="1c84" class="pw-post-body-paragraph lr ls iq lt b lu mk jv lw lx ml jy lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">✨默认情况下，<code class="fe jn jo jp jq b">/etc/profile.d</code>目录中的所有文件通常由<code class="fe jn jo jp jq b">/etc/profile</code>执行，登录时(除非修改)如下:</p><pre class="kk kl km kn gt mp jq mq mr aw ms bi"><span id="4755" class="kv kw iq jq b gy mt mu l mv mw">for i in /etc/profile.d/*.sh; do<br/>  if [ -r "$i" ]; then<br/>    . $i<br/>  fi<br/>done</span></pre></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><h2 id="1351" class="kv kw iq bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">问题</h2><p id="5a8d" class="pw-post-body-paragraph lr ls iq lt b lu lv jv lw lx ly jy lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">我从来没有注意过我的<code class="fe jn jo jp jq b">PATH</code>变量的内容，除了确保所有需要的二进制文件的路径都被添加到其中。最近，我不得不四处查看，因为一个可执行文件指向了一个不需要的版本。</p><p id="6a44" class="pw-post-body-paragraph lr ls iq lt b lu mk jv lw lx ml jy lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">在回显<code class="fe jn jo jp jq b">PATH</code>时，我注意到不需要的版本的<code class="fe jn jo jp jq b">path</code>列在了<code class="fe jn jo jp jq b">PATH</code>中想要的版本的路径之前。</p><p id="333d" class="pw-post-body-paragraph lr ls iq lt b lu mk jv lw lx ml jy lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">我还注意到，对于每一个新的未登录的<code class="fe jn jo jp jq b">SHELL</code>，<code class="fe jn jo jp jq b">PATH</code>的内容都在增加，看起来好像有重复的条目。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/b17760af1564fd6e18d125bfa3099394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pa3Au5llmGggCFOW0xM42Q.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">我的终端窗口的屏幕截图，显示在每个新的shell会话中，重复的条目被添加到PATH中</figcaption></figure><h2 id="df55" class="kv kw iq bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">原因</h2><p id="9282" class="pw-post-body-paragraph lr ls iq lt b lu lv jv lw lx ly jy lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">经过仔细观察，我发现以下条目在<code class="fe jn jo jp jq b">PATH</code>中重复出现。</p><pre class="kk kl km kn gt mp jq mq mr aw ms bi"><span id="1dc9" class="kv kw iq jq b gy mt mu l mv mw">:/usr/local/mysql/bin<br/>:/usr/local/mongodb/bin<br/>:/usr/local/heroku/bin<br/>:/usr/local/lib/apache-jmeter/bin<br/>:/usr/local/lib/apache-maven/bin<br/>:./node_modules/.bin<br/>:/home/sabandyo/.yarn/bin<br/>:/home/sabandyo/.config/yarn/global/node_modules/.bin</span><span id="3a63" class="kv kw iq jq b gy ni mu l mv mw">:/export/apps/xtools/apache-ant-1.7.1/bin<br/>:/var/cfengine/bin<br/>:/export/apps/xtools/charles-proxy/bin<br/>:/export/apps/xtools/oracle-instantclient</span></pre><p id="26c7" class="pw-post-body-paragraph lr ls iq lt b lu mk jv lw lx ml jy lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">我可以用以下理由进行推理:</p><pre class="kk kl km kn gt mp jq mq mr aw ms bi"><span id="9609" class="kv kw iq jq b gy mt mu l mv mw">:/usr/local/mysql/bin<br/>:/usr/local/mongodb/bin<br/>:/usr/local/heroku/bin<br/>:/usr/local/lib/apache-jmeter/bin<br/>:/usr/local/lib/apache-maven/bin<br/>:./node_modules/.bin<br/>:/home/sabandyo/.yarn/bin<br/>:/home/sabandyo/.config/yarn/global/node_modules/.bin</span></pre><p id="df5b" class="pw-post-body-paragraph lr ls iq lt b lu mk jv lw lx ml jy lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">这些条目是我的<code class="fe jn jo jp jq b"><a class="ae nj" href="https://github.com/sarbbottam/conf-files/blob/c44cd4ff7f48cc712ce21b951c8df94e09e5a756/dot-commons/path" rel="noopener ugc nofollow" target="_blank">dot-commons/path</a></code>文件的一部分，重复是因为从我的<code class="fe jn jo jp jq b">~/.<a class="ae nj" href="https://github.com/sarbbottam/conf-files/blob/c44cd4ff7f48cc712ce21b951c8df94e09e5a756/dot-files/bashrc#L2" rel="noopener ugc nofollow" target="_blank">bashrc</a> </code>和<code class="fe jn jo jp jq b">~/.<a class="ae nj" href="https://github.com/sarbbottam/conf-files/blob/c44cd4ff7f48cc712ce21b951c8df94e09e5a756/dot-files/zshrc#L2" rel="noopener ugc nofollow" target="_blank">zshrc</a></code>中调用了<code class="fe jn jo jp jq b"><a class="ae nj" href="https://github.com/sarbbottam/conf-files/blob/c44cd4ff7f48cc712ce21b951c8df94e09e5a756/dot-commons/path" rel="noopener ugc nofollow" target="_blank">dot-commons/path</a></code>。由于<code class="fe jn jo jp jq b">~/.<a class="ae nj" href="https://github.com/sarbbottam/conf-files/blob/c44cd4ff7f48cc712ce21b951c8df94e09e5a756/dot-files/bashrc#L2" rel="noopener ugc nofollow" target="_blank">bashrc</a></code>、<code class="fe jn jo jp jq b">~/.<a class="ae nj" href="https://github.com/sarbbottam/conf-files/blob/c44cd4ff7f48cc712ce21b951c8df94e09e5a756/dot-files/zshrc#L2" rel="noopener ugc nofollow" target="_blank">zshrc</a></code>等人对每个非登录SHELL都执行了，所以他们不断地为每个新的非登录会话将上述条目添加到路径中。</p><h2 id="6295" class="kv kw iq bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">临时解决方案</h2><p id="41c1" class="pw-post-body-paragraph lr ls iq lt b lu lv jv lw lx ly jy lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">我<a class="ae nj" href="https://github.com/sarbbottam/conf-files/commit/6713404c9f240547e07c1bd0d7e820dad4d1d773" rel="noopener ugc nofollow" target="_blank">将dot-commons/path </a>的采购移至<a class="ae nj" href="https://github.com/sarbbottam/conf-files/blob/6713404c9f240547e07c1bd0d7e820dad4d1d773/dot-files/bash_profile#L2" rel="noopener ugc nofollow" target="_blank">。bash_profile </a>和<code class="fe jn jo jp jq b"><a class="ae nj" href="https://github.com/sarbbottam/conf-files/blob/6713404c9f240547e07c1bd0d7e820dad4d1d773/dot-files/zprofile#L2" rel="noopener ugc nofollow" target="_blank">.zprofile</a></code>，它解决了上面提到的<code class="fe jn jo jp jq b">PATH</code>的重复问题。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/0915165325bc44d752e9042c578549e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H42hIy3wifWgBxP_gSyFHw.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">我的终端窗口的屏幕截图显示，在每个新的shell会话中，较少重复的条目被添加到PATH中</figcaption></figure><p id="4887" class="pw-post-body-paragraph lr ls iq lt b lu mk jv lw lx ml jy lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">然而，下面的条目仍然重复出现。</p><pre class="kk kl km kn gt mp jq mq mr aw ms bi"><span id="7dd9" class="kv kw iq jq b gy mt mu l mv mw">:/export/apps/xtools/apache-ant-1.7.1/bin<br/>:/var/cfengine/bin<br/>:/export/apps/xtools/charles-proxy/bin<br/>:/export/apps/xtools/oracle-instantclient</span></pre><h2 id="b4ee" class="kv kw iq bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">最终解决方案</h2><p id="a81a" class="pw-post-body-paragraph lr ls iq lt b lu lv jv lw lx ly jy lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">进一步挖掘后，我发现我的<code class="fe jn jo jp jq b">/etc/profile.d</code>目录中有几个文件负责将这些条目添加到<code class="fe jn jo jp jq b">PATH</code>。<code class="fe jn jo jp jq b">/etc/bashrc</code>、<code class="fe jn jo jp jq b">/etc/zshrc</code>等人，每次未登录<code class="fe jn jo jp jq b">SHELL</code>都会被执行，就像<code class="fe jn jo jp jq b">~/.bashrc</code>、<code class="fe jn jo jp jq b">~/.zshrc</code>等人是这样加载这些文件的:</p><pre class="kk kl km kn gt mp jq mq mr aw ms bi"><span id="bd7a" class="kv kw iq jq b gy mt mu l mv mw">for i in /etc/profile.d/*.sh; do<br/>  if [ -r "$i" ]; then<br/>    . $i<br/>  fi<br/>done</span></pre><p id="ab46" class="pw-post-body-paragraph lr ls iq lt b lu mk jv lw lx ml jy lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">我修改了相关文件，只在条目还没有出现在<code class="fe jn jo jp jq b">PATH</code>中时才添加条目，如下所示:</p><pre class="kk kl km kn gt mp jq mq mr aw ms bi"><span id="2421" class="kv kw iq jq b gy mt mu l mv mw">if ! echo $PATH | grep -q $DESIRED_PATH ; then<br/>  export PATH=$PATH:$DESIRED_PATH<br/>fi</span></pre><p id="54c0" class="pw-post-body-paragraph lr ls iq lt b lu mk jv lw lx ml jy lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">并且解决了<code class="fe jn jo jp jq b">PATH</code>中剩余重复条目的问题。✅</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/6b9ef39295c7a22d3ec0efb870796731.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5c0f8T_k-IrcyzLslX2lng.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">我的终端窗口的屏幕截图，显示在每个新的shell会话中没有重复的条目被添加到PATH中</figcaption></figure><h2 id="2109" class="kv kw iq bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">关键外卖</h2><p id="2b7c" class="pw-post-body-paragraph lr ls iq lt b lu lv jv lw lx ly jy lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">仅当所需路径不存在时，将其添加到<code class="fe jn jo jp jq b">PATH</code>中。</p><pre class="kk kl km kn gt mp jq mq mr aw ms bi"><span id="03fa" class="kv kw iq jq b gy mt mu l mv mw"># ❌ don't do this<br/># export PATH=$PATH:$DESIRED_PATH</span><span id="afb5" class="kv kw iq jq b gy ni mu l mv mw"># ✅ rather do this<br/>if ! echo $PATH | grep -q $DESIRED_PATH ; then<br/>  export PATH=$PATH:$DESIRED_PATH<br/>fi</span></pre><h2 id="5dfa" class="kv kw iq bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">注意</h2><p id="ac9d" class="pw-post-body-paragraph lr ls iq lt b lu lv jv lw lx ly jy lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">我应该只在<code class="fe jn jo jp jq b">PATH</code>中添加一个条目，如果它不在<code class="fe jn jo jp jq b">PATH</code>中，并相应地更新<code class="fe jn jo jp jq b"><a class="ae nj" href="https://github.com/sarbbottam/conf-files/blob/c44cd4ff7f48cc712ce21b951c8df94e09e5a756/dot-commons/path" rel="noopener ugc nofollow" target="_blank">dot-commons/path</a></code>。那么我应该把对<code class="fe jn jo jp jq b"><a class="ae nj" href="https://github.com/sarbbottam/conf-files/blob/c44cd4ff7f48cc712ce21b951c8df94e09e5a756/dot-commons/path" rel="noopener ugc nofollow" target="_blank">dot-commons/path</a></code>的调用移回到<code class="fe jn jo jp jq b"><a class="ae nj" href="https://github.com/sarbbottam/conf-files/blob/c44cd4ff7f48cc712ce21b951c8df94e09e5a756/dot-files/dot-common#L25" rel="noopener ugc nofollow" target="_blank">dot-files/dot-common</a></code>。</p></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><p id="562d" class="pw-post-body-paragraph lr ls iq lt b lu mk jv lw lx ml jy lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">感谢您的阅读。希望这篇帖子提供了一些关于<code class="fe jn jo jp jq b">PATH</code>、<code class="fe jn jo jp jq b">/etc/profile</code>、<code class="fe jn jo jp jq b">/etc/profile.d</code>、<code class="fe jn jo jp jq b">/etc/*shrc</code>的见解。🖥</p><h2 id="b3a5" class="kv kw iq bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">参考</h2><ul class=""><li id="51d0" class="nk nl iq lt b lu lv lx ly le nm li nn lm no mj np nq nr ns bi translated"><a class="ae nj" href="https://www.tecmint.com/understanding-shell-initialization-files-and-user-profiles-linux/" rel="noopener ugc nofollow" target="_blank">了解Linux中的Shell初始化文件和用户配置文件</a></li><li id="26a8" class="nk nl iq lt b lu nt lx nu le nv li nw lm nx mj np nq nr ns bi translated"><a class="ae nj" href="http://www.linuxfromscratch.org/blfs/view/6.3/postlfs/profile.html" rel="noopener ugc nofollow" target="_blank">Bash Shell启动文件</a></li><li id="8ac0" class="nk nl iq lt b lu nt lx nu le nv li nw lm nx mj np nq nr ns bi translated"><a class="ae nj" href="https://medium.com/coding-blocks/getting-to-understand-linux-shell-s-start-up-scripts-and-the-environments-path-variable-fc672107b2d7" rel="noopener">了解Linux外壳、启动脚本和环境的路径变量</a></li></ul></div></div>    
</body>
</html>