<html>
<head>
<title>What I learned after running the wrong set of migrations on the database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在数据库上运行错误的迁移集后，我学到了什么</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/what-did-i-learn-after-running-the-wrong-set-of-migrations-on-the-database-5126e5d4236e?source=collection_archive---------5-----------------------#2022-03-09">https://levelup.gitconnected.com/what-did-i-learn-after-running-the-wrong-set-of-migrations-on-the-database-5126e5d4236e?source=collection_archive---------5-----------------------#2022-03-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1cbf" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">你打破东西，你学到更多！</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/07fe2aa36f83216803bf83affc8b6aa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pZllLXZRXObg2e4E"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kv" href="https://unsplash.com/@mphotographym?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Moritz Mentges </a>拍摄的照片</figcaption></figure><p id="013c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最近在工作中，我在数据库中应用了一组错误的迁移。它最终打破了东西，没有人可以进入系统。我慌了，但我更专注于学习新的东西！</p><p id="4334" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇博客将深入探讨数据库迁移，什么是数据库模式迁移，为什么我们需要它们以及不同的实现策略。稍后，我们将查看由于在数据库上应用错误的迁移集而出错的场景，以及如何避免这种情况。</p><h1 id="ad95" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">数据库迁移</h1><p id="b198" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在开发应用程序时，您可能需要在某个时候存储一种新的信息。也许您需要添加一个新字段。此时，您必须更改数据库的结构。关系数据库结构的增量变化过程称为<strong class="ky ir"> <em class="mp">数据库模式迁移。</em> </strong></p><p id="9afd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">迁移有助于将数据库模式从其当前状态转换到新的期望状态。它可以包括删除特定的行和列、添加一组新的行、修改约束类型等。</p><p id="7066" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">简而言之，我们可以说什么是<a class="ae kv" href="https://git-scm.com/" rel="noopener ugc nofollow" target="_blank"> Git </a>管理源代码的变更；类似地，迁移到数据库。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mq"><img src="../Images/4b84928e4c8b903201a745eb4c8ee8cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BZLhlhNiYtzHLUyiTIfJsA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">移植:数据库模式的版本控制</figcaption></figure><h2 id="0bba" class="mr lt iq bd lu ms mt dn ly mu mv dp mc lf mw mx me lj my mz mg ln na nb mi nc bi translated">什么是迁移脚本？</h2><p id="ff53" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">迁移脚本或“更改”脚本会改变数据库。它通过将每个更改捕获为迁移脚本来对数据库更改进行版本控制。我们将状态转换保存在迁移文件中，这些文件描述了如何到达新的状态，并在需要时将更改恢复到旧的状态。</p><p id="4b7e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下图中，每个迁移脚本都有一个唯一的序列号，以便您知道应用迁移的顺序。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/b62915a51936505ec67a02c401d2315a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*79qEwXY9Yw0xSCbd.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:<a class="ae kv" href="https://cloud.google.com/architecture/devops/devops-tech-database-change-management" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/architecture/devo PS/devo PS-tech-database-change-management</a></figcaption></figure><h1 id="1bc4" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">我们为什么需要它？</h1><p id="4147" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">数据库迁移很有帮助，因为随着需求的变化，它们有助于简化数据库的变化过程。它最终允许开发人员安全地执行数据库模式更改。关键思想是:既然开发人员可以使用Git进行易于回滚的代码更改，为什么开发人员不能在模式更改时做同样的事情呢？</p><h1 id="0ce6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">您如何执行数据库迁移？</h1><p id="27df" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">如何执行数据库迁移在很大程度上取决于您用于该任务的工具。</p><h2 id="18cf" class="mr lt iq bd lu ms mt dn ly mu mv dp mc lf mw mx me lj my mz mg ln na nb mi nc bi translated">框架/语言相关库</h2><p id="3479" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">一些框架(像Django，Spring等。)提供记录良好的数据库迁移库。框架选择的大多数库会为您完成迁移。像Django、Alembic或Liquibase这样的库有助于将迁移定义为代码，我们在其中描述数据库的期望状态。该库负责生成适当的DDL并执行它们。这种方法的主要优点是，它有助于将迁移代码与使用中的数据库分开。然而，它也将我们限制在SQL特性的公共子集上。</p><p id="2a3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有些库提供自动生成功能。他们检查数据库模型中所做的更改，并生成迁移代码。一些库，如play evolutions和Flyway，要求我们在迁移中定义原始DDL。这使我们能够充分利用我们正在使用的数据库，但也意味着我们将不得不自己定义迁移，并变得依赖于数据库。</p><h2 id="9bd5" class="mr lt iq bd lu ms mt dn ly mu mv dp mc lf mw mx me lj my mz mg ln na nb mi nc bi translated">独立的数据库迁移软件</h2><p id="7260" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在某些情况下，您可以使用像Flyway这样的软件作为数据库的源代码控制。它们也提供了生成迁移的命令行方式，并允许定制编码来捕获数据库模式迁移。</p><h1 id="27f0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">迁移是如何进行的？</h1><ol class=""><li id="8805" class="ne nf iq ky b kz mk lc ml lf ng lj nh ln ni lr nj nk nl nm bi translated">每当我们运行迁移时，它首先从模式历史表中检查最后一次应用的迁移。该表是特定于工具的。</li><li id="ffb9" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">迁移工具扫描文件系统以寻找新的迁移。</li><li id="33a1" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">对于它发现的每个新迁移，它创建一个事务，应用DDL，并向模式历史表添加一个新条目。</li><li id="8380" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">在回滚的情况下，它识别需要取消应用的迁移，执行相应的DDL并从模式历史表中删除条目。</li></ol><p id="40c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个简单的迁移工具示例:</p><div class="ns nt gp gr nu nv"><a href="https://github.com/Nancy-Chauhan/migrations/blob/master/migration.py" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">migrations/migration . py at master Nancy-Chauhan/migrations</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">此文件包含双向Unicode文本，其解释或编译可能与下面显示的不同…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj kp nv"/></div></div></a></div><h1 id="ac10" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">我是如何破坏系统的，发生了什么？</h1><p id="27de" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我将一个不同的游戏项目连接到了一个不同的数据库。Play framework发现了一组不同于架构历史记录表中记录的迁移。它错误地确定迁移已被更改，并且未应用现有的迁移集。数据库最终处于不一致的状态。</p><p id="9565" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Play framework比传统的迁移工具更进了一步，它将迁移脚本的散列和“应用/不应用”DDL一起存储在模式历史表中。这样，即使原始迁移脚本不可用或已更改，it部门也可以回滚迁移。</p><h1 id="dae7" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">我是如何解决的，我学到了什么？</h1><p id="7f96" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">解决这个问题的通常方法是恢复整个数据库的快照，这可能是一个非常漫长的过程。但是如果您检查缺失的迁移，您可能会发现并非所有的迁移都会彻底改变数据库。通过比较模式历史表，您将找到缺失的迁移并手动运行它们。这在您运行错误迁移的情况下也会有所帮助。</p><p id="82f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我的例子中，我很幸运，并不是所有的迁移都因为迁移的“down”脚本中的一个bug而没有被应用。玩应用程序，直到错误的迁移。迁移后的更改并不多，我可以手动运行迁移，并更改一些数据以使数据库恢复一致性。</p><p id="16b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我学到了什么？</p><ul class=""><li id="1971" class="ne nf iq ky b kz la lc ld lf ok lj ol ln om lr on nk nl nm bi translated">在生产环境中，永远不要让迁移工具自动取消应用迁移。</li><li id="e357" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr on nk nl nm bi translated">在进行任何迁移之前，请务必备份数据库。</li><li id="78d9" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr on nk nl nm bi translated">如果迁移出了问题，检查模式历史表，看看是否可以执行一些手动纠正，以使服务快速启动和运行。</li></ul></div><div class="ab cl oo op hu oq" role="separator"><span class="or bw bk os ot ou"/><span class="or bw bk os ot ou"/><span class="or bw bk os ot"/></div><div class="ij ik il im in"><p id="4da6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这帮助我了解了数据库迁移的内部原理，并意识到打破常规可以让你学到更多！</p><p id="2a9a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">坚持学习！💜</p></div></div>    
</body>
</html>