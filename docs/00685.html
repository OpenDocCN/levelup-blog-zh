<html>
<head>
<title>Continuous Deployment with Travis and CONDA</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Travis和CONDA的持续部署</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/continuous-deployment-with-travis-and-conda-f385fec1a3f?source=collection_archive---------2-----------------------#2019-06-27">https://levelup.gitconnected.com/continuous-deployment-with-travis-and-conda-f385fec1a3f?source=collection_archive---------2-----------------------#2019-06-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/dba19dc8d23cf546b6dd5063c024e268.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TNvKtw0Iyt1Cu8bXIfhjrQ.jpeg"/></div></div></figure><p id="e202" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Travis和Azure等持续集成平台现在在现代开发环境中无处不在。自动使用别人的计算资源来测试和部署你的软件当然值得去弄清楚这些工具是如何工作的。在使用Python和CONDA时，下面的指南将把你推向更高的学习曲线。</p><p id="5c51" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里的目标不仅仅是让这个工作一次，而是如何创建尽可能低的维护系统。请注意，这不是CONDA或Travis的入门指南，下面的说明假设您对这两个系统都有初步的了解。如果没有，这里有一些有用的链接，分别为<a class="ae kz" href="https://docs.travis-ci.com/user/languages/python/" rel="noopener ugc nofollow" target="_blank">特拉维斯</a>和<a class="ae kz" href="https://docs.conda.io/projects/conda/en/latest/user-guide/getting-started.html" rel="noopener ugc nofollow" target="_blank">康达</a>提供帮助。我们将讨论的内容是:</p><ul class=""><li id="d91b" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">如何安装康达</li><li id="3e9b" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">如何用CONDA方法安装Python包</li><li id="9528" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">如何将包上传到CONDA</li></ul></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><p id="4efd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">第一步是用我们计划用来测试我们的包的Python版本安装Miniconda。如果您只熟悉Anaconda，那么Miniconda是相同的软件包管理系统，只是没有默认的预安装软件包。这将减少我们的构建时间。下面的设置是样板文件，除了Python版本矩阵之外，无需修改就可以在存储库之间共享</p><figure class="lv lw lx ly gt ju"><div class="bz fp l di"><div class="lz ma l"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">安装Miniconda</figcaption></figure></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><p id="7c67" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们已经安装了Miniconda，我们准备创建一个虚拟环境，其中包含执行测试所必需的包。蛮力方法看起来像这样，我在各种仓库中看到很多。</p><figure class="lv lw lx ly gt ju"><div class="bz fp l di"><div class="lz ma l"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">不可维护！</figcaption></figure><p id="e241" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，这是可行的，但是我发现两个主要的缺陷在开发周期中很快暴露出来:</p><ol class=""><li id="1d67" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky mf lg lh li bi translated">我们现在已经在我们的<strong class="kd iu"> </strong>仓库中创建了<strong class="kd iu">第二个</strong>位置，在那里我们需要管理我们的依赖项。如果我们需要改变环境，我们需要记住改变CONDA配方和Travis测试套件中的列表</li><li id="0e1d" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky mf lg lh li bi translated">更糟糕的是，我们没有使用康达配方进行测试。我们甚至不会注意到我们没有指定正确的包，直到我们尝试并使用我们希望在这里部署的CONDA包，这意味着我们可能会部署一个无法工作的CONDA包。</li></ol><p id="91ec" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里的解决方案是在我们的CONDA配方中指定的环境中构建和测试。我喜欢将我的菜谱放在与我的代码相同的存储库中，但是如果这不适合您的应用程序，那么总是可以克隆或者子模块菜谱，以确保它在Travis上可用。这里我们假设我们有一个名为<code class="fe mg mh mi mj b">pkg_name</code>的包，它的CONDA recipe位于顶层文件夹<code class="fe mg mh mi mj b">conda-recipe</code>(我知道真正的创意)。这个解决方案看起来像这样:</p><figure class="lv lw lx ly gt ju"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="68e8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">诀窍是我们首先使用这个方法构建我们的包，然后直接从文件系统安装它，就好像它是托管在其他地方的通道一样。这尽可能地复制了用户从我们的存储库中安装软件包时会收到的代码。您可能会注意到我们在创建环境时使用的额外的<code class="fe mg mh mi mj b">dev-requirements.txt</code>文件。这是只需要运行测试套件的包所在的地方，我们不想给我们的用户增加额外的依赖，但我们确实希望向其他开发人员明确他们在运行测试套件时需要的环境。</p><p id="6342" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果从<code class="fe mg mh mi mj b">pip</code>安装软件包切换，您可能会注意到这种方法需要更长的时间来完成。总的来说，CONDA似乎比<code class="fe mg mh mi mj b">pip</code>慢一点，在我们测试之前构建我们的包的额外步骤增加了开销。然而，如果我们要建立和运输我们的包到我们的CONDA渠道，无论如何这一步必须是复杂的，这只是有点讨厌，它增加了我们看到测试是否失败之前的时间。我认为，知道您正在部署的CONDA配方已经过全面审查，这种安慰是值得多花一两分钟的，这是使用其他人的硬件来完成所有这些工作的好处的一部分。</p></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><p id="5a47" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">测试套件的实际调用对于您的存储库来说可能是唯一的。最简单的执行可能看起来像这样，如果你<code class="fe mg mh mi mj b">pytest</code>。</p><figure class="lv lw lx ly gt ju"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="589f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我个人喜欢使用verbose选项运行我的<code class="fe mg mh mi mj b">pytest</code>套件，但是您应该根据自己的个人喜好来选择输出的结构。</p></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><p id="4fb4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，我们已经执行了测试，并对我们创建的代码充满信心，我们准备将我们的包上传到我们的CONDA通道。幸运的是，由于我们已经构建了测试它的包，这一步应该很短。不过，我们确实要小心一些“陷阱”。首先，如果我们在一个特定的分支上，我们可能只想上传。我们还必须小心，如果有人分叉这个存储库，他们的Travis构建不会上传文件。下面我举了一个例子来说明这可能是什么样子:</p><figure class="lv lw lx ly gt ju"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="24e1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一些有用的环境变量包括:</p><ul class=""><li id="6ee9" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated"><code class="fe mg mh mi mj b">TRAVIS_PULL_REQUEST</code>:(对/错)基于Travis构建是否由pull请求触发。</li><li id="be1b" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><code class="fe mg mh mi mj b">TRAVIS_REPO_SLUG</code>:触发Travis构建的组织和存储库名称</li><li id="7d49" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><code class="fe mg mh mi mj b">TRAVIS_BRANCH</code>:触发Travis构建的分支的名称</li><li id="1b7f" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><code class="fe mg mh mi mj b">TRAVIS_TAG</code>:如果Travis构建是由标签触发的，那么可以在这个变量中找到它。否则就是空的。</li></ul><p id="d294" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可能注意到我们在Travis文件中使用了一个环境变量<code class="fe mg mh mi mj b">$CONDA_UPLOAD_TOKEN</code>。这是我们在Anaconda站点上生成的一个密钥，它允许上传新的包。请记住，这个令牌允许任何人将包上传到您的存储库中。像对待密码一样小心对待它。要生成令牌，请执行以下操作:</p><ol class=""><li id="80c0" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky mf lg lh li bi translated">登录<a class="ae kz" href="https://anaconda.org" rel="noopener ugc nofollow" target="_blank">https://anaconda.org</a>并导航至您希望上传软件包的组织。</li><li id="472c" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky mf lg lh li bi translated">点击右上角的用户名，导航至<em class="mk">设置- &gt;访问。</em>此时您很可能会被要求重新认证。</li><li id="552b" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky mf lg lh li bi translated">使用该表单创建新令牌。给它一个描述性的名称，至少要有读写权限。</li></ol><figure class="lv lw lx ly gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ml"><img src="../Images/ae0d520e0628134fbd2c1194f6e6bfa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I3n3wI5oPxJpgVx1FPGqdw.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">您的令牌需要读写权限</figcaption></figure><p id="9142" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">4.创建后，令牌将在下表中可见。查看它并将其复制到您的剪贴板中。</p><p id="e44e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，关于如何在Travis上添加环境变量作为令牌，您有几个<a class="ae kz" href="https://docs.travis-ci.com/user/environment-variables/#defining-encrypted-variables-in-travisyml" rel="noopener ugc nofollow" target="_blank">选项</a>。最简单的方法是导航到Travis网站上的存储库，并在右上角找到“更多选项”菜单。从那里，进入“Settings”选项卡，使用提示添加您的令牌，其名称与我们在上面的<code class="fe mg mh mi mj b">travis.yml</code>文件中编写的环境变量相匹配。确保该值未设置为在您的生成的日志输出中显示。</p><figure class="lv lw lx ly gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mm"><img src="../Images/21df22411db535963a85a824649f715d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gd-I8H4iuc7ngnUrQ6nqgQ.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">Travis中的环境变量条目</figcaption></figure></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><p id="1455" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将对Travis文件的更改提交到存储库应该会自动触发构建。通过查看Anaconda页面上的构建列表，或者从命令行使用<code class="fe mg mh mi mj b">conda search</code>,您可以在构建结束时检查包是否被正确上传。请注意，如果您担心添加到Conda设置中的另一个频道有重复的软件包，您可以随时添加<code class="fe mg mh mi mj b">--override-channels</code>选项。整个文件可以在<a class="ae kz" href="https://gist.github.com/teddyrendahl/617bb8cab711c78a588d66b4b6b72623" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="97f8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在你知道了！希望这是有帮助的。我在任何地方都找不到完整的指南，所以我想我应该写下我的过程。如果您有任何反馈，请随时参与进来。</p></div></div>    
</body>
</html>