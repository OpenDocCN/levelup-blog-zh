<html>
<head>
<title>3 and a Half Ways to Store Configuration for Microservices in .NET</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">存储微服务配置的3.5种方法。网</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/3-and-a-half-ways-to-store-configuration-for-microservices-in-net-539eb37bd462?source=collection_archive---------7-----------------------#2022-01-31">https://levelup.gitconnected.com/3-and-a-half-ways-to-store-configuration-for-microservices-in-net-539eb37bd462?source=collection_archive---------7-----------------------#2022-01-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e87a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">对利弊进行分析。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/844e7532f969a0f2ca7230c201c4f3af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1t4UOqoxG5T5D-PF"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@sigmund?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">西格蒙德</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="b6a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">开发人员可以采用几种方法来存储和管理microservices .NET的配置变量。每种方法都有其优点和缺点，应该对其进行评估，以选择最适合应用程序需求的方法。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="547d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">1.源代码作为配置存储？</h1><p id="f66e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当执行不同复杂程度的相同任务有几个选项时，通常最好先评估最简单选项的利弊。</p><p id="1c8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于开发人员来说，最简单的选择是在微服务的源代码中存储一个配置值，如URI，以直接连接到另一个服务。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="323c" class="ne md it na b gy nf ng l nh ni">var uri = "https://some-service.com/";</span><span id="84f6" class="ne md it na b gy nj ng l nh ni">var httpClient = new HttpClient();</span><span id="4358" class="ne md it na b gy nj ng l nh ni">var data = await httpClient.GetAsync(uri);</span></pre><p id="b7d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简单吧？</p><h2 id="5450" class="ne md it bd me nk nl dn mi nm nn dp mm li no np mo lm nq nr mq lq ns nt ms nu bi translated">优点:</h2><ul class=""><li id="126d" class="nv nw it lb b lc mu lf mv li nx lm ny lq nz lu oa ob oc od bi translated">这个解决方案实施起来非常简单。</li><li id="22fd" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">阅读源代码的开发人员可以<strong class="lb iu">立即</strong>了解正在使用哪个配置值。</li></ul><h2 id="a067" class="ne md it bd me nk nl dn mi nm nn dp mm li no np mo lm nq nr mq lq ns nt ms nu bi translated">缺点:</h2><ul class=""><li id="3710" class="nv nw it lb b lc mu lf mv li nx lm ny lq nz lu oa ob oc od bi translated">在将微服务代码部署到不同的环境(如测试、试运行或生产)时，<strong class="lb iu">无法更改</strong>URI值。</li><li id="8557" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">每次需要更改和应用新的配置值时，都需要重新部署微服务。</li><li id="246d" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">在代码中存储配置值打破了<strong class="lb iu">粒度访问控制</strong>模型。任何有权访问源代码的人都可以看到配置值，窃取它们，并滥用它们。</li><li id="9948" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">对配置进行硬编码违反了<a class="ae ky" href="https://12factor.net/" rel="noopener ugc nofollow" target="_blank">十二因素应用</a>的<a class="ae ky" href="https://12factor.net/config" rel="noopener ugc nofollow" target="_blank">第三原则</a>。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="049d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">2.环境变量</h1><p id="1f4e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">将配置从源代码中分离出来可以消除前面方法的几个缺点。</p><p id="df44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">英寸NET中，开发人员可以将微服务项目配置作为键值对存储在<code class="fe oj ok ol na b">appsettings.json</code>文件中，并使用<code class="fe oj ok ol na b">IConfiguration</code>来读取这些值。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="f6a1" class="ne md it na b gy nf ng l nh ni"><strong class="na iu">//appsettings.json file:<br/></strong>{<br/>  "ServiceUri": ""<br/>}</span><span id="54c7" class="ne md it na b gy nj ng l nh ni"><strong class="na iu">//source code:</strong><br/>public class Service<br/>{<br/>    private IConfiguration _configuration;</span><span id="4378" class="ne md it na b gy nj ng l nh ni">    public Service(IConfiguration configuration) <br/>        =&gt; _configuration = configuration;<br/>    <br/>    public async Data GetData()<br/>    {<br/>        var uri = _configuration["ServiceUri"];</span><span id="e8f4" class="ne md it na b gy nj ng l nh ni">        var httpClient = new HttpClient();</span><span id="1702" class="ne md it na b gy nj ng l nh ni">        var data = await httpClient.GetAsync(uri);</span><span id="2d9c" class="ne md it na b gy nj ng l nh ni">        //...<br/>    }<br/>}</span></pre><p id="7323" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里需要注意的一点是，使用这种方法，不需要在存储库中提交URI。对于本地开发，开发者可以把URI放在<code class="fe oj ok ol na b">appsettings.json</code>或者更好地使用<code class="fe oj ok ol na b">secret.json</code>文件。然而，当微服务作为应用服务部署到Azure基础设施时，开发人员或DevOps可以创建<code class="fe oj ok ol na b">ServiceUri</code>属性并在那里设置值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/3e6f78af60bf166207965971da6cc0ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Rhn9T9TOIedhZ4pduyGDA.png"/></div></div></figure><p id="60e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Azure App Service中，<code class="fe oj ok ol na b">ServiceUri</code>和其他设置作为环境变量传递给应用程序代码。</p><h2 id="5d93" class="ne md it bd me nk nl dn mi nm nn dp mm li no np mo lm nq nr mq lq ns nt ms nu bi translated">优点:</h2><ul class=""><li id="0065" class="nv nw it lb b lc mu lf mv li nx lm ny lq nz lu oa ob oc od bi translated">配置是从源代码中解耦的<strong class="lb iu"/>，这允许开发者根据代码部署的环境来设置配置值。也不需要将值存储在存储库中。</li><li id="39c5" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">可以以<strong class="lb iu">粒度</strong>的方式配置访问控制。例如，开发人员可能只被授权访问源代码，而DevOps可以读取和更改配置。</li></ul><h2 id="7e73" class="ne md it bd me nk nl dn mi nm nn dp mm li no np mo lm nq nr mq lq ns nt ms nu bi translated">缺点:</h2><ul class=""><li id="c166" class="nv nw it lb b lc mu lf mv li nx lm ny lq nz lu oa ob oc od bi translated">没有办法动态改变配置<strong class="lb iu"/>。配置部分的任何更改都需要重新启动微服务。</li><li id="2748" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">如果配置值需要在微服务之间<strong class="lb iu">共享</strong>，那么维护就很复杂。如果少数微服务需要具有相同的配置键值对，则需要为每个微服务复制和粘贴多次。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2e04" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">3.Azure应用配置</h1><p id="f8ec" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">本质上，前一种方法的两个缺点都可以通过在系统中使用Azure App配置服务来解决。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/da49bc85c51b2600152dc5d63ba5e853.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*xcn95mU8WMCR9aaa7nxlhA.png"/></div></div></figure><p id="16d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用程序配置充当配置值的集中存储，并提供许多附加功能来简化配置管理。</p><h2 id="d8d5" class="ne md it bd me nk nl dn mi nm nn dp mm li no np mo lm nq nr mq lq ns nt ms nu bi translated">优点:</h2><ul class=""><li id="6239" class="nv nw it lb b lc mu lf mv li nx lm ny lq nz lu oa ob oc od bi translated">所有配置都存储在<strong class="lb iu">一个地方</strong>，项目的很多微服务都可以访问。这可以大大简化具有许多微服务的项目的配置管理。</li><li id="b11e" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">微服务可以通过实现<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/azure-app-configuration/enable-dynamic-configuration-dotnet-core-push-refresh?tabs=windowscommandprompt" rel="noopener ugc nofollow" target="_blank">轮询或推送模型</a>动态<strong class="lb iu">接收来自App配置的配置更改，而无需重启。</strong></li><li id="01cf" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">Azure应用配置服务提供了许多<strong class="lb iu">有用的功能</strong>，例如静态加密、时间点快照、功能标志等等。</li></ul><h2 id="d9e5" class="ne md it bd me nk nl dn mi nm nn dp mm li no np mo lm nq nr mq lq ns nt ms nu bi translated">缺点:</h2><ul class=""><li id="0822" class="nv nw it lb b lc mu lf mv li nx lm ny lq nz lu oa ob oc od bi translated">由于引入了必须维护和保护的额外组件(应用配置),系统<strong class="lb iu">复杂性</strong>增加。</li></ul><p id="1be9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有一点需要记住的是，Azure应用配置不建议用于存储机密或其他类型的敏感数据。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c4ea" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">4.蓝色钥匙保险库</h1><p id="d57c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Azure Key Vault是开发人员可以用来集中存储微服务配置的另一项服务。虽然Azure Key Vault看起来像是Azure应用配置的替代品，但它实际上是对它的补充。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/749cf78ce65b18318a23cb576ba97a3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*BqT8UQuVOO-L7F45jdBojw.png"/></div></div></figure><p id="45fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然Azure应用配置应该存储非敏感的配置数据，但Azure Key Vault的目的是存储所有类型的敏感数据，如机密、证书等。，因为它有许多安全功能，如密钥轮换、恢复管理、清除检测等。</p><p id="2b18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用两种不同的Azure服务来存储配置数据看起来让人不知所措。然而，开发人员能够将Azure应用配置服务连接到Azure Key Vault。在这种情况下，Azure应用配置(就像一个门面)可以从Azure Key Vault读取值，这大大简化了对这两种服务的管理。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c0a3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">摘要</h1><p id="5893" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">配置值不应硬编码，尤其是敏感配置。</p><p id="f3c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">配置可以存储在环境变量中，但是这不允许跨多个微服务重用同一个配置变量。</p><p id="4be5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Azure App配置和Azure Key Vault都允许开发者集中管理配置。但是，Azure App配置用于非敏感数据，Azure Key Vault用于敏感数据。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="d1f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读。如果你喜欢你所读到的，看看下面这个故事:</p><div class="op oq gp gr or os"><a rel="noopener  ugc nofollow" target="_blank" href="/5-asp-net-core-open-source-projects-to-gain-practical-knowledge-24fbf9164230"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">5个ASP.NET核心开源项目，获取实用知识</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">在实践中学习。</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="pb l"><div class="pc l pd pe pf pb pg ks os"/></div></div></a></div></div></div>    
</body>
</html>