<html>
<head>
<title>How I removed website layout shift using a predeploy script</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何使用预部署脚本消除网站布局偏移</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/improving-cumulative-layout-shift-on-pre-deploy-stage-1636fb1386cc?source=collection_archive---------12-----------------------#2021-02-11">https://levelup.gitconnected.com/improving-cumulative-layout-shift-on-pre-deploy-stage-1636fb1386cc?source=collection_archive---------12-----------------------#2021-02-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="68a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">三年多前，当我开始我的网络开发者之旅时，我创建了我的网站。最近，我检查了存储库，做了一些改进。看到我在那里犯了那么多错误，真是令人震惊。<a class="ae kl" href="https://web.dev/cls/" rel="noopener ugc nofollow" target="_blank">累积布局偏移</a> (CLS)是我遇到的最大的UX问题之一，也就是说，从CMS获取的内容导致了页面上的意外移动。</p><p id="11d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我敢肯定，每个人都有一个恼人的经验，突然改变页面，而它是加载。例如，当你开始读一篇文章，第二篇文章就消失了。或者当你正要点击一个按钮，却无意中点击了刚刚出现的广告。我的网站也有同样的问题！</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/6ccd0bfe0a3ab26af75da29d21a33b80.png" data-original-src="https://miro.medium.com/v2/resize:fit:816/0*z4W-X8OXDAZKsvUQ"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae kl" href="https://www.webpagetest.org/video/" rel="noopener ugc nofollow" target="_blank">网页测试</a>捕获的页面加载视频</figcaption></figure><p id="ffbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不过我还是设法解决了:)</p><h2 id="d1d2" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">加载占位符</h2><p id="576b" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">一开始我有多种解决方案。第一个是添加内容加载占位符，以显示内容即将到来。尽管这种方法会提高CLS，但是如果呈现的内容条目的形状与占位符不同，它仍然会导致偏移。此外，内容加载速度没有提高。此外，通过添加占位符，我会装载额外的JavaScript来降低页面速度。</p><h2 id="9adb" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">服务工作者缓存</h2><p id="c5e3" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">其次，我尝试使用服务工作者来缓存内容条目<a class="ae kl" href="https://developers.google.com/web/ilt/pwa/caching-files-with-service-worker" rel="noopener ugc nofollow" target="_blank">。这种方法可以提高页面访问者返回的速度和UX。不幸的是，它不会影响首次页面加载。老实说，我并不指望我的页面会有很多回头客，因为它的内容不会定期变化。因此，我需要专注于提高初始页面加载。</a></p><h2 id="0e3f" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">构建前提取数据</h2><p id="6d63" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">在接下来的头脑风暴中，我开始质疑使用CMS的必要性。或者，我可以管理项目存储库中JSON文件的内容。然而，我更喜欢在CMS中编辑内容，因为它有方便的用户界面和图像的自动优化。我想到了在构建之前获取内容的想法。在这种情况下，数据将成为构建的一部分，并从网站服务器而不是CMS提供服务。为此，我创建了一个节点脚本来获取数据并将其写入JSON文件。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="9ba2" class="ky kz iq lx b gy mb mc l md me">// fetchContent.json</span><span id="0aa7" class="ky kz iq lx b gy mf mc l md me">const fetchPosts = async () =&gt; {<br/>  const response = await client<br/>    .getEntries({<br/>      content_type: "card",<br/>    });</span><span id="faf1" class="ky kz iq lx b gy mf mc l md me">  writeData(response, "./src/data/posts.json");<br/>};</span></pre><p id="6174" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mg">注:</em><code class="fe mh mi mj lx b"><em class="mg">client</em></code><em class="mg"/><code class="fe mh mi mj lx b"><em class="mg">getEntries</em></code><em class="mg">由</em><a class="ae kl" href="https://contentful.github.io/contentful.js/contentful/8.1.7/" rel="noopener ugc nofollow" target="_blank"><em class="mg">Contentful CMS JavaScript SDK</em></a><em class="mg">提供。<br/> </em>在React组件中，我用从文件导入的数据替换了对CMS的请求。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="b9c3" class="ky kz iq lx b gy mb mc l md me">import posts from "../data/posts.json";</span></pre><p id="c7a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">数据获取脚本被添加到<code class="fe mh mi mj lx b">npm run predeploy</code>命令中。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="4d24" class="ky kz iq lx b gy mb mc l md me">// package.json</span><span id="711d" class="ky kz iq lx b gy mf mc l md me">"scripts": {<br/>    "predeploy": "node fetchContent.js &amp;&amp; npm run build",<br/>}</span></pre><p id="afcb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用<a class="ae kl" href="https://www.netlify.com/products/build/" rel="noopener ugc nofollow" target="_blank"> Netlify </a>作为托管和连续交付(CD)服务，在这里我可以配置一个构建命令。通过将默认的<code class="fe mh mi mj lx b">npm run build</code>改为<code class="fe mh mi mj lx b">npm run predeploy</code>，我已经将“获取内容”脚本添加到了CD管道中，每当我合并到主分支时，就会自动触发这个脚本。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><p id="2609" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种方法帮助我将累积布局偏移减少到几乎为零！你可以用肉眼看出区别:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/e3f5b81b0a5f17406e974bae6fa44ea6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*9qtUoyr7Gp6w-ZQ03ZCWig.gif"/></div></div></figure><p id="cde7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在我的网站项目中配置的<a class="ae kl" href="https://github.com/GoogleChrome/lighthouse-ci/blob/master/docs/getting-started.md#github-status-checks" rel="noopener ugc nofollow" target="_blank"> Lighthouse CI </a>支持web性能回归测试。基于与之前站点版本的比较，预部署脚本的更改带来了一系列积极的“副作用”，即<a class="ae kl" href="https://web.dev/lcp/" rel="noopener ugc nofollow" target="_blank">最大内容绘制</a>、<a class="ae kl" href="https://web.dev/tti/" rel="noopener ugc nofollow" target="_blank">交互时间</a>、<a class="ae kl" href="https://web.dev/tbt/" rel="noopener ugc nofollow" target="_blank">总阻塞时间</a>略有减少。令人惊讶的是，<a class="ae kl" href="https://web.dev/fcp/" rel="noopener ugc nofollow" target="_blank">第一个内容丰富的油漆</a>和整体<a class="ae kl" href="https://web.dev/speed-index/" rel="noopener ugc nofollow" target="_blank">速度指数</a>有所增加。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mw"><img src="../Images/5cd489e48face80b6deb5dc65a76102e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ne0gsLS4-dwoeE8apD8CmA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae kl" href="https://github.com/GoogleChrome/lighthouse-ci/blob/master/docs/getting-started.md#the-lighthouse-ci-server" rel="noopener ugc nofollow" target="_blank"> Lighthouse CI服务器</a>生成的性能指标差异</figcaption></figure><p id="cef5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://www.webpagetest.org/" rel="noopener ugc nofollow" target="_blank"> WebPageTest </a>上进行的更详细的手动测试显示，我的网站服务器响应时间(<a class="ae kl" href="https://web.dev/time-to-first-byte/" rel="noopener ugc nofollow" target="_blank">到第一个字节的时间</a>)比以前更长，因为它将内容数据包括到响应中。您可以在下面的图表中看到，随着包含内容的JSON文件被导入并与React组件捆绑在一起，JavaScript的大小变大了。这是第一次内容丰富的油漆增加的原因之一。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mx"><img src="../Images/bb432d6617c44d27d92e2ed0c9b969c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1cegD56p1ouVaHPm5JpZ2g.png"/></div></div></figure><p id="8d80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个更积极的成果是请求数量从26个下降到16个。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi my"><img src="../Images/3137097275ec8a6b4e5a6fca2f528fd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Y_R9XZ4gtb82i_yYzO6-Q.png"/></div></div></figure><h2 id="5126" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">CMS触发的部署</h2><p id="9bdc" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">由于请求被转移到“预部署”脚本，每次CMS中的内容发生变化时，都需要重新构建网站。为了避免任何手动步骤，可以使用webhooks自动触发CD管道。</p><p id="5944" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用的内容丰富的CMS提供了这样一个<a class="ae kl" href="https://www.contentful.com/developers/docs/tutorials/general/automate-site-builds-with-webhooks/" rel="noopener ugc nofollow" target="_blank">功能</a>。设置分两步完成:在Netlify设置中生成webhook URL，并将此URL添加到Contentful webhook设置中。每当发布新内容时，这样的事件会自动触发构建并部署网站的新版本。</p><h1 id="af9a" class="mz kz iq bd la na nb nc ld nd ne nf lg ng nh ni lj nj nk nl lm nm nn no lp np bi translated">下一步是什么？</h1><p id="528f" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">虽然我已经修复了累积布局偏移，但是我还有很多需要改进的地方。例如，最大的内容丰富的绘画是大约3秒，这对于像我这样的小页面来说是一个巨大的数字。</p><p id="38b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我的网站内容不会动态变化。从用户的角度来看，它是一个静态页面。尽管如此，它是在客户端呈现的，服务于大量未使用的JavaScript，增加了服务器响应时间，并且需要比它应该的更多的CPU。页面加载时间和UX将受益于在部署到服务器之前作为静态HTML页面生成。结果，客户端将收到准备好的HTML和CSS，而不是处理ReactJS代码。</p><p id="85fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在构建项目之前获取数据是我生成静态站点的第一步。我会让你知道接下来的步骤🤙🏻</p></div></div>    
</body>
</html>