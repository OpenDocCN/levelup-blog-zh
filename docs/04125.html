<html>
<head>
<title>Build a Node App to receive text messages with ngrok and store in an RDS Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建一个节点应用程序，使用ngrok接收文本消息并存储在RDS数据库中</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-node-app-to-receive-an-sms-with-twilio-and-send-the-message-content-to-an-rds-mysql-database-afd7c845eed3?source=collection_archive---------8-----------------------#2020-06-10">https://levelup.gitconnected.com/a-node-app-to-receive-an-sms-with-twilio-and-send-the-message-content-to-an-rds-mysql-database-afd7c845eed3?source=collection_archive---------8-----------------------#2020-06-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f2d73402042246ffc34f1bb40717370b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rG5eKZnJMLnzu5XNZtj0GA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片来自<a class="ae kc" href="https://unsplash.com/photos/yg7WVUOf4N8" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="d913" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本文将演示如何创建一个节点应用程序，该应用程序将使用ngrok和Twilio接收SMS消息，并将消息内容发送到RDS MySQL数据库。</p><h1 id="6600" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">第一步:设置一个AWS账户和一个Twilio账户，并设置您的环境和RDS数据库</strong></h1><p id="acfd" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">创建一个AWS账户和一个Twilio账户。</p><p id="f7c7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要设置您的环境，您需要Node、Express和MySQL。如果你运行的是Ubuntu并且没有安装这些，使用下面的脚本。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b954" class="mn lc iq mj b gy mo mp l mq mr">#!/bin/bash<br/>sudo apt-get update<br/>sudo apt-get install node -y<br/>sudo apt-get install npm -y<br/>sudo npm install -g express-generator<br/>sudo apt-get update<br/>sudo apt-get install mysql-client-core-5.7 -y<br/>sudo apt-get install unzip</span></pre><p id="7f82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要启动您的数据库，请转到AWS RDS选项卡，并创建一个免费层MYSQL数据库。</p><h1 id="9c13" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">第二步:创建节点应用并安装依赖项</strong></h1><p id="00d0" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">当您等待RDS实例启动时，转到您的终端并导航到您的工作目录。使用以下命令初始化节点应用程序:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="aecf" class="mn lc iq mj b gy mo mp l mq mr">express myApp</span></pre><p id="d1d5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导航到新创建的文件夹，并使用</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d916" class="mn lc iq mj b gy mo mp l mq mr">npm install</span></pre><p id="bd95" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要接收SMS消息，将mysql、twilio和body-parser添加到您的新应用程序中。为此，运行以下命令。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="e258" class="mn lc iq mj b gy mo mp l mq mr">npm install mysql -- save<br/>npm install twilio -- save<br/>npm install body-parser -- save</span></pre><p id="c16d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">测试方式:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="89d1" class="mn lc iq mj b gy mo mp l mq mr">npm start</span></pre><p id="81fe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，导航到您的localhost:3000(或$YOUR_PUBLIC_IP:3000)。这将显示默认的快速页面。</p><h1 id="1c82" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">步骤3:配置您的RDS数据库</strong></h1><p id="7fb1" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">导航到AWS控制台，确认RDS数据库已创建。单击数据库的名称，并记下端点。使用以下命令连接到您的数据库:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="810d" class="mn lc iq mj b gy mo mp l mq mr">mysql -h $YOUR_ENDPOINT -P 3306 -u $USERNAME -p</span></pre><p id="5767" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输入您的密码并确认一切正常:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5cfb" class="mn lc iq mj b gy mo mp l mq mr">SHOW DATABASES;</span></pre><p id="7905" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将显示默认数据库。用一些虚拟数据建立一个测试数据库(下面的SQL创建了一个名为text_messages的数据库和一个名为data的表，表中有一个假条目)。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="1860" class="mn lc iq mj b gy mo mp l mq mr">CREATE DATABASE text_messages;<br/>USE text_messages;<br/>CREATE TABLE sms (number varchar(100), message varchar(100));<br/>INSERT INTO sms (number, message) VALUES('1234121234', 'This is a test');</span></pre><p id="17ec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，确认该表已经填充了:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="95e0" class="mn lc iq mj b gy mo mp l mq mr">SELECT * FROM sms;</span></pre><p id="7e59" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，用“退出”关闭连接。</p><h1 id="2325" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">步骤4:将您的节点应用程序连接到您的Twilio帐户</strong></h1><p id="f8b3" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">要接收消息，请转到您的应用程序的文件夹，创建一个名为receive_sms.js的文件，其中包含以下代码。它在/sms接收post请求，将号码和消息插入数据库。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f447" class="mn lc iq mj b gy mo mp l mq mr">var mysql = require(‘mysql’);<br/>var bodyParser = require(‘body-parser’);<br/>const http = require(‘http’);<br/>const express = require(‘express’);<br/>const MessagingResponse = require(‘twilio’).twiml.MessagingResponse;<br/>const app = express();</span><span id="9379" class="mn lc iq mj b gy ms mp l mq mr"><br/>app.use(bodyParser.urlencoded({ extended: false }));<br/>app.use(bodyParser.json());</span><span id="cd7f" class="mn lc iq mj b gy ms mp l mq mr">var my_database = mysql.createConnection({<br/>     host: ‘$YOUR_RDS_ENDPOINT’,<br/>     port : ‘3306’,<br/>     user : ‘admin’,<br/>     password: ‘$YOUR_RDS_PASSWORD’,<br/>     database: ‘text_messages’</span><span id="ae62" class="mn lc iq mj b gy ms mp l mq mr">});</span><span id="2a38" class="mn lc iq mj b gy ms mp l mq mr">app.post(‘/sms’, (req, res) =&gt; {<br/>     const twiml = new MessagingResponse();<br/>     console.log(req.body);</span><span id="279f" class="mn lc iq mj b gy ms mp l mq mr">     twiml.message(“DEFAULT RESPONSE”);<br/>     res.writeHead(200, {‘Content-Type’: ‘text/xml’});<br/>     res.end(twiml.toString());</span><span id="b0ea" class="mn lc iq mj b gy ms mp l mq mr">     var number = req.body.From.toString();<br/>     var message = req.body.Body;</span><span id="125e" class="mn lc iq mj b gy ms mp l mq mr">     var query = “INSERT INTO sms (number, message) VALUES (?, ?)”;<br/>     var inserts = [req.body.From.toString(), req.body.Body];<br/>     queryString = mysql.format(query, inserts);</span><span id="7813" class="mn lc iq mj b gy ms mp l mq mr">     my_database.query(queryString, function(err, result, fields){<br/>          if (err) throw err;<br/>          console.log(“record inserted”);<br/>     });<br/>});</span><span id="1207" class="mn lc iq mj b gy ms mp l mq mr">http.createServer(app).listen(1336, () =&gt; {<br/>     console.log(‘Port 4000’);<br/>});</span></pre><p id="b9f7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，用下面的代码在后台运行您的应用程序。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="aa40" class="mn lc iq mj b gy mo mp l mq mr">node receive_sms.js &amp;</span></pre><p id="c539" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">步骤5:使用ngrok将你的应用程序连接到Twilio并接收消息</strong></p><p id="5723" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ngrok是一个允许你的应用程序连接到Twilio的工具。有付费版和免费版。免费版本将允许您运行ngrok最多8小时。</p><p id="2ef5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要下载ngrok，导航到<a class="ae kc" href="https://ngrok.com/download" rel="noopener ugc nofollow" target="_blank">https://ngrok.com/download</a>并复制linux下载URL。然后，转到工作站的主目录，用wget下载ngrok:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="9b5a" class="mn lc iq mj b gy mo mp l mq mr">wget <a class="ae kc" href="https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip" rel="noopener ugc nofollow" target="_blank">https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip</a></span></pre><p id="eb0b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">解压缩下载内容:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="cf6c" class="mn lc iq mj b gy mo mp l mq mr">unzip ngrok-stable-linux-amd64.zip</span></pre><p id="8da1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，打开应用程序的端口(在上面的例子中是3000):</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="e493" class="mn lc iq mj b gy mo mp l mq mr">./ngrok http 3000</span></pre><p id="d0fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将显示一个包含各种信息的屏幕。保持ngrok运行，复制https转发链接。它应该看起来像这样:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="2f08" class="mn lc iq mj b gy mo mp l mq mr"><a class="ae kc" href="https://743e14723c1f.ngrok.io" rel="noopener ugc nofollow" target="_blank">https://732e14237c1f.ngrok.io</a></span></pre><p id="bd97" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Ngrok每次运行时都会随机生成这些URL，所以要让它一直运行下去。</p><p id="2f29" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">打开浏览器，导航至Twilio控制台，然后转到电话号码屏幕。选择您的号码(如果您还没有号码，请购买一个)。单击电话号码并导航至页面底部的消息部分:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/4cef360a11c58758ecb680573a60a5af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f7zSgNmI-KWKOBF5wRHeqA.png"/></div></div></figure><p id="3dfd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将ngrok URL粘贴到“消息到达”文本字段，并将“/sms”附加到该URL的末尾。检查是否选择了“Webhook”和“Post ”,然后单击“save ”(在屏幕的最底部)。</p><p id="41a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mu">注意:由于ngrok每次运行时都会生成一个随机的URL，所以您每次运行ngrok时都需要粘贴一个新的URL。ngrok的试用版最多只能运行8个小时。</em></p><h1 id="06e5" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">第六步:测试</strong></h1><p id="c90c" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">若要测试你的应用，请向你的手机号码发送消息。ngrok控制台日志应该显示请求正文以及确认RDS已更新的控制台日志。要确认，请使用登录您的RDS</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="cfab" class="mn lc iq mj b gy mo mp l mq mr">mysql -h $YOUR_ENDPOINT -P 3306 -u $USERNAME -p</span></pre><p id="fe8c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">而且，</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d66d" class="mn lc iq mj b gy mo mp l mq mr">USE text_messages;<br/>SELECT * FROM sms;</span></pre><p id="cb55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它应该显示您的短信和相关号码。</p><h1 id="b795" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="54d6" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">只要ngrok在运行，这个应用程序就会将所有收到的消息发送到您的RDS数据库。要构建一个生产就绪的应用程序，请使用Twilio和ngrok的付费版本，并考虑对应用程序进行dockerizing以增强安全性。</p></div></div>    
</body>
</html>