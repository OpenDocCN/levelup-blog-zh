# é›¶åˆ°æµåº”ç”¨â€”å‰ç«¯

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/zero-to-demo-streaming-application-frontend-ec6cb95ee7d2>

![](img/f11dbb6f5eb907265ad9df76b5f779e8.png)

[é˜¿å¾·é‡Œå®‰Â·å‹’æœ](https://unsplash.com/@adrienl?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) æ‹æ‘„çš„ç…§ç‰‡

> ***æ³¨:*** *è¿™æ˜¯â€œ*é›¶åˆ°æµåª’ä½“åº”ç”¨*â€çš„ä¸€éƒ¨åˆ†ï¼Œäº†è§£æµåª’ä½“åº”ç”¨æ„å»º POCã€‚å®Œæ•´ä»£ç * [æ­¤å¤„](https://github.com/FeliceGeracitano/kafka-uber)ã€‚
> 
> [*>ä¸‹ä¸€éƒ¨åˆ†(åç«¯)*](https://medium.com/@felice.geracitano/zero-to-streaming-application-backend-bf18fd1207ae)

# åŠ¨æœº

å­¦ä¹ æ–°çš„ä¸œè¥¿æ˜¯ä¸€ç§ç§¯æçš„æ–¹å¼æ¥åº¦è¿‡æˆ‘ä»¬åœ¨ 2020 å¹´è¢«è¿«éš”ç¦»çš„æ—¶é—´ã€‚æˆ‘åœ¨ youtube ä¸Šç™»é™†äº†è¿™ä¸ªè§†é¢‘ï¼Œå¹¶å†³å®šå­¦ä¹ æ›´å¤šå…³äºæµåª’ä½“åº”ç”¨çš„çŸ¥è¯†ã€‚

ã€Šé˜¿å¸•å¥‡å¡å¤«å¡å¯¼è®ºã€‹ä¸­çš„è©¹å§†æ–¯Â·æ²ƒå¾·:[https://www.youtube.com/watch?v=UEg40Te8pnE](https://www.youtube.com/watch?v=UEg40Te8pnE)

æˆ‘å†³å®šè‡ªå·±å»ºç«‹ä¸€ä¸ªæ±½è½¦å…±äº« POCï¼Œå®¢æˆ·å®æ—¶å…±äº«ä¿¡æ¯ï¼Œæ¶ˆæ¯ç”± Kafka topics å¤„ç†ã€‚æˆ‘ä¹Ÿé€šè¿‡æŒ‘é€‰æˆ‘ä¸æ˜¯æ¯å¤©éƒ½ç”¨çš„æŠ€æœ¯æ¥æŒ‘æˆ˜è‡ªå·±ã€‚æœ¬æ–‡è‡´åŠ›äº POC çš„å‰ç«¯ã€‚

# å›¾ä¹¦é¦†/æŠ€æœ¯

*   [è‹—æ¡çš„](https://svelte.dev/)
*   [Rxjs](https://rxjs-dev.firebaseapp.com/)
*   [åœ°å›¾æ¡†](https://docs.mapbox.com/mapbox-gl-js/api/)
*   [åœ°ç›˜](https://turfjs.org/)

# ä½“ç³»ç»“æ„

å°†æœ‰ä¸€ä¸ª`**rider**`å®¢æˆ·ç«¯å’Œä¸€ä¸ª`**driver**`å®¢æˆ·ç«¯éƒ½é€šè¿‡ WebSocket è¿æ¥åˆ°åç«¯æœåŠ¡ï¼Œç›®æ ‡æ˜¯åœ¨ä¸¤è€…ä¹‹é—´äº§ç”Ÿå’Œæ¶ˆè´¹å¤šä¸ªäº‹ä»¶ã€‚

ä¸‹é¢æ˜¯ä¸¤ä¸ªåº”ç”¨ç¨‹åºå°†äº¤æ¢çš„æ¶ˆæ¯ç±»å‹åˆ—è¡¨ã€‚

æè¿°ç”±å®¢æˆ·ç«¯ç®¡ç†çš„æ“ä½œçš„ Js å¯¹è±¡

ä¸ºäº†ç®€åŒ–å¼€å‘å’Œè°ƒè¯•ï¼Œä¸¤ä¸ªå®¢æˆ·ç«¯å¯ä»¥ä½äºåŒä¸€ä¸ªé¡µé¢ä¸Šã€‚è§‚å¯Ÿä¸€ä¸ªæ›´æ–°å¦‚ä½•å½±å“å¦ä¸€ä¸ªä¼šå®¹æ˜“å¾—å¤šã€‚

åŒä¸€ä¸ªçª—å£ä¸­çš„`**rider**`å’Œ`**driver**`å°†è¢«ä¸€ä¸ªå°é»‘å®¢æ†ç»‘åœ¨ä¸€èµ·ï¼Œå®ƒä»¬å°†å…±äº«ç›¸åŒçš„ IDï¼Œåªæ˜¯å‰ç¼€ä¸åŒ

```
*id =* xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx ***const*** riderId = `**R**${id}**`**
***const*** driverId = `**D**${id}**`**
```

![](img/2b89fcd3d56c4c10b76cf22198068dd5.png)

è¡ŒåŠ¨åœ¨éª‘æ‰‹å’Œè½¦æ‰‹ä¹‹é—´æµåŠ¨ã€‚æ„Ÿè°¢[https://excalidraw.com/](https://excalidraw.com/)æä¾›çš„å›¾è§£å·¥å…·

# é¡¹ç›®ç»“æ„

```
â”€â”€ frontend
    â”œâ”€â”€ package.json
    â”œâ”€â”€ public
    â”œâ”€â”€ rollup.config.js
    â””â”€â”€ src
        â”œâ”€â”€ components
        â”‚   â”œâ”€â”€ App.svelte
        â”‚   â”œâ”€â”€ Driver.svelte
        â”‚   â”œâ”€â”€ Rider.svelte
        â”‚   â””â”€â”€ common
        â”‚       â”œâ”€â”€ BackCamera.svelte
        â”‚       â”œâ”€â”€ Button.svelte
        â”‚       â”œâ”€â”€ CenterView.svelte
        â”‚       â”œâ”€â”€ CountDown.svelte
        â”‚       â”œâ”€â”€ LineString.svelte
        â”‚       â”œâ”€â”€ Map.svelte
        â”‚       â”œâ”€â”€ Marker.svelte
        â”‚       â””â”€â”€ MovingMarker.svelte
        â”œâ”€â”€ main.js
        â””â”€â”€ utils
            â”œâ”€â”€ actions.js
            â”œâ”€â”€ constants.js
            â”œâ”€â”€ mapbox.js
            â””â”€â”€ utils.js
```

`Driver.svelte`å’Œ`Rider.svelte`æ˜¯åœ¨`App.svelte`ä¸­è°ƒç”¨çš„ä¸¤ä¸ªå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºã€‚

é€šç”¨ç»„ä»¶å°†åœ¨`Rider.svelte`å’Œ`Driver.svelte`ä¹‹é—´å…±äº«ï¼Œè¿™äº›å¤§éƒ¨åˆ†æ˜¯æ’ä»¶ï¼Œæ¶ˆè€—åœ°å›¾ä¸Šä¸‹æ–‡å¹¶åœ¨å¿…è¦æ—¶æ›´æ–°åœ°å›¾ã€‚

# å¤„ç† WebSocket æ¶ˆæ¯

æˆ‘ä»¬å¼€å§‹ä» WebSocket æµåˆ›å»ºä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ï¼Œå¹¶å°†æ¶ˆæ¯è¿‡æ»¤åˆ°æ­£ç¡®çš„å¤„ç†ç¨‹åºã€‚ä¸‹é¢çš„è¦ç‚¹å°†æ˜¾ç¤ºå®¢æˆ·ç«¯-æœåŠ¡å™¨çš„è¿æ¥ã€‚

ç»†é•¿çš„***on mount***life cycle:è¿æ¥åˆ°æœåŠ¡å™¨å¹¶å°†æ¶ˆæ¯åˆ†æ´¾ç»™æ­£ç¡®çš„å¤„ç†å™¨

å¼•ç”¨ RxJS æ–‡æ¡£:

> `*multiplex*` *ç”¨æ¥æ¨¡æ‹Ÿæ‰“å¼€å‡ ä¸ªå¥—æ¥å­—è¿æ¥ï¼Œè€Œå®é™…ä¸Šåªç»´æŒä¸€ä¸ªã€‚*

å¾ˆç®€å•ï¼Œ`multiplex`ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°æ¥å—ä¸€ä¸ªåœ¨è¿æ¥äº‹ä»¶æ—¶è°ƒç”¨çš„å‡½æ•°ï¼Œä½œä¸ºç¬¬äºŒä¸ªå‚æ•°æ¥å—ä¸€ä¸ªåœ¨æ–­å¼€äº‹ä»¶æ—¶è°ƒç”¨çš„å‡½æ•°ï¼Œå®ƒä»¬å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ç©ºçš„ã€‚

éª‘æ‰‹æ¶ˆæ¯å¤„ç†ç¨‹åº:

éª‘æ‰‹æœåŠ¡å™¨æ¶ˆæ¯å¤„ç†ç¨‹åº

è®©æˆ‘ä»¬ä»¥`SYNC_STATUS`ä¸ºä¾‹:

*   å®ƒç”±æœåŠ¡å™¨å‘é€ç»™`rider`å’Œ`driver`å®¢æˆ·æœºï¼Œå¹¶å‘ŠçŸ¥æ—…è¡Œçš„å½“å‰çŠ¶æ€
*   åœ¨`rider`çš„æƒ…å†µä¸‹ï¼Œå¦‚æœ trip ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬è¯·æ±‚å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ª`REQUEST_TRIP`åŠ¨ä½œã€‚
*   æˆ‘ä»¬æƒ³åœ¨åœ°å›¾ä¸Šç”»å‡ºä»`origin`åˆ°`destination`çš„æ—…ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒç”¨å‡½æ•°(mapbox æœåŠ¡ä»£ç†)æ¥è·å¾—è¦ç”»æˆçº¿çš„æ–¹å‘ã€‚æ³¨æ„:`origin`å’Œ`destination`æ˜¯å¸¦æœ‰`latitude`å’Œ`longitude`çš„ä¸¤ä¸ªä»»æ„ä½ç½®å¯¹è±¡

è°ƒç”¨åœ°å›¾æ¡† api:

è·å–è¡Œé©¶æ–¹å‘çš„ Mapbox api è°ƒç”¨

ä½ å¯ä»¥åœ¨ gist å“åº”ç¤ºä¾‹ä¸­çœ‹åˆ°ï¼Œå¯¹è±¡`geometry`æ˜¯æˆ‘ä»¬å¸Œæœ›åœ¨åœ°å›¾ä¸Šç”»çº¿çš„æœ‰æ•ˆè½½è·ã€‚

# å¤„ç†åœ°å›¾æ¡†ç§»åŠ¨

æˆ‘ä»¬å°†æ”¯æŒä¸¤ç§ç±»å‹çš„åœ°å›¾ç§»åŠ¨ï¼Œç¬¬ä¸€ç§æ˜¯å°†åœ°å›¾å±…ä¸­ä»¥é€‚åº”`rider`çš„æ—…è¡Œæ–¹å‘ï¼Œç¬¬äºŒç§æ˜¯å¤åˆ¶å…¸å‹ GPS å¯¼èˆªå™¨çš„ç›¸æœºè§†å›¾æˆ–*f1 è§†é¢‘æ¸¸æˆä¸­çš„*è¿œè¿½ğŸå¯¹äº`driver`ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡ api æ„å»º`Map.svelte`ç»„ä»¶ï¼Œå¹¶å‘ä»»ä½•å†…éƒ¨ç»„ä»¶æä¾›åœ°å›¾å¯¹è±¡ã€‚ç„¶åï¼Œæ¯ä¸ªå­ç»„ä»¶å¯ä»¥æ“ä½œå†…å®¹æˆ–æ›´æ”¹ç›¸æœºè®¾ç½®ã€‚

Map.svelte ç»„ä»¶ä»…åœ¨ Mapbox å¯¹è±¡è¢«å®ä¾‹åŒ–åæ‰å®‰å…¨åœ°å‘ˆç°å­çº§

fitBounds å®Œæˆäº†æ‰€æœ‰çš„å·¥ä½œï¼Œä½ åªéœ€è¦é€šè¿‡ä¸€ä¸ª`LngLatBound object`[https://docs.mapbox.com/mapbox-gl-js/api/#lnglatboundslike](https://docs.mapbox.com/mapbox-gl-js/api/#lnglatboundslike)

Rider.svelte è°ƒç”¨åœ°å›¾ç»„ä»¶å¹¶ç”¨ CenterView è£…é¥°

*è¿œè¿½*ç›¸æœºéœ€è¦æ›´å¤šä»£ç è¡Œï¼Œä½†å¹¶ä¸å¤æ‚:

`FarChaseCameraView.svelte and how to calculate bearing with turf`

`FarChaseCameraView.svelte`æ¥å—ä¸€ä¸ª`location`å‚æ•°ï¼Œè¯¥å‚æ•°ä¸æ¥è‡ªè‰çš®çš„[æ’å‘](http://turfjs.org/docs/#rhumbBearing)å®ç”¨ç¨‹åºçš„`previousLocation`è¿›è¡Œæ¯”è¾ƒã€‚ä¸€æ—¦æˆ‘ä»¬æœ‰äº†æ–¹ä½å€¼ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨`easeTo`æˆ–`rotate` Mapbox APIï¼Œå®ƒä¹Ÿå°†å¤„ç†æ ‡è®°åœ¨åœ°å›¾ç©ºé—´ä¸­çš„ x & y ç§»åŠ¨ã€‚

ä¸ºäº†ç®¡ç†æ±½è½¦è¿åŠ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ tripDuration å’Œ turf æ¥è®¡ç®—æ±½è½¦ä½•æ—¶åº”è¯¥åœ¨è·¯çº¿ä¸Šã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å‘é€ä¸€ä¸ªæ›´æ–°ä½ç½®(æ¯ç§’èŠ‚æµ)ï¼Œå¹¶æ£€æŸ¥ä¸ç”¨æˆ·çš„è·ç¦»ï¼Œå¹¶ç»“æŸè¡Œç¨‹ã€‚

é©±åŠ¨å‡½æ•°åŠ¨ç”»

> **æ³¨æ„**å¾ªç¯ä½¿ç”¨`setInterval`è€Œä¸æ˜¯`requestAnimationFrame`æ¥è§¦å‘é€»è¾‘ï¼Œå³ä½¿é€‰é¡¹å¡ä¸åœ¨ç„¦ç‚¹ä¸Šã€‚(æ¨¡æ‹Ÿæ‰“å¼€å¤šä¸ªé€‰é¡¹å¡ä»¥æ¨¡æ‹Ÿå¤šä¸ªå®¢æˆ·ç«¯)ã€‚

# ç»“æœ

ä½ å¯ä»¥çœ‹åˆ°ä¸€ç³»åˆ—æ¼”ç¤ºæ—…è¡Œç”Ÿå‘½å‘¨æœŸçš„ gifï¼Œä»`request`åˆ°`updates`å’Œ`end.`

![](img/821c1a0e45d2fb3c4a555add7701ac76.png)

éª‘æ‰‹å·²é€šè¿‡**è¯·æ±‚ _ è¡Œç¨‹**åŠ¨ä½œå‘é€å…¶è¡Œç¨‹è¯·æ±‚ï¼Œé©¾é©¶å‘˜ç‚¹å‡»â€œç¡®è®¤è¡Œç¨‹â€å°†ç¡®è®¤è¡Œç¨‹å‘é€**ç¡®è®¤ _ è¡Œç¨‹**åŠ¨ä½œã€‚

![](img/71ef3c0b0a55380a23c28f4e18989c6c.png)

é©±åŠ¨ç¨‹åºä¸æ–­é€šè¿‡ **UPDATE_LOCATION å‘æœåŠ¡å™¨å‘é€æ›´æ–°ã€‚**è½¦å‹å±•ç¤ºæœ€æ–°æ›´æ–°ã€‚

![](img/e3a8c4e91ca888a71b95346e3488535a.png)

å½“å¸æœºè¶³å¤Ÿè¿‘çš„æ—¶å€™ï¼Œå®ƒå°±å¯ä»¥æ¥éª‘æ‰‹ï¼Œå‘é€ **START_TRIPã€‚**

![](img/d57bc3adbd335685c5da339f2e49d015.png)

**END_TRIP** åŠ¨ä½œç”±å¸æœºè°ƒç”¨ã€‚

# ç»“è®ºå’Œæˆ‘å­¦åˆ°çš„ä¸œè¥¿

**è‹—æ¡**:ä»å¼€å‘è€…ä½“éªŒçš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘æœŸå¾…æ›´å¤šçš„ä¸œè¥¿ï¼Œæˆ‘ä¼šç”¨å®ƒæ¥è¿›è¡Œå¿«é€Ÿæ¼”ç¤ºå’ŒåŸå‹åˆ¶ä½œï¼Œä½†åœ¨æ—¥å¸¸å·¥ä½œä¸­æ„Ÿè§‰ä¼šå¼•èµ·ä¸€äº›å¤´ç—›ã€‚ä¸€ä¸ªå¤§çº¢è‰²æ ‡è®°æ˜¯ç½‘ç«™ä¸­è®°å½•çš„é»˜è®¤é…ç½®:

```
npx degit [sveltejs/template](https://github.com/sveltejs/template) my-svelte-project
cd my-svelte-project
npm install
npm run dev
```

ä¸ä¼šå¤±è´¥ï¼Œå¦‚æœä½ æ»¥ç”¨ä¾èµ–è¿«ä½¿ä½ åœ¨è¿è¡Œæ—¶æ£€æŸ¥é”™è¯¯ã€‚ä½†æ˜¯æœ€å¤§çš„ç¼ºç‚¹æ˜¯â€¦ğŸ¥(drum å·)â€¦ã€‚ç¼ºå°‘ Typescript æ”¯æŒã€‚ä¸€æ—¦ä½ è¿·å¤±äº†æ‰€æœ‰çš„è¾“å…¥ï¼Œæˆ‘å°è¯•äº†ä¸€äº›éå®˜æ–¹çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å¯¹äºå…¶ä»–çš„åº“/æ¡†æ¶æ¥è¯´å¤ªå¤æ‚äº†ï¼Œä»…ä»…æ˜¯ worksâ„¢ï¸.

*VS ä»£ç é›†æˆå‘¢ï¼Ÿ*

å®˜æ–¹çš„[æ’ä»¶åšäº†ä¸€ä¸ªåŸºæœ¬çš„å·¥ä½œï¼Œä½†æ˜¯å¦‚æœä½ åœ¨æ—¥å¸¸ç¼–ç ä¸­ä½¿ç”¨å…¶ä»–é—ªäº®çš„åŠ©æ‰‹ï¼Œå®ƒä»¬å¯èƒ½éœ€è¦é‡æ–°é…ç½®æ¥ä¸`.svelte`æ‰©å±•ä¸€èµ·å·¥ä½œã€‚](https://marketplace.visualstudio.com/items?itemName=svelte.svelte-vscode)

**Mapbox:** I è¿‡å»ç”¨è¿‡å‡ æ¬¡ï¼Œç®€å•æœ‰æ•ˆï¼Œå¼ºçƒˆæ¨èã€‚

**Rxjs** :è¿™ä¸ªæ¼”ç¤ºè¿‡åº¦æ€æˆ®ï¼Œä¸éœ€è¦å–æ¶ˆæœºåˆ¶æˆ–è€…å¤æ‚çš„äº‹ä»¶èšåˆã€‚æˆ‘åº”è¯¥åªä½¿ç”¨`Websocket`ï¼Œå‡ºäºåŒæ ·çš„åŸå› ï¼Œæˆ‘æ²¡æœ‰è¿›å£`axios`è€Œé€‰æ‹©`fetch`ã€‚

å®Œæ•´çš„æ¼”ç¤ºä»£ç [åœ¨è¿™é‡Œ](https://github.com/FeliceGeracitano/kafka-uber)

> [*>ä¸‹ä¸€éƒ¨åˆ†(åç«¯)*](https://medium.com/@felice.geracitano/zero-to-streaming-application-backend-bf18fd1207ae)

[](https://skilled.dev) [## ç¼–å†™é¢è¯•é—®é¢˜

### ä¸€ä¸ªå®Œæ•´çš„å¹³å°ï¼Œåœ¨è¿™é‡Œæˆ‘ä¼šæ•™ä½ æ‰¾åˆ°ä¸‹ä¸€ä»½å·¥ä½œæ‰€éœ€çš„ä¸€åˆ‡ï¼Œä»¥åŠâ€¦

æŠ€æœ¯å¼€å‘](https://skilled.dev)