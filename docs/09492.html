<html>
<head>
<title>Image Caching with URLCache</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用URLCache进行图像缓存</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/image-caching-with-urlcache-4eca5afb543a?source=collection_archive---------1-----------------------#2021-08-16">https://levelup.gitconnected.com/image-caching-with-urlcache-4eca5afb543a?source=collection_archive---------1-----------------------#2021-08-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a68d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用URLCache将图像和其他媒体文件存储到内存或存储中，这是NSCache的替代方案。</h2></div><h1 id="38d0" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">使用URLCache进行图像缓存和持久化</h1><p id="c639" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">令人惊讶的是，关于URLCache及其简洁的用例的内容并不多，所以我写了一篇短文介绍它以及它同时处理网络调用和缓存二进制对象的能力。</p><p id="6b16" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">我将向您展示我如何将图像加载速度提高了4倍，并减少了我的应用程序创建的网络调用数量。</p><p id="1b28" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">我还有点忘乎所以，在本文中写了一点关于区分内存和磁盘存储的内容，供可能不熟悉这个主题的人参考。</p><p id="ac7c" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">然而，您可能不需要太担心，因为URLCache会处理这两个位置的缓存！</p><p id="82e7" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">在本文结束时，您将:</p><ul class=""><li id="be4e" class="lz ma iq kz b la lt ld lu lg mb lk mc lo md ls me mf mg mh bi translated">将学习如何使用URLCache来缓存和持久化二进制对象(如图像、音频文件等。)来自网络通话。</li><li id="2ff6" class="lz ma iq kz b la mi ld mj lg mk lk ml lo mm ls me mf mg mh bi translated">(可选)可以深入了解内存与存储以及它们在移动开发中各自的角色。</li></ul><p id="80fd" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">我试图从一个API中缓存背景图片，这样我就不用每次启动应用程序时都下载它们了。如果应用程序被重新打开，如果图像仍然与我的应用程序中写的条件相关，那么它将从缓存中加载。例如，在我正在编写的一个天气应用程序中，如果图像不再符合某个地方的天气条件，它就必须改变。</p><p id="0258" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">构建这个功能使我走上了一条(错误地，但愉快地)学习NSCache的道路，学习内存、存储、RAM和HDD，然后找到我的URLCache解决方案(然后在意识到关于它的写作是多么稀缺之后写这篇文章)。</p><h1 id="942d" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">NSCache带来的有趣意外</h1><p id="d496" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我相信我们大多数人都曾在某个时候接触过NSCache。这是一个字典式的集合结构，存储键值对来排列数据。然而，一旦资源变得有限，它就引导出数据。你可以告诉我这绝对不是我使用的最理想的工具。</p><p id="d77c" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">点击阅读更多关于NSCache <a class="ae mn" href="https://developer.apple.com/documentation/foundation/nscache" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="0536" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">虽然它的使用可能看起来很脆弱或有限，但它实际上非常适合处理iOS应用程序的基本功能——ui table views和UICollectionViews。</p><p id="46a3" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">NSCache非常适合需要快速缓存和重用单元格内容的UITableViews和UICollectionViews。为这些单元存储的数据由NSCache保存，ns cache将数据存储在内存中，因此RAM很容易访问这些数据。如果你的用户在你的应用中上下滚动，这就很方便了。你可以从这个<a class="ae mn" href="https://medium.com/flawless-app-stories/reusable-image-cache-in-swift-9b90eb338e8d" rel="noopener">这里</a>阅读更多关于NSCache及其在图像缓存中的使用案例。</p><p id="c2d6" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">这对速度来说是理想的，但它缺乏持久性，因为RAM中的内容在关闭设备或关闭应用程序时会终止。</p><p id="3478" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">我需要提供磁盘缓存的东西，这样我就可以持久保存这些图像。</p><p id="b3b6" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated"><strong class="kz ir"> <em class="ly">内存中与磁盘上</em> </strong></p><p id="8e85" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">应用程序存储在手机的随机存储器中。需要持久保存的数据，以及在应用程序和手机重启后仍然存在的数据，需要保存在磁盘空间中。磁盘空间又被称为<em class="ly">存储</em>和<em class="ly">硬盘</em>。</p><p id="f69a" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">驱动器的优点是，与内存相比，它们可以存储更多的数据，是二进制对象(图像、音频文件等)等大文件的理想选择。缺点是它们比RAM慢得多。</p><p id="93e7" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">相比之下，RAM比驱动器更快，但相比之下存储容量更少。</p><p id="a8e4" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">RAM是在UICollectionView或UITableView中存储图像等资产的理想选择，这样就可以重用它们，而不必在应用程序中进行几十次网络调用。</p><p id="e191" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">该驱动器最适合存储单个用户会话之外的图像。这对于用户将图像保存到图库或保存语音备忘录这样的用例来说是很好的。</p><p id="caf7" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">这应该是理解手头问题的足够的上下文，并且知道这一点很好，因为URLCache缓存了这两者！</p><h2 id="0b57" class="mo kg iq bd kh mp mq dn kl mr ms dp kp lg mt mu kr lk mv mw kt lo mx my kv mz bi translated">代码！</h2><p id="c702" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这个教程项目的核心在于ImageRepository。下面的协议声明了ImageRepository的核心功能。协议是为一个类奠定主要功能和基础的好方法。</p><p id="d1e7" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated"><strong class="kz ir">图像库</strong>的主要功能描述如下:</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="38e7" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated"><strong class="kz ir">图像库</strong>负责处理与图像相关的动作。</p><p id="f9d1" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">如果'<em class="ly"> Promise </em>看起来很陌生——不要担心。它只是我在这里使用的一个异步库。如果你想要的是与Combine或Rx相比中等重量的东西，我强烈建议你看看<a class="ae mn" href="https://github.com/mxcl/PromiseKit" rel="noopener ugc nofollow" target="_blank"> PromiseKit </a>。它保养得很好，很可靠。</p><p id="55f1" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">这是完整的图像库。</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="6a62" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">让我一点一点地把它分解。</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="0b59" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated"><strong class="kz ir"> getImage </strong>将决定我们是否应该从网络调用或缓存中获取图像。</p><p id="9601" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated"><strong class="kz ir"> downloadImage </strong>提供了一个UIImage，它必须根据我们从dataTask收到的数据进行初始化。</p><p id="b3bd" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">dataTask确保有数据，然后以一个<a class="ae mn" href="https://developer.apple.com/documentation/foundation/cachedurlresponse" rel="noopener ugc nofollow" target="_blank"> CachedURLResponse </a>的格式存储它。CachedURLResponse对象存储在内存和存储缓存中，为了满足该函数的需要，我们提供了一个UIImage，它必须根据我们收到的数据进行初始化。</p><p id="e14c" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">在第9行，我们保存cachedData并将其对应到一个url请求。</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="aa77" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated"><strong class="kz ir"> loadImageFromCache </strong>主要返回与指定url请求相对应的缓存URL响应。</p><p id="7524" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">我们通过请求找出数据，然后用检索到的数据初始化一个UIImage。</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nf ng l"/></div></figure><h2 id="a86c" class="mo kg iq bd kh mp mq dn kl mr ms dp kp lg mt mu kr lk mv mw kt lo mx my kv mz bi translated">缓存到驱动器时出现警告</h2><p id="c872" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">苹果确实警告说，如果你的设备存储空间不足，URLCache可能会清除你的数据——与NSCache相同。</p><p id="7235" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">此外，要小心保存敏感信息(如用户信息、地址等。)到磁盘上，因为它不安全。</p><p id="dfe5" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">我对加密还不是很了解，所以我不会在这篇文章的范围内讨论它。</p><h1 id="5a9a" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">奖金！内存和存储之间的速度检查。</h1><p id="e489" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在完整的教程项目中，ViewController保存了一些代码，打印出downloadImage和loadImageFromCache完成所需的毫秒数。</p><p id="398c" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">当我运行10个测试来比较平均值时，我发现从内存中检索数据比从存储器中检索数据快4倍。</p><p id="654f" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">我们都知道会是这种情况，但我认为这将是有趣的。</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi nh"><img src="../Images/43c53106c040ad79a3a47fd037eb6cd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I9z98uO44gI4FsWlC2vskw.png"/></div></div></figure><p id="cb5a" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">平均下载速度:364毫秒</p><p id="ae86" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">平均缓存速度:91毫秒</p><p id="91f0" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated"><strong class="kz ir">平均快4倍。</strong></p><p id="50d4" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">以下是完整项目的链接:<a class="ae mn" href="https://github.com/baruma/CacheImageToDisk-Tutorial" rel="noopener ugc nofollow" target="_blank">https://github.com/baruma/CacheImageToDisk-Tutorial</a></p><h1 id="67e3" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">结论！</h1><p id="7988" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我希望这篇文章能提供一些信息，或者至少对URLCache进行了一些扩展，让更多不熟悉它的人了解它！</p><h1 id="a9d3" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated"><strong class="ak">我在学习中使用的内容:</strong></h1><ul class=""><li id="235f" class="lz ma iq kz b la lb ld le lg no lk np lo nq ls me mf mg mh bi translated"><a class="ae mn" href="https://medium.com/@master13sust/to-nscache-or-not-to-nscache-what-is-the-urlcache-35a0c3b02598" rel="noopener">https://medium . com/@ master 13 ust/to-ns cache-or-not-to-ns cache-what-the-URL cache-35 A0 C3 b 02598</a></li><li id="aa4d" class="lz ma iq kz b la mi ld mj lg mk lk ml lo mm ls me mf mg mh bi translated"><a class="ae mn" href="https://medium.com/flawless-app-stories/reusable-image-cache-in-swift-9b90eb338e8d" rel="noopener">https://medium . com/flashly-app-stories/reusable-image-cache-in-swift-9b 90 EB 338 E8 d</a></li><li id="9561" class="lz ma iq kz b la mi ld mj lg mk lk ml lo mm ls me mf mg mh bi translated"><a class="ae mn" href="https://medium.com/swift2go/swiftbits-caching-images-9de11d034924" rel="noopener">https://medium . com/swift 2 go/swift bits-caching-images-9de 11d 034924</a></li><li id="a6f5" class="lz ma iq kz b la mi ld mj lg mk lk ml lo mm ls me mf mg mh bi translated"><a class="ae mn" href="https://www.backblaze.com/blog/whats-diff-ram-vs-storage/" rel="noopener ugc nofollow" target="_blank">https://www.backblaze.com/blog/whats-diff-ram-vs-storage/</a></li></ul></div></div>    
</body>
</html>