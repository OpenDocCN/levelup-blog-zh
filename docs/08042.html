<html>
<head>
<title>How I built a simple ORM from scratch in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何用Python从头开始构建一个简单的ORM</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-i-built-a-simple-orm-from-scratch-in-python-18b50108cfa3?source=collection_archive---------1-----------------------#2021-03-30">https://levelup.gitconnected.com/how-i-built-a-simple-orm-from-scratch-in-python-18b50108cfa3?source=collection_archive---------1-----------------------#2021-03-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/9893a3c89117ef97cd36abb07836ee83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*CInE9u4EEV2d6fkzulR1dw.jpeg"/></div></figure><h1 id="ea04" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">介绍</h1><p id="55a5" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">一个<strong class="ku ir"> ORM </strong>(对象关系映射器)是一个允许你使用<em class="lq">面向对象</em>范例与你的<em class="lq">数据库</em>交互的工具。因此，ORM一般作为支持面向对象编程的语言的库来实现。</p><p id="2b30" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">下面是Django ORM的一个基本例子:</p><figure class="lw lx ly lz gt jr"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="b27c" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">在不同的编程语言中有几个开源的ORM比如<a class="ae mc" href="https://docs.djangoproject.com/en/3.1/topics/db/queries/" rel="noopener ugc nofollow" target="_blank">Django ORM</a>(Python)<a class="ae mc" href="https://laravel.com/docs/4.2/eloquent#introduction" rel="noopener ugc nofollow" target="_blank">Laravel口才</a>(PHP)<a class="ae mc" href="https://sequelize.org/master/index.html" rel="noopener ugc nofollow" target="_blank">Sequelize</a>(JavaScript)等等。</p><p id="afa2" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">这些ORM实现了非常高级的特性，当您是初学者时，它们的源代码可能会有点吓人，所以在本文中，我们将从头开始用Python实现一个简单的ORM，来揭开这个过程的神秘面纱，并给出它如何工作的一般概念。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi md"><img src="../Images/7ea9c5c718bd19f8d7ecf35d9cb87067.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/1*6KANnVFYNp0hCxYzfzJvGQ.gif"/></div></figure></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h1 id="1c1a" class="ju jv iq bd jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr bi translated">用法定义</h1><p id="3c6d" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">因为我们是从零开始构建ORM，所以在开始编码之前，我们应该定义如何使用它。这将允许我们对我们试图设计的东西有一个很好的概述。</p><p id="d4ec" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">例如，让我们考虑这个查询:</p><blockquote class="mq mr ms"><p id="6029" class="ks kt lq ku b kv lr kx ky kz ls lb lc mt lt lf lg mu lu lj lk mv lv ln lo lp ij bi translated">SELECT * FROM salary = 10000的员工；</p></blockquote><p id="f364" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">使用Django ORM，要执行这个查询，我们可以这样写:</p><pre class="lw lx ly lz gt mw mx my mz aw na bi"><span id="6a64" class="nb jv iq mx b gy nc nd l ne nf">employees = Employee.objects.filter(salary=10000)</span></pre><p id="9a4a" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">但那是因为Django决定实现他的ORM来实现那样的行为。以下是一些可以不同方式实现的示例:</p><pre class="lw lx ly lz gt mw mx my mz aw na bi"><span id="bc87" class="nb jv iq mx b gy nc nd l ne nf">(1) Employee.get_objects(where={'salary': 10000})<br/>(2) Employee.objects.select('*', condition=Condition(salary=10000))</span></pre><p id="a693" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">因此，由系统开发人员决定他的系统将如何运行。</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><p id="f944" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">在我们的例子中，我们将尝试设计一个ORM，允许我们使用下面定义的用法执行基本的<em class="lq">创建</em>、<em class="lq">读取</em>、<em class="lq">更新</em>和<em class="lq">删除</em>操作:</p><figure class="lw lx ly lz gt jr"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="b839" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">在理解了这是如何实现的之后，您应该能够添加更多的特性和用例。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi md"><img src="../Images/ed1c22e9905f8669d8f4b2f7a5357ed5.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/1*NgXUK8fht6fUdhirM_FIFg.gif"/></div></figure></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h1 id="3051" class="ju jv iq bd jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr bi translated">履行</h1><h2 id="31ad" class="nb jv iq bd jw ng nh dn ka ni nj dp ke ld nk nl ki lh nm nn km ll no np kq nq bi translated">结构</h2><p id="cb8c" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们ORM实现的第一步是实现允许我们使用预期的结构。我们可以通过下面的代码实现这一点:</p><figure class="lw lx ly lz gt jr"><div class="bz fp l di"><div class="ma mb l"/></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">ORM实现结构</figcaption></figure><p id="73c4" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">现在我们有了总体结构，我们可以继续实现我们的特性(选择、插入、更新和删除)，如上所述。但是在此之前，让我们建立一个数据库来测试我们的ORM。</p><h2 id="c390" class="nb jv iq bd jw ng nh dn ka ni nj dp ke ld nk nl ki lh nm nn km ll no np kq nq bi translated">数据库设置</h2><p id="5762" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">大多数流行的ORM支持许多数据库管理系统，但是为了简单起见，我们只实现对PostgreSQL 的支持。</p><p id="d70d" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">因此，为了能够测试我们的ORM，我们需要一个Postgres数据库。这就是我们的数据库设置的样子。</p><pre class="lw lx ly lz gt mw mx my mz aw na bi"><span id="ca01" class="nb jv iq mx b gy nc nd l ne nf">DB_SETTINGS = {<br/>    'host': '127.0.0.1',<br/>    'port': '5432',<br/>    'database': 'ormify',<br/>    'user': 'yank',<br/>    'password': 'yank'<br/>}</span></pre><p id="edf4" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">您可以按照这篇漂亮的<a class="ae mc" href="https://medium.com/coding-blocks/creating-user-database-and-adding-access-on-postgresql-8bfcd2f4a91e" rel="noopener">文章</a>创建一个Postgres数据库、用户，并授予用户访问数据库的权限。</p><p id="063d" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">为了遵循上面定义的ORM用法，在创建数据库之后，我们需要创建一个表<code class="fe nv nw nx mx b">employees</code>，其中包含字段<code class="fe nv nw nx mx b">first_name</code>、<code class="fe nv nw nx mx b">last_name</code>、<code class="fe nv nw nx mx b">salary</code>和<code class="fe nv nw nx mx b">grade</code>。</p><p id="22b9" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">您可以使用下面的脚本创建该表，并用一些数据填充它(在用您自己的凭证更新<code class="fe nv nw nx mx b">DB_SETTINGS</code>之后)。</p><figure class="lw lx ly lz gt jr"><div class="bz fp l di"><div class="ma mb l"/></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">设置:创建员工表</figcaption></figure><p id="f2dd" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">这个脚本需要<a class="ae mc" href="https://pypi.org/project/psycopg2-binary/" rel="noopener ugc nofollow" target="_blank"> <em class="lq"> psycopg2 </em> </a>包。您可以通过执行以下命令来安装它:</p><ul class=""><li id="058a" class="ny nz iq ku b kv lr kz ls ld oa lh ob ll oc lp od oe of og bi translated"><code class="fe nv nw nx mx b">pip install psycopg2-binary</code></li></ul><p id="0731" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">如果您已经有了一个包含一些表的数据库，您也可以创建自己的模型(作为我们的<code class="fe nv nw nx mx b">Employee</code>模型)并用它进行测试。</p><p id="58d5" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">好了，如果现在一切都设置好了，我们可以开始第一个功能:<em class="lq">选择</em></p><h2 id="fc50" class="nb jv iq bd jw ng nh dn ka ni nj dp ke ld nk nl ki lh nm nn km ll no np kq nq bi translated">选择功能</h2><p id="1518" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">提醒一下，下面是我们想要的<em class="lq">选择</em>功能:</p><pre class="lw lx ly lz gt mw mx my mz aw na bi"><span id="4b86" class="nb jv iq mx b gy nc nd l ne nf"># SQL: SELECT salary, grade FROM employees;<br/>employees = Employee.objects.select('salary', 'grade')</span></pre><p id="82f4" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">用<code class="fe nv nw nx mx b">employees</code>一个雇员对象列表。我们可以通过如下更新ORM实现代码来实现这一点:</p><figure class="lw lx ly lz gt jr"><div class="bz fp l di"><div class="ma mb l"/></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">ORM“选择”实施</figcaption></figure><p id="b040" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">您可以使用您最喜欢的代码编辑器diff工具或<a class="ae mc" href="https://www.diffchecker.com/" rel="noopener ugc nofollow" target="_blank"> Diffchecker </a>来轻松检查实现的不同步骤中的变化。</p><p id="5ff2" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">让我们测试一下这段代码，看看会发生什么。</p><p id="b9a7" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">如果一切顺利，您应该会看到如下输出:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/8b7703bc513fa3bbbc672a57e3841d58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*GOqxUmqYhpZudryae0OC0w.png"/></div></figure><p id="5e9f" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">如果是的话，恭喜你😎，您已经用Python实现了一个ORM，它可以在您的数据库🗸.上进行基本的选择查询现在让我们添加插入、更新和删除特性。</p><h2 id="044f" class="nb jv iq bd jw ng nh dn ka ni nj dp ke ld nk nl ki lh nm nn km ll no np kq nq bi translated">插入、更新、删除特征</h2><p id="7c2d" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">为了实现这些功能，我们可以按如下方式更新代码:</p><figure class="lw lx ly lz gt jr"><div class="bz fp l di"><div class="ma mb l"/></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">ORM完整实施</figcaption></figure><p id="28be" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">运行该脚本后，您应该会得到如下输出:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/4a9388e31080117fb5194428051253fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*fwHcHZ7TCgv4_KQkkyGA8w.jpeg"/></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">ORM使用输出</figcaption></figure><p id="9b30" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">啊啊。！我们可以自豪😎 😎，我们现在有了一个支持所有基本查询的功能性ORM。祝贺你🗸.</p><h1 id="bebd" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结论</h1><p id="9986" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们已经能够用Python实现一个支持基本SQL查询的简单ORM。我们现在可以通过Python代码与我们的数据库进行交互，并且我们还对如何继续设计我们自己的软件系统有了一个概述。</p><p id="8f7f" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">我们可以向此ORM添加许多功能，使其更加强大，例如:</p><ul class=""><li id="ba0f" class="ny nz iq ku b kv lr kz ls ld oa lh ob ll oc lp od oe of og bi translated">使用<code class="fe nv nw nx mx b">WHERE</code>子句过滤记录</li><li id="2b17" class="ny nz iq ku b kv oj kz ok ld ol lh om ll on lp od oe of og bi translated">接缝</li><li id="57b9" class="ny nz iq ku b kv oj kz ok ld ol lh om ll on lp od oe of og bi translated">聚合等。</li></ul><p id="8865" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">您可以在Github上找到ORM实现的当前状态:</p><div class="oo op gp gr oq or"><a href="https://github.com/yannickkiki/yann-orm" rel="noopener  ugc nofollow" target="_blank"><div class="os ab fo"><div class="ot ab ou cl cj ov"><h2 class="bd ir gy z fp ow fr fs ox fu fw ip bi translated">yannickkiki/yann-orm</h2><div class="oy l"><h3 class="bd b gy z fp ow fr fs ox fu fw dk translated">在GitHub上创建一个帐户，为yannickkiki/yann-orm的开发做出贡献。</h3></div><div class="oz l"><p class="bd b dl z fp ow fr fs ox fu fw dk translated">github.com</p></div></div><div class="pa l"><div class="pb l pc pd pe pa pf js or"/></div></div></a></div><p id="f1ef" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">请随意对项目进行代码审查、问题报告、特性实现、特性请求等。</p><p id="b441" class="pw-post-body-paragraph ks kt iq ku b kv lr kx ky kz ls lb lc ld lt lf lg lh lu lj lk ll lv ln lo lp ij bi translated">如果您有任何问题/反馈，请在评论区告诉我，或者直接与我联系。谢了。</p></div></div>    
</body>
</html>