<html>
<head>
<title>Workaround to force Xamarin.Forms WebView to use a dark mode CSS for local content on Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">强制Xamarin的解决方法。表单WebView为Android上的本地内容使用黑暗模式CSS</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/workaround-to-force-xamarin-forms-webview-to-use-a-dark-mode-css-for-local-content-on-android-41e18c513bb5?source=collection_archive---------19-----------------------#2021-04-06">https://levelup.gitconnected.com/workaround-to-force-xamarin-forms-webview-to-use-a-dark-mode-css-for-local-content-on-android-41e18c513bb5?source=collection_archive---------19-----------------------#2021-04-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ec8774515955c07a111076e687a17b85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*603w-ROx996Jf_2x.png"/></div></div></figure><p id="6972" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最近我更新了我的博客阅读器应用程序，以支持黑暗模式较新的iOS和Android版本的支持。虽然在iOS上一切都很顺利，更新已经在App Store上发布，但我在Android上还有一些工作要做。一个更大的问题:我用来查看帖子的<code class="fe kw kx ky kz b">WebView</code>没有自动切换到<code class="fe kw kx ky kz b">Xamarin.Forms</code>的黑暗模式。</p><h2 id="8de4" class="la lb iq bd lc ld le dn lf lg lh dp li kj lj lk ll kn lm ln lo kr lp lq lr ls bi translated">是什么导致了这个问题？</h2><p id="856d" class="pw-post-body-paragraph jy jz iq ka b kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr lx kt ku kv ij bi translated">部分问题在于<code class="fe kw kx ky kz b">WebView</code>不支持CSS查询<code class="fe kw kx ky kz b">prefers-color-scheme</code>。然而，这在iOS上可以正常工作，并且是Android特有的问题。你可以<a class="ae ly" href="https://github.com/xamarin/Xamarin.Forms/issues/12551" rel="noopener ugc nofollow" target="_blank">参考Github上<code class="fe kw kx ky kz b">Xamarin.Forms</code>库的这个问题</a>。</p><h2 id="a40a" class="la lb iq bd lc ld le dn lf lg lh dp li kj lj lk ll kn lm ln lo kr lp lq lr ls bi translated">工作区</h2><p id="9fe9" class="pw-post-body-paragraph jy jz iq ka b kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr lx kt ku kv ij bi translated">我不确定这个问题是否会被<code class="fe kw kx ky kz b">Xamarin.Forms</code>团队解决。我尝试使用一些在网络上流行的Javascript解决方案来保存一个CSS文件。然而最后，我遵循<a class="ae ly" href="https://en.wikipedia.org/wiki/KISS_principle" rel="noopener ugc nofollow" target="_blank">亲吻原则</a>选择了一种只有<code class="fe kw kx ky kz b">Xamarin.Forms</code>的方法。</p><p id="6a34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kw kx ky kz b">Xamarin.Forms</code>有一个工作的<a class="ae ly" href="https://docs.microsoft.com/en-us/xamarin/xamarin-forms/user-interface/theming/system-theme-changes" rel="noopener ugc nofollow" target="_blank">主题检测机制</a>。基于<code class="fe kw kx ky kz b">Application.Current.RequestedTheme</code>属性的返回值，我要么加载黑暗模式CSS文件，要么加载光明模式CSS文件(在我的例子中是默认的)。</p><p id="8502" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运送CSS文件很容易，我们只需要将它们添加到Assets文件夹，并将构建动作设置为<code class="fe kw kx ky kz b">AndroidAsset</code>。这导致了Android项目中的以下结构:</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lz"><img src="../Images/ad2d6e8d7547b79f04bce7b5e6374401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Okf_65vM6_5FF2SzA03Nhw.png"/></div></div></figure><p id="1b5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以这种方式提供的所有文件都可以通过<code class="fe kw kx ky kz b">android_asset</code>文件uri进行访问:</p><pre class="ma mb mc md gt me kz mf mg aw mh bi"><span id="990c" class="la lb iq kz b gy mi mj l mk ml">&lt;link rel="stylesheet" href="file:///android_asset/dummycss_light.css"&gt;</span></pre><p id="b256" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在一切都在Android项目中设置好了，让我们转向<code class="fe kw kx ky kz b">Xamarin.Forms</code>项目。在本文的示例中，我加载了一个本地html文件，同时在我的博客阅读器应用程序中动态生成html。这种想法在两种情况下都是一样的:</p><pre class="ma mb mc md gt me kz mf mg aw mh bi"><span id="a7c9" class="la lb iq kz b gy mi mj l mk ml">private async Task SetThemeAndLoadSource()<br/>{<br/>    _html = await LoadHtmlFromFileAsync();<br/><br/>    _html = Application.Current.RequestedTheme == OSAppTheme.Dark ?<br/>            _html.Replace("light", "dark") :<br/>            _html.Replace("dark", "light");<br/><br/>    this.TestWebView.Source = new HtmlWebViewSource() { Html = _html };<br/>}</span></pre><p id="7363" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如你所见，我只是覆盖了加载到HTML中的CSS文件名的明暗部分。这就是这里需要发生的所有“魔法”。还有一点需要补充的是——如果用户在应用程序运行时改变了主题，该怎么办？<code class="fe kw kx ky kz b">Xamarin.Forms</code>也内置了解决方案——只需处理<code class="fe kw kx ky kz b">RequestedThemeChanged</code>事件并再次覆盖文件名，然后再次设置<code class="fe kw kx ky kz b">HtmlWebViewSource</code>:</p><pre class="ma mb mc md gt me kz mf mg aw mh bi"><span id="0b0f" class="la lb iq kz b gy mi mj l mk ml">private async void Current_RequestedThemeChanged(object sender, AppThemeChangedEventArgs e)<br/>{<br/>    await SetThemeAndLoadSource();<br/>}</span></pre><h2 id="85e1" class="la lb iq bd lc ld le dn lf lg lh dp li kj lj lk ll kn lm ln lo kr lp lq lr ls bi translated">结论</h2><p id="c877" class="pw-post-body-paragraph jy jz iq ka b kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr lx kt ku kv ij bi translated">正如我们大多数人已经习惯的那样，我们有时需要在处理<code class="fe kw kx ky kz b">Xamarin.Forms</code>时找到一些变通办法。虽然这个问题也可以用一个<code class="fe kw kx ky kz b">WebViewRenderer</code>中的一堆Javascript和一个自定义CSS来解决(我试过，但不喜欢它的复杂性)，但是你可以用上面的解决方法在<code class="fe kw kx ky kz b">Xamarin.Forms</code>中获得可靠的结果。</p><p id="c50b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在Github上找到一个可用的<a class="ae ly" href="https://github.com/MSicc/XFWebviewDarkmode" rel="noopener ugc nofollow" target="_blank">示例。一如既往，我希望这篇文章对你们中的一些人有所帮助。</a></p><p id="0669" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">直到下一个帖子，大家编码快乐！</p></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><p id="d6fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mt">原载于2021年4月6日https://msicc.net</em><em class="mt">的</em> <a class="ae ly" href="https://msicc.net/workaround-to-force-xamarin-forms-webview-to-use-a-dark-mode-css-for-local-content-on-android/" rel="noopener ugc nofollow" target="_blank"> <em class="mt">。</em></a></p></div></div>    
</body>
</html>