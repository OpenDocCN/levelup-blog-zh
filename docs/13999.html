<html>
<head>
<title>Strategy to Migrate from one Database to Another Incrementally</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从一个数据库增量迁移到另一个数据库的策略</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/strategy-to-migrate-from-one-database-to-another-incrementally-21c3a1bcb0ff?source=collection_archive---------11-----------------------#2022-10-23">https://levelup.gitconnected.com/strategy-to-migrate-from-one-database-to-another-incrementally-21c3a1bcb0ff?source=collection_archive---------11-----------------------#2022-10-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="56cf" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://medium.com/@anasanjaria/list/databases-7ea27ca82ce1" rel="noopener">数据库</a></h2><div class=""/><div class=""><h2 id="dd30" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">从MongoDB到PostgreSQL的增量部署迁移</h2></div><p id="1781" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">从一个数据库迁移到另一个数据库可能有各种原因，例如，降低成本、维护开销、性能优化等。</p><p id="e82c" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">迁移一个平稳运行的生产数据库总是具有挑战性。挑战可能包括但不限于以下内容:</p><ul class=""><li id="2a81" class="lk ll iq kq b kr ks ku kv kx lm lb ln lf lo lj lp lq lr ls bi translated">使新数据库能够在相同的生产负载下工作。</li><li id="4d53" class="lk ll iq kq b kr lt ku lu kx lv lb lw lf lx lj lp lq lr ls bi translated">具有比当前运行的生产数据库更好的性能，或者至少具有与当前运行的生产数据库一样的性能。</li></ul><p id="c981" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这篇文章旨在解释在我们的生产系统中促进迁移的策略和过程。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="4b1f" class="mf mg iq bd mh mi mj mk ml mm mn mo mp kf mq kg mr ki ms kj mt kl mu km mv mw bi translated">高级概述</h1><p id="5aee" class="pw-post-body-paragraph ko kp iq kq b kr mx ka kt ku my kd kw kx mz kz la lb na ld le lf nb lh li lj ij bi translated">假设我们想从<code class="fe nc nd ne nf b">MongoDB</code>迁移到<code class="fe nc nd ne nf b">PostgreSQL</code>。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ng"><img src="../Images/53b49c3e70dab72fd37253587b9cc840.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zdai-nji5JgSIhK8EPU9lg.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">从MongoDB迁移到PostgreSQL —由作者使用diagrams.net创建</figcaption></figure><p id="c053" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这意味着<code class="fe nc nd ne nf b">MongoDB</code>是我们当前的主要数据库，我们的应用程序正在使用它。因此，当前的设置如下所示。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nw"><img src="../Images/01412fe3a4e3f58e19f097589abb6986.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AaI83zfDscar56VVLlt4IA.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">使用MongoDB作为主数据库的应用程序—由作者使用diagrams.net创建</figcaption></figure><p id="41fb" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们将修改当前的设置，并添加PostgreSQL作为辅助数据库。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nx"><img src="../Images/1f127b35b6f13637d3bfa05121d7f3d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GjS2aHux0if8nhLxdFHacw.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">使用PostgreSQL作为辅助数据库的应用程序—由作者使用diagrams.net创建</figcaption></figure><p id="9ad8" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">一旦我们的应用程序与PostgreSQL兼容，我们将删除MongoDB数据库。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ny"><img src="../Images/07098496a1781c54855fb5743a699504.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MHcHBbCTfIEuwCXCSanLRg.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">使用PostgreSQL作为主数据库的应用程序—由作者使用diagrams.net创建</figcaption></figure></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="dfd1" class="mf mg iq bd mh mi mj mk ml mm mn mo mp kf mq kg mr ki ms kj mt kl mu km mv mw bi translated">战略和方法</h1><p id="9bd9" class="pw-post-body-paragraph ko kp iq kq b kr mx ka kt ku my kd kw kx mz kz la lb na ld le lf nb lh li lj ij bi translated">策略是:</p><blockquote class="nz"><p id="e5b1" class="oa ob iq bd oc od oe of og oh oi lj dk translated">增量迁移数据库</p></blockquote><p id="7b76" class="pw-post-body-paragraph ko kp iq kq b kr oj ka kt ku ok kd kw kx ol kz la lb om ld le lf on lh li lj ij bi translated">这意味着我们开始为一小部分用户使用<code class="fe nc nd ne nf b">PostgresSQL</code>，并观察我们系统的性能&amp;资源利用率。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oo"><img src="../Images/dc28da05f4f699c4c8d9b6e87fe52601.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v2dBeCV45F-_SVMYrZAiiA.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">增量转出数据库使用—由作者使用diagrams.net创建</figcaption></figure><p id="dcc5" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">当它看起来不错，并按预期工作，我们将逐步增加用户的<code class="fe nc nd ne nf b">PostgreSQL</code>数据库的百分比。否则，我们需要对原因进行故障诊断(将在本文的<code class="fe nc nd ne nf b">Troubleshooting</code>部分讨论)。</p><p id="bc8b" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">您可能已经注意到，使用<code class="fe nc nd ne nf b">PostgreSQL</code>的用户也在使用<code class="fe nc nd ne nf b">MongoDB</code>。</p><blockquote class="nz"><p id="7f23" class="oa ob iq bd oc od oe of og oh oi lj dk translated">这种冗余是一种设计决策。在完成迁移之前，我们不能完全依赖我们的新数据库系统。</p></blockquote><p id="69bc" class="pw-post-body-paragraph ko kp iq kq b kr oj ka kt ku ok kd kw kx ol kz la lb om ld le lf on lh li lj ij bi translated">因此，迁移过程分为三个部分:</p><h2 id="9cee" class="op mg iq bd mh oq or dn ml os ot dp mp kx ou ov mr lb ow ox mt lf oy oz mv iw bi translated">1.稳定写入操作</h2><p id="394e" class="pw-post-body-paragraph ko kp iq kq b kr mx ka kt ku my kd kw kx mz kz la lb na ld le lf nb lh li lj ij bi translated">这使我们能够在两个数据库中拥有相同的数据。</p><ol class=""><li id="304c" class="lk ll iq kq b kr ks ku kv kx lm lb ln lf lo lj pa lq lr ls bi translated">逐步增加使用新数据库的用户百分比。</li><li id="d8d5" class="lk ll iq kq b kr lt ku lu kx lv lb lw lf lx lj pa lq lr ls bi translated">在<code class="fe nc nd ne nf b">PostgreSQL</code>方面有失败是可以的。但是不要让整个传入的HTTP请求和/或流程因为这个失败而失败。</li><li id="57db" class="lk ll iq kq b kr lt ku lu kx lv lb lw lf lx lj pa lq lr ls bi translated">专注于稳定写操作。</li><li id="f592" class="lk ll iq kq b kr lt ku lu kx lv lb lw lf lx lj pa lq lr ls bi translated">一旦写入操作稳定下来，两个数据库上的数据都将可用。</li><li id="ef50" class="lk ll iq kq b kr lt ku lu kx lv lb lw lf lx lj pa lq lr ls bi translated">现在，当任何数据库出现故障时，使整个传入的HTTP请求和/或流程失败。这使我们能够在失败时采取相应的行动。</li></ol><h2 id="530b" class="op mg iq bd mh oq or dn ml os ot dp mp kx ou ov mr lb ow ox mt lf oy oz mv iw bi translated">2.稳定读数</h2><p id="23ce" class="pw-post-body-paragraph ko kp iq kq b kr mx ka kt ku my kd kw kx mz kz la lb na ld le lf nb lh li lj ij bi translated">由于现在两个数据库上都有数据，我们将允许一小部分用户从<code class="fe nc nd ne nf b">PostgreSQL</code>开始读取。</p><p id="4534" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们将遵循上面<code class="fe nc nd ne nf b">Stabilize writing operation first</code>部分提到的相同方法，但现在它适用于阅读。</p><h2 id="c03e" class="op mg iq bd mh oq or dn ml os ot dp mp kx ou ov mr lb ow ox mt lf oy oz mv iw bi translated">3.打扫</h2><p id="4864" class="pw-post-body-paragraph ko kp iq kq b kr mx ka kt ku my kd kw kx mz kz la lb na ld le lf nb lh li lj ij bi translated">由于读写现在已经稳定，我们将删除旧的数据库，并将PostgreSQL作为我们的主数据库。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="bd20" class="mf mg iq bd mh mi mj mk ml mm mn mo mp kf mq kg mr ki ms kj mt kl mu km mv mw bi translated">概念证明</h1><p id="7b5b" class="pw-post-body-paragraph ko kp iq kq b kr mx ka kt ku my kd kw kx mz kz la lb na ld le lf nb lh li lj ij bi translated">源代码用Scala写:<a class="ae pb" href="https://github.com/anasanjaria/incremental-db-service-migration" rel="noopener ugc nofollow" target="_blank">https://github . com/anasanjaria/incremental-d B- service-migration</a></p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pc"><img src="../Images/3135c72376566390d6c53f09df0f7895.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YVIgaptME_n6b9aD9-SPyA.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">(增量)数据库迁移的高级概念—由作者使用diagrams.net创建</figcaption></figure><p id="e9ee" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们将使用代理来实现这个概念。然而，它不是一个实际的代理，而是一个类作为代理，如下面的代码所示。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pd"><img src="../Images/5e1b44fb57e857ec933309bc34afa6d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*scF47Rt-Cu0XDCchYt7abg.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">代理类实现——用Scala编写</figcaption></figure><p id="da99" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">代理中的<code class="fe nc nd ne nf b">rollout</code>参数决定是否允许用户使用新的数据库。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pe"><img src="../Images/70ee7f71a746c7021f3273bc3f1e6270.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6GbQvy8WVfDVRDAcj-Sa_A.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">用Scala编写的一个示例，展示了如何逐步做出部署决策</figcaption></figure><pre class="nh ni nj nk gt pf nf pg ph aw pi bi"><span id="68a4" class="op mg iq nf b gy pj pk l pl pm">Please note that it's just a very simple and basic implementation. You can adjust it as per your need.</span></pre><p id="60eb" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">因为我们总是使用<code class="fe nc nd ne nf b">DAO</code>与我们的数据库通信，因此代理需要<code class="fe nc nd ne nf b">DAOs</code>与各自的数据库通信。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pn"><img src="../Images/3e8264c7241861e725968034692d97d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NnkICbtrYcTCe4QGWf9vVA.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">在各自的数据库中存储产品——用Scala编写</figcaption></figure><pre class="nh ni nj nk gt pf nf pg ph aw pi bi"><span id="5910" class="op mg iq nf b gy pj pk l pl pm"><strong class="nf ja">MongodbProductDAO</strong> &amp; <strong class="nf ja">PsqlProductDAO </strong>manage products CRUD operations for mongodb &amp; postgesql respectively.</span><span id="d865" class="op mg iq nf b gy po pk l pl pm"><strong class="nf ja">storeProduct </strong>stores a product name in respective databases.</span></pre><h2 id="fe5d" class="op mg iq bd mh oq or dn ml os ot dp mp kx ou ov mr lb ow ox mt lf oy oz mv iw bi translated">单元测试</h2><p id="10b1" class="pw-post-body-paragraph ko kp iq kq b kr mx ka kt ku my kd kw kx mz kz la lb na ld le lf nb lh li lj ij bi translated">我已经写了单元测试来解释这篇文章前面提到的高级概念。看一下代理测试<a class="ae pb" href="https://github.com/anasanjaria/incremental-db-service-migration/blob/main/src/test/scala/dao/ProductDAOProxySpec.scala" rel="noopener ugc nofollow" target="_blank">这里</a></p><pre class="nh ni nj nk gt pf nf pg ph aw pi bi"><span id="2992" class="op mg iq nf b gy pj pk l pl pm"><strong class="nf ja">ProductDAOProxy<br/></strong>should fail whole product saving such that user can use both databases<br/>  - when it fails to store product in a mongodb<br/>should not fail whole product saving such that user can use both databases<br/>  - when it fails to store product in a postgres<br/>should only store products in monogdb when user is not allowed to use postgres</span></pre><p id="416c" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果主数据库出现故障，我们希望整个操作失败，但是辅助数据库不应该出现故障。</p><p id="fc26" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">类似地，增量展示概念的单元测试可以在<a class="ae pb" href="https://github.com/anasanjaria/incremental-db-service-migration/blob/main/src/test/scala/utils/IncrementalRolloutSpec.scala" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><pre class="nh ni nj nk gt pf nf pg ph aw pi bi"><span id="887e" class="op mg iq nf b gy pj pk l pl pm"><strong class="nf ja">IncrementalRollout</strong><br/>should allow a user to use a feature<br/>- when a feature is enabled completely for all users<br/>- when a feature is enabled 50%<br/>should not allow a user to use a feature<br/>- when a feature is disabled completely for all users<br/>- when a feature is enabled 50%</span></pre><h1 id="6ce7" class="mf mg iq bd mh mi pp mk ml mm pq mo mp kf pr kg mr ki ps kj mt kl pt km mv mw bi translated">解决纷争</h1><p id="6a93" class="pw-post-body-paragraph ko kp iq kq b kr mx ka kt ku my kd kw kx mz kz la lb na ld le lf nb lh li lj ij bi translated">我们新的生产数据库很可能不会像预期的那样工作。也许它会有很高的资源消耗(内存或CPU)或者一个查询需要很长时间来响应。</p><p id="6e7f" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这两个问题都是查询优化的表现。也许我们需要通过添加索引来调整我们的新数据库。</p><p id="ae55" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">出于确切的原因，我们需要为慢速查询启用日志记录。这可以通过调整Postgres配置来实现。这里有一个关于这个主题的很好的教程—<a class="ae pb" href="https://www.cybertec-postgresql.com/en/3-ways-to-detect-slow-queries-in-postgresql/" rel="noopener ugc nofollow" target="_blank">POSTGRESQL</a>中检测慢速查询的3种方法。</p><p id="d73b" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">一旦您确定了您的慢速查询，您可以检查<a class="ae pb" href="https://thoughtbot.com/blog/reading-an-explain-analyze-query-plan" rel="noopener ugc nofollow" target="_blank">查询执行计划</a>并相应地改进它。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><p id="95fc" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">感谢阅读。</p><p id="66f6" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果你有任何问题，请随时问我。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><p id="1bad" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果你喜欢这篇文章，你可能也会喜欢下面这篇文章。</p><div class="pu pv gp gr pw px"><a href="https://medium.com/@anasanjaria/3-game-changing-software-development-tools-for-me-68ffb13e5076" rel="noopener follow" target="_blank"><div class="py ab fo"><div class="pz ab qa cl cj qb"><h2 class="bd ja gy z fp qc fr fs qd fu fw iz bi translated">3个改变游戏规则的软件开发工具</h2><div class="qe l"><h3 class="bd b gy z fp qc fr fs qd fu fw dk translated">无论一个人是木匠还是软件工程师，工具在我们的生产力中起着至关重要的作用。</h3></div><div class="qf l"><p class="bd b dl z fp qc fr fs qd fu fw dk translated">medium.com</p></div></div><div class="qg l"><div class="qh l qi qj qk qg ql nq px"/></div></div></a></div><div class="pu pv gp gr pw px"><a href="https://medium.com/@anasanjaria/monitor-postgres-performance-using-custom-queries-1c06a766969b" rel="noopener follow" target="_blank"><div class="py ab fo"><div class="pz ab qa cl cj qb"><h2 class="bd ja gy z fp qc fr fs qd fu fw iz bi translated">使用自定义查询监控Postgres性能</h2><div class="qe l"><h3 class="bd b gy z fp qc fr fs qd fu fw dk translated">我在网上看到几篇文章，建议使用自定义查询来监控Postgres的性能。</h3></div><div class="qf l"><p class="bd b dl z fp qc fr fs qd fu fw dk translated">medium.com</p></div></div><div class="qg l"><div class="qm l qi qj qk qg ql nq px"/></div></div></a></div></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><pre class="nh ni nj nk gt pf nf pg ph aw pi bi"><span id="4f23" class="op mg iq nf b gy pj pk l pl pm"><strong class="nf ja">Want to connect?<br/></strong><a class="ae pb" href="https://www.facebook.com/anas.anjaria.kh" rel="noopener ugc nofollow" target="_blank">Facebook</a> | <a class="ae pb" href="https://www.linkedin.com/in/anasanjaria/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a> | <a class="ae pb" href="https://twitter.com/anasanjaria" rel="noopener ugc nofollow" target="_blank">Twitter</a></span><span id="1cbd" class="op mg iq nf b gy po pk l pl pm"><strong class="nf ja">Subscribe to get my work directly into your inbox.<br/></strong><a class="ae pb" href="https://medium.com/subscribe/@anasanjaria" rel="noopener">https://medium.com/subscribe/@anasanjaria</a></span></pre></div></div>    
</body>
</html>