<html>
<head>
<title>Integrating Kubernetes with Gitlab CI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Kubernetes与Gitlab CI集成</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/integrating-kubernetes-with-gitlab-ci-ed3497c41a66?source=collection_archive---------3-----------------------#2019-11-12">https://levelup.gitconnected.com/integrating-kubernetes-with-gitlab-ci-ed3497c41a66?source=collection_archive---------3-----------------------#2019-11-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/0ac4e1ff8eda7f0e16db17ea5096091b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/0*iln2Ufpipramh0rl.png"/></div></figure><p id="8e50" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个系列的最后一篇文章中，我们将Kubernetes (k8s)挂接到Gitlab，并将我们的Go服务部署到我们的k8s系统。我们将使用minikube作为我们的Kubernetes供应商。</p><p id="76cf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kt">本文的所有代码可以在</em> <a class="ae ks" href="https://gitlab.com/lightphos/hi" rel="noopener ugc nofollow" target="_blank"> <em class="kt">这里</em> </a>找到</p><p id="5e2a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">提示:在Visual Studio代码中，您可以添加Microsoft Kubernetes扩展或云代码，以便从编辑器中查看k8s的详细信息</p><h1 id="f5ae" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">安装kubernetes CLI</h1><p id="2371" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated"><a class="ae ks" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></p><p id="b392" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查(这是在mac上):</p><p id="16fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl version</code></p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="802a" class="mj kv iq ma b gy mk ml l mm mn">Client Version: version.Info{Major:"1", Minor:"14", GitVersion:"v1.14.3", GitCommit:"5e53fd6bc17c0dec8434817e69b04a25d8ae0ff0", GitTreeState:"clean", BuildDate:"2019-06-06T01:44:30Z", GoVersion:"go1.12.5", Compiler:"gc", Platform:"darwin/amd64"}<br/>Server Version: version.Info{Major:"1", Minor:"14", GitVersion:"v1.14.0", GitCommit:"641856db18352033a0d96dbc99153fa3b27298e5", GitTreeState:"clean", BuildDate:"2019-03-25T15:45:25Z", GoVersion:"go1.12.1", Compiler:"gc", Platform:"linux/amd64"}</span></pre><h1 id="6aab" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">安装Minikube</h1><p id="38ba" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated"><a class="ae ks" href="https://kubernetes.io/docs/tasks/tools/install-minikube/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/docs/tasks/tools/install-minikube/</a></p><p id="0c8f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">开始</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="7b0a" class="mj kv iq ma b gy mk ml l mm mn">minikube start</span></pre><h2 id="29f8" class="mj kv iq bd kw mo mp dn la mq mr dp le kf ms mt li kj mu mv lm kn mw mx lq my bi translated">从minikube内部启用docker登录</h2><p id="04cb" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">将第一篇文章中创建的密钥添加到minikube:</p><p id="b9fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kt">不幸的是，我们需要在您每次启动minikube时运行此程序。</em></p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="6771" class="mj kv iq ma b gy mk ml l mm mn">cat ~/.docker/certs.d/gitlab.lightphos.com\:5555/ca.crt | minikube ssh "sudo mkdir -p /etc/docker/certs.d/gitlab.lightphos.com:5555 &amp;&amp; sudo tee /etc/docker/certs.d/gitlab.lightphos.com:5555/ca.crt"</span></pre><p id="ed3d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新启动:</p><p id="1b2a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">minikube ssh "sudo systemctl restart docker"</code></p><p id="922e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查登录:</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="3922" class="mj kv iq ma b gy mk ml l mm mn">minikube ssh docker login gitlab.lightphos.com:5555</span></pre><p id="f829" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果成功，我们就可以走了。退出外壳。</p><h1 id="404a" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">手动将Hi.go服务部署到MiniKube K8s</h1><p id="e28e" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">设置docker访问密码，将其命名为gitlab.lightphos(使用gitlab用户名和密码作为DOCKER_USER和DOCKER_PASSWORD)。注意:这将在k8s的默认名称空间内。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="2b06" class="mj kv iq ma b gy mk ml l mm mn">kubectl create secret docker-registry gitlab.lightphos --docker-server=https://gitlab.lightphos.com:5555 --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD</span></pre><p id="cda0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用以下内容创建文件<strong class="jw ir">manifest/deployment . yml</strong>:</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="b04d" class="mj kv iq ma b gy mk ml l mm mn">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: hi-deployment<br/>  labels:<br/>    app: hi<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: hi<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: hi<br/>    spec:<br/>      containers:<br/>      - name: hi<br/>        image: gitlab.lightphos.com:5555/sr/hi:latest<br/>        ports:<br/>        - containerPort: 8090<br/>      imagePullSecrets:<br/>        - name: gitlab.lightphos</span></pre><p id="fe3f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl apply -f manifest/deployment.yml</code></p><p id="10a4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果由于某种原因部署没有按计划进行，首先删除它，然后重新开始</p><p id="b56b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl delete deployment hi-deployment</code></p><p id="0693" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><p id="1134" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl get deployments</code></p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="7183" class="mj kv iq ma b gy mk ml l mm mn">NAME            READY   UP-TO-DATE   AVAILABLE   AGE<br/>hi-deployment   1/1     1            1           10s</span></pre><p id="bb0d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">公开服务，以便我们可以从主机上看到它:</p><p id="7697" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl expose deployment hi-deployment --type=NodePort --port=8090</code> <code class="fe lx ly lz ma b">kubectl get services</code></p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="4d6c" class="mj kv iq ma b gy mk ml l mm mn">NAME              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          hi-deployment     NodePort    10.110.54.136  &lt;none&gt;   8090:32326/TCP<!-- --> </span></pre><p id="ed31" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在浏览器上查看:</p><p id="c22d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">minikube service hi-deployment</code></p><p id="b541" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应该会在浏览器中启动。</p><p id="696c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="http://192.168.99.101:32326/there" rel="noopener ugc nofollow" target="_blank">http://192 . 168 . 99 . 101:32326/there</a></p><p id="dce4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">仪表板应显示服务/部署/pod运行情况:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/80fa449dd07cb3086cfb689ba5a16c41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*68R9X7dOSk5xCz1a.png"/></div></div></figure><p id="4c75" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这将保持运行，即使当pod被删除。</p><p id="1092" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尝试</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="7bdf" class="mj kv iq ma b gy mk ml l mm mn">kubectl get pods <br/>kubectl delete pod &lt;pod&gt; <br/>kubectl get pods</span></pre><p id="c25e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一个新的应该几乎立刻被竖起来。</p><p id="3c85" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">导航回该url。<br/>应该还在运行。这，k8s的威力。</p><p id="803c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">删除部署和服务。</p><p id="2cc4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl delete deployment hi-deployment</code></p><h1 id="7e4e" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">Gitlab Kubernetes集成</h1><p id="5fee" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">回到http://gitlib.lightphos.com:30080<a class="ae ks" href="http://gitlib.lightphos.com:30080" rel="noopener ugc nofollow" target="_blank">的本地git lib</a></p><p id="4177" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">白名单minikube ip，$(minikube ip):</p><p id="48b0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以root用户身份登录</p><p id="0a27" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">管理区-&gt;设置-&gt;网络-&gt;出站请求(勾选所有复选框)<br/>添加以下内容(无论minikube ip是什么):</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="49bc" class="mj kv iq ma b gy mk ml l mm mn">192.168.99.101</span></pre><p id="6555" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以您自己的身份登录导航到您的项目(嗨):</p><p id="dcc3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">git lab-&gt; hi-&gt; Operations-&gt; Kubernetes-&gt;添加现有集群</p><p id="c396" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于API  url，添加192.168.99.101:8443 (minikube)</p><p id="5ab2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">获取默认的<strong class="jw ir"> CA证书</strong>:</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="e8c1" class="mj kv iq ma b gy mk ml l mm mn">kubectl get secret $(kubectl get secrets | grep default | cut -f 1 -d ' ') -o jsonpath="{['data']['ca\.crt']}" | base64 --decode </span></pre><p id="9893" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用CA证书的结果细节</p><p id="8a16" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于服务令牌，创建一个文件manifest/git lab-Service-account . yml。注意:这提供了广泛的权限，下面显示了一个更具限制性的rbac.yml文件。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="fc1f" class="mj kv iq ma b gy mk ml l mm mn">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: gitlab-admin<br/>  namespace: kube-system<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: gitlab-admin<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: cluster-admin<br/>subjects:<br/>- kind: ServiceAccount<br/>  name: gitlab-admin<br/>  namespace: kube-system</span></pre><p id="53f1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用于k8s:</p><p id="ed84" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl apply -f manifest/gitlab-service-account.yml</code></p><p id="daac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检索令牌:</p><p id="6bf5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep gitlab-admin | awk '{print $1}')</code></p><p id="7d40" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将其添加到<strong class="jw ir">服务令牌</strong>字段。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ne"><img src="../Images/2e78e542d199579e1914ef3bf1878cd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kQIY7gAKEcUAc41D.png"/></div></div></figure><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nf"><img src="../Images/53fb9f8eed971111ec1ecbdb7381696b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fSYxy7Qr5tNwRmUV.png"/></div></div></figure><p id="6a53" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查<strong class="jw ir"> Gitlab管理的集群</strong>选项。</p><p id="52dd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加CA和令牌后，minikube k8s将与Gitlab集成。你可以通过安装舵柄来测试连接。</p><p id="0a2e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">注意</strong>:K8s中的命名空间默认为&lt;project _ name&gt;-&lt;project _ id&gt;-&lt;environment&gt;。关于如何将其设置为固定名称，请参见下文。</p><h1 id="7539" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">通过Gitlab CI Automation向K8s部署Hi Go服务</h1><p id="91d1" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">更新。gitlab-ci.yml文件，我们在之前的帖子中有如下内容:</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="8a83" class="mj kv iq ma b gy mk ml l mm mn">variables:<br/>  REPO_NAME: ${CI_REGISTRY}/${CI_PROJECT_PATH}<br/>  CONTAINER_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_BUILD_REF_NAME}_${CI_BUILD_REF}<br/>  CONTAINER_IMAGE_LATEST: ${CI_REGISTRY}/${CI_PROJECT_PATH}:latest<br/>  DOCKER_DRIVER: overlay2<br/><br/>before_script:<br/>  - mkdir -p $GOPATH/src/$(dirname $REPO_NAME)<br/>  - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_NAME<br/>  - cd $GOPATH/src/$REPO_NAME  <br/><br/><br/>stages:<br/>  - test<br/>  - build<br/>  - release<br/>  - deploy<br/><br/>format:<br/>  image: golang:latest<br/>  stage: test<br/>  script:<br/>    - go fmt $(go list ./... | grep -v /vendor/)<br/>    - go vet $(go list ./... | grep -v /vendor/)<br/>    - go test -race $(go list ./... | grep -v /vendor/)<br/><br/>compile:<br/>  image: golang:latest<br/>  stage: build<br/>  script:<br/>    - go build -race -ldflags "-extldflags '-static'" -o $CI_PROJECT_DIR/hi<br/>  artifacts:<br/>    paths:<br/>      - hi<br/><br/><br/>release:<br/>  image: docker:19.03.1<br/>  stage: release<br/>  before_script:<br/>    - echo ${CONTAINER_IMAGE}<br/>    - echo  $CI_BUILD_TOKEN | docker login -u gitlab-ci-token --password-stdin ${CI_REGISTRY}<br/>  script:<br/>    - docker build -t ${CONTAINER_IMAGE} -t ${CONTAINER_IMAGE_LATEST} .<br/>    - docker push ${CONTAINER_IMAGE}<br/>    - docker push ${CONTAINER_IMAGE_LATEST}<br/><br/>deploy:<br/>  image: dtzar/helm-kubectl<br/>  stage: deploy<br/>  environment:<br/>    name: production  # you need to specify an environment to access KUBE vars<br/>    url: http://hi.info/earth<br/>  script:<br/>   - echo CI_PROJECT_ID=$CI_PROJECT_ID<br/>   - echo KUBE_URL=$KUBE_URL<br/>   - echo KUBE_CA_PEM_FILE=$KUBE_CA_PEM_FILE<br/>   - echo KUBE_TOKEN=$KUBE_TOKEN<br/>   - echo KUBE_NAMESPACE=$KUBE_NAMESPACE<br/>   - kubectl config set-cluster "$CI_PROJECT_ID" --server="$KUBE_URL" --certificate-authority="$KUBE_CA_PEM_FILE"<br/>   - kubectl config set-credentials "$CI_PROJECT_ID" --token="$KUBE_TOKEN"<br/>   - kubectl config set-context "$CI_PROJECT_ID" --cluster="$CI_PROJECT_ID" --user="$CI_PROJECT_ID" --namespace="$KUBE_NAMESPACE"<br/>   - kubectl config use-context "$CI_PROJECT_ID"<br/>   - kubectl delete secret gitlab.lightphos --namespace="$KUBE_NAMESPACE" --ignore-not-found<br/>   - kubectl create secret docker-registry gitlab.lightphos --docker-server=${CI_REGISTRY} --docker-username="$CI_REGISTRY_USER" --docker-password="$CI_REGISTRY_PASSWORD" --namespace="$KUBE_NAMESPACE"<br/>   - kubectl delete deployment hi-deployment --ignore-not-found<br/>   - sed -i "s~__CI_REGISTRY_IMAGE__~${CI_REGISTRY_IMAGE}~" manifest/deployment.yml<br/>   - sed -i "s/__CI_ENVIRONMENT_SLUG__/${CI_ENVIRONMENT_SLUG}/" manifest/deployment.yml manifest/service.yml manifest/ingress.yml <br/>   - sed -i "s/__VERSION__/${CI_BUILD_REF_NAME}_${CI_BUILD_REF}/" manifest/deployment.yml <br/>   - kubectl apply -f manifest/deployment.yml<br/>   - kubectl apply -f manifest/service.yml<br/>   - kubectl apply -f manifest/ingress.yml<br/>   - kubectl rollout status -f manifest/deployment.yml<br/>   - kubectl get all,ing -l ref=${CI_ENVIRONMENT_SLUG}</span></pre><p id="42d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">manifest/deployment.yml</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="8467" class="mj kv iq ma b gy mk ml l mm mn">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: hi-deployment<br/>  labels:<br/>    app: hi<br/>    ref: __CI_ENVIRONMENT_SLUG__<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: hi<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: hi<br/>        ref: __CI_ENVIRONMENT_SLUG__<br/>    spec:<br/>      containers:<br/>      - name: hi<br/>        image: __CI_REGISTRY_IMAGE__:__VERSION__<br/>        ports:<br/>        - containerPort: 8090<br/>      imagePullSecrets:<br/>        - name: gitlab.lightphos</span></pre><p id="88a2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">manifest/service.yml</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="f177" class="mj kv iq ma b gy mk ml l mm mn">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: hi-service<br/>  labels:<br/>    app: hi<br/>    ref: __CI_ENVIRONMENT_SLUG__<br/>spec:<br/>  type: NodePort<br/>  externalIPs:<br/>    - 192.168.99.101<br/>  selector:<br/>    app: hi<br/>  ports:<br/>    - port: 3000<br/>      nodePort: 30002<br/>      protocol: TCP<br/>      targetPort: 8090<!-- --> </span></pre><p id="64b6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">推动并查看部署在k8s上的管道。注意:在minikube中选择<strong class="jw ir"> hi-3-production </strong>名称空间。(3是我们本地gitlabs中的项目id，你的可能不一样)。</p><p id="099a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">管道运行后。我们应该看到以下内容。</p><p id="7cc8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">K8s部署:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ng"><img src="../Images/50391c290ab456c8af838910526a73fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hE_a8X53w9GCiIdr.png"/></div></div></figure><p id="8674" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">图片:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nh"><img src="../Images/f8ecb12556e4f0f469fec513a3245570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*S2N6-096BjLXf9-q.png"/></div></div></figure><p id="c327" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">服务:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ni"><img src="../Images/faf9d3d6498c5cfaa97760d63f930d72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eQgsWZ6q7FD6vvb7.png"/></div></div></figure><p id="94d2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">仔细讨论</p><p id="652b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">minikube service hi-service --namespace=hi-3-production</code></p><p id="5bf9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者</p><p id="e947" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">点击服务链接按钮</p><p id="cade" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者</p><p id="3a18" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从Gitlab环境-&gt;生产-&gt;打开实时环境按钮</p><p id="7802" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应该带你去<br/><a class="ae ks" href="http://192.168.99.101:31878/good" rel="noopener ugc nofollow" target="_blank">http://192 . 168 . 99 . 101:3000/</a>地球</p><h1 id="ab39" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">进入</h1><p id="d733" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">添加一个Nginx入口LB。注意入口增加服务。yml不需要节点端口或外部IP。我们将通过主机名hi.info访问该站点。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="3892" class="mj kv iq ma b gy mk ml l mm mn">minikube addons enable ingress</span></pre><p id="310a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查它是否启动:</p><p id="e62e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl get pods -n kube-system | grep nginx-ingress-controller</code></p><p id="6b42" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">日志:</p><p id="d213" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl logs -f -n kube-system $(kubectl get pods -n kube-system | grep nginx-ingress-controller | cut -f 1 -d ' ')</code></p><p id="0b96" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">配置:</p><p id="74e8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl exec -it -n kube-system &lt;nginx ingress controller&gt; cat /etc/nginx/nginx.conf</code></p><p id="1a83" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">manifest/ingress.yml</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="9a29" class="mj kv iq ma b gy mk ml l mm mn">apiVersion: networking.k8s.io/v1beta1 # for versions before 1.14 use extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: hi-ingress<br/>  labels:<br/>    app: hi<br/>    ref: __CI_ENVIRONMENT_SLUG__<br/>  # annotations:<br/>  #   nginx.ingress.kubernetes.io/rewrite-target: /$1 &lt;- stops request parameters being passed<br/>spec:<br/>  rules:<br/>  - host: hi.info<br/>    http:<br/>        paths:<br/>        - path: /<br/>          backend:<br/>            serviceName: hi-service<br/>            servicePort: 3000</span></pre><p id="5454" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用它(添加到. gitlabci.yml中的部署阶段，如下所示):</p><p id="e4fa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">kubectl apply -f manifest/ingress.yml</code></p><p id="7bcb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将minikube ip和主机名hi.info添加到/etc/hosts</p><p id="9b03" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lx ly lz ma b">echo "$(minikube ip) hi.info" | sudo tee -a /etc/hosts</code></p><p id="0dc5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">浏览:</p><p id="49f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">http://hi.info/earth<a class="ae ks" href="http://hi.info/earth" rel="noopener ugc nofollow" target="_blank"/></p><p id="d9ed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">瞧…</p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><h1 id="1771" class="ku kv iq bd kw kx nq kz la lb nr ld le lf ns lh li lj nt ll lm ln nu lp lq lr bi translated">使用固定的名称空间</h1><p id="4c54" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">基于这篇优秀的帖子:<a class="ae ks" href="https://edenmal.moe/post/2019/GitLab-Kubernetes-Using-GitLab-CIs-Kubernetes-Cluster-feature/#gitlab-ci-kubernetes-cluster-feature" rel="noopener ugc nofollow" target="_blank">https://Eden mal . moe/post/2019/git lab-Kubernetes-Using-git lab-CIs-Kubernetes-Cluster-feature/# git lab-ci-Kubernetes-Cluster-feature</a></p><ol class=""><li id="c051" class="nv nw iq jw b jx jy kb kc kf nx kj ny kn nz kr oa ob oc od bi translated">在k8s <br/>上创建名称空间</li><li id="d9a9" class="nv nw iq jw b jx oe kb of kf og kj oh kn oi kr oa ob oc od bi translated">应用rbac.yml文件(如下)<br/>ku bectl apply-f manifest/RBAC . yml</li><li id="b46b" class="nv nw iq jw b jx oe kb of kf og kj oh kn oi kr oa ob oc od bi translated">获取编码的CA和令牌<br/>ku bectl get-n light phos secret $(ku bectl get-n light phos secret | grep git lab-ci | cut-f 1-d ' ')-o YAML</li><li id="b72a" class="nv nw iq jw b jx oe kb of kf og kj oh kn oi kr oa ob oc od bi translated">从base64 <br/>回应&lt; CA &gt; | base64 —解码，回应&lt;令牌&gt; | base64 —解码</li><li id="9c91" class="nv nw iq jw b jx oe kb of kf og kj oh kn oi kr oa ob oc od bi translated">添加到gitlab -&gt; operations -&gt; kubernetes。</li><li id="2d1b" class="nv nw iq jw b jx oe kb of kf og kj oh kn oi kr oa ob oc od bi translated">将项目名称空间设置为lightphos，取消选中Gitlab管理的集群</li><li id="85d7" class="nv nw iq jw b jx oe kb of kf og kj oh kn oi kr oa ob oc od bi translated">部署项目。Gitlab ci文件。gitlab-ci.yml应该不需要改。</li><li id="8288" class="nv nw iq jw b jx oe kb of kf og kj oh kn oi kr oa ob oc od bi translated">代码现在将被部署到lightphos名称空间。<br/>在<a class="ae ks" href="http://hi.info/there" rel="noopener ugc nofollow" target="_blank"> http://hi.info </a>上，该网站应该照常可用</li></ol><p id="bb86" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">清单/rbac.yml</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="ed10" class="mj kv iq ma b gy mk ml l mm mn">---<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: gitlab-ci<br/>  namespace: lightphos<br/>---<br/>kind: Role<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>metadata:<br/>  namespace: lightphos<br/>  name: gitlab-ci<br/>rules:<br/>- apiGroups: [""]<br/>  resources: ["*"]<br/>  verbs: ["*"]<br/>- apiGroups: ["apps"]<br/>  resources: ["*"]<br/>  verbs: ["*"]<br/>- apiGroups: ["batch"]<br/>  resources: ["*"]<br/>  verbs: ["*"]<br/>- apiGroups: ["extensions"]<br/>  resources: ["*"]<br/>  verbs: ["*"]<br/>- apiGroups: ["autoscaling"]<br/>  resources: ["*"]<br/>  verbs: ["*"]<br/>- apiGroups: ["networking.k8s.io"]<br/>  resources: ["*"]<br/>  verbs: ["*"]<br/>---<br/>kind: RoleBinding<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>metadata:<br/>  name: gitlab-ci<br/>  namespace: lightphos<br/>subjects:<br/>- kind: ServiceAccount<br/>  name: gitlab-ci<br/>  namespace: lightphos<br/>roleRef:<br/>  kind: Role<br/>  name: gitlab-ci<br/>  apiGroup: rbac.authorization.k8s.io</span></pre><p id="fa27" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">gitlab ci管道部署阶段的控制台输出:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oj"><img src="../Images/0f9ecd3cc34a563757e3630a8bf5c1e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p9h227mVivzYcNOa.png"/></div></div></figure></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><p id="582f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kt">原载于2019年11月12日</em><a class="ae ks" href="https://blog.ramjee.uk/minikube-and-gitlab-ci/" rel="noopener ugc nofollow" target="_blank"><em class="kt">https://blog . ram JEE . uk</em></a><em class="kt">。</em></p></div></div>    
</body>
</html>