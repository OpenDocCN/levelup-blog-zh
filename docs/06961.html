<html>
<head>
<title>Node.js Basics — Add Authentication to an Express App with Passport</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js基础知识-使用Passport向Express应用程序添加身份验证</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/node-js-basics-add-authentication-to-an-express-app-with-passport-55a181105263?source=collection_archive---------4-----------------------#2021-01-14">https://levelup.gitconnected.com/node-js-basics-add-authentication-to-an-express-app-with-passport-55a181105263?source=collection_archive---------4-----------------------#2021-01-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/559ebc8ec6844a552fe760b43597a105.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7_ALYhsBzoTd-jK7"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@nicolegeri?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">妮可·格里</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="6597" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我们将了解如何开始使用Node.js创建程序。</p><h1 id="e049" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">证明</h1><p id="fcff" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在现实世界中，许多HTTP请求只能在用户通过身份验证后才能发出。我们可以在Node.js应用程序中轻松做到这一点。</p><p id="2356" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了让我们的生活更容易，我们使用Express web框架来创建我们的HTTP服务器，而不是使用内置的<code class="fe mh mi mj mk b">http</code>模块。</p><p id="9adc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们还需要<code class="fe mh mi mj mk b">passport</code>和<code class="fe mh mi mj mk b">passport-local</code>来添加认证和<code class="fe mh mi mj mk b">body-parser</code>包来解析请求体。</p><p id="f140" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了安装所有的包，我们运行:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="fa96" class="mt lf it mk b gy mu mv l mw mx">npm install express body-parser passport passport-local</span></pre><p id="46b2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我们可以编写下面的代码来添加与<code class="fe mh mi mj mk b">passport</code>的认证:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="3700" class="mt lf it mk b gy mu mv l mw mx">const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const Passport = require('passport');<br/>const LocalStrategy = require('passport-local').Strategy;<br/>const users = {<br/>  foo: {<br/>    username: 'foo',<br/>    password: 'bar',<br/>    id: 1<br/>  },<br/>  bar: {<br/>    username: 'bar',<br/>    password: 'foo',<br/>    id: 2<br/>  }<br/>}</span><span id="a29f" class="mt lf it mk b gy my mv l mw mx">const localStrategy = new LocalStrategy({<br/>    usernameField: 'username',<br/>    passwordField: 'password'<br/>  },<br/>  function(username, password, done) {<br/>    user = users[username];<br/>    if (user === undefined) {<br/>      return done(null, false, {<br/>        message: 'Invalid user'<br/>      });<br/>    }<br/>    if (user.password !== password) {<br/>      return done(null, false, {<br/>        message: 'Invalid password'<br/>      });<br/>    }<br/>    done(null, user);<br/>  })</span><span id="01f0" class="mt lf it mk b gy my mv l mw mx">const app = express();</span><span id="a271" class="mt lf it mk b gy my mv l mw mx">app.use(bodyParser.json());<br/>app.use(bodyParser.urlencoded({<br/>  extended: true<br/>}));</span><span id="3e22" class="mt lf it mk b gy my mv l mw mx">app.use(express.static('public'));<br/>app.use(Passport.initialize());<br/>Passport.use('local', localStrategy);</span><span id="b4f8" class="mt lf it mk b gy my mv l mw mx">app.get('/', (req, res) =&gt; {<br/>  res.sendFile('public/index.html');<br/>});</span><span id="c15a" class="mt lf it mk b gy my mv l mw mx">app.post(<br/>  '/login',<br/>  Passport.authenticate('local', {<br/>    session: false<br/>  }),<br/>  function(request, response) {<br/>    response.send('User Id ' + request.user.id);<br/>  }<br/>);</span><span id="d38f" class="mt lf it mk b gy my mv l mw mx">app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="d755" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要<code class="fe mh mi mj mk b">passport</code>和<code class="fe mh mi mj mk b">passport-local</code>封装。</p><p id="d58d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我们使用<code class="fe mh mi mj mk b">LocalStrategy</code>构造函数来创建我们的认证机制。</p><p id="d635" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mh mi mj mk b">userField</code>和<code class="fe mh mi mj mk b">passwordField</code>被设置为<code class="fe mh mi mj mk b">users</code>对象中对象的属性，这样我们就可以获得用户名和密码的属性。</p><p id="8396" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后在我们传入第二个参数<code class="fe mh mi mj mk b">LocalStrategy</code>的函数中，我们检查<code class="fe mh mi mj mk b">user</code>并检查密码。</p><p id="2de6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">调用<code class="fe mh mi mj mk b">done</code>函数，让我们根据用户名或密码的有效性返回我们想要的响应消息。</p><p id="714a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当用户名和密码都有效时，运行最后一个<code class="fe mh mi mj mk b">done</code>调用。</p><p id="6060" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我们调用<code class="fe mh mi mj mk b">Passport.use</code>来创建<code class="fe mh mi mj mk b">'local'</code>认证策略，这样我们就可以使用上面的代码和<code class="fe mh mi mj mk b">Passport.authenticate</code>函数。</p><p id="7122" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们可以使用<code class="fe mh mi mj mk b">request.user</code>属性获取经过身份验证的用户的数据。</p><p id="c0bf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">数据是通过调用以下命令获得的:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="d6a3" class="mt lf it mk b gy mu mv l mw mx">done(null, user);</span></pre><p id="0cd2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，当我们用请求体向<code class="fe mh mi mj mk b">/login</code>路由发出POST请求时:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="550d" class="mt lf it mk b gy mu mv l mw mx">{<br/>    "username": "foo",<br/>    "password": "bar"<br/>}</span></pre><p id="a878" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后我们得到:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="01e9" class="mt lf it mk b gy mu mv l mw mx">User Id 1</span></pre><p id="4a24" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从服务器返回。</p><p id="028e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们有一个不在<code class="fe mh mi mj mk b">users</code>对象中的用户名和密码组合，那么我们得到一个<code class="fe mh mi mj mk b">Unauthorized</code>响应体和一个401状态码。</p><h1 id="0e08" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="5a2a" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为了更容易地向代码中添加身份验证，我们可以使用Passport来添加中间件，从而更容易地添加基本身份验证。</p></div></div>    
</body>
</html>