<html>
<head>
<title>Golang Fantasy Hunting App, 2: Using Your Golang Lambda with DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang幻想狩猎应用程序，2:使用你的Golang Lambda与DynamoDB</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/golang-fantasy-hunting-app-2-using-your-golang-lambda-with-dynamodb-9c82b0b91783?source=collection_archive---------6-----------------------#2020-08-20">https://levelup.gitconnected.com/golang-fantasy-hunting-app-2-using-your-golang-lambda-with-dynamodb-9c82b0b91783?source=collection_archive---------6-----------------------#2020-08-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/3674832b5a0f108d39df98ca309c52e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QGwWOQObSu4q0K-v43h-hg.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">安妮·尼加德在<a class="ae kf" href="https://unsplash.com/s/photos/monster?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="2738" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">本文系列的第一部分可以在这里找到</em><a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/golang-fantasy-hunting-app-1-deploying-a-golang-app-to-lambda-on-aws-f9b950648bae"><em class="le"/></a><em class="le">。我建议您从那里开始了解完整的背景。但是，如果你只是想了解如何让一个golang lambda与dynamodb对话，那么你可以从</em> <a class="ae kf" href="https://github.com/z3n0tus/fantasy-log-basic" rel="noopener ugc nofollow" target="_blank"> <em class="le">这里</em> </a> <em class="le">克隆这个项目的启动代码(你将需要把它部署到AWS)。</em></p><p id="98c5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我们编写了一个基本的lambda，并将其部署到AWS。下一个难题是将它连接到DynamoDB，这样我们可以将新的怪物保存到日志中，并更新现有的怪物。</p><p id="0b3c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为此，我们需要做以下三件事:</p><ul class=""><li id="df42" class="lf lg it ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated">创建一个新的发电机表</li><li id="7e73" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">授予我们保存/更新lambda的权限，以写入dynamo表</li><li id="6a94" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">编写连接到表并插入记录的代码</li></ul><p id="2241" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">创建发电机表</strong></p><p id="0b43" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">注意:迪纳摩会让你花钱。那里<em class="le">是</em>自由层，但是我曾经在EC2上欠了300美元，当时我以为我在自由层。我本可以把钱花在花生酱上。做你的研究。</strong></p><p id="7b75" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要创建dynamo表，请访问AWS控制台中的dynamo服务(<a class="ae kf" href="https://eu-west-1.console.aws.amazon.com/dynamodb/home" rel="noopener ugc nofollow" target="_blank">此处为</a>)并点击“创建表”。给你的表一个名字和一个主键。这将用于在您的表中查找记录。为此使用<code class="fe lt lu lv lw b">id</code>。然后单击创建。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lx"><img src="../Images/4bb15292cd2f9b468334abe2d018e61d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6G9jdBQhPctEIPyXMfxiHg.png"/></div></div></figure><p id="b638" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不要创建二级索引，因为那肯定会让你付出代价。</p><p id="21e2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">授予您的lambda读/写权限</strong></p><p id="2ffb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们的lambda无法与该表进行交互。他们现在真的不能处理彼此的事情。要让他们成为朋友，请进入lambda的保存/更新控制台页面，点击顶部的权限选项卡。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mc"><img src="../Images/6e59e922d414c388e3a177146e2240c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zhxnWGJds16T8VxAdt7cQw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">抱歉，用这个毫无意义的截图来光顾你</figcaption></figure><p id="2282" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">单击角色名称，这将打开IAM控制台，您可以在其中配置与访问相关的各种角色和权限。</p><p id="31d3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">单击标有“附加策略”的蓝色按钮。如果看不到，请在这里试试这个链接<a class="ae kf" href="https://www.specsavers.com/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="4f69" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，在搜索框中输入‘dynamo db’，然后选择<code class="fe lt lu lv lw b">AmazonDynamoDBFullAccess</code>。</p><p id="8bab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">声明:为了安抚目前正在扫视我的窗户的一群戴眼镜的安全书呆子，我应该警告你，给任何东西完全的访问权都不是一个好主意。但既然什么都不重要，生活是痛苦的，而且我们都将不久于人世，我要说，去吧。请自便。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi md"><img src="../Images/ca06306e7d302961ea350029296b4a02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RDLRbDGXDiBCwHcPpmCSQg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">天哪，我们在做什么，这太疯狂了</figcaption></figure><p id="a9d3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">单击附加策略。</p><p id="0a74" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">通过代码连接到表，插入/更新记录</strong></p><p id="fb2f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我们最后一次离开代码时，它看起来像这样。</p><figure class="ly lz ma mb gt ju"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="4b0f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了保持代码的整洁和可重用性，我们将把dynamo的东西放在一个单独的包中。创建一个名为<code class="fe lt lu lv lw b">dynamo</code>的文件夹和一个名为<code class="fe lt lu lv lw b">dynamo.go</code>的文件。</p><p id="17a6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要创建两个函数，一个连接到dynamo，另一个向它写入数据。我会给你看完整的代码，然后再看一遍。</p><figure class="ly lz ma mb gt ju"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="b1a0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我将依次处理每个函数，但是首先，</p><ul class=""><li id="a9cb" class="lf lg it ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated">第1-10行并不新鲜。我们从AWS导入我们需要使用dynamo的类型和一堆包。<code class="fe lt lu lv lw b">fmt</code>包来自Go标准库，用于将文本打印到控制台。</li><li id="1c30" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">第12行演示了如何定义一个常数，即一个永远不会改变的值。</li></ul><p id="8477" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">createDynamoSession函数</em></p><p id="e13f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">createDynamoSession函数未被大写，因为它未在该文件外部被引用。</p><p id="8637" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个函数负责创建dynamo会话并返回它。您会注意到返回类型旁边有一个<code class="fe lt lu lv lw b">*</code>符号。这意味着我们正在返回一个<code class="fe lt lu lv lw b">pointer</code>。指针就是指向一个内存地址的指针。指针可以用来计算出一个值所在的确切的内存地址。这有各种各样的应用，但在这里不相关，对于我们的目的，指针的行为就像一个常规变量一样。</p><p id="a2dd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们使用AWS会话包创建一个会话对象，并向它传递一些选项。</p><p id="3d2a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们通过将aws会话对象传递给<code class="fe lt lu lv lw b">dynamodb.New()</code>来返回一个新的dynamodb会话。</p><p id="1db5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">save monster功能</em></p><p id="ba74" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">SaveMonster函数是大写的，因为它在这个文件之外被引用。</p><p id="7295" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在第15行，我们将monster对象编组到一个dynamo可以用来写的map中。这可能看起来很奇怪，因为我们刚刚在处理函数中将它从JSON有效负载转换为一个Monster类型。当您可以将JSON有效负载直接转换为dynamo map时，为什么要这样做呢？</p><p id="3887" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">原因是，首先将其转换为Monster类型会给我们一些隐式验证和类型检查。例如，如果我们试图在JSON有效负载中为怪物名称传递一个布尔值<code class="fe lt lu lv lw b">true</code>,而没有先将其转换为怪物类型，那么dynamo会很高兴地接受它，我们最终会得到一个名为true的愚蠢怪物，这一点也不可怕。但是通过解组它，我们迫使Go的JSON库验证所有的字段都匹配我们在Monster struct中指定的类型。这也使我们处于一个有利的位置，如果我们愿意的话，可以在以后做进一步的转变。</p><p id="bddb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第17–20行检查封送处理是否成功。如果不是，我们打印一些东西到控制台并原样返回错误，这样我们就可以把它反馈给调用lambda的客户机。</p><p id="6580" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第22行创建了dynamo会话。</p><p id="7c08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第24–27行获取monster map和表名，并将其组合成AWS定制类型之一，<code class="fe lt lu lv lw b">PutItemInput</code>，然后我们在第29行将其传递给<code class="fe lt lu lv lw b">PutItem</code>。PutItem将保存新的条目，但是如果条目的主键(在我们的例子中是<code class="fe lt lu lv lw b">id</code>)与表中已经存在的条目匹配，它还将更新任何现有的条目。</p><p id="9404" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第31–34行再次进行错误检查。</p><p id="7926" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第36行返回nil，这就是我们的处理函数如何知道在执行过程中没有错误。</p><p id="a6dc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">更改主文件</em></p><p id="fd57" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">既然我们已经完成了自定义dynamo客户端的编写，我们只需要更新我们的lambda处理程序就可以使用它了。这是应用更改后的样子。</p><figure class="ly lz ma mb gt ju"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="d5ac" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里只有几行是重要的。</p><ul class=""><li id="ceae" class="lf lg it ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated">第9行导入了我们新的dynamo客户机。</li><li id="9e09" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">第27行调用我们的<code class="fe lt lu lv lw b">SaveMonster</code>函数并检索错误。</li><li id="ebbc" class="lf lg it ki b kj lo kn lp kr lq kv lr kz ls ld lk ll lm ln bi translated">第29–31行检查是否存在错误，如果存在，它将错误返回给客户端。</li></ul><p id="f10e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我还将第33行从返回怪物的名字改为打印成功消息，但这并不重要。</p><p id="8f3d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">展开</strong></p><p id="c075" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成所有这些后，我们就可以部署了。像以前一样，通过运行<code class="fe lt lu lv lw b">GOOS=linux GOARCH=amd64 go build -v main.go</code>构建您的<code class="fe lt lu lv lw b">main.go</code>文件，然后压缩该文件并通过您的lamdba控制台上传它。完成后，运行我们在上一个教程中创建的测试事件，您应该会看到类似如下的输出。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mg"><img src="../Images/738cae58da56ce578f85a2706ea027a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5L2Rb7uf-ml9LVJ67X8h5A.png"/></div></div></figure><p id="6514" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你去迪纳摩的牌桌，你会看到你的记录被保存下来。</p><figure class="ly lz ma mb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mh"><img src="../Images/bff31584b238432bc4cb39c0db667be9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CsryLN1TfI3hRn7IYTP0Hg.png"/></div></div></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><p id="a2d8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这一部分，你学习了如何创建一个dynamo表，给你的lambda dynamo权限，并通过Go代码与dynamo交互。下一篇文章将演示如何在lambda前面添加一个API网关，并把它变成一个HTTP服务。</p><p id="3c2f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">这部分的所有代码都可以在</em> <a class="ae kf" href="https://github.com/z3n0tus/fantasy-log-dynamo" rel="noopener ugc nofollow" target="_blank"> <em class="le">这里</em> </a> <em class="le">找到。</em></p></div></div>    
</body>
</html>