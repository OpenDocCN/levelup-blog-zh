<html>
<head>
<title>Is your API fast enough? How to automate performance testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你的API够快吗？如何自动化性能测试</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/test-your-apis-performance-with-nbomber-load-testing-in-c-3aec1f888762?source=collection_archive---------2-----------------------#2022-12-07">https://levelup.gitconnected.com/test-your-apis-performance-with-nbomber-load-testing-in-c-3aec1f888762?source=collection_archive---------2-----------------------#2022-12-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/2866613a19666f1c4f04a3c21a532d22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aXYaP8lnA_cM9Ff0"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Kolleen Gladden 在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="6ebd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">我将向你展示如何用多个协调的用户编写真实的负载测试。这篇文章将帮助你自信地回答题目中的问题。</em></p><p id="8a23" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://www.the-koi.com/projects/nbomber-load-testing-ship-with-confidence-robust-stress-tested-apis/" rel="noopener ugc nofollow" target="_blank">本文最初发表在我的博客the-koi.com上。</a></p><p id="a560" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果C#不是你的语言类型，不要担心，你只需要这种测试技术的基础。如果你想学，我可以向你推荐这门课程。</p><h1 id="c750" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">什么是负载测试？</h1><p id="7caa" class="pw-post-body-paragraph kg kh it ki b kj md kl km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld im bi translated">负载测试模拟系统与n个用户的交互，收集从响应时间到RAM和CPU使用等系统指标的多维指标。负载测试有助于您发现仅在超过100个用户时才会出现的性能问题，这些问题可能会导致大问题。对于我们的情况，这是一个低效的查询，导致整个应用程序饥饿，azure应用服务频繁重启和无理由扩展。</p><p id="82bb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在负载测试中，不仅仅是询问服务器是否可以处理大量并发连接，这在现实生活中永远不会发生，所以我们不应该关心这个！如果你受到DDos攻击，这种情况可能会发生，但这是另一篇文章的另一个主题。此外，我们应该关心模拟用户真正使用系统做什么，以及模拟系统用户交互有多复杂。然后由负载测试器本身收集数据，以获得关于请求计时的信息。这有助于发现导致问题的请求，并在应用程序监控工具上进一步调查它们。NBomber在模拟请求以发现这些问题方面做得很好。</p><h1 id="b3a1" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">为什么我应该对我的应用程序进行负载测试</h1><p id="9f40" class="pw-post-body-paragraph kg kh it ki b kj md kl km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld im bi translated">可用性专家Jakob Nielsen为应用程序定义了三个响应时间限制:</p><ul class=""><li id="5794" class="mi mj it ki b kj kk kn ko kr mk kv ml kz mm ld mn mo mp mq bi translated"><strong class="ki iu"> <em class="le"> 0.1秒</em> </strong> <em class="le">大约是让用户感觉系统是</em> <strong class="ki iu"> <em class="le">即时反应</em> </strong> <em class="le">的极限，意味着除了显示结果之外，不需要特别的反馈。</em></li><li id="fa90" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated"><strong class="ki iu"> <em class="le"> 1.0秒</em> </strong> <em class="le">大约是</em> <strong class="ki iu"> <em class="le">用户的思想流</em> </strong> <em class="le">保持不间断的极限，即使用户会注意到延迟。通常，在大于0.1秒但小于1.0秒的延迟期间，不需要特殊的反馈，但是用户确实失去了直接在数据上操作的感觉。</em></li><li id="730a" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated"><strong class="ki iu"> <em class="le"> 10秒</em> </strong> <em class="le">是关于</em> <strong class="ki iu"> <em class="le">保持用户注意力</em> </strong> <em class="le">集中在对话上的极限。对于更长时间的延迟，用户会希望在等待计算机完成时执行其他任务，因此他们应该得到反馈，表明计算机预计什么时候完成。如果响应时间可能变化很大，延迟期间的反馈尤其重要，因为用户不知道会发生什么。</em></li></ul><p id="7baa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你不希望应用程序执行一个动作的时间超过10秒，所以你的用户会这样做。因此，性能会决定用户的胜败。负载测试为我们提供了一个工具，在没有真实用户的真实条件下测试我们的应用程序的性能。</p><p id="5f31" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当你正在创业，并且像我一样正在准备你的应用程序的发布时，你有信心应用程序能够处理你想要的用户数量吗？</p><p id="f9b7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对我来说，这一直是一个很大的担忧，你可以手动测试每样东西对10个人都有效，但是对100个人也有效吗？1,000?或者更多？你能在不提供披萨和啤酒的情况下，一天多次重复这些测试吗？我不这么认为。你永远不会知道，因为没有办法手动测试。这就是负载测试发挥作用的地方。有了负载测试，你可以对你的应用程序进行压力测试，并且自信地说它可以为数百个用户工作。这不仅在启动应用程序之前很重要，在启动新功能之前也很重要，因为这也可能会破坏应用程序的性能，而且在发布之前您可能不会意识到这一点。</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/e6d6213cfdcadeb697c81d0bf67dcf80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*nX5d1BvqCgJ_X32u.png"/></div></figure><p id="89f1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面你可以看到一个用户在使用一个没有负载测试的应用程序。你不想要那种用户！以前快乐的用户现在可能不满意，离开你的应用程序，或者取消订阅。当然，你会在你的用户信任分数上损失一些分数。因此，请在您的CI中集成一些负载测试。</p><h1 id="b329" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">为什么用NBomber作为C#负载测试工具？</h1><p id="5bc2" class="pw-post-body-paragraph kg kh it ki b kj md kl km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld im bi translated">NBomber 是一个易于使用的工具，用于<strong class="ki iu">负载测试</strong>您的应用程序。它提供了一个干净易用的API。负载测试本身不仅写得很快，而且编排得很好，NBomber正在为您收集大量有用的数据，以便真正评估您的测试。</p><p id="7d34" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对我来说，最大的优势是负载模拟，在这里你不只是向一个端点发出哑100请求，而且，它们是定时的，模拟真实用户使用你的API提供的数据或访问你的应用的行为。</p><p id="f26a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为测试本身只是执行API调用，所以这是一个黑盒测试过程。这意味着<strong class="ki iu">有了nBomber，你可以测试任何项目，不管是哪种编程语言！</strong></p><h1 id="a6e7" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">基本炸弹示例</h1><h2 id="7947" class="nb lg it bd lh nc nd dn ll ne nf dp lp kr ng nh lt kv ni nj lx kz nk nl mb nm bi translated">创建控制台应用程序项目</h2><p id="e83e" class="pw-post-body-paragraph kg kh it ki b kj md kl km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld im bi translated"><code class="fe nn no np nq b">dotnet new console -n [project_name] -lang ["F#" or "C#"]</code></p><p id="278e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nn no np nq b">dotnet new console -n NBomberTest -lang "F#"</code></p><p id="a16e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nn no np nq b">cd NBomberTest</code></p><h2 id="4991" class="nb lg it bd lh nc nd dn ll ne nf dp lp kr ng nh lt kv ni nj lx kz nk nl mb nm bi translated">添加NBomber包</h2><p id="eefb" class="pw-post-body-paragraph kg kh it ki b kj md kl km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld im bi translated"><code class="fe nn no np nq b">dotnet add package NBomber</code></p><p id="6387" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确保还添加了bomber HTTP包，以获得更简单的HTTP请求API。</p><p id="55fc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nn no np nq b">dotnet add package NBomber.http</code></p><p id="6692" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，让我们看看NBomber文档中的生产就绪示例测试</p><p id="78f6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该测试将模拟访问NBomber网站。</p><pre class="mx my mz na gt nr nq ns bn nt nu bi"><span id="ed82" class="nv lg it nq b be nw nx l ny nz">using System;</span></pre><pre class="oa nr nq ob oc aw od bi"><span id="5798" class="nb lg it nq b gy oe of l og nz">using NBomber;<br/>using NBomber.Contracts;<br/>using NBomber.CSharp;<br/>using NBomber.Plugins.Http.CSharp;<br/>using NBomber.Plugins.Network.Ping;</span><span id="286a" class="nb lg it nq b gy oh of l og nz">namespace NBomberTest<br/>{<br/>    class Program<br/>    {<br/>        static void Main(string[] args)<br/>        {<br/>            var step = Step.Create("fetch_html_page",<br/>                                   clientFactory: HttpClientFactory.Create(),<br/>                                   execute: context =&gt;<br/>                                   {<br/>                                       var request = Http.CreateRequest("GET", "https://nbomber.com")<br/>                                                         .WithHeader("Accept", "text/html");</span><span id="4146" class="nb lg it nq b gy oh of l og nz">                                       return Http.Send(request, context);<br/>                                   });</span><span id="e5d2" class="nb lg it nq b gy oh of l og nz">            var scenario = ScenarioBuilder<br/>                .CreateScenario("simple_http", step)<br/>                .WithWarmUpDuration(TimeSpan.FromSeconds(5))<br/>                .WithLoadSimulations(<br/>                    Simulation.InjectPerSec(rate: 100, during: TimeSpan.FromSeconds(30))<br/>                );</span><span id="0cf1" class="nb lg it nq b gy oh of l og nz">            // creates ping plugin that brings additional reporting data<br/>            var pingPluginConfig = PingPluginConfig.CreateDefault(new[] { "nbomber.com" });<br/>            var pingPlugin = new PingPlugin(pingPluginConfig);</span><span id="ce80" class="nb lg it nq b gy oh of l og nz">            NBomberRunner<br/>                .RegisterScenarios(scenario)<br/>                .WithWorkerPlugins(pingPlugin)<br/>                .Run();<br/>        }<br/>    }<br/>}</span></pre><p id="dcd8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将以下代码复制到您的Programm.cs并执行</p><p id="486b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请确保您使用c#9.0或更高版本！</p><p id="acae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您使用的是旧版本，可以在。csproj文件</p><p id="3576" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">只需将它复制到您的。您的<code class="fe nn no np nq b">&lt;PropertyGroup&gt;</code>标签中的csproj文件。</p><pre class="mx my mz na gt nr nq ns bn nt nu bi"><span id="4ff8" class="nv lg it nq b be nw nx l ny nz">&lt;LangVersion&gt;10.0&lt;/LangVersion&gt;</span></pre><p id="2df6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">NBomber将开始轰炸你的应用程序</p><p id="e70d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您将在控制台中看到以下内容:</p><pre class="mx my mz na gt nr nq ns bn nt nu bi"><span id="614c" class="nv lg it nq b be nw nx l ny nz">_   _   ____                        _<br/> | \ | | | __ )    ___    _ __ ___   | |__     ___   _ __<br/> |  \| | |  _ \   / _ \  | '_ ` _ \  | '_ \   / _ \ | '__|<br/> | |\  | | |_) | | (_) | | | | | | | | |_) | |  __/ | |<br/> |_| \_| |____/   \___/  |_| |_| |_| |_.__/   \___| |_|</span></pre><pre class="oa nr nq ob oc aw od bi"><span id="b837" class="nb lg it nq b gy oe of l og nz">12:24:20 [INF] NBomber '2.1.5' Started a new session:<br/>'2022-03-23_11.24.44_session_787459f0'.<br/>12:24:21 [INF] NBomber started as single node.<br/>12:24:21 [INF] Plugins: no plugins were loaded.<br/>12:24:21 [INF] Reporting sinks: no reporting sinks were loaded.<br/>12:24:21 [INF] Starting init...<br/>12:24:21 [INF] Target scenarios: 'simple_http'.<br/>12:24:21 [INF] Init finished.<br/>12:24:21 [INF] Starting warm up...</span><span id="ebc9" class="nb lg it nq b gy oh of l og nz">                   simple_http ---------------------------------------- 100% 00:00:30<br/>load: keep_constant, copies: 1</span><span id="d587" class="nb lg it nq b gy oh of l og nz">12:24:53 [INF] Starting bombing...</span><span id="3a96" class="nb lg it nq b gy oh of l og nz">                   simple_http ---------------------------------------- 100% 00:01:01<br/>load: keep_constant, copies: 1</span><span id="1f47" class="nb lg it nq b gy oh of l og nz">12:25:54 [INF] Stopping scenarios...<br/>12:25:54 [INF] Calculating final statistics...</span><span id="e253" class="nb lg it nq b gy oh of l og nz">────────────────────────────────────────────────────── test info ───────────────────────────────────────────────────────</span><span id="1b1d" class="nb lg it nq b gy oh of l og nz">test suite: 'nbomber_default_test_suite_name'<br/>test name: 'nbomber_default_test_name'</span><span id="1648" class="nb lg it nq b gy oh of l og nz">──────────────────────────────────────────────────── scenario stats ────────────────────────────────────────────────────</span><span id="5a6f" class="nb lg it nq b gy oh of l og nz">scenario: 'simple_http'<br/>duration: '00:01:00', ok count: 662, fail count: 0, all data: 0 MB<br/>load simulation: 'keep_constant', copies: 1, during: '00:01:00'<br/>┌────────────────────┬────────────────────────────────────────────────────────┐<br/>│               step │ ok stats                                               │<br/>├────────────────────┼────────────────────────────────────────────────────────┤<br/>│               name │ fetch_html_page                                        │<br/>│      request count │ all = 662, ok = 662, RPS = 11                          │<br/>│            latency │ min = 59,66, mean = 90,47, max = 367,5, StdDev = 32,04 │<br/>│ latency percentile │ 50% = 79,61, 75% = 92,48, 95% = 158,98, 99% = 209,15   │<br/>└────────────────────┴────────────────────────────────────────────────────────┘</span><span id="f742" class="nb lg it nq b gy oh of l og nz">──────────────────────────────────────────────────────── hints ─────────────────────────────────────────────────────────</span><span id="e39a" class="nb lg it nq b gy oh of l og nz">hint for Scenario 'simple_http':<br/>Step 'fetch_html_page' in scenario 'simple_http' didn't track status code. In order to track status code, you should use<br/>Response.Ok(statusCode: value)</span><span id="562c" class="nb lg it nq b gy oh of l og nz">hint for Scenario 'simple_http':<br/>Step 'fetch_html_page' in scenario 'simple_http' didn't track data transfer. In order to track data transfer, you should<br/>use Response.Ok(sizeInBytes: value)</span><span id="eb8c" class="nb lg it nq b gy oh of l og nz">12:25:55 [INF] Reports saved in folder:...</span></pre><p id="4b08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所以NBomber参观了我的<a class="ae kf" href="https://www.the-koi.com/playground/" rel="noopener ugc nofollow" target="_blank">测试操场</a>并收集了一些关于它的数据。</p><p id="f49f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了理解产生的输出，让我们看看负载测试的基础。</p><h1 id="0feb" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">负载测试基础</h1><p id="02e7" class="pw-post-body-paragraph kg kh it ki b kj md kl km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld im bi translated">在<a class="ae kf" href="https://nbomber.com/docs/loadtesting-basics" rel="noopener ugc nofollow" target="_blank"> Nbomber文档</a>中，也有关于负载测试基础的很好的解释。我在这里试着总结一下:</p><h1 id="843f" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">重要的负载测试指标</h1><p id="e78d" class="pw-post-body-paragraph kg kh it ki b kj md kl km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld im bi translated">因此，首先，我们看一下上一节中测试用例产生的统计数据。</p><pre class="mx my mz na gt nr nq ns bn nt nu bi"><span id="696c" class="nv lg it nq b be nw nx l ny nz">┌────────────────────┬────────────────────────────────────────────────────────┐<br/>│               step │ ok stats                                               │<br/>├────────────────────┼────────────────────────────────────────────────────────┤<br/>│               name │ fetch_html_page                                        │<br/>│      request count │ all = 662, ok = 662, RPS = 11                          │<br/>│            latency │ min = 59,66, mean = 90,47, max = 367,5, StdDev = 32,04 │<br/>│ latency percentile │ 50% = 79,61, 75% = 92,48, 95% = 158,98, 99% = 209,15   │<br/>└────────────────────┴────────────────────────────────────────────────────────┘</span></pre><ul class=""><li id="e18f" class="mi mj it ki b kj kk kn ko kr mk kv ml kz mm ld mn mo mp mq bi translated">请求计数</li><li id="de64" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">每秒请求数</li><li id="2ff8" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">我们的系统每秒能够处理的请求数。这是评价我们系统性能的一个重要指标。</li><li id="2e75" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">潜伏</li><li id="ad2b" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">发送请求和接收响应之间的时间。这应与RPS保持良好的关系。处理2分钟延迟的2k请求与处理5个1毫秒延迟的RPS一样糟糕。</li><li id="cccf" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">潜伏期百分比</li><li id="5e5f" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">特定时间内有多少百分比？这表明我们有多少好的或坏的请求。</li><li id="d1dc" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">本例中只有几个请求的延迟超过200毫秒，但其中一半不到80毫秒。这有助于您对上述数据进行分类。</li><li id="5254" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">了解您的系统</li><li id="9ac1" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">在负载测试中，有两种主要的系统类型</li><li id="5ac2" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated"><strong class="ki iu">封闭系统:</strong>它们有固定数量的用户，每个用户都会发送一个查询，然后等待响应。这将是一个API →数据库通信。所以数据库是一个封闭的系统。</li><li id="8570" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated"><strong class="ki iu">开放系统:</strong>执行请求的客户机数量可变。所有使用HTTP协议的东西，比如网站或API，都应该被认为是一个开放的系统。</li><li id="64a2" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">基于这些知识，我们稍后将为我们的系统选择正确的模拟。</li><li id="8666" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">对于封闭系统，这也可以是一个常数，但对于开放系统，我建议使用随机的。</li></ul><h1 id="00e8" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">如何编写NBomber负载测试</h1><p id="edcf" class="pw-post-body-paragraph kg kh it ki b kj md kl km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld im bi translated">每个NBomber测试包括三个主要部分</p><ol class=""><li id="6b19" class="mi mj it ki b kj kk kn ko kr mk kv ml kz mm ld oi mo mp mq bi translated">步骤</li><li id="86c1" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld oi mo mp mq bi translated">用户想要执行的操作。例如登录</li><li id="0d6d" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld oi mo mp mq bi translated">方案</li><li id="2d69" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld oi mo mp mq bi translated">模拟系统内部用户流的步骤组合。</li><li id="604e" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld oi mo mp mq bi translated">例如登录、加载用户数据、加载用户项目、打开项目、对项目进行更改</li><li id="8155" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld oi mo mp mq bi translated">nbomberrrunner</li><li id="190c" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld oi mo mp mq bi translated">注册并运行测试</li><li id="ea0e" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld oi mo mp mq bi translated">您可以定义要运行的测试名称和场景。</li></ol><p id="59ee" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">除了这些主要部分，您还可以有三个可选部分</p><ol class=""><li id="6a38" class="mi mj it ki b kj kk kn ko kr mk kv ml kz mm ld oi mo mp mq bi translated">数据馈送</li><li id="253e" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld oi mo mp mq bi translated">它将数据注入到您的测试中。例如，这可能是从Json文件加载用户列表。</li><li id="2e2e" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld oi mo mp mq bi translated">客户端工厂</li><li id="4b31" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld oi mo mp mq bi translated">创建您的客户端来执行并发测试。</li></ol><p id="2bc9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所以让我们从一个示例测试开始来描述这些部分。</p><h1 id="7dc2" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">真实API上的负载测试示例</h1><p id="9bdb" class="pw-post-body-paragraph kg kh it ki b kj md kl km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld im bi translated">我们将测试这个示例API的三个端点。所有这些请求都将在用户成功登录并访问其仪表板时执行，因此良好的性能对他们来说非常重要。</p><ul class=""><li id="c1f5" class="mi mj it ki b kj kk kn ko kr mk kv ml kz mm ld mn mo mp mq bi translated">用户/bySignedInUser</li><li id="c1d0" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">返回登录用户的用户数据</li><li id="23ba" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">公司/签名用户</li><li id="3b35" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">返回签名用户有权访问的公司详细信息</li><li id="c749" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">项目/公司</li><li id="6508" class="mi mj it ki b kj mr kn ms kr mt kv mu kz mv ld mn mo mp mq bi translated">返回给定公司的活动项目</li></ul><p id="0e05" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将要测试的API只向经过身份验证的用户返回数据。</p><h1 id="b48f" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">使用NBomber执行认证请求</h1><pre class="mx my mz na gt nr nq ns bn nt nu bi"><span id="27bd" class="nv lg it nq b be nw nx l ny nz">public static void Run()<br/>        {<br/>var httpFactory = ClientFactory.Create(<br/>name: "http_factory",<br/>clientCount: 5,<br/>// we need to init our client with our API token<br/>initClient: (number, context) =&gt;<br/>{<br/>var client = new HttpClient();<br/>client.DefaultRequestHeaders.Authorization =<br/>new AuthenticationHeaderValue(<br/>"Bearer",<br/>"&lt;your access token&gt;");<br/>return Task.FromResult(client);<br/>});</span></pre><p id="3e23" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们正在用httpFactory创建5个客户端。为了对NBomber 中的请求进行<strong class="ki iu">认证，我们必须根据我们的需求</strong>设置<strong class="ki iu">授权头。</strong></p><p id="2038" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一步是创建我们的步骤。(哈哈)</p><h1 id="6d80" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">创建已验证的NBomber请求步骤</h1><pre class="mx my mz na gt nr nq ns bn nt nu bi"><span id="6d40" class="nv lg it nq b be nw nx l ny nz">var load_user_by_email = Step.Create("load_user_by_email",<br/>                       clientFactory: httpFactory,<br/>                       execute: async context =&gt;<br/>                       {<br/>                           var response = await context.Client.GetAsync(<br/>                               baseUrl + "users/bySignedInUser");</span></pre><pre class="oa nr nq ob oc aw od bi"><span id="4f62" class="nb lg it nq b gy oe of l og nz">                           return response.IsSuccessStatusCode<br/>                               ? Response.Ok()<br/>                               : Response.Fail();<br/>                       });<br/>            var loadUserCompanies = Step.Create("load_User_companies",<br/>                       clientFactory: httpFactory,<br/>                       execute: async context =&gt;<br/>                       {<br/>                           var response = await context.Client.GetAsync(<br/>                               baseUrl + "companies/bySignedInUser");</span><span id="7e78" class="nb lg it nq b gy oh of l og nz">                           return response.IsSuccessStatusCode<br/>                               ? Response.Ok()<br/>                               : Response.Fail();<br/>                       });<br/>            var loadCpmpanyProjects = Step.Create("load_company_projects",<br/>           clientFactory: httpFactory,<br/>           execute: async context =&gt;<br/>           {<br/>               var response = await context.Client.GetAsync(<br/>                   baseUrl + "projects/company");</span><span id="d1df" class="nb lg it nq b gy oh of l og nz">               return response.IsSuccessStatusCode<br/>                   ? Response.Ok()<br/>                   : Response.Fail();<br/>           });</span></pre><p id="75e3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们设置我们的场景</p><h1 id="f489" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">为卸载测试设置Nbomber方案</h1><pre class="mx my mz na gt nr nq ns bn nt nu bi"><span id="6c15" class="nv lg it nq b be nw nx l ny nz">var scenario = ScenarioBuilder.CreateScenario("index_requests",<br/>                load_user_by_email, loadUserCompanies, loadCpmpanyProjects)<br/>                .WithLoadSimulations(new[]<br/>                {<br/>                    // from the nBomber docs:<br/>                    // It's to model an open system.<br/>                    // Injects a random number of scenario copies (threads) per 1 sec <br/>                    // defined in scenarios per second during a given duration.<br/>                    // Every single scenario copy will run only once.<br/>                    // Use it when you want to maintain a random rate of requests<br/>                    // without being affected by the performance of the system under test.<br/>                    Simulation.InjectPerSecRandom(minRate: 5, maxRate: 10, during: TimeSpan.FromMinutes(1))<br/>                });</span></pre><p id="d6f7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后但并非最不重要的是，我们将登记NBomber亚军</p><h1 id="1952" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">注册NBomber Runner</h1><pre class="mx my mz na gt nr nq ns bn nt nu bi"><span id="500e" class="nv lg it nq b be nw nx l ny nz">NBomberRunner<br/>                .RegisterScenarios(scenario)<br/>                .Run();</span></pre><p id="87c4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后不要忘记将您的测试添加到Program.cs中来执行它。</p><pre class="mx my mz na gt nr nq ns bn nt nu bi"><span id="74a1" class="nv lg it nq b be nw nx l ny nz">class Program<br/>    {<br/>        static void Main(string[] args)<br/>        {<br/>            indexLoadTests.Run();<br/>        }<br/>    }</span></pre><h1 id="c78d" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">评估NBomber结果</h1><p id="07e3" class="pw-post-body-paragraph kg kh it ki b kj md kl km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld im bi translated">执行测试后，您将立即在命令行中看到您的结果，如上所示。</p><p id="b42c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但这还不是全部！您还将看到您的测试结果作为一个美丽的HTML页面，md报告，或文本文件，准备与您的同事分享。</p><p id="fbfe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">位于下方</p><pre class="mx my mz na gt nr nq ns bn nt nu bi"><span id="161d" class="nv lg it nq b be nw nx l ny nz">\bin\Release\net6.0\reports</span></pre><p id="18e7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">查看HTML页面，你会发现评估结果。</p><p id="40ac" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为第一次行刑，我制作了</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oj"><img src="../Images/c71756c0cbb64f5bb68aab93c1df8bc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*miYi_LQODFGduzKF.png"/></div></div></figure><p id="5fe8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以查看失败和成功请求的统计数据。</p><p id="bc0c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当成功的请求再次运行该测试时，您将看到如下内容:</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ok"><img src="../Images/958bf51a9d8f4d95ca3d4b1f0fda71f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_Te11qqCR22uds4N.png"/></div></div></figure><p id="e9d3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面的图表以漂亮的图表显示了命令行表中的延迟统计信息。我们还可以看到失败和成功测试的饼状图。但这还不是全部。在菜单的左侧，您还可以浏览您的运行场景，并更详细地查看每个场景。</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/4d0dd4d7df8d3937f7476701b1b1e93f.png" data-original-src="https://miro.medium.com/v2/resize:fit:378/format:webp/0*dq0aQk-5diGRMO9S.png"/></div></figure><p id="810a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们目前只构建了一个场景。</p><p id="d1a8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这个页面中，您可以再次看到一个表格，其中包含了这个场景中每个步骤的信息。但这里更有趣的是下面的图表。</p><p id="2570" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于每个场景，NBomber在测试中设置相关的负载模拟、RPS和时间。</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi om"><img src="../Images/28b48baf54c2c133756db7f2a85ee40b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AZlB0TuEi9NUVu_H.png"/></div></div></figure><p id="7982" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">底部还有一个显示延迟和数据传输行为的图表。</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi on"><img src="../Images/06ceb45d91e434c1faf520ac5333d872.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PIPQlwaoJMCrJ-yi.png"/></div></div></figure><p id="dae7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如您在我们的测试系统中所看到的，对于那些小负载，延迟只增加了一点点。</p><p id="3fc2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当客户端数量增加时，这将非常有趣，您可以看到大量请求的延迟差异。</p><p id="7c08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在提示部分，您可以找到对负载测试有用的提示。就像我们应该跟踪我们的响应状态代码，以确定是否只是一个认证问题或500等。</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oo"><img src="../Images/1f574f2866b1d81ac1820b9f1dacb81c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p1os7BnEoj26TyJr.png"/></div></div></figure><h1 id="74e2" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="571b" class="pw-post-body-paragraph kg kh it ki b kj md kl km kn me kp kq kr mf kt ku kv mg kx ky kz mh lb lc ld im bi translated">我知道这些图表很好看，但是我们还能从负载测试中得到什么呢？</p><p id="f876" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以确定哪里有缓慢的请求，哪里有可能导致API崩溃的真正问题！</p><p id="1aae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成负载测试后，接下来的步骤将是访问您的服务器统计信息页面以及您的应用程序监控工具(如Dynatrace ),以查看您的应用程序中哪里存在瓶颈。</p><p id="3c0c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，您可以深入那些糟糕的请求，并使用您的工具来找到它们的根本原因。也许是一个缓慢的查询，一些低效的算法，巨大的映射，或者阻塞的查询。</p><p id="2421" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">找到这些问题肯定会影响本文的范围，但是很快就会有关于Azure中应用程序分析的文章！我还计划回顾sentry、Dynatrace和Datadog，并使用mini Profiler分析性能问题，敬请关注！</p><p id="f049" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当你发现这些问题时，你就可以有信心进行大量的测试来重现这些问题，并让它们消失。</p><p id="eb7d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">即使图书馆的名字在那个时代听起来有点傻，我希望你能从这篇文章中获得一些新的知识。如果你想支持我和我正在做的工作，你可以给我买杯咖啡。我会把一半捐给乌克兰。</p><p id="aeab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">快乐负载测试，</p><p id="c928" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">亚历克斯</p></div><div class="ab cl op oq hx or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="im in io ip iq"><p id="dd29" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">标有*的链接是附属链接。</p></div></div>    
</body>
</html>