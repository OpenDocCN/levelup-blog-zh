<html>
<head>
<title>IKS Deployment Patterns #1: Single-Zone Cluster, App exposed via LoadBalancer (NLB) and ALB (Ingress Controller)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">IKS部署模式#1:单区域集群，通过负载平衡器(NLB)和ALB(入口控制器)公开应用</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/iks-deployment-patterns-1-single-zone-cluster-app-exposed-via-loadbalancer-nlb-and-alb-6370560307e4?source=collection_archive---------2-----------------------#2018-10-16">https://levelup.gitconnected.com/iks-deployment-patterns-1-single-zone-cluster-app-exposed-via-loadbalancer-nlb-and-alb-6370560307e4?source=collection_archive---------2-----------------------#2018-10-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5342" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最简单的开始方式是什么？<br/>我如何通过LoadBalancer服务直接在我的IBM Cloud Kubernetes服务(IKS)中部署和公开我的应用程序？<br/>如何保存连接的客户端的源IP地址？</p><h1 id="221a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">负载平衡器与ALB /入口控制器</h1><p id="572f" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我应该在什么时候使用哪一个？<br/><code class="fe lo lp lq lr b">LoadBalancer</code>通常是第4层(OSI层)负载均衡器，通过使用NLB(网络负载均衡器)来实现。对于Kubernetes集群，这通常意味着TCP和UDP(在某些情况下是SCTP)。<code class="fe lo lp lq lr b">LoadBalancer</code>服务对更高层(如应用层)中的任何事物都没有概念，例如，它不理解HTTP，这是第7层协议。</p><p id="1990" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ALB / Ingress控制器本质上是反向代理，通常在应用程序使用代理理解的协议时使用，并且可以提供额外的特性、功能和价值。通常，微服务是通过HTTP连接的(甚至是相互对话)。如果是这种情况，第7层代理可以根据HTTP头、GET、POST参数、cookies等进行智能决策。是一个很好的工具，用于请求路由、应用程序级负载平衡，将更高的协议级(L7)信息合并到路由决策中。ALBs / Ingress控制器通常作为Kube pods中的用户空间守护程序运行。</p><p id="b8b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果ALB不知道协议，比如MQTT、RTMP、MySQL、PostgreSQL等二进制协议。类似代理的负载均衡器(如ALB)并没有比第四层负载均衡器(如<code class="fe lo lp lq lr b">LoadBalancer</code>服务)有更多的好处。因此，如果您的ALB将<strong class="jp ir">而不是</strong>处理HTTP请求(如果它没有终止HTTPS的TLS连接)，我们建议您使用IKS <code class="fe lo lp lq lr b">LoadBalancer</code>服务，该服务在数据包处理、转发方面更高效、更快，能够保留连接客户端的源IP地址，并横向扩展到多个工作节点。</p><h1 id="9cce" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">示例部署模式</h1><p id="4417" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在本文中，我们将通过下面的部署模式来完成部署示例应用程序的步骤:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ls"><img src="../Images/8f50b3405055bd4687438c79457453fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yrc2jmYATT1lZNUa5vqJUg.png"/></div></div></figure><h1 id="7699" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">通过负载平衡器直接公开应用的步骤</h1><ol class=""><li id="6e39" class="me mf iq jp b jq lj ju lk jy mg kc mh kg mi kk mj mk ml mm bi translated"><a class="ae mn" href="https://console.bluemix.net/registration/premium?" rel="noopener ugc nofollow" target="_blank">注册</a>并使用<a class="ae mn" href="https://console.bluemix.net/" rel="noopener ugc nofollow" target="_blank"> IBM云控制台</a>创建一个<strong class="jp ir">单区域</strong> IKS集群。关于<a class="ae mn" href="https://console.bluemix.net/docs/containers/cs_clusters.html#clusters" rel="noopener ugc nofollow" target="_blank">部署集群</a>以及<a class="ae mn" href="https://console.bluemix.net/docs/containers/cs_clusters_planning.html#single_zone" rel="noopener ugc nofollow" target="_blank">单区域集群如何工作</a>的文档。重要提示:你必须使用付费层。</li><li id="0791" class="me mf iq jp b jq mp ju mq jy mr kc ms kg mt kk mj mk ml mm bi translated">下载并应用下面的<a class="ae mn" href="https://github.com/IBM-Cloud/kube-samples/blob/master/loadbalancer-alb/iks_single-zone_cluster_app_via_LoadBalancer.yaml" rel="noopener ugc nofollow" target="_blank">示例部署和服务资源yaml </a>，它将通过端口<code class="fe lo lp lq lr b">1884</code>上的<code class="fe lo lp lq lr b">LoadBalancer</code>服务公开<code class="fe lo lp lq lr b">echoserver</code>应用。<br/>也可以直接敷:<br/>T3】</li><li id="0e69" class="me mf iq jp b jq mp ju mq jy mr kc ms kg mt kk mj mk ml mm bi translated">检查<code class="fe lo lp lq lr b">LoadBalancer</code>服务的IP地址:</li></ol><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mu"><img src="../Images/8e204204906fa0bd5bc366a60ca76c03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gRsFuihcilvNbjHowR39qQ.png"/></div></div></figure><h2 id="cae4" class="mv km iq bd kn mw mx dn kr my mz dp kv jy na nb kz kc nc nd ld kg ne nf lh ng bi translated">测试应用程序</h2><ol class=""><li id="b60a" class="me mf iq jp b jq lj ju lk jy mg kc mh kg mi kk mj mk ml mm bi translated">测试加载您在浏览器中指定的IP:port或启动<code class="fe lo lp lq lr b">curl</code>命令(像我的例子):<br/> <code class="fe lo lp lq lr b">$ curl <a class="ae mn" href="https://echoserver.arpad-ipvs-test-aug14.us-south.containers.appdomain.cloud/" rel="noopener ugc nofollow" target="_blank">http://{your IP here}:1884/</a></code></li><li id="4382" class="me mf iq jp b jq mp ju mq jy mr kc ms kg mt kk mj mk ml mm bi translated">您将看到如下所示的响应</li></ol><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nh"><img src="../Images/cd98aa44c084add717e195ca4ccf464d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jin-qcVtmskmNY2_Dy-uRg.png"/></div></div></figure><p id="2857" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在<code class="fe lo lp lq lr b">client_address</code>字段中看到源IP地址，因为我们在<code class="fe lo lp lq lr b">LoadBalancer</code>服务资源中应用了<code class="fe lo lp lq lr b">externalTrafficPolicy: Local</code>。</p><h1 id="2049" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">通过ALB / Ingress控制器公开App的步骤</h1><ol class=""><li id="009e" class="me mf iq jp b jq lj ju lk jy mg kc mh kg mi kk mj mk ml mm bi translated"><a class="ae mn" href="https://console.bluemix.net/registration/premium?" rel="noopener ugc nofollow" target="_blank">注册</a>并使用<a class="ae mn" href="https://console.bluemix.net/" rel="noopener ugc nofollow" target="_blank"> IBM云控制台</a>创建一个<strong class="jp ir">单区域</strong> IKS集群。关于<a class="ae mn" href="https://console.bluemix.net/docs/containers/cs_clusters.html#clusters" rel="noopener ugc nofollow" target="_blank">部署集群</a>的文档，特别是<a class="ae mn" href="https://console.bluemix.net/docs/containers/cs_clusters_planning.html#single_zone" rel="noopener ugc nofollow" target="_blank">单区域集群如何工作</a>。<em class="mo">重要提示:你必须使用付费等级才能使用ALBs。</em></li><li id="0325" class="me mf iq jp b jq mp ju mq jy mr kc ms kg mt kk mj mk ml mm bi translated">检查是否一切正常，白蛋白是否正常。<a class="ae mn" href="https://medium.com/@ArpadKun/ibm-cloud-kubernetes-service-ingress-alb-cheat-sheet-1-basics-4fbc1c86b886" rel="noopener"> IKS入口/ALB备忘单</a>上的有用命令。</li><li id="9e61" class="me mf iq jp b jq mp ju mq jy mr kc ms kg mt kk mj mk ml mm bi translated">下载、编辑并应用以下<a class="ae mn" href="https://github.com/IBM-Cloud/kube-samples/blob/master/loadbalancer-alb/iks_single_or_multi-zone_cluster_app_via_ALB.yaml" rel="noopener ugc nofollow" target="_blank">示例部署和入口资源yaml </a>，这将通过端口<code class="fe lo lp lq lr b">80(http)</code>和<code class="fe lo lp lq lr b">443(https).</code> <br/> <code class="fe lo lp lq lr b">$ kubectl apply -f <a class="ae mn" href="https://raw.githubusercontent.com/IBM-Cloud/kube-samples/master/loadbalancer-alb/iks_single_or_multi-zone_cluster_app_via_ALB.yaml" rel="noopener ugc nofollow" target="_blank">iks_single_or_multi-zone_cluster_app_via_ALB.yaml</a></code>上的ALB / Ingress控制器公开<code class="fe lo lp lq lr b">echoserver</code>应用程序注意:不要忘记编辑<code class="fe lo lp lq lr b">Host</code>和<code class="fe lo lp lq lr b">secretName</code>部分。</li><li id="087b" class="me mf iq jp b jq mp ju mq jy mr kc ms kg mt kk mj mk ml mm bi translated">测试加载您在浏览器中指定的主机或启动<code class="fe lo lp lq lr b">curl</code>命令(像我的例子):<br/> <code class="fe lo lp lq lr b">$ curl <a class="ae mn" href="https://echoserver.arpad-ipvs-test-aug14.us-south.containers.appdomain.cloud/" rel="noopener ugc nofollow" target="_blank">https://echoserver.arpad-ipvs-test-aug14.us-south.containers.appdomain.cloud/</a></code></li><li id="c9a3" class="me mf iq jp b jq mp ju mq jy mr kc ms kg mt kk mj mk ml mm bi translated">您将看到如下所示的响应</li></ol><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ni"><img src="../Images/794bcffb3f43d084bbe99f9e301d08df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LgX_5YRbCZofDDOWgMLg3g.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">对通过IKS ALB传送的成功卷曲的响应</figcaption></figure><p id="dd13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，在<code class="fe lo lp lq lr b">x-forwarded-for</code>和<code class="fe lo lp lq lr b"> x-real-ip</code>头中，您可以看到worker节点的IP地址。发生这种情况是因为<code class="fe lo lp lq lr b">kube-proxy</code>正在Kubernetes集群内进行源NAT，并屏蔽了客户端的原始源IP。</p><p id="3d2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想启用源IP保护，你必须<code class="fe lo lp lq lr b">patch</code>IKS ALB(你可以在这里找到<a class="ae mn" href="https://console.bluemix.net/docs/containers/cs_ingress.html#preserve_source_ip" rel="noopener ugc nofollow" target="_blank">关于这一步的进一步文档)。要为群集中的所有公共ALB设置源IP保留，请运行以下命令:</a></p><p id="361f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lo lp lq lr b">$ kubectl get svc -n kube-system |grep alb | awk '{print $1}' |grep "^public" |while read alb; do kubectl patch svc $alb -n kube-system -p '{"spec": {"externalTrafficPolicy":"Local"}}'; done</code></p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nn"><img src="../Images/be89e609cebcdfe32c8afa077a0923e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_jmj89UB3TuFpaYFZHQ4TQ.png"/></div></div></figure><p id="cc1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用补丁后，您将看到客户端的原始源IP地址显示在<code class="fe lo lp lq lr b">x-forwarded-for</code>和<code class="fe lo lp lq lr b">x-real-ip</code>标题中:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi no"><img src="../Images/19628235587fcb11d67f5612bf1abb74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vVc1UM0OL_Z92HZqGsyepg.png"/></div></div></figure><h1 id="1358" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">摘要</h1><p id="34e9" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">随着您对工作负载的了解越来越多，您可以根据需要调整甚至切换模式。不同的应用需要不同的模式；请让我们帮助你的模式！要阅读其他模式，请点击链接到IBM云博客或Medium.com<a class="ae mn" href="https://medium.com/@ArpadKun/ibm-cloud-kubernetes-service-deployment-patterns-for-maximizing-throughput-and-availability-88a23a99437f" rel="noopener">上的链接</a>。</p><h1 id="250d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">联系我们</h1><p id="76d1" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">如果您有任何问题，请在这里注册<a class="ae mn" href="https://bxcs-slack-invite.mybluemix.net/" rel="noopener ugc nofollow" target="_blank">，通过Slack加入我们的团队，并在我们的公共IBM Cloud Kubernetes服务Slack上的#general channel </a>中加入讨论。</p></div></div>    
</body>
</html>