<html>
<head>
<title>Changing Async/Await to Promises.allSettled() to Speed Up API Calls in Node.JS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Async/Await更改为Promises.allSettled()以加速节点中的API调用。射流研究…</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/changing-async-await-to-promises-all-to-speed-up-api-calls-in-node-js-348ea70592fd?source=collection_archive---------0-----------------------#2022-03-30">https://levelup.gitconnected.com/changing-async-await-to-promises-all-to-speed-up-api-calls-in-node-js-348ea70592fd?source=collection_archive---------0-----------------------#2022-03-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4b47" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">问题是</h2></div><p id="ec94" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有一个批量编辑功能，用户可以多选一些记录，同时编辑所有记录。</p><p id="c793" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，当一次更新50+条记录时，可能需要50秒，页面会冻结。用户在等待过程中会感到困惑，经常会提前离开页面。我们想让它更快。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="lg lh l"/></div></figure></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><h2 id="ffd5" class="lp lq iq bd lr ls lt dn lu lv lw dp lx ko ly lz ma ks mb mc md kw me mf mg mh bi translated">为什么这么慢</h2><p id="a8d3" class="pw-post-body-paragraph kf kg iq kh b ki mi jr kk kl mj ju kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">代码是这样写的:</p><pre class="lb lc ld le gt mn mo mp mq aw mr bi"><span id="1d38" class="lp lq iq mo b gy ms mt l mu mv">for (r in records) {<br/>  await update(r);<br/>}</span></pre><p id="7b9e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">更新一条记录会产生一个API调用，耗时500毫秒到1秒。</p><p id="6d8b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为它遍历记录并逐个更新它们，所以随着有更多的记录需要更新，时间会线性增加。</p></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><h2 id="ba05" class="lp lq iq bd lr ls lt dn lu lv lw dp lx ko ly lz ma ks mb mc md kw me mf mg mh bi translated">用承诺来加速</h2><p id="353e" class="pw-post-body-paragraph kf kg iq kh b ki mi jr kk kl mj ju kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">幸运的是，在处理下一个更新之前，我们不必等待一个更新完成。允许我们在上一个更新请求完成之前发出下一个更新请求。</p><p id="e777" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们所做的:</p><pre class="lb lc ld le gt mn mo mp mq aw mr bi"><span id="736e" class="lp lq iq mo b gy ms mt l mu mv">const allPromises = [];</span><span id="49aa" class="lp lq iq mo b gy na mt l mu mv">for (r in records) {<br/>  const promise = update(r);<br/>  allPromises.push(promise);<br/>};</span><span id="9b85" class="lp lq iq mo b gy na mt l mu mv">await Promise.allSettled(allPromises);</span></pre><p id="7b5c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">视觉上，这是使用<code class="fe mw mx my mo b">async/await</code> v.s .使用<code class="fe mw mx my mo b">promises</code>时发生的情况:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nb"><img src="../Images/e5f4009a3e1d605c312a86924465b094.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EpibSqi7zKJ4AUh2N_yg1g.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">异步/等待v.s .承诺</figcaption></figure><p id="9224" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如我们所看到的，由于我们在发出下一个更新请求之前没有等待每个更新请求的返回，因此节省了大量时间。</p></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><h2 id="84f1" class="lp lq iq bd lr ls lt dn lu lv lw dp lx ko ly lz ma ks mb mc md kw me mf mg mh bi translated">得到承诺的结果</h2><p id="4a0d" class="pw-post-body-paragraph kf kg iq kh b ki mi jr kk kl mj ju kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">可惜<code class="fe mw mx my mo b">update(r)</code>偶尔会出现故障。</p><p id="be2b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果有些更新失败了，我想知道是哪些更新。</p><p id="61ba" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mw mx my mo b"><a class="ae mz" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled" rel="noopener ugc nofollow" target="_blank">Promise.allSettled()</a></code>的解析值可以告诉我们这一点。<code class="fe mw mx my mo b"><a class="ae mz" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled" rel="noopener ugc nofollow" target="_blank">Promise.allSettled()</a></code>给我一个对象数组，每个对象描述一个承诺的结果。</p><p id="70ce" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一个承诺实现了，我就得到<code class="fe mw mx my mo b">{status: “fulfilled”, value: xxx }</code>。</p><p id="c743" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一个承诺被拒绝，我会得到<code class="fe mw mx my mo b">{status: “rejected”, reason: xxx }</code>。</p><p id="2653" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">举个例子，</p><pre class="lb lc ld le gt mn mo mp mq aw mr bi"><span id="c499" class="lp lq iq mo b gy ms mt l mu mv">const values = await Promise.allSettled([<br/>  Promise.resolve(33),<br/>  Promise.reject(new Error('an error'))<br/>])<br/>console.log(values)</span><span id="ec5c" class="lp lq iq mo b gy na mt l mu mv">// [<br/>//   {status: "fulfilled", value: 33},<br/>//   {status: "rejected",  reason: Error: an error}<br/>// ]</span></pre><p id="c43c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我的例子中，我想知道成功更新和没有更新的记录的<code class="fe mw mx my mo b">id</code>。这就是我们所做的:</p><pre class="lb lc ld le gt mn mo mp mq aw mr bi"><span id="639f" class="lp lq iq mo b gy ms mt l mu mv">const allPromises = [];<br/>for (r in records) {<br/>    const promise = new Promise((res, rej) =&gt; {<br/>        update(t)<br/>            .then(() =&gt; { res(r.id) }); # succeeded<br/>            .catch(() =&gt; { rej(r.id) }); # failed<br/>    });<br/>    allPromises.push(promise);<br/>};</span><span id="9003" class="lp lq iq mo b gy na mt l mu mv">const outcomes = await Promise.allSettled(allPromises);</span><span id="8108" class="lp lq iq mo b gy na mt l mu mv">const succeeded = outcomes.filter(o =&gt; o.status === "fulfilled");<br/>const succeededIds = succeeded.map(s =&gt; s.value);</span><span id="902f" class="lp lq iq mo b gy na mt l mu mv">const failed = outcomes.filter(o =&gt; o.status === "rejected");<br/>const failedIds = failed.map(f =&gt; f.reason);</span></pre><p id="da40" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从视觉上看，这就是一些承诺失败时的情况:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nm"><img src="../Images/a036c97767bffab65e296c193dd96d33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*deL8BJq5cyyMoML8byPu8Q.png"/></div></div></figure><p id="4936" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">返回的数组告诉我们哪些成功了，哪些失败了。</p><p id="9ff0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！通过这一更改，我们能够将50多条记录的批量编辑操作从50多秒减少到不到5秒。💪</p></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><h2 id="a5bc" class="lp lq iq bd lr ls lt dn lu lv lw dp lx ko ly lz ma ks mb mc md kw me mf mg mh bi translated">感谢阅读！</h2><p id="9e78" class="pw-post-body-paragraph kf kg iq kh b ki mi jr kk kl mj ju kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">注意，这篇文章被更新为使用<code class="fe mw mx my mo b"><a class="ae mz" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled" rel="noopener ugc nofollow" target="_blank">Promise.allSettled()</a></code>。</p><p id="1368" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">之前的版本用的是<code class="fe mw mx my mo b"><a class="ae mz" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all" rel="noopener ugc nofollow" target="_blank">Promise.all()</a></code>。<code class="fe mw mx my mo b"><a class="ae mz" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all" rel="noopener ugc nofollow" target="_blank">Promise.all()</a></code>仅当所有承诺都解决时才解决，否则拒绝。</p><p id="c8f4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为我们想知道每个承诺的结果，一些读者建议<code class="fe mw mx my mo b"><a class="ae mz" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled" rel="noopener ugc nofollow" target="_blank">Promise.allSettled()</a></code>更适合这个任务。文章已相应更新。</p><p id="51e4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">非常感谢那些提出建议的人，我真的很感激。🙏</p><p id="cb98" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我希望这是明确的和有帮助的。如果您有任何问题，请不要犹豫留下评论。</p><p id="5262" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢您的宝贵时间！</p></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><h1 id="b652" class="nn lq iq bd lr no np nq lu nr ns nt lx jw nu jx ma jz nv ka md kc nw kd mg nx bi translated">分级编码</h1><p id="bcaf" class="pw-post-body-paragraph kf kg iq kh b ki mi jr kk kl mj ju kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">感谢您成为我们社区的一员！升级正在改变技术招聘。<a class="ae mz" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir">在最好的公司</strong>找到你的完美工作 </a> <strong class="kh ir">。</strong></p><div class="ny nz gp gr oa ob"><a href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener  ugc nofollow" target="_blank"><div class="oc ab fo"><div class="od ab oe cl cj of"><h2 class="bd ir gy z fp og fr fs oh fu fw ip bi translated">升级—转变技术招聘</h2><div class="oi l"><h3 class="bd b gy z fp og fr fs oh fu fw dk translated">升级—转变技术招聘🔥使软件工程师能够找到完美的角色…</h3></div><div class="oj l"><p class="bd b dl z fp og fr fs oh fu fw dk translated">作业. levelup.dev</p></div></div><div class="ok l"><div class="ol l om on oo ok op ng ob"/></div></div></a></div></div></div>    
</body>
</html>