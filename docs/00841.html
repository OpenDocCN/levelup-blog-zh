<html>
<head>
<title>Integrating with the iOS Keychain, Simplified</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与iOS钥匙串集成，简化</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/integrating-with-the-ios-keychain-simplified-b75c566f1d49?source=collection_archive---------0-----------------------#2019-08-20">https://levelup.gitconnected.com/integrating-with-the-ios-keychain-simplified-b75c566f1d49?source=collection_archive---------0-----------------------#2019-08-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/1eb3fe4a7addae9ff0a108e06dd9981b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*s1VhcWtEySFVMKuOyk39Hg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">标准iCloud钥匙串服务器(加利福尼亚州苹果公园，2019年)</figcaption></figure><h1 id="2fe1" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">介绍</h1><p id="0252" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">如果说UserDefaults是微波炉，那么Keychain就是烤肉。在我第一次用Keychain开发时，我期望它是一个非常基本的键值存储，可能像UserDefaults一样，但在安全性方面有所尝试。虽然这或多或少是事实，但如果你不熟悉这些明显的差异，就会让你生气、困惑，吃未煮熟的食物。</p><p id="95a5" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">最重要的是，在网上找到实用的帮助并不容易。因此，就像我的大多数其他文章是如何构思的一样，我想我应该整理出一个使用Keychain的小指南。</p><p id="9b45" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这篇文章不会太深入，因为——当我知道我到底在做什么时，我开始意识到——<a class="ae lz" href="https://developer.apple.com/documentation/security/keychain_services" rel="noopener ugc nofollow" target="_blank">文档</a>实际上非常好。所以请注意--我将不再讨论访问组和底层的东西。</p><p id="983d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">本文<em class="ma">将</em>做的是让你熟悉Keychain独特的API，给你一些使用它的实用建议，并希望引导你得出启发性的结论，即Keychain毕竟只是一个键值存储。</p><h1 id="3edb" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">什么是钥匙扣？</h1><p id="3e0f" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Keychain是Apple的一项服务，它将密码、证书和密钥等用户机密储存在安全的数据库中。从开发人员的角度来看，它类似于UserDefaults，因为它允许您存储(和持久化)特定于给定用户的少量数据。然而，虽然用户默认值可以很容易地访问和读取，但钥匙串项目是受保护的。</p><h1 id="8e63" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">如何使用钥匙串</h1><p id="ea1b" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Keychain和常规的旧键值存储之间的最大区别在于，键值存储有密钥，而Keychain有查询。有时，一个查询与钥匙链和boom中的一个项目完全匹配，相同但不同，你就有了一个键值存储。其他时候，这些查询可能会返回一大堆东西。</p><p id="6867" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">换句话说，查询就是查询。</p><p id="ebc3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">但是有一个问题:这些查询不仅用于<em class="ma">查询钥匙链中的</em>项，还用于<em class="ma">插入</em>它们。</p><p id="0308" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">例如，让我们来看看这个用于将项目添加到Keychain的查询:</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="5a7a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这是一个相当简单的查询。以下是对每个属性作用的简要说明:</p><ul class=""><li id="b19b" class="mh mi iq ky b kz lu ld lv lh mj ll mk lp ml lt mm mn mo mp bi translated"><strong class="ky ir"> <em class="ma"> kSecClass: </em> </strong>我们要插入钥匙圈的项目类型；在这种情况下，是一个通用密码。</li><li id="6ffe" class="mh mi iq ky b kz mq ld mr lh ms ll mt lp mu lt mm mn mo mp bi translated"><strong class="ky ir"><em class="ma">kSecAttrSynchronizable:</em></strong>该属性表示项目是否应该与iCloud同步。</li><li id="924d" class="mh mi iq ky b kz mq ld mr lh ms ll mt lp mu lt mm mn mo mp bi translated"><strong class="ky ir"><em class="ma">kSecAttrAccount:</em></strong>该密码的帐户名。如果您想创建一个准键值存储，使用这个属性作为键，使用<em class="ma"> kSecValueData </em>字段作为值将是一种可行的方法。</li><li id="37a6" class="mh mi iq ky b kz mq ld mr lh ms ll mt lp mu lt mm mn mo mp bi translated"><strong class="ky ir"> <em class="ma"> kSecValueData: </em> </strong>最后，我们要插入到keychain中的数据。</li></ul><p id="c5a9" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">仅此而已；我们的数据现在在Keychain中。</p><p id="e870" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">从这里开始，我们可以稍微修改一下这个查询，实现一个fetch而不是insert，然后用它来检索我们的数据。在下面的代码中，我删除了<em class="ma"> kSecValueData </em>字段(仅用于将数据插入到keychain中)并添加了<em class="ma"> kSecReturnData </em>字段，这表明我希望查询返回数据。</p><p id="d9a2" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">然后，我们可以使用查询来检索我们刚才存储的数据，如下所示:</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="1d34" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">瞧，我们存储的钥匙链项目已被检索到。</p><p id="5255" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">但是当我们将<em class="ma"> kSecAttrSynchronizable </em>属性更改为<em class="ma"> false </em>时会发生什么呢？</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="ff49" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">不幸的是，我不能很容易地以交互方式演示这一点，所以我只能告诉你:我们什么也得不到。好吧，我们确实得到了OSStatus -25300(表示没有找到数据)，但这确实是题外话。这是因为这个项目是在将<em class="ma"> kSecAttrSynchronizable </em>属性设置为<em class="ma"> true </em>的情况下插入到Keychain中的，因此这个将<em class="ma"> kSecAttrSynchronizable </em>设置为<em class="ma"> false </em>的新查询不再与之匹配。所以要确保你所有的查询都是完全正确的，因为像这样的小细节会导致很多痛苦。</p><p id="f4cc" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这就是Keychain的工作方式:您使用查询来插入项目——我们称之为“插入查询”——要取回这些项目，您必须使用与这些“插入查询”的所有属性相匹配的查询</p><h1 id="cd63" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">模仿键值存储</h1><p id="fb8d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Keychain的一个常见用例是模拟键值存储。我简单提到的解决方案是使用<em class="ma">kSecClassGenericPassword</em>字段作为“键”，使用<em class="ma"> kSecValueData </em>字段作为“值”</p><p id="8f62" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">然而，不要急于围绕Keychain创建一个简单的键值抽象并使用它，因为这样做会失去Keychain提供的许多很酷的功能。</p><p id="357b" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">例如，<a class="ae lz" href="https://developer.apple.com/documentation/security/ksecclassinternetpassword" rel="noopener ugc nofollow" target="_blank"><em class="ma">kSecClassInternetPassword</em></a><em class="ma"/>类，连同其相关属性如<a class="ae lz" href="https://developer.apple.com/documentation/security/ksecattrserver" rel="noopener ugc nofollow" target="_blank"><em class="ma">kSecAttrServer</em></a><em class="ma"/>和<a class="ae lz" href="https://developer.apple.com/documentation/security/ksecattraccount" rel="noopener ugc nofollow" target="_blank"><em class="ma">kSecAttrAccount</em></a><em class="ma">，</em>可以让你的应用程序将钥匙串项目与特定的域和帐户相关联，以便Safari等其他应用程序可以使用它们为你的用户自动填充密码。</p><p id="d098" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">或者考虑一下<a class="ae lz" href="https://developer.apple.com/documentation/security/ksecattraccesscontrol?language=objc" rel="noopener ugc nofollow" target="_blank"><em class="ma">kSecAttrAccessControl</em></a><em class="ma"/>属性，它可以让您对哪些钥匙圈项目需要什么权限进行粒度控制；有些可能需要face ID，有些可能需要解锁设备，等等。</p><p id="ba68" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">你能做的还有很多很多。确保您的实现是灵活的！</p><h1 id="b390" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">避免竞态条件</h1><p id="f5c3" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Keychain有一个由来已久的问题，就是搞不清自己。如果你的程序正在运行钥匙串查询，很有可能你会遇到竞争情况，你的程序会崩溃。</p><p id="84cb" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">鉴于此，为你的应用程序的钥匙链实现编写一个包装器，并使用NSLock(或类似的东西)来确保一切顺利运行是一个好主意。</p><h1 id="c303" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="257f" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">那是钥匙链。很好地理解API和它的独特之处是困难的部分。一旦你记下了这一点，就真的没有更多的了；疯狂去实现一些奇特的功能！</p></div></div>    
</body>
</html>