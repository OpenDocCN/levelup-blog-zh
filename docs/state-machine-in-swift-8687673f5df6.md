# Swift 中的状态机

> 原文：<https://levelup.gitconnected.com/state-machine-in-swift-8687673f5df6>

## 更干净、错误更少且可扩展的代码

![](img/ffd580d997518990e30902e7e80db11f.png)

状态图

在本文中，我将讨论什么是状态机以及如何在 Swift 中使用它。读完这篇文章后，你应该能够像一个状态机一样思考，像一个状态机一样行动，甚至可能看起来像一个状态机😃。

在进入状态机之前，让我们先看看一个相对简单的特性，我们大多数人都曾在某个时候实现过这个特性。功能要求是

*   设置产品 ID 的能力
*   购买套装产品的能力

我们创建了一个产品文本字段和一个购买按钮。当设置了有效的产品 id 时，购买按钮被启用。点击购买按钮购买产品，这可能导致成功或失败。让我们看看那会是什么样子

![](img/d7d0e8f42b44563861f04e9182e2f3f9.png)

让我们用一种直接的方法来实现它，这可能是我们的第一直觉。

我们有两种主要方法

1.  按下购买按钮时的逻辑。我们在购买产品时禁用输入，根据响应，我们决定需要做什么。
2.  我们输入产品 ID 时的逻辑。

这种实现是可行的，对于我们的场景来说可能已经足够好了。然而，功能往往会发生变化，变得更加复杂。例如，我们可能需要在用户购买时添加一个取消选项，或者监听互联网连接事件并对其做出响应。我们的代码会很快变得复杂、不可预测、错误百出。这意味着我们的代码是不可伸缩的和用户友好的。我们如何改进我们的代码？你猜对了，国家机器！

# 状态机

状态机基本上是一种设计模式，通过引入不同的状态来简化我们的逻辑。在任何给定的时间，我们的逻辑可以处于一种状态。不同状态之间的转换作为对状态机接收到的事件的响应而发生。当转换发生时，可以调用处理程序闭包。这种方法要求我们改变思维。我们需要考虑我们的逻辑可能处于什么状态，它们如何转换，以及当转换发生时会发生什么。

实现状态机的第一步是创建状态图。该图向我们展示了不同状态之间的转换以及触发它们的事件。在我们的例子中，我们需要定义购买流程的状态。让我们定义我们的状态

*   无效产品
*   有效产品
*   购买
*   不成功的
*   完成

我们从`invalidProduct`状态开始，然后过渡到由事件触发的其他状态。让我们定义可能发生的不同事件

*   输入的产品(isValid: Bool)
*   点击购买按钮
*   购买(issue access:Bool)

既然我们已经定义了状态和事件，我们需要定义转换是如何发生的。状态图向我们展示了一切是如何联系在一起的，让我们看看它是什么样子的

![](img/ffd580d997518990e30902e7e80db11f.png)

购买状态机

黄色方框是我们定义的不同状态。箭头显示了不同状态之间的有效转换。文本是触发转变的事件。花些时间理解状态机图，并确保在继续之前它是有意义的。在实现状态机时，创建状态图的能力至关重要。

# 编写状态机代码

在定义了状态、事件和转换之后，我们终于可以实现状态机了！在这个例子中，我使用了 [SwiftState](https://github.com/ReactKit/SwiftState) ，但是任何状态机都可以工作。我们使用枚举来定义状态和事件，就像这样

使用我们的状态和事件创建状态机。状态机是一个通用类，意味着状态和事件是在初始化状态机时定义的类型。这使我们能够使用任何自定义状态和事件枚举。初始状态是在初始化器中设置的，在我们的例子中是`invalidProduct`状态。

状态机还接受一个闭包，用于定义转换和处理程序。我们根据状态图定义闭包内的转换，如下所示

开关盒根据当前状态下触发的事件返回下一个状态。我们基本上复制我们的状态图转换。

处理程序是当一个状态转换到下一个状态时调用的闭包。下面的代码创建所有的处理程序

弄清楚每个处理程序应该做什么，实际上是最好的部分。这比我们最初的实现简单得多，因为我们只需要考虑在每个状态下应该发生什么。例如，在`invalidProduct`状态中，我们希望购买按钮被禁用，其标题为“购买”。在`validProduct`状态下，我们希望启用购买按钮，就这么简单。我建议检查一下处理程序，确保它们有意义，因为像状态机一样思考需要改变思维方式。拼图的最后一块是召唤出事件，让我们看看是什么样子的

SwiftState 库声明了发送事件的新语法。用一个事件在状态机上调用`<-!`将它发送到状态机。正如你所看到的，每次点击购买按钮，都会触发`buyButtonTapped`事件。根据我们所处的状态，状态机将决定如何处理事件。这极大地减少了错误，因为如果由于任何原因事件在一个不应该发生的状态下被触发，什么也不会发生！这与我们最初的实现形成对比，在最初的实现中，每次点击购买按钮都会执行一些逻辑操作。

`Pop quiz: where does the actual purchase occur?`

# 结论

我们已经看到了实现我们特性的两种方法。第一种方法是直截了当的，它的优点是快速完成工作。对于小特性来说，这可能已经足够好了，但是对于较大的项目，或者我们知道会随着时间增长的特性，状态机将是更好的选择。

使用状态机使我们能够以更可伸缩的方式轻松地添加更多的特性和功能。在我们的例子中，状态机比第一种方法有更多的代码，因为我们的例子非常简单。在更复杂的特性中，状态机可能比直接的方法代码更少，也更简单。

我希望你喜欢这篇文章！如果是这样，请随意看看我的其他文章

[](https://medium.com/@ronen.harati/why-write-unit-tests-260fb199af84) [## 为什么要编写单元测试

### 作为开发人员，我们努力编写高质量的代码。随着我们获得越来越多的经验，我们会有一种直觉…

medium.com](https://medium.com/@ronen.harati/why-write-unit-tests-260fb199af84) [](https://medium.com/better-programming/how-to-write-decoupled-code-in-swift-515cfd3fd8eb) [## 如何在 Swift 中编写解耦代码

### 松散耦合的代码是可测试的代码

medium.com](https://medium.com/better-programming/how-to-write-decoupled-code-in-swift-515cfd3fd8eb) [](/dependency-injection-container-in-swift-b4d7e139338c) [## Swift 中的依赖注入容器

### 如何松散地耦合您的整个项目

levelup.gitconnected.com](/dependency-injection-container-in-swift-b4d7e139338c) 

# 我的应用

[](https://apps.apple.com/us/app/last-flower/id1112524681?ls=1) [## 最后一朵花

### 你能拯救最后一朵花吗？iPad 上也有-小行星正在撞击地球，所有的…

apps.apple.com](https://apps.apple.com/us/app/last-flower/id1112524681?ls=1) [](https://apps.apple.com/us/app/tile-color-match/id1294483076?ls=1) [## 瓷砖颜色匹配

### 彩色瓷砖匹配是一个令人兴奋的新游戏。目的是通过移动底部的瓷砖来匹配上面的棋盘布局…

apps.apple.com](https://apps.apple.com/us/app/tile-color-match/id1294483076?ls=1) [](https://apps.apple.com/us/app/koala-nap/id1478157024?ls=1) [## 考拉午睡

### 你或你的伴侣打鼾吗？现在你可以从第一天开始积极减少打鼾，使用考拉午睡。除了展示如何…

apps.apple.com](https://apps.apple.com/us/app/koala-nap/id1478157024?ls=1) 

[www.koalanap.com](https://apps.apple.com/us/app/koala-nap-snore-solution/id1478157024?source=responses-----f5f046350fc9----0-----------------respond_sidebar--------------)