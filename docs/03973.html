<html>
<head>
<title>Chromium and Selenium in AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Lambda中的铬和硒</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/chromium-and-selenium-in-aws-lambda-6e7476a03d80?source=collection_archive---------3-----------------------#2020-06-04">https://levelup.gitconnected.com/chromium-and-selenium-in-aws-lambda-6e7476a03d80?source=collection_archive---------3-----------------------#2020-06-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/8e1541d5daf7aa63633ca66caa427ce3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RGxG2GCiR94CVfeW.jpeg"/></div></div></figure><p id="16c3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们看看如何在AWS Lambda函数中使用铬和硒；首先，为那些不熟悉这两个项目的人提供一些信息。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="2632" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> 2020.09更新</strong>:请到<a class="ae lg" href="https://github.com/vittorio-nardone/selenium-chromium-lambda" rel="noopener ugc nofollow" target="_blank">项目库</a>查看该项目的新版本，包括Chromium ver。86.0.4240.0和硒。3.14.</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="86e9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae lg" href="https://www.chromium.org/Home" rel="noopener ugc nofollow" target="_blank"> Chromium </a>是谷歌Chrome衍生的开源浏览器。浏览器共享大部分代码和功能。然而，它们在许可证方面有所不同，Chromium不支持Flash，没有自动更新系统，也不收集使用和崩溃统计数据。我们将会看到，这些差异丝毫不会影响项目的潜力，而且由于Chromium，我们可以在Lambda函数中执行许多有趣的任务。</p><p id="95c4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Selenium是一个众所周知的专门用于测试web应用程序的框架。我们对Selenium WebDriver特别感兴趣，这是一个允许控制当今所有主流浏览器的工具，包括Chrome/Chromium。</p><h1 id="c528" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">为什么在Lambda函数中使用Chrome？</h1><p id="9c21" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">在没有GUI的环境(AWS Lambda)中使用浏览器的目的是什么？实际上有好几个。操作浏览器可以让你自动完成一系列任务。例如，可以通过创建CI管道来自动测试您的web应用程序。或者，同样重要的是，网络抓取。</p><p id="ff0c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae lg" href="https://en.wikipedia.org/wiki/Web_scraping" rel="noopener ugc nofollow" target="_blank">网络搜集</a>是一种允许我们从网站提取数据的技术，它可能的应用是无限的:监控产品价格，检查服务的可用性，通过从多个公开来源获取记录来建立数据库。</p><p id="3fba" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在本帖中，我们将看到如何在Lambda函数Python中使用Chromium和Selenium来呈现URL。</p><h1 id="228f" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">Lambda函数示例</h1><p id="fafc" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">我们将要创建的Lambda函数有一个特定的目的:给定一个URL，Chromium用于呈现相关的web页面，并以PNG格式捕获内容的屏幕截图。我们将保存在S3桶的形象。通过定期运行该功能，我们将能够“历史化”任何站点的变化，例如在线信息报纸的主页。</p><p id="114f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">显然，我们的Lambda有许多改进的可能性:目的是展示这种方法的潜力。</p><p id="658d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们从所需的Python包(requirements.txt)开始。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="c57e" class="mt li it mp b gy mu mv l mw mx">selenium==2.53.0 <br/>chromedriver-binary==2.37.0</span></pre><p id="f38c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在AWS Lambda Python环境中，包通常是不可用的:我们需要创建一个zipfile来分发我们的函数，包括所有的依赖项。</p><p id="e701" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们得到了Chromium，<strong class="kd iu">的无头版本</strong>，它能够在服务器环境中运行。我们需要相关的Selenium驱动程序。以下是我用过的链接。</p><ul class=""><li id="ad11" class="my mz it kd b ke kf ki kj km na kq nb ku nc ky nd ne nf ng bi translated"><a class="ae lg" href="https://github.com/adieuadieu/serverless-chrome/releases/download/v1.0.0-29/stable-headless-chromium-amazonlinux-2017-03.zip" rel="noopener ugc nofollow" target="_blank">无头铬下载链接</a></li><li id="71af" class="my mz it kd b ke nh ki ni km nj kq nk ku nl ky nd ne nf ng bi translated"><a class="ae lg" href="https://chromedriver.storage.googleapis.com/2.32/chromedriver_linux64.zip" rel="noopener ugc nofollow" target="_blank"> Chrome网络驱动下载链接</a></li></ul><h1 id="286f" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">如何使用Selenium Webdriver</h1><figure class="mk ml mm mn gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="7b2d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如何在Python中使用Selenium的一个简单示例:<strong class="kd iu"> get </strong>方法允许我们将浏览器定向到指定的URL，而<strong class="kd iu"> save_screenshot </strong>方法允许我们保存内容的PNG图像。该图像将具有Chromium窗口的大小，使用<strong class="kd iu">窗口大小</strong>参数将其设置为1280×1024像素。</p><p id="dda2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我决定创建一个包装类来呈现页面<strong class="kd iu">的所有高度</strong>。我们需要计算包含所有元素所需的窗口大小。我们使用一个技巧，一个我们将在页面加载后执行的脚本。Webdriver再次公开了一个适合我们的<strong class="kd iu"> execute_script </strong>方法。</p><figure class="mk ml mm mn gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="f2b1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个解决方案不是很优雅，但是很实用:请求的URL必须加载两次。第一次将浏览器窗口设置为固定大小。页面加载后，JS脚本用于确定所需窗口的大小。之后，关闭原来的浏览器窗口，打开一个大小合适的新窗口，获得完整的高度截图。使用的JS脚本取自这个有趣的帖子<a class="ae lg" href="https://stackoverflow.com/questions/1145850/how-to-get-height-of-entire-document-with-javascript" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="c61c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">包装器也是“Lambda就绪的”:它正确地管理临时路径和指定必要的<strong class="kd iu"> chrome_options </strong>的<strong class="kd iu"> headless-chromium </strong>可执行文件的位置。</p><p id="5952" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们看看我们的Lambda函数是什么样的:</p><figure class="mk ml mm mn gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="57f5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该函数的事件处理程序只是负责实例化我们的<strong class="kd iu"> WedDriverScreenshot </strong>对象，并使用它来生成两个屏幕截图:第一个具有固定的窗口大小(1280×1024像素)。对于第二个，省略了<strong class="kd iu">高度</strong>参数，这将由我们的包装器自动确定。</p><p id="b24e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是两张相互比较的图片，与网站相关</p><figure class="mk ml mm mn gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/41b674ec9c391da4d0079ae0bdbe6ba1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dKGru67OaVnkTYFh0FWuDg.png"/></div></div></figure><h1 id="0fe5" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">功能的部署</h1><p id="adcf" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">我在<a class="ae lg" href="https://github.com/vittorio-nardone/selenium-chromium-lambda" rel="noopener ugc nofollow" target="_blank">这个GitHub库</a>中收集了在AWS Cloud上部署项目所需的所有文件。除了之前已经分析过的文件，还有一个用于堆栈部署的CloudFormation模板。最重要的部分显然与<strong class="kd iu">截屏函数</strong>的定义有关:一些环境变量，如PATH和PYTHONPATH，是正确执行函数和Chromium的基础。还需要注意内存需求和超时设置:加载一个页面可能需要几秒钟。<strong class="kd iu"> lib </strong>路径包含了一些执行Chromium所需的库，这些库在Lambda环境中是缺省不存在的。</p><p id="a3c6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">像往常一样，我更喜欢使用Makefile来执行主要操作。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="5fa2" class="mt li it mp b gy mu mv l mw mx">## download chromedriver, headless-chrome to `./bin/` <br/>make fetch-dependencies </span><span id="aa7d" class="mt li it mp b gy np mv l mw mx">## prepares build.zip archive for AWS Lambda deploy <br/>make lambda-build </span><span id="d0a7" class="mt li it mp b gy np mv l mw mx">## create CloudFormation stack with lambda function and role <br/>make BUCKET=your_bucket_name create-stack</span></pre><p id="be1e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">CloudFormation模板需要一个S3桶作为Lambda函数部署的源。随后，同一个存储桶将用于存储PNG截图。</p><h1 id="2045" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">结论</h1><p id="fda3" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">我们用硒和铬来渲染一个网页。这是这两个项目在无服务器领域的一个可能应用。正如所料，另一个非常有趣的应用是web抓取。在这种情况下，Webdriver的<strong class="kd iu"> page_source </strong>属性允许访问页面的源代码，像<a class="ae lg" href="https://www.crummy.com/software%20/%20BeautifulSoup%20/%20bs4%20/%20doc%20/" rel="noopener ugc nofollow" target="_blank"> BeautifulSoup </a>这样的包对于提取我们想要收集的数据非常有用。Python的Selenium包提供了几种自动化其他操作的方法:请查看<a class="ae lg" href="https://selenium-python.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">优秀的文档。</a></p><p id="a832" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">看看<a class="ae lg" href="https://github.com/vittorio-nardone/selenium-chromium-lambda" rel="noopener ugc nofollow" target="_blank">这个帖子的GitHub库</a>。</p><p id="c17d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们玩得开心吗？下次见！</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="b60b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="nq">原载于2020年6月4日</em><a class="ae lg" href="https://www.vittorionardone.it/en/2020/06/04/chromium-and-selenium-in-aws-lambda/" rel="noopener ugc nofollow" target="_blank"><em class="nq">https://www . vittorionardone . it</em></a><em class="nq">。</em></p></div></div>    
</body>
</html>