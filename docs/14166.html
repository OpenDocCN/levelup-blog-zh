<html>
<head>
<title>Nifty Odoo ORM Methods</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">漂亮的奥多姆方法</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/nifty-odoo-orm-methods-324152490697?source=collection_archive---------16-----------------------#2022-11-06">https://levelup.gitconnected.com/nifty-odoo-orm-methods-324152490697?source=collection_archive---------16-----------------------#2022-11-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a36c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">他们肯定会节省你一些击键和时间</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c8cd8da3046b9da6924e1c7ff351a72d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-fjLUWZZaoW2c-_WWEyNCQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来自<a class="ae ky" href="https://www.pexels.com/photo/man-woman-laptop-office-6804595/" rel="noopener ugc nofollow" target="_blank"> Pexels </a>的cottonbro拍摄的照片</figcaption></figure><p id="0f78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Odoo <a class="ae ky" href="https://www.odoo.com/documentation/16.0/developer/reference/backend/orm.html" rel="noopener ugc nofollow" target="_blank">表单</a>是<a class="ae ky" href="https://www.martinfowler.com/eaaCatalog/activeRecord.html" rel="noopener ugc nofollow" target="_blank">活动记录模式</a>的实现。该模式简化了数据访问和持久性，使开发人员能够用有限的SQL专业知识与数据库进行交互。</p><p id="030a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ORM处理数据水合和脱水的复杂工作。简而言之，它将数据库中的数据抽象出来并自动加载到内存对象中，并将对这些对象所做的修改持久化回数据库。</p><p id="c412" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Odoo开发者文档相当广泛地涵盖了<a class="ae ky" href="https://www.odoo.com/documentation/16.0/developer/reference/backend/orm.html" rel="noopener ugc nofollow" target="_blank"> ORM API </a>。它几乎包含了开发人员可以在日常开发中利用的相关API方法。</p><p id="f2df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有一些由ORM API实现的漂亮方法没有被写入ORM <a class="ae ky" href="https://www.odoo.com/documentation/16.0/developer/reference/backend/orm.html" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="f64e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">了解这些方法可以节省您的按键次数和时间，并简化您作为Odoo开发人员的生活。</p><h1 id="8d96" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">1.正在获取基本URL</h1><p id="6083" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">要动态确定Odoo实例的基本URL，您可以手动引用系统参数<code class="fe ms mt mu mv b">web.base_url</code>并像这样检索它的值</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Odoo实例的基本URL的详细确定</figcaption></figure><p id="4c79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种方法非常简单，因为它只有一条语句。</p><p id="0a33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是甚至有一种更简单、更紧密的方法来确定这一点，使用ORM API上可用的可重用方法。</p><h2 id="8399" class="my lw it bd lx mz na dn mb nb nc dp mf li nd ne mh lm nf ng mj lq nh ni ml nj bi translated">使用ORM API中的方法</h2><p id="9890" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">使用ORM API上可用的<code class="fe ms mt mu mv b">get_base_url()</code>方法。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">一个利用Odoo ORM内置方法的简洁版本</figcaption></figure><h1 id="0709" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">2.定义窗口操作</h1><p id="fc59" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在Odoo中，窗口动作充当视图的容器。窗口操作可以包含多个视图，包括树、表单、看板等。</p><p id="bf20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，窗口操作是用XML定义的。并由绑定菜单触发。但是有时一个模块的工作流和需求要求一个窗口动作由一个按钮而不是一个菜单来触发。</p><p id="a873" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，开发人员有两种选择来定义窗口操作。</p><ol class=""><li id="a354" class="nk nl it lb b lc ld lf lg li nm lm nn lq no lu np nq nr ns bi translated">在模型的方法中完全定义窗口操作，然后将方法绑定到XML定义的按钮来触发操作。</li><li id="5880" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">用XML定义窗口操作，并在模型的方法中引用已定义操作的标识符，然后将该方法绑定到XML定义的按钮以触发该操作。</li></ol><p id="8720" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">定义窗口动作的两种方法看起来都是这样的</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">完全在模型中定义的窗口操作。不需要XML定义。</figcaption></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">XML中定义的窗口操作被其在模型中的标识符引用</figcaption></figure><p id="ac2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">很明显，引用XML中已定义动作的窗口动作的第二个定义与第一个相比显得更简洁。</p><h2 id="c69c" class="my lw it bd lx mz na dn mb nb nc dp mf li nd ne mh lm nf ng mj lq nh ni ml nj bi translated">使用ORM API中的方法</h2><p id="3e94" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">虽然第二个定义很简洁，但有一种更好的方法，它不需要引用窗口动作的标识符，就像代码中用<code class="fe ms mt mu mv b">self.env.ref(...)</code>做的那样。</p><p id="dc1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第三个选项使用ORM方法<code class="fe ms mt mu mv b">get_formview_action()</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">首先在XML中定义的窗口操作，后来使用Odoo ORM方法get_formview_action()引用</figcaption></figure><h1 id="ca5c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">3.检查用户对模型的访问权限</h1><p id="edcc" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">用户对模型的操作在Odoo模块的<code class="fe ms mt mu mv b">security </code>目录下的<code class="fe ms mt mu mv b">ir.model.access.csv</code>文件中定义和管理。</p><p id="9eab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">模型访问文件定义了用户可以在模型上执行的CRUD操作。每当用户在没有<code class="fe ms mt mu mv b">ir.model.access.csv</code>文件中定义的正确访问权限的情况下执行操作时，就会抛出一个<code class="fe ms mt mu mv b">AccessError</code>错误。</p><p id="274e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">开发人员通常将这种检查留给Odoo，Odoo会抛出一个默认的<code class="fe ms mt mu mv b">AccessError </code>错误消息。此消息是通用的。为了自定义此消息，并向用户提供更友好和特定于上下文的反馈，开发人员通常将他们的操作包装在一个try-catch块中，以优雅地捕捉并引发更友好的验证错误。</p><p id="ae8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是我在代码中的意思</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用try-catch错误预测并妥善处理访问错误的create方法的重写</figcaption></figure><p id="4a4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的代码中，我们看到try-catch块用于保护创建操作。它捕捉默认的Odoo <code class="fe ms mt mu mv b">AccessError</code>，然后编写一个更友好的消息。</p><p id="150f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用try-catch定制Odoo默认访问错误消息是不必要的，因为它会使create方法变得冗长。这是真的，即使我们上面的create方法里面几乎没有任何东西。</p><h2 id="3e08" class="my lw it bd lx mz na dn mb nb nc dp mf li nd ne mh lm nf ng mj lq nh ni ml nj bi translated">使用ORM API中的方法</h2><p id="2cb9" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">现在，使用简单的方法<code class="fe ms mt mu mv b">check_access_rights(...)</code>我们可以实现相同的目标，而不需要不必要的try-catch块，这会降低代码的清晰度。</p><p id="4e54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">调用该方法时有两个参数，首先是用户<code class="fe ms mt mu mv b">operation</code>，然后是一个布尔值<code class="fe ms mt mu mv b">raise_exception </code>，指示当没有访问权限对模型执行指定操作时是否引发异常。对于下面例子中的控件，我们将<code class="fe ms mt mu mv b">raise_exception</code>参数设置为false。</p><p id="3637" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，一个使用<code class="fe ms mt mu mv b">check_access_rights(...)</code>方法的示例实现如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="d595" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，除了操作<code class="fe ms mt mu mv b">create</code>，还支持<code class="fe ms mt mu mv b">read</code>、<code class="fe ms mt mu mv b">write</code>、<code class="fe ms mt mu mv b">unlink</code>。</p><h1 id="b5cc" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">4.检查用户对记录的访问权限</h1><p id="17f5" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated"><code class="fe ms mt mu mv b">check_access_rule(...)</code>方法的工作方式类似于<code class="fe ms mt mu mv b">check_access_rights(...)</code>方法，但是基于已定义的记录规则。它根据定义的<code class="fe ms mt mu mv b">ir.rule</code>验证用户对模型记录的访问。</p><p id="4c70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">值得注意的一个区别是，<code class="fe ms mt mu mv b">check_access_rule(...)</code>方法采用单个<code class="fe ms mt mu mv b"> operation</code>参数，而如前所述，<code class="fe ms mt mu mv b">check_access_rights(...)</code>采用两个参数<code class="fe ms mt mu mv b">operation</code>和<code class="fe ms mt mu mv b">raise_exception</code>。</p><h1 id="ca16" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">5.存档记录</h1><p id="8a33" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">当不再需要记录，但不适合出于审计或其他目的删除记录时，记录归档非常有用。</p><p id="bb33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当一个模块的需求包括实现记录归档时，开发人员通常会在必要的模型上引入诸如<code class="fe ms mt mu mv b">active</code>或<code class="fe ms mt mu mv b">is_archived</code>的字段，并将值设置为<code class="fe ms mt mu mv b">True</code>或<code class="fe ms mt mu mv b">False</code>以响应用户对记录的某些特定操作。</p><p id="9da9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据选择用来存储记录存档状态的字段，Odoo提供了支持记录存档操作的特性。</p><p id="c6e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，Odoo自动扩展了树形视图的操作菜单，增加了“存档”和“取消存档”选项，可以轻松地存档和取消存档一条或多条记录。</p><p id="5722" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只有当开发人员在他们的模型上定义了这两个受支持的字段之一时，Odoo才能识别并更新带有存档和取消存档选项的Action菜单。他们是<code class="fe ms mt mu mv b">active</code>和<code class="fe ms mt mu mv b">x_active</code>。</p><p id="d240" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在某些情况下，模型的<code class="fe ms mt mu mv b">active</code>字段可以管理一个状态，而不是一个记录的存档状态。在这种情况下，必须使用<code class="fe ms mt mu mv b">x_active</code>。</p><p id="c893" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当在模型上定义了<code class="fe ms mt mu mv b">active</code>和<code class="fe ms mt mu mv b">x_active</code>字段时，必须在模型上定义一个附加属性，以指示这两个字段中的哪一个用于记录归档。</p><p id="8ac0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们引入值为<code class="fe ms mt mu mv b">x_active</code>的类属性<code class="fe ms mt mu mv b">_active_name</code>，因为我们使用<code class="fe ms mt mu mv b">active</code>字段的目的不同于归档。</p><p id="054e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们已经用Odoo方式实现了记录归档，我们还可以利用ORM API设计中的内置方法在不同的上下文中归档和取消归档记录，而不是在树形视图的Action菜单中。与手动将归档状态设置为真/假相比，这些方法非常方便。</p><p id="6147" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面显示了方法<code class="fe ms mt mu mv b">action_archive(...)</code>、<code class="fe ms mt mu mv b">action_unarchive(...)</code>和<code class="fe ms mt mu mv b">toggle_active(...)</code>的使用总结</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">记录归档和取消归档的一种假设实现</figcaption></figure></div><div class="ab cl ny nz hx oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="im in io ip iq"><p id="51d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="of">感谢您的阅读。我希望这篇文章对你有用。如果有，请花一点时间到</em> <a class="ae ky" href="https://medium.com/subscribe/@ofelix03" rel="noopener"> <em class="of">订阅</em> </a> <em class="of">到</em> <a class="ae ky" href="https://medium.com/subscribe/@ofelix03" rel="noopener"> <em class="of">我的个人资料</em> </a> <em class="of">在我每次发表新文章时接收通知。</em></p><p id="8b7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有一件事，如果你能支持我的写作，我将不胜感激。通过 <a class="ae ky" href="https://medium.com/membership/@ofelix03" rel="noopener"> <em class="of">加入媒介</em> </a> <em class="of">与我的</em> <a class="ae ky" href="https://medium.com/membership/@ofelix03" rel="noopener"> <em class="of">推荐链接</em> </a> <em class="of">，我从你的会员费中获得一小笔佣金，这有助于我投入时间和精力来撰写和发表这些有用的文章。</em></p><div class="og oh gp gr oi oj"><a href="https://ofelix03.medium.com/membership" rel="noopener follow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd iu gy z fp oo fr fs op fu fw is bi translated">通过我的推荐链接加入媒体-费利克斯·奥托</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">阅读费利克斯·奥托(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接支持…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">ofelix03.medium.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox ks oj"/></div></div></a></div></div></div>    
</body>
</html>