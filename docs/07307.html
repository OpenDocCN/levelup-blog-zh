<html>
<head>
<title>Asynchronous tasks in Python with Celery + RabbitMQ + Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Celery + RabbitMQ + Redis实现Python中的异步任务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/asynchronous-tasks-in-python-with-celery-rabbitmq-redis-480f6e506d76?source=collection_archive---------0-----------------------#2021-02-08">https://levelup.gitconnected.com/asynchronous-tasks-in-python-with-celery-rabbitmq-redis-480f6e506d76?source=collection_archive---------0-----------------------#2021-02-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="91b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将使用Celery、RabbitMQ和Redis来构建一个分布式任务队列。但是什么是分布式任务队列，为什么要建立一个呢？</p><blockquote class="kl km kn"><p id="00e5" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">一个<strong class="jp ir">分布式任务队列</strong>允许你将工作卸载到另一个进程，以异步(一旦你将工作推送到<strong class="jp ir">队列</strong>，你就不用等待)和并行(你可以使用其他内核来处理工作)的方式处理。</p></blockquote><p id="e0d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，它基本上让您能够在后台执行任务，同时应用程序继续解决其他任务。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ks"><img src="../Images/0b33bcf746b8e2196c9b3247c4b5d7b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FRkffS6BCCU36LBHglfF9A.png"/></div></div></figure><h1 id="a252" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">任务队列的用例</h1><p id="4e18" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">最基本和最容易理解的例子是在用户注册后发送电子邮件。在这种情况下，您不知道将电子邮件发送给用户需要多长时间，可能需要1毫秒，但也可能需要更长时间，有时甚至根本不发送，因为在这些情况下，您不负责或者只是说您不知道任务将会成功完成，因为另一个提供商将为您完成这项任务。<br/>现在您已经简单了解了如何从任务队列中获益，识别此类任务就像检查它们是否属于以下类别一样简单:</p><ul class=""><li id="0c22" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated"><strong class="jp ir">第三方任务</strong>—web应用程序必须快速为用户提供服务，而不需要在页面加载时等待其他操作完成，例如发送电子邮件或通知，或将更新传播到内部工具(例如为A/B测试或系统日志收集数据)。</li><li id="a9b8" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated"><strong class="jp ir">长时间运行的作业</strong> —资源昂贵的作业，用户在计算结果时需要等待，例如，复杂的工作流执行(DAG工作流)、图形生成、类似Map-Reduce的任务以及媒体内容(视频、音频)服务。</li><li id="8ddb" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated"><strong class="jp ir">周期性任务</strong> —您计划在特定时间或间隔后运行的任务，例如每月报告生成或每天运行两次的web scraper。</li></ul><h1 id="e54a" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">为芹菜设置依赖项</h1><p id="2a79" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated"><em class="ko"> Celery </em>需要一个消息传输来发送和接收消息。可以用作消息代理的一些候选对象有:</p><ul class=""><li id="0774" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated"><a class="ae mv" href="https://www.rabbitmq.com/" rel="noopener ugc nofollow" target="_blank"> RabbitMQ </a></li><li id="0a15" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated"><a class="ae mv" href="https://redis.io/" rel="noopener ugc nofollow" target="_blank"> Redis </a></li><li id="bde5" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated"><a class="ae mv" href="https://aws.amazon.com/sqs/" rel="noopener ugc nofollow" target="_blank">亚马逊SQS </a></li></ul><p id="eb2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本教程中，我们将使用<em class="ko"> RabbitMQ </em>，你可以使用任何其他你想要的消息代理(例如。Redis)。</p><p id="7b7f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提到我们现在要用Redis做什么也很好，因为对于消息传输器，我们使用RabbitMQ。<br/>当任务被发送到代理，然后由celery worker执行时，我们希望保存状态，并查看哪些任务之前已经被执行过。为此，您将需要某种类型的数据存储，对于这一个，我们将使用Redis。</p><p id="17c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于结果商店，我们也有许多候选:</p><ul class=""><li id="a145" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated">雷迪斯·AMQP</li><li id="490b" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">Memcached</li><li id="e015" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">姜戈·奥姆SQLAlchemy</li><li id="a247" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">Apache Cassandra，Elasticsearch，Riak等</li></ul><p id="a24a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了设置这些服务，我们将使用docker，因为它很容易设置，它是一个隔离的环境，当您有一个配置(Dockerfile或docker-compose)时，您可以很容易地复制相同的环境。</p><h2 id="83af" class="mw lf iq bd lg mx my dn lk mz na dp lo jy nb nc ls kc nd ne lw kg nf ng ma nh bi translated">项目设置</h2><p id="e435" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">让我们从头开始一个新的python项目。首先让我们创建一个新目录，创建项目所需的所有文件，然后初始化虚拟环境。</p><pre class="kt ku kv kw gt ni nj nk nl aw nm bi"><span id="d5c5" class="mw lf iq nj b gy nn no l np nq">$ touch docker-compose.yml requirements.txt<br/>$ touch tasks.py</span><span id="726b" class="mw lf iq nj b gy nr no l np nq"># create &amp; activate the virtualenv</span><span id="66e7" class="mw lf iq nj b gy nr no l np nq">$ python -m venv env<br/>$ source env/bin/activate<br/></span></pre><p id="a2c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们安装requirements.txt <strong class="jp ir">中的项目需求。对于这个项目，我们只需要芹菜和红萝卜。</strong></p><pre class="kt ku kv kw gt ni nj nk nl aw nm bi"><span id="3f74" class="mw lf iq nj b gy nn no l np nq">pip install celery==5.0.5 redis </span></pre><p id="9559" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在是时候配置docker-compose运行RabbitMQ和Redis了。在<strong class="jp ir"> docker-compose.yaml </strong>中粘贴以下yaml配置。</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="2eb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们简单地启动两个服务，通过定义image键指向<a class="ae mv" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> dockerhub </a>中的图像，映射端口<code class="fe nu nv nw nj b">&lt;host:docker&gt;</code>，并添加环境变量。要查看您的图像可以使用什么类型的环境变量，您可以简单地转到dockerhub中的相应图像，并查看文档。例如，您可以在这里查看如何使用RabbitMQ图像<a class="ae mv" href="https://hub.docker.com/_/rabbitmq" rel="noopener ugc nofollow" target="_blank"/></p><p id="5593" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们初始化芹菜应用程序，使用RabbitMQ作为消息传输器，使用Redis作为结果存储。<br/>在<strong class="jp ir"> tasks.py </strong>中，我们继续粘贴以下代码:</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="63f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试图让代码尽可能少，这样你就能理解本教程的目的。<br/>如您所见，我们已经定义了RabbitMQ和Redis的URL，然后我们简单地使用这些配置初始化celery应用程序。第一个参数<code class="fe nu nv nw nj b">tasks </code>是当前模块的名称。</p><p id="fc85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们用<code class="fe nu nv nw nj b">@app.task</code>来修饰函数<code class="fe nu nv nw nj b">say_hello</code>，这表明该函数被标记为一个任务，然后稍后可以使用<code class="fe nu nv nw nj b">.delay()</code>来调用，稍后我们将看到。</p><blockquote class="kl km kn"><p id="fc5b" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">通常我们会有一个模块<code class="fe nu nv nw nj b">celery_app.py</code>来初始化celery应用程序实例，然后有一个单独的模块<code class="fe nu nv nw nj b">tasks.py</code>来定义我们希望celery运行的任务。</p></blockquote><h2 id="3efd" class="mw lf iq bd lg mx my dn lk mz na dp lo jy nb nc ls kc nd ne lw kg nf ng ma nh bi translated">用docker构建和运行服务</h2><p id="ebd6" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">现在我们只需要用docker运行服务(RabbitMQ和Redis)。要运行容器中的图像，我们只需运行:</p><pre class="kt ku kv kw gt ni nj nk nl aw nm bi"><span id="5684" class="mw lf iq nj b gy nn no l np nq">$ docker-compose up -d </span></pre><p id="6e17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果本地没有这些图像，这将需要一段时间。然后，为了验证容器是否启动并运行，我们编写:</p><pre class="kt ku kv kw gt ni nj nk nl aw nm bi"><span id="847e" class="mw lf iq nj b gy nn no l np nq">$ docker ps</span></pre><p id="6415" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该看到两个正在运行的服务，以及每个服务的附加信息，如果没有，请检查日志中是否有任何可能的错误。<br/>现在让我们启动芹菜工人，然后让我们试着用<code class="fe nu nv nw nj b">python interactive shell.</code>运行一些任务</p><pre class="kt ku kv kw gt ni nj nk nl aw nm bi"><span id="87dc" class="mw lf iq nj b gy nn no l np nq"># Starting the Celery worker</span><span id="e6bd" class="mw lf iq nj b gy nr no l np nq">$ celery -A tasks worker -l info --pool=solo</span></pre><p id="89f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将运行celery worker，如果您看到日志，它应该会告诉您它已经成功地与代理连接。</p><p id="4dc3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们运行一个任务。</p><pre class="kt ku kv kw gt ni nj nk nl aw nm bi"><span id="ae80" class="mw lf iq nj b gy nn no l np nq"># Running celery tasks</span><span id="a075" class="mw lf iq nj b gy nr no l np nq">$ python<br/>---------------------------------<br/>Type "help", "copyright", "credits" or "license" for more information.<br/>&gt;&gt;&gt; from tasks import say_hello<br/>&gt;&gt;&gt; say_hello.delay("Valon")<br/>&lt;AsyncResult: 55ad96a9-f7ea-44f4-9a47-e15b90d6d8a2&gt;</span></pre><p id="163d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到我们使用<strong class="jp ir">调用了这个函数。delay() </strong>然后传递了名称实参。这个方法实际上是另一个名为<strong class="jp ir"> apply_async()的方法的星形参数快捷方式。</strong>然后我们看到我们得到了<code class="fe nu nv nw nj b">&lt;AsyncResult</code>，这是传递给代理的任务，之后将被celery在后台消耗和完成。</p><p id="bb3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您现在查看您的员工，您将在日志中看到该员工收到了一项任务，然后在5秒钟后会告诉您该任务已成功完成。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nx"><img src="../Images/1cf65c355ded443168636b4c24607317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DoPjdWMffrdv5rvmWUcT9g.png"/></div></div></figure><p id="3da4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们运行相同的任务，但是现在让我们将结果存储在游戏中。在python shell中，让我们将结果存储在一个变量中，然后让它的属性。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ny"><img src="../Images/0aaddd49cc2b9b75a036670a4b458473.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uDjJvpd0DSv6JLnLQZGSrA.png"/></div></div></figure><blockquote class="kl km kn"><p id="10ac" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">如果我们没有在celery (Redis)上配置后端，我们就不能访问这些属性或功能，因为默认情况下它不会存储任何状态，但是既然我们有了它，我们就可以看到并获得关于我们任务的信息。如果你想深入了解，你可以用table plus这样的工具访问Redis数据库，或者你可以设置<code class="fe nu nv nw nj b">Flower</code>来监控Redis和RabbitMQ。</p></blockquote><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nz"><img src="../Images/aab6876ec9a3270e88641b76f4a47a94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k5dDVOMdAa0N6xW1xCcqPQ.png"/></div></div></figure><p id="8420" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如上图所示，所有的任务都存储在Redis中。</p><h2 id="b775" class="mw lf iq bd lg mx my dn lk mz na dp lo jy nb nc ls kc nd ne lw kg nf ng ma nh bi translated">包扎</h2><p id="9be4" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">在本文中，我们用Celery、RabbitMQ和Redis从头开始建立了一个python应用程序。这篇文章的目的是向您展示什么是任务队列，我们可以从中受益，以及如何实现它。<br/>任务的例子只是为了演示，但是您可以使用与我在这个例子中相同的配置，在tasks模块中添加任务，在<strong class="jp ir"> celery_app.py中添加配置</strong>参见文档<a class="ae mv" href="https://docs.celeryproject.org/en/stable/getting-started/next-steps.html" rel="noopener ugc nofollow" target="_blank">此处</a></p><p id="3729" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我强烈建议你在你的应用程序中使用芹菜，因为当你有需要花费较长时间的事情，你需要安排任务等等时，它非常有用。</p><p id="173e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">您可以在GitHub资源库上找到文章的完整源代码，以及说明。</strong></p><p id="6f00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae mv" href="https://github.com/vjanz/python-asynchronous-tasks" rel="noopener ugc nofollow" target="_blank">www.github.com/vjanz/python-asynchronous-tasks</a></p><p id="1e9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你觉得它有帮助，请不要忘记鼓掌&amp;在你的社交网络上或与你的朋友分享。</p><p id="3e68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">如果你想支持我的工作，你可以点击下面的图片给我买杯咖啡😄</strong></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><a href="https://www.buymeacoffee.com/valonjanuzaj"><div class="gh gi oa"><img src="../Images/59b5c6e154bad5ee3b8395e0d7fe91b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kiygRTkeWNs36xpV.gif"/></div></a></figure><p id="d7c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你有任何问题，请随时联系我。</p><p id="4c1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae mv" href="https://www.linkedin.com/in/valon-januzaj-b02692187/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>，<a class="ae mv" href="http://www.github.com/vjanz" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上和我联系</p></div></div>    
</body>
</html>