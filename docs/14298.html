<html>
<head>
<title>Using Amazon Eventbridge Scheduler to build a serverless reminder application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Amazon Eventbridge Scheduler构建无服务器提醒应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-aws-eventbridge-scheduler-to-build-a-serverless-reminder-application-ba3086cf8e?source=collection_archive---------4-----------------------#2022-11-15">https://levelup.gitconnected.com/using-aws-eventbridge-scheduler-to-build-a-serverless-reminder-application-ba3086cf8e?source=collection_archive---------4-----------------------#2022-11-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0b70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本帖中，我们将看到如何使用<a class="ae kl" href="https://docs.aws.amazon.com/scheduler/latest/UserGuide/what-is-scheduler.html" rel="noopener ugc nofollow" target="_blank"> AWS Eventbridge调度器</a>。该服务类似于在调度运行的<a class="ae kl" href="https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-create-rule-schedule.html" rel="noopener ugc nofollow" target="_blank"> Eventbridge规则，但是它提供了更好的定制和改进的可伸缩性。</a></p><p id="408f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了重复性任务之外，Eventbridge Scheduler还能够通过配置“一次性计划”来规划未来的单个任务。在本文中，我们将主要关注这个特性。</p><p id="ce73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为一个用例，我们将构建一个无服务器应用程序，我们可以在未来的指定时间定义提醒，并通过短信接收它们。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/d7c838101e022e6c52541576ac2ee711.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*p7WIDfBL8Lg6jJp-T9R6mQ.png"/></div></figure><h2 id="cbeb" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">TL；速度三角形定位法(dead reckoning)</h2><p id="bc60" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">您可以在这里找到包含完整github action CI/CD工作流的应用程序存储库👉<a class="ae kl" href="https://github.com/ziedbentahar/aws-eventbridge-scheduler-sample" rel="noopener ugc nofollow" target="_blank">https://github . com/ziedbentahar/AWS-event bridge-scheduler-sample</a></p><h2 id="6d6e" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">我们要建造什么？</h2><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ls"><img src="../Images/829cdbfab7a8b8e9d58f3682092496c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ExVYpqwYQm_oiryBE9smEQ.png"/></div></div><figcaption class="lx ly gj gh gi lz ma bd b be z dk translated">“令人敬畏的提醒”的参考架构</figcaption></figure><ul class=""><li id="fe45" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated"><strong class="jp ir">Api网关</strong>公开集成了“注册提醒”lambda的路由。这个路由处理来自客户端的请求:一个包含消息、到期时间和消息的提醒有效负载。</li><li id="df64" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><strong class="jp ir">注册提醒</strong> lambda负责通过在Eventbridge调度程序上创建“一次性时间表”来安排提醒。我们将为发送到调度器的每个输入定义一个<strong class="jp ir">目标</strong>和一个<strong class="jp ir">目标角色</strong>，它允许事件桥写入该目标。在我们的例子中，我们将定义一个SQS队列"<strong class="jp ir">提醒队列</strong>"作为目标。</li><li id="1f72" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">在适当的时候，<strong class="jp ir"> Eventbridge调度器</strong>将提醒发送到<strong class="jp ir">提醒队列。</strong>我们将此队列配置为触发“发送提醒”lambda。</li><li id="61b0" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><strong class="jp ir">发送提醒</strong>通过SNS手机短信功能发布短信提醒。当提醒被成功发布到SNS时，这个lambda函数从Eventbridge调度器中移除已处理的提醒。</li></ul><p id="52a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个例子中将使用node 16 runtime和typescript进行Lambda代码。我们还将使用CloudFormation部署基础设施。</p><p id="8c6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">⚠️ <strong class="jp ir">注意:</strong>默认情况下，当处理SNS短信时，AWS账户会处于沙盒模式。有一些限制:只发送消息到验证的目的地电话号码，有限数量的验证目的地。在本文中，我不会详细描述向任何电话号码发送短信所需的配置。你可以在这里找到<a class="ae kl" href="https://towardsaws.com/configuring-sns-for-sending-sms-to-any-mobile-numbers-14f860650848" rel="noopener ugc nofollow" target="_blank">关于这个话题的一个很好的指南</a>。</p><h2 id="208d" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">让我们看看代码</h2><p id="ef29" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated"><strong class="jp ir"> 1-调度程序组</strong></p><p id="4be0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，Eventbridge调度程序将在“默认”组上创建调度。我们可以用自定义名称定义一个自定义调度组，在其中创建提醒任务。下面是创建调度程序组的CloudFormation资源:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="7a5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建后，该组将出现在Eventbridge调度程序控制台的“调度组”面板中</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi mr"><img src="../Images/73101bd13271c174c1cf3b9df237a46f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KmXvWC1njuR0vQRbZFN_jQ.png"/></div></div></figure><p id="c306" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2-创建执行角色</strong></p><p id="818d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个重要的步骤:我们将需要设置一个EventBridge Scheduler承担的执行角色，我们将把访问策略附加到该角色，以便为EventBridge Scheduler提供对调用目标的访问:在我们的例子中，将消息发送到"<strong class="jp ir"> Reminders queue </strong> " SQS目标。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="dd76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将在此处找到该角色<a class="ae kl" href="https://github.com/ziedbentahar/aws-eventbridge-scheduler-sample/blob/main/aws/cfn/components/register-reminder-lambda.yml" rel="noopener ugc nofollow" target="_blank">的完整模板</a></p><p id="806b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 3-创建“注册提醒”λ</strong></p><p id="6818" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个lambda通过调用<code class="fe ms mt mu mv b">scheduleReminder</code>为给定的提醒创建一个新的日程输入。每个提醒都会被分配一个Id。</p><p id="ef86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用这个Id来标识Eventbridge调度器上的调度输入。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="39ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ms mt mu mv b">scheduleReminder</code>使用AWS SDK在调度器上创建新的调度任务:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="dc23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">相关零件:</strong></p><ul class=""><li id="b262" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">目标、目标角色和调度程序组名称被定义为lambda资源中定义的环境变量</li><li id="cfc0" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">目标:它由目标输入(我们的提醒的有效负载)、目标Arn: " <strong class="jp ir">提醒队列</strong>"和IAM角色的角色Arn组成，当调度被调用时，EventBridge调度程序将为该目标使用该角色。</li><li id="b8be" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">时间表输入:我们将使用提醒的Id作为名称，设置目标并设置定义时间表何时运行的表达式，这里我们将使用<code class="fe ms mt mu mv b">at</code>表达式因为我们正在创建一次性时间表，所以该表达式必须具有以下格式`<code class="fe ms mt mu mv b">at(yyyy-mm-ddThh:mm:ss)</code>。您可以在此找到有关一次性日程<a class="ae kl" href="https://docs.aws.amazon.com/scheduler/latest/UserGuide/schedule-types.html#one-time" rel="noopener ugc nofollow" target="_blank">的更多信息</a></li></ul><p id="59ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该lambda函数需要<code class="fe ms mt mu mv b">allow</code> <code class="fe ms mt mu mv b">scheduler:CreateSchedule</code>策略以及<code class="fe ms mt mu mv b">allow</code> <code class="fe ms mt mu mv b">iam:PassRole</code>用于Eventbridge要使用的执行角色:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="d2c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在这里找到完整的云信息模板</p><p id="7d77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注册提醒后，它们会在Eventbridge计划程序控制台上显示为计划。如前所述，我们使用提醒id作为日程名称。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi mw"><img src="../Images/cc1ed27a8ad2256f1a3261a7b7c11baa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*py9qAdK9ykIom-1p8FfaBA.png"/></div></div><figcaption class="lx ly gj gh gi lz ma bd b be z dk translated">目标类型定义为SQS的“精彩提醒”计划</figcaption></figure><p id="4f3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 4-创建“发送提醒”lambda </strong></p><p id="e0bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个lambda将“提醒队列”定义为一个事件源。当被调用时，这个lambda通过SMS发送接收到的提醒，然后一旦操作成功就通过提醒Id删除相关的日程安排。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="da50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ms mt mu mv b">sendSms</code>功能使用SNS发送消息。以下是该功能的详细信息</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="7134" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“发送提醒”lambda执行角色附加这些策略:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="a087" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong>为了能够发送消息，<code class="fe ms mt mu mv b">send-sms</code>策略必须<code class="fe ms mt mu mv b">allow</code> <code class="fe ms mt mu mv b">sns:Publish</code>但是对于没有arn的资源，SNS文本消息服务就是这种情况。</p><p id="0001" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你会在这个链接后面找到这个lambda <a class="ae kl" href="https://github.com/ziedbentahar/aws-eventbridge-scheduler-sample/blob/main/aws/cfn/components/register-reminder-lambda.yml" rel="noopener ugc nofollow" target="_blank">的完整云形成模板。</a></p></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><h2 id="7a97" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">包扎</h2><p id="e281" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">Eventbridge Scheduler是Eventbridge计划规则或CloudWatch事件的一个很好的替代方案。它的特别调度功能使它成为需要计划将来要处理的消息的应用程序的完美服务。</p><p id="0a74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">⚠️ <strong class="jp ir">重要提示:</strong></p><ul class=""><li id="2a8f" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">在撰写本文时，您可以配置最小粒度为一分钟的计划。</li><li id="866f" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">该服务至少向目标提供一次交付</li></ul><p id="9b82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在这里找到github action CI/CD管道的完整报告👉<a class="ae kl" href="https://github.com/ziedbentahar/aws-eventbridge-scheduler-sample" rel="noopener ugc nofollow" target="_blank">https://github . com/ziedbentahar/AWS-scheduling-with event-bridge</a></p></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><h2 id="518b" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">进一步阅读</h2><div class="ne nf gp gr ng nh"><a href="https://docs.aws.amazon.com/scheduler/latest/UserGuide/getting-started.html" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">EventBridge调度程序入门</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">EventBridge调度程序入门- EventBridge调度程序本主题介绍如何创建新的EventBridge…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><div class="ne nf gp gr ng nh"><a href="https://docs.aws.amazon.com/scheduler/latest/UserGuide/security_iam_service-with-iam.html" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">EventBridge调度程序如何与IAM配合使用</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">在使用IAM管理对EventBridge调度程序的访问之前，请了解哪些IAM功能可用于…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><div class="ne nf gp gr ng nh"><a href="https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-templated.html" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">模板化目标</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">模板化目标是跨一组核心AWS服务的一组公共API操作，如亚马逊SQS、Lambda…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><div class="ne nf gp gr ng nh"><a href="https://towardsaws.com/configuring-sns-for-sending-sms-to-any-mobile-numbers-14f860650848" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">配置SNS以便向任何手机号码发送短信</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">当我们开始使用社交网站时，默认情况下，我们的帐户将处于沙盒模式。开始就好。但是…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">towardsaws.com</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv ks nh"/></div></div></a></div></div></div>    
</body>
</html>