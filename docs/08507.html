<html>
<head>
<title>Cluster Monitoring in Python with Glances</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中的集群监控</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/cluster-monitoring-in-python-with-glances-a6a69f5ce3f7?source=collection_archive---------4-----------------------#2021-05-07">https://levelup.gitconnected.com/cluster-monitoring-in-python-with-glances-a6a69f5ce3f7?source=collection_archive---------4-----------------------#2021-05-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/a328df2041b12251aca01247f4d28ac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4wYX6CwGHH4zGXGm"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kf" href="https://unsplash.com/@autumnmott?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">秋莫特罗德希尔</a>拍摄的照片</figcaption></figure><p id="f86c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几年前，我妻子给我买了几台Raspberry Pi 3 B+单板计算机作为圣诞礼物，这样我就可以尝试创建和管理计算机集群(这是我一直想要的)。从那以后，我发现了用一些我经常使用的高端电脑进行高性能计算的更好方法。因此，我的Raspberry Pi集群很大程度上处于休眠状态，只执行一些小任务(主要是为我的<a class="ae kf" href="https://www.anthonymorast.com/blog/2020/12/08/creating-a-database-with-an-api-stock-price-data/" rel="noopener ugc nofollow" target="_blank">股票价格API </a>收集数据，并充当我家庭网络的SSH接入点)。在此之前，我已经使用Raspberry Pis完成了许多任务，并且总是发现自己在想同样的事情，“那些东西还在运行吗？”由于我使用的是机箱，我无法亲眼看到设备来验证电源和处理灯是亮着还是在闪烁，所以我真的不知道它们的状态。我决定实现一个更容易实现的解决方案，而不是像ping每个Pi或尝试登录每个节点那样做一些基本的事情。在这篇文章中，我描述了Glances API的设置和使用，以及在一个小LCD屏幕上显示某些数据，这个小LCD屏幕安装在我用来存储PI集群的箱子外面。</p><h1 id="928f" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">反光</h1><p id="98fb" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated"><a class="ae kf" href="https://glances.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank">glasses</a>是用Python编写的跨平台监控工具。API提供了大量关于运行该软件的服务器上发生了什么的信息。我发现最有用的是在web服务器模式下运行Glances，它通过一个漂亮的web界面提供信息。在这种模式下运行Glances监听端口61208上的连接(默认情况下),基本上给出的信息类似于您通过<strong class="ki iu"> top </strong>或<strong class="ki iu"> htop </strong>看到的信息，还有其他一些细微之处。在web服务器模式下运行Glances并导航到URL(即http:// &lt;服务器ip &gt; :61208)会提供以下输出:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mh"><img src="../Images/0fa6d54265e00b8481f5b2670805c195.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tH6igjIGo38m7NX4.png"/></div></div></figure><p id="0ba4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这很好，但我计划在多个设备上运行这个软件，并希望能够确定它们的可用性。出现了两个问题，I)必须记住许多设备的IP地址，以及ii)每当我们想要确定设备可用性时，必须(本质上)检查多个网站。</p><p id="d8d2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">幸运的是，Glances还提供了一个RESTful API来检索上面显示的信息(以及更多)。在我的例子中，我想知道我的Raspberry Pi集群中的一个节点是否可用，以及集群的总资源利用率是多少。因此，我需要能够ping节点，获得每个节点的CPU使用情况，以及每个节点的内存(RAM)使用情况。当通过可用的API端点在web服务器模式下运行Glances时，这很容易做到。基本URL是:</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="70b3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在哪里</p><ul class=""><li id="ede4" class="mo mp it ki b kj kk kn ko kr mq kv mr kz ms ld mt mu mv mw bi translated"><em class="mx">服务器ip </em>是Glances服务器的ip地址</li><li id="5161" class="mo mp it ki b kj my kn mz kr na kv nb kz nc ld mt mu mv mw bi translated"><em class="mx">眼色端口</em>是眼色端口正在监听连接</li><li id="f201" class="mo mp it ki b kj my kn mz kr na kv nb kz nc ld mt mu mv mw bi translated">而<em class="mx">插件</em>，在我的例子中，被替换为<em class="mx"> cpu </em>以获得cpu使用细节或者<em class="mx"> mem </em>以获得内存使用细节</li></ul><p id="0a10" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下命令用于在集群中的每个节点上以web服务器模式启动glances。<em class="mx"> -w </em>命令行选项是指定web服务器模式，而<em class="mx"> -p </em>选择端口。尽管使用了默认端口，但我还是通过命令行指定了它，以防将来更改默认端口。</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="6477" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了方便起见，我把它添加到/etc/rc.local文件中，这个文件在Raspbian启动时运行。然而，最近基于Ubuntu/Debian的发行版已经废除了rc.local文件，因此需要另一种方法(cron作业、服务等)。)</p><h1 id="dea1" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">收集CPU和内存使用情况</h1><p id="47be" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">使用了两个函数来获取内存和CPU使用情况，尽管两者做的事情或多或少是一样的。第一个示例如下所示，它使用Glances API来获取关于被查询设备上可用的RAM数量、正在使用的RAM数量以及正在使用的RAM百分比的详细信息。</p><p id="2454" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，导入以下库并定义变量:</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="1837" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">获取存储器数据的函数如下所示:</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="7c39" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里，集群中每个Pi的IP地址被迭代，并且构建了一个URL来向Glances API提交GET请求。online参数是一个列表，如果节点在线，则存储“1”，否则存储“0”。从API返回的数据存储在列表中，并从函数中返回。请注意，我已经通过路由器的DHCP设置为集群中的每个Raspberry Pi分配了一个静态IP地址，因此我不需要更新列表(它们每次都是连续的，我不知道从现在到那时发生了什么)。</p><p id="2226" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，在下面的函数中，查询Glances API来检索每个PI的CPU使用情况。</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="4532" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个函数非常类似于<em class="mx"> get_mem() </em>函数，唯一的区别是返回pi的CPU使用百分比。</p><p id="6d16" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是监控脚本的主要函数，它首先检查Raspberry Pis是否正在运行并通过ping连接到互联网，然后调用上面的函数来获取使用数据，最后使数据更具可读性并将其写入屏幕。</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="3042" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里提供的代码将显示文本行</p><ul class=""><li id="3ce3" class="mo mp it ki b kj kk kn ko kr mq kv mr kz ms ld mt mu mv mw bi translated">可用的计算机数量与群集中的计算机总数之比，</li><li id="e96f" class="mo mp it ki b kj my kn mz kr na kv nb kz nc ld mt mu mv mw bi translated">集群节点的IP地址，</li><li id="8232" class="mo mp it ki b kj my kn mz kr na kv nb kz nc ld mt mu mv mw bi translated">“1”表示节点可用，“0”表示节点不可用，</li><li id="c4ad" class="mo mp it ki b kj my kn mz kr na kv nb kz nc ld mt mu mv mw bi translated">所有节点的平均CPU使用率(百分比)，</li><li id="2644" class="mo mp it ki b kj my kn mz kr na kv nb kz nc ld mt mu mv mw bi translated">可用的RAM总量与正在使用的RAM总量相比，</li><li id="c674" class="mo mp it ki b kj my kn mz kr na kv nb kz nc ld mt mu mv mw bi translated">和正在使用的RAM的平均百分比。</li></ul><p id="524c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这本身就是一个漂亮的脚本，但是它仍然需要持续运行以不断提供更新的值。在我的例子中，我想被动地监视集群中的pi。正因为如此，我最终购买了一个小的20字符，4线I2C液晶显示器，并把它挂在一个旧的树莓Pi 2上。下面提供了实现这一点的代码。</p><p id="39a6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我需要为Raspberry Pi下载一个I2C接口驱动程序。这是从GitHub页面中截取的，或多或少是按原样使用的。感兴趣的文件是<a class="ae kf" href="https://gist.github.com/DenisFromHR/cc863375a6e19dce359d#file-rpi_i2c_driver-py" rel="noopener ugc nofollow" target="_blank"> RPi_I2C_driver.py <strong class="ki iu"> <em class="mx">。由于这个文件几乎有200行长，我将把它从这篇文章中删除，这样它就不会太长，而且因为我没有写脚本或以任何方式修改它(至少我记得)。</em></strong></a></p><p id="098b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了使用上面讨论的驱动程序写入LCD屏幕，下面的代码被添加到上面main函数的print语句之后。</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="92e4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">文本有些浓缩，对于大量节点来说不实用，因为LCD屏幕太小了，但对我来说，它做得很好。</p><h1 id="fd64" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="f734" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">总之，Glances库是一个非常强大的监控工具，几乎可以在任何地方运行，并提供对远程或无头机器的当前状态的深入了解。在web服务器模式下运行的能力，加上这样做打开了一个RESTful API，使得监控集群中的许多节点变得非常容易，只需要几个GET请求和一些JSON解析。请注意，我使用的是这些GET请求提供的数据的一个非常小的子集(主要是为了适合LCD屏幕)，但是还有更多可用的数据，可以在<a class="ae kf" href="https://github.com/nicolargo/glances/wiki/The-Glances-RESTFULL-JSON-API" rel="noopener ugc nofollow" target="_blank">glasses RESTful文档</a>中找到。我用一个旧的小型电脑机箱为我的集群定制了一个机箱，并剪了一个孔来安装LCD屏幕。现在，只需看一眼LCD(也许库就是这么命名的)，我就可以对我的集群的状态有很多有价值的了解。</p><h1 id="c352" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">完整代码</h1><p id="8d4f" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">请使用上面的链接找到树莓派I2C驱动程序代码。</p><h2 id="f5cf" class="nd lf it bd lg ne nf dn lk ng nh dp lo kr ni nj ls kv nk nl lw kz nm nn ma no bi translated">监视器. py</h2><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mm mn l"/></div></figure></div><div class="ab cl np nq hx nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="im in io ip iq"><p id="78cf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mx">原载于2021年5月7日https://www.anthonymorast.com</em><a class="ae kf" href="https://www.anthonymorast.com/blog/2021/05/07/cluster-monitoring-in-python-with-glances/" rel="noopener ugc nofollow" target="_blank"><em class="mx"/></a><em class="mx">。</em></p></div></div>    
</body>
</html>