<html>
<head>
<title>Working with Graph Data — Vert.x and Neo4j</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用图形数据-vert . x和Neo4j</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/reactive-apis-for-graph-data-vert-x-neo4j-335521321fa3?source=collection_archive---------13-----------------------#2020-04-17">https://levelup.gitconnected.com/reactive-apis-for-graph-data-vert-x-neo4j-335521321fa3?source=collection_archive---------13-----------------------#2020-04-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f7a52a703e3068b13c00309b9874a6ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8GybYf0icYHVjh0KO09CEw.jpeg"/></div></div></figure><p id="8a43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">图形是一种强大而通用的数据结构，可以轻松地表示不同类型的数据(节点)之间的真实关系。图表有两个主要部分:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi kw"><img src="../Images/3b6e35680a39cf1c2717ffa39d554350.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wKg4v1EZFkJet_xHxqx6qQ.png"/></div></div></figure><ul class=""><li id="ea4f" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">存储数据的顶点(节点)<em class="lk">，即图像中的字母</em></li><li id="c59d" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated">连接节点<em class="lk">的边(连接)，即图像</em>中节点之间的线</li></ul><p id="a72a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">图形可以是<strong class="ka ir">无向</strong>或<strong class="ka ir">有向</strong>。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lq"><img src="../Images/d761f04fb19499cf767b8de1f2f137a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6JnpO83tjoWVaiAeenfUmQ.png"/></div></div></figure><p id="c03e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">无向图:</strong>两个方向都存在关系。</p><p id="7b46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">有向图:</strong>关系是基于边的方向。它可以是单向关系，也可以是双向关系，但必须明确说明。</p><p id="170e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">与任何其他数据存储一样，可以对图表执行的一些常见操作包括:</p><p id="a95c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">新增内容</strong></p><ul class=""><li id="2c1e" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated"><code class="fe lr ls lt lu b">addNode</code> <strong class="ka ir"> : </strong>给你的图形添加顶点</li><li id="2cb1" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated"><code class="fe lr ls lt lu b">addEdge</code> <strong class="ka ir"> : </strong>创建图形中两个给定顶点之间的边</li></ul><p id="f8d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">移除</strong></p><ul class=""><li id="ff7b" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated"><code class="fe lr ls lt lu b">removeNode</code> <strong class="ka ir"> : </strong>从你的图形中删除顶点</li><li id="2ca7" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated"><code class="fe lr ls lt lu b">removeEdge</code> <strong class="ka ir"> : </strong>删除图形中两个给定顶点之间的边</li></ul><p id="838b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">搜索</strong></p><ul class=""><li id="a461" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated"><code class="fe lr ls lt lu b">contains</code> <strong class="ka ir"> : </strong>检查你的图形是否包含给定值</li><li id="92da" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated"><code class="fe lr ls lt lu b">hasEdge</code> <strong class="ka ir"> : </strong>检查图中两个给定节点之间是否存在连接</li><li id="344f" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated"><code class="fe lr ls lt lu b">getNode</code> <strong class="ka ir"> : </strong>查找符合条件的节点</li><li id="d155" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated"><code class="fe lr ls lt lu b">getEdges</code> <strong class="ka ir"> : </strong>查找符合标准的关系</li><li id="53f6" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated"><code class="fe lr ls lt lu b">getConnectedNodes</code> <strong class="ka ir"> : </strong>给定一个条件，找出由一条路径连接的节点</li></ul><p id="d2be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">算法</strong></p><ul class=""><li id="bb84" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated"><code class="fe lr ls lt lu b">shortestPath</code> <strong class="ka ir"> : </strong>最短路径算法计算一对节点之间的最短(加权)路径</li></ul><h1 id="4896" class="lv lw iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">Neo4j简介</h1><p id="e63f" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">Neo4j 是一个图形数据库，旨在与高度相关的数据进行交互，例如您可能在社交图中找到的关系。如果您的数据被设计成可以用相关节点的图形来表示，那么查询该数据会非常有效。Neo4j的响应时间随着结果集中节点数量的增加而增加。</p><p id="3b77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于本文，我们将使用Neo4j社区版4.0.2。人们可以从Neo4j <a class="ae my" href="https://neo4j.com/download-center/#community" rel="noopener ugc nofollow" target="_blank">网站</a>下载服务器。下载完成后，解压tar文件，运行<code class="fe lr ls lt lu b">neo4j start</code>即可启动服务器。一旦服务器启动并运行，用户就可以使用默认情况下localhost:7474上的neo4j浏览器。</p><h1 id="a845" class="lv lw iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">二进制Bolt协议</h1><p id="959d" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">从Neo4j 3.0开始，服务器支持名为Bolt的二进制协议。它基于PackStream序列化，并通过证书支持密码类型系统、协议版本、认证和TLS。对于Neo4j集群，Bolt提供了带有负载平衡和故障转移的智能客户端路由。</p><p id="515c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Neo4j默认启用二进制协议，因此您可以使用任何支持它的语言驱动程序。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/48342ab28c2d708cadd3885dea4d7922.png" data-original-src="https://miro.medium.com/v2/resize:fit:844/format:webp/1*BGBrFLETDSM7PNiblRzMwQ.jpeg"/></div></figure><p id="1c3b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Neo4j官方为<a class="ae my" href="https://neo4j.com/developer/language-guides/dotnet" rel="noopener ugc nofollow" target="_blank">提供驱动。Net </a>，<a class="ae my" href="https://neo4j.com/developer/language-guides/java" rel="noopener ugc nofollow" target="_blank"> Java </a>，<a class="ae my" href="https://neo4j.com/developer/language-guides/javascript" rel="noopener ugc nofollow" target="_blank"> JavaScript </a>，<a class="ae my" href="https://neo4j.com/developer/language-guides/go" rel="noopener ugc nofollow" target="_blank"> Go </a>，以及<a class="ae my" href="https://neo4j.com/developer/language-guides/python" rel="noopener ugc nofollow" target="_blank"> Python </a>。</p><p id="e5a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在<a class="ae my" href="http://neo4j.com/docs/developer-manual/current/drivers/" rel="noopener ugc nofollow" target="_blank"> Neo4j驱动手册</a>中找到官方驱动的详细信息</p><h1 id="709d" class="lv lw iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">密码查询语言</h1><p id="5187" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">Neo4j提供了一种非常强大和非常直观的查询语言，它支持数据库的所有特性。Cypher基于SQL的强大功能，但专门针对图形进行了优化。语法简洁明了，允许用户以简单和可维护的方式轻松编写所有普通的CRUD操作。</p><h1 id="261c" class="lv lw iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">Java驱动程序</h1><p id="86fa" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">对于本文，我们将运行一个独立的社区服务器，并通过Neo4j Java驱动程序连接到它。</p><p id="7e6b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Neo4j驱动程序支持三种不同的编程模型:</p><ul class=""><li id="c868" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">阻塞数据库访问(很像标准的JDBC)</li><li id="1a2d" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated">基于JDKs completable futures和相关基础设施的异步编程</li><li id="a18c" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated">基于<a class="ae my" href="http://www.reactive-streams.org/" rel="noopener ugc nofollow" target="_blank">反应流</a>的反应编程</li></ul><h1 id="d581" class="lv lw iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">一个示例图形应用程序</h1><p id="000e" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">为了展示图形数据库的强大功能和灵活性，让我们使用Vert.x构建一个简单的Web API，并使用Java驱动程序与Neo4j服务器进行交互。</p><p id="fc83" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于我们的示例应用程序，我们将使用由<a class="ae my" href="https://openflights.org/data.html" rel="noopener ugc nofollow" target="_blank"> OpenFlights </a>提供的开放航空公司数据。我们将使用机场和路线数据，在我们的图表中创建机场节点，并根据路线数据创建两个机场之间的“连接”关系。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/ee1cd18986ecce4c5d6c698f61e9cb99.png" data-original-src="https://miro.medium.com/v2/resize:fit:802/format:webp/1*104el0kUeVX58MA1Dr3ZGQ.png"/></div></figure><p id="bbc8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用maven添加java驱动程序依赖:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="8f6a" class="nf lw iq lu b gy ng nh l ni nj">&lt;dependency&gt;<br/>    &lt;groupId&gt;org.neo4j.driver&lt;/groupId&gt;<br/>    &lt;artifactId&gt;neo4j-java-driver&lt;/artifactId&gt;<br/>    &lt;version&gt;4.0.1&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="b175" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们创建一个包装器来连接图形数据库。包装器使得从API处理程序访问数据库变得容易。</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="3bee" class="nf lw iq lu b gy ng nh l ni nj">public class Graph {<br/>    private Driver      m_driver = null;<br/>    private Session     m_session = null;</span><span id="448b" class="nf lw iq lu b gy nk nh l ni nj">    public Graph() {<br/>        startup();<br/>    }<br/>    private void startup() {<br/>        m_driver = GraphDatabase.driver("bolt://localhost:7687"<br/>                                        , AuthTokens.basic("neo4j", "password"));<br/>        m_session = m_driver.session();<br/>    }<br/>    public void stop() {<br/>        m_session.close();<br/>        m_driver.close();<br/>    }<br/>}</span></pre><h1 id="75aa" class="lv lw iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">将数据载入图表</h1><p id="5e95" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">创建我们的API verticle，以允许与图形接口。API verticle会将图形查询结果转换成JSON消息，以便于前端处理。它还将为类似REST的请求和来自SockJS连接的请求提供处理程序。</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="93ed" class="nf lw iq lu b gy ng nh l ni nj">public class APIVerticle extends AbstractVerticle<br/>{<br/>  private Graph m_graph = null;<br/>  public APIVerticle() {<br/>      super();<br/>  }  <br/>  <a class="ae my" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>  public void start() throws Exception {<br/>    m_graph = new Graph();<br/>  }<br/>}</span></pre><p id="802c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将机场和路线载入图表。</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="3d9a" class="nf lw iq lu b gy ng nh l ni nj">private void load() {<br/>    String path = m_config.getString("airports");<br/>    if (path != null) {<br/>        loadAirports(path);<br/>    }<br/>    path = m_config.getString("routes");<br/>    if (path != null) {<br/>        loadRoutes(path);<br/>    }<br/>}</span></pre><p id="0ed2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从开放航班加载机场数据。在这里下载<a class="ae my" href="https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat" rel="noopener ugc nofollow" target="_blank">CSV格式的数据。定义机场POJO以保存此信息。</a></p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="8895" class="nf lw iq lu b gy ng nh l ni nj">public abstract class Node {<br/>    public abstract String getCreateCypher();<br/>    public abstract HashMap&lt;String, Object&gt; getCreateParams();<br/>}</span><span id="222e" class="nf lw iq lu b gy nk nh l ni nj">public class Airport extends Node <br/>{<br/>    private static String CREATE = <br/>      "CREATE (a:Airport {name: $name, city: $city, country: $country, code: $code"<br/>    + ", latitude: $latitude, longitude: $longitude, altitude: $altitude, timezone: $timezone})\n"<br/>    + "RETURN a";<br/>    <br/>    private String      m_name;<br/>    private String      m_city;<br/>    private String      m_country;<br/>    private String      m_code;<br/>    private Float       m_latitude;<br/>    private Float       m_longitude;<br/>    private Integer     m_altitude;<br/>    private String      m_timezone;<br/>    private HashMap&lt;String, Object&gt; m_params <br/>        = new HashMap&lt;String, Object&gt;();<br/>    <br/>    public Airport(String name, <br/>                   String city, <br/>                   String country, <br/>                   String code, <br/>                   Float latitude, <br/>                   Float longitude, <br/>                   Integer altitude, <br/>                   String timezone) <br/>    {<br/>        m_name = name;<br/>        m_params.put("name", name);<br/>        m_city = city;<br/>        m_params.put("city", city);<br/>        m_country = country;<br/>        m_params.put("country", country);<br/>        m_code = code;<br/>        m_params.put("code", code);<br/>        m_latitude = latitude;<br/>        m_params.put("latitude", latitude);<br/>        m_longitude = longitude;<br/>        m_params.put("longitude", longitude);<br/>        m_altitude = altitude;<br/>        m_params.put("altitude", altitude);<br/>        m_timezone = timezone;<br/>        m_params.put("timezone", timezone);<br/>    }<br/>    <br/>    <a class="ae my" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public String getCreateCypher() {<br/>        return CREATE;<br/>    }<br/>    <a class="ae my" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public HashMap&lt;String, Object&gt; getCreateParams()<br/>    {<br/>        return m_params;<br/>    }<br/>}</span></pre><p id="0e8b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从机场CSV加载数据:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="3100" class="nf lw iq lu b gy ng nh l ni nj">private void loadAirports(String path) <br/>{<br/>    try <br/>    {<br/>        CSVReader reader = new CSVReader(new FileReader(path));<br/>        Observable<br/>            .fromIterable(reader)<br/>            .map(<br/>              csvRow -&gt; {<br/>                  if (csvRow.length &lt; 12) <br/>                  {<br/>                      return null;<br/>                  }<br/>                  return new Airport(csvRow[1], // name<br/>                                     csvRow[2], // city<br/>                                     csvRow[3], // country<br/>                                     csvRow[4], // IATA code<br/>                                     getFloat(csvRow[6]), // latitude<br/>                                     getFloat(csvRow[7]), // longitude<br/>                                     getInteger(csvRow[8]), // altitude<br/>                                     csvRow[11]); // timezone<br/>              }<br/>            )<br/>            .subscribe(airport -&gt; {<br/>                        m_graph.createNode(airport);<br/>                       }<br/>                      , error -&gt; {<br/>                        }<br/>                      , () -&gt; {});</span><span id="071e" class="nf lw iq lu b gy nk nh l ni nj">} catch (FileNotFoundException ex) {<br/>        m_logger.error("Airports file not found", ex);<br/>    }<br/>}</span></pre><p id="539d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从<a class="ae my" href="https://raw.githubusercontent.com/jpatokal/openflights/master/data/routes.dat" rel="noopener ugc nofollow" target="_blank"> CSV </a>加载路线数据。创建POJO来表示路线，并将数据加载到图形中。</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="16e5" class="nf lw iq lu b gy ng nh l ni nj">public class Route extends Node {<br/>    private final static String CREATE_RELATIONSHIP = <br/>      "MATCH (src:Airport {code:$source}), (dst:Airport {code:$destination})\n"<br/>    + "CREATE (src)-[r:Connects {airline:$airline,source:$source,destination:$destination}]-&gt;(dst)\n"<br/>    + "RETURN r";<br/>    <br/>    private String m_source;<br/>    private String m_destination;<br/>    private String m_airline;<br/>    private HashMap&lt;String, Object&gt; m_params = <br/>      new HashMap&lt;String, Object&gt;();<br/>    <br/>    public Route(String source, String destination, String airline) <br/>    {<br/>        m_source = source;<br/>        m_params.put("source", source);<br/>        m_destination = destination;<br/>        m_params.put("destination", destination);<br/>        m_airline = airline;<br/>        m_params.put("airline", airline);<br/>    }<br/>    <br/>    <a class="ae my" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public String getCreateCypher() {<br/>        return CREATE_RELATIONSHIP;<br/>    }<br/>    <a class="ae my" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public HashMap&lt;String, Object&gt; getCreateParams()<br/>    {<br/>        return m_params;<br/>    }<br/>}</span></pre><p id="16f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用路线数据文件中的每一行创建机场之间的关系:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="0bc2" class="nf lw iq lu b gy ng nh l ni nj">private void loadRoutes(String path) <br/>{<br/>  try <br/>  {<br/>    CSVReader reader = new CSVReader(new FileReader(path));<br/>    Observable<br/>      .fromIterable(reader)<br/>      .map(<br/>        csvRow -&gt; {<br/>          if (csvRow.length &lt; 4) <br/>          {<br/>              return null;<br/>          }<br/>          return new Route(csvRow[2], // sourceairport<br/>                           csvRow[4], // destinationairport<br/>                           csvRow[0]); // airline<br/>        }<br/>      )<br/>      .subscribe(route -&gt; {<br/>                  m_graph.createNode(route);<br/>                 }<br/>                , error -&gt; {<br/>                  }<br/>                , () -&gt; {});<br/>  } catch (FileNotFoundException ex) {<br/>    m_logger.error("Routes file not found", ex);<br/>  }<br/>}</span></pre><h1 id="756f" class="lv lw iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">创建节点和关系</h1><p id="a729" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">在Graph中添加一个通用的createNode方法来创建节点和关系。Airport和Route POJO类定义了在Neo4j上执行创建操作所需的必要的CYPHER语句。</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="32b4" class="nf lw iq lu b gy ng nh l ni nj">public void createNode(Node pojo) {<br/>  String createStr = pojo.getCreateCypher();<br/>  m_session.run(createStr, pojo.getCreateParams());<br/>}</span></pre><p id="97ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建机场节点的密码:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="8cc8" class="nf lw iq lu b gy ng nh l ni nj">CREATE (a:Airport {name: $name, city: $city, country: $country, code: $code, latitude: $latitude, longitude: $longitude, altitude: $altitude, timezone: $timezone}) RETURN a</span></pre><p id="e87c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CYPHER创建两个机场之间的“连接”关系:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="6693" class="nf lw iq lu b gy ng nh l ni nj">MATCH (src:Airport {code:$source}), (dst:Airport {code:$destination}) <br/>CREATE (src)-[r:Connects {airline:$airline,source:$source,destination:$destination}]-&gt;(dst) <br/>RETURN r</span></pre><p id="4b00" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用getCreateParams()作为HashMap来提供执行CYPHER所需的参数。</p><p id="11c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用Neo4j浏览器，我们可以将节点以及它们之间的关系可视化。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/870e648db5b3c7c14d697a9338503695.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JT0umqCqe3-AqEFQKtmsMA.png"/></div></div></figure><h1 id="a290" class="lv lw iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">查询图中的节点、关系和路径</h1><p id="6c9f" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">让我们通过一些密码查询来搜索机场和连接机场的路线。</p><p id="0b95" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从查找所有Airport节点的简单查询开始:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="33c2" class="nf lw iq lu b gy ng nh l ni nj">MATCH (airport:Airport) return airport</span></pre><p id="9690" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">根据IATA代码查找机场:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="a322" class="nf lw iq lu b gy ng nh l ni nj">MATCH (airport:Airport {code:$code}) return airport</span></pre><p id="2130" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查找连接最紧密的机场:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="f934" class="nf lw iq lu b gy ng nh l ni nj">MATCH (src)-[:Connects]-&gt;(dst)<br/>RETURN dst.code, count(src) as routes<br/>ORDER BY routes DESC LIMIT 10</span></pre><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/160a437ba6bd8f61b1ad77c32c8e1b90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SfmQSGB8yBbrq-pXDcCUFQ.png"/></div></div></figure><p id="01cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">寻找两个机场之间的路径:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="23dc" class="nf lw iq lu b gy ng nh l ni nj">MATCH p=(src:Airport {code:'ORD'})-[r:Connects]-&gt;(dst:Airport {code:'DEL'}) WITH reduce(output = [], n IN relationships(p) | output + n ) as nodeCollection RETURN nodeCollection</span></pre><p id="89bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过深度限制路径:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="0491" class="nf lw iq lu b gy ng nh l ni nj">MATCH p=(src:Airport {code:'ORD'})-[r:Connects*2]-&gt;(dst:Airport {code:'DEL'}) WITH reduce(output = [], n IN relationships(p) | output + n ) as nodeCollection RETURN nodeCollection</span></pre><h1 id="5494" class="lv lw iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">API和EventBus处理程序</h1><p id="8a07" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">为了方便客户端(浏览器)查询Graph DB，我们将需要APIVerticle中的事件处理程序来处理通过HTTP或SockJS到达的请求。让我们看一个这样的处理程序，它处理一个在两个机场之间查找路线的请求:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="7d2d" class="nf lw iq lu b gy ng nh l ni nj">m_router.get("/routes").handler(this::listRoutes);<br/>...</span><span id="ed1f" class="nf lw iq lu b gy nk nh l ni nj">public void listRoutes(RoutingContext ctx) <br/>{<br/>  HttpServerResponse response = ctx.response();<br/>  String src = ctx.request().getParam("source");<br/>  String dst = ctx.request().getParam("destination");<br/>  List&lt;AirPath&gt; airpaths = m_graph.getRoutes(src.toUpperCase(), dst.toUpperCase(), 2);<br/>  JsonArray arr = new JsonArray();<br/>  airpaths.forEach(r -&gt; { arr.add(r.toJson()); });<br/>  JsonObject msg = new JsonObject();<br/>  msg.put("action", "routes");<br/>  msg.put("routes", arr);<br/>  response<br/>          .setStatusCode(200)<br/>          .putHeader("content-type", <br/>            "application/json; charset=utf-8")<br/>          .end(msg.encodePrettily());<br/>}<br/>...</span><span id="5b2b" class="nf lw iq lu b gy nk nh l ni nj">public List&lt;AirPath&gt; getRoutes(String src, String dst, int connections) <br/>{<br/>  String query = ROUTE_QUERY.replace("ccc", "1.." + connections);<br/>  List&lt;AirPath&gt; airpaths = new ArrayList&lt;AirPath&gt;();<br/>  HashMap&lt;String, Object&gt; params = new HashMap&lt;String, Object&gt;();<br/>  params.put("source", src);<br/>  params.put("destination", dst);<br/>  try<br/>  {<br/>    Result r = m_session.run(query, params);<br/>    r.stream().forEach(record -&gt; {<br/>      record.fields().forEach(p -&gt; {<br/>        AirPath airpath = new AirPath();<br/>        p.value().asList().forEach(n -&gt; {<br/>          InternalRelationship rel = (InternalRelationship)n;<br/>          String source = rel.get("source").asString();<br/>          String destination = rel.get("destination").asString();<br/>          String airline = rel.get("airline").asString();<br/>          Route rte = new Route(source, destination, airline);<br/>          airpath.add(rte);<br/>        });<br/>        airpaths.add(airpath);<br/>      });<br/>    });<br/>  } catch (Exception e) {<br/>    m_logger.error("Route query error {}", query, e);<br/>  }<br/>  return airpaths;<br/>}</span></pre><p id="8bd8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上述路由查询的密码如下所示:</p><pre class="kx ky kz la gt nb lu nc nd aw ne bi"><span id="ba93" class="nf lw iq lu b gy ng nh l ni nj">String ROUTE_QUERY = "MATCH p=(src:Airport {code:$source})-[r:Connects*ccc]-&gt;(dst:Airport {code:$destination})<br/>WITH reduce(output = [], n IN relationships(p) | output + n ) as nodeCollection <br/>RETURN nodeCollection";</span></pre><h1 id="1097" class="lv lw iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">在地图上绘制路线</h1><p id="cbd6" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">使用传单，我们可以在地图上看到这些路线</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/9bdf383db4ad75f52e676dfac6ac1515.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t5NAY2f-clJJgoVMZF8WLg.png"/></div></div></figure><p id="17ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完整的工作演示项目可以在<a class="ae my" href="https://github.com/pvub/demos/tree/master/graph/GraphDemo" rel="noopener ugc nofollow" target="_blank">https://github.com/pvub/demos/tree/master/graph/GraphDemo</a>找到</p><p id="c426" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Neo4j社区服务器可以从<a class="ae my" href="https://neo4j.com/download-center/#community" rel="noopener ugc nofollow" target="_blank">https://neo4j.com/download-center/#community</a>下载</p><p id="b957" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编码快乐！</p></div></div>    
</body>
</html>