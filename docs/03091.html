<html>
<head>
<title>L4 vs L7 Load Balancing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">L4与L7负载平衡</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/l4-vs-l7-load-balancing-d2012e271f56?source=collection_archive---------1-----------------------#2020-04-19">https://levelup.gitconnected.com/l4-vs-l7-load-balancing-d2012e271f56?source=collection_archive---------1-----------------------#2020-04-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="06f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">负载平衡是代理的主要特性之一。负载平衡器在其上运行的层为它提供了不同的功能。L4/L7负载平衡器的这些功能和内部机制将是本文的重点。</p><h1 id="fc7e" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">第4层负载平衡器</h1><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lj"><img src="../Images/c0ba334a52e6bb5431476e336ad0714e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ttz8Pjhn2noTHu5DQzgWXg.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">TCP/UDP直通L4负载平衡器</figcaption></figure><p id="41eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">顾名思义，L4工作在OSI模型的第4层(和第3层)。当客户端发出请求时，它会创建一个与负载平衡器的TCP连接。然后，负载平衡器使用客户机用它创建的同一TCP连接来连接一个上游服务器。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/41c37ee233cfbf44afdee17942ba4756.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*IUCbRTtRSzMoXazlTQwdcA.png"/></div></figure><blockquote class="ma mb mc"><p id="d955" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">传输层添加源端口和目的端口。网络层添加源IP和目的IP(这些层做的远不止这些)</p></blockquote><p id="e579" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，还是有区别的。负载平衡器使用NAT(网络地址转换)更改每个数据包的源和目的IP。</p><pre class="lk ll lm ln gt mh mi mj mk aw ml bi"><span id="fe5c" class="mm km iq mi b gy mn mo l mp mq">Source                 Dest         Source              Dest<br/> ----------- ---------- -------        ------- --------  --------<br/>| Client IP | Segment  | LB IP |  --&gt; | LB IP | Segment | Server |  <br/> ----------- ---------- -------        ------- --------  --------<br/>    Changing source an destination IP for every request packet</span></pre><p id="54c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当收到来自服务器的响应时，负载平衡器会再次执行相同的转换。</p><pre class="lk ll lm ln gt mh mi mj mk aw ml bi"><span id="c1cb" class="mm km iq mi b gy mn mo l mp mq">Source                 Dest         Source              Dest<br/> ----------- ---------- -------        ------- --------  ---------<br/>| Server IP | Segment  | LB IP |  --&gt; | LB IP | Segment | ClientIP |  <br/> ----------- ---------- -------        ------- --------  ---------<br/>    Changing source an destination IP for every response packet</span></pre><blockquote class="ma mb mc"><p id="4606" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">这里是另一种类型的L4负载平衡器，称为TCP/UDP终端负载平衡器，其中有两个不同的TCP连接。</p></blockquote><p id="1e5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用L4负载平衡器时，我们不知道数据。这意味着我们不能根据请求中的数据做出任何决定。我们唯一拥有的是IP(源和目的地)和端口。</p><p id="6f04" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">考虑下面的请求</p><pre class="lk ll lm ln gt mh mi mj mk aw ml bi"><span id="867f" class="mm km iq mi b gy mn mo l mp mq">curl -X GET <a class="ae mr" href="https://integration.gopayapi.com/merchants/v1/payments/S12020030308345Q6MKM1R46RJJB9DU1LIS0MPPR" rel="noopener ugc nofollow" target="_blank">http://apis.pay.com/v1/payments/</a>${paymentId} -H 'Authorization:Basic fdklakglkadskl='</span></pre><p id="99be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设您希望在授权头为空的情况下返回401，或者您希望将调用路由到基于<code class="fe ms mt mu mi b">path</code>的服务。对于L4负载平衡器，这是不可能的，因为您无权访问请求数据。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/e2804ff14fc137b1c509a0e4269c3add.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*0sxS2rUU_BGaXPOvx2ilVg.png"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">保持活动连接</figcaption></figure><p id="8290" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，负载平衡<em class="md">多路复用(HTTP2流)</em>、<em class="md">保持活动状态</em>协议也是一个问题。(多路复用是通过单个连接发送多个请求，保持活动状态是在一段时间内不关闭连接)。考虑这样一种情况，两个客户端<code class="fe ms mt mu mi b">A</code>和<code class="fe ms mt mu mi b">B</code>向具有两个上游服务器<code class="fe ms mt mu mi b">C</code>和<code class="fe ms mt mu mi b">D</code>的负载均衡器发出请求(假设保持活动连接)。假设<code class="fe ms mt mu mi b">A</code>连接到服务器<code class="fe ms mt mu mi b">C</code>，而<code class="fe ms mt mu mi b">B</code>连接到服务器<code class="fe ms mt mu mi b">D</code>。如果<code class="fe ms mt mu mi b">A</code>产生1个RPS而<code class="fe ms mt mu mi b">B</code>产生50个RPS，那么<code class="fe ms mt mu mi b">D</code>比服务器<code class="fe ms mt mu mi b">C</code>多处理50倍的请求，这实际上违背了负载平衡的目的。</p><h2 id="9f74" class="mm km iq bd kn mw mx dn kr my mz dp kv jy na nb kz kc nc nd ld kg ne nf lh ng bi translated">骗局</h2><ol class=""><li id="a893" class="nh ni iq jp b jq nj ju nk jy nl kc nm kg nn kk no np nq nr bi translated">没有智能负载平衡</li><li id="d937" class="nh ni iq jp b jq ns ju nt jy nu kc nv kg nw kk no np nq nr bi translated">不适用于流式/保持活动连接</li><li id="853d" class="nh ni iq jp b jq ns ju nt jy nu kc nv kg nw kk no np nq nr bi translated">没有TLS终止(<em class="md">好坏你决定！</em>)</li></ol><blockquote class="ma mb mc"><p id="2a81" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">L4负载平衡器实际上并不是L4，它们是L3和L4的组合，因此您实际上可以称之为L3/L4负载平衡器。</p></blockquote><h1 id="f52d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">第7层负载平衡器</h1><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/f9c37b4251e0248e1bd81d24d2159419.png" data-original-src="https://miro.medium.com/v2/resize:fit:1154/format:webp/1*ce0nAN9RL88VUPl8bu9NBA.png"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">L7负载平衡器</figcaption></figure><p id="759e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">顾名思义，L7工作在OSI模型的第7层(第6层和第5层)。当客户端发出请求时，它会创建一个与负载平衡器的TCP连接。然后，负载平衡器创建一个与上游服务器之一的新TCP连接。因此，与TCP/UDP直通L4负载平衡器中的1个连接相比，有2个TCP连接。</p><p id="1346" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我们在第7层，所以我们知道请求中的数据。这允许我们执行各种操作，例如</p><ol class=""><li id="0763" class="nh ni iq jp b jq jr ju jv jy ny kc nz kg oa kk no np nq nr bi translated">身份验证— 401，如果某个报头不存在</li><li id="47d5" class="nh ni iq jp b jq ns ju nt jy nu kc nv kg nw kk no np nq nr bi translated">智能路由—将支付呼叫路由到特定的上游</li><li id="d70f" class="nh ni iq jp b jq ns ju nt jy nu kc nv kg nw kk no np nq nr bi translated">TLS终止</li></ol><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/bfc20ae129edf5987c572558f05ac00d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*pEEdaYiHfpnzBBNmg_dCfw.png"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">保持活动连接</figcaption></figure><p id="5b15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在多路复用/保持活动协议的情况下，L7负载均衡器工作起来很有魅力。L7负载平衡器为单个客户端连接创建与每个上游的TCP连接，而不是选择单个上游。这意味着当<code class="fe ms mt mu mi b">A</code>创建与负载平衡器的连接时，负载平衡器创建两个连接，一个与<code class="fe ms mt mu mi b">C</code>连接，一个与<code class="fe ms mt mu mi b">D</code>连接。</p><blockquote class="ma mb mc"><p id="d97d" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">L7负载平衡器实际上不是L7，它们是L5、L6和L7的组合，因此您实际上可以称它们为L5到L7负载平衡器。</p></blockquote><h1 id="2dcd" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">演示</h1><p id="0c2f" class="pw-post-body-paragraph jn jo iq jp b jq nj js jt ju nk jw jx jy oc ka kb kc od ke kf kg oe ki kj kk ij bi translated">对于演示，我将使用<a class="ae mr" href="https://www.envoyproxy.io/" rel="noopener ugc nofollow" target="_blank">特使代理</a>来演示一个简单的例子。</p><blockquote class="of"><p id="2878" class="og oh iq bd oi oj ok ol om on oo kk dk translated">如果请求中没有授权头，则返回401。如果请求路径匹配/ping，则获得Pong响应。应该忽略所有其他路径。401应该在到达服务之前返回。</p></blockquote><p id="8a79" class="pw-post-body-paragraph jn jo iq jp b jq op js jt ju oq jw jx jy or ka kb kc os ke kf kg ot ki kj kk ij bi translated">为了在本地运行envoy，我们将使用docker。下面是Dockerfile和envoy配置的样子。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="ou ov l"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">Dockerfile文件</figcaption></figure><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="ou ov l"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">特使. yaml</figcaption></figure><p id="0801" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们创建一个基本的乒乓应用程序</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="ou ov l"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">乒乓球应用程序</figcaption></figure><blockquote class="ma mb mc"><p id="c6aa" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">您可以使用docker文件在本地构建docker映像，也可以使用我已经在docker hub上推送的映像</p></blockquote><pre class="lk ll lm ln gt mh mi mj mk aw ml bi"><span id="7273" class="mm km iq mi b gy mn mo l mp mq">Now let's run the docker container using the following command</span><span id="8e10" class="mm km iq mi b gy ow mo l mp mq">docker run -p 80:80 mohak1712/envoy</span></pre><p id="cebf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦应用程序和特使运行，我们可以做一个基本的curl请求</p><div class="lk ll lm ln gt ab cb"><figure class="ox lo oy oz pa pb pc paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><img src="../Images/57bbe072edbeb42905fe241c7f686572.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/1*cJ8Kn5apK2rMv5wwS2kDQg.png"/></div></figure><figure class="ox lo pd oz pa pb pc paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><img src="../Images/3a3df158cdc78c7cb2555d01ab785528.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*uifz9Qgwkc6s_Y7aO0pp1g.png"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk pe di pf pg translated">200和401响应代码</figcaption></figure></div><div class="ab cb"><figure class="ox lo ph oz pa pb pc paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><img src="../Images/8c58a9f6c53f261e17c39a16411f55b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:930/format:webp/1*ehh2EGPJ6n5-6AQ0vAQMxQ.png"/></div></figure><figure class="ox lo pi oz pa pb pc paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><img src="../Images/fe2ff0aaa0e11f5b2b4726218f9ae9a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/1*50BE9-4NOXOGuw9WNfwl9w.png"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk pj di pk pg translated">404和401响应代码</figcaption></figure></div><p id="c007" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有输出中有一个有趣的日志是<code class="fe ms mt mu mi b">Connection #0 to the host localhost left intact.</code>,它使客户端能够对其他请求使用相同的连接。</p><blockquote class="ma mb mc"><p id="94d2" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">请记住，您的连接是与特使，而不是与您的后端服务器。</p></blockquote><p id="bfaa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了测试保活连接，我将在两个不同的端口上启动java服务器，更新envoy.yaml以将两个服务器都包含在集群中，并返回端口作为响应。</p><pre class="lk ll lm ln gt mh mi mj mk aw ml bi"><span id="09f3" class="mm km iq mi b gy mn mo l mp mq">clusters:<br/>- name: ping_pong_service<br/>  connect_timeout: 0.25s<br/>  type: strict_dns<br/>  lb_policy: round_robin<br/>  hosts: [{ socket_address: { address: host.docker.internal,  port_value: 8080 }},{ socket_address: { address: host.docker.internal, port_value: 8181 }}]</span></pre><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi pl"><img src="../Images/b6951aba712e6866d8f048e2a8aad80b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rFamiqVb25k0tSyV4075SQ.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">保持活动连接</figcaption></figure><p id="2217" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你注意到我们从两个不同的服务器得到响应[响应-&gt; 8080，8081]。因此，即使在保活连接上，请求也分布在上游服务中。(后端服务器)。</p><p id="3db1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">差不多就是这样！感谢您的阅读，我希望您喜欢这篇文章。如果你真的为它鼓掌了:)</p><p id="8059" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，我强烈推荐阅读这篇<a class="ae mr" href="https://blog.envoyproxy.io/introduction-to-modern-network-load-balancing-and-proxying-a57f6ff80236" rel="noopener ugc nofollow" target="_blank">文章</a></p><p id="459a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">也可以在<a class="ae mr" href="https://medium.com/@mohak1712" rel="noopener">中</a>和<a class="ae mr" href="https://github.com/mohak1712" rel="noopener ugc nofollow" target="_blank"> Github </a>上关注我。🙂</p></div></div>    
</body>
</html>