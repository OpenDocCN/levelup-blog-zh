<html>
<head>
<title>Building a Flutter Computer Vision App Using Dart:ffi, OpenCV, and Tensorflow (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dart构建颤振计算机视觉应用程序:ffi、OpenCV和Tensorflow(第1部分)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/building-a-flutter-computer-vision-app-using-dart-ffi-opencv-and-tensorflow-part-1-513dac9325ab?source=collection_archive---------0-----------------------#2022-01-23">https://levelup.gitconnected.com/building-a-flutter-computer-vision-app-using-dart-ffi-opencv-and-tensorflow-part-1-513dac9325ab?source=collection_archive---------0-----------------------#2022-01-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e951" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">这是解释如何使用dart:ffi、OpenCV和Tensorflow在Flutter中编写计算机视觉应用程序的三部分系列的第一部分。</h2></div><p id="06ca" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一部分讨论了如何正确配置OpenCV库和我们的定制C++文件以在Flutter应用程序中工作，以及如何通过dart:ffi从Dart访问这些C++文件。</p><p id="7fd3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://medium.com/@jeffrey.wolberg/building-a-flutter-computer-vision-app-using-dart-ffi-opencv-and-tensorflow-part-2-81472b4ac380" rel="noopener"> <strong class="kh ir">第二部分</strong> </a> <strong class="kh ir">讨论如何使用dart:ffi库使用指针在Dart和C++之间传递数据。这对于将图像数据传输到C++来说尤其重要，这样它就可以被OpenCV操作并返回到Dart。</strong></p><p id="958c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://medium.com/@jeffrey.wolberg/building-a-flutter-computer-vision-app-using-dart-ffi-opencv-and-tensorflow-part-3-8e3a1182250b" rel="noopener"> <strong class="kh ir">第三部分</strong> </a> <strong class="kh ir">讨论如何使用tflite_flutter插件在Flutter应用程序中使用tensorflow。我们将通过适当的配置，常见的错误，以及如何在我们的设备上运行推理。</strong></p><p id="be7e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意:本教程只包括iOS的配置，并且已经在M1 mac上测试过。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/f6021a5355d99ea7a8abf5a7ff3af46d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z-ao-EkG3iq5e2M1eZ0SHw.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Sudoku Cam，一个用C++实现的使用OpenCV的计算机视觉颤振app</figcaption></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h2 id="9282" class="lz ma iq bd mb mc md dn me mf mg dp mh ko mi mj mk ks ml mm mn kw mo mp mq mr bi translated">在Xcode中配置OpenCV</h2><p id="c693" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">为了在我们的应用中使用OpenCV，我们必须有一个opencv <strong class="kh ir">。框架'</strong>文件，这是一个包含库的头文件以及用于静态链接的二进制文件的包。这里面有很多行话，但这只是意味着苹果需要一种方法来访问OpenCV资源，同时运行应用程序。</p><p id="c73c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在这里阅读更多关于苹果框架的内容:<a class="ae lb" href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPFrameworks/Concepts/WhatAreFrameworks.html" rel="noopener ugc nofollow" target="_blank">https://developer . apple . com/library/archive/documentation/ma cosx/Conceptual/BP frameworks/Concepts/whatareframeworks . html</a></p><p id="872c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">得到这个。“框架”文件，前往<a class="ae lb" href="https://opencv.org/releases/" rel="noopener ugc nofollow" target="_blank">https://opencv.org/releases/</a>下载<strong class="kh ir"> iOS包</strong>。解压后，将<strong class="kh ir"><em class="mx">opencv 2 . framework</em></strong>文件夹放在你的<strong class="kh ir"><em class="mx">PROJECT _ DIR/IOs</em></strong>文件夹中。</p><p id="0781" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要让Xcode链接到应用程序，请前往<strong class="kh ir"><em class="mx">PROJECT _ DIR/IOs/runner . Xcode proj</em></strong>并点击<strong class="kh ir">构建阶段</strong>。然后，在<strong class="kh ir"> Link Binary With Libraries </strong>选项卡下，添加之前添加的<strong class="kh ir"><em class="mx">opencv 2 . framework</em></strong>文件夹。见下图。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi my"><img src="../Images/5cbed03f234cd425e935b92ba35c8036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tkHjqy1rZYWf0YH7l0e7Cg.jpeg"/></div></div></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="19d1" class="mz ma iq bd mb na nb nc me nd ne nf mh jw ng jx mk jz nh ka mn kc ni kd mq nj bi translated">编写和链接我们的C++代码</h1><p id="1238" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">让我们测试一下我们的OpenCV库是否可以被我们的应用程序访问。为此，我们将编写一个简单的C++函数，该函数将在构建我们的应用程序时编译。然后，我们将使用dart:ffi包从我们的flutter应用程序访问它。</p><p id="8a94" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">了解如何使用dart:ffi的最佳和最详细的来源是<a class="ae lb" href="https://docs.flutter.dev/development/platform-integration/c-interop" rel="noopener ugc nofollow" target="_blank">官方文档</a>。下面我将向您展示最重要的步骤:</p><p id="520d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们编写一个小的C++函数来测试我们是否可以从我们的Flutter应用程序成功访问OpenCV:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nk"><img src="../Images/2446fb15ca9605feeb1e988f5e09aac7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SvAPhYxJrU1g-COZbBvbbw.jpeg"/></div></div></figure><p id="b912" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在第3行，你可能会问为什么这些符号是必要的。根据官方文件:</p><blockquote class="nl nm nn"><p id="c1bf" class="kf kg mx kh b ki kj jr kk kl km ju kn no kp kq kr np kt ku kv nq kx ky kz la ij bi translated">FFI库只能绑定C符号，所以在C++中这些符号必须标记<code class="fe nr ns nt nu b">extern C</code>。添加的其他属性防止链接器在链接时优化期间丢弃符号。</p></blockquote><p id="38be" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了确保XCode在构建时编译我们的C++函数，直接进入<strong class="kh ir"><em class="mx">PROJECT _ DIR/IOs/runner . XCode proj</em></strong>并点击<strong class="kh ir">构建阶段</strong>。然后，在<strong class="kh ir">编译源</strong>选项卡下，添加。我们刚刚创建的cpp文件。这叫做<em class="mx">静态链接</em>。见下图。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nv"><img src="../Images/f2dc83f062785f4ed4c7a7ef130b3539.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3NlVclXOCx-UcoEHQJTPKA.jpeg"/></div></div></figure><p id="4a4f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们必须更改Xcode中的另一个配置设置，以便以后能够访问我们的C++代码。</p><p id="636c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">进入<strong class="kh ir"><em class="mx">PROJECT _ DIR/IOs/runner . xcode proj</em></strong>，点击<strong class="kh ir">构建设置。</strong>滚动到<strong class="kh ir">部署</strong>部分，将<strong class="kh ir">条形样式</strong>字段从“所有符号”更改为“非全局符号”。参见GitHub评论了解更多关于为什么这是必要的信息。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nw"><img src="../Images/67c94acd2eb0d4a3ca2a70cfac6aa0b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GqWX2VYkjvqJXotJUF_q7Q.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">更改Xcode中的“条形样式”栏</figcaption></figure><h1 id="5b39" class="mz ma iq bd mb na nx nc me nd ny nf mh jw nz jx mk jz oa ka mn kc ob kd mq nj bi translated">在Dart中访问我们的C++代码</h1><p id="4f8a" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">现在我们将开始用Dart写作。</p><p id="90c6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将dart:ffi包添加到您的pubspec.yaml中，方法是在您的项目文件夹中运行以下命令，或者访问<a class="ae lb" href="https://pub.dev/packages/ffi/install" rel="noopener ugc nofollow" target="_blank">https://pub.dev/packages/ffi/install</a>并找到一个定制版本放在您的pubspec.yaml文件中</p><pre class="ld le lf lg gt oc nu od oe aw of bi"><span id="f3e3" class="lz ma iq nu b gy og oh l oi oj">flutter pub add ffi</span></pre><p id="0038" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">太好了！在我们的Dart代码中，我们必须获得动态库，从中我们将访问我们的自定义C++函数。</p><pre class="ld le lf lg gt oc nu od oe aw of bi"><span id="e271" class="lz ma iq nu b gy og oh l oi oj">import 'dart:ffi'; // For FFI<br/>import 'dart:io'; // For Platform.isX<br/><br/>final DynamicLibrary nativeAddLib = Platform.isAndroid<br/>    ? DynamicLibrary.open('libnative_add.so')<br/>    : DynamicLibrary.process();</span></pre><p id="04ee" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，通过编写以下内容来加载该函数:</p><pre class="ld le lf lg gt oc nu od oe aw of bi"><span id="c5fe" class="lz ma iq nu b gy og oh l oi oj">final int Function(int x, int y) testFunction = nativeAddLib<br/>    .lookup&lt;NativeFunction&lt;Int32 Function(Int32, Int32)&gt;&gt;('testFunction')<br/>    .asFunction();</span></pre><p id="86f3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，你可以调用它！</p><pre class="ld le lf lg gt oc nu od oe aw of bi"><span id="5f18" class="lz ma iq nu b gy og oh l oi oj">int output = testFunction(100, 100);</span></pre><p id="455b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您应该能够在您的Flutter应用程序中看到输出。万岁！这意味着你可以通过C++从你的Flutter应用程序中访问OpenCV函数的完整套件。</p><p id="3450" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在下一个教程的<a class="ae lb" href="https://medium.com/@jeffrey.wolberg/building-a-flutter-computer-vision-app-using-dart-ffi-opencv-and-tensorflow-part-2-81472b4ac380" rel="noopener">中，我们将学习如何使用dart:ffi通过指针在C++中来回传递数据。这对于将图像数据传输到C++来说尤其重要，这样它就可以被OpenCV操作并返回到Dart。</a></p><p id="ddd2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">干杯！</p></div></div>    
</body>
</html>