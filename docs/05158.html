<html>
<head>
<title>How to write Django queries that are 35 times faster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何编写快35倍的Django查询</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/optimizing-django-queries-28e96ad204de?source=collection_archive---------0-----------------------#2020-08-08">https://levelup.gitconnected.com/optimizing-django-queries-28e96ad204de?source=collection_archive---------0-----------------------#2020-08-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="dbeb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用批量查询、预加载外键等。</h2></div><h1 id="8f8d" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">动机</h1><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/9edb677ef4bed7072177d8d4300eccb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZuKMy_SmxOHVbvxnmO0fvg.jpeg"/></div></div></figure><p id="e656" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">你是否已经完成了下一个Django Web应用程序，但它运行得太慢了？现在你认为你应该选择C++或者Java？来吧，没什么好担心的，对你的代码进行一些重构可能会让你的应用程序快两倍！</p><p id="e702" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">例如，您可以一次插入1000个对象，而不是逐个插入对象。另一个例子是通过外键获取数据——它每次都命中数据库。你可以预先加载所有需要的数据，你知道吗？</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h2 id="d8fa" class="mp kj it bd kk mq mr dn ko ms mt dp ks lv mu mv ku lz mw mx kw md my mz ky na bi translated">准备</h2><p id="a507" class="pw-post-body-paragraph lm ln it lo b lp nb ju lr ls nc jx lu lv nd lx ly lz ne mb mc md nf mf mg mh im bi translated">我们将在这里玩两个非常简单的模型:</p><pre class="lb lc ld le gt ng nh ni nj aw nk bi"><span id="e963" class="mp kj it nh b gy nl nm l nn no"><strong class="nh iu">class </strong>Student(models.Model):<br/>    first_name = models.CharField(max_length=100)<br/>    last_name = models.CharField(max_length=100)<br/><br/><br/><strong class="nh iu">class </strong>Grade(models.Model):<br/>    student = models.ForeignKey(Student, on_delete=models.CASCADE)<br/>    course = models.CharField(max_length=100)<br/>    grade = models.IntegerField(default=0)</span></pre><p id="4190" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">所以，我们有很多学生，这些学生有一些成绩。没有比这更简单的了。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h2 id="bc38" class="mp kj it bd kk mq mr dn ko ms mt dp ks lv mu mv ku lz mw mx kw md my mz ky na bi translated">分析你的疑问</h2><p id="3bd1" class="pw-post-body-paragraph lm ln it lo b lp nb ju lr ls nc jx lu lv nd lx ly lz ne mb mc md nf mf mg mh im bi translated">首先，您需要看到与数据库的所有交互。也就是说，当您查询一些数据时，我们希望看到Django进行的所有SQL查询。</p><p id="9ece" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">为此，请转到您的<em class="np"> settings.py </em>并添加以下代码:</p><pre class="lb lc ld le gt ng nh ni nj aw nk bi"><span id="ec1a" class="mp kj it nh b gy nl nm l nn no">LOGGING = {<br/>    <strong class="nh iu">'version'</strong>: 1,<br/>    <strong class="nh iu">'disable_existing_loggers'</strong>: <strong class="nh iu">False</strong>,<br/>    <strong class="nh iu">'handlers'</strong>: {<br/>        <strong class="nh iu">'file'</strong>: {<br/>            <strong class="nh iu">'level'</strong>: <strong class="nh iu">'DEBUG'</strong>,<br/>            <strong class="nh iu">'class'</strong>: <strong class="nh iu">'logging.FileHandler'</strong>,<br/>            <strong class="nh iu">'filename'</strong>: <strong class="nh iu">'sql.log'</strong>,<br/>        },<br/>    },<br/>    <strong class="nh iu">'loggers'</strong>: {<br/>        <strong class="nh iu">'django.db.backends'</strong>: {<br/>            <strong class="nh iu">'handlers'</strong>: [<strong class="nh iu">'file'</strong>],<br/>            <strong class="nh iu">'level'</strong>: <strong class="nh iu">'DEBUG'</strong>,<br/>            <strong class="nh iu">'propagate'</strong>: <strong class="nh iu">True</strong>,<br/>        },<br/>    },<br/>}</span></pre><p id="78da" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">就是这样。现在，所有与数据库的交互都将存储在<em class="np"> sql.log </em>文件中。</p><p id="a70a" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">比如，我们添加一些学生，看看<em class="np"> sql.log </em>里都写了什么。</p><pre class="lb lc ld le gt ng nh ni nj aw nk bi"><span id="a840" class="mp kj it nh b gy nl nm l nn no">student = Student()<br/>student.first_name = <strong class="nh iu">"1"<br/></strong>student.last_name = <strong class="nh iu">"2"<br/></strong>student.save()</span></pre><p id="a30f" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">这是日志:</p><pre class="lb lc ld le gt ng nh ni nj aw nk bi"><span id="0423" class="mp kj it nh b gy nl nm l nn no">(<strong class="nh iu"><em class="np">0</em></strong>.<strong class="nh iu"><em class="np">002</em></strong>) INSERT INTO <strong class="nh iu">"student_student"</strong> (<strong class="nh iu">"first_name"</strong>, <strong class="nh iu">"last_name"</strong>) VALUES (<strong class="nh iu">'1'</strong>, <strong class="nh iu">'2'</strong>); args=[<strong class="nh iu">'1'</strong>, <strong class="nh iu">'2'</strong>]</span></pre><p id="f21c" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我们可以看到插入学生和查询数据所花费的时间。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h2 id="239b" class="mp kj it bd kk mq mr dn ko ms mt dp ks lv mu mv ku lz mw mx kw md my mz ky na bi translated">批量插入</h2><p id="38ee" class="pw-post-body-paragraph lm ln it lo b lp nb ju lr ls nc jx lu lv nd lx ly lz ne mb mc md nf mf mg mh im bi translated">让我们尝试插入1000名学生，每个学生有10个年级:</p><pre class="lb lc ld le gt ng nh ni nj aw nk bi"><span id="d578" class="mp kj it nh b gy nl nm l nn no"><strong class="nh iu">for </strong>i <strong class="nh iu">in </strong>range(1000):<br/>    student = Student()<br/>    student.first_name = str(i)<br/>    student.last_name = str(i)<br/>    student.save()<br/>    <strong class="nh iu">for </strong>j <strong class="nh iu">in </strong>range(10):<br/>        grade = Grade()<br/>        grade.student = student<br/>        grade.course = <strong class="nh iu">"Math"<br/>        </strong>grade.grade = j*10<br/>        grade.save()</span></pre><p id="93b7" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">完成花费了<strong class="lo iu"> 9.45 </strong>秒，并且在日志文件中有<strong class="lo iu"> 11000 </strong>行。</p><p id="4ffc" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">现在批量做同样的事情:</p><pre class="lb lc ld le gt ng nh ni nj aw nk bi"><span id="8d67" class="mp kj it nh b gy nl nm l nn no">students = []<br/>grades = []<br/>batch_size = 500<br/><strong class="nh iu">for </strong>i <strong class="nh iu">in </strong>range(1000):<br/>    student = Student()<br/>    student.first_name = str(i)<br/>    student.last_name = str(i)<br/>    students.append(student)<br/>Student.objects.bulk_create(students, batch_size)</span><span id="f69f" class="mp kj it nh b gy nq nm l nn no"><strong class="nh iu">for </strong>student <strong class="nh iu">in </strong>Student.objects.all():<br/>    <strong class="nh iu">for </strong>j <strong class="nh iu">in </strong>range(10):<br/>        grade = Grade()<br/>        grade.student = student<br/>        grade.course = <strong class="nh iu">"Math"<br/>        </strong>grade.grade = j*10<br/>        grades.append(grade)<br/>Grade.objects.bulk_create(grades, batch_size)</span></pre><p id="d769" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">你不会相信，但它花了<strong class="lo iu"> 0.26 </strong>秒，日志由<strong class="lo iu"> 5 </strong>行组成！</p><p id="6887" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">所以，大约是<strong class="lo iu"> 35 <em class="np">倍</em>快</strong>！！！即使我们为中间的学生做一个额外的查询！</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="f24a" class="ki kj it bd kk kl nr kn ko kp ns kr ks jz nt ka ku kc nu kd kw kf nv kg ky kz bi translated">批量更新</h1><p id="ed13" class="pw-post-body-paragraph lm ln it lo b lp nb ju lr ls nc jx lu lv nd lx ly lz ne mb mc md nf mf mg mh im bi translated">很好，更新呢？比如说，我们想让所有的分数都等于100:</p><pre class="lb lc ld le gt ng nh ni nj aw nk bi"><span id="5cda" class="mp kj it nh b gy nl nm l nn no">grades = Grade.objects.all()<br/><strong class="nh iu">for </strong>grade <strong class="nh iu">in </strong>grades:<br/>    grade.grade = 100<br/>    grade.save()</span></pre><p id="82bd" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">更新用了<strong class="lo iu"> 0.455 </strong>秒。对于10 000条记录和一个SQLite数据库来说已经不错了:)</p><p id="426e" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">好，让我们试试批量更新:</p><pre class="lb lc ld le gt ng nh ni nj aw nk bi"><span id="0953" class="mp kj it nh b gy nl nm l nn no">batch_size = 500<br/>grades = Grade.objects.all()<br/><strong class="nh iu">for </strong>grade <strong class="nh iu">in </strong>grades:<br/>    grade.grade = 100<br/>Grade.objects.bulk_update(grades, [<strong class="nh iu">'grade'</strong>], batch_size=batch_size)</span></pre><p id="2d76" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">用了0.11秒！<strong class="lo iu"> <em class="np">快五倍！耶！</em> </strong></p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="66d6" class="ki kj it bd kk kl nr kn ko kp ns kr ks jz nt ka ku kc nu kd kw kf nv kg ky kz bi translated"><strong class="ak">预加载数据(选择相关)</strong></h1><p id="6d96" class="pw-post-body-paragraph lm ln it lo b lp nb ju lr ls nc jx lu lv nd lx ly lz ne mb mc md nf mf mg mh im bi translated">让我们遍历所有记录并打印出每个学生的每个分数:</p><pre class="lb lc ld le gt ng nh ni nj aw nk bi"><span id="2805" class="mp kj it nh b gy nl nm l nn no">grades = Grade.objects.all()<br/><strong class="nh iu">for </strong>grade <strong class="nh iu">in </strong>grades:<br/>    print(<strong class="nh iu">f"The student {</strong>grade.student.first_name<strong class="nh iu">} has got {</strong>grade.grade<strong class="nh iu">}%"</strong>)</span></pre><p id="0c09" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated"><strong class="lo iu"> <em class="np"> 4.9秒，10 000次查询！</em>T29】</strong></p><p id="cff0" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">你可能不会相信，但在代码中添加几个符号会使同样的事情在<strong class="lo iu"> <em class="np"> 0.19秒内完成:</em> </strong></p><pre class="lb lc ld le gt ng nh ni nj aw nk bi"><span id="6d2f" class="mp kj it nh b gy nl nm l nn no">grades = Grade.objects.select_related(<strong class="nh iu">"student"</strong>).all()<br/><strong class="nh iu">for </strong>grade <strong class="nh iu">in </strong>grades:<br/>    print(<strong class="nh iu">f"The student {</strong>grade.student.first_name<strong class="nh iu">} has got {</strong>grade.grade<strong class="nh iu">}%"</strong>)</span></pre><p id="85d9" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">它只做了一个选择查询！</p><p id="db93" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">这个想法是，所有相关数据也在同一个查询中提取。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="cacf" class="ki kj it bd kk kl nr kn ko kp ns kr ks jz nt ka ku kc nu kd kw kf nv kg ky kz bi translated">批量选择</h1><p id="bd9e" class="pw-post-body-paragraph lm ln it lo b lp nb ju lr ls nc jx lu lv nd lx ly lz ne mb mc md nf mf mg mh im bi translated">在前面的示例中，您可能希望在单独的查询中查询一些学生。比如说，我们想让所有的学生在任何一门课程中都得100分。在我们的情况下，我们得到所有的学生，但我们不在乎。</p><p id="f44b" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">请注意，我们在这里不使用“select_related ”:</p><pre class="lb lc ld le gt ng nh ni nj aw nk bi"><span id="d942" class="mp kj it nh b gy nl nm l nn no">ids = []<br/>grades = Grade.objects.all()<br/><strong class="nh iu">for </strong>grade <strong class="nh iu">in </strong>grades:<br/>    <strong class="nh iu">if </strong>grade.grade == 100:<br/>        ids.append(grade.student_id)<br/>students = Student.objects.in_bulk(ids)<br/><strong class="nh iu">for </strong>student <strong class="nh iu">in </strong>students:<br/>    print(student.first_name, student.last_name)</span></pre><p id="cc13" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">这段代码的运行时间也是0.19秒。</p><p id="d12e" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">因此，您收集所有需要的id并在一个查询中传递它们。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h2 id="af3c" class="mp kj it bd kk mq mr dn ko ms mt dp ks lv mu mv ku lz mw mx kw md my mz ky na bi translated">奖金</h2><p id="45c6" class="pw-post-body-paragraph lm ln it lo b lp nb ju lr ls nc jx lu lv nd lx ly lz ne mb mc md nf mf mg mh im bi translated">通过这些文章，您可以让您的应用程序运行得更快:</p><div class="nw nx gp gr ny nz"><a rel="noopener  ugc nofollow" target="_blank" href="/just-one-index-in-django-makes-your-app-15x-faster-742e2f13108e"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">Django中的一个索引就能让您的应用速度提高15倍！</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">你的应用有了索引会快多少？</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on lk nz"/></div></div></a></div><p id="790a" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated"><strong class="lo iu"> <em class="np">如何用Django </em> </strong>生成并提供PDF文件</p><div class="nw nx gp gr ny nz"><a href="https://python.plainenglish.io/generate-and-serve-pdf-files-with-django-e3efd9fde7bc" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">如何用Django生成和提供PDF文件</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">如何在Django中生成PDF报告</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">python .平原英语. io</p></div></div><div class="oi l"><div class="oo l ok ol om oi on lk nz"/></div></div></a></div><p id="7798" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated"><strong class="lo iu"> <em class="np"> Django:读模型比缓存好</em> </strong></p><div class="nw nx gp gr ny nz"><a rel="noopener  ugc nofollow" target="_blank" href="/django-read-models-are-better-than-cache-9e0d11d6b835"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">Django:读模型比缓存好</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">什么是读取模型，如何在Django中使用它们？</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="oi l"><div class="op l ok ol om oi on lk nz"/></div></div></a></div><p id="9b48" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated"><strong class="lo iu"> <em class="np"> Django管理堆叠内联示例:多对一关系</em> </strong></p><div class="nw nx gp gr ny nz"><a rel="noopener  ugc nofollow" target="_blank" href="/django-admin-stacked-inline-example-many-to-many-relations-e81ae4b59f51"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">Django管理堆叠内联示例:多对多关系</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">你如何把几样东西加入购物车？</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="oi l"><div class="oq l ok ol om oi on lk nz"/></div></div></a></div><p id="c9ad" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated"><strong class="lo iu"> <em class="np">为什么以及如何用Python写冻结的数据类</em> </strong></p><div class="nw nx gp gr ny nz"><a href="https://python.plainenglish.io/why-and-how-to-write-frozen-dataclasses-in-python-69050ad5c9d4" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">为什么以及如何用Python编写冻结的数据类</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">冻结和非冻结数据类的区别。</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">python .平原英语. io</p></div></div><div class="oi l"><div class="or l ok ol om oi on lk nz"/></div></div></a></div></div></div>    
</body>
</html>