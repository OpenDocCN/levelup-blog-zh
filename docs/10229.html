<html>
<head>
<title>How to Secure S3 Objects Using a Presigned URL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用预先设计的URL保护S3对象</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-secure-s3-objects-using-a-presigned-url-ea2b0c57ae86?source=collection_archive---------5-----------------------#2021-11-09">https://levelup.gitconnected.com/how-to-secure-s3-objects-using-a-presigned-url-ea2b0c57ae86?source=collection_archive---------5-----------------------#2021-11-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5841d4adbccbb78695847576eb39ad70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Su_uqZVJh8_DufNEo8wVTA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">格伦·卡斯滕斯-彼得斯在<a class="ae kc" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="5ec8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设我们需要公开一个API，客户端可以上传一个图像文件到S3，后端服务器需要发送回带有S3对象URL的响应。我们如何才能安全地实现这一点，而不暴露我们的S3桶网址给公众？我写这篇文章是为了解释我们如何利用<a class="ae kc" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/ShareObjectPreSignedURL.html" rel="noopener ugc nofollow" target="_blank"> AWS预先设计的URL</a>来完成上述任务。</p><blockquote class="lb lc ld"><p id="9aa2" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">如果我们的头脑充满了问题，我们将通过更快地解决它们来更快地进化。</p></blockquote><h1 id="8190" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">先决条件</h1><ol class=""><li id="7050" class="mg mh iq kf b kg mi kk mj ko mk ks ml kw mm la mn mo mp mq bi translated">S3自动气象站的基本知识</li><li id="2690" class="mg mh iq kf b kg mr kk ms ko mt ks mu kw mv la mn mo mp mq bi translated">任何编程语言(这里使用Python)</li><li id="7c19" class="mg mh iq kf b kg mr kk ms ko mt ks mu kw mv la mn mo mp mq bi translated">想不出别的:)</li></ol><h1 id="54bc" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">为什么需要预先设计的网址？</h1><p id="dabf" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">大多数公司广泛使用亚马逊AWS S3(简单存储服务)来存储持久且易于访问的对象、文件或更多数据。我们可以轻松地将AWS S3桶与几乎任何现代基础设施集成，如移动应用程序、web应用程序等。如果我们在基础设施中使用S3，我们需要将安全URL返回给S3对象，这样，如果有人试图窃取该URL并访问S3对象，那么它自己会在一段时间后过期。为了制作这个安全的网址，S3提供了所谓的<a class="ae kc" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/ShareObjectPreSignedURL.html" rel="noopener ugc nofollow" target="_blank">预签名网址。</a></p><p id="44ba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设我们在S3存储桶上托管了一些文件，我们需要向用户公开这些文件，但是我们不想将存储桶设置为开放(公共)，我们还希望对这些文件的访问保持一些控制，例如通过限制用户可以访问文件的时间范围。我们可以向外界公开我们在S3存储桶中的文件，而不公开存储桶，而是通过在特定时间段内使用预先设计的URL来共享资源。这是一个预先设计好的URL的样子。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="00a4" class="ni lj iq ne b gy nj nk l nl nm"><a class="ae kc" href="https://bucket.s3.region.amazonaws.com/myfile.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=random-aws-credential-to-identify-the-signature&amp;X-Amz-Date=timestamp-of-generation-of-url&amp;X-Amz-Expires=validity-from-generation-timestamp&amp;X-Amz-Signature=6ffca338f5b248ad89ec4ae462cb46dc&amp;X-Amz-SignedHeaders=host" rel="noopener ugc nofollow" target="_blank">https://bucket.s3.region.amazonaws.com/myfile.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=random-aws-credential-to-identify-the-signer&amp;X-Amz-Date=timestamp-of-generation-of-url&amp;X-Amz-Expires=validity-from-generation-timestamp&amp;X-Amz-Signature=6ffca338-f5b2-48ad-89ec-4ae462cb46dc&amp;X-Amz-SignedHeaders=host</a></span></pre><p id="2196" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">格式化的预签名URL</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="40a9" class="ni lj iq ne b gy nj nk l nl nm"><a class="ae kc" href="https://bucket.s3.region.amazonaws.com/myfile.jpg" rel="noopener ugc nofollow" target="_blank">https://bucket.s3.region.amazonaws.com/myfile.jpg</a> ?<br/>X-Amz-Algorithm     =   AWS4-HMAC-SHA256 &amp;<br/>X-Amz-Credential    =   random-aws-credential-to-identify-the-signature &amp;<br/>X-Amz-Date          =   timestamp-of-generation-of-url &amp;<br/>X-Amz-Expires       =   validity-from-generation-timestamp &amp;<br/>X-Amz-Signature     =   6ffca338f5b248ad89ec4ae462cb46dc &amp;<br/>X-Amz-SignedHeaders =   host</span></pre><p id="aa0c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用AWS SDK功能生成预签名URL的签名头和凭证。当有人试图使用预先指定的URL访问S3文件时，S3将尝试为指定的凭证计算相同的签名，包括可选的<code class="fe nn no np ne b">SignedHeaders</code>参数，并检查签名是否有效以及链接是否尚未过期。</p><h1 id="1e8c" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">使用Python为S3桶生成预先设计的URL</h1><p id="da3f" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">首先，我们来安装Python ie的AWS SDK，<a class="ae kc" href="https://aws.amazon.com/sdk-for-python/" rel="noopener ugc nofollow" target="_blank"> Boto3 </a>。Boto3使我们的python应用程序、库或脚本与AWS服务的集成变得容易，AWS服务包括S3、EC2、Amazon Dynamo DB等。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="82ea" class="ni lj iq ne b gy nj nk l nl nm">pip install boto3</span></pre><p id="e9b2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们可以使用下面的代码片段为我们的S3桶生成预先设计的URL。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="fb61" class="ni lj iq ne b gy nj nk l nl nm">import boto3</span><span id="2434" class="ni lj iq ne b gy nq nk l nl nm">AWS_S3_REGION = 'ap-south-1'<br/>AWS_S3_BUCKET_NAME = "my_s3_bucket"<br/>AWS_S3_FILE_NAME = "my-file.jpg"<br/>PRESIGNED_URL_EXPIRY = 100 <em class="le"># in seconds</em></span><span id="306c" class="ni lj iq ne b gy nq nk l nl nm">s3_client = boto3.client('s3', aws_access_key_id=AWS_ACCESS_KEY_ID, region_name=AWS_S3_REGION, aws_secret_access_key=AWS_SECRET_ACCESS_KEY,)</span><span id="9d2a" class="ni lj iq ne b gy nq nk l nl nm">presigned_url = s3_client.generate_presigned_url('get_object',    Params={"Bucket": AWS_S3_BUCKET_NAME, "Key": AWS_S3_FILE_NAME}, ExpiresIn=PRESIGNED_URL_EXPIRY)<br/></span></pre><h1 id="b4b1" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">我们如何使用预先设计的URL来上传AWS S3桶上的资源？</h1><p id="2bc2" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">我们可以简单地向用动作“put_object”创建的预先设计的URL发出一个PUT请求，文件将被安全地上传到S3。</p><figure class="mz na nb nc gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/567e8a681e92af74e88c2434223f67d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*ELz6PEzVujf7jjolTQes1A.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">使用预先指定的URL将文件上传到S3的框图</figcaption></figure><p id="d611" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们首先使用下面的代码片段创建可以将文件上传到S3的预先设计的URL。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="1345" class="ni lj iq ne b gy nj nk l nl nm">import boto3</span><span id="04cc" class="ni lj iq ne b gy nq nk l nl nm">s3_client = boto3.client('s3', aws_access_key_id=AWS_ACCESS_KEY_ID, region_name=AWS_S3_REGION,aws_secret_access_key=AWS_SECRET_ACCESS_KEY, config=Config(signature_version='s3v4'))</span><span id="4887" class="ni lj iq ne b gy nq nk l nl nm">presigned_url = s3_client.generate_presigned_url('put_object',<br/>Params={"Bucket": AWS_S3_BUCKET_NAME, "Key": AWS_S3_FILE_NAME},<br/>ExpiresIn=PRESIGNED_URL_EXPIRY)</span><span id="0bf0" class="ni lj iq ne b gy nq nk l nl nm">print presigned_url</span></pre><p id="7a58" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们可以使用上面预先设计的URL，并使用下面的代码片段上传文件。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="e019" class="ni lj iq ne b gy nj nk l nl nm">import requests<br/><br/>response = requests.put(presigned_url)</span><span id="b283" class="ni lj iq ne b gy nq nk l nl nm">print "File uploaded successfully!"<br/></span></pre><h1 id="c626" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">问候！🙂</h1><p id="31a0" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">我们已经成功地为我们的S3桶创建了预先设计的URL，现在我们可以安全地与我们的客户共享这个URL。在预先指定的URL过期之前，客户端将能够访问资源。此外，客户端能够上传文件到S3使用预先指定的网址，直到到期时间。</p><figure class="mz na nb nc gt jr gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/061bdb2d73a86604f4ece5ad69d9cd80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*Y7VnrOdMXZ2LyxAbYIuufw.gif"/></div></figure><ul class=""><li id="a47d" class="mg mh iq kf b kg kh kk kl ko nt ks nu kw nv la nw mo mp mq bi translated"><em class="le">我们可以使用预先设计的URL来生成一个可用于访问我们的S3桶的URL。</em></li><li id="a1aa" class="mg mh iq kf b kg mr kk ms ko mt ks mu kw mv la nw mo mp mq bi translated"><em class="le">当我们创建一个预先设计好的URL并将其与一个特定的动作相关联时。</em></li><li id="0547" class="mg mh iq kf b kg mr kk ms ko mt ks mu kw mv la nw mo mp mq bi translated"><em class="le">当我们与任何人共享预签名的URL时，该用户可以执行嵌入在URL中的操作，就像他们是原始签名用户一样。</em></li><li id="e365" class="mg mh iq kf b kg mr kk ms ko mt ks mu kw mv la nw mo mp mq bi translated"><em class="le">该URL将过期，当其过期时，将无法再访问S3文件。</em></li><li id="f632" class="mg mh iq kf b kg mr kk ms ko mt ks mu kw mv la nw mo mp mq bi translated"><em class="le">预签名URL的功能仅限于实际创建预签名URL的用户的权限。</em></li></ul><h1 id="15fa" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">摘要</h1><p id="fb00" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">为了这篇文章的完整性，让我们快速回顾一下到目前为止我们所学的内容。</p><ul class=""><li id="0765" class="mg mh iq kf b kg kh kk kl ko nt ks nu kw nv la nw mo mp mq bi translated">了解到每次都创建S3桶公共是不安全的。</li><li id="36dc" class="mg mh iq kf b kg mr kk ms ko mt ks mu kw mv la nw mo mp mq bi translated">了解到不是后端服务器只能上传文件到S3，而是通过使用预先设计的URL客户端也可以上传文件到S3。</li><li id="7136" class="mg mh iq kf b kg mr kk ms ko mt ks mu kw mv la nw mo mp mq bi translated">我们了解了如何使用预先设计的URL安全地与我们的客户共享S3文件。</li><li id="9f74" class="mg mh iq kf b kg mr kk ms ko mt ks mu kw mv la nw mo mp mq bi translated">我们学会了如何将上传文件到S3的责任交给客户。</li></ul><blockquote class="nx"><p id="cb98" class="ny nz iq bd oa ob oc od oe of og la dk translated">如果你喜欢这篇文章，别忘了为它鼓掌！</p></blockquote><figure class="oj ok ol om on jr gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/9bedeee671ad5a4b10258bb6404a965d.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/0*OWjJ2kkAlvuKF62s.gif"/></div></figure><p id="3dfe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请随时在<a class="ae kc" href="https://www.linkedin.com/in/shubham-kaushik-temp/" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">Linkedin</strong></a><strong class="kf ir"/>上ping我，敬请期待下一期！</p></div></div>    
</body>
</html>