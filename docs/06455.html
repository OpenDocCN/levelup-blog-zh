<html>
<head>
<title>Upload files to Firebase Cloud Storage using Vue.js and Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Vue.js和Node.js将文件上传到Firebase云存储</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/upload-files-to-firebase-cloud-storage-using-vue-js-and-node-js-9b61ea3c77df?source=collection_archive---------2-----------------------#2020-11-26">https://levelup.gitconnected.com/upload-files-to-firebase-cloud-storage-using-vue-js-and-node-js-9b61ea3c77df?source=collection_archive---------2-----------------------#2020-11-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6d5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">文件上传是现在web应用程序的重要组成部分之一。在这里，我将向您展示如何使用Node.js和Vue.js将文件上传到Firebase云存储。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/ed06c31e92ea5b8f1df860fb87c882e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U6EZyTb84TIVtDQSNEPtdw.jpeg"/></div></div></figure><h1 id="e92c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">建立firebase项目</h1><p id="3e74" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">为此，您需要有一个firebase帐户。如果没有，可以在这里创建一个<a class="ae ma" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank">。在firebase控制台中，通过单击“添加新项目”创建一个新的firebase项目。为您的项目选择一个名称。然后Firebase将设置您的项目。要存储文件，请单击左侧导航窗格中的“存储”按钮。单击“开始”按钮，然后将打开一个模式，其中包含您的云存储的安全规则。你可以在这里</a>了解更多安全规则<a class="ae ma" href="https://firebase.google.com/docs/storage/security/get-started?authuser=1#sample-rules" rel="noopener ugc nofollow" target="_blank">。点击下一步，选择您的位置，然后点击“完成”。然后firebase会为你创建一个默认的bucket。</a></p><p id="18fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要连接到我们的bucket，我们需要一个私钥来安全地连接到我们的bucket。为此，单击左侧导航窗格顶部的设置图标，然后单击项目设置。在“项目设置”页面中，单击“服务帐户”选项卡，然后单击“生成私钥”按钮。这将生成一个JSON文件，其中包含我们的firebase帐户的凭证。这个文件应该保密，永远不要存储在公共存储库中。我们已经完成了firebase项目的设置，现在我们可以构建Node.js API来将文件上传到云存储。</p><h1 id="9fb2" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak">构建API </strong></h1><p id="b1cd" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">为了上传文件，我们将使用一个名为<a class="ae ma" href="https://www.npmjs.com/package/multer" rel="noopener ugc nofollow" target="_blank"> multer </a>的包。</p><p id="942f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装依赖项</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="effa" class="mg ky iq mc b gy mh mi l mj mk">npm i express multer firebase-admin</span></pre><p id="76b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在创建一个web服务器并导入依赖项。为此，创建一个名为<code class="fe ml mm mn mc b">index.js</code>的文件，并添加以下代码。</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="6909" class="mg ky iq mc b gy mh mi l mj mk">const express = require('express')<br/>const multer = require('multer')<br/>const app = express()</span><span id="67dd" class="mg ky iq mc b gy mo mi l mj mk">app.use(express.urlencoded({extended: false}))<br/>app.use(express.json({extended: false}))</span><span id="a98c" class="mg ky iq mc b gy mo mi l mj mk">app.post('/upload', (req, res) =&gt; {<br/>    console.log("File upload API")<br/>}</span><span id="83c0" class="mg ky iq mc b gy mo mi l mj mk">app.listen(5000, () =&gt; {<br/>    console.log('🚀Server listening on port 5000')<br/>})</span></pre><p id="3eb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在有一个运行在端口5000上的基本web服务器。</p><p id="2f51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们要构建我们的文件上传API。我们将使用multer上传文件。multer将拥有包含上传文件的<code class="fe ml mm mn mc b">req.file</code>对象和包含文本字段的<code class="fe ml mm mn mc b">req.body</code>对象。我们将使用multer提供的<code class="fe ml mm mn mc b">MemoryStorage</code>。内存存储引擎将文件作为<code class="fe ml mm mn mc b">Buffer</code>对象存储在内存中。</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="48ad" class="mg ky iq mc b gy mh mi l mj mk">const upload = multer({<br/>    storage: multer.memoryStorage()<br/>})</span><span id="d967" class="mg ky iq mc b gy mo mi l mj mk">app.use(upload.single())</span></pre><p id="4736" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以使用<code class="fe ml mm mn mc b">req.file</code>访问上传的文件。如果你有多个文件，使用<code class="fe ml mm mn mc b">upload.any()</code>而不是<code class="fe ml mm mn mc b">upload.single()</code>。如果你使用的是<code class="fe ml mm mn mc b">upload.any()</code>，你应该使用<code class="fe ml mm mn mc b">req.files</code>，它将是一个文件数组。</p><p id="b68a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在你的<code class="fe ml mm mn mc b">index.js</code>会是这样的</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="7eda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">连接到firebase </strong></p><p id="7376" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个名为<code class="fe ml mm mn mc b">firebase.js</code>的新文件。导入firebase依赖项并初始化firebase admin SDK。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="363f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经在应用程序中初始化了firebase。现在我们可以移动到<code class="fe ml mm mn mc b">/upload</code>端点。</p><p id="8b20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将文件上传到firebase </p><p id="481e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将出口桶从<code class="fe ml mm mn mc b">firebase.js</code>导入到<code class="fe ml mm mn mc b">index.js</code></p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="6e4a" class="mg ky iq mc b gy mh mi l mj mk">const firebase = require('./firebase')</span></pre><p id="2988" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要检查传入的请求实际上是否包含文件，如果请求不包含任何文件，我们将发送状态为400的响应。我们可以通过以下方式验证该文件是否存在。<code class="fe ml mm mn mc b">/upload</code>端点内，</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="0230" class="mg ky iq mc b gy mh mi l mj mk">if(!req.file) {<br/>        res.status(400).send("Error: No files found")<br/>}</span></pre><p id="2b6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Firebase使用blobs来存储二进制数据。blobs是二进制大对象，它是作为单个实体存储在数据库中的二进制数据的集合。我们可以使用<code class="fe ml mm mn mc b">bucket.file()</code>方法通过传递文件名来创建一个新的blob。</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="51dd" class="mg ky iq mc b gy mh mi l mj mk">const blob = firebase.bucket.file(req.file.filename)</span></pre><p id="eecf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要创建一个可写的流来处理传入的数据。流基本上是数据的集合，但它可能不会一次全部可用，我们需要一次处理一个数据块。</p><p id="0f3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您需要将文件的mimetype作为元数据传递，否则您将无法以正确的格式读取数据。</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="5d8d" class="mg ky iq mc b gy mh mi l mj mk">cosnt blobWriter = blob.createWriteStream({<br/>    metadata: {<br/>        contentType: req.file.mimetype<br/>    }<br/>})</span></pre><p id="4dcc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要在创建可写流时检查错误。我们可以通过<code class="fe ml mm mn mc b">blobWriter</code>上的<code class="fe ml mm mn mc b">error</code>事件做到这一点</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="c9af" class="mg ky iq mc b gy mh mi l mj mk">blobWriter.on('error', (err) =&gt; {<br/>    console.log(err)<br/>})</span></pre><p id="b091" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe ml mm mn mc b">finish</code>事件中，我们可以向客户端发送成功响应。</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="3e28" class="mg ky iq mc b gy mh mi l mj mk">blobWriter.on('finish', () =&gt; {<br/>    res.status(200).send("File uploaded.")<br/>})</span></pre><p id="4bb9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当数据处理完成时，将发出<code class="fe ml mm mn mc b">end</code>事件。</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="1598" class="mg ky iq mc b gy mh mi l mj mk">blobWriter.end(req.file.buffer)</span></pre><p id="820e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样。我们已经创建了Node.js API来将文件上传到firebase云存储。现在你的<code class="fe ml mm mn mc b">index.js</code>文件会是这样的。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mp mq l"/></div></figure></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><h1 id="efc0" class="kx ky iq bd kz la my lc ld le mz lg lh li na lk ll lm nb lo lp lq nc ls lt lu bi translated">构建前端</h1><p id="e1dc" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">现在我们需要创建前端来选择要上传的文件。我们将在Vue.js中进行</p><p id="b6eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用类型文件和按钮创建一个<code class="fe ml mm mn mc b">input</code>字段，以调用API调用的函数。</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="f347" class="mg ky iq mc b gy mh mi l mj mk">&lt;input type="file" ref="file" v-on:change="handleUpload()"/&gt;<br/>&lt;button v-on:click="uploadFile()"&gt;Upload&lt;/button&gt;</span></pre><p id="5f43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经用file类型创建了一个输入字段。我们添加了一个<code class="fe ml mm mn mc b">ref</code>属性，这样我们就可以访问输入文件。我们还添加了一个<code class="fe ml mm mn mc b">handleUpload</code>函数，它将在用户选择文件时被触发。这个函数的作用是，我们将创建一个变量来保存用户选择的文件的值。现在我们将使用<code class="fe ml mm mn mc b">FileList</code>对象将输入文件保存到变量中。当用户选择一个文件时，<code class="fe ml mm mn mc b">handleUpload</code>将被触发，输入文件将被保存到变量中。为此，在我们的<code class="fe ml mm mn mc b">script</code>部分添加以下内容:</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="6fa3" class="mg ky iq mc b gy mh mi l mj mk">&lt;script&gt;<br/>  export default {<br/>    data() {<br/>        return {<br/>            file: ''<br/>        }<br/>    },<br/>    methods: {<br/>      handleFileUpload(){<br/>          this.file = this.$refs.file.files[0]<br/>      },<br/>      uploadFile(){<br/>          <br/>      }<br/>    }<br/>  }<br/>&lt;/script&gt;</span></pre><p id="5123" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用<code class="fe ml mm mn mc b">FormData</code>创建一个保存文件的对象。用<code class="fe ml mm mn mc b">uploadFile</code>方法创建一个新的表单数据对象</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="1f85" class="mg ky iq mc b gy mh mi l mj mk">const formData = new FormData()</span></pre><p id="c466" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要将文件添加到<code class="fe ml mm mn mc b">formData</code>对象中。</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="f2d9" class="mg ky iq mc b gy mh mi l mj mk">formData.append("file", this.file)</span></pre><p id="c676" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">后端API <code class="fe ml mm mn mc b">upload.single(&lt;field name&gt;)</code>上的字段名必须与我们的<code class="fe ml mm mn mc b">formData</code>上的字段名相同。</p><p id="1486" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们可以将数据发布到后端API。我在用Axios发布数据。</p><pre class="km kn ko kp gt mb mc md me aw mf bi"><span id="3e8c" class="mg ky iq mc b gy mh mi l mj mk">axios.post('http://localhost:5000/upload', formData, {<br/>    headers: {<br/>        "Content-Type": "multipart/form-data"<br/>    }<br/>}).then(response =&gt; {<br/>    console.log(response.data)<br/>}).catch(error =&gt; {<br/>    console.log(error)<br/>})</span></pre><p id="fd08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您最终的vue.js文件将如下所示。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="8c3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样。我们最终使用Node.js、Vue.js和Firebase创建了文件上传应用程序。</p><p id="bf39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在这里获得该项目的完整代码。</p><div class="nd ne gp gr nf ng"><a href="https://github.com/amljs/node-vue-firebase-fileupload" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">AML js/node-vue-fire base-file upload</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">GitHub是超过5000万开发人员的家园，他们一起工作来托管和审查代码、管理项目和构建…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">github.com</p></div></div><div class="np l"><div class="nq l nr ns nt np nu kv ng"/></div></div></a></div><p id="fd45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你有任何疑问或需要任何进一步的澄清，请在评论区告诉我。我很乐意帮助你。</p><p id="55fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你觉得这篇文章有帮助或者有趣，可以考虑鼓掌。</p><p id="aea3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编码快乐！！！</p></div></div>    
</body>
</html>