<html>
<head>
<title>React + custom hook + typescript to download a file through API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React +自定义钩子+ typescript通过API下载文件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/react-custom-hook-typescript-to-download-a-file-through-api-b766046db18a?source=collection_archive---------0-----------------------#2021-10-07">https://levelup.gitconnected.com/react-custom-hook-typescript-to-download-a-file-through-api-b766046db18a?source=collection_archive---------0-----------------------#2021-10-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="33d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">想知道如何通过调用认证背后的API在UI上下载文件？</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/e352156562bfdbdecaadf0f0228d645c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oF-8gYnyg3TosiDtm32H8Q.png"/></div></div></figure><h1 id="3548" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">问题陈述</h1><ul class=""><li id="4550" class="lv lw iq jp b jq lx ju ly jy lz kc ma kg mb kk mc md me mf bi translated">文件需要在前端下载。</li><li id="9aee" class="lv lw iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">该文件的数据由后端提供服务。</li></ul><h1 id="3a14" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">可能的解决方案</h1><p id="e0a5" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated"><strong class="jp ir"> <em class="mo"> 1。在&lt; a/ &gt;标签上嵌入要下载文件的链接，在新标签页下载文件。</em>T3】</strong></p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="9898" class="mu ky iq mq b gy mv mw l mx my">&lt;a<br/>href="https://www.some/url/to/file"<br/>target="__blank"&gt;<br/>Download<br/>&lt;/a&gt;</span></pre><p id="c242" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当所提供的文件是公共的并且全世界都可以访问时，上述方法对于较简单的用例很有效。</p><p id="16a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，如果文件在某种认证之后，并且只能通过API提供必要的认证细节(如请求授权头中的载体令牌)来调用，该怎么办呢？</p><p id="3207" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将导致下载文件时出错，你会发现后端错误显示在用户界面上。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mz"><img src="../Images/0070015c02a826d5689ff2d4bb61a61c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Bbtstmb-XV9Hrl9ceWGcA.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">由于未提供身份验证详细信息，下载文件时出错</figcaption></figure><p id="a51e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">2<em class="mo">。调用API </em> </strong> <br/>为了克服方法一中面临的问题，我们必须通过调用API来访问文件。在API请求中，我们可以额外提供必要的细节，让后端应用程序知道我们可以访问所请求的文件。</p><p id="14b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是我们将要讨论的方法，即调用API，获取数据，将这些数据作为文件下载到浏览器上。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="ab gu cl ne"><img src="../Images/c605c39006b9ff7205db08261e1d7566.png" data-original-src="https://miro.medium.com/v2/1*AsyrOY4g8LDLfEzAA5Fdwg.gif"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">点击带有提供的文件名的按钮后，文件被下载</figcaption></figure><h1 id="489e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak">接近</strong></h1><ol class=""><li id="1e65" class="lv lw iq jp b jq lx ju ly jy lz kc ma kg mb kk nf md me mf bi translated">单击按钮，调用需要作为BLOB下载的文件的下载API。</li><li id="d728" class="lv lw iq jp b jq mg ju mh jy mi kc mj kg mk kk nf md me mf bi translated">从blob创建url，并将下载的对象存储在浏览器内存中。</li><li id="dcd4" class="lv lw iq jp b jq mg ju mh jy mi kc mj kg mk kk nf md me mf bi translated">单击隐藏的锚标记，它链接到上面生成的url。</li></ol><h1 id="da09" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">使用的技术</h1><ol class=""><li id="7f35" class="lv lw iq jp b jq lx ju ly jy lz kc ma kg mb kk nf md me mf bi translated">React + Typescript:用于单页应用程序</li><li id="a7d0" class="lv lw iq jp b jq mg ju mh jy mi kc mj kg mk kk nf md me mf bi translated">Axios:用于api调用</li><li id="159a" class="lv lw iq jp b jq mg ju mh jy mi kc mj kg mk kk nf md me mf bi translated">react-bootstrap + bootstrap:用于现成的组件和样式</li><li id="1ff4" class="lv lw iq jp b jq mg ju mh jy mi kc mj kg mk kk nf md me mf bi translated">卢克森:处理日期</li></ol><h1 id="3c09" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">应用程序设置</h1><ol class=""><li id="e7ca" class="lv lw iq jp b jq lx ju ly jy lz kc ma kg mb kk nf md me mf bi translated">创建一个react + typescript样板文件，如react官方文档(https://create-react-app.dev/docs/adding-typescript/)所述</li></ol><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="49be" class="mu ky iq mq b gy mv mw l mx my">npx create-react-app react-download-file-axios --template typescript</span></pre><p id="2c60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.安装助手库</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="223a" class="mu ky iq mq b gy mv mw l mx my">npm i axios @types/axios luxon @types/react bootstrap react-bootstrap</span></pre><h1 id="1cf5" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><em class="ng">我们开始编码:</em></h1><h2 id="1e99" class="mu ky iq bd kz nh ni dn ld nj nk dp lh jy nl nm ll kc nn no lp kg np nq lt nr bi translated">按钮组件</h2><p id="7fed" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">一个简单的可重复使用的按钮组件，可以在调用API时处理加载状态。</p><p id="6f0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接受三个道具:<br/> 1。<strong class="jp ir">按钮状态</strong>:按钮可以处于加载或正常状态(初级)<br/> 2。<strong class="jp ir"> onClick </strong>:点击按钮<br/> 3时需要调用的点击处理函数。<strong class="jp ir">标签</strong>:按钮上显示的文字</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">src/components/button/index . tsx</figcaption></figure><h2 id="47db" class="mu ky iq bd kz nh ni dn ld nj nk dp lh jy nl nm ll kc nn no lp kg np nq lt nr bi translated">可重用的自定义挂钩:useDownloadFile.ts</h2><p id="3b17" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">这段代码的目的是将下载文件的功能抽象成一个可重用的<em class="mo">自定义钩子</em>，这样它就可以在许多页面上重用。<br/>永远最好遵循著名的<em class="mo">不要重复自己(干)</em>编程原则。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">src/custom hooks/usedownloadfile . ts</figcaption></figure><p id="dd94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们来看一下这个函数。</p><p id="f5ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> DownloadFileProps <br/> </strong>钩子接受各种参数:</p><p id="260d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.<code class="fe nu nv nw mq b">apiDefinition</code> <br/>包含API定义的函数中调用的axios API。</p><p id="a44c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.<code class="fe nu nv nw mq b">preDownloading<br/></code>在调用API之前执行的函数。<br/>该函数可以作为一个pre hook来执行任何需要在API调用之前<strong class="jp ir"> <em class="mo">完成的任务。<br/>示例:禁用按钮/将按钮状态更改为正在加载。</em></strong></p><p id="d819" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.<code class="fe nu nv nw mq b">postDownloading</code> <br/>进行API调用后执行的函数。<br/>在 进行API调用后，该函数可以作为post挂钩来完成任何需要<strong class="jp ir"> <em class="mo">完成的任务。<br/>示例:启用按钮/将按钮状态更改为主要。</em></strong></p><p id="4b2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.<code class="fe nu nv nw mq b">onError</code><br/>API失败时调用的函数。错误处理可以在这里完成。<br/>示例:向用户显示一个警告，告诉用户出现了问题，文件没有被下载。</p><p id="adfa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">被钩子</strong>暴露的实用程序<br/> 1。<strong class="jp ir"> ref: </strong> ref，将被附加到父组件中的<code class="fe nu nv nw mq b">&lt;a /&gt;</code>标签上。<br/> 2。<strong class="jp ir"> url: </strong>表示从API获取的数据的url。<br/> 3。<strong class="jp ir">名称:</strong>用户在系统上下载时看到的文件的名称。<br/> 4。<strong class="jp ir">下载:</strong>需要下载文件时需要调用的函数。</p><p id="af60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载功能流程:<br/> 1。调用<code class="fe nu nv nw mq b">preDownloading</code>功能。<br/> 2。打电话给API。如果出现错误，将调用<code class="fe nu nv nw mq b">onError</code>函数来处理错误。<br/> 3。创建一个代表下载数据的url，并将它存储在状态中。这个url被提供给<code class="fe nu nv nw mq b">&lt;a href... /&gt;</code>。<br/> 4。生成将在浏览器中下载的文件的名称。在州中存储相同的名称。<br/> 5。点击DOM中的<code class="fe nu nv nw mq b">&lt;a /&gt;</code>下载文件。<br/> 6。调用<code class="fe nu nv nw mq b">postDownloading</code>功能。<br/> 7。销毁生成的url。</p><h2 id="f69d" class="mu ky iq bd kz nh ni dn ld nj nk dp lh jy nl nm ll kc nn no lp kg np nq lt nr bi translated">下载文件的组件:downloadSampleCsvFile</h2><p id="e340" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">最后，让我们将所有代码拼接起来，单击一个按钮就可以下载一个示例csv文件。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">src/components/downloadSampleCsvFile/index . tsx</figcaption></figure><p id="fc40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个文件非常简单。</p><p id="7afd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有两个状态变量来维护按钮的状态，并在调用API时出现错误时显示警告。</p><p id="d079" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向<code class="fe nu nv nw mq b">useDownloadHook</code>自定义钩子传递各种函数:<br/> 1。<strong class="jp ir"> preDownloadFile </strong>:设置按钮状态为正在加载。<br/> 2。<strong class="jp ir"> postDownloadFile </strong>:将按钮状态设置回主状态。<br/> 3。<strong class="jp ir"> onError </strong>:显示出错警告。<br/> 4。<strong class="jp ir">API definition</strong>:axios get调用带有blob类型的responseType的API。<br/> 5。<strong class="jp ir">获取文件名</strong>:根据当前时间生成文件名。</p><p id="b582" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后组件返回JSX: <br/> 1。<code class="fe nu nv nw mq b">&lt;a /&gt;</code>:隐藏标签，用户看不到。使用refs下载文件后，功能<code class="fe nu nv nw mq b">download</code>内部点击该按钮。<br/> 2。<code class="fe nu nv nw mq b">&lt;Button /&gt;</code>:用户点击下载所需文件的按钮。</p><div class="km kn ko kp gt ab cb"><figure class="nx kq ny nz oa ob oc paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><img src="../Images/6f5439ec8cd748fbb4e61e46f4d83870.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/1*HcO4KTBDKSfpXh8-wEtdEA.png"/></div></figure><figure class="nx kq od nz oa ob oc paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><img src="../Images/facfa72225c6516b3bbee30ea4d58bd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*o5pUGGspoIs4q9x9ryTtzA.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk oe di of og translated">不同的按钮状态</figcaption></figure></div><p id="a889" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.<code class="fe nu nv nw mq b">&lt;Alert /&gt;</code>:负责在UI上显示错误信息</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oh"><img src="../Images/b905b1db432d23d0adcf851e0c03676b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RTy4C6q2esPz0K8lngxe1A.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">调用API导致错误时发出警报</figcaption></figure><h2 id="89ca" class="mu ky iq bd kz nh ni dn ld nj nk dp lh jy nl nm ll kc nn no lp kg np nq lt nr bi translated">App.tsx文件</h2><p id="ce39" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">最后将<code class="fe nu nv nw mq b">&lt;DownloadSampleCsv /&gt;</code>组件集成到<code class="fe nu nv nw mq b">&lt;App /&gt;</code></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">src/App.tsx</figcaption></figure><h1 id="f7ae" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">启动应用程序并测试功能</h1><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="0840" class="mu ky iq mq b gy mv mw l mx my">npm start / yarn start</span></pre><h1 id="479b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结论</h1><ol class=""><li id="2e4b" class="lv lw iq jp b jq lx ju ly jy lz kc ma kg mb kk nf md me mf bi translated">定制钩子可以被增强以支持更多的功能。</li><li id="94e3" class="lv lw iq jp b jq mg ju mh jy mi kc mj kg mk kk nf md me mf bi translated">Github回购可以在<a class="ae oi" href="https://github.com/anubhav-goel/react-download-file-axios" rel="noopener ugc nofollow" target="_blank">https://github.com/anubhav-goel/react-download-file-axios</a>上找到。</li></ol></div></div>    
</body>
</html>