<html>
<head>
<title>How to set up Drone CI on AWS EC2 for a CRA app with a local runner</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS EC2上为有本地跑步者的CRA应用程序设置无人机CI</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-set-up-drone-ci-on-aws-ec2-for-a-cra-app-with-local-dorunner-6164d619f354?source=collection_archive---------13-----------------------#2020-02-20">https://levelup.gitconnected.com/how-to-set-up-drone-ci-on-aws-ec2-for-a-cra-app-with-local-dorunner-6164d619f354?source=collection_archive---------13-----------------------#2020-02-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><h1 id="4a64" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">我们想要达到的目标</h1><p id="cd1a" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们需要这样的设置，当我们推送到Github存储库时，会触发一个webhook，自动执行一系列CI步骤。webhook提供者是Github，webhook的消费者是我们将在EC2实例上设置的CI服务器。</p><p id="184b" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">CI服务器被称为Drone，它有一个HTTP端点，在推送Github存储库时被点击，这些存储库是用名为<code class="fe lr ls lt lu b">.drone.yml</code>的Drone配置文件配置的。如果存储库包含该文件，那么需要执行该文件中指定的指令。这些指令合在一起称为工作负载，由无人机运行人员执行。</p><p id="6bae" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">出于本文的目的，这些CI指令的执行将由本地机器上的运行者来完成。有不同类型的转轮，我们将使用Docker转轮。它轮询EC2中运行的无人机服务器，以执行CI工作负载，并在Docker容器中执行它们。</p><p id="c49f" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">一般步骤是:</p><ol class=""><li id="bed4" class="lv lw it kq b kr lm kv ln kz lx ld ly lh lz ll ma mb mc md bi translated">启动一个EC2实例并在其上安装Docker</li><li id="c83e" class="lv lw it kq b kr me kv mf kz mg ld mh lh mi ll ma mb mc md bi translated">在Github中创建OAuth应用程序</li><li id="a8c9" class="lv lw it kq b kr me kv mf kz mg ld mh lh mi ll ma mb mc md bi translated">在EC2实例上运行一个无人机服务器</li><li id="a420" class="lv lw it kq b kr me kv mf kz mg ld mh lh mi ll ma mb mc md bi translated">在你的本地机器上设置一个无人机跑步者</li><li id="2ad8" class="lv lw it kq b kr me kv mf kz mg ld mh lh mi ll ma mb mc md bi translated">CRA，创建一个包含要执行的CI步骤的<code class="fe lr ls lt lu b">.drone.yml</code>文件，并推送到Github</li></ol><h1 id="90e7" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">1)启动并配置EC2实例</h1><p id="a6d2" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">启动一个EC2实例并对其进行ssh。我用的是Ubuntu 18.04免费层实例。允许HTTP和HTTPS入站访问端口80和443。</p><p id="634f" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">按照<a class="ae mj" href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" rel="noopener ugc nofollow" target="_blank"> Docker文档</a>在实例上安装Docker。</p><p id="6dfd" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated"><a class="ae mj" href="https://docs.drone.io/server/provider/github/" rel="noopener ugc nofollow" target="_blank">无人机文档</a>解释了如何完成以下两个步骤，但我也在这里解释了它们，以防文档中有任何不清楚的地方，这些文档非常简洁。</p><h1 id="6a39" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">2)在Github中创建OAuth应用程序</h1><p id="7180" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们需要启用将在我们的EC2实例上运行的无人机服务器来访问我们的Github资源。</p><p id="eef8" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">在下一步(步骤3)中，我们将启动无人机服务器，并为其提供OAuth2.0客户端凭据，以便它可以使用OAuth2.0让我们登录Github。Github使用标准的授权代码授权类型，所以我们还需要提供一个授权重定向URI(在Github中称为授权回调URL)。</p><p id="ca2a" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">要做到这一点，按照<a class="ae mj" href="https://developer.github.com/apps/building-oauth-apps/creating-an-oauth-app/" rel="noopener ugc nofollow" target="_blank"> Github文档</a>创建一个Github OAuth应用程序；你实际上要填写一张表格。该表单中的重要字段是授权回调URL，您希望将其设置为<code class="fe lr ls lt lu b">http://&lt;ec2_instance_hostname&gt;/login</code>。</p><p id="d8af" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">点击<code class="fe lr ls lt lu b">Register application</code>，下一屏显示<code class="fe lr ls lt lu b">Client ID</code>和<code class="fe lr ls lt lu b">Client Secret</code>。</p><h1 id="5c95" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">3)在EC2实例上启动一个无人机服务器</h1><p id="9f66" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这些步骤在<a class="ae mj" href="https://docs.drone.io/server/provider/github/" rel="noopener ugc nofollow" target="_blank">无人机文档</a>中也有描述。</p><p id="f6ad" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">首先，我们创建一个共享的秘密，该秘密将用于认证我们稍后创建的跑步者。<code class="fe lr ls lt lu b">openssl rand -hex 16</code>生成密码，您可以稍后复制并粘贴。</p><p id="50e8" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">下载无人机服务器，一个docker图片:<code class="fe lr ls lt lu b">docker pull drone/drone:1</code>。</p><p id="c720" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">启动服务器，这是通过运行设置了几个环境变量的无人机服务器docker映像来完成的。</p><p id="c76e" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated"><code class="fe lr ls lt lu b">DRONE_GITHUB_CLIENT_ID</code>和<code class="fe lr ls lt lu b">DRONE_GITHUB_CLIENT_SECRET</code>在上面的步骤2)中获得。<code class="fe lr ls lt lu b">DRONE_RPC_SECRET</code>是我们在这一步前面生成的秘密。</p><p id="7399" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated"><code class="fe lr ls lt lu b">DRONE_SERVER_HOST</code>是我们EC2实例的URL的主机名部分；这将是类似<code class="fe lr ls lt lu b">c2–10–101–22–10.eu-central-1.compute.amazonaws.com</code>的东西。</p><p id="9190" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated"><code class="fe lr ls lt lu b">DRONE_SERVER_PROTO</code>设置为<code class="fe lr ls lt lu b">http</code>。其他部分可以像在无人机文档中一样进行设置:</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mk"><img src="../Images/afd0c6183a47ed39c8785db1a8b249f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o7mlyxnnuExkXCGp3WLE7w.png"/></div></div></figure><p id="9158" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">此时，您可以运行<code class="fe lr ls lt lu b">sudo docker ps</code>并看到一个名为<code class="fe lr ls lt lu b">drone</code>的容器正在运行。</p><p id="30b2" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">转到浏览器，在路径<code class="fe lr ls lt lu b">/login</code>中导航到EC2实例的地址。你将通过Github OAuth，并需要授权无人机访问你的一些Github资源。当您这样做时，您将被重定向到Drone UI，这是一个仪表板，您可以在其中看到您的所有存储库和运行者正在执行的任何工作负载。</p><p id="5692" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">在这一点上，没有跑步者，你也没有推动任何回购有一个<code class="fe lr ls lt lu b">.drone.yml</code>，所以什么也没有发生。</p><h1 id="54b9" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">4)在你的本地机器上设置一个无人机运行器</h1><p id="f8ac" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这部分在<a class="ae mj" href="https://docs.drone.io/runner/docker/installation/linux/" rel="noopener ugc nofollow" target="_blank">无人机文档</a>中解释的足够好了。</p><p id="c5cf" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">你需要在你的本地机器上安装Docker和Docker Drone Runner的Docker镜像:<code class="fe lr ls lt lu b">docker pull drone/drone-runner-docker:1</code>。</p><p id="5aae" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">现在您需要做的就是运行这个映像，并使用一些环境变量，这样运行程序就知道CI服务器在哪里:它将轮询该服务器以执行工作负载。</p><p id="064d" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">文档显示以下命令:</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mw"><img src="../Images/bff5cfc3323d6a8cbd598785ffcfbdd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qc6AXFWmzyP3x-bAi3gI2Q.png"/></div></div><figcaption class="mx my gj gh gi mz na bd b be z dk translated">无人机文档开始运行Docker图像</figcaption></figure><p id="fab4" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">这里的要点是</p><ul class=""><li id="3511" class="lv lw it kq b kr lm kv ln kz lx ld ly lh lz ll nb mb mc md bi translated">我们已经为<code class="fe lr ls lt lu b">http</code>设置了服务器，所以<code class="fe lr ls lt lu b">DRONE_RPC_PROTO</code>应该是<code class="fe lr ls lt lu b">http</code>。</li><li id="09af" class="lv lw it kq b kr me kv mf kz mg ld mh lh mi ll nb mb mc md bi translated"><code class="fe lr ls lt lu b">DRONE_RPC_HOST</code>是EC2实例，所以类似于<code class="fe lr ls lt lu b">c2–10–101–22–10.eu-central-1.compute.amazonaws.com</code>。</li><li id="eb4b" class="lv lw it kq b kr me kv mf kz mg ld mh lh mi ll nb mb mc md bi translated"><code class="fe lr ls lt lu b">DRONE_RPC_SECRET</code>是我们在步骤3)中生成的秘密，并在启动无人机服务器时作为环境变量传递</li></ul><p id="7769" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">当您运行这个命令时，为了查看它是否工作，您需要检查这个<code class="fe lr ls lt lu b">runner</code>容器:<code class="fe lr ls lt lu b">docker logs runner</code>的日志。您希望看到的是远程服务器(EC2 CI服务器)被成功pinged通。</p><h1 id="894e" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">5) CRA与. drone.yml</h1><p id="b3b9" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用<code class="fe lr ls lt lu b">npx create-react-app my-app.</code>创建一个React应用</p><p id="8996" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">在那个项目的根目录下，创建<code class="fe lr ls lt lu b">.drone.yml</code>文件。这是一个非常简单的CI管道。</p><pre class="ml mm mn mo gt nc lu nd ne aw nf bi"><span id="2771" class="ng jr it lu b gy nh ni l nj nk">kind: pipeline<br/>type: docker<br/>name: default<br/>steps:<br/>  - name: dronetest<br/>    image: node<br/>    commands:<br/>      npm install<br/>      npm test</span></pre><p id="611f" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">如果项目中没有任何测试，这个管道将会失败，所以在这种情况下，要么移除<code class="fe lr ls lt lu b">npm test</code>要么在项目中创建一个简单的测试文件。</p><p id="6907" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">为这个项目创建一个Github repo，并将这个代码推送到这个repo。当您这样做时，请看一下Drone UI(EC2实例上的根路径，使用HTTP！)，这将显示有一个管道正在运行(在您的本地机器上)。</p></div></div>    
</body>
</html>