<html>
<head>
<title>setTimeout is a lie. It should be called setThreshold.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">setTimeout是骗人的。应该叫setThreshold。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/settimeout-is-a-lie-it-should-be-called-setthreshold-dcb752766b9d?source=collection_archive---------22-----------------------#2022-09-26">https://levelup.gitconnected.com/settimeout-is-a-lie-it-should-be-called-setthreshold-dcb752766b9d?source=collection_archive---------22-----------------------#2022-09-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="54df" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">这就是为什么…</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0d818af81cbeedc6c3b5286c0845b33e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mY_o_8bFeP0w8CIM1lqnIQ.png"/></div></div></figure><p id="e828" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Node.js是异步的，它提供了一个名为<code class="fe ln lo lp lq b">setTimeout</code>的简单函数，尽管它可能会让任何使用它的人感到困惑。</p><h2 id="e3ab" class="lr ls iq bd lt lu lv dn lw lx ly dp lz la ma mb mc le md me mf li mg mh mi mj bi translated">它是如何工作的</h2><p id="4ced" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">正如你从我的关于异步服务器的<a class="ae mp" rel="noopener ugc nofollow" target="_blank" href="/why-asynchronous-is-a-trend-c9892667e245">文章中所知道的，</a>我们只有一个执行主代码的线程。这里实际发生的事情是Node.js使用您的OS(操作系统)功能创建一个Timer对象。事件循环等待来自计时器对象的信号来运行您的代码。</p><p id="f8f2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，这里我们有两件事情出错了…</p><h2 id="5771" class="lr ls iq bd lt lu lv dn lw lx ly dp lz la ma mb mc le md me mf li mg mh mi mj bi translated"><strong class="ak">竞争条件</strong></h2><p id="7674" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">虽然我们将0作为毫秒数传递给函数调用，但最小时间是3毫秒，所以现在我们有了一个竞争条件。如果你的CPU性能足够好，那么它执行整个事件循环的速度会比定时器发出信号的速度快，在这种情况下，你会看到一个<code class="fe ln lo lp lq b">setImmediate</code>启动得更快。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="e819" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有时<code class="fe ln lo lp lq b">setImmediate</code>比<code class="fe ln lo lp lq b">setTimeout</code>开火更快，尽管我们通常期望<code class="fe ln lo lp lq b">setTimeout</code>更快。</p><p id="c439" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">另外，记住你的程序不是运行在机器上的单个进程，所以OC也可以为其他进程分配CPU时间。</p><h2 id="903f" class="lr ls iq bd lt lu lv dn lw lx ly dp lz la ma mb mc le md me mf li mg mh mi mj bi translated">主线程上的阻止程序</h2><p id="06e9" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">另一个可能出错的原因是主线程上有一个阻塞程序。记住Node.js是异步的，并且只有一个执行业务逻辑的主线程，所以如果我们有一些代码在相当长的时间内阻塞了我们的线程，回调将在以后执行。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="bb59" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是结果</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ms"><img src="../Images/ce3572880605c73d6a25ccffbaf72e76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AgzjOkQH5SBVrFb4vVYDWA.png"/></div></div></figure><h2 id="4de1" class="lr ls iq bd lt lu lv dn lw lx ly dp lz la ma mb mc le md me mf li mg mh mi mj bi translated">摘要</h2><p id="81c3" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">如果操作时间对您的业务至关重要，您不应该依赖Node.js中的<code class="fe ln lo lp lq b">setTimeout</code>函数，因为无法保证它会在您传递给它的X毫秒内执行。</p><h2 id="aabe" class="lr ls iq bd lt lu lv dn lw lx ly dp lz la ma mb mc le md me mf li mg mh mi mj bi translated">接下来呢？</h2><p id="571c" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">爱Node.js？你可以看看我关于它的其他文章:</p><ul class=""><li id="c7ea" class="mt mu iq kt b ku kv kx ky la mv le mw li mx lm my mz na nb bi translated"><a class="ae mp" rel="noopener ugc nofollow" target="_blank" href="/streams-and-how-they-fit-into-node-js-async-nature-a08723055a67">流以及它们如何适应Node.js的异步特性</a></li><li id="4bf4" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated"><a class="ae mp" rel="noopener ugc nofollow" target="_blank" href="/how-to-handle-blockers-in-node-js-1966d0399703">如何处理Node.js中的拦截器</a></li></ul></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><h1 id="d368" class="no ls iq bd lt np nq nr lw ns nt nu lz jw nv jx mc jz nw ka mf kc nx kd mi ny bi translated">分级编码</h1><p id="4f8d" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="dad7" class="mt mu iq kt b ku kv kx ky la mv le mw li mx lm my mz na nb bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="e45e" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">📰查看<a class="ae mp" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="724f" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">🔔关注我们:<a class="ae mp" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae mp" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae mp" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="720d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">🚀👉<a class="ae mp" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir">将像你这样的开发人员安置在顶级创业公司和科技公司</strong> </a></p></div></div>    
</body>
</html>