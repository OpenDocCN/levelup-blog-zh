# CSRF â€”è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ ğŸ˜ˆ

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/csrf-cross-site-request-forgery-88d26304e5f4>

## å®ƒæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆé‡è¦ï¼Œå®ƒæ˜¯å¦‚ä½•åšåˆ°çš„ï¼Œä»¥åŠå¦‚ä½•é˜²æ­¢ CSRF è¢­å‡»

![](img/e531d8df43c613b1b2b45d5bff81c904.png)

é©¬ä¸Â·æ‰˜é©¬æ–¯åˆ›é€ å½¢è±¡

ä¸€ä¸ªè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»æ˜¯ç½‘ç»œç»å…¸ä¹‹ä¸€ã€‚æœ€è¿‘è¿™å·²ç»ä¸å†æ˜¯æ–°é—»äº†ï¼Œå› ä¸ºé˜²å¾¡å¾ˆå®¹æ˜“å®æ–½ï¼Œä¹Ÿå¾ˆæœ‰æ•ˆã€‚å°½ç®¡å¦‚æ­¤ï¼Œä»Šå¹´å’Œ 2019 å¹´ï¼Œå³ä½¿æ˜¯å¤§å‹åˆä½œå’Œæ”¿åºœç»„ç»‡ä¹Ÿæœ‰é—®é¢˜ã€‚

è¯»å®Œè¿™ç¯‡æ–‡ç« åï¼Œä½ ä¼šçŸ¥é“å¦‚ä½•åº”ç”¨é‚£äº›æ”»å‡»ï¼Œä»¥åŠå¦‚ä½•é˜²å¾¡å®ƒä»¬ã€‚æˆ‘ä»¬å¼€å§‹å§ï¼

# ä¸ºä»€ä¹ˆ CSRF å¦‚æ­¤é‡è¦

ä¸å¯å¦è®¤ï¼ŒCSRF è¢­å‡»äº‹ä»¶å¸¦æ¥çš„å·¨å¤§å½±å“ä¸æ˜¯ä¸€æ—¶åŠä¼šå„¿å‘ç”Ÿçš„ã€‚ä»–ä»¬ä¹Ÿä¸å†æ˜¯ OWASP å‰ 10 åï¼Œä½†ä»ç„¶å­˜åœ¨:

*   2022 å¹´:äºšç‰¹å…°è’‚æ–¯å‰æ‹‰æœ‰ä¸€ä¸ª CSRF æ¼æ´([æ¥æº](https://jira.atlassian.com/browse/JRASERVER-73138)
*   2019 å¹´:å¾·å›½å®˜æ–¹å®‰å…¨ç½‘ç«™ Cert-Bund æ˜“å— CSRF æ”»å‡»ï¼Œè¯¥æ”»å‡»å¯èƒ½å…è®¸æ”»å‡»è€…çœ‹åˆ°æœªæŠ«éœ²çš„æ¼æ´([æ¥æº](https://www.golem.de/news/websicherheit-cert-bund-war-anfaellig-fuer-csrf-angriff-1910-144699.html))
*   **2012:å·´è¥¿æ•°ç™¾ä¸‡ DSL è°ƒåˆ¶è§£è°ƒå™¨è¢«é»‘ï¼Œä¼ æ’­é“¶è¡Œæ¶æ„è½¯ä»¶** ( [æ¥æº](https://thehackernews.com/2012/10/millions-of-dsl-modems-hacked-in-brazil.html)ï¼Œ[æ¥æº](https://nakedsecurity.sophos.com/2012/10/01/hacked-routers-brazil-vb2012/))
*   2008 å¹´:å®¶ç”¨ DSL è·¯ç”±å™¨æ˜“å—æ”»å‡»([æ¥æº](https://www.techrepublic.com/article/csrf-attacks-home-dsl-routers-are-vulnerable/))

# CSRF è¢­å‡»æ˜¯å¦‚ä½•å®æ–½çš„ï¼Ÿ

å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåšå®¢çš„è¯„è®ºéƒ¨åˆ†ã€‚æ‚¨æ­£åœ¨ä½¿ç”¨çš„ REST ç«¯ç‚¹æ˜¯`POST /comments`ã€‚å½“ç„¶æ˜¯ç»è¿‡è®¤è¯çš„ã€‚æ‚¨é€‰æ‹©ä½¿ç”¨å¸¦æœ‰ä¼šè¯ ID çš„ cookieã€‚

ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œæ”»å‡»è€…å¯ä»¥åˆ›å»ºä¸€ä¸ªå®Œå…¨ä¸åŒçš„ç½‘ç«™â€”â€”è®©æˆ‘ä»¬ç§°å®ƒä¸º evil.comï¼Œä½ çš„ç½‘ç«™ä¸º vulnerable.comã€‚åœ¨ evil.com å¯èƒ½æ˜¯ä¸€ç§å½¢å¼

```
<form method="post" action="https://vulnerable.com/api/comments"><input type="text" name="comment" />
<input type="submit" /></form>
```

vulnerable.com çš„ cookies æ˜¯ç”±æµè§ˆå™¨**è‡ªåŠ¨**å‘é€çš„ï¼Œä¸ç®¡è¯·æ±‚æ¥è‡ªå“ªé‡Œ**ï¼è¿™æ˜¯å…³é”®éƒ¨åˆ†ã€‚**

å› æ­¤ï¼Œæ”»å‡»çš„å·¥ä½œåŸç†å¦‚ä¸‹:

*   ç¡®ä¿å—å®³è€…ç™»å½•åˆ°æ˜“å—æ”»å‡»çš„ç«™ç‚¹ã€‚æ”»å‡»è€…å¯ä»¥ä¾èµ–äºæ²¡æœ‰äººæ³¨é”€çš„äº‹å®ã€‚
*   æ”»å‡»è€…è®©å—å®³è€…è®¿é—®ç”±æ”»å‡»è€…æ§åˆ¶çš„ç½‘é¡µã€‚è¯¥é¡µé¢ä½¿æµè§ˆå™¨å‘é€è¯·æ±‚â€”æµè§ˆå™¨ä¸éœ€è¦ä»»ä½•æ¼æ´ã€‚æµè§ˆå™¨ä¸€ç›´å‘å…¶ä»–ç½‘ç«™å‘å‡ºè¯·æ±‚ã€‚
*   æµè§ˆå™¨ä¼šè‡ªåŠ¨é™„åŠ  cookie çš„ä¼šè¯ä¿¡æ¯ã€‚

åªè¦å—å®³è€…ç™»å½•åˆ°æ˜“å—æ”»å‡»çš„é¡µé¢ï¼Œæ”»å‡»è€…å°±å¯ä»¥å‘é€ä»»ä½•ä¿¡æ¯ã€‚ç„¶è€Œï¼Œæ”»å‡»è€…æ— æ³•è¯»å–ä¿¡æ¯ã€‚

# æˆ‘å¦‚ä½•é˜²æ­¢ CSRF è¢­å‡»ï¼Ÿ

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥æ¶ˆé™¤ CSRF æ¼æ´:å CSRF ä»¤ç‰Œã€SameSite Cookies å’ŒéåŸºäº cookie çš„èº«ä»½éªŒè¯ã€‚

## å CSRF ä»£å¸â€”â€”ä¸€ç§å¥‡ç‰¹çš„ä¸´æ—¶è´§å¸

æ”¶åˆ°è¯„è®ºçš„é¡µé¢å¯èƒ½åŒ…å«ä¸€ä¸ªâ€œç§˜å¯†â€ã€‚åªæœ‰åŸç½‘ç«™å’Œç”¨æˆ·çŸ¥é“çš„å€¼ã€‚åœ¨å‰ç«¯å‘å‡ºæ³¨é‡Šè¯·æ±‚ä¹‹å‰ï¼Œå®ƒä¼šä¸ºè¯¥ç”¨æˆ·è¯·æ±‚ä¸€æ¬¡æ€§ä»¤ç‰Œã€‚åç«¯çŸ¥é“åªæœ‰åŒ…å«è¿™ä¸ªä»¤ç‰Œçš„è¯·æ±‚æ‰èƒ½è¢«æ¥å—ã€‚

é€šå¸¸ï¼Œè¿™è¢«ç§°ä¸ºâ€œå CSRF ä»¤ç‰Œâ€ã€‚ä½ ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºâ€œNonceâ€â€”â€”ä¸€ä¸ªâ€œ **n** ä½¿ç”¨**ä¸€æ¬¡**çš„æ•°å­—â€ã€‚ä½œä¸ºä¸€ä¸ªå‰¯ä½œç”¨ï¼Œå®ƒè¿˜å¯ä»¥é˜²æ­¢é‡å¤çš„é¡µé¢æäº¤ä¸¤æ¬¡å‘è¡¨è¯„è®ºã€‚å®ç°æ–¹å¼ä¸åŒï¼›å CSRF ä»¤ç‰Œä¹Ÿå¯ä»¥ç»‘å®šåˆ°ä¼šè¯ã€‚

## SameSite Cookies

å±æ€§ä¸º`SameSite=Strict`çš„ Cookies å°†åªä¸æ¥è‡ªåŒä¸€ç«™ç‚¹çš„è¯·æ±‚ä¸€èµ·å‘é€ã€‚

`Strict`æä¾›äº†å®Œç¾çš„é˜²å¾¡ï¼Œä½†ä»¥å¯ç”¨æ€§ä¸ºä»£ä»·ã€‚`Lax`æä¾›äº†ä¸€äº›é˜²å¾¡ã€‚å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»ä»¥ä¸‹æ–‡ç« :

[](https://portswigger.net/web-security/csrf/samesite-cookies) [## ä½¿ç”¨ç›¸åŒç«™ç‚¹ cookies é˜²å¾¡|ç½‘ç»œå®‰å…¨å­¦é™¢

### ä¸€äº›ç½‘ç«™ä½¿ç”¨ç›¸åŒç«™ç‚¹çš„ cookies æ¥é˜²å¾¡ CSRF æ”»å‡»ã€‚SameSite å±æ€§å¯ç”¨äºæ§åˆ¶â€¦

portswigger.net](https://portswigger.net/web-security/csrf/samesite-cookies) 

## å†…å®¹ç±»å‹æ ‡é¢˜

å¦‚æœæ‚¨çš„ API æœŸæœ›å¹¶å¼ºåˆ¶æ‰§è¡Œ`Content-Type: application/json`ï¼Œå¹¶ä¸”æ‚¨æ²¡æœ‰ç¯¡æ”¹ CORS æŠ¥å¤´ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½è¿˜ä¼šä¸ºæ‚¨æä¾›ä¸€äº›é’ˆå¯¹ CSRF æ”»å‡»çš„ä¿æŠ¤ã€‚ä¸è¿‡ï¼Œæˆ‘å¯¹æ­¤å¹¶ä¸æ˜¯ 100%ç¡®å®šã€‚

## ä¸åŸºäº cookie çš„èº«ä»½éªŒè¯

æµè§ˆå™¨åœ¨æ¯æ¬¡è¯·æ±‚æ—¶åªè‡ªåŠ¨å‘é€ cookiesã€‚å¦‚æœæ‚¨å°†å‡­æ®å­˜å‚¨åœ¨ LocalStorage ä¸­ï¼ŒCSRF æ”»å‡»å°±ä¸å†å¯èƒ½ã€‚åœ¨é‚£ç§æƒ…å†µä¸‹ï¼Œä½ åœ¨å›é¿é—®é¢˜ã€‚æˆ‘å–œæ¬¢è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºä½ ä¸èƒ½å¿˜è®°ä¸ºä¸€äº›ç«¯ç‚¹åšè¿™ä»¶äº‹â€”â€”ä¸å CSRF ä»¤ç‰Œç›¸åã€‚

ç„¶è€Œï¼ŒXSS å¯èƒ½æ›´ä»¤äººæ‹…å¿§:

[](/cross-site-scripting-xss-fd374ce71b2f) [## è·¨ç«™ç‚¹è„šæœ¬(XSS)ğŸ˜ˆ

### å®ƒæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆé‡è¦ï¼Œå®ƒä»¬æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Œå¦‚ä½•é˜²æ­¢ XSS æ”»å‡»ï¼Œä»¥åŠå¦‚ä½•åˆ›å»ºä¸€ä¸ª cookie çªƒå–è€…ï¼

levelup.gitconnected.com](/cross-site-scripting-xss-fd374ce71b2f) 

# åŒæºæ”¿ç­–(SOP)æ€ä¹ˆæ ·ï¼Ÿ

åŒæºç­–ç•¥æ˜¯æµè§ˆå™¨ä¸ºé˜²æ­¢è·¨åŸŸæ•°æ®è¯»å–è€Œå®ç°çš„ä¸€ç§å®‰å…¨æœºåˆ¶

ç”±äºè·¨åŸŸè®¿é—®æ§åˆ¶ï¼Œæ”»å‡»è€…ä¸èƒ½ç®€å•åœ°åŒ…å«é“¶è¡Œçš„ iframe å¹¶çœ‹åˆ° iframe çš„å†…å®¹ã€‚åªæœ‰å½“åè®®(HTTP / HTTPS)ã€åŸŸ(evil.com/vulnerable . com)å’Œç«¯å£(å‡ ä¹æ€»æ˜¯ 80)ç›¸åŒæ—¶ï¼Œä»–ä»¬æ‰èƒ½è®¿é—®å®ƒã€‚

> ä½œä¸ºæ—æ³¨:è¿™æ˜¯è¿æ¥åˆ° CORS(è·¨åŸäº§åœ°èµ„æºå…±äº«)ã€‚CORS æ˜¯å®‰å…¨æ”¾æ¾åŒæºæ”¿ç­–(SOP)çš„ä¸€ç§æ–¹å¼ã€‚

ç„¶è€Œï¼ŒCSRF æ”»å‡»å¹¶ä¸æ˜¯ä¸ºäº†è¯»å–æ•°æ®ã€‚CSRF æ”»å‡»è¯•å›¾ç›²ç›®åœ°åšä¸€ä¸ªåŠ¨ä½œã€‚è¿™æ˜¯åŒæºæ”¿ç­–æ‰€ä¸å…³å¿ƒçš„ã€‚å› æ­¤ SOP /ä»»ä½• CORS è®¾ç½®éƒ½ä¸èƒ½æŠµå¾¡ CSRF æ”»å‡»ã€‚

# å…¶ä»–èµ„æº

YouTube ä¸Šæœ‰ä¸€ä¸ªå¾ˆæ£’çš„è§†é¢‘å¾ˆå¥½åœ°è§£é‡Šäº† CSRF:

å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ä¸ªå…³äº CSRF çš„ç”µè„‘çˆ±å¥½è€…è§†é¢‘ã€‚

# ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨è¿™ä¸ªå…³äºåº”ç”¨å®‰å…¨(AppSec)çš„ç³»åˆ—æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»è§£é‡Šäº†æ”»å‡»è€…çš„ä¸€äº›æŠ€æœ¯ğŸ˜ˆä»¥åŠé˜²å®ˆé˜Ÿå‘˜çš„æŠ€æœ¯ğŸ˜‡ï¼š

*   ç¬¬ 1 éƒ¨åˆ†: [SQL æ³¨å…¥](https://medium.com/faun/sql-injections-e8bc9a14c95)ğŸ˜ˆğŸ
*   ç¬¬äºŒéƒ¨:[ä¸è¦æ³„å¯†](/leaking-secrets-240a3484cb80)ğŸ˜‡
*   ç¬¬ 3 éƒ¨åˆ†:[è·¨ç«™ç‚¹è„šæœ¬(XSS)](/cross-site-scripting-xss-fd374ce71b2f) ğŸ˜ˆğŸ
*   ç¬¬ 4 éƒ¨åˆ†:[å¯†ç å“ˆå¸Œ](/password-hashing-eb3b97684636)ğŸ˜‡
*   ç¬¬äº”éƒ¨åˆ†: [ZIP ç‚¸å¼¹](https://medium.com/bugbountywriteup/zip-bombs-30337a1b0112)ğŸ˜ˆ
*   ç¬¬å…­éƒ¨åˆ†:[éªŒè¯ç ](https://medium.com/plain-and-simple/captcha-500991bd90a3)ğŸ˜‡
*   ç¬¬ 7 éƒ¨åˆ†:[ç”µå­é‚®ä»¶æ¬ºéª—](https://medium.com/bugbountywriteup/email-spoofing-9da8d33406bf)ğŸ˜ˆ
*   ç¬¬ 8 éƒ¨åˆ†:[è½¯ä»¶ç»„æˆåˆ†æ](https://medium.com/python-in-plain-english/software-composition-analysis-sca-7e573214a98e) (SCA)ğŸ˜‡
*   ç¬¬ä¹éƒ¨åˆ†: [XXE è¢­å‡»äº‹ä»¶](https://medium.com/faun/xxe-attacks-750e91448e8f)ğŸ˜ˆğŸ
*   ç¬¬åéƒ¨åˆ†:[æœ‰æ•ˆçš„è®¿é—®æ§åˆ¶](/effective-access-control-331f883cb0ff)ğŸ˜‡
*   ç¬¬åä¸€éƒ¨åˆ†: [DOS via åäº¿æ¬¡ç¬‘](https://medium.com/bugbountywriteup/dos-via-a-billion-laughs-9a79be96e139)ğŸ˜ˆ
*   ç¬¬åäºŒéƒ¨åˆ†:[å…¨ç£ç›˜åŠ å¯†](https://medium.com/faun/full-disk-encryption-2090489f9760)ğŸ˜‡
*   ç¬¬ 13 éƒ¨åˆ†:[ä¸å®‰å…¨çš„ååºåˆ—åŒ–](https://medium.com/bugbountywriteup/insecure-deserialization-5c64e9943f0e)ğŸ˜ˆ
*   ç¬¬ 14 éƒ¨åˆ†:[ç å¤´å·¥äººå®‰å…¨](/docker-security-5f4df118948c)ğŸ˜‡
*   ç¬¬ 15 éƒ¨åˆ†:[è¯ä»¶å¡«å……](/credential-stuffing-ff58ee8c3320)ğŸ˜ˆğŸ
*   ç¬¬ 16 éƒ¨åˆ†:[å¤šå› ç´ è®¤è¯](https://medium.com/plain-and-simple/multi-factor-authentication-cefff819be95) (MFA/2FA)ğŸ˜‡
*   ç¬¬ 17 éƒ¨åˆ†:[é‡åš](https://infosecwriteups.com/redos-denial-of-service-by-regex-59c7ffab4880?source=user_profile---------0-------------------------------&gi=bec35fb230e3)ğŸ˜ˆ
*   ç¬¬ 18 éƒ¨åˆ†:[å®‰å…¨å’Œç§äººå³æ—¶é€šè®¯](https://infosecwriteups.com/secure-messaging-5d2fc7748c24)ğŸ˜‡
*   ç¬¬åä¹éƒ¨:[å¯†ç åŠ«æŒ](https://medium.com/coinmonks/cryptojacking-55a73622fb6d)ğŸ˜ˆ
*   ç¬¬ 20 éƒ¨åˆ†:[å¤‡ä»½](https://medium.com/geekculture/backups-what-matters-and-how-to-do-it-right-62accf7e9800)ğŸ˜‡
*   ç¬¬ 21 éƒ¨åˆ†:CSRFğŸ˜ˆ
*   ç¬¬ 22 éƒ¨åˆ†:å•ç‚¹ç™»å½•ğŸ˜‡
*   ç¬¬ 23 éƒ¨åˆ†:å‰ªè´´æ¿åŠ«æŒğŸ˜ˆ
*   ç¬¬ 24 éƒ¨åˆ†:è¯ä¹¦ğŸ˜‡
*   ç¬¬ 25 éƒ¨åˆ†:åŒºå—é“¾çš„ç§æ—æ¡ä»¶æ”»å‡»ğŸ˜ˆ
*   ç¬¬ 26 éƒ¨åˆ†:ç§»åŠ¨è®¾å¤‡ç®¡ç†(MDM)ğŸ˜‡
*   ç¬¬ 27 éƒ¨åˆ†:æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ (SSRF)ğŸ˜ˆ
*   ç¬¬ 28 éƒ¨åˆ†:ç½‘ç»œéš”ç¦»ğŸ˜‡
*   ç¬¬ 29 éƒ¨åˆ†:ç¤¾ä¼šå·¥ç¨‹(åŒ…æ‹¬é’“é±¼)ğŸ˜ˆ
*   ç¬¬ 30 éƒ¨åˆ†:è™šæ‹Ÿä¸“ç”¨ç½‘ç»œğŸ˜‡

å¦‚æœæ‚¨å¯¹æ›´å¤šå…³äº AppSec / InfoSec çš„æ–‡ç« æ„Ÿå…´è¶£ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼

æˆ‘å–œæ¬¢å†™å…³äºè½¯ä»¶å¼€å‘å’ŒæŠ€æœ¯çš„æ–‡ç« ğŸ¤©ä¸è¦é”™è¿‡æ›´æ–°: [**è·å–æˆ‘çš„å…è´¹ç”µå­é‚®ä»¶ç®€è®¯**](https://martinthoma.medium.com/subscribe) ğŸ“§æˆ–è€…[å¦‚æœä½ è¿˜æ²¡æœ‰æŠ¥åå‚åŠ  medium](https://martinthoma.medium.com/membership)âœï¸â€”â€”ä¸¤è€…éƒ½é¼“åŠ±æˆ‘å¤šå†™ğŸ¤—