<html>
<head>
<title>Why you need to aggregate your data and how BigQuery scheduled queries can help you</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么需要聚合数据，以及BigQuery计划查询如何帮助您</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/why-you-need-to-aggregate-your-data-and-how-bigquery-scheduled-queries-can-help-you-22d13be1ed17?source=collection_archive---------9-----------------------#2022-03-24">https://levelup.gitconnected.com/why-you-need-to-aggregate-your-data-and-how-bigquery-scheduled-queries-can-help-you-22d13be1ed17?source=collection_archive---------9-----------------------#2022-03-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="fd7d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在处理大数据时，聚合您正在收集的数据变得越来越重要。为什么会这样呢？</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/50f1485a75d93ed14a608cbe77c939ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VNdhocvU2q5J41wf"/></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">卡斯帕·卡米尔·鲁宾在<a class="ae la" href="https://www.unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="bf92" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在许多情况下，尤其是在使用BigQuery这样的大数据工具时，您需要收集每个数据点。通过这种方式，你可以在以后使用数据驱动的方法来进行商业决策，训练一些人工智能算法，或者以任何形式向你的客户提供数据，以便他们可以利用这些数据做一些事情。然而，在收集数据时，您可能甚至不知道用它来做什么。</p><p id="60e4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那么，这与计划查询和数据聚合有什么关系呢？</p><p id="210f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当你用尽可能多的数据点收集每一个数据时，你的数据集会很快变大。这些快速增长的数据集的一些广泛来源是，例如，物联网设备数据、用户与您的应用程序/网站的交互或股票市场报价。</p><p id="33d6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您第一次收集这些数据时，很可能是大量元数据，您就有了原始数据。但是这些原始数据中有很多您将来可能不需要的不必要的信息，因此您不想将其存储多年。</p><p id="9d30" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">作为一个例子，想象在你的网站上有一些动作跟踪。作为原始数据，您首先可以存储诸如实际操作、一些唯一的用户ID、操作的确切时间、用户的浏览器等内容。</p><p id="5fc8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但最终，这只是原始数据，难以分析并从中获得任何价值。此外，存储如此多的数据会很快变得昂贵，因此您需要聚合这些数据并删除不再需要的旧原始数据。</p><p id="3c93" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除此之外，您不希望扫描可能有几TB或PB的整个数据集，以便从中获得细微的洞察力。</p><p id="247c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一个可能的目标是找出大多数用户使用的浏览器。有了这些信息，你就可以做出数据驱动的决定，增加这些特定浏览器的QA时间，或者放弃对某个特定浏览器的支持，因为只有0.01%的用户在使用它。尽管如此，维护支持(Internet Explorer😒 ).</p><p id="29b6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那么你会如何汇总上述数据呢？</p><p id="f952" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们以下表为例:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/4997266942f9814ff7301aa12a47c68a.png" data-original-src="https://miro.medium.com/v2/resize:fit:534/format:webp/1*pl7fvvKhik16WLg08czxoQ.png"/></div></figure><p id="8a4b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个表中，你可以跟踪你的用户的行为(<strong class="js iu">当然，只有在得到同意的情况下！</strong>)。如您所见，每个用户都有一个浏览器属性。这个简单的例子假设用户只有一个浏览器，并且没有使用几个具有相同用户ID的浏览器。用户ID可以是某个随机生成的ID，不需要匹配某个真实的用户对象。</p><p id="2f20" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">考虑到我们的上述目标，我们现在需要聚集这个表，为我们的业务决策提供所需的信息，并可能在之后丢弃旧的数据。这个例子的聚合逻辑非常简单。我们必须按照用户ID对数据进行分组——因此每个用户只有一行——然后计算浏览器的出现次数，并将这些值写入一个新表中。</p><p id="6dc2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为此，我们创建了下表:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/4d73d63d3ff09254f5f53411bc026609.png" data-original-src="https://miro.medium.com/v2/resize:fit:474/format:webp/1*qfFmD4mvOq9_ZSNiw6McdQ.png"/></div></figure><p id="83c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有了汇总的数据，我们现在可以尝试从中得出一些业务决策。当然，这个例子的数据在统计上并不重要，因为基表中只有6个条目；想象一下至少有几万个条目😉。</p><p id="d480" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">从汇总数据中创造洞察力和商业决策</strong></p><p id="0f5c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过分析上述数据，我们发现了两点。首先，我们每天大约有2-3个用户。第二，我们的用户目前只使用Chrome或Edge作为浏览器。</p><p id="f6d7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一个洞察可能有助于我们识别用户随时间的增长，因为我们可以检查每日活跃用户。但是我会在这里创建一个不同的聚合，不会误用这个表。</p><p id="8120" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以将第二个观点解释如下:</p><p id="d12d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">“我们只有Chrome和Edge用户，所以我们应该特别专注于支持这两种浏览器”。</p><p id="374f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这种认识可能会导致以下决策:</p><p id="d5d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，使用额外的资源(QA + Dev + Testing)来确保应用程序在Chrome和Edge上运行良好。除此之外，考虑放弃对Internet Explorer的支持或将其标记为不推荐使用和不完全支持，因为客户似乎不会使用它。</p><p id="b219" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">这也是为了降低成本</strong></p><p id="aeba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除了从汇总数据中获得洞察力和业务决策(这一点非常重要)之外，另一个关键方面是降低成本。</p><p id="ce98" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以我们上面的例子为例，让我们提出以下问题:</p><blockquote class="ld"><p id="59b3" class="le lf it bd lg lh li lj lk ll lm kn dk translated">"如果我们只对浏览器的使用感兴趣，为什么我们要存储每个用户交互？"</p></blockquote><p id="cbbf" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">当然，在现实世界的例子中，你将会有不止一个用例，但是现在让我们继续。</p><p id="6f38" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">用户的日常用户交互可能很快每天产生几百万行。但是您感兴趣的数据是每个现有浏览器每天只有一行。这意味着您存储了99.999%的您根本不感兴趣的数据。</p><p id="af75" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当然，您不应该在完成汇总后直接删除原始数据，但至少您可以定义一个特定的时间，在此之后您将丢弃原始数据，这样成本就不会激增。</p><p id="368d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">保持您的数据最新</strong></p><p id="53cb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除此之外，您希望您的聚合总是最新的，每天更新，这样您就可以及早发现趋势和变化的行为。但是我想我们都同意，你不希望为了每天运行一个查询而付钱给一些专门的人，因为这可以完全自动化。</p><p id="4379" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这就是BigQuery的计划查询发挥作用的地方。</p><h1 id="a7a6" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">BigQuery的计划查询如何帮助聚合自动化</h1><p id="b806" class="pw-post-body-paragraph jq jr it js b jt mq jv jw jx mr jz ka kb ms kd ke kf mt kh ki kj mu kl km kn im bi translated">顾名思义，预定查询是可以根据某个时间点自动运行或重复运行的查询，例如每24小时运行一次。“每24小时”非常适合上面我们需要每日数据的用例。</p><p id="b565" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是你并不局限于每24小时。谷歌也允许它使用每小时，每周，每月，甚至自定义。例如，使用custom，您可以插入类似于“<em class="mv">每星期三，1月5日，6月13:15”的日程选项。</em></p><p id="fcd5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用“每24小时”，您可以自动运行一个查询，每天一次，总是在同一时间，从原始表中查询所有必要的数据，对其进行聚合，并将结果写入一个额外的表。</p><p id="fadc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建这种计划查询有四种不同的方法。</p><ul class=""><li id="671b" class="mw mx it js b jt ju jx jy kb my kf mz kj na kn nb nc nd ne bi translated">谷歌控制台(GUI)</li><li id="5a0f" class="mw mx it js b jt nf jx ng kb nh kf ni kj nj kn nb nc nd ne bi translated"><em class="mv"> bq </em>命令行工具</li><li id="3ffd" class="mw mx it js b jt nf jx ng kb nh kf ni kj nj kn nb nc nd ne bi translated">谷歌应用编程接口</li><li id="fc3e" class="mw mx it js b jt nf jx ng kb nh kf ni kj nj kn nb nc nd ne bi translated">不同客户端SDK之一(Node.js、Java、Python等。)</li></ul><p id="ab13" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于其灵活性、可再现性和易用性，我更喜欢使用客户端SDK方法。在本文后面的动手编码部分，我们还将看到一些使用Node.js客户机SDK的例子。</p><p id="b5e5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">预定查询是Google通过其“BigQuery数据传输服务”提供的。当然，也可以构建自己的“时间表查询”。例如，您可以使用定义的cron作业运行AppEngine实例，该作业在每个触发器上运行正确的作业。或者，您可以创建一些<a class="ae la" href="https://cloud.google.com/scheduler" rel="noopener ugc nofollow" target="_blank">云调度器</a>，它触发对您的服务之一的请求，例如，运行查询的<a class="ae la" href="https://cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">云函数</a>。</p><p id="9293" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些自实现的缺点是，与简单地使用为这个用例显式实现的特性相比，您引入了更多的开销、复杂性和成本。</p><p id="8889" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们最终开始动手编码之前，我们必须在Google Cloud控制台中启用“BigQuery数据传输服务”。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi nk"><img src="../Images/a2fa8c3647410a98dbb7b8a4525a645f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PpvvoMqQsYhIukuJovuiZg.png"/></div></div></figure><h1 id="73d5" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">动手编码</h1><p id="f47b" class="pw-post-body-paragraph jq jr it js b jt mq jv jw jx mr jz ka kb ms kd ke kf mt kh ki kj mu kl km kn im bi translated">现在让我们着手编写一些代码😊并使用Node.js客户端SDK构建一个计划查询。对于以下部分，我希望您已经设置了GCP和BigQuery，并拥有使用它们的必要权限。</p><p id="2835" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在开始之前，确保您将在本例中使用的服务帐户有一个有效的JSON密钥文件。</p><p id="25b1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以在此找到您的服务帐户<a class="ae la" href="https://cloud.google.com/bigquery/docs/scheduling-queries#required_permissions" rel="noopener ugc nofollow" target="_blank">所需的权限。</a></p><p id="570a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">准备数据</strong></p><p id="973f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了验证我们预定的查询结果，我们应该创建一些我们的查询可以处理的测试数据。</p><p id="65d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以在下表中看到包含原始数据的演示表的结构。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi np"><img src="../Images/17b1bdcbaf7c1da33b3cb3c61a834d51.png" data-original-src="https://miro.medium.com/v2/resize:fit:334/format:webp/1*SDYkKJSpwoz84ZMLbY8lvg.png"/></div></figure><p id="f0d9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们在这里已经简化了很多，并假设该表中的每个条目都是一个单独的用户，因此在这种情况下我们不必对它们进行重复数据删除。我写了一个小脚本，为上面的表结构生成一个合适的CSV文件。这个脚本是为这个特定的演示案例定制的，尽管它会在2021年1月1日到2021年1月31日之间随机创建数据条目。您可以在下面的代码片段中看到该脚本。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="1f65" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">运行脚本后，可以将数据导入BigQuery。你可以使用谷歌云控制台或者我写的另一个JavaScript片段。因为我在以前的文章中已经详细地处理了JavaScript，所以我不会在这里重复。请确保您相应地调整了字段。</p><div class="ns nt gp gr nu nv"><a href="https://javascript.plainenglish.io/working-with-data-in-bigquery-using-node-js-4738561f5329" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">使用Node.js在BigQuery中处理数据</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">本文将介绍BigQuery的实际用法，并展示如何使用Node.js读写数据。</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="oe l"><div class="of l og oh oi oe oj ku nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a rel="noopener  ugc nofollow" target="_blank" href="/optimizing-your-bigquery-tables-using-partitioning-time-unit-column-partitioned-tables-c93cfbf3828d"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">使用分区优化BigQuery表:时间单位列分区表</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">尤其是在处理大数据时，当数据开始变得不稳定时，成本会迅速激增，性能会迅速下降</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="oe l"><div class="ok l og oh oi oe oj ku nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a rel="noopener  ugc nofollow" target="_blank" href="/optimizing-your-bigquery-tables-using-clustering-4d2b4255b461"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">使用聚类优化BigQuery表</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">除了使用表分区来提高BigQuery的性能和成本，还有另一种技术可用…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="oe l"><div class="ol l og oh oi oe oj ku nv"/></div></div></a></div><p id="f230" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">创建预设查询</strong></p><p id="cbb1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">既然我们的数据在BigQuery中可用，那么是时候创建我们的调度查询来聚合数据了。</p><p id="7573" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您想要使用调度查询时，“普通的”BigQuery NPM包— <code class="fe om on oo op b"><a class="ae la" href="https://www.npmjs.com/package/@google-cloud/bigquery" rel="noopener ugc nofollow" target="_blank">@google-cloud/bigquery</a></code> —不提供此功能。但是我们可以为此安装和使用<code class="fe om on oo op b"><a class="ae la" href="https://www.npmjs.com/package/@google-cloud/bigquery-data-transfer" rel="noopener ugc nofollow" target="_blank">@google-cloud/bigquery-data-transfer</a></code> NPM包，所以确保在运行下面的脚本之前安装它。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="7c25" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除了创建一个<code class="fe om on oo op b">DataTransferServiceClient</code>和定义一些常量，我们在上面的脚本中做了两件事。</p><ol class=""><li id="e171" class="mw mx it js b jt ju jx jy kb my kf mz kj na kn oq nc nd ne bi translated">创建将在每个计划事件上运行的查询。</li><li id="3866" class="mw mx it js b jt nf jx ng kb nh kf ni kj nj kn oq nc nd ne bi translated">创建一个传输配置来配置我们的预定查询。</li></ol><p id="53a3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的查询定义了我们希望将日期、浏览器、浏览器计数和预定查询的运行日期写入目标表。</p><p id="6813" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe om on oo op b"><em class="mv">@run_date</em></code>是一个BigQuery内部<code class="fe om on oo op b">DATE</code>类型变量，包含BigQuery运行计划查询的日期。例如，我们可以在我们的<code class="fe om on oo op b">WHERE</code>条件中使用它，只获取前一天的条目，用于我们的日常聚合。</p><p id="0e2d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">运行脚本后，我们可以验证Google在Google Cloud控制台中创建了预定的查询。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi or"><img src="../Images/cfcc6160bbe4cac71d32179928b06db0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oX5oOPbav4t_JfWj44EpDw.png"/></div></div></figure><p id="08e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">点击之后，我们可以看到Google已经运行了预定的查询或者当前正在运行。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi os"><img src="../Images/4e7fb4936a07ca525513e13e02b26d46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kdmawtm15o9Ct4_KeQpdeg.png"/></div></div></figure><p id="be37" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">写处置</strong></p><p id="ecd0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面脚本中的一个关键属性，你应该知道，就是<a class="ae la" href="https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/WriteDisposition" rel="noopener ugc nofollow" target="_blank"><em class="mv">write _ disposition</em></a>。即使有四个不同的枚举值，您也应该在配置中只使用其中的三个。</p><ul class=""><li id="c35f" class="mw mx it js b jt ju jx jy kb my kf mz kj na kn nb nc nd ne bi translated"><code class="fe om on oo op b"><em class="mv">WRITE_EMPTY</em></code> —作业将只写入空表。如果包含数据的表已经存在，BigQuery将抛出“重复”错误。</li><li id="187a" class="mw mx it js b jt nf jx ng kb nh kf ni kj nj kn nb nc nd ne bi translated">【BigQuery完成预定查询后，结果将覆盖当前位于目标表中的所有数据。</li><li id="d3a8" class="mw mx it js b jt nf jx ng kb nh kf ni kj nj kn nb nc nd ne bi translated"><code class="fe om on oo op b"><em class="mv">WRITE_APPEND</em></code> — BigQuery会将新数据追加到现有的表数据中。</li></ul><p id="e0ce" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们的例子中，我们使用<code class="fe om on oo op b"><em class="mv">WRITE_APPEND</em></code>,因为我们决定使用一个日期分区表来存储这个用例的所有聚合数据。</p><p id="a87d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当使用<code class="fe om on oo op b"><em class="mv">WRITE_TRUNCATE</em></code>时，您应该始终确保您的目标表没有硬编码的值。否则，您将总是覆盖您以前的数据。相反，最好使用类似上面的<code class="fe om on oo op b"><em class="mv">@run_date</em></code>或<code class="fe om on oo op b">@run_time</code>的运行时参数，并使用它们来动态创建您的目标表名。</p><p id="a299" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用上面的<em class="mv">destination _ table _ name _ template</em>参数，您可以提供类似于<code class="fe om on oo op b">my_scheduled_table_{run_date}</code>的值，这些值将在每天运行时以<code class="fe om on oo op b">my_scheduled_tableYYYYMMDD</code>的格式为每天创建一个新表。<a class="ae la" href="https://cloud.google.com/bigquery/docs/scheduling-queries#templating_system" rel="noopener ugc nofollow" target="_blank">在这里</a>，你可以找到在预定查询中使用模板语法的完整参考。</p><p id="048d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我看来,<code class="fe om on oo op b"><em class="mv">WRITE_EMPTY</em></code>选项是一种比<code class="fe om on oo op b"><em class="mv">WRITE_TRUNCATE</em></code>选项更“安全”的方法，因为您不必担心意外删除任何表。</p><p id="8142" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当然，这两种方法——<code class="fe om on oo op b"><em class="mv">WRITE_TRUNCATE</em></code>和<code class="fe om on oo op b"><em class="mv">WRITE_APPEND</em></code>——各有利弊。</p><p id="9276" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用<code class="fe om on oo op b"><em class="mv">WRITE_TRUNCATE</em></code>，如果出现问题或某些数据不正确，您可以快速重新运行预定的查询。它将简单地覆盖已经存在的表，并插入新的/正确的数据。这样做的缺点是，查询某个时间范围内的聚合会更加复杂，因为您必须查询/连接多个表，而不是一个表。</p><p id="ffb5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另一方面，<code class="fe om on oo op b"><em class="mv">WRITE_APPEND</em></code>使得查询时间范围变得非常容易，因为所有数据都在一个地方。在这种情况下，您应该确保使用分区来获得出色的性能。当然，这里的缺点是重新运行查询会将更多的数据插入到表中，而不会考虑前一个数据。因此，在重新运行查询之前，您必须自己清除以前的/不正确的数据，这更容易出错，并且在维护方面会产生一些开销。但是希望这不会经常发生。</p><p id="f409" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里没有“一刀切”的方法，所以这取决于您的用例，哪个<em class="mv"> write_disposition </em>对您更有意义。</p><p id="cf5c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">回填数据</strong></p><p id="5b68" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您第一次开始填充原始数据表时，通常没有准备好所有需要的聚合。在您设置好一切之后，您的预定查询将会到达某个地方，因为您可能无法在第一个草稿中100%确定您想要聚合什么数据。除此之外，业务决策可能会导致原始数据的新聚合。因此，现在您面临着创建新的计划查询的挑战，您必须在旧的数据集上运行这些查询。至少在你必须提供这些数据的时候也是如此。</p><p id="45a3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是不用担心。使用预定查询，Google提供了一个“回填”功能。</p><p id="29d3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">简单来说:</p><p id="68c0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以定义运行计划查询的日期范围，使用该特定日期的适当值作为其<em class="mv"> run_time </em>和<em class="mv"> run_date </em>参数。</p><p id="45ee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以轻松触发回填。你只需要在谷歌控制台中选择你的预定查询，点击“预定回填”按钮，输入你想要查询运行的日期范围，然后点击“确定”。您可以看到下图中标记的重要部分。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi ot"><img src="../Images/f9ec1d3a4a7a68fb9d9a2297147ae894.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jErwToGhZNiZGp9nIgeysw.png"/></div></div></figure><p id="6aad" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在后台，您还可以看到我已经为许多运行日期触发了回填。你可以通过他们的计划时间来识别这一点，因为这是2021年4月5日，但他们的运行日期早在2021年1月。</p><p id="dc54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，你必须特别注意你的日期范围的选择。正如Google在上面的图片中已经指出的，开始日期是包含的，但是结束日期不是。在我们的例子中，当我们想要回填整个一月时，我们必须选择2月2日作为结束日期。使用2月2日，谷歌将包括2月1日。将2月1日作为<em class="mv">运行日期</em>，我们的示例查询将生成1月31日的聚合。</p><p id="a0c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一月份的回填完成后，我们现在可以验证我们的查询结果。在下图中，您可以看到我查询了由预定查询创建的表，并请求了1月31日的条目。正如所料，有四个不同浏览器和事件的条目。另外，您可以看到<em class="mv">的运行日期</em>是2月1日。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi ou"><img src="../Images/606ddd9cec0c494f6b650670dddea49c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KaxB4BQwA1_btV8Q2rfYqQ.png"/></div></div></figure><p id="8428" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，我将上面的表路径更改为一些任意值，因为您在这里的值将与我的不同。</p><p id="47e8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">支持地区</strong></p><p id="2e31" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不支持在不同区域之间创建计划查询。因此，预定查询的目标表必须与被查询的数据位于同一区域。</p><p id="582b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，谷歌可能不支持所有地区。您可以在这里找到支持地区的完整列表<a class="ae la" href="https://cloud.google.com/bigquery/docs/scheduling-queries#supported_regions" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="35df" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">最后的话</h1><p id="d1ab" class="pw-post-body-paragraph jq jr it js b jt mq jv jw jx mr jz ka kb ms kd ke kf mt kh ki kj mu kl km kn im bi translated">通过这篇文章，我想向你提供一个谷歌预定查询服务的大致概述，以及如何在几个步骤中使用它，并展示回填操作，在我看来这是非常好的。</p><h2 id="f3f3" class="ov lt it bd lu ow ox dn ly oy oz dp mc kb pa pb mg kf pc pd mk kj pe pf mo pg bi translated">你想联系吗？</h2><p id="6350" class="pw-post-body-paragraph jq jr it js b jt mq jv jw jx mr jz ka kb ms kd ke kf mt kh ki kj mu kl km kn im bi translated">如果你想联系我，请在LinkedIn上联系我。</p><p id="c598" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另外，请随意查看我的书籍推荐📚。</p></div><div class="ab cl ph pi hx pj" role="separator"><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm"/></div><div class="im in io ip iq"><div class="kp kq kr ks gt nv"><a href="https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b" rel="noopener follow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">我的书籍推荐</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">在接下来的章节中，你可以找到我对所有日常生活话题的书籍推荐，它们对我帮助很大。</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="oe l"><div class="po l og oh oi oe oj ku nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://mr-pascal.medium.com/membership" rel="noopener follow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">通过我的推荐链接加入Medium—Pascal Zwikirsch</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">mr-pascal.medium.com</p></div></div><div class="oe l"><div class="pp l og oh oi oe oj ku nv"/></div></div></a></div></div></div>    
</body>
</html>