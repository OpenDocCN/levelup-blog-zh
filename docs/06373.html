<html>
<head>
<title>Simulating a CSRF Attack Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">模拟CSRF攻击第1部分</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/simulating-a-csrf-attack-part-1-5ec8b0f8b152?source=collection_archive---------5-----------------------#2020-11-19">https://levelup.gitconnected.com/simulating-a-csrf-attack-part-1-5ec8b0f8b152?source=collection_archive---------5-----------------------#2020-11-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6d20" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解它如何工作的最好方法是自己做一个</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/30f36ba36698109b04f62e2ee7688e1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*zNh9aevqL6n3ZbZS_Af3tQ.png"/></div></figure><p id="61dc" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是<a class="ae lm" href="https://davidklempfner.medium.com/simulating-a-csrf-attack-part-2-bf6f378da625" rel="noopener"> 2部分</a>系列的第1部分。</p><p id="29ba" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我将向你展示如何使用两个本地网络应用程序模拟一次<strong class="ks iu"> CSRF </strong>攻击，然后回答我在学习这些东西时提出的一系列问题。</p><p id="573f" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我还将谈一谈<strong class="ks iu"> CORS </strong>和<strong class="ks iu">同源</strong>政策。</p><h1 id="fca4" class="ln lo it bd lp lq lr ls lt lu lv lw lx jz ly ka lz kc ma kd mb kf mc kg md me bi translated">场景</h1><p id="d0e9" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">您是一名网上银行用户，目前登录了GoodBank网站。</p><p id="e531" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">当您仍然登录时，您会收到一封假装来自GoodBank的电子邮件。</p><p id="2a39" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">你点击邮件中的链接，它就会加载FakeBank的网站。</p><p id="cb31" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在后台，FakeBank网站将运行向GoodBank发出请求的Javascript代码。因为您是在另一个选项卡中登录GoodBank的，所以浏览器会发送您的会话cookie，其中包含FakeBank网站发送的恶意请求。</p><h1 id="81c7" class="ln lo it bd lp lq lr ls lt lu lv lw lx jz ly ka lz kc ma kd mb kf mc kg md me bi translated">设置web应用程序</h1><p id="d2fc" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">您将设置两个本地运行的web应用程序。一个代表古德班克，另一个代表恶意的FakeBank。</p><h2 id="02ba" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">如果在本地运行，请求将如何跨来源？</h2><p id="68e6" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">对于跨来源的请求，它必须指向至少在以下一个方面不同的URL:</p><ol class=""><li id="85c8" class="mw mx it ks b kt ku kw kx kz my ld mz lh na ll nb nc nd ne bi translated">协议(例如http而不是https)</li><li id="60cb" class="mw mx it ks b kt nf kw ng kz nh ld ni lh nj ll nb nc nd ne bi translated">领域(如another.domain.com而不是domain.com)</li><li id="2c1d" class="mw mx it ks b kt nf kw ng kz nh ld ni lh nj ll nb nc nd ne bi translated">港口(如domain.com:2343而非domain.com:2311)</li></ol><p id="550c" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">多亏了ASP.NET核心，当你在本地运行多个网络应用时，你可以自动拥有不同的端口。</p><h1 id="e001" class="ln lo it bd lp lq lr ls lt lu lv lw lx jz ly ka lz kc ma kd mb kf mc kg md me bi translated">古德班克</h1><p id="94d8" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">使用以下文件/文件夹创建一个名为GoodBank的ASP.NET核心3.0 MVC应用程序:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/ef10da84ba24c357d350d48a3073053d.png" data-original-src="https://miro.medium.com/v2/resize:fit:438/format:webp/1*f41OAdi80VifNJQ7pq5MCA.png"/></div></figure><p id="6207" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">将代码复制到相关文件中。未显示的文件可以保留默认代码:</p><h2 id="2b37" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">HomeController.cs</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div></figure><h2 id="cb51" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">撤回. cs</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div></figure><h2 id="54a5" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">Startup.cs</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div></figure><h1 id="a2ce" class="ln lo it bd lp lq lr ls lt lu lv lw lx jz ly ka lz kc ma kd mb kf mc kg md me bi translated">FakeBank</h1><p id="e4c1" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">使用以下文件/文件夹创建一个名为FakeBank的ASP.NET核心3.0 MVC应用程序:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nn no di np bf nq"><div class="gh gi nk"><img src="../Images/6a1fa95dc1108a4b3d7b0d1814a99178.png" data-original-src="https://miro.medium.com/v2/resize:fit:438/format:webp/1*1c4NYDEw2L-8lcRA-72JSg.png"/></div></div></figure><p id="2378" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">将代码复制到相关文件中。未显示的文件可以保留默认代码:</p><h2 id="61ac" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">Index.cshtml</h2><p id="dcec" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">下面代码中的端口号44386需要替换为用于GoodBank web应用程序的端口(在下一步运行时您会发现)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div></figure><h2 id="4bba" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">设置断点</h2><p id="82a3" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">在GoodBank应用程序的<code class="fe nr ns nt nu b">HomeController</code>类中的每个方法(除了<code class="fe nr ns nt nu b">Index()</code>方法)的第一行放置一个断点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/584a99a5d1f4bbf345cfb843673c9227.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*5-jGXWMn8FnMrtv_U23uEg.png"/></div></figure><h2 id="4ca3" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">启动应用程序</h2><p id="e195" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">启动GoodBank应用程序，您应该会看到这个:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/02373ce4abac9c3195e8997ab215fd6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/1*DNriRcxgL2Yb0KzlH305-w.png"/></div></figure><p id="68f2" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">复制你的端口号(我的是44386)并粘贴到FakeBank应用程序的Index.cshtml文件的URL中。</p><h2 id="256d" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">执行跨来源GET请求</h2><p id="817e" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">现在我们要模拟攻击。</p><p id="92e4" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">一旦FakeBank网站被加载，就会有Javascript在后台运行，向GoodBank发出跨源GET请求，以获取受害者的银行余额。</p><p id="eb4a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在现实生活中，如果您登录到GoodBank，您的会话cookie将被发送，因此您将通过身份验证。</p><p id="297b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在启动FakeBank应用程序。</p><p id="b317" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">当发出GET请求时，断点将在GoodBank应用程序中被命中。</p><h2 id="65ab" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">查看请求</h2><p id="0ed6" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">在观察窗口中，输入<code class="fe nr ns nt nu b">Request.Headers</code>并点击结果视图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nn no di np bf nq"><div class="gh gi nx"><img src="../Images/7f04a06f873d4c4e7be2adbf51d6df50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cLoF4QwoVi7mJB-66IcPJQ.png"/></div></div></figure><h2 id="deab" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">原始标题</h2><p id="3343" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">这里重要的头是源头。它的值是用户发出请求时查看的网页的URL。</p><h2 id="234c" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">网络选项卡</h2><p id="1534" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">现在回到FakeBank网页，点击F12查看控制台。</p><p id="939f" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果你看不到任何东西，你可能需要重新加载页面，然后在断点命中后继续在GoodBank应用中执行，以便查看日志。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nn no di np bf nq"><div class="gh gi ny"><img src="../Images/3646d68e0238d72f50769a96c8b4f695.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Dr4g_XlgS2e0-D3I41l2g.png"/></div></div></figure><h2 id="8530" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">错误</h2><p id="7fa2" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">我们知道请求是成功的，因为我们看到断点在GoodBank应用程序中被命中，但我们也可以看到在FakeBank应用程序中分配给<code class="fe nr ns nt nu b">xhr.onload()</code>的函数甚至没有执行！如果是的话，我们会看到<code class="fe nr ns nt nu b">GET request finished executing. The response is:</code>和响应，并写入控制台。</p><h2 id="fe71" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">注意事项</h2><p id="9a05" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated"><strong class="ks iu">跨源GET请求可以工作，但是响应对Javascript代码不可用。</strong></p><p id="7063" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是浏览器提供的安全功能。如果它允许的话，制作FakeBank的黑客可能已经对返回的敏感信息做了一些事情。</p><p id="a573" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">此功能被称为同源策略，任何知名浏览器都使用它。</p><h2 id="485c" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">如果黑客把Origin头去掉了呢？</h2><p id="c4c4" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">如果您通过在浏览器中键入URL并按回车键来发出GET请求，则不会发送原始标题，因为没有为您发出请求的网页，而是您自己从浏览器中发出请求。</p><p id="56a8" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">那么，如果在Javascript代码中删除了Origin头会怎么样呢？让我们看看如果黑客试图这么做会发生什么。</p><p id="8f66" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">用下面的第9行更新FakeBank应用程序中的Index.cshtml文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="f563" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">保存文件，并刷新FakeBank网页。</p><p id="e8bc" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在GoodBank应用程序中点击断点时，请查看标题。你会注意到原点头还在！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nn no di np bf nq"><div class="gh gi nx"><img src="../Images/7f04a06f873d4c4e7be2adbf51d6df50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cLoF4QwoVi7mJB-66IcPJQ.png"/></div></div></figure><p id="e28f" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是浏览器提供的另一个安全特性。<br/>如果浏览器允许Javascript运行，这就改变了Origin头，黑客可以删除它或者用GoodBank的URL更新它，这样GoodBank web服务器就认为请求来自它自己的网页。</p><h2 id="3654" class="mk lo it bd lp ml mm dn lt mn mo dp lx kz mp mq lz ld mr ms mb lh mt mu md mv bi translated">但是不能使用Powershell或Fiddler等来欺骗标头吗？</h2><p id="458a" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">是的，它可以。但唯一可行的方法是黑客进入受害者的电脑，并能够使用其中一种工具发出请求。</p><p id="f30f" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">但是这有什么意义呢？如果黑客能够进入受害者的电脑，他就能够窃取会话cookie，这将更加有用。</p><h1 id="965b" class="ln lo it bd lp lq lr ls lt lu lv lw lx jz ly ka lz kc ma kd mb kf mc kg md me bi translated">CSRF得到的请求并不真的危险</h1><p id="6d56" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">一个CSRF GET请求并不是真正的“攻击”，除非受害者的银行有一个设计糟糕的web应用，没有使用ReSTful APIs。</p><p id="d169" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">根据ReST，GET请求必须是安全的和幂等的。这意味着它不会在服务器上做任何改变，每次都做同样的事情。</p><p id="d34c" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果API不是ReSTful的，GET请求实际上可能会更新服务器上的内容。如果黑客知道GET请求的处理程序会做什么，那么网站肯定会被利用。</p><h1 id="2668" class="ln lo it bd lp lq lr ls lt lu lv lw lx jz ly ka lz kc ma kd mb kf mc kg md me bi translated">始终使用众所周知的浏览器</h1><p id="21f3" class="pw-post-body-paragraph kq kr it ks b kt mf ju kv kw mg jx ky kz mh lb lc ld mi lf lg lh mj lj lk ll im bi translated">重要的是，同源策略是现代浏览器提供的一个很好的安全特性。但是，请记住跨域GET请求(以及POST请求，我们将在下一篇文章中看到)确实会成功，只是您无法查看响应。</p><p id="4948" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在下一篇  <strong class="ks iu">文章</strong>的<a class="ae lm" href="https://davidklempfner.medium.com/simulating-a-csrf-attack-part-2-bf6f378da625" rel="noopener"> <strong class="ks iu">中，我将讨论可以被利用来执行实际攻击的POST请求，以及当您尝试发出PUT或DELETE请求时会发生什么。</strong></a></p></div></div>    
</body>
</html>