<html>
<head>
<title>A Secure way to use Credentials and Secrets in Azure Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Azure函数中使用凭证和机密的安全方式</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-secure-way-to-use-credentials-and-secrets-in-azure-functions-7ec91813c807?source=collection_archive---------4-----------------------#2020-10-30">https://levelup.gitconnected.com/a-secure-way-to-use-credentials-and-secrets-in-azure-functions-7ec91813c807?source=collection_archive---------4-----------------------#2020-10-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="818e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在Azure函数中引用和访问Azure Key Vault机密作为Node.js中的环境变量</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/177d59e03baa673e7e16db9b8da409ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GDfMrlqYz6cid-FLM_OmbA.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">安妮·斯普拉特在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="49c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Azure函数提供了一种很好的方式来存储和引用凭证、密钥和其他秘密，如<strong class="lb iu">应用程序设置<em class="lv"> s </em> </strong>。应用程序设置在执行过程中被暴露为<strong class="lb iu"> <em class="lv">环境变量</em> </strong>。应用程序设置在静态时加密，并通过加密通道传输。但是，您仍然面临着无意中将这些秘密暴露给未授权用户的风险。</p><p id="83e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">缓解这个问题的一个更好的方法是将凭证或密钥作为秘密存储在Azure Key Vault中，并在我们的Azure functions应用程序中作为环境变量引用这些秘密。</p><p id="26a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文将设置一个Azure functions应用程序来访问Azure Key Vault中存储的秘密。我们还将演示如何在Node.js函数中访问环境变量。</p><p id="94c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong> <em class="lv"> Microsoft Azure是一项付费服务，遵循本文可能会导致您或您的组织承担财务责任。</em></p><p id="32ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">在继续阅读本文之前，请阅读我们的使用条款:</em><a class="ae ky" href="https://dhyanintech.medium.com/disclaimer-disclosure-terms-of-use-fb3bfbd1e0e5" rel="noopener"><em class="lv">https://dhyanintech . medium . com/disclaimer-disclosure-disclosure-terms-of-use-fb3 BF BD 1e 0e 5</em></a></p><h1 id="0450" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">先决条件</h1><ol class=""><li id="3473" class="mo mp it lb b lc mq lf mr li ms lm mt lq mu lu mv mw mx my bi translated">有效的Microsoft Azure订阅</li><li id="4746" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">藏着秘密的天蓝色钥匙金库</li><li id="12df" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">Azure Functions应用程序(Node.js)</li></ol></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><h1 id="b1c3" class="lw lx it bd ly lz nl mb mc md nm mf mg jz nn ka mi kc no kd mk kf np kg mm mn bi translated">为您的应用程序创建托管身份</h1><p id="ea8e" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">Azure为资源和实体提供了两种身份；系统分配的受管身份和用户分配的受管身份。默认情况下，Azure functions应用没有身份，必须创建身份才能将functions应用连接到Azure Key Vault并对其进行身份验证。登录<a class="ae ky" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank"> Azure门户</a>，启动你的功能app。点击<strong class="lb iu">身份，</strong>将<strong class="lb iu">系统分配的</strong>标签下的上的状态设置为<strong class="lb iu">，并<strong class="lb iu">保存</strong>。等待任务完成；新的身份将出现在屏幕上。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/c7e33272e7d9bd3b3a4bd2fb0b78a21d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eegzCu_0qDTvPT39Y5QQlQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Azure Functions应用程序:创建托管身份(图片由作者提供)</figcaption></figure><blockquote class="nu nv nw"><p id="04a8" class="kz la lv lb b lc ld ju le lf lg jx lh nx lj lk ll ny ln lo lp nz lr ls lt lu im bi translated"><em class="it">在撰写本文时，Azure Key Vault reference仅支持系统分配的托管身份。</em></p></blockquote><p id="6ea3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">关于托管身份的进一步阅读:</em></p><div class="oa ob gp gr oc od"><a href="https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=javascript" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd iu gy z fp oi fr fs oj fu fw is bi translated">托管身份- Azure应用服务</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">本主题向您展示如何为App Service和Azure Functions应用程序创建托管身份，以及如何使用…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">docs.microsoft.com</p></div></div><div class="om l"><div class="on l oo op oq om or ks od"/></div></div></a></div><h1 id="472a" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">授予函数应用程序从Azure Key Vault读取机密的权限</h1><p id="963e" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">我们需要为刚刚创建的应用程序身份授予权限，以便从密钥库中读取机密。从门户打开您的密钥库，点击<strong class="lb iu">访问策略</strong>，选择<strong class="lb iu"> +添加访问策略</strong>。在添加访问策略屏幕上，为<strong class="lb iu">秘密权限</strong>选择<strong class="lb iu">获取</strong>。转到<strong class="lb iu">选择负责人</strong>并在<strong class="lb iu">负责人</strong>刀片上搜索您的功能app，从匹配的内容中选择您的功能app，并按图示进行操作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/2a574d2a7f74e788e8f0f849b90936c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L_Ajl7B70JcYLHx7mJJFlA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Azure密钥库:添加访问策略(图片由作者提供)</figcaption></figure><p id="9bee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">关于分配Azure Key Vault访问策略的附加阅读:</em></p><div class="oa ob gp gr oc od"><a href="https://docs.microsoft.com/en-us/azure/key-vault/general/assign-access-policy-portal" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd iu gy z fp oi fr fs oj fu fw is bi translated">分配Azure密钥保管库访问策略(门户)</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">密钥存储库访问策略决定了给定的服务主体(即应用程序或用户组)是否可以…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">docs.microsoft.com</p></div></div><div class="om l"><div class="ot l oo op oq om or ks od"/></div></div></a></div><h1 id="6110" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">Azure密钥保管库引用字符串</h1><p id="c018" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">Azure Key Vault引用的形式是<code class="fe ou ov ow ox b">@Microsoft.KeyVault({referenceString})</code>，其中<code class="fe ou ov ow ox b">{referenceString}</code>是秘密标识符，可以是URL形式，也可以是键值形式。我们很快就会看到他们两个。在你的密钥库中点击<strong class="lb iu">秘密</strong>，在你的功能应用中点击你想要引用的秘密，点击你的秘密的最新版本，并将<strong class="lb iu">秘密标识符</strong>复制到记事本。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/2d755e75e58c5e80e7c4ca7c0f466004.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TMabw-rZc1mXcN1GDTnR-Q.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Azure密钥库:获取秘密标识符(图片由作者提供)</figcaption></figure><p id="78fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看Azure Key Vault引用字符串的两种形式。我们将很快演示这两种方法。</p><h2 id="f059" class="oz lx it bd ly pa pb dn mc pc pd dp mg li pe pf mi lm pg ph mk lq pi pj mm pk bi translated"># URL表单</h2><p id="8b70" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">钥匙库里的秘密的完整URI，包括一个版本</p><pre class="kj kk kl km gt pl ox pm pn aw po bi"><span id="5c9c" class="oz lx it ox b gy pp pq l pr ps">@Microsoft.KeyVault(SecretUri=https://kv-restapi.vault.azure.net/secrets/PostgreSQL-Admin/e57d70bd9971412ebb2287f797d3a4)</span></pre><h2 id="ae70" class="oz lx it bd ly pa pb dn mc pc pd dp mg li pe pf mi lm pg ph mk lq pi pj mm pk bi translated">#键值形式</h2><pre class="kj kk kl km gt pl ox pm pn aw po bi"><span id="52e4" class="oz lx it ox b gy pp pq l pr ps">@Microsoft.KeyVault(VaultName=kv-restapi;SecretName=PostgreSQL-Admin;SecretVersion=e57d70bd9971412ebb2287f797d3a4)</span></pre><p id="6306" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">关于关键保险库参考的进一步阅读:</em></p><div class="oa ob gp gr oc od"><a href="https://docs.microsoft.com/en-us/azure/app-service/app-service-key-vault-references" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd iu gy z fp oi fr fs oj fu fw is bi translated">使用密钥保管库引用- Azure应用服务</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">本主题向您展示如何在您的应用服务或Azure Functions应用程序中使用来自Azure Key Vault的机密…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">docs.microsoft.com</p></div></div><div class="om l"><div class="pt l oo op oq om or ks od"/></div></div></a></div><h1 id="4e74" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">从密钥保管库到应用程序设置的源机密</h1><p id="9082" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">既然我们已经准备好了参考字符串并设置了访问权限，那么是时候将应用程序的秘密添加为应用程序设置了。打开你的功能app，进入<strong class="lb iu">配置</strong>，点击应用设置选项卡下的<strong class="lb iu"> +新应用设置</strong>。在<strong class="lb iu">添加/编辑应用设置</strong>刀片上，输入一个<strong class="lb iu">名称</strong>来标识您的秘密；该名称将在运行时作为函数中的环境变量。输入Azure Key Vault引用字符串作为<strong class="lb iu">值</strong>并点击<strong class="lb iu"> OK </strong>。如果你有多个秘密要参考，重复这个过程。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pu"><img src="../Images/55ebfd90d744a63ac97c8ba7f0df0ed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MWN5DcDQg8XiycisRHNK9g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Azure Functions App:添加应用程序设置(图片由作者提供)</figcaption></figure><p id="e6ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">关于应用程序设置的附加阅读:</em></p><div class="oa ob gp gr oc od"><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-app-settings" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd iu gy z fp oi fr fs oj fu fw is bi translated">Azure函数的应用设置参考</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">功能应用中的应用设置包含影响该功能应用的所有功能的全局配置选项…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">docs.microsoft.com</p></div></div><div class="om l"><div class="pv l oo op oq om or ks od"/></div></div></a></div><p id="fc9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您是否很想知道引用密钥库的秘密如何防止我们的凭据被暴露？让我们开始测试它。点击<strong class="lb iu">刷新</strong>；请注意，我们引用的机密的来源显示为<strong class="lb iu">密钥库引用</strong>。默认情况下，所有应用程序设置值都是隐藏的，单击其中一个密钥库引用的<strong class="lb iu">值</strong>，看看会发生什么。我们看到的不是秘密值，而是我们之前输入的引用字符串——我们的应用程序指向存储在密钥库中的秘密，而不是获取和存储它。点击一个关键保险库引用的<strong class="lb iu">名称</strong>调出<strong class="lb iu">添加/编辑应用设置</strong>刀片，注意刀片上可用的新细节部分，状态<strong class="lb iu">为</strong>。这有助于将来解决一些问题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pw"><img src="../Images/3aaa5c4f7ab48e0d161527a1865009cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*13SU1KqB3I4WD6L_llOipw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Azure Functions应用程序:测试密钥库引用(图片由作者提供)</figcaption></figure><h1 id="d399" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">在函数中访问环境变量</h1><p id="a99a" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">正如我们之前所讨论的，应用程序设置在执行期间被公开为<strong class="lb iu"> <em class="lv">环境变量</em> </strong>。我们可以使用<code class="fe ou ov ow ox b">process.env["APPLICATION_SETTING_NAME"]</code>来访问Node.js代码中的环境变量</p><blockquote class="px"><p id="16f9" class="py pz it bd qa qb qc qd qe qf qg lu dk translated"><em class="qh">应用程序设置有一个应用程序范围，可用于应用程序中的所有功能。</em></p></blockquote><p id="6fda" class="pw-post-body-paragraph kz la it lb b lc qi ju le lf qj jx lh li qk lk ll lm ql lo lp lq qm ls lt lu im bi translated">让我们看一个示例代码，演示如何在Node.js函数中访问环境变量。这个函数在执行过程中访问环境变量，并将值作为JSON响应返回给调用者。从浏览器和REST插件触发该函数的结果如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="qn qo l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qp"><img src="../Images/c13bcc7e90e4b44a5c6015182494a7a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D0o606l2KP4LjXy4EzYc-Q.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Azure函数:测试环境变量(图片由作者提供)</figcaption></figure><p id="409b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">赞美！你已成功将Azure Key Vault中的机密引用到你的Azure Functions应用，而没有以纯文本形式存储它们。</p><h1 id="97e5" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">结论</h1><p id="d99d" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">我们学习了如何为Azure Functions应用程序创建系统分配的托管身份，以及如何在Azure Key Vault中创建访问策略。我们引用了Azure Key Vault secrets作为应用程序设置，并学习了如何在Node.js函数中访问环境变量。我们可以得出结论，引用Azure Key Vault secrets是在Azure Functions应用程序中使用凭据和密钥的一种安全可靠的方式。</p><h1 id="2108" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">后续步骤</h1><p id="72a1" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">我们有一篇很棒的文章，是关于解决关键保险库引用问题的。去解决你遇到的错误。</p><div class="oa ob gp gr oc od"><a href="https://dhyanintech.medium.com/troubleshooting-azure-key-vault-references-in-azure-function-apps-b228c1216f63" rel="noopener follow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd iu gy z fp oi fr fs oj fu fw is bi translated">Azure Function应用中Azure密钥库引用的故障排除</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">一个方便的傻瓜指南，用于解决函数应用程序中的Azure Key Vault引用错误</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">dhyanintech.medium.com</p></div></div><div class="om l"><div class="qq l oo op oq om or ks od"/></div></div></a></div></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><h2 id="eecb" class="oz lx it bd ly pa pb dn mc pc pd dp mg li pe pf mi lm pg ph mk lq pi pj mm pk bi translated">喜欢这个帖子？与Dhyan联系</h2><p id="4bb0" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">让我们做朋友吧！你可以在<a class="ae ky" href="https://www.linkedin.com/in/dhyans/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上找到我或者在<a class="ae ky" href="https://dhyanintech.medium.com/membership" rel="noopener"> Medium </a>上<strong class="lb iu">加入</strong>我。</p></div></div>    
</body>
</html>