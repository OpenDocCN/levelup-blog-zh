<html>
<head>
<title>Angular — environment configuration at runtime</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">角度—运行时的环境配置</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/angular-environment-configuration-at-runtime-b44e230da585?source=collection_archive---------3-----------------------#2022-07-03">https://levelup.gitconnected.com/angular-environment-configuration-at-runtime-b44e230da585?source=collection_archive---------3-----------------------#2022-07-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6151" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">构建一次应用程序，并在运行时为任何阶段注入环境配置</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/d4d5c821c0e5462b828535aef3a3d75d.png" data-original-src="https://miro.medium.com/v2/resize:fit:672/format:webp/1*XNmM5WYgFkAlha2BVXbdeA.png"/></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">在<a class="ae ku" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ku" href="https://unsplash.com/@ajonesyyyyy?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Jarrod Erbe </a>拍照</figcaption></figure><p id="2427" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">今天的主题是关于部署Angular应用程序。通常，我们希望将应用程序部署到多个阶段，例如开发、测试和生产环境。一般来说，应该在每个环境中部署相同的代码，但是，某些参数，如后端的URL或身份验证变量，可能会有所不同。通常，<strong class="kx iu">环境. ts </strong>文件用于此目的，这些文件通常已经由Angular CLI为新项目自动创建。在本文中，我介绍了加载环境参数的另一种方法以及它提供的好处。</p><h2 id="bb13" class="lr ls it bd lt lu lv dn lw lx ly dp lz le ma mb mc li md me mf lm mg mh mi mj bi translated">为什么不是环境文件？</h2><p id="66d7" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">让我们首先澄清为什么Angular暗示的方式可能不是注入环境配置的最佳选择。我想你们大多数人都熟悉Angular的<strong class="kx iu">环境. ts </strong>文件，并像我一样使用它们来配置不同的环境。虽然这种方法并非完全错误，而且确实很有效，但是它也有一个缺点。</p><p id="17d1" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">为了使用不同的文件，我们需要通过使用某些命令来构建应用程序，用在<strong class="kx iu"> angular.json </strong>文件中配置的相应文件替换<strong class="kx iu"> environment.ts </strong>文件。这一切都发生在编译时，这正是这种方法的问题所在。</p><h2 id="8ffc" class="lr ls it bd lt lu lv dn lw lx ly dp lz le ma mb mc li md me mf lm mg mh mi mj bi translated">编译时与运行时</h2><p id="4270" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">因此，对于编译时配置，我们必须在编译期间将环境变量注入到应用程序中。因此，我们需要为每个环境构建一个新的版本。然而，使用运行时配置，我们可以在应用程序启动时读取环境变量。一个巨大的好处是我们可以在任何环境下使用相同的构建。</p><p id="38cf" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们现在已经简要讨论了<strong class="kx iu"> environment.ts </strong>文件以及编译时和运行时配置之间的区别。接下来，让我们检查一个例子，看看在启动应用程序时如何注入环境参数。</p><h2 id="d264" class="lr ls it bd lt lu lv dn lw lx ly dp lz le ma mb mc li md me mf lm mg mh mi mj bi translated">运行时方法</h2><p id="0f81" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">过程如下:一旦应用程序启动，我们就使用一个简单的JSON文件和一个HTTP请求加载所需的环境变量。因此，我们首先创建一个新的服务。以下Angular CLI命令对此有所帮助:</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="3c8e" class="lr ls it mq b gy mu mv l mw mx">ng generate service environment-loader</span></pre><p id="f022" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们在服务中实现了两个方法。一个用于加载我们的配置，另一个用作获取器:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="4b3b" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><code class="fe na nb nc mq b">loadEnvConfig</code>接收<code class="fe na nb nc mq b">configPath</code>作为参数，然后执行一个简单的GET请求。注意，这里我们使用RxJs的<code class="fe na nb nc mq b">lastValueFrom</code>函数，它将一个可观察值转换为一个承诺。这很有用，因为应用程序在继续之前会等待承诺得到解决。</p><p id="fee6" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">如上所述，<code class="fe na nb nc mq b">getEnvConfig</code>是一个简单的getter函数，可以在整个应用程序中用来检索配置数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="fb10" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">接下来，我们需要告诉Angular在启动时调用我们的<code class="fe na nb nc mq b">loadEnvConfig</code>方法。我们可以利用<code class="fe na nb nc mq b">APP_INITIALIZER</code>令牌来做到这一点。这个令牌用于调用我们的<code class="fe na nb nc mq b">EnvironmentLoaderService</code>的工厂函数。该功能将在应用程序启动过程中执行，配置数据将在启动时可用。一个例子如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="f1d1" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们有了自己的<code class="fe na nb nc mq b">initAppFn</code>工厂，并将其添加到<code class="fe na nb nc mq b">AppModule</code>的providers数组中的<code class="fe na nb nc mq b">APP_INITIALIZER</code>标记中。当我们在工厂中调用<code class="fe na nb nc mq b">EnvironmentLoaderService</code>时，我们将它添加到令牌的依赖项中。</p><p id="5bdc" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在我们已经做好了一切准备，可以在启动时加载我们的配置了。在这种情况下，JSON是从assets文件夹中检索的，但是您也可以从任何地方请求它。在您的部署管道中，您需要确保提取正确的配置文件。</p><p id="1a4f" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">查看这个StackBlitz，获得一个小的工作示例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd mz l"/></div></figure><h2 id="f63e" class="lr ls it bd lt lu lv dn lw lx ly dp lz le ma mb mc li md me mf lm mg mh mi mj bi translated">好处</h2><p id="1f77" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">我已经就运行时方法的优势给出了一些提示，但是让我们总结一下。尽管这两个概念都可行，但我会选择在运行时加载我的配置(至少在任何具有多个阶段的适当构建和部署管道的项目中)。这允许相同的代码(完全相同的二进制文件)用于所有阶段。</p><p id="d7e9" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">除了节省时间，因为需要的构建更少，这还可以避免阶段之间的错误，因为重新编译的代码中可能会有变化。</p></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><p id="0557" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在<a class="ae ku" href="https://saackef.com/" rel="noopener ugc nofollow" target="_blank"> Medium </a>或<a class="ae ku" href="https://twitter.com/sw3eks" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我，阅读更多关于Angular的内容！</p></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><h1 id="1d1e" class="nl ls it bd lt nm nn no lw np nq nr lz jz ns ka mc kc nt kd mf kf nu kg mi nv bi translated">分级编码</h1><p id="8aa4" class="pw-post-body-paragraph kv kw it kx b ky mk ju la lb ml jx ld le mm lg lh li mn lk ll lm mo lo lp lq im bi translated">感谢您成为我们社区的一员！更多内容见<a class="ae ku" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">级编码出版物</a>。<br/>跟随:<a class="ae ku" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a>，<a class="ae ku" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">领英</a>，<a class="ae ku" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">通迅</a> <br/> <strong class="kx iu">升一级正在改造理工大招聘➡️ </strong> <a class="ae ku" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kx iu">加入我们的人才集体</strong> </a></p></div></div>    
</body>
</html>