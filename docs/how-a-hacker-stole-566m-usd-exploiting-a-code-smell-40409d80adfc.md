# 黑客如何利用代码气味窃取了 5.66 亿美元

> 原文：<https://levelup.gitconnected.com/how-a-hacker-stole-566m-usd-exploiting-a-code-smell-40409d80adfc>

## 我不是安全专家。但是我确实喜欢干净的代码和代码气味

![](img/94a550daac9ca52fc062ad032a7f757e.png)

> *TL；大卫:不要相信你的散列。*

# 黑客

昨天，2022 年 10 月 7 日，一个更大的区块链不得不停止。

[这条新闻](https://www.coindesk.com/business/2022/10/06/binance-linked-bnb-price-falls-close-to-4-on-hack-rumors/)令人震惊，因为大多数区块链从定义上来说是分散的。

停止大型区块链并不是什么新闻。

[](https://blog.devgenius.io/web3-for-dummies-part-01-what-is-a-blockchain-9176e32027db) [## Web3 For Dummies —第一部分—什么是区块链？

### TL；DR:在这个系列中，我们将从非常区块链的基础知识谈到构建一个复杂的 DAPP。

blog.devgenius.io](https://blog.devgenius.io/web3-for-dummies-part-01-what-is-a-blockchain-9176e32027db) 

也不是第一个[的](https://biz.crast.net/terra-blockchain-paused-to-prevent-attacks-after-luna-token-crashes-almost-100-overnight/)。

# 原因

我关注[区块链](https://blog.devgenius.io/web3-for-dummies-part-01-what-is-a-blockchain-9176e32027db)和安全新闻。

这远远不是我写技术文章的舒适区。

我已经写了 180 多个[代码闻](https://blog.devgenius.io/how-to-find-the-stinky-parts-of-your-code-fa8df47fc39c)和[重构](https://blog.devgenius.io/refactoring-001-remove-setters-e5acdf60462c)。

以正确、干净的方式做事和性能优化之间总是存在矛盾。

区块链应该很快。

许多漏洞都与加密和优化的代码有关。

这种代码在许多关键任务的大型系统和代码库中是不可接受的。

性能和安全性是 Web3 的主要驱动力，因此区块链和合同代码通常都有漏洞。

干净的代码不容易被利用。

# 问题是

我读过很多关于这个问题的法医分析。

最好的解释之一是:

[](https://twitter.com/1578167198203289600) [## JavaScript 不可用。

### 编辑描述

twitter.com](https://twitter.com/1578167198203289600) 

这条[推文](https://twitter.com/samczsun/status/1578167198203289600)有很多可供研究的资源。

我将阐述其主要观点:

> *重要的是，由于哈希函数的工作方式，我们基本上可以肯定地说，任何(path，nleaf)对都将产生唯一的哈希。如果我们想伪造证据，这些需要保持不变*
> 
> 总之，币安桥验证证据的方式存在缺陷，这使得攻击者能够伪造任意消息。幸运的是，这里的攻击者只伪造了两条消息，但是损失可能会更大
> 
> *TL；DR:哈希函数被利用了。*

# 杂烩

几十年来我一直在使用散列函数(当然不是在区块链)。

有很多关于数学散列函数的研究。

我们在大学教我们的学生关于[哈希冲突](https://en.wikipedia.org/wiki/Hash_collision)以及我们如何努力创建[数学函数](https://en.wikipedia.org/wiki/Hash_function)来避免它们。

我们也教他们一些推论:

> *具有相同散列的两个对象可能不相同。*
> 
> *如果我们覆盖一个对象的相等性，我们也需要覆盖散列。*

最后一个对于散列集合非常重要。

一堂干净的代码课应该是:

> *用(快)哈希进行快速丢弃，用(慢)等式保证自己是对的。*

现在，我需要回到我的舒适区，用我已经使用多年的标准代码味道模板来写这一课。

如果你喜欢这种格式，你可以在这里阅读更多 166:

[](https://blog.devgenius.io/how-to-find-the-stinky-parts-of-your-code-fa8df47fc39c) [## 如何找到你的代码中有问题的部分

### 代码很难闻。让我们看看如何改变香味。

blog.devgenius.io](https://blog.devgenius.io/how-to-find-the-stinky-parts-of-your-code-fa8df47fc39c) 

# 图像制作者名单

你看到的漂亮的封面图片是一个 PNG 图片，它本身就是 hash。

看完整的故事[这里](https://twitter.com/David3141593/status/1573218394358386688):

[](https://twitter.com/1573218394358386688) [## JavaScript 不可用。

### 编辑描述

twitter.com](https://twitter.com/1573218394358386688) 

还有[系列](https://blog.devgenius.io/how-to-find-the-stinky-parts-of-your-code-fa8df47fc39c)格式里的码味…

# 代码气味 167 —哈希比较

*哈希保证两个对象是不同的。不是说他们是一样的*

> *TL；DR:如果你检查散列，你也应该检查相等性*

# 问题

*   [双射故障](https://codeburst.io/the-one-and-only-software-design-principle-5328420712af)

# 解决方法

1.  检查哈希(快速)，然后检查相等性(慢速)

# 示例代码

## 错误的

```
public class Person {public String name;
// Public attributes are another smell   @Override
 public boolean equals(Person anotherPerson) {
   return name.equals(anotherPerson.name); 
 }@Override
 public int hashCode() {
   return (int)(Math.random()*256); 
 }
 // This is just an example of non correlation   // When using HashMaps we can make a mistake 
 // and guess the object is not present in the collection}
```

## 对吧

```
public class Person {public String name;
// Public attributes are another smell   @Override
 public boolean equals(Person anotherPerson) {
   return name.equals(anotherPerson.name); 
 }@Override
 public int hashCode() {
   return name.hashCode(); 
 }
 // This is just an example of non correlation }
```

# 侦查

[X]半自动

许多 linters 都有散列和相等重定义的规则。

通过突变测试，我们可以用相同的散列来播种不同的对象，并检查我们的测试。

# 标签

*   身份
*   安全性

# 结论

每一种性能改进都有其缺点。

缓存和复制是显著的例子。

我们可以(必须)小心使用它们。

# 关系

[](https://blog.devgenius.io/code-smell-49-caches-d2e64373b838) [## 代码气味 49 —缓存

### 储藏处很性感。他们是一夜情。我们需要在长期关系中避开它们。

blog.devgenius.io](https://blog.devgenius.io/code-smell-49-caches-d2e64373b838) [](/code-smell-150-equal-comparison-4a3d1eed823d) [## 代码气味 150 —同等比较

### 每个开发人员都平等地比较属性。他们错了。

levelup.gitconnected.com](/code-smell-150-equal-comparison-4a3d1eed823d) 

# 更多信息

[相等和散列](http://forum.world.st/Is-it-always-needed-to-redefine-hash-message-when-you-redefine-message-td4828721.html)

[Java 中的 Hashcode](https://stackoverflow.com/questions/3563847/what-is-the-use-of-hashcode-in-java)

[Hashcode vs Equal](https://www.digitalocean.com/community/tutorials/java-equals-hashcode)

# 放弃

代码气味只是我的[观点](https://mcsee.medium.com/i-wrote-more-than-90-articles-on-2021-here-is-what-i-learned-76c238f9936f)。

> 这可能会让你的一些读者感到惊讶，但我的主要兴趣不是计算机安全。我主要对编写能按预期工作的软件感兴趣。

*Wietse Venema*

[](https://blog.devgenius.io/software-engineering-great-quotes-3af63cea6782) [## 软件工程名言

### 有时一个简短的想法可以带来惊人的想法。

blog.devgenius.io](https://blog.devgenius.io/software-engineering-great-quotes-3af63cea6782)