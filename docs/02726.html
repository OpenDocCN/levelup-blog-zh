<html>
<head>
<title>Test Angular Components and Services With HTTP Mocks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用HTTP模拟测试Angular组件和服务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/test-angular-components-and-services-with-http-mocks-e143d90fa27d?source=collection_archive---------0-----------------------#2020-04-01">https://levelup.gitconnected.com/test-angular-components-and-services-with-http-mocks-e143d90fa27d?source=collection_archive---------0-----------------------#2020-04-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7306" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在模拟HTTP请求的帮助下测试Angular组件和服务</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/92c8d9b5ad99aa351f56a9750fd37f89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ARj7jYIrVb-eR7B0OOD2Zg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Josue Isai Ramos Figueroa 在<a class="ae ky" href="https://unsplash.com/s/photos/free?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="30b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我每天分享<a class="ae ky" href="https://medium.com/@david.dalbusco/one-trick-a-day-d-34-469a0336a07e" rel="noopener">一个窍门</a>直到2020年4月19日新冠肺炎隔离期结束。离希望中的好日子还有18天。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="eb69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有一天，我正在为我的一个客户的新项目编写一些测试，我正要模拟我的服务功能，突然我有了一个想法:如果我不模拟我的服务功能，而是模拟我所有测试的全局HTTP请求，目的是在测试我的组件的同时也测试我的服务逻辑，会怎么样🤔</p><p id="a903" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我能够实现这个目标，这就是为什么我在这篇新的博文中分享我的学习。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="aa3c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">设置</h1><p id="5438" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">让我们定义一个简单的设置作为例子。</p><p id="df9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们有一个<code class="fe mz na nb nc b">service</code>，它公开了一个HTTP请求。出于本教程的目的，我们可以使用<a class="ae ky" href="https://dog.ceo/dog-api/" rel="noopener ugc nofollow" target="_blank">狗API </a>提供的令人惊叹的免费开源API。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="b27a" class="nh md it nc b gy ni nj l nk nl">import {Injectable} from '@angular/core';<br/>import {HttpClient} from '@angular/common/http';<br/><br/>import {Observable} from 'rxjs';<br/><br/>export interface Dog {<br/>  message: string;<br/>  status: string;<br/>}<br/><br/>@Injectable({<br/>  providedIn: 'root'<br/>})<br/>export class DogService {<br/><br/>  constructor(private httpClient: HttpClient) {<br/>  }<br/><br/>  randomDog(): Observable&lt;Dog&gt; {<br/>    return this.httpClient<br/>               .get&lt;Dog&gt;(`https://dog.ceo/api/breeds/image/random`);<br/>  }<br/>}</span></pre><p id="56aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以及显示随机狗的组件。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="bd76" class="nh md it nc b gy ni nj l nk nl">import {Component} from '@angular/core';<br/><br/>import {Observable} from 'rxjs';<br/><br/>import {Dog, DogService} from '../dog.service';<br/><br/>@Component({<br/>  selector: 'app-dog',<br/>  template: `&lt;img *ngIf="doggo$ | async as doggo" <br/>                  [src]="doggo.message"&gt;`<br/>})<br/>export class DogComponent {<br/><br/>  doggo$: Observable&lt;Dog&gt;;<br/><br/>  constructor(private dogService: DogService) {<br/>    this.doggo$ = dogService.randomDog();<br/>  }<br/>  <br/>}</span></pre><p id="d599" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你测试这个组件，在你的浏览器中渲染，你应该会发现一只像这只可爱的牛头犬一样的好狗狗。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/78b76c2cefae3e8a3037a887ad3964e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nEw8NxG6y8xwPwOe9YXf4g.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3290" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用HTTP请求测试服务</h1><p id="7176" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">因为我们要为我们的HTTP请求开发一个模拟，所以我们可以从测试我们的服务开始。</p><p id="21a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了测试我们的服务，我们将利用Angular提供的<a class="ae ky" href="https://angular.io/api/common/http/testing/HttpClientTestingModule" rel="noopener ugc nofollow" target="_blank">HttpClientTestingModule</a>，正如<a class="ae ky" href="https://medium.com/@Jestfer?source=post_page-----3880ceac74cf----------------------" rel="noopener">霍苏埃·埃斯特韦斯·费尔南德斯</a>在他关于<a class="ae ky" href="https://medium.com/better-programming/testing-http-requests-in-angular-with-httpclienttestingmodule-3880ceac74cf" rel="noopener">角度测试</a>的精彩文章中所描述的那样。</p><p id="ab34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基本上，我们所做的是订阅我们的服务公开函数<code class="fe mz na nb nc b">randomDog()</code>,以便排除一个应该是我们模拟数据的结果。为了触发结果，我们指示控制器我们只想使用<code class="fe mz na nb nc b">exceptOne</code>执行一个查询，最后我们用模拟数据<code class="fe mz na nb nc b">flush</code>响应，这将导致我们的观察者进行解析。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="164c" class="nh md it nc b gy ni nj l nk nl">import { TestBed<strong class="nc iu"><em class="nn"> </em></strong>} from '@angular/core/testing';<br/>import {HttpClientTestingModule, HttpTestingController} <br/>       from '@angular/common/http/testing';<br/><br/>import {Dog, DogService} from './dog.service';<br/><br/>export const mockDog: Dog = {<br/>    message: <br/>    'https://images.dog.ceo/breeds/hound-basset/n02088238_9815.jpg',<br/>    status: 'success'<br/>};<br/><br/>describe('DogService', () =&gt; {<br/>  let httpTestingController: HttpTestingController;<br/>  let service: DogService;<br/><br/>  beforeEach(() =&gt; {<br/>    TestBed.configureTestingModule({<br/>      providers: [DogService],<br/>      imports: [HttpClientTestingModule]<br/>    });<br/><br/>    httpTestingController = TestBed.get(HttpTestingController);<br/>    service = TestBed.get(DogService);<br/>  });<br/><br/>  afterEach(() =&gt; {<br/>    httpTestingController.verify();<br/>  });<br/><br/>  it('should be created', () =&gt; {<br/>    expect(service).toBeTruthy();<br/>  });<br/><br/>  it('random should should provide data', () =&gt; {<br/>    service.randomDog().subscribe((dog: Dog) =&gt; {<br/>      expect(dog).not.toBe(null);<br/>      expect(JSON.stringify(dog)).toEqual(JSON.stringify(mockDog));<br/>    });<br/><br/>    const req = httpTestingController<br/>              .expectOne(`https://dog.ceo/api/breeds/image/random`);<br/><br/>    req.flush(mockDog);<br/>  });<br/>});</span></pre><p id="2a97" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您运行测试(<code class="fe mz na nb nc b">npm run test</code>)，应该会成功。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/81baffedd4d6a833a7e617ed39a8f422.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ko-H8QOYgTlx4xuB9hhhSQ.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="42d2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">用HTTP请求模拟测试组件</h1><p id="9559" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在有趣的部分来了😉。我们的目标是在不“接触”服务的情况下测试我们的组件，而是模拟这些组件使用的所有HTTP请求。</p><p id="96b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们创建了一个定制的<code class="fe mz na nb nc b">HttpInterceptor</code>，正如<a class="ae ky" href="https://dev.to/sanidz" rel="noopener ugc nofollow" target="_blank"> sanidz </a>在他/她的关于<a class="ae ky" href="https://dev.to/sanidz/angular-http-mock-interceptor-for-mocked-backend-1h5g" rel="noopener ugc nofollow" target="_blank">模仿拦截器</a>的超级文章中解释的那样，它应该负责拦截请求，并在我们需要时用我们的模仿数据覆盖我们的调用。在我们的示例中，如果DOG api被击中，我们希望用我们之前定义的模拟数据来回答，以测试我们的服务。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="8a76" class="nh md it nc b gy ni nj l nk nl">import { Injectable, Injector } from '@angular/core';<br/>import { HttpEvent, HttpHandler, HttpInterceptor, HttpRequest, HttpResponse } from '@angular/common/http';<br/><br/>import { Observable, of } from 'rxjs';<br/><br/>import {mockDog} from './dog.service.spec';<br/><br/>@Injectable()<br/>export class HttpRequestInterceptorMock implements HttpInterceptor {<br/>    constructor(private injector: Injector) {}<br/><br/>    intercept(request: HttpRequest&lt;any&gt;, next: HttpHandler): <br/>              Observable&lt;HttpEvent&lt;any&gt;&gt; {<br/>        if (request.url &amp;&amp; request.url<br/>         .indexOf(`https://dog.ceo/api/breeds/image/random`) &gt; -1) {<br/>            return<br/>              of(new HttpResponse({ status: 200, body: mockDog<strong class="nc iu"><em class="nn"> </em></strong>}));<br/>        }<br/><br/>        return next.handle(request);<br/>    }<br/>}</span></pre><p id="5a8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在创建上面的拦截器时，您可能会面临一个关于装饰器的typescript错误。如果是这种情况，您可以通过启用<code class="fe mz na nb nc b">tsconfig.spec.json</code>中的<code class="fe mz na nb nc b">experimentalDecorators</code>来解决。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="e1e4" class="nh md it nc b gy ni nj l nk nl">{<br/>  "extends": "./tsconfig.json",<br/>  "compilerOptions": {<br/>    "outDir": "./out-tsc/spec",<br/>    "experimentalDecorators": true, &lt;- enable experimental decorator<br/>    "types": [<br/>      "jasmine",<br/>      "node"<br/>    ]<br/>  },<br/>  "files": [<br/>    "src/test.ts",<br/>    "src/polyfills.ts"<br/>  ],<br/>  "include": [<br/>    "src/**/*.spec.ts",<br/>    "src/**/*.d.ts"<br/>  ]<br/>}</span></pre><p id="b632" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">拦截器已经设置好了，现在我们可以测试我们的组件了。我们将再次使用HttpClientTestingModule，此外，我们还为测试配置提供了HTTP拦截器。这样，对于每个请求，我们的拦截器都将被触发，我们将能够模拟我们的数据。我们还使用这些来确保组件的图像与我们定义为mock的图像相匹配。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="424e" class="nh md it nc b gy ni nj l nk nl">import {async, ComponentFixture, TestBed}<br/>       from '@angular/core/testing';<br/>import {HttpClientTestingModule}<br/>       from '@angular/common/http/testing';<br/>import {HTTP_INTERCEPTORS} from '@angular/common/http';<br/><br/>import {HttpRequestInterceptorMock} <br/>       from '../http-request-interceptor.mock';<br/><br/>import {mockDog} from '../dog.service.spec';<br/><br/>import {DogComponent} from './dog.component';<br/><br/>describe('DogComponent', () =&gt; {<br/>  let component: DogComponent;<br/>  let fixture: ComponentFixture&lt;DogComponent&gt;;<br/><br/>  beforeEach(async(() =&gt; {<br/>    TestBed.configureTestingModule({<br/>      declarations: [DogComponent],<br/>      imports: [<br/>        HttpClientTestingModule<br/>      ],<br/>      providers: [<br/>        {<br/>          provide: HTTP_INTERCEPTORS,<br/>          useClass: HttpRequestInterceptorMock,<br/>          multi: true<br/>        }<br/>      ]<br/>    }).compileComponents();<br/>  }));<br/><br/>  beforeEach(() =&gt; {<br/>    fixture = TestBed.createComponent(DogComponent);<br/>    component = fixture.componentInstance;<br/>    fixture.detectChanges();<br/>  });<br/><br/>  it('should create', () =&gt; {<br/>    expect(component).toBeTruthy();<br/>  });<br/><br/>  it('should render image', async () =&gt; {<br/>    const img: HTMLImageElement = <br/>          fixture.debugElement.nativeElement.querySelector('img');<br/><br/>    expect(img).not.toBe(null);<br/>    expect(mockDog.message === img.src).toBe(true);<br/>  });<br/>});</span></pre><p id="9df7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是它，它是超级的，此外，除了能够测试我们的组件，我们还能够同时测试我们的服务🥳.</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/152715b54e486fcd2aae78840c7f2f3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S9NnYvTRXnX0ztI0WZkkag.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0b74" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">摘要</h1><p id="1d48" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我真的很感激从<a class="ae ky" href="https://medium.com/@Jestfer?source=post_page-----3880ceac74cf----------------------" rel="noopener">霍苏埃·埃斯特韦斯·费尔南德斯</a>和<a class="ae ky" href="https://dev.to/sanidz" rel="noopener ugc nofollow" target="_blank">萨尼兹</a>那里找到有用的建议。设置现在已经就绪，我可以真正地在项目开发中取得进展，同时能够添加有意义的测试，至少对我来说是这样😉。我希望这个方法有一天也能帮助你。</p><p id="79b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">呆在家里，注意安全！</p><p id="1974" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大卫</p></div></div>    
</body>
</html>