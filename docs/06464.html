<html>
<head>
<title>How to write a million rows in an Excel file efficiently</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何高效地在Excel文件中写入一百万行</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-write-a-million-rows-in-an-excel-file-efficiently-5f7ce6c69314?source=collection_archive---------0-----------------------#2020-11-28">https://levelup.gitconnected.com/how-to-write-a-million-rows-in-an-excel-file-efficiently-5f7ce6c69314?source=collection_archive---------0-----------------------#2020-11-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f3ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经有了Apache提供的<a class="ae kl" href="https://poi.apache.org/apidocs/dev/org/apache/poi/xssf/usermodel/XSSFWorkbook.html" rel="noopener ugc nofollow" target="_blank"> POI实用程序</a>来用Java写/读excel文件。如果文件中要插入的行数少于50K，可以使用任何excel工具。但是，当我们有一个在excel文件中插入一百万行的用例时，我们需要查看实用程序，以找到最适合我们用例的实用程序。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/c7cf9a15930017759179ad0d505d2748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8LW24TI04gAbfmjItkQurA.png"/></div></div></figure><p id="fa85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们举个例子来更好地理解它。假设我们的Java应用程序为用户从Elasticsearch查询的文档生成一个报告。给定的查询有100万个文档要返回，所以查询应该分批进行，以避免Elasticsearch如此大的响应(100万个文档)。定义批量大小(假设<strong class="jp ir"> 5000 </strong>)。现在，有两种方法可以从Elasticsearch获得响应并将它们插入到一个文件中。</p></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><h2 id="f2f8" class="lf lg iq bd lh li lj dn lk ll lm dp ln jy lo lp lq kc lr ls lt kg lu lv lw lx bi translated">方法A</h2><ol class=""><li id="5380" class="ly lz iq jp b jq ma ju mb jy mc kc md kg me kk mf mg mh mi bi translated">创建一个excel文件。</li><li id="04c3" class="ly lz iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">开始循环的总文件数/5000次。</li><li id="cc78" class="ly lz iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">对于每一次迭代，从Elasticsearch(或任何数据源)获取文档(最多5000个)。</li><li id="71cd" class="ly lz iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">将文档附加到excel文件中。每当我们向该文件追加文档时，它就会在内存中打开。</li></ol><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mo mp l"/></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mq"><img src="../Images/1f237ee864af8ea1424b83d87fc91f35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fc2hCTEP_m5j64UIQO_iFg.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">方法A的堆内存占用，总行数:10万，批处理大小:5000</figcaption></figure></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><h2 id="ba51" class="lf lg iq bd lh li lj dn lk ll lm dp ln jy lo lp lq kc lr ls lt kg lu lv lw lx bi translated">方法B(使用<a class="ae kl" href="https://poi.apache.org/apidocs/dev/org/apache/poi/xssf/streaming/SXSSFWorkbook.html" rel="noopener ugc nofollow" target="_blank"> excel流API </a></h2><ol class=""><li id="96ab" class="ly lz iq jp b jq ma ju mb jy mc kc md kg me kk mf mg mh mi bi translated">开始循环的总文件数/5000次。</li><li id="602c" class="ly lz iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">对于每次迭代，从Elasticsearch(可以是任何数据源)获取文档(最多5000个),并将它们存储在HashMap中。</li><li id="2b0c" class="ly lz iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">一旦HashMap准备好了所有的文档，就使用excel stream实用程序将所有的文档(或行)插入到文件中。</li></ol><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mo mp l"/></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mv"><img src="../Images/715bcd11880a6661eb2105c8a45d59d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q1bhWAKiVLtk9Mg6osVpHQ.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">方法B的堆内存占用，总行数:10万，全部在一个批处理中</figcaption></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mw"><img src="../Images/05d0071b50c50f2c335eee304fbaca48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mSpozQMIVni1FzSqqIoyDg.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">方法B的堆内存占用，总行数:1百万，全部在一个批处理中</figcaption></figure></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><h2 id="b747" class="lf lg iq bd lh li lj dn lk ll lm dp ln jy lo lp lq kc lr ls lt kg lu lv lw lx bi translated">观察结果:</h2><ol class=""><li id="94e8" class="ly lz iq jp b jq ma ju mb jy mc kc md kg me kk mf mg mh mi bi translated">方法B ( <strong class="jp ir"> 350 MB </strong>)显示了更好的内存占用。(方法A需要<strong class="jp ir"> 3 GB </strong>左右)。</li><li id="d755" class="ly lz iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">方法B花费<strong class="jp ir"> 5秒</strong>，方法A花费<strong class="jp ir"> 1分56秒</strong>插入所有文件。</li><li id="df38" class="ly lz iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">在上面的例子中，方法A将整个文件保存在内存中，而方法B只将第<strong class="jp ir"> 1行</strong>保存在内存中。<br/><strong class="jp ir">sxssf workbook workbook = new sxssf workbook(1)</strong></li><li id="760d" class="ly lz iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">无法在追加模式下打开SXSSFWorkbook。</li><li id="4216" class="ly lz iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">即使使用<strong class="jp ir"> 16 GB </strong>堆内存，使用方法A也无法增加100万行。</li></ol><p id="7aad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢阅读！</p></div></div>    
</body>
</html>