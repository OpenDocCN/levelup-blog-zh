<html>
<head>
<title>Integrate Azure AD B2C profile editing user flow in angular using oidc-client-js.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用oidc-client-js在angular中集成Azure AD B2C配置文件编辑用户流。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/integrate-azure-ad-b2c-profile-editing-user-flow-in-angular-using-oidc-client-js-81265f8e8fbf?source=collection_archive---------3-----------------------#2020-10-24">https://levelup.gitconnected.com/integrate-azure-ad-b2c-profile-editing-user-flow-in-angular-using-oidc-client-js-81265f8e8fbf?source=collection_archive---------3-----------------------#2020-10-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/2c5df25ec8baf1df6e5662daef8bfd3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dCkNpuPNxhhZEqqai77msw.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由来自<a class="ae kf" href="https://www.pexels.com/photo/internet-technology-computer-display-360591/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a>的<a class="ae kf" href="https://www.pexels.com/@markusspiske?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Markus Spiske </a>拍摄</figcaption></figure><p id="c61b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇文章是我几个月前写的关于<a class="ae kf" href="https://www.taithienbo.com/how-to-authenticate-user-against-azure-adb2c-from-angular-app-using-oidc-client-js/" rel="noopener ugc nofollow" target="_blank">如何使用oidc-client-js </a>对来自angular app的Azure ADB2C用户进行身份验证的博客文章的延续。在那篇文章中，我讨论了如何集成AD B2C注册和登录流程，以允许用户针对AD B2C进行身份验证。在这篇文章中，我将展示一个集成编辑概要用户流的例子。您可以在这里找到附带的示例项目<a class="ae kf" href="https://github.com/taithienbo/oidc-client-js-azure-integration-ex" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="2443" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我假设您对angular和Rxjs有一些基本的了解，并且主要关注与集成编辑用户流相关的方面。如果您对代码有任何疑问，请随时联系我们。</p><p id="c4bd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，请查看下一篇与oidc-client-js相关的<a class="ae kf" href="https://www.taithienbo.com/integrate-azure-ad-b2c-reset-password-user-flow-in-angular-using-oidc-client-js/" rel="noopener ugc nofollow" target="_blank">帖子</a>，在这篇帖子中，我将介绍如何处理密码重置。</p><h1 id="f796" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">创建编辑简档用户流</h1><p id="5118" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">您可以通过登录您的AD B2C租户并转到<strong class="ki iu">策略</strong>下的<strong class="ki iu">用户流</strong>来找到现有用户流列表。</p><p id="7501" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇文章中，我将创建一个新的配置文件编辑用户流。</p><ul class=""><li id="3c94" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">点击顶部的新用户流按钮。</li><li id="eb70" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">在选择用户流类型下，选择配置文件编辑。</li><li id="133a" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">选择推荐的版本，然后单击创建。</li></ul><p id="e352" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在撰写本文时，微软有一个更新的版本，似乎是在预览。我要用这个。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mv"><img src="../Images/00f9aa091dd7a9c608c9fbe43e34c339.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HZLYHVdEpC5DI5zX"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">创建新的配置文件编辑用户流。</figcaption></figure><p id="570f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一个屏幕显示流的选项，包括名称、禁用或启用多因素身份认证，以及您希望允许用户编辑的属性。</p><p id="e81a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面显示了一个属性示例:</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/99be04eedb1c2277957eef7b2305696d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AswiRAy2nmf3N70P"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">配置文件编辑用户流属性</figcaption></figure><p id="5f17" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦创建了概要文件编辑流，就可以获得导航到该流的URL。您可以通过选择流并点击<strong class="ki iu">运行用户流</strong>按钮来获取URL。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/5cbcc58f900d7d4308a919254a8b3533.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NW1yu1QGc8LAG5UG"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">配置文件编辑用户流url。</figcaption></figure><h1 id="52a9" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">以角度配置编辑配置文件url。</h1><p id="eef6" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在angular应用程序中，您可以将URL放在environment.ts或配置文件中。例如，我将配置放在assets文件夹下的一个单独的json文件中，并使用一个服务来加载配置。我遵循这种模式，因为我可以在azure devops上构建应用程序时动态替换密钥。你可以在这篇<a class="ae kf" href="https://www.taithienbo.com/using-azure-devops-file-transform-to-deploy-a-same-angular-build-to-multiple-environments/" rel="noopener ugc nofollow" target="_blank">帖子</a>中了解更多信息。另一件事是，我在服务中动态构建URL，而不是使用我从AD B2C获得的确切URL。如果您注意到，用户流的url遵循一种格式，该格式由租户名称、客户机id、重定向url和其他参数组成。基于这一点，我可以动态地构造url，这样，如果我更改了一个参数(如重定向url ),就不必更改多个位置。</p><pre class="mw mx my mz gt nb nc nd ne aw nf bi"><span id="f12f" class="ng lf it nc b gy nh ni l nj nk">{<br/>  "client_id": "47ea6724-b21f-46de-9d17-7425920f77e4",<br/>  "baseUrl": "<a class="ae kf" href="http://localhost:4200" rel="noopener ugc nofollow" target="_blank">http://localhost:4200</a>",<br/>  "signupSigninPolicy": "b2c_1_signupandsignin",<br/>  "tenantName": "taithienbo",<br/>  "response_type": "id_token token",<br/>  "loadUserInfo": false,<br/>  "response_mode": "fragment",<br/>  "scope": "<a class="ae kf" href="https://taithienbo.onmicrosoft.com/mywebapi/user_impersonation" rel="noopener ugc nofollow" target="_blank">https://taithienbo.onmicrosoft.com/mywebapi/user_impersonation</a> openid profile",<br/>  "editProfilePolicy": "B2C_1_a_profile_edit"<br/>}</span></pre><p id="7a95" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的代码片段中，我只输入了配置文件编辑用户流的名称。在SettingsService中，我使用httpClient加载上述json并构建完整的url。</p><pre class="mw mx my mz gt nb nc nd ne aw nf bi"><span id="56db" class="ng lf it nc b gy nh ni l nj nk">private loadOidcConfigs() {<br/>    return this.httpClient<br/>      .get('assets/oidc-settings.json')<br/>      .subscribe((settings) =&gt; {<br/>        this.oidcSettingsSubject.next(new OidcSettings(settings));<br/>      });<br/>  }</span></pre><h1 id="dd0a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">将用户导航到简档编辑页面。</h1><p id="7ead" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">设置好url后，只需将用户导航到用于编辑配置文件的url。在示例项目中，单击Edit profile按钮会调用以下代码:</p><pre class="mw mx my mz gt nb nc nd ne aw nf bi"><span id="ed94" class="ng lf it nc b gy nh ni l nj nk">editProfile() { window.location.href = this.authService.settings.editProfileRoute; }</span></pre><p id="52a3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在“编辑个人资料”页面上，用户可以看到他们可以编辑的属性。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/192d6ebea069d937d65262830afaf419.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8SFhHcUzcxWiDgu6"/></div></div></figure><p id="a2f0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在真实的应用程序中，您可能需要设计用户流的外观和感觉，这超出了本文的范围。如果你想了解更多，请查看<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/customize-ui-overview" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="96e3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦用户点击继续，AD B2C会根据注册应用程序时配置的重定向URL将用户重定向回应用程序。</p><h1 id="c0c5" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">处理来自广告B2C的响应</h1><p id="61a1" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">当在编辑配置文件时将用户重定向回应用程序时，AD B2C包括基于response_mode值的id令牌。例如，在示例项目中，response_mode是‘fragment ’,这意味着可以在URL的片段部分找到id标记。例如，下面是一个url，用户编辑完个人资料后，AD B2C会将用户重定向到该URL。</p><pre class="mw mx my mz gt nb nc nd ne aw nf bi"><span id="7d50" class="ng lf it nc b gy nh ni l nj nk"><a class="ae kf" href="http://localhost:4200/#id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ilg1ZVhrNHh5b2pORnVtMWtsMll0djhkbE5QNC1jNTdkTzZRR1RWQndhTmsifQ.eyJleHAiOjE2MDMyNDgxNTEsIm5iZiI6MTYwMzI0NDU1MSwidmVyIjoiMS4wIiwiaXNzIjoiaHR0cHM6Ly90YWl0aGllbmJvLmIyY2xvZ2luLmNvbS9kMjk1YmFjMC1iNWEyLTQzZDMtYWNhZi1hMTk5Y2Q3MTNiYTcvdjIuMC8iLCJzdWIiOiJiNzM4NjQ1NS1lMDEzLTQ1YWItOWE4My00NjhhYWU1N2I4YWEiLCJhdWQiOiI0N2VhNjcyNC1iMjFmLTQ2ZGUtOWQxNy03NDI1OTIwZjc3ZTQiLCJub25jZSI6ImRlZmF1bHROb25jZSIsImlhdCI6MTYwMzI0NDU1MSwiYXV0aF90aW1lIjoxNjAzMjQ0NTUxLCJjaXR5IjoiTXkgQ2l0eSIsImNvdW50cnkiOiJVbml0ZWQgU3RhdGVzIiwibmFtZSI6IlRhaSBCbyIsImdpdmVuX25hbWUiOiJUYWkiLCJqb2JUaXRsZSI6IlNvZnR3YXJlIEVuZ2luZWVyIiwicG9zdGFsQ29kZSI6IjEyMzQ1Iiwic3RhdGUiOiJPaGlvIiwic3RyZWV0QWRkcmVzcyI6IjExMTEgTXkgU3RyZWV0IiwiZmFtaWx5X25hbWUiOiJCbyIsInRmcCI6IkIyQ18xX2FfcHJvZmlsZV9lZGl0In0.lQnuN6RKSos0i6dAp_PqPLHzVb5TpvH7N0OlRPvMvA8BdifI2TWWvySddeWemucySdnWvj64JS5XASiMPD97gtxAAUzGXdxpZ1qn8bALQ5jBVb4-FfA003aJwWgLQitzSr1wczKyQPPUJhRBPoCiOOm2Wu61DAt03lQQgLGRifspkw2L3zoIIu72QQc05H4YCB2zqATdUCOsAw6sNT5xxEO6cUWh_duYGxlUVQQJFUm_bMmN7kSZ-7sl2Xq3y-4QcfmDlqKF2GHknpxEbJ-m3lgPYqYVxa5QuEG5F7p06sba-6PI-i5QwP-tv7upk-JsVJJXLVs1NL9ajkh-fil37A" rel="noopener ugc nofollow" target="_blank">http://localhost:4200/#id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ilg1ZVhrNHh5b2pORnVtMWtsMll0djhkbE5QNC1jNTdkTzZRR1RWQndhTmsifQ.eyJleHAiOjE2MDMyNDgxNTEsIm5iZiI6MTYwMzI0NDU1MSwidmVyIjoiMS4wIiwiaXNzIjoiaHR0cHM6Ly90YWl0aGllbmJvLmIyY2xvZ2luLmNvbS9kMjk1YmFjMC1iNWEyLTQzZDMtYWNhZi1hMTk5Y2Q3MTNiYTcvdjIuMC8iLCJzdWIiOiJiNzM4NjQ1NS1lMDEzLTQ1YWItOWE4My00NjhhYWU1N2I4YWEiLCJhdWQiOiI0N2VhNjcyNC1iMjFmLTQ2ZGUtOWQxNy03NDI1OTIwZjc3ZTQiLCJub25jZSI6ImRlZmF1bHROb25jZSIsImlhdCI6MTYwMzI0NDU1MSwiYXV0aF90aW1lIjoxNjAzMjQ0NTUxLCJjaXR5IjoiTXkgQ2l0eSIsImNvdW50cnkiOiJVbml0ZWQgU3RhdGVzIiwibmFtZSI6IlRhaSBCbyIsImdpdmVuX25hbWUiOiJUYWkiLCJqb2JUaXRsZSI6IlNvZnR3YXJlIEVuZ2luZWVyIiwicG9zdGFsQ29kZSI6IjEyMzQ1Iiwic3RhdGUiOiJPaGlvIiwic3RyZWV0QWRkcmVzcyI6IjExMTEgTXkgU3RyZWV0IiwiZmFtaWx5X25hbWUiOiJCbyIsInRmcCI6IkIyQ18xX2FfcHJvZmlsZV9lZGl0In0.lQnuN6RKSos0i6dAp_PqPLHzVb5TpvH7N0OlRPvMvA8BdifI2TWWvySddeWemucySdnWvj64JS5XASiMPD97gtxAAUzGXdxpZ1qn8bALQ5jBVb4-FfA003aJwWgLQitzSr1wczKyQPPUJhRBPoCiOOm2Wu61DAt03lQQgLGRifspkw2L3zoIIu72QQc05H4YCB2zqATdUCOsAw6sNT5xxEO6cUWh_duYGxlUVQQJFUm_bMmN7kSZ-7sl2Xq3y-4QcfmDlqKF2GHknpxEbJ-m3lgPYqYVxa5QuEG5F7p06sba-6PI-i5QwP-tv7upk-JsVJJXLVs1NL9ajkh-fil37A</a></span></pre><p id="8059" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">id令牌封装了AD B2C返回给app的属性。您可以在AD B2C中编辑用户配置文件的<strong class="ki iu">应用程序声明</strong>部分下选择在令牌中包含哪些属性。下面显示了我选择包含在令牌中的声明。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/066aef1afb50c684d3bb69bbdb20316f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BNK5UzHhxkpjMyAh"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">配置文件编辑用户流应用程序声明</figcaption></figure><p id="69d4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们可以用新的id令牌更新用户对象来获取更改，生活将会很美好。然而，这个库并没有公开一个仅仅处理id标记的方法。在不验证id标记的情况下设置id标记目录并不是一件好事。</p><pre class="mw mx my mz gt nb nc nd ne aw nf bi"><span id="d9c4" class="ng lf it nc b gy nh ni l nj nk">// This does not work. Don't use. <br/>public updateIdToken(idToken: string) {<br/>    this.userManager.getUser().then((user) =&gt; {<br/>      user.id_token = idToken;<br/>      this.userManager.storeUser(user);<br/>      this.userSubject.next(user);<br/>    });<br/>  }</span></pre><p id="8c31" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你的应用程序需要刷新个人资料，我知道的方法是进行静默登录。</p><p id="1107" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在示例应用程序中，我检查URL是否只包含id标记，然后调用signinSilent方法，如下面的代码片段所示。</p><pre class="mw mx my mz gt nb nc nd ne aw nf bi"><span id="ccd1" class="ng lf it nc b gy nh ni l nj nk">public loginSilent() {<br/>    this.userManager.signinSilent().then((user) =&gt; {<br/>      this.userSubject.next(user);<br/>    });<br/>  }</span></pre><p id="2d34" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">signinSilent方法在用户不可见的iFrame中构造对授权端点的登录请求。静默登录请求和常规登录请求之间的区别在于，静默请求将参数“prompt”设置为“none ”,并将id_token_hint参数设置为当前id令牌。</p><p id="06ad" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">无人值守登录完成后，AD B2C会将用户重定向到无人值守登录调用中指定的重定向url。您可以使用<code class="fe nl nm nn nc b">UserManagerSettings</code>类的属性silent_redirect_uri来设置这个url，您可以将它传递给UserManager的构造函数。该url需要与您在AD B2C中应用注册的身份验证下指定的URL之一相匹配。</p><h1 id="7679" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">处理来自广告B2C的无声签名响应</h1><p id="9481" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">成功静默登录后，AD B2C会将用户重定向回iframe中的应用程序。这里，我们必须检测并调用库的signinSilentCallback()方法来更新用户数据。因为iframe在应用程序之外，我们还需要在处理结果后刷新应用程序。在示例应用程序以及项目github页面上的<a class="ae kf" href="https://github.com/IdentityModel/oidc-client-js/tree/dev/samples" rel="noopener ugc nofollow" target="_blank"> angular示例</a>中，处理登录的代码在angular之外的html文件中。这是因为在iframe中加载整个angular应用程序是不必要的，也是低效的。</p><p id="1398" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">按照这种方法，在应用程序注册的身份验证中，我添加了静默登录的重定向url，以指向assets文件夹下的HTML文件。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/88879a0bf02e154d2e523c958576ba86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wldRnZ0rfA_U26AW"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在AD B2C中添加静默登录重定向url。</figcaption></figure><p id="068d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是signin_silent_callback.html中处理令牌的代码。</p><pre class="mw mx my mz gt nb nc nd ne aw nf bi"><span id="14e6" class="ng lf it nc b gy nh ni l nj nk">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;<br/>&lt;head&gt;<br/>  &lt;script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/oidc-client/1.10.1/oidc-client.min.js"&gt;&lt;/script&gt;<br/>  &lt;script&gt;<br/>    new Oidc.UserManager().signinSilentCallback();<br/>  &lt;/script&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="cf0a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的片段中需要注意一些事情:</p><ul class=""><li id="8482" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">在oidc-client.min.js中，UserManager和其他对象都被分组并分配给oidc变量。</li><li id="3b82" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><code class="fe nl nm nn nc b">signinSilentCallback</code>方法更新存储中的用户对象并关闭iframe。</li><li id="9494" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">angular page通过Rxjs observable向用户自动刷新数据。</li></ul><p id="35ab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们差不多完成了。我们需要做的最后一件事是当用户取消编辑配置文件时处理重定向。</p><h1 id="08ad" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">处理用户取消</h1><p id="3473" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果用户点击取消，广告B2C重定向用户回到应用程序以及信息。例如，如果response_mode为“fragment”或“query ”,您可以在URL中看到类似以下内容的错误信息:</p><p id="2c1b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nl nm nn nc b"><a class="ae kf" href="http://localhost:4200/#error=access_denied&amp;error_description=AADB2C90091:+The+user+has+cancelled+entering+self-asserted+information...." rel="noopener ugc nofollow" target="_blank">http://localhost:4200/#error=access_denied&amp;error_description=AADB2C90091:+The+user+has+cancelled+entering+self-asserted+information....</a></code></p><p id="9bcc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每次用户从direct返回时，应用程序组件都必须重新初始化。在示例应用程序中，我发现有必要重新加载用户对象，因为oidc-client-js不会在重定向后引发用户加载事件。似乎只有当我们调用一个登录回调方法时，才会引发用户加载事件。</p><p id="e140" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">总结一下，下面是AppComponent的完整ngOnInit方法。</p><pre class="mw mx my mz gt nb nc nd ne aw nf bi"><span id="8a1c" class="ng lf it nc b gy nh ni l nj nk">import { Component, OnDestroy, OnInit } from '@angular/core';<br/>import { Router, ActivatedRoute } from '@angular/router';<br/>import { AuthService } from './services/auth.service';<br/>import { Subscription } from 'rxjs';<br/>import {<br/>  HashLocationStrategy,<br/>  LocationStrategy,<br/>  Location,<br/>} from '@angular/common';<br/><br/>@Component({<br/>  selector: 'app-root',<br/>  templateUrl: './app.component.html',<br/>  styleUrls: ['./app.component.scss'],<br/>  providers: [<br/>    Location,<br/>    { provide: LocationStrategy, useClass: HashLocationStrategy },<br/>  ],<br/>})<br/>export class AppComponent implements OnInit, OnDestroy {<br/>  user: any;<br/><br/>  userJson: string;<br/><br/>  private routeFragments$: Subscription;<br/>  private authServiceIsReady$: Subscription;<br/><br/>  constructor(<br/>    private router: Router,<br/>    private route: ActivatedRoute,<br/>    public authService: AuthService<br/>  ) {}<br/><br/>  ngOnDestroy(): void {<br/>    if (this.routeFragments$) {<br/>      this.routeFragments$.unsubscribe();<br/>    }<br/>    if (this.authServiceIsReady$) {<br/>      this.authServiceIsReady$.unsubscribe();<br/>    }<br/>  }<br/><br/>  ngOnInit() {<br/>    console.log('AppComponent ngOnInit() called.');<br/>    const idTokenKeyWord = 'id_token';<br/>    const accessTokenKeyWord = 'access_token';<br/>    const errorDescriptionKeyWord = 'error_description';<br/>    const cancellationCode = 'AADB2C90091';<br/>    const resetPasswordCode = 'AADB2C90118';<br/>    this.authServiceIsReady$ = this.authService.isReady.subscribe((isReady) =&gt; {<br/>      if (isReady) {<br/>        this.route.fragment.subscribe((fragment) =&gt; {<br/>          const params = new URLSearchParams(fragment);<br/>          const idToken = params.get(idTokenKeyWord);<br/>          const accessToken = params.get(accessTokenKeyWord);<br/>          const errorDescription = params.get(errorDescriptionKeyWord);<br/>          if (idToken &amp;&amp; accessToken) {<br/>            this.handleIdAndAccessToken();<br/>          } else if (idToken) {<br/>            this.handleIdToken();<br/>          } else if (<br/>            errorDescription &amp;&amp;<br/>            errorDescription.includes(cancellationCode)<br/>          ) {<br/>            this.handleUserCancellation();<br/>          } else if (<br/>            errorDescription &amp;&amp;<br/>            errorDescription.includes(resetPasswordCode)<br/>          ) {<br/>            this.handlePasswordReset();<br/>          }<br/>        });<br/>      }<br/>    });<br/>  }<br/><br/>  login() {<br/>    console.log('AppComponent: login() called.');<br/>    this.authService<br/>      .loginRedirect()<br/>      .then(() =&gt; console.log('Login redirect finished.'));<br/>  }<br/><br/>  logout() {<br/>    console.log('AppComponent: logout() called.');<br/>    this.authService.logoutRedirect().then();<br/>  }<br/><br/>  editProfile() {<br/>    const url = new URL(this.authService.settings.editProfileRoute);<br/>    window.location.href = url.href;<br/>  }<br/><br/>  keyWordInURLFound(searchWord: string, url: string): boolean {<br/>    const index = url.indexOf(searchWord);<br/>    if (index &gt; -1) {<br/>      return true;<br/>    }<br/>    return false;<br/>  }<br/><br/>  private handlePasswordReset() {<br/>    // we simply redirect the user to the reset password page.<br/>    window.location.href = this.authService.settings.resetPasswordRoute;<br/>  }<br/><br/>  private handleUserCancellation() {<br/>    // The user has clicked Cancel from an azure adb2c user flow page (e.g.<br/>    // user has cancelled the reset password or edit profile process).<br/>    // In a real app, you may want to navigate the user back to the home<br/>    // page or do something else. However, here, I simply ignore the result.<br/>  }<br/><br/>  private handleIdAndAccessToken() {<br/>    // if both id and access tokens are in the URL, it means the user<br/>    // has come back from a successful authentication. We call the<br/>    // library to handle the result (e.g. store the user and state in storage)<br/>    this.authService.loginRedirectCallback().then((user) =&gt; {<br/>      this.user = user;<br/>    });<br/>  }<br/><br/>  private handleIdToken() {<br/>    // If the user has come back from the edit profile page, the<br/>    // user object is still present in the storage, and we can do a<br/>    // silent login to pick up any changes to the profile if desired. However,<br/>    // if the user has reset the password, the user object is no longer<br/>    // available, and the user needs to login again.<br/>    this.authService.loadUser().then((user) =&gt; {<br/>      if (user) {<br/>        // user has come back after edit profile.<br/>        this.authService.loginSilent().then((u) =&gt; {<br/>          this.user = u;<br/>        });<br/>      } else {<br/>        // user has come back after reset password and need to login again.<br/>        this.authService.loginRedirect();<br/>      }<br/>    });<br/>  }<br/>}</span></pre><p id="08b8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为最后一个技巧，您可以启用<a class="ae kf" href="https://github.com/IdentityModel/oidc-client-js/wiki#logging" rel="noopener ugc nofollow" target="_blank">日志</a>来帮助调试问题。</p><p id="91a9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样。希望你觉得这篇文章有用。保持冷静，继续编码。</p><h1 id="84d9" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">参考</h1><p id="6b0a" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated"><a class="ae kf" href="https://www.scottbrady91.com/OpenID-Connect/Silent-Refresh-Refreshing-Access-Tokens-when-using-the-Implicit-Flow#:~:text=Silent%20refresh%20uses%20the%20assumption,without%20interrupting%20the%20user%20experience." rel="noopener ugc nofollow" target="_blank">静默刷新—使用隐式流时刷新访问令牌</a> <br/> <a class="ae kf" href="https://stackoverflow.com/questions/55369023/how-to-get-logging-using-oidc-client-with-angular" rel="noopener ugc nofollow" target="_blank">如何使用oidc-client with Angular</a><br/><a class="ae kf" href="https://github.com/IdentityModel/oidc-client-js/wiki" rel="noopener ugc nofollow" target="_blank">oidc-client-js github页面</a></p></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><p id="afc7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nv">原载于2020年10月24日https://www.taithienbo.com</em><a class="ae kf" href="https://www.taithienbo.com/integrate-azure-ad-b2c-profile-editing-user-flow-in-angular-using-oidc-client-js/" rel="noopener ugc nofollow" target="_blank"><em class="nv"/></a><em class="nv">。</em></p></div></div>    
</body>
</html>