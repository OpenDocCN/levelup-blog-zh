<html>
<head>
<title>Logging Incoming Requests in KrakenD API Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在KrakenD API网关中记录传入请求</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/logging-incoming-requests-in-krakend-api-gateway-341134b71e29?source=collection_archive---------9-----------------------#2021-05-04">https://levelup.gitconnected.com/logging-incoming-requests-in-krakend-api-gateway-341134b71e29?source=collection_archive---------9-----------------------#2021-05-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/93eacac5ba9c8a6ab28db1284125df20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UKdVd1scipegcmlDduxSlg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">许多日志文件的图像</figcaption></figure><p id="f2c9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你对探索克拉肯有兴趣，你可以在这里阅读<a class="ae la" href="https://www.krakend.io/docs/overview/introduction/" rel="noopener ugc nofollow" target="_blank">入门文档</a>。您可能也有兴趣查看一下<a class="ae la" href="https://www.krakend.io/docs/benchmarks/api-gateway-benchmark/" rel="noopener ugc nofollow" target="_blank">基准测试结果</a>，看看KrakenD与其他开源API网关如<a class="ae la" href="https://konghq.com/" rel="noopener ugc nofollow" target="_blank"> Kong </a>、<a class="ae la" href="https://vulcand.github.io/" rel="noopener ugc nofollow" target="_blank"> Vulcand </a>或<a class="ae la" href="https://tyk.io/" rel="noopener ugc nofollow" target="_blank"> Tyk </a>相比如何。本文是为那些已经在使用(以及那些计划或将要使用)KrakenD作为其服务的API网关的读者准备的。本文不包括如何在生产中设置和使用KrakenD。</p><h2 id="614c" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated">KrakenD中的默认请求日志</h2><p id="d8bc" class="pw-post-body-paragraph kc kd iq ke b kf lu kh ki kj lv kl km kn lw kp kq kr lx kt ku kv ly kx ky kz ij bi translated">默认情况下，KrakenD中的请求日志中包含的信息在某些情况下可能不足以用于审计目的。如果您已经将KrakenD配置为使用Logstash格式来打印日志，那么请求日志仍然会使用默认格式，这需要开发人员仔细地为日志设置解析逻辑。KrakenD依赖于GIN引擎中配置的默认日志记录器来打印请求日志，这也意味着如果您已经配置了KrakenD Logger来将日志写到<em class="lz"> Syslog </em>中，那么请求日志就不会被发送到那里。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ma"><img src="../Images/fbd29cf531b1c2a7041968583ffb3323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*all9FkUCAH579bbQaPe0QQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">KrakenD中的默认请求日志</figcaption></figure><h2 id="9930" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated">为GIN设置自定义日志格式化程序</h2><p id="f787" class="pw-post-body-paragraph kc kd iq ke b kf lu kh ki kj lv kl km kn lw kp kq kr lx kt ku kv ly kx ky kz ij bi translated">您可以很容易地修改KrakenD-CE代码，为GIN引擎添加一个定制的日志格式化程序中间件。我为KrakenD开发了一个模块，你可以很容易地在KrakenD-CE代码库中扩展它，在那里它初始化GIN引擎。你可以在我的GitHub账户找到模块<a class="ae la" href="https://github.com/ifaisalalam/krakend-gin-logger" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="5561" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你需要做的就是<a class="ae la" href="https://github.com/git-guides/git-clone" rel="noopener ugc nofollow" target="_blank">克隆</a>KrakenD-CE<a class="ae la" href="https://github.com/devopsfaith/krakend-ce" rel="noopener ugc nofollow" target="_blank">库并在<code class="fe mf mg mh mi b">router_engine.go</code>文件中修改</a><a class="ae la" href="https://github.com/devopsfaith/krakend-ce/blob/f77ed77b24c8dba6f45dfb8ff14fb21ee7348d9a/router_engine.go#L15" rel="noopener ugc nofollow" target="_blank">这个函数</a>。这是您需要做的更改的快照。</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="11fe" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您现在可以通过运行<code class="fe mf mg mh mi b">make build</code>命令在您的机器上构建KrakenD二进制文件。这将在您的机器上克隆存储库的相同位置创建一个<code class="fe mf mg mh mi b">krakend</code>二进制文件。</p><h2 id="a26e" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated"><strong class="ak">启用GIN日志格式化程序</strong></h2><p id="9d21" class="pw-post-body-paragraph kc kd iq ke b kf lu kh ki kj lv kl km kn lw kp kq kr lx kt ku kv ly kx ky kz ij bi translated">现在可以通过将以下内容添加到KrakenD的<code class="fe mf mg mh mi b">configuration.json</code>文件中的服务<code class="fe mf mg mh mi b">extra_config</code>来启用GIN日志格式化程序。</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="f2f2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该模块使用与KrakenD内部使用的相同的<a class="ae la" href="https://github.com/devopsfaith/krakend-gologging" rel="noopener ugc nofollow" target="_blank">记录器模块来打印日志。因此，您为logger模块设置的配置选项也将应用于请求日志。</a></p><p id="10b3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">下面是一个使用Logstash和带有自定义选项的日志模块的示例<code class="fe mf mg mh mi b">configuration.json</code>。</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="d5fe" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">仅此而已！下面是上面的示例配置中日志的样子。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/f9021d72fbaf4d2f47c1afaaafb77bf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZgjZE7D9AtMP2lKUYMk6EA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">添加自定义日志格式化程序后的KrakenD请求日志</figcaption></figure><p id="2a8c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您还可以配置GIN日志格式化程序模块来忽略某些路径并且不记录它们。例如，您可能想要忽略<code class="fe mf mg mh mi b">/__health</code>呼叫，并且不将它们包含在日志中。您可以通过在<code class="fe mf mg mh mi b">skip_paths</code>选项中传递一个要忽略的路径列表来做到这一点。这里有一个如何实现这一点的示例配置。</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="9c1d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在本例中，对路径<code class="fe mf mg mh mi b">/__health</code>或<code class="fe mf mg mh mi b">/api/ignore</code>的任何请求都不会被记录。</p><h2 id="d3c4" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated">GIN日志格式化程序记录的字段</h2><p id="83cb" class="pw-post-body-paragraph kc kd iq ke b kf lu kh ki kj lv kl km kn lw kp kq kr lx kt ku kv ly kx ky kz ij bi translated">该模块记录传入请求的以下参数:</p><ul class=""><li id="7a2a" class="mm mn iq ke b kf kg kj kk kn mo kr mp kv mq kz mr ms mt mu bi translated"><code class="fe mf mg mh mi b">method</code> : HTTP请求方式</li><li id="56c8" class="mm mn iq ke b kf mv kj mw kn mx kr my kv mz kz mr ms mt mu bi translated"><code class="fe mf mg mh mi b">host</code></li><li id="2c9e" class="mm mn iq ke b kf mv kj mw kn mx kr my kv mz kz mr ms mt mu bi translated"><code class="fe mf mg mh mi b">path</code></li><li id="deed" class="mm mn iq ke b kf mv kj mw kn mx kr my kv mz kz mr ms mt mu bi translated"><code class="fe mf mg mh mi b">status_code</code> : HTTP响应状态码</li><li id="a989" class="mm mn iq ke b kf mv kj mw kn mx kr my kv mz kz mr ms mt mu bi translated"><code class="fe mf mg mh mi b">user_agent</code>:用户代理字符串</li><li id="fd4e" class="mm mn iq ke b kf mv kj mw kn mx kr my kv mz kz mr ms mt mu bi translated"><code class="fe mf mg mh mi b">client_ip</code></li><li id="af79" class="mm mn iq ke b kf mv kj mw kn mx kr my kv mz kz mr ms mt mu bi translated"><code class="fe mf mg mh mi b">latency</code></li><li id="fd39" class="mm mn iq ke b kf mv kj mw kn mx kr my kv mz kz mr ms mt mu bi translated"><code class="fe mf mg mh mi b">response_timestamp</code></li></ul><p id="6970" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果您想在日志中添加更多的字段，可以随意地<a class="ae la" href="https://guides.github.com/activities/forking/" rel="noopener ugc nofollow" target="_blank">派生</a>存储库，并在KrakenD中使用您自己版本的模块。这是GitHub项目的链接—<a class="ae la" href="https://github.com/ifaisalalam/krakend-gin-logger" rel="noopener ugc nofollow" target="_blank">https://github.com/ifaisalalam/krakend-gin-logger</a>。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="511d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我希望这篇文章和这个项目对你有用。如果您有兴趣参与该项目，请随时打开<a class="ae la" href="https://docs.github.com/en/github/collaborating-with-issues-and-pull-requests/creating-a-pull-request" rel="noopener ugc nofollow" target="_blank">拉动式请求</a>。</p><h2 id="32d7" class="lb lc iq bd ld le lf dn lg lh li dp lj kn lk ll lm kr ln lo lp kv lq lr ls lt bi translated">参照(References)</h2><ul class=""><li id="4ab0" class="mm mn iq ke b kf lu kj lv kn nh kr ni kv nj kz mr ms mt mu bi translated"><a class="ae la" href="https://github.com/ifaisalalam/krakend-gin-logger" rel="noopener ugc nofollow" target="_blank">https://github.com/ifaisalalam/krakend-gin-logger </a></li><li id="9c44" class="mm mn iq ke b kf mv kj mw kn mx kr my kv mz kz mr ms mt mu bi translated"><a class="ae la" href="https://github.com/devopsfaith/krakend-ce" rel="noopener ugc nofollow" target="_blank">https://github.com/devopsfaith/krakend-ce </a></li></ul></div></div>    
</body>
</html>