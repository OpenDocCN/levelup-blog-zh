<html>
<head>
<title>Build a Web API based on parameters that retrieves JSON data from a spreadsheet using Google Apps Script</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于参数构建一个Web API，使用Google Apps脚本从电子表格中检索JSON数据</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/build-a-web-api-based-on-parameters-that-retrieves-json-data-from-a-spreadsheet-using-google-apps-20a3a8f89f6d?source=collection_archive---------0-----------------------#2022-01-21">https://levelup.gitconnected.com/build-a-web-api-based-on-parameters-that-retrieves-json-data-from-a-spreadsheet-using-google-apps-20a3a8f89f6d?source=collection_archive---------0-----------------------#2022-01-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/197fb487564aa842c626e8d814e163ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pPskNey74RP9VJG1TrmWyA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图片来源:海·凯尔(YouTube)</figcaption></figure><p id="22c6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你好，学习者！</p><p id="1dda" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">本文延续了我之前的文章“如何构建一个Web API，使用Google Apps脚本 从Google电子表格中检索JSON数据”，展示了如何基于一些参数使用Google Apps脚本从Google电子表格中检索JSON数据。参数可以包括电子邮件id、密钥id、姓名或任何其他可以用来在Google电子表格中定位行的信息。让我们了解一下它是如何工作的。</p><p id="0dfd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">以下步骤将指导我们完成整个过程:</strong></p><p id="6053" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">步骤1: </strong>打开你的Google Apps脚本编辑器，编写下面的<strong class="ke ir"> doGet() </strong>函数。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="a85a" class="lk ll iq lg b gy lm ln l lo lp">var email;<br/>var sheetname;</span><span id="8dd1" class="lk ll iq lg b gy lq ln l lo lp">function doGet(event) {</span><span id="1a89" class="lk ll iq lg b gy lq ln l lo lp">sheetname = event.parameter['sheetname'];<br/>email = event.parameter['email'];</span><span id="02cb" class="lk ll iq lg b gy lq ln l lo lp">var data = getJsonData(sheetname, email); <br/> return buildSuccessResponse(data, 1);<br/>}</span></pre><p id="db36" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在上面的代码中，email<strong class="ke ir">和<strong class="ke ir"> sheetname </strong>已经被声明为全局变量。<strong class="ke ir">事件</strong>变量传入<strong class="ke ir"> doGet() </strong>函数；这是一个变量，我们将从中获取已经从前端传递到Web API URL的参数及其值<em class="lr">(稍后我们将看到如何检索Web API URL)</em>。在上面的示例代码中，可以看到<strong class="ke ir">事件</strong>变量有两个参数:<strong class="ke ir"> sheetname </strong>和<strong class="ke ir"> email </strong>。这些参数是使用<strong class="ke ir">参数</strong>属性获得的。参数属性可以通过放置一个点<em class="lr">()</em>之后的<strong class="ke ir">事件</strong>变量，并在[ ]括号内定义键字符串。请参考下面的示例代码。</strong></p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="52e0" class="lk ll iq lg b gy lm ln l lo lp">event.parameter['sheetname'];</span></pre><p id="67b6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在我们有了Web API URL参数及其值。我们将把它们传递给<strong class="ke ir"> getJsonData() </strong>函数，然后声明我们将从中检索数据的Google电子表格id和sheetname。</p><p id="1b64" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下面的示例代码所示，我们可以看到如何将参数传递给<strong class="ke ir"> getJsonData() </strong>函数。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="cdcb" class="lk ll iq lg b gy lm ln l lo lp">getJsonData(sheetname, email);</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="957e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">步骤2: </strong>作为该步骤的一部分，我们将为<strong class="ke ir"> getJsonData() </strong>函数创建Google Apps脚本，并定义电子表格的电子表格id和电子表格名称。请参考下面的示例代码。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="72b0" class="lk ll iq lg b gy lm ln l lo lp">function getJsonData(sheetname, email){<br/>  <br/> var spreadSheetId='YOUR_SPREADSHEET_ID';<br/>  <br/> var ss = SpreadsheetApp.openById(spreadSheetId);<br/> var sheet = ss.getSheetByName("YOUR_SHEETNAME");<br/>  <br/> var json_data = getData(sheetname, email);<br/> <br/>  return json_data; <br/>}</span></pre><p id="1020" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在上面的示例代码中，我们已经定义了Google电子表格ID和名称，我们将从中获取数据。让电子表格工作的顺序是，首先我们需要编写<strong class="ke ir">电子表格id </strong>，然后应用<strong class="ke ir"> SpreadsheetApp </strong>库函数，接着是<strong class="ke ir"> openbyId </strong>来访问电子表格，然后编写我们从中获取数据的电子表格名称。</p><p id="cef9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后我们调用<strong class="ke ir"> getData() </strong>函数，并传递<strong class="ke ir"> sheetname </strong>和<strong class="ke ir"> emai </strong> l参数来检索JSON格式的基于条件的数据。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="75dd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">第三步:</strong>在这一步中，我们将编写带有参数化条件的<strong class="ke ir"> getData() </strong>函数的代码。这个函数将有与字符串化我们从电子表格中得到的数据相关的代码。让我们看看下面的代码。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="b9af" class="lk ll iq lg b gy lm ln l lo lp">function getData(sheet){<br/>  <br/>  var jo = {};<br/>  var i =0;<br/>  var rows2 = sheet.getDataRange().getValues();<br/>   Logger.clear();<br/>//  ===============Get data=================<br/>  var rows2=[];<br/>  var rangeData = sheet.getDataRange();<br/>  var values = rangeData.getValues();<br/>  var lastColumn = rangeData.getLastColumn();<br/>  var lastRow = rangeData.getLastRow();<br/>  var data=[];<br/>  var x=0,y=0;<br/>  for(i = 0; i&lt;lastRow; i++){<br/>    data[x]=[];<br/>    <br/>    for(var j=0; j&lt;lastColumn; j++ ){ </span><span id="af9f" class="lk ll iq lg b gy lq ln l lo lp">// Here we are matching values with eamil  parameter</span><span id="7efc" class="lk ll iq lg b gy lq ln l lo lp">// values[i][2] will have data of emails in second column of your <br/>// spreadsheet <br/>      if(email == values[i][2]){ <br/>        data[x][j]= values[i][j];<br/>        y=1;<br/>      }<br/>    }<br/>    if(y==1){ x=x+1; y=0; }<br/> <br/>  }<br/>  return data;  <br/>}</span></pre><p id="6f03" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在上面声明的函数中，我们使用了很少的库函数。请参见下面的定义:</p><p id="0d25" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> getDataRange(): </strong>获取有数据的电子表格的范围。</p><p id="c26d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> getValues(): </strong>获取电子表格中选定范围的值。</p><p id="663c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> getLastColumn(): </strong>获取电子表格的最后一列。</p><p id="3ef9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> getLastRow(): </strong>获取电子表格的最后一行。</p><p id="ff1a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后使用<strong class="ke ir">电子邮件</strong>参数根据相同的电子邮件值过滤数据。我们使用<strong class="ke ir"> value[i][2] </strong>，因为它定义了电子表格中包含电子邮件的第二列。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="433f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">第四步:</strong>在这一步中，我们只需要定义前面在示例代码顶部的<strong class="ke ir"> doGet() </strong>函数中声明的<strong class="ke ir"> buildSuccessResponse() </strong>函数。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="1ce8" class="lk ll iq lg b gy lm ln l lo lp">function buildSuccessResponse(data, pages) {<br/>  var output = JSON.stringify({<br/>    status: 'success',<br/>    data: data,<br/>    pages: pages<br/>  });<br/>  <br/>  return ContentService.createTextOutput(output).setMimeType(ContentService.MimeType.JSON);<br/>}</span></pre><p id="09ce" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在上面的代码中，我们传递了从<strong class="ke ir"> getJsonData() </strong>函数获得的整个数组。由于stringnify是获取JSON格式的数组数据的过程，所以我们还可以传递一些参数，比如数据是否已经成功发送到Web API，以及更多的参数。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="b31f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">第5步:</strong>我们现在处于API构建过程的末尾。你所要做的就是使用谷歌脚本编辑器右上角的选项<strong class="ke ir">“Deploy”</strong>，将整个代码部署为一个web API。完成此操作后，您将看到如下Web API URL:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="a333" class="lk ll iq lg b gy lm ln l lo lp"><a class="ae la" href="https://script.google.com/macros/s/AKfycbyS6P2P2TUGBfqmFTrTfourZK97fB5JnVxyWTz32St8y1UwgdaYYK6jBIq1JqR1qLlZ/exec" rel="noopener ugc nofollow" target="_blank">https://script.google.com/macros/s/AKfycbyS6P2P2TUGBfqmFTrTfourZK97fB5JnVxyWTz32St8y1UwgdaYYK6jBIq1JqR1qpsi/exec</a></span></pre><p id="4b8a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">以上可见的URL仅用于演示目的，它不是一个有效的URL。在这个URL中，您需要传递我们从<strong class="ke ir"> doGet() </strong>函数收到的那些参数——<strong class="ke ir">sheet name</strong>和<strong class="ke ir"> email </strong>。现在让我们看看它如何与Web API URLs一起使用。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="0c03" class="lk ll iq lg b gy lm ln l lo lp"><a class="ae la" href="https://script.google.com/macros/s/AKfycbyS6P2P2TUGBfqmFTrTfourZK97fB5JnVxyWTz32St8y1UwgdaYYK6jBIq1JqR1qLlZ/exec" rel="noopener ugc nofollow" target="_blank">https://script.google.com/macros/s/AKfycbyS6P2P2TUGBfqmFTrTfourZK97fB5JnVxyWTz32St8y1UwgdaYYK6jBIq1JqR1qpsi/exec</a>?sheetname=YOUR_SHEETNAME&amp;email=YOUR_EMAIL_VALUE</span></pre><p id="9d9c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上面你可以看到我们增加了<strong class="ke ir"> <em class="lr">？sheet name = YOUR _ sheet name&amp;EMAIL = YOUR _ EMAIL _ VALUE，</em>URL后的</strong>，用来包含Web API URL的参数，并且我们可以通过添加&amp;操作符来添加更多。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="aa11" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你有兴趣学习Google Apps脚本和自动化你的Google Workspace？必须试试这本<strong class="ke ir">电子书</strong>上的<a class="ae la" href="https://www.amazon.com/dp/B0BTJC9X5R" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir">谷歌应用套件脚本:初学者指南</strong> </a></p><p id="fb42" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通过阅读这篇文章，我希望您能够构建自己的Web API，这样您就可以根据参数从Google电子表格中将数据提取到您的网页中。</p><p id="d4ff" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你有任何问题，请留下评论。我很乐意帮忙。</p><p id="6aca" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">快乐学习！</p></div></div>    
</body>
</html>