<html>
<head>
<title>How to select images using PHPickerViewController with SwiftUI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用PHPickerViewController和SwiftUI选择图像</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-select-images-using-phpickerviewcontroller-with-swiftui-da8bd3ec3d05?source=collection_archive---------13-----------------------#2021-01-11">https://levelup.gitconnected.com/how-to-select-images-using-phpickerviewcontroller-with-swiftui-da8bd3ec3d05?source=collection_archive---------13-----------------------#2021-01-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="13d9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在更改个人资料图片、发布更新或分享宠物照片时，需要从我们的iPhone图库中选择图像。在本帖中，我们将探讨如何在SwiftUI中使用<code class="fe ko kp kq kr b">PHPickerViewController</code>。苹果在WWDC2020上公布了这款视图控制器。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ks"><img src="../Images/4523887085c6cfa133f12fa5cccf4d85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Kq4t0cJLafvZLaCYI61oQ.jpeg"/></div></div><figcaption class="le lf gj gh gi lg lh bd b be z dk translated"><a class="ae li" href="https://unsplash.com/@danielcgold" rel="noopener ugc nofollow" target="_blank">丹金</a>在<a class="ae li" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照。</figcaption></figure><h1 id="8535" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">什么是PHPickerViewController？</h1><p id="5919" class="pw-post-body-paragraph jq jr it js b jt mh jv jw jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn im bi translated"><code class="fe ko kp kq kr b">PHPickerViewController</code>是一个视图控制器，允许我们的应用程序用户从他们的照片库中选择资源。它提供了一个众所周知的用户界面，我们不需要费心去构建它。</p><p id="265a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这种方法带来的一个好处是，我们不需要担心添加信息来访问用户在<code class="fe ko kp kq kr b">Info.plist</code>文件中的照片库。用户可以决定允许访问所有照片库或者选择性地授权访问特定照片。这解决了隐私问题，应用程序可以读取整个图书馆，甚至跟踪人们。</p><h1 id="6828" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">创建一个<code class="fe ko kp kq kr b">PHPickerViewController</code></h1><p id="e419" class="pw-post-body-paragraph jq jr it js b jt mh jv jw jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn im bi translated">为了创建一个<code class="fe ko kp kq kr b">PHPickerViewController</code>，我们需要通过传递配置来初始化它，这是<code class="fe ko kp kq kr b">PHPickerConfiguration</code>的一个实例。对于配置，我们需要指定我们想要什么类型的图片，并设置选择限制。</p><p id="ceca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于<code class="fe ko kp kq kr b">PHPickerViewController</code>本身，我们设置需要实现<code class="fe ko kp kq kr b">PHPickerViewControllerDelegate</code>协议的委托。它只有一个方法，当我们的用户选择照片时，它会给出一个信号。</p><h1 id="c253" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">与SwiftUI集成</h1><p id="e75f" class="pw-post-body-paragraph jq jr it js b jt mh jv jw jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn im bi translated">为了在SwiftUI应用中使用<code class="fe ko kp kq kr b">PHPickerViewController</code>，我们需要使用<code class="fe ko kp kq kr b">UIViewControllerRepresentable</code>来表示一个UIKit视图控制器。让我们回顾一下做这件事所需的所有步骤。</p><h1 id="20b6" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">设置UIKit视图控制器</h1><p id="93fb" class="pw-post-body-paragraph jq jr it js b jt mh jv jw jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn im bi translated"><code class="fe ko kp kq kr b">UIViewControllerRepresentable</code>是一个协议，需要实现两个方法:</p><ul class=""><li id="b9ef" class="mm mn it js b jt ju jx jy kb mo kf mp kj mq kn mr ms mt mu bi translated"><code class="fe ko kp kq kr b">makeUIViewController</code> -创建并配置视图控制器；</li><li id="d782" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated"><code class="fe ko kp kq kr b">updateUIViewControoler</code> -更新视图控制器的状态。</li></ul><p id="8445" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将在<code class="fe ko kp kq kr b">makeUIViewController</code>方法中创建并配置<code class="fe ko kp kq kr b">PHPickerViewController</code>。我们不需要更新它，所以我们可以让<code class="fe ko kp kq kr b">updateUIViewControoler</code>为空。</p><pre class="kt ku kv kw gt na kr nb nc aw nd bi"><span id="23ff" class="ne lk it kr b gy nf ng l nh ni">struct PhotoPicker: UIViewControllerRepresentable {<br/>  @Binding var pickerResult: [UIImage] // pass images back to the SwiftUI view<br/>  @Binding var isPresented: Bool // close the modal view<br/>  <br/>  func makeUIViewController(context: Context) -&gt; some UIViewController {<br/>    var configuration = PHPickerConfiguration(photoLibrary: PHPhotoLibrary.shared())<br/>    configuration.filter = .images // filter only to images<br/>    configuration.selectionLimit = 0 // ignore limit<br/>    <br/>    let photoPickerViewController = PHPickerViewController(configuration: configuration)<br/>    photoPickerViewController.delegate = context.coordinator // Use Coordinator for delegation<br/>    return photoPickerViewController<br/>  }<br/>  <br/>  func updateUIViewController(_ uiViewController: UIViewControllerType, context: Context) { }<br/>}</span></pre><h1 id="da51" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">协调者</h1><p id="a09b" class="pw-post-body-paragraph jq jr it js b jt mh jv jw jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn im bi translated">现在我们可以呈现<code class="fe ko kp kq kr b">PHPickerViewController</code>了，但是我们如何将选中的图像传输回来呢？我们需要使用<code class="fe ko kp kq kr b">makeCoordinator</code>方法并创建实现<code class="fe ko kp kq kr b">PHPickerViewControllerDelegate</code>协议的<code class="fe ko kp kq kr b">Coordinator</code>类。对于SwiftUI如何与UIKit委托模式思想进行通信，这是一种经过深思熟虑的方法。</p><pre class="kt ku kv kw gt na kr nb nc aw nd bi"><span id="af0f" class="ne lk it kr b gy nf ng l nh ni">struct PhotoPicker: UIViewControllerRepresentable {</span><span id="9315" class="ne lk it kr b gy nj ng l nh ni">  // ...</span><span id="7ca3" class="ne lk it kr b gy nj ng l nh ni">  func makeCoordinator() -&gt; Coordinator {<br/>    Coordinator(self)<br/>  }<br/>  <br/>  // Create the Coordinator, in this case it is a way to communicate with the PHPickerViewController<br/>  class Coordinator: PHPickerViewControllerDelegate {<br/>    private let parent: PhotoPicker<br/>    <br/>    init(_ parent: PhotoPicker) {<br/>      self.parent = parent<br/>    }<br/>    <br/>    func picker(_ picker: PHPickerViewController, didFinishPicking results: [PHPickerResult]) {<br/>    }<br/>  }<br/>}</span></pre><h1 id="384d" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">将UIKit与SwiftUI一起使用</h1><p id="3d71" class="pw-post-body-paragraph jq jr it js b jt mh jv jw jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn im bi translated">让我们把它们放在一起。我们需要创建一个SwiftUI视图来呈现照片选择器视图，并将其呈现为一个模态。你可以在我的<a class="ae li" href="https://kristaps.me/blog/swiftui-modal-view/" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>中读到更多关于如何在SwiftUI中显示模态视图的信息。</p><pre class="kt ku kv kw gt na kr nb nc aw nd bi"><span id="1ecc" class="ne lk it kr b gy nf ng l nh ni">.sheet(isPresented: $photoPickerIsPresented) {<br/>  // Present the photo picker view modally<br/>  PhotoPicker(pickerResult: $pickerResult,<br/>              isPresented: $photoPickerIsPresented)<br/>}</span></pre><h1 id="c1c6" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">将数据从UIKit传递到SwiftUI</h1><p id="fbef" class="pw-post-body-paragraph jq jr it js b jt mh jv jw jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn im bi translated">要获取用户所选内容的照片，让我们使用<code class="fe ko kp kq kr b">@State</code>变量，并使用<code class="fe ko kp kq kr b">@Binding</code> <a class="ae li" href="https://swiftuipropertywrappers.com/#binding" rel="noopener ugc nofollow" target="_blank">属性包装器</a>将其传递给<code class="fe ko kp kq kr b">PhotoPicker</code>视图。</p><p id="1754" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们可以为我们的<code class="fe ko kp kq kr b">Coordinator</code>类完全完成<code class="fe ko kp kq kr b">PHPickerViewControllerDelegate</code>协议了。</p><pre class="kt ku kv kw gt na kr nb nc aw nd bi"><span id="29ee" class="ne lk it kr b gy nf ng l nh ni">func picker(_ picker: PHPickerViewController, didFinishPicking results: [PHPickerResult]) {<br/>  parent.pickerResult.removeAll() // remove previous pictures from the main view<br/>  <br/>  // unpack the selected items<br/>  for image in results {<br/>    if image.itemProvider.canLoadObject(ofClass: UIImage.self) {<br/>      image.itemProvider.loadObject(ofClass: UIImage.self) { [weak self] newImage, error in<br/>        if let error = error {<br/>          print("Can't load image \(error.localizedDescription)")<br/>        } else if let image = newImage as? UIImage {<br/>          // Add new image and pass it back to the main view<br/>          self?.parent.pickerResult.append(image)<br/>        }<br/>      }<br/>    } else {<br/>      print("Can't load asset")<br/>    }<br/>  }<br/>  <br/>  // close the modal view<br/>  parent.isPresented = false<br/>}</span></pre><p id="9b7f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们在这里做的是从照片库中解包选定的项目，并将它们设置到父项的<code class="fe ko kp kq kr b">@Binding</code>变量。通过这样做，我们将数据传输回主视图。</p><h1 id="6e55" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">展示选定的图像</h1><p id="2bc6" class="pw-post-body-paragraph jq jr it js b jt mh jv jw jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn im bi translated">为了呈现选中的照片，我们可以迭代并在一个<code class="fe ko kp kq kr b">ScrollView</code>中显示它们。</p><pre class="kt ku kv kw gt na kr nb nc aw nd bi"><span id="fb51" class="ne lk it kr b gy nf ng l nh ni">ScrollView {<br/>  ForEach(pickerResult, id: \.self) { uiImage in<br/>    ImageView(uiImage: uiImage)<br/>  }<br/>}</span></pre><p id="b6fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一个重要的事实是图像的类型是<code class="fe ko kp kq kr b">UIImage</code>，但是幸运的是SwiftUI为传递<code class="fe ko kp kq kr b">UIImage</code>类型的<code class="fe ko kp kq kr b">Image</code>视图提供了一个很好的初始化器。</p><p id="28a9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以点击查看完整的实现<a class="ae li" href="https://github.com/fassko/PHPickerViewController-SwiftUI" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="1d17" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="66be" class="pw-post-body-paragraph jq jr it js b jt mh jv jw jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn im bi translated">选择图像并在我们的应用程序中使用它们是现代iOS应用程序的一个基本功能。苹果在WWDC2020上宣布了一种更安全、更精细的新方法——<code class="fe ko kp kq kr b">PHPickerViewController</code>。注意，只有iOS14及更高版本才有。</p><p id="4c5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要将<code class="fe ko kp kq kr b">PHPickerViewController</code>与SwiftUI一起使用，我们需要实现<code class="fe ko kp kq kr b">UIViewControllerRepresentable</code>协议。它允许与UIKit view控制器进行完美的通信。</p><h1 id="b8e7" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">链接</h1><ul class=""><li id="ec28" class="mm mn it js b jt mh jx mi kb nk kf nl kj nm kn mr ms mt mu bi translated"><a class="ae li" href="https://github.com/fassko/PHPickerViewController-SwiftUI" rel="noopener ugc nofollow" target="_blank">样本代码</a></li><li id="5991" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated"><a class="ae li" href="https://developer.apple.com/documentation/photokit/phpickerviewcontroller" rel="noopener ugc nofollow" target="_blank"> PHPickerViewController文档</a></li><li id="0e80" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated"><a class="ae li" href="https://krausefx.com/blog/ios-privacy-detectlocation-an-easy-way-to-access-the-users-ios-location-data-without-actually-having-access" rel="noopener ugc nofollow" target="_blank">iOS Privacy:detect . location——无需实际访问即可轻松访问用户的iOS位置数据</a></li><li id="8f0c" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated"><a class="ae li" href="https://www.kairadiagne.com/2020/11/04/adopting-the-new-photo-picker.html" rel="noopener ugc nofollow" target="_blank">采用新的PHPicker </a></li><li id="2cd1" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated"><a class="ae li" href="https://nemecek.be/blog/30/checking-out-the-new-phpickerviewcontroller-in-ios-14-to-select-photos-or-videos" rel="noopener ugc nofollow" target="_blank">在iOS 14中检查新的PHPickerViewController</a></li><li id="c8b2" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated"><a class="ae li" href="https://ohmyswift.com/blog/2020/08/29/replacing-uiimagepickercontroller-with-phpickerviewcontroller/" rel="noopener ugc nofollow" target="_blank">用PHPickerViewController替换UIImagePickerController】</a></li><li id="d8ef" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated"><a class="ae li" href="https://christianselig.com/2020/09/phpickerviewcontroller-efficiently/" rel="noopener ugc nofollow" target="_blank">以内存高效的方式使用PHPickerViewController图像</a></li></ul></div></div>    
</body>
</html>