<html>
<head>
<title>What You Should Know To Troubleshoot AWS Security Groups &amp; Network ACLs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS安全组和网络ACL故障排除须知</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/what-you-should-know-to-troubleshoot-aws-security-groups-network-acls-115ca775dc3a?source=collection_archive---------6-----------------------#2020-05-21">https://levelup.gitconnected.com/what-you-should-know-to-troubleshoot-aws-security-groups-network-acls-115ca775dc3a?source=collection_archive---------6-----------------------#2020-05-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="0a33" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">AWS网络</h2><div class=""/><div class=""><h2 id="54e9" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">AWS安全组和网络ACL的深入故障排除。您应该了解哪些故障排除知识？以及一些有用的网络工具。</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/e311cb91e9443b3ad05fafb1bd884f58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8jMFzunn7XGSehe9FHYBKw.jpeg"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">照片由<a class="ae lh" href="https://unsplash.com/s/photos/connection?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae lh" href="https://unsplash.com/@othentikisra?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> israel palacio </a>拍摄</figcaption></figure><p id="ca6f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果您已经在<a class="ae lh" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS </a>上工作了一段时间，无论是管理基础设施还是创建一些花哨的无服务器应用程序，您一定至少遇到过一次由于AWS安全组或网络访问控制列表(ACL)的错误配置而导致的某种网络问题。</p><p id="fcef" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们看看为什么它们如此重要，以及如果您的AWS网络出现问题，知道如何对它们进行故障排除为什么如此重要。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><p id="0a1f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在我们继续之前，让我们花点时间了解AWS安全组和网络ACL在AWS网络中的用途。</p><h2 id="128b" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">AWS安全组</h2><p id="5aae" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">在这种情况下，我们将仅指VPC安全组，而不是EC2-Classic安全组，因为我们不应再与EC2 Classic合作。</p><p id="43a2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">简单地说，AWS安全组可以被描述为主机级的包过滤防火墙。通常，它们与AWS EC2实例相关联，并被视为抵御任何入侵的最后一道防线。</p><p id="7c06" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">EC2安全组与<a class="ae lh" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html" rel="noopener ugc nofollow" target="_blank">弹性网络接口</a> (ENI)相关联。因为它们附属于ENIs，所以它们与其他服务一起使用，如Amazon RDS、Amazon Elasticache和VPC端点。</p><h2 id="a8b7" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">网络访问控制列表(NACL)</h2><p id="eccb" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">网络ACL是可以在VPC子网级别控制入/出流量的防火墙。NACLs用于管理整个子网中所有EC2实例的流量规则。</p><p id="82f2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">NACL被认为是VPC安全的一个可选层，有时人们生活在默认的NACL规则下，该规则允许进出流量跨越子网边界。</p><p id="a3b3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">由于各种原因，如管理复杂性、安全组规则冗余以及对规则处理开销的担忧，人们普遍倾向于远离自定义NACLs。尽管这些都是合理的考虑，但是在可能的情况下维护定制的NACLs是一个好的实践，以便拥有这个额外的网络安全控制层。为了前任。在任何DDoS攻击的情况下，阻止攻击者的IP范围可能会更容易和更快。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="1bd1" class="ni mm it bd mn nj nk nl mq nm nn no mt ki np kj mw kl nq km mz ko nr kp nc ns bi translated">参考架构</h1><p id="4ba3" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">让我们来看看由于AWS安全组和网络ACL错误配置而遇到的一些基于场景的AWS网络问题。作为参考，我们将考虑下面的简单架构。</p><p id="9d28" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这里，我们使用AWS应用程序负载平衡器(ALB ),以及ALB后面的EC2实例(在不同的子网中),它们也可以连接到一些外部网络。在这种情况下，我们将它视为公共互联网。另外，请注意，我们将子网连接到两个独立的网络ACL。这是为了我们的故障排除场景，在实践中不必如此。</p><p id="765c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">此外，这里假设我们有其他网络服务和组件，如路由表、互联网网关、NAT网关等。配置正确。这里的重点是深入探讨与安全组和NACLs相关的问题，但在任何此类故障排除过程中，可能还必须考虑其他相关服务的配置。</p><p id="bc61" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><em class="nt">一旦我们深入以下几节中的故障排除场景，您应该能够将类似的概念应用到您的相关使用案例和场景中。</em></p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/32b7119544b8d0c0b4cf843cfacc33ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*_FHTwHHPyprgeIwChz13WQ.png"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">参考架构</figcaption></figure></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="ee91" class="ni mm it bd mn nj nk nl mq nm nn no mt ki np kj mw kl nq km mz ko nr kp nc ns bi translated">AWS安全组故障排除</h1><h2 id="fcfc" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">场景1:一切都使用默认出站规则</h2><p id="756e" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">基于上面的架构，让我们理解安全组如何使用默认出站规则。</p><p id="5d28" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我为负载平衡器和web服务器考虑了两个独立的安全组。并且，我在两个安全组中打开了1 <code class="fe nv nw nx ny b">HTTP/80</code>入站规则，没有对出站规则进行任何更改。</p><p id="5bef" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><em class="nt">注意:为了简单起见，我考虑使用HTTP/80而不是安全的HTTPS/443。尽管这不是一个好的实践。</em>😥</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nz"><img src="../Images/4260489d28f08d66b2d0ebda29cd1312.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lf2nm9eslDOwR5oYyKtBpA.png"/></div></div></figure><p id="4fa7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在这种情况下，您应该能够成功地<code class="fe nv nw nx ny b">curl/wget</code>(或使用浏览器)负载平衡器的DNS名称(一个记录)或CNAME(如果您有)。你会看到这样的HTML响应—</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oa"><img src="../Images/746b4bc5584182712bf832535f24573e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fNGUxItArHN-ESU47LQqKA.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">卷曲试验</figcaption></figure><p id="2da8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在，要查看EC2实例安全组的出站规则是如何工作的，您可以尝试ping Google DNS IPs，它应该也能正常工作。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/a8c40a0257944773d7b6e56fd9944962.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/1*8xtOBu9kXT1bZvPfhy6llw.png"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">从EC2服务器ping Google DNS IP</figcaption></figure><p id="1a8a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">因此，我们检查了下面列出的交通流量，它们工作正常。</p><ul class=""><li id="c3c1" class="oc od it lk b ll lm lo lp lr oe lv of lz og md oh oi oj ok bi translated">从用户到→ ALB到→ EC2的流量，以及返回的响应。</li><li id="a75f" class="oc od it lk b ll ol lo om lr on lv oo lz op md oh oi oj ok bi translated">从EC2(比如说，<code class="fe nv nw nx ny b">ping 8.8.8.8</code>)到互联网的流量以及返回的响应。</li></ul><p id="367f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在我们探索其他场景和配置选项之前，理解安全组的有状态行为和连接跟踪机制是很重要的。</p><blockquote class="oq or os"><p id="2ee2" class="li lj nt lk b ll lm kd ln lo lp kg lq ot ls lt lu ou lw lx ly ov ma mb mc md im bi translated">那么，什么是连接跟踪，它如何使安全组有状态？</p></blockquote><p id="7b2b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在上面讨论的场景中，让我们假设我们从附加到EC2实例的<code class="fe nv nw nx ny b">nginx-web-sg</code>安全组中删除了出站规则。现在，来自负载均衡器的任何请求仍然会得到响应。这是因为响应通过在源端打开的临时端口返回到源端(无论是负载平衡器还是另一个EC2实例)。简而言之，这就是连接跟踪。</p><p id="a25f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">但是，来自EC2实例的任何流量(在本例中为<code class="fe nv nw nx ny b">ping 8.8.8.8</code>)将无法流出。这是因为现在在<code class="fe nv nw nx ny b">nginx-web-sg</code>安全组中没有适用于源流量的出站规则。</p><p id="7bab" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">因此，我们有了安全组的有状态行为。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h2 id="6df1" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">场景2:无法从EC2实例连接到另一个网络</h2><p id="5405" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">在这种情况下，已经删除了<code class="fe nv nw nx ny b">nginx-web-sg</code>安全组的默认出站规则。如上所述，任何来自EC2实例的流量(在本例中为<code class="fe nv nw nx ny b">ping 8.8.8.8</code>)都将无法流出。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nz"><img src="../Images/cfb2d49c02beb5de7b1d691395e1964d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4N4z2TeEWZzDfOnzBgy7cw.png"/></div></div></figure><p id="9d9c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果您尝试运行<code class="fe nv nw nx ny b">ping 8.8.8.8</code>或<code class="fe nv nw nx ny b">curl -I https://<a class="ae lh" href="http://www.amazon.com," rel="noopener ugc nofollow" target="_blank">www.amazon.com</a></code>或<a class="ae lh" href="http://www.amazon.com," rel="noopener ugc nofollow" target="_blank">，</a> egress将会失败。您会看到100%的数据包丢失。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/c95e34f1c8fd44f7e211609ffd1f06de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/format:webp/1*EDo_3P9nK_Bty0cpy6QW7w.png"/></div></figure><p id="94be" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">但是，您仍然会看到对负载平衡器请求的成功响应。那么，它是如何工作的呢？从负载平衡器安全组到EC2安全组的连接跟踪使其工作。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oa"><img src="../Images/746b4bc5584182712bf832535f24573e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fNGUxItArHN-ESU47LQqKA.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">卷曲试验</figcaption></figure><p id="9452" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们快速检查一下为上述请求创建的VPC流日志条目。如果您还没有启用VPC流日志，我建议立即启用它，因为这是推荐的最佳实践。</p><p id="d328" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">由于VPC流量日志条目是根据ENI生成的，您可能需要查看与相关Eni对应的所有日志组。</p><p id="d8a5" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">单个Eni的VPC流量日志样本CloudWatch日志组:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ox"><img src="../Images/7157aa16ac928a67a35ecfb47ff07499.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kePRXUfbPXUiT24HHMcVeA.png"/></div></div></figure><p id="60ec" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">请注意，默认日志格式如下所示。现在，如果需要，我们也可以配置自定义格式。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oy"><img src="../Images/438afecc9a137eec8eb3e956a90c71e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uo2RWBZvJLzD9Zb6DetfwA.png"/></div></div></figure><p id="fcf2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在下面的流日志中，我们有两个独立的事件。</p><p id="f042" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">第一条记录是在从<code class="fe nv nw nx ny b">nginx-web-sg</code>安全组中删除安全出站规则的情况下发出<code class="fe nv nw nx ny b">ping 8.8.8.8</code>请求时的条目。在这种情况下，流量无法流出EC2实例。</p><p id="80e9" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">当默认出站规则存在时，日志显示2条类似于时间戳为<code class="fe nv nw nx ny b"><em class="nt">16:22:27</em></code>的记录。从VPC流量日志格式中，我们可以看到响应被成功接收— <code class="fe nv nw nx ny b">request 10.0.4.80 → 8.8.8.8</code>和<code class="fe nv nw nx ny b">response 8.8.8.8 → 10.0.4.80</code>。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oz"><img src="../Images/bc746700ad090dcd1489685793ec2d6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yS2UzZrGmwsr3Ppy5RoA5w.png"/></div></div></figure></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h2 id="ae58" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">场景3:一些连接在EC2实例中工作正常，而另一些则不然</h2><p id="3bcd" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">这里，<code class="fe nv nw nx ny b">nginx-web-sg</code>安全组的默认出站规则已经被替换为自定义出站规则。让我们考虑一下<code class="fe nv nw nx ny b">HTTP/80</code>已经向公众开放了互联网。</p><p id="8e81" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在，只有来自我们EC2实例的特定流量(<code class="fe nv nw nx ny b">HTTP/80</code>)能够流出，并且响应将被成功接收。任何其他像<code class="fe nv nw nx ny b">ping 8.8.8.8</code>或<code class="fe nv nw nx ny b">ping <a class="ae lh" href="http://www.amazon.com" rel="noopener ugc nofollow" target="_blank">www.amazon.com</a> -c 1</code>这样的请求都会因为缺少出站规则而失败。“ping”需要ICMP出站规则。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pa"><img src="../Images/5af341c7ce600ac8db8b01e015de0dc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4WEwrC551AshIBKC0Wdpiw.png"/></div></div></figure><p id="d0aa" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">查看这些不同请求的源ENI VPC流日志。您将看到源EC2实例安全组阻止了“ping”流量的相关条目。对于<code class="fe nv nw nx ny b">curl -Iv <a class="ae lh" href="http://www.amazon.com" rel="noopener ugc nofollow" target="_blank">www.amazon.com</a></code>请求，将会有请求/响应条目。</p><p id="63bb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">注意，我在curl命令中使用了<code class="fe nv nw nx ny b">-Iv</code>作为选项。这将在详细模式下打印标题信息。因此，我们会看到发出请求的IP地址。在搜索VPC流日志时，可以使用该IP地址。</p><p id="a742" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">样本“卷曲”和VPC流量测井输出:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/9bf263ac28d79752c099626591e77b2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:940/format:webp/1*nyOkmTiomfP1FWJNgJAB5w.png"/></div></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pc"><img src="../Images/057d93ded3cae12ccb54dcdcaa8c1778.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WAtssD4Q5Qr6s73qk7h6OQ.png"/></div></div></figure></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h2 id="1d73" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">场景4:多个资源使用同一个安全组</h2><p id="6fdf" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">有时，您可能希望对负载平衡器及其背后的服务器使用同一个安全组。但是，我不推荐这种方法，因为它不是一种非常整洁的方法，而且随着规则数量的增加，它会变得非常复杂。此外，保持隔离也变得很困难。</p><p id="ce9a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然而，我已经看到这种模式在多个场合被使用。因此，让我们探讨一下在这种情况下，我们需要如何配置规则，以使配置正常工作。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pd"><img src="../Images/6dd0c49184fe289a2b9477715aff792d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4sJxBOEn-asF_hG1WOWlxQ.png"/></div></div></figure><p id="961c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在这里，您会注意到规则中有对自身的引用。</p><p id="9d49" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">对于入站规则，同一个安全组现在需要从所有可能的来源打开所有必需的规则。在这种情况下，它应该包括负载平衡器和EC2实例的规则。</p><p id="1538" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">此外，安全组应该包括一个规则，允许自己作为源。当EC2实例从负载平衡器接收流量时，将应用此规则。如果未配置此规则，EC2实例将无法接收流量，因为没有匹配的入站规则。</p><p id="e86e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">另一个场景是不同的端口被用作负载平衡器和EC2实例的入站端口。例如，如果负载平衡器正在监听<code class="fe nv nw nx ny b">HTTPS/443</code>，并且在SSL/TLS卸载后流量被发送到<code class="fe nv nw nx ny b">HTTP/80</code>上的EC2实例，那么安全组需要在入站规则中允许<code class="fe nv nw nx ny b">HTTP/80</code>和<code class="fe nv nw nx ny b">HTTPS/443</code>。如果只配置了<code class="fe nv nw nx ny b">HTTP/443</code>，那么流量将被阻塞，因为EC2实例的适用入站规则<code class="fe nv nw nx ny b">HTTP/80</code>丢失。</p><p id="0ccd" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">关于出站规则，一种选择是保留默认规则，我们不必担心出站连接。但是，如果您可能使用自定义出站规则，请确保所有必需的端口和协议都是开放的。出站规则将适用于负载平衡器和EC2实例。</p><p id="c362" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">使用上图中的第一个出站规则，我们可以将流量从负载平衡器发送到EC2实例，因为该实例使用相同的安全组，并且自身也有一个入站规则。并且，第二个规则将允许<code class="fe nv nw nx ny b">ping 8.8.8.8</code>成功，但不允许<code class="fe nv nw nx ny b">ping 8.8.4.4</code>，因为该规则是特定于IP地址的。</p><p id="ceb9" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如您所见，对多个入站/出站资源使用带有自定义出站规则的单个安全组会很快使事情变得复杂。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="d1ed" class="ni mm it bd mn nj nk nl mq nm nn no mt ki np kj mw kl nq km mz ko nr kp nc ns bi translated">网络ACL故障排除</h1><p id="cf5b" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">让我们将网络ACL融入其中，看看会发生什么。回顾我们的参考架构，我们在独立的子网中有2个EC2实例，它们与2个不同的网络ACL相关联。我们也可以拥有与1个NACL相关联的子网，但我将它分开，以便在这里讨论我们的故障排除场景。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/32b7119544b8d0c0b4cf843cfacc33ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*_FHTwHHPyprgeIwChz13WQ.png"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">参考架构</figcaption></figure><p id="4b0e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">网络ACL是无状态的。与安全组不同，连接跟踪不适用于NACLs。因此，我们需要为允许/拒绝规则配置所有相关的端口和协议。</p><p id="6603" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">默认NACLs允许所有入站/出站流量。但是，默认情况下，自定义NACLs会拒绝所有流量。需要添加允许/拒绝入口/出口规则。</p><p id="75fe" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">NACL的一个重要方面是规则处理顺序。基本上，数字越小，优先级越高。我们来看一个例子。</p><p id="e2b8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果我们有一个更高规则号的出站ICMP拒绝规则(见下面的截图)，那么它仍然允许<code class="fe nv nw nx ny b">ping 8.8.8.8</code>外出。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pe"><img src="../Images/0884aa2eb0e72b781aeaad39cf847181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BY5fmPFGg02oQ9m_MSnZkQ.png"/></div></div></figure><p id="eaa4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">但是，如果规则的编号较低(因此优先级较高)，那么它会阻止流量。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pf"><img src="../Images/1039aa23e303cefba77a5b9396ae5a87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RnBCaj8ySCBIifwIWbNZRA.png"/></div></div></figure><h2 id="6844" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">分析NACL相关问题的VPC流量日志</h2><p id="fb47" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">既然我们已经了解了规则优先级在NACL中是如何工作的，那么让我们来看看如何分析VPC流日志并对NACL相关问题进行故障排除。</p><p id="6bbe" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们考虑我们架构中的2个EC2实例。为简单起见，让我们考虑具有默认规则的安全组和具有默认允许入站/出站规则的子网A(流量源)NACL。</p><h2 id="6a25" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">场景1:使用入站拒绝NACL规则的子网B(流量目的地)</h2><p id="e6aa" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">在这种情况下，源EC2实例和子网A的安全组和NACL分别允许出口流量。因此，流量应该到达目的子网和EC2实例。</p><p id="9929" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">请记住，在排除NACL问题时，我们需要检查源和目标ENI VPC流量日志。</p><p id="35a2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">源EC2 ENI的VPC流日志将显示如下所示的条目。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/4b7a1a035969d8572f92952b55c47933.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*94kcTZEgGKEd95h7nUy_JA.png"/></div></figure><p id="4a25" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">并且，目的地EC2 ENI的VPC流日志将只有如下1个条目。为什么？因为入站流量在到达EC2安全组之前被入站NACL规则阻止。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ph"><img src="../Images/4c25a303c045851186548703845efed1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*te0_P7SyiYdBhnFbXpR-cw.png"/></div></div></figure><p id="bb45" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在下一个场景中，让我们看看添加拒绝出站规则而不是入站规则时会发生什么。</p><h2 id="5afa" class="ml mm it bd mn mo mp dn mq mr ms dp mt lr mu mv mw lv mx my mz lz na nb nc iz bi translated">场景2:使用出站拒绝NACL规则的子网B(流量目的地)</h2><p id="253d" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">像前面的场景一样，源EC2 ENI VPC流量日志条目将是可用的。</p><p id="23ab" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">但是，在目的地EC2 ENI的情况下，我们将能够看到2个条目。第一个是入站接受条目，第二个是出站拒绝条目。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pi"><img src="../Images/93927dfee8f789fa5d3df1a75730feee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gqFKn6c4r3oBa40om1CJlg.png"/></div></div></figure><p id="ec98" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">因此，有了可用的VPC流日志条目，您应该能够找出可能的配置问题。用ping或curl之类的命令测试上述规则配置，您应该会看到预期的输出。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="b7cb" class="ni mm it bd mn nj nk nl mq nm nn no mt ki np kj mw kl nq km mz ko nr kp nc ns bi translated">有用的网络故障排除工具</h1><p id="9972" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">下面列出了我在排除网络相关问题时通常使用的一些常用工具/实用程序。</p><p id="6f72" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">尽管专业网络工程师可能会使用其他工具，但这些工具应该足以解决基本的AWS网络问题。</p><p id="17ee" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> ping </strong> —用于通过ICMP在源和目的地之间进行基本连接测试。</p><p id="faa2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> tracert </strong>，<strong class="lk jd"> traceroute </strong> —用于查找从源到目的地路径的更详细信息。</p><p id="92a1" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> dig，nslookup </strong> —查找DNS记录。</p><p id="650d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> ipconfig </strong>，<strong class="lk jd"> ifconfig </strong> —查找主机的IP配置。</p><p id="1289" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> netstat </strong> —用于查找活动的TCP连接/端口。</p><p id="f265" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> telnet </strong> —用于检查可远程访问的TCP端口，或在开放端口上远程连接。</p><p id="427e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> netcat </strong> —类似于telnet，但提供更多功能，如使用UDP连接。</p><p id="51a1" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd">路由</strong> —查找或编辑路由信息。</p><p id="e387" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> Wireshark </strong> —网络数据包分析工具。这可以用于深度包检查。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="20d6" class="ni mm it bd mn nj nk nl mq nm nn no mt ki np kj mw kl nq km mz ko nr kp nc ns bi translated">总结想法</h1><p id="d5e3" class="pw-post-body-paragraph li lj it lk b ll nd kd ln lo ne kg lq lr nf lt lu lv ng lx ly lz nh mb mc md im bi translated">除了这些工具之外，在对EC2主机级别的基本网络问题进行故障排除时，您可能还需要考虑其他方面。</p><p id="0429" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">根据Windows与Linux系统的不同，您可能还需要查看主机级配置，比如iptables /Windows防火墙、主机网络配置文件、DNS设置等等！</p><p id="fbb5" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我希望这篇文章能帮助你理解AWS安全组和NACL规则是如何协同工作的，以及它们如何影响你的AWS环境中的连通性。</p><p id="3aac" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">故障排除愉快！</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="4cf5" class="ni mm it bd mn nj nk nl mq nm nn no mt ki np kj mw kl nq km mz ko nr kp nc ns bi translated">参考</h1><div class="pj pk gp gr pl pm"><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html" rel="noopener  ugc nofollow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd jd gy z fp pr fr fs ps fu fw jc bi translated">您的VPC的安全组</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">安全组充当实例的虚拟防火墙，控制入站和出站流量。当您启动…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><div class="pj pk gp gr pl pm"><a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html" rel="noopener  ugc nofollow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd jd gy z fp pr fr fs ps fu fw jc bi translated">网络ACL</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">网络访问控制列表(ACL)是VPC的一个可选安全层，可作为防火墙用于…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">docs.aws.amazon.com</p></div></div><div class="pv l"><div class="pw l px py pz pv qa lb pm"/></div></div></a></div><div class="pj pk gp gr pl pm"><a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html" rel="noopener  ugc nofollow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd jd gy z fp pr fr fs ps fu fw jc bi translated">VPC流量测井</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">VPC流量日志是一项功能，使您能够捕获进出网络的IP流量信息…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">docs.aws.amazon.com</p></div></div><div class="pv l"><div class="qb l px py pz pv qa lb pm"/></div></div></a></div></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><p id="87f1" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><em class="nt">跟我上</em> <a class="ae lh" href="https://www.linkedin.com/in/bideep/" rel="noopener ugc nofollow" target="_blank"> <em class="nt"> LinkedIn </em> </a> <em class="nt">，</em><a class="ae lh" href="https://twitter.com/bbideep" rel="noopener ugc nofollow" target="_blank"><em class="nt">Twitter</em></a><em class="nt">。</em></p><p id="ed99" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><a class="ae lh" href="https://bbideep.medium.com/subscribe" rel="noopener"> <em class="nt">在媒体上订阅</em> </a> <em class="nt">更多此类帖子。</em></p></div></div>    
</body>
</html>