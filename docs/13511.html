<html>
<head>
<title>Upload Files to S3 Using Angular and NestJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Angular和NestJS将文件上传到S3</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/upload-files-to-s3-using-angular-and-nestjs-64721d815d18?source=collection_archive---------2-----------------------#2022-09-12">https://levelup.gitconnected.com/upload-files-to-s3-using-angular-and-nestjs-64721d815d18?source=collection_archive---------2-----------------------#2022-09-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ff21" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Angular和NestJS的端到端示例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/934a44359c0a01a004dbf24d7f0521e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*76MfwqJzRTxBT_B09ak-6A.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@agniveshaj?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">阿格尼维什·贾亚迪普</a>在<a class="ae ky" href="https://unsplash.com/s/photos/file?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="5d03" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最近，我为Angular/NestJS应用程序开发了一个S3文件上传功能。令我惊讶的是，我很难找到一个完整的和工作的例子教程。因此，我认为用Angular和NestJS完成将文件上传到S3 (Amazon Simple Storage Service)存储桶的过程可能是有用的。</p><p id="82d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我假设你对Angular和NestJS有基本的了解。因此，我将跳过这些应用程序的初始设置，专注于文件上传部分。</p><h1 id="849a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">先决条件</h1><p id="a969" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">您将需要这些技术来跟进:</p><ul class=""><li id="0809" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">角度14</li><li id="6104" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">NestJS版本9</li><li id="abfd" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">NodeJS v14或以上</li><li id="51ae" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">AWS帐户</li></ul></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h2 id="4c68" class="nn lw it bd lx no np dn mb nq nr dp mf li ns nt mh lm nu nv mj lq nw nx ml ny bi translated">S3桶和访问密钥/秘密访问密钥</h2><p id="8efd" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">要将文件上传到S3，我们需要设置NestJS API访问它所需的S3桶和IAM用户。</p><p id="b54c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你还没有一个S3桶，按照这个指令创建一个。</p><p id="6a75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是登录您的AWS帐户并导航到IAM以添加用户。输入用户名并勾选“访问键-编程访问”选项。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/4b3530af23a76303476744f7e4a6b657.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gTTzcQ0WjgRi6hvn5RwJvw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">创建IAM用户</figcaption></figure><p id="1e0f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，单击“Next: Permission”按钮，将“AmazonS3FullAccess”策略附加到IAM用户。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/63fbc2174d2edb94375daecd30bd2584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y72uqoq2Ig1uzhWHQCR39g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">附加现有策略</figcaption></figure><p id="e3b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">单击“下一步”按钮接受默认设置并创建用户。访问密钥ID和秘密访问密钥将显示在成功屏幕上。我们可以下载CSV文件来保存键值以备后用。</p><p id="410c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，我们创建一个IAM用户，他可以完全访问您的AWS帐户下的所有S3时段。在生产环境中，我们应该创建一个自定义策略，限制IAM用户只能访问特定的S3存储桶进行文件上传。但是为了简单起见，我们在本文中跳过这一步。</p><p id="1595" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们已经准备好了S3桶。让我们用NestJS构建文件上传API。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h2 id="b291" class="nn lw it bd lx no np dn mb nq nr dp mf li ns nt mh lm nu nv mj lq nw nx ml ny bi translated">NestJS文件上传</h2><p id="60da" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们可以使用Nest CLI创建一个新的NestJS应用程序。</p><pre class="kj kk kl km gt ob oc od oe aw of bi"><span id="891f" class="nn lw it oc b gy og oh l oi oj">nest new ng-nest-upload</span></pre><p id="116e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要安装<code class="fe ok ol om oc b">aws-sdk</code>包。</p><pre class="kj kk kl km gt ob oc od oe aw of bi"><span id="c009" class="nn lw it oc b gy og oh l oi oj">npm install aws-sdk @types/aws-sdk</span></pre><p id="e0d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还需要安装multer的类型定义</p><pre class="kj kk kl km gt ob oc od oe aw of bi"><span id="d0c8" class="nn lw it oc b gy og oh l oi oj">npm i -D @types/multer</span></pre><blockquote class="on oo op"><p id="76da" class="kz la oq lb b lc ld ju le lf lg jx lh or lj lk ll os ln lo lp ot lr ls lt lu im bi translated">NestJs使用<a class="ae ky" href="https://www.npmjs.com/package/multer" rel="noopener ugc nofollow" target="_blank"> Multer </a>来处理文件上传。Multer是一个处理<code class="fe ok ol om oc b">multipart/form-data</code>的node.js中间件，主要用于上传文件。Multer将表单文本字段的值提取到一个<code class="fe ok ol om oc b">body</code>对象中。它还在<code class="fe ok ol om oc b">request.file</code>或<code class="fe ok ol om oc b">request.files</code>对象中为文件或多个文件创建一个新对象。<code class="fe ok ol om oc b">body</code>对象包含表单文本字段的值，<code class="fe ok ol om oc b">file</code>或<code class="fe ok ol om oc b">files</code>对象包含通过表单上传的文件。</p></blockquote><p id="5acd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建文件上传端点，它从FileInterceptor捕获并保存文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ou ov l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">文件上传控制器</figcaption></figure><p id="25a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在这里使用两个装饰者:</p><ul class=""><li id="c373" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated"><code class="fe ok ol om oc b">FileInterceptor</code>:将字段名作为第一个参数，提取上传的文件。字段名是从客户端<code class="fe ok ol om oc b">multipart/form-data</code>发送的，因此您需要更新它以匹配您代码中的字段名。FileInterceptor在幕后使用Multer。</li><li id="79db" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><code class="fe ok ol om oc b">UploadedFile</code>:用于从请求中引用文件载荷。</li></ul><h2 id="9306" class="nn lw it bd lx no np dn mb nq nr dp mf li ns nt mh lm nu nv mj lq nw nx ml ny bi translated">将文件保存到S3桶中</h2><p id="0390" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在上面的控制器中，我们也使用<code class="fe ok ol om oc b">FileService</code>将文件保存到S3。在文件服务中，我们使用<code class="fe ok ol om oc b">aws-sdk</code> v3将流对象上传到S3桶。如下所示，我们需要指定3个参数</p><ul class=""><li id="21fc" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">时段:S3时段的名称</li><li id="72de" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">Body:表示文件的缓冲区对象</li><li id="1196" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">Key:文件的唯一键</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ou ov l"/></div></figure><p id="79ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如何在NestJS API中设置对S3的访问配置？我们在<code class="fe ok ol om oc b">main.ts</code>的<code class="fe ok ol om oc b">bootstrap </code>方法中初始化这些配置。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ou ov l"/></div></figure><p id="45bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样为了简单起见，在上面的例子中，访问密钥和秘密是硬编码的。在现实生活的应用程序中，它们应该来自环境变量。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h2 id="c947" class="nn lw it bd lx no np dn mb nq nr dp mf li ns nt mh lm nu nv mj lq nw nx ml ny bi translated">棱角分明的客户</h2><p id="c158" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了从Angular应用程序上传文件，我们使用<code class="fe ok ol om oc b"><a class="ae ky" href="https://medium.com/gitconnected/3-ways-to-access-local-files-from-web-browser-70f57fa57e50" rel="noopener"><em class="oq">File</em></a></code> <a class="ae ky" href="https://medium.com/gitconnected/3-ways-to-access-local-files-from-web-browser-70f57fa57e50" rel="noopener"> <em class="oq"> </em>接口</a>，该接口提供关于文件的信息并允许网页上的JavaScript访问它们的内容。</p><p id="68c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的<code class="fe ok ol om oc b">&lt;input type="file"&gt;</code>代表一个文件选择域和一个“选择文件”按钮。这个简单的按钮允许用户从浏览器访问本地文件。我们可以使用<code class="fe ok ol om oc b">accept</code>属性来限制上传文件的类型。</p><pre class="kj kk kl km gt ob oc od oe aw of bi"><span id="e091" class="nn lw it oc b gy og oh l oi oj">&lt;input type="file" [accept]="acceptedFileExtensions" (change)="attachFile($event)"&gt;</span></pre><p id="b489" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不幸的是，我们不能改变默认文件选择按钮的样式。解决方案是使用另一个自定义按钮来调用默认按钮。在下面的代码中，我们隐藏了默认按钮，并用CSS类<code class="fe ok ol om oc b">fileButton</code>设计了自定义按钮。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ou ov l"/></div></figure><p id="06c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe ok ol om oc b">UploadComponent</code>中，我们使用@ViewChild decorator来获取对模板中隐藏的文件选择按钮的引用。</p><pre class="kj kk kl km gt ob oc od oe aw of bi"><span id="9cf3" class="nn lw it oc b gy og oh l oi oj">@ViewChild(‘fileInput’, { static: false })<br/> fileInput: ElementRef | undefined;</span></pre><p id="ef43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以调用组件类中的隐藏按钮click，而不是调用Html模板中的click处理程序，如下所示。</p><pre class="kj kk kl km gt ob oc od oe aw of bi"><span id="9268" class="nn lw it oc b gy og oh l oi oj">this.fileInput.nativeElement.click();</span></pre><p id="664a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了将文件发送到NestJS API，我们构造了formData并向NestJS端点发送了一个请求，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ou ov l"/></div></figure><p id="4846" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，post请求标题不应包含内容类型。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h2 id="6f32" class="nn lw it bd lx no np dn mb nq nr dp mf li ns nt mh lm nu nv mj lq nw nx ml ny bi translated">进一步考虑</h2><p id="9b71" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在这个虚构的例子中，没有实现身份验证。在实际应用中，您可以考虑使用JWT令牌来<a class="ae ky" href="https://medium.com/gitconnected/maximize-code-security-in-your-nestjs-applications-part-2-be707466b7ea" rel="noopener">加强Angular客户端和后端之间的安全性</a>。</p><p id="9d7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一件要考虑的事情是上传文件的安全性。尽管我们已经在Angular客户机中实现了文件扩展名的验证，但这还不够。含有恶意内容的文件仍有可能溜进来。更好的方法是设置一个带有防病毒扫描服务的分段S3存储桶。在将任何上传的文件移动到最终存储桶进行消费之前，都需要对其进行扫描。但是这个主题超出了本文的范围，这里的<a class="ae ky" href="https://aws.amazon.com/blogs/apn/integrating-amazon-s3-malware-scanning-into-your-application-workflow-with-cloud-storage-security/" rel="noopener ugc nofollow" target="_blank">是一个很好的起点。</a></p><p id="e486" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过对上传的文件执行这些检查，您可以确保它不是恶意的，并保护您的系统免受潜在的伤害。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h2 id="dc97" class="nn lw it bd lx no np dn mb nq nr dp mf li ns nt mh lm nu nv mj lq nw nx ml ny bi translated">摘要</h2><p id="5ad8" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在本文中，我们将通过NestJS API从Angular客户端向S3木桶上传一个文件。通过内置的装饰器，NestJS使得处理文件上传过程变得非常容易。</p><p id="760f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完整的源代码可以在这个<a class="ae ky" href="https://github.com/sunnyy02/ng-nest-s3-upload" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中找到。</p><p id="56bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编程快乐！</p></div></div>    
</body>
</html>