<html>
<head>
<title>Cron Jobs — For Scheduling Tasks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Cron作业—用于调度任务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/cron-jobs-for-scheduling-tasks-1b835d9502b?source=collection_archive---------16-----------------------#2021-05-16">https://levelup.gitconnected.com/cron-jobs-for-scheduling-tasks-1b835d9502b?source=collection_archive---------16-----------------------#2021-05-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/49cff5ec44be8bbb70544460be2535d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JU8SLStT_WFtPsdasinMbw.jpeg"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">由<a class="ae jg" href="https://unsplash.com/@malvestida?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Malvestida杂志</a>在<a class="ae jg" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><div class=""/><p id="9a53" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Cron作业用于调度在服务器上运行的任务。它们最常用于自动化系统维护或管理。然而，它们也与web应用程序开发相关。在许多情况下，web应用程序可能需要定期运行某些任务。</p><h1 id="1cc0" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">定义</h1><p id="fa96" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">首先，让我们熟悉一下与这门学科相关的术语。</p><blockquote class="mh mi mj"><p id="b91c" class="kg kh mk ki b kj kk kl km kn ko kp kq ml ks kt ku mm kw kx ky mn la lb lc ld im bi translated">"<strong class="ki jk"> Cron </strong>"是类Unix操作系统(Linux、FreeBSD、Mac OS等)中基于时间的作业调度器。这些作业或任务被称为“Cron作业”。</p></blockquote><p id="3cdf" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有一个cron“守护进程”运行在这些系统上。守护程序是一直在后台运行的程序，通常由系统启动。这个cron守护进程负责按计划启动这些cron作业。</p><p id="0b0c" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该计划驻留在名为“crontab”的配置文件中。那里列出了所有的任务和它们的计时器。</p><h1 id="8472" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">为什么要使用Cron Jobs？</h1><p id="6a9e" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">服务器管理员已经使用cron作业很长时间了。然而，对于web开发，让我们来看一些与这个领域相关的cron作业的用例:</p><ul class=""><li id="8312" class="mo mp jj ki b kj kk kn ko kr mq kv mr kz ms ld mt mu mv mw bi translated">如果我们有一个会员网站，其中的帐户有到期日期，我们可以安排cron作业来定期停用或删除过期的帐户。</li><li id="e2f1" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld mt mu mv mw bi translated">我们可以每天发送时事通讯电子邮件。</li><li id="7d5e" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld mt mu mv mw bi translated">如果我们在您的数据库中有汇总表(或物化视图),它们可以用cron作业定期更新。例如，我们可以将每个网页的点击率存储在一个表中，但另一个汇总表可能包含每日流量汇总。</li><li id="852e" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld mt mu mv mw bi translated">我们可以在某个时间间隔终止并删除缓存的数据文件。</li><li id="ec3d" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld mt mu mv mw bi translated">我们可以自动检查我们网站内容中的断开链接，并定期通过电子邮件向我们发送报告。</li><li id="c1e5" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld mt mu mv mw bi translated">我们可以安排长时间运行的任务从命令行脚本运行，而不是从web脚本运行。比如视频编码，或者群发邮件。</li><li id="437d" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld mt mu mv mw bi translated">我们甚至可以做一些简单的事情，比如获取我们最近的推文，并缓存在一个文本文件中。</li></ul><h1 id="8b46" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">句法</h1><p id="aed9" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">下面是一个简单的cron作业:</p><p id="c319" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">10 * * * * /usr/bin/php /www/virtual/username/cron.php &gt; /dev/null 2&gt;&amp;1</code></p><p id="3b8f" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有两个主要部分:</p><ol class=""><li id="77be" class="mo mp jj ki b kj kk kn ko kr mq kv mr kz ms ld ng mu mv mw bi translated">第一部分是“10 * * * *”。这是我们安排计时器的地方。</li><li id="f75f" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld ng mu mv mw bi translated">该行的其余部分是从命令行运行的命令。</li></ol><p id="8a88" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本例中的命令本身有三个部分:</p><ol class=""><li id="6e64" class="mo mp jj ki b kj kk kn ko kr mq kv mr kz ms ld ng mu mv mw bi translated">"/usr/bin/php "。PHP脚本本身通常是不可执行的。因此，我们需要通过PHP解析器运行它。</li><li id="61aa" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld ng mu mv mw bi translated">"/www/virtual/username/cron.php "。这只是脚本的路径。</li><li id="3c73" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld ng mu mv mw bi translated">" &gt;/dev/null 2&gt;&amp;1 "。这部分处理脚本的输出。稍后将详细介绍。</li></ol><h1 id="e0b2" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">时序语法</h1><p id="1c34" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如上所述，这是cron作业字符串的第一部分。它决定了cron作业运行的频率和时间。</p><p id="acfd" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它由五部分组成:</p><ol class=""><li id="0192" class="mo mp jj ki b kj kk kn ko kr mq kv mr kz ms ld ng mu mv mw bi translated">分钟</li><li id="3090" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld ng mu mv mw bi translated">小时</li><li id="7e84" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld ng mu mv mw bi translated">一月中的某一天</li><li id="1d55" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld ng mu mv mw bi translated">月</li><li id="749a" class="mo mp jj ki b kj mx kn my kr mz kv na kz nb ld ng mu mv mw bi translated">星期几</li></ol><p id="8e89" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是一个例子:</p><figure class="ni nj nk nl gt iv gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/23b84a795999ae1125fdf6dcf7cbbe7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*D8tl29kLrIkQQnNJ.png"/></div></figure><h2 id="7922" class="nm lf jj bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">星号</h2><p id="9896" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">通常，您会看到星号(*)而不是数字。这代表了该职位所有可能的数字。例如，分钟位置的星号会使它每分钟运行一次。</p><p id="46d2" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要看几个例子来完全理解这个语法。</p><h2 id="6472" class="nm lf jj bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">示例:</h2><p id="1bb0" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">这个cron作业将每分钟一直运行:</p><p id="bf15" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">* * * * * [command]</code></p><p id="ee6e" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该cron作业将在每小时的第0分钟运行(即每小时一次的cron作业):</p><p id="2021" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">0 * * * * [command]</code></p><p id="a445" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这也是一个每小时的cron作业，但改为在第15分钟运行(即00:15、01:15、02:15等。):</p><p id="b27c" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">15 * * * * [command]</code></p><p id="784a" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将在每天凌晨2:30运行一次:</p><p id="7fde" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">30 2 * * * [command]</code></p><p id="598f" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将在每月第二天的午夜运行一次(即1月2日12:00am、2月2日12:00am等)。):</p><p id="051b" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">0 0 2 * * [command]</code></p><p id="857f" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将在星期一每小时运行一次(即一天24次，但仅在星期一):</p><p id="8753" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">0 * * * 1 [command]</code></p><p id="a593" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以使用多个用逗号分隔的数字。这将每小时运行三次，时间分别为0分钟、10分钟和20分钟:</p><p id="01c6" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">0,10,20 * * * * [command]</code></p><p id="ceff" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">也使用除法运算符。这将每小时运行12次，即每5分钟一次:</p><p id="84fc" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">*/5 * * * * [command]</code></p><p id="21ed" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">破折号可用于指定范围。这将在上午5:00到10:00之间每小时运行一次:</p><p id="bad9" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">0 5-10 * * * [command]</code></p><p id="d747" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，有一个特殊的关键字可以让您在每次服务器重新启动时运行cron作业:</p><p id="0039" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">@reboot [command]</code></p><h1 id="ec06" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">设置和管理Cron作业</h1><p id="fb78" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">有几种不同的方法来创建和管理我们的cron作业。</p><h2 id="cecc" class="nm lf jj bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">控制面板</h2><p id="da4d" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">许多虚拟主机公司为他们的客户提供控制面板。如果我们是其中之一，我们可能能够在控制面板中找到一个部分来管理我们的cron作业。</p><figure class="ni nj nk nl gt iv gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/76a6499bc146e8424c0a7dc186369880.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/0*CQ4QvllKeMQp2I7c.png"/></div></figure><h2 id="7d7f" class="nm lf jj bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">编辑Crontab</h2><p id="5583" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">运行该命令将启动vi(文本编辑器),并让我们编辑crontab的内容:</p><p id="df50" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">crontab -e</code></p><figure class="ni nj nk nl gt iv gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/25f2e0d33baaf477ecba4e334901a2d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/0*9JFlUXdhOzu34UL9.png"/></div></figure><p id="6343" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，熟悉<a class="ae jg" href="http://www.cbu.edu/ietc/faq/vifaq.html" rel="noopener ugc nofollow" target="_blank">基本vi命令</a>会很有帮助，因为它与你可能用过的任何其他文本编辑器都很不同。</p><p id="55fc" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们只想查看现有的crontab而不编辑它，我们可以运行以下命令:</p><p id="ab7f" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">crontab -l</code></p><figure class="ni nj nk nl gt iv gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/f6a7ff5a2b94bc796b58e88ec0792a39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*2V-4l1MyYmr5AATK9iB0IA.png"/></div></figure><p id="8eff" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要删除crontab的内容:</p><p id="1b3c" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">crontab -r</code></p><figure class="ni nj nk nl gt iv gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/becafe0ee74c2404f1fc102871b3b934.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/format:webp/1*OuRMS5HqJJYYBPQlsOVqjg.png"/></div></figure><h2 id="b894" class="nm lf jj bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">加载文件</h2><p id="ff31" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们可以将您的所有cron作业写入一个文件，然后将其推送到crontab:</p><p id="d137" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">crontab cron.txt</code></p><p id="0ea7" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请小心，因为这将使用该文件的内容覆盖所有现有的cron作业，并且不会发出警告。</p><h2 id="f4c0" class="nm lf jj bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">评论</h2><p id="ee42" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们可以添加注释，后跟#字符。</p><p id="5387" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b"># This cron job does something very important</code></p><p id="71f9" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">10 * * * * /usr/bin/php /www/virtual/username/cron.php &gt; /dev/null 2&gt;&amp;1</code></p><h2 id="2630" class="nm lf jj bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">设置电子邮件</h2><p id="7bbd" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">正如我前面提到的，缺省情况下，crons的输出通过电子邮件发送，除非我们丢弃它们或将它们重定向到一个文件。MAILTO设置允许我们设置或更改将邮件发送到哪个电子邮件地址:</p><p id="ee3f" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">MAILTO="username@example.com"</code></p><p id="fe7a" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b"># This cron job does something very important</code></p><p id="f080" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">10 * * * * /usr/bin/php /www/virtual/username/cron.php &gt; /dev/null 2&gt;&amp;1</code></p><h1 id="f102" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用PHP解析器</h1><p id="d9f2" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">默认情况下，CGI脚本是可执行的，但PHP脚本不是。它们需要运行PHP解析器。这就是为什么我们需要把解析器的路径放在脚本的路径之前。</p><p id="c69d" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">* * * * * /usr/bin/php [path to php script]</code></p><p id="edf7" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有时它可能在另一个位置下，比如“/usr/local/bin/php”。为了找到答案，我们可以尝试在命令行中运行:</p><p id="2b34" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">which php</code></p><figure class="ni nj nk nl gt iv gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/3d26db0137a7b0f588df44475b3e45eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:532/format:webp/1*5tdENDOx_s4Hzfyp-q_uiw.png"/></div></figure><h1 id="4d55" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">处理输出</h1><p id="6d1b" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果我们不处理cron脚本的输出，它会将它们作为电子邮件发送到我们在服务器上的用户帐户。</p><h2 id="9b79" class="nm lf jj bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">丢弃输出</h2><p id="e484" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果我们将“&gt;/dev/null 2&gt;&amp;1”放在cron作业命令(或任何命令)的末尾，输出将被丢弃。</p><figure class="ni nj nk nl gt iv gh gi paragraph-image"><div class="gh gi od"><img src="../Images/edaba655c590deb7b35bf0a00eb14b6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*eUSUMvQL_s-RUOGCaL2NLw.png"/></div></figure><p id="52b4" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">右括号(&gt;)用于重定向输出。“/dev/null”就像一个输出黑洞。任何去那里的东西，都会被系统忽略。</p><p id="58d8" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这部分" 2&gt;&amp;1 "导致STDERR(错误)输出被重定向到STDOUT(正常)输出。因此，它也以“/dev/null”结束。</p><h2 id="c083" class="nm lf jj bd lg nn no dn lk np nq dp lo kr nr ns ls kv nt nu lw kz nv nw ma nx bi translated">输出到文件</h2><p id="9399" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">要将cron输出存储在文件中，请再次使用右括号(&gt;):</p><p id="2991" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">10 * * * * /usr/bin/php /www/virtual/username/cron.php &gt; /var/log/cron.log</code></p><p id="1a56" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每次都会重写输出文件。如果我们想将输出附加到文件的末尾，而不是完全重写，请使用双引号(&gt;&gt;)来代替:</p><p id="902a" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">10 * * * * /usr/bin/php /www/virtual/username/cron.php &gt;&gt; /var/log/cron.log</code></p><h1 id="643f" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">可执行脚本</h1><p id="e098" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">通常我们需要在命令的开头指定解析器，就像我们一直做的那样。但是实际上有一种方法可以让你的PHP脚本像CGI脚本一样从命令行执行。</p><p id="78af" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要将路径添加到解析器，作为脚本的第一行:</p><pre class="ni nj nk nl gt oe nf of og aw oh bi"><span id="76ff" class="nm lf jj nf b gy oi oj l ok ol">#!/usr/local/bin/php</span><span id="b333" class="nm lf jj nf b gy om oj l ok ol">&lt;?php</span><span id="087f" class="nm lf jj nf b gy om oj l ok ol">echo<!-- --> <!-- -->"hello world\n";</span><span id="167e" class="nm lf jj nf b gy om oj l ok ol">// ...</span><span id="2997" class="nm lf jj nf b gy om oj l ok ol">?&gt;</span></pre><p id="b30a" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，确保设置正确的chmod(如755)使文件可执行。</p><figure class="ni nj nk nl gt iv gh gi paragraph-image"><div class="gh gi on"><img src="../Images/f1208ff14162f730230f682083cab566.png" data-original-src="https://miro.medium.com/v2/resize:fit:828/format:webp/1*r2cZuiS2JGda9CRr-g5KvQ.png"/></div></figure><p id="bfc8" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我们有一个可执行脚本时，cron作业可以更短，如下所示:</p><p id="18e3" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">10 * * * * /www/virtual/username/hello.php</code></p><h1 id="f56c" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">防止Cron作业冲突</h1><p id="5906" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在某些情况下，我们可能经常运行cron作业，如果它们运行的时间比频率本身长，我们不希望它们发生冲突。</p><p id="62ba" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我们可能每分钟都有一个cron作业在运行。然而，有时运行时间可能会超过一分钟。这会导致同一cron脚本的另一个实例在前一个实例完成之前开始运行。这样我们可能会创建太多繁忙的进程，如果它们不断地互相降低速度，可能会使服务器崩溃，并随着时间的推移导致更多的进程被创建。</p><p id="a590" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个问题可以通过文件锁定解决，更具体地说，可以通过非阻塞(LOCK_NB)类型的文件锁定解决。(如果你不熟悉文件锁定，我建议你<a class="ae jg" href="https://php.net/manual/en/function.flock.php" rel="noopener ugc nofollow" target="_blank">先阅读一下</a>。)</p><p id="89b6" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以将这段代码添加到cron作业脚本中:</p><pre class="ni nj nk nl gt oe nf of og aw oh bi"><span id="219c" class="nm lf jj nf b gy oi oj l ok ol">$fp<!-- --> <!-- -->= fopen('/tmp/lock.txt', 'r+');</span><span id="86fb" class="nm lf jj nf b gy om oj l ok ol"><strong class="nf jk">if</strong>(!flock($fp, LOCK_EX | LOCK_NB)) {</span><span id="50ff" class="nm lf jj nf b gy om oj l ok ol">echo<!-- --> <!-- -->'Unable to obtain lock';</span><span id="4e75" class="nm lf jj nf b gy om oj l ok ol">exit(-1);</span><span id="df3c" class="nm lf jj nf b gy om oj l ok ol">}</span><span id="335e" class="nm lf jj nf b gy om oj l ok ol">/* ... */</span><span id="68c1" class="nm lf jj nf b gy om oj l ok ol">fclose($fp);</span></pre><p id="6c85" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于常规文件锁定，如果存在锁定，flock()函数调用将阻塞脚本。一旦锁被打开，它就会释放。但是，对于非阻塞锁，比如上面的代码，函数调用不会停止脚本，但是如果存在锁，它会立即返回FALSE。因此，在这种情况下，当我们看到存在一个锁时，我们可以立即退出脚本，这表明另一个cron作业当前正在运行。</p><h1 id="6188" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">阻止对Cron作业的Web访问</h1><p id="999c" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">当您用web脚本语言(如PHP)编写cron作业时，您可能希望确保没有人能够通过从浏览器加载它来执行它。一个简单的选择是将这些脚本存储在web文件夹之外。然而，对于一些开发人员来说，如果他们想将cron作业脚本保存在web应用程序文件夹中，这可能是不切实际或不可取的。</p><p id="57eb" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您将所有cron作业脚本放在一个文件夹中，您可以通过在. htaccess文件中放置以下行来阻止访问:</p><p id="128b" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b">deny from all</code></p><p id="f317" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者，您也可以通过在开头添加以下代码行来拒绝对脚本的访问:</p><p id="54d8" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nc nd ne nf b"><strong class="ki jk">if</strong></code>T3】</p><p id="ae64" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将确保当从web访问脚本时，它会立即中止。</p><h1 id="7420" class="le lf jj bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="2d7b" class="pw-post-body-paragraph kg kh jj ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">感谢您的阅读。尽管cron作业看起来只是系统管理员的工具，但它们实际上与许多类型的web应用程序相关。</p></div></div>    
</body>
</html>