<html>
<head>
<title>Dockerizing a React Application using NGINX and React-Router</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用NGINX和React-Router对接React应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/dockerizing-a-react-application-using-nginx-and-react-router-43154cc8e58c?source=collection_archive---------4-----------------------#2020-04-05">https://levelup.gitconnected.com/dockerizing-a-react-application-using-nginx-and-react-router-43154cc8e58c?source=collection_archive---------4-----------------------#2020-04-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="fbdd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Docker是一个强大的工具，允许开发人员在一致的环境中工作，并使部署过程更加顺畅。随着React用户群的增长，越来越多的应用程序使用Docker部署，最常见的是使用NGINX作为负载平衡器。如果您的应用程序使用非常流行的react: <code class="fe ko kp kq kr b">react-router</code>或<code class="fe ko kp kq kr b">react-router-dom</code>路由包，这种配置可能会导致问题。当部署一个应用程序时，你会发现从根目录进入网站很好，而从任何子路径进入都会导致错误。这是因为NGINX不能告诉您想要将哪些文件提供给该路由。</p><p id="92c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了解决这个问题，我们需要在应用程序的<code class="fe ko kp kq kr b">Dockerfile</code>中使用一个特殊的配置。这将告诉NGINX在哪里寻找服务于任何给定路由的文件。让我们深入了解一下配置。</p></div><div class="ab cl ks kt hx ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="im in io ip iq"><h1 id="2b0c" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">Dockerfile文件</h1><p id="0355" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">docker文件是docker在为您的应用程序构建容器时用作指令的文件。这个文件应该创建在应用程序的根目录下，没有文件扩展名。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/eed6ffcde603ecd795b7f05ae8ccc0ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:746/format:webp/1*nyv9kk9M8QeACN-eD4_aaQ.png"/></div></figure><p id="eb45" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个配置要利用Docker的<a class="ae mk" href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="noopener ugc nofollow" target="_blank">多级建筑</a>。在第一阶段，我们将构建React应用程序，第二步我们将配置NGINX并给它适当的配置。</p><p id="221c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们构建的第一阶段将如下所示:</p><pre class="md me mf mg gt ml kr mm mn aw mo bi"><span id="8476" class="mp la it kr b gy mq mr l ms mt"># Stage 0, "build-stage", based on Node.js to build the frontend<br/>FROM node:alpine as build<br/>WORKDIR /app<br/>COPY package*.json /app/<br/>RUN npm install<br/>COPY ./app/<br/>RUN npm run build</span></pre><p id="6b89" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个阶段将node的最新稳定版本作为初始映像，我们将使用它来构建我们的应用程序。然后，它继续设置一个工作目录，并将我们的文件复制到环境中，然后安装依赖项并创建一个编译后的构建文件夹。我们将在下一个构建阶段配置NGINX时使用它。</p><h1 id="168f" class="kz la it bd lb lc mu le lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw bi translated">NGINX配置</h1><p id="447b" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">现在我们已经有了React应用程序的初始构建，我们可以创建一个配置来告诉NGINX在哪里查找文件。我们需要做的第一件事是在应用程序的根目录下创建一个新的<code class="fe ko kp kq kr b">nginx</code>目录来保存我们的NGINX配置(以及以后可能需要的任何其他NGINX相关文件)。在这个文件夹中，我们将创建一个新文件<code class="fe ko kp kq kr b">nginx.conf</code>。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/c247599a6991ec584ccda3ace332e30c.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*V2XSaRKItkbgHQba9qcanQ.png"/></div></figure><p id="36ff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，这是重要的一步，我们告诉NGINX，对于应用程序的任何给定子路径，从哪里提取文件。将以下代码添加到配置文件中:</p><pre class="md me mf mg gt ml kr mm mn aw mo bi"><span id="c5d2" class="mp la it kr b gy mq mr l ms mt">server {<br/>  listen 80;<br/>  location / {<br/>    root   /usr/share/nginx/html;<br/>    index  index.html index.htm;<br/>    try_files $uri $uri/ /index.html;</span><span id="2f9f" class="mp la it kr b gy na mr l ms mt">  }<br/>  error_page 500 502 503 504 /50x.html;<br/>  location = /50x.html {<br/>    root  /usr/share/nginx/html;<br/>  }<br/>}</span></pre><p id="3d73" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个配置的重要一行是<code class="fe ko kp kq kr b">try_files ...</code>,它告诉NGINX查看各种目录，找到要服务的正确文件。</p><h1 id="7e1d" class="kz la it bd lb lc mu le lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw bi translated">回到文档中</h1><p id="6217" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">现在我们有了NGINX的配置，我们可以返回Docker文件，告诉Docker我们想要如何构建NGINX。我们将在第二阶段执行NGINX构建，并引用第一阶段生成的React应用程序的构建文件夹。NGINX构建阶段应该如下所示:</p><pre class="md me mf mg gt ml kr mm mn aw mo bi"><span id="6937" class="mp la it kr b gy mq mr l ms mt"># Stage 1, based on NGINX to provide a configuration to be used with react-router</span><span id="72a1" class="mp la it kr b gy na mr l ms mt">FROM nginx:alpine<br/>COPY --from=build /app/build /usr/share/nginx.html<br/>RUN rm /etc/nginx/conf.d/default.conf<br/>COPY nginx/nginx.conf /etc/nginx/conf.d<br/>EXPOSE 80<br/>CMD ["nginx", "-g", "daemon off;"]</span></pre><p id="344e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这为我们提供了一个新的NGINX映像，然后我们删除默认配置，用我们刚刚创建的配置替换它。</p><h1 id="eee1" class="kz la it bd lb lc mu le lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw bi translated">建造它</h1><p id="c35f" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">现在，我们可以尝试构建我们的应用程序，并在本地进行测试。要建立Docker形象，请使用:</p><pre class="md me mf mg gt ml kr mm mn aw mo bi"><span id="9688" class="mp la it kr b gy mq mr l ms mt">docker build --tag example-name .</span></pre><p id="8aea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您将看到Docker运行您的Docker文件中定义的两个阶段。完成后，您可以使用以下命令运行容器:</p><pre class="md me mf mg gt ml kr mm mn aw mo bi"><span id="d690" class="mp la it kr b gy mq mr l ms mt">docker run --publish 80:80 example-name</span></pre><p id="2c83" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里，您应该能够通过导航到<a class="ae mk" href="http://localhost" rel="noopener ugc nofollow" target="_blank"> http://localhost </a>来查看React应用程序。</p><p id="2019" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您的React应用程序现在配置为在一个稳定的Docker容器中运行，带有NGINX和react-router！</p></div></div>    
</body>
</html>