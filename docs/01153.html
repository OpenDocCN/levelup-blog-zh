<html>
<head>
<title>Utilizing the Power of Interfaces when Mocking and Testing External APIs in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Golang中模拟和测试外部API时利用接口的力量</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/utilizing-the-power-of-interfaces-when-mocking-and-testing-external-apis-in-golang-1178b0db5a32?source=collection_archive---------0-----------------------#2019-11-19">https://levelup.gitconnected.com/utilizing-the-power-of-interfaces-when-mocking-and-testing-external-apis-in-golang-1178b0db5a32?source=collection_archive---------0-----------------------#2019-11-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b36f6d394ee86ad728a921320d3728b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_pE4nka1sxs0gMpybN3o5Q.jpeg"/></div></div></figure><p id="c8fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在测试文件中调用实际的外部API端点并不是好的做法，尤其是在单元测试中。</p><p id="45bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是一些原因:</p><ul class=""><li id="2dd1" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">API服务器可能已关闭。</li><li id="3338" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">API可以有一个速率限制(您可能需要在测试中多次达到这个限制)</li></ul><p id="2cd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">测试时，我们最好模仿外部API。</p><p id="3c04" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将构建一个调用<a class="ae lk" href="https://darksky.net/dev" rel="noopener ugc nofollow" target="_blank"> darksky </a> api的<strong class="ka ir">微服务</strong>。</p><p id="48ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae lk" href="https://darksky.net/dev" rel="noopener ugc nofollow" target="_blank"> Darksky </a>是一个天气API。我们将需要输入经度和纬度的位置，以获得基于上述参数的天气细节。</p><p id="e099" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以注册<a class="ae lk" href="https://darksky.net/dev" rel="noopener ugc nofollow" target="_blank"> Darksky </a> API来获得一个免费的API密匙，你可以用它来获取天气数据。</p><h1 id="80ee" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">我们开始吧</h1><p id="cf71" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">这是我们希望在本文中实现的一个想法:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mo"><img src="../Images/328e0fef080679cb3a14b45b961eaad4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9OyBDm3X50OrVBXTZVXKpw.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">图片来自费德里科的课程</figcaption></figure><h2 id="f6e2" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">步骤1:基本设置</h2><p id="529e" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated"><strong class="ka ir"> a .创建根目录:</strong>在您的终端中，创建一个名为<code class="fe nj nk nl nm b">interface-testing</code>的目录</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="63d6" class="mx lm iq nm b gy nr ns l nt nu">mkdir interface-testing</span></pre><p id="596f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">初始化go模块:对于依赖关系管理，我们需要一个文件来保存我们将使用的所有依赖关系。</p><p id="57b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们的<code class="fe nj nk nl nm b">interface-testing</code>目录中，初始化<strong class="ka ir"> go模块:</strong></p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="bc1b" class="mx lm iq nm b gy nr ns l nt nu">go mod init interface-testing</span></pre><p id="dba2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将模型名作为我们的根目录名。你可以随便叫它什么。</p><p id="2bca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在项目根目录下创建<code class="fe nj nk nl nm b">api</code>目录:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="6aad" class="mx lm iq nm b gy nr ns l nt nu">mkdir api</span></pre><p id="8925" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另外，在根项目目录中创建<code class="fe nj nk nl nm b">main.go</code>文件:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="e1db" class="mx lm iq nm b gy nr ns l nt nu">touch main.go</span></pre><p id="552e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的初始设置应该如下所示:</p><p id="5ca8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接口测试├──API├──main . go└──go . mod</p><h2 id="5196" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">第二步:客户</h2><p id="f94e" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们需要一个能够让我们与API对话的客户端。我们将定义一个对API执行<strong class="ka ir"> GET请求</strong>的函数。</p><p id="c499" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nj nk nl nm b"><strong class="ka ir">api</strong></code> <strong class="ka ir">目录</strong>内，创建<code class="fe nj nk nl nm b">clients</code>目录:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="a40d" class="mx lm iq nm b gy nr ns l nt nu">cd api &amp;&amp; mkdir clients</span></pre><p id="cc8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后在<code class="fe nj nk nl nm b"><strong class="ka ir">clients</strong></code>目录中创建<code class="fe nj nk nl nm b"><strong class="ka ir">restclient</strong></code>目录:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="c1b9" class="mx lm iq nm b gy nr ns l nt nu">cd clients &amp;&amp; mkdir restclient</span></pre><p id="5540" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nj nk nl nm b"><strong class="ka ir">restclient</strong></code>目录下创建<code class="fe nj nk nl nm b"><strong class="ka ir">restclient.go</strong></code>文件:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="4c24" class="mx lm iq nm b gy nr ns l nt nu">cd restclient &amp;&amp; touch restclient.go</span></pre><p id="c445" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">文件的内容:</p><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="38dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从上面的文件中可以看出，“clientStruct”正在实现ClientInterface。因此，接口中定义的任何方法，结构也必须定义该方法。接口在测试中简直牛逼；因为它们帮助我们创造假方法。</p><h2 id="acf5" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">步骤3:域</h2><p id="1d44" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">此应用程序的范围不需要数据库。但是我们需要定义一个模式，类似于我们将要发送和接收的API请求和响应数据。</p><p id="66e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nj nk nl nm b"><strong class="ka ir">api</strong></code> <strong class="ka ir">目录下，</strong>创建<code class="fe nj nk nl nm b"><strong class="ka ir">domain</strong></code> <strong class="ka ir"> </strong>目录:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="690b" class="mx lm iq nm b gy nr ns l nt nu">mkdir domain</span></pre><p id="c64b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为我们正在构建天气API，所以我们将创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_domain</strong></code>目录:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="db8a" class="mx lm iq nm b gy nr ns l nt nu">cd domain &amp;&amp; mkdir weather_domain</span></pre><p id="ac91" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> a .天气模式</strong></p><p id="5d18" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要获取某个地方的天气信息，我们需要提供:</p><ul class=""><li id="341b" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">Darksky认证密钥</li><li id="ab93" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">这个地方的纬度</li><li id="8aff" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">这个地方的经度</li></ul><p id="6e4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将在GET请求中提供这些细节，我们将收到来自API的带有天气结果的响应。</p><p id="e8d1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nj nk nl nm b"><strong class="ka ir">weather_domain</strong></code>目录下，创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_domain.go</strong></code>文件。</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="d27e" class="mx lm iq nm b gy nr ns l nt nu">cd weather_domain &amp;&amp; touch weather_domain.go</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="2957" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> b .错误模式</strong></p><p id="4938" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当输入错误的细节时，API会抛出一个错误。我们将定义一个错误接口，并连接一些我们将在整个应用程序中使用的方法。</p><p id="58d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nj nk nl nm b"><strong class="ka ir">weather_domain</strong></code>目录下，创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_error.go</strong></code> <strong class="ka ir">文件</strong></p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="5a1a" class="mx lm iq nm b gy nr ns l nt nu">touch weather_error.go</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="9482" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> c .测试模式</strong></p><p id="da20" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以测试上面定义的模式。仍然，在<code class="fe nj nk nl nm b"><strong class="ka ir">weather_domain</strong></code>目录中，创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_domain_test.go</strong></code>文件。</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="5ee6" class="mx lm iq nm b gy nr ns l nt nu">touch weather_domain_test.go</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="8181" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以使用以下方式运行测试:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="69cd" class="mx lm iq nm b gy nr ns l nt nu">go test -v</span></pre><p id="d9fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nj nk nl nm b"><strong class="ka ir">v</strong></code> <strong class="ka ir">标志</strong>为<strong class="ka ir"> </strong>用于详细输出。</p><p id="d8f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以使用以下工具运行特定测试:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="a779" class="mx lm iq nm b gy nr ns l nt nu">go test -v --run TestWeather</span></pre><h2 id="4bc5" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">第四步:供应商</h2><p id="a569" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在<strong class="ka ir">客户端</strong>中定义的<strong class="ka ir"> Get </strong>函数，需要在提供者中调用。</p><p id="9b3c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从<strong class="ka ir"> API </strong>目录中，创建<code class="fe nj nk nl nm b"><strong class="ka ir">providers</strong></code>目录</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="5878" class="mx lm iq nm b gy nr ns l nt nu">mkdir providers</span></pre><p id="a2bc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，在<code class="fe nj nk nl nm b"><strong class="ka ir">providers</strong></code>目录中创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_providers</strong></code>目录。</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="4acd" class="mx lm iq nm b gy nr ns l nt nu">cd providers &amp;&amp; mkdir weather_providers</span></pre><p id="c22a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> a .天气提供者文件:</strong></p><p id="81c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nj nk nl nm b"><strong class="ka ir">weather_provider</strong></code>目录中，创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_provider.go</strong></code>文件</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="741a" class="mx lm iq nm b gy nr ns l nt nu">touch weather_provider.go</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="f70a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意来自rest客户端的<strong class="ka ir"> Get </strong>函数被调用。</p><p id="58ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> b .气象提供商测试案例</strong></p><p id="f62a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将测试当我们从restclient调用<strong class="ka ir"> Get </strong>函数时会发生什么，包括好的和坏的数据。</p><p id="c1e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nj nk nl nm b"><strong class="ka ir">weather_provider</strong></code>目录下，创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_provider_test.go</strong></code>文件。</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="890b" class="mx lm iq nm b gy nr ns l nt nu">touch weather_provider_test.go</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="51af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从上面的测试文件中，您可以看到使用接口是如何避免我们碰到实际的<strong class="ka ir"> API的。</strong>我们模拟请求和响应。这些测试的好处是，你可以在每个测试中访问实际的URL提供者，但是这一次，来自<a class="ae lk" href="https://darksky.net/dev" rel="noopener ugc nofollow" target="_blank"> Darksky </a>的<strong class="ka ir"> real API key </strong>仍然得到与我们在模拟中提供的响应相同的结果。在上面的文件中为需要它们的测试用例提供了解释。</p><h2 id="46b1" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">第五步:服务</h2><p id="14c2" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">让我们连接我们的服务。我们将定义<code class="fe nj nk nl nm b"><strong class="ka ir">GetWeather</strong></code> <strong class="ka ir">方法</strong>，该方法将调用我们在提供者中定义的<code class="fe nj nk nl nm b"><strong class="ka ir">GetWeather</strong></code> <strong class="ka ir">函数</strong>。</p><p id="7178" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从<strong class="ka ir"> API </strong>目录中，创建<code class="fe nj nk nl nm b"><strong class="ka ir">services</strong></code> <strong class="ka ir">目录</strong></p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="ccb8" class="mx lm iq nm b gy nr ns l nt nu">mkdir services</span></pre><p id="bc01" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> a .气象服务文件:</strong></p><p id="fd07" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后在<code class="fe nj nk nl nm b"><strong class="ka ir">services</strong></code>目录下创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_service.go</strong></code>文件:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="4b37" class="mx lm iq nm b gy nr ns l nt nu">cd services &amp;&amp; touch weather_service.go</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="f194" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可能需要注意上面的文件，因为我们定义了一个接口，我们将使用该接口在测试时创建一个假的<code class="fe nj nk nl nm b"><strong class="ka ir">GetWeather</strong></code> <strong class="ka ir">方法</strong>。</p><p id="000b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们让<code class="fe nj nk nl nm b"><strong class="ka ir">weatherService</strong></code> <strong class="ka ir"> </strong>结构<strong class="ka ir"> </strong>实现了<code class="fe nj nk nl nm b"><strong class="ka ir">weatherServiceInterface</strong></code>。<strong class="ka ir"> </strong>在<strong class="ka ir"> </strong>我们的测试中，我们将定义一个实现相同接口的伪结构。因此，该结构必须具有实现该接口的方法。例如<code class="fe nj nk nl nm b"><strong class="ka ir">GetWeather</strong></code>中的<strong class="ka ir">法。这在测试我们的控制器文件时会很有用。</strong></p><p id="51c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> b .气象服务测试文件</strong></p><p id="e01e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将需要测试<code class="fe nj nk nl nm b">GetWeather</code>方法。在<code class="fe nj nk nl nm b"><strong class="ka ir">services</strong></code> <strong class="ka ir"> </strong>目录下，创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_service_test.go</strong></code>文件。我们还将在测试中使用模拟数据。</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="a811" class="mx lm iq nm b gy nr ns l nt nu">touch weather_service_test.go</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="a87b" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">第七步:控制器</h2><p id="bbb9" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">创建天气控制器，它将调用我们在服务中定义的<code class="fe nj nk nl nm b"><strong class="ka ir">GetWeather</strong></code>方法。</p><p id="a275" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从<code class="fe nj nk nl nm b"><strong class="ka ir">api</strong></code>目录中，创建<code class="fe nj nk nl nm b"><strong class="ka ir">controllers</strong></code>目录</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="7eab" class="mx lm iq nm b gy nr ns l nt nu">mkdir controllers</span></pre><p id="9ebb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nj nk nl nm b"><strong class="ka ir">controllers</strong></code>目录中，创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_controller</strong></code>目录。</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="6600" class="mx lm iq nm b gy nr ns l nt nu">cd controllers &amp;&amp; mkdir weather_controller </span></pre><p id="a1b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> a .天气控制器文件</strong></p><p id="9bba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_controller.go</strong></code>文件。</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="a5e0" class="mx lm iq nm b gy nr ns l nt nu">touch weather_controller.go</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="12cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">记住，我们是从URL中获取<strong class="ka ir"> api键</strong>、<strong class="ka ir">纬度、</strong>和<strong class="ka ir">经度</strong>。我们使用<a class="ae lk" href="https://github.com/gin-gonic/gin" rel="noopener ugc nofollow" target="_blank"> gin </a>来路由和处理JSON响应。</p><p id="0149" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> b .天气控制器测试文件</strong></p><p id="6a4c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">还记得我们如何在服务中使用接口吗？我们这样做是为了模仿服务中的<code class="fe nj nk nl nm b">GetWeather</code>方法。在上面的控制器中，我们调用了那个方法。但是我们不应该在控制器测试中调用真正的方法。因此，我们将定义一个实现<code class="fe nj nk nl nm b"><strong class="ka ir">WeatherErrorInterface</strong></code> <strong class="ka ir">的结构。</strong>当我们这样做时，我们必须定义GetWeather方法(这次是假的)。请参见下面的测试文件。</p><p id="aada" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nj nk nl nm b"><strong class="ka ir">weather_controller</strong></code>目录下，创建<code class="fe nj nk nl nm b"><strong class="ka ir">weather_controller_test.go</strong></code> <strong class="ka ir"> </strong>文件:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="b7a6" class="mx lm iq nm b gy nr ns l nt nu">touch weather_controller_test.go</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="b2bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于上述所有测试，没有一个真正触及真正的API。这就是测试外部API的方式。</p><h2 id="8a1b" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">步骤8:运行应用程序</h2><p id="b7e9" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们已经准备好运行这个应用程序了。</p><p id="2416" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从<code class="fe nj nk nl nm b"><strong class="ka ir">api</strong></code>目录中，创建<code class="fe nj nk nl nm b"><strong class="ka ir">app</strong></code> <strong class="ka ir">目录。</strong></p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="07c7" class="mx lm iq nm b gy nr ns l nt nu">mkdir app</span></pre><p id="6c36" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> a .路由</strong></p><p id="6265" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nj nk nl nm b"><strong class="ka ir">app</strong></code>目录下创建<code class="fe nj nk nl nm b"><strong class="ka ir">routes.go</strong></code> <strong class="ka ir">文件</strong>:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="af1d" class="mx lm iq nm b gy nr ns l nt nu">cd app &amp;&amp; touch routes.go</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="1e25" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">b .申请文件</p><p id="abb6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">仍然在app目录中，创建<code class="fe nj nk nl nm b"><strong class="ka ir">app.go</strong></code>文件。该文件将调用路由:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="b709" class="mx lm iq nm b gy nr ns l nt nu">touch app.go</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="fe0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> c. main.go </strong></p><p id="b5a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">记住，前面我们在项目根目录中创建了<code class="fe nj nk nl nm b">main.go</code>文件。我们需要调用<code class="fe nj nk nl nm b">app.go</code>文件中定义的<code class="fe nj nk nl nm b">RunApp</code>函数。</p><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="c1fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的目录结构应该如下所示:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/822e22610b4389f8e131ec18a2c79f30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1I4PyTb6wdV7VBadbsqg-Q.png"/></div></div></figure><p id="6159" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时运行是安全的:</p><pre class="mp mq mr ms gt nn nm no np aw nq bi"><span id="280e" class="mx lm iq nm b gy nr ns l nt nu">go run main.go</span></pre><p id="ec53" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的应用程序应该在端口8080上运行。</p><p id="4192" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用curl、postman或导航到您的浏览器并输入测试细节(您的API密钥、纬度和经度)。根据提供的数据，你应该得到天气的反应。</p><p id="7231" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以再次运行您的测试套件。如果你使用的是<a class="ae lk" href="https://www.jetbrains.com/go/" rel="noopener ugc nofollow" target="_blank"> GoLand </a>编辑器，右击<code class="fe nj nk nl nm b">api</code>目录，你可以选择运行<code class="fe nj nk nl nm b">api</code>目录下的测试。当您这样做时，您将会观察到所有的<strong class="ka ir">提供者</strong>、<strong class="ka ir">服务、</strong>和<strong class="ka ir">控制器</strong>包都有100%的覆盖率。</p><p id="5ff3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">获取</strong><a class="ae lk" href="https://github.com/victorsteven/Go-Interfaces-and-API-Testing" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">github</strong></a><strong class="ka ir">上的代码。</strong></p><p id="531a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">干杯。</p></div></div>    
</body>
</html>