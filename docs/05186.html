<html>
<head>
<title>Exploiting Schema Inference in Apache Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">åˆ©ç”¨Apache Sparkä¸­çš„æ¨¡å¼æ¨ç†</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://levelup.gitconnected.com/exploiting-schema-inference-in-apache-spark-c10f7fe5fa9f?source=collection_archive---------10-----------------------#2020-08-10">https://levelup.gitconnected.com/exploiting-schema-inference-in-apache-spark-c10f7fe5fa9f?source=collection_archive---------10-----------------------#2020-08-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/aef41b1ee28d939ecfc3e7be7e6157f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hznYsSo_EtfqWNJu.jpg"/></div></div></figure><p id="e304" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Apache Sparkæœ€å¤§çš„ç‰¹æ€§ä¹‹ä¸€æ˜¯èƒ½å¤ŸåŠ¨æ€æ¨æ–­æ¨¡å¼ã€‚è¯»å–æ•°æ®å¹¶ç”Ÿæˆæ¨¡å¼è™½ç„¶å¾ˆå®¹æ˜“ä½¿ç”¨ï¼Œä½†ä¼šä½¿æ•°æ®è¯»å–é€Ÿåº¦å˜æ…¢ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ä¸ªæŠ€å·§å¯ä»¥ä¸€æ¬¡æ€§ç”Ÿæˆæ¨¡å¼ï¼Œç„¶åä»ç£ç›˜åŠ è½½å®ƒã€‚è®©æˆ‘ä»¬å¼€å§‹å§ï¼</p><p id="3c67" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">å°±æœ¬æ–‡è€Œè¨€ï¼Œè®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨å…·æœ‰å¤æ‚æ•°æ®ç»“æ„çš„æ•°æ®ï¼Œå…¶ä¸­åˆ›å»ºä»»ä½•ç§ç±»çš„caseç±»æˆ–structç±»å‹éƒ½å°†æœ‰ä¸€ç™¾è¡Œé•¿ã€‚</p><h1 id="4e84" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">ä¿å­˜æ¨¡å¼</h1><p id="599b" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">è®©æˆ‘ä»¬ä»è¯»å–ä¸€äº›æ ·æœ¬æ•°æ®å¹¶å¯¹å…¶å®æ–½æ¨¡å¼æ¨ç†å¼€å§‹ã€‚ä½¿ç”¨Apache Sparkå’ŒScalaè¯­è¨€ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·å®Œæˆ:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="317f" class="ml la it mh b gy mm mn l mo mp">val carsDf = spark.read<br/>    .option("inferSchema", "true")<br/>    .json("src/main/resources/data/cars.json")</span></pre><p id="d939" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æˆ‘å°†ä¸€ä¸ªæ ·æœ¬JSONæ–‡ä»¶(<code class="fe mq mr ms mh b">cars.json</code>)è¯»å…¥ä¸€ä¸ªåä¸º<code class="fe mq mr ms mh b">carsDf</code>çš„æ•°æ®å¸§ã€‚è¯¥æ•°æ®é›†çš„ç¤ºä¾‹è®°å½•å¦‚ä¸‹æ‰€ç¤º:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="0d72" class="ml la it mh b gy mm mn l mo mp">{<br/>   "Name":"chevrolet chevelle malibu",<br/>   "Miles_per_Gallon":18,<br/>   "Cylinders":8,<br/>   "Displacement":307,<br/>   "Horsepower":130,<br/>   "Weight_in_lbs":3504,<br/>   "Acceleration":12,<br/>   "Year":"1970-01-01",<br/>   "Origin":"USA"<br/>}</span></pre><p id="aa91" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šé¢çœ‹åˆ°çš„ï¼Œè¿™ä¸ªæ¨¡å¼éå¸¸å®¹æ˜“ç†è§£ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹Sparkä»ä¸­æ¨æ–­å‡ºäº†ä»€ä¹ˆ:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="7141" class="ml la it mh b gy mm mn l mo mp">val schemaJson = carsDf.schema.json<br/>println(schemaJson)</span></pre><p id="ad62" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æ­¤æ“ä½œçš„è¾“å‡ºå¯èƒ½æ˜¯è¿™æ ·çš„:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="824f" class="ml la it mh b gy mm mn l mo mp">{<br/>   "type":"struct",<br/>   "fields":[<br/>      {<br/>         "name":"Acceleration",<br/>         "type":"double",<br/>         "nullable":true,<br/>         "metadata":{</span><span id="e779" class="ml la it mh b gy mt mn l mo mp">         }<br/>      },<br/>      {<br/>         "name":"Cylinders",<br/>         "type":"long",<br/>         "nullable":true,<br/>         "metadata":{</span><span id="76ff" class="ml la it mh b gy mt mn l mo mp">         }<br/>      },<br/>      {<br/>         "name":"Displacement",<br/>         "type":"double",<br/>         "nullable":true,<br/>         "metadata":{</span><span id="8c40" class="ml la it mh b gy mt mn l mo mp">         }<br/>      },<br/>      {<br/>         "name":"Horsepower",<br/>         "type":"long",<br/>         "nullable":true,<br/>         "metadata":{</span><span id="5415" class="ml la it mh b gy mt mn l mo mp">         }<br/>      },<br/>      {<br/>         "name":"Miles_per_Gallon",<br/>         "type":"double",<br/>         "nullable":true,<br/>         "metadata":{</span><span id="f22a" class="ml la it mh b gy mt mn l mo mp">         }<br/>      },<br/>      {<br/>         "name":"Name",<br/>         "type":"string",<br/>         "nullable":true,<br/>         "metadata":{</span><span id="653a" class="ml la it mh b gy mt mn l mo mp">         }<br/>      },<br/>      {<br/>         "name":"Origin",<br/>         "type":"string",<br/>         "nullable":true,<br/>         "metadata":{</span><span id="45e8" class="ml la it mh b gy mt mn l mo mp">         }<br/>      },<br/>      {<br/>         "name":"Weight_in_lbs",<br/>         "type":"long",<br/>         "nullable":true,<br/>         "metadata":{</span><span id="bef9" class="ml la it mh b gy mt mn l mo mp">         }<br/>      },<br/>      {<br/>         "name":"Year",<br/>         "type":"string",<br/>         "nullable":true,<br/>         "metadata":{</span><span id="c057" class="ml la it mh b gy mt mn l mo mp">         }<br/>      }<br/>   ]<br/>}</span></pre><p id="cb44" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">è¿™å°±æ˜¯Sparkå¦‚ä½•å®šä¹‰å®ƒè®¾æ³•æ¨æ–­çš„æ¨¡å¼ã€‚ç°åœ¨ï¼Œæ¯æ¬¡æˆ‘ä»¬å¯åŠ¨Sparkä½œä¸šæ—¶ï¼Œéƒ½å¿…é¡»é‡æ–°åˆ›å»ºè¿™äº›ä¿¡æ¯ã€‚å½“è¿›è¡Œå¼€å‘æ—¶ï¼Œä¼šæœ‰å¾ˆå¤šè¿™æ ·çš„äº‹æƒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ¨¡å¼çš„é‡å»ºä¸Šæµªè´¹äº†å¾ˆå¤šæ—¶é—´ã€‚è®©æˆ‘ä»¬å°è¯•ç”Ÿæˆä¸€æ¬¡ï¼Œå¹¶åœ¨è¿ç»­è¯»å–ä¸­é‡ç”¨å®ƒã€‚</p><p id="8435" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">åœ¨æˆ‘ä½¿ç”¨çš„Scalaä¸­ï¼Œæ¨¡å¼çš„JSONæ–‡ä»¶å¯ä»¥ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œä»£ç å¦‚ä¸‹:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="8bb2" class="ml la it mh b gy mm mn l mo mp">val file = new File("src/resources/schema.json")<br/>val bw = new BufferedWriter(new FileWriter(file))<br/>bw.write(schemaJson)<br/>bw.close()</span></pre><p id="56bd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">è¿™æ ·ï¼Œæˆ‘ä»¬æ¨æ–­å‡ºçš„æ¨¡å¼å°†ä½œä¸ºåä¸º<code class="fe mq mr ms mh b">schema.json</code>çš„JSONæ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•é˜…è¯»å®ƒï¼Œå¹¶ç”¨å®ƒæ¥åŠ é€Ÿç«èŠ±ã€‚</p><h1 id="976f" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">åŠ è½½æ¨¡å¼</h1><p id="085c" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨Sparkå’ŒScalaç¯å¢ƒè¯»å–JSONæ–‡ä»¶ã€‚è¿™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç æ¥å®Œæˆ:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="bed1" class="ml la it mh b gy mm mn l mo mp">import org.apache.spark.sql.types.{DataType, StructType}</span><span id="86a4" class="ml la it mh b gy mt mn l mo mp">val schemaJson = Source<br/>    .fromFile("src/resources/schema.json")<br/>    .getLines<br/>    .mkString</span><span id="294c" class="ml la it mh b gy mt mn l mo mp">val schemaStructType = Try(DataType.fromJson(schemaJson))<br/>        .getOrElse(LegacyTypeStringParser.parse(schemaJson)) <br/>    match {<br/>      case t: StructType =&gt; t<br/>      case _ =&gt; throw new RuntimeException(s"Failed parsing JSON Schema")<br/>    }</span></pre><p id="ea16" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">ç”±äºSpark SQLåŒ…ï¼Œä¸Šé¢çš„ä»£ç éƒ¨åˆ†ä»JSONæ–‡ä»¶ä¸­è¯»å–æ¨¡å¼ï¼Œå¹¶å°†å…¶è§£æä¸ºä¸€ä¸ª<code class="fe mq mr ms mh b">StructType</code>å®ä¾‹ã€‚æˆ‘åœ¨è¿™é‡Œä½¿ç”¨äº†æ¨¡å¼åŒ¹é…ï¼Œä»¥é€‚åº”æ‰€ä½¿ç”¨çš„ä¸æ­£ç¡®è·¯å¾„ã€‚</p><p id="1ddc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æœ‰äº†é¢„ç”Ÿæˆçš„æ¨¡å¼ï¼Œåœ¨Sparkä¸­è¯»å–æ•°æ®å°†ä¼šæ›´å¿«ã€‚ä½¿ç”¨æˆ‘ä»¬çš„å¸¦æœ‰<code class="fe mq mr ms mh b">cars.json</code>æ–‡ä»¶çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è¯»å–è¿™ä¸ªæ•°æ®:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="4687" class="ml la it mh b gy mm mn l mo mp">val carsDf = spark.read<br/>    .schema(schemaStructType)<br/>    .json("src/main/resources/data/cars.json")</span></pre><h1 id="6ff0" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">æ‘˜è¦</h1><p id="607b" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰ç”¨ã€‚å¦‚æœæœ‰ï¼Œä¸è¦çŠ¹è±«ï¼Œå–œæ¬¢æˆ–åˆ†äº«è¿™ä¸ªå¸–å­ã€‚æ­¤å¤–ï¼Œå¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥åœ¨æˆ‘çš„ç¤¾äº¤åª’ä½“ä¸Šå…³æ³¨æˆ‘ğŸ™‚</p></div></div>    
</body>
</html>