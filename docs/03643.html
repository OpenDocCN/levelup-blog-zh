<html>
<head>
<title>STDIN: Implementing the JQ equivalent in Deno</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">STDIN:在Deno中实现JQ等价</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/stdin-implementing-the-jq-equivalent-in-deno-77226e44504c?source=collection_archive---------9-----------------------#2020-05-20">https://levelup.gitconnected.com/stdin-implementing-the-jq-equivalent-in-deno-77226e44504c?source=collection_archive---------9-----------------------#2020-05-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="7709" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Deno可能是编程界的下一个大事件。本文帮助您理解读取STDIN和使用它。我不会在这里创建整个库。相反，我将给出一个小演示，演示如何使用Deno读取STDIN数据并解析它。</p><p id="150f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ko kp kq kr b">jq</code>就像<code class="fe ko kp kq kr b">sed</code>对于JSON数据一样，你可以用它来切片、过滤、映射和转换结构化数据</p><p id="50b5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ko kp kq kr b">— <a class="ae ks" href="https://stedolan.github.io/jq/`" rel="noopener ugc nofollow" target="_blank">https://stedolan.github.io/jq/</a></code></p><p id="da45" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi kt translated"><span class="l ku kv kw bm kx ky kz la lb di">F</span><strong class="js iu">act Check:</strong>STDIN[<a class="ae ks" href="https://en.wikipedia.org/wiki/Standard_streams#Standard_input_(stdin)" rel="noopener ugc nofollow" target="_blank">标准输入流</a> ] —标准输入是程序从中读取其输入数据的流。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/595610469ca054c03bca75dba2b24740.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HxbKsi_V3NeDIzUGFlBXtg.jpeg"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">ytimg.com</figcaption></figure><h2 id="2baf" class="ls lt it bd lu lv lw dn lx ly lz dp ma kb mb mc md kf me mf mg kj mh mi mj mk bi translated"><strong class="ak">如何创建一个标准输入</strong></h2><p id="8bb7" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn im bi translated">从<code class="fe ko kp kq kr b">stdin</code>传递数据非常容易。您可以使用<code class="fe ko kp kq kr b">&lt;</code>将数据传输到任何程序。</p><h2 id="f44f" class="ls lt it bd lu lv lw dn lx ly lz dp ma kb mb mc md kf me mf mg kj mh mi mj mk bi translated"><strong class="ak">例如:</strong></h2><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="4704" class="ls lt it kr b gy mu mv l mw mx">deno run program.ts &lt; file_name.txt<br/>deno run programe.ts &lt; echo "data here"</span></pre><p id="9ac0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您还可以使用管道<code class="fe ko kp kq kr b">(|)</code>将任何程序的输出传递给另一个程序。</p><h2 id="5736" class="ls lt it bd lu lv lw dn lx ly lz dp ma kb mb mc md kf me mf mg kj mh mi mj mk bi translated"><strong class="ak">例如:</strong></h2><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="f90b" class="ls lt it kr b gy mu mv l mw mx">cat file_name.txt | deno run program.ts<br/>echo "data here" | deno run programe.ts</span></pre><h2 id="71ec" class="ls lt it bd lu lv lw dn lx ly lz dp ma kb mb mc md kf me mf mg kj mh mi mj mk bi translated"><strong class="ak">如何读取Deno中的stdin</strong></h2><p id="3354" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn im bi translated">读取stdin与读取Deno中的流非常相似。Deno提供了类似<code class="fe ko kp kq kr b">Deno.read</code>和<code class="fe ko kp kq kr b">Deno.readAll</code>的核心API。</p><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="6251" class="ls lt it kr b gy mu mv l mw mx">// examples/advance_jq.ts</span><span id="a99f" class="ls lt it kr b gy my mv l mw mx">const stdinContent = await Deno.readAll(Deno.stdin);<br/>console.log(stdinContent);</span></pre><p id="92d9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">运行:</strong> <code class="fe ko kp kq kr b">deno run examples/advance_jq.ts &lt; examples/advance_jq.ts</code></p><p id="b624" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当你运行这个程序时，会打印出一些数字(<code class="fe ko kp kq kr b">Uint8Array</code>)。像其他语言一样，流数据是在缓冲区中编码的缓冲数据。要转换我们需要<code class="fe ko kp kq kr b">TextDecoder</code>。</p><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="dcdf" class="ls lt it kr b gy mu mv l mw mx">// examples/advance_jq.ts</span><span id="158f" class="ls lt it kr b gy my mv l mw mx">const stdinContent = await Deno.readAll(Deno.stdin);<br/>const response = new TextDecoder().decode(stdinContent);<br/>console.log(response);</span></pre><p id="34a7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">运行:</strong> <code class="fe ko kp kq kr b">deno run examples/advance_jq.ts &lt; examples/advance_jq.ts</code></p><p id="2c97" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以看到您的文件数据作为输出</p><p id="f229" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">解析JSON </strong></p><p id="cff8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">解析JSON并提取值是一项非常繁琐的任务。我已经根据提供的键编写了一个从对象中提取值的基本程序。代码如下所示:</p><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="f815" class="ls lt it kr b gy mu mv l mw mx">const evalReg = /(\.)|(\[(\d)\])/;<br/>const safeEval = (key: string, obj: any) =&gt; {<br/>  let lastKey;<br/>  let match;<br/>  do {<br/>    if (lastKey) {<br/>      if (match &amp;&amp; match[2]) {<br/>        obj = obj[lastKey][match[3]];<br/>      } else {<br/>        obj = obj[lastKey];<br/>      }<br/>    }<br/>    match = evalReg.exec(key);<br/>    if (!match) {<br/>      lastKey = key;<br/>      break;<br/>    } else {<br/>      lastKey = key.substr(0, match.index);<br/>      key = key.slice(!match[3] ? match.index + 1 : match.index + 3);<br/>    }<br/>  } while (match);<br/>  if (lastKey) {<br/>    obj = obj[lastKey];<br/>  }<br/>  return obj;<br/>};</span></pre><p id="a628" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里我使用<code class="fe ko kp kq kr b">RegExp.exec</code> [ <a class="ae ks" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/exec" rel="noopener ugc nofollow" target="_blank"> more </a> ]方法解析密钥并提取令牌。这是JQ所能做的一个非常粗略的例子。所以<code class="fe ko kp kq kr b">safeEvel</code>代码也小😁。</p><h2 id="f269" class="ls lt it bd lu lv lw dn lx ly lz dp ma kb mb mc md kf me mf mg kj mh mi mj mk bi translated">这种方法的工作原理:</h2><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="ceed" class="ls lt it kr b gy mu mv l mw mx">const obj = {<br/>  id: 1,<br/>  version: "1.0.1",<br/>  contributors: ["deepak", "gary"],<br/>  actor: {<br/>    name: "Tom Cruise",<br/>    age: 56,<br/>    "Born At": "Syracuse, NY",<br/>    Birthdate: "July 3 1962",<br/>    movies: ["Top Gun", "Mission: Impossible", "Oblivion"],<br/>    photo: "<a class="ae ks" href="https://jsonformatter.org/img/tom-cruise.jpg" rel="noopener ugc nofollow" target="_blank">https://jsonformatter.org/img/tom-cruise.jpg</a>",<br/>  },<br/>};<br/>console.log(JSON.stringify(obj, null, 2));<br/>console.log(safeEval("id", obj));<br/>console.log(safeEval("contributors", obj));<br/>console.log(safeEval("contributors[1]", obj));<br/>console.log(safeEval("actor.movies[2]", obj));</span></pre><h2 id="1f5b" class="ls lt it bd lu lv lw dn lx ly lz dp ma kb mb mc md kf me mf mg kj mh mi mj mk bi translated">输出:</h2><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="5f59" class="ls lt it kr b gy mu mv l mw mx">1<br/>[ "deepak", "gary" ]<br/>gary<br/>Oblivion</span></pre><p id="0fad" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如你所见，这正是我们所需要的。让我们完成实际的演示。</p><p id="3d18" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">【注:】</strong>感谢Deno <code class="fe ko kp kq kr b">import</code>，现在我可以直接从Github使用这个文件了。我不需要创建另一个文件来导入。你能做到的。不过，我会用网络来<code class="fe ko kp kq kr b">import</code>。</p><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="1ccb" class="ls lt it kr b gy mu mv l mw mx">import safeEval from "<a class="ae ks" href="https://raw.githubusercontent.com/deepakshrma/deno-by-example/master/examples/safe_eval.ts" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/deepakshrma/deno-by-example/master/examples/safe_eval.ts</a>";</span><span id="d7c8" class="ls lt it kr b gy my mv l mw mx">const stdinContent = await Deno.readAll(Deno.stdin);<br/>const response = new TextDecoder().decode(stdinContent);</span><span id="eef3" class="ls lt it kr b gy my mv l mw mx">try {<br/>  console.log(safeEval(key, JSON.parse(response)));<br/>} catch (err) {<br/>  console.log(response);<br/>}</span></pre><p id="7cf2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是等等，我们将从哪里得到丢失的钥匙呢？</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/58fe16045d315624bb602599f44cb87b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*r8jPWJ08cABVkW5-NuxM5A.jpeg"/></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">(Paolo Nicolello在Unsplash上的照片</figcaption></figure><p id="a507" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Deno提供了对使用CLI传递给程序的参数的直接访问。我们可以使用<code class="fe ko kp kq kr b">Deno.args</code>将所有参数作为数组传递给程序。让我们使用它。</p><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="61e8" class="ls lt it kr b gy mu mv l mw mx">import safeEval from "<a class="ae ks" href="https://raw.githubusercontent.com/deepakshrma/deno-by-example/master/examples/safe_eval.ts" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/deepakshrma/deno-by-example/master/examples/safe_eval.ts</a>";</span><span id="2015" class="ls lt it kr b gy my mv l mw mx">const stdinContent = await Deno.readAll(Deno.stdin);<br/>const response = new TextDecoder().decode(stdinContent);</span><span id="5d2a" class="ls lt it kr b gy my mv l mw mx">const [key = ""] = Deno.args;<br/>try {<br/>  console.log(safeEval(key, JSON.parse(response)));<br/>} catch (err) {<br/>  console.log(response);<br/>}</span></pre><p id="4cda" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以创建一个JSON( <code class="fe ko kp kq kr b">tom.json</code>)并试用。</p><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="1eeb" class="ls lt it kr b gy mu mv l mw mx">/* tom.json */<br/>{<br/>  "id": 1,<br/>  "version": "1.0.1",<br/>  "contributors": ["deepak", "gary"],<br/>  "actor": {<br/>    "name": "Tom Cruise",<br/>    "age": 56,<br/>    "Born At": "Syracuse, NY",<br/>    "Birthdate": "July 3 1962",<br/>    "movies": ["Top Gun", "Mission: Impossible", "Oblivion"],<br/>    "photo": "<a class="ae ks" href="https://jsonformatter.org/img/tom-cruise.jpg" rel="noopener ugc nofollow" target="_blank">https://jsonformatter.org/img/tom-cruise.jpg</a>"<br/>  }<br/>}</span></pre><p id="1efb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">运行:</strong></p><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="8368" class="ls lt it kr b gy mu mv l mw mx">$ deno run examples/advance_jq.ts "id" &lt; examples/tom.json<br/>## 1</span><span id="c9af" class="ls lt it kr b gy my mv l mw mx">$ deno run examples/advance_jq.ts "actor.name" &lt; examples/tom.json<br/>## Tom Cruise</span></pre><p id="4ef5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完美:让我们试试卷发</p><pre class="ld le lf lg gt mq kr mr ms aw mt bi"><span id="12d8" class="ls lt it kr b gy mu mv l mw mx">curl -s -k <a class="ae ks" href="https://raw.githubusercontent.com/deepakshrma/deno-by-example/master/examples/tom.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/deepakshrma/deno-by-example/master/examples/tom.json</a> | deno run  examples/advance_jq.ts "actor.movies[1]"</span><span id="cd78" class="ls lt it kr b gy my mv l mw mx">Output: Mission: Impossible</span></pre><p id="67ed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不错！任务:<strong class="js iu">我有可能</strong></p><p id="29c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">更多示例，请访问:<a class="ae ks" href="https://deepakshrma.github.io/deno-by-example/" rel="noopener ugc nofollow" target="_blank">https://deepakshrma.github.io/deno-by-example/</a></p><p id="6b3f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">阅读更多关于<code class="fe ko kp kq kr b">Deno.readAll</code>(<a class="ae ks" href="https://doc.deno.land/https/github.com/denoland/deno/releases/latest/download/lib.deno.d.ts#Deno.readAll" rel="noopener ugc nofollow" target="_blank">https://doc . deno . land/https/github . com/deno land/deno/releases/latest/download/lib . deno . d . ts # deno . read all</a>)</p><p id="6a42" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">提前感谢您的支持和建议。</p><p id="3ef9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于代码回购:</p><div class="na nb gp gr nc nd"><a href="https://github.com/deepakshrma/deno-by-example" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd iu gy z fp ni fr fs nj fu fw is bi translated">deepakshrma/deno-举例说明</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">在GitHub上创建一个帐户，为deepakshrma/deno-by-example开发做出贡献。</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">github.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr lm nd"/></div></div></a></div></div></div>    
</body>
</html>