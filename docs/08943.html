<html>
<head>
<title>Serverless Framework meets the CDK 🚀</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器框架符合CDK🚀</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/serverless-framework-meets-the-cdk-70037c730c04?source=collection_archive---------6-----------------------#2021-06-21">https://levelup.gitconnected.com/serverless-framework-meets-the-cdk-70037c730c04?source=collection_archive---------6-----------------------#2021-06-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/77c506d38de906cb060245aac4c13744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YvdP5MoPjLfN80kfe7mCDg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">丹尼尔·斯通在<a class="ae jd" href="https://unsplash.com/t/architecture?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><div class=""><h2 id="8fe7" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">设置场景</h2></div><p id="3346" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">假设您的团队正在为您当前的项目使用<a class="ae jd" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>，并且您对您的<a class="ae jd" href="https://en.wikipedia.org/wiki/Infrastructure_as_code" rel="noopener ugc nofollow" target="_blank"> IaC </a>有以下基本的定制需求:</p><ol class=""><li id="1bea" class="lr ls jg kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">如果阶段是生产或准备阶段，则向lambda添加CloudWatch警报，但是如果是QA或短暂环境(<em class="ma">例如pr-123 </em>)，则不要添加。这可能是因为您希望在这些环境中降低成本，并且您会在开发过程中收到许多您不想要的垃圾警告。</li></ol><p id="2141" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以越来越深入，例如:</p><ol class=""><li id="c7c6" class="lr ls jg kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">如果阶段是QA或短暂的环境，那么共享一个<a class="ae jd" href="https://aws.amazon.com/elasticsearch-service/" rel="noopener ugc nofollow" target="_blank"> ElasticSearch </a>集群，使用阶段作为前缀生成索引名称；但是，在生产或准备阶段，创建一个单独的ES群集。您可以在非生产/非转移环境中执行此操作，因为对于短暂的环境，每次创建和删除群集都需要时间，而且成本也很高。</li><li id="1ebc" class="lr ls jg kx b ky mb lb mc le md li me lm mf lq lw lx ly lz bi translated">在生产或试运行中有3个实例，但是在QA或短暂的环境中使用1个实例。同样，这可能是为了降低成本，您的负载测试只在您需要更大的集群以增强信心的阶段和生产中运行。</li></ol><blockquote class="mg mh mi"><p id="e0a7" class="kv kw ma kx b ky kz kh la lb lc kk ld mj lf lg lh mk lj lk ll ml ln lo lp lq ij bi translated"><strong class="kx jh">注意:</strong>这些都是虚构的需求，只是为了展示不管你的需求如何定制，你都可以用这种方法获得多大的创造力。</p></blockquote><p id="5210" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用无服务器框架和YML，这些定制的需求可能相当麻烦和难以实现(<em class="ma">即使使用社区创建的插件</em>)，然而当使用AWS CDK这样的框架时，这可以很容易地实现，因为您有能力使用TypeScript进行条件编程和导入函数。</p></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><h2 id="13ac" class="mt mu jg bd mv mw mx dn my mz na dp nb le nc nd ne li nf ng nh lm ni nj nk nl bi translated">那么，我们如何使用无服务器框架来实现这一点呢？</h2><p id="1b57" class="pw-post-body-paragraph kv kw jg kx b ky nm kh la lb nn kk ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated">实现这一点的一种方法是使用JS或TS作为您的无服务器配置文件，而不是使用YML ( <code class="fe nr ns nt nu b"><em class="ma">serverless.js</em></code> <em class="ma">或</em> <code class="fe nr ns nt nu b"><em class="ma">serverless.ts</em></code>)，这就提供了使用导入函数的能力，从本质上使无服务器框架100%可扩展。如果你可以在JavaScript或TypeScript中实现，那么你也可以在无服务器框架和IaC中实现！💥</p><p id="3705" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这在无服务器框架文档以及节点和类型脚本的示例中有进一步的描述:<a class="ae jd" href="https://www.serverless.com/framework/docs/providers/aws/guide/intro#services" rel="noopener ugc nofollow" target="_blank">https://www . server less . com/Framework/docs/providers/AWS/guide/intro # services</a></p><blockquote class="mg mh mi"><p id="04ef" class="kv kw ma kx b ky kz kh la lb lc kk ld mj lf lg lh mk lj lk ll ml ln lo lp lq ij bi translated">该框架还处理从项目根目录下的Javascript文件<code class="fe nr ns nt nu b">serverless.js</code>或Typescript文件<code class="fe nr ns nt nu b">serverless.ts</code>中本地导出JSON对象。虽然框架是语言不可知的，但使用Node.js编写的项目将从对服务定义文件使用相同的语言中受益匪浅。</p></blockquote><p id="ae99" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">大多数团队自然会直接使用YML，让我们面对现实吧，它比JSON漂亮得多，但在我看来扩展性较差！😍</p><blockquote class="mg mh mi"><p id="da2a" class="kv kw ma kx b ky kz kh la lb lc kk ld mj lf lg lh mk lj lk ll ml ln lo lp lq ij bi translated">两年前，我和我的团队在一个大型企业无服务器项目中使用了这种方法，这种方法非常成功。这种方法和<a class="ae jd" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank"> Jest </a>一起意味着我们实际上也可以对我们的逻辑进行单元测试(包括CloudFormation输出的快照),因为它应该是确定性的，所以我们可以更加安心；在我们的<a class="ae jd" href="https://lerna.js.org/" rel="noopener ugc nofollow" target="_blank"> Lerna monorepo </a>包中，我们也有可重用的函数、类型和接口，以便在多个无服务器服务中使用它们。</p><p id="6e57" class="kv kw ma kx b ky kz kh la lb lc kk ld mj lf lg lh mk lj lk ll ml ln lo lp lq ij bi translated">这也允许我们使用预定义的文件夹策略为不同的资源进行更多的资源和配置(这也可以在YML中通过拉入外部文件来实现，但是使用TS/JS，您可以直接导入并单击IDE中的本地函数，这是一种更好的开发人员体验)。</p></blockquote></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><h2 id="47e3" class="mt mu jg bd mv mw mx dn my mz na dp nb le nc nd ne li nf ng nh lm ni nj nk nl bi translated">好，听起来不错——给我举个例子！</h2><p id="e45d" class="pw-post-body-paragraph kv kw jg kx b ky nm kh la lb nn kk ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated">当您从无服务器框架CLI中使用<a class="ae jd" href="https://www.serverless.com/framework/docs/providers/aws/cli-reference/create/" rel="noopener ugc nofollow" target="_blank">模板功能</a>时，选择<strong class="kx jh"> aws-nodejs-typscript </strong>模板类型，它将在根文件夹中为您生成以下默认<strong class="kx jh"> serverless.ts </strong>以及API网关和“hello”lambda函数(<em class="ma">调用和下面的自动生成输出</em>):</p><pre class="nv nw nx ny gt nz nu oa ob aw oc bi"><span id="dc4d" class="mt mu jg nu b gy od oe l of og">serverless create --template aws-nodejs-typescript</span></pre><figure class="nv nw nx ny gt is"><div class="bz fp l di"><div class="oh oi l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用无服务器CLI自动生成的serverless.ts文件示例</figcaption></figure><p id="9677" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这允许我们基于stage环境变量，为我们关于警报的特定需求(高于的<em class="ma">)创建并单元测试一个名为<strong class="kx jh"> configureAlarms </strong>的新函数；然后可以导入到<strong class="kx jh"> serverless.ts </strong>文件中使用。这将基本上在从函数返回的正确的<a class="ae jd" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> CloudFormation </a>中传播到资源部分。例如在第33行:</em></p><figure class="nv nw nx ny gt is"><div class="bz fp l di"><div class="oh oi l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">每个阶段定制警报创建的示例serverless.ts</figcaption></figure><p id="93db" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下sudo代码显示了导入的<strong class="kx jh"> configureAlarms </strong>函数在本例中可能的样子:</p><figure class="nv nw nx ny gt is"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="ecb9" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用您正在部署的stage环境变量运行serverless命令(<em class="ma">或者您也可以使用serverless中的dotenv特性来执行此操作</em>):</p><pre class="nv nw nx ny gt nz nu oa ob aw oc bi"><span id="e175" class="mt mu jg nu b gy od oe l of og">STAGE=prod sls deploy --stage=prod</span></pre></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><h2 id="d0f4" class="mt mu jg bd mv mw mx dn my mz na dp nb le nc nd ne li nf ng nh lm ni nj nk nl bi translated">太棒了，还有其他好处吗？</h2><p id="d533" class="pw-post-body-paragraph kv kw jg kx b ky nm kh la lb nn kk ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated">这种方法还有另外三个好处:</p><ol class=""><li id="602a" class="lr ls jg kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">在过去几年中，围绕无服务器配置的配置选项大量增加，现在变得非常冗长。通过使用Serverless + TypeScript，您将拥有配置的显式类型，从而允许您使用IDE intellisense浏览配置。这是优于YML的一个主要优点。</li><li id="ac56" class="lr ls jg kx b ky mb lb mc le md li me lm mf lq lw lx ly lz bi translated">如果你有可以在多个无服务器项目中共享和使用的通用函数，你可以通过NPM或者通过使用monorepo打包和导入它们以获得更好的重用。</li><li id="f3a7" class="lr ls jg kx b ky mb lb mc le md li me lm mf lq lw lx ly lz bi translated">您可以键入您的stage(<em class="ma">正如我上面所做的，并导入它们</em>)，并从配置文件中获取您的stage值，以确保您的IaC代码中没有键入错误，并确保已经提供了环境变量(<em class="ma">如果没有，该错误将阻止无服务器部署</em>)。配置文件可以像下面这样简单，以确保您不必在代码中到处使用<code class="fe nr ns nt nu b">process.env.STAGE </code>,也就是说，将它很好地包装在可以在任何地方导入的配置服务中:</li></ol><pre class="nv nw nx ny gt nz nu oa ob aw oc bi"><span id="392c" class="mt mu jg nu b gy od oe l of og">// the imported getStage function just returns the value of<br/>// process.env.STAGE and throws an error if it is not supplied<br/>const stage = getStage();</span><span id="14a7" class="mt mu jg nu b gy oj oe l of og">export const config = {<br/>   stage: `${stage}`,<br/>};</span></pre></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><h1 id="558b" class="ok mu jg bd mv ol om on my oo op oq nb km or kn ne kp os kq nh ks ot kt nk ou bi translated">包扎</h1><p id="c02f" class="pw-post-body-paragraph kv kw jg kx b ky nm kh la lb nn kk ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated">虽然这是一个基本的sudo代码示例，说明了您可以实现的目标，但希望这将展示一种方法，当YML过于严格时，这种方法可能适合您的需求。</p><p id="a211" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们连接以下任何一项:</p><p id="bec7" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae jd" href="https://www.linkedin.com/in/lee-james-gilmore/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/lee-james-gilmore/</a>T19】T20】https://twitter.com/LeeJamesGilmore</p><p id="d3e1" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你觉得这些文章鼓舞人心或有用，请随时用虚拟咖啡<a class="ae jd" href="https://www.buymeacoffee.com/leegilmore" rel="noopener ugc nofollow" target="_blank">https://www.buymeacoffee.com/leegilmore</a>来支持我，不管怎样，让我们联系和聊天吧！☕️</p><p id="b9c5" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你喜欢这些帖子，请关注我的简介<a class="ae jd" href="https://medium.com/u/2906c6def240?source=post_page-----39c4f4ae5aff----------------------" rel="noopener">李·詹姆斯·吉尔摩</a>以获取更多的帖子/系列，别忘了联系我并打招呼👋</p><p id="17be" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh">本文由</strong><a class="ae jd" href="https://www.sedai.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kx jh">sedai . io</strong>T7】赞助</a></p><figure class="nv nw nx ny gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ov"><img src="../Images/4c77bc2d275bd557dda90aa2fe842d2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LJqkQYFI-KAGHOI3cHWxJQ.png"/></div></div></figure><h1 id="d5ee" class="ok mu jg bd mv ol ow on my oo ox oq nb km oy kn ne kp oz kq nh ks pa kt nk ou bi translated">关于我</h1><p id="b371" class="pw-post-body-paragraph kv kw jg kx b ky nm kh la lb nn kk ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated"><strong class="kx jh"> " </strong> <em class="ma">大家好，我是Lee，英国的AWS认证技术架构师和多语言软件工程师，是一名技术云架构师和无服务器主管，过去5年来主要从事AWS上的全栈JavaScript工作。</em></p><p id="e138" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="ma">我认为自己是一个热爱AWS、创新、软件架构和技术的无服务器布道者。</em><strong class="kx jh"/></p><p id="1ae9" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh"> ** </strong>所提供的信息是我个人的观点，我对这些信息的使用不承担任何责任。</p></div></div>    
</body>
</html>