<html>
<head>
<title>Using Nix Flakes with Bazel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Nix薄片与Bazel一起使用</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-nix-flakes-with-bazel-8189719ea799?source=collection_archive---------9-----------------------#2021-08-30">https://levelup.gitconnected.com/using-nix-flakes-with-bazel-8189719ea799?source=collection_archive---------9-----------------------#2021-08-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/072d0439e0f8c61a97173b65c8847503.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*aj4IXogfazuERicINvKofA.jpeg"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">Christine Makhlouf 在<a class="ae jy" href="https://unsplash.com/s/photos/flake?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="61bf" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><a class="ae jy" href="https://nixos.wiki/wiki/Flakes" rel="noopener ugc nofollow" target="_blank"> Nix Flakes </a>是Nix 2.4的一个新特性(在撰写本文时仍是预发布版本)，它使Nix衍生产品可组合，并可用于将衍生产品分发给其他人。</p><p id="4d2d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这不是一个关于Nix Flakes是什么的帖子，如果你还没有阅读过，我推荐你阅读Tweag的系列文章(这里先看<a class="ae jy" href="https://nixos.wiki/wiki/Flakes" rel="noopener ugc nofollow" target="_blank"/>)。</p><p id="43ac" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">对薄片的支持当然不是很广泛。这是一个非常简短的解释，我是如何在我的一个项目中弥合Nix Flakes和Bazel之间的差距的。乍一看，这并不复杂，但也不十分明显。</p><h1 id="21fa" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">简单的开发环境</h1><p id="064a" class="pw-post-body-paragraph jz ka iq kb b kc lv ke kf kg lw ki kj kk lx km kn ko ly kq kr ks lz ku kv kw ij bi translated">首先，我们在项目的根目录下创建一个简单的<code class="fe ma mb mc md b">flake.nix</code>。它使用<code class="fe ma mb mc md b">flake-utils</code>为各种系统轻松创建环境，例如<code class="fe ma mb mc md b">x86_64-linux</code>。我们从Nixpkgs的不同版本中获取Bazel，因为上次我尝试时它在<code class="fe ma mb mc md b">nixpkgs-unstable</code>被破坏了。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="6ff4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">“旧的”nixpkgs(如在<code class="fe ma mb mc md b">import &lt;nixpkgs&gt; {}</code>中)可以在<code class="fe ma mb mc md b">nixpkgs.legacyPackages.x86_64-linux</code>等属性中获得，这里的<code class="fe ma mb mc md b">nixpkgs</code>是一个薄片，作为我们薄片的输入。</p><p id="d5ca" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为了便于演示，我们定义了一个简单的Nix覆盖图，它覆盖了来自<code class="fe ma mb mc md b">nixpkgs</code>的<code class="fe ma mb mc md b">ghc</code>，在<code class="fe ma mb mc md b">nix/haskell/overlay.nix</code>有一个不同的派生。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">nix/haskell/overlay.nix</figcaption></figure><p id="ed6c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为了让Bazel知道Nix环境依赖于这个文件，我们可以用下面的规则在<code class="fe ma mb mc md b">nix/haskell/</code>中创建<code class="fe ma mb mc md b">BUILD.bazel</code>文件。这将在稍后的<code class="fe ma mb mc md b">WORKSPACE</code>中使用。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">nix/haskell/BUILD.bazel</figcaption></figure><p id="0396" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">接下来，我们可以像以前一样定义我们的开发环境。我喜欢把它放在<code class="fe ma mb mc md b">nix/shell.nix</code>中，所以(几乎)所有的Nix代码都在<code class="fe ma mb mc md b">nix/</code>中结束。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">nix/shell.nix</figcaption></figure><p id="b876" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">运行<code class="fe ma mb mc md b">nix develop</code>应该会让您进入一个带有Bazel和Python的shell。因为这是它第一次运行，所以应该用输入的固定版本生成另一个文件<code class="fe ma mb mc md b">flake.lock</code>。</p><h1 id="c42d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">这座桥</h1><p id="ed72" class="pw-post-body-paragraph jz ka iq kb b kc lv ke kf kg lw ki kj kk lx km kn ko ly kq kr ks lz ku kv kw ij bi translated"><a class="ae jy" href="https://github.com/tweag/rules_nixpkgs" rel="noopener ugc nofollow" target="_blank"> rules_nixpkgs </a>没有对Nix Flakes的本地支持，所以我们需要用一个简单的文件来弥补这个缺口，这个文件公开了与flake中相同的<code class="fe ma mb mc md b">nixpkgs</code>。我们还希望应用任何覆盖，以便Bazel使用正确版本的依赖项。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><h1 id="b700" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Bazel工作空间</h1><p id="ec8b" class="pw-post-body-paragraph jz ka iq kb b kc lv ke kf kg lw ki kj kk lx km kn ko ly kq kr ks lz ku kv kw ij bi translated">最后，我们可以在桥上使用<code class="fe ma mb mc md b">rules_nixpkgs</code>，就好像我们根本没有使用雪花一样。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="40cd" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">正如你所看到的，关键就是那个文件<code class="fe ma mb mc md b">bazel-nixpkgs.nix</code>，它非常简单。拥有这个文件的一个好的副作用是，只需输入<code class="fe ma mb mc md b">:l ./bazel-nixpkgs.nix</code>就可以在<code class="fe ma mb mc md b">nix repl</code>中加载Nixpkgs。这个技巧对于调试非常有用。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><p id="4642" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">如果你喜欢这样的故事，可以考虑成为媒体的会员，或者订阅。</p></div></div>    
</body>
</html>