<html>
<head>
<title>Spring Boot Performance Workshop with Vlad Mihalcea</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Vlad Mihalcea的Spring Boot表演工作坊</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/spring-boot-performance-workshop-with-vlad-mihalcea-e886bbb4e4ad?source=collection_archive---------15-----------------------#2022-06-19">https://levelup.gitconnected.com/spring-boot-performance-workshop-with-vlad-mihalcea-e886bbb4e4ad?source=collection_archive---------15-----------------------#2022-06-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6de22fd7d4deb8564fe4d8adea77a3da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aysUG3atKxXUTCj1qWBtVw.png"/></div></div></figure><p id="9f89" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几周前，我们和Vlad Mihalcea一起举办了一个研讨会，大家可以在下面看到。这很有趣，我希望很快再次这样做！</p><p id="fa07" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本次研讨会中，我们重点讨论了Spring Boot性能，但最重要的是Hibernate性能，这是生产环境中的一个常见问题。这尤其难以跟踪，因为在本地调试时，与数据相关的问题通常难以察觉。当我们有大规模的“真实世界”数据时，它们会突然膨胀并成为主要问题。</p><p id="157e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章的开始，我将概述演讲中的许多亮点，最后回答一些我们错过的问题。我们计划做这个演讲的第二部分，因为有太多的事情我们从来没有谈到过！</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="la lb l"/></div></figure><h1 id="d9c8" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">show-sql的问题是</h1><p id="6d1c" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">简短的介绍之后，我们直接进入了问题。开发人员在配置文件中启用<code class="fe mf mg mh mi b">spring.jpa.show-sql</code>设置是很常见的。通过将此项设置为true，我们将看到Hibernate执行的所有SQL语句都打印在控制台上。这对于调试性能问题非常有帮助，因为我们可以确切地看到数据库中发生了什么。</p><p id="be74" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是它不记录SQL查询。它打印在控制台上！</p><h1 id="a537" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">我们为什么要使用记录器？</h1><p id="19d0" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">这引发了观众的疑问:为什么我们使用记录器而不使用<code class="fe mf mg mh mi b">System.out</code>有关系？</p><p id="4276" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">聊天中的常见回答包括:</p><ul class=""><li id="8b3a" class="mj mk iq ka b kb kc kf kg kj ml kn mm kr mn kv mo mp mq mr bi translated"><code class="fe mf mg mh mi b">System.out</code>速度慢–它有性能开销。但是伐木业也是如此</li><li id="ba7a" class="mj mk iq ka b kb ms kf mt kj mu kn mv kr mw kv mo mp mq mr bi translated"><code class="fe mf mg mh mi b">System.out</code>阻塞——大多数日志实现都是如此，但是你可以使用异步日志记录器</li><li id="e150" class="mj mk iq ka b kb ms kf mt kj mu kn mv kr mw kv mo mp mq mr bi translated">无持久性—您可以将流程的输出重定向到文件</li></ul><p id="28ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">原因是记录器提供的细粒度控制和元数据。记录器让我们根据日志级别、包等过滤日志。</p><p id="0f0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">他们让我们使用像MDC这样的工具将元数据附加到请求上，这绝对令人惊奇。您还可以通过管道将日志传送到多个目的地，以JSON等可接收的格式输出它们，这样当您查看来自所有服务器的所有日志时，它们可以包含适当的元数据(例如在Elastic上)。</p><h1 id="aeba" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">Show-sql只是系统输出</h1><p id="96a1" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">它不包括上下文。有可能它不会进入你的弹性输出，即使它进入了。你将没有上下文。无法判断查询是因为请求X还是y而被触发的。</p><p id="d8ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里的另一个问题是SQL中的问号。可以使用的环境非常有限。我们希望看到变量值，而不是问题。</p><h1 id="32d9" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">使用Lightrun添加日志</h1><p id="8b0b" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">Lightrun允许您在不更改源代码的情况下向生产应用程序添加新日志。我们只需打开Hibernate文件“Loader.java”并向<code class="fe mf mg mh mi b">executeQueryStatement</code>添加一个新日志。</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi gj"><img src="../Images/520e755559660e99e031d66fd4ef4231.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zplDiWwuoYrwZq-f"/></div></div></figure><p id="47b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以在提示我们的对话框中填写日志语句。注意，我们可以使用花括号来编写Java表达式，例如变量名、方法调用等。</p><p id="d514" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些表达式在沙箱中执行，<strong class="ka ir">保证</strong>它们不会影响应用程序的状态。沙盒<strong class="ka ir">保证</strong>只读状态！</p><p id="9842" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">单击“确定”后，我们可以看到日志出现在IDE中。请注意，代码没有发生变化，但是这将如同您在该行中编写了一个logger语句一样。因此日志将与其他日志集成在一起。</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/3cca5480c700fd7241372d277e724dae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tZI92PlFRNkjwa8g"/></div></div></figure><p id="4c6e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，我们打印了语句和参数，因此日志输出将包含我们需要的所有内容。你可能会担心这对CPU的负担太重，你是对的。Lightrun会检测CPU的过度使用，并暂时暂停昂贵的操作，以控制执行时间。这可以防止您意外执行过于昂贵的操作。</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/6c44ea9eb3f8b264b95db5834dae0594.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jIgOr-p181Thdbr2"/></div></div></figure><p id="d5d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以看到日志被打印出来，完整的内容放在最上面，但是为了防止CPU开销而被挂起。这意味着在调查性能问题时，您不会遇到性能问题…</p><p id="a7cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您仍然可以看到查询，以及发送到数据库服务器的值。</p><h1 id="68ec" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">原木管道</h1><p id="53a0" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated"><a class="ae mz" href="https://lightrun.com/" rel="noopener ugc nofollow" target="_blank"> Lightrun的</a>日志功能的最大好处之一是它能够与代码中编写的其他日志语句集成。当您查看日志文件时，Lightrun添加的语句将与用代码编写的日志语句“按顺序”出现。</p><p id="6721" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就好像你写了语句，重新编译，上传了新版本。但这并不是你在所有情况下都想要的。</p><p id="6b62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果有很多人在处理源代码，并且您想要调查一个问题，那么日志记录可能是一个问题。您可能不想让您的“调试打印”污染主日志文件。这就是我们使用日志管道的情况。</p><p id="ce71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">日志管道让我们决定日志的去向。我们可以选择通过管道将日志发送到插件，在这种情况下，日志不会与其他应用程序日志一起出现。这样，开发人员可以跟踪问题，而不会污染日志的神圣性。</p><h1 id="1b1e" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">Spring Boot连接收购</h1><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/53df5d8b4a665438dcdb8df0248e7e40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Em7xMrwosWU4E3J7"/></div></div></figure><p id="d996" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">理想情况下，我们应该在最后一刻建立关系数据库连接。您应该尽快释放它以增加数据库吞吐量。在JDBC，默认情况下，事务是自动提交的，这与Spring Boot的JPA事务不兼容。</p><p id="d34d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不幸的是，我们正处于一个先有鸡还是先有蛋的问题。Spring Boot需要禁用自动提交。为此，它需要一个数据库连接。因此，它需要连接到数据库，以便关闭这个本来应该关闭的标志。</p><p id="9347" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这可能会严重影响性能和吞吐量，因为一些请求可能会在等待来自池的数据库连接时被阻塞。</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/7e42e4662e4deea6908c763cf0284b8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W630O8ftTzDhZDteKh4quw.png"/></div></div></figure><p id="76fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果打印出这个日志，我们的自动提交配置就有问题。一旦我们知道剩下的就很容易了。我们需要添加这两个字段来禁用自动提交，并告诉Hibernate我们禁用了它。一旦这些都设置好了，性能应该会提高。</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/8370c105ba8f7eb96894b880f2eb1ae2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nvFC1rT1SUfnC2dTYiZZ9w.png"/></div></div></figure><h1 id="76d0" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">查询计划缓存</h1><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/30fdd337970859509033ec39b8de5991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W6G2VW4GPiA2i_UEVU-KWQ.png"/></div></div></figure><p id="3828" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将JPQL编译成本地SQL代码需要时间。Hibernate缓存结果以节省CPU时间。</p><p id="fcb9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这种情况下，缓存未命中会对性能产生巨大影响，如下图所示:</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/056999dace8335daf9e0b483480c4921.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lz573__xZs1OAKRHqAFcjg.png"/></div></div></figure><p id="c99d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这会严重影响查询执行时间和整个服务的响应时间。</p><p id="98da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Hibernate有一个统计类来收集所有这些信息。我们可以用它来检测有问题的区域，在这种情况下，向类中添加一个快照。</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/4b155084926ab65f450258c1f17457ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Afy5yM5OtvoR_AtukFxcCQ.png"/></div></div></figure><h1 id="f774" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">快照</h1><p id="1b9d" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">快照(也称为不间断断点或捕获)是一个不停止程序执行的断点。它包括堆栈跟踪、每个堆栈帧中的变量值等。然后，它在一个与IDE断点UI非常相似的UI中向我们展示这些细节。</p><p id="a36c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以通过单击堆栈帧来遍历源代码，并查看变量值。我们可以添加观察条目，最重要的是:我们可以创建条件快照(这也适用于日志和指标)。</p><p id="4734" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">条件快照允许我们仅在满足特定条件时触发快照。一个常见的问题是当系统中的一个bug只被一个特定的用户遇到时。我们可以使用条件快照来获取特定用户的堆栈信息。</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/cfa9bfb70a877d19110729fd4cd2ec48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8KRZV7Dm3LRamspg0QCx5w.png"/></div></div></figure><h1 id="eb30" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">渴望获取</h1><p id="140c" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">当我们查看SQL查询的日志时，我们经常可以看到数据库获取的数据比我们最初要求的要多得多。这是因为JPA关系的默认设置是EAGER。这是规范本身的问题。我们可以通过显式地将获取类型定义为LAZY来实现显著的性能提升。</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/3af5ceed76d17d32f4da5e698dc848c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2cukRIEEHLitL13M4GPwvA.png"/></div></div></figure><p id="bd5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以通过在<code class="fe mf mg mh mi b">DefaultLoadEventListener</code>的<code class="fe mf mg mh mi b">loadFromDatasource()</code>方法中放置一个快照来检测这些问题。</p><p id="3a0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这种情况下，我们使用带有条件的条件快照:<code class="fe mf mg mh mi b">event.isAssociationFetch()</code>。</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/2ed03846a3f49b8e27b05880e4555202.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*7bM3Nd6Z_6BAzdo-aQKbrA.png"/></div></figure><p id="bf63" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，只有当我们有一个急切的关联时，快照才会被触发，这通常是一个bug。这意味着我们忘记了在注释中包含惰性参数。</p><p id="4f0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如您所见，这是由一个完整的堆栈跟踪和关于具有这种关系的实体的信息触发的。</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/f7964d2aa3d382c2b5c2133c5a82271b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hOcR7bULOv7FT3-RqNQPqw.png"/></div></div></figure><p id="3c8f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您也可以使用这种方法来检测不正确的延迟获取。多次延迟获取可能比一次紧急获取更糟糕，因此我们需要保持警惕。</p><h1 id="df30" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">在视图反模式中打开会话</h1><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/100c108a9f569ae94380bb3185c65f5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kz_5IFVPPiUUZydNiuY2Pg.png"/></div></div></figure><p id="2211" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从表面上看，我们似乎没有做错什么。我们只是从数据库中获取数据，并将其返回给客户端。但是，当post控制器返回时，事务上下文完成了，因此，我们要再次从数据库中获取数据。我们需要做额外的查询，因为数据可能是陈旧的。隔离级别可能会被破坏，除了性能之外，还会出现许多错误。</p><p id="7bbb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这造成了不必要查询的N+1问题！</p><p id="a3cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以通过在<code class="fe mf mg mh mi b">onInitializeCollection</code>调用上放置一个快照并查看打开的会话来检测这个问题:</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/d0f5f6e5cc32c3d6eef9d37fad518838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U_lzXMYXjU1EItxaFVNcjg.png"/></div></div></figure><p id="e0a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们看到问题正在发生，我们可以通过定义<code class="fe mf mg mh mi b">spring.jpa.open-in-view=false</code>来解决问题</p><p id="2340" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它会阻止你使用这种方法。</p><h1 id="f769" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">问与答(Question and Answer)</h1><p id="0119" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">作为会议的一部分，有许多精彩的问题。以下是答案。</p><p id="27e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">你能描述一下Lightrun吗？</strong></p><p id="2ece" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Lightrun是一个开发者观察平台。因此，它可以让您安全地调试产品，同时严格控制CPU的使用。它包括以下部分:</p><ul class=""><li id="000e" class="mj mk iq ka b kb kc kf kg kj ml kn mm kr mn kv mo mp mq mr bi translated">客户端— IDE插件/命令行</li><li id="be26" class="mj mk iq ka b kb ms kf mt kj mu kn mv kr mw kv mo mp mq mr bi translated">管理服务器</li><li id="d398" class="mj mk iq ka b kb ms kf mt kj mu kn mv kr mw kv mo mp mq mr bi translated">代理—在您的服务器上运行以启用功能</li></ul><p id="8e17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我在这里写了关于它的深度<a class="ae mz" href="https://talktotheduck.dev/remote-debugging-and-developer-observability" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="70e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Lightrun可以离线工作吗？</p><p id="7468" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为您正在调试产品，所以我们假设您的服务器没有离线。</p><p id="43f7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，Lightrun可以在内部部署，这样就不需要开放的互联网环境。</p><p id="385e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">想知道这个样品的情况，它可供我们参考吗？</strong></p><p id="4e22" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码都是<a class="ae mz" href="https://github.com/vladmihalcea/spring-petclinic" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="e3a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">由于检测/操作是通过服务器进行的，假设我自己没有托管检测服务器，那么正在传输的数据是什么类型和数量？数据是否以任何方式受到保护或加密？</strong></p><p id="9bf7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用代理在您的服务器上进行检测。</p><p id="dd5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Lightrun服务器无法访问您的源代码或字节码！</p><p id="b97d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">源代码或字节码在任何阶段都不会出现在网络上，Lightrun也不会接触到它们。</p><p id="acc7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所有的传输都是安全和加密的。证书被固定以避免中间人攻击。Lightrun架构接受了多轮深度安全审查，正在多家财富500强企业中运行。</p><p id="12bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，Lightrun中的所有操作都记录在管理员日志中，这意味着您可以跟踪执行的每个操作，并拥有完整的事后跟踪。</p><p id="4dfa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在这里阅读更多关于Lightrun security的信息。</p><p id="67af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">如前所述，这些日志会在1小时内过期。是否可以保存这些日志并重复使用，而不是每次都手动创建日志条目？</strong></p><p id="6977" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Lightrun操作默认在1小时后过期，以消除任何潜在的无意开销。您可以将这个数字设置得更高，这对难以重现的错误很有用。</p><p id="09a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，当操作过期时，您只需单击它并重新创建它。它将在IDE中以红色显示，并且仍然可以用作参考。</p><p id="cecb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">IntelliJ IDEA是添加断点/日志的唯一方法吗？或者说用Lightrun调试在生产中是怎么做的？</strong></p><p id="2a0c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以使用IntelliJ(还有PyCharm和WebStorm)以及VSCode、VSCode.dev和命令行。</p><p id="fbfc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些通过Lightrun服务器连接到生产环境。目标是让您感觉好像在提取生产数据的同时调试本地应用程序。没有隐含的风险。</p><p id="32b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">对于一对多、多对多或多对一的关系，是否应该总是配置急切加载？我总是为上述关系配置延迟加载。可以吗？</strong></p><p id="2a8a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是的。如果您看到您一直在获取另一个实体，那么这种情况下的急切加载是有意义的。在大多数情况下，将渴望作为缺省值没有什么意义。</p><p id="61bc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">我们需要用javaagent重启应用程序吗？</strong></p><p id="245a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代理会一直在后台运行。它很安全，不使用时没有开销。</p><p id="9cc0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">如果我们使用其他测量工具，比如AppDynamics或dynatrace ……这是否也适用？</strong></p><p id="0e2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这因工具而异。除了Lightrun之外，大多数APM都工作得很好，因为它们与JVM的不同功能挂钩。</p><p id="e693" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">这适用于GraalVM吗？</strong></p><p id="4bb4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为GraalVM不支持javaagent参数，所以现在不支持。我们正在寻找替代方法，但希望GraalVM团队会有一些解决方案。</p><p id="9892" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">可以免费使用吗？</strong></p><p id="02f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是啊！</p><p id="0c1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看看<a class="ae mz" href="https://lightrun.com/free" rel="noopener ugc nofollow" target="_blank">lightrun.com/free</a></p><p id="81f7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">它会影响应用性能吗？</strong></p><p id="d9e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是的，但是它是最小的。不使用动作时低于0.5%，使用多个动作时低于8%。请注意，您可以调整代理配置中的开销数量。</p><p id="37ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">对Scala和Kotlin有效吗？</strong></p><p id="5571" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是的。</p><p id="f83b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">没有IDE如何在生产中使用？</strong></p><p id="3dd5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">IDE甚至可以用于生产，因为您不直接连接到生产服务器，也不能访问它们。IDE仅连接到Lightrun管理服务器。这使您的生产服务器保持隔离。</p><p id="7366" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">话虽如此，您仍然可以使用命令行界面来获得这里讨论的所有特性以及更多特性。</p><p id="8d0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除了注射伐木工，我们还能做什么？</p><p id="c5f5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">快照使您可以获得完整的堆栈跟踪，包括堆栈和对象实例状态中所有变量的值。您还可以将自定义观察器表达式作为快照的一部分。</p><p id="204a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">度量允许您添加计数器(我们到达该行的次数)、tictocs(执行该块需要多长时间)、方法持续时间(类似于tictocs，但适用于整个方法)和自定义度量。</p><p id="ec12" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还可以向其中的每一个添加条件，以缩小数据的范围。</p><p id="b82b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">我们如何对豆子隐藏敏感属性？说用户的信用卡号？</strong></p><p id="c312" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Lightrun支持PII缩减，允许您定义一个在进入日志之前将被删除的掩码(例如，信用卡)。这让您可以阻止无意中注入日志。</p><p id="fdba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它还支持阻止列表，允许您阻止文件/类/组的操作。这意味着开发人员不能在那里放置日志或快照。</p><p id="5290" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">我们如何用它来进行性能测试呢？</strong></p><p id="0ce5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我在这里做了这个<a class="ae mz" href="https://twitter.com/debugagent/status/1531653268639825923?s=20&amp;t=_2mpt-LGGCr5WYvDc7POUw" rel="noopener ugc nofollow" target="_blank">的教程。</a></p><p id="74e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">当需要在prem上预留工作空间时，您如何提供服务器，作为jar或docker…？</strong></p><p id="ea8c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是我们的团队帮助您设置的。</p><p id="44cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">如果我们运行Lightrun代理，会消耗更多内存吗？</strong></p><p id="b07b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是最低限度。在没有代理的情况下，在我的Mac上运行petclinic演示程序会在系统监视器中产生以下结果:</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/bfac661c17266ce9021dff03e29b140c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7iRKFpEvTJLxe9T-Enmo_w.png"/></div></div></figure><p id="6a71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有了代理，我们就有了这个:</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/a3c869a9ba74e6c0d3016ff189a9de5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0oRQaeIjGaqf9pJyBRs4Bw.png"/></div></div></figure><p id="7763" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这些尺度上，17mb的差异实际上在误差范围内。不清楚代理有多少开销，如果有的话。</p><h1 id="8791" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">最后</h1><p id="ee45" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">这太有趣了，我们迫不及待地想再玩一次。请关注<a class="ae mz" href="https://twitter.com/vlad_mihalcea" rel="noopener ugc nofollow" target="_blank"> Vlad </a>、<a class="ae mz" href="https://twitter.com/tomGranot/" rel="noopener ugc nofollow" target="_blank"> Tom </a>和<a class="ae mz" href="https://twitter.com/debugagent" rel="noopener ugc nofollow" target="_blank">我自己</a>了解所有这些的更新。</p><p id="5028" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除了缓慢的查询和spring数据的细微差别之外，还有太多的东西我们没有时间去讨论。我们向Grafana展示了一个非常酷的管道指标演示，我们希望下次向您展示。</p></div></div>    
</body>
</html>