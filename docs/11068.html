<html>
<head>
<title>How Browsers Verify Digital Certificates — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">浏览器如何验证数字证书—第2部分</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-browsers-verify-digital-certificates-part-2-ad46e4b5b59f?source=collection_archive---------4-----------------------#2022-02-12">https://levelup.gitconnected.com/how-browsers-verify-digital-certificates-part-2-ad46e4b5b59f?source=collection_archive---------4-----------------------#2022-02-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="275f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">签名验证在底层如何工作</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5a3085d55e589ff3a5668cef267c4fbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*irTgwDsAerujjIfL"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@garrettpsystems" rel="noopener ugc nofollow" target="_blank">加勒特·帕克</a>在<a class="ae ky" href="https://unsplash.com/photos/DlkF4-dbCOU" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="d0ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是“浏览器如何验证数字证书”系列的最后一篇文章。</p><p id="8829" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您还没有，请在继续之前阅读<a class="ae ky" href="https://davidklempfner.medium.com/how-browsers-verify-digital-certificates-part-1-26ee57a6e712" rel="noopener">第1部分</a>。</p><p id="ef69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将:</p><ol class=""><li id="6725" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">从R3证书中提取“待签名”(tbs)证书。</li><li id="ef5f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">从R3证书中提取签名。</li><li id="0845" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用。NET 5.0来使用我们在第1部分中找到的公钥解密签名。</li><li id="b5bb" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">验证解密的签名是否与tbs证书匹配。</li></ol><h1 id="7454" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">在本地保存证书</h1><p id="5e92" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">在我们在<a class="ae ky" href="https://davidklempfner.medium.com/how-browsers-verify-digital-certificates-part-1-26ee57a6e712" rel="noopener">第1部分</a>中看到的ISRG根X1证书的证书路径选项卡中，双击R3证书。</p><p id="3b3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将此证书作为DER编码的二进制X.509(.cer)文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/46b9b6fb2a0db2dc9db8fbd158970798.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bNUVWbLHZIY6ivGk9N45FA.png"/></div></div></figure><h1 id="5646" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">在十六进制编辑器中查看字节</h1><p id="f77d" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">根据<a class="ae ky" href="https://www.rfc-editor.org/rfc/rfc5280#section-4.1" rel="noopener ugc nofollow" target="_blank"> RFC5280 </a>，证书的结构如下:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="ed93" class="nm mk it ni b gy nn no l np nq">Certificate  ::=  SEQUENCE  {<br/>        tbsCertificate       TBSCertificate,<br/>        signatureAlgorithm   AlgorithmIdentifier,<br/>        signatureValue       BIT STRING  }</span></pre><p id="675c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要提取出<code class="fe nr ns nt ni b">tbsCertificate</code>和<code class="fe nr ns nt ni b">signatureValue</code>。</p><p id="192c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了查看证书中哪一个字节对应于三个部分中的哪一个，您需要复制证书的字节(您可以使用<a class="ae ky" href="https://mh-nexus.de/en/hxd/" rel="noopener ugc nofollow" target="_blank"> HxD </a>查看字节)，并将它们粘贴到<a class="ae ky" href="http://lapo.it/asn1js" rel="noopener ugc nofollow" target="_blank">http://lapo.it/asn1js</a>中。</p><p id="00c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是证书在HxD中打开时的样子。</p><p id="e307" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将这些字节复制到记事本中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/e510e1a7b1c8472ceedaed598b402c81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1050/format:webp/1*7xD6CEBhlSXQCVuSdQ5fFQ.png"/></div></figure><p id="1b38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以通过将这些字节粘贴到<a class="ae ky" href="http://lapo.it/asn1js" rel="noopener ugc nofollow" target="_blank">http://lapo.it/asn1js</a>中来查看它们代表了什么。</p><p id="6eec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，这是有等级的。第一个序列是整个证书，层次结构中的下一个序列是<code class="fe nr ns nt ni b">tbsCertificate</code>。这意味着在<code class="fe nr ns nt ni b">tbsCertificate </code>下面的同一级别中的下两个项目必须是<code class="fe nr ns nt ni b">signatureAlgorithm </code>，然后是<code class="fe nr ns nt ni b">signatureValue</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/3c438ea7c8bb5a96077c20211f93836b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jIj9YXSxdjqeYwbCzrWueA.png"/></div></div></figure><h1 id="7a39" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">提取R3的“待签名”证书</h1><p id="2e99" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">正如您在上面的截图中看到的，如果您将鼠标悬停在第一个子序列(<code class="fe nr ns nt ni b">tbsCertificate</code>)上，您可以看到右侧突出显示的字节。使用它在记事本中查找字节，并将其复制到另一个文件中，因为您以后会需要它。</p><h1 id="985e" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">提取R3的签名</h1><p id="49f2" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">如果您滚动到底部并将鼠标悬停在BITSTRING上，您将会看到右侧突出显示的代表签名的字节。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/1f2d878fd6288ff3442ddc52e05b404a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*ojTT1rtYTxk4mThPmHsGoQ.png"/></div></figure><p id="5ed6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它不会显示所有的字节，但你会看到开始序列，并可以用它来识别你的记事本文件中的字节。找到文件的开头，将所有字节复制到文件的末尾，然后粘贴到另一个记事本文件中，以备后用。</p><p id="fb4b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您需要移除<code class="fe nr ns nt ni b">03</code>到<code class="fe nr ns nt ni b">00</code>，即。从<code class="fe nr ns nt ni b">85</code>开始复制。</p><p id="aabe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是因为前四个字节是<a class="ae ky" href="https://letsencrypt.org/docs/a-warm-welcome-to-asn1-and-der/" rel="noopener ugc nofollow" target="_blank">元数据</a>:</p><p id="78b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nr ns nt ni b">03</code>表示它是一个位串，<code class="fe nr ns nt ni b">82</code>表示接下来的两个字节代表长度。<code class="fe nr ns nt ni b">0201</code>是长度，<code class="fe nr ns nt ni b">00</code>只是用来让签名成为<a class="ae ky" href="https://medium.com/gitconnected/what-is-the-2s-complement-d185800bcdab" rel="noopener"> +ve号</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/ee6a4b3bbf2a7b45d9198f7a44ab3263.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/format:webp/1*-79xaGeYdX3bcdGKCgQW6A.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">签名从字节0x85开始。</figcaption></figure><h1 id="7ad2" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">解密R3的签名</h1><p id="0143" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">要解密R3的签名，我们需要使用RSA使用的算法。我不会在这里讨论数学，但是如果你感兴趣的话，这很容易理解。</p><p id="6d80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要执行验证，我们需要将以下几组字节复制到. NET 5.0控制台应用程序中:</p><ol class=""><li id="0e41" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">来自ISRG根X1的模数(来自<a class="ae ky" href="https://davidklempfner.medium.com/how-browsers-verify-digital-certificates-part-1-26ee57a6e712" rel="noopener">第1部分</a>中的根CA证书)。</li><li id="9075" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">来自ISRG根X1的指数(来自<a class="ae ky" href="https://davidklempfner.medium.com/how-browsers-verify-digital-certificates-part-1-26ee57a6e712" rel="noopener">第一部分</a>中的根CA证书)。</li><li id="d36b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">TbsCertificate(来自之前提取的R3证书)。</li><li id="492d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">签名字节(来自之前提取的R3证书)。</li></ol><h1 id="23cb" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">控制台应用程序</h1><p id="8324" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">现在你有了你需要的字节(模数，指数，证书，签名)，你可以把它们作为十六进制字符串复制到这里。NET 5控制台应用程序。确保您删除了字节之间的任何空格。</p><p id="a527" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你需要安装一个名为<a class="ae ky" href="https://www.bouncycastle.org/csharp/index.html" rel="noopener ugc nofollow" target="_blank"> BouncyCastle </a>的NuGet包。</p><p id="52e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大部分代码是不言自明的，但是您会注意到有一行代码从解密的签名中删除了“sha256Identifier”。</p><p id="65d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些字节<a class="ae ky" href="https://www.rfc-editor.org/rfc/rfc3447#page-43" rel="noopener ugc nofollow" target="_blank">代表</a>sha 256算法。</p><p id="8cf4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在这里阅读更多关于对象标识符如何编码的信息<a class="ae ky" href="https://docs.microsoft.com/en-us/windows/win32/seccertenroll/about-object-identifier" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="8775" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您运行上面的控制台应用程序，它应该会打印出<code class="fe nr ns nt ni b">true</code>,表明签名已经过验证。</p><h1 id="aa80" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">常见问题</h1><p id="fce1" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">如果一个证书的签名可以用CA的公钥成功解密，这难道还不足以证明CA签署了那个证书吗？T12】</p><p id="fbb3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这足以证明签名确实是由CA创建的，但是不足以证明签名属于那个特定的证书。这就是为什么必须将证书的哈希与解密的签名进行比较。</p><p id="5aff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">否则，任何人都可以创建一个恶意证书，并添加他们想要的任何签名。</p><p id="ea23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="oa">为什么用的是证书的hash而不是证书本身？</em> </strong></p><p id="29d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用RSA，被加密的值不能大于模数。使用散列是因为它接受任意大量的数据，并将其转换成大小不变的东西。即使您可以解密大于模数的数据，解密小于模数的数据仍然是有意义的。</p><h1 id="e820" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">摘要</h1><p id="9003" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">在本系列中，我们讨论了如何从数字证书中提取所有必要的信息，以便验证签名。</p><p id="1f14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">证书验证不仅仅是验证签名。你可以在谷歌上阅读更多关于证书验证的内容。</p><p id="5d24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">没有显示的是验证的最后一步，使用R3验证StackOverflow的证书。这一点没有讨论，因为它与这里已经展示的过程完全相同。</p><p id="bbd6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有兴趣了解更多关于C#中的BouncyCastle，看看<code class="fe nr ns nt ni b">VerifyData()</code>、<code class="fe nr ns nt ni b">GetPublicKey()</code>、<code class="fe nr ns nt ni b">GetSignature()</code>和<code class="fe nr ns nt ni b">GetTbsCertificate()</code>。这些方法使得获取所需信息变得非常容易，并且极大地简化了验证过程。</p><p id="8905" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你喜欢这篇文章，如果你有任何问题，请留下评论。</p></div></div>    
</body>
</html>