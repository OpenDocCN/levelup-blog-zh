<html>
<head>
<title>Upgrade Java8 to Java17</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Java8升级到Java17</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/upgrade-java8-to-java17-every-java-developer-should-know-43358b30532a?source=collection_archive---------1-----------------------#2022-11-08">https://levelup.gitconnected.com/upgrade-java8-to-java17-every-java-developer-should-know-43358b30532a?source=collection_archive---------1-----------------------#2022-11-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/372b90fd061b479cf63a9e1f86985a72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4qjFze-96PJQR7Yp"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@clemhlrdt?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Clément Hélardot </a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="4d47" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我正在从Java8迁移到Java17。前期做了一些准备。过程中的一些信息记录如下。</p><h1 id="7067" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">1.编译相关</h1><h2 id="5fd0" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">1.1给320</h2><p id="643f" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在Java11中，引入了一个提案JEP 320: <a class="ae kf" href="http://openjdk.org/jeps/320" rel="noopener ugc nofollow" target="_blank">移除Java EE和CORBA模块</a>提案，该提案移除了Java EE和CORBA的模块，如果在项目中使用需要手动引入。例如，下面的<code class="fe mt mu mv mw b">javax.annotation.*</code>:</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="d7a8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在编译时将找不到相关的类。这是因为Java EE <code class="fe mt mu mv mw b">Java 9</code>在Java 11中已经被标记为弃用，在Java 11中正式移除，javax包可以手动导入:</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="56f6" class="mc lf it mw b gy nh ni l nj nk">&lt;dependency&gt;<br/>    &lt;groupId&gt;javax.annotation&lt;/groupId&gt;<br/>    &lt;artifactId&gt;javax.annotation-api&lt;/artifactId&gt;<br/>    &lt;version&gt;1.3.2&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><h2 id="1237" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">1.2使用sun.misc.*下的软件包</h2><p id="ab20" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">例如，<code class="fe mt mu mv mw b">sun.misc.BASE64Encoder</code>，这个很简单，只是替换工具类。</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="7791" class="mc lf it mw b gy nh ni l nj nk">[ERROR]   symbol:   class BASE64Encoder<br/>[ERROR]   location: package sun.misc</span></pre><p id="d50e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">netty的较低版本使用sun.misc.*，编译错误信息如下</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="15c9" class="mc lf it mw b gy nh ni l nj nk">Caused by: java.lang.Nthe oClassDefFoundError: Could not initialize class io.netty.util.internal.PlatformDependent0 at io.netty.util.internal.PlatformDependent.getSystemClassLoader(PlatformDependent.java:694) ~[netty-all-4.0.42.Final.jar!/:4.0.42.Final]</span></pre><p id="46eb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对应的源代码如下:</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="0266" class="mc lf it mw b gy nh ni l nj nk">/**<br/> * The {<strong class="mw iu">@link</strong> PlatformDependent} operations which requires access to {<strong class="mw iu">@code</strong> sun.misc.*}.<br/> */<br/>final class PlatformDependent0 {<br/>}</span></pre><h2 id="cc8f" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">1.3 Lombok使用com.sun.tools.javac下的软件包*</h2><p id="acb7" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">错误消息如下所示:</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="5935" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你在项目中使用<code class="fe mt mu mv mw b">Lombok</code>，而且是低配版，就会出现。<code class="fe mt mu mv mw b">Lombok</code>的原理是在编译期间做一些小技巧，使用下面的文件<code class="fe mt mu mv mw b">com.sun.tools.javac</code>，升级到最新版本解决。</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="28be" class="mc lf it mw b gy nh ni l nj nk">&lt;dependency&gt;<br/>    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br/>    &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br/>   &lt;!-- &lt;version&gt;1.16.4&lt;/version&gt;--&gt;<br/>    &lt;version&gt;1.18.24&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><h2 id="c3e1" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">1.4 Kotlin版本限制</h2><p id="5e36" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们的后端多年来一直是全功能的Kotlin，Kotlin升级也是我们的首要任务。</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="5dbe" class="mc lf it mw b gy nh ni l nj nk">[ERROR] Failed to execute goal org.jetbrains.kotlin:kotlin-maven-plugin:1.2.71:compile (compile) on project encloud-core: Compilation failure [ERROR] Unknown JVM target version: 17 [ERROR] Supported versions: 1.6, 1.8</span></pre><p id="522b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kotlin在1.6.0版本开始支持Java17字节码，1.6.0以下的编译会直接报错</p><h2 id="78d3" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">1.5不赞成使用的依赖关系分析</h2><p id="fe55" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">可以使用<code class="fe mt mu mv mw b">jdeps --jdk-internals --multi-release 17 --class-path . encloud-api.jar</code>进行项目依赖分析</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nl"><img src="../Images/870fbfe041309e632f7d61a9dab1ef86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8kkNQEnB0wYeadvH52cUpw.png"/></div></div></figure><p id="d41a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这样你就知道哪些库需要升级了。</p><h1 id="f84e" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">2.参数迁移</h1><h2 id="3b06" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">2.1什么是统一日志记录</h2><p id="9d31" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在Java领域，有比较知名的log框架，slf4j，log4j等。这些框架提供了统一的编程接口，允许用户通过简单的配置实现日志输出的个性化配置，比如日志标签、级别、上下文(线程id、行号、时间)，JVM内部一直缺乏这样的规范，于是统一日志应运而生，实现了日志格式的统一。</p><p id="08e1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们接触最多的是gc日志。在java8中，我们配置gc日志的参数是<code class="fe mt mu mv mw b">-Xloggc:/tmp/gc.log</code>。除了GC，JVM中还有大量其他相关的日志，比如线程、os等。在新的统一日志中，日志输出的方式发生了变化<code class="fe mt mu mv mw b">java -Xlog:xxx</code>，GC不再是特殊的，只是日志的一种存在形式。</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="09af" class="mc lf it mw b gy nh ni l nj nk">java -Xlog -version</span></pre><p id="2c26" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">输出如下所示:</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nl"><img src="../Images/83b92119d612d76162e486bbfbc2baae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Y3TAqP_pDmJVVRT382ZWg.png"/></div></div></figure><p id="f22f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以看到，在日志输出中，不仅有GC相关的日志，还有os线程相关的信息。其实java log的生产者有很多部分，比如线程、类加载、卸载、safepoint、cds等等。</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nm"><img src="../Images/252f3aa04f3fe2650550386feee3eb8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*otV74iyEDr50Ap1Ii90krQ.png"/></div></div></figure><p id="8701" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">归根结底，日志打印需要明确回答三个问题:</p><ol class=""><li id="b5e4" class="nn no it ki b kj kk kn ko kr np kv nq kz nr ld ns nt nu nv bi translated">输出什么信息(标签)，输出什么日志级别(级别)。</li><li id="827d" class="nn no it ki b kj nw kn nx kr ny kv nz kz oa ld ns nt nu nv bi translated">输出的位置(控制台或文件)。</li><li id="4517" class="nn no it ki b kj nw kn nx kr ny kv nz kz oa ld ns nt nu nv bi translated">如何记录？</li></ol><h2 id="3f2c" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">2.2输出什么信息(选择器)</h2><p id="8919" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">首先看什么部分，如何指定输出哪些信息，这在JVM内部叫做选择器。</p><p id="ed99" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">JVM使用<code class="fe mt mu mv mw b">&lt;tag-set&gt;=&lt;level&gt;</code>的形式来表示选择器。默认情况下，tag为<code class="fe mt mu mv mw b">all</code>，表示所有tag，level为<code class="fe mt mu mv mw b">INFO</code>，相当于下面形式的<code class="fe mt mu mv mw b">java -Xlog -version</code></p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="fbc9" class="mc lf it mw b gy nh ni l nj nk">java -Xlog:all=info -version</span></pre><p id="4b55" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们想输出标记为gc、日志级别为debug的日志，我们可以使用<code class="fe mt mu mv mw b">java -Xlog:gc=debug</code>格式:</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="ba79" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这样就输出了标签为gc，级别为debug的日志信息。</p><p id="8164" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，这里有个坑点。这里的标签匹配规则是精确匹配。如果一个日志的标签<code class="fe mt mu mv mw b">gc,metaspace</code>不符合上述规则，我们可以手动输出。</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="422c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当然，这样做很麻烦。JVM提供通配符<code class="fe mt mu mv mw b">*</code>来解决精确匹配的问题。例如，如果我们想要标记为gc的所有日志，我们可以写:</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="4451" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您只想要信息级别的日志，您可以使用<code class="fe mt mu mv mw b">java -Xlog:gc* -version</code>。</p><p id="e26f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果想知道哪些个性化标签可用，可以使用<code class="fe mt mu mv mw b">java -Xlog:help</code>查找所有可用标签。</p><h2 id="53f1" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">2.3向何处输出(Output)</h2><p id="86ec" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">默认情况下，日志将输出到stdout，JVM支持以下三种输出方法:</p><ul class=""><li id="a1f3" class="nn no it ki b kj kk kn ko kr np kv nq kz nr ld ob nt nu nv bi translated">标准输出</li><li id="0a1f" class="nn no it ki b kj nw kn nx kr ny kv nz kz oa ld ob nt nu nv bi translated">标准错误</li><li id="bc18" class="nn no it ki b kj nw kn nx kr ny kv nz kz oa ld ob nt nu nv bi translated">文件</li></ul><p id="4b57" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一般来说，我们会将日志输出到一个文件中，以供进一步分析。</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="6b56" class="mc lf it mw b gy nh ni l nj nk">-Xlog:all=debug:file=/path_to_logs/app.log</span></pre><p id="a8a7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">还可以指定原木切割的尺寸和方式</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="d33c" class="mc lf it mw b gy nh ni l nj nk">-Xlog:gc*:file=/path_to_logs/app.log:filesize=104857600,filecount=5</span></pre><h2 id="86bf" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">2.4原木装饰工</h2><p id="53ca" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">除了正常信息之外，每个日志都有很多与日志相关的上下文信息，这些信息在JVM中被调用，<code class="fe mt mu mv mw b">decorators</code>并有以下选项。</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="1e54" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">输出格式如下:</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="27f5" class="mc lf it mw b gy nh ni l nj nk">-Xlog:[selectors]:[output]:[decorators][:output-options]</span></pre><ul class=""><li id="53d4" class="nn no it ki b kj kk kn ko kr np kv nq kz nr ld ob nt nu nv bi translated">选择器是多个标签和级别的组合，起什么(过滤器)的作用。格式为<code class="fe mt mu mv mw b">tag1[+tag2...][*][=level][,...]</code></li><li id="b463" class="nn no it ki b kj nw kn nx kr ny kv nz kz oa ld ob nt nu nv bi translated">装饰者是与日志相关的描述信息，也可以理解为上下文</li><li id="4080" class="nn no it ki b kj nw kn nx kr ny kv nz kz oa ld ob nt nu nv bi translated">输出是一个与输出相关的选项。一般我们会配置成输出到一个文件，根据文件大小进行剪切。</li></ul><p id="53b5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里补充一个知识点，默认值:</p><ul class=""><li id="b90a" class="nn no it ki b kj kk kn ko kr np kv nq kz nr ld ob nt nu nv bi translated"><strong class="ki iu">标签</strong>:全部</li><li id="82eb" class="nn no it ki b kj nw kn nx kr ny kv nz kz oa ld ob nt nu nv bi translated"><strong class="ki iu">级别</strong>:信息</li><li id="4db1" class="nn no it ki b kj nw kn nx kr ny kv nz kz oa ld ob nt nu nv bi translated"><strong class="ki iu">输出</strong> :stdout</li><li id="098a" class="nn no it ki b kj nw kn nx kr ny kv nz kz oa ld ob nt nu nv bi translated">装饰者:正常运行时间，等级，标签</li></ul><h2 id="528a" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">2.6 GC参数迁移</h2><p id="19e7" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">可以看到Xlog下已经收集了GC相关的参数，Java8下很多之前的参数都被移除或者标记为过期。</p><p id="2124" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如<code class="fe mt mu mv mw b">PrintGCDetails</code>已经被<code class="fe mt mu mv mw b">-Xlog:gc*</code>替换为:</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="a67b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">标记为不推荐使用的常见参数有<code class="fe mt mu mv mw b">-XX:+PrintGC</code>和<code class="fe mt mu mv mw b">-Xloggc:&lt;filepath&gt;</code>。</p><p id="2373" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，大量的GC参数被移除，比如常用参数<code class="fe mt mu mv mw b">-XX:+PrintTenuringDistribution</code>，Java17会拒绝启动。</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="286b" class="mc lf it mw b gy nh ni l nj nk">java -XX:+PrintTenuringDistribution -version<br/>Unrecognized VM option 'PrintTenuringDistribution'<br/>Error: Could not create the Java Virtual Machine.<br/>Error: A fatal exception has occurred. Program will exit.</span></pre><p id="1e2d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">更详细的删除参数如下</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="1f0a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些被删除的参数中的大部分可以在新的日志系统中找到。例如，<code class="fe mt mu mv mw b">PrintHeapAtGC</code>这个参数可以用<code class="fe mt mu mv mw b">-Xlog:gc+heap=debug</code>来替换。</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="b972" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">看这部分源代码的变化就知道是这样的。在Java8中，<code class="fe mt mu mv mw b">PSYoungGen::resize_spaces</code>代码如下:</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oc"><img src="../Images/c6899dd4accc10797fc5d0d244d60a34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*INdHF40kWRaGeDBpqFRyCA.png"/></div></div></figure><p id="58c9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在Java17中，日志打印的这一部分被gc+ergo的标记log所取代:</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi od"><img src="../Images/941e0397bde2863b42d71a179305f8b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qNwT_J2-FEBdZmpud-0n5Q.png"/></div></div></figure><p id="d5e1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">世代GC <code class="fe mt mu mv mw b">-XX:+PrintTenuringDistribution</code>中还有一个非常有用的参数，现在<code class="fe mt mu mv mw b">gc+age=trace</code>被取代。</p><h2 id="b8b5" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">2.7参数迁移示例</h2><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="e850" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">变更后:</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="1ab5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">推荐配置</strong></p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h1 id="5833" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">3.运行相关</h1><h2 id="0cab" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">3.1反射+私有API调用伤害</h2><p id="5fe4" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在Java 8中，没有人能阻止你访问特定的包，比如sun.misc，反射也没有限制，只要setAccessible(true)就可以了。Java 9模块化后，一切都变了，<code class="fe mt mu mv mw b">--add-exports</code>和<code class="fe mt mu mv mw b">--add-opens</code>模块封装只能被突破和</p><ul class=""><li id="d401" class="nn no it ki b kj kk kn ko kr np kv nq kz nr ld ob nt nu nv bi translated"><code class="fe mt mu mv mw b">--add-opens</code>导出特定的包</li><li id="2b4d" class="nn no it ki b kj nw kn nx kr ny kv nz kz oa ld ob nt nu nv bi translated"><code class="fe mt mu mv mw b">--add-opens</code>允许类路径深度反射访问模块中的特定包</li></ul><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h2 id="bab4" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">3.2关于GC算法的选择</h2><p id="e5a9" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">CMS正式退出历史舞台，G1正式接手，ZGC蓄势待发。就GC算法的选择而言，G1仍然是目前最好的选择。由于ZGC的内存使用量被OS占用过高(是共享内存的三倍)的问题，进程可能会被OOM-killer杀死。</p><h2 id="f1dd" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">3.3 ZGC三重分辨率内存</h2><p id="983b" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">ZGC的底层使用了一种叫做彩色指针的技术，它使用三种视图(Marked0、Marked1和map)来映射到同一个共享内存区域。原理如下:</p><figure class="mx my mz na gt ju"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="4be3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以想象三个存储区域p1、p2和p3是ZGC的三个视图。</p><p id="0696" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但在Linux统计中，虽然是共享内存，但还是会被统计三次，比如RES。</p><p id="564a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">同样的应用，用G1 RES显示占用2G，ZGC显示占用6G</p><pre class="mx my mz na gt nd mw ne nf aw ng bi"><span id="743c" class="mc lf it mw b gy nh ni l nj nk">java -XX:+AlwaysPreTouch -Xms2G -Xmx2G -XX:+UseZGC MyTest<br/>java -XX:+AlwaysPreTouch -Xms2G -Xmx2G -XX:+UseG1GC MyTest                                                                                              </span></pre><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oe"><img src="../Images/9ad455b624e1123afe53dc0d99515cbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7a2KchXjyYQE-ANFHSij3Q.png"/></div></div></figure><p id="4db7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们下面讨论的是与G1有关的。</p><h2 id="23c4" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">3.4不配置年轻一代的规模</h2><p id="ba14" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这在《JVM G1源代码分析和调优》一书中有详细描述，主要有两个原因:</p><ul class=""><li id="82b4" class="nn no it ki b kj kk kn ko kr np kv nq kz nr ld ob nt nu nv bi translated">G1对内存的管理是不连续的，重新分配一个分区的成本非常低。</li><li id="492b" class="nn no it ki b kj nw kn nx kr ny kv nz kz oa ld ob nt nu nv bi translated">G1需要根据目标暂停时间动态调整收集的分区数量。如果新一代的尺寸无法调整，那么G1可能无法满足暂停时间的要求。</li></ul><p id="02a3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如<code class="fe mt mu mv mw b">-Xmn, -XX:NewSize, -XX:MaxNewSize, -XX:SurvivorRatio</code>不出现在G1，只需要控制最大最小堆和目标暂停时间。</p><h2 id="63cb" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">3.5将<code class="fe mt mu mv mw b">-XX:InitiatingHeapOccupancyPercent</code>调整到合适的值</h2><p id="d7ac" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">IHOP的默认值是45。该值是开始并发标记的先决条件。在老一代中，并发标记任务将仅在总存储器堆栈空间的45%之后开始。</p><p id="75c1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">增加这个值:并发标记可能需要更多的时间，同时YGC和Mixed-GC收集时的分区数量会减少，可以根据整体应用占用的平均内存来设置。</p><h1 id="9c05" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">最后</h1><p id="e619" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated"><strong class="ki iu">感谢阅读</strong>。期待您的关注，阅读更多高质量的文章。</p><div class="of og gp gr oh"><div role="button" tabindex="0" class="ab bv gv cb fp oi oj bn ok jz ex"><div class="ol l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw om on fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l om on fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----43358b30532a--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="oq or gw l"><h2 class="bd iu tv nn fp tw fr fs tx fu fw is bi translated">更好的编程</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi ty au tz ua ub qk uc an eh ei ud ue uf el em eo de bk ep" href="https://medium.com/@omgzui/list/better-programing-9b4c9bb174aa?source=post_page-----43358b30532a--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="ug l fo"><span class="bd b dl z dk">108 stories</span></div></div></div><div class="pd dh pe fp ab pf fo di"><div class="di ov bv ow ox"><div class="dh l"><img alt="" class="dh" src="../Images/3e6ce891363c151131c5993ca0dcc526.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7cAp-WibSblfO7hT"/></div></div><div class="di ov bv oy oz pa"><div class="dh l"><img alt="" class="dh" src="../Images/a7dd413de22f319a3c4729c9e737feb8.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*FcmHdVfoUOhlJlsG"/></div></div><div class="di bv pb pc pa"><div class="dh l"><img alt="" class="dh" src="../Images/3666e533060c4dc70c7e80f31bccbcba.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*V6I1dcf-gpxiYTjb"/></div></div></div></div></div><div class="of og gp gr oh"><div role="button" tabindex="0" class="ab bv gv cb fp oi oj bn ok jz ex"><div class="ol l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw om on fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l om on fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----43358b30532a--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="oq or gw l"><h2 class="bd iu tv nn fp tw fr fs tx fu fw is bi translated">Java 语言(一种计算机语言，尤用于创建网站)</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi ty au tz ua ub qk uc an eh ei ud ue uf el em eo de bk ep" href="https://medium.com/@omgzui/list/java-e7c93884d94b?source=post_page-----43358b30532a--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="ug l fo"><span class="bd b dl z dk">55 stories</span></div></div></div><div class="pd dh pe fp ab pf fo di"><div class="di ov bv ow ox"><div class="dh l"><img alt="" class="dh" src="../Images/3666e533060c4dc70c7e80f31bccbcba.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*V6I1dcf-gpxiYTjb"/></div></div><div class="di ov bv oy oz pa"><div class="dh l"><img alt="" class="dh" src="../Images/0dd5c9327f714baf2e445bfe821b8114.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*UsD4qh_ARNmOPhO96s5dvQ.png"/></div></div><div class="di bv pb pc pa"><div class="dh l"><img alt="" class="dh" src="../Images/9054376845be34a58a63fb815bb5d5b3.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*iohZiyQquP93nEL4X5h3ow.png"/></div></div></div></div></div><div class="of og gp gr oh"><div role="button" tabindex="0" class="ab bv gv cb fp oi oj bn ok jz ex"><div class="ol l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw om on fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l om on fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----43358b30532a--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="oq or gw l"><h2 class="bd iu tv nn fp tw fr fs tx fu fw is bi translated">新闻</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi ty au tz ua ub qk uc an eh ei ud ue uf el em eo de bk ep" href="https://medium.com/@omgzui/list/news-67ec0a972660?source=post_page-----43358b30532a--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="ug l fo"><span class="bd b dl z dk">23 stories</span></div></div></div><div class="pd dh pe fp ab pf fo di"><div class="di ov bv ow ox"><div class="dh l"><img alt="" class="dh" src="../Images/c3f36b36bf050f98fd5a8e3c89103cad.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*LISEmTdz19k7BAHY"/></div></div><div class="di ov bv oy oz pa"><div class="dh l"><img alt="" class="dh" src="../Images/8459df5aae62dc00f04377e09544be88.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*RvBGLw3V9JZfn_HO"/></div></div><div class="di bv pb pc pa"><div class="dh l"><img alt="" class="dh" src="../Images/2864058bcedc8c1cd6492624ba9671c6.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*IUWVb3zTn1_HKV9P"/></div></div></div></div></div></div></div>    
</body>
</html>