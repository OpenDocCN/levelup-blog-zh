<html>
<head>
<title>Track Builder: a single-page, multiplayer, JavaScript web application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Track Builder:一个单页、多人的JavaScript web应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/track-builder-a-single-page-multiplayer-javascript-web-application-bb5da2a25856?source=collection_archive---------13-----------------------#2021-02-21">https://levelup.gitconnected.com/track-builder-a-single-page-multiplayer-javascript-web-application-bb5da2a25856?source=collection_archive---------13-----------------------#2021-02-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="89bc" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated"><em class="km">如何使用WebSockets和普通JavaScript以及Rails创建多人游戏</em></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/e1c9789783b692f3e2fe4dfca793b448.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BV-HTkd6hPNAqQL1rFb70w.jpeg"/></div></div></figure><p id="926f" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">在我与FlatIron School的最新项目中，我开发了单页JavaScript web应用程序Track Builder。</p><p id="9fd3" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">在这个应用程序中，用户可以创建和查看赛道。当观看他们的时候，他们<em class="km">订阅</em>一个频道，其他用户也观看该频道，以便能够与他们比赛。</p><p id="a84e" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">您可以访问网站，在这里亲自测试一下<a class="ae kz" href="https://track-builder.netlify.app/" rel="noopener ugc nofollow" target="_blank">。请注意，在初始页面加载时，数据库可能需要一段时间来响应，因为它是在一个未付费的Heroku设置上运行的。</a></p><p id="8342" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">为了实现上述功能，我在后端使用了Rails的ActionCable来响应消息。为了在生产中实现这一点，我使用了Heroku的redis插件。</p><p id="4705" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">许多应用程序利用这种WebSocket功能，不仅用于游戏，还用于聊天频道或用其他用户所做的实时更改来更新用户。</p><p id="8423" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">这篇文章将为你提供在开发中设置ActionCable的所有必要工具，并且我还将提供我发现的处理游戏场景中延迟问题的最佳方法。</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h2 id="e6ef" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">入门指南</h2><p id="e3bb" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">我最初在Ruby 2.6.1上开发这个项目。然而，当将后端推送到Heroku进行托管时，他们的最新应用程序需要最新版本。所以，如果你打算用Heroku做主机，我建议你现在更新以避免这个问题。</p><p id="e2ce" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">此外，为了最容易地过渡到Heroku，请确保您的应用程序配置为使用Postgres数据库。</p><p id="8bf9" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">在本指南中，我假设您有一个用<code class="fe mf mg mh mi b">rails new your-app-name — api</code>命令启动的Rails API后端应用程序。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi mj"><img src="../Images/73b9e2afaf86ec6630c694b6ae4a885d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m5yNE9L8ginHYzq8c5HK8g.jpeg"/></div></div></figure><h2 id="169f" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">为WebSockets配置后端</h2><p id="7573" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">Rails处理WebSocket集成的内置类是ActionCable。当WebSockets被服务器接受时，一个连接对象被实例化，该对象成为创建的所有以下通道订阅的父对象。</p><p id="c621" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">ActionCable由ApplicationCable连接和Cable类组成。</p><p id="8f9d" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">ApplicationCable::Connection类可以访问与连接请求一起发送的cookies，这可以用来处理登录或验证用户。但是，对于Track Builder，这不是必需的。不需要逻辑来检查有效用户，我没有改变连接类。</p><p id="6508" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">Cable类的操作与所有控制器都将继承的ApplicationController类非常相似，因此我的TrackCable设置如下:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="3b21" class="lh li iq mi b gy mo mp l mq mr">class TrackChannel &lt; ApplicationCable::Channel</span><span id="42ee" class="lh li iq mi b gy ms mp l mq mr">    def subscribed<br/>        stream_from(params[:id])<br/>    end</span><span id="66c3" class="lh li iq mi b gy ms mp l mq mr">    def receive(data)<br/>        ActionCable.server.broadcast(params[:id], <strong class="mi ir">{</strong>content: data<strong class="mi ir">}</strong>)<br/>    end</span><span id="f826" class="lh li iq mi b gy ms mp l mq mr">    def unsubscribed<br/>        stop_all_streams<br/>    end</span><span id="08fd" class="lh li iq mi b gy ms mp l mq mr">end</span></pre><p id="8f2a" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated"><code class="fe mf mg mh mi b">subscribed</code>、<code class="fe mf mg mh mi b">receive</code>和<code class="fe mf mg mh mi b">unsubscribed</code>这三种方法对应于前端将要发送的消息中的命令。此消息中还包含构成可用参数的信息。</p><p id="5885" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">这里，<code class="fe mf mg mh mi b">subscribed</code>将在发送消费者(app用户)希望订阅的曲目id时响应命令‘subscribe’，<code class="fe mf mg mh mi b">stream_from</code>方法将为频道打开一条路由以广播信息。</p><p id="3b78" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated"><code class="fe mf mg mh mi b">stream_from</code>接受一个字符串作为流名的参数，我简单地使用了每个音轨的id。如果您愿意，并且您的应用程序有一个与流相对应的类，那么可以使用<code class="fe mf mg mh mi b">stream_for</code>，它接受一个模型实例，可以写成:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="3d33" class="lh li iq mi b gy mo mp l mq mr">track = Track.find(params[:id])<br/>stream_for track</span></pre><p id="5e97" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">打开流后，使用<code class="fe mf mg mh mi b">ActionCable.server.broadcast</code>在rails应用程序中传输数据，如<code class="fe mf mg mh mi b">receive</code>方法所示。<code class="fe mf mg mh mi b">broadcast</code>有两个参数，广播名称和内容。</p><p id="b159" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated"><strong class="jq ir">注意，</strong>在撰写本文时，ruby要求第二个参数放在大括号{}中，这与文档的写法相反。</p><p id="141b" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated"><code class="fe mf mg mh mi b">receive</code>响应“消息”命令，接受消息中发送的属性。</p><p id="5243" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">在我的应用程序中，只有当用户发送频道信息时，数据才会广播给频道的所有订阅者，但该命令可以在任何需要的地方使用。</p><p id="b104" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">控制器创建、更新和销毁动作中的其他例子。在这里，当数据更新时，广播将与所有订阅的消费者进行通信，而不需要页面更新。只要有足够的JavaScript来处理它。</p><p id="9b0c" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated"><code class="fe mf mg mh mi b">unsubscribed</code>方法响应“取消订阅”命令。然后它调用<code class="fe mf mg mh mi b">stop_all_streams</code>来取消用户订阅的所有广播。</p><p id="75ee" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">这些方法的文档可以在<a class="ae kz" href="https://guides.rubyonrails.org/action_cable_overview.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="60ba" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">有了这个配置，剩下唯一要做的事情就是将服务器安装到一个路由上，供您的前端参考。将以下内容添加到您的config/routes.rb文件中就可以了:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="4442" class="lh li iq mi b gy mo mp l mq mr">mount ActionCable.server =&gt; "/cable"</span></pre></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h2 id="327a" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">前端准备</h2><p id="d8f9" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">为了在我的前端发送和接收数据，用下面的代码实例化了一个普通的JavaScript WebSocket:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="5f99" class="lh li iq mi b gy mo mp l mq mr">const socket = new WebSocket(webSocket);</span></pre><p id="39d7" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">这引用了之前在端口常量旁边定义的常量“webSocket ”:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="e10a" class="lh li iq mi b gy mo mp l mq mr">const port = '<a class="ae kz" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank">http:</a>//localhost:3000';</span><span id="c239" class="lh li iq mi b gy ms mp l mq mr">const webSocket = 'ws<a class="ae kz" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank">:</a>//localhost:3000/cable';</span></pre><p id="142b" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">在WebSocket启动时，一个“握手”被发送到服务器以打开一个连接，服务器将从该连接做出响应。以下JavaScript代码可用于类似于事件监听器的行为:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="d8a5" class="lh li iq mi b gy mo mp l mq mr">socket.onopen = function(e) {</span><span id="2777" class="lh li iq mi b gy ms mp l mq mr">    // desired functionality here</span><span id="025e" class="lh li iq mi b gy ms mp l mq mr">}</span></pre><p id="c5ef" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">在这里可以打开任何通用的广播频道。</p><p id="6820" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">然而，在曲目生成器中，我只希望用户在查看曲目时订阅频道，所以我使用了以下代码:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="e4ad" class="lh li iq mi b gy mo mp l mq mr">function requestSubscribe() {</span><span id="68a4" class="lh li iq mi b gy ms mp l mq mr">    const message: {</span><span id="f60c" class="lh li iq mi b gy ms mp l mq mr">        command: "subscribe",</span><span id="5c5d" class="lh li iq mi b gy ms mp l mq mr">        identifier: JSON.stringify({<br/>            channel: "TrackChannel", id: currentTrack.id<br/>        })</span><span id="f1f3" class="lh li iq mi b gy ms mp l mq mr">    };</span><span id="63ad" class="lh li iq mi b gy ms mp l mq mr">    socket.send(JSON.stringify(message));</span><span id="3fd6" class="lh li iq mi b gy ms mp l mq mr">}</span></pre><p id="3590" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">如后端部分所述，这将触发TrackChannel的<code class="fe mf mg mh mi b">subscribed</code>方法，发送所需的曲目id作为参数。</p><p id="36d7" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">发送完全相同的消息，但是将命令切换为‘unsubscribe’将会触发<code class="fe mf mg mh mi b">unsubscribed</code>方法。</p><p id="311b" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">为了向服务器发送数据，数据的附加关键字被添加到消息散列中:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="526a" class="lh li iq mi b gy mo mp l mq mr">function updateCarLocation() {</span><span id="f28b" class="lh li iq mi b gy ms mp l mq mr">    const message = {</span><span id="e597" class="lh li iq mi b gy ms mp l mq mr">        command: "message",</span><span id="629a" class="lh li iq mi b gy ms mp l mq mr">        identifier: JSON.stringify({<br/>            channel: "TrackChannel", id: currentTrack.id<br/>        }),</span><span id="d8b5" class="lh li iq mi b gy ms mp l mq mr">        data: JSON.stringify(myCar)</span><span id="7efb" class="lh li iq mi b gy ms mp l mq mr">    };</span><span id="6594" class="lh li iq mi b gy ms mp l mq mr">    socket.send(JSON.stringify(message));</span><span id="a4fe" class="lh li iq mi b gy ms mp l mq mr">}</span></pre><p id="0e65" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">这将把关于用户汽车的信息发送到服务器，以便广播给订阅赛道频道的每个人。我将在下一节更详细地介绍汽车信息的组成。</p><p id="b22e" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">将数据发送到指定的服务器后，我们将使用<code class="fe mf mg mh mi b">onmessage</code>功能接收数据广播，如下所示:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="91e4" class="lh li iq mi b gy mo mp l mq mr">socket.onmessage = function(e) {</span><span id="7faa" class="lh li iq mi b gy ms mp l mq mr">    const data = JSON.parse(e.data);</span><span id="7e0d" class="lh li iq mi b gy ms mp l mq mr">    if (data.type === 'ping' || !data.message) return</span><span id="fe66" class="lh li iq mi b gy ms mp l mq mr">    const carData = data.message.content;</span><span id="1d04" class="lh li iq mi b gy ms mp l mq mr">    if (ip !== carData.ip) cars[carData.ip] = carData;</span><span id="894a" class="lh li iq mi b gy ms mp l mq mr">}</span></pre><p id="efc7" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">每当消息被广播到WebSocket订阅的通道时，都会触发此操作。这些包括不需要在此应用程序中执行的“pings ”,这是第一个if语句的原因。</p><p id="c5e0" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">隐式发送给该函数的参数是消息事件。事件的数据属性包含消息的有效负载；这将在您的Rails通道的<code class="fe mf mg mh mi b">receive</code>方法中设置。因此，我从消息中检索出了<code class="fe mf mg mh mi b">.content</code>。</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi mt"><img src="../Images/790cc89f6cb9443ebccc1565224d3ff4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H_qOBTCCgeFxACIC8vDMUQ.jpeg"/></div></div></figure><h2 id="d8f0" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">提高多人游戏环境性能的技巧</h2><p id="04e0" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">在这里，我分享一些我用来确保用户在这个应用程序中切换频道时体验流畅的技巧。如果您使用WebSockets来实现聊天功能，或者使用实时数据库更改来更新页面，那么可以跳过这一部分。</p><p id="4a36" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">如果您访问过该站点并检查过该页面，您会注意到动画是使用JavaScript canvas对象呈现的。为了做到这一点，使用了<code class="fe mf mg mh mi b">window.requestAnimationFrame()</code>函数，该函数在渲染后会调用自身。</p><p id="ca2d" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">这通常每秒发生60次左右。因此，我将它作为我的代码中调用之前定义的<code class="fe mf mg mh mi b">updateCarLocation()</code>的点。这意味着有非常定期的更新正在广播，以便每辆车的信息将被所有用户很好地维护。</p><p id="bf28" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">发送的数据包括汽车的位置、角度、颜色、用户的ip地址，以及汽车是否处于活动状态。这意味着当用户收到汽车信息时，他们可以比较ip地址，如果不是他们发送的信息，他们会将汽车添加到要在下一个动画帧中呈现的汽车对象中。</p><p id="6d65" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">虽然这种高更新率有助于保持频道中所有汽车的准确日期，但当用户切换频道时，它确实开始引起不必要的行为。这种不想要的行为是汽车不能被正确地从它离开的通道中移除(将其活动属性设置为false)。</p><p id="d73e" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">这是因为在发送了取消订阅频道的请求后，应用程序帧被渲染。为了解决这个问题，我添加了一个“ready”常量，在取消订阅后的30毫秒内该常量将被设置为false，因此不会有更新发送到之前的频道。</p><p id="2e6d" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">我还编写了代码，如果用户收到一条包含不活动汽车的消息，他们应该重置他们的汽车哈希，并在等待30毫秒后再次作为备份。</p><p id="9ad7" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">我添加的另一个安全措施是，不管人们是否切换频道，每个用户的cars hash都会每15秒重置一次。我已经试验过增加这个的频率，但是发现它开始在动画中引起闪烁。</p><p id="bb84" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">最后一点，为了在用户刷新浏览器或关闭标签页时删除用户，我在窗口中添加了一个事件监听器:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="1438" class="lh li iq mi b gy mo mp l mq mr">window.addEventListener('beforeunload', (event) =&gt; {</span><span id="9d36" class="lh li iq mi b gy ms mp l mq mr">    event.preventDefault();</span><span id="feba" class="lh li iq mi b gy ms mp l mq mr">    removeCar(channel);</span><span id="cde3" class="lh li iq mi b gy ms mp l mq mr">    unsubscribeFrom(channel);</span><span id="23b0" class="lh li iq mi b gy ms mp l mq mr">});</span></pre><p id="2351" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">其中<code class="fe mf mg mh mi b">removeCar()</code>将向通道发送汽车不活动的更新。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi mu"><img src="../Images/32c25cd288468602067db41de4167276.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xNk_IvHzh-KoqixSdTM1aQ.jpeg"/></div></div></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h2 id="be91" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">升级到生产</h2><p id="535f" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">随着应用程序现在在开发和测试，我们准备发布！在这一节中，您会发现许多文档链接，如果遇到任何错误，这些链接应该是您的第一个求助对象。</p><p id="00a6" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">我用他们的文档<a class="ae kz" href="https://devcenter.heroku.com/articles/getting-started-with-rails6" rel="noopener ugc nofollow" target="_blank">在这里</a>托管了Heroku的后端，按照他们的指示托管了Netlify的前端。</p><p id="ea24" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">从开发阶段转移到生产阶段后，您的代码将需要进行大量的更改。首先我们将从后端开始。</p><h2 id="b43d" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">后端- Heroku和redis</h2><p id="6baf" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">为了让Heroku正确运行您的后端服务器，必须在您的后端文件结构的根目录中添加一个Procfile。</p><p id="844f" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">如果你熟悉托管服务器，尤其是Sinatra，你可能已经使用了<em class="km">瘦</em>来运行服务器。然而，Thin不会在对WebSocket消息的响应中发送正确的头，因此应该使用<em class="km"> Puma </em>。您生成的配置文件应包含以下内容:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="de4d" class="lh li iq mi b gy mo mp l mq mr">web: bundle exec puma -C config/puma.rb</span><span id="7824" class="lh li iq mi b gy ms mp l mq mr">release: bundle exec rake db:migrate</span></pre><p id="f367" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">这依赖于用rails new初始化的项目，它将生成所需的puma.rb文件。</p><p id="2d58" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">为了让您的应用程序读取Procfile，领班gem应添加到您的gem文件中:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="64f6" class="lh li iq mi b gy mo mp l mq mr">gem 'foreman'</span></pre><p id="5ce1" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">随着从开发到生产的转变，ActionCable的适配器将从async升级到redis。</p><p id="05e2" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">我选择使用(并推荐)Heroku的免费redis插件，它可以在bash中用Heroku命令初始化:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="0abe" class="lh li iq mi b gy mo mp l mq mr">heroku addons:create heroku-redis:hobby-dev -a your-app-name</span></pre><p id="89e6" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">请注意，为了做到这一点，你需要附上一张银行卡到你的Heroku帐户。但是您可以通过在创建后输入以下命令来确认该附加组件是免费的:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="d88e" class="lh li iq mi b gy mo mp l mq mr">heroku addons:info your-app-name</span></pre><p id="4b75" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">Heroku的一个重要特性是，当附加组件完成时，一个新的配置变量将对您的后端可用，并且可以通过以下方式查看:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="c11d" class="lh li iq mi b gy mo mp l mq mr">heroku config | grep REDIS</span></pre><p id="2ee8" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">REDIS_URL在这里很重要，我们需要修改Rails的默认config/cable.yml文件，如下所示:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="6aa1" class="lh li iq mi b gy mo mp l mq mr">development:<br/>    adapter: async</span><span id="2132" class="lh li iq mi b gy ms mp l mq mr">test:<br/>    adapter: test</span><span id="d5db" class="lh li iq mi b gy ms mp l mq mr">production:<br/>    adapter: redis</span><span id="4a28" class="lh li iq mi b gy ms mp l mq mr">    <strong class="mi ir">url: &lt;%= ENV.fetch("REDIS_URL") %&gt;</strong></span><span id="921d" class="lh li iq mi b gy ms mp l mq mr">    channel_prefix: backend_track_builder_production</span></pre><p id="3f1c" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">以下gem也是gem文件中所必需的，并且应该可以作为Rails新命令的一部分注释掉:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="0aa1" class="lh li iq mi b gy mo mp l mq mr">gem 'redis', '~&gt; 4.0'</span></pre><p id="24b7" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">最后一个后端准备步骤是更新config/cors.rb文件，只接受来自前端的请求。在Netlify上完成托管后，请返回此处进行修改:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="8bda" class="lh li iq mi b gy mo mp l mq mr">Rails.application.config.middleware.insert_before 0, Rack::Cors do<br/>    allow do<br/>        <strong class="mi ir">origins 'https://your-app-name.netlify.app'</strong></span><span id="4005" class="lh li iq mi b gy ms mp l mq mr">        resource '*',</span><span id="a32a" class="lh li iq mi b gy ms mp l mq mr">        headers: :any,<br/>        methods: [<br/>            :get, :post, :put, :patch, :delete, :options, :head<br/>        ]<br/>    end<br/>end</span></pre><h2 id="2512" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated"><strong class="ak">前端网络功能</strong></h2><p id="ce9f" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">随着后端的运行，前端所需的唯一变化是更新您的端口和websocket变量，以反映您的Heroku url:</p><pre class="ko kp kq kr gt mk mi ml mm aw mn bi"><span id="0308" class="lh li iq mi b gy mo mp l mq mr">const port = 'https://your-app-name.herokuapp.com';</span><span id="6213" class="lh li iq mi b gy ms mp l mq mr">const webSocket = '<strong class="mi ir">wss</strong>://your-app-name.herokuapp.com/cable';</span></pre><p id="2588" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">注意这里<strong class="jq ir"> wss </strong>的重要性。开发中的<strong class="jq ir"> ws </strong>与本地主机配合得非常好；然而，生产中需要安全连接。</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi mv"><img src="../Images/5f580aa0c2088891c04b4e8b711d6c5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hzJRzBFyhqZBsfu9Nt2ncg.jpeg"/></div></div></figure><h2 id="b770" class="lh li iq bd lj lk ll dn lm ln lo dp lp jz lq lr ls kd lt lu lv kh lw lx ly lz bi translated">越过这条线</h2><p id="4f58" class="pw-post-body-paragraph jo jp iq jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ij bi translated">遵循本指南后，您应该在生产中拥有一个完全可操作的应用程序！利用ActionCable和redis，并提供向您的前端发送实时更新的通道。</p><p id="d06a" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">我希望读完这篇文章后，你不会像我一样遇到控制台错误，并且有了这些额外的知识，你能够进一步提高你的Javascript和Rails技能。</p><p id="701c" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">所有的代码都可以在我的github <a class="ae kz" href="https://github.com/Shilcof/frontend-track-builder" rel="noopener ugc nofollow" target="_blank">前端</a>和<a class="ae kz" href="https://github.com/Shilcof/backend-track-builder" rel="noopener ugc nofollow" target="_blank">后端</a>中找到。</p><p id="74e9" class="pw-post-body-paragraph jo jp iq jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ij bi translated">请务必让我知道你是如何使用自己的应用程序的，并在休息时间建立一条赛道，挑战你的朋友完成最快圈速！</p></div></div>    
</body>
</html>