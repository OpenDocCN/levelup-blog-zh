# 寻找所有合法的棋步

> 原文：<https://levelup.gitconnected.com/finding-all-legal-chess-moves-2cb872d05bc6>

## 基本移动和捕获，发现检查，城堡，顺道，和促销

![](img/52bd804369cbb4cc53082074c0d8ab75.png)

象棋，作者图片。

国际象棋经历了 2020 年的[大规模繁荣。很多在封锁期间被困在家里的人选择了在线国际象棋作为消遣，在网飞发布了他们令人惊叹的节目](https://medium.com/super-jump/the-2020-chess-boom-992427704a28)[女王的策略](https://medium.com/fan-fare/the-queens-gambit-the-price-of-genius-fcd5d161ec90)后，更多的人对这款游戏感兴趣。

看完节目后，我也重新发现了自己对象棋的热爱。虽然我已经玩了一会儿，做了很多拼图，但这让我对开发自己的象棋引擎产生了兴趣。我最初的项目之一，当我在学习 C++的时候，是开发一个象棋 AI。不幸的是，它从来没有好到能在一场比赛中打败我。

作为一个新的挑战，我想创造一个足够强大的国际象棋人工智能来击败我，乐观地说，一个普通的国际象棋选手。第一步是找到一个位置上所有合法的棋步。虽然棋子的基本移动模式非常简单，但在执行国际象棋规则时，我们必须考虑许多特殊情况。

# 可能的行动

找到所有合法移动的第一步是找到所有可能的移动，这样我们就可以在以后删除非法移动。根据基本的国际象棋走法，可能的走法是一个棋子可以走到的所有方格。

骑士和国王是最容易的。他们都有 8 个可以去的方格，跳给骑士，所有相邻的方格给国王。如果目标方块在界内，并且没有被相同颜色的方块覆盖，这是一个可能的移动。

滑动棋子(车、象、后)要求循环走直线或对角线，当它在界外，被相同颜色的棋子覆盖，或在有敌人棋子的方块后停止。

棋子可能是游戏中最基本的棋子，但它们是拥有最特殊规则的棋子。如果是空的，他们总是可以向前移动一格。如果一个向前的方格和一个向旁边的方格被敌人的棋子覆盖，他们也可以占领这些方格。如果棋子在起始位置，它也可以选择往前走两格。最后，如果满足某些条件，他们有可能顺便获得晋升，并在达到最终级别时晋升，稍后会详细介绍。

所有可能的棋子移动，完整的源代码在底部。

# 威胁地图

象棋最基本的规则是不能俘虏国王。因此，我们需要一种方法来防止国王移动到受到其他颜色攻击的方块中。为此，我们使用威胁地图。威胁地图记录了哪些方格受到了至少一枚棋子的攻击。这也包括由至少一个其他棋子保护的相同颜色的棋子。

创建威胁地图非常类似于计算所有可能的移动，除了我们还包括被一块相同颜色覆盖的方块，以说明被防御的方块。唯一不同的是棋子，因为他们有不同的移动和捕捉规则。对于卒，我们只占领方格，这意味着卒前面的方格对敌方国王来说是安全的。

每次移动后都会计算威胁地图，因此我们总是有最新的威胁地图用于移动计算。

![](img/7560decfee161f164253216d52bf725a.png)

黑棋的威胁地图，所有被至少一个黑棋攻击或防守的方格，图片由作者提供。

# 移除非法移动

一旦我们有了所有可能行动的清单，我们就必须排除非法行动。如果移动后会让国王受到牵制，那么这种移动就是非法的。首先，我们可以对国王的移动增加额外的检查，只允许他移动到根据威胁地图没有受到威胁的方格。

被发现的过牌(移动一个最终会被国王过牌的棋子)要过滤掉就有点烦人了。对于每一个可能的移动，我们必须暂时移动，检查国王是否在检查中，并再次撤消移动。当国王将在检查，移动是非法的，我们可以删除它。在回合开始时，国王是否过牌也无关紧要，因为只有阻挡过牌或把国王移到安全位置的棋才被允许。

# 将死

一旦我们有了合法行动的列表，将死的计算就非常容易了。如果没有合法的移动并且国王在检查中，它是另一种颜色的将死。如果没有合法的移动，国王也不在检查，这是一个僵局或平局。

![](img/0381887072029f6794d0d170c84eddb7.png)

只有阻挡检查或移动国王的移动是允许的，由作者图像。

# 特殊动作

## 城堡

王车易位是国际象棋中的一种特殊走法，国王和车交换位置，国王移动到一个更安全的位置。只有在满足某些条件时才允许。国王和车之间的所有方格必须是空的，国王不能被检查，不能在检查中结束，甚至不能穿过检查过的方格。我们可以利用当前的董事会位置和威胁图轻松测试这些条件。

然而，只有当国王和车都没有移动的时候才允许王车易位。因此，我们需要添加一些布尔值来跟踪它们的运动。一旦国王或车第一次移动，我们将它们设置为真，并且不再选择用那块车阉割。

## 顺带一提

顺便提一下，捕捉是国际象棋中最难懂的规则。它们是一种特殊的棋子移动，只有当棋子在第五级时才会发生。如果相邻格中的敌方棋子向前移动了两格，则在下一回合中，即使敌方棋子不在目标格中，也只有该棋子可以选择对角向前移动一格并捕获敌方棋子。

要实现 en passants，我们还需要添加几个布尔值，每个棋子一个，当棋子移动两格时，布尔值被设置为 true。在对手的下一个回合，我们可以检查布尔，当它和所有其他条件都满足时，我们可以添加顺路作为一个可能的移动。因为途中只能走一步，所以布尔在该颜色的下一回合开始时被重置。

## 促销

最后的特别举措是[促销](https://en.wikipedia.org/wiki/Promotion_(chess))。如果一个棋子达到了它的最终等级，它可以晋升到另一个棋子，这几乎在所有情况下都是皇后。目前，只有女王级的晋升是可能的，因为这是最容易实现的。如果一个兵在移动后最终在最后一级，就用一个皇后代替它。这相当于每个国际象棋网站上的自动皇后选项，但我将不得不在未来添加对其他棋子促销的支持。

![](img/617924c18a82313998311c527013e8fe.png)

“人工智能”玩随机合法的举动对自己不利，图片由作者提供。

找到所有合法的棋步比听起来稍微复杂一些。虽然我们大多数人都熟悉棋子的基本移动模式，但合法移动还需要一些额外的条件，最重要的是，不能以国王被控制而告终。其他特殊情况，如阉割或顺便捕获需要更多的边缘情况。

然而，找到所有合法走法的好算法是创建象棋引擎的基础。当进行指数树搜索时，在最早的机会消除非法移动将节省大量时间。

开发国际象棋引擎结合了我对编程的热爱和我对国际象棋重新发现的兴趣，虽然我不想参加下一届计算机国际象棋锦标赛，但无论如何，创建一个足够强大的国际象棋引擎来击败我都是一个不错的挑战。

# 资源

*   [Board.hpp](https://gist.github.com/pingpoli/0fae457637476db69dda95ef08b91eb6) ， [Board.cpp](https://gist.github.com/pingpoli/dab1a4ace22a2c01f9bd54d89d05c5db)
*   [ThreatMap.hpp](https://gist.github.com/pingpoli/4093422041237dbe836061797ee22055) ， [ThreatMap.cpp](https://gist.github.com/pingpoli/1d7e0d4cef2090fd1e396bd4c60c70bd)
*   [象棋规则](https://en.wikipedia.org/wiki/Rules_of_chess)
*   [象棋编程](https://www.chessprogramming.org/Main_Page)