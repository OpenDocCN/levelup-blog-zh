<html>
<head>
<title>How to Add Google Logger to Scrapy in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Python中给Scrapy添加Google Logger</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-add-google-logger-to-scrapy-in-python-87308156495c?source=collection_archive---------10-----------------------#2022-10-03">https://levelup.gitconnected.com/how-to-add-google-logger-to-scrapy-in-python-87308156495c?source=collection_archive---------10-----------------------#2022-10-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0dfb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过谷歌日志，学会更好地利用你的抓取日志</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/86c5c7efa029586f5c51b744ad0d0a4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PtkuEP1JB-7sKFbE.jpg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://pixabay.com/illustrations/cloud-computer-hosting-3406627/" rel="noopener ugc nofollow" target="_blank">图片由Pixabay的kreatikar拍摄</a></figcaption></figure><p id="245a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用日志记录保存抓取项目的记录很重要，这样我们可以知道哪些蜘蛛工作正常，哪些不正常。将日志写到一些文件中并在稍后尝试分析纯文本是很麻烦的。更好的方法是将日志发送到云端，比如Google Logging。通过这种方式，我们可以集中控制日志，并可以基于日志创建强大的监控指标，然后可以在Grafana等可视化应用程序中使用这些指标。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="b8f3" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">Python中的基本日志记录</h2><p id="3a70" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">Python中的<a class="ae ky" href="https://lynn-kwong.medium.com/stop-using-print-in-your-python-code-for-logging-use-the-logging-module-like-a-pro-66fb0427d636" rel="noopener">登录</a>是通过内置的<em class="na">登录</em>模块进行的。我们可以直接使用root logger用<em class="na"> logging </em>模块来记录日志。但是，建议先创建一个日志程序，然后用它来记录日志。这样，不同应用程序或模块的日志可以通过记录器名称来区分。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="efae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于这个简单的例子，有几点需要注意:</p><ul class=""><li id="00d5" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">使用自定义记录器名称创建记录器，该名称可以是您的应用程序名称，也可以只是模块名称。</li><li id="f7de" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">创建一个流处理程序并将其添加到记录器中。这似乎是多余的，因为默认情况下，日志记录会记录到控制台。然而，默认情况下，日志被发送到<em class="na"> sys.stderr </em>。在本例中，它被更改为<em class="na"> sys.stdout </em>，这在某些情况下可能是首选。</li><li id="f6a0" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">我们需要分别为日志记录器和处理程序设置一个级别。特别是，记录器的默认级别是<em class="na">警告</em>。它应该设置为与处理程序的相同或更低，以便可以将日志发送到处理程序。</li></ul><p id="1056" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要了解更多关于Python中的基本日志记录，请查看<a class="ae ky" href="https://lynn-kwong.medium.com/stop-using-print-in-your-python-code-for-logging-use-the-logging-module-like-a-pro-66fb0427d636" rel="noopener">这篇文章</a>。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="04e1" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">用Python写日志到Google云日志</h2><p id="d84b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">除了使用日志模块记录到控制台或文件，我们还可以在Python应用程序中<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-write-logs-to-google-cloud-logging-in-python-46e7b514c60b">将日志写到Google Cloud Logging </a>。通过这种方式，我们可以集中控制日志，并基于日志创建强大的监控指标，然后在可视化应用程序中使用，如<a class="ae ky" href="https://lynn-kwong.medium.com/how-to-visualize-google-logs-in-grafana-54cb18efe454" rel="noopener"> Grafana </a>。</p><p id="c2f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用Python向Google Logging发送日志，需要安装相应的客户端库<a class="ae ky" href="https://pypi.org/project/google-cloud-logging/" rel="noopener ugc nofollow" target="_blank"><em class="na">Google-cloud-Logging</em></a>。建议在<a class="ae ky" href="https://lynn-kwong.medium.com/how-to-create-virtual-environments-with-venv-and-conda-in-python-31814c0a8ec2" rel="noopener">虚拟环境</a>中安装第三方库，这样它们就不会影响系统库:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="2389" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们实际向Google Logging发送日志之前，我们应该获得一个服务帐户密钥，它将用于验证上面安装的客户端库。如果需要，请查看<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-set-up-your-local-environment-to-work-with-gcp-4ed0a11421ef">这篇文章</a>了解如何在本地设置您的GCP环境，以及<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-write-logs-to-google-cloud-logging-in-python-46e7b514c60b">这篇文章</a>了解如何创建服务帐户以及如何获取其密钥。</p><p id="2693" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦下载了服务帐户的密钥，我们需要将它的路径设置为神奇的GCP环境变量<code class="fe nr ns nt nu b">GOOGLE_APPLICATION_CREDENTIALS</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="1493" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以在Python应用程序中向Google Logging写入日志:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="2a7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面代码片段的要点:</p><ul class=""><li id="ddac" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">这里我们不需要验证客户端，因为神奇的GCP环境变量<code class="fe nr ns nt nu b">GOOGLE_APPLICATION_CREDENTIALS</code>被设置为使用服务帐户密钥。</li><li id="b46f" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">使用<code class="fe nr ns nt nu b">setup_logging()</code>方法，默认的Stackdriver日志处理程序被附加到根日志记录器。现在，当我们使用本机日志模块记录任何内容时，无论有没有自定义日志记录器，日志都将被发送到Google Logging <strong class="lb iu"> <em class="na">以及</em> </strong>。请注意，日志也将打印在屏幕上，因为默认的流处理程序不受影响。</li><li id="feee" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">我们可以创建一个定制的Google Logger，分别用<code class="fe nr ns nt nu b">log_text()</code>记录纯文本，用<code class="fe nr ns nt nu b">log_struct()</code>记录结构化的JSON数据。</li></ul><p id="c651" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当上面的代码运行时，我们可以在GCP控制台的日志浏览器中检查日志:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/2e26ab385a8645fe4b817ab22687ad41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s0QpoXSsCXe8OFPRnOUXLg.png"/></div></div></figure><p id="5bc4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请查看<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-write-logs-to-google-cloud-logging-in-python-46e7b514c60b">这篇文章</a>了解如何更详细地将日志写入谷歌日志，以及<a class="ae ky" href="https://lynn-kwong.medium.com/how-to-visualize-google-logs-in-grafana-54cb18efe454" rel="noopener">这篇文章</a>了解如何为谷歌日志创建监控仪表板，以便随时关注您的应用程序。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="0d6e" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">发送零碎日志到谷歌日志</h2><p id="43bc" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">现在我们知道了如何将日志发送到Google Logging，让我们看看如何将Scrapy日志写到Google Logging，这可能有点挑战性，因为我们需要了解Scrapy中的日志是如何工作的。</p><p id="ce46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用在以下两篇文章中使用的相同的简单Scrapy项目:</p><ul class=""><li id="f6bd" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-build-a-scraping-project-with-scrapy-and-mongodb-46e78b6549e3">如何用Scrapy和MongoDB构建一个抓取项目</a></li><li id="9ee5" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-run-scrapy-spiders-in-your-program-7db56792c1f7">如何在你的Python程序中运行Scrapy spider</a></li></ul><p id="68ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你是Scrapy新手，建议查看这两个帖子。</p><p id="e792" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常情况下，我们会在<code class="fe nr ns nt nu b"><a class="ae ky" href="https://github.com/lynnkwong/scrapy-google-logger/blob/main/scraping_proj/settings.py" rel="noopener ugc nofollow" target="_blank">&lt;project-folder&gt;/settings.py</a></code>文件中为一个零散的项目设置一些项目级的设置，比如<code class="fe nr ns nt nu b">LOG_LEVEL</code>、<code class="fe nr ns nt nu b">LOG_FORMAT</code>、<code class="fe nr ns nt nu b">LOG_FILE</code>等。为了访问蜘蛛的这些设置，我们需要使用<code class="fe nr ns nt nu b">from_crawler</code> <a class="ae ky" href="https://betterprogramming.pub/how-to-use-the-magical-staticmethod-classmethod-and-property-decorators-in-python-e42dd74e51e7" rel="noopener ugc nofollow" target="_blank">类方法</a>。此外，为了使代码可重用，我们创建了一个新的基础蜘蛛，它可以被其他蜘蛛继承，因此不需要为每个蜘蛛重复设置日志设置。请检查下面的代码和注释。之后会有解释。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="631d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面代码片段的要点:</p><ul class=""><li id="3f4c" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">因为我们需要访问<code class="fe nr ns nt nu b">settings.py</code>中的<code class="fe nr ns nt nu b">LOG_LEVEL</code>变量。我们需要使用<code class="fe nr ns nt nu b">from_crawler</code>,因为这是在创建蜘蛛之前访问项目设置的唯一方法。</li><li id="52e4" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">用<code class="fe nr ns nt nu b">from_crawler</code>创建的蜘蛛是将要运行的最终蜘蛛，我们可以在这里访问项目设置。</li><li id="c5e7" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">Google日志处理程序是以上面演示的相同方式创建的，并被添加到一个自定义日志记录器中，以蜘蛛的名字作为名称。如果你想知道为什么我们可以用这种方式设置蜘蛛记录器，Scrapy的<a class="ae ky" href="https://github.com/scrapy/scrapy/blob/731f2d30851762443cc288a1dfaf25b431b4b680/scrapy/spiders/__init__.py#L32-L44" rel="noopener ugc nofollow" target="_blank">源代码</a>会很有帮助。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="6e5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你不清楚<code class="fe nr ns nt nu b">@propery</code>装饰器是如何工作的，在这里查看<a class="ae ky" href="https://betterprogramming.pub/how-to-use-the-magical-staticmethod-classmethod-and-property-decorators-in-python-e42dd74e51e7" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="977c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过在<code class="fe nr ns nt nu b">BaseSpider</code>中正确设置Google日志，我们可以将它添加到自定义蜘蛛中，这样它们就可以继承日志设置:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="f43c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们运行蜘蛛并检查谷歌日志浏览器中的日志:</p><pre class="kj kk kl km gt nw nu nx ny aw nz bi"><span id="ec25" class="mc md it nu b gy oa ob l oc od">$ <strong class="nu iu">scrapy crawl authors</strong></span></pre><p id="a68b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此处提醒！为了确保蜘蛛能够成功运行，并且日志能够成功发送到Google日志，您应该确保:</p><ul class=""><li id="ffc8" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">环境变量<code class="fe nr ns nt nu b">GOOGLE_APPLICATION_CREDENTIALS</code>被设置为指向服务帐户密钥文件。</li><li id="d655" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">该命令在安装了Scrapy和Google日志客户端库的虚拟环境中运行。</li></ul><p id="800c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当蜘蛛完成抓取时，我们可以在谷歌日志浏览器中查看日志:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/e9201b5e29b10c7666e267dc14bce544.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NOttmgaNBmmN2RbzVGK9SQ.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="cd9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">干杯！我们已经成功地设置了我们的蜘蛛来发送日志到谷歌日志。您可以将任何对您的项目有价值的信息发送到Google Logging。在谷歌日志中有抓取日志有助于分析。您可以对日志进行集中控制，并可以创建日志监控仪表板来密切关注清理作业。</p><p id="85f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Scrapy项目的代码可以在<a class="ae ky" href="https://github.com/lynnkwong/scrapy-google-logger" rel="noopener ugc nofollow" target="_blank">这个GitHub repo </a>中找到。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="a6ed" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">相关文章:</h2><ul class=""><li id="4725" class="nd ne it lb b lc mv lf mw li of lm og lq oh lu ni nj nk nl bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-write-logs-to-google-cloud-logging-in-python-46e7b514c60b">如何用Python写日志到Google云日志</a></li><li id="3e76" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated"><a class="ae ky" href="https://lynn-kwong.medium.com/how-to-visualize-google-logs-in-grafana-54cb18efe454" rel="noopener">如何用Grafana可视化谷歌日志</a></li></ul></div></div>    
</body>
</html>