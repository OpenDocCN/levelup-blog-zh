<html>
<head>
<title>Don’t Accept the Defaults! How to Reduce Costs with Google App Engine Autoscaling</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不要接受默认值！如何通过谷歌应用引擎自动缩放降低成本</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/dont-accept-the-defaults-how-to-reduce-costs-with-google-app-engine-autoscaling-316af4804a01?source=collection_archive---------1-----------------------#2020-07-03">https://levelup.gitconnected.com/dont-accept-the-defaults-how-to-reduce-costs-with-google-app-engine-autoscaling-316af4804a01?source=collection_archive---------1-----------------------#2020-07-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c286" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">谷歌应用引擎(GAE)和AWS Lambda等无服务器技术是基于云的软件系统的强大平台。无服务器平台易于部署和管理，这使得它们成为许多组织将其工作负载迁移到云的一个极具吸引力的选择。</p><p id="9d75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">无服务器平台还有另一个吸引人的特性——它们能够随着请求负载的增长自动扩展服务。这种<em class="kl">自动扩展</em>功能的具体运作方式取决于云平台。月底你会收到账单。</p><p id="6df9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在云可伸缩性系列的<a class="ae km" href="https://medium.com/@i.gorton/scalability-and-cost-analysis-for-cloud-based-software-systems-part-1-472012435b26" rel="noopener">第一篇文章中，我们展示了无服务器平台(GAE)的编程语言选择如何对性能产生重大影响，并可以导致成本降低4倍以实现基线吞吐量。在接下来的工作中，我们将在GAE上试验自动缩放参数。结果显示了如何通过修改默认值来匹配服务的工作负载，从而以更低的成本获得更高的性能。</a></p><p id="18a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者，在与默认GAE平台设置几乎相同的性能下，您可以实现近50%的成本降低。随着系统的扩展，50%的成本降低可能是一大笔钱。</p><p id="81f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该系列的第一篇文章详细解释了我们的总体目标和实验方法，因此我们在此不再赘述。让我们深入了解一下自动扩展如何在GAE上工作，并解释我们可以修改哪些参数来影响工作负载的管理方式。</p><h1 id="763a" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">谷歌应用引擎自动缩放</h1><p id="f9c9" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">自动缩放是您在app.yaml文件中指定的一个选项，该文件在您上传服务器代码时被传递给GAE。自动缩放的应用程序由GAE根据一组默认参数值进行管理，您可以在app.yaml中覆盖这些参数值。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi lq"><img src="../Images/f23b5e4a587aca3f991508610f2a17fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/format:webp/1*S1PuK7DN1aHihwNt-aEkoQ.png"/></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">图1 GAE天文尺度</figcaption></figure><p id="2a9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">GAE根据传入的流量负载管理应用程序部署的服务器实例数量。如果没有传入的请求，那么GAE将不会安排任何实例，您将无需支付任何费用。当请求到达时，GAE部署一个实例来处理请求。</p><p id="0dd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署一个实例可能需要大约500毫秒到几秒钟<a class="ae km" href="https://medium.com/dev-genius/scalability-and-cost-analysis-for-cloud-based-software-systems-part-1-472012435b26" rel="noopener">，这取决于您使用的编程语言</a>。这意味着如果没有常驻实例，延迟可能会很高。为了减轻实例加载延迟的影响，可以指定可用于处理请求的最小实例数。这当然要花钱。</p><p id="5ff4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">随着请求负载的增长，GAE调度程序将动态加载更多的实例来处理请求。有三个参数可以精确控制这种操作方式。这些是:</p><p id="d63a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">目标CPU利用率</strong>:设置CPU利用率阈值，超过该阈值将启动更多实例来处理请求。范围是0.5 (50%)到0.95 (95%)。如果您什么都不做，您将得到默认值0.6 (60%)。</p><p id="9eb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">最大并发请求数:</strong>设置在调度程序生成新实例之前，一个实例可以接受的最大并发请求数。默认值为10，最大值为80。文档没有说明允许的最小值，但是可以推测，1将定义一个单线程服务。</p><p id="913b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">目标吞吐量利用率:</strong>它与为最大并发请求指定的值一起使用，以指定何时启动新实例。范围是0.5 (50%)到0.95 (95%)。默认值为0.6 (60%)。它是这样工作的——当一个实例的并发请求数达到最大并发请求数乘以目标吞吐量利用率的值时，调度程序会尝试启动一个新的实例。</p><p id="e113" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">明白了吗？😊</p><p id="108d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，默认情况下，在创建新实例之前，一个实例将处理10 x 0.6 = 6个并发请求。如果这6个(或更少)请求导致一个实例的CPU利用率超过60%，调度程序也会尝试创建一个新实例。</p><p id="1a57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">反正我觉得。</p><p id="7305" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是等等，还有呢！</p><p id="8d4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以指定值来控制GAE何时根据请求在请求待定队列中等待分派给实例进行处理的时间间隔来扩展实例。这个<em class="kl">最大挂起延迟</em>参数是在启动额外的实例来处理请求和减少整体延迟之前，GAE应该允许请求在挂起队列中等待的最长时间。默认值为30毫秒。该值越低，应用程序向上扩展的速度就越快。你可能会花更多的钱。</p><p id="b0dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有一个<em class="kl">最小挂起延迟</em>参数，默认值为零。如果你很勇敢，最小值和最大值如何一起工作在这里解释<a class="ae km" href="https://cloud.google.com/appengine/docs/standard/python/config/appref#scaling_elements" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="ae44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些自动缩放参数设置使我们能够微调服务的行为，以平衡性能和成本。这很好，不是吗？</p><p id="54bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于GAE软件架构师来说，问题很简单，你如何选择参数值？你从哪里开始？可能的设置组合很多。您如何知道您的参数值尽可能地服务于您的用户和您的预算？在这个视频中有一些来自Google <a class="ae km" href="https://www.youtube.com/watch?v=eUXUY7QFfAI" rel="noopener ugc nofollow" target="_blank">的好的一般性建议，但是你仍然面临为你的应用选择精确参数值的问题。</a></p><p id="d4ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，让我们只考虑三个可用的参数，如表1所示。一个应用程序实际上有45x45x80种可能的配置。如果您想知道，这是162K的配置。我想我不想知道。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/d8be1fafcf840a809594d21847c2f57f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*tJAoENhwGwUaUg_MJ2RrHg.png"/></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">表1自动缩放参数</figcaption></figure><p id="064c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">即使我们将10作为最大并发请求的实际最小值，我们仍然有超过141K的配置。如果我们非常实际地考虑吞吐量和CPU利用率的增量值为0.05，最大并发请求的增量值为10，那么我们最终会得到648种可能的配置。这仍然是不切实际的，特别是当我们真的不知道我们的服务对任何参数值有多敏感的时候。</p><p id="a719" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，我们如何有效地获得一些关于如何调整我们的应用程序以进行扩展的见解呢？</p><p id="f7ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请继续阅读…</p><h1 id="7d64" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">GAE自动缩放参数研究</h1><p id="f78e" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">简而言之，我们有一个棘手的问题需要探索。我们可以调整多种配置设置。任何改变将如何精确地影响我们系统的成本和吞吐量基本上是未知的？更棘手的是，这些设置并不是独立的——改变一个设置会影响其他设置对性能和成本的影响</p><p id="7c77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，我们能做什么呢？</p><p id="b52e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">调整系统性价比的一种方法是进行参数研究。也称为参数研究，该方法允许您指定评估参数，定义参数范围，指定设计约束，并分析每个参数变化的结果。</p><p id="2437" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们为GAE应用程序定义这样一个研究。</p><p id="3f6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一步是选择一个或多个配置参数，并为每个参数分配一个可能值的列表。通常最好从参数化地处理少量设置开始。在研究了它们的结果之后，您可能会添加另一个配置参数，或者用一个可能具有更显著效果的参数来替换一个影响不大的参数。一起改变三个或四个以上的参数很少有帮助。</p><p id="12b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文展示的参数研究中，我们探讨了改变CPU利用率和最大并发请求参数值的影响。我们为CPU利用率选择三个值，即{0.6，0.7。0.8}，分别从默认的60%到80%不等。对于每个实例的最大并发请求数，我们选择4个值，即{10，35，60，80}，默认值为10，最大值为80，如表2所示。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi md"><img src="../Images/5ba052248cd15ec6bf6ba9e142814a11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*adCVTmMVFnNakn1dt_ktLA.png"/></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">表2参数研究选定值</figcaption></figure><p id="35a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这为GAE应用程序定义了12种不同的配置。这些使我们能够探索每个参数值的范围，并分析它们如何相互作用。</p><p id="cb0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了量化这些参数变化导致的性能和成本差异，我们对我们上一篇文章中<a class="ae km" href="https://medium.com/dev-genius/scalability-and-cost-analysis-for-cloud-based-software-systems-part-1-472012435b26" rel="noopener">描述的Go GAE服务器进行了一系列测试。我们针对每个服务器配置运行了512个并发客户端请求的最大负载，并记录了每个测试的吞吐量、延迟和成本指标。每个测试至少运行3次，以获得一致的测量结果，同样遵循这里</a><a class="ae km" href="https://medium.com/dev-genius/scalability-and-cost-analysis-for-cloud-based-software-systems-part-1-472012435b26" rel="noopener">描述的方法</a>。</p><p id="7123" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在是有趣的部分——结果！</p><h1 id="b9be" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">实验结果</h1><p id="ded3" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">探索参数研究结果的一种简便方法是为感兴趣的给定指标绘制响应面。例如，图2描绘了每个测试配置的平均响应时间。我们可以看到，当最大并发请求值位于参数值范围的低端时，平均吞吐量最高。它对CPU利用率设置值也不敏感。随着最大并发请求值的增加，在最坏的情况下，平均吞吐量下降了大约9%。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi me"><img src="../Images/e5451a25636b3a554411d02ccfa90f28.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*9vJE8zE8jMQoeFmi1gsRxg.png"/></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">图2所有测试配置的平均响应时间</figcaption></figure><p id="1be8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们比较一下每个配置的成本，这是由GAE执行每个测试收取的实例小时数来衡量的。图3绘制了一个响应面，显示当一个实例的并发性设置为10时，会产生更高的成本。随着并发级别的提高，成本降低了近50%,而且似乎对CPU利用率相对不敏感。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/726ea035e59ebaec8893353f48e3b12b.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*-O1sRME6JI8VfhjZahqEyg.png"/></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">图3所有测试配置的实例小时成本</figcaption></figure><p id="a315" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">响应面对于比较结果的总体<em class="kl">形状</em>非常有用，可以识别结果中的波峰和波谷，在这些地方进一步的研究可能是有益的。然而，为了详细分析这些测试结果到底告诉了我们什么，我们需要看看这些数字。为此，表3显示了每个测试配置的平均吞吐量，表4显示了每个测试配置的实例小时平均成本。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/b1f671a739c63a1a946e80cd99cd6019.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*2N5GL73RnNQZes0B4Yz-WA.png"/></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">表3每个测试配置的平均吞吐量</figcaption></figure><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/be75073f90620470edc8c29ebf63696b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*TR9sc_FFOKtAlLSKQs5COA.png"/></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">表4每种测试配置的平均成本</figcaption></figure><p id="3678" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从这些结果中我们可以得出几个重要的观察结果:</p><ul class=""><li id="0e47" class="mi mj iq jp b jq jr ju jv jy mk kc ml kg mm kk mn mo mp mq bi translated">默认的参数设置{CPU60，max10}既没有提供最高的性能，也没有提供最低的成本。</li><li id="5f20" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">我们使用{CPU80，max10}配置<strong class="jp ir">以与默认配置相同的成本获得了<strong class="jp ir"> 3%的高性能</strong>。</strong></li><li id="cdeb" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">与默认配置设置相比，我们从{CPU70，max35}配置中获得了略高(~2%)的性能，同时降低了18%的成本。更快更便宜是好事。</li><li id="cda7" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">对于{CPU70，max 80 }测试配置，我们以大约54%的成本获得了大约96%的默认配置性能。</li></ul><h1 id="4a34" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">要拿走的分数</h1><p id="990b" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">这些结果表明，探索GAE应用的配置参数设置可以获得可观的回报。在这个实验中，我们看到近50%的成本降低，而性能损失最小。与默认的GAE设置相比，我们可以以低得多的成本获得稍好的性能。仅仅这些结果就足以激励我们去探索改变配置值是如何提高性价比的。</p><p id="021c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">特定参数值的影响当然会因应用程序的行为及其工作负载而异。这就是为什么本文中描述的使用参数研究的系统研究方法是一种强有力的方法。</p><p id="2769" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在测试环境中部署和评估不同的配置既便宜又快速。也可以将这种实验作为生产环境的一部分。GAE使您能够部署相同代码的不同版本，具有不同的参数设置，并使用GAE <a class="ae km" href="https://cloud.google.com/appengine/docs/admin-api/migrating-splitting-traffic" rel="noopener ugc nofollow" target="_blank">流量分流特性</a>将相同百分比的请求路由到每个版本。使用GAE控制台和<a class="ae km" href="https://cloud.google.com/monitoring/api/metrics_gcp" rel="noopener ugc nofollow" target="_blank">云监控功能</a>，您可以跟踪每个实例的成本和平均延迟，以比较每个设置组合的效果。如果您是AWS Lambda商店，您可以使用<a class="ae km" href="https://aws.amazon.com/about-aws/whats-new/2017/11/aws-lambda-supports-traffic-shifting-and-phased-deployments-with-aws-codedeploy/#:~:text=You%20can%20now%20shift%20incoming,based%20on%20pre%2Dassigned%20weights.&amp;text=Now%2C%20you%20can%20point%20a,%2C%20AWS%20CLI%2C%20and%20SDKs." rel="noopener ugc nofollow" target="_blank"> lambda函数别名和流量转移</a>进行类似的部署和监控。</p><p id="60de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">也许从这篇文章中最重要的东西如下。不要接受无服务器应用程序的默认配置参数，因为它的负载很大。有了探索配置设置的系统方法，您几乎肯定能够以更低的成本为您的客户端提供更好的性能。所以优先考虑你的客户——你的云提供商已经赚了足够多的钱！</p></div></div>    
</body>
</html>