<html>
<head>
<title>What happens when you run apt commands</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">运行apt命令时会发生什么</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/what-happens-when-you-run-apt-commands-1e8acc38d4f0?source=collection_archive---------10-----------------------#2022-03-29">https://levelup.gitconnected.com/what-happens-when-you-run-apt-commands-1e8acc38d4f0?source=collection_archive---------10-----------------------#2022-03-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="faa0" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">背景</h1><p id="034f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在Linux世界中，软件是以<code class="fe lj lk ll lm b">package</code>的形式交付的。当一个软件工程师想要在Linux平台上工作时，您将会一次又一次地运行包管理命令。因此，您需要理解运行这些命令时实际会发生什么。在本文中，我将介绍这个主题。</p><p id="b54d" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated"><strong class="kn ir">注意</strong>不同的Linux发行版有不同的包管理工具。在本文中，让我们关注Ubuntu系统和软件包管理工具<code class="fe lj lk ll lm b">apt</code>。</p><h1 id="4d3a" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">软件仓库</h1><p id="e147" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如今，每个人都熟悉app store，它是一个中心位置。用户可以在那里检索应用程序。在Linux世界里，<strong class="kn ir">软件仓库</strong>就像应用商店一样工作。软件库通常以mirros的形式提供，您的Linux系统可以订阅它。</p><p id="c8c7" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">世界上有许多存储库镜像，您可以决定使用哪一个。在Ubuntu系统中，它在<code class="fe lj lk ll lm b">/etc/apt/sources.list</code>的配置文件中定义如下:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ls"><img src="../Images/181e161bccd1d5b726f5f0cec489840e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QlO6O4TjPrMRbBhU.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">来源列表</figcaption></figure><p id="2696" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">文件中定义的URL只是软件仓库。</p><h1 id="00ff" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">包装索引</h1><p id="6e55" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">APT包索引本质上是一个数据库，其中包含了来自上述存储库的可用包。</p><p id="b321" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">在Ubuntu系统中，包索引文件存储在<code class="fe lj lk ll lm b">/var/lib/apt/lists</code>中</p><h1 id="2d23" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">apt更新</h1><p id="8701" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">基于以上两点，我们很容易理解当我们运行<code class="fe lj lk ll lm b">apt update</code>时会发生什么。它不更新任何已安装的软件包，而是通过向<strong class="kn ir">软件库</strong>发送新的网络请求来更新本地机器中的<strong class="kn ir">软件包索引</strong>文件。这也是为什么我们需要在运行<code class="fe lj lk ll lm b">apt upgrade</code>或<code class="fe lj lk ll lm b">apt install</code>之前运行它的原因。因为升级的版本或新安装的版本将依赖于更新的包索引文件。通过这种方式，用户将获得目标包的最新版本。</p><h1 id="41de" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">apt-缓存搜索</h1><p id="b5d7" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在您实际安装一个包之前，您可以运行带有包名的<code class="fe lj lk ll lm b">apt-cache search</code>命令来获得任何匹配的可用包的列表。如果您事先不知道确切的包名，这可以帮助您。</p><p id="1e70" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated"><code class="fe lj lk ll lm b">apt-cache</code>命令不发送任何网络请求，而是基于本地机器中的包索引文件工作。如何证明这一点？当然最直接的方法是阅读源代码。但是我想用<code class="fe lj lk ll lm b">strace</code>这个工具给大家展示另一种证明方式。</p><p id="1c11" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated"><code class="fe lj lk ll lm b">strace</code>是一个可以显示你运行命令时调用的所有<code class="fe lj lk ll lm b">system call</code>的工具。如果我们对<code class="fe lj lk ll lm b">apt-cache search</code>的猜测是正确的，它应该会调用系统调用来读取包索引目录<code class="fe lj lk ll lm b">/var/lib/apt/lists</code>中的文件，对吗？让我们通过运行以下命令来看看:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="bbde" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">不是前面命令中的<strong class="kn ir">2&gt;1</strong>部分，这是因为<code class="fe lj lk ll lm b">strace</code>将其所有输出写入<code class="fe lj lk ll lm b">stderr</code>，而不是<code class="fe lj lk ll lm b">stdout</code>。一个<code class="fe lj lk ll lm b">pipe</code>重定向stdout，而不是stderr。所以在管道到<code class="fe lj lk ll lm b">grep</code>之前，需要将strace的stderr重定向到stdout。输出很长，但包含以下几行:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mk"><img src="../Images/9357365d184a1e3ddca36b3c767287dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*l9tPSyUdF8pzPFfY.png"/></div></div></figure><p id="2273" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">和我们猜测的一样。好吧。</p><h1 id="ace0" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">易于安装</h1><p id="d6d1" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">论坛上有很多人在问关于<code class="fe lj lk ll lm b">apt install</code>的秘密，比如<a class="ae ml" href="https://askubuntu.com/questions/162477/how-are-packages-actually-installed-via-apt-get-install" rel="noopener ugc nofollow" target="_blank">这个</a>。<code class="fe lj lk ll lm b">apt install</code>下载包的源代码然后在你的机器上编译吗？这也是我第一次接触Linux世界时想到的问题之一。我的直觉告诉我，当我运行<code class="fe lj lk ll lm b">apt install</code>时，不应该有编译和构建过程。因为我觉得太费时间了。</p><p id="2a43" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">事实上，<code class="fe lj lk ll lm b">apt install</code>是用来将<strong class="kn ir">预构建的二进制包</strong>安装到您的机器上的。简单地说，它完成两项任务:</p><ul class=""><li id="b396" class="mm mn iq kn b ko ln ks lo kw mo la mp le mq li mr ms mt mu bi translated">下载这个包，一个<strong class="kn ir"> Debian包</strong>，到<code class="fe lj lk ll lm b">/var/cache/apt/archives</code></li><li id="b0df" class="mm mn iq kn b ko mv ks mw kw mx la my le mz li mr ms mt mu bi translated">从Debian包中提取文件，并将它们复制到特定的系统位置</li></ul><p id="2476" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">因为Ubuntu源自Debian系统，所以你在Ubuntu上安装的包实际上是一个Debian包，是一个文件名以<code class="fe lj lk ll lm b">.deb</code>结尾的存档文件。例如，<code class="fe lj lk ll lm b">openvpn</code> Debian包如下:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi na"><img src="../Images/2348ce846221c2b683bc27be93ee7524.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Wc84lUgkcHlZ0nEd.png"/></div></div></figure><p id="33bb" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">然后我们可以用<code class="fe lj lk ll lm b">ar x &lt;package_name.deb&gt;</code>命令解压这个包，你会发现每个Debian包里面有三个文件:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nb"><img src="../Images/970475751dcfcffeabe19cbe19e2ad90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VKeZQCG9h-G5NfFe.png"/></div></div></figure><ul class=""><li id="128b" class="mm mn iq kn b ko ln ks lo kw mo la mp le mq li mr ms mt mu bi translated">debian-binary——一个文本文件，指示。deb包格式。</li><li id="902e" class="mm mn iq kn b ko mv ks mw kw mx la my le mz li mr ms mt mu bi translated">control.tar.gz—一个压缩文件，包含md5sums和用于构建包的控制目录。</li><li id="e06a" class="mm mn iq kn b ko mv ks mw kw mx la my le mz li mr ms mt mu bi translated">data.tar.xz —一个压缩文件，它包含要在您的系统上安装的所有文件。这是我们需要继续探索的。</li></ul><p id="1c14" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">运行下面的<code class="fe lj lk ll lm b">tar</code>命令打开这个tarball:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="651f" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">请注意，tarball包含以下目录:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/2a4355dacd644a99a653d900e9f9dcec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/0*JmrGpu4i9Ut-woWv.png"/></div></figure><p id="3b72" class="pw-post-body-paragraph kl km iq kn b ko ln kq kr ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ij bi translated">查看一下<code class="fe lj lk ll lm b">usr</code>目录，您会发现预编译的二进制文件。</p></div></div>    
</body>
</html>