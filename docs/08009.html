<html>
<head>
<title>iOS Snapshot tests + dark mode support</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">iOS快照测试+黑暗模式支持</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/ios-snapshot-tests-dark-mode-support-30f70cdb4c9f?source=collection_archive---------13-----------------------#2021-03-28">https://levelup.gitconnected.com/ios-snapshot-tests-dark-mode-support-30f70cdb4c9f?source=collection_archive---------13-----------------------#2021-03-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bf8ea68451625ec64a1ec4c88ed6a0d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ar7b6nmBJ9mYIloQcdES9A.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@williamtm?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">威廉·胡克</a>在<a class="ae kc" href="https://unsplash.com/s/photos/ios-app?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="c057" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为UI视图编写测试与单元测试和集成测试一样重要。这些测试不是强制性的，但是在开发iOS应用程序时很有帮助。今天我想和大家分享如何使用<code class="fe lb lc ld le b"><a class="ae kc" href="https://github.com/uber/ios-snapshot-test-case" rel="noopener ugc nofollow" target="_blank">iOSSnapshotTestCase</a></code>框架添加快照测试，以及如何添加对黑暗模式的支持。</p><h2 id="af44" class="lf lg iq bd lh li lj dn lk ll lm dp ln ko lo lp lq ks lr ls lt kw lu lv lw lx bi translated"><strong class="ak">什么是快照测试？</strong></h2><p id="989a" class="pw-post-body-paragraph kd ke iq kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">这种测试包括从您的视图中拍摄快照，并与我们项目中存储的参考图像进行比较。当然，为了有一个参考图像，我们首先需要捕捉这个图像。</p><p id="c58f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">快照测试应该仅用于验证视图，而不是逻辑(如下载数据、解析信息、日期格式等)。).如果我们需要验证这些东西，你可能需要单元测试。</p><p id="9bec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如我们将看到的，我们不需要每次都运行应用程序来验证UI是否正常。我们将使用快照测试快速获得视图反馈，而不是运行应用程序，导航到该视图并验证视图。</p><p id="cd4f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">启动前:</strong></p><p id="90ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，我们的屏幕需要显示:</p><ul class=""><li id="d99b" class="md me iq kf b kg kh kk kl ko mf ks mg kw mh la mi mj mk ml bi translated">带有“你好，世界！”的居中标签没有自定义样式的邮件。</li><li id="a788" class="md me iq kf b kg mm kk mn ko mo ks mp kw mq la mi mj mk ml bi translated">相同的标签应该能够显示一个成功的消息与<code class="fe lb lc ld le b">green</code>字体颜色。</li><li id="fb88" class="md me iq kf b kg mm kk mn ko mo ks mp kw mq la mi mj mk ml bi translated">相同的标签应该能够显示一个错误信息与<code class="fe lb lc ld le b">red</code>字体颜色和文本样式<code class="fe lb lc ld le b">title1</code>。</li></ul><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/45b56b8c4d5349dedc298fbbc08c2168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W2QxnFtuCVucX0J3VePSTw.png"/></div></div></figure><h2 id="6997" class="lf lg iq bd lh li lj dn lk ll lm dp ln ko lo lp lq ks lr ls lt kw lu lv lw lx bi translated">设置应用程序以使用iOSSnapshotTestCase框架</h2><p id="bc59" class="pw-post-body-paragraph kd ke iq kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">要将iOSSnapshotTestCase框架配置到您的应用程序中，您可以使用依赖管理器作为<a class="ae kc" href="https://cocoapods.org" rel="noopener ugc nofollow" target="_blank"> CocoaPods </a>或<a class="ae kc" href="https://github.com/Carthage/Carthage" rel="noopener ugc nofollow" target="_blank"> Carthage </a>。不幸的是<a class="ae kc" href="https://swift.org/package-manager/" rel="noopener ugc nofollow" target="_blank"> Swift包管理器</a>仍然不被支持。在这种情况下，我们使用Carthage将框架添加到我们的应用程序中，但是您可以根据需要随意设置您的应用程序。</p><p id="e14b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想测试框架是如何工作的，您可以创建一个新项目，并确保选中了<em class="mw"> Include Tests </em>。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/265a598b5109c6421c0e777deeeeeff0.png" data-original-src="https://miro.medium.com/v2/resize:fit:732/format:webp/1*5saEIcZee4jZqm5j5FFUhQ.png"/></div></figure><p id="05f2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者您可以从Github克隆启动项目:</p><div class="my mz gp gr na nb"><a href="https://github.com/AlfredoHernandez/iOSSnapshotTestCaseDemo/tree/starter" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd ir gy z fp ng fr fs nh fu fw ip bi translated">Alfredo Hernandez/iosnapshottestcasedemo</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">快照测试iOS初学者项目。通过创建一个…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">github.com</p></div></div></div></a></div><p id="78dd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你想使用迦太基，你可以对<code class="fe lb lc ld le b">carthage</code>分支做一个<a class="ae kc" href="https://git-scm.com/docs/git-checkout" rel="noopener ugc nofollow" target="_blank"> <em class="mw">【结账】</em> </a>，该分支包含一个<code class="fe lb lc ld le b">Cartfile</code>与被配置项目的依赖关系。然后运行<code class="fe lb lc ld le b">carthage update — use-xcframeworks</code>命令下载框架。</p><p id="396e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您需要将xcframework添加到项目中，转到项目中的<code class="fe lb lc ld le b">Frameworks, Libraries, and Embedded Content</code>并添加<code class="fe lb lc ld le b">FBSnapshotTestCase.xcframework</code></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/51933400d4fc410f6fbf9be74b995bae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*QHM9fvuxBnY6xHHYjHJZWA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">注意:选择“不嵌入”</figcaption></figure><p id="3517" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过运行应用程序和运行测试，确保一切都配置良好。</p><p id="564d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您正在<strong class="kf ir">使用GitHub存储库</strong>，您将看到一个失败的测试，这意味着一切正常。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/575f39bd05fa3c2c3a1274a2647ac78d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6wfAh84NDm4FvkIUd-yaxw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">测试零</figcaption></figure><p id="4a3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如乔恩·里德在他的书《通过例子进行iOS单元测试》中所说:</p><blockquote class="nm nn no"><p id="cd9f" class="kd ke mw kf b kg kh ki kj kk kl km kn np kp kq kr nq kt ku kv nr kx ky kz la ij bi translated">“测试零有助于将我们的问题分开，以便我们可以一次解决一个问题。当我们创建一个新的测试套件时，我们通常会考虑第一个测试。但是在我们忘记编写测试之前，让我们确保套件运行。否则，基本的基础设施问题会打断我们的思维。”</p></blockquote><h2 id="3840" class="lf lg iq bd lh li lj dn lk ll lm dp ln ko lo lp lq ks lr ls lt kw lu lv lw lx bi translated">设置测试方案</h2><p id="f46b" class="pw-post-body-paragraph kd ke iq kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">我们将向我们的方案中添加两个ENV变量，因此转到您的方案&gt;测试&gt;参数并添加以下变量:</p><p id="53f2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">FB_REFERENCE_IMAGE_DIR</code>带值<code class="fe lb lc ld le b">$(SOURCE_ROOT)/$(PROJECT_NAME)Tests/ReferenceImages</code></p><p id="4677" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">IMAGE_DIFF_DIR</code>带值<code class="fe lb lc ld le b">$(SOURCE_ROOT)/$(PROJECT_NAME)Tests/FailureDiffs</code></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/e2e520064d7f593202e46fb49084d57c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*svxUqja8bT5Su6iQ1_dWfw.png"/></div></div></figure><p id="8664" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">expand variables based on</code>你的测试目标，就像这样:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/fe1cef8d27424292b44a173aca93fb38.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*0OmTg7xLixZGDQLZsKZifA.png"/></div></figure><h1 id="4795" class="nu lg iq bd lh nv nw nx lk ny nz oa ln ob oc od lq oe of og lt oh oi oj lw ok bi translated">配置用户界面视图控制器并运行快照测试</h1><p id="07cb" class="pw-post-body-paragraph kd ke iq kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">是时候将UI元素添加到视图控制器中了，我们将在故事板的UIViewController中间添加一个UI标签。<strong class="kf ir">请不要添加约束条件。</strong></p><p id="ae5c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在您的测试中，导入<code class="fe lb lc ld le b">FBSnapshotTestCase</code>并子类化<code class="fe lb lc ld le b">FBSnapshotTestCase</code>而不是<code class="fe lb lc ld le b">XCTestCase</code></p><p id="8fbb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">编写以下测试:</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="18b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">选择您喜欢的苹果手机型号并运行测试。您会看到一个失败的测试(无法加载参考图像)，因为我们还没有参考图像。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi on"><img src="../Images/053326f999e9bb57c9b936e7917c1bec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F_Gia2OAFiyvUILDNV4tbQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">测试失败:无法加载参考图像</figcaption></figure><p id="2d1b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在加载包之前添加<code class="fe lb lc ld le b">recordMode = <strong class="kf ir">true</strong></code> <strong class="kf ir"> </strong>并再次运行测试。您将(再次)看到一个失败的测试，但是这次我们有一个<code class="fe lb lc ld le b">Test ran in record mode. Reference image is now saved.</code>错误消息。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oo"><img src="../Images/3aa048131d24ad8c42d28f2a7542d14a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*296UP-KB2hghA_kq5iL2Lw.png"/></div></div></figure><p id="d88e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你查看你的项目文件夹，你会发现一个名为<code class="fe lb lc ld le b">ReferenceImages_64</code>的文件夹，里面有拍摄的快照。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/fc93cdb8c97aeca8939c0fb65e35549c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r6ZrgI6WdramUeI6SeXGKg.png"/></div></div></figure><p id="95f7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在删除<code class="fe lb lc ld le b">recordMode = <strong class="kf ir">true</strong></code> <strong class="kf ir"> </strong>行，再次运行测试。瞧，我们通过了测试。但是等等，如果你仔细看这张快照，我们会发现它不在中间。我们需要解决这个问题。</p><p id="cb34" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">转到您的故事板，并在屏幕中央添加约束，如下所示:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oq"><img src="../Images/5215579f368992d68089b341e2a3a170.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tn1YiLeEqmNxzefvzuLWpA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">向标签添加约束</figcaption></figure><p id="905b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">回到您的快照测试，并再次运行它们。我们的测试失败了。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi or"><img src="../Images/ad9dbe13573f2c93fbaa5147882fa8e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uxNL1_dGSwWe--ZNuZcNUg.png"/></div></div></figure><p id="4900" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如你所见，这次我们有一条<code class="fe lb lc ld le b">“Images different"</code>消息，意思是“我们的观点被修改了”。如果你在你的项目文件中看到，我们有一个名为<code class="fe lb lc ld le b">FailureDiffs</code>的新文件夹，里面有三张不同的图片。</p><ul class=""><li id="4340" class="md me iq kf b kg kh kk kl ko mf ks mg kw mh la mi mj mk ml bi translated"><strong class="kf ir">参考</strong>图像，即我们之前记录的图像</li><li id="2b0d" class="md me iq kf b kg mm kk mn ko mo ks mp kw mq la mi mj mk ml bi translated"><strong class="kf ir">失败的</strong>图像，显示更改后视图控制器的样子</li><li id="2398" class="md me iq kf b kg mm kk mn ko mo ks mp kw mq la mi mj mk ml bi translated"><strong class="kf ir">差异</strong>图像显示参考图像和故障图像之间的差异</li></ul><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi os"><img src="../Images/92e970841b984af9648267f29cb388c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tF9SAHLlpCms5o8FbE6yCQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">FailureDiffs目录中的图像</figcaption></figure><p id="415a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这一次，失败的图像看起来比参考图像更好，以<code class="fe lb lc ld le b">Hello, World!</code>消息为中心。因此，再次记录，以存储此图像，并运行您的测试，使其处于绿色状态。</p><h1 id="775f" class="nu lg iq bd lh nv nw nx lk ny nz oa ln ob oc od lq oe of og lt oh oi oj lw ok bi translated">添加更多测试并重构测试代码</h1><p id="6db0" class="pw-post-body-paragraph kd ke iq kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">想象一下，在点击一个按钮或得到服务的响应后，如果出现错误，我们需要将消息更改为成功或失败消息。我们可以使用快照测试来测试这种行为。</p><p id="0756" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">记住<strong class="kf ir">这只是针对视图</strong>，逻辑需要通过使用单元或集成测试来测试驱动。</p><p id="ee91" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以让我们写一个测试:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/e641188aa3f5005fdc7c98ce0b4bfa9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sB99CL-RdEzCW4XtTknjNg.png"/></div></div></figure><p id="47af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当然我们需要在视图控制器中添加一个显示方法来运行测试，所以请添加它。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/5dc76a482b5fc6cc6d6e2b20db5b62cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:656/format:webp/1*gHNLWqo39R-fgjglft0kqA.png"/></div></figure><p id="bbbd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在测试中添加记录模式，并运行它来存储图像。如果我们看到的图像，我们发现这是完全相同的最后一个。当然，这不是我们想要的(我们需要一个绿色的消息标签)。因此，让我们在视图控制器内部工作。</p><ul class=""><li id="c280" class="md me iq kf b kg kh kk kl ko mf ks mg kw mh la mi mj mk ml bi translated">将您的UILabel从故事板连接到视图控制器</li><li id="d9f1" class="md me iq kf b kg mm kk mn ko mo ks mp kw mq la mi mj mk ml bi translated">在显示方法中，通过<code class="fe lb lc ld le b">.systemGreen</code>设置接收的信息并改变颜色</li><li id="9c41" class="md me iq kf b kg mm kk mn ko mo ks mp kw mq la mi mj mk ml bi translated">运行测试以记录快照</li></ul><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/a284a1a8a942ecf8c754c2fce1623974.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*7UFLoanomvGElZ0FE_vrew.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">致命错误</figcaption></figure><p id="fbd2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">显示了一个致命的错误，这是因为当加载视图时，我们需要从视图控制器调用中调用方法，如viewDidLoad、viewWillAppear等来配置视图。为此，我们不调用每个方法，而是调用<code class="fe lb lc ld le b">.loadViewIfNeeded()</code>。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/4a76acb57ca0de9ee5171cc701d356e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*sVRlkg5ge6MPhKEuJWFG0A.png"/></div></figure><p id="7d38" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">再次运行测试，并验证您的视图是否如您所愿地良好显示。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/72c10b470a714b611a1b651e4078675d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*kI7SplyxeoxltneHfQkE8g.png"/></div></figure><p id="deda" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请添加另一个测试来显示带有<code class="fe lb lc ld le b">.systemRed</code>颜色和字体大小<code class="fe lb lc ld le b">.title1</code>的错误消息，并保存快照。您的快照应该是这样的:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/f5fc7dc821e8819ef0421a11ebf2d5fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*Ths4viZGk8CDyhheGgrv0w.png"/></div></figure><p id="59ff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您的测试套件:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/83c6affbb59a20306a2c9082405f013b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*i0ZyYxRolrYNPMpJgy0TIQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">快照测试套件</figcaption></figure><p id="290d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如你在我们的测试套件中看到的，我们有可以重构的重复代码。我们可以将SUT ( <em class="mw">测试下的系统</em>)创建转移到一个助手方法中，就像这样:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oy"><img src="../Images/d5d5ce11157d0eb927cc6862f2b09db6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1ArOxzGMi8AfbRsLh-Tsag.png"/></div></div></figure><p id="d631" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们可以在测试中使用它。通过这样做，我们使我们的测试更加清晰易读。我们还可以看到，我们有三个共同的阶段:<strong class="kf ir"> A </strong> rrange、<strong class="kf ir"> A </strong> ct和<strong class="kf ir"> A </strong> ssert (AAA ),由Jon Reid推荐的空行分隔(Jon Reid。“iOS单元测试示例”)。</p><p id="729f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们的测试看起来像这样:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oz"><img src="../Images/4821ff6999df8a466541df530f315ce4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r0GhgkKF1UAJj8ad_HSvFQ.png"/></div></div></figure><p id="ffbf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为你开始在你的代码中添加测试，所以建议保持代码的整洁、简单、易读、有组织以及所有你认为对你的代码有益的东西。</p><blockquote class="nm nn no"><p id="b20b" class="kd ke mw kf b kg kh ki kj kk kl km kn np kp kq kr nq kt ku kv nr kx ky kz la ij bi translated">“测试代码和生产代码一样重要”来自:Jon Reid。“iOS单元测试示例”。</p></blockquote><h2 id="ca3e" class="lf lg iq bd lh li lj dn lk ll lm dp ln ko lo lp lq ks lr ls lt kw lu lv lw lx bi translated">我们可以做得更多</h2><p id="0f3c" class="pw-post-body-paragraph kd ke iq kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">我们可以创建两个助手来简化这项任务，而不是在每次需要更新或记录新的快照时添加记录模式标志来捕获快照。<code class="fe lb lc ld le b">record()</code>和<code class="fe lb lc ld le b">assert()</code>方法。</p><p id="845e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为什么不创建一个<code class="fe lb lc ld le b">SnaphshotTestCase</code>类来添加这两个助手，而不是子类<code class="fe lb lc ld le b">FBSnapshotTestCase</code>呢？我们开始吧。请添加一个名为<code class="fe lb lc ld le b">SnaphshotTestCase.</code>的新文件，确保它是在我们的测试目标中创建的，并添加以下代码。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pa"><img src="../Images/367de3b330f6e15aa7201204c6381f16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UZ1TLEL4crgjNKfGV2cL0A.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">快照测试用例自定义类</figcaption></figure><p id="8d98" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，在我们的主测试套件中，从<code class="fe lb lc ld le b">SnapshotTestCase</code>派生出子类，并用我们定制的<code class="fe lb lc ld le b">assert()</code>方法替换<code class="fe lb lc ld le b">FBSnapshotVerifyView</code>方法。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pb"><img src="../Images/6eb03c60a1aed59545d4861fab4599ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x-99vN5K3nQ11F4pJAExVw.png"/></div></div></figure><p id="b03b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">再次运行你的测试来验证一切正常。如果您需要记录新的快照，只需用<code class="fe lb lc ld le b">record</code>替换<code class="fe lb lc ld le b">assert</code>，神奇的事情就会发生。</strong></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pc"><img src="../Images/a3e6ca6ac2a2f1d269e03bf4be501753.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*isdyd-Wbakqrz_3FQJ_33Q.png"/></div></div></figure><h1 id="858a" class="nu lg iq bd lh nv nw nx lk ny nz oa ln ob oc od lq oe of og lt oh oi oj lw ok bi translated">通过快照测试增加黑暗模式支持</h1><p id="3d5b" class="pw-post-body-paragraph kd ke iq kf b kg ly ki kj kk lz km kn ko ma kq kr ks mb ku kv kw mc ky kz la ij bi translated">在iOS 13.0和更高版本中，人们可以选择采用一种黑暗的全系统外观，称为黑暗模式。到目前为止，我们只有快照测试来支持光模式，但暗模式呢？让我们添加一些测试代码，使用快照测试开始支持黑暗模式。</p><p id="21ad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要添加黑暗模式支持，我们需要覆盖用户界面风格。所以在我们的帮助器方法中，覆盖用户界面样式:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pd"><img src="../Images/3f561834acd2ac2531330d6947392f6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1rfIMMTO-ycqXJ-QMHY64g.png"/></div></div></figure><p id="170c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是这还不够，在我们的测试套件中，我们需要为我们的视图控制器添加一个UIWindow，并再次记录快照。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pe"><img src="../Images/f87132de5bfcd1f913038284e66362fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JVQ0KcFd6s3_ztKINlWivA.png"/></div></div></figure><p id="c7a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们为助手添加了两个参数，<code class="fe lb lc ld le b">mode</code>指定使用哪种用户风格(亮/暗),而<code class="fe lb lc ld le b">identifier</code>为快照名称添加后缀并标识屏幕版本。</p><p id="0d02" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从我们的快照文件中，删除旧的快照(没有后缀)并再次运行测试，从<code class="fe lb lc ld le b">record</code>更改为<code class="fe lb lc ld le b">assert</code></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pf"><img src="../Images/1f326109bb3216d4f1137c9bb3344f30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HTNH05ro4tQK-dpz9wVKFQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">必须删除选定的图像</figcaption></figure><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/5b7f996d451333c8d993849813dfab3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*_VC6tS-OHq3-kwPUklic8w.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">通过测试</figcaption></figure><p id="c255" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看看你新录制的快照，你会发现你的屏幕上有明有暗的变化。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ph"><img src="../Images/c2c36cc338cab1c381f83d3343cd1a7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YFs-PnyZ2aG4qs0N_0Sqng.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">亮暗模式的预览</figcaption></figure><p id="490e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在此处找到该项目的差异:</p><div class="my mz gp gr na nb"><a href="https://github.com/AlfredoHernandez/iOSSnapshotTestCaseDemo/pull/1" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd ir gy z fp ng fr fs nh fu fw ip bi translated">迦太基决赛由AlfredoHernandez拉动请求# 1 Alfredo Hernandez/iosnapshottestcasedemo</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">将此建议添加到可以作为单次提交应用的批处理中。此建议无效，因为没有更改…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">github.com</p></div></div><div class="pi l"><div class="pj l pk pl pm pi pn jw nb"/></div></div></a></div><p id="1f6e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请随意定制您的助手并改进代码。</p><h2 id="dc9b" class="lf lg iq bd lh li lj dn lk ll lm dp ln ko lo lp lq ks lr ls lt kw lu lv lw lx bi translated">关键注意事项:</h2><ol class=""><li id="2483" class="md me iq kf b kg ly kk lz ko po ks pp kw pq la pr mj mk ml bi translated">使用相同的iOS模拟器记录和断言快照，否则测试将失败。</li><li id="1234" class="md me iq kf b kg mm kk mn ko mo ks mp kw mq la pr mj mk ml bi translated">快照名称与相同的测试方法名称存储在一起(加上一个标识符，如果我们添加的话)。</li><li id="f871" class="md me iq kf b kg mm kk mn ko mo ks mp kw mq la pr mj mk ml bi translated">不要忘记在git存储库中添加/删除所需的记录快照。</li><li id="1bf7" class="md me iq kf b kg mm kk mn ko mo ks mp kw mq la pr mj mk ml bi translated">让你的测试代码像你的产品代码一样简洁明了。</li></ol></div></div>    
</body>
</html>