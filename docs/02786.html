<html>
<head>
<title>Running Celery in Multi Module Setup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在多模块设置中运行芹菜</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/running-celery-in-multi-module-setup-5411f8f0b9e?source=collection_archive---------13-----------------------#2020-04-04">https://levelup.gitconnected.com/running-celery-in-multi-module-setup-5411f8f0b9e?source=collection_archive---------13-----------------------#2020-04-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/9a5f3ea4d285c75037fea5a3018efc98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*vR_BLNAw5bYkdaxGIPYSrQ.png"/></div></figure><p id="a366" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这篇文章是针对芹菜初学者的。它讨论了种植芹菜的不同方法。</p><ul class=""><li id="a644" class="kv kw it jz b ka kb ke kf ki kx km ky kq kz ku la lb lc ld bi translated">使用具有单一模块的芹菜</li><li id="b9bb" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">使用具有多个模块的芹菜。</li><li id="6282" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">使用celery，将多个模块拆分成多个包。</li></ul><h2 id="20b2" class="lj lk it bd ll lm ln dn lo lp lq dp lr ki ls lt lu km lv lw lx kq ly lz ma mb bi translated">先决条件</h2><p id="1e1b" class="pw-post-body-paragraph jx jy it jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">你应该安装芹菜和Redis。我们将使用Redis作为我们的经纪人。</p><h2 id="80e8" class="lj lk it bd ll lm ln dn lo lp lq dp lr ki ls lt lu km lv lw lx kq ly lz ma mb bi translated">使用具有单一模块的芹菜</h2><p id="caa0" class="pw-post-body-paragraph jx jy it jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">让我们创建一个名为<code class="fe mh mi mj mk b">tasks.py</code>的模块，内容如下:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="5c6f" class="lj lk it mk b gy mt mu l mv mw">from celery import Celery</span><span id="990f" class="lj lk it mk b gy mx mu l mv mw">app = Celery('tasks', broker='redis://localhost')</span><span id="55eb" class="lj lk it mk b gy mx mu l mv mw">@app.task<br/>def hello():<br/>    return 'hello'</span></pre><p id="e2dc" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">让我们开始芹菜工人</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="f58e" class="lj lk it mk b gy mt mu l mv mw">celery -A tasks worker -l INFO</span></pre><p id="bd4f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">让我们启动一个shell并对一个任务进行排队。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="643d" class="lj lk it mk b gy mt mu l mv mw">In [1]: from tasks import hello<br/>In [2]: hello.apply_async()<br/>Out[2]: &lt;AsyncResult: 079bd2b9-05da-4660-9064-b369b3863cb0&gt;</span></pre><p id="0af9" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">您应该会在工人控制台上看到一条消息。这验证了芹菜工人处理了任务。</p><h1 id="13dc" class="my lk it bd ll mz na nb lo nc nd ne lr nf ng nh lu ni nj nk lx nl nm nn ma no bi translated">使用具有多个模块的芹菜。</h1><p id="5b40" class="pw-post-body-paragraph jx jy it jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">让我们用下面的内容创建一个名为<code class="fe mh mi mj mk b">mathematics.py</code>的模块。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="df73" class="lj lk it mk b gy mt mu l mv mw">from tasks import app</span><span id="edae" class="lj lk it mk b gy mx mu l mv mw">@app.task<br/>def sum(a, b):<br/>    return a + b</span></pre><p id="5494" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们需要请求Celery <code class="fe mh mi mj mk b">app</code>实例包含这个模块，这样当worker启动时，它就知道这个模块的任务。</p><p id="9fa3" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">因此，<code class="fe mh mi mj mk b">tasks.py</code>中的<code class="fe mh mi mj mk b">app</code>实例化需要修改如下:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="9f3b" class="lj lk it mk b gy mt mu l mv mw">app = Celery('tasks', broker='redis://localhost', include=['mathematics'])</span></pre><p id="3567" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">重启芹菜工。</p><p id="0485" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">重启python shell，将任务<code class="fe mh mi mj mk b">sum</code>排队。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="c7e4" class="lj lk it mk b gy mt mu l mv mw">In [2]: from mathematics import sum<br/>In [4]: sum.apply_async(args=(3, 4))<br/>Out[4]: &lt;AsyncResult: 1ba8aea0-a604-49d6-aa45-a0315d2b58c6&gt;</span></pre><p id="129f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">您应该会在工作人员的控制台上看到计算出的总和。这验证了芹菜工人处理了任务。</p><h2 id="4434" class="lj lk it bd ll lm ln dn lo lp lq dp lr ki ls lt lu km lv lw lx kq ly lz ma mb bi translated">在多包装设置中使用芹菜</h2><p id="8d1f" class="pw-post-body-paragraph jx jy it jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">让我们创建一个名为<code class="fe mh mi mj mk b">internationalization</code>的包。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="7a74" class="lj lk it mk b gy mt mu l mv mw">╰─$ mkdir internationalization</span><span id="de38" class="lj lk it mk b gy mx mu l mv mw">╰─$ touch internationalization/__init__.py</span></pre><p id="a45c" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">让我们在其中创建模块<code class="fe mh mi mj mk b">german.py</code>和<code class="fe mh mi mj mk b">french.py</code>。</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="213b" class="lj lk it mk b gy mt mu l mv mw"># internationalization/german.py</span><span id="6d42" class="lj lk it mk b gy mx mu l mv mw">from tasks import app</span><span id="9709" class="lj lk it mk b gy mx mu l mv mw">@app.task<br/>def hello():<br/>    return "Hallo"</span></pre><p id="c6f9" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">国际化/french.py</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="dce6" class="lj lk it mk b gy mt mu l mv mw"># internationalization/french.py</span><span id="7c9e" class="lj lk it mk b gy mx mu l mv mw">from tasks import app</span><span id="3465" class="lj lk it mk b gy mx mu l mv mw">@app.task<br/>def hello():<br/>    return 'Bonjour'</span></pre><p id="9b55" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们需要在我们的芹菜应用程序中包含这些任务模块。修改tasks.py中的<code class="fe mh mi mj mk b">app</code>,使其看起来像:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="7453" class="lj lk it mk b gy mt mu l mv mw">app = Celery('tasks', broker='redis://localhost', include=['mathematics', 'internationalization.french', 'internationalization.german'])</span></pre><p id="063e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">重启芹菜工。</p><p id="87fb" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">重启python shell，对来自german.py和french.py的任务<code class="fe mh mi mj mk b">hello</code>进行排队</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="6b6d" class="lj lk it mk b gy mt mu l mv mw">In [1]: from internationalization.french import hello<br/>In [2]: hello.apply_async()<br/>Out[2]: &lt;AsyncResult: 09297a37-2733-4820-8f37-cd6eeeb5ce5b&gt;</span></pre><p id="998b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">您应该会在工作人员的控制台上看到该消息。这验证了芹菜工人处理了任务。</p></div><div class="ab cl np nq hx nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="im in io ip iq"><p id="7a1b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">随时询问任何关于芹菜的问题，我很乐意回答。</p></div></div>    
</body>
</html>