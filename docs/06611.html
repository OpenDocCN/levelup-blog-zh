<html>
<head>
<title>Effects of Docker Image Size on AutoScaling w.r.t Single and Multi-Node Kube Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker图像大小对自动缩放w.r.t单节点和多节点Kube集群的影响</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/effects-of-docker-image-size-on-autoscaling-w-r-t-single-and-multi-node-kube-cluster-29c4f689cd99?source=collection_archive---------1-----------------------#2020-12-12">https://levelup.gitconnected.com/effects-of-docker-image-size-on-autoscaling-w-r-t-single-and-multi-node-kube-cluster-29c4f689cd99?source=collection_archive---------1-----------------------#2020-12-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="11db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当你问开发人员，提高应用程序性能的两个关键因素是什么时，答案肯定是</p><ul class=""><li id="dcc9" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">CPU核心的数量。</li><li id="f514" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">应用RAM。</li></ul><p id="887a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当谈到单片架构时，我们估计一个应用程序所需的总CPU和RAM，并选择一台具有大量CPU内核和数百GB RAM的大型计算机。</p><p id="d88d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种巨大机器的问题是，与多个水平缩放的轻量级机器相比，它们非常昂贵，而且它们很难像在飞行中可用的轻量级机器那样立即得到一个。</p><p id="4428" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为这篇文章主要是关于自动缩放和Docker图像大小，所以我们不讨论单片和微服务。</p></div><div class="ab cl kz la hu lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ij ik il im in"><p id="d35b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将在本文中讨论的内容有</p><ul class=""><li id="210c" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">什么是自动扩展，何时需要自动扩展。</li><li id="b402" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">docker图像大小和自动缩放有什么关系？</li><li id="4abb" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">它如何影响单节点和多节点Kubernetes部署的最终用户</li></ul><p id="bb6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们开始讨论吧</p><ul class=""><li id="e6ea" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><strong class="jp ir">什么是自动缩放</strong></li></ul><p id="e01a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设我估计的请求数量是50000 RPM(请求/分钟),我的SLA响应时间大约是50毫秒。基于这些请求和我的SLA，我对我的服务器和数据库进行基准测试，得出所需的容器数量和每个容器的容量(<strong class="jp ir"> CPU &amp; RAM </strong>)。让我们想象一下事情将会怎样。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/1f44e1011126e3a6bf1330744315d440.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FrHpE2RjRb3Dw3NpncTKNQ.png"/></div></div></figure><p id="bb7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设转速为50000 RPM，使用3个容器，我能够在我的SLA范围内满足请求。但是拥有庞大的用户群，我们不能保证请求数不能超过或者不能说我们的服务不支持超过50000 RPM。</p><p id="34cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在考虑一下，由于一些快速销售，我们开始收到大约70000 RPM的请求，现在这是每个容器的CPU使用情况。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/c2e8fe6e3ef6749ecab71f99a5b3726e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D4z2o821OGEmkTgutr7C1g.png"/></div></div></figure><p id="f200" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着我们仍将继续使用3个集装箱为70000 RPM的额外负载提供服务，我们不确定RPM是否会进一步呈指数级增长。此时，我所有的CPU内核都忙于处理用户请求，每个内核都有大量的队列。<strong class="jp ir">随着队列的增加，响应时间也增加了，这导致我的SLA超时以及取消一些请求，因为我的服务器最多可以处理X个并行连接。</strong></p><p id="a90a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为开发人员，我们假设系统在任何时间点可以达到的最小RPM、平均RPM和最高RPM。假设最小RPM是20000 (2个容器可以处理负载)，平均值是50000 (3个容器)，最大值是100000 (6个容器)。现在，如果我们有一个系统，其中如果容器上的负载较少，它可以减少到2个容器，如果系统上的负载较高，它可以增加到6个容器(基于我们的[低、高]配置),而无需任何手动干预，这对我们扩展系统非常有帮助，即使是在峰值负载时。这是自动缩放进入画面的时候。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ls"><img src="../Images/6709b636e6d0dc1fac00cbffd05e5199.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Goy4u8j9Zd0_ALKuItJCA.png"/></div></div></figure><p id="d809" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我把我所有的容器放在一个自动缩放组下，但是对于自动缩放组来说，它需要一些度量来进行缩放。这些是我们在创建自动缩放组时设置的一组条件。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lt"><img src="../Images/e4df4671006cc6f7b53612c4e40374cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OaOGqhAkJz-uV6AC3C6ptQ.png"/></div></div></figure><p id="43ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">右下角是自动伸缩基于应用健康和能量(CPU、RAM)放大或缩小容器的条件。</p><p id="bcf5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然你对什么是水平缩放和什么是自动缩放有了基本的了解，让我们深入到描述自动缩放过程的第二点。</p><ul class=""><li id="eb1b" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><strong class="jp ir">Docker图像大小如何影响自动缩放</strong></li></ul><p id="86aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设我们以50K RPM运行的应用程序开始获得70K RPM，并且我们现有的服务器即将违反SLA。这个自动扩展组充当容器运行时统计的监听器，一旦满足其中一个条件，它就会尝试扩展一个新容器。</p><p id="5541" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">生产一个新集装箱需要什么程序？</p><pre class="lh li lj lk gt lu lv lw lx aw ly bi"><span id="46b5" class="lz ma iq lv b gy mb mc l md me">Container Spawning Time = Total time to download docker image + time taken for application boot up scripts + measuring health of newly spawned container.</span></pre><p id="22d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从这个等式中我们可以清楚地理解一件事。如果在CPU使用率&gt; 80%的情况下触发自动伸缩来增加一个容器，那么假设下载docker映像需要2分钟，启动脚本需要30秒，应用程序健康检查需要30秒。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mf"><img src="../Images/5093ea2af8552b7642b5fcd77a3a58f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R79pXa6Kc69BX81GpBPdCw.png"/></div></div></figure><p id="3e7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以在这3分钟的间隙里，很多事情都可能发生。</p><ul class=""><li id="a295" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">服务器可以达到100%的CPU利用率，这会导致崩溃，从而中断许多用户请求。</li><li id="3d60" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">所有的服务器都会经历峰值负载，从而大幅增加响应时间，导致用户体验不佳。</li></ul><p id="2e2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在有人可能会问，为什么图像下载需要大量的时间，其中大部分步骤将从现有的缓存中选取。因为已经有3个容器在节点上运行，如果必须生成第4个容器，它将从节点上现有的构建缓存中获取，并且需要较少的下载时间。</p><p id="6d0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">这就是多节点部署的用武之地。</strong></p><ul class=""><li id="aa2c" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><strong class="jp ir">它如何影响单节点终端用户&amp;多节点Kubernetes部署</strong></li></ul><p id="f2cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为一个产品，将会有多个这样的应用程序与我们的并行部署。让我们考虑一个例子。</p><p id="6656" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有3个应用，每个应用2个容器，最多可扩展到4个。现在，我们在多个节点上部署了这3个应用程序。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mg"><img src="../Images/6dd5a082314e8f945f3d6637fc65c5ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UfFaX3vEr8suQ9gNudkcVQ.png"/></div></div></figure><p id="8eee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，App 1正面临着一些严重的CPU负载，因此自动缩放被触发，需要产生App 1的另一个实例。它遍历每个可用节点，其中它可以找到具有可用资源的节点来产生这个新容器。</p><p id="406b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在最好的情况下，如果节点1或节点2有额外的资源，新的容器将被部署在这两个节点中的任何一个上，其中构建缓存已经存在于该映像中。在这种情况下，下载和启动会更快。</p><p id="e5a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，考虑节点1或节点2没有资源来生成App 1的另一个容器，并且只有节点3可用。因此，kube server在节点3上安排了一个新的容器部署，但这次节点3不包含App 1映像的构建缓存，映像必须在运行时从公共或私有集线器下载，下载的总时间完全取决于网络带宽，这无疑会花费更多时间。</p><p id="a159" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到目前为止，人们应该已经对docker图像大小在自动缩放和客户满意度中的重要作用有了基本的了解。</p><p id="cc4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你有任何问题或建议，请在评论区留言。我会尽快回复你。</p></div></div>    
</body>
</html>