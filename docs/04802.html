<html>
<head>
<title>Using Realm with Combine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">结合使用领域</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-realm-with-combine-288afa199b33?source=collection_archive---------6-----------------------#2020-07-16">https://levelup.gitconnected.com/using-realm-with-combine-288afa199b33?source=collection_archive---------6-----------------------#2020-07-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/24e217ce50da462490e82828e43290c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fJ0Z-BxOigBU_zC6"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@cleipelt?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯·莱佩尔特</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="7228" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Combine是苹果的反应式编程框架。它很强大，我想在现实世界中尝试一下，与Realm集成。从<a class="ae kf" href="https://github.com/realm/realm-cocoa/releases/tag/v5.0.0" rel="noopener ugc nofollow" target="_blank">版本5.0.0 </a>开始，Realm增加了对Combine和SwiftUI的支持，大家试一试吧！🎆</p><h1 id="623b" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">模型</h1><p id="1383" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们将使用我之前关于领域的<a class="ae kf" href="https://blog.usejournal.com/realm-tips-of-an-ios-developer-26ca1654adaf" rel="noopener ugc nofollow" target="_blank">文章的相同模型:</a></p><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="ml mm l"/></div></figure><h1 id="484e" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用</h1><p id="7332" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们的目标是创建一个名为<code class="fe mn mo mp mq b">writeObject</code>的发布者适配器，并声明性地使用它:</p><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="ml mm l"/></div></figure><ol class=""><li id="e59c" class="mr ms it ki b kj kk kn ko kr mt kv mu kz mv ld mw mx my mz bi translated">有<code class="fe mn mo mp mq b">Output == Any</code>的发行商。它可以是提供JSON的任何东西，比如<a class="ae kf" href="https://developer.apple.com/documentation/foundation/urlsession/datataskpublisher" rel="noopener ugc nofollow" target="_blank"> URLSession。数据任务发布者</a></li><li id="e918" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">我们的目标是定义领域对象的类型和接收线程</li><li id="a72b" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">结果，看看已经打出来的有多甜😍</li></ol><h1 id="1289" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">发布者适配器</h1><p id="cd21" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">这里的目标是在幕后处理多线程。为了实现这一点，我们扩展了<a class="ae kf" href="https://developer.apple.com/documentation/combine/publisher" rel="noopener ugc nofollow" target="_blank">发布者</a>协议:</p><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="ml mm l"/></div></figure><ol class=""><li id="3e88" class="mr ms it ki b kj kk kn ko kr mt kv mu kz mv ld mw mx my mz bi translated">首先，看看返回类型<code class="fe mn mo mp mq b">AnyPublisher&lt;T, Error&gt;</code>。<code class="fe mn mo mp mq b">T</code>是结果发布者的<code class="fe mn mo mp mq b">Output</code>类型，<code class="fe mn mo mp mq b">Error</code>是它的<code class="fe mn mo mp mq b">Failure</code>类型。另外，请注意，我们只扩展了那些<code class="fe mn mo mp mq b">Output</code>和<code class="fe mn mo mp mq b">Failure</code>分别匹配<code class="fe mn mo mp mq b">Any</code>和<code class="fe mn mo mp mq b">Error</code>的发布者。关于下面第6个项目符号中的<code class="fe mn mo mp mq b">AnyPublisher</code>类型的更多信息。</li><li id="142a" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">我们将在领域发布者下创建的发布者</li><li id="c0f3" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">来自<a class="ae kf" href="https://developer.apple.com/documentation/combine/anypublisher/subscribe(on:options:)" rel="noopener ugc nofollow" target="_blank">苹果</a> : <code class="fe mn mo mp mq b">subscribe(on:) changes the execution context of upstream messages</code>。我们告诉<code class="fe mn mo mp mq b">AddObject</code>发布者在领域队列中运行</li><li id="a644" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">由Realm团队创建，它<code class="fe mn mo mp mq b">enables passing thread-confined objects to a different dispatch queue</code>。如果你删除这一行，应用程序将崩溃。</li><li id="a2ef" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">由Realm团队重载，它指定了返回线程(已经考虑了我们的<code class="fe mn mo mp mq b">ThreadSafeReference</code>)</li><li id="7647" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">清理我们的返回类型，否则，它将:<code class="fe mn mo mp mq b">RealmSwift.Publishers.DeferredHandover&lt;Combine.Publishers.SubscribeOn&lt;Combine.Publishers.FlatMap&lt;RealmSwift.Publishers.AddObject&lt;T&gt;, Self&gt;, DispatchQueue&gt;, DispatchQueue&gt;</code>👀</li></ol><h1 id="b6e2" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">出版者</h1><p id="d1b0" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们将在名为AddObject的领域发布者下创建一个自定义发布者。我们有两项任务:</p><ul class=""><li id="26e7" class="mr ms it ki b kj kk kn ko kr mt kv mu kz mv ld nf mx my mz bi translated">定义关联的类型<code class="fe mn mo mp mq b">Output</code>和<code class="fe mn mo mp mq b">Failure</code></li><li id="d465" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld nf mx my mz bi translated">为订阅者订阅订阅</li></ul><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="ml mm l"/></div></figure><ol class=""><li id="4165" class="mr ms it ki b kj kk kn ko kr mt kv mu kz mv ld mw mx my mz bi translated">将我们的输出设置为通用对象类型</li><li id="c131" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">设置我们的失败为<code class="fe mn mo mp mq b">Error</code></li><li id="b8f2" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">协议一致性，限制我们的一般<a class="ae kf" href="https://developer.apple.com/documentation/combine/subscriber" rel="noopener ugc nofollow" target="_blank">订户</a>与我们的失败和输出类型兼容。</li><li id="1515" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">我们将要创建的<a class="ae kf" href="https://developer.apple.com/documentation/combine/subscription" rel="noopener ugc nofollow" target="_blank">订阅</a></li><li id="7540" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">发布者唯一应该做的事情是:为订阅者订阅订阅</li></ol><h1 id="7d0c" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">签署</h1><p id="258c" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">这是奇迹发生的地方。订阅的职责是响应订阅者的需求请求。</p><figure class="mh mi mj mk gt ju"><div class="bz fp l di"><div class="ml mm l"/></div></figure><ol class=""><li id="b754" class="mr ms it ki b kj kk kn ko kr mt kv mu kz mv ld mw mx my mz bi translated">同样，限制我们的通用<a class="ae kf" href="https://developer.apple.com/documentation/combine/subscriber" rel="noopener ugc nofollow" target="_blank">订阅者</a>与我们的失败和输出类型兼容。</li><li id="5885" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">协议一致性，<a class="ae kf" href="https://developer.apple.com/documentation/combine/subscription/request(_:)" rel="noopener ugc nofollow" target="_blank">该功能</a>负责控制用户的<a class="ae kf" href="https://developer.apple.com/documentation/combine/subscribers/demand" rel="noopener ugc nofollow" target="_blank">需求</a>并提供正确数量的响应。我没有计算请求的数量，而是创建了一个缓存变量<code class="fe mn mo mp mq b">result</code>，并在每个请求中发送响应。不知道这是不是最好的方法，我会很感激你在这里的评论😄</li><li id="215a" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">符合<a class="ae kf" href="https://developer.apple.com/documentation/combine/cancellable" rel="noopener ugc nofollow" target="_blank">可取消</a>协议</li><li id="536c" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">将成功的结果传递给订户。</li><li id="4cbc" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">通知订阅者发布者已完成其工作</li><li id="b212" class="mr ms it ki b kj na kn nb kr nc kv nd kz ne ld mw mx my mz bi translated">将失败结果传递给订户</li></ol><h1 id="31c2" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">最终想法</h1><p id="7456" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">这是我第一次接触反应式编程和Combine框架，我真的很兴奋！联合是强大的，我期待在<a class="ae kf" href="https://www.tellusapp.com/" rel="noopener ugc nofollow" target="_blank"> Tellus </a>使用这些策略。我希望你和我一样喜欢这次旅行🚀</p><p id="ad47" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">跟随我阅读指数技术和软件开发😄</p><h1 id="5df5" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">参考</h1><div class="ng nh gp gr ni nj"><a href="https://developer.apple.com/documentation/combine" rel="noopener  ugc nofollow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd iu gy z fp no fr fs np fu fw is bi translated">Apple开发者文档</h2><div class="nq l"><p class="bd b dl z fp no fr fs np fu fw dk translated">developer.apple.com</p></div></div></div></a></div><div class="ng nh gp gr ni nj"><a href="https://github.com/realm/realm-cocoa/pull/6488" rel="noopener  ugc nofollow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd iu gy z fp no fr fs np fu fw is bi translated">通过tgoyne Pull请求#6488 realm/realm-cocoa添加对Combine/SwiftUI的支持</h2><div class="nr l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">这是目前缺少的API文档，我计划在完成发布的第一稿后编写它…</h3></div><div class="nq l"><p class="bd b dl z fp no fr fs np fu fw dk translated">github.com</p></div></div><div class="ns l"><div class="nt l nu nv nw ns nx jz nj"/></div></div></a></div><div class="ng nh gp gr ni nj"><a href="https://medium.com/flawless-app-stories/swift-combine-custom-publisher-6d1cc3dc248f" rel="noopener follow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd iu gy z fp no fr fs np fu fw is bi translated">如何在Combine中创建自定义发布者</h2><div class="nr l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">了解如何在Swift中创建自己的联合出版商</h3></div><div class="nq l"><p class="bd b dl z fp no fr fs np fu fw dk translated">medium.com</p></div></div><div class="ns l"><div class="ny l nu nv nw ns nx jz nj"/></div></div></a></div><div class="ng nh gp gr ni nj"><a href="https://thoughtbot.com/blog/lets-build-a-custom-publisher-in-combine" rel="noopener  ugc nofollow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd iu gy z fp no fr fs np fu fw is bi translated">让我们在Combine中构建一个自定义发布器</h2><div class="nr l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">在开始使用Combine，打了几个网络电话，也许还试用了Timer publisher或KVO之后…</h3></div><div class="nq l"><p class="bd b dl z fp no fr fs np fu fw dk translated">thoughtbot.com</p></div></div><div class="ns l"><div class="nz l nu nv nw ns nx jz nj"/></div></div></a></div></div></div>    
</body>
</html>