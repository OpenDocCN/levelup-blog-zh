<html>
<head>
<title>Terraform: Serverless Kubernetes Cluster with AWS EKS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform:带AWS EKS的无服务器Kubernetes集群</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/serverless-webhosting-with-aws-eks-on-fargate-using-terraform-fcd1d98170c1?source=collection_archive---------6-----------------------#2021-02-02">https://levelup.gitconnected.com/serverless-webhosting-with-aws-eks-on-fargate-using-terraform-fcd1d98170c1?source=collection_archive---------6-----------------------#2021-02-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fb0a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">与EKS一起在法盖特运行豆荚，并使用Terraform向外界展示它们</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7f7fb9ea2eaf9f5d5bc81237778ec1be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YieBnXu12EaoWnfIr66A3Q.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:谷歌</figcaption></figure><p id="a93d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi lu translated"><span class="l lv lw lx bm ly lz ma mb mc di">一个</span> <strong class="la iu"> WS Fargate </strong>是一个用于容器的无服务器计算引擎，它与<a class="ae md" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">亚马逊弹性容器服务(ECS) </strong> </a>和<a class="ae md" href="https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">亚马逊弹性库本内特服务(EKS) </strong> </a>一起工作。Fargate使您可以轻松地专注于构建应用程序。Fargate消除了供应和管理服务器的需要，允许您为每个应用程序指定和支付资源，并通过设计应用程序隔离来提高安全性。</p><p id="ceb0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">今天的世界完全是关于<strong class="la iu">敏捷</strong>和<strong class="la iu">自动化</strong>的，我们正在向<strong class="la iu">无服务器这样的新趋势发展。因此，这篇文章充满了自动化，解释了从无服务器到保护数据库，从测试到生产环境和代码管理的一切。</strong></p><p id="c547" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这篇文章解释了如何托管自己的web应用程序，比如WordPress、Owncloud等等。通过与EKS建立一个Kubernetes集群。为了完成这个设置，我们将使用<a class="ae md" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">地形</strong> </a> <strong class="la iu"> </strong>，这是一个<strong class="la iu"> IaC </strong>工具。但是如果你不熟悉terraform，那么你可以参考我的这篇文章。</p><p id="903e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从<a class="ae md" href="https://github.com/Ajaypathak372/eks-fargate-terraform.git" rel="noopener ugc nofollow" target="_blank">这里</a>获得完整的代码，这样您就可以跟随文章了</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="1c5e" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">项目描述</h1><p id="cf3a" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">在本文中，我们将首先创建网络设置，如VPC、子网等。对于EKS集群来说。然后，我们将使用受管节点组和Fargate配置文件创建一个<strong class="la iu"> EKS </strong>集群。接下来，我们将为我们的web应用程序(即Fargate上的WordPress)启动一个Kubernetes部署，并为该部署创建一个PVC(持久卷声明)。为了访问该应用程序，我们还将在Kubernetes中创建一个负载平衡器类型的服务。最后，我们为我们的web应用程序创建一个数据库。</p><p id="8cb9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这个完整的设置中，我们将使用<strong class="la iu">地形</strong>来自动化我们的工作。最后，我将通过创建我们自己的Terraform模块向您展示一件有趣的事情，即<strong class="la iu">代码管理。并将以这样一种方式构建我们的代码，即只需一个命令就可以使用相同的代码来设置测试环境和生产环境。</strong></p><p id="741a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，我试图从头开始向您展示几乎所有内容，我相信您会发现一些与Terraform和AWS相关的有趣而重要的概念:)</p><h1 id="24ea" class="ml mm it bd mn mo ni mq mr ms nj mu mv jz nk ka mx kc nl kd mz kf nm kg nb nc bi translated">先决条件</h1><ul class=""><li id="e42e" class="nn no it la b lb nd le ne lh np ll nq lp nr lt ns nt nu nv bi translated">需要有一个AWS帐户</li><li id="196e" class="nn no it la b lb nw le nx lh ny ll nz lp oa lt ns nt nu nv bi translated"><a class="ae md" href="https://www.terraform.io/downloads.html" rel="noopener ugc nofollow" target="_blank">安装和配置的地形</a></li></ul><p id="56ec" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">注意:——我用windows 10作为我的本地系统</strong></p><h2 id="b5b2" class="ob mm it bd mn oc od dn mr oe of dp mv lh og oh mx ll oi oj mz lp ok ol nb om bi translated"><strong class="ak">本文分为4个步骤:</strong></h2><ul class=""><li id="887a" class="nn no it la b lb nd le ne lh np ll nq lp nr lt ns nt nu nv bi translated"><a class="ae md" href="#b057" rel="noopener ugc nofollow">在AWS中设置网络基础设施</a></li><li id="b598" class="nn no it la b lb nw le nx lh ny ll nz lp oa lt ns nt nu nv bi translated"><a class="ae md" href="#9a71" rel="noopener ugc nofollow"> AWS EKS、Fargate和节点组</a></li><li id="f89a" class="nn no it la b lb nw le nx lh ny ll nz lp oa lt ns nt nu nv bi translated"><a class="ae md" href="#572a" rel="noopener ugc nofollow"> Kubernetes部署，PVC，web应用的负载平衡器服务</a></li><li id="33b8" class="nn no it la b lb nw le nx lh ny ll nz lp oa lt ns nt nu nv bi translated"><a class="ae md" href="#e76d" rel="noopener ugc nofollow"> AWS RDS数据库</a></li><li id="2ca5" class="nn no it la b lb nw le nx lh ny ll nz lp oa lt ns nt nu nv bi translated"><a class="ae md" href="#1e99" rel="noopener ugc nofollow">使用Terraform模块进行代码管理</a></li></ul></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="b057" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">步骤1:为EKS设置网络</h1><p id="35d2" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">这一步包括创建VPC、子网、互联网和NAT网关、路由表等。所以这部分不会花太多时间。我们创建的VPC将同时拥有公有子网和私有子网。让我们从编写VPC的代码开始。</p><p id="8e2b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，我们必须告诉Terraform我们的AWS帐户，所以我们需要先添加一个<strong class="la iu">提供者</strong></p><pre class="kj kk kl km gt on oo op oq aw or bi"><span id="80d9" class="ob mm it oo b gy os ot l ou ov">provider "aws" {<br/>  region = "ap-south-1"<br/>  profile = "Ajay"<br/>}</span></pre><p id="d7ba" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">创造VPC </strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">vpc</figcaption></figure><h2 id="d146" class="ob mm it bd mn oc od dn mr oe of dp mv lh og oh mx ll oi oj mz lp ok ol nb om bi translated"><strong class="ak">创建子网</strong></h2><p id="c13c" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">在这里，我们将创建公共和私有子网</p><p id="461d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">公共子网</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">发布子网</figcaption></figure><p id="4f03" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上述代码将在指定区域的所有<strong class="la iu">可用区域</strong>中创建一个子网，并使用VPC的CIDR创建子网CIDR。在这里，您可以注意到我为子网提供了一些标记，如果我们要使用这些子网创建EKS群集，提供这些标记非常重要。</p><ul class=""><li id="ba3b" class="nn no it la b lb lc le lf lh oy ll oz lp pa lt ns nt nu nv bi translated"><code class="fe pb pc pd oo b">kubernetes.io/cluster/{clustername}: shared</code>标签需要添加到集群应该能够使用的所有子网中</li><li id="6e5b" class="nn no it la b lb nw le nx lh ny ll nz lp oa lt ns nt nu nv bi translated"><code class="fe pb pc pd oo b">kubernetes.io/role/elb: 1</code>标签需要添加到公共子网中，以便Kubernetes知道只将这些子网用于公共负载平衡器</li><li id="453f" class="nn no it la b lb nw le nx lh ny ll nz lp oa lt ns nt nu nv bi translated"><code class="fe pb pc pd oo b">kubernetes.io/role/internal-elb: 1</code>标签需要被添加到私有子网，以便Kubernetes知道使用这些子网作为内部负载平衡器</li></ul><p id="59a5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以在这里阅读关于这些标签<a class="ae md" href="https://aws.amazon.com/premiumsupport/knowledge-center/eks-vpc-subnet-discovery/" rel="noopener ugc nofollow" target="_blank">的更多信息。</a></p><p id="7c96" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">私有子网</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">私有子网</figcaption></figure><p id="ec1b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">创建互联网和NAT网关</strong></p><p id="d37d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，我们必须为公共子网创建一个<strong class="la iu">互联网网关</strong>，为私有子网创建<strong class="la iu"> NAT网关</strong>，以便私有子网中启动的资源能够访问互联网。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">互联网和nat网关</figcaption></figure><p id="3b82" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">创建路由表</strong></p><p id="6c86" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，我们必须为公共和私有子网创建<strong class="la iu">路由表</strong>。在这些路由表中，我们使用CIDR块<strong class="la iu"> "0.0.0.0/0" </strong>创建了一条路由，这样这些子网中的资源就可以到达外部世界的任何地方。这将允许SNAT。</p><p id="6dac" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，所有公共和私有子网都需要与各自的路由表相关联。这里我使用了<strong class="la iu"> count </strong>变量将每个子网与路由表关联起来。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">路由表</figcaption></figure><h1 id="9a71" class="ml mm it bd mn mo ni mq mr ms nj mu mv jz nk ka mx kc nl kd mz kf nm kg nb nc bi translated">步骤2:使用节点组和Fargate创建EKS集群</h1><h2 id="12a0" class="ob mm it bd mn oc od dn mr oe of dp mv lh og oh mx ll oi oj mz lp ok ol nb om bi translated">EKS集群</h2><p id="caa2" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">为了用EKS创建一个Kubernetes集群，我们首先必须创建一个<strong class="la iu"> IAM角色</strong>和一些<strong class="la iu">策略</strong>，因为EKS代表你调用其他AWS服务来使用或管理与服务相关的资源。所以基本上我们必须允许EKS为我们管理事情。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">eks-iam-角色</figcaption></figure><p id="6762" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在要创建一个EKS集群，我们必须编写以下terraform代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">eks集群</figcaption></figure><h2 id="0d8c" class="ob mm it bd mn oc od dn mr oe of dp mv lh og oh mx ll oi oj mz lp ok ol nb om bi translated">节点组</h2><p id="8fb3" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">现在我们的集群已经准备好了，但是我们没有任何节点来运行我们的pod。也可以在Fargate上运行整个集群，但为此，我们必须对CoreDNS部署做一些调整，你可以在这里看到更多。</p><p id="82ce" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们实际上在Fargate上运行我们的web应用程序pods，但是我们还必须为<strong class="la iu"> kube-system </strong>名称空间创建一个节点组，它用于运行操作Kubernetes集群所需的任何pods。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">节点组iam</figcaption></figure><p id="64aa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">注意:- </strong>如果您正在使用<strong class="la iu"> "ap-south-1" </strong>区域，那么不要使用<strong class="la iu"> t2 </strong>类作为该区域的<strong class="la iu"> ap-south-1c </strong>区域不支持此类型的实例类型。</p><p id="8ea6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在上面的代码中，根据你的需要设置<code class="fe pb pc pd oo b">desired_size</code>和<code class="fe pb pc pd oo b">max_size</code>，因为在一个实例中只能发射有限的吊舱，比如在<code class="fe pb pc pd oo b">t2.micro</code>你只能发射2个吊舱，在这里阅读更多关于它的<a class="ae md" href="https://docs.aws.amazon.com/eks/latest/userguide/pod-networking.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="d073" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">类似地，对于节点组，我们必须创建单独的IAM角色和策略。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">节点组</figcaption></figure><h2 id="294b" class="ob mm it bd mn oc od dn mr oe of dp mv lh og oh mx ll oi oj mz lp ok ol nb om bi translated">法尔盖特</h2><blockquote class="pe pf pg"><p id="4a64" class="ky kz ph la b lb lc ju ld le lf jx lg pi li lj lk pj lm ln lo pk lq lr ls lt im bi translated">AWS Fargate是<strong class="la iu">无服务器</strong>意味着我们不需要担心CPU和内存使用、存储、实例<strong class="la iu">可用性</strong>和<strong class="la iu">耐用性</strong>等问题，因为AWS为我们管理所有这些事情，并且他们使用他们最好的资源来使事情始终对我们可用。</p></blockquote><p id="4e2f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了在<strong class="la iu"> Fargate(又名“无服务器”)</strong>配置中运行pod，我们首先需要创建一个<strong class="la iu"> Fargate概要文件</strong>。这个概要文件定义了名称空间和选择器，它们用于识别哪些pod应该在Fargate节点上运行。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="e849" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同样，对于fargate配置文件，我们必须创建一个pod执行角色，让Fargate控制器代表您调用AWS API。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h1 id="572a" class="ml mm it bd mn mo ni mq mr ms nj mu mv jz nk ka mx kc nl kd mz kf nm kg nb nc bi translated">步骤3:创建Kubernetes部署并在Fargate上运行它</h1><p id="6a87" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">接下来的部分主要是关于如何在Kubernetes集群上部署一个应用，如何在fargate上运行它，以及如何在负载平衡器控制器的帮助下从外部访问应用。并为应用程序创建一个PVC。</p><h2 id="5dd6" class="ob mm it bd mn oc od dn mr oe of dp mv lh og oh mx ll oi oj mz lp ok ol nb om bi translated">部署</h2><p id="27a2" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">在Kubernetes中创建<a class="ae md" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">部署</strong> </a>非常简单，部署有助于pods的滚动更新。这里我们将部署一个<a class="ae md" href="https://wordpress.org/" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">WordPress</strong></a><strong class="la iu"/>app<strong class="la iu"/>这是一个强大的托管平台，通过它，你可以轻松地创建一个漂亮的网站、博客或应用程序。还有其他应用程序，如Owncloud、Drupal等。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="ba21" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在上面的代码中，如果你注意到我已经为wordpress使用了<strong class="la iu">环境变量</strong>，由于我们不需要手动连接WordPress和数据库，这将自动获得数据库地址和登录细节，并将其与WordPress连接。</p><h2 id="370a" class="ob mm it bd mn oc od dn mr oe of dp mv lh og oh mx ll oi oj mz lp ok ol nb om bi translated">聚氯乙烯</h2><p id="6a49" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">下一件事是为部署创建一个<strong class="la iu"> PVC(永久卷声明)</strong>，这样你在wordpress中做的任何事情都将被永久保存，如果任何一个Pod关闭，你也不会丢失你的数据。</p><p id="eb8b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因为我们的Pods运行在Fargate上，而Fargate只支持<a class="ae md" href="https://aws.amazon.com/efs/#:~:text=Amazon%20EFS%20is%20a%20regional,Direct%20Connect%20or%20AWS%20VPN.&amp;text=What%20is%20Cloud%20File%20Storage%3F" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">【EFS】(弹性文件系统)</strong> </a> <strong class="la iu"> </strong>来创建PVC，所以在这里我们首先要创建一个EFS。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="cc11" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">需要将一个安全组连接到EFS，该安全组将只允许在VPC内连接到EFS。</p><p id="8c20" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，要使用这个EFS，需要创建一个存储类和一个PV(持久卷),最后是一个将由部署使用的PVC。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h2 id="6075" class="ob mm it bd mn oc od dn mr oe of dp mv lh og oh mx ll oi oj mz lp ok ol nb om bi translated">公开部署</h2><p id="f8a5" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">在kubernetes中，为了公开部署，需要创建某种类型的<a class="ae md" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>，由于我们的集群运行在AWS上，因此我们必须使用<strong class="la iu">负载平衡器</strong>类型的服务，这意味着Kubernetes将使用AWS的<strong class="la iu"> ELB </strong>服务，使应用程序可以从外部访问。</p><p id="53b1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在在AWS中有三种类型的<a class="ae md" href="https://aws.amazon.com/elasticloadbalancing/" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">【ELB(弹性负载均衡)</strong> </a> <strong class="la iu"> </strong>分别是经典、网络和应用负载均衡器。因为我们的EKS集群也有一个节点组，所以任何ELB都可以用来暴露我们的应用程序，否则<strong class="la iu"> Fargate只支持ALB和NLB </strong>。从技术上来说，所有的ELB做同样的工作，但有不同的方式来使用它们。</p><p id="af6a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了使用传统的负载平衡器，只需创建一个类型为<code class="fe pb pc pd oo b">LoadBalancer</code>的服务，如下所示</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="b8b9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要创建一个网络负载平衡器，请在元数据中的上述代码中添加这个<strong class="la iu">注释</strong></p><pre class="kj kk kl km gt on oo op oq aw or bi"><span id="26c4" class="ob mm it oo b gy os ot l ou ov">annotations = {<br/>      "service.beta.kubernetes.io/aws-load-balancer-type" = "nlb-ip"<br/>}</span></pre><p id="9b3f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在创建一个应用程序负载平衡器比其他两个负载平衡器稍微复杂一点，为此，我们需要一个<strong class="la iu">负载平衡器控制器</strong>。</p><h2 id="32b5" class="ob mm it bd mn oc od dn mr oe of dp mv lh og oh mx ll oi oj mz lp ok ol nb om bi translated">负载平衡器控制器</h2><p id="b9aa" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">为了创建一个ALB，我们需要添加一个<a class="ae md" href="https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html" rel="noopener ugc nofollow" target="_blank"> AWS负载平衡器控制器</a>(以前叫做<em class="ph"> AWS ALB入口控制器</em>)。为了使该控制器具有创建ALB以及在ALB中注册(注销)目标pod的访问权限，我们需要首先创建一个IAM角色和策略来允许这样做。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="78d5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="ph">在上面的代码中，如果你注意到我已经直接给出了IAM策略的URL，因为这个策略写起来太长了，这会使我们的代码变大，所以这就是为什么我使用了一个terraform技巧来使代码变短，但你可以在这里阅读完整的策略</em><a class="ae md" href="https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.1.0/docs/install/iam_policy.json" rel="noopener ugc nofollow" target="_blank"><em class="ph"/></a><em class="ph">。</em></p><p id="0704" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，要将上面创建的IAM角色与集群连接起来，我们需要在kubernetes集群中有一个集群角色和一个服务帐户，但是要将IAM角色用于服务帐户，您的集群必须有一个IAM <strong class="la iu"> OIDC提供者</strong>。</p><pre class="kj kk kl km gt on oo op oq aw or bi"><span id="5cc6" class="ob mm it oo b gy os ot l ou ov">data "tls_certificate" "certificate" {<br/>  url = aws_eks_cluster.eks_cluster.identity[0].oidc[0].issuer<br/>}</span><span id="65f8" class="ob mm it oo b gy pl ot l ou ov"># creating OIDC provider<br/>resource "aws_iam_openid_connect_provider" "oidc_provider" {<br/>  client_id_list  = ["sts.amazonaws.com"]<br/>  thumbprint_list = [data.tls_certificate.certificate.certificates[0].sha1_fingerprint]<br/>  url = aws_eks_cluster.eks_cluster.identity[0].oidc[0].issuer<br/>}</span></pre><p id="3140" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们可以为入口控制器创建集群角色和服务帐户</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="c382" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">负载平衡器控制器是一个在pod中运行的程序，因此要部署此控制器，我们必须在集群中创建一个部署。为了部署控制器，我借助了kubernetes中管理资源的工具<a class="ae md" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">Helm</strong></a><strong class="la iu"/>，因此它的terraform代码是</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="5d28" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">随着负载平衡器控制器的部署，现在我们可以为WordPress创建ALB，我们还创建了一个类型为<strong class="la iu"> NodePort </strong>的<strong class="la iu">服务</strong>，它将充当内部负载平衡器，并使负载平衡器控制器可以访问部署。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h1 id="e76d" class="ml mm it bd mn mo ni mq mr ms nj mu mv jz nk ka mx kc nl kd mz kf nm kg nb nc bi translated">步骤4:创建AWS RDS数据库</h1><p id="f6f1" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">在这一步中，我们将为WordPress应用程序创建一个数据库，我使用AWS <strong class="la iu"> RDS(关系数据库服务)</strong>创建数据库，这是由AWS提供的数据库即服务，通过它我们可以建立自己的RDBMS类型的数据库，它支持几乎所有的数据库引擎，如MySQL、PostgreSQL、Aurora等。你可以在这里阅读更多关于RDS <a class="ae md" href="https://aws.amazon.com/rds/" rel="noopener ugc nofollow" target="_blank">的内容</a>。</p><p id="6e7d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这里，我用私有子网中的<strong class="la iu"> <em class="ph"> RDS创建了一个MySQL数据库，因为数据库对任何公司来说都非常重要，所以这就是为什么我没有为它提供任何公共连接</em> </strong>。并且还附加了一个安全组来限制其仅在VPC内的连通性。</p><p id="fd6f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，要使用RDS创建数据库，必须使用Terraform进行以下设置:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="63a7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在RDS中，我们必须给出用户名和密码，但是如果你在团队中工作，那么你不能在<strong class="la iu">纯文本</strong>中给出密码。所以密码需要加密，为此，我们可以使用<strong class="la iu"> AWS KMS </strong>来加密秘密。</p><p id="b8b8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，用您的秘密创建一个名为<code class="fe pb pc pd oo b">db-creds.yml</code>的文件:</p><pre class="kj kk kl km gt on oo op oq aw or bi"><span id="0749" class="ob mm it oo b gy os ot l ou ov">username: admin<br/>password: password</span></pre><p id="2559" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，使用<code class="fe pb pc pd oo b">aws kms encrypt</code>命令加密该文件，并将结果密文写入<code class="fe pb pc pd oo b">db-creds.yml.encrypted</code>:</p><pre class="kj kk kl km gt on oo op oq aw or bi"><span id="c49f" class="ob mm it oo b gy os ot l ou ov">aws kms encrypt \<br/>  --key-id &lt;YOUR KMS KEY&gt; \<br/>  --region &lt;AWS REGION&gt; \<br/>  --plaintext fileb://db-creds.yml \<br/>  --output text \<br/>  --query CiphertextBlob \<br/>  &gt; db-creds.yml.encrypted</span></pre><p id="2294" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们可以在terraform中使用<code class="fe pb pc pd oo b">db-creds.yml.encrypted</code>文件来获取秘密，并且需要在terraform中编写这段代码</p><pre class="kj kk kl km gt on oo op oq aw or bi"><span id="6d6c" class="ob mm it oo b gy os ot l ou ov">data "aws_kms_secrets" "creds" {<br/>  secret {<br/>    name    = "db"<br/>    payload = file("rds-creds.yml.encrypted")<br/>  }<br/>}</span><span id="90ff" class="ob mm it oo b gy pl ot l ou ov">locals {<br/>  db_creds = yamldecode(data.aws_kms_secrets.creds.plaintext["db"])<br/>}</span></pre><p id="576f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下一次使用本地密码，就像我在上面的RDS代码中给出的一样。</p><h1 id="1e99" class="ml mm it bd mn mo ni mq mr ms nj mu mv jz nk ka mx kc nl kd mz kf nm kg nb nc bi translated">步骤5:使用Terraform模块进行代码管理</h1><p id="32b7" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">这是最后一步，但也是最重要的一步。在这一步，我们将把现有的所有terraform代码或文件转换成单独的<a class="ae md" href="https://www.terraform.io/docs/language/modules/index.html" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">模块</strong> </a>。然后只创建一个文件并使用其中的所有模块。所以这将使我们的<strong class="la iu">代码更加清晰易读。</strong></p><p id="5b2c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在下面的代码中，您可以清楚地看到我的完整存储库的树形结构，其中我为每个主要资源创建了模块，如网络、EKS集群、RDS数据库、Kubernetes。</p><pre class="kj kk kl km gt on oo op oq aw or bi"><span id="5e3b" class="ob mm it oo b gy os ot l ou ov">│   main.tf<br/>│   outputs.tf<br/>│   production.tfvars<br/>│   testing.tfvars<br/>│   variables.tf<br/>│<br/>├───eks<br/>│   ├───eks_cluster<br/>│   │       main.tf<br/>│   │       outputs.tf<br/>│   │       variables.tf<br/>│   │<br/>│   ├───eks_node_group<br/>│   │       main.tf<br/>│   │       outputs.tf<br/>│   │       variables.tf<br/>│   │<br/>│   └───fargate<br/>│           main.tf<br/>│           outputs.tf<br/>│           variables.tf<br/>│<br/>├───kubernetes<br/>│       app.tf<br/>│       aws-load-balancer-controller.tf<br/>│       main.tf<br/>│       outputs.tf<br/>│       pvc.tf<br/>│       variables.tf<br/>│<br/>├───network<br/>│       main.tf<br/>│       outputs.tf<br/>│       variables.tf<br/>│<br/>└───rds<br/>        main.tf<br/>        outputs.tf<br/>        variables.tf</span></pre><p id="5a6f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在现实世界中，我们总是创建两个环境，即<strong class="la iu">测试</strong>和<strong class="la iu">生产。</strong>在将应用程序部署到生产环境之前，首先由<strong class="la iu"> QA团队</strong>对应用程序进行测试，为此，他们需要一个与生产环境几乎相同的测试环境，唯一不同的是测试环境中的<strong class="la iu">计算能力</strong>与我们的情况不同，节点数量、副本、磁盘大小、数据库存储等将根据测试和生产环境进行设置。</p><p id="0662" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">现在，为了创建这两个环境，我们使用了完全相同的代码，但为测试和生产环境创建了不同的变量文件，因此在创建任何环境时，只需传递该环境的相应变量文件。</strong></p><p id="a59b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是包含所有模块的主文件</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="3c48" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在是时候运行我们到目前为止编写的所有代码了。所以在terraform中首先运行下面的命令，这将下载所有需要的插件。</p><pre class="kj kk kl km gt on oo op oq aw or bi"><span id="b161" class="ob mm it oo b gy os ot l ou ov">terraform init</span></pre><p id="b50b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，为两个环境创建单独的<strong class="la iu">地形工作空间</strong>，并根据环境选择工作空间</p><pre class="kj kk kl km gt on oo op oq aw or bi"><span id="5d14" class="ob mm it oo b gy os ot l ou ov"># creating workspace for testing<br/>terraform workspace new testing</span><span id="2305" class="ob mm it oo b gy pl ot l ou ov"># selecting testing workspace<br/>terraform workspace select testing</span></pre><p id="cf66" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下一步是建立完整的基础设施，这一条命令就能为我们做好一切。这是我保证的最后一个了:)</p><pre class="kj kk kl km gt on oo op oq aw or bi"><span id="501d" class="ob mm it oo b gy os ot l ou ov">terraform apply -var-file=testing.tfvars</span></pre><h2 id="9635" class="ob mm it bd mn oc od dn mr oe of dp mv lh og oh mx ll oi oj mz lp ok ol nb om bi translated">输出</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pm"><img src="../Images/ef1a951d5c87a7940c385acfea112de8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1aPdP36MJMCWWdp2aHj5fw.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">输出-1</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pn"><img src="../Images/c41cf5a51baa3416b10815a81bebbc8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QpWNRLVAT3V74_l24uJmLQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">输出-2</figcaption></figure><p id="0358" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上面是输出的一些快照，在第二个图像通知中，它打印了负载平衡器URL，您可以通过它访问您的应用程序。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi po"><img src="../Images/7244ffc70aedc46b5001bb51cd3d12a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mr8t4bL-uOGo6QNHtMCjjw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">wordpress软件</figcaption></figure><p id="7c89" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">嘣嘣！！！！</p><p id="2342" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">现在你的WordPress网站已经准备好了，你可以创建自己的漂亮文章和博客，并与世界分享……</strong></p><p id="c12f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您也可以只使用一个命令来删除相同的完整基础架构</p><pre class="kj kk kl km gt on oo op oq aw or bi"><span id="ea37" class="ob mm it oo b gy os ot l ou ov">terraform destroy -var-file=testing.tfvars</span></pre><p id="2162" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这就是如何用相同的代码管理两种环境，并且只需要根据环境需要设置变量。</p><p id="9e74" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">这都是我这边的……</strong></p><p id="1cc9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="ph">我希望你喜欢这篇文章，并了解一些有趣的概念。请与我一起关注更多这样的文章。</em></p><p id="9115" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">编码快乐！！</p><p id="47b4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这里 可以找到完整的资源库<a class="ae md" href="https://github.com/Ajaypathak372/eks-fargate-terraform.git" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">。</strong></a></p><p id="a4ad" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在Linkedin<a class="ae md" href="https://www.linkedin.com/in/ajay-pathak372" rel="noopener ugc nofollow" target="_blank">上与我联系</a></p></div></div>    
</body>
</html>