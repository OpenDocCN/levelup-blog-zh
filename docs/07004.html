<html>
<head>
<title>Deploy AWS Lambda Python functions through GitLab CI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过GitLab CI部署AWS Lambda Python函数</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/aws-lambda-in-production-deploy-python-functions-through-gitlab-ci-9c4aa1392600?source=collection_archive---------1-----------------------#2021-01-18">https://levelup.gitconnected.com/aws-lambda-in-production-deploy-python-functions-through-gitlab-ci-9c4aa1392600?source=collection_archive---------1-----------------------#2021-01-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ce4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我关于如何在<a class="ae kl" href="https://www.textcloud.co" rel="noopener ugc nofollow" target="_blank"> textcloud </a>管理我们的AWS Lambda函数系列的另一部分。尽管无服务器范例很棒，但是在处理复杂的项目时，还是会陷入重重陷阱。在本文中，我将详细介绍如何在GitLab CI上构建一个dockerized Python Lambda函数，以便在我们向存储库推送新的更改时自动部署。</p><p id="e2f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我知道，这听起来应该非常简单，不值得再写一篇文章，但是请耐心听我说:我花了两天时间才做好，我非常愿意分享我的见解，这样你就不必陷入这个兔子洞了。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="66c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这个话题，你可以在这里找到我的其他一些文章:</p><ul class=""><li id="107c" class="kt ku iq jp b jq jr ju jv jy kv kc kw kg kx kk ky kz la lb bi translated"><a class="ae kl" href="https://gntrm.medium.com/aws-lambda-in-production-deploy-a-monorepo-with-gitlab-ci-4ecc84f89263" rel="noopener">第2部分:用GitLab CI部署所有Lambda函数的mono repo</a></li><li id="5a27" class="kt ku iq jp b jq lc ju ld jy le kc lf kg lg kk ky kz la lb bi translated"><a class="ae kl" href="https://gntrm.medium.com/schedule-your-lambda-functions-with-boto3-cron-e7ee4efc887" rel="noopener">用Python和boto3编程调度Lambda函数</a></li><li id="db18" class="kt ku iq jp b jq lc ju ld jy le kc lf kg lg kk ky kz la lb bi translated"><a class="ae kl" href="https://gntrm.medium.com/goodbye-php-goodbye-mailchimp-how-to-build-a-simple-email-list-directly-from-your-landing-page-fcb776ce7085" rel="noopener">用idea+Airtable+AWS Lambda</a>建立一个邮件列表</li></ul><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi lh"><img src="../Images/2b1b34767dcb2e2c26a760e7d3ec8439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3cSXIogBuLuz3uJ2JsTDEw.png"/></div></div></figure><h1 id="8331" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">目标:Python Lambda函数的CI</h1><p id="6bd7" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk ij bi translated">我们的目标是当我们将新代码推送到GitLab存储库的某个分支时，自动部署AWS Lambda函数，例如,<code class="fe mw mx my mz b">develop</code>或<code class="fe mw mx my mz b">master</code>分支。</p><p id="2fdb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用<a class="ae kl" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">神奇的无服务器工具</a>进行部署，旁边还有<code class="fe mw mx my mz b">serverless-python-requirements</code>插件。后者是捆绑我们的Python需求所需要的。我们还配置了插件，在一个特殊的Docker容器中构建Python环境，以确保与AWS环境的兼容性。简而言之，一旦你需要编译你的一些需求(我看着你呢，NumPy)，你就需要这个了。</p><p id="f771" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为旁注，我们也依赖多普勒来管理我们的环境变量。我强烈推荐使用它们，但是当然，您也可以依赖GitLab向构建上下文提供您的env变量。</p><p id="dde7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果关键字'<strong class="jp ir">无服务器插件</strong>'和'<strong class="jp ir">构建在一个特殊的Docker容器</strong>中，对你来说是一个危险信号，那么你正处在崩溃到来的正确轨道上。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="185c" class="lt lu iq bd lv lw na ly lz ma nb mc md me nc mg mh mi nd mk ml mm ne mo mp mq bi translated">分步:使用无服务器从GitLab CI部署AWS Lambda</h1><h2 id="f2e3" class="nf lu iq bd lv ng nh dn lz ni nj dp md jy nk nl mh kc nm nn ml kg no np mp nq bi translated">在GitLab CI上运行无服务器</h2><p id="2e57" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk ij bi translated">我们开始吧！首先，我们需要能够在GitLab CI中运行无服务器工具。幸运的是，<a class="ae kl" href="https://hub.docker.com/r/amaysim/serverless" rel="noopener ugc nofollow" target="_blank">有一个Docker映像</a>，我们可以在GitLab中直接使用它来运行我们的命令。</p><p id="31a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们进展到什么程度了？最初的<code class="fe mw mx my mz b">.gitlabci.yml</code>大概是这样的:</p><figure class="li lj lk ll gt lm"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="9968" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">啊，第一条错误信息出现了:</p><p id="a551" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mw mx my mz b">Serverless plugin "serverless-python-requirements" not found. Make sure it's installed and listed in the "plugins" section of your serverless config file.</code></p><p id="98c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，让我们安装它，然后继续:</p><p id="596a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mw mx my mz b">sls plugin install -n serverless-python-requirements</code></p><p id="d276" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一个错误出现了:</p><p id="9fbd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mw mx my mz b">serverless "TypeError: Os.tmpDir is not a function"</code></p><p id="b50d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">什么？这到底是怎么回事？这与另一个我们甚至不需要的无服务器插件有关(<code class="fe mw mx my mz b">serverless-offline-python</code>)。</p><p id="9dcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不想告诉你那些血淋淋的细节。我们做了以下工作来最终让它运行起来:</p><ul class=""><li id="09b9" class="kt ku iq jp b jq jr ju jv jy kv kc kw kg kx kk ky kz la lb bi translated">从<code class="fe mw mx my mz b">serverless.yml</code>上移除<code class="fe mw mx my mz b">serverless-offline-python</code>插件</li><li id="854e" class="kt ku iq jp b jq lc ju ld jy le kc lf kg lg kk ky kz la lb bi translated">删除我们之前检入的<code class="fe mw mx my mz b">package.json</code>和<code class="fe mw mx my mz b">yarn.lock</code>文件。无服务器通过NPM安装插件，这就是文件的来源。</li></ul><p id="986f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们安装了插件，万岁！</p><h2 id="becd" class="nf lu iq bd lv ng nh dn lz ni nj dp md jy nk nl mh kc nm nn ml kg no np mp nq bi translated">可选:安装多普勒CLI</h2><p id="1233" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk ij bi translated">Doppler是一项服务，允许您在一个位置管理您的秘密，并授予对它们的细粒度访问权限。换句话说，我们将配置这个项目所需的所有环境变量都存储在Doppler中，只需要将<code class="fe mw mx my mz b">DOPPLER_TOKEN</code> env var添加到GitLab中就可以加载它们了。所有能够访问环境变量的命令都必须通过<code class="fe mw mx my mz b">doppler run -- mycommand</code>运行。</p><p id="a332" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果不用多普勒，就跳过那些部分。</p><p id="ad61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我们的<code class="fe mw mx my mz b">.gitlabci.yml</code>现在的样子:</p><figure class="li lj lk ll gt lm"><div class="bz fp l di"><div class="nr ns l"/></div></figure><h2 id="350b" class="nf lu iq bd lv ng nh dn lz ni nj dp md jy nk nl mh kc nm nn ml kg no np mp nq bi translated">为无服务器配置AWS凭据</h2><p id="c971" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk ij bi translated">我们需要无服务器能够代表我们在AWS上运行命令，所以让我们配置它:</p><p id="b978" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mw mx my mz b">doppler run --command "serverless config credentials --provider aws --key \\$AWS_ACCESS_KEY_ID --secret \\$AWS_SECRET_ACCESS_KEY"</code></p><p id="6737" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果不使用多普勒，命令应该是这样的:</p><p id="fb73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mw mx my mz b">sls config credentials --provider aws --key $AWS_ACCESS_KEY_ID --secret $AWS_SECRET_ACCESS_KEY</code>，鉴于你在GitLab内设置了<code class="fe mw mx my mz b">AWS_ACCESS_KEY_ID</code>和<code class="fe mw mx my mz b">AWS_SECRET_ACCESS_KEY</code>。</p><h2 id="cfdb" class="nf lu iq bd lv ng nh dn lz ni nj dp md jy nk nl mh kc nm nn ml kg no np mp nq bi translated">正确设置Python</h2><p id="9ffc" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk ij bi translated">对于其他设置，这一步可能是可选的，但我们在textcloud使用诗歌作为我们的Python包管理器。无服务器Python插件与poem完全兼容，但是需要安装它来打包项目以便部署。这很糟糕，但可以通过安装Python和诗歌轻松解决:</p><figure class="li lj lk ll gt lm"><div class="bz fp l di"><div class="nr ns l"/></div></figure><h2 id="15f8" class="nf lu iq bd lv ng nh dn lz ni nj dp md jy nk nl mh kc nm nn ml kg no np mp nq bi translated">是时候让Docker恢复正常了</h2><p id="4517" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk ij bi translated">现在，几个小时过去了，我们还远没有完成。下一个弹出的错误信息是:<code class="fe mw mx my mz b">docker: command not found</code></p><p id="a57a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">啊，对了，我们需要Docker以AWS兼容的方式打包我们的Python项目。让我们安装它，并在GitLab中添加一个Docker-in-Docker服务:<code class="fe mw mx my mz b">apk add docker</code>和<code class="fe mw mx my mz b">services: ['docker:dind']</code>应该就可以了。</p><p id="3d7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了当他们不:<code class="fe mw mx my mz b">Cannot connect to the Docker daemon at unix:///var/run/docker.sock</code></p><p id="0dfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再说一遍，我不想浪费你沮丧的时间，直接跳到解决方案。GitLab论坛中有很长的线程，但是我们必须告诉Docker客户端使用在自己机器之外运行的Docker安装。此外，我们需要添加一些其他配置，即使在今天，我还没有完全弄清楚。</p><p id="c264" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在它应该运行了！但事实并非如此。我仍然不确定这一步是否绝对必要，但我们必须确保容器中的Docker客户机与Docker-in-Docker服务中的客户机版本相同。为了适应未来，我们必须修正版本。</p><h1 id="66cd" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">我们终于到了！</h1><p id="00ae" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk ij bi translated">有了这些小怪癖，它终于工作了:我们从Doppler加载了我们的秘密，我们成功地正确安装了无服务器插件，我们安装了Python和poems，正确使用了Docker，并登录到AWS。是时候开一瓶啤酒，到此为止了！</p><p id="07c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我们的最终配置:</p><figure class="li lj lk ll gt lm"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="e668" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编码快乐！或者如果AWS已经让你落泪，<a class="ae kl" href="https://www.textcloud.co/" rel="noopener ugc nofollow" target="_blank">看看textcloud，看看工作流自动化+自然语言处理</a>如何通过自动化复杂的工作来帮助你的公司节省时间和金钱:)</p><p id="7953" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您在让AWS Lambda与GitLab CI一起工作时遇到问题，请随时联系我！</p></div></div>    
</body>
</html>