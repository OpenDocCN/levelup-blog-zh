<html>
<head>
<title>HTTP Strict Transport Security FAQs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HTTP严格传输安全常见问题</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/http-strict-transport-security-faqs-844e00ac385c?source=collection_archive---------6-----------------------#2021-07-08">https://levelup.gitconnected.com/http-strict-transport-security-faqs-844e00ac385c?source=collection_archive---------6-----------------------#2021-07-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2e19" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于HSTS和预载的一些问答</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/65f90342f00308212dec19b244bddbd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aQF5O9qqSppIwcdn"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">亚历山德罗·萨基在<a class="ae ky" href="https://unsplash.com/photos/NUFnfYd09iI" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="13c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是我在学习HSTS时想到的一些问题，以及相应的答案。</p><h2 id="2ca1" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">什么是HSTS？</h2><p id="01a2" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">严格传输安全标头如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/6c0f501a83773fcfcd41954971f77ee1.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*HJgfR4q-W27fCIb-SigmYw.png"/></div></figure><p id="4bf8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它在网站的响应中返回，让浏览器知道从现在开始它应该只尝试使用HTTPS访问网站。</p><p id="ae90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在你的浏览器接收到HSTS报头后，下次你去http://facebook.com的<a class="ae ky" href="http://facebook.com," rel="noopener ugc nofollow" target="_blank">，</a>时，你的浏览器不会真的发出请求，它会做一个“内部重定向”(HTTP 307)，而是请求<a class="ae ky" href="https://facebook.com" rel="noopener ugc nofollow" target="_blank">https://facebook.com</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/945ca4c8bd41590cc7913e6014ef7069.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*T8VGnhGEkWqmVR6l0cQVdw.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">浏览器只知道使用HTTPS，并相应地重定向</figcaption></figure><p id="aee4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这和你在浏览器的地址栏中输入<a class="ae ky" href="https://facebook.com" rel="noopener ugc nofollow" target="_blank">https://facebook.com</a>的效果是一样的。</p><h2 id="29e1" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">HSTS有什么意义？</h2><p id="16b1" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">想象一下，你在机场，一名黑客从他们的笔记本电脑上设置了一个公共Wi-Fi，并托管了一个假版本的http://facebook.com。你去<a class="ae ky" href="http://facebook.com" rel="noopener ugc nofollow" target="_blank">http://facebook.com</a>，黑客得到你的用户名/密码。</p><p id="e7cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">多亏了HSTS，如果你已经访问过https://facebook.com，你的浏览器应该已经收到了HSTS的标题，并且知道从那时起使用HTTPS的版本。</p><p id="a972" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是如果你还没有访问过HTTPS版本呢？</p><h2 id="5e0b" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">事先装好</h2><p id="45b5" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">如果用户第一次通过黑客的公共Wi-Fi访问<a class="ae ky" href="http://facebook.com" rel="noopener ugc nofollow" target="_blank">http://facebook.com</a>，浏览器不知道要重定向到HTTPS，用户的账户就会受到威胁。</p><p id="e89c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是<a class="ae ky" href="https://hstspreload.org/" rel="noopener ugc nofollow" target="_blank">预载</a>发挥作用的地方。谷歌维护着一个硬编码到Chrome和其他浏览器中的域名列表。当你第一次使用HTTP进入这些域之一时，浏览器将把你重定向到HTTPS版本，即使你的浏览器还没有收到HSTS报头。</p><p id="2e6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这解决了前面提到的公共Wi-Fi的安全风险。</p><h2 id="97cc" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">预载要求</h2><p id="2770" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">预载有<a class="ae ky" href="https://hstspreload.org/" rel="noopener ugc nofollow" target="_blank">要求</a>，你可以阅读相关内容。预载的有效HSTS标头示例如下:</p><p id="9fb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mv mw mx my b">Strict-Transport-Security:</code> <code class="fe mv mw mx my b">max-age=63072000; includeSubDomains; preload</code></p><p id="39ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有一点要注意的是，你只能注册域名，即。没有子域。</p><h2 id="359c" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">为什么不能注册子域？</h2><p id="2dee" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">HSTS预加载列表以二进制形式发送到全球数十亿个浏览器客户端，这使得控制该列表的大小变得非常重要。</p><p id="3dd9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了使该列表尽可能小，并确保列表中的每个条目为用户提供最广泛的价值，HSTS预加载列表的政策是预加载TLD和可注册域名，通常称为eTLD + 1(其中eTLD由<a class="ae ky" href="https://publicsuffix.org/" rel="noopener ugc nofollow" target="_blank">公共后缀列表</a>确定，而+ 1意味着加上一个额外的标签)。</p><p id="0e4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">预加载子域名仍然允许将来预加载其他子域名(或可注册域名本身)，这应该通过预加载可注册域名并对其下的域名授予HTTPS强制执行权限来处理。</p><h2 id="b9d6" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">错误:HTTP首先重定向到www</h2><p id="7c7d" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我在检查我的网站的资格时发现了这个错误:</p><pre class="kj kk kl km gt mz my na nb aw nc bi"><span id="dda0" class="lv lw it my b gy nd ne l nf ng">Error: HTTP redirects to www first</span><span id="c5e2" class="lv lw it my b gy nh ne l nf ng">http://website1.com (HTTP) should immediately redirect to https://website1.com (HTTPS) before adding the www subdomain.</span><span id="1e54" class="lv lw it my b gy nh ne l nf ng">Right now, the first redirect is to https://www.website1.com/.<br/>The extra redirect is required to ensure that any browser which supports HSTS will record the HSTS entry for the top level domain, not just the subdomain.</span></pre><p id="3e6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为什么<a class="ae ky" href="http://website1.com" rel="noopener ugc nofollow" target="_blank">http://website1.com</a>不能直接使用预加载重定向到<a class="ae ky" href="http://website1.com" rel="noopener ugc nofollow" target="_blank">https://website1.com</a>，而不管它当前重定向到<a class="ae ky" href="https://www.website1.com/" rel="noopener ugc nofollow" target="_blank">https://www.website1.com</a>的事实？</p><p id="09b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要回答这个问题，想想如果你有另一个子域，<a class="ae ky" href="http://sub.website1.com," rel="noopener ugc nofollow" target="_blank">http://sub.website1.com，</a>只使用HTTP运行会发生什么。</p><p id="82d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果谷歌让你预装<a class="ae ky" href="http://website1.com/" rel="noopener ugc nofollow" target="_blank">http://website1.com</a>，那么所有的子域名都会被内部重定向到HTTPS版本，这将导致<a class="ae ky" href="http://sub.website1.com," rel="noopener ugc nofollow" target="_blank">http://sub.website1.com</a>不再工作，因为用户会被重定向到<a class="ae ky" href="http://sub.website1.com," rel="noopener ugc nofollow" target="_blank">https://sub.website1.com</a>。</p><p id="7f68" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">谷歌强迫你自己先发现这些问题(在你的网站开启半永久预加载功能之前)，强迫你将用户重定向到<a class="ae ky" href="https://website1.com/" rel="noopener ugc nofollow" target="_blank">https://website1.com</a>，这样当HSTS的标题返回时，浏览器就知道使用HTTPS作为顶级域名和所有子域。</p><p id="c172" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个想法是，你会发现HTTP子域的问题，并在预加载设置之前修复它们，这是<a class="ae ky" href="https://bugs.chromium.org/p/chromium/issues/detail?id=527947" rel="noopener ugc nofollow" target="_blank">一旦到位</a>很难删除的。</p><h2 id="fa88" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">如果我从HTTP网站返回HSTS头会发生什么？</h2><p id="6c35" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">如果从使用HTTP的网站返回，浏览器将忽略HSTS头。</p><p id="3abf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是因为浏览器没有办法知道网站是否真实。你可能在一个恶意的公共Wi-Fi上，就像我们之前描述的那样。</p><p id="954f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">黑客可以插入或删除HSTS报头，所以浏览器没有必要关注它。</p><p id="1c34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果一个网站没有设置HTTPS，并且浏览器没有忽略HTTP上的HSTS，那么黑客可以通过HTTP返回HSTS报头，给网站的用户造成问题。当用户下一次通过家里的Wi-Fi访问该网站时，浏览器会将HTTPS用于专为HTTP设计的网站，这将导致404未找到。</p><h2 id="6e0d" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">摘要</h2><p id="078f" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">HSTS是一个很好的安全特性，但是你真的需要考虑预加载的含义，以及以后可能必须移除它的风险，这是很困难的，是否值得为这种特殊情况提供额外的安全层。</p><p id="ad2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除非你运营一个知名网站，否则你的某个用户第一次通过公共Wi-Fi访问你的网站，以及有黑客运行该Wi-Fi的可能性非常小。</p></div></div>    
</body>
</html>