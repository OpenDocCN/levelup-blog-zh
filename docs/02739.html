<html>
<head>
<title>Configure CI/CD pipelines for NodeJs Applications with Azure DevOps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure DevOps为NodeJs应用程序配置CI/CD管道</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/configure-ci-cd-pipelines-for-nodejs-applications-with-azure-devops-44e7425f5a99?source=collection_archive---------0-----------------------#2020-04-02">https://levelup.gitconnected.com/configure-ci-cd-pipelines-for-nodejs-applications-with-azure-devops-44e7425f5a99?source=collection_archive---------0-----------------------#2020-04-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9bf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Azure DevOps管道来构建和测试Node.js应用，然后部署或发布到Azure应用服务。以下是完整CI/CD工作流要执行的步骤。</p><ol class=""><li id="711d" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">在开发分支中开发并提交您的代码。</li><li id="cbba" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">从开发分支推代码到→测试分支→主分支。</li><li id="02de" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">在不同的环境中部署您的代码；在Azure DevOps中使用CI/CD管道进行开发→测试→生产。</li></ol><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi kz"><img src="../Images/b665ad2be9bc5be00cf5d85fc488e4ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fuWGU5SbGDryj3cIS979Ag.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">用于NodeJs/Javascript应用程序的0.1 Azure DevOps CI/CD工作流</figcaption></figure></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="dce0" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">创建生成管道</h1><ul class=""><li id="4380" class="kl km iq jp b jq mu ju mv jy mw kc mx kg my kk mz kr ks kt bi translated">前往<a class="ae na" href="http://dev.azure.com/$" rel="noopener ugc nofollow" target="_blank">dev.azure.com/</a>{组织名称} →选择项目→管道</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nb"><img src="../Images/e5189c6b4f648a5652168b564be47c63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*iiGwF1OFVIGjXeXW6rLQvQ.gif"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.1转到项目→管道</figcaption></figure><ul class=""><li id="323b" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">创建新管道→使用Azure Git Repos (YAML)创建管道作为代码，或者使用<strong class="jp ir">经典编辑器</strong>从可视化设计器创建管道。对于本教程，我们将使用经典编辑器。</li><li id="4598" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">选择源存储库→选择项目名称→选择存储库→选择分支名称→单击继续。</li><li id="430d" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">选择模板作为<strong class="jp ir">空工单。</strong></li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nb"><img src="../Images/0c383fc2992df34145f4c8b8f92dcdf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*p2FzyoBs3oCOqvnfhlbb8A.gif"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.2使用经典编辑器创建新管道</figcaption></figure><ul class=""><li id="c4fa" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">根据您组织的命名约定更改构建管道的名称→根据需求选择<strong class="jp ir">代理池</strong>{ Hosted vs 2017-win 2016 for Windows Environment&amp;Hosted Ubuntu 18.04 for Linux based Environment }。</li><li id="b044" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">将这些代理想象成具有不同操作系统风格的虚拟机。</li><li id="542f" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">除非您知道自己在做什么，否则最好使用Microsoft托管代理，而不是自托管代理😕</li><li id="bc1d" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">选择Tag Sources → on success，以便在构建成功时创建<a class="ae na" href="https://git-scm.com/book/en/v2/Git-Basics-Tagging" rel="noopener ugc nofollow" target="_blank"> git标记</a>。您可以将标记格式保持为<strong class="jp ir"> $(build.buildNumber)或v$(build.buildNumber)。</strong></li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nb"><img src="../Images/a4b5f2110d28710033b11005cebfb50f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Is7r6LVGceme2WI-bUQ43A.gif"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.3选择代理池</figcaption></figure><ul class=""><li id="e11e" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">点击添加任务(+) →搜索任务→添加任务</li><li id="da66" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">您可以添加多个任务。</li><li id="0850" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">如果任务在您的组织中不可用，您可以从Marketplace安装它。</li></ul><h1 id="995e" class="lw lx iq bd ly lz nc mb mc md nd mf mg mh ne mj mk ml nf mn mo mp ng mr ms mt bi translated">任务详细信息</h1><ul class=""><li id="370b" class="kl km iq jp b jq mu ju mv jy mw kc mx kg my kk mz kr ks kt bi translated"><strong class="jp ir"> NodeJS工具安装器</strong>——查找或下载并缓存Node.js的指定版本规范，并将其添加到PATH中</li><li id="0bc3" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">最新的LTS节点版本已安装在代理上，由Microsoft管理。如果您在项目中使用特定版本的Node，则使用此任务指定您想要使用的确切版本。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/c3cf30818009aa74dd7f0dba18e699bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*88uQJq89J4FvZ_-7GdMsbg.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.4节点。Js工具安装程序任务</figcaption></figure><ul class=""><li id="2499" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated"><strong class="jp ir"> npm任务- </strong>安装并发布NPM软件包，或者运行NPM命令。支持npmjs.com和认证注册中心，如Azure工件。</li><li id="b29c" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">可用命令:CI、安装、发布、自定义。</li><li id="043d" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">对于自定义命令，不需要预先考虑npm。</li><li id="839b" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">包含包文件夹的根目录:<strong class="jp ir"> ${Build。SourcesDirectory}- </strong>它是一个预定义的变量。代理上下载源代码文件的本地路径。例如:c:\agent\_work\1\s .这些变量由系统自动设置，只读。</li><li id="77ec" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">关于预定义变量的更多信息:转到<a class="ae na" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&amp;tabs=yaml" rel="noopener ugc nofollow" target="_blank">预定义变量</a></li><li id="d293" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">一项任务可以有多个版本。确保使用稳定版本，避免使用预览版本。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/d774e265c8e1f9c37e7794de8cd02423.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gYLDeGXErsJHru_WyGeHDg.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.5安装盖茨比命令行界面</figcaption></figure><ul class=""><li id="e1d1" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">npm <strong class="jp ir"> install </strong>命令将在开发环境(默认)中的包目录内运行时安装<strong class="jp ir"> devDependencies </strong>以及其他<strong class="jp ir">依赖项</strong>。</li><li id="a2ca" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">每次触发新的构建时，都会有一个新的代理实例，它不包含任何npm缓存。</li><li id="b049" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">避免在生产环境中安装<strong class="jp ir"> devDependencies </strong>。使用自定义命令→ <strong class="jp ir"> install — only=prod </strong></li><li id="65b4" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">我们可以为单元测试、林挺等添加npm任务。如果测试成功，那么唯一的管道将会成功。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/37e07726b2a2804243e0dd6b7fdfdadb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sooj0basmxK3gOVI8z0rtg.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.6安装节点模块</figcaption></figure><ul class=""><li id="a852" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">使用环境变量来参数化命令。使用<strong class="jp ir">运行构建-$(变量名)→ </strong>转到<strong class="jp ir">变量选项卡</strong> → <strong class="jp ir">添加变量</strong> → <strong class="jp ir">变量名→值</strong></li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/9768b2abe6d0843aed22db209474b1d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NbvwaJrYrkZ76wsgbcxndg.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.7构建解决方案</figcaption></figure><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/dfc77566f013f927fe7f0a5dcce8baa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q2rUuzgqXzEvYFhd7DByiQ.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.8添加环境变量</figcaption></figure><ul class=""><li id="d142" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated"><strong class="jp ir">归档文件:</strong>将文件压缩成. 7z、. tar.gz或. zip。</li><li id="5a7a" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">我们将进行zip部署以减少部署时间。我们也可以使用复制任务来创建工件，但是由于将会有大量的文件，所以与zip部署相比，它将会更慢。在这里找到更多关于zip部署的信息。</li><li id="6faa" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">指定要存档的文件夹/目录。公开的/公开的。</li><li id="5861" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">指定将创建的归档文件名。</li><li id="4636" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated"><strong class="jp ir">添加根文件夹名称</strong>→该复选框将创建一个具有存档名称的文件夹，并在存档前将所有文件放入该文件夹。</li><li id="ffcb" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">替换现有的档案库 -这个复选框将在每次新构建时创建新的档案库之前删除以前的档案库。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/4c7e23432405d449ae636ee097abe9de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AGceUNt65xCz2yxrtdn2GA.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.9归档可部署的组件</figcaption></figure><ul class=""><li id="922b" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated"><strong class="jp ir">发布构建工件:</strong>将构建工件发布到Azure管道或Windows文件共享。</li><li id="162d" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">保留默认设置。</li><li id="5d39" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">您可以给出一个定制的工件名称。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/ef5bfaab3eb549bcc841752c96b62f39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xFEUlyJ8KBQ50MHqCOapvQ.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.10发布构建工件</figcaption></figure><ul class=""><li id="dc33" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">启用持续集成，以便在过滤器分支发生任何变化时触发构建管道。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/153864411cfbf928589f8e0b4cebc6bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vGXb2Bn2q9O8M7WHVphjYw.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.11实现持续集成</figcaption></figure><ul class=""><li id="12dc" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">内部版本号格式将创建内部版本号作为<strong class="jp ir">专业。minor . patch . uniqueid</strong>→1.0.0.1(语义版本化)</li><li id="3152" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">buildId的语义版本将更有意义🤔而不仅仅是一个唯一的编号作为buildId。</li><li id="5459" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">建造。BuildId是一个预定义的变量，每当一个新的构建被赋予组织级别的范围(1，2，3…n)。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/2b642924b6172ee488cc375f7d3433a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nZ0WWCK1bSEFDW8vG8UIQw.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.12自定义内部版本号格式以使用语义版本化</figcaption></figure><ul class=""><li id="54bb" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">在变量选项卡中添加变量Major、Minor和Patch。</li><li id="00df" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">Major- 1，Minor- 0，Patch-<strong class="jp ir">$[counter(format(' { 0 })。“{1}”，变量['大调']，变量['小调']，0)] </strong></li><li id="e383" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">补丁变量将从0开始，并在每次触发新构建时递增。当主要或次要值改变/增加时，它将重置为0。</li><li id="c6ae" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">保持这两个变量在运行时可设置，以便应用程序团队可以在运行时更改主/次版本。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/c2d0dc8295f0425c8807e216a306be1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6p59kccxFfbMUPzTzHRt1A.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.13为主要变量、次要变量和补丁变量添加计数器</figcaption></figure><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi ni"><img src="../Images/9518e5c48b1bbab839a98a37806abc35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qbvwd_mu-cIcW4dmcEFF0w.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.14自定义BuildId-语义版本化</figcaption></figure><ul class=""><li id="532a" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">我们还可以安排构建时间</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/ccd33ae13da4e6724cd17b85d3f856ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pL3D0cbXx2DOz5k60e81HQ.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.15构建调度程序</figcaption></figure><ul class=""><li id="4190" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated"><strong class="jp ir"> History选项卡:</strong>查看对构建管道所做更改的历史，并比较差异。</li><li id="9d77" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">使用<strong class="jp ir"> Revert Pipeline </strong>选项，也可以将管道恢复到之前的状态。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/33454c0f85013b469401aee283fed947.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1rqu4juNDLWUncdBSHAYNA.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.16历史选项卡，用于比较和恢复更改</figcaption></figure><h1 id="ff3d" class="lw lx iq bd ly lz nc mb mc md nd mf mg mh ne mj mk ml nf mn mo mp ng mr ms mt bi translated">如果您必须在您的项目中创建许多将使用同一组任务的管道，该怎么办🤔</h1><p id="514a" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy nj ka kb kc nk ke kf kg nl ki kj kk ij bi translated"><strong class="jp ir">任务组:</strong>如果在不同的管道中有相似的任务，无论是在同一个项目中还是在不同的项目中，您都可以从现有的管道任务中创建任务组，如图所示。选择所有任务，右键单击→选择创建任务组。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nb"><img src="../Images/0c77085b5b03e7fd00efcaed8daf4170.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*LAH-hRqZzl87uh-0hdCpgg.gif"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.17任务组</figcaption></figure><ul class=""><li id="56e8" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">如果任务中的参数不同，那么您可以将其编写为variable $(variable-name ),当您将其添加为任务组时，它会要求您提供值，如下图所示。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/8d205472a27f041498e392dfa7b3e6e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6siRtk2p51eXoofh_tDMTg.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.18任务组中的参数</figcaption></figure><ul class=""><li id="8434" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">我们可以导出和导入任务组，以便在多个Azure DevOps项目中使用它。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/ea75ad9690bc2e8333d7a53911988e52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PIj9zIG9-pSjO-LeolufmA.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.19出口任务组</figcaption></figure><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nb"><img src="../Images/14c1accb21d844000ff885f1983ed789.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*blZ6M84xQgB4HLW9aD2L4Q.gif"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">1.20导入任务组</figcaption></figure></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="d31c" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">创建发布管道</h1><ul class=""><li id="6500" class="kl km iq jp b jq mu ju mv jy mw kc mx kg my kk mz kr ks kt bi translated">转到<a class="ae na" href="http://dev.azure.com/$" rel="noopener ugc nofollow" target="_blank">dev.azure.com/</a>{组织名称} →选择项目→管道→发布。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/a0787c024ad6f3202df21c64f0034f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PTtgyI1A2YVc9IuuINxrjw.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.1创建发布渠道</figcaption></figure><ul class=""><li id="4e56" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">新管道→选择<strong class="jp ir">空作业</strong></li><li id="6daa" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">重命名阶段</li><li id="3fbe" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">点击添加工件→选择源构建管道→默认版本:最新→工件别名:默认→添加</li><li id="c688" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated"><strong class="jp ir">源别名:</strong>它将在代理中创建一个具有相同名称源别名的文件夹(在我们的例子中为<em class="nm"> _Medium-Blogs-CI-Prod </em>)。工件将存储在代理的这个文件夹中。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nb"><img src="../Images/0d975328012d9465b7533f61cdf70748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*n_3FfJYMk3NZdEeWAcx56g.gif"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.2发布管道中的阶段</figcaption></figure><ul class=""><li id="c9b6" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">启用<strong class="jp ir">连续部署。</strong>每当与此管道相关的新版本可用时，都会触发新版本。</li><li id="307b" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">启用分支筛选器，仅从选定的分支触发释放。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/a91314b07f372e1cd8c113a87335b6f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KcNF6eV17-GGgzddN3PNUg.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.3持续部署触发器</figcaption></figure><ul class=""><li id="7442" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">编辑管道名称→添加任务:Azure应用服务部署</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/cc1c3e8d46c6f32efb6a462db71aa4dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eh8PkLWDu2cYVHTPHMoeNA.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.4在代理作业中添加任务</figcaption></figure><ul class=""><li id="0de2" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">转到代理作业→根据要求选择<strong class="jp ir">代理池</strong>{用于Windows环境的托管vs 2017-win 2016&amp;用于基于Linux的环境的托管Ubuntu 18.04。</li><li id="41b1" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">除非您知道自己在做什么，否则最好使用Microsoft托管代理，而不是自托管代理😕</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/3bf9e5494c28985ee5f12e097626a2b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XbnifYo390HaBfEASqFtWA.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.5代理规格</figcaption></figure><ul class=""><li id="ca1a" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">为基于windows的计算机选择应用服务类型作为Windows上的Web应用(任务版本4) / Web应用(任务版本3)。</li><li id="e52b" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">仅对生产管道选中“部署到插槽”</li><li id="978c" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">包或文件夹:<strong class="jp ir"> $(系统。DefaultWorkingDirectory)/**/*。zip </strong> →该选项将在默认工作目录中查找任何zip文件。示例位置:-链接的工件→工件别名→工件名称→ ${BuildId}。活力</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/6d6983ab8e728a524e7143a48f918d16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ShuZNGMWSJ86KBDq48Xlg.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.6 Azure应用服务部署任务</figcaption></figure><ul class=""><li id="e855" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated"><strong class="jp ir">附加部署选项</strong>:如果未选中，它将根据您的应用类型、包格式和其他参数自动检测最佳部署方法。选择选项以查看支持的部署方法，并选择一种方法来部署您的应用程序。</li><li id="1c24" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated"><strong class="jp ir">使应用程序离线</strong>:在同步操作开始之前，通过将app_offline.htm文件放在应用程序服务的根目录中，选择使Azure应用程序服务离线的选项。同步操作成功完成后，该文件将被删除。</li><li id="1ad1" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated"><strong class="jp ir">删除目标位置的其他文件</strong>:选择该选项可删除Azure应用服务上的文件，这些文件在应用服务包或文件夹中没有匹配的文件。注意:这还将删除与此Azure应用服务上安装的任何扩展相关的所有文件。要防止这种情况，请选择“从App_Data文件夹中排除文件”复选框。</li><li id="b21e" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated"><strong class="jp ir">从App_Data文件夹中排除文件</strong>:选择该选项可防止App_Data文件夹中的文件被部署到Azure App Service或从Azure App Service中删除。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/839fae62e01afe0dc8577f51517bff08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8EXuk0f5AJMZJjQ2PnfoGA.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.7其他部署选项</figcaption></figure><h1 id="598a" class="lw lx iq bd ly lz nc mb mc md nd mf mg mh ne mj mk ml nf mn mo mp ng mr ms mt bi translated">如果web应用程序不是静态的呢🤔</h1><p id="3df0" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy nj ka kb kc nk ke kf kg nl ki kj kk ij bi translated">我们将不得不在Azure应用服务上启动一个节点服务器来服务这些请求。</p><ul class=""><li id="0cc2" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">要在windows应用服务中启动节点服务器，我们必须在目录的根目录中包含一个web.config文件。</li><li id="bcf7" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">要在发布期间创建web.config文件，请转到<strong class="jp ir">文件转换&amp;变量替换选项→检查生成web。Config </strong>复选框，提供web.config文件的参数，如服务器文件名、app类型等。它将生成一个web.config文件，该文件将在web应用程序中启动node.exe服务器</li><li id="db2f" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">web.config文件可能因应用程序而异。因此，使用一个自定义的web.config文件，并将其保存在源代码中，而不是在运行时生成。当它生成web.config文件时，它首先尝试在一个临时位置(有限的内存)解压缩工件zip文件，然后将配置文件放入其中，然后再次压缩。这需要很多时间，如果zip文件包含太多文件，那么它可能会由于内存限制而失败。它使用一个节点包来压缩和解压缩文件。我在有大量文件的多个应用程序中遇到过这个问题。一种解决方法是在构建管道中使用复制任务，而不是归档任务，但这会降低管道的速度。</li><li id="d095" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated"><strong class="jp ir">部署后选项:</strong>这些脚本将在成功部署软件包后运行。您可以在设计器本身中给出一个内联脚本，或者可以使用工件目录中的脚本文件。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nn"><img src="../Images/d87c760131bdb9f37e3758cabc574588.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r-zDLQj2QklWb5OjYbvaVg.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.8生成web.config文件</figcaption></figure><h2 id="ab1a" class="no lx iq bd ly np nq dn mc nr ns dp mg jy nt nu mk kc nv nw mo kg nx ny ms nz bi translated">对于生产流水线，我们将不得不为插槽交换增加一个阶段。</h2><ul class=""><li id="67a7" class="kl km iq jp b jq mu ju mv jy mw kc mx kg my kk mz kr ks kt bi translated">在生产管道中添加一个新阶段用于插槽交换。</li><li id="29fd" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">首先需要在app service中创建一个名为Inactive/canary(取决于部署类型)的新插槽。</li><li id="71c0" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">在第一个插槽(非活动插槽)中，选中复选框- <strong class="jp ir">部署到插槽或应用服务环境→ </strong>提供插槽名称(非活动/淡黄色)。</li><li id="450b" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">它将首先在非活动/淡黄色插槽中部署程序包，然后将其与活动插槽交换。这将确保生产部署中的零停机时间。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/01d91e705529ed72bd47fb4b9ffc4614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VsEMJ6E_3wFCC8QyFkItHQ.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.9检查→部署到插槽或App服务环境→非活动插槽</figcaption></figure><ul class=""><li id="0370" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">由于一个插槽也托管一个应用程序，所以它也将消耗ASP的内存，这可能会降低生产应用程序的性能。</li><li id="ec4e" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">因此，我们将在不使用时停止金丝雀/非活动插槽，即在插槽交换后，并在金丝雀/非活动插槽中部署之前启动插槽。</li><li id="5828" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated">在Azure App Service Deploy任务之前添加<strong class="jp ir"> Azure App Service Manage </strong>任务，并将Action设置为<strong class="jp ir"> Start App Service </strong></li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/1b4175b161d574c1cab89c3a67b8d7b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EQNJhNLWgTzHQaeePyE67Q.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.10此任务将在部署前启动非活动插槽</figcaption></figure><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nb"><img src="../Images/9e0a66c7197e6230b74c1b37a27eb5d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*YcASkeO7iePnwS5M6oXpmQ.gif"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.11添加插槽交换阶段</figcaption></figure><ul class=""><li id="a288" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated"><strong class="jp ir">预部署条件:</strong>选择此选项为插槽交换阶段添加批准者。您可以添加多个批准人或一组批准人。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nb"><img src="../Images/89a2155dd5047b3c52e7dae9798480ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*STFZuNv55wy029VMSgTgBA.gif"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.12部署前批准</figcaption></figure><ul class=""><li id="a65b" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">添加任务- <strong class="jp ir"> Azure应用服务管理器</strong>，它可以启动、停止、重启、插槽交换、安装站点扩展或启用对Azure应用服务的持续监控</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/a65e64e10ca8eacc881e7d80e9ed3761.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BeiXfiZf2FFoSop_AAN0vw.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.13插槽交换</figcaption></figure><ul class=""><li id="a271" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated">在插槽交换完成后，我们将停止非活动/金丝雀插槽，以减少不必要的资源消耗。</li></ul><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/9cf83209d11ba986abb7df79d36be706.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-XA7Rjgyp7wqaQqjVNTgcA.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">2.14部署前启动插槽</figcaption></figure><h1 id="b813" class="lw lx iq bd ly lz nc mb mc md nd mf mg mh ne mj mk ml nf mn mo mp ng mr ms mt bi translated">改进的余地</h1><ol class=""><li id="0c38" class="kl km iq jp b jq mu ju mv jy mw kc mx kg my kk kq kr ks kt bi translated">IaC(作为代码的基础设施)——这篇文章是为初学者准备的。如果你已经熟悉CI/CD管道，那么多级YAML管道是一个不错的选择。</li><li id="c725" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">通过使用npm缓存❗❓提高构建管道性能</li><li id="700e" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">在构建管道中使用像SonarQube这样的静态代码分析工具。</li><li id="bd37" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">构建对拉请求的验证。</li></ol><p id="5751" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">如果您需要任何帮助或有任何建议，请通过</strong> <a class="ae na" href="https://www.linkedin.com/in/aniketprashar" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> LinkedIn </strong> </a>与我联系</p></div></div>    
</body>
</html>