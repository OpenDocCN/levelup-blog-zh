<html>
<head>
<title>Handle React state inside an event listener callback</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">处理事件侦听器回调中的反应状态</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/handle-react-state-inside-an-event-listener-callback-2c37399c3e0c?source=collection_archive---------4-----------------------#2021-11-24">https://levelup.gitconnected.com/handle-react-state-inside-an-event-listener-callback-2c37399c3e0c?source=collection_archive---------4-----------------------#2021-11-24</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="6a6b" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">而无需在每次渲染时重新创建函数。</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/b28e95c9a883d2aeaff52135b596ad2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sPiAmmzN_zK80iTK"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@ejleusink?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Erik-Jan Leusink </a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="eaaa" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">前几天，我的女朋友danwessels正在开发一个功能，你可以使用键盘上的箭头来浏览一系列图像。旋转木马已经有了UI箭头的功能，但是人类很懒，不想移动光标和点击按钮。<strong class="lc iv">添加一个足够简单的功能…或者是吗？</strong></p><p id="5d0d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">添加键盘功能之前的轮播代码:</p><pre class="kk kl km kn gu lw lx ly lz aw ma bi"><span id="484b" class="mb mc iu lx b gz md me l mf mg">import { useEffect, useState } from 'react'</span><span id="78fa" class="mb mc iu lx b gz mh me l mf mg">import { getImages } from './api/images'</span><span id="ec3c" class="mb mc iu lx b gz mh me l mf mg">const Carousel = () =&gt; {<br/>  const [currentImage, setCurrentImage] = useState(null)<br/>  const [images, setImages] = useState([])<br/>  const [currentIndex, setCurrentIndex] = useState(0)</span><span id="3c49" class="mb mc iu lx b gz mh me l mf mg">  useEffect(() =&gt; {<br/>    fetchImages()<br/>  }, [])</span><span id="9e65" class="mb mc iu lx b gz mh me l mf mg">  useEffect(() =&gt; {<br/>    setCurrentIndex(images.findIndex(({ id }) =&gt; id === currentImage.id))<br/>  }, [images, currentImage])</span><span id="5670" class="mb mc iu lx b gz mh me l mf mg">  async function fetchImages() {<br/>    const images = getImages() // e.g. from an API<br/>    setImages(images)<br/>    setCurrentImage(images[0])<br/>  }</span><span id="e2cb" class="mb mc iu lx b gz mh me l mf mg">  function nextItem() {<br/>    let newCurrentIndex = currentIndex<br/>    if (currentIndex === images.length - 1) newCurrentIndex = 0<br/>    else newCurrentIndex += 1<br/>    setCurrentImage(images[newCurrentIndex])<br/>  }</span><span id="a478" class="mb mc iu lx b gz mh me l mf mg">  function previousItem() {<br/>    let newCurrentIndex = currentIndex<br/>    if (currentIndex === 0) newCurrentIndex = images.length - 1<br/>    else newCurrentIndex -= 1<br/>    setCurrentImage(images[newCurrentIndex])<br/>  }</span><span id="df2e" class="mb mc iu lx b gz mh me l mf mg">  return (<br/>    &lt;div&gt;<br/>      {images?.length &gt; 1 &amp;&amp; (<br/>        &lt;button<br/>          onClick={previousItem}<br/>        &gt;<br/>          Previous<br/>        &lt;/button&gt;<br/>      )}<br/>      {currentImage?.id &amp;&amp;<br/>        &lt;div&gt;<br/>          &lt;img src={currentImage.src} alt={currentImage.altText} /&gt;<br/>        &lt;/div&gt;<br/>      }<br/>      {images.length &gt; 1 &amp;&amp; (<br/>        &lt;button<br/>          onClick={nextItem}<br/>        &gt;<br/>          Next<br/>        &lt;/button&gt;<br/>      )}<br/>    &lt;/div&gt;<br/>  )<br/>}</span><span id="dbcc" class="mb mc iu lx b gz mh me l mf mg">export default Carousel</span></pre><p id="c13e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">carousel代码很简单，但是还没有使用键盘箭头的功能。为此，您需要通过这样做来监听<code class="fe mi mj mk lx b">keydown</code>事件:</p><pre class="kk kl km kn gu lw lx ly lz aw ma bi"><span id="c0cf" class="mb mc iu lx b gz md me l mf mg">useEffect(() =&gt; {<br/>  document.addEventListener('keydown', navigate)<br/>  return function cleanup() {<br/>    document.removeEventListener('keydown', navigate)<br/>  }<br/>}, [])</span><span id="4651" class="mb mc iu lx b gz mh me l mf mg">function navigate(e) {<br/>  if (e.keyCode === 37) {<br/>    previousItem()<br/>  } else if (e.keyCode === 39) {<br/>    nextItem()<br/>  }<br/>}</span></pre><p id="6154" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">问题是<code class="fe mi mj mk lx b">navigate</code>函数被声明为<code class="fe mi mj mk lx b">eventListener</code>的回调函数。这样做意味着<code class="fe mi mj mk lx b">navigate</code>函数是用初始状态创建的，而<strong class="lc iv">永远不会有最新的状态。有一个简单的修复方法，就是将状态附加到<code class="fe mi mj mk lx b">useEffect</code>钩子的依赖数组中:</strong></p><pre class="kk kl km kn gu lw lx ly lz aw ma bi"><span id="52b7" class="mb mc iu lx b gz md me l mf mg">useEffect(() =&gt; {<br/>  document.addEventListener('keydown', navigate)<br/>  return function cleanup() {<br/>    document.removeEventListener('keydown', navigate)<br/>  }<br/>}, [currentIndex])</span></pre><p id="b6ec" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是这样做意味着导航功能将在每次点击后被重新创建！那么我们该怎么办？</p><p id="33cd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这是我女朋友想出来的😄：</p><pre class="kk kl km kn gu lw lx ly lz aw ma bi"><span id="7c72" class="mb mc iu lx b gz md me l mf mg">const prevBtn = useRef(null)<br/>const nextBtn = useRef(null)</span><span id="6945" class="mb mc iu lx b gz mh me l mf mg">useEffect(() =&gt; {<br/>  document.addEventListener('keydown', navigate)<br/>  return function cleanup() {<br/>    document.removeEventListener('keydown', navigate)<br/>  }<br/>}, [])</span><span id="245e" class="mb mc iu lx b gz mh me l mf mg">function navigate(e) {<br/>  if (e.keyCode === 37) {<br/>    prevBtn.current.click()<br/>  } else if (e.keyCode === 39) {<br/>    nextBtn.current.click()<br/>  }<br/>}</span><span id="ce2e" class="mb mc iu lx b gz mh me l mf mg">// render method<br/>&lt;button<br/>  onClick={previousItem}<br/>  ref={prevBtn}<br/>&gt;<br/>  Previous<br/>&lt;/button&gt;</span><span id="13be" class="mb mc iu lx b gz mh me l mf mg">&lt;button<br/>  onClick={nextItem}<br/>  ref={nextBtn}<br/>&gt;<br/>  Previous<br/>&lt;/button&gt;</span></pre><p id="023e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">通过这样做，我们从按钮模拟了<code class="fe mi mj mk lx b">onClick</code>事件，并且我们可以访问我们组件的最新<code class="fe mi mj mk lx b">state</code>。相当牛逼！🎉</p><p id="58ec" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">完整的代码现在看起来像这样:</p><pre class="kk kl km kn gu lw lx ly lz aw ma bi"><span id="b158" class="mb mc iu lx b gz md me l mf mg">import { useEffect, useRef, useState } from 'react'</span><span id="f5a5" class="mb mc iu lx b gz mh me l mf mg">import { getImages } from './api/images'</span><span id="af5d" class="mb mc iu lx b gz mh me l mf mg">const Carousel = () =&gt; {<br/>  const prevBtn = useRef(null)<br/>  const nextBtn = useRef(null)<br/>  const [currentImage, setCurrentImage] = useState(null)<br/>  const [images, setImages] = useState([])<br/>  const [currentIndex, setCurrentIndex] = useState(0)</span><span id="4cb3" class="mb mc iu lx b gz mh me l mf mg">  useEffect(() =&gt; {<br/>    fetchImages()<br/>    document.addEventListener('keydown', navigate)<br/>    return function cleanup() {<br/>      document.removeEventListener('keydown', navigate)<br/>    }<br/>  }, [])</span><span id="67ac" class="mb mc iu lx b gz mh me l mf mg">useEffect(() =&gt; {<br/>    setCurrentIndex(images.findIndex(({ id }) =&gt; id === currentImage.id))<br/>  }, [images, currentImage])</span><span id="f3a6" class="mb mc iu lx b gz mh me l mf mg">  function navigate(e) {<br/>    if (e.keyCode === 37) {<br/>      prevBtn.current.click()<br/>    } else if (e.keyCode === 39) {<br/>      nextBtn.current.click()<br/>    }<br/>  }</span><span id="071c" class="mb mc iu lx b gz mh me l mf mg">  async function fetchImages() {<br/>    const images = getImages() // e.g. from an API<br/>    setImages(images)<br/>    setCurrentImage(images[0])<br/>  }</span><span id="9704" class="mb mc iu lx b gz mh me l mf mg"> function nextItem() {<br/>    let newCurrentIndex = currentIndex<br/>    if (currentIndex === images.length - 1) newCurrentIndex = 0<br/>    else newCurrentIndex += 1<br/>    setCurrentImage(images[newCurrentIndex])<br/>  }</span><span id="f9a2" class="mb mc iu lx b gz mh me l mf mg"> function previousItem() {<br/>    let newCurrentIndex = currentIndex<br/>    if (currentIndex === 0) newCurrentIndex = images.length - 1<br/>    else newCurrentIndex -= 1<br/>    setCurrentImage(images[newCurrentIndex])<br/>  }</span><span id="da92" class="mb mc iu lx b gz mh me l mf mg"> return (<br/>    &lt;div&gt;<br/>      {images?.length &gt; 1 &amp;&amp; (<br/>        &lt;button<br/>          onClick={previousItem}<br/>          ref={prevBtn}        <br/>         &gt;<br/>          Previous<br/>        &lt;/button&gt;<br/>      )}<br/>      {currentImage?.id &amp;&amp;<br/>        &lt;div&gt;<br/>          &lt;img src={currentImage.src} alt={currentImage.altText} /&gt;<br/>        &lt;/div&gt;<br/>      }<br/>      {images.length &gt; 1 &amp;&amp; (<br/>        &lt;button<br/>          onClick={nextItem}<br/>          ref={nextBtn}<br/>         &gt;<br/>          Next<br/>        &lt;/button&gt;<br/>      )}<br/>    &lt;/div&gt;<br/>  )<br/>}</span><span id="c8ab" class="mb mc iu lx b gz mh me l mf mg">export default Carousel</span></pre><p id="0ce3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">尽情享受吧！所有的荣誉都要归功于我的女朋友danwessels提出了这个巧妙的解决方案。</p><div class="ml mm gq gs mn mo"><a href="https://blog.jagonzalr.com/membership" rel="noopener  ugc nofollow" target="_blank"><div class="mp ab fp"><div class="mq ab mr cl cj ms"><h2 class="bd iv gz z fq mt fs ft mu fv fx it bi translated">加入我的介绍链接媒体-何塞安东尼奥冈萨雷斯罗德里格斯</h2><div class="mv l"><h3 class="bd b gz z fq mt fs ft mu fv fx dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="mw l"><p class="bd b dl z fq mt fs ft mu fv fx dk translated">blog.jagonzalr.com</p></div></div><div class="mx l"><div class="my l mz na nb mx nc kt mo"/></div></div></a></div></div></div>    
</body>
</html>