<html>
<head>
<title>How we accidentally burned $40,000 by calling recursive patterns</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何通过调用递归模式意外地烧掉了40，000美元</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-we-accidentally-burned-40-000-by-calling-recursive-patterns-571fe5ede90?source=collection_archive---------3-----------------------#2022-11-14">https://levelup.gitconnected.com/how-we-accidentally-burned-40-000-by-calling-recursive-patterns-571fe5ede90?source=collection_archive---------3-----------------------#2022-11-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="514e" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">背景</h1><p id="00cb" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">几年前，我是一家航空公司物联网公司的顾问，负责构建分析架构，包括完整的数据工程管道和分析仪表板。</p><p id="238a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">3000多台物联网设备每天向ETL管道发送200 GB数据。这些数据临时存储在一个SQL数据库中，每四个小时就会以CSV文件的形式转储到S3。根据他们工程主管的意见，我决定采取以下行动计划。</p><p id="af55" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">设定上下文(已编辑)</strong>:这件事发生在2019年，我不是AWS管理员。但是，作为我们政策的一部分:</p><ul class=""><li id="d461" class="lo lp iq kn b ko lj ks lk kw lq la lr le ls li lt lu lv lw bi translated">我们通知他们的AWS管理员在项目开始前配置cloudwatch警报，但他们没有这样做</li><li id="6e22" class="lo lp iq kn b ko lx ks ly kw lz la ma le mb li lt lu lv lw bi translated">我管理着一个由四名工程师组成的团队，其中一名工程师编写函数</li><li id="4c93" class="lo lp iq kn b ko lx ks ly kw lz la ma le mb li lt lu lv lw bi translated">这是一个临时函数，应该只能工作两周，这就是为什么它写在Lambda上的原因</li><li id="7241" class="lo lp iq kn b ko lx ks ly kw lz la ma le mb li lt lu lv lw bi translated">无服务器服务将按需扩展，配置保留并发或供应并发是2019年的新概念</li><li id="dad0" class="lo lp iq kn b ko lx ks ly kw lz la ma le mb li lt lu lv lw bi translated">等式中有太多我无法控制的因素，本文的目的是让开发人员了解递归模式，以便他们谨慎行事。</li></ul><p id="8d6c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">作为一名顾问，我建议对现有架构进行以下四项重大更改:</p><ol class=""><li id="343e" class="lo lp iq kn b ko lj ks lk kw lq la lr le ls li mc lu lv lw bi translated">整个历史数据将被转换为小时级<em class="md">日期分区的爽快压缩拼花格式(</em><strong class="kn ir"><em class="md">DPSCP</em></strong><em class="md">)</em></li><li id="7186" class="lo lp iq kn b ko lx ks ly kw lz la ma le mb li mc lu lv lw bi translated">现有管道继续以CSV格式将数据转储到S3，但是我们使用我们屡试不爽的脚本在两周的迁移期间将每个文件转换为DPSCP—<strong class="kn ir">问题出现在这里</strong></li><li id="53ab" class="lo lp iq kn b ko lx ks ly kw lz la ma le mb li mc lu lv lw bi translated">开发一个新的管道，将即将到来的数据转储到<strong class="kn ir"> DPSCP </strong></li><li id="da6e" class="lo lp iq kn b ko lx ks ly kw lz la ma le mb li mc lu lv lw bi translated">使用Athena查询创建最终的BI仪表板(<strong class="kn ir">注意:</strong>实时仪表板是一个不同的用例)</li></ol><p id="358a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">成功标准:</strong>按工作顺序提供一切。我们必须能够以最低的现收现付查询成本查询所有可访问的数据，并且只需为S3上的数据存储付费。</p><h1 id="c003" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">问题和原因</h1><p id="1118" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在迁移过程中(第2步)，我们创建了一个为期2周的临时Lambda来监听S3桶事件，将它们转换成拼花，并发布到S3。由于源和目的地的桶和前缀都被分配给同一个桶，它被触发了数百万次。</p><blockquote class="me mf mg"><p id="4948" class="kl km md kn b ko lj kq kr ks lk ku kv mh ll ky kz mi lm lc ld mj ln lg lh li ij bi translated">理想情况下，Lambda应该在两周内每天将24个CSV文件转换为Parquet。但是由于我们没有在处理后删除CSV文件(用于验证),而是基于S3事件进行触发，所以每当处理后转储新的parquet文件时，S3事件会再次触发Lambda，Lambda会重复这个过程。</p></blockquote><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/efcf30d26198a32fc05012cc454c2424.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*lIxxVheFqWlSqJhYzU9cTA.png"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">递归模式</figcaption></figure><p id="d503" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">无限循环导致Lambda扩展到使用所有可用的并发，而S3继续为Lambda编写对象和创建新事件。</p><h1 id="7bdb" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">成本分析</h1><p id="ca6a" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">到2天结束时，这个循环已经运行了大约40个小时，花费了大约40，000美元，主要是因为Lambda并发和S3 put请求。</p><figure class="ml mm mn mo gt mp"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">AWS成本细分</figcaption></figure><h1 id="cf0f" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">预防方法</h1><ul class=""><li id="4585" class="lo lp iq kn b ko kp ks kt kw my la mz le na li lt lu lv lw bi translated">使用肯定触发器:例如，一个S3对象触发器可能使用一个命名约定或元标签，它只在第一次被调用时起作用。这将阻止Lambda函数编写的对象再次调用同一个函数。</li><li id="2d6c" class="lo lp iq kn b ko lx ks ly kw lz la ma le mb li lt lu lv lw bi translated"><strong class="kn ir">使用保留并发</strong>:当一个函数的保留并发被设置为一个下限时，这个函数的并发不能超过这个限制。<strong class="kn ir">它不会停止递归</strong>，但作为一种安全措施，它会限制使用的资源量。在开发和测试阶段，这很有帮助。</li><li id="2b15" class="lo lp iq kn b ko lx ks ly kw lz la ma le mb li lt lu lv lw bi translated"><strong class="kn ir">使用CloudWatch监控和警报</strong>:通过在函数的并发性指标上设置警报，如果并发性突然上升，您可以获得警报，从而允许您采取正确的行动。</li></ul><p id="bec0" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">在下面的AWS文章中，可以在其他情况和服务中看到类似的模式。</p><div class="nb nc gp gr nd ne"><a href="https://docs.aws.amazon.com/lambda/latest/operatorguide/recursive-runaway.html" rel="noopener  ugc nofollow" target="_blank"><div class="nf ab fo"><div class="ng ab nh cl cj ni"><h2 class="bd ir gy z fp nj fr fs nk fu fw ip bi translated">导致Lambda函数失控的递归模式</h2><div class="nl l"><h3 class="bd b gy z fp nj fr fs nk fu fw dk translated">AWS服务生成调用Lambda函数的事件，Lambda函数可以向AWS服务发送消息…</h3></div><div class="nm l"><p class="bd b dl z fp nj fr fs nk fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><h1 id="e1fc" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">我们如何修复它</h1><p id="a2ce" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在S3时段中设置事件通知时，您还可以使用前缀或后缀按对象关键字进行筛选。我们通过使用两个不同的S3前缀来避免递归模式，即'<em class="md">原始'</em>和'<em class="md">已处理'</em>和Sufix ' <em class="md">。csv。</em></p><p id="9788" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我在AWS的博客上找到了这篇文章，它详细解释了这一点。</p><div class="nb nc gp gr nd ne"><a href="https://aws.amazon.com/blogs/compute/avoiding-recursive-invocation-with-amazon-s3-and-aws-lambda/" rel="noopener  ugc nofollow" target="_blank"><div class="nf ab fo"><div class="ng ab nh cl cj ni"><h2 class="bd ir gy z fp nj fr fs nk fu fw ip bi translated">使用亚马逊S3和AWS Lambda |亚马逊Web服务避免递归调用</h2><div class="nl l"><h3 class="bd b gy z fp nj fr fs nk fu fw dk translated">最佳实践是将Lambda函数的输出存储在与源不同的bucket或AWS资源中…</h3></div><div class="nm l"><p class="bd b dl z fp nj fr fs nk fu fw dk translated">aws.amazon.com</p></div></div><div class="nn l"><div class="no l np nq nr nn ns mq ne"/></div></div></a></div><h1 id="9790" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">分级编码</h1><p id="6b9f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="8ce6" class="lo lp iq kn b ko lj ks lk kw lq la lr le ls li lt lu lv lw bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="4c0a" class="lo lp iq kn b ko lx ks ly kw lz la ma le mb li lt lu lv lw bi translated">📰查看<a class="ae nt" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="3d89" class="lo lp iq kn b ko lx ks ly kw lz la ma le mb li lt lu lv lw bi translated">🔔关注我们:<a class="ae nt" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae nt" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae nt" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="82bf" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">🚀👉<a class="ae nt" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir">加入高级人才集体，与最优秀的创业公司和科技公司联系</strong> </a></p></div></div>    
</body>
</html>