<html>
<head>
<title>How to code a Telegram Bot to get stock price updates in pure Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用纯Python编写一个电报机器人来获取股票价格更新</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-code-a-telegram-bot-to-get-stock-price-updates-in-pure-python-c35d3c44b04c?source=collection_archive---------2-----------------------#2021-03-22">https://levelup.gitconnected.com/how-to-code-a-telegram-bot-to-get-stock-price-updates-in-pure-python-c35d3c44b04c?source=collection_archive---------2-----------------------#2021-03-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3d85" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">创建您自己的个人股票更新奴隶</h2></div><blockquote class="ki kj kk"><p id="e2e6" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">我将在本文中提到的电报机器人是<a class="ae li" href="https://t.me/stock_updates_bot" rel="noopener ugc nofollow" target="_blank">股票更新从属服务器</a>，源代码可以在这个<a class="ae li" href="https://github.com/davidcjw/stockM" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>上找到。</p></blockquote><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lj"><img src="../Images/f058737cb248ef910acf0938bf19e105.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xCXYIU1Pz8la7Qj7"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">照片由<a class="ae li" href="https://unsplash.com/@christianw?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯蒂安·威迪格</a>在<a class="ae li" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="ebd7" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">您可能会想，<strong class="ko iu"> <em class="kn">为什么我们甚至需要一项服务来更新我们的投资组合持有情况</em> </strong>？事实是，我们大多数人都忙于日常生活和经纪平台，我们订阅了这些服务，但他们的推送通知是以电子邮件或移动应用提醒的形式出现的，我们几乎从来不愿意点击或打开。电报机器人提醒因此更有用，因为它被集成到我们更有可能点击的日常信息应用程序中。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mc"><img src="../Images/66e500d8e2e21da211c8c947b99c52b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*WWCYDsbyDzWTbgHect87Zg.gif"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">我的电报机器人演示(作者GIF)</figcaption></figure></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><p id="b6ab" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">在我们开始之前，这里有一些构建这个简单电报机器人的先决条件:</p><ol class=""><li id="72b5" class="mk ml it ko b kp kq ks kt lz mm ma mn mb mo lh mp mq mr ms bi translated">初级到中级Python</li><li id="aa51" class="mk ml it ko b kp mt ks mu lz mv ma mw mb mx lh mp mq mr ms bi translated">对API工作原理的基本理解</li><li id="e6e2" class="mk ml it ko b kp mt ks mu lz mv ma mw mb mx lh mp mq mr ms bi translated">电报帐户</li><li id="0692" class="mk ml it ko b kp mt ks mu lz mv ma mw mb mx lh mp mq mr ms bi translated">Heroku帐户(用于部署)</li><li id="05d6" class="mk ml it ko b kp mt ks mu lz mv ma mw mb mx lh mp mq mr ms bi translated">GitHub帐户(用于部署)</li><li id="816f" class="mk ml it ko b kp mt ks mu lz mv ma mw mb mx lh mp mq mr ms bi translated">SQL Alchemy(可选，用于数据库目的)[ <strong class="ko iu">未涵盖</strong></li><li id="9983" class="mk ml it ko b kp mt ks mu lz mv ma mw mb mx lh mp mq mr ms bi translated">AWS帐户(可选，用于无服务器CRON作业)[ <strong class="ko iu">不包括</strong></li></ol></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><p id="588b" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">事不宜迟，我们开始吧！</p><p id="1933" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">首先，我们需要一个API来获取我们心目中的股票的价格变化。为了简单起见，我们将使用<a class="ae li" href="https://github.com/ranaroussi/yfinance" rel="noopener ugc nofollow" target="_blank"><strong class="ko iu"><em class="kn">y finance</em></strong></a>，一个在<em class="kn"> Yahoo财务</em> API被停用。它的API是用Python编写的，我们还将为Telegram API使用一个基于Python的库，称为<a class="ae li" href="https://github.com/python-telegram-bot/python-telegram-bot" rel="noopener ugc nofollow" target="_blank"><strong class="ko iu"><em class="kn">Python-Telegram-bot</em></strong></a>。</p><p id="f700" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">我们将首先基于<em class="kn"> yfinance </em> API创建一个简单的脚本来获取输入报价机的价格变动。接下来，我们将设置电报处理器来监听对机器人的请求。</p><p id="8de3" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated"><strong class="ko iu">步骤1 </strong>:创建一个脚本，使用<em class="kn"> yfinance </em>获取价格变化</p><p id="3021" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">下面的脚本接受一个<em class="kn">收报机</em>作为输入，一个<em class="kn">回看</em>周期作为可选参数，并返回一个<em class="kn">元组</em>，该元组由第一个指数的百分比变化和第二个指数的百分比变化的收盘值列表(主要用于提取准确的价格，如果需要的话)组成。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="53dd" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated"><strong class="ko iu">第二步</strong>:用<a class="ae li" href="https://t.me/BotFather" rel="noopener ugc nofollow" target="_blank">机器人父亲</a>创建一个电报机器人</p><p id="fd72" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">按照机器人上的说明来设置你的机器人(<em class="kn">是的，你正在使用一个机器人来创建一个机器人</em>——即<strong class="ko iu"> <em class="kn">机器人异常</em> </strong>)。最后，您将获得一个访问HTTP API所需的bot令牌。记下这个记号。我们将在下一步中使用它。</p><p id="06ce" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated"><strong class="ko iu">步骤3 </strong>:将这个令牌导出为一个环境变量，这样我们的应用程序以后就可以使用它了。</p><p id="a356" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">从命令行运行:</p><pre class="lk ll lm ln gt na nb nc nd aw ne bi"><span id="48c7" class="nf ng it nb b gy nh ni l nj nk">export TELEGRAM_BOT_TOKEN=&lt;YOUR_BOT_TOKEN_HERE&gt;</span></pre><p id="09a1" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated"><strong class="ko iu">第四步</strong>:创建一个<code class="fe nl nm nn nb b">telegram_bot_app.py</code>就是我们的电报机器人</p><p id="59c3" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">这个电报机器人只有一个命令——<em class="kn">get _ px _ change</em>——使用<code class="fe nl nm nn nb b">/</code>命令启动。在telegram上，要获得<em class="kn"> AMZN </em> ticker的价格变化，通过<code class="fe nl nm nn nb b">python -m telegram_bot_app</code>在本地提供应用程序后运行<code class="fe nl nm nn nb b">/get_px_change AMZN</code>。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="2a7a" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated"><strong class="ko iu">第五步</strong>:将该命令注册在电报上，以便用户更直观的知道该命令的存在</p><p id="6c1f" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">通过<code class="fe nl nm nn nb b">/setcommands</code>返回<em class="kn">机器人</em>登记该命令<em class="kn"> get_px_change </em>。包含一个像<em class="kn"> start </em>这样的命令来通知用户如何使用你的机器人也是值得的。</p><blockquote class="ki kj kk"><p id="0707" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated"><strong class="ko iu"> FYI </strong>:命令处理程序以<code class="fe nl nm nn nb b">/</code>开头，出现在命令列表中。</p><p id="c3ec" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated"><strong class="ko iu">注意</strong>:代替命令处理程序，对话处理程序也可以和键盘标记一起使用(如上面的GIF所示)。后者可能更直观，更方便用户导航。</p><p id="7a89" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated"><strong class="ko iu">更多注意事项</strong>:最好的做法是用错误处理器来处理未识别的命令。</p></blockquote><p id="7e45" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated"><strong class="ko iu">第6步</strong>:将脚本放在<em class="kn"> GitHub </em>仓库中，以便于在<em class="kn"> Heroku </em>上部署</p><p id="f085" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">然而，在我们可以在Heroku 上部署之前，我们需要定义我们的环境。为此，我们需要两个新文件:</p><p id="af9b" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">a) <strong class="ko iu"> Procfile </strong> —它告诉<em class="kn"> Heroku </em>应用程序的类型，以及设置环境后要运行的命令。它将只包含这一行:</p><pre class="lk ll lm ln gt na nb nc nd aw ne bi"><span id="75fc" class="nf ng it nb b gy nh ni l nj nk">web: python -m telegram_bot_app</span></pre><p id="4a7c" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">b) <strong class="ko iu"> requirements.txt </strong> —这定义了典型的基于Python的应用程序的环境需求。它应该是这样的:</p><pre class="lk ll lm ln gt na nb nc nd aw ne bi"><span id="31e0" class="nf ng it nb b gy nh ni l nj nk">pandas==1.0.1<br/>numpy==1.18.1<br/>yfinance==0.1.54<br/>python-telegram-bot==13.1</span></pre><p id="6d39" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">文件夹结构应该如下所示:</p><pre class="lk ll lm ln gt na nb nc nd aw ne bi"><span id="9185" class="nf ng it nb b gy nh ni l nj nk">.<br/>├── telegram_bot_app.py<br/>├── ticker.py<br/>├── Procfile<br/>└── requirements.txt</span></pre><p id="fae0" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">将这些文件推送到主/主分支上的一个<em class="kn"> GitHub </em>存储库中。</p><p id="f9b5" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated"><strong class="ko iu">第七步</strong>:在<em class="kn"> Heroku </em>上部署该应用</p><p id="58b5" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">如果你没有一个<em class="kn"> Heroku </em>的帐号，创建一个并安装<a class="ae li" href="https://devcenter.heroku.com/articles/heroku-cli" rel="noopener ugc nofollow" target="_blank"> Heroku命令行界面</a> (CLI)。</p><p id="19b6" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">a)接下来，通过CLI创建一个新项目:</p><pre class="lk ll lm ln gt na nb nc nd aw ne bi"><span id="e85c" class="nf ng it nb b gy nh ni l nj nk">heroku create &lt;project_name&gt;</span></pre><p id="9eac" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">b)将电报机器人令牌设置为环境变量。</p><pre class="lk ll lm ln gt na nb nc nd aw ne bi"><span id="bda7" class="nf ng it nb b gy nh ni l nj nk">heroku config:set TELEGRAM_BOT_TOKEN=&lt;YOUR_BOT_TOKEN_HERE&gt;</span></pre><p id="2f3c" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">c)修改您的<code class="fe nl nm nn nb b">telegram_bot_app.py</code>来监听webhook事件。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="596e" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">d)将您的<em class="kn"> GitHub </em> repo推至<em class="kn"> Heroku </em>遥控器。注意<em class="kn"> Heroku </em>只会在你推进到主分支或者主分支的时候建造。从您的git repo中，运行以下命令:</p><pre class="lk ll lm ln gt na nb nc nd aw ne bi"><span id="496f" class="nf ng it nb b gy nh ni l nj nk">git push heroku master</span></pre></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><p id="3855" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated"><strong class="ko iu"> <em class="kn">瞧</em> </strong>！这就是你自己的基于Python的电报机器人！当然，您可以通过添加更多功能和更多命令/消息处理程序来扩展这个机器人的功能。</p><p id="c024" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">如果你想每天更新你的投资组合，请查看我的<a class="ae li" href="https://t.me/stock_updates_bot" rel="noopener ugc nofollow" target="_blank"> <strong class="ko iu"> <em class="kn">股票更新奴隶</em> </strong> </a></p><p id="a6b9" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">对于更高级的用户，请随意查看我的<a class="ae li" href="https://github.com/davidcjw/stockM" rel="noopener ugc nofollow" target="_blank"> git库</a>，了解我如何建立一个<em class="kn"> PostgreSQL数据库</em>来跟踪用户投资组合和/或观察列表中的股票，以及他/她的订阅状态。如果你订阅了我的机器人，它还支持你的观察列表和/或投资组合的双日更新(推送通知)。这是通过使用<em class="kn">AWSλ</em>的<em class="kn">无服务器CRON作业</em>设置来完成的。Heroku还支持计划作业，因此这也是一种选择。</p><h2 id="f001" class="nf ng it bd no np nq dn nr ns nt dp nu lz nv nw nx ma ny nz oa mb ob oc od oe bi translated">结束语</h2><p id="5c61" class="pw-post-body-paragraph kl km it ko b kp of ju kr ks og jx ku lz oh kx ky ma oi lb lc mb oj lf lg lh im bi translated">最后，如果你喜欢这篇文章，并想了解更多，请考虑为这篇文章鼓掌(高达50！)如果您有任何反馈，请留下您的评论。谢谢大家！</p><p id="ab6a" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku lz kw kx ky ma la lb lc mb le lf lg lh im bi translated">如果你喜欢我的内容，并且<em class="kn">没有</em>订阅Medium，请考虑支持我，并通过我在这里的推荐链接<a class="ae li" href="https://davidcjw.medium.com/membership" rel="noopener">订阅(<em class="kn">注:你的一部分会员费将作为推荐费</em>分摊给我)。</a></p></div></div>    
</body>
</html>