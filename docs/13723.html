<html>
<head>
<title>Terraform: Create a Self-Signed Certificate with KeyVault and access inside the app (private network)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform:使用KeyVault创建自签名证书，并在应用程序内部访问(专用网络)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/terraform-create-self-signed-certificate-with-keyvault-and-access-inside-the-app-private-15f39516c0e6?source=collection_archive---------8-----------------------#2022-09-30">https://levelup.gitconnected.com/terraform-create-self-signed-certificate-with-keyvault-and-access-inside-the-app-private-15f39516c0e6?source=collection_archive---------8-----------------------#2022-09-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/c09bc00ac56f390db2d2361bed989c76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hx0RnP3Mk72v6ssosmO_IQ.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@mojamsanii?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Moja Msanii </a>在<a class="ae kf" href="https://unsplash.com/s/photos/lock?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="4b7f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇博客中，我将尝试解释如何在密钥库中创建自签名证书，稍后Web应用程序可以(在私有网络内)进行身份验证以读取它(公钥/私钥对)，而无需显式管理其凭据。</p><p id="4e35" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">注意:整个过程在“使用Graph API证书认证的Web应用程序”的上下文中进行了解释，将它与Azure Key Vault结合使用可以极大地提高安全性。</em></p><h2 id="120f" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">要求</h2><ul class=""><li id="e6d1" class="ly lz it ki b kj ma kn mb kr mc kv md kz me ld mf mg mh mi bi translated">创建可访问允许的网络和服务的专用密钥库</li><li id="0768" class="ly lz it ki b kj mj kn mk kr ml kv mm kz mn ld mf mg mh mi bi translated">使用密钥库创建自动续订自签名证书</li><li id="2dc6" class="ly lz it ki b kj mj kn mk kr ml kv mm kz mn ld mf mg mh mi bi translated">为Azure应用服务配置证书访问</li><li id="d43d" class="ly lz it ki b kj mj kn mk kr ml kv mm kz mn ld mf mg mh mi bi translated">配置Azure AD应用程序</li><li id="9aa9" class="ly lz it ki b kj mj kn mk kr ml kv mm kz mn ld mf mg mh mi bi translated">配置web应用程序以读取证书。</li></ul><h2 id="60fa" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">创建私钥保管库。</h2><p id="2ce7" class="pw-post-body-paragraph kg kh it ki b kj ma kl km kn mb kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">我们的第一步是创建一个没有任何公共网络访问的密钥库，仅限于您的应用程序子网和允许的服务。</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="dfb9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的片段来自我之前的博客，<a class="ae kf" href="https://rollendxavier.medium.com/automate-secrets-to-azure-key-vault-and-access-it-in-devops-pipelines-69a24ecb9602" rel="noopener">Azure Key vault secrets automation&amp;devo PS pipelines中的集成</a></p><h2 id="6bc7" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">使用密钥库生成自动续订自签名证书</h2><p id="301c" class="pw-post-body-paragraph kg kh it ki b kj ma kl km kn mb kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">下面的terraform代码将在您的密钥库中创建一个自签名、自动更新的证书。</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="3102" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mx my mz na b">azuread_application_certificate</code>应该使您的AD应用程序能够访问证书。</p><h2 id="f7ee" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">为Azure应用服务配置证书访问</h2><p id="2f4e" class="pw-post-body-paragraph kg kh it ki b kj ma kl km kn mb kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">希望你已经创建了一个应用服务(与网络集成)，否则请阅读此处<a class="ae kf" href="https://learn.microsoft.com/en-us/azure/app-service/overview-vnet-integration" rel="noopener ugc nofollow" target="_blank">将你的应用与Azure虚拟网络集成— Azure应用服务</a>&amp;<a class="ae kf" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/app_service" rel="noopener ugc nofollow" target="_blank">Azure RM _ App _ Service</a></p><p id="98c9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来我们要为web应用程序启用托管身份，这样我们就可以使用应用程序的身份与密钥库进行通信。将以下内容添加到您的应用服务terraform代码中。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nb"><img src="../Images/98f2249d78ea40c3f89312930a49e872.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zD5vOPN5P6c6OiOMRQxgXA.png"/></div></div></figure><p id="2b53" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们将添加一个密钥库访问策略，以便您的web应用程序可以通过Azure Active Directory (Azure AD)对密钥库进行身份验证。</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h2 id="9501" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">配置web应用程序以读取证书。</h2><p id="bd9a" class="pw-post-body-paragraph kg kh it ki b kj ma kl km kn mb kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">最后，轮到您从您的web应用程序的密钥库中读取密码，我没有完全解释这些步骤，但应该是类似下面的内容，这里的意图是，没有用于身份验证的密码/密码！！</p><pre class="mr ms mt mu gt nc na nd ne aw nf bi"><span id="b45d" class="lf lg it na b gy ng nh l ni nj">SecretClientOptions options = new SecretClientOptions()<br/>    {<br/>        Retry =<br/>        {<br/>            Delay= TimeSpan.FromSeconds(2),<br/>            MaxDelay = TimeSpan.FromSeconds(16),<br/>            MaxRetries = 5,<br/>            Mode = RetryMode.Exponential<br/>         }<br/>    };<br/>var client = new SecretClient(new Uri("https://&lt;your-unique-key-vault-name&gt;.vault.azure.net/"), new DefaultAzureCredential(),options);</span><span id="b16a" class="lf lg it na b gy nk nh l ni nj">KeyVaultSecret secret = client.GetSecret("&lt;mySecret&gt;");</span><span id="7e75" class="lf lg it na b gy nk nh l ni nj">string secretValue = secret.Value;</span></pre><h2 id="6f54" class="lf lg it bd lh li lj dn lk ll lm dp ln kr lo lp lq kv lr ls lt kz lu lv lw lx bi translated">结论</h2><p id="3a47" class="pw-post-body-paragraph kg kh it ki b kj ma kl km kn mb kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">Azure AD允许应用程序在没有用户与客户端凭据流交互的情况下运行。为此，我们需要在Azure AD中注册一个应用程序，并配置一个客户端密码或一个我们可以用来验证和查询MS Graph的证书。我在这里试着用一个私网词来解释一下认证的证书方式！</p></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="321e" class="ns lg it bd lh nt nu nv lk nw nx ny ln nz oa ob lq oc od oe lt of og oh lw oi bi translated">分级编码</h1><p id="ebd7" class="pw-post-body-paragraph kg kh it ki b kj ma kl km kn mb kp kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="d09d" class="ly lz it ki b kj kk kn ko kr oj kv ok kz ol ld mf mg mh mi bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="1f62" class="ly lz it ki b kj mj kn mk kr ml kv mm kz mn ld mf mg mh mi bi translated">📰查看<a class="ae kf" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">级编码出版物</a>中的更多内容</li><li id="ccd1" class="ly lz it ki b kj mj kn mk kr ml kv mm kz mn ld mf mg mh mi bi translated">💰免费编码面试课程<a class="ae kf" href="https://skilled.dev/?utm_source=luc&amp;utm_medium=article" rel="noopener ugc nofollow" target="_blank">查看课程</a></li><li id="a13d" class="ly lz it ki b kj mj kn mk kr ml kv mm kz mn ld mf mg mh mi bi translated">🔔关注我们:<a class="ae kf" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a> | <a class="ae kf" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a> | <a class="ae kf" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="2b97" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">🚀👉<a class="ae kf" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>