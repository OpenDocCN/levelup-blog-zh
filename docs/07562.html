<html>
<head>
<title>Add SIP Calls to WebRTC Video Sessions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将SIP呼叫添加到WebRTC视频会话</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/add-sip-calls-to-webrtc-video-sessions-b2bedc78336a?source=collection_archive---------31-----------------------#2021-02-23">https://levelup.gitconnected.com/add-sip-calls-to-webrtc-video-sessions-b2bedc78336a?source=collection_archive---------31-----------------------#2021-02-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ebd27ef402552a4312cb06f133e9e3fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UYovhnXblS83THqLP9ApPg.png"/></div></div></figure><p id="de28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们生活在一个视频会议的时代。从学校到工作到家庭活动，视频会议已经成为许多人的一种生活方式，但有时从电脑上加入是不可能的。在本教程中，我们将介绍如何允许参与者通过电话加入您的Vonage视频API会话。</p><blockquote class="kw kx ky"><p id="29e5" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">想跳到最后吗？你可以在<a class="ae ld" href="https://github.com/opentok-community/sip-sample" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到本教程的所有源代码。</p></blockquote><h1 id="9acd" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">它是如何工作的？</h1><p id="06f5" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">从视频API会话中，我们将调用语音API。这个调用将在我们的应用程序中触发answer webhook，从而创建一个语音对话。该对话将作为另一个流加入视频会话。</p><p id="669f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当用户拨入会议号码时，系统会提示他们输入PIN。如果用户提供正确的PIN，他们将加入语音对话。此时，用户将能够听到视频会话中的所有参与者，并且他们将能够依次听到其他参与者的声音。</p><p id="c97b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">会话结束后，应挂断电话，以避免额外的语音或视频API费用。</p><h1 id="afd9" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">先决条件</h1><p id="6a5c" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">要完成本教程，您需要:</p><ul class=""><li id="8144" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv mm mn mo mp bi translated">Vonage视频API帐户。<a class="ae ld" href="https://tokbox.com/account/user/signup" rel="noopener ugc nofollow" target="_blank">点击这里</a>免费获得一个。</li><li id="61f1" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">可选:<a class="ae ld" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank"> Ngrok </a>用于本地测试</li></ul><h1 id="2a59" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">Vonage API帐户</h1><p id="1791" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">要完成本教程，您将需要一个<a class="ae ld" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2021-02-08-add-sip-calls-to-webrtc-video-sessions" rel="noopener ugc nofollow" target="_blank"> Vonage API帐户</a>。如果您还没有，您可以今天就<a class="ae ld" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2021-02-08-add-sip-calls-to-webrtc-video-sessions" rel="noopener ugc nofollow" target="_blank">注册</a>并开始使用免费信用点数进行构建。一旦你有了一个帐户，你可以在<a class="ae ld" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2021-02-08-add-sip-calls-to-webrtc-video-sessions" rel="noopener ugc nofollow" target="_blank"> Vonage API仪表板</a>的顶部找到你的API密匙和API秘密。</p><p id="0bfe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本教程还使用了一个虚拟电话号码。要购买号码，请前往<em class="kz">号码</em> &gt; <em class="kz">购买号码</em>并搜索符合您需求的号码。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/941d1ebad7252085aa9c1e88f9dc18f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9RUNrmWVrhuK9uZKQ1igZA.png"/></div></div></figure><h1 id="2f51" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">构建前端</h1><p id="dc03" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">我们的前端将使用EJS模板的表达。对于本文，我们不会讨论如何创建视频API会话，但是您可以查看存储库中的代码，看看我们是如何做到这一点的。我们将只关注如何将SIP呼叫添加到现有会话中。</p><p id="498f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在视频会话的模板中，添加以下两个JavaScript函数:</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="df0e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这两个功能都在我们的Express后端调用路线。<code class="fe nb nc nd ne b">dialOut</code>方法将启动语音会议，并将其作为流添加到视频会话中。<code class="fe nb nc nd ne b">hangUp</code>功能将在会话结束时用于断开语音会议与会话的连接。在我们的HTML中，我们想要添加两个按钮来调用这些函数8。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="mz na l"/></div></figure><h1 id="a4b4" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">到后端的快速通道</h1><p id="4c93" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">随着我们的前端准备就绪，让我们设置我们的后端来处理通过SIP到Vonage语音API的连接。</p><h2 id="cfce" class="nf lf iq bd lg ng nh dn lk ni nj dp lo kj nk nl ls kn nm nn lw kr no np ma nq bi translated">助手功能</h2><p id="7a7b" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">在处理拨出和挂断之前，我们需要一些辅助函数。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="66d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nb nc nd ne b">generatePin</code>功能生成一个随机的4位数PIN，我们将使用它为每个视频会话创建一个唯一的PIN。在被允许加入会话之前，会话的呼叫者将被提示输入该PIN。</p><p id="8994" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nb nc nd ne b">generateToken</code>函数用于通过SIP创建视频API令牌</p><p id="2ae6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nb nc nd ne b">setSipOptions</code>函数创建了一个我们在拨打SIP连接时使用的对象。它包含加入语音会议所需的认证信息。</p><h2 id="04f6" class="nf lf iq bd lg ng nh dn lk ni nj dp lo kj nk nl ls kn nm nn lw kr no np ma nq bi translated">回答前端</h2><p id="37f2" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">有了这些功能，让我们添加路由来响应我们的前端。下面的<code class="fe nb nc nd ne b">dial-out</code>路由将使用视频API连接到SIP会议。稍后，我们将设置语音API来了解如何响应这些调用。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="54cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nb nc nd ne b">hang-up</code>路由将语音会议与视频API会话断开。在会议结束时挂断电话至关重要。否则，语音会议将保持打开并连接到视频会话。这将导致双方继续增加费用。</p><h1 id="b6ba" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">语音API Webhooks</h1><p id="7041" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">创建语音应用程序时，您需要提供答案Url和事件Url。如果您在本地运行应用程序，您将希望使用ngrok来提供一个外部端点。为您的ngrok Url或Heroku Url提供路由<code class="fe nb nc nd ne b">/voice-answer</code>作为答案Url，为事件Url提供<code class="fe nb nc nd ne b">/voice-events</code>。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="856b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于我们的拨出，当被触发时,<code class="fe nb nc nd ne b">/voice-answer</code>路由将创建一个对话。当其他参与者打进来时，他们将被提示提供该会话的4位PIN。来自呼叫者的条目将被转发到<code class="fe nb nc nd ne b">/voice-dtmf</code>路由，以潜在地加入会话。</p><h1 id="72ca" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">配置设置</h1><p id="9601" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">让我们从创建一个<code class="fe nb nc nd ne b">.env</code>文件开始。您可以将回购中的<code class="fe nb nc nd ne b">.env-sample</code>文件用作模板。它的内容应该是:</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="26ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要设置<code class="fe nb nc nd ne b">videoApiKey</code>和<code class="fe nb nc nd ne b">videoApiSecret</code>，从视频API仪表板创建一个新项目。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/c0b67198a98cda6bd063b4771ac53eca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*FwWdbOQhZAd5QzY3WIovFA.png"/></div></figure><p id="80fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建完成后，复制API密钥和秘密，并分别作为<code class="fe nb nc nd ne b">videoApiKey</code>和<code class="fe nb nc nd ne b">videoApiSecret</code>粘贴到您的<code class="fe nb nc nd ne b">.env</code>文件中。</p><p id="65b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在创建一个语音应用程序，使用API密钥和秘密作为<code class="fe nb nc nd ne b">voiceApiKey</code>和<code class="fe nb nc nd ne b">voiceApiSecret</code>。您需要购买一个号码，并将其与您的语音应用程序相关联。使用该数字作为<code class="fe nb nc nd ne b">conferenceNumber</code>变量。</p><p id="f63f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，输入ngrok或Heroku url作为serverUrl。</p><p id="9aa1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您可以加入视频会话，其他人可以拨打您的号码并输入PIN码来加入会话。需要强调的是，您需要在视频会议结束时挂断电话，以防止在您结束时视频和语音帐户都被使用。</p><h1 id="d2e7" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">进一步阅读</h1><p id="9021" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">想了解更多关于视频API的SIP互连特性吗？下面是一些你可能会觉得有用的链接。</p></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><p id="4d08" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kz">最初发布于</em><a class="ae ld" href="https://learn.vonage.com/blog/2021/02/08/add-sip-calls-to-webrtc-video-sessions/" rel="noopener ugc nofollow" target="_blank"><em class="kz">https://learn . vonage . com/blog/2021/02/08/add-sip-calls-to-webrtc-video-sessions/</em></a></p></div></div>    
</body>
</html>