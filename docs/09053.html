<html>
<head>
<title>An approach to analyse and monitor AWS CloudFront logs on Datadog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一种基于Datadog的自动气象站CloudFront日志分析和监控方法</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/an-approach-to-analyse-and-monitor-aws-cloudfront-logs-on-datadog-dacab0ca45e6?source=collection_archive---------5-----------------------#2021-06-30">https://levelup.gitconnected.com/an-approach-to-analyse-and-monitor-aws-cloudfront-logs-on-datadog-dacab0ca45e6?source=collection_archive---------5-----------------------#2021-06-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="12a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将讨论在Datadog上分析和监控日志所需遵循的体系结构和步骤。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/c21b764e30899f9ce0ee9a1a4fc37751.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*COpesASbj1Px15J_.jpg"/></div></div></figure><p id="bd79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">亚马逊网络服务(AWS)是世界上最全面、最广泛采用的云平台，从全球数据中心提供200多种全功能服务。CloudFront就是他们提供的服务之一。CloudFront是一个内容交付网络，帮助组织/客户向他们的消费者交付内容。</p><p id="730f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一方面，Datadog是信息技术(IT)和DevOps团队的监控和分析工具，可用于确定性能指标以及基础架构和云服务的事件监控。</p><p id="46a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，有人可能会问，既然可以通过Cloudwatch实现，他们为什么还需要Datadog？是的，你说得对。“监控AWS资源”是开发者考虑Amazon CloudWatch优于竞争对手的主要原因，而“监控许多应用程序(数据库、web服务器等)”被认为是选择Datadog的关键因素。如果您正在使用或希望使用Datadog来监控您的各种应用程序(数据库、web服务器等)，您也希望利用Datadog的惊人功能来监控您的AWS日志。</p><h1 id="f7a4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">体系结构</h1><p id="d185" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">下面是为我们的目的而设计的架构。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ma"><img src="../Images/b53581ec3b1e42a0203cb45558898feb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sbDse0fycSsXSp56Qf23Yw.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">Cloudfront日志到Datadog架构</figcaption></figure><p id="c68d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在继续之前，让我们了解一下这个架构中使用的服务。</p><h2 id="b143" class="mf ky iq bd kz mg mh dn ld mi mj dp lh jy mk ml ll kc mm mn lp kg mo mp lt mq bi translated">AWS云锋</h2><p id="1825" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Amazon CloudFront是由Amazon Web Services运营的内容交付网络。内容传送网络提供了代理服务器的全球分布式网络，这些代理服务器将内容(例如网络视频或其他大容量媒体)缓存在消费者本地，从而提高了下载内容的访问速度。<br/>对于CloudFront标准日志文件字段，请参考此处的<a class="ae mr" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/AccessLogs.html" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="f305" class="mf ky iq bd kz mg mh dn ld mi mj dp lh jy mk ml ll kc mm mn lp kg mo mp lt mq bi translated">自动气象站运动学数据流</h2><p id="0452" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">亚马逊Kinesis数据流(KDS)是一个大规模可扩展和持久的实时数据流服务。收集的数据可在数毫秒内获得，以支持实时分析用例，如实时仪表盘、实时异常检测、动态定价等。</p><h2 id="d6af" class="mf ky iq bd kz mg mh dn ld mi mj dp lh jy mk ml ll kc mm mn lp kg mo mp lt mq bi translated">AWS Kinesis消防软管</h2><p id="54e8" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Amazon Kinesis Data Firehose是一项完全托管的服务，可自动供应、管理和扩展处理和加载流数据所需的计算、内存和网络资源。一旦设置完成，Kinesis Data Firehose会在数据流到达目的地时将其持续加载到目的地。</p><h2 id="c50c" class="mf ky iq bd kz mg mh dn ld mi mj dp lh jy mk ml ll kc mm mn lp kg mo mp lt mq bi translated">AWS S3铲斗</h2><p id="b5c7" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">亚马逊S3存储桶是亚马逊网络服务(AWS)简单存储服务(S3)中可用的公共云存储资源，这是一种对象存储产品。亚马逊S3存储桶类似于文件夹，存储由数据及其描述性元数据组成的对象。</p><h2 id="05e1" class="mf ky iq bd kz mg mh dn ld mi mj dp lh jy mk ml ll kc mm mn lp kg mo mp lt mq bi translated">数据狗</h2><p id="b166" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Datadog是面向信息技术(IT)和DevOps团队的监控和分析工具，可用于确定性能指标以及基础架构和云服务的事件监控。</p><p id="7239" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们正在设置一个Kinesis数据流来传输CloudFront日志，然后使用Kinesis firehose将数据流加载到DataDog。如果在向Datadog发送日志时出现任何故障，它们可以存储在S3存储桶中。在Datadog端，我们需要解析这些日志，提取对我们有用的字段，并在它们之上创建定制的度量。然后，这些自定义指标将用于在仪表板上创建时间序列图，从而创建监视器和警报。下面是建立上述架构的详细步骤。</p><h1 id="edaf" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">流程步骤</h1><h2 id="39c1" class="mf ky iq bd kz mg mh dn ld mi mj dp lh jy mk ml ll kc mm mn lp kg mo mp lt mq bi translated">将CloudFront日志推送到Datadog</h2><ol class=""><li id="26a2" class="ms mt iq jp b jq lv ju lw jy mu kc mv kg mw kk mx my mz na bi translated">确定我们想要监控其流量的Cloudfront分布。</li><li id="eee2" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">配置CloudFront发送实时日志:- <br/>一个CloudFront <a class="ae mr" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/real-time-logs.html#understand-real-time-log-config" rel="noopener ugc nofollow" target="_blank">实时日志配置</a>指定日志的来源和目的地，以及它们包含的字段。要创建您的日志配置，请为配置提供一个名称，并指定它的日志采样率——由CloudFront生成的、您想要发送到Kinesis的日志的百分比。接下来，选择要包含在日志中的字段。默认情况下，您的日志配置将包括所有可用的<a class="ae mr" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/real-time-logs.html#understand-real-time-log-config-fields" rel="noopener ugc nofollow" target="_blank"> CloudWatch日志字段</a>。</li><li id="ffc2" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">创建Kinesis流:- <br/>指定一个<a class="ae mr" href="https://aws.amazon.com/kinesis/data-streams/" rel="noopener ugc nofollow" target="_blank"> Kinesis数据流</a>作为CloudFront将日志发送到的端点。如果您已经有了一个想要使用的流，请在Endpoint字段中输入它的<a class="ae mr" href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html" rel="noopener ugc nofollow" target="_blank"> Amazon资源名称(ARN) </a>。或者创建新的流。</li><li id="bb41" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">导航回“创建实时日志配置”页面，并将ARN粘贴到端点字段中。</li><li id="f9ce" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">创建一个<a class="ae mr" href="https://www.datadoghq.com/blog/cloudfront-real-time-logs/#configure-cloudfront-to-send-real-time-logs" rel="noopener ugc nofollow" target="_blank"> Datadog API键</a>，当我们创建AWS Kinesis firehose时将需要它。</li><li id="0066" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">通过Kinesis Data Firehose将日志发送到Datadog:- <br/>要将日志发送到Datadog，请创建一个Kinesis Data Firehose <a class="ae mr" href="https://docs.aws.amazon.com/firehose/latest/dev/what-is-this-service.html#key-concepts" rel="noopener ugc nofollow" target="_blank">交付流</a>，并选择上面创建的Kinesis数据流作为源。接下来，指定Datadog作为您的交付流的目的地。最后，输入您的Datadog API密钥，选择适当的HTTP端点URL，并提供所需的<a class="ae mr" href="https://docs.datadoghq.com/logs/guide/send-aws-services-logs-with-the-datadog-kinesis-firehose-destination/?tab=kinesisfirehosedeliverystream" rel="noopener ugc nofollow" target="_blank">附加配置细节</a>。参见AWS文档，了解如何<a class="ae mr" href="https://docs.aws.amazon.com/firehose/latest/dev/create-destination.html#create-destination-datadog" rel="noopener ugc nofollow" target="_blank">将Datadog配置为Kinesis数据消防软管目的地</a>。</li><li id="38b6" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">确保在AWS kinesis firehose中添加键值参数，这将有助于轻松找到Datadog上的日志。</li></ol><p id="fb7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成上述步骤后，您可以看到日志被发送到DataDog，并且可以通过搜索上述步骤中创建的参数在<a class="ae mr" href="https://docs.datadoghq.com/logs/explorer/live_tail/" rel="noopener ugc nofollow" target="_blank"> Live Tail </a>上看到。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ng"><img src="../Images/b2a121cddf3d8d73341aabbc0e4cd013.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Twh_GydW2aRyHKDF.gif"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">随机活尾样本</figcaption></figure><p id="94f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Datadog的后续步骤</p><p id="ed8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> **索引整个日志不划算，我们应该采用</strong> <a class="ae mr" href="https://www.datadoghq.com/blog/logging-without-limits/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">无限制日志记录</strong> </a> <strong class="jp ir">的方法。创建自定义指标将为我们节省大量成本。</strong></p><h2 id="648d" class="mf ky iq bd kz mg mh dn ld mi mj dp lh jy mk ml ll kc mm mn lp kg mo mp lt mq bi translated">从Datadog上的CloudFront日志中解析和创建定制指标</h2><ol class=""><li id="bbbd" class="ms mt iq jp b jq lv ju lw jy mu kc mv kg mw kk mx my mz na bi translated">在Datadog中创建一个<a class="ae mr" href="https://docs.datadoghq.com/logs/log_configuration/pipelines/" rel="noopener ugc nofollow" target="_blank">管道</a>来处理接收到的日志。</li><li id="7fec" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated"><a class="ae mr" href="https://docs.datadoghq.com/logs/log_configuration/parsing/?tab=matchers" rel="noopener ugc nofollow" target="_blank">添加Grok解析器</a>解析日志，从日志中提取有用的字段。</li><li id="ef8b" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated"><a class="ae mr" href="https://docs.datadoghq.com/logs/log_configuration/processors/?tab=ui" rel="noopener ugc nofollow" target="_blank">在管道中添加URL解析器、类别处理、重映射器</a>来修改上面提取的字段或添加新的字段。</li><li id="dc0a" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated"><a class="ae mr" href="https://docs.datadoghq.com/metrics/custom_metrics/" rel="noopener ugc nofollow" target="_blank">使用参数(在Kinesis firehose中添加)创建一个自定义指标</a>作为过滤器，其尺寸符合要求/使用案例。</li></ol><p id="6440" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们已经准备好使用上面创建的自定义指标来创建我们的控制面板、监视器和警报。<br/>下面是实现相同的一些参考链接:- <a class="ae mr" href="https://docs.datadoghq.com/dashboards/" rel="noopener ugc nofollow" target="_blank">仪表盘</a> &amp; <a class="ae mr" href="https://docs.datadoghq.com/monitors/monitor_types/" rel="noopener ugc nofollow" target="_blank">监控器</a></p><p id="0e40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你喜欢这篇文章，并帮助你完成你的任务。</p><h2 id="6ea8" class="mf ky iq bd kz mg mh dn ld mi mj dp lh jy mk ml ll kc mm mn lp kg mo mp lt mq bi translated">如果你觉得这篇文章有用，给我倒杯咖啡:-<a class="ae mr" href="http://buymeacoffee.com/rushabh" rel="noopener ugc nofollow" target="_blank">buymeacoffee.com/rushabh</a></h2></div></div>    
</body>
</html>