<html>
<head>
<title>Concurrency in iOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">iOS中的并发性</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/concurrency-in-ios-feb653301d1a?source=collection_archive---------10-----------------------#2020-06-09">https://levelup.gitconnected.com/concurrency-in-ios-feb653301d1a?source=collection_archive---------10-----------------------#2020-06-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="fcd0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于一个应用程序来说，性能非常重要，作为一个iPhone用户，没有人想在采取行动后等待回应，如果发生这种情况，你的应用程序可能会得到负面评价。</p><p id="3099" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以通过多种方式优化应用程序的性能，并发就是其中之一</p><p id="9296" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">什么是并发？</strong></p><p id="06d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果一个以上的任务同时发生，那么它被称为并发。自2011年以来，所有iPhone都支持同时执行多个任务。通过添加一些代码，我们可以同时运行多个任务。</p><p id="f0c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章是关于提高应用程序的性能，我们可以通过两种方式在iOS中并发运行代码</p><ol class=""><li id="a931" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><strong class="jp ir">中央车站</strong></li><li id="ee3f" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><strong class="jp ir">操作类</strong></li></ol><p id="fe9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们深入研究一下-</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="le lf l"/></div></figure><p id="bca9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">大中央调度</strong></p><p id="7a2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Dispatch也称为Grand Central Dispatch (GCD ),包含语言特性、运行时库和系统增强功能，对macOS、iOS、watchOS和tvOS中多核硬件上的并发代码执行支持进行了系统、全面的改进。<br/>BSD子系统、Core Foundation和Cocoa APIs都得到了扩展，以使用这些增强功能来帮助系统和您的应用程序更快、更高效地运行，并提高响应能力。想想看，单个应用程序有效使用多个内核有多困难，更不用说在具有不同数量计算内核的不同计算机上或在多个应用程序竞争这些内核的环境中这样做了。运行在系统级的GCD可以更好地适应所有正在运行的应用程序的需求，以平衡的方式将它们与可用的系统资源相匹配。—苹果文档。</p><p id="f66c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">串行和并发队列</strong></p><p id="e5fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">串行队列只有一个与之关联的线程，因此在任何给定的时间点只允许执行一个任务。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lg"><img src="../Images/c9f9e236f561b17a68d875738415d7a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dI7BB1Kik9zzK-6FtQl5tg.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">串行队列图</figcaption></figure><p id="ba52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个并发队列可以利用系统资源所能利用的所有线程。将在并发队列中根据需要创建和释放一个线程。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lr"><img src="../Images/a979b5bb5b83cf82145278e353367810.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r0AmfKyXjFqEjT2xTg26Vg.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">并发队列图</figcaption></figure><p id="37b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">同步和异步任务</strong></p><p id="b0cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们在队列中有一些未完成的任务，我们可以同步完成<strong class="jp ir">或者异步完成</strong>或者<strong class="jp ir">。</strong></p><p id="39f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当一个任务正在同步运行时，当前队列将被阻塞，直到该任务没有完成，然后才移动到另一个任务。</p><p id="c2b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一方面，当前队列上的异步任务将启动，但会立即将控制返回给当前队列。这样，当前队列将不会被阻塞，我们可以在当前队列上执行其他任务。</p><blockquote class="ls lt lu"><p id="1070" class="jn jo lv jp b jq jr js jt ju jv jw jx lw jz ka kb lx kd ke kf ly kh ki kj kk ij bi translated">记住，如果一个任务是异步的，并不意味着它会并发运行。我们可以对串行或并发队列执行异步任务。同步和异步只是确定我们正在其上运行任务的队列是否必须等待任务完成，然后才能移动到下一个任务。<br/>包含串行与并发识别队列是否有单线程或多线程可用于执行任务。</p></blockquote><p id="0446" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过并行运行而不是串行运行，我们可以更快地完成任务。</p><p id="1e45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">调度队列</strong></p><p id="61c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建队列时，操作系统会将一个或多个线程分配给该队列。如果现有线程可用，它们可以被重用；如果没有，那么操作系统将相应地创建它们。创建调度队列-</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="lz lf l"/></div></figure><p id="8a54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就这样，已经创建了一个串行队列。:)</p><p id="e9db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，当应用程序启动时，会为您创建一个主调度队列。它是一个串行队列，主要负责UI。你可以像这样访问它-</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="lz lf l"/></div></figure><p id="411b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除非与UI无关，否则不应该在这里执行任何同步任务。否则，它将冻结您的用户界面，直到执行同步任务。</p><p id="7db0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以通过将属性作为. concurrent传递来创建并发队列</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="lz lf l"/></div></figure><p id="3985" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据服务质量(QoS ),并发队列分为六个不同的全局并发队列类别。</p><p id="3c6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">服务质量</strong></p><p id="1a17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用QoS来确定任务的优先级。较高优先级的任务应该比较低优先级的任务执行得更快，因为它需要更多的系统资源。如果您想要一个并发队列，并且不想自己管理它，那么就使用预定义的全局队列。</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="lz lf l"/></div></figure><p id="947c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里有不同的服务质量-</p><ol class=""><li id="4d6e" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><strong class="jp ir">。userInteractive - </strong>推荐用于用户直接交互的任务。主要与UI相关，如动画、事件处理或更新应用程序的用户界面。如果一个耗时的任务来了，那么它可能会冻结你的应用程序中的屏幕。</li><li id="af8a" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><strong class="jp ir">。用户启动- </strong>您可以执行在用户交互后启动的任务，如打开文档、获取数据等。这些任务可以异步执行，并反映到UI中。</li><li id="b603" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><strong class="jp ir">。utility - </strong>可以执行用户不主动跟踪的任务。显示长时间运行的计算或下载的进度指示器。</li><li id="7b7b" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><strong class="jp ir">。背景- </strong>你可以执行一个用户不知道的任务。例如维护数据库、执行备份等。</li><li id="46af" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><strong class="jp ir">。默认- </strong>介于用户交互和用户发起之间。</li><li id="c452" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><strong class="jp ir">。未指明的</strong></li></ol><p id="3f7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">。默认</strong>和<strong class="jp ir">。未指明的</strong>是很少使用的Qos。</p><p id="88da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以创建自己的具有Qos的并发调度队列，如下所示</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="lz lf l"/></div></figure><p id="7c1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以像这样向队列添加任务-</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="lz lf l"/></div></figure><p id="65f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总是更新主队列中的UI。如果你想使用同步方法，那么在这里要小心使用，否则会导致死锁。不要从主线程调用sync方法，它会阻塞主线程并导致死锁。</p><p id="c97d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您在应用程序中实现并发时，您应该小心，否则您可能会面临并发问题，如竞争条件、死锁或优先级反转。</p><p id="af32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有时你需要同时执行多个任务，但是哪个任务先完成并不重要，你只是想知道所有任务什么时候完成。对于这个场景，我们可以使用<strong class="jp ir"> DispatchGroup。下面是DispatchGroup的一个基本实现。</strong></p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="lz lf l"/></div></figure><p id="26a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在某些情况下，你想要指定有多少线程可以访问一个共享资源，在这种情况下我们可以使用一个<strong class="jp ir">信号量</strong>。</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="lz lf l"/></div></figure><p id="2954" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">作战- </strong></p><p id="e0e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过使用Grand Central Dispatch，我们可以同时提交任务，但是如果您想要对任务进行额外的定制，那么操作就成了问题。运营本身就是一个很大的话题。我将在本文的下一部分讨论这个问题。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><p id="f347" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢您阅读这篇文章。如果你觉得这篇文章有帮助，请不要忘记鼓掌。</p><p id="6ecb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您有任何问题或意见，请随时通过推特<a class="ae mh" href="https://twitter.com/nomadicsheldon" rel="noopener ugc nofollow" target="_blank">联系我。</a></p></div></div>    
</body>
</html>