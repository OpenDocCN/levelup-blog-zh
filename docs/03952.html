<html>
<head>
<title>Storing and querying monetary values in Postgres and Hasura</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Postgres和Hasura中存储和查询货币值</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/storing-and-querying-monetary-data-in-postgres-and-hasura-c0d2cdc2a560?source=collection_archive---------4-----------------------#2020-06-03">https://levelup.gitconnected.com/storing-and-querying-monetary-data-in-postgres-and-hasura-c0d2cdc2a560?source=collection_archive---------4-----------------------#2020-06-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5fa3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">PostgreSQL中财务信息应该使用和不应该使用的数据类型，以及JavaScript和Hasura特有的风险。</h2></div><p id="efac" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">无论你在做什么，将来你都有一个很好的机会将这个项目货币化。</p><p id="4b8b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">随着货币化，存储和操纵金融数据的许多挑战也随之而来。</p><p id="76e4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面，我将讨论Postgres中货币信息应该使用和不应该使用的数据类型。然后我将讨论在JavaScript和<a class="ae lb" href="https://hasura.io/" rel="noopener ugc nofollow" target="_blank"> Hasura </a>中使用这些类型时的额外考虑。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/2cd46f3dd91774185b70f7369418da16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xgWH2bfIsD85MLVcrKi9UA.png"/></div></div></figure><h1 id="aa50" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">PostgreSQL中的货币类型</h1><h2 id="75d9" class="mg lp iq bd lq mh mi dn lu mj mk dp ly ko ml mm ma ks mn mo mc kw mp mq me mr bi translated">⚠实数/双精度(浮点)</h2><p id="9bf9" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated"><em class="mx">用于存储可变精度的近似值。</em></p><p id="7a0b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">许多初级开发人员无意中选择的存储金融交易的类型是浮点型。</p><p id="9629" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">毕竟，在包括JavaScript在内的普通语言中，Float是数字的默认类型，对于4.99美元的商品，键入<em class="mx"> const price = 4.99 </em>具有直观的意义。</p><p id="da2c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">问题是，<a class="ae lb" href="https://0.30000000000000004.com/" rel="noopener ugc nofollow" target="_blank">浮点运算并不是100%准确</a>。</p><p id="fb05" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，尝试运行下面的JavaScript代码:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="54d1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者Postgres中类似的脚本:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="cd43" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这种不精确会导致大规模的财务损失。因此，<strong class="kh ir">货币数据永远不应该存储为Float </strong>，一般应该避免使用类型。</p><h2 id="fa86" class="mg lp iq bd lq mh mi dn lu mj mk dp ly ko ml mm ma ks mn mo mc kw mp mq me mr bi translated">数字/小数</h2><p id="d97b" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated"><em class="mx">用于存储精确值，实际上没有限制，用户特定的精度(小数点前最多131072位；小数点后最多16383位)。</em></p><p id="8616" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了解决浮点精度问题，Postgres提供了数字类型及其别名Decimal。这些类型可以存储非常多位数的数字，并且还可以精确地执行计算。</p><p id="fcef" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们重新运行前面的SQL循环，用Numeric类型代替Float类型:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="c4dc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您只处理美元和小于10亿美元的金额，Numeric(12，2)应该可以提供足够的精度。</p><p id="2171" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您要在多种货币之间进行转换，或者处理以分数计价的商品(如汽油)，请使用较大的数字(18，8)。</p><h2 id="3181" class="mg lp iq bd lq mh mi dn lu mj mk dp ly ko ml mm ma ks mn mo mc kw mp mq me mr bi translated">金钱</h2><p id="73f6" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated"><em class="mx">用于存储固定小数精度的货币金额。</em></p><p id="d16a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">与MySQL不同，Postgres还提供了一种专用的货币类型，以固定的小数精度存储货币金额。</p><p id="352b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输入可以采用多种形式，包括整数、浮点数，甚至是字符串，如“$20.00”。输出也会自动格式化为货币值:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="7f42" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">小数精度和货币符号都由数据库或环境<em class="mx"> LC_MONETARY </em>设置决定。</p><p id="ca18" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这意味着您不能同时操作$和，如果您处理多种货币，那么不鼓励使用货币类型。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="fb9b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，货币值除以整数是通过将小数部分向零截断来执行的。</p><p id="b1ed" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了得到一个舍入的结果，在除法之前将货币值转换成数字，然后再转换回货币。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><blockquote class="na nb nc"><p id="7949" class="kf kg mx kh b ki kj jr kk kl km ju kn nd kp kq kr ne kt ku kv nf kx ky kz la ij bi translated">如果高性能对您的用例很重要，那么对货币类型值的操作要比对数字或整数的操作慢。</p></blockquote><h2 id="c296" class="mg lp iq bd lq mh mi dn lu mj mk dp ly ko ml mm ma ks mn mo mc kw mp mq me mr bi translated">整数/整数</h2><p id="3600" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated"><em class="mx">用于存储不含小数的值，在</em> -2147483648和+2147483647 <em class="mx">之间。</em></p><p id="b990" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了避免浮点精度问题，处理货币值的一种常见方法，特别是在JavaScript中，是使用正整数值来表示以最小货币单位收费的金额。</p><p id="7718" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">整数的除法和小数的乘法仍然可能导致不精确的值，但是比较和基本的整数加法、减法和乘法将是精确的。</p><p id="9604" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您曾经使用过Stripe，那么您应该已经熟悉了这种模式。Stripe API返回$1.00作为100(美分)，100作为100(因为日元是零十进制货币)。</p><p id="eef0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，Postgres中的最大安全整数是2，147，483，647。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="8dad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这意味着您只能使用整数来存储大约20亿美分，或2000万美元。</p><p id="b2da" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您需要处理一美分的小数部分，例如货币兑换、汽油价格、广告展示或API费用，您将需要使用整数微美元($0.000001)来代替。</p><p id="ee0b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这使我们的最大储值仅为2147美元。</p><blockquote class="na nb nc"><p id="8bb8" class="kf kg mx kh b ki kj jr kk kl km ju kn nd kp kq kr ne kt ku kv nf kx ky kz la ij bi translated">如果高性能对您的用例很重要，那么对整数的操作要比对货币、数字和字符串的操作快。</p></blockquote><h2 id="31a3" class="mg lp iq bd lq mh mi dn lu mj mk dp ly ko ml mm ma ks mn mo mc kw mp mq me mr bi translated">BigInt</h2><p id="e961" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated"><em class="mx">用于存储不含小数的值，在</em> -9223372036854775808和+9223372036854775807之间</p><p id="42ab" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一个整数的最大值刚好超过2000万美元，Stripe每天怎么处理几十亿？</p><p id="a855" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输入BigInt，这是一种可以存储高达千万亿分或千万亿美元的值的类型！</p><p id="5228" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">即使您决定将值存储为微美元，BigInt也能为您提供超过一万亿美元的数据。</p><p id="102c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，直到最近，JavaScript还不支持<a class="ae lb" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt" rel="noopener ugc nofollow" target="_blank"> BigInt </a>，ECMA-262引入的新类型仍然需要polyfill才能在Safari浏览器(包括iOS)中工作。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="d736" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还要注意，在BigInt除法中，小数结果被截断，而不是四舍五入:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="0a44" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，如果在分组数据中仅超过最大整数值，请记住，在调用聚合函数之前，您总是可以将单个值转换为BigInt:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><blockquote class="na nb nc"><p id="381d" class="kf kg mx kh b ki kj jr kk kl km ju kn nd kp kq kr ne kt ku kv nf kx ky kz la ij bi translated">如果高性能对您的用例很重要，请注意BigInt上的操作比Integer慢，但比Money和Numeric快。</p></blockquote><h1 id="c9ca" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">在哈苏拉处理金钱</h1><p id="a3e4" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">通读以上内容，或者StackOverflow和其他地方的无数争论之后，你可能已经决定用一种或另一种类型来存储你的财务数据。</p><p id="07a8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">也许是为了格式和易用性，或者是为了直观的精确性。</p><p id="b7e0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是等等，如果你最终打算用Hasura和JavaScript来使用数据，还有几个问题要考虑！</p><h2 id="24cb" class="mg lp iq bd lq mh mi dn lu mj mk dp ly ko ml mm ma ks mn mo mc kw mp mq me mr bi translated">对JS使用数字类型的风险</h2><p id="8893" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">Numeric可能是Postgres社区中最流行的货币值类型。</p><p id="4701" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它足够直观，足够高效，舍入也没有问题。</p><p id="bf5c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，这意味着一旦查询数据，您将有效地在JavaScript中获得一个浮点。您必须记住在任何操作之前将该值乘以100(如果处理分数美分，则乘以更多)，然后在存储最终结果之前除以100。</p><p id="90dd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于货币类型也存在同样的问题。</p><h2 id="288b" class="mg lp iq bd lq mh mi dn lu mj mk dp ly ko ml mm ma ks mn mo mc kw mp mq me mr bi translated">对JS使用整数类型的风险</h2><p id="2cd8" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">整数是JavaScript社区中存储货币值的最流行的选项，使用起来相当简单，但是需要记住一个主要问题。</p><p id="123e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">JavaScript中的<em class="mx"> MAX_SAFE_INTEGER </em>是9，007，199，254，740，991，而Postgres中的最大整数值只有2，147，483，647(与JS中位运算的最大安全整数大小相同)。</p><p id="8e40" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您正在处理非常大或非常小的货币金额，那么您将面临超出Postgres中最大值的风险，而不会在JS代码中遇到任何错误。</p><p id="88ec" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了避免这个问题，考虑使用你自己的整数极限常数，而不是依赖于<em class="mx">数。MAX_SAFE_INTEGER </em>。</p><h2 id="b9e1" class="mg lp iq bd lq mh mi dn lu mj mk dp ly ko ml mm ma ks mn mo mc kw mp mq me mr bi translated">用Hasura变异和查询BigInt值</h2><p id="e209" class="pw-post-body-paragraph kf kg iq kh b ki ms jr kk kl mt ju kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">如果您需要在系统中处理非常大(或非常小)的值，BigInt可能是最健壮和性能最好的解决方案。</p><p id="62a7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，重要的是要记住，JSON不支持这种类型，当在查询中返回时，大整数将被限制为<em class="mx"> MAX_SAFE_INTEGER </em>！</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="1946" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要解决这个问题，可以使用<em class="mx"> - stringify-numeric-types </em>标志或<em class="mx">HASURA _ graph QL _ STRINGIFY _ NUMERIC _ TYPES = true</em>环境变量来启用Postgres数值类型的字符串化。</p><p id="c257" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">启用此选项后，Hasura将表示BigInt(以及数字、小数等。)作为字符串，并在突变中接受相同的格式:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="8a9a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Node.js中，你必须记住用ES6 <em class="mx"> BigInt() </em>函数将字符串转换成安全值，如果你需要在Safari客户端上进行操作，使用<a class="ae lb" href="https://github.com/peterolson/BigInteger.js" rel="noopener ugc nofollow" target="_blank"> BigInteger polyfill </a>。</p><p id="d52e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后但同样重要的是，您应该避免使用Hasura控制台UI来插入或更新任何这样大的值，因为这些值最终也会被JavaScript的<em class="mx"> MAX_SAFE_INTEGER </em>所限制。</p><div class="ld le lf lg gt ab cb"><figure class="ng lh nh ni nj nk nl paragraph-image"><img src="../Images/6f697a1494e01fb122721c5e14d9128c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1496/format:webp/0*rsHyQNN53C7S1M8c.png"/></figure><figure class="ng lh nm ni nj nk nl paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><img src="../Images/f9ad83648d7fa88db4cab0e858111b49.png" data-original-src="https://miro.medium.com/v2/resize:fit:378/format:webp/0*ckubgTJw-IQtQwoH.png"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk nr di ns nt">😱</figcaption></figure></div><h2 id="62e1" class="mg lp iq bd lq mh mi dn lu mj mk dp ly ko ml mm ma ks mn mo mc kw mp mq me mr bi translated">喜欢这篇文章吗？跟我来🐦推特<a class="ae lb" href="https://twitter.com/seifip" rel="noopener ugc nofollow" target="_blank"> @seifip </a></h2></div></div>    
</body>
</html>