<html>
<head>
<title>Mitigate Unstable Connectivity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">缓解不稳定的连接</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/mitigate-unstable-connectivity-bf989c62acdd?source=collection_archive---------3-----------------------#2021-06-17">https://levelup.gitconnected.com/mitigate-unstable-connectivity-bf989c62acdd?source=collection_archive---------3-----------------------#2021-06-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d439" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用tmux和。用于SSH远程会话的bashrc</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/da0d8d59d444d2b7f81c0168f09b5b7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CzY7zh81Hql9rfV9oLaCAA.png"/></div></div></figure><p id="6b26" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你在科技行业工作过一段时间，或者过去只是上过一些计算机科学课程，那么你很可能不得不通过<a class="ae lq" href="https://en.wikipedia.org/wiki/Secure_Shell_Protocol" rel="noopener ugc nofollow" target="_blank"> SSH </a>与远程服务器一起工作，以执行一些命令、编译代码、解决服务器问题，或者部署你编写的新应用。你们中的一些人甚至可能有一个便携式CLI环境，只要你有稳定的互联网连接，无论你去哪里，它都允许你做任何你自己定制的事情。也就是说，如果您总是与一台台式计算机保持稳定的连接，并且您运行的命令不需要花费数小时来完成，那么SSH很可能就足够了。</p><p id="d7b3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，如果你一天中不停地跑来跑去通过多个地点连接，你会遇到和这篇文章顶部图片一样的问题。当您完成了一个命令的90%时，突然之间，您的连接中断了，这难道不令人沮丧吗？是的，这意味着您必须重新开始，因为您会丢失会话状态，并且一旦连接中断，所有进程都会被终止。如果您想要运行一个需要5个小时的命令，并且在这5个小时之间，您必须使用同一台笔记本电脑移动到不同的物理位置，该怎么办？好吧，欢迎来到我的生活故事！</p><h2 id="6be6" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">长时间运行流程和不稳定连接的解决方案</h2><p id="e609" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">是的，正如这篇文章的标题所暗示的，上面提到的挑战有一个解决方案，而且只需要几分钟就可以完成。您所要做的就是安装以下软件:</p><ul class=""><li id="d4bd" class="mp mq it kw b kx ky la lb ld mr lh ms ll mt lp mu mv mw mx bi translated"><a class="ae lq" href="https://github.com/tmux/tmux" rel="noopener ugc nofollow" target="_blank">tmux</a>——一个强大的终端多路复用器，它的能力超过了我在这里将要讨论的范围。出于本文的目的，我们将重点关注它在多次登录/连接中维护会话状态以及在远程会话中拆分窗口的能力，就像您在本地桌面环境中使用<a class="ae lq" href="https://gnunn1.github.io/tilix-web/" rel="noopener ugc nofollow" target="_blank"> Tilix </a> / <a class="ae lq" href="https://gnome-terminator.org/" rel="noopener ugc nofollow" target="_blank"> Terminator </a>一样。</li></ul><p id="2477" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如您所料，tmux是键盘驱动的，非常适合远程CLI环境。你不需要这样做，但这里有一个快速的备忘单，告诉那些有兴趣深入了解我将在以下步骤中介绍的内容的人如何去做:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/3fc4c9170959bb8c8c793bc0c666e6fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sfa1eF24Y6sC1UPvpVQa5A.png"/></div></div></figure><p id="1b3d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">虽然tmux很可能已经安装在您选择的发行版中，但是如果您的远程Linux服务器上还没有安装tmux，那么下面是如何安装tmux的方法:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="f316" class="lr ls it na b gy ne nf l ng nh"># Debian/Ubuntu Base<br/>$ sudo apt install tmux</span><span id="1230" class="lr ls it na b gy ni nf l ng nh"># Arch Based<br/>$ sudo pacman -S tmux</span><span id="eaa7" class="lr ls it na b gy ni nf l ng nh"># RedHat Based<br/>$ sudo dnf install tmux</span></pre><p id="1e6a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这就是了。现在，当您登录后只需键入tmux，您将拥有一个远程会话，它将经受住多次登录/注销和不稳定的连接:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/ea9db38d94eacf8a4105875c8da363c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*pmoZnMdLlkhIuFWKQHVSHg.png"/></div></figure><p id="6f24" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">请注意底部有一个绿色条。它表示您处于tmux会话中。此时，即使您的连接中断，您的会话仍将继续。您只需重新登录并重新连接tmux会话，就可以再次看到所有内容重新出现在您的眼前。</p><p id="f321" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在让我们在tmux会话中进行一些“工作”:</p><ul class=""><li id="29c6" class="mp mq it kw b kx ky la lb ld mr lh ms ll mt lp mu mv mw mx bi translated">水平分割窗口，点击Ctrl-b %,然后输入“htop”在右边运行htop</li><li id="4855" class="mp mq it kw b kx nk la nl ld nm lh nn ll no lp mu mv mw mx bi translated">按Ctrl-b ←(左箭头)返回到左侧外壳</li><li id="b1a9" class="mp mq it kw b kx nk la nl ld nm lh nn ll no lp mu mv mw mx bi translated">运行DoTheWork.sh脚本</li></ul><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="8b98" class="lr ls it na b gy ne nf l ng nh">$ ./DoTheWork.sh</span></pre><p id="8514" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您的会话现在看起来将如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/62d297bc5a3ba795b4758c4ded949a10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0KwPs7fu6Wyki7ZqUh5Jrg.png"/></div></div></figure><p id="002a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，让我们从这个会话中分离出来，并在它完成它的工作时干净地注销，以便我可以通过按Ctrl-b d，然后按Ctrl-d或键入exit从服务器中注销，实际移动到我的下一个目的地。</p><p id="88af" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">到达下一个目的地后，我只需重新登录服务器并键入以下内容:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="28e0" class="lr ls it na b gy ne nf l ng nh">$ tmux attach -t 0</span></pre><p id="27d0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">上面命令中的“0”是会话id，如果只有一个tmux会话，则该id始终为0。如果您有多个会话，那么id当然会增加。所以，是的，你可以同时进行多个会话。要检查您打开了哪些会话，您只需键入:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="3966" class="lr ls it na b gy ne nf l ng nh">$ tmux ls</span></pre><p id="5669" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在任何情况下，在您重新连接tmux会话之后，您将会看到一切都如预期的那样仍然存在。请再次注意，即使您没有干净地分离tmux会话，并且在工作时失去了连接，这也是正确的。</p><p id="8992" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">就是这样！然而，您可能像我一样，在登录远程服务器时有时会忘记启动tmux。我不记得在没有启动tmux的情况下，在远程服务器上运行某个长进程之前，我有多少次想扇自己耳光。所以能解决我健忘的部分来了。</p><h2 id="6c1a" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">自动启动tmux</h2><p id="91fd" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">我将假设您要么使用bash，要么使用shell环境。我是巴沙尔。</p><p id="10cf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了让tmux在登录时自动启动，这样您就不必自己动手了，请打开~/。bashrc，并添加以下几行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="aaf7" class="lr ls it na b gy ne nf l ng nh">if [[ -n "$PS1" ]] &amp;&amp; [[ -z "$TMUX" ]]; then<br/>    tmux new-session<br/>fi</span></pre><p id="0df4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这将在您每次登录时自动打开一个新的tmux会话。这当然意味着您必须在下次登录时手动重新连接会话，但这也意味着您可以灵活地连接您想要的任何会话，而不是自动启动现有会话。</p><p id="933c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是，如果您只想反复使用同一个会话，请在。改为远程服务器的bashrc:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="7d6f" class="lr ls it na b gy ne nf l ng nh">if [[ -n "$PS1" ]] &amp;&amp; [[ -z "$TMUX" ]]; then<br/>    tmux attach-session -t ssh_tmux || tmux new-session<br/>fi</span></pre><p id="af7a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后但同样重要的是，如果您希望在分离或退出tmux会话后自动注销，请在。您的远程服务器的bashrc intead:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="95cc" class="lr ls it na b gy ne nf l ng nh">if [[ -n "$PS1" ]] &amp;&amp; [[ -z "$TMUX" ]]; then<br/>    tmux attach-session -t ssh_tmux &amp;&amp; exit || tmux new-session &amp;&amp; exit<br/>fi</span></pre><p id="2c27" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你有它！现在，您已经准备好成为一名移动战士，而不会受到不稳定的连接或长时间运行的流程的影响，从而无法前往下一个目的地！</p></div></div>    
</body>
</html>