# 大量意大利面条式代码背后的真正原因

> 原文：<https://levelup.gitconnected.com/the-real-reason-behind-enormous-spaghetti-code-2726fd17bfc7>

![](img/197f008085c076047c44e785bba582dc.png)

照片由[梅姆](https://unsplash.com/@picoftasty?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

大约 5 年前，当我加入一家移动产品公司时，我非常开心。他们使用了非常著名的前沿库和框架。一些例子包括:

*   协议缓冲区，确保基于 TCP 的高效数据传输
*   加密设备上数据的 AES 算法
*   不断更新的移动 UI 框架(iOS 和 Android)确保用户获得最佳体验。

然而，在我加入后不久，我观察到代码库相当臃肿。虽然我不明白到底发生了什么，但是质量差的代码库的症状即使对我这样的新手来说也是显而易见的。

## **没有清单/指南= >不一致**:

没有承诺前清单。如果没有一个通用的标准，即使是最有才华的开发人员也会破坏代码库。对于来自不同背景、不同经验水平、对理想编码实践有不同想法的开发人员(如果存在的话)，你有什么期望？

如何解决这种不一致是另外一个问题:是通过类似 lint 的工具还是通过手动清单。首先解决这个问题的意图是一个先决条件，但在这里并不存在。

## **无质量关卡= >质量差:**

没有对提交进行检查。如果代码审查曾经发生过，那也只是例外，而不是常规。像这样的陈述很常见:

> 更彻底地检查新手提交。

(因为他的前辈没有退休，所以即使过了几年，他还是新手)

> 让我们团结起来，确保只有这**一个**关键特性不会搞砸，其他一切我们都可以单独管理。

(为什么只有这一个，介意解释一下吗？)

在这样的环境中，没有一个新的开发人员会对他将要做的交付感到真诚。他可以看到，每个人都在一个可以接受的借口下犯下每一项罪行，并且可以不受惩罚。

## **冗余= >冗余**:

几周后，我推断，这是前两种症状的最终结果。

> 冗余是多米诺骨牌效应

每个人，不管他是多么资深或有经验，都修复了最新的 bug，而没有注意预先存在的特性/库/函数/类。这导致几乎相同的代码存在于 N 个不同的地方。

*   我们在至少 4 个地方实现了 **atoi()** 及其等价物
*   3 个数据转换例程为至少 10 个不同的类执行几乎相同的 JSON < = >域对象转换。所有这些例程都作为静态函数存在，而不是类成员序列化函数。
*   15+日期格式函数(这个数字可以减少到 2，但是当我尝试的时候，每个人都反对，指出了*巨大变化*的明显缺陷😤)

我在标题中两次提到冗余，只是为了强调它是递归的。你写的冗余代码越多，你的继任者就越有可能效仿。这是一种多米诺骨牌效应，每个人都为已经实现的东西推出自己的实现。

# 这家公司并不孤单:

经过大约 3 个月的糟糕代码，我已经习惯了。事实上，我变得漠不关心，因为我也成了犯罪的同伙。

大约在那个时候，我参加了一个技术会议，一个刚从大学毕业的人向观众展示了他的测试驱动开发方法。他为一个测试表单输入有效性的函数编写了大约 12 个单元测试。原因是这个函数有 6 个输入，所有 12 个测试代表不同的输入排列和组合。

每个人都批评这种方法，提到最好有一个更好的函数实现，只允许一个单元测试来测试所有这些变化。6 个输入也可能由于耦合而减少，这是初级开发人员所忽略的。

这在开发人员中引发了一场关于坏代码最后一个症状的有趣讨论:**冗余**。

我非常惊讶冗余存在于定义良好的清单/指导方针以及严格遵循代码审查过程的公司中。

我恳求为什么会这样，但没有明确的答案出现。

当我离开我的无人看守的公司，加入一个高度组织化和流程驱动的公司时，这一点变得更加清晰。

# 冗余成为主流的真正原因是:

当我加入这个过程驱动的公司时，我对创新的狂热有些失望。换句话说:我了解到，你的公司做着令人敬畏的技术工作，但这并不一定意味着更快乐的工作生活。

流程驱动的公司没有做什么了不起的事情。在其可变屏幕应用程序中，它所做的只是从一个 API 获取特定领域的数据，并将其显示在一个列表中以供查看，或者显示在一个表单中以供创建/更新/删除。最基本的建筑文档被放在一个中心位置，让每个人都可以看到。

代码审查是高度结构化的。他们使用 Gerrit 实现了一个投票机制:一个开发者的提交只有在得到最资深的开发者的两票(= 4 票)时才会被提交给 master。

初级开发人员可以投出一张(1/dev)票，但是他们犹豫不决:即使他们总共投了 4 张票，他们也没有改变什么。如果他们做了什么，那只是向高级开发人员发出信号，表明它已经被查看过了，而且看起来相当不错——在给出它(2 * 2)时不需要太多的分析。

我相信这个系统是世界上最民主的质量关卡。因此也是最好的一个。

是的，这个过程是高度集中的。没有高级开发人员的肯定，没有代码能成功。低年级学生可以抢先一步，让他们的生活更轻松，这是理所应当的！知识自上而下，工作自下而上。

在我开始提交代码后不久，我对这个过程的敬畏开始消失。

首先，没有人注意我的意见。高年级学生通常很忙，这被认为是很正常的。然而，让我困惑的是，有时我的下级同事实际上阻止了评审过程:他们引用我的代码中的不一致，这在其他地方也存在。

代码库臃肿，但没人承认。这家公司被同一个冗余怪物所困扰，而且每天都在变大。

当我在 Gerrit reviews 中争论时，我的 MR 提交会进入三态，没有高级开发人员的干预是无法解决的。

即使有明确定义的编码指导方针，当提交的内容变成初级同行之间的争论时，代码审查队列拒绝移动一英寸。

老年人有时会干预。但当事情发生时，截止日期已经临近了。他们给予他们的双重投票更多的是出于同情，这些未说的话:

> 我现在可以在 10 分钟内完成编码，就像你两周前做的那样，它就在我的队列里。我们需要玩这个游戏，因为你要学习，我要教你。这里没人送东西。

当他们不干预时，这位先生被认为不值得他们注意。作者将不得不重新提交，这将不可避免地导致同行评议。

我至少在 3 次团队会议上提出了阻塞管道的问题。大家都承认了，但是什么都没做。

直到 3 个月后，我的经理把我叫进他的小屋，我才知道发生了什么。

投影仪显示了合并到母版中的 MRs 的条形图。最小的酒吧在右端。我的名字写在下面。

> 我想哭，我多么想重构 10 倍的冗余代码。

![](img/b11433945df1c9f63873279f0f804c63.png)

照片由[алексарцибашев](https://unsplash.com/@lxrcbsv?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

我没花多少时间就意识到发生了什么。但是经理好心地告诉了我。

> 你是最底层的贡献者。我不想让你觉得自己无能，但是董事会没有给我讲一个积极的故事。我需要你一个月内的行动计划。你打算怎么办？

我颤抖了一下。我脑子里闪过一千个论点。我想叙述在每一次被我的同龄人封锁的 MR 期间到底发生了什么。我想哭，我多么想重构 10 倍的冗余代码。

我试着尽可能抽象地描述这个问题(经理不是技术人员，我的运气已经越来越差了):

> “代码库不在理想状态。虽然我是一个新手，但我不认为高级开发人员不知道这种情况。我经常提到重构的必要性，但是什么也没有做。如果我的代码评审论点得到验证并及时采取行动，那么许多 MRs 将会很快通过。官僚作风浪费了很多时间——我本来可以在这段时间里做很多事情，但我所有的提交都被阻止了。”

对此，他说出了至今仍铭刻在我心中的话:

> 你如何处理团队的其他成员是一个**实现细节**，没有人比你这样的高级开发人员更能理解它😊。事实上你比我更有经验！但是让我重申一下，如果你不清楚的话:
> 
> **你的 MR 意见书是我评价你的基准**。其他人都是用同样的标准来评估的。您在主分支中提交的越多，您在年度绩效评估中的表现就越好。
> 
> 目前来看，你参加明年复审的机会相当渺茫。

我麻木了几分钟。我脑子里有一千个论点在为干净的代码、重构、长期代码质量、代码评审反馈的重要性辩护——我可以持续一个小时。

但是等级制度不在我这边。我将向文盲人群发表演讲。此外，高级开发人员已经知道的比我要说的更多。他们有更多的筹码来说服经理。

唉，他们还没有这样做。或者，他们这样做是为了他们自己的利益。无论如何，我的失败迫在眉睫。

> 我保证会改进。

说完这句无可奈何的话，我离开了房间。经理在背后感谢我。

# 结论是:

> 这种解脱比得到我的第一份工作机会还要大。

几个月后，大流行持续了下来。该公司亏损严重。

然而，即使对于一个对收入数字一无所知的低级开发人员来说，我也不难算出来。

他们解雇了大约 100 名开发人员，丝毫不在乎质量。我是其中之一。如果我在图表中的最低棒线起了作用，我无从得知。

在我的职业生涯中，我从未感到如此快乐。事实上，当我得到我的第一份软件工作时，我被解雇的消息让我松了一口气。

在失业期间，我重新参加了开发商会议。在讨论中，我提出了*更多的提交=更好的评审*公式*。*

令我惊讶的是，我得到了褒贬不一的评价。

一些开发人员认为，仅仅数数先生并不能很好地反映开发人员对公司的价值。

对其他一些开发商来说，伯爵先生仍然举足轻重。如果有人在团队平均得分 70+的基础上只犯了 10 个错误，这确实值得一看。

但是谁来评估这 10 个行为是否:

*   负责代码质量/应用程序性能的最大改进
*   负责大量用户涌入(一个独特的吸引用户的视觉糖果动画)
*   仅仅是团队工作流程受阻的结果(我所经历的磨难)

对我来说，这种不相关的数字与估算软件价值的 LOC 方法没有太大区别。然而，令我沮丧的是，如此多的公司使用批准的 MRs/年指标来评估他们的开发商。

难怪我的资历较浅的同行老是封杀我的 MRs，老是把预先存在的功能推给已经臃肿的代码库。学长没在意。钻研争论会减少他们在参加管理会议以维持职业生涯的同时，可用于进行更多提交(从而制作一个漂亮的代码评审仪表板图表)的时间。

归根结底，代码质量不是程序员吸收干净代码原则的程度的函数。

相反，这是胡萝卜加大棒的作用。

[**笔磁铁**](https://tipsnguts.medium.com/) 是广受欢迎的高级开发人员面试电子书的作者，该书解决了亚马逊明星面试格式的问题:

[**高级开发人员面试综合方法(40+例题)**](https://tipsnguts.gumroad.com/l/crrzat/zp1vks8) (对于第 **100 名中等读者，**折扣为 **50%** )