<html>
<head>
<title>Zip Based Exploits: Zip Slip and Zip Symlink Upload</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于Zip的漏洞:Zip滑和Zip符号链接上传</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/zip-based-exploits-zip-slip-and-zip-symlink-upload-21afd1da464f?source=collection_archive---------1-----------------------#2021-01-29">https://levelup.gitconnected.com/zip-based-exploits-zip-slip-and-zip-symlink-upload-21afd1da464f?source=collection_archive---------1-----------------------#2021-01-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="7ac7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我将带您了解两个涉及Zip文件的最常被利用的漏洞。我解释了这些漏洞的来源以及它们如何利用系统。之后，我们将讨论开发人员如何缓解这些攻击媒介，以保护他们的web应用程序以及敏感和隐私信息。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/fa970cb04d8ecd63ca9c5e86174a1f7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D2atysuG9lXQ2i8um5zEdg.jpeg"/></div></div></figure><p id="c7c2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">31年前的1989年，一家美国软件公司PKWARE Inc .使用了第一个Zip文件。在那之后，苹果和微软这两大巨头在各自的操作系统中很快支持了Zip格式。从那以后，这种文件格式在编程社区内外获得了极大的流行。直到今天，在官僚或家庭环境中，人们使用Zip文件通过电子邮件发送多个文件。</p><p id="d123" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是什么是真正的Zip文件呢？</p><p id="7040" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> Zip文件是归档文件</strong>。归档文件最初用于存储元数据和串联文件。因此，如果你以前有7本pdf格式的哈利波特，你想把它们存储在你的系统中，你可以把它们放在一个目录中，这样就没问题了。但是你们中的极客会压缩这个目录以占据更少的空间。后来实现了附加功能。如今，档案有5种类型:</p><ul class=""><li id="f605" class="lb lc it js b jt ju jx jy kb ld kf le kj lf kn lg lh li lj bi translated"><strong class="js iu">只归档</strong>格式的串连文件。</li><li id="7ac0" class="lb lc it js b jt lk jx ll kb lm kf ln kj lo kn lg lh li lj bi translated"><strong class="js iu">仅压缩</strong>格式仅压缩文件。</li><li id="3edf" class="lb lc it js b jt lk jx ll kb lm kf ln kj lo kn lg lh li lj bi translated"><strong class="js iu">多功能</strong>格式可以存储元数据，串接，压缩，加密，创建错误检测和恢复信息，将存档打包成自解压和自扩展的文件。</li><li id="9d56" class="lb lc it js b jt lk jx ll kb lm kf ln kj lo kn lg lh li lj bi translated"><strong class="js iu">软件包</strong>格式用于创建可能是自安装文件的软件包。</li><li id="7aed" class="lb lc it js b jt lk jx ll kb lm kf ln kj lo kn lg lh li lj bi translated"><strong class="js iu">磁盘映像</strong>格式用于创建海量存储卷的磁盘映像。</li></ul><p id="c6e5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最流行的存档扩展名是:zip、rar、7z和tar。</p><p id="569f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一些开发人员在他们的web应用程序中使用Zip文件格式，以允许用户在系统上上传他们的文件。让我们看看为什么这可能是一个非常糟糕的主意。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lp"><img src="../Images/b4d38aa7f6203b3b8d24c792b5ccafcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FRuLhLbQbhdrpl-ss4sQ3A.jpeg"/></div></div></figure><p id="e51d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">拉链滑动漏洞</strong></p><p id="a2b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们来看看这段服务器端代码:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lq lr l"/></div></figure><p id="8df3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这段代码提取归档文件中的所有文件，并将它们写入目标目录。我没看到任何危险信号，对吧？</p><p id="b074" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">再仔细看看上面的内容。在这个归档中压缩的文件可以有非常传统的名字，比如<code class="fe ls lt lu lv b">goodboy.sh</code>。但是，有时候它们会有很怪异的名字，想到<code class="fe ls lt lu lv b">../../../badboy.sh</code> <em class="ko">。</em>上面的代码获取文件名<code class="fe ls lt lu lv b">e.getName()</code>，并将其连接到目标目录或<code class="fe ls lt lu lv b">destinationDir</code>。假设目标目录是<code class="fe ls lt lu lv b">/var/www/vulnerable-website/userfiles/</code>。上面的代码将在<code class="fe ls lt lu lv b">/var</code>中写入<code class="fe ls lt lu lv b">badboy.sh</code>，从而导致目录遍历。如果该文件已经存在，它将覆盖它。想想如果恶意文件名是<code class="fe ls lt lu lv b">../../../../../../../bin/passwd</code>会怎么样。服务器将覆盖系统上的用户及其密码。<code class="fe ls lt lu lv b">badboy.sh</code>还可能包含产生反向外壳的代码，这将允许攻击者连接并危害整个系统。</p><p id="6eb3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">归档创建工具通常不允许用户添加具有这种名称的文件，尽管zip规范允许这样做。然而，使用正确的工具，很容易用这些路径创建文件。</p><p id="0344" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了保护服务器并避免这种任意文件上传的发生，开发人员必须在将zip内容写入系统之前验证它们的名称。下面是一个例子。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lq lr l"/></div></figure><p id="304a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">换句话说，我们告诉服务器将文件名和目录路径连接起来，结果存储在<code class="fe ls lt lu lv b">canonicalDestinationFile</code>变量中。如果这个变量不是以允许的目录<code class="fe ls lt lu lv b">canonicalDestinationDirPath</code>开始，用户试图绕过并在其他地方存储一些文件。用一个例外来阻止他。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lw"><img src="../Images/a66fc5a2a02ffaf06cd7f919f24e4296.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GKZ3xdMyBf3G0M63BTt61w.jpeg"/></div></div></figure><p id="bade" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">Zip符号链接漏洞利用</strong></p><p id="bd20" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们深入第二个漏洞之前，让我们先来谈谈符号链接。</p><p id="1398" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">简单地说，符号链接是其他文件的快捷方式。对于系统中的任何文件，您都可以轻松地创建一个链接。</p><pre class="kq kr ks kt gt lx lv ly lz aw ma bi"><span id="e7fb" class="mb mc it lv b gy md me l mf mg">ln -s /home/simon/bills.txt myfinances/bills-linked.txt</span></pre><p id="fb91" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的命令将把<code class="fe ls lt lu lv b">bills-linked.txt</code>链接到<code class="fe ls lt lu lv b">bills.txt</code>。该链接将是一个与其来源相似的文件，但存储在另一个目录中。在任一文件中发生的任何修改都将反映在另一个文件中。</p><p id="3be6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有两种类型符号链接:硬链接和软链接。软符号链接的工作方式类似于快捷方式。当您打开一个文件夹的软链接时，您将被重定向到存储文件的文件夹。然而，硬链接使文件或文件夹看起来好像实际存在于符号链接的位置，而您的应用程序不会知道得更好。这使得硬符号链接在大多数情况下更加有用。</p><p id="72c0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">符号链接可以用于各种事情，包括将任何文件夹与Dropbox、Google Drive和OneDrive等程序同步。它们还可用于利用易受攻击的系统。</p><p id="2cc4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以利用从符号链接创建的以下zip文件来攻击易受攻击的系统:</p><pre class="kq kr ks kt gt lx lv ly lz aw ma bi"><span id="1be5" class="mb mc it lv b gy md me l mf mg">ln -s /etc/passwd link<br/>zip --symlinks evil.zip link</span></pre><p id="b454" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将创建一个指向<code class="fe ls lt lu lv b">/etc/passwd</code>命名链接的链接，并将该链接压缩到一个档案中。当这个档案上传到服务器时，服务器将导出指向服务器中的<code class="fe ls lt lu lv b">/etc/passwd</code>的链接。如果我们能以任何方式显示这个解压缩文件的内容，我们就能看到<code class="fe ls lt lu lv b">/etc/passwd</code>的内容。</p><p id="294f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是为什么我们在上传之前要压缩链接呢？不能直接把链接上传到服务器吗？小心，你将上传你自己的<code class="fe ls lt lu lv b">/etc/passwd</code>到服务器。</p><p id="c076" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">针对此漏洞的基本对策是在创建文件之前检查该文件是否已经存在。一些linux系统也有针对这种攻击的内置计数器。一种是针对错误程序的“安全网”,这些程序会不安全地创建临时文件。当在目录上设置粘滞位时(如在/etc中)，如果进程拥有符号链接，或者符号链接和目录拥有相同的所有者(通常是/etc的根)，Linux将只允许进程跟随符号链接。这样，即使攻击者安装了符号链接，受害者进程也无法跟踪它，并且会收到一个错误。这将可能的特权提升攻击转变为对特定进程的更良性的拒绝服务。</p><p id="16db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">服务器上的大量漏洞都涉及某种恶意文件上传。Zip文件只是一长串文件的开始。<a class="ae mh" rel="noopener ugc nofollow" target="_blank" href="/using-word-documents-or-docx-files-to-gain-unauthorised-access-to-server-private-resources-2477b3eafb7b">在这篇文章</a>中，我向你解释如何’。docx文件也可用于权限提升和任意代码执行。对这些攻击最有效的对策是了解它们是如何发生的，并对用户的任何输入(尤其是文件)实施额外的验证步骤。</p></div></div>    
</body>
</html>