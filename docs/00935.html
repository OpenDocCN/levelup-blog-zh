<html>
<head>
<title>Switch to Go Modules from Go Dep</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Go Dep切换到Go模块</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/switch-to-go-modules-from-go-dep-fcdd4aa41bd5?source=collection_archive---------2-----------------------#2019-09-23">https://levelup.gitconnected.com/switch-to-go-modules-from-go-dep-fcdd4aa41bd5?source=collection_archive---------2-----------------------#2019-09-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/1896b168723fa9173ae1520e54dba940.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gv8j5ak9JYPW5FNGQT3wvQ.jpeg"/></div></div></figure><h2 id="a3cc" class="iz ja jb bd b dl jc jd je jf jg jh dk ji translated" aria-label="kicker paragraph"><a class="ae ep" rel="noopener ugc nofollow" target="_blank" href="/go-restful-series-a7addbfef5b1">安息吧</a> — #7</h2><div class=""/><p id="7bee" class="pw-post-body-paragraph kh ki jb kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">在我的<a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/manage-go-dependencies-with-dep-within-docker-and-vscode-remote-containers-cc0fedd627f2?source=friends_link&amp;sk=33fe8a746c1a413624f2b7c9a5cfd506">上一篇文章</a>中，我使用<code class="fe lg lh li lj b">go-dep</code>作为一个Go项目的依赖管理工具。然而，<a class="ae lf" href="https://github.com/golang/go/wiki/Modules" rel="noopener ugc nofollow" target="_blank"> Go模块</a>最近已经发布并宣布为官方的Go依赖管理工具。许多Go第三库正在被迁移以使用Go模块，并要求依赖项目也使用Go模块。因此，Go Dep很快就会被弃用。我们将在之前启动的项目中用Dep替换Go模块。</p><figure class="ll lm ln lo gt is gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/602e3e240e7500d5af09feaed01512ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*jGTqQo_dUA28d3GhuHYO8g.gif"/></div></figure></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="c48a" class="lw lx jb bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">Go模块简介</h1><p id="e6bf" class="pw-post-body-paragraph kh ki jb kj b kk mu km kn ko mv kq kr ks mw ku kv kw mx ky kz la my lc ld le ij bi translated">Go Modules是官方的Go依赖管理工具，它被直接实现到Go工具链中(通过<code class="fe lg lh li lj b">go</code> CLI使用)。</p><h2 id="6d5c" class="mz lx jb bd ly na nb dn mc nc nd dp mg ks ne nf mk kw ng nh mo la ni nj ms jh bi translated">特征</h2><ul class=""><li id="c89f" class="nk nl jb kj b kk mu ko mv ks nm kw nn la no le np nq nr ns bi translated">允许并推荐项目位于<code class="fe lg lh li lj b">$GOPATH</code>之外。</li><li id="ec5c" class="nk nl jb kj b kk nt ko nu ks nv kw nw la nx le np nq nr ns bi translated">依赖项被放在一个<code class="fe lg lh li lj b">vendor</code>目录中(与<code class="fe lg lh li lj b">go-dep</code>相同)，这样不同的项目可以依赖于相同包的不同版本。</li><li id="acd0" class="nk nl jb kj b kk nt ko nu ks nv kw nw la nx le np nq nr ns bi translated">自动检测导入语句，然后更新依赖关系图，锁定、下载和安装适当版本的软件包。</li><li id="3e3d" class="nk nl jb kj b kk nt ko nu ks nv kw nw la nx le np nq nr ns bi translated">当<code class="fe lg lh li lj b">build</code>、<code class="fe lg lh li lj b">run</code>或<code class="fe lg lh li lj b">test</code>时，自动检查依赖性。</li><li id="11a7" class="nk nl jb kj b kk nt ko nu ks nv kw nw la nx le np nq nr ns bi translated">允许指定、降级和升级包的版本。</li><li id="1c32" class="nk nl jb kj b kk nt ko nu ks nv kw nw la nx le np nq nr ns bi translated">自动生成依赖锁，以确保可重现的构建。</li><li id="227f" class="nk nl jb kj b kk nt ko nu ks nv kw nw la nx le np nq nr ns bi translated">语义版本化机制。</li><li id="4137" class="nk nl jb kj b kk nt ko nu ks nv kw nw la nx le np nq nr ns bi translated">官方推荐的依赖项，并应用于Go生态系统。</li></ul><h2 id="0bba" class="mz lx jb bd ly na nb dn mc nc nd dp mg ks ne nf mk kw ng nh mo la ni nj ms jh bi translated">使用</h2><p id="a529" class="pw-post-body-paragraph kh ki jb kj b kk mu km kn ko mv kq kr ks mw ku kv kw mx ky kz la my lc ld le ij bi translated">Go模块在Go项目中引入了两个新文件:</p><ul class=""><li id="6263" class="nk nl jb kj b kk kl ko kp ks ny kw nz la oa le np nq nr ns bi translated"><code class="fe lg lh li lj b">go.mod</code>指定模块名、依赖项及其最小版本。</li><li id="7c49" class="nk nl jb kj b kk nt ko nu ks nv kw nw la nx le np nq nr ns bi translated"><code class="fe lg lh li lj b">go.sum</code>是自动生成的依赖锁文件。</li><li id="1f0b" class="nk nl jb kj b kk nt ko nu ks nv kw nw la nx le np nq nr ns bi translated">这两个文件都位于项目的根级别。</li></ul><p id="90ca" class="pw-post-body-paragraph kh ki jb kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">像<code class="fe lg lh li lj b">go build</code>或<code class="fe lg lh li lj b">go test</code>这样的标准命令将根据需要自动添加新的依赖项以满足导入(更新<code class="fe lg lh li lj b">go.mod</code>并下载新的依赖项)。因此，我们完全不用担心更新依赖关系。只要执行我们的代码，依赖关系图就会自动更新。</p><p id="06fa" class="pw-post-body-paragraph kh ki jb kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">当需要时，可以使用命令选择更具体的依赖版本，例如<code class="fe lg lh li lj b">go get foo@v1.2.3</code>、<code class="fe lg lh li lj b">go get foo@master</code> ( <code class="fe lg lh li lj b">foo@tip</code>和mercurial)、<code class="fe lg lh li lj b">go get foo@e3702bed2</code>，或者直接编辑<code class="fe lg lh li lj b">go.mod</code>。</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="bed2" class="lw lx jb bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">从Go Dep切换到Go模块</h1><h2 id="0e0d" class="mz lx jb bd ly na nb dn mc nc nd dp mg ks ne nf mk kw ng nh mo la ni nj ms jh bi translated">将项目移到$GOPATH之外</h2><p id="643a" class="pw-post-body-paragraph kh ki jb kj b kk mu km kn ko mv kq kr ks mw ku kv kw mx ky kz la my lc ld le ij bi translated">尽管Go模块允许项目位于<code class="fe lg lh li lj b">$GOPATH</code>内，但这样做不再是一个好的做法。让我们将它移动到一个通用的工作区目录<code class="fe lg lh li lj b">root/project</code>。</p><p id="b3ee" class="pw-post-body-paragraph kh ki jb kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">有2个地方需要更新(基于我们之前创建的项目)。</p><ul class=""><li id="5d28" class="nk nl jb kj b kk kl ko kp ks ny kw nz la oa le np nq nr ns bi translated">首次更新<code class="fe lg lh li lj b">scripts/start-devcontainer.sh</code>。</li></ul><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="ob oc l"/></div></figure><ul class=""><li id="68b9" class="nk nl jb kj b kk kl ko kp ks ny kw nz la oa le np nq nr ns bi translated">然后更新<code class="fe lg lh li lj b">.devcontainer.json</code>。</li></ul><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="f5a5" class="mz lx jb bd ly na nb dn mc nc nd dp mg ks ne nf mk kw ng nh mo la ni nj ms jh bi translated">初始化go.mod和go.sum</h2><p id="442e" class="pw-post-body-paragraph kh ki jb kj b kk mu km kn ko mv kq kr ks mw ku kv kw mx ky kz la my lc ld le ij bi translated">Go模块执行一个命令来启动Go模块的使用。此外，该工具足够智能，可以自动读取<code class="fe lg lh li lj b">Gopkg.toml</code>和<code class="fe lg lh li lj b">Gopkg.lock</code>并将其转换为<code class="fe lg lh li lj b">go.mod</code>和<code class="fe lg lh li lj b">go.sum</code>。</p><p id="0495" class="pw-post-body-paragraph kh ki jb kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">在项目目录(根级别)，发出:</p><pre class="ll lm ln lo gt od lj oe of aw og bi"><span id="e910" class="mz lx jb lj b gy oh oi l oj ok">go mod init github.com/the-evengers/go-restful</span></pre><p id="04d9" class="pw-post-body-paragraph kh ki jb kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">然后，我用预定义的依赖项创建了一个<code class="fe lg lh li lj b">go.mod</code>。</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="0603" class="mz lx jb bd ly na nb dn mc nc nd dp mg ks ne nf mk kw ng nh mo la ni nj ms jh bi translated">删除go-dep的内容</h2><p id="d59c" class="pw-post-body-paragraph kh ki jb kj b kk mu km kn ko mv kq kr ks mw ku kv kw mx ky kz la my lc ld le ij bi translated">现在让我们去掉<code class="fe lg lh li lj b">go-dep</code>多余的东西。</p><ul class=""><li id="c7d3" class="nk nl jb kj b kk kl ko kp ks ny kw nz la oa le np nq nr ns bi translated">首先删除<code class="fe lg lh li lj b">Gopkg.toml</code>和<code class="fe lg lh li lj b">Gopkg.lock</code>。</li><li id="b659" class="nk nl jb kj b kk nt ko nu ks nv kw nw la nx le np nq nr ns bi translated">然后更新<code class="fe lg lh li lj b">Dockerfile</code>，从预装Go工具列表中删除<code class="fe lg lh li lj b">go-dep</code>。</li></ul><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="710c" class="pw-post-body-paragraph kh ki jb kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">此外，我设置了环境变量<code class="fe lg lh li lj b">GO111MODULE=on</code>，这样我就可以在全局范围内使用Go模块的特性，例如安装VS代码推荐的最新版本的<code class="fe lg lh li lj b">gopls</code> (Go语言服务器)。</p><p id="0932" class="pw-post-body-paragraph kh ki jb kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">注意，因为我们去掉了<code class="fe lg lh li lj b">go-dep</code>，所以<code class="fe lg lh li lj b">.devcontainer.json</code>中的<code class="fe lg lh li lj b">postCreateCommand: "dep ensure"</code>已经过时，也应该去掉。</p><h2 id="ff72" class="mz lx jb bd ly na nb dn mc nc nd dp mg ks ne nf mk kw ng nh mo la ni nj ms jh bi translated">重建开发容器</h2><p id="1186" class="pw-post-body-paragraph kh ki jb kj b kk mu km kn ko mv kq kr ks mw ku kv kw mx ky kz la my lc ld le ij bi translated">最后一步是重新构建开发容器。</p><ul class=""><li id="34c1" class="nk nl jb kj b kk kl ko kp ks ny kw nz la oa le np nq nr ns bi translated">打开VS代码，执行Command(<em class="ol">F1</em>或<em class="ol">Command/Ctrl</em>+<em class="ol">Shift</em>+<em class="ol">P</em>)<em class="ol">Remote-Containers:Rebuild Container</em>)。</li><li id="ba0f" class="nk nl jb kj b kk nt ko nu ks nv kw nw la nx le np nq nr ns bi translated">或者使用Docker命令直接删除以前的容器和图像，然后在VS代码容器模式下重新打开项目。</li></ul><h1 id="6301" class="lw lx jb bd ly lz om mb mc md on mf mg mh oo mj mk ml op mn mo mp oq mr ms mt bi translated">我们更新了！</h1><figure class="ll lm ln lo gt is gh gi paragraph-image"><div class="gh gi or"><img src="../Images/ce635a8ad8f4d2bb8bce4abe68ec59f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*WKeT3rk_MeeaQT25PGVVQg.png"/></div></figure><p id="d0e7" class="pw-post-body-paragraph kh ki jb kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">耶！现在我升级了这个项目，以应用新的官方Go依赖管理工具。</p><p id="6b62" class="pw-post-body-paragraph kh ki jb kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">通过简单地运行<code class="fe lg lh li lj b">go build</code>或<code class="fe lg lh li lj b">go run main.go</code>或者使用VS代码的<em class="ol">启动</em>特性，所有项目的依赖项将被自动下载和安装。</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><p id="4109" class="pw-post-body-paragraph kh ki jb kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">这篇文章的全部源代码发表在<a class="ae lf" href="https://github.com/the-evengers/go-restful/tree/1d3590c6a2c9de694be24702b51fd46e81aab086" rel="noopener ugc nofollow" target="_blank">这里</a>。下一篇文章再见！</p></div></div>    
</body>
</html>