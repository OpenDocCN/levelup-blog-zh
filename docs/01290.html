<html>
<head>
<title>How does foreach keep track of changes?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">foreach如何跟踪更改？</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-does-foreach-keep-track-of-changes-fe64f97058fe?source=collection_archive---------9-----------------------#2019-12-11">https://levelup.gitconnected.com/how-does-foreach-keep-track-of-changes-fe64f97058fe?source=collection_archive---------9-----------------------#2019-12-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="cc23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们都知道,<code class="fe kl km kn ko b">foreach</code>循环被设计成读取集合，而不是写入集合。</p><p id="7a48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是为什么下面的结果是一个<code class="fe kl km kn ko b">InvalidOperationException</code>:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi kp"><img src="../Images/66186d1076c2553eda791766077320f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/0*igfpK4-uozOCXWAm.JPG"/></div></figure><h1 id="5ada" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">它如何跟踪集合中的变化？</h1><p id="057c" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">这是通过<code class="fe kl km kn ko b">List&lt;T&gt;</code>类中一个名为<code class="fe kl km kn ko b">_<a class="ae ma" href="https://referencesource.microsoft.com/#mscorlib/system/collections/generic/list.cs,43" rel="noopener ugc nofollow" target="_blank">version</a></code>的int完成的。</p><p id="8a88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每当集合被更新时，<code class="fe kl km kn ko b">_version</code>就会增加，方法如下:</p><ul class=""><li id="36c8" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">索引器设置器方法</li><li id="b656" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><code class="fe kl km kn ko b">Add()</code></li><li id="e624" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><code class="fe kl km kn ko b">Clear()</code></li><li id="8b3c" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><code class="fe kl km kn ko b">Insert()</code></li><li id="6b89" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><code class="fe kl km kn ko b">InsertRange()</code></li><li id="fb5f" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><code class="fe kl km kn ko b">RemoveAll()</code></li><li id="f0d6" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><code class="fe kl km kn ko b">RemoveAt()</code></li><li id="3987" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><code class="fe kl km kn ko b">RemoveRange()</code></li><li id="5db0" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><code class="fe kl km kn ko b">Reverse()</code></li><li id="68e8" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><code class="fe kl km kn ko b">Sort()</code></li></ul><p id="cb1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当在<code class="fe kl km kn ko b">foreach</code>中枚举<code class="fe kl km kn ko b">List&lt;T&gt;</code>时，调用<code class="fe kl km kn ko b">GetEnumerator()</code>方法，该方法返回名为<code class="fe kl km kn ko b"><a class="ae ma" href="https://referencesource.microsoft.com/#mscorlib/system/collections/generic/list.cs,1140" rel="noopener ugc nofollow" target="_blank">Enumerator</a></code>的结构的实例。</p><p id="f844" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kl km kn ko b">Enumerator</code>有自己的<code class="fe kl km kn ko b">version</code>变量，该变量只初始化一次，使用来自<code class="fe kl km kn ko b">List&lt;T&gt;._version</code>的值，并且永不改变。</p><p id="c4f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe kl km kn ko b">foreach</code>的每次迭代中，都会调用<code class="fe kl km kn ko b">MoveNext()</code>方法来检查<code class="fe kl km kn ko b">List&lt;T&gt;._version</code>是否与<code class="fe kl km kn ko b">version</code>相同。</p><p id="5028" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果它们不是相同的值，则会引发异常:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/e8fd7b3a50fe6153bf7e2928e1567f48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3A-iq9qkqE9CdiNL.JPG"/></div></div></figure><p id="cab3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">阅读这篇文章来学习一个绕过这个异常的有趣技巧。</p></div></div>    
</body>
</html>