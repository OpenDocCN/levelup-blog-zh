<html>
<head>
<title>A Simple KeyVal Store Implemented in Motoko</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Motoko中实现的一个简单的KeyVal存储</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-simple-keyval-store-implemented-in-motoko-f8ba5af43618?source=collection_archive---------17-----------------------#2021-11-30">https://levelup.gitconnected.com/a-simple-keyval-store-implemented-in-motoko-f8ba5af43618?source=collection_archive---------17-----------------------#2021-11-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7de0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在互联网计算机上为罐式智能合同构建一个通用的keyval存储。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6e3e83f01d72f0634247cbfcd4fd113f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TtIqarWb4Sbvh2lntKUlHg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@peterlaster?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">佩德罗·拉斯特拉</a>在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="230a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我喜欢离线web应用程序，我的大多数个人开源项目，如<a class="ae ky" href="http://deckdeckgo.com/" rel="noopener ugc nofollow" target="_blank"> DeckDeckGo </a>或<a class="ae ky" href="https://tietracker.app.link/" rel="noopener ugc nofollow" target="_blank"> Tie Tracker </a>，都遵循这种方法。</p><p id="f7ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这两个特定的应用程序中，我使用<a class="ae ky" href="https://github.com/jakearchibald/idb-keyval" rel="noopener ugc nofollow" target="_blank"> idb-keyval </a>通过类似keyval的API来简化与IndexedDB的交互。</p><p id="097e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是为什么，在我们迁移到<a class="ae ky" href="https://dfinity.org/" rel="noopener ugc nofollow" target="_blank"> DFINITY </a>的互联网计算机的最后一次迭代中，我在<a class="ae ky" href="https://smartcontracts.org/docs/language-guide/motoko.html" rel="noopener ugc nofollow" target="_blank"> Motoko </a>中为罐智能契约开发了一个通用存储，它也维护带有键和值的数据。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="94eb" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">商店</h1><p id="3c1c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我的目标是能够跨罐和项目多次重用同一个存储。如果我的一个角色包含不同类型的数据，例如汽车和蔬菜，我想重用封装数据并公开函数的同一个助手，例如:<code class="fe mz na nb nc b">put</code>、<code class="fe mz na nb nc b">get</code>、<code class="fe mz na nb nc b">delete</code>和<code class="fe mz na nb nc b">list</code>。</p><p id="8b16" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我开发的store不亚于一个通用类，它使用一个<a class="ae ky" href="https://sdk.dfinity.org/docs/base-libraries/hashmap" rel="noopener ugc nofollow" target="_blank">散列表</a>来持久化文本键(类型<a class="ae ky" href="https://smartcontracts.org/docs/base-libraries/Text.html" rel="noopener ugc nofollow" target="_blank">文本</a>)。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="a477" class="nh md it nc b gy ni nj l nk nl">import Text "mo:base/Text";<br/>import HashMap "mo:base/HashMap";<br/>import Iter "mo:base/Iter";<br/>import Array "mo:base/Array";<br/><br/>module {<br/>    public class DataStore&lt;T&gt;() {<br/>        private var data: HashMap.HashMap&lt;Text, T&gt; = <br/>                HashMap.HashMap&lt;Text, T&gt;(10, Text.equal, Text.hash);<br/>    }<br/>}</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7504" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">上传、获取和删除</h1><p id="7a24" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">修改状态的函数基本上是直接对<code class="fe mz na nb nc b">HashMap</code>应用修改，除了删除操作，我用<code class="fe mz na nb nc b">getter</code>扩展了删除操作，即使如果键不存在的话<code class="fe mz na nb nc b">delete</code>什么也不做。我认为偶尔找回被删除的键的值会很有趣。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="3e7f" class="nh md it nc b gy ni nj l nk nl">public func put(key: Text, value: T) {<br/>    data.put(key, value);<br/>};<br/><br/>public func get(key: Text): ?T {<br/>    return data.get(key);<br/>};<br/><br/>public func del(key: Text): ?T {<br/>    let entry: ?T = get(key);<br/><br/>    switch (entry) {<br/>        case (?entry) {<br/>            data.delete(key);<br/>        };<br/>        case (null) {};<br/>    };<br/><br/>    return entry;<br/>};</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="eefa" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">目录</h1><p id="54d1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果没有过滤数据的可能性，获得商店所有条目的列表也不会比直接查询<code class="fe mz na nb nc b">HashMap</code>多多少。事实上，只搜索以特定前缀开头或包含特定前缀的键可能会很有趣。</p><p id="865e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我首先为过滤器定义了一个新的类型<code class="fe mz na nb nc b">DataFilter</code>,并实现了有效的过滤功能，这些功能承认这些选项的可选性。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="dc65" class="nh md it nc b gy ni nj l nk nl">public type DataFilter = {<br/>    startsWith: ?Text;<br/>    contains: ?Text;<br/>};<br/><br/>private func keyStartsWith(key: Text, startsWith: ?Text): Bool {<br/>    switch (startsWith) {<br/>        case null {<br/>            return true;<br/>        };<br/>        case (?startsWith) {<br/>            return Text.startsWith(key, #text startsWith);<br/>        };<br/>    };<br/>};<br/><br/>private func keyContains(key: Text, contains: ?Text): Bool {<br/>    switch (contains) {<br/>        case null {<br/>            return true;<br/>        };<br/>        case (?contains) {<br/>            return Text.contains(key, #text contains);<br/>        };<br/>    };<br/>};</span></pre><p id="77c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果没有定义过滤器，上述函数将返回<code class="fe mz na nb nc b">true</code>，假设<code class="fe mz na nb nc b">undefined</code>表示“忽略选项”。在Motoko中可能有一种更好的方法来实现这样的条件，但是，我在这方面还不像在其他语言(如TypeScript)中那样流畅。如果你想改进解决方案，就去做吧，给我发一个<a class="ae ky" href="https://github.com/deckgo/deckdeckgo/blob/main/canisters/src/data/data.filter.mo" rel="noopener ugc nofollow" target="_blank">拉动请求</a>！</p><p id="12d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我实现了<code class="fe mz na nb nc b">list</code>函数本身，它要么返回所有条目，要么按照<code class="fe mz na nb nc b">and</code>逻辑应用过滤器。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="676a" class="nh md it nc b gy ni nj l nk nl">public func list(filter: ?DataFilter): [(Text, T)] {<br/>    let entries: Iter.Iter&lt;(Text, T)&gt; = data.entries();<br/><br/>    switch (filter) {<br/>        case null {<br/>            return Iter.toArray(entries);<br/>        };<br/>        case (?filter) {<br/>            let keyValues: [(Text, T)] = Iter.toArray(entries);<br/><br/>            let {startsWith; contains} = filter;<br/><br/>            let values: [(Text, T)] = <br/>                        Array.mapFilter&lt;(Text, T), (Text, T)&gt;<br/>            (keyValues, func ((key: Text, value: T)) : ?(Text, T) {<br/>                if (keyStartsWith(key, startsWith) and <br/>                    keyContains(key, contains)) {<br/>                    return ?(key, value);<br/>                };<br/><br/>                return null;<br/>            });<br/><br/><br/>            return values;<br/>        };<br/>    };<br/>};</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e6b3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">升级</h1><p id="056b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了在升级时保持罐的状态，可以为默认情况下不稳定的变量实现<a class="ae ky" href="https://smartcontracts.org/docs/language-guide/upgrades.html#_preupgrade_and_postupgrade_system_methods" rel="noopener ugc nofollow" target="_blank">升级前和升级后</a>系统挂钩。为了预见这样的过程，我还为存储添加了两个最终函数。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="c60a" class="nh md it nc b gy ni nj l nk nl">public func preupgrade(): HashMap.HashMap&lt;Text, T&gt; {<br/>    return data;<br/>};<br/><br/>public func postupgrade(stableData: [(Text, T)]) {<br/>    data := HashMap.fromIter&lt;Text, T&gt;(stableData.vals(), 10, Text.equal, Text.hash);<br/>};</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6b10" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用</h1><p id="3a6e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了展示这种通用存储在actor中的用法，我们创建了一个空容器，它定义了要存储的对象类型，比如一个<code class="fe mz na nb nc b">Car</code>。</p><p id="62aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们<code class="fe mz na nb nc b">import</code>助手并声明我们将要使用的两个对象。<code class="fe mz na nb nc b">store</code>本身和一个稳定的<code class="fe mz na nb nc b">entries</code>在升级时保持状态。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="d7b6" class="nh md it nc b gy ni nj l nk nl">import Iter "mo:base/Iter";<br/><br/>import DataStore "./store";<br/><br/>actor Test {<br/><br/>    type Car = {<br/>        name: Text;<br/>        manufacturer: Text;<br/>    };<br/><br/>    private let store: DataStore.DataStore&lt;Car&gt; = <br/>                       DataStore.DataStore&lt;Car&gt;();<br/><br/>    private stable var entries : [(Text, Car)] = [];<br/><br/>    system func preupgrade() {<br/>        entries := Iter.toArray(store.preupgrade().entries());<br/>    };<br/><br/>    system func postupgrade() {<br/>        store.postupgrade(entries);<br/>        entries := [];<br/>    };<br/>};</span></pre><p id="8273" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦定义了这些，我们就公开修改状态的函数，并将它们与存储链接起来。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="1591" class="nh md it nc b gy ni nj l nk nl">public query func get(key: Text) : async (?Car) {<br/>    let entry: ?Car = store.get(key);<br/>    return entry;<br/>};<br/><br/>public func set(key: Text, data: Car) : async () {<br/>    store.put(key, data);<br/>};<br/><br/>public func del(key: Text) : async () {<br/>    let entry: ?Car = store.del(key);<br/>};</span></pre><p id="f634" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们插入最后一点代码，即列出和过滤条目的函数。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="eb2f" class="nh md it nc b gy ni nj l nk nl">public query func get(key: Text) : async (?Car) {<br/>    let entry: ?Car = store.get(key);<br/>    return entry;<br/>};</span></pre><p id="683b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">瞧，用几行代码，我们实现了一个简单的keyval罐智能合同，存储我们的数据🥳.</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d27c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">操场</h1><p id="2a63" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">想玩前一个例子并存储吗？检查这个<a class="ae ky" href="https://m7sm4-2iaaa-aaaab-qabra-cai.raw.ic0.app/?tag=1517752901" rel="noopener ugc nofollow" target="_blank"> Motoko游乐场</a>并玩得开心🤙。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/a1d777f19663421fe66797c6dc58e2ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CgTzjuNqFv3mr1IpCZsPgw.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="25ce" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">进一步阅读</h1><p id="1962" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">想了解更多我们的项目吗？以下是自从我们用互联网计算机开始这个项目以来，我发表的博文列表:</p><ul class=""><li id="8e64" class="nn no it lb b lc ld lf lg li np lm nq lq nr lu ns nt nu nv bi translated"><a class="ae ky" href="https://itnext.io/typescript-utilities-for-candid-bf5bdd92a9a3" rel="noopener ugc nofollow" target="_blank">偷拍的打字实用程序</a></li><li id="d351" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><a class="ae ky" href="https://medium.com/geekculture/bye-bye-amazon-google-hello-web-3-0-b01bfe8f8783" rel="noopener">再见亚马逊&amp;谷歌，你好Web 3.0 </a></li><li id="97cb" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><a class="ae ky" href="https://itnext.io/dynamically-import-esm-modules-from-a-cdn-5a6f741e2a1c" rel="noopener ugc nofollow" target="_blank">从CDN动态导入ESM模块</a></li><li id="d8da" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><a class="ae ky" href="https://medium.com/geekculture/internet-computer-web-app-decentralized-database-architecture-8647d1a437b8" rel="noopener">互联网计算机:Web App分散数据库架构</a></li><li id="9696" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><a class="ae ky" href="https://javascript.plainenglish.io/singleton-factory-patterns-with-typescript-59e5a405531e" rel="noopener ugc nofollow" target="_blank">单例&amp;工厂模式带打字稿</a></li><li id="ed34" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><a class="ae ky" href="https://javascript.plainenglish.io/getting-started-with-the-internet-computer-web-hosting-b9b748350fc2" rel="noopener ugc nofollow" target="_blank">在互联网上托管电脑</a></li><li id="8d7e" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><a class="ae ky" href="https://medium.com/geekculture/we-received-a-grant-to-port-our-web-app-to-the-internet-computer-7be64806565a" rel="noopener">我们收到了一笔赠款，用于将我们的网络应用移植到互联网计算机上</a></li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0ab2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">保持联络</h1><p id="01fa" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了跟随我们的冒险，你可以开始观看我们的<a class="ae ky" href="https://github.com/deckgo/deckdeckgo" rel="noopener ugc nofollow" target="_blank"> GitHub回购</a> ⭐️和<a class="ae ky" href="http://eepurl.com/hKeMLD" rel="noopener ugc nofollow" target="_blank">注册</a>加入测试者名单。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6d42" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="8ba4" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">可能有更好的方法来实现过滤选项，并且不确定这样的架构是否是最先进的(其他Motoko开发人员会在他们的罐子旁边创建商店吗？).</p><p id="f2bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，它非常适合我的项目，正如我仍在学习的那样，它只能在时间内得到改进，因为我正在将我们的web编辑器移植到<a class="ae ky" href="https://dfinity.org/" rel="noopener ugc nofollow" target="_blank"> DFINITY </a>的互联网计算机上，并且不打算很快停止。</p><p id="2d67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到无限和更远的地方！</p><p id="098f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大卫</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="b1ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在推特上或者我的网站上联系到我。</p><p id="1029" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为您的下一张幻灯片尝试一下<a class="ae ky" href="https://deckdeckgo.com/" rel="noopener ugc nofollow" target="_blank"> DeckDeckGo </a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://deckdeckgo.com"><div class="gh gi ob"><img src="../Images/4e1da5c1004252f30044c0ee000da144.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YZ_9B6eA9L3YaocI.png"/></div></a></figure></div></div>    
</body>
</html>