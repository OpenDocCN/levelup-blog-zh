<html>
<head>
<title>Does Your Database/ORM Make You Do Stupid Things Too?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你的数据库/ORM也让你做傻事吗？</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/is-your-database-bullying-you-bc0b2d587be6?source=collection_archive---------2-----------------------#2021-09-23">https://levelup.gitconnected.com/is-your-database-bullying-you-bc0b2d587be6?source=collection_archive---------2-----------------------#2021-09-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="5e36" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">固执己见的观点</h2><div class=""/><div class=""><h2 id="c38b" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">不要仅仅为了让你的ORM开心而写代码。</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/044580f7e60ba8ba78b472e62a7e05c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8P9Bds6b_W5gnOctGI8S-w.jpeg"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">图片由@nmillard提供</figcaption></figure><p id="a2f4" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">不要让你的数据库控制你的应用程序。</p><p id="6a34" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">您可能会让数据库生成您的id。不是吗？也许是因为它的便利性——尽管它真的一点也不方便。</p><p id="121b" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">你多久对你的模型做一次“务实”的决定？或者在某些领域不变量上有所松懈，因为这样可以更容易地使用您的对象关系映射(ORM)框架？</p><blockquote class="md"><p id="f021" class="me mf it bd mg mh mi mj mk ml mm mc dk translated">在设计领域模型时，只要您关心基础设施，就会让数据库或ORM欺负您。</p></blockquote><p id="83ac" class="pw-post-body-paragraph lh li it lj b lk mn kd lm ln mo kg lp lq mp ls lt lu mq lw lx ly mr ma mb mc im bi translated">你有没有为了讨好ORM大神而添加属性，或者让属性有公共setters？添加无用的私有默认构造函数怎么样？这些构造函数从来没有被你自己的代码使用过，只有ORM才需要。</p><p id="df44" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">你是否故意实施了一些不好的实践，因为你的ORM使得做正确的事情太麻烦了？比如，让持久性问题渗入您的领域模型。</p><p id="3306" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">🔔<a class="ae ms" href="https://nmillard.medium.com/subscribe" rel="noopener">想要更多这样的文章？在这里签名。</a></p><h1 id="27a4" class="mt mu it bd mv mw mx my mz na nb nc nd ki ne kj nf kl ng km nh ko ni kp nj nk bi translated">查看取悦数据库的(真正的)糟糕代码的示例。</h1><p id="6ea3" class="pw-post-body-paragraph lh li it lj b lk nl kd lm ln nm kg lp lq nn ls lt lu no lw lx ly np ma mb mc im bi translated">在设计领域时考虑到持久性会导致糟糕的设计。</p><p id="eee8" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">作为一个初级开发人员，这种废话我都记不清写了多少遍了。更令人担忧的是，即使有经验的开发人员也会这样做。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nq"><img src="../Images/037ce83016e922f4af71136c38c4a6b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IRSVU5Dsx1hRiHtJykYjnw.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">可怕的领域模型。</figcaption></figure><p id="f72c" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这段代码来自一个实际的、有效的应用程序——为了简洁起见，我更改了类名并删除了大量属性。</p><p id="125d" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">代码片段完美地展示了您可以对域模型做的所有坏事。</p><p id="01d6" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这个模型绝不是持久性不可知的。一旦保存到数据库中，就会生成作者id(这是我的主要烦恼之一)。另一方面，理想情况下，域实体甚至不需要公共id属性。</p><blockquote class="md"><p id="9167" class="me mf it bd mg mh mi mj mk ml mm mc dk translated">身份应该是不可变的和全局唯一的。数据库提交应该会突然改变实体的身份。那只是糟糕的做法。</p></blockquote><p id="8a2e" class="pw-post-body-paragraph lh li it lj b lk mn kd lm ln mo kg lp lq mp ls lt lu mq lw lx ly mr ma mb mc im bi translated">在为其属性赋值方面没有安全措施。模特尖叫着“没有规则管我！”。<code class="fe nr ns nt nu b">Books</code>集合是可变的，这显然是一个非常糟糕的主意。所有的财产都有公共设置者——我们都知道有公共设置者是通往灾难之城的高速公路。</p><p id="3b5c" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">让我们看看同样设计糟糕的<code class="fe nr ns nt nu b">Book</code>车型。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nq"><img src="../Images/eecd588db8554fff09bbdfd20cfc164e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*06E095j730_f1ALGmQe86A.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">又一个可怕的域类。</figcaption></figure><p id="81c3" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">没有什么比默认构造函数、导航属性和领域模型中的持久性问题更让我头疼的了。绝对没有理由拥有<code class="fe nr ns nt nu b">Author</code>房产，更不用说<code class="fe nr ns nt nu b">AuthorId</code>房产了。默认构造函数允许您实例化不完整状态的对象，这违反了业务规则。</p><p id="4e61" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">当您想要比较对象时，这些实践也使单元测试变得很痛苦。通常，您使用id属性来比较域对象，但这是不可能的，因为在第三方系统(数据库)分配它们的id之前，对象没有id。</p><h1 id="693a" class="mt mu it bd mv mw mx my mz na nb nc nd ki ne kj nf kl ng km nh ko ni kp nj nk bi translated">为什么你让数据库欺负你，让它创建你的域名id？</h1><p id="37ed" class="pw-post-body-paragraph lh li it lj b lk nl kd lm ln nm kg lp lq nn ls lt lu no lw lx ly np ma mb mc im bi translated">有时候这是很容易做到的事。我明白了。但是很有可能以后你会为这种假定的便利付出代价。</p><p id="8b32" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我知道您可能对让您自己的应用程序生成域id持保留意见，这些域id随后会存储在数据库中。但是试着把逻辑翻转180度。为什么您愿意让第三方应用程序派生您特定于业务的身份值？</p><p id="7671" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">知道当对象被传递给这个方法时,<code class="fe nr ns nt nu b">author</code> id为空，您觉得下面的代码看起来不错吗？</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nq"><img src="../Images/86050fdb87b3a4c06e7d94458c39d3dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7TNFtBZfzF6s_C-WzgKXMQ.png"/></div></div></figure><p id="232a" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在上面的代码片段中，您在自己的应用程序中实例化了一个域对象，只是让第三方指定其身份。它的身份在创建时就应该是已知的。</p><p id="f50b" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">为了便于讨论，我们假设操作失败了。调用代码仍然会有一个实际的、无效的<code class="fe nr ns nt nu b">Author</code>对象，但是没有id它就没有用了——使用无效对象进行后续的比较或相等检查会导致不好的事情(但是，老实说，不管id是在哪里生成的，忘记检查<code class="fe nr ns nt nu b">CreateAsync()</code>的返回值都是不好的)</p><h1 id="4dd7" class="mt mu it bd mv mw mx my mz na nb nc nd ki ne kj nf kl ng km nh ko ni kp nj nk bi translated">“IDs只是基础设施方面的问题！”</h1><p id="efa3" class="pw-post-body-paragraph lh li it lj b lk nl kd lm ln nm kg lp lq nn ls lt lu no lw lx ly np ma mb mc im bi translated">你看，域(或实体)标识和数据库主键是两个不同的东西，经常互换使用。</p><p id="9464" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">当然，主键肯定只是一个基础设施问题，并且显式地向您的域实体添加一个public <code class="fe nr ns nt nu b">Id</code>属性很可能是泄漏到您的模型中的一个基础设施问题。当在域边界内时，您将希望避免使用ids。</p><p id="0ba5" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">确定等式的更好方法是例如覆盖等式运算符。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nq"><img src="../Images/e085659673404549021abdcb176a57ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h78Cz67OdJWcn-1_WdW-eA.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">平等比较。</figcaption></figure><p id="f443" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">然而，在您的数据库中，您肯定需要一个用于域实体的主键。但是您可以在单独的基础架构或数据层中处理这个问题。</p><h1 id="453f" class="mt mu it bd mv mw mx my mz na nb nc nd ki ne kj nf kl ng km nh ko ni kp nj nk bi translated">你最好的防御数据库或ORM的方法是了解你的工具。</h1><p id="f980" class="pw-post-body-paragraph lh li it lj b lk nl kd lm ln nm kg lp lq nn ls lt lu no lw lx ly np ma mb mc im bi translated">现在，我知道您可能认为使用ORM进行数据库操作需要牺牲模型的有效性和领域规则的宽松性。</p><p id="37e7" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">没必要这样。</p><p id="9451" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">您只需要更好地理解您选择的ORM，或者使用只能在您的基础设施层中访问的持久性对象，这些对象按照ORM的规则和模型，根据您的实体在性能方面的最佳存储方式来运行。</p><p id="dba3" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">如今任何体面的ORM都提供流畅的配置。流畅的配置基本上消除了对专门的持久模型的需求，因为您可以配置ORM如何持久化您的领域模型。</p><p id="0dfd" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">因此，让我们来看看如何在您的领域模型中完全忽略持久性问题。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nv"><img src="../Images/b872db6df5747d19180565144f06591c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JznQ8rptTI3bH3ILG-6iXQ.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">ORM和域封装的正确使用。</figcaption></figure><p id="4682" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">现在真的很难把事情搞砸。您的域是安全的，您的数据库和ORM是愉快的。</p><p id="5c76" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">您甚至可以更进一步，将<a class="ae ms" href="https://docs.microsoft.com/en-us/ef/core/modeling/shadow-properties" rel="noopener ugc nofollow" target="_blank">影子属性</a>添加到您的持久性逻辑中，这可以进一步提高性能、安全性、可审计性、监控等。</p><h1 id="da6b" class="mt mu it bd mv mw mx my mz na nb nc nd ki ne kj nf kl ng km nh ko ni kp nj nk bi translated">让我们保持联系！</h1><p id="19f0" class="pw-post-body-paragraph lh li it lj b lk nl kd lm ln nm kg lp lq nn ls lt lu no lw lx ly np ma mb mc im bi translated"><a class="ae ms" href="https://nmillard.medium.com/subscribe" rel="noopener">在这里注册我的简讯</a>并查看新的YouTube频道<a class="ae ms" href="https://www.youtube.com/channel/UCaUy83EAkVdXsZjF3xGSvMw" rel="noopener ugc nofollow" target="_blank"><em class="nw">(@ Nicklas Millard)</em></a></p><p id="1a4d" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><em class="nw">连接上</em> <a class="ae ms" href="https://www.linkedin.com/in/nicklasmillard/" rel="noopener ugc nofollow" target="_blank"> <em class="nw"> LinkedIn </em> </a></p><h1 id="2987" class="mt mu it bd mv mw mx my mz na nb nc nd ki ne kj nf kl ng km nh ko ni kp nj nk bi translated">好奇者的资源</h1><ul class=""><li id="8400" class="nx ny it lj b lk nl ln nm lq nz lu oa ly ob mc oc od oe of bi translated"><a class="ae ms" href="https://enterprisecraftsmanship.com/posts/entity-identity-vs-database-primary-key/" rel="noopener ugc nofollow" target="_blank">实体身份与数据库主键</a>作者Vladimir Khorikov</li><li id="7001" class="nx ny it lj b lk og ln oh lq oi lu oj ly ok mc oc od oe of bi translated"><a class="ae ms" href="http://by Vladimir Khorikov" rel="noopener ugc nofollow" target="_blank">不要在你的域实体中使用id！弗拉基米尔·霍里科夫</a></li><li id="a235" class="nx ny it lj b lk og ln oh lq oi lu oj ly ok mc oc od oe of bi translated"><a class="ae ms" href="https://enterprisecraftsmanship.com/posts/separation-of-concerns-in-orm/" rel="noopener ugc nofollow" target="_blank">由Vladimir Khorikov提出的ORM </a>中的关注点分离</li><li id="151f" class="nx ny it lj b lk og ln oh lq oi lu oj ly ok mc oc od oe of bi translated"><a class="ae ms" href="https://www.sqlskills.com/blogs/kimberly/the-clustered-index-debate-continues/" rel="noopener ugc nofollow" target="_blank">聚集索引的争论还在继续……</a>金伯利·特里普</li><li id="7b6a" class="nx ny it lj b lk og ln oh lq oi lu oj ly ok mc oc od oe of bi translated"><a class="ae ms" href="https://www.sqlskills.com/blogs/kimberly/guids-as-primary-keys-andor-the-clustering-key/" rel="noopener ugc nofollow" target="_blank">Kimberly Tripp将GUIDs作为主键和/或聚类键</a></li><li id="7161" class="nx ny it lj b lk og ln oh lq oi lu oj ly ok mc oc od oe of bi translated"><a class="ae ms" href="https://softwareengineering.stackexchange.com/questions/365524/is-it-normal-for-a-domain-model-not-to-have-an-id" rel="noopener ugc nofollow" target="_blank">领域模型没有ID正常吗？</a>关于堆叠交换的问题</li></ul></div></div>    
</body>
</html>