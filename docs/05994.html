<html>
<head>
<title>The power of Swift + Web Assembly (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Swift + Web Assembly的力量(第1部分)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/the-power-of-swift-web-assembly-part-1-fdfa4e9134ee?source=collection_archive---------0-----------------------#2020-10-17">https://levelup.gitconnected.com/the-power-of-swift-web-assembly-part-1-fdfa4e9134ee?source=collection_archive---------0-----------------------#2020-10-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d818" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">想知道如何在Go或Rust项目中利用Swift吗？如何无痛地将Swift融入不同的语言？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a5e1806554ea15b474e30c3a137a30ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*duPJW32aIIQ16riCr3eNnQ.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自<a class="ae kv" href="https://prog.hu/welcome/" rel="noopener ugc nofollow" target="_blank">https://prog.hu/welcome/</a></figcaption></figure><p id="bc2a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">编写一次，随处运行</em>几十年来一直是软件公司和开发者的梦想。删除重复代码的想法不仅仅是用最少的成本做最多的事情，也是为了避免忘记更新所有副本的灾难。如果你曾经参与过一个大规模的软件项目(即使是一个小项目)，你可能会看到不同的团队如何试图集中核心解决方案和算法以避免重复。但是，我相信在这条道路上成功的并不多。</p><p id="22eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://webassembly.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">网络组装</strong> </a>可能是实现梦想的独唱之路。这是一种利用在项目中运行自包含且独立于语言的二进制文件的强大方法。官方说法是，网络组装是</p><blockquote class="lt lu lv"><p id="7cff" class="kw kx ls ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">基于堆栈的虚拟机的二进制指令格式。Wasm被设计为编程语言的可移植编译目标，支持客户端和服务器应用程序在web上的部署。(<a class="ae kv" href="https://webassembly.org/" rel="noopener ugc nofollow" target="_blank">https://webassembly.org/</a>)</p></blockquote><p id="9255" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里，我想展示如何使用<em class="ls"> wasm </em>将Swift实现集成到Go项目中，使用<a class="ae kv" href="https://book.swiftwasm.org/" rel="noopener ugc nofollow" target="_blank">https://book.swiftwasm.org/</a>中给出的说明以及我与GitHub维护者的<a class="ae kv" href="https://github.com/swiftwasm/swift/issues/1880" rel="noopener ugc nofollow" target="_blank">讨论</a>。一旦你学会了这些概念，你就能够在不同的项目中使用它们，比如Rust，JS等等。</p></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><h1 id="fa71" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">工具</h1><p id="eae1" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">让我们首先回顾一下您需要拥有或安装的工具</p><p id="fff9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> macOS/Ubuntu: </strong>这些操作系统为Swift提供了最好的支持。本教程使用的是<em class="ls"> Ubuntu 20.04.1 LTS </em></p><p id="8d74" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Swiftenv: 安装和管理不同版本Swift的强大工具。要安装，只需按照这里描述的说明:<a class="ae kv" href="https://swiftenv.fuller.li/en/latest/installation.html" rel="noopener ugc nofollow" target="_blank">https://swiftenv.fuller.li/en/latest/installation.html</a></p><p id="26be" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> swift-wasm: </strong>一旦你安装了<em class="ls"> Swiftenv </em>，你就可以安装在<a class="ae kv" href="https://github.com/swiftwasm/swift/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/swiftwasm/swift/releases</a>上市的<em class="ls"> swift-wasm </em>的最新版本了。<em class="ls">在我写这篇文章的时候，最新的版本是2020年10月14日</em></p><p id="24b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在安装之前，您可能需要安装更多的依赖项。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="0053" class="ni mh iq ne b gy nj nk l nl nm">$ <!-- -->apt update<!-- --> <br/>$ <!-- -->apt install <!-- -->binutils git gnupg2 libc6-dev libcurl4 libedit2 libgcc-9-dev libpython2.7 libsqlite3-0 libstdc++-9-dev libxml2 libz3-dev pkg-config tzdata zlib1g-dev curl <!-- -->lsb-release</span></pre><p id="7ab0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦安装了依赖项，您就可以安装<em class="ls"> swift-wasm </em></p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="ffda" class="ni mh iq ne b gy nj nk l nl nm">$ swiftenv install <a class="ae kv" href="https://github.com/swiftwasm/swift/releases/download/swift-wasm-DEVELOPMENT-SNAPSHOT-2020-10-14-a/swift-wasm-DEVELOPMENT-SNAPSHOT-2020-10-14-a-ubuntu20.04-x86_64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/swiftwasm/swift/releases/download/swift-wasm-DEVELOPMENT-SNAPSHOT-2020-10-14-a/swift-wasm-DEVELOPMENT-SNAPSHOT-2020-10-14-a-ubuntu20.04-x86_64.tar.gz</a></span><span id="2838" class="ni mh iq ne b gy nn nk l nl nm">$ swiftenv versions<br/>&gt; wasm-DEVELOPMENT-SNAPSHOT-2020-10-14-a-ubuntu20.04 (set by /root/.swiftenv/version)</span><span id="4a9a" class="ni mh iq ne b gy nn nk l nl nm">$ swiftenv global <br/>&gt; wasm-DEVELOPMENT-SNAPSHOT-2020-10-14-a-ubuntu20.04</span></pre><p id="2f95" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">Wamer:</strong>Web assembly运行时工具可以加载wasm二进制文件，并在受支持的主机语言中与之通信。虽然现在有一些可用的选项(如wasmtime、wasmer等。)我发现<a class="ae kv" href="https://wasmer.io/" rel="noopener ugc nofollow" target="_blank"> wasmer </a>是目前为止最好最简单的。要安装，只需按照文档:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="7fef" class="ni mh iq ne b gy nj nk l nl nm">$ curl https://get.wasmer.io -sSfL | sh<br/>$ source /root/.wasmer/wasmer.sh</span></pre></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><h1 id="f847" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated"><strong class="ak"> Swift </strong></h1><p id="1cc9" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">让我们首先创建一个新的Swift包可执行项目并运行它。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="0da9" class="ni mh iq ne b gy nj nk l nl nm">$ swift package init --type executable<br/>&gt; Creating executable package: swiftwasm<br/>&gt; Creating Package.swift<br/>&gt; Creating README.md<br/>&gt; Creating .gitignore<br/>&gt; Creating Sources/<br/>&gt; Creating Sources/swiftwasm/main.swift<br/>&gt; Creating Tests/<br/>&gt; Creating Tests/LinuxMain.swift<br/>&gt; Creating Tests/swiftwasmTests/<br/>&gt; Creating Tests/swiftwasmTests/swiftwasmTests.swift<br/>&gt; Creating Tests/swiftwasmTests/XCTestManifests.swift</span><span id="2d94" class="ni mh iq ne b gy nn nk l nl nm">$ swift build<br/>&gt; [4/4] Linking swiftwasm</span><span id="955e" class="ni mh iq ne b gy nn nk l nl nm">$ swift run<br/>Hello, world!</span></pre><h1 id="45da" class="mg mh iq bd mi mj no ml mm mn np mp mq jw nq jx ms jz nr ka mu kc ns kd mw mx bi translated"><strong class="ak">开始</strong></h1><p id="7e08" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">wasmer 对许多语言有丰富的支持，如Go、Rust、C/C++、PHP等。对于这些教程，我选择Go，因为它是一个常用的教程，而且几乎更容易学习和开始。让我们首先创建一个新的Go项目:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="0e6c" class="ni mh iq ne b gy nj nk l nl nm">$ go mod init "your-github-repository"</span></pre><p id="97f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建<em class="ls"> main.go </em>并添加一个简单的<em class="ls"> Hello World！</em>去它的</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="d444" class="ni mh iq ne b gy nj nk l nl nm">package main</span><span id="6055" class="ni mh iq ne b gy nn nk l nl nm">import (<br/> "fmt"<br/>)</span><span id="a53c" class="ni mh iq ne b gy nn nk l nl nm">func main() {<br/> fmt.Println("Hello World!")<br/>}</span></pre><p id="5de0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并运行它</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="02a6" class="ni mh iq ne b gy nj nk l nl nm">$ go run ./<br/>&gt; Hello World!</span></pre><h1 id="344d" class="mg mh iq bd mi mj no ml mm mn np mp mq jw nq jx ms jz nr ka mu kc ns kd mw mx bi translated"><strong class="ak">整合wasmer </strong></h1><p id="8f98" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们现在已经做好了一切准备，是时候将wasmer集成到我们的Go应用程序中了。用以下代码编辑<em class="ls"> main.go </em></p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="6e7a" class="ni mh iq ne b gy nj nk l nl nm">package main</span><span id="36f3" class="ni mh iq ne b gy nn nk l nl nm">import (<br/> "fmt"</span><span id="d051" class="ni mh iq ne b gy nn nk l nl nm"> "github.com/wasmerio/go-ext-wasm/wasmer"<br/>)</span><span id="ba5f" class="ni mh iq ne b gy nn nk l nl nm">func main() {<br/> // Reads the WebAssembly module as bytes.<br/> bytes, err := wasmer.ReadBytes("binary.wasm")<br/> if err != nil {<br/>  panic(err)<br/> }</span><span id="3115" class="ni mh iq ne b gy nn nk l nl nm"> // Compile bytes into wasm binary<br/> module, err := wasmer.Compile(bytes)<br/> if err != nil {<br/>  panic(err)<br/> }</span><span id="bf2e" class="ni mh iq ne b gy nn nk l nl nm"> // Get current wasi version and corresponded import objects<br/> wasiVersion := wasmer.WasiGetVersion(module)<br/> if wasiVersion == 0 {<br/>  // wasiVersion is unknow, use Latest instead<br/>  wasiVersion = wasmer.Latest<br/> }<br/> importObject := wasmer.NewDefaultWasiImportObjectForVersion(wasiVersion)</span><span id="cda8" class="ni mh iq ne b gy nn nk l nl nm"> // Instantiates the WebAssembly module using derived import objects.<br/> instance, err := module.InstantiateWithImportObject(importObject)<br/> if err != nil {<br/>  panic(err)<br/> }<br/> defer importObject.Close()<br/> defer instance.Close()</span><span id="f26c" class="ni mh iq ne b gy nn nk l nl nm"> fmt.Println(instance)<br/>}</span></pre><p id="a39c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过运行该代码，您将得到下面的异常，表明我们还没有向应用程序提供有效的wasm二进制文件</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="c573" class="ni mh iq ne b gy nj nk l nl nm">$ go run ./<br/>&gt; panic: open binary.wasm: no such file or directory</span></pre><h1 id="fed7" class="mg mh iq bd mi mj no ml mm mn np mp mq jw nq jx ms jz nr ka mu kc ns kd mw mx bi translated">创造。Swift的wasm</h1><p id="25e3" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">为了让Go应用程序工作，我们需要生成一个Web程序集(。wasm)二进制文件，并将其放在正在生成的<em class="ls"> main.go. </em>文件旁边。来自Swift项目的wasm二进制很容易。只需遵循以下步骤</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="2757" class="ni mh iq ne b gy nj nk l nl nm">$ # ensure you have swift-wasm on your machine<br/>$ swiftenv global<br/>&gt; wasm-DEVELOPMENT-SNAPSHOT-2020-10-14-a-ubuntu20.04</span><span id="8aae" class="ni mh iq ne b gy nn nk l nl nm">$ # set Toolchain path alias<br/>$ TOOLCHAIN_PATH=$(cd $(dirname "$(swiftenv which swiftc)") &amp;&amp; cd ../share &amp;&amp; pwd)</span><span id="4f60" class="ni mh iq ne b gy nn nk l nl nm">$ # build using defined Toolchain<br/>$ swift build --triple wasm32-unknown-wasi -c release --toolchain $TOOLCHAIN_PATH</span></pre><p id="94cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">生成的文件放在。<em class="ls"> build/release/ </em>是以项目的名字命名的。将它复制到Go项目目录，并将其重命名为<em class="ls">binary . wasm。</em>重新运行Go项目，您将看到以下输出</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="be51" class="ni mh iq ne b gy nj nk l nl nm">$ go run ./<br/>&gt; {0x7f33440201a0 0xc00000e080 map[_start:0x4b0f80] 0xc000012010 &lt;nil&gt;}</span></pre><h1 id="6b07" class="mg mh iq bd mi mj no ml mm mn np mp mq jw nq jx ms jz nr ka mu kc ns kd mw mx bi translated"><strong class="ak">启动二进制</strong></h1><p id="b0ed" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">从上面的输出可以看出，Go应用程序可以运行一个<em class="ls"> _start </em>函数。这个函数只是启动二进制(和<em class="ls"> swift run </em>一样)，但是不接受任何参数，也不返回值。编辑<em class="ls"> main.go </em>并添加一个新函数来启动二进制文件</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="58e9" class="ni mh iq ne b gy nj nk l nl nm">func main() {<br/> .........<br/> start(&amp;instance)<br/>}</span><span id="ace3" class="ni mh iq ne b gy nn nk l nl nm">func start(instance *wasmer.Instance) {<br/> // Gets start function from the WebAssembly instance.<br/> start := instance.Exports["_start"]</span><span id="8da0" class="ni mh iq ne b gy nn nk l nl nm"> // Calls that exported function with Go standard values. The WebAssembly types are inferred and values are casted automatically.<br/> result, err := start()<br/> if err != nil {<br/>  panic(err)<br/> }</span><span id="3263" class="ni mh iq ne b gy nn nk l nl nm"> // To ensure the start function doesn't return any values<br/> fmt.Println(result.GetType() == wasmer.TypeVoid)<br/>}</span></pre><p id="bec2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行Go项目，您将看到Swift项目的输出，以及函数返回<em class="ls"> void </em>的事实</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="15a4" class="ni mh iq ne b gy nj nk l nl nm">$ go run ./<br/>&gt; Hello, world!<br/>&gt; true</span></pre></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><h1 id="423d" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">下一步是什么</h1><p id="c563" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">这是关于如何从Swift项目中生成和使用wasm二进制文件的介绍。如果你渴望完成更复杂的任务，你可以阅读这里发布的下一部分:<a class="ae kv" href="https://medium.com/@h.shahbazi/the-power-of-swift-web-assembly-part-2-30b6c4619c27" rel="noopener">https://medium . com/@ h . shah bazi/the-power-of-swift-web-assembly-part-2-30 B6 c 4619 c 27</a></p><p id="714b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，这两个项目都可以在<a class="ae kv" href="https://github.com/hassan-shahbazi/swiftwasm-go/tree/part1" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上访问</p></div></div>    
</body>
</html>