<html>
<head>
<title>Using logstash to rebuild a complex elastic index</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用logstash重建复杂弹性指数</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-logstash-to-rebuild-a-complex-elastic-index-8c977f643cf3?source=collection_archive---------14-----------------------#2020-01-23">https://levelup.gitconnected.com/using-logstash-to-rebuild-a-complex-elastic-index-8c977f643cf3?source=collection_archive---------14-----------------------#2020-01-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="187b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">对于复杂对象，Logstash是rest客户端的替代方案</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/67530498b8c0fff9bf335ab35406a6a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Brs2zoKhT_DWCc8I"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">Maksym Kaharlytskyi 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="af0c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">两年前，我们开始使用弹性搜索将我们的一个主要应用程序的用户体验提升到一个新的水平——一个带有<strong class="ky ir">关系数据库模型</strong>的基本CRUD应用程序。</p><p id="9933" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在获得第一个用例的积极反馈后，我们开始更深入地整合它。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="9000" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">问题是</h1><p id="0f90" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">一切看起来都很好，直到我们有了一个新功能，我们必须向现有文档添加一些数据，我们需要重建我们的索引。</p><p id="1423" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">简单的任务…至少我们是这样认为的。</p><p id="d1fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的关系数据库模型中添加新字段，并将其添加到UI和Beans中，这和以前一样简单。</p><p id="1203" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们开始用数据填充新字段时，问题就出现了。我们必须用来自不同数据源的迁移值填充它。这意味着我们现在不得不将这些新数据放入我们现有的索引中，其中包含许多大型文档。</p><p id="7673" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们第一次使用这个指数时，它非常小。我们编写了一些简单的服务将数据读入我们的对象，通过调用一些其他服务来准备和丰富它们，然后使用<strong class="ky ir"> RestHighLevelClient将它们放入我们的索引中。</strong></p><p id="d384" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是现在这项服务成了我们的瓶颈。重建索引需要超过16个小时。这对于一次性重建来说是可以的，但是了解我们的利益相关者和我们项目的性质后，我们意识到这将很快再次发生。</p><p id="6805" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于白天进行部分更新不是我们的用户和利益相关者也同意的选项，我们必须找到一个不同的解决方案。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d738" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">Logstash来救援？</h1><p id="5ad3" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">当然，我们的第一次尝试是优化现有服务的性能，但很快我们就看到它已经达到了极限。经过一番调查后，我们决定尝试一下<strong class="ky ir"> logstash </strong>。</p><p id="7815" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的环境中设置它并查看jdbc插件之后。我们从一个管道开始，有一个巨大的声明。对于我们来说，性能比从我们的服务中推送我们的对象要好得多并不奇怪。</p><p id="f933" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">管道示例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">简单管道</figcaption></figure><p id="31f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用logstash的优点:</p><ul class=""><li id="ba03" class="my mz iq ky b kz la lc ld lf na lj nb ln nc lr nd ne nf ng bi translated">索引重建可以快得多</li><li id="9018" class="my mz iq ky b kz nh lc ni lf nj lj nk ln nl lr nd ne nf ng bi translated">减少我们后端服务的负载</li></ul><p id="8547" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">缺点是:</p><ul class=""><li id="3567" class="my mz iq ky b kz la lc ld lf na lj nb ln nc lr nd ne nf ng bi translated">你创建一个新层。现在，您必须在源代码和logstash管道中维护您的对象/类</li><li id="0566" class="my mz iq ky b kz nh lc ni lf nj lj nk ln nl lr nd ne nf ng bi translated">用户在看到对象之前可能会有一段延迟时间(取决于您的管道配置)</li></ul></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="4597" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">多管道</h1><p id="c046" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们仍然对结果不完全满意。我们速度更快，但是语句太复杂，对我们的数据库影响太大，所以我们尝试了另一种解决方案。基于我们的关系数据模型，我们在logstash中创建了多个管道。</p><p id="f476" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，一个项目包含一个客户和一个报价。因此，我们创建了三个管道来镜像这三个元素。当然，一个元素可以包含多个表。</p><p id="2110" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该项目的管道如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">多管道示例</figcaption></figure><p id="9bc1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">输出</strong>插件是这里最有趣的部分。</p><p id="3534" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nm">动作</em>参数和<em class="nm"> doc_as_upsert </em>参数允许我们插入不存在的新文档。但是如果文档已经存在，那么来自我们的输入插件的值会被添加到现有的文档中。因此，我们现在可以创建多个管道，写入同一文档的同一索引。您只需要确保在所有管道上使用相同的<strong class="ky ir"> id </strong>。</p><p id="3d84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一个文档有多个管道的优点是:</p><ul class=""><li id="1ceb" class="my mz iq ky b kz la lc ld lf na lj nb ln nc lr nd ne nf ng bi translated">部分重建是可能的</li><li id="e834" class="my mz iq ky b kz nh lc ni lf nj lj nk ln nl lr nd ne nf ng bi translated">更好的性能</li><li id="aac7" class="my mz iq ky b kz nh lc ni lf nj lj nk ln nl lr nd ne nf ng bi translated">更容易理解SQL语句</li></ul><p id="d765" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">缺点是:</p><ul class=""><li id="4f27" class="my mz iq ky b kz la lc ld lf na lj nb ln nc lr nd ne nf ng bi translated">您将不得不维护多个语句和管道。如果您要维护多个环境，这将变得更加困难</li></ul><h1 id="3ff2" class="lz ma iq bd mb mc nn me mf mg no mi mj jw np jx ml jz nq ka mn kc nr kd mp mq bi translated">结论</h1><p id="74c9" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">去掉中间层，在我们的例子中是Java服务，可以大大减少索引的重建时间。但是这也带来了在项目中引入新的层次和复杂性的代价。</p></div></div>    
</body>
</html>