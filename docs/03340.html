<html>
<head>
<title>Environment Variables in Cypress End-to-End Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Cypress端到端测试中的环境变量</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/environment-variables-in-cypress-end-to-end-testing-e2f20acd6a86?source=collection_archive---------5-----------------------#2020-05-04">https://levelup.gitconnected.com/environment-variables-in-cypress-end-to-end-testing-e2f20acd6a86?source=collection_archive---------5-----------------------#2020-05-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c7e8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">向赛普拉斯测试传递秘密的正确方法。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bd1862adb0f2eb252d0641c8e8fcef4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WQzm2rpwsVqJVoA69iZQ6w.png"/></div></div></figure><p id="b1d6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们经常需要编写端到端(e2e)测试来验证请求安全资源的流程，这需要适当的凭证。例如，登录表单需要有效的用户名和密码，端点强制使用正确的API密钥，HTTP请求需要可验证的令牌。我们有多种方法来保护e2e测试中的这些秘密，这是持续集成(CI)过程的一个关键部分。一种常见的方法是将秘密保存为环境变量，以便测试脚本可以检索它们。</p><p id="e6a7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Cypress提供了几种处理环境变量的方法。在关于环境变量的文档中(<a class="ae lq" href="https://docs.cypress.io/guides/guides/environment-variables.html#Setting" rel="noopener ugc nofollow" target="_blank">链接</a>，Cypress列出了它们的用法，并比较了每个选项的优缺点。在本文中，我们将关注使用Cypress命令行界面(CLI)传递环境变量的选项，并且我们将讨论使用Cypress npm包和Cypress docker映像的场景。</p><p id="7537" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">出于演示目的，我们将针对登录页面编写e2e测试(<a class="ae lq" href="http://the-internet.herokuapp.com/login" rel="noopener ugc nofollow" target="_blank">链接</a>)。测试用户名和密码将被保存为环境变量，并通过Cypress CLI传递给测试。e2e测试和相关命令可以在<a class="ae lq" href="https://github.com/changhuixu/testing-login-form-with-cypress" rel="noopener ugc nofollow" target="_blank">我的GitHub库</a>中找到。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="26ce" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">e2e测试</h1><p id="1c15" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">下面的屏幕截图显示了测试中的登录页面。这是一个带有登录表单的通用测试页面。为了登录网站，我们需要提供一个用户名字符串和一个密码字符串。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/b8dc109dab33d001ec1412a95bc9ebb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*koR4aV-q4ZbODjp2iwQ9WA.png"/></div></div></figure><p id="d33d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这个虚构的例子中，我们已经知道了正确的用户名和密码，因为它们显示在登录页面中。让我们确保不会在现实世界的应用程序中向公众公开凭据。</p><p id="e532" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">成功登录后，我们应该能够看到以下屏幕。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mw"><img src="../Images/1da810b2d859aa19ddbc767da8e048d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AJIHWCxVRDVpFU6Q1yTi8w.png"/></div></div></figure><p id="b214" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了使e2e测试简单，我们将只验证快乐路径。成功的登录结果应该包括一个包含字符串“<code class="fe mx my mz na b">secure</code>”的URL、一个CSS类为“<code class="fe mx my mz na b">success</code>”的alert元素和一个标题为“<code class="fe mx my mz na b">h2</code>”的文本“<code class="fe mx my mz na b">Secure Area</code>”。</p><p id="c0af" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们的目标是避免在测试文件中硬编码用户名和密码，这样就不会将秘密提交给我们的代码库。以下代码片段显示了登录过程的e2e测试示例。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">一个赛普拉斯e2e测试用户登录过程。(<a class="ae lq" href="https://gist.github.com/changhuixu/ff94b1b2ea7361f3a4a1bc893414d848" rel="noopener ugc nofollow" target="_blank">要点链接</a>)</figcaption></figure><p id="a91b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在第5行和第6行，Cypress访问环境变量来获取用户名和密码的值。然后在第7行和第8行，Cypress输入用户名和密码来提交登录表单。第10到13行是成功结果的断言。</p><h1 id="35c7" class="ly lz it bd ma mb nh md me mf ni mh mi jz nj ka mk kc nk kd mm kf nl kg mo mp bi translated">Cypress npm脚本中的环境变量</h1><p id="fda0" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">在这个测试中，Cypress期望两个环境变量:<code class="fe mx my mz na b">username</code>和<code class="fe mx my mz na b">password</code>，如第5行和第6行所示。</p><p id="ee01" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们当然可以使用下面的命令传入这两个环境变量。注意:在Cypress CLI工具中，环境变量由逗号分隔。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="7d84" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Cypress能够解析命令并获得定义的值，e2e测试通过。</p><p id="c0aa" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是，我们不想以明文形式签入这个命令。对于大多数CI平台，我们需要提供一个配置文件来描述测试脚本，我们通常在我们的版本控制系统中提交配置文件。因此，为了CI管道中的安全性，我们需要有另一层环境变量。</p><p id="2d3a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">大多数CI平台支持凭证插件或类似的东西。在这种情况下，我们可以在CI平台中存储键-值对，当在CI配置文件中找到键时，CI代理将替换正确的值。假设我们已经在CI平台中设置了两个参数<code class="fe mx my mz na b">TESTUSERNAME</code>和<code class="fe mx my mz na b">TESTPASSWORD</code>，那么我们可以在CI配置文件中使用以下命令。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="5438" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">注意:</strong>如果您不喜欢<code class="fe mx my mz na b">$(npm bin)</code>的语法，更喜欢使用自己的npm脚本，那么请考虑添加一个<code class="fe mx my mz na b">-s</code>标志来抑制解释脚本的回声。例如，我在<code class="fe mx my mz na b">package.json</code>文件中定义了一个脚本<code class="fe mx my mz na b">“cypress:run”: “cypress run”</code>，那么CI测试命令应该如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="24a2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了帮助你理解<code class="fe mx my mz na b">-s</code>旗的效果，我们来看看下面的截图。如果没有<code class="fe mx my mz na b">-s</code>标志，npm会将解释后的命令回显到控制台，因此CI日志会以明文形式显示秘密，这可能不合适。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/2dbb28ec6913c1aa14905243129365d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I0mxDVxoEc2DiNBDcseTAw.png"/></div></div></figure><p id="bb71" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">说到CI日志，我们可能还会对Cypress e2e测试生成的视频和截图保持谨慎，因为我们可以在Cypress时间旅行记录中看到密码。下面的屏幕截图显示了生成的视频的快照。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/a0d1ff353e9f6750d04ddc513d644a33.png" data-original-src="https://miro.medium.com/v2/resize:fit:878/format:webp/1*TsmlSyfc4LRafgZTiq0Rfw.png"/></div></figure><p id="09d3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">知道了这一点，您可能想在<code class="fe mx my mz na b">cypress.json</code>文件中将video设置为false，并使用Cypress API抑制快照。或者，至少，我们应该把藏物保存在一个安全的环境中。</p><h1 id="d788" class="ly lz it bd ma mb nh md me mf ni mh mi jz nj ka mk kc nk kd mm kf nl kg mo mp bi translated">测试跑步者档案中的环境变量</h1><p id="6b04" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">如果我们的CI平台没有存储键值对的特性，那么我们可以将秘密设置为测试运行程序的用户环境变量的一部分，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="3fdd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">环境变量可以存储在测试运行者的概要文件中，比如存储在<code class="fe mx my mz na b">~/.bash_profile</code>文件中。然后，我们可以按照上一节提到的类似方式使用它们。</p><p id="25b0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，使用特定于Cypress的环境变量可能更容易，这些变量带有前缀<code class="fe mx my mz na b">CYPRESS_</code>。例如，我们可以在<code class="fe mx my mz na b">~/.bash_profile</code>中设置以下环境变量。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="28df" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这样，我们不需要在Cypress命令中传递环境变量。相反，我们可以简单地运行命令<code class="fe mx my mz na b">npm run cypress:run</code>，测试就会通过。</p><h1 id="5429" class="ly lz it bd ma mb nh md me mf ni mh mi jz nj ka mk kc nk kd mm kf nl kg mo mp bi translated">docker图像的环境变量:<code class="fe mx my mz na b">cypress/included</code></h1><p id="64e2" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">Cypress提供了一个docker镜像<code class="fe mx my mz na b">cypress/included</code>,允许我们只使用一个命令来运行测试。例如，要运行本文中的测试，我们可以转到<code class="fe mx my mz na b">e2e</code>文件夹，并执行下面的命令。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="b86e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个命令告诉docker以交互方式运行映像<code class="fe mx my mz na b">cypress/included:4.5.0</code>，并将测试文件夹作为卷<code class="fe mx my mz na b">/e2e</code>安装在docker容器中。docker容器将获取环境变量并运行Cypress测试。</p><p id="669b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意，我在每个卷路径前加了一个斜杠<code class="fe mx my mz na b">/</code>符号，因为我在Windows中运行这个命令，斜杠符号帮助docker在Windows中正确获取卷路径。</p><p id="34d7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在运行docker容器的场景中，<code class="fe mx my mz na b">CYPRESS_</code>环境变量不起作用，因为它只存在于主机中。</p><h1 id="33ac" class="ly lz it bd ma mb nh md me mf ni mh mi jz nj ka mk kc nk kd mm kf nl kg mo mp bi translated">自定义docker图像的环境变量</h1><p id="7867" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">我们可能希望构建一个docker映像，并让CI管道在一个容器中运行测试。在这种情况下，我们可以根据柏树图像<code class="fe mx my mz na b">cypress/base</code>写出下面的<code class="fe mx my mz na b">Dockerfile</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="79a4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们将映像的入口点设置为“<code class="fe mx my mz na b">cypress:run</code>”命令，这样当容器运行映像时，e2e测试将自动执行。我们可以使用以下命令构建映像并在容器中运行它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="68e0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">非常好。我们再次看到测试通过，但是是在docker容器中。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><p id="cbcd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">基本原则是避免将凭证签入代码存储库，在本文中，我们使用环境变量来传递秘密。我想我已经涵盖了我所知道的所有场景，我希望这篇文章能够帮助您决定如何在Cypress测试中使用环境变量。</p><p id="d879" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">e2e测试的完整项目可以在<a class="ae lq" href="https://github.com/changhuixu/testing-login-form-with-cypress" rel="noopener ugc nofollow" target="_blank">我的GitHub库</a>中找到。感谢阅读。</p></div></div>    
</body>
</html>