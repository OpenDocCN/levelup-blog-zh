<html>
<head>
<title>The Secret to Update User Password Profile with Microsoft Graph API In Azure AD Programmatically</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Azure AD中使用Microsoft Graph API以编程方式更新用户密码配置文件的秘诀</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-reset-or-update-user-passwords-with-microsoft-graph-api-in-azure-ad-c6733c3b0ac3?source=collection_archive---------4-----------------------#2020-01-15">https://levelup.gitconnected.com/how-to-reset-or-update-user-passwords-with-microsoft-graph-api-in-azure-ad-c6733c3b0ac3?source=collection_archive---------4-----------------------#2020-01-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="85a1" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">微软图形语言</h2><div class=""/><div class=""><h2 id="d5b1" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">通过Microsoft Graph API更新密码配置文件时，权限不足以完成操作这一错误的最佳解决方案</h2></div><p id="e660" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi lk translated">最近，我在做一个项目，将它的信息管理系统与微软office365和Azure AD整合起来，用于邮件交换服务。在开发过程中，我遇到了一个问题，通过Microsoft graph API在azure active directory中重置用户密码时，总是显示以下错误:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="321c" class="mc md iq ly b gy me mf l mg mh">"code": "Authorization_RequestDenied",<br/>"message": "Insufficient privileges to complete the operation.",</span></pre><p id="e0dc" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">很快我发现许多开发者遇到了同样的问题，并简单地放弃了，因为似乎没有解决这个问题的灵丹妙药。然而，经过长时间的研究，我终于找到了原因和解决办法。因此，我想分享它，并希望它可以帮助其他开发者。</p><figure class="lt lu lv lw gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mi"><img src="../Images/e6d2677530893c153a42bef6b7ac2e73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ny9yCJpkSoscHTdrQQHN9A.png"/></div></div></figure><h1 id="fd5d" class="mq md iq bd mr ms mt mu mv mw mx my mz kf na kg nb ki nc kj nd kl ne km nf ng bi translated">背景和原因——关键秘密</h1><p id="e2cd" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">使用Microsoft Graph读取和写入资源有两种方式</p><blockquote class="nm"><p id="c395" class="nn no iq bd np nq nr ns nt nu nv lj dk translated">委托权限模式:可以有委托权限，比如目录。一个用户，但它必须通过一个交互式登录</p><p id="8684" class="nn no iq bd np nq nr ns nt nu nv lj dk translated">应用许可模式:不需要交互式登录，非常适合后端服务使用。但是，由于它不是真正的用户，所以不能拥有一些委托权限，所以不能被委托。</p></blockquote><p id="3a5c" class="pw-post-body-paragraph ko kp iq kq b kr nw ka kt ku nx kd kw kx ny kz la lb nz ld le lf oa lh li lj ij bi translated">因此，如果我们构建一个服务或应用程序来访问Microsoft graph，我们必须使用应用程序权限模式来避免交互式登录，这意味着访问不是由任何用户触发的。但是，当更新<strong class="kq ja"> passwordProfile </strong>属性时，需要以下权限:Directory。AccessAsUser.All，这只是委派的权限。这就是为什么不管分配什么权限，密码配置文件的更新都会失败。</p><h1 id="bd27" class="mq md iq bd mr ms mt mu mv mw mx my mz kf na kg nb ki nc kj nd kl ne km nf ng bi translated">解决办法</h1><p id="beb5" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">当然，人们可以切换到委托许可访问模式，并使用一些GUI框架(如WebDriver)来自动化交互式登录网页过程，这非常麻烦、不方便，并且更糟糕的是，不稳定和不可靠。</p><p id="ffa7" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">那么对此的最佳解决方案是什么呢？</p><blockquote class="nm"><p id="54e5" class="nn no iq bd np nq nr ns nt nu nv lj dk translated">答案是在我们的应用程序中添加必要且足够的角色，这样我们的应用程序就可以执行原本需要授权用户才能完成的任务。这可以通过一些Powershell模块来实现，并且只在服务器端一次性完成。</p></blockquote><p id="a6ea" class="pw-post-body-paragraph ko kp iq kq b kr nw ka kt ku nx kd kw kx ny kz la lb nz ld le lf oa lh li lj ij bi translated">有两个版本的PowerShell模块可用于连接到Office 365并管理用户帐户、组和许可证:</p><blockquote class="nm"><p id="f993" class="nn no iq bd np nq nr ns nt nu nv lj dk translated">azure Active Directory PowerShell for Graph</p><p id="26d1" class="nn no iq bd np nq nr ns nt nu nv lj dk translated">用于Windows PowerShell的Microsoft Azure Active Directory模块</p></blockquote><p id="8b4e" class="pw-post-body-paragraph ko kp iq kq b kr nw ka kt ku nx kd kw kx ny kz la lb nz ld le lf oa lh li lj ij bi translated">截至本文，Azure Active Directory PowerShell for Graph模块并没有完全取代Microsoft Azure Active Directory Module for Windows PowerShell模块的cmdlets中用于用户、组和许可证管理的功能。我还发现Azure AD PowerShell甚至不能在Mac上安装。所以我会用<code class="fe ob oc od ly b">MSOL</code>。<code class="fe ob oc od ly b">Windows os </code>这里强烈推荐，虽然它声称MSOL模块完全转移到点网核心。</p><h2 id="53bf" class="mc md iq bd mr oe of dn mv og oh dp mz kx oi oj nb lb ok ol nd lf om on nf iw bi translated">安装MSOL并使用MSOL登录Azure Active Directory。</h2><p id="e27f" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">打开PowerShell并输入:</p><p id="cf91" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><code class="fe ob oc od ly b">Install-Module -Name MSOnline</code></p><p id="0dd6" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果您使用的是带点网核心的Mac OS，那么需要显式导入模块</p><p id="04d2" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><code class="fe ob oc od ly b">Import-Module MSOnline</code></p><p id="abdd" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">然后连接服务</p><p id="0748" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><code class="fe ob oc od ly b">Connect-MsolService</code></p><p id="22ca" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在应该会有一个弹出窗口，要求您登录Azure。请确保使用全局管理员帐户。</p><h2 id="098a" class="mc md iq bd mr oe of dn mv og oh dp mz kx oi oj nb lb ok ol nd lf om on nf iw bi translated">获取应用程序的ObjectID</h2><p id="0d6c" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">我们可以使用以下命令获取对象ID:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="2269" class="mc md iq ly b gy me mf l mg mh">$tenantID = “&lt;Tenant ID&gt;”<br/>$appID = “&lt;Application ID&gt;”<br/>$myAp = Get-MsolServicePrincipal -AppPrincipalId $appID -TenantID $tenantID<br/>$objectId = $myAp.ObjectId</span></pre><p id="3a25" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">或者直接在azure广告中获取。</p><figure class="lt lu lv lw gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi oo"><img src="../Images/b6d9114b6d4b58a357c70e4c392300d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*42amzYFJBoudsi695pmadA.jpeg"/></div></div></figure><h2 id="7851" class="mc md iq bd mr oe of dn mv og oh dp mz kx oi oj nb lb ok ol nd lf om on nf iw bi translated">添加角色成员</h2><p id="d083" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">这里我们选择<code class="fe ob oc od ly b">Helpdesk Administrator</code>，它做用户管理的权力最小。(实际上，密码管理的最小角色是<code class="fe ob oc od ly b">Password Administrator</code>，但它不足以实现用户管理的其他必要功能)</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="989b" class="mc md iq ly b gy me mf l mg mh">Add-MsolRoleMember -RoleName “Helpdesk Administrator” -RoleMemberType ServicePrincipal -RoleMemberObjectId $objectId</span></pre><p id="7723" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果它碰巧不是你需要的角色，你也可以轻松地删除它。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="4ac3" class="mc md iq ly b gy me mf l mg mh">Remove-MsolRoleMember -RoleName “Helpdesk Administrator” -RoleMemberType ServicePrincipal -RoleMemberObjectId $objectId</span></pre><h2 id="a29f" class="mc md iq bd mr oe of dn mv og oh dp mz kx oi oj nb lb ok ol nd lf om on nf iw bi translated">测试更新操作</h2><p id="6e95" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">等待几分钟后，当我们再次点击端点时，我们可以看到服务器返回204 No Content，显示密码更新成功。</p><figure class="lt lu lv lw gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi op"><img src="../Images/41dbfabab324bf5104e160e4466985f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l0EUAnTwwJ9Ln-dPBSZ9dg.jpeg"/></div></div></figure></div><div class="ab cl oq or hu os" role="separator"><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov"/></div><div class="ij ik il im in"><h1 id="b03b" class="mq md iq bd mr ms ox mu mv mw oy my mz kf oz kg nb ki pa kj nd kl pb km nf ng bi translated">使用AAD PowerShell V2.0的解决方案</h1><h2 id="f354" class="mc md iq bd mr oe of dn mv og oh dp mz kx oi oj nb lb ok ol nd lf om on nf iw bi translated">安装AAD PowerShell V2.0模块并登录</h2><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="27c3" class="mc md iq ly b gy me mf l mg mh">Install-Module AzureAD<br/>Connect-AzureAD</span></pre><h2 id="bc9e" class="mc md iq bd mr oe of dn mv og oh dp mz kx oi oj nb lb ok ol nd lf om on nf iw bi translated">获取应用程序的ObjectID</h2><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="f0e5" class="mc md iq ly b gy me mf l mg mh">$myAp = Get-AzureADServicePrincipal -searchstring &lt;your application name&gt;</span><span id="20e6" class="mc md iq ly b gy pc mf l mg mh">$myAp.ObjectId</span></pre><h2 id="21e4" class="mc md iq bd mr oe of dn mv og oh dp mz kx oi oj nb lb ok ol nd lf om on nf iw bi translated">添加角色成员</h2><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="532d" class="mc md iq ly b gy me mf l mg mh">$myAADRole = Get-AzureADDirectoryRole | Where-Object {$_.displayName -eq ‘Helpdesk Administrator’}</span><span id="8450" class="mc md iq ly b gy pc mf l mg mh">Add-AzureAD DirectoryRoleMember -ObjectId $myAADRole.ObjectId -RefOb jectId $myAp.Object Id</span></pre></div><div class="ab cl oq or hu os" role="separator"><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov"/></div><div class="ij ik il im in"><h1 id="1769" class="mq md iq bd mr ms ox mu mv mw oy my mz kf oz kg nb ki pa kj nd kl pb km nf ng bi translated">参考:</h1><p id="38bb" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated"><strong class="kq ja"> Azure角色和权限</strong>:<a class="ae pd" href="https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#details-about-the-global-administrator-role" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/Azure/active-directory/users-groups-Roles/directory-assign-admin-Roles # details-about-the-global-administrator-role</a></p><p id="e3e9" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><strong class="kq ja">关于office-365-PowerShell的更多信息</strong>:<a class="ae pd" href="https://docs.microsoft.com/en-us/office365/enterprise/powershell/connect-to-office-365-powershell" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/office 365/enterprise/PowerShell/why-you-need-to-use-office-365-PowerShell</a></p></div></div>    
</body>
</html>