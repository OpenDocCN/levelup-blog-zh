<html>
<head>
<title>Rolling our own Medium-style WYSIWYG</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">滚动我们自己的中等风格所见即所得</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/rolling-our-own-medium-style-wysiwyg-c10fda0e5699?source=collection_archive---------4-----------------------#2019-01-24">https://levelup.gitconnected.com/rolling-our-own-medium-style-wysiwyg-c10fda0e5699?source=collection_archive---------4-----------------------#2019-01-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8be6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一年前，一个客户找到我们，要求提供一个富文本编辑器(RTE ),它的外观和感觉都像Medium.com，并添加了一些自定义功能。我们开始的模型很简单，只有文章的主体是中等风格的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/40e0d3dbaedc0bc654ffb3cd35160ee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XMP5K5cdU5rYyLkGiJwWow.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">2018年1月—富文本编辑器模型</figcaption></figure><p id="e446" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的一个初级开发人员从一个现有的RTE开始，<a class="ae lb" href="https://ckeditor.com/" rel="noopener ugc nofollow" target="_blank">cke editor</a>，并开始对它进行定制，以与我们在几个月前构建的API数据结构一起工作，但是在开发的几个星期后，危险信号开始出现:</p><ul class=""><li id="d623" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">我们如何可靠地获得用户文本插入符号的水平和垂直位置？(您正在书写的闪烁的垂直破折号)</li><li id="647b" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">我们应该将文本格式转换为markdown格式还是将原始HTML存储在数据中？</li><li id="f78d" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">如果用户在段落中间插入图像或视频，我们如何处理将文本块一分为二？</li><li id="0dab" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">旧版本的Safari/Firefox没有CKEditor中的一些新ECMA标准。</li><li id="97f0" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">我们的构建规模从大约450kb膨胀到超过1.5mb。</li></ul><p id="1b4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">随着CKEditor的每一次发布，我们添加的定制似乎都崩溃了，导致了一次又一次的延迟。——最初看起来“可行”的事情很快变成了“好吧，让我们让它变得可用”的游戏。</p><p id="d22b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们编辑器的第一个版本漏洞百出，当格式问题出现时，我们的客户同意在我们手动编辑帖子数据的同时解决这些问题。在所有的错误中，最常见的与降价有关。</p><p id="f7ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">降价并不完美。它非常有用，但远非完美。在很多情况下，它可能无法正确地转换回HTML，尤其是当你需要支持诸如删除线、下划线、可选标题、<strong class="jp ir"> <em class="lq">文字内的</em> </strong>抠图和组合格式(粗体、斜体、&amp;删除线)等格式时。—更不用说markdown讨厌尾随空格。</strong></p><h2 id="ed5d" class="lr ls iq bd lt lu lv dn lw lx ly dp lz jy ma mb mc kc md me mf kg mg mh mi mj bi translated">有趣的事实:甚至Medium也不支持删除线或下划线。</h2><p id="d3b5" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">原因可能是因为流行的web标准只要求链接在HTML中加下划线，但是我们为我们的客户工作，我们的客户要求两种格式选项。—所以我们必须支持这一点。</p><p id="f88d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几个月来，我们的客户令人沮丧地继续使用我们为他们制作的劣质解决方案，而我们则努力寻找更好的方法。经过几周的辩论和研究，我们决定最好的解决方案是从头开始，推出我们自己的产品。<strong class="jp ir">好玩</strong>。“好玩”。好玩？</p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="45eb" class="mw ls iq bd lt mx my mz lw na nb nc lz nd ne nf mc ng nh ni mf nj nk nl mi nm bi translated">输入内容可编辑</h1><p id="84ac" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">HTML中的“contenteditable”属性已经存在多年，并且有一些现成的强大功能，但开发人员一直反对它(2014年的<a class="ae lb" href="https://medium.engineering/why-contenteditable-is-terrible-122d8a40e480" rel="noopener ugc nofollow" target="_blank">包括Medium </a>，但现在使用“contenteditable”)。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/7c9bac908a5f41cf0c87a1c836329615.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*06ApcfQopWiM91lQYGLURQ.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">在写这篇文章的时候，中等代码的快速峰值。</figcaption></figure><p id="5c2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再加上一个可靠的markdown转换器来适当地存储数据，contenteditable HTML元素是一个非常强大的东西。</p><ul class=""><li id="6e01" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">格式化命令很简单:document.execCommand('bold ')。</li><li id="631e" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">键盘快捷键默认工作:CTRL + I，CTRL + Z等。</li><li id="d269" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">找到光标位置和文本选择比使用普通JS更容易。</li><li id="3baf" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">子HTML元素(特别是embed和iframe)本身就可以工作。</li></ul><p id="6c45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然仍然有<a class="ae lb" href="https://ckeditor.com/blog/ContentEditable-The-Good-the-Bad-and-the-Ugly/" rel="noopener ugc nofollow" target="_blank">有效的理由</a>反对不使用contenteditable，但是我们没有开发所需的资源来开发我们自己的一组contenteditable已经支持的定制侦听器。</p><h1 id="4bda" class="mw ls iq bd lt mx no mz lw na np nc lz nd nq nf mc ng nr ni mf nj ns nl mi nm bi translated">我们所见即所得的基础:内容可编辑的内容块+降价。</h1><p id="3342" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">从那时起，随着我们开始探索添加以下自定义功能，事情变得更加复杂:</p><ul class=""><li id="f4cb" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">自定义降价:删除线、下划线</li><li id="178b" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">净化和格式化从外部应用程序粘贴的内容</li><li id="633a" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">内容块的拖放</li><li id="118b" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">当用户需要时，退出某些元素，如<ul> &amp; </ul><ol/></li><li id="a92d" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">当用户插入嵌入元素时拆分文本块</li><li id="2688" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">确保用户不会到达HTML结构不正确的状态</li><li id="c26d" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">如果用户在键入时接近HTML元素的结尾，则自动滚动页面</li><li id="aeb5" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">允许用户在内容中创建动态表格</li><li id="cadb" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">检测粘贴的图像，而不是上传图像</li></ul><p id="1f17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同时保持尽可能小的构建规模。那么，让我们深入探讨一下我对最困难问题的一些解决方案。</p><h2 id="ee4b" class="lr ls iq bd lt lu lv dn lw lx ly dp lz jy ma mb mc kc md me mf kg mg mh mi mj bi translated">1.定制降价</h2><p id="537c" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">我认为markdown的一个弱点是开始和结束语法。<br/> **text here**不如#%text here%#之类的东西好用。可能有我不知道的原因，但是当我知道哪些字符串是开始而不是结束时，转换自定义降价会容易得多。</p><p id="4fae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于我们的删除线自定义减价，我决定使用% % #删除线#%%，并且在传统的减价转换之后，我通过正则表达式来转换我的自定义减价，因此没有任何冲突。</p><h2 id="72f2" class="lr ls iq bd lt lu lv dn lw lx ly dp lz jy ma mb mc kc md me mf kg mg mh mi mj bi translated"><strong class="ak"> 2。净化软件</strong>中粘贴的文本</h2><p id="d583" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">这是一场持续的战斗。每一个软件都试图以不同的方式格式化它们的文本。当您从它复制和粘贴时，隐藏的格式随之而来。下面是一个从谷歌文档粘贴的例子。丑陋，但有道理。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nt"><img src="../Images/fc0294e4b9f00544e93ffb76b05e370b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wbHRZwWpfrYRfDstzfNO_A.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">其中一些需要保留，其余的可以丢弃。</figcaption></figure><p id="4da6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我也可以去掉所有的格式并粘贴原始文本，但是这样做对用户不太友好。因此，我们去掉所有不重要的元素，然后清理可用的元素，如粗体、斜体、换行符和链接，然后检查每个主要的文本编辑器是否都受支持(Google、Word、写字板、TextEdit等)。这涉及到大量的正则表达式魔术。这是我们定制消毒的<strong class="jp ir">小</strong> <strong class="jp ir">样品</strong>。</p><pre class="km kn ko kp gt nu nv nw nx aw ny bi"><span id="4a38" class="lr ls iq nv b gy nz oa l ob oc">const<strong class="nv ir"> </strong>removeStyle = <strong class="nv ir">function</strong>(e) {<br/>e.preventDefault();</span><span id="f0fc" class="lr ls iq nv b gy od oa l ob oc">const<strong class="nv ir"> </strong>pastedText = e.clipboardData;</span><span id="a053" class="lr ls iq nv b gy od oa l ob oc">// change line breaks into p tags<br/>let<strong class="nv ir"> </strong>sanitizedText = pastedText.replace(/^\s*\n/gm, '&lt;p&gt;&lt;br /&gt;&lt;/p&gt;');</span><span id="4c9a" class="lr ls iq nv b gy od oa l ob oc">// remove all spans<br/>sanitizedText = sanitizedText.replace(/&lt;\/?span[^&gt;]*&gt;/g, '');</span><span id="60b4" class="lr ls iq nv b gy od oa l ob oc">// remove classes<br/>sanitizedText = sanitizedText.replace(/class='[a-zA-Z0-9:;\\.\\s\\(\\)\\-\\,]*'/g, '');<br/><br/>// remove styles<br/>sanitizedText = sanitizedText.replace(/style='[a-zA-Z0-9:;\\.\\s\\(\\)\\-\\,]*'/g, '');<br/><br/>document.execCommand('insertHTML', false, sanitizedText);</span><span id="9a5e" class="lr ls iq nv b gy od oa l ob oc">}</span><span id="2fa2" class="lr ls iq nv b gy od oa l ob oc">editableDiv.addEventListener('paste', removeStyle, false);</span></pre><h2 id="f247" class="lr ls iq bd lt lu lv dn lw lx ly dp lz jy ma mb mc kc md me mf kg mg mh mi mj bi translated">3.插入符号和选择检测</h2><p id="304b" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">在一串文本中获得插入符号(闪烁的光标)的位置非常容易。</p><pre class="km kn ko kp gt nu nv nw nx aw ny bi"><span id="1426" class="lr ls iq nv b gy nz oa l ob oc">window.getSelection().getRangeAt(0).startOffset</span><span id="2a61" class="lr ls iq nv b gy od oa l ob oc">// or if user has selected text</span><span id="c62a" class="lr ls iq nv b gy od oa l ob oc">window.getSelection().getRangeAt(0).getBoundingClientRect().left</span></pre><p id="8f48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，获取插入符号的垂直位置并不容易。因为我们不仅需要知道左边的“+”号应该放在哪里，我们还需要知道在哪里插入您正在创建的新内容块(例如，插入一个图像或Twitter嵌入)。所以我们首先获得一个光标上方所有标签的数组，并找到我们在哪个标签上。</p><pre class="km kn ko kp gt nu nv nw nx aw ny bi"><span id="2c9e" class="lr ls iq nv b gy nz oa l ob oc">// index is passed by keyup or click event</span><span id="a6ff" class="lr ls iq nv b gy od oa l ob oc">const<strong class="nv ir"> </strong>contentContainer = document.getElementById('textBlock-' + index);</span><span id="1c03" class="lr ls iq nv b gy od oa l ob oc">const child = window.getSelection().anchorNode;</span><span id="7a67" class="lr ls iq nv b gy od oa l ob oc">const currentParagraph = (Array.from(contentContainer['children']).indexOf(child)) + 1;</span><span id="716a" class="lr ls iq nv b gy od oa l ob oc">const<strong class="nv ir"> </strong>tagsAbove = Array.from(contentContainer['children']).slice(0, currentParagraph - 1);</span></pre><p id="72ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，一旦我们知道我们在哪里，我们就确定元素的高度，我们知道光标上方的高度，我们可以将该值设置为“+”按钮的顶部CSS位置。</p><pre class="km kn ko kp gt nu nv nw nx aw ny bi"><span id="0a51" class="lr ls iq nv b gy nz oa l ob oc">let heightAbove = 0;</span><span id="607c" class="lr ls iq nv b gy od oa l ob oc">tagsAbove.forEach((tag) =&gt; {<br/>  heightAbove += tag['clientHeight'] + 20;<br/>});</span><span id="d9e1" class="lr ls iq nv b gy od oa l ob oc">// adding 20px because each element has a margin bottom of 20px</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/34ed4a598155f2559c938b0949a57e38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/1*7BQKCOBweCF6oAntATwHZg.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">我们新的所见即所得的截图。加号在正确的位置。</figcaption></figure></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="4592" class="mw ls iq bd lt mx my mz lw na nb nc lz nd ne nf mc ng nh ni mf nj nk nl mi nm bi translated">4个月后……最终产品</h1><p id="a35d" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">迄今为止，这是我职业生涯中参与的最困难的项目。最终的RTE不到2500行HTML、CSS和JS，支持嵌入YouTube、Vimeo、SoundCloud、Twitter、Instagram、CrowdSignal、图像和视频。</p><p id="6504" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们确实使用了一个<a class="ae lb" href="https://www.npmjs.com/package/ngx-markdown" rel="noopener ugc nofollow" target="_blank"> markdown库</a>来转换富文本。我们还没疯狂到写自己的。—下面您可以看到我们富文本编辑器的屏幕截图。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi of"><img src="../Images/a922e05f8ad8b532eaa5a45e3f524f3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*-Sugm2O96vxKvbC4E2y8PQ.png"/></div></figure></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><p id="e7da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">非常感谢我们FanReact的QA大师Ian Shirley，他发现了数百个bug。这是一个艰苦的4周的测试，错误挤压和发布，但我们有一个高度稳定和用户友好的编辑器，我感到自豪。</p><p id="fc99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更多关于Angular、Javascript、CSS的文章请访问我的网站。</p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><figure class="km kn ko kp gt kq gh gi paragraph-image"><a href="https://levelup.gitconnected.com"><div class="gh gi og"><img src="../Images/9914c5dd23ac08b70eea6f4f9ba6fed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E6CoI_MRyZ1JInNPsBSHtA.png"/></div></a></figure><div class="oh oi gp gr oj ok"><a href="https://gitconnected.com/learn/javascript" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">学习JavaScript -最佳JavaScript教程(2019) | gitconnected</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">前65名JavaScript教程-免费学习JavaScript。课程由开发人员提交并投票，从而实现…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">gitconnected.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy kv ok"/></div></div></a></div></div></div>    
</body>
</html>