# 成长的果实:多租户的现实

> 原文：<https://levelup.gitconnected.com/like-growing-fruits-the-reality-of-multi-tenancy-672d69f0f902>

## 重新考虑 B2B SaaS 产品的核心系统架构和运营模式概念

![](img/b78c28b6f4998de8138bbe1550569aa1.png)

生于斯长于斯？(本·阿什比在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍照)

如果你曾经开发过 B2B SaaS 产品，我敢打赌，你被告知的第一件事就是[多租户](https://www.gartner.com/en/information-technology/glossary/multitenancy#:~:text=Multitenancy%20is%20a%20reference%20to,logically%20isolated%2C%20but%20physically%20integrated.)必须是你整个产品的**运营模式**。

全球最成功的[SaaS 公司](https://www.salesforce.com/)的创始人&首席执行官马克·贝尼奥夫在 2008 年说道:

> “多租户是 SaaS 供应商取得成功的必要条件”

![](img/1fa7b29b274ae435432d95faca6158e1.png)

这不是威胁，这是承诺

我想告诉你一个关于在你的花园里生产 SaaS 产品和种植水果的故事。我发现这两件事有很多共同之处。

大约在我的团队开发 SaaS B2B 产品的同时，我和我的家人正在建造我们的新房子。我们有一个种植水果的梦想。没什么大不了的，大约 10 棵树，主要是为了颜色、气味和新鲜的味道。״:孩子们会照顾״的树木，她说。

## 一棵树的力量在于它的根

多租户确实有非常坚实的基础。我记得我是如何经历 SaaS 早期的。我在一家名为[水星互动](https://www.encyclopedia.com/books/politics-and-business-magazines/mercury-interactive-corporation)的公司工作。我们构建并销售 IT 管理产品。**伟大的团队，**打造非常好的产品。生意兴隆。

像当时大多数 B2B 公司一样，部署模式是**内部部署**。我们编写大量代码，每年刻录一次光盘*、*打包，然后*、*将这些光盘运送给我们的客户，这些客户不太喜欢自己操作产品。惊人的模式，尤其是对我们来说。

![](img/44916da64f37cb2de72902d39d6b1512.png)

我们有些人家里还留着那个盒子

我不太记得 SaaS 的压力来自哪里(那时我主要忙于写糟糕的代码)，但我记得我们处理它的方式。**托管服务**。亲爱的顾客，你不喜欢我们的彩色光盘吗？你不想安装和操作我们创造的艺术品？没问题，我们会为你做的。你所要做的就是付钱给我们，然后把你的浏览器指向我们给你的网址。就在那里。SaaS。美女。

在幕后，情况并不乐观。我们有一个专门的团队在**运营托管服务**。在很早的时候，他们只是简单地获得与我们的普通客户相同的产品(但没有花哨的盒子)，他们的任务是操作服务的许多“实例”。多少？**每位顾客一张**。

![](img/249f8056137b895c10fe12ec13bee4aa.png)

多少鸡蛋？你有多少就有多少(查理+ 0.5)

无需深入了解我们产品的系统架构，我们只需说我们正在谈论 21 世纪初的**大数据**和**富客户端**应用。恐龙还生活在我们中间的时候。想象一下一个经典的三层架构，所有的数据都驻留在一个非常大并且非常好调的关系数据库中，业务逻辑和 UI 实现为一个巨大的 J2EE 应用程序，部署在运行 Windows(！idspnonenote)的 JBoss 服务器上。)。还有许多其他组件(代理、消息代理等。)，但对于本文来说，庞大的 RDBMS 和永远内存饥渴的应用服务器就足够了。

![](img/73493070adf145ba1244cab5dfbfdd58.png)

我告诉过你，如果我们吃光了，他们会给我们带来更多的羊

托管服务背后的业务案例大多是“土地和扩展”策略，或者是为小型客户服务。那时，非常大的企业客户仍然可以在他们自己的场所安装和运行我们的产品。因此，托管服务是针对 **明确定义的业务案例**的**快速** **和简单的解决方案。**

问题是，按照系统的设计方式，我们必须不断投入更多资源来保持托管服务的运转。

首先，在**基础设施资源消耗**方面，每个服务实例有一个**固定开销**。非常高的固定开销。无论客户有多小，我们仍然需要提供一个完整的数据库和一个专用的 JBoss 服务器，它占用 1GB 的内存，只是为了启动和说“hello world”。我们需要高可用性吗？所以我们需要(至少)两个。

![](img/876bf5439986077314cff53c9f331d65.png)

是的，老板，我正在看仪表盘(照片由[斯蒂芬妮·勒布朗](https://unsplash.com/@sleblanc01?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)

第二，运营此类托管服务涉及高昂的**劳动力成本**。安装、配置、监控、调整、备份、升级。**每个实例**。我们需要的团队规模随着我们操作的实例数量的增加而增加。这意味着我们的毛利润有限，业务表现更像服务业务，而不是产品业务。我想这就是他们将其命名为“*托管服务*”的原因。

回到家，发现有人需要给树浇水。我们的浇水"**托管服务"**使用一张被磁化到冰箱上的纸。列表中的列是树，行是日期。每个单元格中的值代表那棵树在那一天应该得到多少水。轮次以循环方式管理。理论上是这样。事实上，大多数时候我是一个标记所有线条的人，每棵树得到的水量不是很准确。

![](img/14cec4b73af7fe1ea82920b5d039be6f.png)

感觉像 25 升，对吧？(照片由[佩德罗·库梅尔](https://unsplash.com/@pedrokummel?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)

## 一代人种树，另一代人乘凉

解决办法？听贝尼奥夫的。**多租户**。我们能否在一个**集群**上运行所有托管客户，而不是为每个客户建立一个专用集群？我们当然可以。

怎么会？让我们从**数据库**开始:让我们添加一个“租户”表，包含我们拥有的每个客户的主数据。在所有其他表中，让我们添加一个“TenantID”字段，该字段带有一个外键约束，引用该记录所属的租户。现在我们有了一个包含所有客户数据的单一数据库模式。简单。

在应用服务器端:我们只需要**租户上下文**。从现在开始，在服务器上执行的每个请求或任务都将被绑定到这个租户上下文，并且只引用属于该租户的数据。这几乎和在每个数据库查询的 WHERE 子句中添加“AND TenantID=x”一样简单。差不多了。

**从旧的单租户系统迁移**到新的多租户系统很难，但这是一次性的努力，我们渴望停止管理如此多的独立实例，最终**成为 salesforce** 。

回到家里，所有迹象表明，除非我们改变浇水模式，否则树木将无法存活。我们请来了一位专业的园丁。他来告诉我们所有关于树的知识。他还帮助我们为所有的树安装了一个别致的自动浇水系统。别再提桶了！我们完全按照他说的做了。他是我们的贝尼奥夫，这是成功种植水果的必要条件。

![](img/f234888e3eea1542c58363f600fc4d6c.png)

站在巨人的肩膀上(由[托比亚斯·亚当](https://unsplash.com/@tobiasadam?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)

太好了。我们走出泥淖，跟随巨人，使用 SaaS(和园艺)的最佳实践。**一个大系统，服务多个客户**。

我们所有的服务器现在都连接成一个集群，固定开销大幅降低，规模经济开始发挥作用，我们突然拥有了大量可用的基础设施资源。

操作单一系统要简单得多，而且我们开始喜欢这样的事实:当系统运行时，所有客户的 **系统都会运行****。**

**甚至过去作为项目管理并需要数周时间完成的**升级**，现在只需要几个小时。我们的人在办公室打桌上足球和乒乓球(索尼 Playstation 之前也有这种东西)。**

**在国内，美丽的橙子和柠檬开始出现在我们的一些树上。我们梦想的颜色、气味和味道。**成功的滋味**其余的树还没有出现，但是我们有信心它们的出现只是时间问题。**

**![](img/b38a0d5a63bc6c5777500dfa0783923d.png)**

**如果这能让你开心，那就没那么糟糕了**

## **高大的树木能吸收大量的风**

**就在事情似乎进展顺利的时候，新的问题出现了。它始于一笔**大交易的签署**。该产品历史上最大的一笔交易。这怎么会是个问题呢？如上所述，到目前为止，您“一夜之间发明”的多租户系统只服务于小客户。账户很多，但大小都差不多，都是小到中等。大型企业客户使用本地单租户部署，在许多情况下，该部署针对其特定工作负载进行了调整和优化。但是这一大笔交易是不同的，客户签署了 7 位数的合同，因为他**想要一个 SaaS 解决方案**。**

**这并不妨碍你和车队一起庆祝这笔交易，但是出于某种原因，啤酒的味道和平时有点不同。**

**![](img/a34fc146653d91445b3ade23ca162208.png)**

**是的，我很高兴见到你(照片由[基思·马基里](https://unsplash.com/@rhino007?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

**一个月后，你终于明白为什么了。现在是星期五晚上，离季度结束还有几天。公司历史上最重要的一个季度(每个季度都是)。所有的渠道都向你发出警报。**系统宕机**，常规的 run book(= =重启一切)好像也不行。**

**一个小时后，当所有人都在“桥”上时，发现了根本原因:数据库。写操作次数是正常情况下的 3 倍，读操作次数是 4 倍，平均响应时间是正常情况下的 15 倍，错误率是正常情况下的 50 倍。查看应用服务器端的日志，您会发现连接池是如此的枯竭，以至于获得有效数据库连接的机会**就像** **芒果在您的柠檬树上生长的机会**。重新启动数据库集群和应用服务器集群似乎有所帮助，但是 5 分钟后系统又回到了相同的状态。**

**对系统实际负载的更深入分析表明 **80%的请求来自 rhino 客户**。他们打开了所有的门，现在一切都在水下。你的手机似乎是公司里唯一还能用的东西，因为每个人都在打电话:客户支持工程师、客户经理、下周要签署交易的销售代表、你的首席执行官，甚至是人力资源主管(她要求你远离 windows 和尖锐的物体)。**

**![](img/a717aade130a8f6d02fc06a0c03969a6.png)**

**是时候打电话给你的朋友格伦，征求他的意见了(由[迪伦·德·容格](https://unsplash.com/@dylandejonge?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

## **一把小斧子能砍倒一棵大树**

**非常时期需要非常手段。你从**扔** **更多的硬件**来解决问题开始。你知道这可能解决不了问题，但你还是这么做了，因为这给了你几个小时的希望。你现在处于“*愿意听任何疯狂想法的***”**状态。“*让我们开始从数据库中删除索引*”你听到有人说。*写起来会快很多*。另一个人建议“*增加速率限制，一旦超过这些限制就阻止 rhino 的请求*”。诸如此类。这些想法要么不能解决问题，要么会产生其他具有**类似商业影响**的问题。**

**在一天结束的时候，你知道你需要做什么。回到旧习惯中去。您要求您的团队安装一个单独的系统，并将 rhino 客户转移到它自己的洞穴中。没有您准备、培训或自动化的“租户迁移”过程，但是您的团队设法在几个小时内完成了。**

**你现在有了一个为 rhino 服务的系统，你正在努力稳定它(现在你可以针对 rhino 产生的工作负载类型做各种各样的事情)，还有一个让你的其他 500 个客户和平相处的系统。**

**![](img/741255e2c338368e59dfd27972c1760d.png)**

**我们甚至有一个术语——模拟转换(照片由 [Samur Isma](https://unsplash.com/@freeyorker?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

**回到家里，在我们可爱的花园里也有类似的故事。李子树看起来很糟糕。叶子是干的，果实很小。看起来这棵树需要更多的水。但是我们怎样才能给它更多的水呢？我们有一个带有单一调度程序的自动浇水系统。给李子树更多的水意味着给其他所有的树更多的水。就目前的收入水平而言，他们看起来都相当不错。解决办法？模拟转换。每天一桶…**

## ****黑暗中所有的树都是黑色的****

**我上面描述的完全虚构的系统中断场景只是一个可能的例子。在许多其他场景中，多租户的*可能会导致**您的业务出现重大问题**。***

**你可以争辩说，如果系统为多租户设计得更好，那么检测和处理危机就会容易得多，甚至可能完全避免危机的发生。虽然这是事实，但我们并不是生活在一个完美的世界，我们的系统也不是完美的。在**现实中，**重新设计整个系统以适应所有多租户最佳实践通常是不切实际的。**

**这是否意味着我们根本不应该采用多租户？不，不是的。这仅仅意味着，我们应该停止将整个系统视为一个庞大的系统，要么作为单租户运行，要么作为多租户运行。相反，让我们把这个系统看作是子域和服务的集合。别担心，这不会是另一篇关于“*打破巨石*”或“*微服务架构如何治愈癌症*”的文章(尽管我确实计划在我喝得足够醉的时候写一篇)。在做出多租户还是单租户决策的背景下，对于每个子域，最重要的方面是您处理和存储的**数据**。**

**![](img/7ef5281d802987095a9a229b3b852e94.png)**

**会不会又是一篇关于 Monolith 转微服务的文章？**

## **如果你想要苹果，你必须摇树**

**大多数 B2B 应用程序收集、接收、处理和存储数据。这里的想法是尝试按照子域和使用模式对数据进行切片。对于每个切片，我们应该分析该切片中数据的**特征，并根据这些特征决定正确的租用策略。****

**每个切片的分析可以通过回答 10 个问题来完成。我们先列出这些问题，然后用一个实例产品来阐明如何在现实中应用。以下是我们的列表:**

1.  **我们在收集和存储什么类型的数据？**
2.  **数据是如何被持久化的？**
3.  **我们期望处理和保存多少数据？**
4.  **数据的时间线分布是怎样的？**
5.  **数据的客户分布情况如何？**
6.  **我们必须将数据保留多长时间？**
7.  **数据在隐私方面是否敏感？**
8.  **在数据驻留方面有什么限制吗？**
9.  **客户是否有资格请求导出/删除他们的数据？**
10.  **我们会被要求提供多云或自托管模式吗？**

**![](img/c0665c47035ad79572705f6995039e8d.png)**

**我已经知道答案了，我只是在等你问正确的问题(图片由 [Rohit 农民](https://unsplash.com/@rohitfarmer?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

## **具体例子**

**对于我们的例子，让我们使用[托帕石](https://docplayer.net/19438928-Mercury-interactive-topaz-web-performance-management.html)，我之前描述的水星时代的产品。托帕石是一种监控产品。它扮演的角色类似于 [NewRelic](https://newrelic.com/) 、 [AppDynamics](https://www.appdynamics.com/) 和 [DataDog](https://www.datadoghq.com/) 等产品在当今市场格局中扮演的角色。价值主张是帮助公司**提高其业务应用的可用性和性能**。其实现方式是通过收集不同类型的运行状况指标、日志和跟踪，将所有这些指标纳入一个数据平台，在该平台上，它们可用于生成应用程序状态的完整视图。现在我们称之为[可观察性，而不是监控](https://medium.com/@copyconstruct/monitoring-and-observability-8417d1952e1c)，但是你必须相信我，这几乎正是托帕斯在大约 20 年前所做的。**

**就**将 Topaz 数据分割成子域**而言，最好的方法是通过收集到平台中的不同类型的健康指标。有几种类型，每一种都有自己的特点，但为了我们的目的，让我们集中于其中的两种:第一种将是**系统**监视器，第二种将是**真实用户**监视器。**

****系统监视器**提供基础设施状态的可见性。这可以是运行应用程序的服务器、网络设备(如交换机和路由器)或存储系统。典型的系统健康指标将代表特定指标的值。一个例子可以是服务器的 CPU 利用率，或者某个磁盘上有多少空闲空间。**

****Real User Monitors** (RUM)是一种性能监控类型，用于捕获和分析应用程序用户执行的事务。它用于了解用户体验，包括加载时间和不同的事务路径等指标。典型的真实用户指示器将表示用户作为流程的一部分执行的单个步骤。此类步骤的一个简单示例是将商品添加到购物车，作为电子商务应用程序中购买流程的一部分。**

**现在我们已经有了子域和数据片，我们旅程的下一阶段是回答每个数据片的 10 个问题，并使用答案来决定哪个租用模式最适合每个子域。**

**![](img/be0d2835eb6d6a37ddfe71b69cd1155a.png)**

**将问题分成几个子领域(由[阿维纳什·库马尔](https://unsplash.com/@ashishjha?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

## **1.类型**

**就**类型**和我们存储的数据格式而言，**系统监视器**的答案是特定基础设施指标的状态快照。我想我们给这个数据结构起的名字是“sample ”,它包含了度量的 id、拍摄快照的时间戳以及收集的值。漂亮*简洁紧凑*。在**真实用户监视器**端，我们存储的数据类型在结构上*更灵活，基数上*更丰富。通常有两种类型的事件:一种用于“用户会话”，另一种用于会话中的每个步骤。这两种类型往往有多个属性，每个属性可能有许多有效值，包括长文本值。**

**![](img/a9d693319e9721bae2595047afd03a48.png)**

**一个具有许多属性和高基数的实体(照片由 [Stepan Babanin](https://unsplash.com/@stepanbabanin?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

## **2.持续**

**就**而言，数据是如何持久存储的？**，当时所有问题的答案都是 RDBMS。但是，对于我们今天拥有的选项，对于**系统监视器，**我可能会选择[时间序列数据库](https://medium.com/schkn/4-best-time-series-databases-to-watch-in-2019-ef1e89a72377)或类似于 [Prometheus](https://prometheus.io/) 的东西，它们将数据存储为时间序列，而且开箱即用，具有与监视领域相关的功能(维度查询、警报等)。).时间序列数据库是高度可伸缩的，只要您让它们做自己的事情(将数据存储为时间序列)，并且不要弄乱它们对数据进行分区的方式。在**真实用户监视器**方面，我们需要一个能够支持大量维度的持久系统，我们可能还需要全文搜索(例如过滤文本输入)。我可能会去我们[弹性搜索](https://www.elastic.co/)或者和[德鲁伊](https://druid.apache.org/)一起去。在这两种情况下，这些系统确实提供了一种合理有效的方法来在某个维度(在我们的例子中是客户)上划分数据。**

**![](img/41f0d4bea4c9b6a48ec422d5830db12c.png)**

**用于分区的高开销数据库(照片由 [Kelly Neil](https://unsplash.com/@baconandbaileys?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

## **3.量**

**下一个问题，**保留了多少数据？**对于**系统显示器，**的回答是“*没那么多*”。让我们假设一个普通客户定义了 100 个系统健康监视器，每 5 分钟触发一次。这给我们每个客户每秒 0.3 个样本。如上所述，这些样本非常紧凑。在**真实用户监视器**方面，我们正在谈论一个*大得多的规模*。如果一个普通的应用程序/站点平均有 100 个并发用户，并且每个用户每 2 秒钟生成一个事件，那么我们每个客户已经有 50 个 EPS。**

**![](img/b234df9f76a3de2c03b1dccf21334c10.png)**

**当生活给了你柠檬，就做柠檬水(照片由 [Hoach Le Dinh](https://unsplash.com/@hoachld?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

## **4.时间轴分布**

**前进到**时间线分布**问题。对于**系统监视器，**我们谈论的是定期监视(“每 X 分钟运行一次”)，所以这里的答案是我们有一个*恒定速率的*传入数据来处理和保存。恒定是好的。在**真实用户监视器**端，则完全相反。这种分布与目标应用的流量直接相关，很可能*不是恒定的，而是峰值*。营业时间、特殊事件和其他外部因素会使我们的图表看起来像石油勘探公司的股票价值。**

**![](img/bea5ef63112c58c35a4723ace37368af.png)**

**巨大的工作量接踵而至(照片由 [Tim Mossholder](https://unsplash.com/@timmossholder?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

## **5.客户分布**

**就客户之间的**数据分布而言，在这两种情况下，分布都不是 100%均匀的，但是在使用**系统监视器**的情况下，小客户和大客户之间的比例大约为 1:10，而在使用**真实用户监视器**的情况下，比例可能更接近 1:100。****

**![](img/3cf965e705cd04992b7ddbe25331b27f.png)**

**顾客有不同的规模**

## **6.保留**

**下一个问题，**我们必须将数据保留多长时间？**用**系统监测到的**数据我们给出的答案是*短时间内*，大概不会超过一个月。之后的原始数据就没什么意思了。在**真实用户监视器**端，情况有所不同，我们必须将数据保留*更长的时间*(至少 12 个月)，主要用于趋势分析。**

**![](img/8cb7caec3b2b88443159a29533212a8d.png)**

**一些客户要求将他们的数据保留一段时间**

## **7.隐私**

**继续讨论**灵敏度**问题。**系统监控**数据是通常*不敏感*，即使在少数可能包含敏感数据(例如 IP 地址)的情况下，对其进行杀毒也应该相对容易。在**真实用户监视器**端，情况有所不同:数据可能*包含敏感信息*，如个人身份信息(PII)或受保护的健康信息(HIPAA)，或者一般来说，目标应用程序支持的任何输入。**

**![](img/8e39c675ec9b5cc4e60751eee7f8480c.png)**

**一些客户希望他们的数据被单独保存(图片由[威廉·费尔克](https://unsplash.com/@gndclouds?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

## **8.住所**

**下一个问题是关于数据的**驻留地**，或者说数据必须在哪里被物理地存储和处理。您可能知道，一些国家和行业对在国外存储敏感数据有限制。**系统监控**数据，因为它本质上不太敏感，更可能没有限制。在**真实用户监视器**上，由于数据是敏感的，您更有可能受到特定国家的[数据驻留法规](https://permission.io/blog/data-residency/)的限制。**

**![](img/338e7a77d9a753a5b83378f415258851.png)**

**部分数据不能出境(图片由 [mana5280](https://unsplash.com/@mana5280?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

## **9.删除**

**接下来是关于客户是否有资格要求我们**导出或删除他们的所有数据**的问题。这与数据的敏感程度和数据保留政策密切相关。更敏感且保留时间更长的数据会增加客户要求我们导出并删除其数据的可能性。这意味着对于**系统监视器**数据，我们可能不支持导出和删除，而在**真实用户监视器**端这更可能是业务需求。**

**![](img/6e294670096ebeba4d14375070dd4229.png)**

**告诉过你删除某个客户的数据会很容易**

## **10.主办；主持**

**最后但同样重要的是，我们会被要求为数据提供**多云或自托管**模式吗？答案通常与数据驻留问题密切相关，但有时它也涉及特定客户的商业方面(“我们不能在 AWS 上存储这些数据”)，这将导致我们产品的多云需求，或者只是客户法规(“这种类型的数据只能存储在本地”)，这将转化为自托管需求。在所有情况下，**系统监控**数据是*不太可能*被要求支持多云和自托管，而**真实用户监控**数据*可能肯定是。*请注意，当需求到来时，它通常来自一个巨大的机会，所以很难说不。**

**![](img/3aea4e2f7772cd6f92a1308ad4f339f3.png)**

**当然，它可以托管在任何云上(照片由[约翰·福勒](https://unsplash.com/@wildhoney?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

## **那么每个服务的正确选择是什么呢？**

**多租户应该是默认选项。只有当某些问题的答案让您觉得多租户可能会带来问题时，您才应该考虑单租户途径吗？为了更加直观，让我们尝试为每个因素附加一个“多租户就绪性”评级:**

**![](img/13103b09ed0f86beaafa9c8bd6f87180.png)**

**多租户就绪**

**那么我们得到了什么？在一列中，我们有**系统监视器**数据，其中大多数指标看起来像是**多租户**的经典用例。在另一栏，对于**真实用户监视器**服务，结果是不同的。看一下所有 10 个答案的组合，我会选择该服务的单租户。**

## **单租房真的更贵吗？**

**简短的回答是，它可能更贵，但也可能更便宜。这实际上取决于我们将在单租户服务中使用的**系统架构**和**技术堆栈**。**

**是的，为特定服务的每个客户配置一个 Oracle 数据库和一个 J2EE 集群(在一个微服务架构中，我们可能有数百个不同的服务)将非常昂贵。不合理的昂贵。但是，如果我们的数据库不是 Oracle，而是类似于 Elasticsearch 或 MongoDB(或任何其他对每个独立数据集具有低开销的持久性系统)的东西，那该怎么办呢？如果我们的应用服务器是用低开销的技术栈实现的呢？这可能是 docker 容器运行的应用程序，在 Go，Rust 甚至上帝原谅我 NodeJS 中实现。更好的是，如果您用无服务器的架构实现您的服务器端业务逻辑[会怎么样？](https://narrativescience.com/resource/blog/how-aws-lambda-changed-the-game-of-multi-tenancy/)**

**![](img/46af4db56bfdc6b827c147d9cd6b5e44.png)**

**无服务器？(照片由[内森·宾格尔](https://unsplash.com/@nathangbingle?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)**

**这里的关键因素是**弹性**。如果我们同意，无论如何，我们的基础架构需要具有弹性(意味着**根据工作负载自动扩展**)，并且如果我们的技术堆栈具有如上所述的低开销，那么实际上我们的基础架构**成本**将是相似的，无论我们是使用多租户还是单租户作为我们的运营模式。**

**但是我听到你说“基础设施成本只是一个因素，那么与操作系统相关的**劳动力成本**呢？”。这里的现实是非常令人惊讶和反直觉的。我相信，如果我们在定义系统架构和构建 CI/CD 管道方面做得很好，那么与在单租户模式下运营服务相关的总人工成本会比在多租户模式下低。这样做的主要原因是**降低了许多运营流程的复杂性和风险**。无论采用何种租赁模式，我们都需要实现自动化的流程，但采用单一租赁模式时，构建和维护更简单，执行风险更低。**

**![](img/0e2adfa3663f24d5ee3eecbbc10d3bf1.png)**

**有时候好事发生在倒霉的时候**

## **结论:**

**对于我们的 B2B SaaS 应用程序来说，多租户是一个很好的 **架构选择**，花园中果树的中央灌溉系统也是如此。但是有时我们的产品中有一些特定的领域需要复杂的系统功能来在多租户架构中实现。**

**在基于服务的架构中，产品中的一些服务以**单租户**模式设计和运营并没有错。只要我们有良好的服务边界，这对于应用程序中的其他服务应该是**透明的**，并使我们能够与重要的业务需求保持一致。**

**混合多租户和单租户是“*为工作选择合适的工具*”的又一个例子。这是将我们在教科书中读到的伟大理论应用到构建伟大产品的现实中的一个关键概念。在某种程度上，这就是为什么我们在花园里种植的水果比我们在超市里能买到的更好。**