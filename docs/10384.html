<html>
<head>
<title>Pytorch LSTM Example — Time Series Forecasting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pytorch LSTM示例—时间序列预测</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/forecasting-walmart-quarterly-revenue-pytorch-lstm-example-b4e4b20862a7?source=collection_archive---------3-----------------------#2021-11-30">https://levelup.gitconnected.com/forecasting-walmart-quarterly-revenue-pytorch-lstm-example-b4e4b20862a7?source=collection_archive---------3-----------------------#2021-11-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="92f9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">应用LSTM网络预测时间序列数据</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/dbf8eece4c82e8d1d45012c4e54d5604.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XFC0jxggDEU_mT04krNJUw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</figcaption></figure><p id="efcf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇文章中，我将使用PyTorch应用一个长短期记忆(LSTM)网络来预测未来多个时间段的时间序列。正如我们在上面的图表中看到的，许多时间序列显示出季节性趋势。例如，一家公司的销售额可能会在每年的假日季节激增。这是许多零售商的特点，从大公司到你当地的周日市场，他们的销售因圣诞节而增加。</p><p id="650f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">传统模型很难发现这些季节性趋势，但是LSTMs已经很好地处理了这类问题。模型本身将是非常基本的；我们将使用前面的十六个季度值来预测后面的八个季度值。因此，我们本质上是在处理一个时间序列预测问题。</p><h2 id="635c" class="lu lv it bd lw lx ly dn lz ma mb dp mc lh md me mf ll mg mh mi lp mj mk ml mm bi translated">数据</h2><p id="8789" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">该数据是任何季节性时间序列数据的特征，具有某些重复模式。数据和代码都可以在我的Github <a class="ae ms" href="https://github.com/rian-dolphin/Walmart_LSTM" rel="noopener ugc nofollow" target="_blank">这里</a>找到。本文中使用的收入数据是公开的，每个上市公司都可以通过其法律要求的公司文件获得，这些数据可以从<a class="ae ms" href="https://stock.walmart.com/investors/financial-information/quarterly-results/default.aspx" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/968b3a94c06b7f1d9d733eebb6aa4726.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oxz0dA5jqXA-674SUqKyfQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</figcaption></figure><p id="ae9f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如我们所看到的，数据中有一个清晰的模式。最引人注目的是，每四个数据点就有一个大的峰值，对应于假日季节，许多零售商都经历了销售额的增长。希望我们的LSTM模型能够捕捉到季节模式，以及其他模式，如总体趋势。</p><p id="f2c1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面的代码用于读入数据并确保索引是DateTime格式的。数据是按时间顺序倒过来的，所以我把它倒过来了。此外，只使用了截至2019年底的数据，因为疫情破坏了数据中良好的季节模式！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h2 id="07fe" class="lu lv it bd lw lx ly dn lz ma mb dp mc lh md me mf ll mg mh mi lp mj mk ml mm bi translated">为我们的模型准备数据</h2><p id="d003" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">如前所述，我们将简单地使用前面的十六个季度值来预测后面的八个季度值。首先，我将过去八个季度作为训练集，我们可以用它来公平地比较预测。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="bf27" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，我调整了训练数据以提高模型性能。通过使用sklearn的MinMaxScaler，当我们希望将预测转换回原始单位(在我们的例子中是十亿美元)时，我们可以很容易地应用反向转换💵</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="d44c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，让我们将缩放后的训练数据转换为Pytorch FloatTensor，以便它稍后与我们的模型兼容。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="7f60" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了训练我们的模型，我们需要从训练数据中创建<em class="mw"> (x，y) </em>对，其中<em class="mw"> x </em>是长度为16的序列，<em class="mw"> y </em>是要预测的长度为8的序列。我们在这里注意到，【T6(x，y)】对意味着<em class="mw"> y </em>序列包含紧跟在<em class="mw"> x </em>序列之后的八个值。这很重要，因为我们希望在预测接下来的八个季度值时使用最新的数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="3a02" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们有了<em class="mw"> (x，y) </em>对，我们可以定义我们的LSTM模型并开始训练了！🏃‍♂️</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="4815" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们定义的模型将接受三个输入:</p><ol class=""><li id="e420" class="mx my it la b lb lc le lf lh mz ll na lp nb lt nc nd ne nf bi translated"><em class="mw">input _ size</em>-该输入表示我们在模型中使用的预测要素的数量。在我们的例子中，我们只使用一个特性，过去的收入。值得注意的是，尽管我们使用了一系列收入值，但它仍然只是一个特性，因此<em class="mw"> input_size </em>为1。</li><li id="25ec" class="mx my it la b lb ng le nh lh ni ll nj lp nk lt nc nd ne nf bi translated"><em class="mw"> hidden_size — </em>该输入将决定LSTM模型中隐藏状态和单元格状态的维度(参见<a class="ae ms" href="https://towardsdatascience.com/lstm-networks-a-detailed-explanation-8fae6aefc7f9" rel="noopener" target="_blank">此处</a>了解更多相关信息)。</li><li id="cb96" class="mx my it la b lb ng le nh lh ni ll nj lp nk lt nc nd ne nf bi translated"><em class="mw">output _ size—</em>py torch LSTM的输出是隐藏状态和单元格状态的组合，为了将它们转换成我们想要的格式，我们必须使用线性层。<em class="mw"> output_size </em>将告诉我们的模型我们想要从线性层得到的输出数量(在我们的例子中是8)。</li></ol><p id="8a17" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们定义的模型将给出两个输出:</p><ol class=""><li id="e6f3" class="mx my it la b lb lc le lf lh mz ll na lp nb lt nc nd ne nf bi translated">首先，该模型将输出长度为8的序列，其中包含对未来八个季度收入的预测。</li><li id="8db3" class="mx my it la b lb ng le nh lh ni ll nj lp nk lt nc nd ne nf bi translated">其次，它将输出<em class="mw"> self.hidden </em> —这是一个包含两个元素的元组。第一个元素是一个张量，包含计算出的最终隐藏状态。第二个元素是包含单元状态的<em class="mw">最新版本的张量。就我们的目的而言，我们不需要它们，但是如果您希望在保留先前上下文的同时进行进一步的预测，它会很有用。</em></li></ol><p id="7b88" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">定义了模型类之后，我们现在需要初始化该类的一个实例，并决定使用哪个标准和优化器。由于我们在这里处理的是连续输出，我们可以使用均方误差(MSE)作为我们的损失函数。优化器的工作是调整网络的权重和偏差。我选择使用Adam优化器，它只是随机梯度下降的一个替代方案。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h2 id="0a78" class="lu lv it bd lw lx ly dn lz ma mb dp mc lh md me mf ll mg mh mi lp mj mk ml mm bi translated">培养</h2><p id="d278" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">既然我们已经建立了模型，我们可以开始训练了。这发生在以下步骤中:</p><ol class=""><li id="eb7a" class="mx my it la b lb lc le lf lh mz ll na lp nb lt nc nd ne nf bi translated">定义时期数-时期数是一个超参数，表示训练过程将使用整个数据集的次数。决定使用多少个历元并不是一门精确的科学。一个有用的指标是以一定的时间间隔观察损失，并在损失不再减少时识别出来。选择太多的历元会导致训练数据过拟合。</li><li id="f478" class="mx my it la b lb ng le nh lh ni ll nj lp nk lt nc nd ne nf bi translated">对于每个历元中的每个<em class="mw"> (x，y) </em>对，我们首先计算预测的<strong class="la iu"><em class="mw">【ŷ</em></strong><em class="mw"/>序列。</li><li id="716c" class="mx my it la b lb ng le nh lh ni ll nj lp nk lt nc nd ne nf bi translated">接下来，我们计算<em class="mw"> ŷ </em>和真实值<em class="mw"> y. </em>之间的<strong class="la iu">损失</strong> (MSE)</li><li id="5b87" class="mx my it la b lb ng le nh lh ni ll nj lp nk lt nc nd ne nf bi translated">然后我们使用Pytorch <em class="mw">计算神经网络中参数的<strong class="la iu">梯度</strong>。</em>功能向后()。</li><li id="7e73" class="mx my it la b lb ng le nh lh ni ll nj lp nk lt nc nd ne nf bi translated">计算出梯度后，最后一步是相应地更新参数。这是使用Pytorch的<em class="mw"> optimizer.step() </em>函数完成的。</li><li id="03e1" class="mx my it la b lb ng le nh lh ni ll nj lp nk lt nc nd ne nf bi translated">重复上述步骤，直到达到指定的次数。</li></ol><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mu mv l"/></div></figure><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="63bd" class="lu lv it nm b gy nq nr l ns nt">------- Output -------</span><span id="153f" class="lu lv it nm b gy nu nr l ns nt">epoch:    0 loss:0.34732404<br/>epoch:  100 loss:0.00491276<br/>epoch:  200 loss:0.00099649<br/>epoch:  300 loss:0.00120929<br/>epoch:  400 loss:0.00043398<br/>epoch:  500 loss:0.00050389<br/>epoch:  600 loss:0.00022331</span></pre><h2 id="1239" class="lu lv it bd lw lx ly dn lz ma mb dp mc lh md me mf ll mg mh mi lp mj mk ml mm bi translated">做预测</h2><p id="bc30" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">训练好我们的模型后，让我们看看我们做得怎么样！我们希望使用2014-2017年发布的十六个值来预测2018-2019年发布的八个季度收入。</p><p id="d21f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因为我们在训练之前调整了数据，所以我们需要下面的最后一行代码将输出转换回我们最初的十亿美元单位。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="802c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们有了预测值，我们可以将它们与真实值进行对比，看看我们的LSTM模型是否能够捕捉到公司收入的趋势。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mu mv l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/95b91858cd355840eb9817f7a91a4413.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FNzF08qK4-U5K3m5lJL3Sw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</figcaption></figure><p id="0ee9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过比较红线和蓝色虚线，我们可以看到，该模型肯定会考虑数据的季节性趋势。预测值比预期值低了一点。然而，纵观前几年，我们可以看到，预测是完全合理的。</p><h2 id="8a40" class="lu lv it bd lw lx ly dn lz ma mb dp mc lh md me mf ll mg mh mi lp mj mk ml mm bi translated">结论</h2><p id="b557" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">对于那些走到这一步的人，我希望你学到了一些东西！如果你有任何想法或问题，请在下面评论。这个项目完整的Jupyter笔记本可以在我的Github <a class="ae ms" href="https://github.com/rian-dolphin/Walmart_LSTM" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">这里</strong> </a>找到。🪐</p><p id="c792" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要深入了解LSTM网络如何运作，请查看我的另一篇文章👇</p><div class="nw nx gp gr ny nz"><a href="https://towardsdatascience.com/lstm-networks-a-detailed-explanation-8fae6aefc7f9" rel="noopener follow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">LSTM网络|详细解释</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">LSTMs的全面介绍</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">towardsdatascience.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on ks nz"/></div></div></a></div></div><div class="ab cl oo op hx oq" role="separator"><span class="or bw bk os ot ou"/><span class="or bw bk os ot ou"/><span class="or bw bk os ot"/></div><div class="im in io ip iq"><div class="kj kk kl km gt nz"><a href="https://medium.com/@riandolphin/membership" rel="noopener follow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">加入我的推荐链接-海豚</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">medium.com</p></div></div><div class="oi l"><div class="ov l ok ol om oi on ks nz"/></div></div></a></div></div></div>    
</body>
</html>