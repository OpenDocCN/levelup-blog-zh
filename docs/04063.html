<html>
<head>
<title>Setting up GraphQL API with MongoDB and Apollo Server for a NextJS app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用MongoDB和Apollo Server为NextJS应用程序设置GraphQL API</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/setting-up-graphql-api-with-mongodb-and-apollo-server-for-a-nextjs-app-cec7a9baedbf?source=collection_archive---------6-----------------------#2020-06-08">https://levelup.gitconnected.com/setting-up-graphql-api-with-mongodb-and-apollo-server-for-a-nextjs-app-cec7a9baedbf?source=collection_archive---------6-----------------------#2020-06-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9469" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近，我对使用服务器端渲染(SSR)应用程序的<a class="ae kl" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank">next . js</a>T5】React框架产生了兴趣。我越来越多地将Next用于我喜欢的项目。我惊讶于使用NextJS是如此直观、简单和愉快。</p><p id="4e7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将为NextJS应用程序设置带有<a class="ae kl" href="https://www.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>连接的<a class="ae kl" href="https://graphql.org/" rel="noopener ugc nofollow" target="_blank"> GraphQL </a> API。令我惊讶的是，NextJS和Apollo GraphQL示例都缺少MongoDB的这种通用用例。有一些使用PostgreSQL的例子，但是我想使用一个非SQL数据库。在花了一些时间学习和阅读之后，我整理了这个分步指南，介绍如何将Apollo服务器GraphQL API连接到MongoDB，以及如何在GraphQL解析器中读取/写入数据到Mongo数据库。</p><h1 id="3ce6" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">初始化NextJS默认应用程序</h1><p id="ca50" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">通过<a class="ae kl" href="https://nextjs.org/docs/getting-started#setup" rel="noopener ugc nofollow" target="_blank"> create-next-app </a>使用Next初始化项目有多种方式，类似于<code class="fe lp lq lr ls b">create-react-app</code>或<a class="ae kl" href="https://nextjs.org/docs/getting-started#setup" rel="noopener ugc nofollow" target="_blank">手动</a>。</p><p id="6503" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个例子中，我将使用带纱线的<code class="fe lp lq lr ls b">create-next-app</code>(或者，你可以使用NPM ):</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="d933" class="mb kn iq ls b gy mc md l me mf">yarn create next-app graphql-apollo-mongodb</span></pre><p id="141e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">选择模板默认入门应用</p><p id="0fe4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装依赖项后:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="3204" class="mb kn iq ls b gy mc md l me mf">cd graphql-apollo-mongodb<br/>yarn dev</span></pre><p id="d542" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">酷！我们的NextJS应用运行在<code class="fe lp lq lr ls b"><a class="ae kl" href="http://localhost:3000." rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a></code> <a class="ae kl" href="http://localhost:3000." rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="e69f" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">设置MongoDB Atlas</h1><blockquote class="mg mh mi"><p id="39c5" class="jn jo mj jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated"><em class="iq"> MongoDB Atlas是面向现代应用的全球云数据库服务。跨AWS、Azure或GCP部署完全托管的MongoDB。一流的自动化和成熟的实践保证了可用性、可扩展性，并符合最苛刻的数据安全性和隐私标准。使用MongoDB强大的驱动程序、集成和工具生态系统，以更快的速度构建和更少的时间管理您的数据库。</em></p></blockquote><p id="18ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将使用cloud Mongo数据库的一个实例。</p><ol class=""><li id="c0a3" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk ms mt mu mv bi translated">导航到<a class="ae kl" href="https://www.mongodb.com/cloud/atlas" rel="noopener ugc nofollow" target="_blank"> MongoDB Atlas </a>页面</li><li id="e605" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">点击“免费开始”,注册MongoDB账户</li><li id="b099" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">在“项目”页面上，单击“新建项目”,为其命名并创建</li><li id="ae42" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">添加成员。你已经是会员了-&gt;点击继续</li><li id="0025" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">构建集群-&gt;选择空闲层</li><li id="5022" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">选择云提供商和地区并创建集群</li></ol><figure class="lt lu lv lw gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nb"><img src="../Images/b8a1372120035d5f22d250a53413f5ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zE_LUMwvdD9aC-yM.png"/></div></div></figure><p id="9efa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.集群初始化后，单击“connect”</p><figure class="lt lu lv lw gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nb"><img src="../Images/9ad854e711e198a49819dabd7ea2a0f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MQ1rpldycYazblxn.png"/></div></div></figure><p id="f01e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">选择连接方法-&gt;选择连接您的应用程序并选择Node.js</p><ul class=""><li id="8b83" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk nj mt mu mv bi translated">将连接字符串添加到应用程序代码中</li><li id="3335" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk nj mt mu mv bi translated">复制并保存您的应用程序字符串</li></ul><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="79fa" class="mb kn iq ls b gy mc md l me mf">"mongodb+srv://&lt;dbname&gt;:&lt;password&gt;@cluster0-yvwjx.mongodb.net/&lt;dbname&gt;?retryWrites=true&amp;w=majority"</span></pre><p id="8ed2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很好。我们有一个指向云数据库实例的URL，可以从我们的代码连接到这个实例，但是我们还没有一个数据库。让我们创建一个新的数据库。</p><p id="d445" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8.导航至集合选项卡，然后单击添加我自己的数据</p><figure class="lt lu lv lw gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nb"><img src="../Images/6bd3e37e32b577546577cada45265f5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B1fWroBXMQDGbBl-.png"/></div></div></figure><figure class="lt lu lv lw gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nk"><img src="../Images/3e284d6957be1a0dcb3604f7da4a57e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kffIg39MxCvnlcwf.png"/></div></div></figure><p id="a8f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置完成后，您应该看到您的集群正在运行:</p><figure class="lt lu lv lw gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nb"><img src="../Images/4f04be61c5a8c589d86fb8849ffc265e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Y-wQFMkKJBzu8JYD.png"/></div></div></figure><p id="6fe9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以手动或通过代码执行将一些文档/数据插入我们的数据库。我们到此为止。</p><h1 id="a1ad" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">使用Apollo服务器设置GraphQL API</h1><p id="475a" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">现在我们的应用程序中没有任何graphql设置。当我们导航到<code class="fe lp lq lr ls b">http://localhost:3000/api/hello</code>时，我们会看到</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="922d" class="mb kn iq ls b gy mc md l me mf">{ "name": "John Doe" }</span></pre><p id="984c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从<code class="fe lp lq lr ls b">pages/api/hello.js</code>文件提供的输出。</p><p id="4ad5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要的是在<code class="fe lp lq lr ls b">pages/api/graphql.js</code>下创建一个新的端点，这就是我们的Apollo Server GraphQL设置的位置。从<code class="fe lp lq lr ls b"><a class="ae kl" href="http://localhost:3000/api/graphql." rel="noopener ugc nofollow" target="_blank">http://localhost:3000/api/graphql</a></code> <a class="ae kl" href="http://localhost:3000/api/graphql." rel="noopener ugc nofollow" target="_blank">调用GraphQL API。</a></p><h1 id="4392" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">安装Apollo-server-micro graph QL MongoDB</h1><p id="dba5" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">让我们安装Apollo服务器设置所需的软件包</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="27ec" class="mb kn iq ls b gy mc md l me mf">yarn add apollo-server-micro graphql mongodb</span></pre><h1 id="0172" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">创建一个基本的GraphQL服务器</h1><p id="26ce" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在<code class="fe lp lq lr ls b">pages/api/</code>下添加<code class="fe lp lq lr ls b">graphql.js</code>文件。</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="513f" class="mb kn iq ls b gy mc md l me mf">// pages/api/graphql.js<br/>import { ApolloServer, gql } from 'apollo-server-micro'<br/><br/>const typeDefs = gql`<br/>  type Query {<br/>    sayHello: String<br/>  }<br/>`<br/><br/>const resolvers = {<br/>  Query: {<br/>    sayHello(parent, args, context) {<br/>      return 'Hello World!'<br/>    },<br/>  },<br/>}<br/><br/>export const config = {<br/>  api: {<br/>    bodyParser: false,<br/>  },<br/>}<br/><br/>const apolloServer = new ApolloServer({ typeDefs, resolvers })<br/>export default apolloServer.createHandler({ path: '/api/graphql' })</span></pre><p id="e8a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们创建了ApolloServer的一个新实例，将我们的类型定义和解析器传递给它，并在<code class="fe lp lq lr ls b">/api/graphql</code>路径上服务这个graphql。</p><p id="1102" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您导航到<code class="fe lp lq lr ls b">http://localhost:3000/api/graphql</code>时，您应该会看到一个GraphQL游乐场，在这里您可以执行变异/查询。</p><figure class="lt lu lv lw gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nb"><img src="../Images/0d977bc6fd250e29c1875690d0565f72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2SzGw-xX22e4klMH.png"/></div></div></figure><p id="6b85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这很好，但我们的API目前没有做太多。它只是为了测试而建造的。让我们添加一个MongoDB连接。</p><h1 id="95d2" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">向我们的Apollo服务器添加MongoDB连接</h1><p id="4c45" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在添加MongoDB连接之前，让我们先讨论一下数据。出于示例目的，我们的应用程序将显示来自MongoDB的用户列表。</p><p id="8e01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是我的数据表示:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="d5f1" class="mb kn iq ls b gy mc md l me mf">{<br/>  "users": [<br/>    {<br/>      "id": 1,<br/>      "firstName": "Alexander",<br/>      "lastName": "Grischuk",<br/>      "blog": "<a class="ae kl" href="https://grischuk.de/" rel="noopener ugc nofollow" target="_blank">https://grischuk.de/</a>",<br/>      "stars": 5<br/>    },<br/>    {<br/>      "id": 2,<br/>      "firstName": "Max",<br/>      "lastName": "Mustermann",<br/>      "blog": "mustermann.de",<br/>      "stars": 3<br/>    }<br/>  ]<br/>}</span></pre><p id="475f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将手动将其插入MongoDB:</p><figure class="lt lu lv lw gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nb"><img src="../Images/14278931c477c46444f270469ed52591.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9WZqd50GNwrbNe6Y.png"/></div></div></figure><figure class="lt lu lv lw gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nl"><img src="../Images/be2969cc4f646cb461315dfdc88ce343.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v78_wumzeFVROYkK.png"/></div></div></figure><h1 id="ca0b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">创建可执行模式并将mongo客户端连接到数据库</h1><p id="88d9" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">Graphql模式是<code class="fe lp lq lr ls b">typeDefs</code>和<code class="fe lp lq lr ls b">resolvers</code>的组合。</p><p id="d583" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要使模式可执行，我们需要安装<code class="fe lp lq lr ls b">graphql-tools</code></p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="7bb6" class="mb kn iq ls b gy mc md l me mf">yarn add graphql-tools</span></pre><p id="7e27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们在<code class="fe lp lq lr ls b">typeDefs</code>和<code class="fe lp lq lr ls b">resolvers</code>中描述一个数据查询。我们想从MongoDB中查询一个用户列表。</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="44f5" class="mb kn iq ls b gy mc md l me mf">// pages/api/graphql.js<br/>import { ApolloServer, gql } from 'apollo-server-micro'<br/>import { makeExecutableSchema } from 'graphql-tools'<br/>import { MongoClient } from 'mongodb'<br/><br/>const typeDefs = gql`<br/>  type User {<br/>    id: ID!<br/>    firstName: String!<br/>    lastName: String!<br/>    blog: String<br/>    stars: Int<br/>  }<br/><br/>  type Query {<br/>    users: [User]!<br/>  }<br/>`<br/><br/>const resolvers = {<br/>  Query: {<br/>    users(_parent, _args, _context, _info) {<br/>      return _context.db<br/>        .collection('users')<br/>        .findOne()<br/>        .then((data) =&gt; {<br/>          return data.users<br/>        })<br/>    },<br/>  },<br/>}<br/><br/>const schema = makeExecutableSchema({<br/>  typeDefs,<br/>  resolvers,<br/>})<br/><br/>let db<br/><br/>const apolloServer = new ApolloServer({<br/>  schema,<br/>  context: async () =&gt; {<br/>    if (!db) {<br/>      try {<br/>        const dbClient = new MongoClient(<br/>          'mongodb+srv://&lt;dbname&gt;:&lt;password&gt;@cluster0-yvwjx.mongodb.net/next-graphql?retryWrites=true&amp;w=majority',<br/>          {<br/>            useNewUrlParser: true,<br/>            useUnifiedTopology: true,<br/>          }<br/>        )<br/><br/>        if (!dbClient.isConnected()) await dbClient.connect()<br/>        db = dbClient.db('next-graphql') // database name<br/>      } catch (e) {<br/>        console.log('---&gt;error while connecting with graphql context (db)', e)<br/>      }<br/>    }<br/><br/>    return { db }<br/>  },<br/>})<br/><br/>export const config = {<br/>  api: {<br/>    bodyParser: false,<br/>  },<br/>}<br/><br/>export default apolloServer.createHandler({ path: '/api/graphql' })</span></pre><h1 id="876f" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">正在配置。环境变量</h1><p id="b186" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">为了安全和部署方便，不建议将您的MongoDB URI直接签入git。我们将通过环境变量访问Mongodb URI，并从那里提取它。</p><p id="878f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，安装<code class="fe lp lq lr ls b">dotenv</code> npm包</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="2715" class="mb kn iq ls b gy mc md l me mf">yarn add dotenv</span></pre><p id="e0f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用你的<code class="fe lp lq lr ls b">MONGO_DB_URI</code>在项目根目录下创建<code class="fe lp lq lr ls b">.env</code>文件</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="d2cc" class="mb kn iq ls b gy mc md l me mf">MONGO_DB_URI=mongodb+srv://&lt;dbname&gt;:&lt;password&gt;@cluster0-yvwjx.mongodb.net/next-graphql?retryWrites= true&amp;w=majority</span></pre><p id="317d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用。代码中的env:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="52a2" class="mb kn iq ls b gy mc md l me mf">// pages/api/graphql.js<br/>import { ApolloServer, gql } from 'apollo-server-micro'<br/>import { makeExecutableSchema } from 'graphql-tools'<br/>import { MongoClient } from 'mongodb'<br/><br/>require('dotenv').config()<br/><br/>const typeDefs = gql`<br/>  type User {<br/>    id: ID!<br/>    firstName: String!<br/>    lastName: String!<br/>    blog: String<br/>    stars: Int<br/>  }<br/><br/>  type Query {<br/>    users: [User]!<br/>  }<br/>`<br/><br/>const resolvers = {<br/>  Query: {<br/>    users(_parent, _args, _context, _info) {<br/>      return _context.db<br/>        .collection('users')<br/>        .findOne()<br/>        .then((data) =&gt; {<br/>          return data.users<br/>        })<br/>    },<br/>  },<br/>}<br/><br/>const schema = makeExecutableSchema({<br/>  typeDefs,<br/>  resolvers,<br/>})<br/><br/>let db<br/><br/>const apolloServer = new ApolloServer({<br/>  schema,<br/>  context: async () =&gt; {<br/>    if (!db) {<br/>      try {<br/>        const dbClient = new MongoClient(process.env.MONGO_DB_URI, {<br/>          useNewUrlParser: true,<br/>          useUnifiedTopology: true,<br/>        })<br/><br/>        if (!dbClient.isConnected()) await dbClient.connect()<br/>        db = dbClient.db('next-graphql') // database name<br/>      } catch (e) {<br/>        console.log('---&gt;error while connecting via graphql context (db)', e)<br/>      }<br/>    }<br/><br/>    return { db }<br/>  },<br/>})<br/><br/>export const config = {<br/>  api: {<br/>    bodyParser: false,<br/>  },<br/>}<br/><br/>export default apolloServer.createHandler({ path: '/api/graphql' })</span></pre><h1 id="5ec8" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">在GraphQL Playground中使用MongoDB连接测试GraphQL API</h1><p id="58fb" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">导航至<code class="fe lp lq lr ls b">http://localhost:3000/api/graphql</code>并进行查询</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="ae9d" class="mb kn iq ls b gy mc md l me mf">{<br/>  users {<br/>    id<br/>    firstName<br/>  }<br/>}</span></pre><p id="be36" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">来自MongoDB连接的查询结果:</p><figure class="lt lu lv lw gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nb"><img src="../Images/b45108510a5dd06efa1f66b830b6d0cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dSAimdCO9XvE6Gvh.png"/></div></div></figure><p id="83b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们的MongoClient设置中，我们通过MongoDB cloud使用<code class="fe lp lq lr ls b">new MongoClient()</code>初始化一个新的数据库连接，URI从我们的<code class="fe lp lq lr ls b">.env</code>文件中读取。我们从上下文函数中返回db对象<code class="fe lp lq lr ls b">{ db }</code>，以便通过解析器中的<code class="fe lp lq lr ls b">_context</code>进行访问。就是这样！一旦您可以访问解析器中的数据库，您就可以在那里为您的查询和变异执行读/写操作。</p><h1 id="8d88" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">graph QL-Apollo-MongoDB-示例</h1><p id="78a9" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我为本文创建了一个支持性的<a class="ae kl" href="https://github.com/alexandr-g/graphql-apollo-mongodb-example" rel="noopener ugc nofollow" target="_blank">存储库</a>，这样您就可以一个接一个地提交了。</p></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><p id="d81f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mj">原载于2020年6月8日https://grischuk.de/</em><a class="ae kl" href="https://grischuk.de/posts/setting-up-graphql-api-with-mongodb-and-apollo-server" rel="noopener ugc nofollow" target="_blank"/><em class="mj">。</em></p></div></div>    
</body>
</html>