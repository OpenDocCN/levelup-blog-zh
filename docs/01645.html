<html>
<head>
<title>Kubernetes Cluster Upgrade — Slow Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes集群升级—慢速指南</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/kubernetes-cluster-upgrade-slow-guide-b3e76c5f082a?source=collection_archive---------3-----------------------#2020-01-19">https://levelup.gitconnected.com/kubernetes-cluster-upgrade-slow-guide-b3e76c5f082a?source=collection_archive---------3-----------------------#2020-01-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="712d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">详细介绍如何更新到最新的Kubernetes版本1.25.0的简单指南</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/a56d29689c9666c7370b62543ceb3fd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6vuuN7jqoGqNtKS5"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">照片由<a class="ae le" href="https://unsplash.com/@diegitane?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">迭戈·费尔南德斯</a>在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="7334" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">升级Kubernetes集群比使用包管理器进行典型的更新需要更多的工作，但是它非常简单，可以很快完成。在本指南中，我将详细介绍所需的步骤，并附有每个步骤的截图。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="052f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意:和往常一样，在继续之前，请确保您有一个备份，事情总是有可能因为各种原因而偏离正轨。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="6c38" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我最近注意到有一个新版本的Kubernetes v1.25.0可用，是时候从我当前的版本v1.20.2获得最新和最棒的版本并进行升级了。我想利用这个机会详细描述升级所需的步骤。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lm"><img src="../Images/066a73614ef62bfd11a458d2cf82b0af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OadQoIK4wzUiMZcZPuSwNw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">有新的更新</figcaption></figure><p id="5c70" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先让我们运行<code class="fe ln lo lp lq b">sudo apt list --upgradable</code>看看还有什么可以更新。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lr"><img src="../Images/55b06e649ed851b189328dd4e4de1c89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X-diaVDDJZLbJcdvNQyKuw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">可用于更新的所有软件包的列表</figcaption></figure><p id="5cef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以更新除Kubernetes之外的所有内容，因此为了阻止Kubernetes包，我们将运行:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="81e9" class="lw lx it lq b gy ly lz l ma mb">sudo apt-mark hold kubeadm kubectl kubelet</span></pre><p id="b536" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们可以通过运行以下命令来更新所有其他内容:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="2e74" class="lw lx it lq b gy ly lz l ma mb">sudo apt update<br/>sudo apt upgrade</span></pre><p id="b280" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你会注意到Kubernetes包，已被扣留，他们将被排除在升级。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lm"><img src="../Images/05db06f46929f5c4119a7a03640bdc26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dl841mpHZblwIQeQ5neQ9w.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Kubernetes软件包被保留</figcaption></figure><p id="3f90" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，随着其他包的方式，我们可以专注于Kubernetes。在这个特定的示例中，我们将Kubernetes从1.20.2版升级到1.25.0版。为了查看我们需要做什么，我们可以运行:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="19cf" class="lw lx it lq b gy ly lz l ma mb">sudo kubeadm upgrade plan</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mc"><img src="../Images/00e9babf478f052c3f997ae51eab8ef2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*utoUBp1LB4Ebbq3xA96EvA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">“kubeadm升级计划”命令的结果</figcaption></figure><p id="9dbd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据前面命令的输出，我们需要首先将kubeadm升级到v.1.20.15。因为最新版本比当前版本更新，我们需要首先升级到1.20.15。</p><p id="7e00" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要确认这是可用于更新的最新版本，让我们运行:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="f9b0" class="lw lx it lq b gy ly lz l ma mb">apt-cache madison kubeadm | head</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lr"><img src="../Images/08f3ab02c394686c243d51face468b61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oXEIULXTLU74Qs4D53jPLQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">repo中可用的kubeadm最新版本列表</figcaption></figure><p id="d9a3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最新版本确实是1.25.0，但我们需要先升级到1.20.15，所以我们先用以下命令清空主节点:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="7f68" class="lw lx it lq b gy ly lz l ma mb">kubectl drain k8-m1 --ignore-daemonsets</span></pre><p id="bc05" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们现在可以指定我们想要升级到的kubeadm版本，并使用<code class="fe ln lo lp lq b">--allow-change-held-packages</code>标志升级我们持有的包。</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="9c86" class="lw lx it lq b gy ly lz l ma mb">sudo apt-get update<br/>sudo apt-get install --allow-change-held-packages kubeadm=1.20.15-00</span></pre><p id="e2ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当我们运行<code class="fe ln lo lp lq b">sudo kubeadm upgrade plan</code>时，我们得到的下一步是用kubeadm工具应用升级:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="1349" class="lw lx it lq b gy ly lz l ma mb">sudo kubeadm upgrade apply v1.20.15</span></pre><p id="e404" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这一步将持续几分钟，一旦完成，您将看到成功的升级状态。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lm"><img src="../Images/d48e543c241bf2bd8b008316531b3db6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*064QNHYWS2smUs5sbrNvrw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Kubernetes集群更新成功的结果</figcaption></figure><p id="e08e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您有额外的主节点，您可以按照第一个主节点的步骤进行，但是用<code class="fe ln lo lp lq b">kubeadm upgrade apply</code>升级它们，您应该运行:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="070b" class="lw lx it lq b gy ly lz l ma mb">sudo kubeadm upgrade node</span></pre><p id="9696" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来要做的是更新kubelet和kubectl。我们可以通过以下方式做到这一点:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="637f" class="lw lx it lq b gy ly lz l ma mb">sudo apt-get update<br/>sudo apt-get install --allow-change-held-packages kubectl=1.20.15-00 kubelet=1.20.15-00</span></pre><p id="6c79" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了确认我们的主节点工作正常，让我们运行:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="12c9" class="lw lx it lq b gy ly lz l ma mb">kubelet --version<br/>kubectl get nodes</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lm"><img src="../Images/d3cf67ec1485b1b734c525e20f2c50ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3GfLyMZlev6RedKocbO8VQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">我们集群中的Kubernetes版本</figcaption></figure><p id="8db0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一切看起来都很好。我们的主节点运行的是最新版本。你可能已经注意到我没有重启kubelet服务，因为这是不必要的。如果你需要这样做，你可以运行:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="929c" class="lw lx it lq b gy ly lz l ma mb">sudo systemctl restart kubelet.service</span></pre><p id="ad78" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们再次启用主节点并运行:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="3bb8" class="lw lx it lq b gy ly lz l ma mb">kubectl uncordon k8-m1</span></pre><p id="309c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这样，我们的主节点就完成了，我们可以切换到工作节点。我们将一个接一个地做。首先，我们将使用以下命令清空节点:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="3eb6" class="lw lx it lq b gy ly lz l ma mb">kubectl drain k8-w1 <!-- -->--ignore-daemonsets</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lm"><img src="../Images/0fd37963a18e51e5707522a4a2d7d38a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qo_2ZzHQFMrTWuoGfhPnUg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">排水工人节点k8-w1</figcaption></figure><p id="0e04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，与主节点相比，我们将同时更新kubeadm、kubectl和kubelet:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="5c69" class="lw lx it lq b gy ly lz l ma mb">sudo apt-get update<br/>sudo apt-get install --allow-change-held-packages kubeadm=1.20.15-00 kubectl=1.20.15-00 kubelet=1.20.15-00</span></pre><p id="e97c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成后，我们现在可以将我们的工作节点放回集群:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="ef50" class="lw lx it lq b gy ly lz l ma mb">kubectl uncordon k8-w1</span></pre><p id="7822" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将对剩余的工作节点重复这个过程。最后，让我们通过运行以下命令来确保一切正常:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="02ce" class="lw lx it lq b gy ly lz l ma mb">kubectl get nodes</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lm"><img src="../Images/15930eaab8b3eb7a761ff097c09fe25f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AVSiW1XjXLBhXdSUiOAuUA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">所有Kubernetes节点都升级到版本1.20.15</figcaption></figure><p id="edef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们完了。我们所有的节点都运行最新最好的Kubernetes v1.20.15。现在我们需要升级一个主要版本。下一个是is 1.21。我们将升级到可以通过运行找到的最大子版本</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="22a9" class="lw lx it lq b gy ly lz l ma mb">apt-cache madison kubeadm | grep 1.21.</span></pre><p id="904c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在是冲洗和重复前面的步骤，一直到1.25。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="a290" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">只剩下一件事要做了。在我们用<code class="fe ln lo lp lq b">--allow-change-held-packages</code>更新Kubernetes包的过程中，我们的kubeadm、kubectl和kubelet被从保留列表中删除。</p><p id="b107" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要确认我们可以运行:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="2029" class="lw lx it lq b gy ly lz l ma mb">apt-mark showheld</span></pre><p id="7461" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了让它们在未来保持不变并避免意外更新，我们应该运行:</p><pre class="kp kq kr ks gt ls lq lt lu aw lv bi"><span id="d48f" class="lw lx it lq b gy ly lz l ma mb">sudo apt-mark hold kubeadm kubectl kubelet</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lm"><img src="../Images/e9192e405f1ee7c84ea25a6d266debcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pYgGyZxZb84kpaCxqjxt0Q.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">软件包kubeadm kubectl kubelet在将来不会更新</figcaption></figure></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="c824" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">至此，我们完成了升级指南。如果您想了解有关设置我的Raspberry Pi Kubernetes集群的更多信息，请访问:</p><div class="md me gp gr mf mg"><a href="https://medium.com/@astrujic/step-by-step-slow-guide-kubernetes-cluster-on-raspberry-pi-4b-part-1-6e4179c89cbc" rel="noopener follow" target="_blank"><div class="mh ab fo"><div class="mi ab mj cl cj mk"><h2 class="bd iu gy z fp ml fr fs mm fu fw is bi translated">循序渐进指南—树莓Pi 4B上的Kubernetes集群—第1部分</h2><div class="mn l"><h3 class="bd b gy z fp ml fr fs mm fu fw dk translated">基于RaspberryPi 4B、Containerd、Project Calico、MetalLB和Ubuntu Server的Kubernetes集群</h3></div><div class="mo l"><p class="bd b dl z fp ml fr fs mm fu fw dk translated">medium.com</p></div></div><div class="mp l"><div class="mq l mr ms mt mp mu ky mg"/></div></div></a></div><p id="6408" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">或者如何为夏季做好准备并监测RaspberryPi Kubernetes集群的温度:</p><div class="md me gp gr mf mg"><a href="https://medium.com/@astrujic/raspberry-pi-4b-kubernetes-cluster-temperature-monitoring-with-daemonsets-slow-guide-b648da771d3e" rel="noopener follow" target="_blank"><div class="mh ab fo"><div class="mi ab mj cl cj mk"><h2 class="bd iu gy z fp ml fr fs mm fu fw is bi translated">Raspberry Pi 4B —使用DaemonSets监控Kubernetes集群温度—慢速指南</h2><div class="mn l"><h3 class="bd b gy z fp ml fr fs mm fu fw dk translated">监控Kubernetes集群温度的简单方法。</h3></div><div class="mo l"><p class="bd b dl z fp ml fr fs mm fu fw dk translated">medium.com</p></div></div><div class="mp l"><div class="mv l mr ms mt mp mu ky mg"/></div></div></a></div></div></div>    
</body>
</html>