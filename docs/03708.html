<html>
<head>
<title>Building Chat Service in Golang and Websockets Backed by Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">åˆ©ç”¨Redisæ„å»ºGolangå’ŒWebsocketsèŠå¤©æœåŠ¡</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://levelup.gitconnected.com/building-chat-service-in-golang-and-websockets-backed-by-redis-b42a8784636c?source=collection_archive---------0-----------------------#2020-05-24">https://levelup.gitconnected.com/building-chat-service-in-golang-and-websockets-backed-by-redis-b42a8784636c?source=collection_archive---------0-----------------------#2020-05-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/c537249d70478034cdf43bbffb446160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PqIOluZ3QdiNrdwpLzsfrA.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">é«˜å±‚å»ºç­‘çš„è§£å†³æ–¹æ¡ˆ</figcaption></figure></div><div class="ab cl kf kg hx kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="im in io ip iq"><p id="de14" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">è¿™æ˜¯Redisç³»åˆ—çš„ç¬¬å…­ç¯‡å¸–å­ã€‚</p><p id="86d7" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated"><a class="ae lk" href="https://medium.com/swlh/install-redis-inside-a-ubuntu-vm-d5022d42d8cc" rel="noopener"> <strong class="ko iu">ç¬¬ä¸€éƒ¨åˆ†</strong>:åœ¨Ubuntu VMå†…éƒ¨å®‰è£…Redis<br/></a><a class="ae lk" href="https://medium.com/@mhewedy_46874/redis-persistence-by-example-167aacf3a028" rel="noopener"><strong class="ko iu">ç¬¬äºŒéƒ¨åˆ†:</strong> RedisæŒä¹…åŒ–å®ä¾‹</a> <br/> <a class="ae lk" href="https://medium.com/@mhewedy_46874/implement-game-scoring-using-redis-75660f739760" rel="noopener"> <strong class="ko iu">ç¬¬ä¸‰éƒ¨åˆ†</strong>:ä½¿ç”¨Rediså®ç°æ¸¸æˆæ’è¡Œæ¦œ</a> <br/> <a class="ae lk" href="https://medium.com/@mhewedy_46874/implement-job-queue-in-redis-9f0f8d394561" rel="noopener"> <strong class="ko iu">ç¬¬å››éƒ¨åˆ†</strong>:ä½¿ç”¨Rediså®ç°ä½œä¸šé˜Ÿåˆ—</a> <br/> <a class="ae lk" href="https://medium.com/@mhewedy_46874/building-rest-api-backed-by-redis-ae8ff4818460" rel="noopener"> <strong class="ko iu">ç¬¬äº”éƒ¨åˆ†</strong>:æ„å»ºç”±Redisæ”¯æŒçš„REST API</a><br/>ğŸ‘ˆ<br/> <a class="ae lk" href="https://medium.com/@mhewedy_46874/redis-cluster-configurations-by-example-5480a178e884" rel="noopener"> <strong class="ko iu">ç¬¬ä¸ƒéƒ¨åˆ†</strong> : <strong class="ko iu"> </strong> Redisé›†ç¾¤é…ç½®ç¤ºä¾‹</a> <br/> <a class="ae lk" href="https://medium.com/@mhewedy_46874/redis-geospatial-by-example-f5505a0962ef" rel="noopener"> <strong class="ko iu">ç¬¬å…«éƒ¨åˆ†</strong> : Redisåœ°ç†ç©ºé—´ç¤ºä¾‹</a></p></div><div class="ab cl kf kg hx kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="im in io ip iq"><p id="b143" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨Redisä½œä¸ºä¸€ä¸ªå‘å¸ƒè®¢é˜…æ¥å®ç°ä¸€ä¸ªæ°´å¹³å¯ä¼¸ç¼©çš„èŠå¤©æœåŠ¡:</p><p id="af8a" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">ğŸ’ä»€ä¹ˆæ˜¯Pub-subï¼Ÿ<br/>ğŸ’è®¾è®¡å†³ç­–<br/>ğŸ’è®©æˆ‘ä»¬ç¼–ç (æœ€æ— èŠçš„éƒ¨åˆ†ğŸ”¥ï¼Œæ•¬è¯·æœŸå¾…)<br/>ğŸ’æ­£åœ¨è¿è¡Œçš„èŠå¤©æœåŠ¡<br/>ğŸ’æµ‹è¯•æ°´å¹³å¯ä¼¸ç¼©æ€§</p></div><div class="ab cl kf kg hx kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="im in io ip iq"><p id="8969" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®‰è£…åœ¨è™šæ‹Ÿæœºä¸Šçš„<a class="ae lk" href="https://medium.com/swlh/install-redis-inside-a-ubuntu-vm-d5022d42d8cc" rel="noopener"> Redisï¼Œä½¿ç”¨<strong class="ko iu">å®³è™«</strong>ï¼Œæ™ºèƒ½è™šæ‹Ÿæœºç®¡ç†å™¨ï¼Œå’Œä¸€ä¸ª</a><a class="ae lk" href="https://medium.com/@mhewedy_46874/vermin-a-modern-cli-for-vagrant-b115c9e97989" rel="noopener">ç°ä»£CLIçš„æµæµªè€…</a>ã€‚</p><p id="4610" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">ä½ å¯ä»¥ä»Githubé¡µé¢äº†è§£æ›´å¤šå…³äº<strong class="ko iu">å®³è™«</strong>çš„ä¿¡æ¯ã€‚</p><div class="ll lm gp gr ln lo"><a href="https://github.com/mhewedy/vermin" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab fo"><div class="lq ab lr cl cj ls"><h2 class="bd iu gy z fp lt fr fs lu fu fw is bi translated">mhewedy/å®³è™«</h2><div class="lv l"><h3 class="bd b gy z fp lt fr fs lu fu fw dk translated">ç›®å½•:å®³è™«æ˜¯ä¸€ä¸ªæ™ºèƒ½ï¼Œç®€å•å’Œå¼ºå¤§çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºLinuxï¼ŒWindowså’ŒmacOSã€‚å®ƒè¢«è®¾è®¡æˆâ€¦</h3></div><div class="lw l"><p class="bd b dl z fp lt fr fs lu fu fw dk translated">github.com</p></div></div><div class="lx l"><div class="ly l lz ma mb lx mc jz lo"/></div></div></a></div></div><div class="ab cl kf kg hx kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="im in io ip iq"><h1 id="603a" class="md me it bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">ä»€ä¹ˆæ˜¯Pub-subï¼Ÿ</h1><p id="7148" class="pw-post-body-paragraph km kn it ko b kp nb kr ks kt nc kv kw kx nd kz la lb ne ld le lf nf lh li lj im bi translated">åœ¨æœ¬ç³»åˆ—çš„æ–‡ç« â€œ<a class="ae lk" href="https://medium.com/@mhewedy_46874/implement-job-queue-in-redis-9f0f8d394561" rel="noopener">ä½¿ç”¨Redis </a>å®ç°ä½œä¸šé˜Ÿåˆ—â€ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†å¦‚ä½•ä½¿ç”¨<code class="fe ng nh ni nj b">list</code>æ“ä½œåŠå…¶<code class="fe ng nh ni nj b">BLPOP</code>ä»åˆ—è¡¨ä¸­å¼¹å‡ºå¹¶é˜»å¡ï¼Œç›´åˆ°æ–°å…ƒç´ å‡ºç°ã€‚åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°åœ¨Redisä¸­æ‹¥æœ‰ä¸€æµæ”¯æŒçš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼ã€‚</p><h2 id="ec77" class="nk me it bd mf nl nm dn mj nn no dp mn kx np nq mr lb nr ns mv lf nt nu mz nv bi translated">é‚£ä¹ˆä»€ä¹ˆæ˜¯å…¬å…±è®¢é˜…å‘¢ï¼Ÿ</h2><p id="c5c5" class="pw-post-body-paragraph km kn it ko b kp nb kr ks kt nc kv kw kx nd kz la lb ne ld le lf nf lh li lj im bi translated">å‘å¸ƒ-è®¢é˜…æ¨¡å¼å…è®¸ç§°ä¸º<em class="nw">å‘å¸ƒè€…</em>çš„æ¶ˆæ¯å‘é€è€…é€šè¿‡ä¸€ä¸ªé€šé“å‘ç§°ä¸º<em class="nw">è®¢é˜…è€…</em>çš„æ¥æ”¶è€…å‘å¸ƒæ¶ˆæ¯ï¼Œè€Œä¸çŸ¥é“å­˜åœ¨å“ªäº›è®¢é˜…è€…â€”â€”å¦‚æœæœ‰çš„è¯ã€‚æ‰€æœ‰è®¢é˜…è€…åœ¨æ”¶åˆ°æ¶ˆæ¯æ—¶éƒ½å¯ä»¥åŒæ—¶æ”¶åˆ°æ¶ˆæ¯ã€‚</p><p id="9341" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">ä¸<strong class="ko iu">æ¶ˆæ¯é˜Ÿåˆ—</strong>ä¸åŒï¼Œåè€…åœ¨æ¶ˆæ¯çš„<em class="nw">å‘é€æ–¹</em>å’Œ<em class="nw">æ¥æ”¶æ–¹</em>ä¹‹é—´æä¾›å¼‚æ­¥é€šä¿¡åè®®ï¼Œå› æ­¤å®ƒä»¬ä¸éœ€è¦åŒæ—¶ä¸æ¶ˆæ¯é˜Ÿåˆ—äº¤äº’ã€‚æ”¾å…¥é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å°†è¢«å­˜å‚¨ï¼Œç›´åˆ°æ”¶ä»¶äººæ£€ç´¢åˆ°å®ƒä»¬ã€‚</p><p id="948e" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">è¿™æ˜¯ä¸€ä¸ªåœ¨å‘å¸ƒè®¢é˜…åˆåŒä¸­æ£€ç´¢æ¶ˆæ¯çš„å›æ‰§ï¼Œæ‰€æœ‰æ´»åŠ¨è®¢é˜…è€…éƒ½å°†åœ¨å‘å¸ƒè®¢é˜…åˆåŒä¸­æ¥æ”¶æ¶ˆæ¯ã€‚æ­¤å¤–ï¼Œåœ¨å‘å¸ƒè®¢é˜…ä¸­ï¼Œå¦‚æœæ²¡æœ‰æ´»è·ƒçš„è®¢æˆ·ï¼Œæ¶ˆæ¯å°†ä¼šä¸¢å¤±ã€‚</p></div><div class="ab cl kf kg hx kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="im in io ip iq"><h1 id="8dba" class="md me it bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">è®¾è®¡å†³ç­–</h1><ol class=""><li id="6320" class="nx ny it ko b kp nb kt nc kx nz lb oa lf ob lj oc od oe of bi translated">èŠå¤©æœåŠ¡å…è®¸ç”¨æˆ·è®¢é˜…å¤šä¸ªé¢‘é“ã€‚(å¯ç”¨äºå®ç°ç›´æ¥èŠå¤©)</li><li id="8996" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">è¿™ä¸ªèŠå¤©æœåŠ¡è¢«è®¾è®¡æˆ<em class="nw">æ°´å¹³å¯ä¼¸ç¼©çš„</em>ã€‚å®ƒæ˜¯ä¸€ä¸ªæ— çŠ¶æ€æœåŠ¡(<em class="nw">çŠ¶æ€ä»…åœ¨WebSocketè¿æ¥æ‰“å¼€æ—¶ä¿å­˜ï¼Œç”¨æˆ·å¯ä»¥å»ºç«‹åˆ°å¤šä¸ªæœåŠ¡å™¨çš„å¤šä¸ªè¿æ¥</em>)ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®Reidsæ°´å¹³æ‰©å±•èŠå¤©æœåŠ¡ï¼Œè€Œä¸ç”¨æ‹…å¿ƒWebSocketåè®®çš„çŠ¶æ€æœ¬è´¨ã€‚</li><li id="c36a" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">Rediså®¢æˆ·ç«¯ä¸ºæ¯ä¸ªè®¢é˜…æ‰“å¼€ä¸€ä¸ªTCPè¿æ¥ï¼Œè¿™éœ€è¦æ‰“å¼€å¤ªå¤šä»èŠå¤©æœåŠ¡åˆ°Redisçš„è¿æ¥ï¼Œå¦‚æœæˆ‘ä»¬ä¸ºç”¨æˆ·è®¢é˜…çš„æ¯ä¸ªé¢‘é“æ‰“å¼€ä¸€ä¸ªè¿æ¥ã€‚<br/>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæ¯å½“ç”¨æˆ·è®¢é˜…æ–°çš„é¢‘é“ï¼Œæˆ‘éƒ½è¦å–æ¶ˆæ—§çš„è®¢é˜…ï¼Œä¸€æ¬¡æ€§è®¢é˜…æ‰€æœ‰ç”¨æˆ·é¢‘é“ã€‚(Rediså…è®¸åŒæ—¶è®¢é˜…å¤šä¸ªé¢‘é“)</li><li id="5f86" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">é»˜è®¤æƒ…å†µä¸‹ï¼ŒèŠå¤©æœåŠ¡åœ¨ä¸¤ä¸ªé€šé“ä¸­æ³¨å†Œæ‰€æœ‰è¿æ¥çš„ç”¨æˆ·â€œ<em class="nw">é€šç”¨</em>å’Œâ€œ<em class="nw">éšæœº</em>â€(éµå¾ªæ¾å¼›çº¦å®š)ã€‚ç”¨æˆ·å¯ä»¥åœ¨ä»»ä½•æ—¶é—´è®¢é˜…ä»»ä½•ä»»æ„é¢‘é“ï¼Œå¹¶ä¸”åªæœ‰è®¢é˜…äº†è¿™äº›é¢‘é“çš„ç”¨æˆ·æ‰èƒ½çœ‹åˆ°æ¶ˆæ¯ã€‚</li><li id="a1a8" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">æˆ‘ä½¿ç”¨WebSocketsæ¥å¤„ç†JavaScriptå®¢æˆ·æœºå’ŒèŠå¤©æœåŠ¡ä¹‹é—´çš„é€šä¿¡ã€‚(æˆ‘å–œæ¬¢)</li><li id="20a6" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">javascriptå®¢æˆ·ç«¯ç”¨JSONå‘Websocket APIå‘é€æ¶ˆæ¯ï¼Œè¯¥APIä½¿ç”¨ä¸‹é¢çš„ç»“æ„<code class="fe ng nh ni nj b">{"command": &lt;0=Subscribe, 1=Unsubscribe or 2=Chat&gt;, "channel": "channel name", "content": "content text"}</code></li><li id="0ed6" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">è¯¥æœåŠ¡æä¾›äº†å‡ ä¸ªREST APIsæ¥è·å–ç”¨æˆ·å’Œç‰¹å®šç”¨æˆ·è®¢é˜…çš„é¢‘é“ã€‚(å°†æœ‰åŠ©äºåœ¨æœåŠ¡ä¹‹ä¸Šæ„å»ºGUI)</li><li id="401f" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">èŠå¤©æœåŠ¡ä¸å¤„ç†ç”¨æˆ·ç®¡ç†æˆ–è®¤è¯æ–¹é¢çš„é—®é¢˜ã€‚</li></ol></div><div class="ab cl kf kg hx kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="im in io ip iq"><h1 id="349b" class="md me it bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">è®©æˆ‘ä»¬ç¼–ç ğŸš€ğŸš€ğŸš€</h1><p id="bdac" class="pw-post-body-paragraph km kn it ko b kp nb kr ks kt nc kv kw kx nd kz la lb ne ld le lf nf lh li lj im bi translated">åœ¨è¿™ä¸€(é•¿)éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†æµè§ˆæœ€é‡è¦çš„ä»£ç ç‰‡æ®µï¼Œç„¶è€Œï¼Œå®Œæ•´çš„æºä»£ç æ˜¯æ‰˜ç®¡åœ¨https://github.com/mhewedy-playground/Chatçš„Githubä¸Š</p><h2 id="fcc0" class="nk me it bd mf nl nm dn mj nn no dp mn kx np nq mr lb nr ns mv lf nt nu mz nv bi translated">èŠå¤©æœåŠ¡çš„é«˜çº§æ‹±é—¨</h2><figure class="om on oo op gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ol"><img src="../Images/25e53662ff2d3a81292f7746fb2e5c88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qjJ984G3CS8S9ivRKzvWBA.jpeg"/></div></div></figure><h2 id="30b8" class="nk me it bd mf nl nm dn mj nn no dp mn kx np nq mr lb nr ns mv lf nt nu mz nv bi translated">ç”¨æˆ·ç»„ä»¶:</h2><p id="3342" class="pw-post-body-paragraph km kn it ko b kp nb kr ks kt nc kv kw kx nd kz la lb ne ld le lf nf lh li lj im bi translated">è®©æˆ‘ä»¬ä»ç»“æ„å®šä¹‰å¼€å§‹:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="78e6" class="nk me it nj b gy ou ov l ow ox"><strong class="nj iu">type </strong>User <strong class="nj iu">struct </strong>{<br/>   name            string<br/>   channelsHandler *redis.PubSub</span><span id="9674" class="nk me it nj b gy oy ov l ow ox">   stopListenerChan <strong class="nj iu">chan struct</strong>{}<br/>   listening        bool</span><span id="0051" class="nk me it nj b gy oy ov l ow ox">   MessageChan <strong class="nj iu">chan </strong>redis.Message<br/>}</span></pre><p id="a999" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated"><code class="fe ng nh ni nj b"><strong class="ko iu">name</strong></code>:ç”¨æˆ·çš„åå­—</p><p id="6f24" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated"><code class="fe ng nh ni nj b"><strong class="ko iu">channelsHandler</strong></code>:Redis subscribeå‘½ä»¤è¿æ¥çš„å¤„ç†ç¨‹åºã€‚å› æ­¤ï¼Œæ¯æ¬¡ç”¨æˆ·è®¢é˜…ä¸€ä¸ªæ–°é¢‘é“æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨è¯¥å¤„ç†ç¨‹åºæ¥ç»“æŸå½“å‰è®¢é˜…ï¼Œç„¶åå¼€å§‹å¯¹æ–°é¢‘é“åˆ—è¡¨(æ—§é¢‘é“+æ–°é¢‘é“)çš„æ–°è®¢é˜…ï¼Œç„¶åé€šè¿‡subscribeå‡½æ•°è¿”å›çš„å€¼æ¥æ›´æ–°è¯¥å¼•ç”¨ã€‚</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="f6b0" class="nk me it nj b gy ou ov l ow ox">// cancel current subscritpion<br/>u.channelsHandler.Unsubscribe()<br/>u.channelsHandler.Close()</span><span id="d227" class="nk me it nj b gy oy ov l ow ox">// start a new subscritpion on the new channels list (old channels list + the new channel user ask to subscribe to)<br/>pubSub := rdb.Subscribe(channels...)<br/>u.channelsHandler = pubSub</span></pre><p id="64e1" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated"><code class="fe ng nh ni nj b"><strong class="ko iu">stopListenerChan</strong></code> : Golangé€šé“ï¼Œç”¨äºåœæ­¢å½“å‰ç”¨äºå¤„ç†å½“å‰è®¢é˜…çš„goroutineã€‚å®ƒä¸<code class="fe ng nh ni nj b"><strong class="ko iu">channelsHandler</strong></code> <strong class="ko iu"> </strong>æœ‰å…³ã€‚</p><p id="e097" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated"><code class="fe ng nh ni nj b"><strong class="ko iu">MessageChan</strong></code> <strong class="ko iu"> : </strong>åœ¨Reidsè®¢é˜…goroutineå’ŒWebsocketå‘é€æ–¹goroutineä¹‹é—´è¿›è¡Œé€šä¿¡çš„Golangé€šé“ã€‚å› æ­¤ï¼Œæ¯å½“ä¸€æ¡æ–°æ¶ˆæ¯åˆ°è¾¾Redisä¸­çš„ä¸€ä¸ªé€šé“æ—¶ï¼Œæˆ‘ä»¬ä¼šç«‹å³å°†å…¶å‘å¸ƒåˆ°web socketè¿æ¥ã€‚</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="0322" class="nk me it nj b gy ou ov l ow ox"><em class="nw">// The Listener Goroutine:<br/></em><strong class="nj iu">go func</strong>() {<br/>   u.listening = <strong class="nj iu"><em class="nw">true<br/>   </em></strong>fmt.Println(<strong class="nj iu">"starting the listener for user:"</strong>, u.name, <strong class="nj iu">"on channels:"</strong>, channels)<br/>   <strong class="nj iu">for </strong>{<br/>      <strong class="nj iu">select </strong>{<br/>      <strong class="nj iu">case </strong>msg, ok := &lt;-pubSub.Channel():<br/>         <strong class="nj iu">if </strong>!ok {<br/>            <strong class="nj iu">break<br/>         </strong>}<br/>         u.MessageChan &lt;- *msg</span><span id="59b2" class="nk me it nj b gy oy ov l ow ox">      <strong class="nj iu">case </strong>&lt;-u.stopListenerChan:<br/>         <strong class="nj iu">break<br/>      </strong>}<br/>   }<br/>}()</span></pre><p id="3421" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">ä¸‹é¢æ˜¯ç”¨æˆ·ç±»å‹çš„<code class="fe ng nh ni nj b"><strong class="ko iu">Connect</strong></code>ã€<code class="fe ng nh ni nj b">Subscribe</code>å’Œ<code class="fe ng nh ni nj b">Unsubscribe</code>æ–¹æ³•çš„å®ç°ï¼Œç®€å•æ˜äº†:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="f300" class="nk me it nj b gy ou ov l ow ox"><em class="nw">//Connect connect user to user channels on redis<br/></em><strong class="nj iu">func </strong>Connect(rdb *redis.Client, name string) (*User, error) {<br/>   <strong class="nj iu">if </strong>_, err := rdb.SAdd(<strong class="nj iu"><em class="nw">usersKey</em></strong>, name).Result(); err != nil {<br/>      <strong class="nj iu">return </strong>nil, err<br/>   }</span><span id="6f26" class="nk me it nj b gy oy ov l ow ox">   u := &amp;User{<br/>      name:             name,<br/>      stopListenerChan: make(<strong class="nj iu">chan struct</strong>{}),<br/>      MessageChan:      make(<strong class="nj iu">chan </strong>redis.Message),<br/>   }</span><span id="74b5" class="nk me it nj b gy oy ov l ow ox">   <strong class="nj iu">if </strong>err := u.connect(rdb); err != nil {<br/>      <strong class="nj iu">return </strong>nil, err<br/>   }</span><span id="2e01" class="nk me it nj b gy oy ov l ow ox">   <strong class="nj iu">return </strong>u, nil<br/>}</span><span id="13c6" class="nk me it nj b gy oy ov l ow ox"><strong class="nj iu">func </strong>(u *User) Subscribe(rdb *redis.Client, channel string) error {</span><span id="a467" class="nk me it nj b gy oy ov l ow ox">   userChannelsKey := fmt.Sprintf(<strong class="nj iu"><em class="nw">userChannelFmt</em></strong>, u.name)</span><span id="a74f" class="nk me it nj b gy oy ov l ow ox">   <strong class="nj iu">if </strong>rdb.SIsMember(userChannelsKey, channel).Val() {<br/>      <strong class="nj iu">return </strong>nil<br/>   }<br/>   <strong class="nj iu">if </strong>err := rdb.SAdd(userChannelsKey, channel).Err(); err != nil {<br/>      <strong class="nj iu">return </strong>err<br/>   }</span><span id="b692" class="nk me it nj b gy oy ov l ow ox">   <strong class="nj iu">return </strong>u.connect(rdb)<br/>}</span><span id="418b" class="nk me it nj b gy oy ov l ow ox"><strong class="nj iu">func </strong>(u *User) Unsubscribe(rdb *redis.Client, channel string) error {</span><span id="a2c4" class="nk me it nj b gy oy ov l ow ox">   userChannelsKey := fmt.Sprintf(<strong class="nj iu"><em class="nw">userChannelFmt</em></strong>, u.name)</span><span id="866b" class="nk me it nj b gy oy ov l ow ox">   <strong class="nj iu">if </strong>!rdb.SIsMember(userChannelsKey, channel).Val() {<br/>      <strong class="nj iu">return </strong>nil<br/>   }<br/>   <strong class="nj iu">if </strong>err := rdb.SRem(userChannelsKey, channel).Err(); err != nil {<br/>      <strong class="nj iu">return </strong>err<br/>   }</span><span id="3131" class="nk me it nj b gy oy ov l ow ox">   <strong class="nj iu">return </strong>u.connect(rdb)<br/>}</span></pre><p id="932a" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">ç®€å•ç›´æ¥åœ°è¯´ï¼Œæˆ‘ä»¬ä»Redisä¸­æ£€ç´¢é¢‘é“ï¼Œå¹¶é€šè¿‡è®¢é˜…/å–æ¶ˆè®¢é˜…æ“ä½œä¿æŒé¢‘é“æ›´æ–°ã€‚ç„¶åè°ƒç”¨è®¢é˜…ç”¨æˆ·æ‹¥æœ‰çš„é¢‘é“åˆ—è¡¨çš„<code class="fe ng nh ni nj b">connect</code>æ–¹æ³•ã€‚</p><p id="8524" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">ä¸‹é¢æ˜¯<code class="fe ng nh ni nj b">connect</code>æ–¹æ³•çš„å®ç°:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="21c3" class="nk me it nj b gy ou ov l ow ox"><strong class="nj iu">func </strong>(u *User) connect(rdb *redis.Client) error {<br/><br/>   <strong class="nj iu">var </strong>c []string<br/><br/>   c1, err := rdb.SMembers(<strong class="nj iu"><em class="nw">ChannelsKey</em></strong>).Result()<br/>   <strong class="nj iu">if </strong>err != nil {<br/>      <strong class="nj iu">return </strong>err<br/>   }<br/>   c = append(c, c1...)<br/><br/>   <em class="nw">// get all user channels (from DB) and start subscribe<br/>   </em>c2, err := rdb.SMembers(fmt.Sprintf(<strong class="nj iu"><em class="nw">userChannelFmt</em></strong>, u.name)).Result()<br/>   <strong class="nj iu">if </strong>err != nil {<br/>      <strong class="nj iu">return </strong>err<br/>   }<br/>   c = append(c, c2...)<br/><br/>   <strong class="nj iu">if </strong>len(c) == 0 {<br/>      fmt.Println(<strong class="nj iu">"no channels to connect to for user: "</strong>, u.name)<br/>      <strong class="nj iu">return </strong>nil<br/>   }<br/><br/>   <strong class="nj iu">if </strong>u.channelsHandler != nil {<br/>      <strong class="nj iu">if </strong>err := u.channelsHandler.Unsubscribe(); err != nil {<br/>         <strong class="nj iu">return </strong>err<br/>      }<br/>      <strong class="nj iu">if </strong>err := u.channelsHandler.Close(); err != nil {<br/>         <strong class="nj iu">return </strong>err<br/>      }<br/>   }<br/>   <strong class="nj iu">if </strong>u.listening {<br/>      u.stopListenerChan &lt;- <strong class="nj iu">struct</strong>{}{}<br/>   }<br/><br/>   <strong class="nj iu">return </strong>u.doConnect(rdb, c...)<br/>}<br/><br/><strong class="nj iu">func </strong>(u *User) doConnect(rdb *redis.Client, channels ...string) error {<br/>   <em class="nw">// subscribe all channels in one request<br/>   </em>pubSub := rdb.Subscribe(channels...)<br/>   <em class="nw">// keep channel handler to be used in unsubscribe<br/>   </em>u.channelsHandler = pubSub<br/><br/>   <em class="nw">// The Listener<br/>   </em><strong class="nj iu">go func</strong>() {<br/>      u.listening = <strong class="nj iu"><em class="nw">true<br/>      </em></strong>fmt.Println(<strong class="nj iu">"starting the listener for user:"</strong>, u.name, <strong class="nj iu">"on channels:"</strong>, channels)<br/>   <strong class="nj iu">loop</strong>:<br/>      <strong class="nj iu">for </strong>{<br/>         <strong class="nj iu">select </strong>{<br/>         <strong class="nj iu">case </strong>msg, ok := &lt;-pubSub.Channel():<br/>            <strong class="nj iu">if </strong>!ok {<br/>               <strong class="nj iu">break loop<br/>            </strong>}<br/>            u.MessageChan &lt;- *msg<br/><br/>         <strong class="nj iu">case </strong>&lt;-u.stopListenerChan:<br/>            fmt.Println(<strong class="nj iu">"stopping the listener for user:"</strong>, u.name)<br/>            <strong class="nj iu">break loop<br/>         </strong>}<br/>      }<br/>   }()<br/>   <strong class="nj iu">return </strong>nil<br/>}</span></pre><p id="eaba" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">æˆ‘ä»¬åŸºæœ¬ä¸Šæ£€ç´¢ç”¨æˆ·çš„é¢‘é“åˆ—è¡¨ï¼Œç„¶åæ¸…é™¤æ—§çŠ¶æ€(ä½¿ç”¨<code class="fe ng nh ni nj b">channelsHandler</code>å…³é—­ä»»ä½•ç°æœ‰çš„TCPè¿æ¥ï¼Œä½¿ç”¨<code class="fe ng nh ni nj b">stopListener</code>å…³é—­æ­£åœ¨è¿è¡Œçš„Goroutinesï¼Œå¦‚æœæœ‰çš„è¯)</p><p id="63ea" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">ç„¶åæˆ‘ä»¬è°ƒç”¨è®¢é˜…é¢‘é“åˆ—è¡¨çš„<code class="fe ng nh ni nj b">doConnect</code>ã€‚<code class="fe ng nh ni nj b">doConnect</code> <em class="nw">(è¿™æ˜¯è¿„ä»Šä¸ºæ­¢æœ€é‡è¦çš„æ–¹æ³•)</em>åšå¦‚ä¸‹å·¥ä½œ:</p><ol class=""><li id="74f2" class="nx ny it ko b kp kq kt ku kx oz lb pa lf pb lj oc od oe of bi translated">é€šè¿‡ä¸ºä¸€ä¸ªè¿æ¥ä¸­çš„æ‰€æœ‰é¢‘é“åˆ—è¡¨æ‰“å¼€ä¸€ä¸ªTCPè¿æ¥æ¥è®¢é˜…é¢‘é“åˆ—è¡¨</li><li id="8077" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">æ•è·å¯¹TCPè¿æ¥çš„å¼•ç”¨(<code class="fe ng nh ni nj b">u.channelsHandler = pubSub</code>)</li><li id="569a" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">å¯åŠ¨ä¸€ä¸ªgoroutineï¼Œå®ƒå°†å¤„ç†æˆ‘ä»¬åœ¨ä»»ä½•è®¢é˜…çš„é¢‘é“ä¸Šä»Redisæ”¶åˆ°çš„æ¶ˆæ¯ã€‚(åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…³é—­Golangé€šé“<code class="fe ng nh ni nj b">stopListener</code>æ¥åœæ­¢goroutine)</li><li id="7427" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">å°†ä»Redisæ”¶åˆ°çš„æ¶ˆæ¯å‘é€åˆ°Golangé¢‘é“<code class="fe ng nh ni nj b">u.MessageChan</code>ã€‚è¿™ä¸ªGolangé€šé“æ­£åœ¨è¢«è¿­ä»£ï¼Œä»»ä½•æ–°æ¶ˆæ¯éƒ½å°†è¢«æ¨é€åˆ°WebSocketå®¢æˆ·ç«¯ã€‚</li></ol><p id="cbbb" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ç§<code class="fe ng nh ni nj b">Disconnect</code>æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šä¸<code class="fe ng nh ni nj b">connect</code>æ–¹æ³•ç±»ä¼¼(é€šè¿‡æ¸…ç†èµ„æº)ï¼Œä½†å®ƒä¸è®¢é˜…æ–°çš„é¢‘é“åˆ—è¡¨ï¼Œè€Œä¸”å®ƒå…³é—­äº†<code class="fe ng nh ni nj b">MessageChan</code> Golangé¢‘é“Rediså’ŒWebSocketsä¹‹é—´çš„é€šä¿¡â€”â€”å› ä¸ºå®ƒä¸å†éœ€è¦ã€‚</p><p id="c25e" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">æœ€åä¸€ä¸ªæ–¹æ³•<code class="fe ng nh ni nj b">Chat</code>ï¼Œç®€å•å¦‚ä¸‹:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="071e" class="nk me it nj b gy ou ov l ow ox"><strong class="nj iu">func </strong>Chat(rdb *redis.Client, channel string, content string) error {<br/>   <strong class="nj iu">return </strong>rdb.Publish(channel, content).Err()<br/>}</span></pre><p id="204d" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">å®ƒåªæ˜¯å°†æ¶ˆæ¯å‘å¸ƒåˆ°ä¸€ä¸ªé€šé“ã€‚</p><h2 id="1e23" class="nk me it bd mf nl nm dn mj nn no dp mn kx np nq mr lb nr ns mv lf nt nu mz nv bi translated">WebSocketèŠå¤©å¤„ç†æ–¹æ³•:</h2><pre class="om on oo op gt oq nj or os aw ot bi"><span id="b379" class="nk me it nj b gy ou ov l ow ox"><strong class="nj iu">func </strong>ChatWebSocketHandler(w http.ResponseWriter, r *http.Request, rdb *redis.Client) {</span><span id="950c" class="nk me it nj b gy oy ov l ow ox">   conn, err := upgrader.Upgrade(w, r, nil)<br/>   <strong class="nj iu">if </strong>err != nil {<br/>      handleWSError(err, conn)<br/>      <strong class="nj iu">return<br/>   </strong>}</span><span id="8bf6" class="nk me it nj b gy oy ov l ow ox">   err = onConnect(r, conn, rdb)<br/>   <strong class="nj iu">if </strong>err != nil {<br/>      handleWSError(err, conn)<br/>      <strong class="nj iu">return<br/>   </strong>}</span><span id="5c54" class="nk me it nj b gy oy ov l ow ox">   closeCh := onDisconnect(r, conn, rdb)</span><span id="e9ce" class="nk me it nj b gy oy ov l ow ox">   // on recieve message from redis channels<br/>   onChannelMessage(conn, r)</span><span id="67c8" class="nk me it nj b gy oy ov l ow ox"><strong class="nj iu">loop</strong>:<br/>   <strong class="nj iu">for </strong>{<br/>      <strong class="nj iu">select </strong>{<br/>      <strong class="nj iu">case </strong>&lt;-closeCh:<br/>         <strong class="nj iu">break loop<br/>      default</strong>:<br/>         onUserMessage(conn, r, rdb)<br/>      }<br/>   }<br/>}</span></pre><ol class=""><li id="e4f5" class="nx ny it ko b kp kq kt ku kx oz lb pa lf pb lj oc od oe of bi translated">æˆ‘ä»¬å‡çº§è¿æ¥(ä½¿ç”¨Gorilla Toolkit WebSocketå®ç°)</li><li id="a51c" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">è°ƒç”¨<code class="fe ng nh ni nj b">onConnect</code>æ¥æ£€ç´¢URLçš„ç”¨æˆ·åï¼Œå¹¶è°ƒç”¨<code class="fe ng nh ni nj b">user.Connect</code>æ–¹æ³•æ¥å»ºç«‹åˆ°ç”¨æˆ·è®¢é˜…çš„é¢‘é“çš„è¿æ¥ï¼Œå¹¶å°†ç”¨æˆ·æ·»åŠ åˆ°<strong class="ko iu"><em class="nw">connected users</em></strong><code class="fe ng nh ni nj b">map</code>ã€‚</li><li id="b4f9" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">è°ƒç”¨<code class="fe ng nh ni nj b">onDiscounnect</code>å®ƒæ³¨å†Œä¸€ä¸ªè°ƒç”¨<code class="fe ng nh ni nj b">user.Disconnect</code>çš„WebSocketå…³é—­å¤„ç†ç¨‹åºï¼Œå¹¶å°†ç”¨æˆ·ä»<strong class="ko iu"><em class="nw">connected users</em></strong><code class="fe ng nh ni nj b">map</code>ä¸­ç§»é™¤ï¼Œæœ€åï¼Œå®ƒè¿”å›ä¸€ä¸ªGolangé€šé“ï¼Œè¯¥é€šé“ç”¨äºä¸­æ–­WebSocketå¾ªç¯ï¼Œæˆ‘ä»¬å°†åœ¨åˆ°è¾¾è¯¥æ–¹æ³•çš„andæ—¶çœ‹åˆ°ã€‚</li><li id="a9bd" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj oc od oe of bi translated">å«<code class="fe ng nh ni nj b">onChannelMessage</code>é‚£æ ·å­:</li></ol><pre class="om on oo op gt oq nj or os aw ot bi"><span id="d3d1" class="nk me it nj b gy ou ov l ow ox">u := connectedUsers[username]</span><span id="32e1" class="nk me it nj b gy oy ov l ow ox"><strong class="nj iu">go func</strong>() {<br/>   <strong class="nj iu">for </strong>m := <strong class="nj iu">range </strong>u.MessageChan {</span><span id="0e84" class="nk me it nj b gy oy ov l ow ox">      msg := msg{<br/>         Content: m.Payload,<br/>         Channel: m.Channel,<br/>         Command: 0,<br/>      }</span><span id="178c" class="nk me it nj b gy oy ov l ow ox">      <strong class="nj iu">if </strong>err := conn.WriteJSON(msg); err != nil {<br/>         fmt.Println(err)<br/>      }<br/>   }</span><span id="833d" class="nk me it nj b gy oy ov l ow ox">}()</span></pre><p id="e629" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">å®ƒä»<strong class="ko iu"><em class="nw">connected users</em></strong>æ˜ å°„ä¸­æ£€ç´¢ç”¨æˆ·ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ªgoroutineï¼Œè¯¥goroutineå°†ä»è®¢é˜…Reidsé€šé“çš„go routineæ­£åœ¨ç¼–å†™çš„<code class="fe ng nh ni nj b">u.MssageChan</code>ä¸­è¿›è¡Œè¯»å–ã€‚ç„¶åï¼Œå®ƒå°†WebSocketè¿æ¥çš„æ¶ˆæ¯å†™å›å®¢æˆ·ç«¯ã€‚</p><p id="2791" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">5.WebSocketå¾ªç¯:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="3b57" class="nk me it nj b gy ou ov l ow ox"><strong class="nj iu">loop</strong>:<br/>   <strong class="nj iu">for </strong>{<br/>      <strong class="nj iu">select </strong>{<br/>      <strong class="nj iu">case </strong>&lt;-closeCh:<br/>         <strong class="nj iu">break loop<br/>      default</strong>:<br/>         onUserMessage(conn, r, rdb)<br/>      }<br/>   }</span></pre><p id="faee" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">å®ƒåŸºæœ¬ä¸Šæ°¸è¿œå¾ªç¯ä¸‹å»ï¼Œç›´åˆ°ä¸€ä¸ª<code class="fe ng nh ni nj b">closeCh</code>(ä»ä¸Šé¢#3ä¸­çš„<code class="fe ng nh ni nj b">onDisconnect</code>æ–¹æ³•è¿”å›)è°ƒç”¨<code class="fe ng nh ni nj b">onUserMessage</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è§£ææ¥è‡ªWebSocketè¿æ¥çš„æ¶ˆæ¯å¹¶æ ¹æ®å‘½ä»¤ç±»å‹é‡‡å–è¡ŒåŠ¨ã€‚å®ç°å¦‚ä¸‹:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="2009" class="nk me it nj b gy ou ov l ow ox"><strong class="nj iu">type </strong>msg <strong class="nj iu">struct </strong>{<br/>   Content string <strong class="nj iu">`json:"content,omitempty"`<br/>   </strong>Channel string <strong class="nj iu">`json:"channel,omitempty"`<br/>   </strong>Command int    <strong class="nj iu">`json:"command,omitempty"`<br/>   </strong>Err     string <strong class="nj iu">`json:"err,omitempty"`<br/></strong>}</span><span id="86c9" class="nk me it nj b gy oy ov l ow ox"><strong class="nj iu">const </strong>(<br/>   <strong class="nj iu"><em class="nw">commandSubscribe </em></strong>= <strong class="nj iu"><em class="nw">iota<br/>   commandUnsubscribe<br/>   commandChat<br/></em></strong>)</span><span id="9e04" class="nk me it nj b gy oy ov l ow ox"><strong class="nj iu">func </strong>onUserMessage(conn *websocket.Conn, r *http.Request, rdb *redis.Client) {</span><span id="59a8" class="nk me it nj b gy oy ov l ow ox">   <strong class="nj iu">var </strong>msg msg</span><span id="a6c6" class="nk me it nj b gy oy ov l ow ox">   <strong class="nj iu">if </strong>err := conn.ReadJSON(&amp;msg); err != nil {<br/>      handleWSError(err, conn)<br/>      <strong class="nj iu">return<br/>   </strong>}</span><span id="2d76" class="nk me it nj b gy oy ov l ow ox">   username := r.URL.Query()[<strong class="nj iu">"username"</strong>][0]<br/>   u := connectedUsers[username]</span><span id="3f48" class="nk me it nj b gy oy ov l ow ox">   <strong class="nj iu">switch </strong>msg.Command {<br/>   <strong class="nj iu">case <em class="nw">commandSubscribe</em></strong>:<br/>      <strong class="nj iu">if </strong>err := u.Subscribe(rdb, msg.Channel); err != nil {<br/>         handleWSError(err, conn)<br/>      }<br/>   <strong class="nj iu">case <em class="nw">commandUnsubscribe</em></strong>:<br/>      <strong class="nj iu">if </strong>err := u.Unsubscribe(rdb, msg.Channel); err != nil {<br/>         handleWSError(err, conn)<br/>      }<br/>   <strong class="nj iu">case <em class="nw">commandChat</em></strong>:<br/>      <strong class="nj iu">if </strong>err := user.Chat(rdb, msg.Channel, msg.Content); err != nil {<br/>         handleWSError(err, conn)<br/>      }<br/>   }<br/>}</span></pre><p id="7059" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">å®ƒåŸºæœ¬ä¸Šè¯»å–æ¥è‡ªJavascript Websocketå®¢æˆ·ç«¯çš„JSONï¼Œç„¶åä»<strong class="ko iu"><em class="nw">connected users</em></strong><code class="fe ng nh ni nj b">map</code>æ£€ç´¢ç”¨æˆ·ï¼Œç„¶ååˆ‡æ¢æ¶ˆæ¯æœ¬èº«çš„<code class="fe ng nh ni nj b">Command</code>å­—æ®µï¼Œè¯¥å­—æ®µå¯èƒ½æ˜¯ä»¥ä¸‹ä¹‹ä¸€:</p><ul class=""><li id="da60" class="nx ny it ko b kp kq kt ku kx oz lb pa lf pb lj pc od oe of bi translated"><code class="fe ng nh ni nj b"><strong class="ko iu">commandSubscribe</strong></code>:æ¥å—ç”¨æˆ·çš„é¢‘é“åç§°ï¼Œå¹¶ä¸ºç”¨æˆ·è®¢é˜…è¯¥é¢‘é“(é€šè¿‡è°ƒç”¨<code class="fe ng nh ni nj b">u.Subscribe</code></li><li id="9074" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj pc od oe of bi translated"><code class="fe ng nh ni nj b"><strong class="ko iu">commandUnsubscribe</strong></code>:æ¥å—ç”¨æˆ·çš„é¢‘é“åç§°ï¼Œå–æ¶ˆç”¨æˆ·å¯¹è¯¥é¢‘é“çš„è®¢é˜…(é€šè¿‡è°ƒç”¨<code class="fe ng nh ni nj b">u.Subscribe</code>)</li><li id="e9d8" class="nx ny it ko b kp og kt oh kx oi lb oj lf ok lj pc od oe of bi translated"><code class="fe ng nh ni nj b"><strong class="ko iu">commandChat</strong></code>:è¯¥å‘½ä»¤è°ƒç”¨<code class="fe ng nh ni nj b">user.Chat</code>å‘é¢‘é“å‘é€æ–‡æœ¬æ¶ˆæ¯ã€‚</li></ul><h2 id="6129" class="nk me it bd mf nl nm dn mj nn no dp mn kx np nq mr lb nr ns mv lf nt nu mz nv bi translated">APIå¤„ç†ç¨‹åº</h2><p id="c806" class="pw-post-body-paragraph km kn it ko b kp nb kr ks kt nc kv kw kx nd kz la lb ne ld le lf nf lh li lj im bi translated">é™¤äº†ç”¨æˆ·å’ŒWebsocketèŠå¤©ç»„ä»¶ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰æœ€åä¸€ä¸ªä»£è¡¨APIçš„ç»„ä»¶:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="039b" class="nk me it nj b gy ou ov l ow ox">r.Path(<strong class="nj iu">"/chat"</strong>).Methods(<strong class="nj iu">"GET"</strong>).HandlerFunc(api.<strong class="nj iu"><em class="nw">ChatWebSocketHandler</em></strong>)r.Path(<strong class="nj iu">"/users"</strong>).Methods(<strong class="nj iu">"GET"</strong>).HandlerFunc(api.<strong class="nj iu"><em class="nw">UsersHandler</em></strong>)<br/>r.Path(<strong class="nj iu">"/user/{user}/channels"</strong>).Methods(<strong class="nj iu">"GET"</strong>).HandlerFunc(api.<strong class="nj iu"><em class="nw">UserChannelsHandler</em></strong>)</span></pre><p id="8011" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚å·²ç»æ£€æŸ¥äº†å‡½æ•°<strong class="ko iu"><em class="nw">ChatWebSocketHandler</em></strong><em class="nw">ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹UserHandlerå’Œuserchandler:</em>çš„å®ç°</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="88b5" class="nk me it nj b gy ou ov l ow ox"><strong class="nj iu">func </strong>UserChannelsHandler(w http.ResponseWriter, r *http.Request, rdb *redis.Client) {<br/>   username := mux.Vars(r)[<strong class="nj iu">"user"</strong>]</span><span id="e3b6" class="nk me it nj b gy oy ov l ow ox">   list, err := user.GetChannels(rdb, username)<br/>   <strong class="nj iu">if </strong>err != nil {<br/>      handleError(err, w)<br/>      <strong class="nj iu">return<br/>   </strong>}<br/>   err = json.NewEncoder(w).Encode(list)<br/>   <strong class="nj iu">if </strong>err != nil {<br/>      handleError(err, w)<br/>      <strong class="nj iu">return<br/>   </strong>}</span><span id="a5bf" class="nk me it nj b gy oy ov l ow ox">}</span><span id="4b5d" class="nk me it nj b gy oy ov l ow ox"><strong class="nj iu">func </strong>UsersHandler(w http.ResponseWriter, r *http.Request, rdb *redis.Client) {</span><span id="8414" class="nk me it nj b gy oy ov l ow ox">   list, err := user.List(rdb)<br/>   <strong class="nj iu">if </strong>err != nil {<br/>      handleError(err, w)<br/>      <strong class="nj iu">return<br/>   </strong>}<br/>   err = json.NewEncoder(w).Encode(list)<br/>   <strong class="nj iu">if </strong>err != nil {<br/>      handleError(err, w)<br/>      <strong class="nj iu">return<br/>   </strong>}<br/>}</span></pre><p id="9170" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">è¿™å°±æ˜¯ç¼–ç éƒ¨åˆ†çš„å…¨éƒ¨å†…å®¹ã€‚ä½ å¯ä»¥åœ¨Github<a class="ae lk" href="https://github.com/mhewedy-playground/Chat" rel="noopener ugc nofollow" target="_blank">https://github.com/mhewedy-playground/Chat</a>çœ‹çœ‹æ•´ä¸ªå®ç°</p><p id="6abe" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°èŠå¤©æœåŠ¡çš„è¿è¡Œã€‚</p></div><div class="ab cl kf kg hx kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="im in io ip iq"><h1 id="b7f9" class="md me it bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">èŠå¤©æœåŠ¡æ­£åœ¨è¿è¡Œ</h1><p id="2463" class="pw-post-body-paragraph km kn it ko b kp nb kr ks kt nc kv kw kx nd kz la lb ne ld le lf nf lh li lj im bi translated">è®©æˆ‘ä»¬åƒä¸‹é¢è¿™æ ·å¹¶æ’æ‰“å¼€ä¸¤ä¸ªchromeçª—å£ï¼Œè¿™æ ·æµ‹è¯•å°±å®¹æ˜“äº†:</p><figure class="om on oo op gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pd"><img src="../Images/3f9a35623ad5bd7acd00b8f5c6f3f39b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XoztHPhcHYib9RB9hbmLlQ.png"/></div></div></figure><blockquote class="pe pf pg"><p id="f207" class="km kn nw ko b kp kq kr ks kt ku kv kw ph ky kz la pi lc ld le pj lg lh li lj im bi translated">ä½ éœ€è¦é¦–å…ˆå¯åŠ¨GolangèŠå¤©æœåŠ¡ï¼Œå¹¶ç¡®ä¿å®ƒè¿æ¥åˆ°RedisæœåŠ¡å™¨ï¼Œä½ å¯èƒ½ä¼šå‘ç°æœ¬ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« æœ‰åŠ©äºåœ¨å‡ åˆ†é’Ÿå†…å®‰è£…å’Œé…ç½®Ubuntu VMä¸­çš„Redisã€‚</p></blockquote><h2 id="abfb" class="nk me it bd mf nl nm dn mj nn no dp mn kx np nq mr lb nr ns mv lf nt nu mz nv bi translated">è¿æ¥å’Œè®¢é˜…:</h2><p id="810f" class="pw-post-body-paragraph km kn it ko b kp nb kr ks kt nc kv kw kx nd kz la lb ne ld le lf nf lh li lj im bi translated">é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å¯åŠ¨èŠå¤©æœåŠ¡:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="7cc8" class="nk me it nj b gy ou ov l ow ox">$ go build; ./chat</span></pre><p id="e89b" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">è®©æˆ‘ä»¬åœ¨å®ƒä»¬çš„æ¯ä¸ªé€‰é¡¹å¡ä¸Šå¯åŠ¨WebSocketå®¢æˆ·ç«¯ï¼Œåœ¨å·¦ä¾§é€‰é¡¹å¡ä¸Šé”®å…¥:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="6835" class="nk me it nj b gy ou ov l ow ox">let socket = new WebSocket("ws://localhost:8080/chat?username=<strong class="nj iu">wael</strong>");<br/>socket.onmessage = function(event) {<br/>  console.log(`[message] Data received from server: ${event.data}`);<br/>};</span></pre><p id="5e68" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">åœ¨å³è¾¹çš„æ ‡ç­¾ä¸Šå†™ä¸‹:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="c158" class="nk me it nj b gy ou ov l ow ox">let socket = new WebSocket("ws://localhost:8080/chat?username=<strong class="nj iu">mazen</strong>");<br/>socket.onmessage = function(event) {<br/>  console.log(`[message] Data received from server: ${event.data}`);<br/>};</span></pre><p id="1357" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">è¯·æ³¨æ„èŠå¤©æœåŠ¡æ—¥å¿—:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="b4ff" class="nk me it nj b gy ou ov l ow ox">connected from: [::1]:55471 user: wael<br/>starting the listener for user: wael on channels: [general random]<br/>connected from: [::1]:55490 user: mazen<br/>starting the listener for user: mazen on channels: [general random]</span></pre><p id="6afd" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">è®©æˆ‘ä»¬æ³¨æ„ä¸€ä¸‹ä½¿ç”¨<code class="fe ng nh ni nj b">redis-cli</code>çš„Rediså®¢æˆ·ç«¯:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="5f61" class="nk me it nj b gy ou ov l ow ox">127.0.0.1:6379&gt; <strong class="nj iu">client list</strong><br/>id=325 addr=127.0.0.1:58944 fd=9 name= age=98745 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=26 qbuf-free=32742 obl=0 oll=0 omem=0 events=r cmd=client<br/>id=852 addr=127.0.0.1:60006 fd=8 name= age=107 idle=104 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=smembers<br/>id=853 addr=127.0.0.1:60008 fd=10 name= age=107 idle=17 flags=P db=0 sub=2 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=ping<br/>id=854 addr=127.0.0.1:60010 fd=11 name= age=104 idle=14 flags=P db=0 sub=2 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=ping</span></pre><p id="5266" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">æ³¨æ„ï¼Œæˆ‘ä»¬æœ‰4ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ°Redis:ç¬¬ä¸€ä¸ªæ˜¯<code class="fe ng nh ni nj b">redis-cli</code>æœ¬èº«ã€‚ç¬¬äºŒä¸ªæ˜¯Rediså‘½ä»¤åœ¨æœåŠ¡å†…éƒ¨ä½¿ç”¨çš„è¿æ¥(<code class="fe ng nh ni nj b">publish</code>ã€<code class="fe ng nh ni nj b">smembers</code>ã€<code class="fe ng nh ni nj b">sadd</code>...ç­‰ç­‰)ã€‚æœ€åä¸¤ä¸ªæ˜¯ä¸¤ä¸ªå®¢æˆ·ç«¯(å·¦æ ‡ç­¾å®¢æˆ·ç«¯å’Œå³æ ‡ç­¾å®¢æˆ·ç«¯)çš„è®¢é˜…åŠŸèƒ½çš„è¿æ¥ã€‚</p><blockquote class="pe pf pg"><p id="ed80" class="km kn nw ko b kp kq kr ks kt ku kv kw ph ky kz la pi lc ld le pj lg lh li lj im bi translated">æ³¨æ„ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯åªæœ‰ä¸€ä¸ªåˆ°å®ƒç›‘å¬çš„æ‰€æœ‰é¢‘é“çš„æ‰“å¼€çš„è¿æ¥ã€‚</p></blockquote><p id="9dcb" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">ç°åœ¨ï¼Œè®©æˆ‘ä»¬å‘å·¦ä¾§é€‰é¡¹å¡å®¢æˆ·ç«¯æ·»åŠ å¦å¤–3ä¸ªé€šé“ï¼Œå¹¶é‡æ–°æ£€æŸ¥å‘½ä»¤ã€‚åœ¨å·¦ä¾§é€‰é¡¹å¡ä¸­é”®å…¥:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="aaec" class="nk me it nj b gy ou ov l ow ox">socket.send('{"command": 0, "channel": "new_channel1"}')<br/>socket.send('{"command": 0, "channel": "new_channel2"}')<br/>socket.send('{"command": 0, "channel": "new_channel3"}')</span></pre><blockquote class="pe pf pg"><p id="4947" class="km kn nw ko b kp kq kr ks kt ku kv kw ph ky kz la pi lc ld le pj lg lh li lj im bi translated">åŒæ ·ï¼Œå‘½ä»¤=0è¡¨ç¤ºè®¢é˜…ï¼Œå‘½ä»¤=1è¡¨ç¤ºå–æ¶ˆè®¢é˜…ï¼Œå‘½ä»¤=2è¡¨ç¤ºå‘é€èŠå¤©æ¶ˆæ¯ã€‚</p></blockquote><p id="f04c" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">è¯·æ³¨æ„èŠå¤©æœåŠ¡æ—¥å¿—:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="f423" class="nk me it nj b gy ou ov l ow ox">starting the listener for user: wael on channels: [general random new_channel1]<br/>starting the listener for user: wael on channels: [general random new_channel2 new_channel1]<br/>starting the listener for user: wael on channels: [general random new_channel3 new_channel2 new_channel1]</span></pre><p id="4a66" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">å®ƒæŒ‡ç¤ºä½¿ç”¨â€œwaelâ€(å·¦è¾¹çš„ç”¨æˆ·)ç°åœ¨æ­£åœ¨æ”¶å¬æ€»å…±5ä¸ªæˆ¿é—´ï¼Œä½†æ˜¯è®©æˆ‘ä»¬æ£€æŸ¥åˆ°Redisçš„TCPè¿æ¥ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬æ²¡æœ‰è¿‡å¤šåœ°ä½¿ç”¨å®ƒä»¬:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="5c7f" class="nk me it nj b gy ou ov l ow ox">127.0.0.1:6379&gt; client list<br/>id=325 addr=127.0.0.1:58944 fd=9 name= age=99646 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=26 qbuf-free=32742 obl=0 oll=0 omem=0 events=r cmd=client<br/>id=882 addr=127.0.0.1:60066 fd=8 name= age=99 idle=83 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=smembers<br/>id=884 addr=127.0.0.1:60070 fd=11 name= age=93 idle=3 flags=P db=0 sub=2 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=ping<br/>id=887 addr=127.0.0.1:60076 fd=10 name= age=83 idle=23 flags=P db=0 sub=5 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=ping</span></pre><p id="b331" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">å¾ˆå¥½ï¼Œæˆ‘ä»¬ä»ç„¶ä½¿ç”¨4ä¸ªé€šé“ï¼Œä½ å¯èƒ½ä¼šæ³¨æ„åˆ°è¿æ¥çš„<code class="fe ng nh ni nj b">id</code>å·²ç»æ”¹å˜ã€‚</p><h2 id="8f23" class="nk me it bd mf nl nm dn mj nn no dp mn kx np nq mr lb nr ns mv lf nt nu mz nv bi translated">å‘é€æ¶ˆæ¯:</h2><p id="3826" class="pw-post-body-paragraph km kn it ko b kp nb kr ks kt nc kv kw kx nd kz la lb ne ld le lf nf lh li lj im bi translated">ç°åœ¨è®©æˆ‘ä»¬ä»å·¦è¾¹çš„<strong class="ko iu"> <em class="nw">å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯</em> </strong>åˆ°â€œé€šç”¨â€é¢‘é“:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="a378" class="nk me it nj b gy ou ov l ow ox">socket.send('{"command": 2, "channel": "general", "content": "some general content"}')</span></pre><p id="2422" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">æ¶ˆæ¯å°†è¢«å‘å¸ƒåˆ°<strong class="ko iu"><em class="nw">ã€generalã€‘</em></strong>é€šé“ï¼Œç„¶åå®ƒå°†è¢«ä¸¤ä¸ªå®¢æˆ·ç«¯æ¥æ”¶å¹¶è¢«æ¨é€åˆ°ä¸¤ä¸ªå®¢æˆ·ç«¯ä¸Šçš„WebSocket:</p><figure class="om on oo op gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pk"><img src="../Images/67f8ed718b03dd6751175787c12d4e2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LEgTLeWSUoSVb_cu0xHjmA.png"/></div></div></figure><p id="c064" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•å°†æ¶ˆæ¯æ¨é€åˆ°å·¦ä¾§å®¢æˆ·ç«¯ç‹¬å çš„é¢‘é“ä¹‹ä¸€(ä¾‹å¦‚â€œ<strong class="ko iu"><em class="nw">ã€new _ channel 1ã€‘</em></strong>),å®ƒå°†ä¸ä¼šå‡ºç°åœ¨å³ä¾§å®¢æˆ·ç«¯ã€‚</p><p id="0c1b" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">è®©æˆ‘ä»¬æ¥çœ‹çœ‹Redisçš„æ•°æ®ç»“æ„:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="9b28" class="nk me it nj b gy ou ov l ow ox">127.0.0.1:6379&gt; keys *<br/>1) "users"<br/>2) "user:wael:channels"<br/>3) "channels"<br/>127.0.0.1:6379&gt; smembers users<br/>1) "mazen"<br/>2) "wael"<br/>127.0.0.1:6379&gt; smembers channels<br/>1) "general"<br/>2) "random"<br/>127.0.0.1:6379&gt; smembers user:wael:channels<br/>1) "new_channel3"<br/>2) "new_channel2"<br/>3) "new_channel1"</span></pre><p id="e1f2" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œä¸æˆ‘ä»¬çš„èŠå¤©æœåŠ¡ç›¸å…³çš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨Redisä¸­ï¼Œè¿™æœ‰åŠ©äºèŠå¤©æœåŠ¡åœ¨æ°´å¹³æ–¹å‘<strong class="ko iu"> <em class="nw">æ‰©å±•</em> </strong>ã€‚</p><blockquote class="pe pf pg"><p id="17c6" class="km kn nw ko b kp kq kr ks kt ku kv kw ph ky kz la pi lc ld le pj lg lh li lj im bi translated">æˆ‘ä»¬å¯ä»¥ä¾èµ–Redisä½¿ç”¨<code class="fe ng nh ni nj b">INCR</code>å‘½ä»¤æä¾›çš„åŸå­æ€§ï¼Œå¹¶ç”¨æƒŸä¸€çš„IDæ ‡è®°æ¯æ¡èŠå¤©æ¶ˆæ¯ï¼Œä»¥ç¡®ä¿å®¢æˆ·ç«¯æ”¶åˆ°çš„æ¯æ¡æ¶ˆæ¯éƒ½æ˜¯ä¸€è‡´çš„ã€‚</p></blockquote><h2 id="c677" class="nk me it bd mf nl nm dn mj nn no dp mn kx np nq mr lb nr ns mv lf nt nu mz nv bi translated">æ–­å¼€è¿æ¥:</h2><p id="2196" class="pw-post-body-paragraph km kn it ko b kp nb kr ks kt nc kv kw kx nd kz la lb ne ld le lf nf lh li lj im bi translated">è®©æˆ‘ä»¬è¯•ç€å°†<strong class="ko iu"> <em class="nw">å³è¾¹çš„</em> </strong>å®¢æˆ·ç«¯æ–­å¼€ï¼Œå¹¶å†æ¬¡æ£€æŸ¥<code class="fe ng nh ni nj b">users</code>çš„Redisè®¾ç½®ã€‚åœ¨chrome issueçš„å³ä¾§é€‰é¡¹å¡ä¸Š:</p><p id="7f63" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">æˆ‘ä»¬æœ‰ä¸€ä¸ªAPIæ¥åˆ—å‡ºæˆ‘ä»¬æ‹¥æœ‰çš„ç”¨æˆ·:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="042e" class="nk me it nj b gy ou ov l ow ox">watch curl -s <a class="ae lk" href="http://localhost:8080/users" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/users</a></span></pre><p id="1693" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">åœ¨æˆ‘çš„æ¡ˆä¾‹ä¸­æ˜¾ç¤º:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="518e" class="nk me it nj b gy ou ov l ow ox">Every 2.0s: curl -s <a class="ae lk" href="http://localhost" rel="noopener ugc nofollow" target="_blank">http://localhost</a>...  Muhammads-MacBook-Pro.local: Sun May 24 11:21:29 2020</span><span id="716a" class="nk me it nj b gy oy ov l ow ox">["mazen","wael"]</span></pre><p id="5597" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">ç°åœ¨è®©æˆ‘ä»¬è½¬åˆ°chromeçš„å³è¾¹æ ‡ç­¾ï¼Œå…³é—­è¿æ¥:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="c2dc" class="nk me it nj b gy ou ov l ow ox">socket.close()</span></pre><p id="87ed" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">æ‚¨ä¼šæ³¨æ„åˆ°curl watchå‘½ä»¤çš„ç»“æœå‘ç”Ÿäº†å˜åŒ–:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="c718" class="nk me it nj b gy ou ov l ow ox">Every 2.0s: curl -s <a class="ae lk" href="http://localhost" rel="noopener ugc nofollow" target="_blank">http://localhost</a>...  Muhammads-MacBook-Pro.local: Sun May 24 11:22:16 2020</span><span id="4973" class="nk me it nj b gy oy ov l ow ox">["wael"]</span></pre><p id="6f62" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">è®©æˆ‘ä»¬çœ‹çœ‹Redis:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="7949" class="nk me it nj b gy ou ov l ow ox">127.0.0.1:6379&gt; smembers users<br/>1) "wael"</span></pre><h1 id="452e" class="md me it bd mf mg pl mi mj mk pm mm mn mo pn mq mr ms po mu mv mw pp my mz na bi">ğŸ‘ğŸ‘ğŸ‘</h1><blockquote class="pe pf pg"><p id="02e1" class="km kn nw ko b kp kq kr ks kt ku kv kw ph ky kz la pi lc ld le pj lg lh li lj im bi translated">æˆ‘ç”¨æ¥è°ƒè¯•å‘é€ç»™Redisçš„å‘½ä»¤çš„ä¸€ä¸ªæ–¹ä¾¿çš„å‘½ä»¤æ˜¯<code class="fe ng nh ni nj b"><em class="it">MONITOR</em></code>,å®ƒç”¨æ¥æ‰“å°RedisæœåŠ¡å™¨æ”¶åˆ°çš„æ¯ä¸€ä¸ªå‘½ä»¤ã€‚</p></blockquote></div><div class="ab cl kf kg hx kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="im in io ip iq"><h1 id="47e0" class="md me it bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">æµ‹è¯•æ°´å¹³å¯ä¼¸ç¼©æ€§</h1><p id="b875" class="pw-post-body-paragraph km kn it ko b kp nb kr ks kt nc kv kw kx nd kz la lb ne ld le lf nf lh li lj im bi translated">æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å¯åŠ¨ä¸¤ä¸ªèŠå¤©æœåŠ¡ï¼Œå¹¶å°†æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ°å…¶ä¸­ä¸€ä¸ª:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="71ef" class="nk me it nj b gy ou ov l ow ox">$ go build; PORT=8080 ./chat &amp; PORT=8081 ./chat &amp;<br/>[1] 51535<br/>[2] 51536</span></pre><p id="ddf3" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">ç°åœ¨è®©æˆ‘ä»¬æ‰“å¼€chromeï¼Œå°†å·¦ä¾§å®¢æˆ·ç«¯æŒ‡å‘8080æœåŠ¡ï¼Œå°†å³ä¾§å®¢æˆ·ç«¯æŒ‡å‘8081æœåŠ¡:</p><p id="a41a" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">åœ¨å·¦ä¾§çš„é€‰é¡¹å¡ä¸Šï¼Œç²˜è´´:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="1b86" class="nk me it nj b gy ou ov l ow ox">let socket = new WebSocket("ws://localhost:<strong class="nj iu">8080</strong>/chat?username=<strong class="nj iu">wael</strong>");<br/>socket.onmessage = function(event) {<br/>  console.log(`[message] Data received from server: ${event.data}`);<br/>};</span></pre><p id="6ea3" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">åœ¨å³è¾¹çš„é€‰é¡¹å¡ä¸Šï¼Œç²˜è´´:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="7887" class="nk me it nj b gy ou ov l ow ox">let socket = new WebSocket("ws://localhost:<strong class="nj iu">8081</strong>/chat?username=<strong class="nj iu">mazen</strong>");<br/>socket.onmessage = function(event) {<br/>  console.log(`[message] Data received from server: ${event.data}`);<br/>};</span></pre><p id="70f5" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">åœ¨å·¦ä¾§çš„é€‰é¡¹å¡ä¸Šï¼Œæˆ‘ä»¬å‘åŒæ–¹éƒ½åº”è¯¥è®¢é˜…çš„â€œé€šç”¨â€é¢‘é“å‘é€ä¸€æ¡æ¶ˆæ¯:</p><pre class="om on oo op gt oq nj or os aw ot bi"><span id="5050" class="nk me it nj b gy ou ov l ow ox">socket.send('{"command": 2, "channel": "general", "content": "some general content"}')</span></pre><p id="442e" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">æ˜¯çš„ï¼Œå®ƒæ­£åœ¨å·¥ä½œ:</p><figure class="om on oo op gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pq"><img src="../Images/61a335ff9b5b9e8b985b6dbcb8ac2fed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LAaHU3mRO3Dfk0o2m4gGeg.png"/></div></div></figure><h1 id="5d5a" class="md me it bd mf mg pl mi mj mk pm mm mn mo pn mq mr ms po mu mv mw pp my mz na bi">ğŸ‘ğŸ‘ğŸ‘ ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰</h1></div><div class="ab cl kf kg hx kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="im in io ip iq"><p id="64ee" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†å¦‚ä½•ä½¿ç”¨Rediså’ŒGolangå¼ºå¤§çš„goroutineså’Œä½¿ç”¨WebSocketç¼–è¯‘çš„é€šé“ï¼Œä½¿ç”¨å¼ºå¤§çš„åº“Gorilla Toolkit WebSocketå’ŒGo-Redisæ¥æ„å»ºä¸€ä¸ª<strong class="ko iu"><em class="nw"/></strong><strong class="ko iu"><em class="nw">å¤šé€šé“</em> </strong>èŠå¤©æœåŠ¡ã€‚</p><p id="072b" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">è¯·æ³¨æ„ï¼Œè¯¥ä»£ç ä¸æ˜¯æœ€å¥½çš„ï¼Œä¹Ÿä¸æ˜¯ç”Ÿäº§çº§çš„ï¼Œå®ƒæ˜¯ä½œä¸ºæ¦‚å¿µéªŒè¯ç¼–å†™çš„ã€‚</p><p id="e0e0" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">åŒæ ·ï¼Œä½ å¯ä»¥åœ¨Githubæ‰¾åˆ°æºä»£ç :<a class="ae lk" href="https://github.com/mhewedy-playground/Chat" rel="noopener ugc nofollow" target="_blank">https://github.com/mhewedy-playground/Chat</a></p></div><div class="ab cl kf kg hx kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="im in io ip iq"><p id="a1a4" class="pw-post-body-paragraph km kn it ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj im bi translated">å‚è€ƒèµ„æ–™:</p><div class="ll lm gp gr ln lo"><a href="https://redis.io/topics/pubsub" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab fo"><div class="lq ab lr cl cj ls"><h2 class="bd iu gy z fp lt fr fs lu fu fw is bi translated">å‘å¸ƒ/è®¢é˜…Redis</h2><div class="lv l"><h3 class="bd b gy z fp lt fr fs lu fu fw dk translated">è®¢é˜…ã€å–æ¶ˆè®¢é˜…å’Œå‘å¸ƒå®ç°å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯ä¼ é€’èŒƒå¼ï¼Œå…¶ä¸­(å¼•ç”¨ç»´åŸºç™¾ç§‘)å‘é€è€…â€¦</h3></div><div class="lw l"><p class="bd b dl z fp lt fr fs lu fu fw dk translated">redis.io</p></div></div><div class="lx l"><div class="pr l lz ma mb lx mc jz lo"/></div></div></a></div><div class="ll lm gp gr ln lo"><a href="https://www.wikiwand.com/en/Publish%E2%80%93subscribe_pattern" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab fo"><div class="lq ab lr cl cj ls"><h2 class="bd iu gy z fp lt fr fs lu fu fw is bi translated">å‘å¸ƒ-è®¢é˜…æ¨¡å¼|ç»´åŸºç½‘</h2><div class="lv l"><h3 class="bd b gy z fp lt fr fs lu fu fw dk translated">åœ¨è½¯ä»¶æ¶æ„ä¸­ï¼Œå‘å¸ƒ-è®¢é˜…æ˜¯ä¸€ç§æ¶ˆæ¯ä¼ é€’æ¨¡å¼ï¼Œæ¶ˆæ¯çš„å‘é€è€…(ç§°ä¸ºå‘å¸ƒè€…)ä¸â€¦</h3></div><div class="lw l"><p class="bd b dl z fp lt fr fs lu fu fw dk translated">www.wikiwand.com</p></div></div><div class="lx l"><div class="ps l lz ma mb lx mc jz lo"/></div></div></a></div><div class="ll lm gp gr ln lo"><a href="https://github.com/gorilla/websocket" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab fo"><div class="lq ab lr cl cj ls"><h2 class="bd iu gy z fp lt fr fs lu fu fw is bi translated">å¤§çŒ©çŒ©/ç½‘ç»œæ’åº§</h2><div class="lv l"><h3 class="bd b gy z fp lt fr fs lu fu fw dk translated">Gorilla WebSocketæ˜¯WebSocketåè®®çš„Goå®ç°ã€‚Gorilla WebSocketåŒ…æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„â€¦</h3></div><div class="lw l"><p class="bd b dl z fp lt fr fs lu fu fw dk translated">github.com</p></div></div><div class="lx l"><div class="pt l lz ma mb lx mc jz lo"/></div></div></a></div><div class="ll lm gp gr ln lo"><a href="https://github.com/go-redis/redis" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab fo"><div class="lq ab lr cl cj ls"><h2 class="bd iu gy z fp lt fr fs lu fu fw is bi translated">go-redis/redis</h2><div class="lv l"><h3 class="bd b gy z fp lt fr fs lu fu fw dk translated">æ”¯æŒ:APIæ–‡æ¡£:https://pkg.go.dev/github.com/go-redis/redis/v8?tab=doc.ç¤ºä¾‹â€¦</h3></div><div class="lw l"><p class="bd b dl z fp lt fr fs lu fu fw dk translated">github.com</p></div></div><div class="lx l"><div class="pu l lz ma mb lx mc jz lo"/></div></div></a></div></div></div>    
</body>
</html>