<html>
<head>
<title>Implementing a domain parser using Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Golang实现领域解析器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/implementing-a-domain-parser-using-golang-f88f83f56517?source=collection_archive---------2-----------------------#2022-09-07">https://levelup.gitconnected.com/implementing-a-domain-parser-using-golang-f88f83f56517?source=collection_archive---------2-----------------------#2022-09-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b05c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi kl translated">与IP地址不同，域名被设计成可读和可记忆的，但这并不是它们的全部。域名由多个部分组成:</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ku"><img src="../Images/7b2849828bced22c0fca84648556ca5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kD7yQO97DnoMqQHFPt7DSw.png"/></div></div></figure><p id="b341" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，我将用Golang实现一个简单的域解析器，使用公共后缀列表<a class="ae lg" href="https://publicsuffix.org/list/public_suffix_list.dat" rel="noopener ugc nofollow" target="_blank">。</a></p><blockquote class="lh li lj"><p id="91c0" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><strong class="jp ir">最终的Golang模块在我的</strong><a class="ae lg" href="https://github.com/mehrdadep/dex" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">Github</strong></a><strong class="jp ir">上有。</strong></p></blockquote><h2 id="50c9" class="lo lp iq bd lq lr ls dn lt lu lv dp lw jy lx ly lz kc ma mb mc kg md me mf mg bi translated">步骤1:下载并解析列表</h2><p id="fc91" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">公共后缀列表包括两个主要部分。ICANN和私有域名。ICANN部分以<code class="fe mm mn mo mp b">// ===BEGIN ICANN DOMAINS===</code>开头，以<code class="fe mm mn mo mp b">// ===END ICANN DOMAINS===</code>结尾。同样的规则也适用于私有域，它们的部分以<code class="fe mm mn mo mp b">// ===BEGIN PRIVATE DOMAINS===</code>开始，以<code class="fe mm mn mo mp b">// ===END PRIVATE DOMAINS===</code>结束。我们在解析列表和创建TLD树时需要考虑这一点。</p><p id="4c53" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我决定给解析后的文件添加一个<code class="fe mm mn mo mp b">mode</code>，并将其缓存在文件系统中的某个地方。<code class="fe mm mn mo mp b">mode=1</code>表示TLD属于ICANN部门,<code class="fe mm mn mo mp b">mode=2</code>表示私有域名。最终解析的文件如下所示</p><pre class="kv kw kx ky gt mq mp mr ms aw mt bi"><span id="c0ea" class="lo lp iq mp b gy mu mv l mw mx">.<br/>.<br/>.</span><span id="0fe8" class="lo lp iq mp b gy my mv l mw mx">travelersinsurance,1<br/>trust,1<br/>trv,1<br/>tube,1<br/>tui,1<br/>.<br/>.<br/>.</span><span id="83f9" class="lo lp iq mp b gy my mv l mw mx">ui.nabu.casa,2<br/>pony.club,2<br/>of.fashion,2<br/>.<br/>.<br/>.</span></pre><p id="7924" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些对于创建TLD树来说很方便。我已经给每个节点添加了<code class="fe mm mn mo mp b">isPrivate</code>和<code class="fe mm mn mo mp b">isIcann</code>。</p><pre class="kv kw kx ky gt mq mp mr ms aw mt bi"><span id="8cb8" class="lo lp iq mp b gy mu mv l mw mx">for _, line := range lines {<br/>   line = strings.TrimSpace(line)<br/>   if line != "" &amp;&amp; strings.HasPrefix(line, "// ===BEGIN ICANN DOMAINS===") {<br/>      mode = "1"<br/>   }<br/>   if line != "" &amp;&amp; strings.HasPrefix(line, "// ===BEGIN PRIVATE DOMAINS===") {<br/>      mode = "2"<br/>   }<br/>   if line != "" &amp;&amp; !strings.HasPrefix(line, "//") {<br/>      buffer.WriteString(line + "," + mode)<br/>      buffer.WriteString("\n")<br/>   }<br/>}</span></pre><h2 id="a60d" class="lo lp iq bd lq lr ls dn lt lu lv dp lw jy lx ly lz kc ma mb mc kg md me mf mg bi translated">步骤2:使用正则表达式提取不同的部分</h2><p id="b253" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我们需要去掉URL的模式部分。regex将为我们做这件事。</p><p id="abfa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提取TLD后，我们需要确保根域的格式是有效的。<code class="fe mm mn mo mp b">^[a-z0–9-\p{L}]{1,63}$</code>检查URL上根部分的有效性。</p><p id="2e2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提取URL的子域部分很容易。我们只需要用<code class="fe mm mn mo mp b">dot</code>分离器将<code class="fe mm mn mo mp b">subdomain+root</code>部分分开。</p><pre class="kv kw kx ky gt mq mp mr ms aw mt bi"><span id="6865" class="lo lp iq mp b gy mu mv l mw mx">func extractSubdomain(d string) (string, string) {<br/>   ps := strings.Split(d, ".")<br/>   l := <em class="lk">len</em>(ps)<br/>   if l == 1 {<br/>      return "", d<br/>   }<br/>   return strings.Join(ps[0:l-1], "."), ps[l-1]<br/>}</span></pre><p id="7a63" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果提取的TLD为空，我们需要检查URL是否是有效的IPv4/IPv6。在使用<code class="fe mm mn mo mp b">regex</code>匹配IPv4格式之前，我们可以使用内置的<code class="fe mm mn mo mp b">net.ParseIP(url)</code>，然后只检查IPv4(跳过IPv6的regex)</p><h2 id="61db" class="lo lp iq bd lq lr ls dn lt lu lv dp lw jy lx ly lz kc ma mb mc kg md me mf mg bi translated">第三步:Trie特里</h2><p id="a6c9" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我们使用Trie来构成TLD。以这部分清单为例</p><pre class="kv kw kx ky gt mq mp mr ms aw mt bi"><span id="2985" class="lo lp iq mp b gy mu mv l mw mx">// mz : http://www.uem.mz/<br/>// Submitted by registry &lt;antonio@uem.mz&gt;<br/>mz<br/>ac.mz<br/>adv.mz<br/>co.mz<br/>edu.mz<br/>gov.mz<br/>mil.mz<br/>net.mz<br/>org.mz</span></pre><p id="1375" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将像这样成为Trei的一部分</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mz"><img src="../Images/73a3feb4cb7ea2d1317983b74b41bc2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ejZs5XNLQZR8CLOSAiFQ1g.png"/></div></div></figure><p id="12ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">树的每个节点都包括一些关于该节点的信息，例如:</p><ul class=""><li id="b33a" class="na nb iq jp b jq jr ju jv jy nc kc nd kg ne kk nf ng nh ni bi translated">无论是私有域名还是ICANN</li><li id="aa98" class="na nb iq jp b jq nj ju nk jy nl kc nm kg nn kk nf ng nh ni bi translated">这是有效的TLD吗</li><li id="d5da" class="na nb iq jp b jq nj ju nk jy nl kc nm kg nn kk nf ng nh ni bi translated">是否是例外规则(以<code class="fe mm mn mo mp b">!</code>开头的规则)</li></ul><h2 id="bd95" class="lo lp iq bd lq lr ls dn lt lu lv dp lw jy lx ly lz kc ma mb mc kg md me mf mg bi translated">第四步:就这样，没有更多的步骤</h2><p id="f8a9" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">使用go模块安装<code class="fe mm mn mo mp b">dex</code>。</p><pre class="kv kw kx ky gt mq mp mr ms aw mt bi"><span id="a72f" class="lo lp iq mp b gy mu mv l mw mx">go get github.com/mehrdadep/dex</span></pre><p id="c9e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像这样使用它</p><pre class="kv kw kx ky gt mq mp mr ms aw mt bi"><span id="3882" class="lo lp iq mp b gy mu mv l mw mx">package main<br/><br/>import (<br/>"fmt"<br/>"github.com/mehrdadep/dex"<br/>)<br/><br/><br/>func main() {<br/> <br/>    cache := "/tmp/list.cache"</span><span id="d2bf" class="lo lp iq mp b gy my mv l mw mx">    extract, _ := dex.New(cache)</span><span id="34d7" class="lo lp iq mp b gy my mv l mw mx">    result:=extract.Parse("<a class="ae lg" href="https://mehrdadep.medium.com" rel="noopener">https://mehrdadep.medium.com</a>")</span><span id="067b" class="lo lp iq mp b gy my mv l mw mx">    fmt.Printf("%+v\n",result)</span><span id="5cb7" class="lo lp iq mp b gy my mv l mw mx">}</span></pre><p id="55b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将输出</p><pre class="kv kw kx ky gt mq mp mr ms aw mt bi"><span id="a4a2" class="lo lp iq mp b gy mu mv l mw mx">&amp;{IsIcann:true IsIpV4:false IsIpV6:false IsPrivate:false Subdomain:mehrdadep Root:medium Tld:com}</span></pre></div></div>    
</body>
</html>