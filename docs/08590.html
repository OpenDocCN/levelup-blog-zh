<html>
<head>
<title>I Hate Finding Great, Outdated Docker Images 🤬</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我讨厌发现伟大的，过时的Docker图像🤬</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/i-hate-finding-great-outdated-docker-images-9eea8f76ed0d?source=collection_archive---------14-----------------------#2021-05-14">https://levelup.gitconnected.com/i-hate-finding-great-outdated-docker-images-9eea8f76ed0d?source=collection_archive---------14-----------------------#2021-05-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bce7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">不同的CI平台如何自动和定期地构建和推送您的开源Docker映像。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/deccb7f3440d9b08bd73fcf51c19f6dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o7mamvIfKrJ-iBMQDyP_RA.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">安德烈·亨特在<a class="ae ky" href="https://unsplash.com/s/photos/angry?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="36e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最糟糕的事情莫过于在网上搜索适合您当前使用情况的Docker图片，却在几个误导性链接后发现您想要使用的图片是“最后一次推送:3年前”…</p><h1 id="ce90" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">最佳码头工人形象</h1><p id="8e36" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在搜索符合自己需求的公共docker图片时，你会寻找什么？我的意思是，这样的形象应该满足什么要求？</p><p id="6eee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我假设当你最后一次复制和粘贴docker图片到你的CI平台或舵图或任何你使用它的地方时，你确实考虑过这个问题。如果没有，现在或者下次再考虑吧。原因很简单，尽管在一个容器中，但您可能正在执行来自其他人的代码，这些人可能怀有恶意。</p><h2 id="02ed" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">什么是相关的</h2><p id="4c57" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">您是否需要访问源代码(Dockerfile)来验证和/或自己构建它？</p><p id="2d3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">必须是最近建的还是自动建的？以便它包含最新版本的库和工具？</p><p id="5be0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CI管道运行(和结果)是否也必须公开，以便您可以检查和验证构建过程？</p><p id="78ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会检查它所依赖的基本映像和它使用的版本吗？以便您可以确保兼容性，并且它使用最新的基本系统？</p><p id="f4ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尺寸重要吗？</p><p id="465e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你上一次在容器中使用秘密是什么时候，你没有100%检查其图像是否有恶意软件？</p><h2 id="eff6" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">如何建立你的公众形象</h2><p id="b505" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了回答你关于如何识别比其他人更可信的公共图像的问题，让我向你展示这个过程可能是什么样子的——并指出一些实际的例子。</p></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><h1 id="9334" class="lv lw it bd lx ly nl ma mb mc nm me mf jz nn ka mh kc no kd mj kf np kg ml mm bi translated">建立你的形象</h1><p id="471c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">每个Docker图像的基础是Docker文件。下面是我在构建图像时学到的一些东西——到目前为止还不完整，所以你必须自己看得更远，那里有很多好的来源和例子。</p><h2 id="cc27" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">使用<code class="fe nq nr ns nt b">ARG</code>来支持版本</h2><p id="d5a1" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">使用<code class="fe nq nr ns nt b">ARG</code>,您可以将变量传递给构建过程。这允许您在docker文件中做各种有趣的事情，比如传递版本或条件构建步骤。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="cbb7" class="ms lw it nt b gy ny nz l oa ob">ARG VERSION=latest<br/>FROM alpine:$VERSION AS base<br/># do some base work</span><span id="1173" class="ms lw it nt b gy oc nz l oa ob"># each `FROM` resets ARGs, so define it before you use it<br/>FROM base AS case-one<br/>ARG CASE_VALUE=something<br/># run command(s) that use CASE_VALUE</span><span id="a343" class="ms lw it nt b gy oc nz l oa ob">FROM base AS case-two<br/>ARG CASE_VALUE=other<br/># run command(s) that use CASE_VALUE</span><span id="5f4b" class="ms lw it nt b gy oc nz l oa ob">ARG CASE=one<br/>FROM case-$CASE<br/># continue build steps<br/></span></pre><ul class=""><li id="f0f1" class="od oe it lb b lc ld lf lg li of lm og lq oh lu oi oj ok ol bi translated">确保在使用<code class="fe nq nr ns nt b">FROM</code>后定义默认值并重新定义参数。</li><li id="ae5e" class="od oe it lb b lc om lf on li oo lm op lq oq lu oi oj ok ol bi translated">运行<code class="fe nq nr ns nt b">docker build --build-arg CASE=two</code>来基于上面例子中的<code class="fe nq nr ns nt b">case-two</code>构建一个映像。</li></ul><p id="1bbd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">链接到Dockerfile <code class="fe nq nr ns nt b">ARG</code>参考:</p><div class="or os gp gr ot ou"><a href="https://docs.docker.com/engine/reference/builder/#arg" rel="noopener  ugc nofollow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd iu gy z fp oz fr fs pa fu fw is bi translated">Dockerfile文件参考</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">本页描述了您可以在Dockerfile文件中使用的命令。当您阅读完本页后，请参阅…</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">docs.docker.com</p></div></div><div class="pd l"><div class="pe l pf pg ph pd pi ks ou"/></div></div></a></div><h2 id="b291" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">为多种架构构建</h2><p id="63b4" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">你可能不需要，但是不同架构的使用，也就是<code class="fe nq nr ns nt b">arm64</code>，正在上升。如果您使用的基础映像支持它，那么您只需要在构建管道中增加几个步骤就可以构建多个架构了！</p><p id="4783" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经在下面的文章中描述了如何建立一个多拱图像，所以我在这里不再赘述。关键是:当你发布开源软件时，你的受众是广泛的，所以不要遗漏那些正在尝试新架构的极客，比如在树莓Pi上运行《我的世界》服务器...</p><div class="or os gp gr ot ou"><a href="https://betterprogramming.pub/setting-up-a-multi-arch-docker-build-with-circleci-and-alpine-for-your-apple-m1-ba739ef1f754" rel="noopener  ugc nofollow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd iu gy z fp oz fr fs pa fu fw is bi translated">用CircleCI和Alpine(为您的Apple M1)设置多拱门码头构件</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">为多个基本映像版本和平台构建Docker映像的简洁设置</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">better编程. pub</p></div></div><div class="pd l"><div class="pj l pf pg ph pd pi ks ou"/></div></div></a></div></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><h1 id="bab9" class="lv lw it bd lx ly nl ma mb mc nm me mf jz nn ka mh kc no kd mj kf np kg ml mm bi translated">添加CI平台</h1><p id="1adb" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">现在，您的Dockerfile已经在您的公共Git存储库中了(再次，在这里做一些假设…)，是时候在管道中构建它了——可能用于多种架构。</p><p id="2b87" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不同管道中的方法是不同的，但它们都有一些共同点:它们可以在您推送代码时被触发，它们允许您使用Docker服务或Docker-in-Docker ( <code class="fe nq nr ns nt b">dind</code>)构建Docker映像。他们都非常有能力建立你的公众码头工人形象，所以不要浪费太多时间选择。</p><blockquote class="pk"><p id="1f64" class="pl pm it bd pn po pp pq pr ps pt lu dk translated">为了建立公共Docker形象，你的CI平台的选择应该是:“可用的那个”。</p></blockquote><p id="d9db" class="pw-post-body-paragraph kz la it lb b lc pu ju le lf pv jx lh li pw lk ll lm px lo lp lq py ls lt lu im bi translated">我将在另一篇文章中发布关于使用这些CI平台的详细信息，但我想在这里提到一些差异和示例:</p><h2 id="aa67" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">基于机器的CI平台</h2><p id="187c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这些CI平台在虚拟机上运行您的代码，因此您可以选择它们运行的机器映像(例如<code class="fe nq nr ns nt b">ubuntu:bionic</code>或<code class="fe nq nr ns nt b">ubuntu-2004:202101–01</code>或<code class="fe nq nr ns nt b">macos</code>或<code class="fe nq nr ns nt b">windows-latest</code>)。</p><p id="2d41" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例子有<a class="ae ky" href="https://travis-ci.com" rel="noopener ugc nofollow" target="_blank"> Travis-CI </a>、<a class="ae ky" href="https://circleci.com" rel="noopener ugc nofollow" target="_blank"> Circle-CI </a>(如果使用<a class="ae ky" href="https://circleci.com/docs/2.0/configuration-reference/?section=configuration#machine" rel="noopener ugc nofollow" target="_blank"> Circle-CI机器执行器</a>)、<a class="ae ky" href="https://docs.github.com/en/actions" rel="noopener ugc nofollow" target="_blank"> GitHub动作</a>或<a class="ae ky" href="https://semaphoreci.com" rel="noopener ugc nofollow" target="_blank">信号量-CI </a></p><ul class=""><li id="9d0c" class="od oe it lb b lc ld lf lg li of lm og lq oh lu oi oj ok ol bi translated">我用Travis-CI构建的多拱<code class="fe nq nr ns nt b">dnsmasq</code> Docker形象的例子:<code class="fe nq nr ns nt b"><a class="ae ky" href="https://github.com/DrPsychick/docker-dnsmasq" rel="noopener ugc nofollow" target="_blank">drpsychick/dnsmasq</a></code>(不是最好的例子，我必须承认，但确实有效)。</li><li id="a78c" class="od oe it lb b lc om lf on li oo lm op lq oq lu oi oj ok ol bi translated">GitHub Actions通过一个适当的动作让它变得简单:<a class="ae ky" href="https://github.com/marketplace/actions/build-and-push-docker-images" rel="noopener ugc nofollow" target="_blank">构建并推送Docker图片</a>。</li></ul><h2 id="edcd" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">基于Docker的CI平台</h2><p id="c17d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这些CI平台在docker映像中运行您的代码。在每个构建阶段，您可以选择不同的映像来运行代码，因此非常灵活。然而，你需要接受的是，在docker中运行任何东西也可能带来一些挑战:访问磁盘空间、服务之间的通信或与远程docker引擎的通信等等</p><p id="193a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如<a class="ae ky" href="https://about.gitlab.com/stages-devops-lifecycle/continuous-integration/" rel="noopener ugc nofollow" target="_blank"> GitLab-CI </a>、<a class="ae ky" href="https://circleci.com" rel="noopener ugc nofollow" target="_blank"> Circle-CI </a>或<a class="ae ky" href="https://semaphoreci.com" rel="noopener ugc nofollow" target="_blank"> Semaphore-CI </a></p><p id="6f46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了简化在基于Docker的CI平台上的构建，我发布了一组简单的<a class="ae ky" href="https://github.com/DrPsychick/docker-ci-images" rel="noopener ugc nofollow" target="_blank"> Docker CI映像</a>，其中包含了使用<code class="fe nq nr ns nt b">kubectl</code>或<code class="fe nq nr ns nt b">helm</code>在kubernetes上构建、测试和部署映像所需的全部内容。它们实际上是通过Circle-CI管道构建并保持最新的。</p><div class="or os gp gr ot ou"><a href="https://github.com/DrPsychick/docker-ci-images" rel="noopener  ugc nofollow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd iu gy z fp oz fr fs pa fu fw is bi translated">DrPsychick/docker-ci-images</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">可以在基于docker的CI管道中使用的图像集合。而不是将依赖项安装在…</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">github.com</p></div></div><div class="pd l"><div class="pz l pf pg ph pd pi ks ou"/></div></div></a></div><p id="6ea0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为另一个例子，我的<a class="ae ky" href="https://github.com/DrPsychick/charts" rel="noopener ugc nofollow" target="_blank"> Helm Charts repository </a>使用这些带有Circle-CI的图像来测试带有<a class="ae ky" href="https://github.com/helm/chart-testing" rel="noopener ugc nofollow" target="_blank"> Chart-Testing </a>的图表，并将它们测试部署到管道中的<a class="ae ky" href="https://kind.sigs.k8s.io" rel="noopener ugc nofollow" target="_blank">Kubernetes-in-Docker(KinD)</a>集群。</p></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><h1 id="fc20" class="lv lw it bd lx ly nl ma mb mc nm me mf jz nn ka mh kc no kd mj kf np kg ml mm bi translated">添加计划</h1><p id="150e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">最后一步非常重要，也非常容易设置:安排管道定期运行:每周一次或每月一次。这将使您的图像保持最新，如果管道出现故障，您会收到通知(这种情况<strong class="lb iu">将</strong>发生)。</p><h2 id="f579" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">在中设置计划的管道运行</h2><ul class=""><li id="022d" class="od oe it lb b lc mn lf mo li qa lm qb lq qc lu oi oj ok ol bi translated">GitLab-CI:通过<a class="ae ky" href="https://docs.gitlab.com/ee/ci/pipelines/schedules.html" rel="noopener ugc nofollow" target="_blank"> GitLab UI </a>配置日程</li><li id="c9eb" class="od oe it lb b lc om lf on li oo lm op lq oq lu oi oj ok ol bi translated">GitHub动作:将时间表添加到您的<a class="ae ky" href="https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#onschedule" rel="noopener ugc nofollow" target="_blank">工作流程</a></li><li id="d3b8" class="od oe it lb b lc om lf on li oo lm op lq oq lu oi oj ok ol bi translated">Circle-CI:将时间表添加到您的管道<a class="ae ky" href="https://github.com/DrPsychick/docker-ci-images/blob/53f6137bde972aba4b9cea3a4142b75ce452274f/.circleci/config.yml#L128" rel="noopener ugc nofollow" target="_blank"> config.yml </a></li><li id="f164" class="od oe it lb b lc om lf on li oo lm op lq oq lu oi oj ok ol bi translated">Travis-CI:通过<a class="ae ky" href="https://docs.travis-ci.com/user/cron-jobs/" rel="noopener ugc nofollow" target="_blank"> Travis UI </a>配置cronjobs</li><li id="b46d" class="od oe it lb b lc om lf on li oo lm op lq oq lu oi oj ok ol bi translated">信号量-CI:通过<a class="ae ky" href="https://docs.semaphoreci.com/essentials/schedule-a-workflow-run/" rel="noopener ugc nofollow" target="_blank"> Web UI或CLI </a>配置</li></ul></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><h1 id="1a0c" class="lv lw it bd lx ly nl ma mb mc nm me mf jz nn ka mh kc no kd mj kf np kg ml mm bi translated">摘要</h1><p id="2199" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我希望这能让您很好地理解这个过程，并且它实际上很容易构建，然后向开源社区提供最新的图像。</p><p id="ded8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在一定的预算内，大多数CI平台对于开源项目都是免费的，所以<strong class="lb iu">试试吧！让我知道我是否可以为这个作品添加一些我已经忘记或错过的东西。或者给我一个你的项目的链接，例如Semaphore-CI，我可以把它添加到例子中。</strong></p><p id="2845" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完全没有必要浪费人们为建立有用的Docker形象所付出的努力——因为现在缺少的只是一个CI平台。</p></div></div>    
</body>
</html>