<html>
<head>
<title>LAG functionality on SQL Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL数据的滞后功能</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/lag-functionality-on-sql-data-d58027631d8a?source=collection_archive---------20-----------------------#2020-07-19">https://levelup.gitconnected.com/lag-functionality-on-sql-data-d58027631d8a?source=collection_archive---------20-----------------------#2020-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="54d0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">SQL与宇宙的中间话题</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/27846985d8e4b91f8c5509f7f0c14aa2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SK9pQB3NvXOVqapsOKyFVw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:美国宇航局</figcaption></figure><p id="7c17" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="lr">“火星就在那里，等着被到达。”—巴兹·奥尔德林</em></p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="7b67" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在火星上旅行和度假——这是科幻小说的内容。火星是地球的近邻，有深谷和高山。一座山是奥林匹斯山，惊人的高度为72000英尺(是珠穆朗玛峰海拔的两倍半)。这是一座盾状火山，很像构成夏威夷群岛的大型火山。</p><p id="75cc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">尽管火星的环境对人类不利(其中一个特点是在火星表面受到的辐射量可能会对健康造成危害)，我还是要创造一个场景，让我们想象在这个红色星球上度假。假设我们花了4年时间乘坐宇宙飞船去那个星球旅行。在这个星球的众多景点中，我们本周将参观奥林匹斯山。在山区基地，一个食品摊正在出售宇航员冰淇淋和其他冻干食品。</p><p id="edcc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">今天的SQL帖子使用假数据来展示<code class="fe ma mb mc md b">LAG</code>窗口函数。<em class="lr">我们开始吧。</em></p><h1 id="d976" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">创建数据</h1><p id="511f" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated">因为这是一个假设的场景，所以我将为食品摊创建一个月销售假想数据。</p><p id="5d13" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这里，我创建了名为<code class="fe ma mb mc md b">sales</code>的表:</p><pre class="kg kh ki kj gt nb md nc nd aw ne bi"><span id="ee16" class="nf mf iq md b gy ng nh l ni nj">CREATE TABLE sales (<br/>  months INT,<br/>  net_sales FLOAT<br/>);</span></pre><p id="a070" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，我将数据插入表中:</p><pre class="kg kh ki kj gt nb md nc nd aw ne bi"><span id="d2d8" class="nf mf iq md b gy ng nh l ni nj">INSERT INTO sales(months, net_sales)<br/>  VALUES (1, 8964),<br/>  (2, 4212),<br/>  (3, 5618),<br/>  (4, 7319),<br/>  (5, 9282);</span></pre><p id="0df9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我最后用一句<code class="fe ma mb mc md b">SELECT</code>的话来看待我的作品:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/61138da14c500a5033156a6bf749c798.png" data-original-src="https://miro.medium.com/v2/resize:fit:434/format:webp/1*tw9HX2Ut72MKP_GS-eXe4g.png"/></div></figure><p id="0f41" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，有5条<code class="fe ma mb mc md b">net_sales</code>记录，每条记录对应于小吃摊开放的一个月。</p><h1 id="ba3c" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">滞后窗口函数</h1><p id="87db" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated">假设我想查看上个月的净销售额，同时查看本月。这可以通过<code class="fe ma mb mc md b">LAG</code>窗口功能实现。这允许我们访问当前行之前特定偏移量处的行。就我们的例子而言，如果当前行是第4个<code class="fe ma mb mc md b">month</code>并且<code class="fe ma mb mc md b">net_sales</code>值是7319，那么在偏移量为1的情况下，我期望在该行的下一列中看到5618。类似地，对于其他记录，我们可以预期如下。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/5321ec594a2695e50b32fcf2eebbdaca.png" data-original-src="https://miro.medium.com/v2/resize:fit:802/format:webp/1*Yuyz-IWtvdo71JjaQ3d9lQ.png"/></div></figure><p id="3101" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">编码如下:</p><pre class="kg kh ki kj gt nb md nc nd aw ne bi"><span id="21e7" class="nf mf iq md b gy ng nh l ni nj">SELECT *<br/>  , LAG(net_sales, 1) OVER (ORDER BY months) "previous_month_sales"<br/>FROM sales;</span></pre><p id="6693" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对此有两点评论:</p><ul class=""><li id="5a80" class="nm nn iq kx b ky kz lb lc le no li np lm nq lq nr ns nt nu bi translated"><code class="fe ma mb mc md b">LAG</code>函数参数是返回值(这里是<code class="fe ma mb mc md b">net_sales</code>)和偏移量(这里是1)。</li><li id="9e13" class="nm nn iq kx b ky nv lb nw le nx li ny lm nz lq nr ns nt nu bi translated"><code class="fe ma mb mc md b">OVER</code>功能表示应用了<code class="fe ma mb mc md b">LAG</code>功能的数据窗口。这里，我们在整个数据集上应用这个函数，时间大约是几个月。</li></ul><p id="6409" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">查看查询的结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/4fdfcc324b6b18a7b7beefdafe487790.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/format:webp/1*yKIthItdAgQQ16JFAHvKbA.png"/></div></figure><p id="73cd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">真好。但是，让我们更进一步。假设我们要比较两个月销售额的百分比变化。这也可以做到:</p><pre class="kg kh ki kj gt nb md nc nd aw ne bi"><span id="65eb" class="nf mf iq md b gy ng nh l ni nj">WITH comparison AS (<br/>  SELECT *<br/>   , LAG(net_sales, 1) OVER (ORDER BY months) "previous_month_sales"<br/>  FROM sales<br/>)</span><span id="92b0" class="nf mf iq md b gy ob nh l ni nj">SELECT *<br/>  , CAST ((net_sales - previous_month_sales)  / previous_month_sales   <br/>           * 100 AS INT) "vs_previous_month"<br/>FROM comparison;</span></pre><p id="18c7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这个查询稍微复杂一点，它从表中计算一个值。我们来分解一下。</p><ul class=""><li id="e39b" class="nm nn iq kx b ky kz lb lc le no li np lm nq lq nr ns nt nu bi translated">首先，我需要为一个查询定义一个临时表(名为<code class="fe ma mb mc md b">comparison</code>)。该表允许将<code class="fe ma mb mc md b">previous_month_sales</code>定义为我们可以查询的列。(否则，它只会出现在表格视图中。)</li><li id="8412" class="nm nn iq kx b ky nv lb nw le nx li ny lm nz lq nr ns nt nu bi translated">在下一个查询中，我计算百分比变化，但是<code class="fe ma mb mc md b">CAST</code>将其作为一个<code class="fe ma mb mc md b">INT</code>，这样我在最终的表视图中就有了一个简洁明了的百分比。</li></ul><p id="107f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/bd479731d72171f3ac496229d7f71fc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*0im8X-gRnTFVlwckVWAObQ.png"/></div></figure><p id="2879" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">阅读和解释这张表，第二个月的销售额与前一个月相比下降了53%。第3个月的净销售额增长了33%，以此类推。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="cb58" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">各位，这些假数据到此为止！SQL工具箱的另一个主题。</p><p id="8133" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">作为参考，我有一系列SQL教程，涵盖了基本查询和中间查询。看一看！</p><ul class=""><li id="33dd" class="nm nn iq kx b ky kz lb lc le no li np lm nq lq nr ns nt nu bi translated"><a class="ae lz" rel="noopener ugc nofollow" target="_blank" href="/black-holes-planets-and-sql-5667e74b272a?source=friends_link&amp;sk=82cfce28709cee06c56254ede9cfc2bb">黑洞、行星和SQL </a></li><li id="8b70" class="nm nn iq kx b ky nv lb nw le nx li ny lm nz lq nr ns nt nu bi translated"><a class="ae lz" href="https://medium.com/swlh/touring-the-solar-system-with-sql-b2a9d167b829?source=friends_link&amp;sk=b77b267ffa08a803232c06afd85816b8" rel="noopener">用SQL漫游太阳系</a></li><li id="6695" class="nm nn iq kx b ky nv lb nw le nx li ny lm nz lq nr ns nt nu bi translated"><a class="ae lz" href="https://medium.com/swlh/searching-for-moons-with-sql-4d803738347c?source=friends_link&amp;sk=8e9af00e337fc5551e3ffe28cd7a2a46" rel="noopener">用SQL搜索卫星</a></li><li id="d1c5" class="nm nn iq kx b ky nv lb nw le nx li ny lm nz lq nr ns nt nu bi translated"><a class="ae lz" href="https://medium.com/swlh/classifying-black-holes-with-sql-88bd07b54e64?source=friends_link&amp;sk=5b4594dcf3d82881f1d316a90d118f3e" rel="noopener">用SQL对黑洞进行分类</a></li><li id="0fa3" class="nm nn iq kx b ky nv lb nw le nx li ny lm nz lq nr ns nt nu bi translated"><a class="ae lz" href="https://medium.com/@kwarmbein/joining-constellations-with-sql-af40f1255562?source=friends_link&amp;sk=0c5a75976efa60006cb3b2889120e1f2" rel="noopener">用SQL连接星座图</a></li><li id="03f8" class="nm nn iq kx b ky nv lb nw le nx li ny lm nz lq nr ns nt nu bi translated"><a class="ae lz" href="https://medium.com/swlh/solar-system-classifications-with-sql-f1a3a5e4730a?source=friends_link&amp;sk=6a9eafa2c412523f5243f708a4f8e279" rel="noopener">用SQL进行太阳系分类</a></li><li id="f3c9" class="nm nn iq kx b ky nv lb nw le nx li ny lm nz lq nr ns nt nu bi translated"><a class="ae lz" href="https://medium.com/swlh/many-to-many-relations-among-the-stars-1728ba18a2d0?source=friends_link&amp;sk=520341a6b29b886a2f71e13925559bf5" rel="noopener">星星之间的多(对多)关系</a></li><li id="8285" class="nm nn iq kx b ky nv lb nw le nx li ny lm nz lq nr ns nt nu bi translated"><a class="ae lz" href="https://medium.com/swlh/creating-tables-in-sql-a3c5995da5f7?source=friends_link&amp;sk=46f6eed6a011ef5c1959bb7e1d7c48bb" rel="noopener">在SQL中创建表格</a></li><li id="58d5" class="nm nn iq kx b ky nv lb nw le nx li ny lm nz lq nr ns nt nu bi translated"><a class="ae lz" href="https://medium.com/swlh/a-window-to-the-solar-system-d4e882031964?source=friends_link&amp;sk=f421d2e0c4758d29efb1a13a53b0799d" rel="noopener">通往太阳系的窗口</a></li></ul><p id="1635" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="lr">喜欢这些SQL帖子？有问题吗？大家在评论里聊聊吧！</em></p></div></div>    
</body>
</html>