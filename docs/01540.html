<html>
<head>
<title>Step by Step slow guide — Kubernetes Cluster on Raspberry Pi 4B — Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">循序渐进指南—树莓Pi 4B上的Kubernetes集群—第3部分</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/step-by-step-slow-guide-kubernetes-cluster-on-raspberry-pi-4b-part-3-899fc270600e?source=collection_archive---------7-----------------------#2020-01-11">https://levelup.gitconnected.com/step-by-step-slow-guide-kubernetes-cluster-on-raspberry-pi-4b-part-3-899fc270600e?source=collection_archive---------7-----------------------#2020-01-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/21ac29b36540cc9f3fd2d88617dee92c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YhCXgPAb7z9qb8Bu"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">尼古拉斯·皮卡德在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="4a73" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在前一部分中，我们初始化了主节点并添加了工作节点。现在，我们需要向我们的群集添加网络。我们这里有很多选择，但我们将使用印花棉布，因为这是在AWS和GKE上使用的。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h2 id="0bc7" class="ll lm it bd ln lo lp dn lq lr ls dp lt kr lu lv lw kv lx ly lz kz ma mb mc md bi translated">印花布项目——安装</h2><p id="0406" class="pw-post-body-paragraph kg kh it ki b kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated">首先，我们需要下载calico配置文件</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="f044" class="ll lm it mo b gy ms mt l mu mv">curl https://docs.projectcalico.org/manifests/calico.yaml -O</span></pre><p id="033d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将自动检测CIDR IP块，因此我们可以将yaml应用到我们的集群</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="7c01" class="ll lm it mo b gy ms mt l mu mv">kubectl apply -f calico.yaml</span></pre><p id="59b8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将需要一两分钟的时间，因此我们可以使用</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="ee6c" class="ll lm it mo b gy ms mt l mu mv">kubectl get pods --all-namespaces</span></pre><p id="9097" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦所有pod都在运行，我们就可以通过运行以下命令来确认所有节点现在都处于就绪状态</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="8e17" class="ll lm it mo b gy ms mt l mu mv">kubectl get nodes</span></pre><p id="54ac" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们也把标签<none>改名为“工人”</none></p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="2289" class="ll lm it mo b gy ms mt l mu mv">kubectl label node k8-w1 node-role.kubernetes.io/worker=worker<br/>kubectl label node k8-w2 node-role.kubernetes.io/worker=worker<br/>kubectl label node k8-w3 node-role.kubernetes.io/worker=worker</span></pre><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mw"><img src="../Images/b0b286bdf1bf66e0107a2587547e0139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W86Fb2XgZJwCVhCILxyr5w.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">运行Kubernetes集群</figcaption></figure><p id="940c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">恭喜您，您的Kubernetes集群现在正在运行！</p><p id="fe3a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们还将安装calicoctl，它将允许我们操作calico对象</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="51e1" class="ll lm it mo b gy ms mt l mu mv">cd /usr/local/bin/<br/>sudo curl -o calicoctl -O -L https://github.com/projectcalico/calicoctl/releases/download/v3.17.1/calicoctl-linux-arm64<br/>sudo chmod +x calicoctl</span></pre><p id="ab8b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们确认它工作正常</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="8583" class="ll lm it mo b gy ms mt l mu mv">calicoctl version</span></pre><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mw"><img src="../Images/5f45890df9852cb4c981a6d1cec0186e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*33WcUdXBInwMVGUi7dRkxQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">calicoctl成功运行</figcaption></figure><p id="e4bd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的calico客户端现在工作正常。然而，我们还没有完成(毕竟它被称为慢指南)。</p><h2 id="7bf3" class="ll lm it bd ln lo lp dn lq lr ls dp lt kr lu lv lw kv lx ly lz kz ma mb mc md bi translated">MetalLB负载平衡器安装</h2><p id="60fc" class="pw-post-body-paragraph kg kh it ki b kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated">由于我们没有外部负载平衡器，我们将需要一个软件解决方案，metalLB看起来是一个不错的选择。Calico和metaLB存在一些兼容性问题，您可以在这里<a class="ae kf" href="https://metallb.universe.tf/configuration/calico/" rel="noopener ugc nofollow" target="_blank">阅读更多内容</a>。然而，它们对于我们要做的事情并不重要。</p><p id="5ba8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们的主节点上，让我们安装负载平衡器。</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="97a1" class="ll lm it mo b gy ms mt l mu mv">kubectl apply -f <a class="ae kf" href="https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/namespace.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/namespace.yaml</a><br/>kubectl apply -f <a class="ae kf" href="https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/metallb.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/metallb.yaml</a><br/># On first install only<br/>kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)"</span></pre><p id="2d77" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们需要配置我们的IP池。确保它超出了本地DHCP的地址范围，但在路由器本地网络的范围内。让我们将下面的配置图保存为metalLB-config.yaml</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="30b9" class="ll lm it mo b gy ms mt l mu mv">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  namespace: metallb-system<br/>  name: config<br/>data:<br/>  config: |<br/>    address-pools:<br/>    - name: default<br/>      protocol: layer2<br/>      addresses:<br/>      - 192.168.1.200-192.168.254.254</span></pre><p id="3195" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以将其安装到集群中</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="6a41" class="ll lm it mo b gy ms mt l mu mv">kubectl apply -f metalLB-config.yaml</span></pre><p id="c2e3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就这样，我们都准备好了！</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="5d6a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">是时候做一些测试，确保一切正常。我们将为nginx创建一个包含4个副本的部署，并通过一个从负载均衡器获取外部地址的服务来公开它。我们将把文件保存为nginx-deployment.yaml</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="449d" class="ll lm it mo b gy ms mt l mu mv">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: nginx-deployment<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: nginx<br/>  replicas: 4<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: nginx<br/>    spec:<br/>      containers:<br/>      - name: nginx<br/>        image: nginx:latest<br/>        ports:<br/>        - containerPort: 80<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx-service<br/>spec:<br/>  selector:<br/>    app: nginx<br/>  ports:<br/>    - protocol: TCP<br/>      port: 80<br/>      targetPort: 80<br/>  externalTrafficPolicy: Local<br/>  type: LoadBalancer</span></pre><p id="5bd2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们应用它</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="bb6d" class="ll lm it mo b gy ms mt l mu mv">kubectl apply -f nginx-deployment.yaml</span></pre><p id="4723" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以确认我们的豆荚是通过跑步产生的</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="aaa9" class="ll lm it mo b gy ms mt l mu mv">kubectl get pods</span></pre><p id="a836" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们需要从服务中检索一个外部IP地址</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="9508" class="ll lm it mo b gy ms mt l mu mv">kubectl get svc nginx-service</span></pre><p id="f1de" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以使用curl来检查一切是否正常</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="3a3b" class="ll lm it mo b gy ms mt l mu mv">#change IP address to one that you got by running previous command<br/>curl 192.168.200.1</span></pre><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mw"><img src="../Images/0e2008199f5b834b142f6a68bd0e1cf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*128xz2dANTksfKw2-aMQDw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在我们的Kubernetes集群中运行的nginx的响应</figcaption></figure><p id="5dcf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">呜哇！我们得到了回应。看起来一切正常！</p><p id="b87e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们离开之前，让我们做一些清理并删除我们的nginx测试部署。</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="ce90" class="ll lm it mo b gy ms mt l mu mv">kubectl delete -f nginx-deployment.yaml</span></pre></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="77d6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就这些了，希望这个指南对你有用。它现在更新了所有内容的最新版本，这将有助于解决您可能遇到的任何问题。期待大家的提问和评论！</p><div class="mx my gp gr mz na"><a href="https://medium.com/@astrujic/step-by-step-slow-guide-kubernetes-cluster-on-raspberry-pi-4b-part-2-e1f2ee8f3011" rel="noopener follow" target="_blank"><div class="nb ab fo"><div class="nc ab nd cl cj ne"><h2 class="bd iu gy z fp nf fr fs ng fu fw is bi translated">循序渐进指南—树莓Pi 4B上的Kubernetes集群—第2部分</h2><div class="nh l"><h3 class="bd b gy z fp nf fr fs ng fu fw dk translated">在前一部分中，我们准备好了主节点和工作节点。准备就绪后，我们可以继续安装…</h3></div><div class="ni l"><p class="bd b dl z fp nf fr fs ng fu fw dk translated">medium.com</p></div></div><div class="nj l"><div class="nk l nl nm nn nj no jz na"/></div></div></a></div><div class="mx my gp gr mz na"><a href="https://medium.com/@astrujic/step-by-step-slow-guide-kubernetes-cluster-on-raspberry-pi-4b-part-1-6e4179c89cbc" rel="noopener follow" target="_blank"><div class="nb ab fo"><div class="nc ab nd cl cj ne"><h2 class="bd iu gy z fp nf fr fs ng fu fw is bi translated">循序渐进指南—树莓Pi 4B上的Kubernetes集群—第1部分</h2><div class="nh l"><h3 class="bd b gy z fp nf fr fs ng fu fw dk translated">基于RaspberryPi 4B、Containerd、Project Calico、MetalLB和Ubuntu Server的Kubernetes集群</h3></div><div class="ni l"><p class="bd b dl z fp nf fr fs ng fu fw dk translated">medium.com</p></div></div><div class="nj l"><div class="np l nl nm nn nj no jz na"/></div></div></a></div></div></div>    
</body>
</html>