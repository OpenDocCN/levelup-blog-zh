<html>
<head>
<title>The Good, the Bad and the Ugly of Taking Screenshots with Selenium and Java</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Selenium和Java截图的好，坏，丑</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/the-good-the-bad-and-the-ugly-of-taking-screenshots-with-selenium-and-java-c9da23e09842?source=collection_archive---------12-----------------------#2020-02-20">https://levelup.gitconnected.com/the-good-the-bad-and-the-ugly-of-taking-screenshots-with-selenium-and-java-c9da23e09842?source=collection_archive---------12-----------------------#2020-02-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/7f45ee8410376278d3026576b27e7d24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v2EFX8oR8oRHeS4OYf_S6w.jpeg"/></div></div></figure><p id="57cb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当然，我借用了克林特·伊斯特伍德主演的同名电影的名字。</p><p id="87c5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这篇文章是关于什么的？</p><p id="731a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它讨论了用Selenium和Java截屏的3种方法。</p><p id="d1a0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你猜，坏的，丑的，好的:)</p><h1 id="9b02" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">丑陋的那个</h1><p id="985a" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">糟糕的方法是用try/catch语句包装Selenium测试，如下所示:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="0e74" class="ml la it mh b gy mm mn l mo mp">import org.testng.Assert;<br/>import org.testng.annotations.Test;<br/>import PageObjects1.HomePage;<br/>import PageObjects1.ResultsPage;<br/>import framework.Screenshot;<br/></span><span id="7fd5" class="ml la it mh b gy mq mn l mo mp">public class TestClass extends TestBase{<br/> <br/>  private static String URL = “<a class="ae mr" href="http://www.vpl.ca" rel="noopener ugc nofollow" target="_blank">http://www.vpl.ca</a>";<br/> <br/>  @Test<br/>  public void search_For_Keyword_Works() { </span><span id="4005" class="ml la it mh b gy mq mn l mo mp">    try {<br/>       HomePage homePage = openSite();</span><span id="f782" class="ml la it mh b gy mq mn l mo mp">       ResultsPage resultsPage = homePage.searchFor(“java”);<br/> <br/>       Assert.assertTrue(resultsPage.header().contains(“java”), <br/>                         “Results Page header is incorrect!”);<br/>    }<br/>    catch (Exception e) {<br/>       Screenshot screenshot = new Screenshot(driver);<br/>       screenshot.capture(“Search_For_Keyword_Works”);<br/>    }</span><span id="bd56" class="ml la it mh b gy mq mn l mo mp">   }<br/> <br/>   private HomePage openSite() {<br/>     driver.get(URL);<br/>     <br/>     return new HomePage(driver);<br/>   }<br/> <br/>}</span></pre><p id="6074" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果页面类(HomePage和ResultsPage)生成了异常或者断言失败，则在catch子句中捕获一个屏幕截图。</p><p id="e318" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">截图将被存储在Maven项目的/target/screens文件夹中。该文件夹是在基本测试类的设置方法中创建的:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="d888" class="ml la it mh b gy mm mn l mo mp">import java.io.File;<br/>import org.openqa.selenium.WebDriver;<br/>import org.openqa.selenium.chrome.ChromeDriver;<br/>import org.testng.annotations.AfterMethod;<br/>import org.testng.annotations.BeforeClass;<br/>import org.testng.annotations.BeforeMethod;</span><span id="66cb" class="ml la it mh b gy mq mn l mo mp">public class TestBase {<br/> <br/>  public WebDriver driver;<br/>  private String chromeDriverPath =   <br/>           “./src/test/resources/chromedriver.exe”;<br/> <br/>  @BeforeClass<br/>  public void setUp_Class() {<br/>     new File(“./target/screenshots”).mkdir();<br/>  }<br/> <br/>  @BeforeMethod<br/>  public void setUp() {<br/>    System.setProperty(“webdriver.chrome.driver”, chromeDriverPath);<br/>    this.driver = new ChromeDriver();<br/>  }<br/> <br/>  @AfterMethod<br/>  public void tearDown() { <br/>    driver.quit();<br/>  }<br/> <br/>}</span></pre><p id="6193" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">基本测试类有两种设置方法:</p><ul class=""><li id="6268" class="ms mt it kd b ke kf ki kj km mu kq mv ku mw ky mx my mz na bi translated">一个使用BeforeClass注释并创建目标/截图文件夹</li><li id="0e37" class="ms mt it kd b ke nb ki nc km nd kq ne ku nf ky mx my mz na bi translated">另一个使用BeforeMethod注释并创建驱动程序对象</li></ul><p id="a04b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">截屏由以下类获取并保存:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="6ed8" class="ml la it mh b gy mm mn l mo mp">package framework;</span><span id="7afb" class="ml la it mh b gy mq mn l mo mp">import java.io.FileOutputStream;<br/>import java.time.LocalDateTime;<br/>import org.openqa.selenium.OutputType;<br/>import org.openqa.selenium.TakesScreenshot;<br/>import org.openqa.selenium.WebDriver;</span><span id="b6bb" class="ml la it mh b gy mq mn l mo mp">public class Screenshot {<br/> <br/>  private WebDriver driver; <br/>  private String folderPath = “./target/screenshots/”;<br/> <br/>  public Screenshot(WebDriver driver)<br/>  { <br/>    this.driver = driver;<br/>  }</span><span id="2bf1" class="ml la it mh b gy mq mn l mo mp">  public void capture(String fileName) <br/>  { <br/>    try { <br/>      String now = LocalDateTime.now().toString();</span><span id="e6ca" class="ml la it mh b gy mq mn l mo mp">      now = now.replace(“:”, “_”)<br/>               .replace(“;”, “_”)<br/>               .replace(“.”, “_”);<br/> <br/>      FileOutputStream file = new FileOutputStream(<br/>                 folderPath + fileName + now + “.png”);<br/> <br/>      byte[] info = <br/>      ((TakesScreenshot)driver).getScreenshotAs(OutputType.BYTES);<br/> <br/>      file.write(info);<br/>      file.close(); <br/>    } <br/>    catch (Exception ex) {<br/>      throw new RuntimeException(“cannot create screenshot;”, ex);<br/>    }<br/> <br/>  }</span><span id="4f50" class="ml la it mh b gy mq mn l mo mp">}</span></pre><p id="15a5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">截图文件名包括唯一性的now值。</p><h2 id="6d69" class="ml la it bd lb ng nh dn lf ni nj dp lj km nk nl ln kq nm nn lr ku no np lv nq bi translated">这种截图方式有什么问题？</h2><p id="d6ef" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">2件事是错误的:</p><ol class=""><li id="1ff5" class="ms mt it kd b ke kf ki kj km mu kq mv ku mw ky nr my mz na bi translated">好的单元测试不包括任何Java语句，如IF/ELSE、FOR、WHILE、SWITCH或TRY/CATCH。它只使用页面方法来打开站点，导航到被测试的页面，并在其上做出断言。</li><li id="52e5" class="ms mt it kd b ke nb ki nc km nd kq ne ku nf ky nr my mz na bi translated"><strong class="kd iu">每个测试都需要截图的重复代码。</strong></li></ol><p id="295b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这种情况下，测试类看起来并不好。</p><p id="4fda" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将其与干净简单的页面对象类进行比较。</p><p id="51ce" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是主页类:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="32b7" class="ml la it mh b gy mm mn l mo mp">import org.openqa.selenium.By;<br/>import org.openqa.selenium.WebDriver;<br/>import org.openqa.selenium.WebElement;</span><span id="3e87" class="ml la it mh b gy mq mn l mo mp">public class HomePage {</span><span id="73f4" class="ml la it mh b gy mq mn l mo mp"> private WebDriver driver;<br/> private static String TITLE = “Vancouver Public Library |”;<br/> <br/> private static By SEARCH_BOX_ID = By.id(“edit-search”);<br/> private static By SEARCH_BUTTON_ID = By.id(“edit-submit1”);<br/> <br/> public HomePage(WebDriver driver) {</span><span id="2241" class="ml la it mh b gy mq mn l mo mp">   this.driver = driver;<br/> <br/>   if (!driver.getTitle().equals(TITLE))<br/>     throw new RuntimeException(“Home Page is not displayed!”);</span><span id="11bc" class="ml la it mh b gy mq mn l mo mp"> }<br/> <br/> public ResultsPage searchFor(String keyword) {</span><span id="f8c2" class="ml la it mh b gy mq mn l mo mp">   WebElement searchBox = driver.findElement(SEARCH_BOX_ID);<br/>   searchBox.sendKeys(keyword);<br/> <br/>   WebElement searchButton = driver.findElement(SEARCH_BUTTON_ID);<br/>   searchButton.click();<br/> <br/>   return new ResultsPage(driver);</span><span id="524f" class="ml la it mh b gy mq mn l mo mp"> }<br/> <br/>}</span></pre><p id="7fb5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是ResultsPage类:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="9680" class="ml la it mh b gy mm mn l mo mp">import org.openqa.selenium.By;<br/>import org.openqa.selenium.WebDriver;<br/>import org.openqa.selenium.WebElement;</span><span id="ac28" class="ml la it mh b gy mq mn l mo mp">public class ResultsPage {<br/> <br/> private WebDriver driver;<br/> <br/> private static String URL = “vpl.bibliocommons.com”;<br/> <br/> private static By HEADER_XPATH = <br/>    By.xpath(“//h1[<a class="ae mr" href="http://twitter.com/data" rel="noopener ugc nofollow" target="_blank">@data</a>-test-id = ‘searchTitle’]”);<br/> <br/> public ResultsPage(WebDriver driver) {<br/> <br/>   this.driver = driver;<br/> <br/>   if (!driver.getCurrentUrl().contains(URL))<br/>     throw new RuntimeException(“Results Page is not displayed!”);<br/> <br/> }<br/> <br/> public String header() {</span><span id="0453" class="ml la it mh b gy mq mn l mo mp">   WebElement header = driver.findElement(HEADER_XPATH);<br/>   return header.getText().toLowerCase();</span><span id="4a9e" class="ml la it mh b gy mq mn l mo mp"> }</span><span id="9e25" class="ml la it mh b gy mq mn l mo mp">}</span></pre><h1 id="6436" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">坏的那个</h1><p id="9b95" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">如果测试不能包含截图的代码，也许我们可以将这些代码转移到页面对象类中。</p><p id="3ed6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">HomePage.java的变化如下:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="419f" class="ml la it mh b gy mm mn l mo mp">import org.openqa.selenium.By;<br/>import org.openqa.selenium.WebDriver;<br/>import org.openqa.selenium.WebElement;</span><span id="3606" class="ml la it mh b gy mq mn l mo mp">import framework.Screenshot;</span><span id="547b" class="ml la it mh b gy mq mn l mo mp">public class HomePage {</span><span id="3bcf" class="ml la it mh b gy mq mn l mo mp">  private WebDriver driver;<br/>  private static String TITLE = “Vancouver Public Library |”;<br/> <br/>  private static By SEARCH_BOX_ID = By.id(“edit-search”);<br/>  private static By SEARCH_BUTTON_ID = By.id(“edit-submit1”);<br/> <br/>  public HomePage(WebDriver driver) {</span><span id="47b1" class="ml la it mh b gy mq mn l mo mp">    this.driver = driver;<br/> <br/>    if (!driver.getTitle().equals(TITLE))<br/>      throw new RuntimeException(“Home Page is not displayed!”);</span><span id="9047" class="ml la it mh b gy mq mn l mo mp">  }<br/> <br/>  public ResultsPage searchFor(String keyword) {</span><span id="5568" class="ml la it mh b gy mq mn l mo mp">    try {<br/>     <br/>      WebElement searchBox = driver.findElement(SEARCH_BOX_ID);<br/>      searchBox.sendKeys(keyword);<br/> <br/>      WebElement searchBtn = driver.findElement(SEARCH_BUTTON_ID);<br/>      searchBtn.click();<br/> <br/>      return new ResultsPage(driver);</span><span id="553d" class="ml la it mh b gy mq mn l mo mp">    }<br/>    catch (Exception e) {</span><span id="7c6b" class="ml la it mh b gy mq mn l mo mp">      Screenshot screenshot = new Screenshot(driver);<br/>      screenshot.capture(“HomePage_SearchFor_”);<br/> <br/>      throw new RuntimeException(“cannot search!”);</span><span id="b566" class="ml la it mh b gy mq mn l mo mp">    }<br/>  }<br/> <br/>}</span></pre><p id="7904" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">ResultsPage有类似的代码:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="4f6f" class="ml la it mh b gy mm mn l mo mp">import org.openqa.selenium.By;<br/>import org.openqa.selenium.WebDriver;<br/>import org.openqa.selenium.WebElement;</span><span id="69b5" class="ml la it mh b gy mq mn l mo mp">import framework.Screenshot;</span><span id="5fff" class="ml la it mh b gy mq mn l mo mp">public class ResultsPage {<br/> <br/>  private WebDriver driver;<br/> <br/>  private static String URL = “vpl.bibliocommons.com”;<br/> <br/>  private static By HEADER_XPATH = <br/>        By.xpath(“//h1[<a class="ae mr" href="http://twitter.com/data" rel="noopener ugc nofollow" target="_blank">@data</a>-test-id = ‘searchTitle’]”);<br/> <br/>  public ResultsPage(WebDriver driver) {</span><span id="ed6a" class="ml la it mh b gy mq mn l mo mp">    this.driver = driver;<br/> <br/>    if (!driver.getCurrentUrl().contains(URL))<br/>      throw new RuntimeException(“Results Page is not displayed!”);</span><span id="e0cf" class="ml la it mh b gy mq mn l mo mp">  }<br/> <br/>  public String header() {<br/> <br/>    try {</span><span id="79c1" class="ml la it mh b gy mq mn l mo mp">      WebElement header = driver.findElement(HEADER_XPATH);<br/>      return header.getText().toLowerCase();</span><span id="2b99" class="ml la it mh b gy mq mn l mo mp">    }<br/>    catch (Exception e) {</span><span id="da13" class="ml la it mh b gy mq mn l mo mp">      Screenshot screenshot = new Screenshot(driver);<br/>      screenshot.capture(“ResultsPage_Header_”);<br/> <br/>      throw new RuntimeException(“cannot get the header!”);</span><span id="b1da" class="ml la it mh b gy mq mn l mo mp">    }<br/> <br/> }</span><span id="da67" class="ml la it mh b gy mq mn l mo mp">}</span></pre><p id="93fa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这种情况下，每个页面方法的代码都被包装在TRY/CATCH中，以便在出现异常时获取屏幕截图。</p><p id="6902" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">不过，测试看起来不错:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="aaf1" class="ml la it mh b gy mm mn l mo mp">import org.testng.Assert;<br/>import org.testng.annotations.Test;</span><span id="e604" class="ml la it mh b gy mq mn l mo mp">import PageObjects2.HomePage;<br/>import PageObjects2.ResultsPage;</span><span id="d72a" class="ml la it mh b gy mq mn l mo mp">public class TestClass extends TestBase{<br/> <br/>  private static String URL = “http://www.vpl.ca";<br/> <br/>  @Test<br/>  public void search_For_Keyword_Works() { </span><span id="e099" class="ml la it mh b gy mq mn l mo mp">    HomePage homePage = openSite();</span><span id="0949" class="ml la it mh b gy mq mn l mo mp">    ResultsPage resultsPage = homePage.searchFor(“java”);<br/> <br/>    Assert.assertTrue(resultsPage.header().contains(“java”), <br/>                      “Results Page header is incorrect!”);<br/>  }<br/> <br/>  private HomePage openSite() {<br/>    driver.get(URL);<br/>    return new HomePage(driver);<br/>  }<br/> <br/>}</span></pre><p id="1c5d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">这为什么不好？</strong></p><p id="9a42" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">代码复制从单元测试转移到了页面方法。</p><p id="d134" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">每个页面方法都需要用TRY/CATCH包装其代码，以便在出现异常时获取屏幕截图。</p><p id="906c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">好的，所以截图不能在测试中获取，也不能在页面方法中获取。他们会被带到哪里？</p><h1 id="f1e8" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">好的那个</h1><p id="c0d9" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">TestNG监听器是正确的解决方案。</p><p id="d7b3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">监听器监听测试并为每个测试结果执行定制代码:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="32f4" class="ml la it mh b gy mm mn l mo mp">import java.lang.reflect.Field;</span><span id="1894" class="ml la it mh b gy mq mn l mo mp">import org.testng.ITestContext;<br/>import org.testng.ITestListener;<br/>import org.testng.ITestResult;</span><span id="c8f9" class="ml la it mh b gy mq mn l mo mp">import framework.Screenshot;</span><span id="12be" class="ml la it mh b gy mq mn l mo mp">import org.openqa.selenium.WebDriver;</span><span id="df4b" class="ml la it mh b gy mq mn l mo mp">/*<br/>   the test listener captures in the OnTestFailure() method the    <br/>   screenshot of the current page both <br/>   — when an exception happens in a test script<br/>   — when a test script fails because of an assertion</span><span id="340e" class="ml la it mh b gy mq mn l mo mp">   none of the other listener methods are implemented.<br/> */<br/>public class TestListener implements ITestListener {<br/> <br/>  @Override<br/>  public void onTestStart(ITestResult result) { <br/>  }<br/> <br/>  @Override<br/>  public void onTestSuccess(ITestResult result) { <br/>  }</span><span id="11ad" class="ml la it mh b gy mq mn l mo mp">  /*<br/>   the driver parameter of Screenshot constructor is provided by the <br/>   driver() method;<br/> <br/>   testResult.getName() returns the name of the test script being <br/>   executed;<br/> <br/>   we pass this as parameter to capture() so that the screenshot is <br/>   named after the test script;<br/>  */<br/>  @Override<br/>  public void onTestFailure(ITestResult testResult) { </span><span id="4777" class="ml la it mh b gy mq mn l mo mp">    try {<br/>      Screenshot screenshot = new Screenshot(driver(testResult));<br/>      screenshot.capture(“listener_” + testResult.getName());<br/>    } <br/>    catch (IllegalAccessException e) {<br/>      e.printStackTrace();<br/>    }  </span><span id="5ce1" class="ml la it mh b gy mq mn l mo mp">  }</span><span id="f9f0" class="ml la it mh b gy mq mn l mo mp">  @SuppressWarnings(“unchecked”)<br/>  private WebDriver driver(ITestResult testResult) <br/>     throws IllegalAccessException <br/>  {<br/>  <br/>    try {<br/> <br/>      /*<br/>       we use reflection and generics to find the driver object:<br/> <br/>       1. testResult.getInstance() <br/>          returns the running test class object<br/> <br/>       2. testResult.getInstance().getClass() <br/>          returns the class of testResult (TestClass)<br/> <br/>       3. testClass.getSuperclass() <br/>          returns the parent of the test class (BaseTestClass)<br/> <br/>       4. Field driverField = <br/>                baseTestClass.getDeclaredField(“driver”)<br/>          returns the driver field of the BaseTestClass<br/>   <br/>       5. driver = <br/>           (WebDriver)driverField.get(testResult.getInstance());<br/>          gets the value of the driver field from the BaseTestClass<br/>      */</span><span id="933d" class="ml la it mh b gy mq mn l mo mp">      Class&lt;?extends ITestResult&gt; testClass = <br/>        (Class&lt;? extends ITestResult&gt;) <br/>           testResult.getInstance().getClass();</span><span id="f1ee" class="ml la it mh b gy mq mn l mo mp">      Class&lt;?extends ITestResult&gt; baseTestClass = <br/>        (Class&lt;? extends ITestResult&gt;) <br/>           testClass.getSuperclass();</span><span id="cfae" class="ml la it mh b gy mq mn l mo mp">      Field driverField = baseTestClass.getDeclaredField(“driver”);<br/>      WebDriver driver =   <br/>        (WebDriver)driverField.get(testResult.getInstance()); <br/>  <br/>      return driver;<br/>    }  <br/>    catch (SecurityException | <br/>           NoSuchFieldException | <br/>           IllegalArgumentException e) { </span><span id="5540" class="ml la it mh b gy mq mn l mo mp">      throw new RuntimeException("could not get the driver");</span><span id="1cfb" class="ml la it mh b gy mq mn l mo mp">    }<br/> <br/>  }</span><span id="d291" class="ml la it mh b gy mq mn l mo mp">  @Override<br/>  public void onTestSkipped(ITestResult result) {<br/>  }</span><span id="c8e2" class="ml la it mh b gy mq mn l mo mp">  @Override<br/>  public void onTestFailedButWithinSuccessPercentage(ITestResult   <br/>  result) {<br/>  }</span><span id="3e76" class="ml la it mh b gy mq mn l mo mp">  @Override<br/>  public void onStart(ITestContext context) {<br/>  }</span><span id="5a6a" class="ml la it mh b gy mq mn l mo mp">  @Override<br/>  public void onFinish(ITestContext context) {<br/>  }<br/>}</span></pre><p id="9307" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">代码应该相当容易理解。</p><p id="362a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">每个侦听器方法都获得一个ITestResult类型的参数，它是测试类的实例。</p><p id="11eb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用这个参数，我们可以使用反射从基本测试类中获取驱动程序对象。</p><p id="f379" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦驱动程序对象可用，我们就用它来获取以运行单元测试命名的屏幕截图。</p><p id="5490" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们如何使用监听器？</p><p id="022d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">页面类中不需要修改代码。它们不包括任何截屏代码。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="0934" class="ml la it mh b gy mm mn l mo mp">import org.openqa.selenium.By;<br/>import org.openqa.selenium.WebDriver;<br/>import org.openqa.selenium.WebElement;</span><span id="22e7" class="ml la it mh b gy mq mn l mo mp">public class HomePage {</span><span id="3599" class="ml la it mh b gy mq mn l mo mp">  private WebDriver driver;<br/>  private static String TITLE = “Vancouver Public Library |”;<br/> <br/>  private static By SEARCH_BOX_ID = By.id(“edit-search”);<br/>  private static By SEARCH_BUTTON_ID = By.id(“edit-submit1”);<br/> <br/>  public HomePage(WebDriver driver) {</span><span id="34e7" class="ml la it mh b gy mq mn l mo mp">    this.driver = driver;<br/> <br/>    if (!driver.getTitle().equals(TITLE))<br/>      throw new RuntimeException(“Home Page is not displayed!”);</span><span id="3175" class="ml la it mh b gy mq mn l mo mp">  }<br/> <br/>  public ResultsPage searchFor(String keyword) {</span><span id="753a" class="ml la it mh b gy mq mn l mo mp">    WebElement searchBox = driver.findElement(SEARCH_BOX_ID);<br/>    searchBox.sendKeys(keyword);<br/> <br/>    WebElement searchButton = driver.findElement(SEARCH_BUTTON_ID);<br/>    searchButton.click();<br/> <br/>    return new ResultsPage(driver);</span><span id="da08" class="ml la it mh b gy mq mn l mo mp">  }<br/> <br/>}</span><span id="c07a" class="ml la it mh b gy mq mn l mo mp">import org.openqa.selenium.By;<br/>import org.openqa.selenium.WebDriver;<br/>import org.openqa.selenium.WebElement;</span><span id="d1f9" class="ml la it mh b gy mq mn l mo mp">public class ResultsPage {<br/> <br/>  private WebDriver driver;<br/> <br/>  private static String URL = “vpl.bibliocommons.com”;<br/> <br/>  private static By HEADER_XPATH = <br/>        By.xpath(“//h1[<a class="ae mr" href="http://twitter.com/data" rel="noopener ugc nofollow" target="_blank">@data</a>-test-id = ‘searchTitle’]”);<br/> <br/>  public ResultsPage(WebDriver driver) {</span><span id="0656" class="ml la it mh b gy mq mn l mo mp">    this.driver = driver;<br/> <br/>    if (!driver.getCurrentUrl().contains(URL))<br/>      throw new RuntimeException(“Results Page is not displayed!”);</span><span id="9fd3" class="ml la it mh b gy mq mn l mo mp">  }<br/> <br/>  public String header() {<br/> <br/>    WebElement header = driver.findElement(HEADER_XPATH);<br/>    return header.getText().toLowerCase();<br/> <br/>  }</span><span id="9373" class="ml la it mh b gy mq mn l mo mp">}</span></pre><p id="2e7f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">测试类也没有任何截图的代码。但是，它使用@Listeners注释和侦听器类的名称:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="0e57" class="ml la it mh b gy mm mn l mo mp">import org.testng.Assert;<br/>import org.testng.annotations.Listeners;<br/>import org.testng.annotations.Test;</span><span id="7efa" class="ml la it mh b gy mq mn l mo mp">import PageObjects3.HomePage;<br/>import PageObjects3.ResultsPage;</span><span id="53ce" class="ml la it mh b gy mq mn l mo mp">@Listeners(TestListener.class)<br/>public class TestClass extends TestBase{<br/> <br/>  private static String URL = “http://www.vpl.ca";<br/> <br/>  @Test<br/>  public void search_For_Keyword_Works() {<br/> <br/>    HomePage homePage = openSite();<br/> <br/>    ResultsPage resultsPage = homePage.searchFor(“java”);<br/> <br/>    Assert.assertTrue(resultsPage.header().contains(“java”), <br/>                      “Results Page header is incorrect!”);<br/>  }<br/> <br/>  private HomePage openSite() {<br/>    driver.get(URL);<br/>    return new HomePage(driver);<br/>  }<br/> <br/> <br/>}</span></pre><p id="db28" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这种情况下会发生什么？</p><p id="c231" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">单元测试运行。如果它生成一个异常或断言失败，监听器将会注意到这一点，并在OnTestFailure()方法中截取当前页面的屏幕截图。</p><p id="c89b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为什么这是正确的解决方案应该是显而易见的:</p><ul class=""><li id="2123" class="ms mt it kd b ke kf ki kj km mu kq mv ku mw ky mx my mz na bi translated">单元测试不包括任何截屏代码</li><li id="340a" class="ms mt it kd b ke nb ki nc km nd kq ne ku nf ky mx my mz na bi translated">页面对象类不包含任何截屏代码</li><li id="f6f9" class="ms mt it kd b ke nb ki nc km nd kq ne ku nf ky mx my mz na bi translated">截图都是在一个地方拍的</li><li id="71f7" class="ms mt it kd b ke nb ki nc km nd kq ne ku nf ky mx my mz na bi translated">如果一个测试类需要它的单元测试来获取屏幕截图，它只需要@Listeners注释，后跟监听器类名</li></ul><p id="00e8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">希望你喜欢这篇文章，也许能从中学到一些东西。</p></div></div>    
</body>
</html>