<html>
<head>
<title>TDD with Typescript and Jest: Url shortener</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有Typescript和Jest的TDD:Url shorter</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/tdd-with-typescript-and-jest-url-shortener-6956e2387ce8?source=collection_archive---------19-----------------------#2021-03-07">https://levelup.gitconnected.com/tdd-with-typescript-and-jest-url-shortener-6956e2387ce8?source=collection_archive---------19-----------------------#2021-03-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/af699dcd98be3a15939cc6e9303cc84f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Oo1wk8MB4I0_NGWWQbegg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://unsplash.com/@benchaccounting" rel="noopener ugc nofollow" target="_blank">钳工</a>在<a class="ae kc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照。</figcaption></figure><p id="a0ec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一个简单的项目——编写一个在Nodejs上运行的API服务。该服务是URL缩短服务。该服务也是使用Typescript、Jest、Express和Mongoose的TDD风格的一个例子。</p><h1 id="197b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">创建并初始化项目</h1><p id="f672" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">这个项目将基于<a class="ae kc" href="https://hoangdv.medium.com/tdd-with-typescript-and-jest-starter-project-cca94fd089f5" rel="noopener"> TDD与Typescript和Jest: Starter项目</a>。</p><p id="9873" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">只需从<a class="ae kc" href="https://github.com/hoangsetup/ts-jest-tdd-starter" rel="noopener ugc nofollow" target="_blank"> Github </a>中克隆启动项目:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="a314" class="mn lc iq mj b gy mo mp l mq mr">$ git clone <a class="ae kc" href="https://github.com/hoangsetup/ts-jest-tdd-starter.git" rel="noopener ugc nofollow" target="_blank">https://github.com/hoangsetup/ts-jest-tdd-starter</a>.git url-shortener<br/>$ cd url-shortener<br/>$ npm ci</span></pre><p id="be61" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">带<code class="fe ms mt mu mj b">url-shortener</code>的是这个项目的名称。您也可以更新<code class="fe ms mt mu mj b">package.json</code>文件中的项目名称。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="0176" class="mn lc iq mj b gy mo mp l mq mr">{<br/>  "name": "url-shortener",<br/>  "version": "1.0.0",<br/>  "description": "",<br/>  "main": "index.js",<br/>  ...</span></pre><h1 id="d362" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">安装所需的依赖项</h1><p id="c2bf" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">首先，让我们安装一些构建服务所需的外部依赖包。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="e985" class="mn lc iq mj b gy mo mp l mq mr">$ npm install dotenv express mongoose shortid validator -S</span></pre><p id="fed3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要它们的类型定义:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c59a" class="mn lc iq mj b gy mo mp l mq mr">$ npm install @types/dotenv @types/express @types/mongoose @types/shortid @types/validator supertest nodemon -D</span></pre><h1 id="525b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">MongoDB服务</h1><p id="3c65" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">这是一个可选的部分，在这篇关于TDD的文章中，我试图把重点放在“如何编写单元测试？”。</p><p id="a923" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我用docker运行了一个MongoDB服务实例，你可以随意用你的方式创建DB服务实例。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d673" class="mn lc iq mj b gy mo mp l mq mr">$ docker run -it --rm -p 27017:27017 mongo</span></pre><h1 id="d385" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">简单快速服务器和mongoose模型</h1><p id="d0a6" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在这一步中，我们将使用Express创建一个API服务器，并设置一个开发环境。</p><h2 id="8637" class="mn lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">Api应用程序类</h2><p id="67cd" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">该类将提供express的一个实例，该实例将与完整的功能一起导出。</p><p id="6b83" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建<code class="fe ms mt mu mj b">src/ApiApp.ts</code>文件:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="2b27" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过<code class="fe ms mt mu mj b">getApplication</code>函数获得express实例。</p><h2 id="3dc1" class="mn lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">用于开发的服务器和设置</h2><p id="d62a" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如您所见，我们需要一些逻辑来启动基于express应用程序的HTTP服务器。</p><p id="7b01" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创造<code class="fe ms mt mu mj b">src/server.ts</code></p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="2896" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该文件是服务的起点。我们尝试连接到MongoDB服务，然后在来自<code class="fe ms mt mu mj b">PORT</code>环境变量的端口或默认端口— 3000上为应用程序提供服务。</p><p id="7fb7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它还需要<code class="fe ms mt mu mj b">MONGO_URI</code>环境变量。您可以通过创建内容如下的<code class="fe ms mt mu mj b">.env</code>文件来传递这些环境变量:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="dcea" class="mn lc iq mj b gy mo mp l mq mr">PORT=3000<br/>MONGO_URI="mongodb://localhost:27017/url-shortener"</span></pre><p id="29fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尝试启动服务器，首先我们要构建TS到JS的代码:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="cba1" class="mn lc iq mj b gy mo mp l mq mr">$ npm build<br/>$ node ./dist/server.js</span></pre><p id="bccd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一切正常，您将看到如下消息:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c07b" class="mn lc iq mj b gy mo mp l mq mr">listening on port 3000</span></pre><p id="4943" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并且，发送<code class="fe ms mt mu mj b">GET /</code>请求你会得到一条问候信息:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="e14b" class="mn lc iq mj b gy mo mp l mq mr">$ curl --request GET '<a class="ae kc" href="http://localhost:3000'" rel="noopener ugc nofollow" target="_blank">http://localhost:3000'</a><br/>{"message":"Welcome to our service!"}</span></pre><h1 id="2f99" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">TimeDivisionDuplex 时分双工</h1><p id="01eb" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们将进入高级类，然后进入较低级别的依赖类。</p><p id="910b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于每个文件或类，我们定义它的需求，然后尝试按照TDD风格实现需求。</p><p id="8992" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">总的来说，最小缩短URL服务的用户故事是:</p><ul class=""><li id="d834" class="ni nj iq kf b kg kh kk kl ko nk ks nl kw nm la nn no np nq bi translated">缩短URL——用户向我们的服务发送一个“长”URL，服务将返回一个短id字符串。</li><li id="e560" class="ni nj iq kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated">反转“短”url —用户使用浏览器请求短id字符串，如果id与目标URL映射，则将浏览器重定向到目标URL。如果没有，则返回一个错误。</li></ul><p id="9831" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的项目将有这样的结构:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b768" class="mn lc iq mj b gy mo mp l mq mr">Router -&gt; Controller -&gt; Model</span></pre><ul class=""><li id="74a8" class="ni nj iq kf b kg kh kk kl ko nk ks nl kw nm la nn no np nq bi translated">路由器:注册HTTP请求处理程序，它调用参数为<code class="fe ms mt mu mj b">request, response</code>的<code class="fe ms mt mu mj b">Controller</code>函数。</li><li id="8197" class="ni nj iq kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated">控制器:我们服务的主要逻辑，通过使用模型获取URL信息。</li><li id="b874" class="ni nj iq kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated">模型:定义URL文档模式，以便在MongoDB中使用<code class="fe ms mt mu mj b">urls</code>文档。</li></ul><h2 id="4349" class="mn lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">Url模型</h2><p id="c73c" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">模型类就像一个配置，那么不需要为这个类编写测试。</p><p id="e7a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">URL记录的主要属性:</p><ul class=""><li id="4d32" class="ni nj iq kf b kg kh kk kl ko nk ks nl kw nm la nn no np nq bi translated"><code class="fe ms mt mu mj b">url</code> —字符串，目的url。</li><li id="e9c2" class="ni nj iq kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated"><code class="fe ms mt mu mj b">shortId</code> —字符串，目标url的缩写id。</li></ul><p id="af2c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建<code class="fe ms mt mu mj b">src/models/UrlModel.ts</code>:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="a396" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认导出— <code class="fe ms mt mu mj b">UrlModel</code>，用于在MongoDB中处理url文档。</p><p id="563a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">IUrlDocument</code> —从<code class="fe ms mt mu mj b">UrlModel</code>查询返回的url项目的类型。</p><h2 id="61ef" class="mn lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">路由器</h2><p id="787b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">本课程的要求是:</p><ul class=""><li id="d045" class="ni nj iq kf b kg kh kk kl ko nk ks nl kw nm la nn no np nq bi translated">导出和快速路由器实例</li><li id="8071" class="ni nj iq kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated">向路由器注册<code class="fe ms mt mu mj b">GET /:shortId</code>，调用，并将<code class="fe ms mt mu mj b">req, res</code>传递给<code class="fe ms mt mu mj b">Controller.redirectUrl</code>。</li><li id="89ce" class="ni nj iq kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated">向路由器注册<code class="fe ms mt mu mj b">POST /</code>，调用，并将<code class="fe ms mt mu mj b">req, res</code>传递给<code class="fe ms mt mu mj b">Controller.shortenUrl</code>。</li></ul><p id="ed38" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，通过创建规格文件<code class="fe ms mt mu mj b">src/routers/ShortenerUrl.spec.ts</code>得到一个<code class="fe ms mt mu mj b">Red code</code></p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ec0b" class="mn lc iq mj b gy mo mp l mq mr">import ShortenerRoute from './ShortenerRoute';</span></pre><p id="d47f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">红色</strong> : <em class="nw">找不到模块。/ShortenerRoute”或其相应的类型声明。</em></p><p id="6a64" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过创建生产代码文件— <code class="fe ms mt mu mj b">src/routers/ShortenUrl.ts</code>修复<strong class="kf ir">红色</strong>代码</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f73d" class="mn lc iq mj b gy mo mp l mq mr">class ShortenerRoute {</span><span id="eb8a" class="mn lc iq mj b gy nx mp l mq mr">}</span><span id="d9d6" class="mn lc iq mj b gy nx mp l mq mr">export default new ShortenerRoute();</span></pre><p id="910c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导出<code class="fe ms mt mu mj b">ShortenerUrl</code>类的一个实例。</p></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><p id="ce9d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为路由器类将调用控制器函数，但是控制器是另一个单元，所以在这个规范文件中我们必须模拟控制器的一些函数。</p><p id="ee40" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们将使用<code class="fe ms mt mu mj b">jest.mock</code>函数— <em class="nw">在需要的时候用自动模仿的版本来模仿一个模块。</em></p><p id="06e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对等级库文件的更新:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="cd7d" class="mn lc iq mj b gy mo mp l mq mr">import ShortenerRoute from './ShortenerRoute';</span><span id="c2a4" class="mn lc iq mj b gy nx mp l mq mr">import UrlController from '../controllers/ShortenerController';<br/></span><span id="f11c" class="mn lc iq mj b gy nx mp l mq mr">jest.mock('../controllers/ShortenerController');</span></pre><p id="1ade" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">红色</strong> : <em class="nw">找不到模块'</em>../controllers/shorter controller<em class="nw">或其对应的类型声明。</em></p><p id="7365" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过创建生产代码文件— <code class="fe ms mt mu mj b">src/controllers/ShortenerController.ts</code>修复<strong class="kf ir">红色</strong>代码</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="2f41" class="mn lc iq mj b gy mo mp l mq mr">class ShortenerController {<br/>  <br/>}</span><span id="070b" class="mn lc iq mj b gy nx mp l mq mr">export default new ShortenerController();</span></pre></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><p id="9be2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用<a class="ae kc" href="https://www.npmjs.com/package/supertest" rel="noopener ugc nofollow" target="_blank">超级测试</a>来触发快速路由器中的注册请求处理。</p><p id="826d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们在规范文件中编写第一个测试块——“ShortenerRoute”</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b8ae" class="mn lc iq mj b gy mo mp l mq mr">import express, { Application } from 'express';<br/>import { MockedObject, mocked } from 'ts-jest/dist/utils/testing';<br/>import supertest from 'supertest';</span><span id="1ebd" class="mn lc iq mj b gy nx mp l mq mr">import ShortenerRoute from './ShortenerRoute';<br/>import UrlController from '../controllers/ShortenerController';</span><span id="b18b" class="mn lc iq mj b gy nx mp l mq mr">jest.mock('../controllers/ShortenerController');</span><span id="507a" class="mn lc iq mj b gy nx mp l mq mr">describe('ShortenerRoute', () =&gt; {<br/>  const shortId = 'short-id';<br/>  const expectedResponse = expect.anything();</span><span id="978e" class="mn lc iq mj b gy nx mp l mq mr">  let app: Application;<br/>  let request: supertest.SuperTest&lt;supertest.Test&gt;;<br/>  let UrlControllerMock: MockedObject&lt;typeof UrlController&gt;;</span><span id="85d2" class="mn lc iq mj b gy nx mp l mq mr">  beforeEach(() =&gt; {<br/>    UrlControllerMock = mocked(UrlController);<br/>    UrlControllerMock.redirectUrl.mockImplementation(async (_, res) =&gt; {<br/>      return res.json({});<br/>    });</span><span id="2465" class="mn lc iq mj b gy nx mp l mq mr">app = express();<br/>    app.use(express.json());<br/>    app.use('/', ShortenerRoute.getRouter());<br/>    request = supertest(app);<br/>  });<br/>});</span></pre><p id="db12" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在“beforeEach”块中，我们重新实现了控制器的<code class="fe ms mt mu mj b">redirectUrl</code>功能——只是完成一个请求。而且，我们必须创建一个express应用程序实例，将<code class="fe ms mt mu mj b">ShortenerRouter</code>附加到应用程序中，由<code class="fe ms mt mu mj b">suprertest</code>通过app测试路由器。</p><p id="50ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">红色:</strong> <em class="nw">属性“redirectUrl”在类型“mocked object&lt;shortener controller&gt;上不存在。</em></p><p id="eb73" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">红色:</strong> <em class="nw">属性“getRouter”在类型“ShortenerRoute”上不存在</em></p><p id="01c7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最佳实践是:出现错误时立即停止，并在继续之前修复它。但是在本文中，我会尝试在转到另一个文件之前完成一个文件(spec文件)中已完成的部分。</p><p id="c650" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要修复<strong class="kf ir">红色</strong>代码，只需为控制器创建<code class="fe ms mt mu mj b">redirectUrl</code>函数，为路由器创建<code class="fe ms mt mu mj b">getRouter</code>函数。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="1dc8" class="mn lc iq mj b gy mo mp l mq mr">class ShortenerController {<br/>  async redirectUrl(req: Request, res: Response) {<br/>    throw new Error('Not implemented yet!');<br/>  }<br/>}<br/>export default new ShortenerController();</span></pre><p id="bb8b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对管制员来说这就够了。这个时候不要在意<code class="fe ms mt mu mj b">redirectUrl</code>函数的逻辑。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="66f3" class="mn lc iq mj b gy mo mp l mq mr">import { Router } from 'express';</span><span id="40e2" class="mn lc iq mj b gy nx mp l mq mr">import UrlController from '../controllers/ShortenerController';</span><span id="9a61" class="mn lc iq mj b gy nx mp l mq mr">class ShortenerRoute {<br/>  private router: Router;</span><span id="8715" class="mn lc iq mj b gy nx mp l mq mr">  constructor() {<br/>    this.router = Router();<br/>    this.setupRouter();<br/>  }</span><span id="d267" class="mn lc iq mj b gy nx mp l mq mr">  private setupRouter() {</span><span id="e3b1" class="mn lc iq mj b gy nx mp l mq mr">  }</span><span id="850c" class="mn lc iq mj b gy nx mp l mq mr">  getRouter() {<br/>    return this.router;<br/>  }<br/>}</span><span id="7239" class="mn lc iq mj b gy nx mp l mq mr">export default new ShortenerRoute();</span></pre><p id="4d73" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建一个私有属性— <code class="fe ms mt mu mj b">router</code>是一个快速路由器的实例，我们通过<code class="fe ms mt mu mj b">getRouter</code>函数导出这个变量。</p></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><p id="3719" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一个测试用例——我们期望用<code class="fe ms mt mu mj b">req</code>对象调用<code class="fe ms mt mu mj b">redirectUrl</code>,该对象在其<code class="fe ms mt mu mj b">params</code>对象中包含<code class="fe ms mt mu mj b">shortId</code>。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b935" class="mn lc iq mj b gy mo mp l mq mr">it('should call UrlController.redirectUrl function when GET /:shortId', async () =&gt; {<br/>  await request.get(`/${shortId}`);</span><span id="a410" class="mn lc iq mj b gy nx mp l mq mr">  expect(UrlControllerMock.redirectUrl)<br/>    .toHaveBeenCalledWith(<br/>      expect.objectContaining({<br/>        params: { shortId },<br/>      }),<br/>      expectedResponse,<br/>    );<br/>});</span></pre><p id="3f85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在IDE上没有得到任何错误，是时候运行测试脚本了:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5726" class="mn lc iq mj b gy mo mp l mq mr">npm run test -- --watch</span></pre><p id="208d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">--watch</code> flag帮助我们观察项目中的任何变化，并重新运行测试脚本。</p><p id="a082" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一切运行“良好”,您将得到如下结果:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/a79e679aa79ddb383a18cf3dd6370d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jpuBPgMC-2-qCd9aP8XqMQ.png"/></div></div></figure><p id="f043" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们期望调用控制器函数，但是<code class="fe ms mt mu mj b">Number of calls: 0</code>。</p><p id="d079" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">修复它，为<code class="fe ms mt mu mj b">GET /:shortId</code>请求注册一个处理程序。更新路由器类的<code class="fe ms mt mu mj b">setupRouter</code>功能</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="7d1b" class="mn lc iq mj b gy mo mp l mq mr">private setupRouter() {<br/>  this.router.get('/:shortId', async (req, res) =&gt; {<br/>    await UrlController.redirectUrl(req, res);<br/>  });<br/>}</span></pre><p id="a73a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">保存文件，测试结果应该是这样的:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/d958376c03a4ca9217fc80475c117d77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z_tsXS-OmElG8z6IVc6yHA.png"/></div></div></figure></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><p id="7461" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对第二条路线进行同样的操作，</p><p id="77e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">测试规格:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="a083" class="mn lc iq mj b gy mo mp l mq mr">it('should call UrlController.shortenUrl function when POST /', async () =&gt; {<br/>  const body = { url: 'too-long-url' };</span><span id="e020" class="mn lc iq mj b gy nx mp l mq mr">await request.post(`/`).send(body);</span><span id="eeba" class="mn lc iq mj b gy nx mp l mq mr">expect(UrlControllerMock.shortenUrl)<br/>    .toHaveBeenCalledWith(<br/>      expect.objectContaining({<br/>        body,<br/>      }), expectedResponse,<br/>    );<br/>});</span></pre><p id="ed9b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">生产代码:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5295" class="mn lc iq mj b gy mo mp l mq mr">this.router.post('/', async (req, res) =&gt; {<br/>  await UrlController.shortenUrl(req, res);<br/>});</span></pre></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><p id="d578" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们已经完成了<code class="fe ms mt mu mj b">ShortenerRouter</code>课。</p><h2 id="f59e" class="mn lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">控制器</h2><p id="c41a" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">本课程的要求:</p><ul class=""><li id="be3f" class="ni nj iq kf b kg kh kk kl ko nk ks nl kw nm la nn no np nq bi translated">函数<code class="fe ms mt mu mj b">redirectUrl</code> <br/> -如果<code class="fe ms mt mu mj b">shortId</code>不在请求中，响应状态400，消息<code class="fe ms mt mu mj b">shortId is not provide</code> <br/> -如果<code class="fe ms mt mu mj b">shortId</code>不在DB中，响应状态400，消息<code class="fe ms mt mu mj b">shortId is invalid</code> <br/> -否则，将请求重定向到目的url。<br/> -如果出现问题，响应状态500，消息<code class="fe ms mt mu mj b">Some thing went wrong!</code></li><li id="6681" class="ni nj iq kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated">函数<code class="fe ms mt mu mj b">shortenUrl</code> <br/> -如果<code class="fe ms mt mu mj b">url</code>不存在于请求中，响应状态为400，消息<code class="fe ms mt mu mj b">url is not provided</code> <br/> -如果<code class="fe ms mt mu mj b">url</code>不是有效的url，响应状态为400，消息<code class="fe ms mt mu mj b">url is invalid</code> <br/> -否则，如果<code class="fe ms mt mu mj b">url</code>已经存在于DB中，响应状态为200，主体响应包括<code class="fe ms mt mu mj b">url</code>和已存在的<code class="fe ms mt mu mj b">shortId</code> <br/> -否则，如果<code class="fe ms mt mu mj b">url</code>不存在于DB中，创建一个新的url项，将其保存到DB中，并响应</li></ul><p id="cc8b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了避免长篇大论，我将推出完整的规范文件和产品文件。</p><p id="735e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">src/controllers/ShortenerController.spec.ts</code></p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="7f70" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">生产文件:</p><p id="b14f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">src/controllers/ShortenerController.ts</code></p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="41a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最终测试结果:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/13ef836e2ce14d15873f37f6a64f96ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7SKIFWLgQeAELuBkgdhDcQ.png"/></div></div></figure><p id="762b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<code class="fe ms mt mu mj b">--coverage</code>标志执行测试时:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="7ff4" class="mn lc iq mj b gy mo mp l mq mr">npm run test -- --coverage</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/ea263e76fc4a2f1be1ae8fa366d01c69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0jVLbFghDc-JRe1Jhd2j4w.png"/></div></div></figure><h2 id="382b" class="mn lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">将路由器应用于快速应用</h2><p id="57cd" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">因为现在，我们没有为<code class="fe ms mt mu mj b">src/ApiApp.ts</code>编写测试，所以不能使用单元测试来检测缺失——我们还没有使用<code class="fe ms mt mu mj b">ShortenerRouter</code>类。</p><p id="995c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我们使用手动测试时，将会发现缺失。现在，让我们使用它。更新<code class="fe ms mt mu mj b">ApiApp</code>类的<code class="fe ms mt mu mj b">setupRouters</code>功能:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4743" class="mn lc iq mj b gy mo mp l mq mr">import router from './routers/ShortenerRoute';</span><span id="ae15" class="mn lc iq mj b gy nx mp l mq mr">...<br/>  private setupRouters() {<br/>    this.application.get('/', (_, res) =&gt; {<br/>      res.json({ message: 'Welcome to our service!'});<br/>    });</span><span id="ba19" class="mn lc iq mj b gy nx mp l mq mr">    this.application.use('/urls', router.getRouter());<br/>  }<br/>...</span></pre><p id="e955" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仅此而已！</p><h1 id="ab50" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">摘要</h1><p id="9089" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">当你得到至少一个“<strong class="kf ir">红色代码”时，只需更新你的生产代码。</strong></p><p id="67fb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该项目的完整代码已经发布在<a class="ae kc" href="https://github.com/hoangsetup/url-shortener" rel="noopener ugc nofollow" target="_blank"> Github </a>上。</p><p id="e028" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢您的阅读！</p></div></div>    
</body>
</html>