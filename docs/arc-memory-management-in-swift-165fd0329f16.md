# swift ä¸­çš„å†…å­˜ç®¡ç†(ç¬¬ä¸€éƒ¨åˆ†)

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/arc-memory-management-in-swift-165fd0329f16>

æè¿°å¦‚ä½•åœ¨ Swift ä¸­ä½¿ç”¨è‡ªåŠ¨å¼•ç”¨è®¡æ•°æ¥ç®¡ç†åº”ç”¨ç¨‹åºå†…å­˜ã€‚

![](img/4ec0ab04fc40b9361d9b69f617172d0f.png)

ç“¦ä¼¦ä¸Â·å¡”çº³ç´¢ç»´å¥‡é€šè¿‡[æ´¾å…‹æ–¯](https://www.pexels.com/@pixabay)æ‹æ‘„çš„ç…§ç‰‡

# æ¦‚è§‚

å¼€å‘ç§»åŠ¨åº”ç”¨ç¨‹åºæ—¶ï¼Œå†…å­˜æ˜¯ä¸€ä¸ªå¤§é—®é¢˜ã€‚ä¸å¯»å¸¸çš„å†…å­˜è®¿é—®ä¼šé™ä½åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºæ„å¤–å´©æºƒã€‚å¹¸è¿çš„æ˜¯ï¼ŒSwift ä½¿ç”¨ ARC(è‡ªåŠ¨å¼•ç”¨è®¡æ•°)æ¥ç®¡ç†æ‚¨çš„åº”ç”¨ç¨‹åºå†…å­˜ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒARC ä¼šè‡ªå·±æ¸…ç†å†…å­˜ï¼Œä½†æœ‰æ—¶ä¼šå› ä¸ºæŸäº›å…³ç³»è€Œæ— æ³•æ¸…ç†ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨ ARC æ¥é‡Šæ”¾ Swift çš„å†…å­˜ã€‚

> *æœ¬æ•™ç¨‹ä½¿ç”¨* ***Swift 5ï¼ŒXcode 12.1 ç¼–å†™ã€‚***

# ä»€ä¹ˆæ˜¯ ARCï¼Ÿ

å½“æˆ‘ä»¬ä½¿ç”¨ init()åˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹æ—¶ï¼Œä¼šä¸ºå®ƒåˆ†é…ä¸€äº›å†…å­˜å—ã€‚å½“ä¸å†ä½¿ç”¨è¿™ä¸ªå®ä¾‹æ—¶ï¼Œè°ƒç”¨ deinit()æ–¹æ³•ï¼ŒARC é‡Šæ”¾è¯¥å¯¹è±¡å ç”¨çš„å†…å­˜ã€‚

ä½†äº‹æƒ…å¹¶ä¸æ˜¯æ¯æ¬¡éƒ½è¿™ä¹ˆç®€å•ã€‚æœ‰æ—¶ç”±äºæŸç§å…³ç³»ï¼Œdeinit()æ–¹æ³•ä¸æ‰§è¡Œï¼ŒARC ä¸èƒ½é‡Šæ”¾å†…å­˜ã€‚æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œåœ¨ iOS å¼€å‘ä¸­ï¼Œæœ‰æ—¶å˜é‡ä½¿ç”¨å¼±å…³é”®å­—æˆ–æ— ä¸»å…³é”®å­—å£°æ˜ã€‚è¿™äº›å…³é”®å­—å®é™…ä¸Šä¸ä¸€ä¸ªå˜é‡å’Œä¸€ä¸ªç±»è”ç³»åœ¨ä¸€èµ·ã€‚æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•èªæ˜åœ°å¤„ç†å®ƒä»¬å¹¶é‡Šæ”¾æœªä½¿ç”¨çš„å†…å­˜ã€‚

# â€œå¼ºâ€å‚è€ƒå’Œä¿ç•™å‘¨æœŸ

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„ç±» **Student** ï¼Œå®ƒæœ‰ä¸€ä¸ªå±æ€§åˆå§‹åŒ–å™¨æ¥åˆå§‹åŒ–å®ƒçš„å±æ€§ã€‚

```
class Student {
    let studentName: String
    init(studentName: String) {
        self.studentName = studentName
        print("\(studentName) created")
    }deinit {
        print("Deinit student \(studentName)")
    }
}
```

å­¦ç”Ÿç±»ä¹Ÿæœ‰ä¸€ä¸ªååˆå§‹åŒ–å™¨ã€‚å½“ä¸€ä¸ªç±»çš„å±æ€§è¢« ARC ä»å†…å­˜ä¸­å–æ¶ˆåˆå§‹åŒ–æ—¶ï¼Œå°†è°ƒç”¨ deinit()æ–¹æ³•ã€‚

ç°åœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€å•çš„å˜é‡**å­¦ç”Ÿ**çš„**å­¦ç”Ÿ**ç±»ã€‚è¯¥å˜é‡å°†åˆ›å»ºä¸€ä¸ªå¯¹ **Student** ç±»çš„å¼ºå¼•ç”¨ï¼ŒStudent ç±»çš„å¼•ç”¨è®¡æ•°å°†å˜ä¸º 0 æ¯” 1ã€‚

```
var student: Student? = Student(studentName: â€œJohnâ€)**Console output:**
*John created*
```

![](img/b8e5a927ad2f96fd6cbb7973695a9d5a.png)

æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†**å­¦ç”Ÿ**å˜é‡å€¼è®¾ç½®ä¸ºé›¶æ¥ç§»é™¤å¼•ç”¨ã€‚ ***æ³¨æ„*** ***æ³¨æ„ï¼Œé€šè¿‡å°†å˜é‡è®¾ç½®ä¸ºé›¶ï¼Œæˆ‘ä»¬ä¸æ˜¯åˆ é™¤å˜é‡ï¼Œè€Œä¸ä»…ä»…æ˜¯åˆ é™¤å¼•ç”¨ã€‚***

```
student = nil**Console output:** *Deinit student John*
```

è¯¥è¯­å¥å°†åˆ é™¤**å­¦ç”Ÿ**å˜é‡ä¸**å­¦ç”Ÿ**ç±»çš„å…³ç³»ï¼Œæ‰§è¡Œ deinit()æ–¹æ³•ï¼Œå¹¶ä¸”**å­¦ç”Ÿ**ç±»å¼•ç”¨è®¡æ•°ä» 1 å˜ä¸º 0ã€‚

![](img/4e10be4e003d2756a80b40ff042d5c2e.png)

ç°åœ¨å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªä¸åŒçš„ç­çº§ä½œä¸º**å­¦ç”Ÿ**å’Œ**è¯¾ç¨‹**

```
class Student {
    var course: Course?
    let studentName: String
    init(studentName: String) {
        self.studentName = studentName
        print("\(studentName) created")
    }
deinit {
        print("Deinit student \(studentName)")
    }
}class Course{
    var student: Student?
    let courseName: String
    init(courseName: String) {
        self.courseName = courseName
        print("\(courseName) generated")
    }
    deinit {
        print("Deinit course \(courseName)")
    }
}
```

æˆ‘ä»¬åˆå§‹åŒ–**å­¦ç”Ÿ** & **è¯¾ç¨‹**ç­çº§å¦‚ä¸‹

```
var student: Student? = Student(studentName: â€œJohnâ€)
var course: Course? = Course(courseName: â€œCS-190â€)**Console output:** *John created
CS-190 generated*
```

ç°åœ¨è¿™ä¸¤ä¸ªç±»çš„å¼•ç”¨è®¡æ•°éƒ½æ˜¯ 1ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ºå®ƒä»¬åˆ›å»ºäº†ä¸¤ä¸ªå•ç‹¬çš„å¼•ç”¨ã€‚

![](img/6155d8a684baa18ffbcdab7fea2d1093.png)

å½“æˆ‘ä»¬åˆ†åˆ«ä¸º**å­¦ç”Ÿ**å’Œ**è¯¾ç¨‹**ç±»ä¸­çš„**è¯¾ç¨‹**å’Œ**å­¦ç”Ÿ**å±æ€§è®¾ç½®å€¼æ—¶ï¼Œå®ƒä»¬ä¹‹é—´ä¼šåˆ›å»ºä¸€ä¸ªå¼ºå¼•ç”¨ã€‚ä¸¤ä¸ªç±»çš„å¼•ç”¨è®¡æ•°éƒ½ä» 1 å˜ä¸º 2ã€‚

```
student?.course = course
course?.student = student**Console output:** *John created
CS-190 generated*
```

![](img/3636cdf2c248b3e5c30aaf5e67bc1565.png)

ä½†æ˜¯ç°åœ¨å¦‚æœæˆ‘ä»¬æ‰“ç ´**å­¦ç”Ÿ**å’Œ**è¯¾ç¨‹**å˜é‡çš„å¼ºå¼•ç”¨ï¼Œå°†å®ƒä»¬è®¾ç½®ä¸ºé›¶ï¼Œé‚£ä¹ˆ**å­¦ç”Ÿ** & **è¯¾ç¨‹**çš„å¼•ç”¨è®¡æ•°å°†ä¸ä¼šåƒæˆ‘ä»¬é¢„æœŸçš„é‚£æ ·ä» 2 ä¸‹é™åˆ° 0ã€‚è¿™ä¸¤ä¸ªç±»çš„å¼•ç”¨è®¡æ•°éƒ½æ˜¯ 1ğŸ˜®

```
course = nilstudent = nil**Console output:** *John created
CS-190 generated*
```

æ£€æŸ¥æ‚¨çš„æ§åˆ¶å°è¾“å‡ºã€‚æ‚¨å°†æ‰¾ä¸åˆ°ä»»ä½•å…³äºå–æ¶ˆåˆå§‹åŒ–çš„å†…å®¹ï¼Œå› ä¸ºæ‚¨çš„ **deinit()** æ–¹æ³•æ²¡æœ‰æ‰§è¡Œã€‚è™½ç„¶**è¯¾ç¨‹** & **å­¦ç”Ÿ**è¢«æ˜ç¡®è®¾ç½®ä¸º 0ï¼Œä½†æ˜¯å„ç­ä¹‹é—´ç›¸äº’å‚ç…§ã€‚

![](img/1224a115b9c03667d17626660d8ffd35.png)

è¿™ç§æƒ…å†µè¢«ç§°ä¸º**å†…å­˜æ³„æ¼**ã€‚ARC æ— æ³•é‡Šæ”¾å†…å­˜ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªç±»ä¹‹é—´éƒ½æœ‰ä¸€ä¸ª**å¼º**ä¿ç•™å¾ªç¯ã€‚

# â€œå¼±â€å¼•ç”¨ä»¥é¿å…ä¿ç•™å¾ªç¯

æ ¹æ® swift æ–‡æ¡£ï¼Œ

> å¼±å¼•ç”¨ä¸ä¼šåœ¨å®ƒæ‰€å¼•ç”¨çš„å®ä¾‹ä¸Šä¿ç•™æ®ç‚¹ï¼Œå½“å¼±å¼•ç”¨ä»åœ¨å¼•ç”¨å®ƒæ—¶ï¼Œè¯¥å®ä¾‹æœ‰å¯èƒ½è¢«é‡Šæ”¾ã€‚å› æ­¤ï¼Œå½“å®ƒå¼•ç”¨çš„å®ä¾‹è¢«é‡Šæ”¾æ—¶ï¼ŒARC è‡ªåŠ¨å°†å¼±å¼•ç”¨è®¾ç½®ä¸º nilã€‚

**å¼±**å±æ€§ä¸ä¿ç•™æ®ç‚¹ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬è®¾ç½®ä¸€ä¸ªå±æ€§ä¸º**å¼±**ï¼Œå®ƒä¸ä¼šå¢åŠ ç›¸å…³ç±»çš„å¼•ç”¨è®¡æ•°ã€‚ä½¿ç”¨**å¼±**å‚è€ƒçš„æ—¶é—´ï¼Œå°†**å­¦ç”Ÿ**å†…çš„**è¯¾ç¨‹**å˜é‡è®¾ç½®ä¸º

```
weak var course: Course?
```

è¿™å°†åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå½±å“åˆ°**å­¦ç”Ÿ** & **è¯¾ç¨‹**ç­çº§çš„å…³ç³»ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å®ƒå¦‚ä½•é¿å…å†…å­˜æ³„æ¼ã€‚

![](img/37ebae45a13f24f5123e5179d93440e2.png)

ç›®å‰ï¼Œ**å­¦ç”Ÿ**ç±»æœ‰ä¸¤ä¸ªå¼ºå¼•ç”¨ï¼Œè€Œ**è¯¾ç¨‹**ç±»æœ‰ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œå¦ä¸€ä¸ªå¼±å¼•ç”¨ã€‚å¦‚æœæˆ‘ä»¬è®¾ç½®**è¿›ç¨‹**å˜é‡ä¸º **nilï¼Œ**å®ƒå°†è§£å†³**å†…å­˜æ³„æ¼**ğŸ˜² ğŸ˜²

æ˜¯çš„ï¼Œè¿™èƒŒåçš„é»‘å®¢æ˜¯å½“æˆ‘ä»¬å°†**è¯¾ç¨‹**å˜é‡è®¾ç½®ä¸º 0 æ—¶ï¼Œ**è¯¾ç¨‹** & **å­¦ç”Ÿ**ç±»ä¹‹é—´çš„å¼ºå…³ç³»ä¸å¤å­˜åœ¨(è‡ªåŠ¨ç§»é™¤ï¼Œå› ä¸º**è¯¾ç¨‹**å¼•ç”¨è¢«ç§»é™¤)ã€‚

ä½†æ˜¯å¦ä¸€ä¸ªå¼±å¼•ç”¨å‘¢ï¼Ÿå¼±å‚è€ƒå°†åœ¨è®¾ç½®ä¸º**é›¶**çš„è¿‡ç¨‹åç«‹å³é€šè¿‡ ARC è®¾ç½®ä¸º**é›¶**ã€‚è¿™å°±æ˜¯å¼±å…³é”®å­—çš„åŠ›é‡ğŸ˜ƒ

ç°åœ¨è®¾ç½®**èˆªå‘**å˜é‡ä¸º**é›¶**å¹¶çœ‹åˆ°ä½ çš„æ§åˆ¶å°å‡ºæ¥ã€‚

```
course = nil**Console output:** John created
CS-190 generated
Deinit course CS-190
```

**è°ƒç”¨**è¯¾ç¨‹**ç±»ä¸­çš„ deinit()** æ–¹æ³•ã€‚è¿™æ„å‘³ç€ ARC æˆåŠŸåœ°ä»å†…å­˜ä¸­åˆ é™¤äº†**èˆªå‘**å˜é‡ã€‚

![](img/2bb73ded3145dd0bd320fd76684282c1.png)

çœ‹ä¸åˆ°æ›´å¤šçš„ä¿ç•™å‘¨æœŸï¼Œæ²¡æœ‰æ›´å¤šçš„å†…å­˜æ³„æ¼ã€‚ç°åœ¨ï¼Œå¦‚æœä¸å†éœ€è¦ï¼Œæ‚¨ä¹Ÿå¯ä»¥å°†**å­¦ç”Ÿ**å˜é‡è®¾ç½®ä¸º**é›¶**ã€‚

# â€œæ— ä¸»â€å¼•ç”¨

**æ— ä¸»**æ˜¯å¦ä¸€ç§æœ€å°åŒ–å¼•ç”¨è®¡æ•°çš„æ–¹æ³•ã€‚ç±»ä¼¼äº**å¼±**ä½†ä¸¤è€…ç•¥æœ‰åŒºåˆ«ã€‚**å¼±**å‚è€ƒå¿…é¡»æ˜¯å¯é€‰ç±»å‹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå½“ä¸å†éœ€è¦å¼•ç”¨æ—¶ï¼ŒARC å¯ä»¥å°† nil è®¾ç½®ä¸ºå¼±å¼•ç”¨ã€‚

æ— ä¸»çš„ä¸èƒ½æ˜¯å¯æœ‰å¯æ— çš„ï¼Œå¹¶æœŸæœ›æ€»æœ‰ä¸€äº›ä»·å€¼ã€‚æ‰€ä»¥ ARC ä¸èƒ½æŠŠä¸€ä¸ªæœªçŸ¥çš„å‚è€ƒå€¼è®¾ç½®ä¸º nilã€‚è¯·è€ƒè™‘ä»¥ä¸‹äº‹å®ï¼Œæ³¨æ„ä½¿ç”¨ unownedã€‚æ ¹æ® swift æ–‡æ¡£ï¼Œ

> ä»…å½“æ‚¨ç¡®å®šå¼•ç”¨æ€»æ˜¯å¼•ç”¨å°šæœªè¢«é‡Šæ”¾çš„å®ä¾‹æ—¶ï¼Œæ‰ä½¿ç”¨æ— ä¸»å¼•ç”¨ã€‚
> 
> å¦‚æœæ‚¨è¯•å›¾åœ¨å®ä¾‹è¢«é‡Šæ”¾åè®¿é—®ä¸€ä¸ªæ— ä¸»å¼•ç”¨çš„å€¼ï¼Œæ‚¨å°†å¾—åˆ°ä¸€ä¸ªè¿è¡Œæ—¶é”™è¯¯ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¸**æ— ä¸»ç›¸å…³çš„ä¾‹å­ã€‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªç­çº§**å­¦ç”Ÿ** & **å¤§å­¦**ã€‚ç­çº§ä¹‹é—´çš„å…³ç³»ä¸ä»¥å‰çš„ç­çº§ç•¥æœ‰ä¸åŒã€‚ä¸€ä¸ªå­¦ç”Ÿå¯èƒ½æœ‰ä¹Ÿå¯èƒ½æ²¡æœ‰ä»»ä½•å¤§å­¦ï¼Œä½†æ¯ä¸ªå¤§å­¦éƒ½å¿…é¡»æœ‰å­¦ç”Ÿã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æŠŠ**å¤§å­¦**ç±»é‡Œé¢çš„**å­¦ç”Ÿ**å˜é‡å£°æ˜ä¸º**æ— ä¸»**ä¸èƒ½å†å¯é€‰äº†ã€‚**

```
class Students {
    let studentName: String
    var university: University? init(studentName: String) {
        self.studentName = studentName
    }
    deinit { 
        print(â€œ\(studentName) is being deinitializedâ€) }
    }class University {
    let universityName: String
    unowned let student: Students init(universityName: String, student: Students) {
        self.universityName = universityName 
        self.student = student
    } deinit {
        print(â€œ\(universityName) is being deinitializedâ€) }
    }var student: Students?
student = Students(studentName: â€œJohnâ€)
student!.university = University(universityName: â€œABCâ€, student: student!)
```

ç°åœ¨è¿™ä¸¤ä¸ªé˜¶çº§ä¹‹é—´çš„å…³ç³»å°±åƒä¸‹å›¾ä¸€æ ·

![](img/cb6e1128a1aad61662e9a1404541125f.png)

å¦‚æœæˆ‘ä»¬æƒ³é‡Šæ”¾ä½ çš„å†…å­˜ï¼Œåªéœ€å°†**å­¦ç”Ÿ**å˜é‡è®¾ç½®ä¸º**é›¶**ã€‚

```
student = nil**Console output:** John is being deinitialized
ABC is being deinitialized
```

æ£€æŸ¥ä½ çš„æ§åˆ¶å°ï¼ŒARC æˆåŠŸåœ°ä»å†…å­˜ä¸­åˆ é™¤äº†å¯¹è±¡çš„å¼•ç”¨ï¼Œé…·ğŸ˜å…¶è¾“å‡ºå°†å¦‚ä¸‹æ‰€ç¤ºã€‚

![](img/0c298cf7eef19c2dd4c155707f8b6ed4.png)

ä½†æ˜¯ç­‰åˆ°**æ— ä¸»çš„æ—¶å€™**ä¼šå‡ºé—®é¢˜å—ï¼Ÿå°† **student** å¯¹è±¡è®¾ç½®ä¸º **nil** åï¼Œå°è¯•å¦‚ä¸‹è®¿é—® **University** ç±»çš„ **student** å±æ€§ã€‚

```
student = nil
university.student //Run time error
```

æ ¹æ® **unowned** çš„å®šä¹‰ï¼Œå®ƒå¿…é¡»æœ‰ä¸€ä¸ªå¯¹è¯¥å¯¹è±¡çš„éé›¶å¼•ç”¨ã€‚ç”±äºæ‰€æœ‰è€…å¯¹è±¡å·²ç»è¢«é‡Šæ”¾ï¼Œå®ƒå´©æºƒäº†ã€‚

æˆ‘æƒ³ç°åœ¨æ‚¨å·²ç»å¯¹ä½¿ç”¨ Swift ç¼–ç¨‹è¯­è¨€è¿›è¡Œå†…å­˜ç®¡ç†æœ‰äº†ä¸€äº›äº†è§£ã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šï¼ŒæŸ¥çœ‹æˆ‘çš„å†…å­˜ç®¡ç†æ•™ç¨‹ç¬¬äºŒéƒ¨åˆ†[è¿™é‡Œ](https://medium.com/@arifulislam14/memory-management-in-swift-part-02-b5b5f9fbb12b)ã€‚ä½ ä¼šåœ¨ [Swift çš„å®˜æ–¹æ–‡æ¡£](https://docs.swift.org/swift-book/LanguageGuide/AutomaticReferenceCounting.html)ä¸­æ‰¾åˆ°å¯¹å®ƒä»¬çš„ç®€çŸ­è®¨è®ºã€‚

**å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ç”¨ï¼Œè¯·åˆ†äº«å¹¶é¼“æŒ**ğŸ‘ğŸ‘ğŸ‘
åœ¨ [Medium](https://medium.com/@arifulislam14) ä¸ŠæŸ¥çœ‹æˆ‘çš„å…¶ä»–æ–‡ç« ï¼Œåœ¨ [LinkedIn](https://www.linkedin.com/in/arifparvez14/) ä¸Šå¸®æˆ‘è”ç³»ã€‚

æ„Ÿè°¢æ‚¨é˜…è¯»&å¿«ä¹ç¼–ç ğŸ™‚