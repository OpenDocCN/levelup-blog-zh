<html>
<head>
<title>Kubesec for Static Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于静态分析的Kubesec</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/static-analysis-kubesec-cc4ed1fb88e3?source=collection_archive---------9-----------------------#2022-12-02">https://levelup.gitconnected.com/static-analysis-kubesec-cc4ed1fb88e3?source=collection_archive---------9-----------------------#2022-12-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="03a3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">kube sec——安全分析概述</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c42bb1514654bb0139b879cac240bd7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*98RmgcHgM1cyOobu"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">克里斯多夫·伯恩斯在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="bca7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">kubernetes资源的静态分析</strong>可以帮助我们识别安全威胁，并在部署前修复它们。</p><p id="5863" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kubernetes的静态分析工具之一是<a class="ae kv" href="https://kubesec.io/" rel="noopener ugc nofollow" target="_blank"> kubesec </a>。kubesec将帮助我们分析Kubernetes资源的安全风险。</p><h2 id="1a60" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">kubesec —二进制安装:</h2><p id="de53" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在Linux的情况下，使用<a class="ae kv" href="https://medium.com/geekculture/linux-command-dmesg-uname-d2e4f98d6c98" rel="noopener"> <strong class="ky ir"> uname </strong> </a>检查您的Linux架构:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="f549" class="mv lt iq mr b be mw mx l my mz">&gt;&gt; uname --all<br/><br/>Linux controlplane 5.4.0-1093-gcp #102~18.04.1-Ubuntu SMP Sat Oct 29 06:35:49 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span></pre><p id="2c3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后从这里获取二进制— <a class="ae kv" href="https://github.com/controlplaneio/kubesec/releases" rel="noopener ugc nofollow" target="_blank">最新发布</a>。并将其安装在您的系统上。</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="e84f" class="mv lt iq mr b be mw mx l my mz">&gt;&gt; wget https://github.com/controlplaneio/kubesec/releases/download/v2.12.0/kubesec_linux_amd64.tar.gz<br/><br/>&gt;&gt; tar -xvf  kubesec_linux_amd64.tar.gz<br/>CHANGELOG.md<br/>LICENSE<br/>README.md<br/>kubesec<br/><br/>&gt;&gt; mv kubesec /usr/bin/</span></pre><p id="3c96" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们将扫描以下pod清单以分析安全风险:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="7bb1" class="mv lt iq mr b be mw mx l my mz"># pod manifest<br/># pod.yaml<br/><br/>apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  labels:<br/>    run: pod-1<br/>  name: pod-1<br/>spec:<br/>  containers:<br/>  - image: nginx<br/>    name: pod-1<br/>    securityContext:<br/>      privileged: true</span></pre><h2 id="faf1" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">kubesec扫描:</h2><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="2aa5" class="mv lt iq mr b be mw mx l my mz">&gt;&gt; kubesec scan pod.yaml<br/><br/># ---------------------------------------------------------------------------<br/>[<br/>  {<br/>    "object": "Pod/pod-1.default",<br/>    "valid": true,<br/>    "fileName": "pod.yaml",<br/>    "message": "Failed with a score of -30 points",   # failed<br/>    "score": -30,        # &lt;-------<br/>    "scoring": {<br/>      "critical": [<br/>        {<br/>          "id": "Privileged",   # &lt;-------------<br/>          "selector": "containers[] .securityContext .privileged == true",<br/>          "reason": "Privileged containers can allow almost completely unrestricted host access",<br/>          "points": -30<br/>        }<br/>      ],<br/>      "advise": [<br/>        {<br/>          "id": "ApparmorAny",<br/>          "selector": ".metadata .annotations .\"container.apparmor.security.beta.kubernetes.io/nginx\"",<br/>          "reason": "Well defined AppArmor policies may provide greater protection from unknown threats. WARNING: NOT PRODUCTION READY",<br/>          "points": 3<br/>        },<br/>        {<br/>          "id": "ServiceAccountName",<br/>          "selector": ".spec .serviceAccountName",<br/>          "reason": "Service accounts restrict Kubernetes API access and should be configured with least privilege",<br/>          "points": 3<br/>        },<br/>        {<br/>          "id": "SeccompAny",<br/>          "selector": ".metadata .annotations .\"container.seccomp.security.alpha.kubernetes.io/pod\"",<br/>          "reason": "Seccomp profiles set minimum privilege and secure against unknown threats",<br/>          "points": 1<br/>        },<br/>        {<br/>          "id": "LimitsCPU",<br/>          "selector": "containers[] .resources .limits .cpu",<br/>          "reason": "Enforcing CPU limits prevents DOS via resource exhaustion",<br/>          "points": 1<br/>        },<br/>        {<br/>          "id": "LimitsMemory",<br/>          "selector": "containers[] .resources .limits .memory",<br/>          "reason": "Enforcing memory limits prevents DOS via resource exhaustion",<br/>          "points": 1<br/>        },<br/>        {<br/>          "id": "RequestsCPU",<br/>          "selector": "containers[] .resources .requests .cpu",<br/>          "reason": "Enforcing CPU requests aids a fair balancing of resources across the cluster",<br/>          "points": 1<br/>        },<br/>        {<br/>          "id": "RequestsMemory",<br/>          "selector": "containers[] .resources .requests .memory",<br/>          "reason": "Enforcing memory requests aids a fair balancing of resources across the cluster",<br/>          "points": 1<br/>        },<br/>        {<br/>          "id": "CapDropAny",<br/>          "selector": "containers[] .securityContext .capabilities .drop",<br/>          "reason": "Reducing kernel capabilities available to a container limits its attack surface",<br/>          "points": 1<br/>        },<br/>        {<br/>          "id": "CapDropAll",<br/>          "selector": "containers[] .securityContext .capabilities .drop | index(\"ALL\")",<br/>          "reason": "Drop all capabilities and add only those required to reduce syscall attack surface",<br/>          "points": 1<br/>        },<br/>        {<br/>          "id": "ReadOnlyRootFilesystem",<br/>          "selector": "containers[] .securityContext .readOnlyRootFilesystem == true",<br/>          "reason": "An immutable root filesystem can prevent malicious binaries being added to PATH and increase attack cost",<br/>          "points": 1<br/>        },<br/>        {<br/>          "id": "RunAsNonRoot",<br/>          "selector": "containers[] .securityContext .runAsNonRoot == true",<br/>          "reason": "Force the running image to run as a non-root user to ensure least privilege",<br/>          "points": 1<br/>        },<br/>        {<br/>          "id": "RunAsUser",<br/>          "selector": "containers[] .securityContext .runAsUser -gt 10000",<br/>          "reason": "Run as a high-UID user to avoid conflicts with the host's user table",<br/>          "points": 1<br/>        }<br/>      ]<br/>    }<br/>  }<br/>]</span></pre><p id="302d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们分析上图，我们会注意到<strong class="ky ir"> pod.yaml </strong>没有通过安全风险分析测试。原因是我们用定义的<strong class="ky ir">特权</strong>模式配置了pod清单，这可能是一个主要的安全风险:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="cf0b" class="mv lt iq mr b be mw mx l my mz">"critical": [<br/>        {<br/>          "id": "Privileged",   # &lt;-------------<br/>          "selector": "containers[] .securityContext .privileged == true",<br/>          "reason": "Privileged containers can allow almost completely unrestricted host access",<br/>          "points": -30<br/>        }<br/>      ],</span></pre><p id="40b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了补救(通过安全测试)，我们必须重新配置<strong class="ky ir"> pod.yaml </strong>:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="b186" class="mv lt iq mr b be mw mx l my mz"># pod manifest<br/># pod.yaml<br/><br/>apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  labels:<br/>    run: pod-1<br/>  name: pod-1<br/>spec:<br/>  containers:<br/>  - image: nginx<br/>    name: pod-1<br/>    securityContext:<br/>      privileged: false   #&lt;-----</span></pre><p id="0ed8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们已将“<strong class="ky ir">特权</strong>模式”更改为“<strong class="ky ir">假</strong>”。现在再次运行<strong class="ky ir"> kubesec扫描</strong>命令:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="d90f" class="mv lt iq mr b be mw mx l my mz">&gt;&gt; kubesec scan pod.yaml<br/><br/>[<br/>  {<br/>    "object": "Pod/pod-1.default",<br/>    "valid": true,<br/>    "fileName": "pod.yaml",<br/>    "message": "Passed with a score of 0 points",  #&lt;-----<br/>    "score": 0,<br/>    "scoring": {<br/>      "advise": [<br/>        {<br/>          "id": "ApparmorAny",<br/>          "selector": ".metadata .annotations .\"container.apparmor.security.beta.kubernetes.io/nginx\"",<br/>          "reason": "Well defined AppArmor policies may provide greater protection from unknown threats. WARNING: NOT PRODUCTION READY",<br/>          "points": 3<br/>        },<br/>       ....<br/>        {<br/>          "id": "RunAsNonRoot",<br/>          "selector": "containers[] .securityContext .runAsNonRoot == true",<br/>          "reason": "Force the running image to run as a non-root user to ensure least privilege",<br/>          "points": 1<br/>        },<br/>       ....</span></pre><p id="4392" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们已经通过了考验。但是有一堆建议给我们，以加强安全。目前，我们的分数是<strong class="ky ir"> 0。为了提高我们的分数，让我们按照kubesec提供的建议修改我们的pod清单。</strong></p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="f7e7" class="mv lt iq mr b be mw mx l my mz"># pod manifest<br/># pod.yaml<br/><br/>apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  labels:<br/>    run: pod-1<br/>  name: pod-1<br/>spec:<br/>  containers:<br/>  - image: nginx<br/>    name: pod-1<br/>    securityContext:<br/>      privileged: false<br/>      runAsNonRoot: true   # advised by kubesec</span></pre><p id="6cc9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在扫描kubesec的<strong class="ky ir"> pod.yaml </strong>文件:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="a4d7" class="mv lt iq mr b be mw mx l my mz">&gt;&gt; kubesec can pod.yaml<br/><br/># ---------------------------------------------------------------------------<br/>[<br/>  {<br/>    "object": "Pod/pod-1.default",<br/>    "valid": true,<br/>    "fileName": "pod.yaml",<br/>    "message": "Passed with a score of 1 points",<br/>    "score": 1,     # &lt;----<br/>    "scoring": {      <br/>      "passed": [    # &lt;----<br/>        {<br/>          "id": "RunAsNonRoot",<br/>          "selector": "containers[] .securityContext .runAsNonRoot == true",<br/>          "reason": "Force the running image to run as a non-root user to ensure least privilege",<br/>          "points": 1<br/>        }<br/>      ],<br/>      "advise": [<br/>        {<br/>          "id": "ApparmorAny",<br/>          "selector": ".metadata .annotations .\"container.apparmor.security.beta.kubernetes.io/nginx\"",<br/>          "reason": "Well defined AppArmor policies may provide greater protection from unknown threats. WARNING: NOT PRODUCTION READY",<br/>          "points": 3<br/>        },<br/>...</span></pre><p id="10ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，如果我们分析上面的演示，我们会看到我们的分数从“0”提高到了“1”。使用kubesec提供的建议，我们可以提高工作负载的安全性。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h2 id="56a0" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">kubesec即服务:</h2><p id="5aa1" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在v2.kubesec.io/scan<a class="ae kv" href="https://v2.kubesec.io/scan" rel="noopener ugc nofollow" target="_blank">的HTTPS</a>也可以买到Kubesec</p><p id="2977" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以在我们的系统上不安装<strong class="ky ir"> kubesec </strong>二进制文件的情况下使用<strong class="ky ir"> kubesec </strong>。为了实现这一点，我们必须用我们的kubernetes清单向远程kubesec服务器发送请求。</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="86ed" class="mv lt iq mr b be mw mx l my mz"># "kubesec scan" request to remote kubesec server<br/>&gt;&gt; curl -sSX POST --data-binary @"pod.yaml" https://v2.kubesec.io/scan</span></pre><h2 id="92d4" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">使用kubesec的其他方法如下:</h2><ul class=""><li id="dbe6" class="nh ni iq ky b kz ml lc mm lf nj lj nk ln nl lr nm nn no np bi translated"><a class="ae kv" href="https://hub.docker.com/r/kubesec/kubesec/tags" rel="noopener ugc nofollow" target="_blank">码头集装箱图像</a>在<code class="fe nq nr ns mr b">docker.io/kubesec/kubesec:v2</code></li><li id="a1c0" class="nh ni iq ky b kz nt lc nu lf nv lj nw ln nx lr nm nn no np bi translated"><a class="ae kv" href="https://github.com/stefanprodan/kubesec-webhook" rel="noopener ugc nofollow" target="_blank"> Kubernetes入场管理员</a></li><li id="0b7e" class="nh ni iq ky b kz nt lc nu lf nv lj nw ln nx lr nm nn no np bi translated"><a class="ae kv" href="https://github.com/stefanprodan/kubectl-kubesec" rel="noopener ugc nofollow" target="_blank"> Kubectl插件</a></li></ul></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><blockquote class="ny nz oa"><p id="0974" class="kw kx ob ky b kz la jr lb lc ld ju le oc lg lh li od lk ll lm oe lo lp lq lr ij bi translated"><em class="iq">如果你觉得这篇文章很有帮助，请点击</em> <strong class="ky ir"> <em class="iq">跟随</em> </strong> <em class="iq">👉</em><strong class="ky ir"><em class="iq"/></strong><em class="iq"/><strong class="ky ir"><em class="iq">拍手</em> </strong> <em class="iq">👏</em> <strong class="ky ir"> <em class="iq"> </em> </strong> <em class="iq">按钮帮助我写更多这样的文章。<br/>谢谢🖤 </em></p></blockquote></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h2 id="e418" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">🚀👉关于Kubernetes的所有文章</h2><div class="of og gp gr oh"><div role="button" tabindex="0" class="ab bv gv cb fp oi oj bn ok kp ex"><div class="ol l"><div class="ab q"><div class="l di"><img alt="Md Shamim" class="l de bw om on fe" src="../Images/b46bdc53005abde6c6cb3e8ff0c200c3.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*Hqd8Xz1WHsoL1s2To3awnA.png"/><div class="fb bw l om on fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@shamimice03?source=post_page-----cc4ed1fb88e3--------------------------------" rel="noopener follow" target="_top"> Md沙米姆</a></p></div></div><div class="oq or gw l"><h2 class="bd ir tx nh fp ty fr fs tz fu fw ip bi translated">关于Kubernetes的所有文章</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi ua au ub uc ud qn ue an eh ei uf ug uh el em eo de bk ep" href="https://medium.com/@shamimice03/list/all-articles-on-kubernetes-7ae1a0f96f3b?source=post_page-----cc4ed1fb88e3--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="ui l fo"><span class="bd b dl z dk">24 stories</span></div></div></div><div class="pd dh pe fp ab pf fo di"><div class="di ov bv ow ox"><div class="dh l"><img alt="" class="dh" src="../Images/f1050aa27a3ef03122558b1ba1de1f58.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7DhVxBWLKw_5M_jP"/></div></div><div class="di ov bv oy oz pa"><div class="dh l"><img alt="" class="dh" src="../Images/f1c4131e92176033bce05392de197205.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*AkrEbqlA_j76u2I5Tm8npg.png"/></div></div><div class="di bv pb pc pa"><div class="dh l"><img alt="" class="dh" src="../Images/27d4385154af67764cf37713dbbdc38e.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*98RmgcHgM1cyOobu"/></div></div></div></div></div></div></div>    
</body>
</html>