<html>
<head>
<title>Autocomplete API with Serverless Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用无服务器Redis的自动完成API</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/autocomplete-api-with-serverless-redis-4f9b1faab39f?source=collection_archive---------13-----------------------#2021-04-07">https://levelup.gitconnected.com/autocomplete-api-with-serverless-redis-4f9b1faab39f?source=collection_archive---------13-----------------------#2021-04-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ecdf974ee5e0505d815683c6310ffb6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YfvTIS-1eymWKXNy.png"/></div></div></figure><p id="a1f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本教程实现了一个由无服务器Redis支持的自动完成API。参见<a class="ae kw" href="https://auto-complete-example.vercel.app/" rel="noopener ugc nofollow" target="_blank">的演示</a>和<a class="ae kw" href="https://wfgz7cju24.execute-api.us-east-1.amazonaws.com/query?term=ca" rel="noopener ugc nofollow" target="_blank"> API的端点</a>和<a class="ae kw" href="https://github.com/upstash/serverless-tutorials/tree/master/auto-complete-api" rel="noopener ugc nofollow" target="_blank">源代码</a>。</p><p id="0db8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将在Redis排序集中保存国家名称。在Redis排序集合中，具有相同分数的元素按字典顺序排序。所以在我们的例子中，所有的国家名称都有相同的分数，0。我们保留国家的所有前缀，并使用ZRANK来查找建议的术语。算法详情见<a class="ae kw" href="http://oldblog.antirez.com/post/autocomplete-with-redis.html" rel="noopener ugc nofollow" target="_blank">这篇博文</a>。</p><h1 id="3a2c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤1:项目设置</h1><p id="6515" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如果您还没有安装无服务器框架，请通过:<code class="fe ma mb mc md b">npm install -g serverless</code></p><p id="675f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在任何文件夹中运行如下<code class="fe ma mb mc md b">serverless</code>:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="49ca" class="mm ky iq md b gy mn mo l mp mq">&gt;&gt; serverless</span><span id="ff51" class="mm ky iq md b gy mr mo l mp mq">Serverless: No project detected. Do you want to create a new one? Yes<br/>Serverless: What do you want to make? AWS Node.js<br/>Serverless: What do you want to call this project? test-upstash</span><span id="2a03" class="mm ky iq md b gy mr mo l mp mq">Project successfully created in 'test-upstash' folder.</span><span id="b657" class="mm ky iq md b gy mr mo l mp mq">You can monitor, troubleshoot, and test your new service with a free Serverless account.</span><span id="308f" class="mm ky iq md b gy mr mo l mp mq">Serverless: Would you like to enable this? No<br/>You can run the “serverless” command again if you change your mind later.</span></pre><p id="669f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在项目文件夹中，使用以下命令创建一个节点项目:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="8d5a" class="mm ky iq md b gy mn mo l mp mq">npm init</span></pre><p id="4981" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后安装redis客户机，安装时使用:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="25fb" class="mm ky iq md b gy mn mo l mp mq">npm install ioredis</span></pre><h1 id="df47" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤2: API实现</h1><p id="12ad" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如下所示编辑handler.js文件。算法详情见<a class="ae kw" href="http://oldblog.antirez.com/post/autocomplete-with-redis.html" rel="noopener ugc nofollow" target="_blank">博文</a>。</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="a2d4" class="mm ky iq md b gy mn mo l mp mq">var Redis = require("ioredis");<br/>if (typeof client === 'undefined') {<br/>    var client = new Redis(process.env.REDIS_URL);<br/>}<br/>const headers = {<br/>    'Access-Control-Allow-Origin': '*',<br/>    'Access-Control-Allow-Credentials': true,<br/>};</span><span id="5f29" class="mm ky iq md b gy mr mo l mp mq">module.exports.query = async (event, context, callback) =&gt; {<br/>    if (!event.queryStringParameters || !event.queryStringParameters.term) {<br/>        return {<br/>            statusCode: 400,<br/>            headers: headers,<br/>            body: JSON.stringify(<br/>                {<br/>                    message: 'Invalid parameters. Term needed as query param.',<br/>                }<br/>            ),<br/>        };<br/>    }<br/>    let term = event.queryStringParameters.term.toUpperCase();<br/>    let res = []<br/>    let rank = await client.zrank("terms", term)<br/>    if (rank != null) {<br/>        let temp = await client.zrange("terms", rank, rank + 100)<br/>        for (const el of temp) {<br/>            if (!el.startsWith(term)) {<br/>                break;<br/>            }<br/>            if (el.endsWith("*")) {<br/>                res.push(el.substring(0, el.length - 1));<br/>            }<br/>        }<br/>    }<br/>    return {<br/>        statusCode: 200,<br/>        headers: headers,<br/>        body: JSON.stringify(<br/>            {<br/>                message: 'Query:' + event.queryStringParameters.term,<br/>                result: res,<br/>            }<br/>        ),<br/>    };<br/>};</span></pre><h1 id="451b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤3:在Upstash上创建数据库</h1><p id="2ba5" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如果您没有数据库，请按照本<a class="ae kw" href="https://docs.upstash.com/" rel="noopener ugc nofollow" target="_blank">指南</a>创建一个数据库。点击数据库页面内的<code class="fe ma mb mc md b">Redis Connect</code>按钮，复制Redis网址。复制ioredis的URL，因为我们在应用程序中使用ioredis。创造。env文件并粘贴您的Redis URL:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="cf20" class="mm ky iq md b gy mn mo l mp mq">REDIS_URL=YOUR_REDIS_URL</span></pre><h1 id="9901" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤4:初始化数据库</h1><p id="a5cc" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们将用国家名称初始化数据库。从<a class="ae kw" href="https://github.com/upstash/serverless-tutorials/blob/master/auto-complete-api/initdb.js" rel="noopener ugc nofollow" target="_blank">这里</a>复制并运行initdb.js脚本。</p><p id="2fbf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们只需将国家名称及其所有前缀放入排序后的集合中。</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="ae6d" class="mm ky iq md b gy mn mo l mp mq">require('dotenv').config()<br/>var Redis = require("ioredis");</span><span id="c6af" class="mm ky iq md b gy mr mo l mp mq">var countries = [<br/>    {"name": "Afghanistan", "code": "AF"},<br/>    {"name": "Åland Islands", "code": "AX"},<br/>    {"name": "Albania", "code": "AL"},<br/>    {"name": "Algeria", "code": "DZ"},<br/>    ...<br/>]<br/>var client = new Redis(process.env.REDIS_URL);</span><span id="938a" class="mm ky iq md b gy mr mo l mp mq">for (const country of countries) {<br/>    let term = country.name.toUpperCase();<br/>    let terms = [];</span><span id="2e41" class="mm ky iq md b gy mr mo l mp mq">for (let i = 1; i &lt; term.length; i++) {<br/>        terms.push(0);<br/>        terms.push(term.substring(0, i));<br/>    }<br/>    terms.push(0);<br/>    terms.push(term + "*");<br/>    (async () =&gt; {<br/>        await client.zadd("terms", ...terms)<br/>    })();<br/>}</span></pre><h1 id="3a53" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤5:部署您的功能<a class="ae kw" href="https://docs.upstash.com/tutorials/auto_complete_with_serverless_redis#step-5-deploy-your-function" rel="noopener ugc nofollow" target="_blank"> # </a></h1><p id="d032" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如下编辑<code class="fe ma mb mc md b">serverless.yml</code>并替换您的Redis URL:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="2a87" class="mm ky iq md b gy mn mo l mp mq">service: auto-complete-api<br/># add this if you set REDIS_URL in .env<br/>useDotenv: true<br/>frameworkVersion: '2'</span><span id="130f" class="mm ky iq md b gy mr mo l mp mq">provider:<br/>  name: aws<br/>  runtime: nodejs14.x<br/>  lambdaHashingVersion: 20201221<br/>  environment:<br/>    REDIS_URL: REPLACE_YOUR_REDIS_URL</span><span id="516d" class="mm ky iq md b gy mr mo l mp mq">functions:<br/>  query:<br/>    handler: handler.query<br/>    events:<br/>      - httpApi:<br/>          path: /query<br/>          method: get<br/>          cors: true</span></pre><p id="e293" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在项目文件夹中运行:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="51ee" class="mm ky iq md b gy mn mo l mp mq">serverless deploy</span></pre><p id="c620" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您可以使用以下命令运行您的函数:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="5da7" class="mm ky iq md b gy mn mo l mp mq">serverless invoke -f query -d '{ "queryStringParameters": {"term":"ca"}}'</span></pre><p id="7f48" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它应该给出以下输出:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="672d" class="mm ky iq md b gy mn mo l mp mq">{<br/>  "statusCode": 200,<br/>  "headers": {<br/>    "Access-Control-Allow-Origin": "*",<br/>    "Access-Control-Allow-Credentials": true<br/>  },<br/>  "body": "{\"message\":\"Query:ca\",\"result\":[\"CAMBODIA\",\"CAMEROON\",\"CANADA\",\"CAPE VERDE\",\"CAYMAN ISLANDS\"]}"<br/>}</span></pre><p id="4a6e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还可以使用AWS控制台测试您的功能。在AWS Lambda部分，单击您的函数。向下滚动到代码部分，点击右上角的<code class="fe ma mb mc md b">Test</code>按钮。使用<code class="fe ma mb mc md b">{ "queryStringParameters": {"term":"ar"}}</code>作为您的事件数据。</p><h1 id="39df" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤6:本地运行您的函数</h1><p id="4d56" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在您的项目文件夹中运行:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="9a08" class="mm ky iq md b gy mn mo l mp mq">serverless invoke local -f query -d '{ "queryStringParameters": {"term":"ca"}}'</span></pre><p id="c817" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它应该给出以下输出:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="250c" class="mm ky iq md b gy mn mo l mp mq">{<br/>  "statusCode": 200,<br/>  "headers": {<br/>    "Access-Control-Allow-Origin": "*",<br/>    "Access-Control-Allow-Credentials": true<br/>  },<br/>  "body": "{\"message\":\"Query:ca\",\"result\":[\"CAMBODIA\",\"CAMEROON\",\"CANADA\",\"CAPE VERDE\",\"CAYMAN ISLANDS\"]}"<br/>}</span></pre></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><p id="ff9b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mz">最初发表于</em><a class="ae kw" href="https://docs.upstash.com/tutorials/auto_complete_with_serverless_redis" rel="noopener ugc nofollow" target="_blank">T5【https://docs.upstash.com】</a><em class="mz">。</em></p></div></div>    
</body>
</html>