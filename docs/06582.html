<html>
<head>
<title>Playing with Multer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与Multer一起玩</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/playing-with-multer-a8a3378194ed?source=collection_archive---------6-----------------------#2020-12-09">https://levelup.gitconnected.com/playing-with-multer-a8a3378194ed?source=collection_archive---------6-----------------------#2020-12-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c469" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使Node.js中的图像上传更简单的技巧</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/917e9a2c5696d5ab7a2c78626255d91c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h4TLlisFk7XvtREAsS7C7Q.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">来源:<a class="ae kv" href="https://unsplash.com/photos/m_HRfLhgABo?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditShareLink" rel="noopener ugc nofollow" target="_blank">Unsplash.com</a></figcaption></figure><p id="b232" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当web客户端在服务器上上传一个文件(比如一张图片或者一个文档)时，通常是通过一个表单，它被编码为<code class="fe ls lt lu lv b">multipart/form-data</code>。因此，multer是一个与Express.js和Node.js一起使用的中间件，使这些文件的处理更加容易。</p><p id="a07b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在深入研究如何定制multer之前，让我们先看看它的基础知识。对于这里的例子，让我们假设一个学生的图像必须被上传，并且图像必须被保存在后端的文件夹<code class="fe ls lt lu lv b">assets/images</code>中。<strong class="ky ir">首先，至关重要的是，在前端客户端的表单中，</strong> <code class="fe ls lt lu lv b"><strong class="ky ir">enctype=multipart/form-data</strong></code> <strong class="ky ir">被设置。</strong></p><p id="700e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">乘法器在磁盘存储中提供了两个参数:</p><ol class=""><li id="af19" class="lw lx iq ky b kz la lc ld lf ly lj lz ln ma lr mb mc md me bi translated"><code class="fe ls lt lu lv b">destination</code>，目标文件夹</li><li id="cb61" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr mb mc md me bi translated"><code class="fe ls lt lu lv b">filename</code>，这是我们想要保存文件的名字。</li></ol><p id="f8a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于上面的例子，这可以如下进行</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="dee2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里，我们对文件进行检查，以确保它是一个图像，然后我们给它一个随机的名称，同时将它存储在后端。您也可以选择不更改名称，在这种情况下，文件将与用户使用的名称相同。</p><p id="594e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们看看如何定制它。</p><h2 id="e240" class="mm mn iq bd mo mp mq dn mr ms mt dp mu lf mv mw mx lj my mz na ln nb nc nd ne bi translated">如果要根据某些条件将文件存储在不同的目的地呢？</h2><p id="96a9" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">假设web客户端允许教师和学生上传他们的个人资料图像，他们的图像分别存储在文件夹<code class="fe ls lt lu lv b">assets/images/teachers </code>和<code class="fe ls lt lu lv b">assets/images/students </code>中。所以，在设置文件的目的地之前，重要的是我们要弄清楚这是老师的形象还是学生的形象。</p><p id="138b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一种方法是在客户端设置的<code class="fe ls lt lu lv b">formData </code>中定义一个布尔变量。但是由于multer是一个中间件，文件通常出现在任何formData的顶部，所以表单中的其他参数在这里是不可访问的。为此，需要做一个小的改变，那就是在formData的末尾添加文件。这样，检查这是老师还是学生的图像变得更容易，因此可以将其保存在适当的文件夹中。</p><p id="0580" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以设布尔变量为<code class="fe ls lt lu lv b">isStudent</code>。</p><p id="e43f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的表单数据包含学生/教师注册时的基本数据，看起来像这样</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="804d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，<code class="fe ls lt lu lv b">“image”</code>被附加在<code class="fe ls lt lu lv b"> formData</code>的末尾。</p><p id="1940" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，multer上传功能将修改如下-</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><h2 id="d4b4" class="mm mn iq bd mo mp mq dn mr ms mt dp mu lf mv mw mx lj my mz na ln nb nc nd ne bi translated">如果您想使用从数据库中检索的值来重命名文件，该怎么办？</h2><p id="9f2c" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">比方说，我不想给这些图像起一个随机的名字，而是想给它们起一些有意义的名字，以确保我以后可以检索这些图像。继续我们的例子，让我们假设图像必须被命名为——学生的<code class="fe ls lt lu lv b">“RollNo.jpg”</code>和教师的<code class="fe ls lt lu lv b">“StaffNo.jpg”</code>。在这里，<code class="fe ls lt lu lv b">RollNo</code>和<code class="fe ls lt lu lv b">StaffNo</code>将不得不从数据库中检索，给定这些人的唯一<code class="fe ls lt lu lv b">IDValues</code>。</p><p id="85da" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，解决这个问题的一种方法是在multer存储器的<code class="fe ls lt lu lv b">filename </code>参数中命名该文件，就像我们到目前为止所做的那样，然后在用于该路径的控制器函数中对其进行重命名。仅在控制器函数中重命名的原因是，只能在控制器函数中从数据库中检索值。</p><p id="0731" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我们的multer上传功能将与上述功能相同。</p><p id="3d40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让控制器函数被称为<code class="fe ls lt lu lv b">setProfileImage().</code></p><p id="8e79" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">控制器函数将以这种方式进行重命名-</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="e37b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里，我根据是学生还是教师来检索员工编号，然后重命名该文件。这里使用的数据库是Mongodb，但这可以用任何数据库来完成。</p><p id="a047" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一种不用重命名就能保存图像的方法是在Mongoose对象中添加一个名为<code class="fe ls lt lu lv b"> imagePath</code>的新字段，它将存储我们给定的随机文件名。</p><p id="842e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">还有更多的方法可以定制multer，比如它可以处理多个文件上传，不像上面例子中的单个文件上传。更多关于multer的信息可以在<a class="ae kv" href="https://github.com/expressjs/multer" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h2 id="37d5" class="mm mn iq bd mo mp mq dn mr ms mt dp mu lf mv mw mx lj my mz na ln nb nc nd ne bi translated">就是这样！</h2><p id="cb80" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">我希望这对你使用multer上传文件和以不同的方式保存文件有用。</p><h2 id="664e" class="mm mn iq bd mo mp mq dn mr ms mt dp mu lf mv mw mx lj my mz na ln nb nc nd ne bi translated">资源-</h2><p id="c3f2" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/expressjs/multer#readme" rel="noopener ugc nofollow" target="_blank">https://github.com/expressjs/multer#readme</a></p></div></div>    
</body>
</html>