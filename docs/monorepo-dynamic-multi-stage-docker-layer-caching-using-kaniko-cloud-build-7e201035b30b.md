# Monorepo:ä½¿ç”¨ Kaniko +äº‘æ„å»ºçš„åŠ¨æ€å¤šçº§ Docker å±‚ç¼“å­˜

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/monorepo-dynamic-multi-stage-docker-layer-caching-using-kaniko-cloud-build-7e201035b30b>

åœ¨è¿™ç¯‡ç®€æ˜çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºä¸€ç§åœ¨ monorepo ä¸­å…±äº«æ‚¨çš„åº”ç”¨ç¨‹åºçš„ Docker æ–‡ä»¶çš„å¥½æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨ Kaniko å’Œ Cloud Build æ¥ç¼“å­˜æ‰€æœ‰å¤šé˜¶æ®µ Docker å±‚ã€‚

![](img/bcd54b61c3d620c2bb399d3835054c73.png)

# è¿½è¸ª

è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« çš„åç»­ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚

[](/multi-stage-docker-layer-caching-using-kaniko-cloud-build-7e46395fb2c2) [## ä½¿ç”¨ Kaniko +äº‘æ„å»ºçš„å¤šçº§ Docker å±‚ç¼“å­˜

### ç®€è¦ä»‹ç»å¦‚ä½•åœ¨äº‘æ„å»ºä¸­ä½¿ç”¨ Kanikoï¼Œå¹¶éªŒè¯å¤šé˜¶æ®µ Docker æ˜ åƒæ˜¯å¦è¢«æ­£ç¡®ç¼“å­˜ã€‚

levelup.gitconnected.com](/multi-stage-docker-layer-caching-using-kaniko-cloud-build-7e46395fb2c2) 

æ‚¨å¯ä»¥å°†æœ¬æ–‡è§†ä¸ºä¸€ä¸ªâ€œé«˜çº§â€ç‰ˆæœ¬ï¼Œå®ƒæ˜¯åœ¨ monorepo ç”¨ä¾‹çš„åŸºç¡€ä¸Šåˆ›å»ºçš„ï¼Œå…¶ä¸­å‡ ä¸ªæœåŠ¡å…±äº«åŒä¸€ä¸ª Dockerfileï¼Œè¿™è‡³å°‘åœ¨æˆ‘çš„å·¥ä½œç¯å¢ƒä¸­æ˜¯å¸¸è§çš„ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä¸ä¼šåœ¨æœ¬æ•™ç¨‹ä¸­éå†æ¯ä¸€è¡Œä»£ç ï¼Œè€Œåªä¼šéå†ä¸è¿™ä¸ªé«˜çº§ç‰ˆæœ¬ç›¸å…³çš„ä»£ç ã€‚å› æ­¤ï¼Œè¯·åŠ¡å¿…æ£€æŸ¥ä¹‹å‰çš„æ–‡ç« ã€‚

# GitHub çŸ¥è¯†åº“

è¦æŸ¥çœ‹ä½¿ç”¨çš„ä»£ç ï¼Œè¯·æŸ¥çœ‹æˆ‘ä¸ºæœ¬æ–‡åˆ›å»ºçš„ [GitHub åº“](https://github.com/mr-pascal/medium-cloud-build-kaniko-monorepo)ã€‚

[](https://github.com/mr-pascal/medium-cloud-build-kaniko-monorepo) [## GitHub-Mr-Pascal/medium-cloud-build-kaniko-mono repo

### æ­¤æ—¶æ‚¨ä¸èƒ½æ‰§è¡Œè¯¥æ“ä½œã€‚æ‚¨å·²ä½¿ç”¨å¦ä¸€ä¸ªæ ‡ç­¾é¡µæˆ–çª—å£ç™»å½•ã€‚æ‚¨å·²åœ¨å¦ä¸€ä¸ªé€‰é¡¹å¡ä¸­æ³¨é”€ï¼Œæˆ–è€…â€¦

github.com](https://github.com/mr-pascal/medium-cloud-build-kaniko-monorepo) 

# æ–‡ä»¶å¤¹ç»“æ„

å› æ­¤ï¼Œè®©æˆ‘ä»¬é¦–å…ˆæµè§ˆä¸€ä¸‹æˆ‘ä»¬çš„æ–‡ä»¶å¤¹ç»“æ„å’Œæˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­è®¨è®ºçš„å•ä¸ªæ–‡ä»¶

```
|- kaniko-demo/
|- kaniko-demo2/
|- build.sh
|- cloudbuild.yaml
|- Dockerfile
```

*   æˆ‘ä»¬çš„æ¼”ç¤ºåº”ç”¨ç¨‹åºã€‚åªæ˜¯ä¸€ä¸ªæ–°çš„ Nest.js åº”ç”¨ã€‚
*   `kaniko-demo2` â€”å¦ä¸€ä¸ªæ¼”ç¤ºåº”ç”¨ã€‚åªæ˜¯ä¸€ä¸ªæ–°çš„ Nest.js åº”ç”¨ã€‚
*   `build.sh` â€”ä¸€ä¸ªå¸¦æœ‰å‚æ•°çš„å°å‹ shell è„šæœ¬ï¼Œæœ‰åŠ©äºç®€åŒ–æˆ‘ä»¬çš„æ„å»ºï¼Œä»¥æ„å»ºæœ¬åœ° Docker æ˜ åƒæˆ–å°†æ„å»ºæäº¤åˆ°äº‘æ„å»ºã€‚
*   `Dockerfile` â€”ä¸¤ä¸ªæ¼”ç¤ºåº”ç”¨ç¨‹åºä½¿ç”¨çš„ Dockerfile æ–‡ä»¶ã€‚

# ä»£ç 

ä¸ºäº†ä½¿ä¹‹å‰çš„[æ•™ç¨‹](/multi-stage-docker-layer-caching-using-kaniko-cloud-build-7e46395fb2c2)ä¸­çš„ç¤ºä¾‹ä¸º monorepo è®¾ç½®ä¸­çš„æµçº¿å‹æ„å»ºæ­¥éª¤åšå¥½å‡†å¤‡ï¼Œæˆ‘ä»¬å¿…é¡»è°ƒæ•´`Dockerfile`ã€`cloudbuild.yaml`å¹¶æä¾›ä¸€ç§é€šè¿‡ shell è„šæœ¬æ„å»ºæ˜ åƒçš„åŠ¨æ€æ–¹å¼ã€‚

## Dockerfile æ–‡ä»¶

ä¸€èˆ¬æ¥è¯´ï¼Œä½ çš„`Dockerfile`åœ¨ä½ çš„åº”ç”¨ç¨‹åºçš„æ–‡ä»¶å¤¹é‡Œã€‚æœ‰äº† monorepoï¼Œä½ ä»ç„¶å¯ä»¥èµ°è¿™æ¡è·¯ã€‚å³ä½¿æ‚¨ç»å¸¸æƒ³è¦å…±äº« Docker æ„å»ºé…ç½®ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸€ä¸ªæœåŠ¡å¤åˆ¶&ç²˜è´´å®ƒã€‚

ä¸ºæ­¤ï¼Œæ‚¨çš„`Dockerfile`éœ€è¦æ›´åŠ é€šç”¨ï¼Œå¹¶ä¸”ä½äºæ‚¨çš„æœåŠ¡æ–‡ä»¶å¤¹ä¹‹å¤–ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„`Dockerfile`ã€‚è¯¥æ–‡ä»¶ä¸ä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„æ–‡ä»¶å‡ ä¹ç›¸åŒï¼Œå°½ç®¡æœ‰å››è¡Œä»£ç æ˜¯æ–°çš„ï¼Œå¹¶æ ‡æœ‰`## NEW!!`æ³¨é‡Šï¼Œæ‰€ä»¥æ‚¨æ›´å®¹æ˜“å‘ç°ã€‚

æˆ‘ä»¬åˆ°åº•åœ¨é‚£é‡Œåšäº†ä»€ä¹ˆï¼Ÿ

ç”±äº Docker æ–‡ä»¶åœ¨å®é™…çš„æœåŠ¡æ–‡ä»¶å¤¹ä¹‹å¤–ï¼Œæˆ‘ä»¬å¿…é¡»ä¸º Docker æä¾›ä¸€ä¸ªæŒ‡å‘æºä»£ç çš„è·¯å¾„ï¼Œå› ä¸ºå®ƒå¯èƒ½åœ¨ä»»ä½•åœ°æ–¹ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªåä¸º`SRC_DIR`çš„æ„å»ºå‚æ•°ã€‚è¿™ä¸ªå‚æ•°ç¨åå°†è¢«è®¾ç½®ä¸ºæˆ‘ä»¬çš„æœåŠ¡çš„æ–‡ä»¶å¤¹åï¼Œä¾‹å¦‚`kaniko-demo2`ã€‚ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€åœ°æ„å»ºåˆ°`package.json`ã€`package-lock.json`å’Œå‰©ä½™æºæ–‡ä»¶çš„æ–‡ä»¶è·¯å¾„ã€‚

å¯¹äº`Dockerfile`ï¼Œæˆ‘ä»¬æ²¡æœ‰ä»€ä¹ˆéœ€è¦æ”¹å˜çš„äº†ã€‚

## cloudbuild.yaml

å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»å‘Šè¯‰äº‘æ„å»ºé…ç½®ï¼Œå®ƒç°åœ¨å¿…é¡»æ„å»º Docker æ˜ åƒã€‚è¿™é‡Œæˆ‘ä»¬è¿˜å¿…é¡»æ›´æ”¹ä¸‰è¡Œä»£ç 

ä½¿ç”¨`--dockerfile=${_DOCKER_FILE}`å‚æ•°ï¼Œæˆ‘ä»¬å‘Šè¯‰ Cloud Build å’Œ Kanikoï¼Œå°†æœ‰ä¸€ä¸ª`_DOCKER_FILE`å‚æ•°ä¼ é€’ç»™ Cloud Build å‘½ä»¤ï¼ŒKaniko åº”è¯¥ä½¿ç”¨è¿™ä¸ªå‚æ•°ä½œä¸ºåˆ°`Dockerfile`çš„è·¯å¾„ã€‚

`--build-arg=SRC_DIR=${_APP}`è¡¨ç¤ºå°†ä¼ é€’ä¸€ä¸ª`_APP`å‚æ•°ï¼ŒKaniko åº”å°†è¯¥å‚æ•°ç”¨ä½œ Docker æ„å»ºå‚æ•°`SRC_DIR`çš„å€¼ï¼Œè¯¥å‚æ•°åœ¨`Dockerfile`ä¸­å®šä¹‰ã€‚

æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å¿…é¡»è°ƒæ•´`--destination`å‚æ•°çš„å€¼ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨`${_APP}`è€Œä¸æ˜¯ç¡¬ç¼–ç çš„`kaniko-demo`ã€‚

æ‰€ä»¥ä½ çœ‹ï¼Œ`cloudbuild.yaml`çš„å˜åŒ–ä¹Ÿæ˜¯æ¯«ä¸è´¹åŠ›å’Œç›´æ¥çš„ã€‚

## build.sh

ä½†æ˜¯ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡è®¾ç½®å®šåˆ¶æ„å»ºè„šæœ¬æ¥è¿›å…¥æ›´æ¿€åŠ¨äººå¿ƒçš„éƒ¨åˆ†ã€‚

åœ¨ä¸‹é¢çš„`build.sh`æ–‡ä»¶ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•é€šè¿‡å…±äº«çš„`Dockerfile`åŠ¨æ€æ„å»ºæ‚¨çš„åº”ç”¨ç¨‹åºï¼Œè€Œä¸ä¼šå¢åŠ æ„å»ºä¸Šä¸‹æ–‡ã€‚

é¦–å…ˆï¼Œæ‚¨å¯èƒ½ä¼šå¿½ç•¥å‰ 35 è¡Œä»£ç ï¼Œå› ä¸ºå®ƒä»¬æ›´åƒæ˜¯â€œè¾…åŠ©ä»£ç â€ï¼Œè€Œä¸æ˜¯é‡è¦çš„é€»è¾‘ã€‚ä½†ç®€è€Œè¨€ä¹‹ï¼Œè¿™æ®µä»£ç ä¸ºæ‚¨çš„ shell è„šæœ¬æä¾›äº†æ¥å—ä¸€ä¸ª`-c`æ ‡å¿—å’Œä¸€ä¸ª`-a $APP`å‚æ•°çš„å¯èƒ½æ€§ã€‚

æœ€åï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿™äº›å‘½ä»¤è¿è¡Œä»¥ä¸‹æ„å»ºè„šæœ¬:

```
# Build "kaniko-demo" app on your local machine
./build.sh -a kaniko-demo# Build "kaniko-demo" app on Cloud Build
./build.sh -c -a kaniko-demo
```

æˆ‘è¯•å›¾åœ¨ shell è„šæœ¬çš„é‡è¦éƒ¨åˆ†æ·»åŠ ä¸€äº›æœ‰æ„ä¹‰çš„å‘½ä»¤ï¼Œä½†æ˜¯è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹å®ƒçš„å‡ ä¸ªéƒ¨åˆ†:

é¦–å…ˆï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦ä¸“ç”¨çš„ Dockerfile å’Œã€‚dockerignoreï¼Ÿ

ä½ å¯èƒ½è®¤ä¸ºä½ ä¸éœ€è¦ä¸€ä¸ªä¸“ç”¨çš„`Dockerfile`,å› ä¸ºæ— è®ºå¦‚ä½•éƒ½æ˜¯ç›¸åŒçš„å‘½ä»¤ï¼Œå¯¹å—ï¼Ÿä½†æ˜¯æœ‰ä¸€ä¸ªæŠ€å·§ï¼Œä¸ºä»€ä¹ˆå®ƒä»ç„¶æ˜¯å¿…éœ€çš„ï¼Œå½“æˆ‘ä»¬å°†å‚æ•°ä¼ é€’ç»™`docker build`å‘½ä»¤æ—¶ï¼Œæ‚¨å°†åœ¨æœ¬æ–‡çš„åé¢æ‰¾åˆ°è¿™ä¸ªæŠ€å·§ã€‚

å¦ä¸€æ–¹é¢ï¼Œ`*.dockerignore`éå¸¸é‡è¦ã€‚æˆ‘è®¤ä¸ºæ„å»ºæ–‡ä»¶å¤¹`dist`å’Œ`node_modules`æ–‡ä»¶å¤¹åº”è¯¥æ€»æ˜¯è¢«æ’é™¤åœ¨å¤–ï¼Œè¿™æ˜¯å¾ˆæ¸…æ¥šçš„å¸¸è¯†ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬é¦–å…ˆå¿½ç•¥ä¸€åˆ‡ï¼Œç„¶åæ˜¾å¼å¯ç”¨æˆ‘ä»¬æƒ³è¦æ„å»ºçš„åº”ç”¨ç¨‹åºçš„æºæ–‡ä»¶å¤¹å‘¢ï¼Ÿ

Dockerï¼Œè¿˜æœ‰äº‘æ„å»ºï¼Œæ€»æ˜¯æ¥å—æ„å»ºä¸Šä¸‹æ–‡ã€‚åœ¨è„šæœ¬ä¸­ï¼Œé€šè¿‡`.`è·å–å½“å‰æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰æ–‡ä»¶å’ŒæœåŠ¡ã€‚å½“ç„¶ï¼Œè¿™ä¸æ˜¯æ‚¨æƒ³è¦çš„ï¼Œå› ä¸ºæ‚¨åªæƒ³æ„å»ºä¸€ä¸ªæœåŠ¡ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬é¦–å…ˆå¿½ç•¥æ‰€æœ‰å†…å®¹ï¼Œç„¶åå°†å®é™…çš„æœåŠ¡æºä»£ç æ”¾å›å»ã€‚

## æ·»åŠ å‚æ•°

ç°åœ¨ä¸´æ—¶çš„`Dockerfile`å’Œ`.dockerignore`æ–‡ä»¶å·²ç»åˆ›å»ºï¼Œæˆ‘ä»¬å¯ä»¥æä¾›`gcloud builds submit`å’Œ`docker build`å‘½ä»¤æœåŠ¡åä»¥åŠå®ƒä»¬åº”è¯¥ä½¿ç”¨çš„`Dockerfile`ã€‚

```
## Build via Cloud Build
gcloud builds submit --region europe-west2 \
            --config cloudbuild.yaml \
            --ignore-file $DOCKER_IGNORE_FILE \
            --substitutions _DOCKER_FILE=$DOCKER_FILE,_APP=$APP \
            .# Build via local Docker
docker build -t $APP -f $DOCKER_FILE --build-arg SRC_DIR=$APP .
```

æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°æ²¡æœ‰ä¸º`docker build`å‘½ä»¤å®šä¹‰ç‰¹å®šçš„`.dockerignore`æ–‡ä»¶ã€‚ä½†è¿™ä¸æ˜¯é—®é¢˜ã€‚å¾—ç›Šäº Docker v19.03 ç‰ˆæœ¬ï¼ŒDocker è¶³å¤Ÿèªæ˜ï¼Œå¯ä»¥æ ¹æ®æä¾›çš„`Dockerfile`çš„åç§°åŠ è½½è‡ªå®šä¹‰çš„`.dockerignore`æ–‡ä»¶:

> Docker å®¢æˆ·ç«¯é¦–å…ˆå°è¯•åŠ è½½`<dockerfile-name>.dockerignore`ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™é€€å›åˆ°`.dockerignore`ã€‚æ‰€ä»¥`docker build -f Dockerfile.foo .`é¦–å…ˆå°è¯•åŠ è½½`Dockerfile.foo.dockerignore`ã€‚

## è¿è¡Œ/æ„å»ºå®ƒ

ç°åœ¨æˆ‘ä»¬å®Œæˆäº†é…ç½®ï¼Œå¯ä»¥ä½¿ç”¨`build.sh`è„šæœ¬è¿è¡Œæ„å»ºï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
./build.sh -a kaniko-demo
```

![](img/e56f77b6c6e2307cdc37cbc099f34f7f.png)

ã€‚/build.sh -a kaniko-demo

## ä½ æƒ³è”ç³»å—ï¼Ÿ

å¦‚æœä½ æƒ³è”ç³»æˆ‘ï¼Œè¯·åœ¨ LinkedIn ä¸Šè”ç³»æˆ‘ã€‚

å¦å¤–ï¼Œå¯ä»¥éšæ„æŸ¥çœ‹[æˆ‘çš„ä¹¦ç±æ¨è](https://medium.com/@mr-pascal/my-book-recommendations-4b9f73bf961b)ğŸ“šã€‚

[](https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b) [## æˆ‘çš„ä¹¦ç±æ¨è

### åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°æˆ‘å¯¹æ‰€æœ‰æ—¥å¸¸ç”Ÿæ´»è¯é¢˜çš„ä¹¦ç±æ¨èï¼Œå®ƒä»¬å¯¹æˆ‘å¸®åŠ©å¾ˆå¤§ã€‚

mr-pascal.medium.com](https://mr-pascal.medium.com/my-book-recommendations-4b9f73bf961b) [](https://mr-pascal.medium.com/membership) [## é€šè¿‡æˆ‘çš„æ¨èé“¾æ¥åŠ å…¥ Mediumâ€”Pascal Zwikirsch

### ä½œä¸ºä¸€ä¸ªåª’ä½“ä¼šå‘˜ï¼Œä½ çš„ä¼šå‘˜è´¹çš„ä¸€éƒ¨åˆ†ä¼šç»™ä½ é˜…è¯»çš„ä½œå®¶ï¼Œä½ å¯ä»¥å®Œå…¨æ¥è§¦åˆ°æ¯ä¸€ä¸ªæ•…äº‹â€¦

mr-pascal.medium.com](https://mr-pascal.medium.com/membership)