<html>
<head>
<title>PostgreSQL — Monitor Continuous Archiving and Point-in-Time Recovery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PostgreSQL —监控连续归档和时间点恢复</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/postgresql-monitor-continuous-archiving-and-point-in-time-recovery-c08ec0dd9f6c?source=collection_archive---------17-----------------------#2022-12-26">https://levelup.gitconnected.com/postgresql-monitor-continuous-archiving-and-point-in-time-recovery-c08ec0dd9f6c?source=collection_archive---------17-----------------------#2022-12-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="0110" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://medium.com/@anasanjaria/list/psql-continuous-archiving-and-pointintime-recovery-db6aad0e417a" rel="noopener">连续归档和时间点恢复</a></h2><div class=""/><p id="f971" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">欢迎使用我的<a class="ae ku" href="https://medium.com/@anasanjaria/list/psql-continuous-archiving-and-pointintime-recovery-db6aad0e417a" rel="noopener">连续归档和时间点恢复</a>系列。</p><p id="bac4" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">到目前为止，我们已经介绍了理解归档机制所需的<a class="ae ku" href="https://medium.com/@anasanjaria/postgres-backup-management-using-spilo-20a66befb88a" rel="noopener">基本概念</a>，在AWS S3中存储备份的<a class="ae ku" href="https://medium.com/@anasanjaria/store-postgresql-backup-in-aws-s3-using-spilo-942d05567bc3" rel="noopener">配置设置</a>，以及如何使用AWS云中存储的备份<a class="ae ku" href="https://medium.com/@anasanjaria/postgresql-restore-a-node-from-backups-stored-in-aws-cloud-c0f9b1cc0fce" rel="noopener">恢复独立节点</a>。</p><p id="3f43" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">这篇文章的重点是在将连续归档推广到我们的生产系统后对其进行监控，以确保稳定性和可靠性。</p><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi kv"><img src="../Images/0659b3fa0b614f7fcfef7ac8546eeb51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cl3f7ltnjD0VHjziVjULCw.jpeg"/></div></div><figcaption class="lh li gj gh gi lj lk bd b be z dk translated">推出新功能的开发周期</figcaption></figure></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><p id="6861" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">如果我们观察归档流程和运行该流程的系统(或实例),我们可以确保备份管理的稳定性和可靠性。</p><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi ca"><img src="../Images/6eef12dab798099781eb79bc35993120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IE5FIi4NRZ7iIGYk6siJzw.png"/></div></div><figcaption class="lh li gj gh gi lj lk bd b be z dk translated">监控连续归档和时间点恢复的基本指标</figcaption></figure><h1 id="84d3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">监控归档过程</h1><p id="ea59" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">为了确保我们的归档流程完美运行，我们可以观察:</p><ul class=""><li id="ce1c" class="mv mw iq jy b jz ka kd ke kh mx kl my kp mz kt na nb nc nd bi translated">存档状态(是否无法将备份存储到AWS云)。</li><li id="a240" class="mv mw iq jy b jz ne kd nf kh ng kl nh kp ni kt na nb nc nd bi translated">存档完成(是否定期成功存储备份)。</li></ul><p id="f0fb" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">我们使用以下步骤来收集这些基本指标。这里的想法是使用<code class="fe nj nk nl nm b">log-as-metrics</code>。</p><ol class=""><li id="b60c" class="mv mw iq jy b jz ka kd ke kh mx kl my kp mz kt nn nb nc nd bi translated">将度量转储到日志文件中。</li><li id="4927" class="mv mw iq jy b jz ne kd nf kh ng kl nh kp ni kt nn nb nc nd bi translated">使用<a class="ae ku" href="https://www.elastic.co/beats/filebeat" rel="noopener ugc nofollow" target="_blank"> filebeat </a>将这些指标发送给弹性搜索。</li><li id="065e" class="mv mw iq jy b jz ne kd nf kh ng kl nh kp ni kt nn nb nc nd bi translated">使用<a class="ae ku" href="https://www.elastic.co/kibana/" rel="noopener ugc nofollow" target="_blank"> kibana </a>可视化信息。</li><li id="9df3" class="mv mw iq jy b jz ne kd nf kh ng kl nh kp ni kt nn nb nc nd bi translated">最后，在失败的情况下通过slack通知我们的团队。</li></ol><pre class="kw kx ky kz gt no nm np bn nq nr bi"><span id="ee45" class="ns lt iq nm b be nt nu l nv nw">I have explained this approach in more details in my following articles:<br/><br/>- <a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/monitor-ansible-playbook-executions-bf92ce16d100">Monitor Ansible Playbook Executions</a><br/>- <a class="ae ku" href="https://medium.com/@anasanjaria/monitor-postgres-performance-using-custom-queries-1c06a766969b" rel="noopener">Monitor Postgres Performance Using Custom Queries</a></span></pre><h2 id="a758" class="nx lt iq bd lu ny nz dn ly oa ob dp mc kh oc od mg kl oe of mk kp og oh mo iw bi translated">监控存档状态</h2><p id="b481" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">我们可以使用下面的SQL查询来监控归档。</p><pre class="kw kx ky kz gt no nm np bn nq nr bi"><span id="4515" class="ns lt iq nm b be nt nu l oi nw">select * from pg_stat_archiver;</span></pre><p id="6d8c" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">您可以查看我关于使用定制查询监控Postgres性能的文章。</p><h2 id="0357" class="nx lt iq bd lu ny nz dn ly oa ob dp mc kh oc od mg kl oe of mk kp og oh mo iw bi translated">监控存档完成情况</h2><p id="1be5" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">由于我们使用了<code class="fe nj nk nl nm b">wal-g</code>，因此，我们可以使用以下命令列出所有备份(成功存储在AWS S3中)来监控归档过程。</p><p id="7ecd" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">根据时间戳，我们可以确定最近24小时内是否有备份。</p><pre class="kw kx ky kz gt no nm np bn nq nr bi"><span id="06ed" class="ns lt iq nm b be nt nu l oi nw">wal-g backup-list --json</span></pre><p id="b708" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">更准确地说，我们将使用以下命令列出AWS S3的备份，将它们转储到一个日志文件中，并将其用作指标。</p><pre class="kw kx ky kz gt no nm np bn nq nr bi"><span id="fccb" class="ns lt iq nm b be nt nu l oi nw">#!/bin/bash<br/><br/>docker run --rm --name monitor-completed-backup \<br/>  --env AWS_REGION='...' \<br/>  --env AWS_ENDPOINT='...' \<br/>  --env WAL_S3_BUCKET='...' \<br/>  --env WALE_S3_PREFIX='...' \<br/>  --env WALE_S3_ENDPOINT='...' \<br/>  registry.opensource.zalan.do/acid/spilo-14:2.1-p7 \<br/>  wal-g backup-list --json | jq -c '.[]' \<br/>  &gt;&gt; /path/to/metrics.log</span></pre><p id="8d8d" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">请注意，我们使用<a class="ae ku" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank"> jq </a>来操作JSON。</p><h1 id="32a9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">监控系统指标</h1><p id="75ec" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">我们可以使用<a class="ae ku" href="https://www.elastic.co/beats/metricbeat" rel="noopener ugc nofollow" target="_blank"> metricbeat </a>的<code class="fe nj nk nl nm b">system</code>模块来监控我们的系统。配置如下所示:</p><pre class="kw kx ky kz gt no nm np bn nq nr bi"><span id="3f03" class="ns lt iq nm b be nt nu l oi nw">metricbeat.modules:<br/># https://www.elastic.co/guide/en/beats/metricbeat/current/metricbeat-metricset-system-cpu.html<br/>- module: system<br/>  period: 1m<br/>  metricsets:<br/>    - cpu<br/>    - memory<br/>  process.include_top_n:<br/>    by_cpu: 5      # include top 5 processes by CPU<br/>    by_memory: 5   # include top 5 processes by memory<br/><br/># https://www.elastic.co/guide/en/beats/metricbeat/current/metricbeat-metricset-system-filesystem.html<br/>- module: system<br/>    period: 30s<br/>    metricsets: ["filesystem"]<br/>    processors:<br/>    - drop_event.when.regexp:<br/>        system.filesystem.mount_point: '^/(sys|cgroup|proc|dev|etc|host)($|/)'</span></pre><p id="83e6" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><code class="fe nj nk nl nm b">system.filesystem.used.pct</code>-已用磁盘空间的百分比。</p><p id="3b8f" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><code class="fe nj nk nl nm b">system.memory.actual.used.pct</code> —实际使用的内存百分比。</p><p id="94cf" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><code class="fe nj nk nl nm b">system.cpu.total.pct</code> —处于非空闲和低等待状态的CPU时间百分比。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><p id="05ab" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">感谢阅读。</p><p id="90a3" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">如果你有任何问题，请随时在评论区提问。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><p id="4354" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">如果你喜欢这篇文章，你可能也会喜欢我的网站可靠性工程系列。</p><div class="oj ok gp gr ol"><div role="button" tabindex="0" class="ab bv gv cb fp om on bn oo lf ex"><div class="op l"><div class="ab q"><div class="l di"><img alt="Anas Anjaria" class="l de bw oq or fe" src="../Images/89827307249a30f11a5732a9890e912d.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*uUIPYdjxGW5QbiWgjkhyDg.jpeg"/><div class="fb bw l oq or fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@anasanjaria?source=post_page-----c08ec0dd9f6c--------------------------------" rel="noopener follow" target="_top">阿纳斯·安贾里亚</a></p></div></div><div class="ou ov gw l"><h2 class="bd ja ub mv fp uc fr fs ud fu fw iz bi translated">现场可靠性工程</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi ue au uf ug uh qr ui an eh ei uj uk ul el em eo de bk ep" href="https://medium.com/@anasanjaria/list/site-reliability-engineering-fd4dc0eabf12?source=post_page-----c08ec0dd9f6c--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="um l fo"><span class="bd b dl z dk">6 stories</span></div></div></div><div class="ph dh pi fp ab pj fo di"><div class="di oz bv pa pb"><div class="dh l"><img alt="Essential metrics to monitor continuous archiving &amp; point-in-time recovery" class="dh" src="../Images/218297210fc211ae26c0d6cc69260bb0.png" width="194" height="194" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*IE5FIi4NRZ7iIGYk6siJzw.png"/></div></div><div class="di oz bv pc pd pe"><div class="dh l"><img alt="Monitor Your System — Practical Guide. Site reliability engineering" class="dh" src="../Images/3d271359e6086a41f80bff2b638af676.png" width="194" height="194" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*SOX9hjN4XpoQA8co"/></div></div><div class="di bv pf pg pe"><div class="dh l"><img alt="High level overview of collecting Postgres metrics using custom query" class="dh" src="../Images/d643efa963dab995deed8d0125948586.png" width="194" height="194" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*wGBWHb2-SVt6p9m_GF4XTg.png"/></div></div></div></div></div></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><pre class="kw kx ky kz gt no nm np bn nq nr bi"><span id="a9ce" class="ns lt iq nm b be nt nu l nv nw"><strong class="nm ja">Want to connect?</strong><br/><br/><a class="ae ku" href="https://www.facebook.com/anas.anjaria.kh" rel="noopener ugc nofollow" target="_blank">Facebook</a> | <a class="ae ku" href="https://www.linkedin.com/in/anasanjaria/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a> | <a class="ae ku" href="https://twitter.com/anasanjaria" rel="noopener ugc nofollow" target="_blank">Twitter</a></span></pre></div></div>    
</body>
</html>