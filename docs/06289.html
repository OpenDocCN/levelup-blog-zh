<html>
<head>
<title>How to Handle Handset Input (DTMF) From a Phone Call in ASP.NET Core</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在ASP.NET核心网处理来自电话的手机输入(DTMF)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-handle-handset-input-dtmf-from-a-phone-call-in-asp-net-core-417f7a8554e0?source=collection_archive---------6-----------------------#2020-11-11">https://levelup.gitconnected.com/how-to-handle-handset-input-dtmf-from-a-phone-call-in-asp-net-core-417f7a8554e0?source=collection_archive---------6-----------------------#2020-11-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d3745cd09c7da841bfa23f7e040ca715.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y-SLzzT9wmjWkAIe8ICr0A.png"/></div></div></figure><p id="9950" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">任何交互式语音应答(IVR)系统的基本构件都是处理输入。通常有两种类型的输入可以通过编程从公共交换电话网(PSTN)获取，这两种类型都受Vonage支持:</p><ol class=""><li id="530c" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae lf" href="https://developer.nexmo.com/voice/voice-api/guides/dtmf" rel="noopener ugc nofollow" target="_blank">双音多频(DTMF)</a>——这些是从用户手机上收集的输入事件。例如，“销售按1，客户服务按2”</li><li id="a9ea" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://developer.nexmo.com/voice/voice-api/guides/asr" rel="noopener ugc nofollow" target="_blank">自动语音识别(ASR)</a>-这些是语音识别事件，输入是用户的声音。</li></ol><p id="f68f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本教程中，我们将使用<a class="ae lf" href="https://developer.nexmo.com/voice/voice-api/overview" rel="noopener ugc nofollow" target="_blank"> Vonage语音API </a>来学习如何快速将前者(DTMF)整合到我们的ASP.NET核心应用中。通过PSTN呼叫从用户处收集DTMF将涉及以下内容:</p><ol class=""><li id="36aa" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">如果你还没有Vonage API账户的话，建立一个</li><li id="e0e5" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">使用<a class="ae lf" href="https://github.com/Nexmo/nexmo-cli" rel="noopener ugc nofollow" target="_blank"> CLI </a>创建Vonage应用程序</li><li id="374b" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">写点C#代码。</li><li id="c124" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">将我们的应用程序连接到网络。</li></ol><h1 id="7e28" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">直接跳到代码</h1><p id="6db7" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">如果你想跳过本教程并引入一个工作示例，你可以在<a class="ae lf" href="https://github.com/nexmo-community/dtmf-dotnet" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中找到这个示例。</p><h1 id="07bb" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">先决条件</h1><ul class=""><li id="390e" class="kw kx iq ka b kb mj kf mk kj mo kn mp kr mq kv mr lc ld le bi translated">nexmo CLI。如果没有，可以用<code class="fe ms mt mu mv b">npm install nexmo-cli -g</code>安装</li><li id="8cb8" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv mr lc ld le bi translated">最新<a class="ae lf" href="https://dotnet.microsoft.com/download" rel="noopener ugc nofollow" target="_blank">。NET Core SDK </a></li><li id="1613" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv mr lc ld le bi translated">Visual Studio或Visual Studio代码。我将使用Visual Studio 2019</li><li id="d206" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv mr lc ld le bi translated">用于测试的ngrok 。你只需要自由层。</li></ul><h1 id="92ea" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Vonage API帐户</h1><p id="aeb2" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">要完成本教程，您需要一个<a class="ae lf" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2020-10-20-how-to-handle-handset-input-dtmf-from-a-phone-call-in-asp-net-core" rel="noopener ugc nofollow" target="_blank"> Vonage API帐户</a>。如果你还没有，你可以今天<a class="ae lf" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2020-10-20-how-to-handle-handset-input-dtmf-from-a-phone-call-in-asp-net-core" rel="noopener ugc nofollow" target="_blank">注册</a>并开始用免费信用点数进行构建。一旦你有了一个帐户，你可以在<a class="ae lf" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2020-10-20-how-to-handle-handset-input-dtmf-from-a-phone-call-in-asp-net-core" rel="noopener ugc nofollow" target="_blank"> Vonage API仪表板</a>的顶部找到你的API密钥和API秘密</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/05f5ab8d35736729caeffdb738cb2982.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MO2GDjJkEik7Rttj"/></div></div></figure><h1 id="77fa" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">旋转ngrok</h1><p id="1ec1" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们将使用ngrok向互联网公开我们本地运行的ASP.NET核心应用程序。在你安装了ngrok之后，这样做就像在你的控制台中运行命令<code class="fe ms mt mu mv b">ngrok http 5000</code>一样简单。会产生类似这样的东西:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/48d538ba82af5edd0ee26ba964388ecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OA3xijAz4K-ZlAUF"/></div></div></figure><blockquote class="nb nc nd"><p id="2ff9" class="jy jz ne ka b kb kc kd ke kf kg kh ki nf kk kl km ng ko kp kq nh ks kt ku kv ij bi translated">注意:本教程使用<a class="ae lf" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-3.1" rel="noopener ugc nofollow" target="_blank"> Kestral </a>进行本地调试。如果你想使用IIS Express，请查看我们的<a class="ae lf" href="https://developer.nexmo.com/tools/ngrok#configure-iis-express-for-the-correct-port" rel="noopener ugc nofollow" target="_blank">解释器</a>关于在IIS Express中使用ngrok。</p></blockquote><p id="8382" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里需要注意的关键是转发URL——在我的例子中，这个URL是<code class="fe ms mt mu mv b">http://34332d9dca30.ngrok.io</code>。当你在Vonage号码上收到一个呼叫时，Vonage将向你的应用程序发送一个叫做WebHook的东西，这只是一个HTTP GET请求，要求一个叫做Nexmo呼叫控制对象(NCCO)的东西。我们的应用程序将监听<code class="fe ms mt mu mv b">/webhooks/answer</code>，所以我需要的整个URL将是<code class="fe ms mt mu mv b"><a class="ae lf" href="http://34332d9dca30.ngrok.io/webhooks/answer." rel="noopener ugc nofollow" target="_blank">http://34332d9dca30.ngrok.io/webhooks/answer</a></code> <a class="ae lf" href="http://34332d9dca30.ngrok.io/webhooks/answer." rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="fe42" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">设置CLI</h1><p id="cbb7" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">如果您还没有设置nexmo CLI，请通过运行命令<code class="fe ms mt mu mv b">nexmo setup API_KEY API_SECRET</code>来设置，其中API密钥和密码是在您的<a class="ae lf" href="https://dashboard.nexmo.com/settings" rel="noopener ugc nofollow" target="_blank">帐户的设置页面</a>上找到的API密钥和密码</p><h1 id="eb22" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">购买号码并创建应用程序</h1><p id="56f3" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">现在，您的CLI已设置好，我们将购买一个号码，创建一个Vonage应用程序，并将该号码链接到该应用程序，它将告诉Vonage转发到您的应用程序。</p><h2 id="5ca8" class="ni lm iq bd ln nj nk dn lr nl nm dp lv kj nn no lz kn np nq md kr nr ns mh nt bi translated">买一个号码</h2><p id="f088" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">要购买号码，请使用以下命令(用您的国家ID代替<code class="fe ms mt mu mv b">US</code>)</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="e515" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">键入<code class="fe ms mt mu mv b">confirm</code>完成操作；它将输出您购买的号码。</p><h2 id="a63e" class="ni lm iq bd ln nj nk dn lr nl nm dp lv kj nn no lz kn np nq md kr nr ns mh nt bi translated">创建应用程序</h2><p id="5d63" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">接下来，我们将创建一个应用程序。create application命令将接受两个URL，一个是应答URL——Vonage将向其发送来电的号码，另一个是事件URL，Vonage将向其发送由您的一个号码产生的事件。记住用你的ngrok URL的随机散列替换<code class="fe ms mt mu mv b">34332d9dca30</code>:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="a74a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此操作将使用应用程序ID和私钥进行响应。保存这两个值。在本教程中，我们将只使用应用程序ID，但是您使用私钥来授权您的应用程序请求。</p><h2 id="94f5" class="ni lm iq bd ln nj nk dn lr nl nm dp lv kj nn no lz kn np nq md kr nr ns mh nt bi translated">链接应用程序</h2><p id="a0b6" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">接下来，我们需要将新购买的号码链接到我们的应用程序。链接我们的号码将告诉Vonage将该号码上收到的任何呼叫发送到我们的应用程序的webhook URL。为此，我们需要刚刚从创建应用程序请求中收到的应用程序ID(看起来像<code class="fe ms mt mu mv b">e7a25242-77a1-42cd-a32e-09febcb375f4</code>)和我们刚刚购买的电话号码，我们将运行如下所示的命令:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h1 id="77a4" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">构建我们的应用</h1><p id="6c5c" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">现在剩下要做的就是构建我们的应用程序！</p><h2 id="3f37" class="ni lm iq bd ln nj nk dn lr nl nm dp lv kj nn no lz kn np nq md kr nr ns mh nt bi translated">创建应用程序</h2><p id="9d34" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在控制台中，导航到通常放置代码的目录。我们将创建一个ASP.NET核心应用程序<code class="fe ms mt mu mv b">Web API</code>。我们就不配置<code class="fe ms mt mu mv b">https</code>，这样更容易测试。您可以使用以下dotnet CLI命令轻松实现这一点:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h2 id="ab4b" class="ni lm iq bd ln nj nk dn lr nl nm dp lv kj nn no lz kn np nq md kr nr ns mh nt bi translated">安装Vonage SDK</h2><p id="d1c9" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">运行cd命令进入<code class="fe ms mt mu mv b">VonageDtmf</code>项目文件夹，并运行以下命令将<a class="ae lf" href="https://github.com/vonage/vonage-dotnet-sdk" rel="noopener ugc nofollow" target="_blank"> Vonage Server SDK </a>添加到您的项目中。</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h2 id="1296" class="ni lm iq bd ln nj nk dn lr nl nm dp lv kj nn no lz kn np nq md kr nr ns mh nt bi translated">创建语音控制器</h2><p id="14bf" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">导航到它创建的目录，并在您选择的IDE中打开csproj文件。在<code class="fe ms mt mu mv b">Controllers</code>文件夹中，添加一个名为<code class="fe ms mt mu mv b">VoiceController</code>的新的空API控制器。在<code class="fe ms mt mu mv b">VoiceController</code>中，除了ApiController样板文件之外，我们还将添加用于<code class="fe ms mt mu mv b">System.Threading.Tasks</code>、<code class="fe ms mt mu mv b">Vonage.Utility</code>、<code class="fe ms mt mu mv b">Vonage.Voice.EventWebhooks</code>和<code class="fe ms mt mu mv b">Vonage.Voice.Nccos</code>的语句。之后，控制器应该是这样的。</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h2 id="4f1a" class="ni lm iq bd ln nj nk dn lr nl nm dp lv kj nn no lz kn np nq md kr nr ns mh nt bi translated">处理回答</h2><p id="5cc3" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们现在将为<code class="fe ms mt mu mv b">/webhooks/answer</code>添加路线。这个路由将是一个GET请求，因为Vonage将从我们的服务器获得一个NCCO。这个方法将使用两个动作(调用的指令)构造一个NCCO。动作一将是一个讲话动作，它将告诉用户输入一个数字。那么第二个动作将是多输入动作。此操作将收集用户的输入。您可以指定是否通过此操作收集DTMF和/或语音输入。我们将通过向动作添加一个<code class="fe ms mt mu mv b">DtmfSettings</code>对象并将其最大位数设置为<code class="fe ms mt mu mv b">1</code>来选择DTMF。我们将把事件URL传递给它——这将是我们在<code class="fe ms mt mu mv b">/webhooks/dtmf</code>的服务器的基本URL(我们将很快定义这个路由。)最后，我们将这些动作转换成NCCO，并将来自该动作的JSON返回给Vonage。</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h2 id="52a1" class="ni lm iq bd ln nj nk dn lr nl nm dp lv kj nn no lz kn np nq md kr nr ns mh nt bi translated">处理DTMF输入</h2><p id="3208" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">当用户在手机上输入一个数字时，我们的应用程序将从Vonage接收另一个包含用户输入数字的webhook。我们将从请求中去掉<code class="fe ms mt mu mv b">MultiInput</code>结构。然后，我们将使用该结构中嵌入在<code class="fe ms mt mu mv b">Dtmf</code>对象中的数字来创建一个新的Talk动作，告诉用户输入的内容。</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h1 id="7411" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">测试应用程序</h1><p id="bea0" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">现在剩下要做的就是测试应用程序。要运行该应用程序，请使用以下命令:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><blockquote class="nb nc nd"><p id="32d7" class="jy jz ne ka b kb kc kd ke kf kg kh ki nf kk kl km ng ko kp kq nh ks kt ku kv ij bi translated">注意:如果您选择使用IIS Express，请务必阅读我们关于使用ngrok的IIS Express的文章<a class="ae lf" href="https://developer.nexmo.com/tools/ngrok#usage-with-iis-express" rel="noopener ugc nofollow" target="_blank">。确保在您的回答方法中使用x-original-host来形成主机名，而不是请求主机。</a></p></blockquote><p id="88a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们的应用程序正在运行，您可以拨入您的Vonage号码，瞧！您可以接收用户的DTMF输入。</p><h1 id="e791" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">下一步是什么？</h1><p id="2e20" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">能够管理来自用户的DTMF输入并通过PSTN线路对其作出响应，使您能够与语音建立各种强大的集成。查看我们的<a class="ae lf" href="https://developer.nexmo.com/use-cases/interactive-voice-response" rel="noopener ugc nofollow" target="_blank">交互式语音应答(IVR)指南</a>。</p><p id="65b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你也可以看看我谈到的其他一些很酷的语音集成。净，包括:</p></div><div class="ab cl nw nx hu ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="ij ik il im in"><p id="f5ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ne">最初发布于</em><a class="ae lf" href="https://www.nexmo.com/blog/2020/10/20/how-to-handle-handset-input-dtmf-from-a-phone-call-in-asp-net-core" rel="noopener ugc nofollow" target="_blank"><em class="ne">https://www . NEX mo . com/blog/2020/10/20/how-to-handle-handset-input-DTMF-from-a-phone-call-in-ASP-net-core</em></a></p></div></div>    
</body>
</html>