<html>
<head>
<title>Advanced Postgres Connection Pooling Using PgBouncer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用PgBouncer的高级Postgres连接池</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/advanced-postgres-connection-pooling-using-pgbouncer-ebb814f3f8c7?source=collection_archive---------21-----------------------#2020-06-18">https://levelup.gitconnected.com/advanced-postgres-connection-pooling-using-pgbouncer-ebb814f3f8c7?source=collection_archive---------21-----------------------#2020-06-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/575e9c00f39be16c89ae96d691bc7b47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fbo4PN4nxX--Y6rUdlXU6g.png"/></div></div></figure><h1 id="a8e3" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">使用PgBouncer扩展Django/Postgres</h1><p id="4a2c" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">有没有使用Postgres的app？数据库连接快用完了吗？也许你已经尝试过设置<a class="ae lx" href="https://docs.djangoproject.com/en/3.0/ref/settings/#conn-max-age" rel="noopener ugc nofollow" target="_blank"> CONN_MAX_AGE </a>，但那只帮了一会儿。是时候推出P <a class="ae lx" href="https://www.pgbouncer.org/" rel="noopener ugc nofollow" target="_blank"> gBouncer </a>，Postgres连接池事实上的标准了。</p><p id="424e" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">在本文中，我们将了解如何使用PgBouncer来扩展您的应用程序。我们将使用Django(一个流行的Python web框架)作为设置的例子，使用<a class="ae lx" href="https://www.heroku.com" rel="noopener ugc nofollow" target="_blank"> Heroku </a>作为部署平台。然而，PgBouncer的安装步骤和概念应该适用于Heroku上的任何应用程序。</p><h1 id="8dd0" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">你将学到什么</h1><p id="894a" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">虽然设置PgBouncer很简单，但是为您的特定用例找到正确的设置可能是一个挑战。对于PgBouncer配置，没有一种通用的解决方案。</p><p id="a885" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">本文将向您展示:</p><ul class=""><li id="1877" class="me mf it lb b lc lz lg ma lk mg lo mh ls mi lw mj mk ml mm bi translated">如何选择PgBouncer池模式和部署类型</li><li id="9747" class="me mf it lb b lc mn lg mo lk mp lo mq ls mr lw mj mk ml mm bi translated">如何通过将<a class="ae lx" href="https://github.com/heroku/heroku-buildpack-pgbouncer" rel="noopener ugc nofollow" target="_blank"> pgbouncer buildpack </a>添加到您现有的Django应用程序来在Heroku上安装PgBouncer</li><li id="48ed" class="me mf it lb b lc mn lg mo lk mp lo mq ls mr lw mj mk ml mm bi translated">如何监控PgBouncer运行时统计数据以帮助微调您的设置</li><li id="1a37" class="me mf it lb b lc mn lg mo lk mp lo mq ls mr lw mj mk ml mm bi translated">常见错误和注意事项</li></ul><p id="30d9" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">你可以在GitHub的https://github.com/steuke/heroku-pgbouncer-django-demo<a class="ae lx" href="https://github.com/steuke/heroku-pgbouncer-django-demo" rel="noopener ugc nofollow" target="_blank">找到一个示例项目。</a></p><p id="9786" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">注意:要使用本指南，您的应用程序必须使用DATABASE_URL环境变量来配置其数据库连接。这很重要。如果手动配置数据库，首先需要切换到使用DATABASE_URL。对于Django，看一看<a class="ae lx" href="https://github.com/jacobian/dj-database-url" rel="noopener ugc nofollow" target="_blank"> dj-database-url </a>和示例项目，这会使这变得非常容易。您可以查看示例项目<a class="ae lx" href="https://github.com/steuke/heroku-pgbouncer-django-demo/blob/7d20aff9b051995a8f1f8b07083512e695b59df7/pgbouncer_client_demo/settings.py#L10-L11" rel="noopener ugc nofollow" target="_blank">来更好地理解这是如何实现的。</a></p><h1 id="43c9" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">开始之前需要考虑什么</h1><h2 id="9ed4" class="ms kc it bd kd mt mu dn kh mv mw dp kl lk mx my kp lo mz na kt ls nb nc kx nd bi translated">选择正确的PgBouncer部署类型</h2><p id="2ed0" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">PgBouncer可以用不同的方式部署。Heroku支持服务器端和客户端部署。Heroku上的服务器端实现仍处于测试阶段，在配置选项上有些限制，并且只支持事务模式(见下一节)。因此，本指南使用客户端方法，将PgBouncer部署在与Django应用程序相同的dyno上，并为您提供对每个设置的更多控制。</p><p id="40a0" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">如果您不确定使用哪种部署类型，Heroku官方文档将帮助您决定客户端部署是否适合您。</p><h2 id="03eb" class="ms kc it bd kd mt mu dn kh mv mw dp kl lk mx my kp lo mz na kt ls nb nc kx nd bi translated">选择正确的PgBouncer池模式和Django设置</h2><p id="9826" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">PgBouncer有<a class="ae lx" href="http://www.pgbouncer.org/features.html" rel="noopener ugc nofollow" target="_blank">三种类型的连接池模式</a>，这里从最礼貌到最积极的连接共享列出:会话、事务和语句模式。</p><p id="4cf3" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">在考虑使用Django应用程序的不同池模式时，您需要了解以下内容:</p><ul class=""><li id="ee47" class="me mf it lb b lc lz lg ma lk mg lo mh ls mi lw mj mk ml mm bi translated"><strong class="lb iu"> Session-mode </strong>(只有当用户会话关闭时连接才返回到池中)<strong class="lb iu"> : </strong>这种模式是最保守的。如果你使用这种模式，你不需要改变你的Django应用程序中的任何东西。如果其他模式不适用于您的应用程序，此模式可能会修复问题。该模式支持所有Postgres特性。</li><li id="a18f" class="me mf it lb b lc mn lg mo lk mp lo mq ls mr lw mj mk ml mm bi translated"><strong class="lb iu">事务模式</strong>(事务一完成，连接就返回到池中)<strong class="lb iu"> : </strong>这是Heroku PgBouncer buildpack的默认模式。此模式要求您禁用服务器端游标的使用。在Django中，通过设置<a class="ae lx" href="https://docs.djangoproject.com/en/3.0/ref/settings/#disable-server-side-cursors" rel="noopener ugc nofollow" target="_blank">DISABLE _ SERVER _ SIDE _ CURSORS = True</a>来禁用它们。这种模式应该适用于大多数应用程序，但请注意，一些重要的Postgres功能，如预准备语句、监听/通知、<a class="ae lx" href="http://www.pgbouncer.org/features.html" rel="noopener ugc nofollow" target="_blank">和其他、</a>不受支持。如果你使用这些特性中的任何一个(或者你依赖于一个使用这些特性的库)，你将冒着破坏你的应用程序或者降低一些查询性能的风险。</li><li id="ce5d" class="me mf it lb b lc mn lg mo lk mp lo mq ls mr lw mj mk ml mm bi translated"><strong class="lb iu">语句模式</strong>(语句一执行连接就返回池)<strong class="lb iu"> : </strong>这甚至比事务模式更激进。在这种模式下，不能使用多语句事务。多状态事务将导致错误(“服务器意外关闭了连接”)。如果您在某些用例中需要此模式，请考虑设置多个具有不同设置的PgBouncer池。</li></ul><p id="4f1d" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">作为最佳实践，从使用事务模式开始，并验证您的应用程序仍然工作。之后，可以随意试验其他模式及其对性能和资源使用的影响。例如，如果您的应用程序使用了不支持的功能，导致您遇到错误，请尝试切换到会话模式。如果你没有遇到错误，并且你想进一步提高应用程序的性能，你可以尝试使用语句模式。更多细节可在Heroku文档中找到。</p><h1 id="0844" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">使用构建包在Heroku上安装PgBouncer</h1><p id="7f2b" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated"><em class="ly">给你一个建议:使用一个试运行环境来遵循这个指南。只有在试运行环境中测试您的应用程序后，才能将此更改推广到生产环境中。在解决问题之前，不正确的步骤可能会阻止您的应用程序运行。(已经警告过你了！)</em></p><p id="3e80" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">好了，我们开始吧。按照以下五个步骤将PgBouncer添加到您的应用程序中(在本文中，我们将使用<a class="ae lx" href="https://devcenter.heroku.com/articles/heroku-cli" rel="noopener ugc nofollow" target="_blank"> Heroku CLI </a>命令):</p><h2 id="f2bf" class="ms kc it bd kd mt mu dn kh mv mw dp kl lk mx my kp lo mz na kt ls nb nc kx nd bi translated">1.禁止使用服务器端游标</h2><p id="844f" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">在Django应用程序中，只需将<a class="ae lx" href="https://github.com/steuke/heroku-pgbouncer-django-demo/blob/01de2fd2af0d4933cabed782066d0d2790bd3e1d/pgbouncer_client_demo/settings.py#L13" rel="noopener ugc nofollow" target="_blank">这一行</a>添加到您的settings.py:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="5840" class="ms kc it nj b gy nn no l np nq"><em class="ly">DISABLE_SERVER_SIDE_CURSORS = True # required when using pgbouncer’s pool_mode=transaction</em></span></pre><h2 id="3d08" class="ms kc it bd kd mt mu dn kh mv mw dp kl lk mx my kp lo mz na kt ls nb nc kx nd bi translated">2.添加PgBouncer构建包</h2><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="909a" class="ms kc it nj b gy nn no l np nq"><em class="ly">heroku buildpacks:add heroku/pgbouncer</em></span></pre><h2 id="a7c6" class="ms kc it bd kd mt mu dn kh mv mw dp kl lk mx my kp lo mz na kt ls nb nc kx nd bi translated">3.添加python构建包</h2><p id="3450" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">在某些情况下，您必须手动添加python buildpack(或您正在使用的语言的buildpack)。既然这么做没有坏处，那就这么做吧:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="94a7" class="ms kc it nj b gy nn no l np nq"><em class="ly">heroku buildpacks:add heroku/python</em></span></pre><h2 id="4e48" class="ms kc it bd kd mt mu dn kh mv mw dp kl lk mx my kp lo mz na kt ls nb nc kx nd bi translated">4.更改您的Procfile，以便在启动时启动PgBouncer</h2><p id="9eda" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">如果您使用的是python/Django，那么在此更改之前，您的Procfile将如下所示:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="633f" class="ms kc it nj b gy nn no l np nq"><em class="ly">web: gunicorn your_django_project.wsgi</em></span></pre><p id="9c17" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">改成这样的<a class="ae lx" href="https://github.com/steuke/heroku-pgbouncer-django-demo/blob/01de2fd2af0d4933cabed782066d0d2790bd3e1d/Procfile#L1" rel="noopener ugc nofollow" target="_blank"/>:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="8c59" class="ms kc it nj b gy nn no l np nq"><em class="ly">web: bin/start-pgbouncer gunicorn your_django_project.wsgi</em></span></pre><p id="9ea0" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">这一更改将把您原来的启动命令传递给bin/start-pgbouncer脚本。该脚本是PgBouncer buildpack的一部分。其主要目的是将<code class="fe nr ns nt nj b">DATABASE_URL</code>环境变量改为指向本地PgBouncer连接池，而不是原来的Postgres数据库。</p><p id="132f" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">这就是Django应用程序必须使用DATABASE_URL环境变量来配置数据库连接的原因。如果您不使用DATABASE_URL，您的应用程序仍将工作，但它不会通过PgBouncer连接到您的Postgres。</p><h2 id="d1ea" class="ms kc it bd kd mt mu dn kh mv mw dp kl lk mx my kp lo mz na kt ls nb nc kx nd bi translated">5.提交更改并将其部署到Heroku</h2><p id="bf33" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">使用您最喜欢的git客户端提交更改，并将它们推送到Heroku。然后开始用<code class="fe nr ns nt nj b">h<em class="ly">eroku logs -t --source app | grep pgbouncer</em></code>查看日志，同时在你的应用上运行测试。您应该会看到一系列类似如下的日志条目:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="9f35" class="ms kc it nj b gy nn no l np nq"><em class="ly">2020–04–30T18:59:48.918478+00:00 app[web.1]: 2020–04–30 18:59:48.918 53 LOG C-0x56211ba01900: pgbouncer/pgbouncer@unix(63):6000 login attempt: db=pgbouncer user=pgbouncer tls=no</em></span><span id="6d7e" class="ms kc it nj b gy nu no l np nq"><em class="ly">2020–04–30T18:59:48.919044+00:00 app[web.1]: 2020–04–30 18:59:48.919 53 LOG C-0x56211ba01900: pgbouncer/pgbouncer@unix(63):6000 closing because: client close request (age=0)</em></span></pre><p id="6ce9" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">恭喜你！这表明您的应用程序已成功配置并使用PgBouncer连接到Postgres。</p><h2 id="aa20" class="ms kc it bd kd mt mu dn kh mv mw dp kl lk mx my kp lo mz na kt ls nb nc kx nd bi translated">你刚刚实现了什么？</h2><p id="1045" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">您的web dyno现在正在运行一个PgBouncer实例，它为您的Django应用程序(运行在同一个dyno上)提供一个连接池。您的Django应用程序正在连接到这个本地PgBouncer连接池，而不是直接连接到Postgres数据库。</p><p id="d969" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">在下一节中，您将学习如何监视PgBouncer。</p><h1 id="c40a" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">监控PgBouncer</h1><p id="846a" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">有几种方法可以监控PgBouncer。一种常见的方法是<a class="ae lx" href="https://devcenter.heroku.com/articles/postgres-connection-pooling#viewing-connection-pool-stats" rel="noopener ugc nofollow" target="_blank">使用psql </a>连接到PgBouncer管理控制台。本节演示了另外两种方法:使用Heroku日志和从Django应用程序中查询统计数据。</p><h2 id="bec6" class="ms kc it bd kd mt mu dn kh mv mw dp kl lk mx my kp lo mz na kt ls nb nc kx nd bi translated">使用Heroku日志</h2><p id="12a0" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">PgBouncer buildpack配置为以一分钟为间隔记录PgBouncer统计信息。运行以下命令会显示最新的统计信息:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="06cb" class="ms kc it nj b gy nn no l np nq"><em class="ly">heroku logs — source app | grep “LOG Stats”</em></span></pre><p id="7b6a" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">输出如下所示:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="b901" class="ms kc it nj b gy nn no l np nq"><em class="ly">2020–04–30T19:11:25.720304+00:00 app[web.1]: 2020–04–30 19:11:25.720 54 LOG Stats: 5 xacts/s, 46 queries/s, in 5401 B/s, out 2756 B/s, xact 45640 us, query 992 us wait time 1396 us</em></span></pre><h2 id="5c90" class="ms kc it bd kd mt mu dn kh mv mw dp kl lk mx my kp lo mz na kt ls nb nc kx nd bi translated">使用SHOW STATS从Django应用程序查询PgBouncer数据库</h2><p id="3cc7" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">PgBouncer提供了一个包含其统计数据的虚拟数据库。这也被称为<a class="ae lx" href="http://www.pgbouncer.org/usage.html#admin-console" rel="noopener ugc nofollow" target="_blank">管理控制台</a>。PgBouncer buildpack通过名为/tmp的Unix套接字提供对这个虚拟数据库的访问，使用用户名“PgBouncer ”,没有密码。</p><p id="ce16" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">使用这些凭证，您可以通过使用低级别的psycopg2数据库API从Django应用程序中检索PgBouncer统计信息。下面是一个示例函数pgbouncer_stats()，它使用该API检索统计信息:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="9999" class="ms kc it nj b gy nn no l np nq"><em class="ly">def pgbouncer_stats() -&gt; List[Dict]:</em></span><span id="1ef8" class="ms kc it nj b gy nu no l np nq"><em class="ly">try:</em></span><span id="1703" class="ms kc it nj b gy nu no l np nq"><em class="ly">connection = psycopg2.connect(host=”/tmp/”, port=6000, dbname=”pgbouncer”, user=”pgbouncer”,</em></span><span id="1c14" class="ms kc it nj b gy nu no l np nq"><em class="ly">cursor_factory=extras.DictCursor)</em></span><span id="163f" class="ms kc it nj b gy nu no l np nq"><em class="ly">connection.autocommit = True # must enable autocommit when querying pgbouncer stats</em></span><span id="20d2" class="ms kc it nj b gy nu no l np nq"><em class="ly">cursor = connection.cursor()</em></span><span id="b022" class="ms kc it nj b gy nu no l np nq"><em class="ly">cursor.execute(‘SHOW STATS’)</em></span><span id="cdfc" class="ms kc it nj b gy nu no l np nq"><em class="ly">pgbouncer_stats = [dict(row) for row in cursor]</em></span><span id="c966" class="ms kc it nj b gy nu no l np nq"><em class="ly">return pgbouncer_stats</em></span><span id="b9e3" class="ms kc it nj b gy nu no l np nq"><em class="ly">except Exception as e:</em></span><span id="76e1" class="ms kc it nj b gy nu no l np nq"><em class="ly">return [{‘error’: True, ‘description’: ‘Could not query pgbouncer stats.’, ‘reason’: f’{e}’}]</em></span><span id="574e" class="ms kc it nj b gy nu no l np nq"><em class="ly">&lt;/code&gt;</em></span><span id="193e" class="ms kc it nj b gy nu no l np nq">The return value of pgbouncer_stats() is a list of dictionaries, with one dictionary for each database that PgBouncer is pooling:</span><span id="ef59" class="ms kc it nj b gy nu no l np nq"><em class="ly">&lt;code&gt;</em></span><span id="165c" class="ms kc it nj b gy nu no l np nq"><em class="ly">“pgbouncer_stats”:[</em></span><span id="973e" class="ms kc it nj b gy nu no l np nq"><em class="ly">{</em></span><span id="eaf5" class="ms kc it nj b gy nu no l np nq"><em class="ly">“database”:”db1",</em></span><span id="65c2" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_xact_count”:220,</em></span><span id="a7e8" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_query_count”:2750,</em></span><span id="b9c1" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_received”:330110,</em></span><span id="666d" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_sent”:168517,</em></span><span id="46ca" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_xact_time”:15062895,</em></span><span id="ce4d" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_query_time”:2837299,</em></span><span id="f85c" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_wait_time”:84837,</em></span><span id="efd1" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_xact_count”:2,</em></span><span id="62b3" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_query_count”:29,</em></span><span id="c9de" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_recv”:3519,</em></span><span id="bef7" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_sent”:1796,</em></span><span id="8bd6" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_xact_time”:68467,</em></span><span id="39a0" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_query_time”:1031,</em></span><span id="230b" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_wait_time”:904</em></span><span id="fde2" class="ms kc it nj b gy nu no l np nq"><em class="ly">},</em></span><span id="c7d1" class="ms kc it nj b gy nu no l np nq"><em class="ly">{</em></span><span id="f8a1" class="ms kc it nj b gy nu no l np nq"><em class="ly">“database”:”pgbouncer”,</em></span><span id="ec7d" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_xact_count”:110,</em></span><span id="b3cd" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_query_count”:110,</em></span><span id="a494" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_received”:0,</em></span><span id="ca6c" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_sent”:0,</em></span><span id="f2a7" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_xact_time”:0,</em></span><span id="78ea" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_query_time”:0,</em></span><span id="865b" class="ms kc it nj b gy nu no l np nq"><em class="ly">“total_wait_time”:0,</em></span><span id="6c32" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_xact_count”:1,</em></span><span id="e2aa" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_query_count”:1,</em></span><span id="0fb7" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_recv”:0,</em></span><span id="8c1b" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_sent”:0,</em></span><span id="f4ca" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_xact_time”:0,</em></span><span id="d026" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_query_time”:0,</em></span><span id="5607" class="ms kc it nj b gy nu no l np nq"><em class="ly">“avg_wait_time”:0</em></span><span id="58b3" class="ms kc it nj b gy nu no l np nq"><em class="ly">}</em></span><span id="e704" class="ms kc it nj b gy nu no l np nq"><em class="ly">]</em></span></pre><p id="2851" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">您可以看到“db1”数据库的total_xact_count为220。这表明总共处理了220笔交易。PgBouncer文档中有完整的统计列表及其含义。</p><h1 id="9861" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">常见错误和注意事项</h1><p id="2d3c" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">如何修复开始使用PgBouncer时的一些常见问题:</p><ul class=""><li id="6c2a" class="me mf it lb b lc lz lg ma lk mg lo mh ls mi lw mj mk ml mm bi translated">"致命错误:数据库' pgbouncer '不存在:"您正在连接的服务器似乎不是PgBouncer-server。有没有给PgBouncer加Heroku buildpack？您是否使用DATABASE_URL来配置您的连接？有没有把Procfile改成启动PgBouncer？</li><li id="d240" class="me mf it lb b lc mn lg mo lk mp lo mq ls mr lw mj mk ml mm bi translated">"错误:没有这样的用户:用户名。"如果您使用的是Heroku buildpack，这应该不会发生。确保您是以用户“pgbouncer”的身份通过Unix套接字连接的，没有密码。更多详情请参见<a class="ae lx" href="https://www.pgbouncer.org/config.html#authentication-file-format" rel="noopener ugc nofollow" target="_blank">pg bouncer-认证文档</a>。</li><li id="718d" class="me mf it lb b lc mn lg mo lk mp lo mq ls mr lw mj mk ml mm bi translated">您需要在Django的数据库选项中禁用SSL，即删除任何“SSL mode”:“require”。由于您使用的是客户端安装，流量不会离开您的机器，应该是安全的。或者，<a class="ae lx" href="https://www.pgbouncer.org/config.html" rel="noopener ugc nofollow" target="_blank">参见PgBouncer文档以启用TLS支持</a>。</li><li id="322d" class="me mf it lb b lc mn lg mo lk mp lo mq ls mr lw mj mk ml mm bi translated">如果连接到多个Postgres数据库，需要设置PGBOUNCER_URLS环境变量，让PGBOUNCER知道应该使用哪些环境变量进行连接池。例如，此命令告诉PgBouncer为DATABASE_URL和EVENT_DATABASE_URL创建连接池:heroku config:add PgBouncer _ URLS = " DATABASE _ URL EVENT _ DATABASE _ URL "</li><li id="84c5" class="me mf it lb b lc mn lg mo lk mp lo mq ls mr lw mj mk ml mm bi translated">如果您的请求需要访问包含许多行的大型表，当您必须禁用服务器端游标时，您的应用程序的性能会受到影响。一种解决方案是使用多个连接池。对于这些大型表请求，可以有一个处于会话模式的池，而对于其他请求，可以使用另一个处于事务模式的池。</li></ul><h1 id="75fd" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">后续步骤:监控、基准测试和微调PgBouncer</h1><p id="660b" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">此时，PgBouncer已经启动并运行在您的dyno上，为您的Django应用程序提供连接池。</p><p id="492f" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mb lm ln lo mc lq lr ls md lu lv lw im bi translated">你下一步应该做什么？</p><ul class=""><li id="f0af" class="me mf it lb b lc lz lg ma lk mg lo mh ls mi lw mj mk ml mm bi translated">确保你的应用性能稳定。监控PgBouncer统计数据，关注面向用户的统计数据，如avg_wait_time，它指示您的应用程序等待连接的时间。</li><li id="8b59" class="me mf it lb b lc mn lg mo lk mp lo mq ls mr lw mj mk ml mm bi translated">执行基准测试并试验PgBouncer设置以及池类型。一种方法是使用负载测试工具，让你的应用程序承受不断增加的负载。负荷增加的同时，看PgBouncer的maxwait-stat。如果这个数字越来越大，那么这个池处理客户端请求的速度就不够快。你可以尝试增加<a class="ae lx" href="https://github.com/heroku/heroku-buildpack-pgbouncer#tweak-settings" rel="noopener ugc nofollow" target="_blank"> PGBOUNCER_DEFAULT_POOL_SIZE，减少PGBOUNCER _ RESERVE _ POOL _ time out</a>或者尝试使用更激进的池模式。如果这些都没有帮助，可能是服务器资源不足，这可能意味着您需要升级Postgres服务器。</li><li id="a2c9" class="me mf it lb b lc mn lg mo lk mp lo mq ls mr lw mj mk ml mm bi translated">熟悉PgBouncer设置，如max_client_conn、default_pool_size和max_db_connections，以调整连接池。</li></ul><h1 id="3c4b" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">结论</h1><p id="d470" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">当数据库连接数成为问题时，PgBouncer是帮助扩展Postgres应用程序的合适工具。请记住，虽然将PgBouncer添加到您的设置中会给您和您的团队带来额外的复杂性，但花时间仔细设置、监控和调整您的配置应该会提高您的应用程序的性能。</p></div></div>    
</body>
</html>