<html>
<head>
<title>Next Django Version Will Have Better Test Cases Isolation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">下一个Django版本将会有更好的测试用例隔离</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/next-django-version-will-have-better-testcases-isolation-71959eb7b62c?source=collection_archive---------14-----------------------#2020-06-25">https://levelup.gitconnected.com/next-django-version-will-have-better-testcases-isolation-71959eb7b62c?source=collection_archive---------14-----------------------#2020-06-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/80820519c5061f29549c6a52df03f0c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Btn7PBsZ0QslijmOCNV2Ag.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@ripato?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">里卡多·戈麦斯·安吉尔</a>在<a class="ae kf" href="https://unsplash.com/photos/VnOs8OuCvVY" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="63e0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如您可能知道的，Django发布了它的TestCase类，带有事务的<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/using-transactions-to-make-django-tests-run-faster-224fdd695bfd">两级嵌套</a>:两个TestCase类彼此独立存在，TestCase中的单个测试也是如此。这个特性是很多年前在Django 1.8中引入的，但是它有一个问题:隔离只在数据库级执行。因此，有可能编写一个粗心的测试，错误地依赖于python级别的隔离:</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="li lj l"/></div></figure><p id="0395" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里，<code class="fe lk ll lm ln b">test1</code>“破坏”了python对象的状态，<code class="fe lk ll lm ln b">test2</code>足够智能来解决这个问题，<code class="fe lk ll lm ln b">test3</code>失败，因为回滚事务不会修改相应python对象的状态。</p><p id="cd07" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">解决这个问题的标准方法(如果简单地编写不依赖于python对象隔离的测试由于某种原因不可行)是</p><figure class="le lf lg lh gt ju"><div class="bz fp l di"><div class="li lj l"/></div></figure><p id="cd19" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这需要在每个测试函数的开始为每个涉及的模型进行额外的db查询，但在其他方面效果很好。</p><p id="22ce" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在即将到来的django版本中，不再需要这个黑客了！神奇的是在TestData类中自动发生的——不需要对项目进行任何更改，它深度复制相关对象并在必要时重置它们。该解决方案一直存在于第三方应用程序<a class="ae kf" href="https://github.com/charettes/django-testdata" rel="noopener ugc nofollow" target="_blank"> django-testdata </a>中，并随着错误报告获得了一些用户群。现在它已经足够成熟，可以进入django master(ticket<a class="ae kf" href="https://code.djangoproject.com/ticket/31395" rel="noopener ugc nofollow" target="_blank"># 31395</a>)了，你只要在git中切换django分支，就可以在开发机器上试一试了。</p></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><p id="c54c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[1]Lev Maximov(2020年6月22日)<em class="lv">使用事务使Django测试运行更快</em><a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/using-transactions-to-make-django-tests-run-faster-224fdd695bfd">https://level up . git connected . com/Using-Transactions-to-Make-Django-Tests-Run-Faster-224 FDD 695 bfd</a></p><p id="b245" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[2] Django 3.0文档。<em class="lv">测试工具/test case . setuptestdata()</em><a class="ae kf" href="https://docs.djangoproject.com/en/3.0/topics/testing/tools/#django.test.TestCase.setUpTestData" rel="noopener ugc nofollow" target="_blank">https://docs . django project . com/en/3.0/topics/Testing/tools/# django . test . test case . setuptestdata</a></p><p id="e494" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[3] Django第31395号机票。(2020年3月22日)<em class="lv">让TestCase.setUpTestData强制执行内存数据隔离。</em><a class="ae kf" href="https://code.djangoproject.com/ticket/31395" rel="noopener ugc nofollow" target="_blank">https://code.djangoproject.com/ticket/31395</a></p></div></div>    
</body>
</html>