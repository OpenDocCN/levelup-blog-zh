<html>
<head>
<title>Configuring Load Balancer(HAProxy) Dynamically With Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ansible动态配置负载平衡器(HAProxy)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/configuring-load-balancer-haproxy-dynamically-with-ansible-9de3923a67b4?source=collection_archive---------19-----------------------#2021-03-29">https://levelup.gitconnected.com/configuring-load-balancer-haproxy-dynamically-with-ansible-9de3923a67b4?source=collection_archive---------19-----------------------#2021-03-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8336" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">任务Part1 </strong>:使用Ansible playbook配置反向代理，即HAProxy，并在每次新的管理节点(配置有Apache Webserver)加入清单时自动更新其配置文件。</p><p id="42f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第2部分:</strong>在AWS上使用实例配置与第1部分相同的设置。</p><p id="ad9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么让我们来了解一下什么是HAProxy… <strong class="jp ir"> HAProxy </strong>是一个免费的、非常快速和可靠的解决方案，它为基于TCP和HTTP的应用程序提供了<a class="ae kl" href="http://en.wikipedia.org/wiki/High_availability" rel="noopener ugc nofollow" target="_blank">高可用性</a>、<a class="ae kl" href="http://en.wikipedia.org/wiki/Load_balancer" rel="noopener ugc nofollow" target="_blank">负载平衡</a>和代理。它特别适用于高流量的网站，并为世界上许多访问量最大的网站提供支持。我们特别要用它来实现后端Apache服务器之间的反向代理和负载平衡。</p><p id="adc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，在我们开始之前，我们必须首先了解如何集成Apache Webserver和HAProxy。如果你知道如何使用Apache Webserver，HAProxy只是另一个配置文件。HAProxy的典型配置文件如下所示:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/ac501f1c27af49582b0d93a7d96a1d7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/0*eeoBjgb9TARktdE2.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">haproxy.cfg示例片段</figcaption></figure><p id="434b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">片段中突出显示的部分是必须更改的部分。<code class="fe ky kz la lb b">bind</code>是告诉HAProxy必须绑定到哪个端口才能工作。<code class="fe ky kz la lb b">server</code>是我们必须告诉HAProxy我们的后端服务器在哪里工作的部分，也是HAProxy识别它们的名称，即<code class="fe ky kz la lb b">app1</code>和<code class="fe ky kz la lb b">app2.</code></p><p id="7cc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是每当调用一个新的后端时，手动配置将会非常非常乏味，因此我们需要<a class="ae kl" href="https://divya-kurothe.medium.com/automation-with-ansible-6661c61a3cee" rel="noopener"> Ansible </a>的自动化能力。因此，为了执行这个任务，我们必须编写一个<a class="ae kl" href="https://prithvirajsingh1604.medium.com/configuring-hadoop-with-ansible-how-to-write-a-play-book-24bd9a3648bc" rel="noopener">可理解的剧本</a>，这样我们就可以一次又一次地重复完整的任务，只需点击一个按钮或发出一个命令。</p><p id="2608" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们这里的剧本可以很容易地创建。那么，挑战是什么？有人可能会问，执行这样一项任务的挑战是，我们必须为我们添加的每<em class="lc"> n </em>个后端服务器添加<em class="lc"> n </em>个行。在开发环境中，web服务器的数量是可以管理的，但是当我们转向测试、生产前以及最终的生产环境时，web服务器的数量会变得太多，一个人无法单独管理。虽然我们可以雇用许多人来完成这项任务，但这在金钱和时间方面会非常昂贵，因为人类比计算机慢得多。因此，我们希望我们的计算机也能做到这一点，在计算机开始执行所需的工作后，无需任何人工干预。</p><p id="fa0d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，为了帮助我们管理数量不断变化的后端服务器，我们必须借助<strong class="jp ir">模板</strong>特别是<strong class="jp ir">Jinja 2……</strong>Jinja是一个快速、富于表现力、可扩展的模板引擎。模板中的特殊占位符允许编写类似Python语法的代码。但是怎么做呢？如前所述，特殊的占位符允许我们编写类似python的代码。Ansible预装了使用Jinja(Jinja2)模板将内容从一个地方(在控制器节点中)动态复制到另一个地方(在目标节点中)的功能。因此，我们可以简单地应用一个<code class="fe ky kz la lb b">for</code>循环，同时将我们的配置文件从模板复制到它的原始位置，这将是解决我们问题的最简单的方法…</p><p id="c239" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我们为此任务创建的行动手册:</p><pre class="kn ko kp kq gt ld lb le lf aw lg bi"><span id="6cee" class="lh li iq lb b gy lj lk l ll lm">- hosts: proxy<br/>  vars:<br/>    - s_port: 80<br/>  tasks:<br/><br/>    - name: installing HaProxy...<br/>      package:<br/>        name: haproxy<br/>        state: present<br/><br/>    - name: copying the configuration file...<br/>      template:<br/>        src: haproxy.j2<br/>        dest: /etc/haproxy/haproxy.cfg<br/>      notify: restarting haproxy... <br/><br/>    - name: starting the service...<br/>      service:<br/>        name: haproxy<br/>        state: started<br/>        enabled: yes<br/>      register: started<br/><br/>    - name: setting up facts...<br/>      set_fact:<br/>        condition_restart: "{{ started.changed==False }}"<br/><br/>  handlers:<br/>    - name: restarting haproxy...<br/>      service: <br/>        name: haproxy<br/>        state: restarted<br/>      when: condition_restart<br/><br/>- hosts: server<br/>  tasks:<br/>    - name: installing httpd...<br/>      package:<br/>        name: httpd<br/>        state: present<br/><br/>    - name: starting service...<br/>      service:<br/>        name: httpd<br/>        state: started<br/>        enabled: yes<br/><br/>    - name: copying content...<br/>      template:<br/>        src: index.j2<br/>        dest: /var/www/html/index.html</span></pre><p id="dd16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">剧本有两个剧本。第一个在主机<code class="fe ky kz la lb b">proxy</code>上运行，我们将在那里安装HAProxy，配置HAProxy，启动或重启HAProxy的服务。为了配置HAProxy，我们将使用模板模块，它将把Jinja2代码转换成可用的格式，然后将其复制到所需的位置。我们使用的模板如下所示:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi ln"><img src="../Images/183e7be6446dc79647eaa87588b8552d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/0*haRaSdFgnZqtzhoN.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">haproxy.j2片段</figcaption></figure><p id="e54b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ky kz la lb b">s_port </code>是一个变量，其值由剧本本身定义。第二部分是Jinja2 for循环，通过它我们将为我们在库存文件中添加的每个后端服务器打印<code class="fe ky kz la lb b">server app&lt;n&gt; &lt;IP&gt; check</code>。该任务的清单文件如下所示:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/e6a20088cb6f6ee5ea1469d58a99da87.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/0*OdVOk8O55LZyd37j.png"/></div></figure><p id="00ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其中<code class="fe ky kz la lb b">proxy</code>是HAProxy服务器组，而<code class="fe ky kz la lb b">server</code>是Apache服务器组，我们将使用它作为我们的后端服务器。</p><p id="4066" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二个脚本将<code class="fe ky kz la lb b">server</code>作为目标节点，我们将在这里下载Apache Webserver(HTTPD)，使用模板来更改根文档，这样我们的网页就只是系统本身的IP地址，最后启动HTTPD的服务。这个剧本的模板如下所示:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/6fe2d1699cbf9a3e4c0e312485677815.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/0*c7VrDcYXAr0kS2BW.png"/></div></figure><p id="88c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们使用<a class="ae kl" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_vars_facts.html" rel="noopener ugc nofollow" target="_blank"> ansible_facts </a>获取IP并打印到所需的位置。让我们测试剧本并检查我们是否得到了合适的结果(使用curl)。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/32bd235206934b7f38e5f9c93f138b8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/0*XkngZORfbDZyt8TI.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">为我们的剧本运行输出</figcaption></figure><p id="94af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">剧本运行良好，现在让我们使用curl命令测试设置…</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/69a18bcf770e2c6bc441305fb288364e.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/format:webp/0*VgOaR6Du4OMDL9PD.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">卷曲试验</figcaption></figure><p id="22d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是我们想要的设置功能…</p></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><p id="c7ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第2部分:</strong>对于这一部分，我们需要做的唯一更改是对我们的库存(更改为适当的IP集)和ansible.cfg文件(用于<a class="ae kl" href="https://docs.ansible.com/ansible/latest/user_guide/become.html" rel="noopener ugc nofollow" target="_blank">权限提升</a>)。</p><p id="e2f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">清单不会有太大变化，我们只需要将IP地址更改为所需系统的IP地址。此外，由于我们在这里不能使用密码，我们将对SSH使用私钥文件。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi md"><img src="../Images/6e13dbd7462d7ea77fd34c95946ad7af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/0*tayS3NVumsmBMP2q.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">新库存</figcaption></figure><p id="e473" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ansible.cfg将被改为如下形式:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi me"><img src="../Images/cedfafef65ace09ca4c08f104d26fd78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/0*AGW49vKpl8UqVhLQ.png"/></div></figure><p id="400d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们必须将remote_user改为ec2-user，因为AWS不允许我们通过SSH直接使用root，因此我们需要额外的<code class="fe ky kz la lb b">[privilege_escalation]</code>部分。现在你既可以自己创建所有需要的文件，也可以使用GitHub，如下所示:</p><p id="c780" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从GitHub复制文件时可以运行的命令</p><p id="88a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以使用复制的文件作为基础进行构建。</p><p id="77a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，要在您的ec2实例(Amazon Linux)中安装Ansible，您可以遵循以下步骤:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi mf"><img src="../Images/eee963c04a8e58d720311b1e449f26db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oM_ft5rW-MNUHkaH.png"/></div></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi mg"><img src="../Images/021f093b5859f1c919105364bfe9dea6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HUYMTr6KsRNU1cwm.png"/></div></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi mh"><img src="../Images/244db30fef146bd1570912a4fc8a64c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aOqACWSDkQbs8QYQ.png"/></div></div></figure><p id="eff8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装Ansible</p><p id="c81e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="lc">边注:</em> </strong> <em class="lc">亚马逊Linux不支持HAProxy，所以用RedHat代替。</em></p><p id="3301" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们测试我们的剧本和我们新的Ansible配置…</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi mi"><img src="../Images/dac342494ba3ea8731bd4c78cacc5c20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LBKsfC8ykVYNs0zb.png"/></div></div></figure><p id="c361" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Play1运行成功</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi mj"><img src="../Images/62b19947ce73dfeab76d3176adf88834.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yCIF0d_saYB7F3vQ.png"/></div></div></figure><p id="8337" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Play2运行成功</p><p id="5cbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，行动手册运行成功…</p><p id="89ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们做一个卷曲测试:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi mk"><img src="../Images/ba108cf4f7d6a14f3972b1036ab02f46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*azdqwi7M207ZWO81.png"/></div></div></figure><p id="1d2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">这项任务是与@Prithviraj Singh合作完成的，我要感谢他的指导和支持。</strong></p></div></div>    
</body>
</html>