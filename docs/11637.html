<html>
<head>
<title>Infrastructure as Code in Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基础设施作为Azure中的代码</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/infrastructure-as-code-in-azure-7dc5e6d9eab9?source=collection_archive---------3-----------------------#2022-04-02">https://levelup.gitconnected.com/infrastructure-as-code-in-azure-7dc5e6d9eab9?source=collection_archive---------3-----------------------#2022-04-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="204c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在Azure做IaC的快速印象。什么是作为代码的基础设施？有哪些限制和缺陷？</p><p id="ffed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="#f5a2" rel="noopener ugc nofollow"> IaC概述</a> <br/> ∘ <a class="ae kl" href="#5e01" rel="noopener ugc nofollow">什么是IaC？</a> <br/> ∘ <a class="ae kl" href="#5d36" rel="noopener ugc nofollow">为什么需要IaC？</a><br/>∘<a class="ae kl" href="#df75" rel="noopener ugc nofollow">IaC的两种做法</a> <br/> ∘ <a class="ae kl" href="#e78a" rel="noopener ugc nofollow">流行的IAC工具</a><br/><a class="ae kl" href="#eede" rel="noopener ugc nofollow">IAC in azure</a><br/>∘<a class="ae kl" href="#a462" rel="noopener ugc nofollow">azure管理理念</a> <br/> ∘ <a class="ae kl" href="#30cc" rel="noopener ugc nofollow"> ARM模板</a> <br/> ∘ <a class="ae kl" href="#bf30" rel="noopener ugc nofollow"> ARM Teamplate局限性</a> <br/> ∘ <a class="ae kl" href="#a782" rel="noopener ugc nofollow"> 6。azure resource visualizer sucks</a><br/><a class="ae kl" href="#4c32" rel="noopener ugc nofollow">最终文字</a> <br/> <a class="ae kl" href="#431c" rel="noopener ugc nofollow">引用</a></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/91d1bff7032808fc56f99e7d10404389.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dKMiRlYNnIth0xRFQZTnCA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">IaC运行中的可视化</figcaption></figure><h1 id="f5a2" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">IaC概述</h1><p id="24ec" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在讨论IaC是如何在Azure中完成的之前，我们先来了解一些关于IaC的背景。</p><h2 id="5e01" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">什么是IaC？</h2><p id="4219" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated"><a class="ae kl" href="https://en.wikipedia.org/wiki/Infrastructure_as_code" rel="noopener ugc nofollow" target="_blank">infra structure as Code</a>(IaC)是在文件中管理计算机基础设施的过程。IaC有两个组成部分。第一个是通过部署提供资源。第二是将部署的资源作为代码进行管理。在这两种情况下，将基础设施描述为代码是必要的先决条件。</p><h2 id="5d36" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">为什么需要IaC？</h2><p id="2db3" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">要了解为什么IaC是必要的和有益的，请考虑默认情况。对于任何必须管理中型服务器实验室的人来说，您都知道跟踪和配置机架、布线、网络等所有硬件的物理设备是多么痛苦。迁移到云确实使得用漂亮的控制台UI来可视化变得更加容易，但是管理它们仍然很有挑战性。下面是一个典型的控制台用户界面的截图。有了多层选项和规则，很容易在云中迷失方向(这不是双关语)。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mr"><img src="../Images/e63b1f34f6303b504322f56467077286.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NuFYxx5hPsWB4QxGaFFpjg.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">云服务的典型控制台用户界面</figcaption></figure><p id="ef42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将基础架构的复杂配置作为文件进行调配和管理，可以对它们进行版本控制和代码审查。这将降低人为错误的风险，节省管理成本，并提高部署和设置的速度。</p><h2 id="df75" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">IaC的两种方法</h2><p id="5e36" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">有两种方法可以实现IaC。在<strong class="jp ir">命令式(或程序式)</strong>方法中，您描述了如何实现期望的状态。要做到这一点，您需要知道事情如何工作的细节:即顺序、错误检查条件等。通常，这些过程是用某种脚本语言指定的，如Powershell CLR或Python。</p><p id="30db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二种方法被称为“T2”声明性或功能性方法，因为它只是描述了期望的状态，而没有说明如何实现它。Yaml或JSON文件通常用于此目的。需要注意的重要一点是，所描述的状态是'<strong class="jp ir">幂等的</strong>，'这意味着多次执行相同的脚本不会改变期望的结果。</p><h2 id="e78a" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">流行的IaC工具</h2><p id="2259" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">最流行的IaC工具是<a class="ae kl" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>，它使用<a class="ae kl" href="https://en.wikipedia.org/wiki/Go_(programming_language)" rel="noopener ugc nofollow" target="_blank"> Go </a>作为脚本语言。RedHat的Ansible 使用了Python，是另一个流行的工具。</p><p id="3af8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一方面，像AWS、Azure和GCP这样的云提供商有自己的IaC工具。AWS IaC解决方案是<a class="ae kl" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> CloudFormation </a>，它使用YAML作为文件格式。Azure有用JSON写的ARM (Azure资源管理器)模板。另一方面，Google CDM(云部署管理器)模板是用Python编写的。</p><p id="a2ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我个人使用过AWS CloudFormation和ARM，它们的用法非常相似。</p><h1 id="eede" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">天蓝色的IaC</h1><p id="ce38" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">建立了一些关于IaC的基础知识之后，我们就可以看到IaC在ARM (Azure Resource Manager)中的运行了。</p><h2 id="a462" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">Azure管理概念</h2><p id="1fee" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在Azure中，资源被组织在层次结构中，从授权你访问Azure服务和订阅的帐户开始。<a class="ae kl" href="https://en.wikipedia.org/wiki/Microsoft_Azure_Active_Directory" rel="noopener ugc nofollow" target="_blank">Azure AD(Active Directory)</a>是管理帐户访问Azure资源的系统。租户是Azure AD的一个实例，每个租户都有一个单独的专用可信目录，其中包含租户的用户、组和应用程序。</p><p id="5b5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目录按层次结构进一步分为管理组、订阅、资源组和资源。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ms"><img src="../Images/13ddc273f6b1ae3906075966815883d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ATy0PekK7voU118O6lAtYQ.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><a class="ae kl" href="https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-setup-guide/organize-resources" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/cloud-adoption-framework/ready/azure-setup-guide/organize-resources</a></figcaption></figure><h2 id="30cc" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">ARM模板</h2><p id="a8a8" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">ARM (Azure资源管理器)是Azure的IaC服务，ARM模板是定义和描述资源和配置的JSON文件。</p><p id="7988" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ARM模板作用于资源和资源组。例如，您可以选择导出一个资源(例如，数据库资源)或包含大量资源的整个资源组。但是，您不能导出到资源组之外:例如，跨多个订阅或目录。</p><p id="8689" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，将您的资源放入逻辑相关的资源中是一个很好的做法:例如，将所有与数据库相关的资源放入一个资源组中。例如，一旦相关资源被组织成组，一次性部署整个资源组就变得非常容易。</p><p id="cf95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">官方文档有大量的解释和示例，所以我将跳过细节。相反，我将把重点放在我在使用ARM模板时遇到的一些个人“陷阱”上。</p><h2 id="bf30" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">ARM团队板限制</h2><p id="63b1" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">虽然ARM模板是管理和部署资源的好方法，具有IaC的所有优点，但它们也有一些限制。</p><ol class=""><li id="6918" class="mt mu iq jp b jq jr ju jv jy mv kc mw kg mx kk my mz na nb bi translated"><strong class="jp ir">并非所有资源都出口。</strong></li></ol><p id="af2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可能遇到的第一个障碍是，并非所有资源都被导出。例如，下面是我在尝试导出资源时遇到的一些错误消息:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="f34d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种错误并不少见，但是绝大多数资源都是导出的，所以这不应该成为不使用ARM模板的借口。</p><p id="c0fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2。ARM模板只是“尽力而为”。</strong></p><p id="1d4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ARM模板的声明性语法意味着您不必担心执行顺序、如何创建它们等等。但是，它们不能100%保证正确或可部署。如果资源存在依赖关系，而这些依赖关系不存在，则不会创建依赖资源。例如，如果虚拟机依赖于不存在的磁盘驱动器，部署将会失败。</p><p id="d70d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 3。修复循环依赖关系。</strong></p><p id="db60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在尝试部署模板时，您可能会遇到的一个错误是“循环依赖”例如，可用性集和虚拟机可能相互依赖。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ne"><img src="../Images/70af5bcc802c2183093edf7f0b6ef4f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BhiMJkkTqU0DbWZKE62l7w.png"/></div></div></figure><p id="0318" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，模板将在部署前验证失败，因此您必须移除循环依赖。在我的例子中，我简单地从可用性集依赖关系中删除了VM来解决这个问题。</p><p id="7ac9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 4。机密不会导出。</strong></p><p id="1237" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所谓“秘密”，我指的是与隐私或安全有关的私有或秘密资源:例如，证书、密码等。例如，当您导出数据库资源时，即使您通过UI设置了管理员用户名和密码，它们也不会被导出。显然，这些不是限制，而是保护资源的安全特性。</p><p id="8831" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了更好地保护您的机密，最佳做法是使用Key Vault service来保存您的机密并引用模板文件中的机密。以下模板片段显示了通过用户分配的身份对证书的KeyVault机密的引用。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="84bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 5。静态资源可能不是静态的。</strong></p><p id="e501" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署了静态资源，如IP地址，但是它们的实际值可能与您分配给它们的值不同，这取决于当前的可用性。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="2384" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了避免部署和服务问题，最好对静态资源使用参数，而不是硬编码实际值。</p><h2 id="a782" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">6.Azure资源可视化工具很烂</h2><p id="8a73" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">您可以使用资源可视化工具在Azure中可视化ARM模板。但是，我必须警告你，这个工具的功能非常少，除了放大和缩小之外，你不能与元素交互。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nf"><img src="../Images/3223340fa011efc8b715cedd6836f13f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q2CHnP9wR3ocs2YJxUWQ_A.png"/></div></div></figure><p id="c451" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">幸运的是，VS代码为ARM模板提供了两个很好的扩展。<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/quickstart-create-templates-use-visual-studio-code?tabs=CLI" rel="noopener ugc nofollow" target="_blank">Azure Resource Manager Tools</a>extension是编辑模板的好帮手，而<a class="ae kl" href="https://marketplace.visualstudio.com/items?itemName=bencoleman.armview" rel="noopener ugc nofollow" target="_blank"> ARM Template Viewer </a>是一个很棒的交互式可视化工具。上面绘制的相同资源组在ARM模板查看器中显示如下:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/91d1bff7032808fc56f99e7d10404389.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dKMiRlYNnIth0xRFQZTnCA.png"/></div></div></figure><h1 id="4c32" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">最后的话</h1><p id="e72c" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">尽管有上述限制和缺陷，ARM模板和IaC仍然是管理资源和配置的最佳方式。像任何工具或技能一样，也有技术上的权衡，您必须意识到其中的问题，并做出明智的决定，确定哪些工具最适合您的特定需求。我希望我的文章已经告诉了您从哪里开始IaC和ARM模板之旅。</p><h1 id="431c" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">参考</h1><p id="fc16" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">[1]微软文档:<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/considerations/fundamental-concepts" rel="noopener ugc nofollow" target="_blank"> Azure基础概念</a></p><p id="5783" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">[2]微软文档:<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/overview" rel="noopener ugc nofollow" target="_blank"> Azure资源管理器</a></p><p id="08f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">[3]比较不同IaC框架的优秀参考文章:<a class="ae kl" href="https://spacelift.io/blog/infrastructure-as-code" rel="noopener ugc nofollow" target="_blank">https://spacelift.io/blog/infrastructure-as-code</a></p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><h1 id="85b7" class="lc ld iq bd le lf nn lh li lj no ll lm ln np lp lq lr nq lt lu lv nr lx ly lz bi translated">分级编码</h1><p id="16c4" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">感谢您成为我们社区的一员！更多内容见<a class="ae kl" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">级编码出版物</a>。<br/>跟随:<a class="ae kl" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a>，<a class="ae kl" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">领英</a>，<a class="ae kl" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">通迅</a> <br/> <strong class="jp ir">升一级正在改造理工大招聘➡️ </strong> <a class="ae kl" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">加入我们的人才集体</strong> </a></p></div></div>    
</body>
</html>