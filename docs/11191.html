<html>
<head>
<title>Smart Contract Javafication: Web3j Wrappers and Other Sorceries</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">智能契约Java应用:Web3j包装器和其他魔法</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/smart-contract-javafication-web3j-wrappers-and-other-sorceries-137ab3a2f4e9?source=collection_archive---------7-----------------------#2022-02-24">https://levelup.gitconnected.com/smart-contract-javafication-web3j-wrappers-and-other-sorceries-137ab3a2f4e9?source=collection_archive---------7-----------------------#2022-02-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8037" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">科特林教母入门魔法书</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/237269a23eeb90bdeca3e09644068801.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8cRtit_nL3RmV0z1RXFhdA.jpeg"/></div></div></figure><p id="fc5d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最近我在尝试使用<a class="ae ln" href="https://consensys.net/quorum/developers/" rel="noopener ugc nofollow" target="_blank"> Quorum </a>，这是一套开源的工具、API、私钥管理器和客户端来运行一个私有以太网。我的主要目标是弄清楚如何在以太坊区块链之上构建应用程序，以及如何正确地与智能合约交互。我选择了一个使用Besu的Quorum版本，这是一个由Hyperledger Foundation维护的以太坊客户端，它实现了企业用例的私有事务。</p><p id="0e90" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">作为第一步，我们需要准备贸易工具。当然，拥有一个运行中的区块链是开始工作的基础。在我看来，建立一个区块链本地以太坊是非常棘手的，但是我们很幸运，因为<a class="ae ln" href="https://consensys.net/" rel="noopener ugc nofollow" target="_blank">咨询公司</a>策划了一个法定人数<a class="ae ln" href="https://consensys.net/quorum/products/guides/getting-started-with-consensys-quorum" rel="noopener ugc nofollow" target="_blank">快速启动项目</a>，它拥有在几分钟内运行网络所需的一切。《Consensys实践指南》在使网络部署变得简单明了方面做得很好，所以我不会在这里讨论细节。</p><div class="lo lp gp gr lq lr"><a href="https://github.com/ConsenSys/quorum-dev-quickstart" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd ir gy z fp lw fr fs lx fu fw ip bi translated">GitHub-ConsenSys/Quorum-dev-quick start:Quorum Developer quick start实用程序可用于…</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">Quorum Developer Quickstart实用程序可用于为…快速生成本地Quorum区块链网络</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">github.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf kp lr"/></div></div></a></div><p id="590a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但是，如果一切都做得正确，最后您将在您的机器上举办一场docker图像的生动聚会:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mg"><img src="../Images/338b80fc9f27790bb702ce85a73b44bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LzYqQ9TABtY__5w_GFzeyA.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">图片来自consensys.net</figcaption></figure><p id="3b5f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这里有很多东西需要打开。除了<a class="ae ln" href="https://www.elastic.co/what-is/elk-stack" rel="noopener ugc nofollow" target="_blank"> ELK </a>堆栈、监控工具和块资源管理器，我们还可以找到:</p><ul class=""><li id="4a88" class="ml mm iq kt b ku kv kx ky la mn le mo li mp lm mq mr ms mt bi translated">4个以太坊节点运行在QFTP上。这是拥有抗拜占庭故障网络所需的最小数量</li><li id="8899" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">3个Besu客户端，保存各自成员的信息</li><li id="a62e" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">3 Tessera服务，这是管理私人事务及其数据所必需的</li><li id="3067" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">RPC服务节点</li></ul><h2 id="49f9" class="mz na iq bd nb nc nd dn ne nf ng dp nh la ni nj nk le nl nm nn li no np nq nr bi translated">[0x 1]Java签订智能合同</h2><p id="a46a" class="pw-post-body-paragraph kr ks iq kt b ku ns jr kw kx nt ju kz la nu lc ld le nv lg lh li nw lk ll lm ij bi translated">quorum-quickstart项目的特色是一个名为<code class="fe nx ny nz oa b">SimpleStorage.sol</code>的智能合约和一些有趣的脚本，这些脚本展示了<em class="ob"> web3js </em>，一个在以太坊网络上与智能合约交互的库。然而，作为一个更像Kotlin的人，我更愿意尝试一下<strong class="kt ir"> <em class="ob"> web3j </em> </strong>，一个基于Java的库，并重写相同的脚本来弄清楚它们实际上做了什么。</p><p id="6e98" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">显然，第一步是建立一个项目，然后导入所需的依赖项:</p><pre class="kg kh ki kj gt oc oa od oe aw of bi"><span id="9481" class="mz na iq oa b gy og oh l oi oj"><em class="ob">// build.gradle (v6)<br/>dependencies {<br/>  implementation(</em>"org.web3j:core:4.8.7"<em class="ob">)<br/>  implementation(</em>"org.web3j:besu:4.8.7"<em class="ob">)<br/>}</em></span></pre><p id="a060" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们也不要忘记插件:</p><pre class="kg kh ki kj gt oc oa od oe aw of bi"><span id="f2d7" class="mz na iq oa b gy og oh l oi oj"><em class="ob">// build.gradle (v6)<br/>plugins {<br/>  </em>id<em class="ob">(</em>"org.web3j"<em class="ob">) version </em>"4.8.7"<br/><em class="ob">}</em></span></pre><p id="794b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在意识到<code class="fe nx ny nz oa b">web3j</code>插件<em class="ob">目前</em>不支持<em class="ob"> gradle 7 </em>之后，要做的第一步是将<em class="ob"> SimpleStorage </em> solidity文件转换成一个漂亮的Java公主。让我们来看看:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="9241" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">即使对于我们当中那些不精通稳固巫术的人来说，契约逻辑也是简单明了的。<code class="fe nx ny nz oa b">SimpleStorage.sol</code>只在区块链上存储一个无符号整数，公开一些方便的get/set方法与它交互。然而，在我们能够与这份合同合作之前，还有许多工作要做。幸运的是，web3j插件可以为我们完成这项工作。我们需要做的就是把它放在一个合理的位置，如下所示</p><pre class="kg kh ki kj gt oc oa od oe aw of bi"><span id="0257" class="mz na iq oa b gy og oh l oi oj">src<br/>├── main<br/>│   ├── kotlin<br/>│   ├── solidity<br/>│   │   └── <strong class="oa ir">SimpleStorage.sol</strong><br/>│   └── resources<br/>└── test</span></pre><p id="5d57" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后跑<code class="fe nx ny nz oa b">gradle generateContractWrappers</code>。web3j插件将在项目的<code class="fe nx ny nz oa b">build</code>目录中构建一个名为<code class="fe nx ny nz oa b"> SimpleStorage.java</code>的Java包装器，这样我们就可以用Kotlin代码轻松处理合同。</p><h2 id="d38c" class="mz na iq bd nb nc nd dn ne nf ng dp nh la ni nj nk le nl nm nn li no np nq nr bi translated">[0x2]设置成员凭据</h2><p id="24d7" class="pw-post-body-paragraph kr ks iq kt b ku ns jr kw kx nt ju kz la nu lc ld le nv lg lh li nw lk ll lm ij bi translated">正如我们在上面看到的，Quorum Quickstart创建了三个Besu成员资格:为了简单起见，我们将分别称它们为ALICE、BOB和CHARLIE。列出的私钥由Quorum quickstart示例生成，并存储在<code class="fe nx ny nz oa b">smart_contracts/keys.js</code>文件中</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="95b2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">主要内容包括:</p><ul class=""><li id="337b" class="ml mm iq kt b ku kv kx ky la mn le mo li mp lm mq mr ms mt bi translated"><strong class="kt ir">成员节点URL:</strong>这些是到达Besu客户端并提交请求的端点</li><li id="eef3" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated"><strong class="kt ir">私钥:</strong>会员提交交易的凭证，从中我们也可以导出他们的公钥和地址。出于演示的目的，这里都是硬编码的，对于真实的用例，最好依靠适当的密钥管理系统</li><li id="16b4" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated"><strong class="kt ir"> Tessera公共密钥:</strong>对Tessera的飞地id的引用，管理私人交易数据需要这些id</li></ul><p id="a0cb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">既然我们已经查看了文件内容，那么我们可以将它们翻译成更适合JVM的语言，比如Kotlin:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">包含节点URL、客户端和私钥的Credentials.kt文件</figcaption></figure><p id="061a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一切终于准备好执行一些区块链的诡计。</p><h2 id="7717" class="mz na iq bd nb nc nd dn ne nf ng dp nh la ni nj nk le nl nm nn li no np nq nr bi translated">[0x3]运行公共事务</h2><p id="8406" class="pw-post-body-paragraph kr ks iq kt b ku ns jr kw kx nt ju kz la nu lc ld le nv lg lh li nw lk ll lm ij bi translated">一个基本的起点是部署我们的<code class="fe nx ny nz oa b">SimpleStorage</code>智能契约，并向它提交一个事务。但是我们怎么能呢？老实说，Javascript示例看起来有点复杂:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="4f3d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">那里发生了很多事情，刚开始有点头晕是正常的。简而言之，该示例通过提交智能合约的十六进制编码从头构建了一个<code class="fe nx ny nz oa b">RawTransaction</code>，使用<code class="fe nx ny nz oa b">Alice</code>的私钥在本地对交易进行签名，然后提交交易。最后，契约地址不是立即可用的，我们仍然必须等待事务被确认，以便稍后调用契约方法。总之就是拖。</p><p id="a073" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然而，不一定非要这样。</p><pre class="kg kh ki kj gt oc oa od oe aw of bi"><span id="ba7e" class="mz na iq oa b gy og oh l oi oj">val simpleStorage = SimpleStorage.deploy(<br/>  clientAlice, ALICE, GAS_PRICE, GAS_LIMIT, BigInteger.ONE<br/>).send()</span></pre><p id="98c9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">…魔法！我们刚刚在以太坊上部署了一个智能合约，只有一行小把戏，这都要归功于web3j包装器和细节。我们可以习惯性地调用Kotlin中的<code class="fe nx ny nz oa b">get</code>和<code class="fe nx ny nz oa b">set</code>方法，因为<code class="fe nx ny nz oa b">simpleStorage</code>是一个常规对象。Alice凭证嵌入在智能契约实例中，因此我们可以提交任何事务，web3j将负责编码、签名、发送到Besu以及所有这些事情。不言而喻，鲍勃和查理应该有机会获得相同的公共合同，这才是公平的</p><pre class="kg kh ki kj gt oc oa od oe aw of bi"><span id="4420" class="mz na iq oa b gy og oh l oi oj">val contractForBob = SimpleStorage.load(<br/>  DEPLOYED_CONTRACT_ADDRESS, clientBob, BOB, GAS_PRICE, GAS_LIMIT<br/>)</span></pre><p id="7aef" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">仅仅通过访问前面提到的一组API，就可以编写一个非常基本的dApp。Alice和Bob可以通过访问他们独立的分类帐实例，在智能合同的同一个实例上进行交互，这可能是在世界的另一端:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure></div><div class="ab cl om on hu oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="ij ik il im in"><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><h2 id="e538" class="mz na iq bd nb nc nd dn ne nf ng dp nh la ni nj nk le nl nm nn li no np nq nr bi translated">[0x4]运行私有事务🥷</h2><p id="aa3d" class="pw-post-body-paragraph kr ks iq kt b ku ns jr kw kx nt ju kz la nu lc ld le nv lg lh li nw lk ll lm ij bi translated">既然我们都觉得自己有点像上帝，我们甚至可以考虑涉足私人交易。请注意:当提到私有事务时，我指的是数据有效负载对一个封闭的参与者组可用的事务。Besu中的这个特性与目标网络是正交的:可以在以太坊主网或一个许可的网络中运行私有事务。</p><p id="6c5d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">隐私层的使能技术称为Tessera:它是私有交易数据的分散存储，其中每个参与者都由Enclave密钥标识，并且可以访问保留的Tessera节点。多个飞地的集合被称为隐私组，隐私组是保存在私人事务期间收集的私人状态的实体。当然，任何愿意处理私有数据的节点都必须有自己的Tessera节点。Quorum quickstart示例将设置现成的Enclaves:只需记住<a class="ae ln" href="https://besu.hyperledger.org/en/stable/HowTo/Use-Privacy/Use-FlexiblePrivacy/#enabling-flexible-privacy-groups" rel="noopener ugc nofollow" target="_blank">通过配置环境变量</a>启用隐私组。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/8170017ee6c594e1dd0a2b16fba5f958.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EvyrbJ6NZ77fdgwM_gHoEQ.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated"><a class="ae ln" href="https://besu.hyperledger.org/en/stable/Concepts/Privacy/Privacy-Overview/" rel="noopener ugc nofollow" target="_blank">https://besu . hyperledger . org/en/stable/Concepts/Privacy/Privacy-Overview/</a></figcaption></figure><p id="83fd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">运行私有事务比提交公共事务要复杂一些，但是web3j仍然很好地惯坏了我们。主要的警告是，我们现在需要一个<code class="fe nx ny nz oa b">private transaction processor</code>来检查私人交易是否被挖掘，还需要一个<code class="fe nx ny nz oa b">private transaction manager</code>来代替普通凭证。但是让我们按顺序来。</p><p id="8a57" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将为爱丽丝和查理创建一个隐私组，并等待它在网上得到确认</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="0919" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">部署智能合约并与之交互几乎与公共事务一样简单。我们所需要的是隐私组ID和一个特殊的T2，它可以很容易地从已有的信息中建立起来</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="5d3d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最后，我们需要做的就是私下部署一个智能合同</p><pre class="kg kh ki kj gt oc oa od oe aw of bi"><span id="0699" class="mz na iq oa b gy og oh l oi oj">val privateSimpleStorage = SimpleStorage.deploy(<br/>  clientAlice, tm, GAS_PRICE, GAS_LIMIT, BigInteger.ONE<br/>).send()</span></pre><p id="606f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的私有智能契约包装器现在将公开Solidity实现的<code class="fe nx ny nz oa b">set</code>和<code class="fe nx ny nz oa b">get</code>方法，但是不出所料，数据将只在隐私组内可用。</p><h2 id="d891" class="mz na iq bd nb nc nd dn ne nf ng dp nh la ni nj nk le nl nm nn li no np nq nr bi translated">[0xFFF]结论</h2><p id="4d47" class="pw-post-body-paragraph kr ks iq kt b ku ns jr kw kx nt ju kz la nu lc ld le nv lg lh li nw lk ll lm ij bi translated">当讨论web3应用程序时，基于JVM的语言并不是第一个想到的，但是老实说，它们是相当普遍的，并且已经有了一个很好的生态系统。只由我们来决定建造什么。</p><p id="f246" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你度过了一段美好的时光，并想阅读更多关于迪士尼比较的有问题的文章，请在Medium上关注我，让我知道你的观点。</p><p id="f257" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">好了，我们现在就走吧:我们的Kotlinderellas在等着我们呢！</p></div><div class="ab cl om on hu oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="ij ik il im in"><p id="8daa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae ln" href="https://blog.lorisocchipinti.com" rel="noopener ugc nofollow" target="_blank">加入我的时事通讯，了解更多类似的故事</a></p><h2 id="82e8" class="mz na iq bd nb nc nd dn ne nf ng dp nh la ni nj nk le nl nm nn li no np nq nr bi translated">参考</h2><ul class=""><li id="1184" class="ml mm iq kt b ku ns kx nt la ou le ov li ow lm mq mr ms mt bi translated">Web3j网站:<a class="ae ln" href="https://docs.web3j.io/4.8.7/" rel="noopener ugc nofollow" target="_blank">https://docs.web3j.io/4.8.7/</a></li><li id="faf0" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">Besu文件和API:<a class="ae ln" href="https://besu.hyperledger.org/en/stable/" rel="noopener ugc nofollow" target="_blank">https://besu.hyperledger.org/en/stable/</a></li><li id="fdaa" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">quorum quick start:<a class="ae ln" href="https://consensys.net/quorum/products/guides/getting-started-with-consensys-quorum/" rel="noopener ugc nofollow" target="_blank">https://consensys . net/quorum/products/guides/getting-started-with-consensys-quorum/</a></li></ul></div></div>    
</body>
</html>