<html>
<head>
<title>Deploying an Apollo GraphQL application as an AWS lambda function through Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过无服务器部署Apollo GraphQL应用程序作为AWS lambda函数</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploying-an-apollo-graphql-application-as-an-aws-lambda-function-through-serverless-77fa33612bae?source=collection_archive---------17-----------------------#2021-02-22">https://levelup.gitconnected.com/deploying-an-apollo-graphql-application-as-an-aws-lambda-function-through-serverless-77fa33612bae?source=collection_archive---------17-----------------------#2021-02-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/070a942d778b6e1d4e16990a1bcc879e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GM4TPAR0ELvmUReJPUT_6g.png"/></div></div></figure><p id="a91c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇文章是我上一篇<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/accessing-aws-dynamodb-through-apollo-graphql-server-deployed-in-aws-lambda-through-serverless-e2752c84281c">文章</a>的延续，在那篇文章中，我们构建了一个极简应用程序来从本地托管的Graphql服务器中提取AWS DynamoDB数据。</p><p id="81d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们将进一步修改代码，以运行与通过无服务器部署的AWS Lambda函数相同的代码。</p><p id="92b2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">第四步:制作一个lambda函数</strong></p><p id="82cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Apollo服务器通过<code class="fe kx ky kz la b">apollo-server-lambda</code>模块为lambda函数提供绑定。</p><p id="bc65" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更改<code class="fe kx ky kz la b">server.js</code>，不运行Apollo Server，而是导出一个apollo GraphQL lambda函数，AWS lambda将基于HTTP事件调用该函数。</p><p id="0440" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">const { ApolloServer, gql } = require(‘apollo-server-lambda’);</code></p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="5504" class="lj lk iq la b gy ll lm l ln lo">const handler = server.createHandler({<br/>  cors: {<br/>    origin: true,<br/>    credentials: true,<br/>  },<br/>});<br/>exports.graphqlHandler = handler;</span></pre><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lp lq l"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">server.js的完整代码</figcaption></figure></div><div class="ab cl lv lw hu lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ij ik il im in"><p id="af7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">步骤5:部署到AWS </strong></p><p id="b0c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在您需要将它发布到AWS。为此，我们将利用<a class="ae kw" href="https://www.serverless.com/framework/docs/" rel="noopener ugc nofollow" target="_blank">无服务器</a>(一个简化开发和部署无服务器应用程序的框架)。</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="add7" class="lj lk iq la b gy ll lm l ln lo">npm install -g serverless</span></pre><p id="4522" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">无服务器需要一个AWS概要文件来代表您发布和部署代码。在上一篇<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/accessing-aws-dynamodb-through-apollo-graphql-server-deployed-in-aws-lambda-through-serverless-e2752c84281c">文章</a>中，我们创建了一个名为<code class="fe kx ky kz la b">serverlessuser</code>的概要文件。</p><p id="2dbc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">aws configure --<strong class="ka ir">profile serverlessuser</strong></code></p><p id="d2bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在CLI中运行以下命令以提供对无服务器的访问(替换<code class="fe kx ky kz la b"><strong class="ka ir">aws_secret_access_key</strong></code>和<code class="fe kx ky kz la b"><strong class="ka ir">aws_access_key_id)</strong></code></p><p id="c81e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">serverless config credentials --provider aws -- key <strong class="ka ir">aws_access_key_id</strong> -- secret <strong class="ka ir">aws_secret_access_key</strong> — profile custom-profile</code></p><p id="2b07" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个<code class="fe kx ky kz la b">serverless</code> YAML文件</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="a90b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们检查一下这个文件。</p><p id="00a2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个YAML文件指示创建一个AWS Lambda服务<code class="fe kx ky kz la b">apollo-lambda</code>并使用运行时作为<code class="fe kx ky kz la b">node12</code>。</p><p id="9f8b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在在CLI中运行以下命令</p><p id="2efc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">serverless deploy --aws-profile serverlessuser</code></p><p id="8744" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CLI将显示端点的位置(例如<a class="ae kw" href="https://38s4u8qm3f.execute-api.us-east-1.amazonaws.com/dev/graphql" rel="noopener ugc nofollow" target="_blank">https://xxxx-east1.amazonaws.com/dev/graphql</a>)以访问部署的GraphiQL接口。</p><p id="6fc5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">注意</strong>:确保新创建的<a class="ae kw" href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/functions" rel="noopener ugc nofollow" target="_blank"> Lambda </a>函数可以访问DynamoDB，方法是转到permissions选项卡，并将访问DynamoDB(或用于开发目的的所有资源)的适当策略附加到角色。</p><p id="355c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在可以访问GraphiQL接口并运行查询了</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="8e64" class="lj lk iq la b gy ll lm l ln lo">query {<br/>  quotes {<br/>    id<br/>    value<br/>    source<br/>  }<br/>}</span></pre><p id="f5ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样！</p><p id="b923" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其他几个链接将帮助您理解无服务器为您做了什么，并调试应用程序</p><p id="bf1b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks?filteringStatus=active&amp;filteringText=&amp;viewNested=true&amp;hideStacks=false" rel="noopener ugc nofollow" target="_blank">云形成</a>、<a class="ae kw" href="https://console.aws.amazon.com/apigateway/main/apis?region=us-east-1" rel="noopener ugc nofollow" target="_blank"> API网关</a>和<a class="ae kw" href="https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logsV2:logs-insights" rel="noopener ugc nofollow" target="_blank">云观察日志</a>，</p></div><div class="ab cl lv lw hu lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ij ik il im in"><p id="ad7d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">奖金</strong> : <strong class="ka ir">幕后</strong></p><p id="8882" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下部分简要介绍了无服务器为您做了什么。</p><p id="73e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，它创建了一个Lambda函数。让我们试着自己做。</p><p id="a625" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到λ<a class="ae kw" href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/discover" rel="noopener ugc nofollow" target="_blank">控制台</a>。</p><p id="4453" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从头开始创建函数-作者&gt;为将运行时设置为节点填写一个名称。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mc"><img src="../Images/767d34d7b277d6dd4db7c61f23edb159.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NBMafDqaE2VkrPzKrPPbfw.png"/></div></div></figure><p id="ebd9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另外，确保lambda函数的运行时设置。导出函数名应该是<code class="fe kx ky kz la b">graphql.graphqlHandler</code></p><p id="3c74" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过提供您的zip链接URL，从亚马逊S3上传文件。利用无服务器在S3水桶中为你推的同一拉链。</p><p id="f298" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们试着运行一个测试，并对这个函数执行一个查询。</p><p id="5d56" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">配置测试事件。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi md"><img src="../Images/d0d51573ffad1cf7189d854fb3fc4cdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vQfEpSX-c_KfGEg3XvLxXA.png"/></div></div></figure><p id="3e55" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将此作为请求输入:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="37b4" class="lj lk iq la b gy ll lm l ln lo">{<br/>  "operationName": null,<br/>  "variables": {},<br/>  "query": "{\n  quotes {\n    id\n    value\n    source\n  }\n}\n"<br/>}</span></pre><p id="9036" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存并点击“测试”，您将看到一个<strong class="ka ir">错误</strong>！为什么？因为该函数被公开来响应HTTP请求。下面是无服务器为您做的第二部分。</p><p id="b8cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Serverless使用<a class="ae kw" href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks?filteringStatus=active&amp;filteringText=&amp;viewNested=true&amp;hideStacks=false" rel="noopener ugc nofollow" target="_blank"> AWS Cloudformation </a>创建一个<code class="fe kx ky kz la b">stack</code>，它通过AWS <a class="ae kw" href="https://console.aws.amazon.com/apigateway/main/apis?region=us-east-1" rel="noopener ugc nofollow" target="_blank"> API网关</a>公开HTTP端点。</p><p id="f381" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查为应用<code class="fe kx ky kz la b">apollo-lambda-dev.</code>创建的无服务器堆栈，转到“模板”选项卡，并在<em class="me">设计器</em>中查看。这将显示为运行lambda函数而创建的所有资源。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/3eb3eb0a91bb978b3a027b0464e0d7c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*89Bb7tRWoNfvRTJ5TGBXfw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">云形成设计者</figcaption></figure><p id="5908" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你在你的<strong class="ka ir">模板</strong>中定义你的资源、属性和关系，然后从它创建你的<strong class="ka ir">栈</strong>。正如您所看到的，有多个<strong class="ka ir">资源</strong>，如果您仔细观察，您会看到<strong class="ka ir">API gateway</strong><strong class="ka ir">RestAPI</strong>和<strong class="ka ir">方法</strong>(用于处理GET、POST等)，它们与<strong class="ka ir"> Lambda </strong> <strong class="ka ir">函数</strong>资源集成在一起，以执行任何RestAPI调用。</p><p id="b3bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里有很多内容超出了本文的范围，但希望它能让我们了解无服务器如何帮助开发和部署无服务器应用程序。</p></div><div class="ab cl lv lw hu lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ij ik il im in"><p id="b43c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你喜欢这个，请点击👏按钮并关注我以获取更多更新。</p></div></div>    
</body>
</html>