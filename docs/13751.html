<html>
<head>
<title>Terraform — Use managed identity to connect Key Vault to an Azure web app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform —使用托管身份将密钥库连接到Azure web应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/terraform-use-managed-identity-to-connect-key-vault-to-an-azure-web-app-565122126c4b?source=collection_archive---------4-----------------------#2022-10-03">https://levelup.gitconnected.com/terraform-use-managed-identity-to-connect-key-vault-to-an-azure-web-app-565122126c4b?source=collection_archive---------4-----------------------#2022-10-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="47c9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如何认证应用服务以使用托管身份从密钥库中读取机密</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/6f49880b72c5a9a0a7bb8a29ab66dbc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h2AAZXX2dpxreEjimAHVGA.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated"><a class="ae le" href="https://unsplash.com/@davisuko?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">达维苏科</a>在<a class="ae le" href="https://unsplash.com/s/photos/identity?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><blockquote class="lf lg lh"><p id="52ff" class="jq jr li js b jt ju jv jw jx jy jz ka lj kc kd ke lk kg kh ki ll kk kl km kn im bi translated">托管身份在Azure Active Directory中为应用程序提供了一个自动托管的身份，以便在连接到支持Azure Active Directory (Azure AD)身份验证的资源时使用。应用程序可以使用托管身份<strong class="js iu">来获得Azure AD令牌，而无需管理任何凭证</strong>。</p></blockquote><h2 id="7319" class="lm ln it bd lo lp lq dn lr ls lt dp lu kb lv lw lx kf ly lz ma kj mb mc md me bi translated">必需的权限</h2><p id="3365" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">terraform服务主体需要一个<a class="ae le" href="https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#application-administrator" rel="noopener ugc nofollow" target="_blank">应用管理员</a>角色来创建AD应用。</p><p id="7b8f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="li">注意:你的应用子网应该有一个“</em> <strong class="js iu"> <em class="li">微软。KeyVault </em> </strong> <em class="li">”添加服务点，将其添加到允许的网络。更多内容请点击此处</em> <a class="ae le" href="https://learn.microsoft.com/en-us/azure/key-vault/general/overview-vnet-service-endpoints" rel="noopener ugc nofollow" target="_blank"> <em class="li">虚拟网络服务端点为Azure Key Vault </em> </a></p><h2 id="4ac6" class="lm ln it bd lo lp lq dn lr ls lt dp lu kb lv lw lx kf ly lz ma kj mb mc md me bi translated">将（行星）地球化（以适合人类居住）</h2><p id="50e5" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">第一步是为应用服务启用托管身份，这样应用将拥有azure托管服务主体。您可以拥有“系统分配的”(<em class="li">，将在应用的整个生命周期</em>中进行管理)或“用户分配的”(<em class="li">用户管理的生命周期</em>)管理身份，更多信息请点击<a class="ae le" href="https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview" rel="noopener ugc nofollow" target="_blank">查看</a>。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="51f0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上述Terraform代码中的<code class="fe mm mn mo mp b">identity </code>部分将为我们的应用程序提供前面提到的“系统分配的”托管身份。</p><h2 id="939a" class="lm ln it bd lo lp lq dn lr ls lt dp lu kb lv lw lx kf ly lz ma kj mb mc md me bi translated">对密钥库的应用服务访问</h2><p id="3877" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">因此，我们启用了托管身份，接下来是读取作为托管身份的一部分创建的底层服务主体详细信息(记得我之前提到过)</p><pre class="kp kq kr ks gt mq mp mr bn ms mt bi"><span id="36ed" class="mu ln it mp b be mv mw l mx my"># Get the app's managed identity principal id.<br/>data "azuread_service_principal" "app_sp" {<br/>  display_name = azurerm_app_service.app.name<br/>  depends_on   = [<br/>    azurerm_app_service.app<br/>  ]<br/>}</span></pre><p id="f063" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，将服务主体访问权限分配给密钥库</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="c05a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="li">如果你在一个</em> <strong class="js iu"> <em class="li">的私有网络</em> </strong> <em class="li">的世界里记得把app子网也添加到访问“允许”的虚拟网络子网标识</em></p><h2 id="637b" class="lm ln it bd lo lp lq dn lr ls lt dp lu kb lv lw lx kf ly lz ma kj mb mc md me bi translated">结论</h2><p id="3dbd" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">托管身份将使您的应用程序能够访问密钥库，而无需管理代码中的任何机密。读取应用程序内部的秘密会因你使用的技术而异，但在Azure世界中，你的应用程序已经有了它需要的东西！</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="1ed0" class="ng ln it bd lo nh ni nj lr nk nl nm lu nn no np lx nq nr ns ma nt nu nv md nw bi translated">分级编码</h1><p id="0e57" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="a68d" class="nx ny it js b jt ju jx jy kb nz kf oa kj ob kn oc od oe of bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="ebe1" class="nx ny it js b jt og jx oh kb oi kf oj kj ok kn oc od oe of bi translated">📰查看<a class="ae le" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">级编码出版物</a>中的更多内容</li><li id="d51a" class="nx ny it js b jt og jx oh kb oi kf oj kj ok kn oc od oe of bi translated">💰免费编码面试课程<a class="ae le" href="https://skilled.dev/?utm_source=luc&amp;utm_medium=article" rel="noopener ugc nofollow" target="_blank">查看课程</a></li><li id="432d" class="nx ny it js b jt og jx oh kb oi kf oj kj ok kn oc od oe of bi translated">🔔关注我们:<a class="ae le" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a> | <a class="ae le" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a> | <a class="ae le" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="fe9e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">🚀👉<a class="ae le" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>