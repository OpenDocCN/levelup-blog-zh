<html>
<head>
<title>How To Save A Fortune On Azure Kubernetes Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Azure Kubernetes服务上省钱</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-save-a-fortune-on-azure-kubernetes-service-d4910239b8b3?source=collection_archive---------12-----------------------#2021-01-28">https://levelup.gitconnected.com/how-to-save-a-fortune-on-azure-kubernetes-service-d4910239b8b3?source=collection_archive---------12-----------------------#2021-01-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/17bfcbd77851be166ead5cd9081453cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4OB_KclRm-CUAL3kHRNLdg.png"/></div></div></figure><div class=""/><div class=""><h2 id="c458" class="pw-subtitle-paragraph kb jd je bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks dk translated">帮助您最大限度减少AKS支出的各种策略</h2></div><p id="8333" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">我们都知道这个故事——您的团队获得了云提供商，第一个月每个人都很高兴并参与其中。DevOps团队为开发、测试和生产环境快速启动多个Kubernetes集群。而且都很美好…直到第一张发票来了。突然就没那么多彩了。</p><h1 id="238d" class="lp lq je bd lr ls lt lu lv lw lx ly lz kk ma kl mb kn mc ko md kq me kr mf mg bi translated">AK对我的钱做了什么？</h1><p id="1325" class="pw-post-body-paragraph kt ku je kv b kw mh kf ky kz mi ki lb lc mj le lf lg mk li lj lk ml lm ln lo im bi translated">配置Azure Kubernetes集群(AKS)很容易，只需启动向导并单击“下一步”直到完成。然而，这种简化的方法可能会花费你很多钱。云供应商并不急于减少您的云支出，因此需要花费一些时间和精力来寻找所有可能的方法。</p><p id="f4a8" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">有多种方法可以控制你的AKS支出。在这里，我们收集了一些最重要的:</p><h1 id="5927" class="lp lq je bd lr ls lt lu lv lw lx ly lz kk ma kl mb kn mc ko md kq me kr mf mg bi translated">使用定点实例</h1><p id="469d" class="pw-post-body-paragraph kt ku je kv b kw mh kf ky kz mi ki lb lc mj le lf lg mk li lj lk ml lm ln lo im bi translated">Azure云通常没有得到充分利用，客户没有使用大量的计算能力。这种未使用的容量促使微软提供了一种新型的虚拟机— Spot Instances。它们比普通虚拟机便宜得多，并且可以随时被驱逐。这使得spot实例非常适合开发和测试环境，但不太适合生产环境。除非您完全了解spot实例如何工作以及它们有什么风险，否则您不应该将它应用到生产环境中。</p><p id="22b8" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">AKS可以使用Spot实例作为额外的节点池，在底层映射到虚拟机规模集(VMSS)。让我们看一下默认AKS在节点池方面的表现——一个具有单个昂贵节点池的集群。</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/5e03ddf6cbd0b2a5a6c981bf5abf5f42.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/0*p4h32PntNY0f46BG.jpg"/></div></figure><p id="dc48" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">现在，如果我们添加廉价的Spot实例池，会发生什么呢？我们可以看到，该集群现在有两个节点池，但是我们添加的那个有点不同，它有一个特殊的<a class="ae mr" href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" rel="noopener ugc nofollow" target="_blank">污点</a>。它使新的点池不可用于所有工作负载。</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ms"><img src="../Images/cb9f2411dcc29e3a2b10e21e60c54241.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yQtTRttPuXy277Hu.jpg"/></div></div></figure><p id="b167" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">一个可能的解决方案是调整我们部署的YAML文件，并添加一个<a class="ae mr" href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" rel="noopener ugc nofollow" target="_blank">容错</a>，这将允许pod被安排在受感染的节点上。</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ms"><img src="../Images/a8486ffca477c827a865e925260c3951.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uR2MDgKoMjjWevuI.jpg"/></div></div></figure><p id="ee22" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">但是，如果您不想更改部署并允许每个工作负载在廉价节点上运行，可以通过自动清除Spot实例节点来实现。为此，您需要用下面的脚本创建一个守护进程集——它将在每个节点上运行并清除污点。</p><blockquote class="mt mu mv"><p id="cd26" class="kt ku mw kv b kw kx kf ky kz la ki lb mx ld le lf my lh li lj mz ll lm ln lo im bi translated">kubernetes.azure.com/scalesetpriority-<strong class="kv jf"/></p><p id="67cb" class="kt ku mw kv b kw kx kf ky kz la ki lb mx ld le lf my lh li lj mz ll lm ln lo im bi translated"><em class="je">这样，所有pod都将能够利用Spot实例</em></p></blockquote><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ms"><img src="../Images/b5329e900fea1c5d9e7a397074c4ff49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*94eryZp2akHwoIsT.jpg"/></div></div></figure><blockquote class="mt mu mv"><p id="ee5f" class="kt ku mw kv b kw kx kf ky kz la ki lb mx ld le lf my lh li lj mz ll lm ln lo im bi translated"><strong class="kv jf"> <em class="je">与标准实例类型相比，利用Spot实例可以节省高达90%的成本。</em>T13】</strong></p></blockquote><h1 id="9f94" class="lp lq je bd lr ls lt lu lv lw lx ly lz kk ma kl mb kn mc ko md kq me kr mf mg bi translated">计划集群关闭</h1><p id="b41f" class="pw-post-body-paragraph kt ku je kv b kw mh kf ky kz mi ki lb lc mj le lf lg mk li lj lk ml lm ln lo im bi translated">开发人员是非常有弹性的人，他们可以长时间不间断地工作，只要他们的油箱里有足够的咖啡。然而，即使是最强硬的开发人员也需要休息一段时间。这就是为什么为非生产集群创建启动和关闭时间表是有益的。最简单也是最有效的策略是让集群在工作时间保持运行，在周末完全关闭。这种情况可以使用Terraform <a class="ae mr" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/monitor_autoscale_setting" rel="noopener ugc nofollow" target="_blank"> autoscale </a>资源或直接在VMSS配置页面上实现。</p><p id="fe7d" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">群集时间线可能如下所示:</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi na"><img src="../Images/b754e20e642964c03a3a203517697f93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1idKW2NmyZrznjFA.jpg"/></div></div></figure><blockquote class="mt mu mv"><p id="ae78" class="kt ku mw kv b kw kx kf ky kz la ki lb mx ld le lf my lh li lj mz ll lm ln lo im bi translated"><strong class="kv jf">测试基础设施不是每周运行168小时，而是只运行45小时。这意味着成本降低了73%。</strong></p></blockquote><h1 id="2a61" class="lp lq je bd lr ls lt lu lv lw lx ly lz kk ma kl mb kn mc ko md kq me kr mf mg bi translated">一起使用集群自动缩放和HPA</h1><p id="2d70" class="pw-post-body-paragraph kt ku je kv b kw mh kf ky kz mi ki lb lc mj le lf lg mk li lj lk ml lm ln lo im bi translated">没有人预先知道生产流量产生了多少计算能力。当您创建AKS集群时，通常使用“不要太多也不要太少”的范例来设置节点的数量。这种方法在开始时可能有效，但是随着流量的增长，应用程序需要更多的CPU和内存，您可能最终每天都要手动添加和删除节点。</p><p id="b1a0" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这是投入时间对<a class="ae mr" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" rel="noopener ugc nofollow" target="_blank">水平吊舱自动缩放器</a> (HPA)和<a class="ae mr" href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler" rel="noopener ugc nofollow" target="_blank">集群自动缩放器</a> (CA)进行适当配置的重要时刻。正确配置的HPA将保持pod实例的最佳数量，从而使您的应用程序运行良好。如果负载更高，HPA将动态添加新实例。在负载峰值之后，HPA将去掉不再需要的pod。要回答“我应该何时扩展我的应用程序”这个问题，您可以使用CPU或内存使用等基本指标。您还可以使用由Prometheus等公司提供的定制指标，并在API响应缓慢时开始扩展。另一种可能是，当Azure服务总线中存储了大量事件时，扩展部署。最后一种需要安装一个<a class="ae mr" href="https://github.com/Azure/azure-k8s-metrics-adapter" rel="noopener ugc nofollow" target="_blank">额外的适配器</a>。</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nb"><img src="../Images/a507581eabd6390ce6cacafe5cd552d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AQKn5RM0KuRQVUKu.jpg"/></div></div></figure><p id="55c8" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">HPA在单元级别工作，而群集自动缩放器在节点(虚拟机)上运行。这是一个调整Kubernetes集群规模的工具。它将监视类似“由于CPU/MEM不足而无法调度”的事件，并使用Azure API动态供应新的虚拟机。</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nb"><img src="../Images/44efe95ccf38d0a5072c4f0420799ce3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HDEo4GOpOZ3ckxLL.jpg"/></div></div></figure><p id="43d3" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">集群自动缩放和水平机架自动缩放一起为自动调整集群带来了终极解决方案。您可以只为当前需要的资源进行配置和付费。如果负载较低，集群将保持较小。如果负载增加，HPA将开始扩展单元，这将触发CA配置新节点。当风暴结束时，一切都会变小。</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nc"><img src="../Images/9a0b2603d8ad02c8aa4b3b76a3bfe426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aBGYh7QmwW2Koa83.jpg"/></div></div></figure><h1 id="24e4" class="lp lq je bd lr ls lt lu lv lw lx ly lz kk ma kl mb kn mc ko md kq me kr mf mg bi translated">使用保留实例</h1><p id="7549" class="pw-post-body-paragraph kt ku je kv b kw mh kf ky kz mi ki lb lc mj le lf lg mk li lj lk ml lm ln lo im bi translated">如果您计划让您的环境保持正常运行至少一年，那么使用保留的实例将让您不费吹灰之力就能立即降低成本。与标准价格相比，成本节约高达72%。唯一的缺点是您失去了部分灵活性——您被绑定到您预订的云提供商和实例类型(尽管预订可以应用到灵活性<a class="ae mr" href="https://docs.microsoft.com/en-us/azure/virtual-machines/reserved-vm-instance-size-flexibility" rel="noopener ugc nofollow" target="_blank">组</a>)。值得花一些时间来分析您的工作负载，并为未来几年选择最佳的实例类型。Azure为您提供取消预订的可能性，但会收取12%的额外费用。</p><p id="534f" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">下面您可以看到一个6节点AKS集群的成本节约图表，比较了按需实例与1年和3年预留的情况:</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nd"><img src="../Images/4e3c42e40cb98929e62ca0a656361ecd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*umV4Br2Ae1G95w7G.png"/></div></div></figure><p id="9d96" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">请记住，对于保留的实例，您是在为24×7的保留付费，因此对非全时运行的集群使用它是没有意义的。在您计划使用Spot实例的订阅中保留虚拟机也没有什么意义。</p><h1 id="791c" class="lp lq je bd lr ls lt lu lv lw lx ly lz kk ma kl mb kn mc ko md kq me kr mf mg bi translated">调整节点池的大小</h1><p id="257d" class="pw-post-body-paragraph kt ku je kv b kw mh kf ky kz mi ki lb lc mj le lf lg mk li lj lk ml lm ln lo im bi translated">通常情况下，一个Kubernetes集群运行不同类型的工作负载—数据库、web服务器、应用服务器等。当涉及到计算资源时，它们中的每一个都可能有完全不同的需求。数据库通常渴望内存，而应用服务器需要更多的CPU。由于资源分配不当，将所有这些工作负载置于同一类型的虚拟机中可能会导致额外的成本。例如，您可以购买8xD12s实例来分配您的所有工作负载，但是如果您仔细查看资源使用情况，您会发现您几乎利用了100%的CPU，而RAM仅利用了10%。</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ne"><img src="../Images/e5fd4d9a3c675e23286c0a9d0f6f6a5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PmLzIbL7WFgzLkpK.jpg"/></div></div></figure><p id="15c6" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">您的一些工作负载具有较高的CPU需求，因此最好将它们分配到由3个Standard_F8s_v2实例和2个d12实例组成的CPU优化节点池中。</p><figure class="mn mo mp mq gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nf"><img src="../Images/b12a40729383f64b0d7c2f8f58d8cb78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/0*cUSXrUVhTc7tOZSY.jpg"/></div></div></figure><blockquote class="mt mu mv"><p id="51d2" class="kt ku mw kv b kw kx kf ky kz la ki lb mx ld le lf my lh li lj mz ll lm ln lo im bi translated"><strong class="kv jf"> <em class="je">上面的例子节省了将近36%的成本。</em> </strong></p></blockquote><h1 id="95c2" class="lp lq je bd lr ls lt lu lv lw lx ly lz kk ma kl mb kn mc ko md kq me kr mf mg bi translated">当心额外费用</h1><p id="da50" class="pw-post-body-paragraph kt ku je kv b kw mh kf ky kz mi ki lb lc mj le lf lg mk li lj lk ml lm ln lo im bi translated">通常不考虑日志存储的成本。然而，在非常嘈杂的环境中，应用程序被设置为调试模式，它们会生成大量的日志。日志分析的成本可能会出乎你的意料。您可以为您的工作区配置每日摄入限制，以避免额外成本。但是，请小心，因为一旦达到限制，您将丢失当天剩余时间的数据。这就是为什么我们建议在开发/测试环境中设置它，以及一个<a class="ae mr" href="https://docs.microsoft.com/en-us/azure/azure-monitor/platform/manage-cost-storage#create-an-alert-when-data-collection-is-high" rel="noopener ugc nofollow" target="_blank">警报</a>来通知您何时达到极限。</p><p id="33ce" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">Azure Defender是一个很好的工具来跟踪你的集群的安全得分。它与Azure Security Center集成在一起，因此在AKS中启用它只需点击几下鼠标。但是，要知道它会产生巨大的成本。在编写Defender for AKS时，每个虚拟机内核每月的成本为2美元，因此，对于拥有100个内核的集群，成本会增加200美元。考虑使用开源工具，如<a class="ae mr" href="https://github.com/aquasecurity/kube-bench" rel="noopener ugc nofollow" target="_blank"> Kube-Bench </a>和<a class="ae mr" href="https://falco.org/" rel="noopener ugc nofollow" target="_blank"> Falco </a>。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><p id="39de" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">本指南由Zartis 的DevOps工程师Adam PAC zek撰写。</p></div></div>    
</body>
</html>