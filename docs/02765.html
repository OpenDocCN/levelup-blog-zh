<html>
<head>
<title>Using Neo4j and Cypher to reproduce São Paulo’s subway system</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Neo4j和Cypher再现圣保罗的地铁系统</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-neo4j-and-cypher-to-reproduce-s%C3%A3o-paulos-subway-system-8becec817974?source=collection_archive---------8-----------------------#2020-04-03">https://levelup.gitconnected.com/using-neo4j-and-cypher-to-reproduce-s%C3%A3o-paulos-subway-system-8becec817974?source=collection_archive---------8-----------------------#2020-04-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/></div><div class="ab cl jq jr hx js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="im in io ip iq"><p id="7430" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">大家好。今天我将写一篇短文，解释如何使用基于图形的数据库来模拟地铁系统，以及如何将其与Python集成。Github回购可以在这里访问:<a class="ae kv" href="https://github.com/lukmoda/graph-subway" rel="noopener ugc nofollow" target="_blank">https://github.com/lukmoda/graph-subway</a></p><h1 id="fffb" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">介绍</h1><h2 id="2079" class="lu kx it bd ky lv lw dn lc lx ly dp lg ki lz ma lk km mb mc lo kq md me ls mf bi translated">图表</h2><p id="d864" class="pw-post-body-paragraph jx jy it jz b ka mg kc kd ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku im bi translated">首先，快速提醒一下什么是<em class="ml">图</em>。</p><p id="97dc" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">图是由实体和连接组成的数据结构。让我们来看一些概念:</p><ul class=""><li id="7af4" class="mm mn it jz b ka kb ke kf ki mo km mp kq mq ku mr ms mt mu bi translated"><strong class="jz iu">节点:</strong>是对象，实体。可以是一个人，一座城市，一种动物；作为学习的<em class="ml">主题</em>的一切(你可以把节点想成<em class="ml">名词</em>)。节点也叫<em class="ml">顶点</em>；</li><li id="ace1" class="mm mn it jz b ka mv ke mw ki mx km my kq mz ku mr ms mt mu bi translated"><strong class="jz iu">属性:</strong>与OOP非常相似，节点可以有属性，用键值对表示。假设你有一个动物节点“狮子”。它可以具有类似{尺寸:1.8米，重量:150公斤等}的特性。；</li><li id="3b97" class="mm mn it jz b ka mv ke mw ki mx km my kq mz ku mr ms mt mu bi translated"><strong class="jz iu">关系</strong>:这表达了节点是如何连接的(你可以把它想成<em class="ml">动词</em>)。它们定义了节点之间的关系(例如，“节点A喜欢节点B，节点C和节点D住在一起，等等)。关系也叫<em class="ml">边</em>；</li></ul><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi na"><img src="../Images/ca170ca5dc94bb5498c9b36ab5252849.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ZZRB9XN3o2dv0SbKHA0jw.jpeg"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">直接取自Neo4j网站的示例。</figcaption></figure><ul class=""><li id="9c91" class="mm mn it jz b ka kb ke kf ki mo km mp kq mq ku mr ms mt mu bi translated">方向、圈和权重:这些是图的“附加”属性，用来对它们进行分类。方向只是告诉关系与哪个节点相关。类似地，连接可以有权重(你可以把它们想成节点间的<em class="ml">距离</em>)。最后，如果你能在遍历连接后回到一个节点，我们说这个图是循环的。你可能会看到一些像<em class="ml"> DAG(有向无环图)</em>这样的大词，但它们只是告诉你图是如何表现的。</li></ul><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/0bb30f5fcb30c23c5c6f8450a444f62b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*gKAtQbwp5LKid-dmcjrz-w.png"/></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">加权DAG的示例:节点(蓝色圆圈)连接有方向，没有循环，边有权重。可以看出，dag非常类似于另一种数据结构:树。</figcaption></figure><h2 id="c473" class="lu kx it bd ky lv lw dn lc lx ly dp lg ki lz ma lk km mb mc lo kq md me ls mf bi translated">Neo4j和Cypher</h2><p id="c8bc" class="pw-post-body-paragraph jx jy it jz b ka mg kc kd ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku im bi translated">Neo4j是一个面向图形的数据库。与传统的表或模式不同，实体被建模为具有节点和连接的图形。因为这是一个NoSQL数据库，所以使用一种叫做<em class="ml"> Cypher、</em>的适当的查询语言，这种语言非常简单易懂。我们将在未来进一步使用这些技术，但是你可以在Neo4j的网站上了解更多，它有很好的记录(<a class="ae kv" href="https://neo4j.com/developer/graph-database/" rel="noopener ugc nofollow" target="_blank">https://neo4j.com/developer/graph-database/</a>)。</p><p id="ad7b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">圣保罗地铁系统</strong></p><p id="6a72" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在我们来谈谈我们研究的对象。在我工作的地方(<a class="ae kv" href="https://levee.com.br/" rel="noopener ugc nofollow" target="_blank">https://levee.com.br/</a>)，我们用人工智能和人工智能来匹配合适的候选人和工作。我们的平台上注册了数百万名候选人，进行的研究表明，住得离工作地点越近的人在那个职位上成功的概率<em class="ml">更高</em>。不过，我们想更进一步，检查这个人必须经过的车站数量是否与模型相关(剧透:是的)。本文的目的不是展示我们的模型，我只是想解释什么是可能的应用。</p><p id="956b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">为了找到穿过的车站数量，我们需要首先模拟地铁系统，这…非常类似于一个图表！然后，因为我们有每个候选人和工作lat-long，我们可以计算哪个是离每个最近的地铁(即，设置开始和结束节点)，然后找到最短的路径。圣保罗的地铁系统(截至2020年初)由13条线路(分为6条线路的现代地下列车“metro”和7条线路的老式地上列车“CPTM”)组成，183个车站和371公里的延长线(<a class="ae kv" href="https://www.metrocptm.com.br/veja-o-mapa-de-estacoes-do-metro-e-cptm/" rel="noopener ugc nofollow" target="_blank">https://www . metrocptm . com . br/veja-o-mapa-de-estacoes-do-metro-e-cptm/</a>)。</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nr"><img src="../Images/f46f9ac40bcecbac4b9448177ca1faef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LJFITL9F1V2k9T1vbjNRkA.jpeg"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">圣保罗的地铁系统。你能看出它和图表有多相关吗？</figcaption></figure><h1 id="d073" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">构建图表</h1><h2 id="e1f2" class="lu kx it bd ky lv lw dn lc lx ly dp lg ki lz ma lk km mb mc lo kq md me ls mf bi translated">收集数据</h2><p id="493b" class="pw-post-body-paragraph jx jy it jz b ka mg kc kd ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku im bi translated">好吧，如果你想为你的城市建立你的解决方案，这部分可能不是真的必要，但是它真的有助于得到更好的组织。我所做的是逐行创建一个包含每个站点及其纬度的表格。它帮助我不迷路:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/53302e99ccd2bc78ccf1647c9d2fc640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*GdTvQCxGx22p5K4Hz8_jrQ.png"/></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">文件头。为你系统的每一个站做！</figcaption></figure><h2 id="7458" class="lu kx it bd ky lv lw dn lc lx ly dp lg ki lz ma lk km mb mc lo kq md me ls mf bi translated">启动Neo4j服务器</h2><p id="b9e1" class="pw-post-body-paragraph jx jy it jz b ka mg kc kd ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku im bi translated">在您的机器上安装了Neo4j之后，让我们启动并运行服务器。就这么简单:</p><pre class="nb nc nd ne gt nt nu nv nw aw nx bi"><span id="ca08" class="lu kx it nu b gy ny nz l oa ob">sudo neo4j start</span></pre><p id="46ff" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">过一会儿，服务器将在localhost:7474上可用。您应该会看到这样的屏幕:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi oc"><img src="../Images/cb46ae1cb1e555e3de0ba29d747c74b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I0H1hrTK_EYWwA1lVwlmxg.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">Neo4j本地主机web界面。</figcaption></figure><h2 id="d1ff" class="lu kx it bd ky lv lw dn lc lx ly dp lg ki lz ma lk km mb mc lo kq md me ls mf bi translated">创建节点</h2><p id="fd35" class="pw-post-body-paragraph jx jy it jz b ka mg kc kd ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku im bi translated">接下来，我们将编辑一个cypher脚本(常见的扩展有。塞弗和。cql)。在我们开始创建节点之前，我将对id进行约束:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div class="gh gi od"><img src="../Images/bd3591416242751bcabee903aec3b5dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*5XxDD6GJDG8hbbBXYHnhZw.png"/></div></figure><p id="d952" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在这里，<em class="ml"> s </em>就像是每个<em class="ml"> Station </em>对象的别名，我们设置了id必须唯一的约束。</p><p id="c6cb" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在，让我们创建我们的站节点，就像常规SQL中的一个<em class="ml">插入</em>:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi oe"><img src="../Images/8e6756be2cd8a0bfb600691b18c12156.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*16Q09ufUtFvFcFvp1HsBlA.png"/></div></div></figure><p id="502d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">每个Cypher语句都以分号结尾。创建一个节点很简单，我们只需传递关键字<strong class="jz iu"> CREATE </strong>和括号内的id以及它所代表的对象(Neo4j中称为<em class="ml"> Label </em>)。关键字<strong class="jz iu"> SET </strong>用于创建节点的属性，用逗号分隔。</p><h2 id="da3c" class="lu kx it bd ky lv lw dn lc lx ly dp lg ki lz ma lk km mb mc lo kq md me ls mf bi translated">创建关系</h2><p id="cd48" class="pw-post-body-paragraph jx jy it jz b ka mg kc kd ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku im bi translated">接下来，我们需要创建关系。在一个地铁系统里，我把这个关系叫做<strong class="jz iu">“连接”</strong>。这个过程分两部分完成:M <em class="ml"> atch </em>和<em class="ml"> Merge: </em></p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div class="gh gi of"><img src="../Images/292063b8393ddcf111228fa9c12d809d.png" data-original-src="https://miro.medium.com/v2/resize:fit:680/format:webp/1*BM_igkQhY1dwFE4dl1B_og.png"/></div></figure><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div class="gh gi og"><img src="../Images/9980c1f8317102e9340ffb9ec04f12fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:812/format:webp/1*IuOX9BWTDI15yzapFtFlDw.png"/></div></figure><p id="7a29" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">注意只有一个分号，在最后一个语句的末尾。“匹配”阶段就像一个SQL <em class="ml"> SELECT </em>，在这里您指出哪些节点(您也可以使用别名，就像在这个例子中一样)将被引用来创建边。然后，“合并”阶段有效地创建了关系。您需要传递括号中的开始节点和结束节点，以及它们之间[:verb]中的连接动词。“-”和“&gt;表示<em class="ml">方向</em>。这个图是有向的，但是你可以不用“&gt;”合并节点做一个无向图。类似地，如果你在两端都放上箭头，连接是双向的。它简单、富于表现力、优雅。</p><p id="9fc2" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">并且找出两个节点之间的最短路径？Neo4j已经有了一个方便的功能:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/224651c016d61866b57d2af51f1a6dfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*KhjVXZHqWUORj0Ew_1YLAA.png"/></div></figure><p id="ef31" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">只需传递开始和结束节点，并使用<em class="ml"> shortestPath </em>函数。如果你想返回整个路径而不是长度，返回<em class="ml">节点(p)。</em>" *..50]"是一个约束，如果路径超过50个节点，算法将停止遍历。您可以将它设置为任何值或完全禁用它，但如果您的图形非常密集，它会非常有用。</p><p id="b23b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">你可以用Cypher做更多的事情:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/fb9997e844d93f3c7991d1c3db8697a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:654/format:webp/1*JjOPEMqSxFUAm0UqzRcWyg.png"/></div></figure><p id="a505" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">还有很多很多。要获得完整的密码指南，请查看这个备忘单:<a class="ae kv" href="https://neo4j.com/docs/cypher-refcard/current/" rel="noopener ugc nofollow" target="_blank">https://neo4j.com/docs/cypher-refcard/current/</a></p><h2 id="429d" class="lu kx it bd ky lv lw dn lc lx ly dp lg ki lz ma lk km mb mc lo kq md me ls mf bi translated">运行脚本</h2><p id="f41b" class="pw-post-body-paragraph jx jy it jz b ka mg kc kd ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku im bi translated">您可以运行一个Cypher脚本或打开一个cypher-shell，直接在那里传递命令。Cypher Shell看起来是这样的:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi oj"><img src="../Images/f05837a1794589d32431d63d0dff2614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NaCBVEGO_cIxu0Uv1sz5BQ.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">您可以像普通的SQL客户端shell一样使用它，传递Cypher语句。</figcaption></figure><p id="1f07" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">或者您可以直接在终端中运行脚本:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi ok"><img src="../Images/47ca2318b2ad041ffaefb87450d99316.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jjbbgKVu_z6hVnRwzs9xRw.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">只需在来自<em class="ml"> py2neo </em>包的</figcaption></figure><p id="1aef" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">After you create all the nodes and all relationships (that’s the hard part!), you can see your graph in the web UI:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi ol"><img src="../Images/e9343acf75ae54295b348c462cdf2c82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l8TM1aR39tN6RJps9IMImQ.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">Zoomed around São Paulo’s Center, with its famous Luz Station highlighted (see its properties in the bottom left corner)</figcaption></figure><p id="284d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">The complete Graph looks like this:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi om"><img src="../Images/2a11318da8a419a719a0f03362a634b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U2gPV-FdNnuiBO5fLgVe0Q.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">Beautiful, isn’t it?</figcaption></figure><h1 id="2d72" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">Integrating with Python</h1><p id="e098" class="pw-post-body-paragraph jx jy it jz b ka mg kc kd ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku im bi translated">Now that our subway graph is done, let’s see how we can integrate it with python. Here is the simple script:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi on"><img src="../Images/d68be65b8681e5d0e7c04388b3c42b96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KK49sh2-Wxo53UTusED2BQ.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">Python script to connect with Neo4j and do Cypher queries.</figcaption></figure><p id="c8aa" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">All you need to do is instantiate a <em class="ml"> Graph </em>对象后传递您的用户名、密码和密码文件，传递服务器、用户和密码作为参数。然后将Cypher查询作为字符串传递，并使用<em class="ml"> evaluate </em>方法来检索结果。就这么简单！</p><p id="8d0f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这是我们运行脚本来查找Butant(第4行-黄色)和Tatuapé(第3行-红色)之间的桩号和路径时得到的结果:</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi oo"><img src="../Images/fe69e834fca5cbcb38f09f69d2959b44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2dt3rLwfX5GmVG821ASA2A.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">脚本的输出。</figcaption></figure><p id="d65c" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">图表、连接和查询都准备好了，创建包含求职者和工作之间的站点数量的特征的结构也准备好了！</p><h1 id="bc40" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">最后的话</h1><p id="c456" class="pw-post-body-paragraph jx jy it jz b ka mg kc kd ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku im bi translated">我希望这篇文章能帮助那些希望利用图表的力量进行分析的人。在必须构建这个特性之前，我只听说过Neo4j，并且能够快速学习和开发这个解决方案。这个数据库有很好的文档记录，可扩展，易于使用/学习，并与许多语言(如Python)集成；塞弗也没什么好害怕的。现在，当您看到一个可以用图形建模的问题时，请强烈考虑使用Neo4j和Cypher来构建您的解决方案！</p></div></div>    
</body>
</html>