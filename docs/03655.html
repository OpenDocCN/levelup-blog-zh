<html>
<head>
<title>Write Better SQL in 5 Minutes — Introduction to Dynamic SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在5分钟内编写更好的SQL—动态SQL简介</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/write-better-sql-in-5-minutes-introduction-to-dynamic-sql-3320d1eeaff6?source=collection_archive---------7-----------------------#2020-05-21">https://levelup.gitconnected.com/write-better-sql-in-5-minutes-introduction-to-dynamic-sql-3320d1eeaff6?source=collection_archive---------7-----------------------#2020-05-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="567e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过3个简单的步骤学习动态SQL</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e49db04cfdb8e61a142a72a6df10496e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OutZwj8PXH-0Tlyw"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@socialcut?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">S O C I A L C U T</a>拍摄</figcaption></figure><h1 id="527d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">动态什么？</h1><p id="eb12" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">当我在2014年左右开始接触<a class="ae ky" href="https://www.w3schools.com/sql/default.asp" rel="noopener ugc nofollow" target="_blank">结构化查询语言(SQL) </a>的时候，我记得我在互联网上搜寻例子。我会看到有人说“这使用了动态SQL”或者“这个脚本是动态的”虽然我看到了例子，但我并不真正理解使它“动态”的组件，因为我是新的。随着我在这个领域获得更多的经验，我不仅学会了构成动态SQL的三个组件，还学会了如何将它应用到各种用例中。这个简短的介绍旨在帮助SQL初学者或任何人更好地理解动态SQL的组件。</p><h1 id="6248" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">示例数据</h1><p id="02e9" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果感兴趣的话，我正在使用Kaggle上的期权市场交易数据。</p><div class="mn mo gp gr mp mq"><a href="https://www.kaggle.com/bendgame/options-market-trades" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd iu gy z fp mv fr fs mw fu fw is bi translated">期权市场交易</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">2017-2019年60k+期权交易样本</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">www.kaggle.com</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne ks mq"/></div></div></a></div><h1 id="81af" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">什么是动态SQL？</h1><p id="cf8a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">尽管它的应用可能会变得复杂，但动态SQL的定义实际上很简单:</p><p id="7163" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated"><strong class="lt iu">动态SQL </strong>是运行时构建的SQL语句。</p><p id="dc51" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">这允许您构建一个通用查询，并通过使用变量构建您需要动态执行的语句。我将在下面解构这个超级基本动态SQL的例子:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="2bce" class="np la it nl b gy nq nr l ns nt">DECLARE @dynamic_sql NVARCHAR(max)</span><span id="fc5a" class="np la it nl b gy nu nr l ns nt">select @dynamic_sql = 'select * from orderFlow'</span><span id="63e5" class="np la it nl b gy nu nr l ns nt">EXEC(@dynamic_sql)</span></pre><p id="c25b" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">与<strong class="lt iu">动态SQL </strong>相对的是<strong class="lt iu"> <em class="nv">静态SQL </em> </strong>，它是一条在运行时不会改变的SQL语句。例如:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="92f6" class="np la it nl b gy nq nr l ns nt">SELECT * FROM orderFlow</span></pre><p id="4552" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">注意到区别了吗？静态SQL既不使用execute命令运行，也不使用变量构建。</p><h1 id="a401" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">编写动态SQL的三个步骤</h1><p id="4c7e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果您想编写动态SQL，请记住三个组件:</p><ol class=""><li id="0ae1" class="nw nx it lt b lu nf lx ng ma ny me nz mi oa mm ob oc od oe bi translated"><strong class="lt iu">声明变量</strong> <br/>考虑使用变量作为SQL语句的构建块。在示例中，我声明了一个名为<strong class="lt iu"> dynamic_sql </strong>的变量，并将其数据类型设为<strong class="lt iu"><em class="nv"/></strong>。我用<strong class="lt iu"> <em class="nv"> max </em> </strong>给我最大的空间来输入一条SQL语句。</li></ol><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="a9ca" class="np la it nl b gy nq nr l ns nt">DECLARE @dynamic_sql NVARCHAR(max)</span></pre><p id="e9e4" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">2.<strong class="lt iu">构造sql字符串</strong> <br/>事实上，您可以向变量<strong class="lt iu"> dynamic_sql </strong>中输入任何您想要的SQL，这是使这个示例成为动态SQL的部分原因！因为我想返回表<em class="nv"> orderFlow </em>中的所有结果，所以我将变量设置为一个简单的select语句，该语句可以正确执行。</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="22ef" class="np la it nl b gy nq nr l ns nt">select @dynamic_sql = 'select * from orderFlow '</span></pre><p id="0ddb" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">3.<strong class="lt iu">执行SQL语句<br/> </strong>需要执行第二步构建的语句。<strong class="lt iu"> EXEC </strong>命令通常用于运行存储过程，但也可以运行任何存储为字符串的合法SQL语句，比如存储在变量<strong class="lt iu"> dynamic_sql中的语句。</strong></p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="2016" class="np la it nl b gy nq nr l ns nt">EXEC(@dynamic_sql)</span></pre><p id="5af8" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">想象一下，使用一个用户界面，该界面有一个文本字段，允许用户输入原始SQL语句，然后当用户单击run时执行该语句。我在商业智能产品中使用过类似的功能！现在您已经了解了一些动态SQL，很容易想象它在幕后是如何工作的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/59463a33cfa3682de2e563b5c6cc595f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*Tx7A_jVILSXhct7hd71I0Q.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">想象的用户界面</figcaption></figure><blockquote class="og"><p id="e1c4" class="oh oi it bd oj ok ol om on oo op mm dk translated">恭喜你！现在，您已经了解了动态SQL的3个组成部分！</p></blockquote><h1 id="44e8" class="kz la it bd lb lc ld le lf lg lh li lj jz oq ka ll kc or kd ln kf os kg lp lq bi translated">用例</h1><p id="2efa" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">很容易想到一个用例来帮助探索更多的例子:</p><p id="6042" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">假设您正在创建一个允许用户与数据交互的用户界面，但是您没有让他们编写纯SQL，而是让他们使用两个下拉列表构造一个语句:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/6a4bfbb91fbeab19eb71615b26f9e676.png" data-original-src="https://miro.medium.com/v2/resize:fit:880/format:webp/1*VMvqQvAEiUAr_l-h2ByAOg.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">虚拟用户界面2</figcaption></figure><p id="832f" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">在后台，使用存储过程和动态SQL来执行在UI中构造的SQL语句:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="9957" class="np la it nl b gy nq nr l ns nt">--Creating a Stored Procedure<br/><strong class="nl iu">CREATE PROCEDURE</strong> sp_example </span><span id="d433" class="np la it nl b gy nu nr l ns nt"> --a variable for each drop list<br/>@drop_list_1 NVARCHAR(25) = Null,<br/>@drop_list_2 NVARCHAR(50) = Null</span><span id="d7d2" class="np la it nl b gy nu nr l ns nt"><strong class="nl iu">AS</strong></span><span id="598c" class="np la it nl b gy nu nr l ns nt">--since the user selects the values, no select statement is needed<br/>--just combine the variables!</span><span id="fd4a" class="np la it nl b gy nu nr l ns nt"><strong class="nl iu">EXEC</strong>(@drop_list_1 + ' ' + @drop_list_2)</span></pre><p id="ac0c" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">注意，存储过程使用用户输入来填充这两个变量。由于在用户界面模型中已经定义了变量，所以存储过程只需要构造字符串并执行语句。我添加了一个空格，这样用户在执行过程时就不需要记住输入一个空格。例如:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/b50fe77296cc3a65b0f843c6feaeefa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/format:webp/1*2y91lwNnLt0gSXseX9iQVg.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">在Microsoft SQL Server Management studio中运行存储过程</figcaption></figure><h2 id="4ab5" class="np la it bd lb ov ow dn lf ox oy dp lj ma oz pa ll me pb pc ln mi pd pe lp pf bi translated">用例2:</h2><p id="8c57" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">假设您想使用一个存储过程来查询特定股票代码的<em class="nv"> orderFlow </em>表:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="1971" class="np la it nl b gy nq nr l ns nt">CREATE PROCEDURE sp_example2 <br/> <br/>@stock_symbol NVARCHAR(6) = Null</span><span id="44a1" class="np la it nl b gy nu nr l ns nt">AS<br/>SELECT * FROM orderFlow where sym = @stock_symbol</span></pre><p id="22fc" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">请注意，在用例2的<strong class="lt iu"> WHERE </strong>子句中使用了该变量。这样，我可以输入股票代码并获得结果，而不必一遍又一遍地使用静态查询。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/0ddd50dcbce9dfcbb6cc6c87063a9f4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*QQDmiOuMOZDaicaPIBvIFw.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">在Microsoft SQL Server Management studio中运行存储过程</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/e0e678cf71a21b95dd2510f599e42df9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*gG8RFcmydv4exrZPGIkLUg.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">sp_example2的结果</figcaption></figure><h1 id="b5de" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">动态的缺点</h1><p id="e99f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">使用动态SQL会有一些缺点。它很容易受到SQL注入的攻击，成为潜在的安全隐患。当您要求用户输入时，通常会发生SQL注入，用户输入的不是用户名之类的预期输入，而是将在数据库上运行的SQL语句，从而导致意外情况发生。SQL注入会导致严重的问题，是一种常见的黑客技术。</p><p id="0d6a" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">性能可能是另一个潜在的问题，因为执行计划不能被缓存。解决这个问题的一个方法是使用存储过程和<strong class="lt iu"> sp_executesql </strong>命令(至少在Microsoft sql server 中是<em class="nv">)。动态SQL语句会很快变得复杂，并且很难调试，这让新手望而生畏。</em></p><h1 id="9e32" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">最后的想法</h1><p id="85be" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">尽管一开始看起来有些棘手或乏味，但动态SQL是一种强大的技术，因为它允许您在运行时构造和执行SQL语句。动态SQL由三个组件组成:</p><ol class=""><li id="35d1" class="nw nx it lt b lu nf lx ng ma ny me nz mi oa mm ob oc od oe bi translated"><strong class="lt iu">声明变量</strong></li><li id="ee04" class="nw nx it lt b lu pi lx pj ma pk me pl mi pm mm ob oc od oe bi translated"><strong class="lt iu">构造SQL字符串</strong></li><li id="acc4" class="nw nx it lt b lu pi lx pj ma pk me pl mi pm mm ob oc od oe bi translated"><strong class="lt iu">执行SQL </strong></li></ol><p id="d7c9" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">可能会有一些负面影响，如使代码更难调试，但它给用户带来的灵活性可以超过顾虑，特别是在适当实现时。</p><p id="e6a7" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">如果你有兴趣学习更多关于SQL或数据科学的知识，请查看我的其他教程:</p><div class="mn mo gp gr mp mq"><a href="https://towardsdatascience.com/create-a-free-linux-virtual-machine-on-your-computer-for-data-science-projects-using-virtualbox-c862ffa7eec" rel="noopener follow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd iu gy z fp mv fr fs mw fu fw is bi translated">使用VirtualBox在您的计算机上为数据科学项目创建一个免费的Linux虚拟机…</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">跳过云，使用自己的硬件。使用Ubuntu和Oracle VirtualBox轻松免费地设置虚拟机</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">towardsdatascience.com</p></div></div><div class="mz l"><div class="pn l nb nc nd mz ne ks mq"/></div></div></a></div><h1 id="504d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">谢谢大家！</h1><ul class=""><li id="cf0a" class="nw nx it lt b lu lv lx ly ma po me pp mi pq mm pr oc od oe bi translated"><em class="nv">如果你喜欢这个，</em> <a class="ae ky" href="https://medium.com/@erickleppen" rel="noopener"> <em class="nv">关注我的Medium </em> </a> <em class="nv">了解更多</em></li><li id="0d39" class="nw nx it lt b lu pi lx pj ma pk me pl mi pm mm pr oc od oe bi translated"><a class="ae ky" href="https://erickleppen.medium.com/membership" rel="noopener"> <em class="nv">通过订阅</em> </a>获得完全访问权限并帮助支持我的内容</li><li id="8026" class="nw nx it lt b lu pi lx pj ma pk me pl mi pm mm pr oc od oe bi translated"><em class="nv">我们连线上</em><a class="ae ky" href="https://www.linkedin.com/in/erickleppen01/" rel="noopener ugc nofollow" target="_blank"><em class="nv">LinkedIn</em></a></li><li id="767b" class="nw nx it lt b lu pi lx pj ma pk me pl mi pm mm pr oc od oe bi translated"><em class="nv">用Python分析数据？查看我的</em> <a class="ae ky" href="https://pythondashboards.com/" rel="noopener ugc nofollow" target="_blank"> <em class="nv">网站</em> </a></li></ul><p id="0a80" class="pw-post-body-paragraph lr ls it lt b lu nf ju lw lx ng jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated"><a class="ae ky" href="http://pythondashboards.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="lt iu"> —埃里克·克莱本</strong> </a></p></div></div>    
</body>
</html>