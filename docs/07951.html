<html>
<head>
<title>Fixing Ubuntu 18.04's stunnel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">修复Ubuntu 18.04的漏洞</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/fixing-ubuntu-18-04s-stunnel-c1f0c29f1b27?source=collection_archive---------17-----------------------#2021-03-23">https://levelup.gitconnected.com/fixing-ubuntu-18-04s-stunnel-c1f0c29f1b27?source=collection_archive---------17-----------------------#2021-03-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8f4d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">针对已知内存泄漏的快速修复</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/02f2b6fce5bd557ab4c2699649b894d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7uXVqP3G1dElKk1vsYB2FA.png"/></div></div></figure><p id="c376" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您有运行在Ubuntu 18.04上的生产工作负载吗？你是将缓存切换到<a class="ae lq" href="https://redis.io/" rel="noopener ugc nofollow" target="_blank"> Redis </a>还是更具体地配置一个像Magento这样没有内置tls支持Redis的应用程序(据我所知)来使用<a class="ae lq" href="https://aws.amazon.com/elasticache/redis/" rel="noopener ugc nofollow" target="_blank">AWS elastic cache</a>？如果你是，你会遇到和我一样的问题，在这个Ubuntu版本中最新的<a class="ae lq" href="https://www.stunnel.org/" rel="noopener ugc nofollow" target="_blank"> stunnel </a>有一个<a class="ae lq" href="https://bugs.launchpad.net/ubuntu/+source/stunnel4/+bug/1813415" rel="noopener ugc nofollow" target="_blank">已知的内存泄漏</a>。</p><h2 id="0a8c" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">那是什么意思？</h2><p id="b4b7" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">对于那些不熟悉这个术语的人来说，<a class="ae lq" href="https://en.wikipedia.org/wiki/Memory_leak" rel="noopener ugc nofollow" target="_blank">内存泄漏</a>本质上要做的是，它不会从过去的活动中释放不需要的RAM，同时为新的活动分配更多的RAM，直到你的容器或VM不再需要使用为止；导致您的工作负载在某个时候变得完全无响应。</p><h2 id="d714" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">艰难地学习</h2><p id="b21a" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">很久以前，在一个阳光明媚的周六，我正在愉快地开发一个客户端的web应用程序，该应用程序正在切换到Redis进行缓存。我设置了stunnel，类似于AWS文档中关于如何用stunnel 连接到Redis的Elasticache的概述，还有一些我自己的调整。(<strong class="kw iu">旁注:</strong> <em class="mp"> options = NO_SSLv2 </em>不是一个有效的配置，将导致stunnel无法正常启动)在几分钟内，我就为应用程序正确设置了stunnel，使其能够通过我指定的localhost端口连接到Redis。一切都很好，对吗？嗯，没那么快！</p><p id="1b9d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">大约一两天后，一位同事联系我，告诉我运行web应用程序的docker主机关闭了。所以我对控制台进行了截图，它显示了一个充满内存不足错误的屏幕。所以我检查了日志，发现这些错误信息反复出现:</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="4cec" class="lr ls it mr b gy mv mw l mx my">stunnel: LOG4[3610]: Possible memory leak at ../crypto/asn1/asn1_lib.c:295: 318560 allocations<br/>stunnel: LOG4[3610]: Possible memory leak at ../crypto/asn1/tasn_new.c:122: 285606 allocations<br/>stunnel: LOG4[3610]: Possible memory leak at ../crypto/asn1/asn1_lib.c:327: 208706 allocations<br/>stunnel: LOG4[3610]: Possible memory leak at ../crypto/stack/stack.c:209: 80595 allocations<br/>stunnel: LOG4[3610]: Possible memory leak at ../crypto/bn/bn_lib.c:280: 59487 allocations<br/>stunnel: LOG4[3610]: Possible memory leak at ../crypto/stack/stack.c:180: 58620 allocations<br/>stunnel: LOG4[3610]: Possible memory leak at ../crypto/threads_pthread.c:29: 47845 allocations<br/>stunnel: LOG4[3610]: Possible memory leak at ../crypto/asn1/tasn_new.c:302: 43943 allocations<br/>stunnel: LOG4[3610]: Possible memory leak at ../crypto/asn1/tasn_new.c:97: 32765 allocations</span></pre><p id="796d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我不仅耗尽了内存，stunnel本身也告诉我可能存在内存泄漏。所以我开始了一次搜索，并发现了这个已知的错误。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/a8f257924c86f4a45fd1625e5ec0cf01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m00DCdSIBal_2IpBgowhIQ.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated"><a class="ae lq" href="https://bugs.launchpad.net/ubuntu/+source/stunnel4/+bug/1813415" rel="noopener ugc nofollow" target="_blank">https://bugs . launch pad . net/Ubuntu/+source/stunnel 4/+bug/1813415</a></figcaption></figure><p id="c0c1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">不幸的是，这个bug似乎不会引起维护者的注意。该漏洞于2019年初首次提交并得到确认，现在是2021年，但仍然没有新的更新。这意味着如果升级到20.04不是一个选项，我们必须自己想办法解决这个问题。</p><h2 id="6bf0" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">怎么修</h2><p id="b3c9" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">令人欣慰的是，后来的上游版本摆脱了这个bug，能够从源代码编译不需要大量的依赖搜索。我已经安装了build-essential和libssl-dev，所以我不能确认如果没有安装它们，编译是否会失败。然而，尽管如此，我所做的只是从stunnel站点下载最新的<a class="ae lq" href="https://www.stunnel.org/downloads/stunnel-5.58.tar.gz" rel="noopener ugc nofollow" target="_blank">(5.58</a>)，从源代码编译它，然后用新编译的二进制文件替换现有的二进制文件。命令的顺序如下:</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="f228" class="lr ls it mr b gy mv mw l mx my">$ sudo service stunnel4 stop<br/>$ wget <a class="ae lq" href="https://www.stunnel.org/downloads/stunnel-5.58.tar.gz" rel="noopener ugc nofollow" target="_blank">https://www.stunnel.org/downloads/stunnel-5.58.tar.gz</a><br/>$ tar -xzvf stunnel-5.58.tar.gz<br/>$ cd stunnel-5.58<br/>$ ./configure<br/>$ make<br/>$ sudo make install<br/>$ cd /usr/bin<br/>$ sudo mv stunnel /root/backup/<br/>$ sudo mv stunnel4 /root/backup/<br/>$ sudo ln -s /usr/local/bin/stunnel .<br/>$ sudo ln -s /usr/local/bin/stunnel ./stunnel4<br/>$ sudo service stunnel4 start</span></pre><p id="88f0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">就是这样！在那之后，stunnel运行得很好，没有内存泄漏，也没有由于内存不足而导致的无响应工作负载。</p></div></div>    
</body>
</html>