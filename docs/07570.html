<html>
<head>
<title>Implementing CI/CD for Containers on AWS using ECS and Jenkins</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ECS和Jenkins在AWS上为容器实施CI/CD</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/implementing-ci-cd-for-containers-on-aws-using-ecs-and-jenkins-ac1952741fcd?source=collection_archive---------4-----------------------#2021-02-24">https://levelup.gitconnected.com/implementing-ci-cd-for-containers-on-aws-using-ecs-and-jenkins-ac1952741fcd?source=collection_archive---------4-----------------------#2021-02-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/884b20567673929577a8957b077f86dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BidOoOIqUoKGce7s"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">由阿尔瓦罗·雷耶斯在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="cdcb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有一篇文章介绍了如何<a class="ae kf" href="https://medium.com/cloudadventure/implement-ci-cd-for-containers-on-aws-using-ecs-and-codepipeline-1f93e58d8b08" rel="noopener">使用ECS和CodePipeline </a>为AWS上的容器实现CI/CD。但我的经历略有不同。我们在自己的私有数据中心有一个Jenkins设置，它已经被公司使用了很长时间，不仅用于AWS，还用于其他用途，如Android build。因此，几乎没有人希望使用AWS代码管道。请允许我向您展示如何使用Jenkins而不是CodePipeline来交付您的容器。</p><h1 id="17b5" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">我们开始吧</h1><p id="0f50" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated"><strong class="ki iu">先决条件:</strong></p><p id="eb8d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">A.您的源代码包括根文件夹中的<em class="mh"> taskdef.json、Dockerfile、Jenkinsfile、appspec.yml </em>。</p><p id="6804" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">B.您正在ap-southeast-1可用性区域中运行ECS集群、ECR、服务、任务定义、S3时段和代码部署。</p><p id="ca4e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">C.确保安装了相关的Jenkins pipeline插件、<a class="ae kf" href="https://plugins.jenkins.io/docker-workflow/" rel="noopener ugc nofollow" target="_blank"> docker-workflow </a>和<a class="ae kf" href="https://plugins.jenkins.io/pipeline-aws/" rel="noopener ugc nofollow" target="_blank"> AWS pipeline </a></p><p id="79d8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">D.创建一个<code class="fe mi mj mk ml b">awsId</code> Jenkins凭证(用户名和密码)。在AWS IAM中创建一个名为Jenkins的新用户，并创建新的安全凭证。使用AWS_ACCESS_KEY_ID作为用户名，使用AWS_SECRET_KEY_ID作为密码</p><p id="85f0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">E.确保运行管道的Jenkins机器(无论是主机器还是节点机器)需要安装Docker，并且可以被Jenkins访问</p><p id="4d6f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在打开你的Jenkinsfile并开始实现你的阶段:</p><p id="064f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">阶段1 </strong> — git克隆你的项目，这样你就有了一个基础</p><pre class="mm mn mo mp gt mq ml mr ms aw mt bi"><span id="c03c" class="mu lf it ml b gy mv mw l mx my">stage('Git Clone') {<br/>      steps {<br/>        script {<br/>            git branch: master,<br/>              credentialsId: &lt;your credentials id&gt;,<br/>              url: &lt;your github url&gt;<br/>        }<br/>      }<br/>    }</span></pre><p id="9dbb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第二阶段 —开始你的docker构建</p><pre class="mm mn mo mp gt mq ml mr ms aw mt bi"><span id="358b" class="mu lf it ml b gy mv mw l mx my">stage('Docker Build') {<br/>      steps {<br/>        script {<br/>            docker.build('&lt;your-image-name&gt;')<br/>        }<br/>      }<br/>    }</span></pre><p id="ab02" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">第三阶段</strong>——将你的形象推向ECR。使用<code class="fe mi mj mk ml b">withAWS</code>命令登录</p><pre class="mm mn mo mp gt mq ml mr ms aw mt bi"><span id="6015" class="mu lf it ml b gy mv mw l mx my">stage('docker push SG') {<br/>      steps {<br/>        script {<br/>          withAWS(region: 'ap-southeast-1', credentials: 'awsId') {<br/>            sh "${ecrLogin()}"<br/>            sh "docker tag &lt;your-image-name&gt; &lt;your-ecr-uri&gt;"<br/>            sh "docker push &lt;your-ecr-uri&gt;"<br/>          }<br/>        }<br/>      }<br/>    }</span></pre><p id="4755" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">阶段4(可选)</strong> —更新您的任务定义。我只推荐这一步，如果你没有在第三步中标记你的图片，或者因为某些原因你经常改变你的<code class="fe mi mj mk ml b">taskdef.json</code>文件。</p><pre class="mm mn mo mp gt mq ml mr ms aw mt bi"><span id="81a6" class="mu lf it ml b gy mv mw l mx my">script {<br/>    withAWS(region: 'ap-southeast-1', credentials: 'awsId') {<br/>        taskDefRegistry = readJSON text: sh(returnStdout: true, script:"aws ecs register-task-definition \<br/>            --memory 4096 \<br/>            --cpu 2048 \<br/>            --task-role-arn &lt;task-role-arn&gt; \<br/>            --family &lt;task-def-name&gt; \<br/>            --network-mode awsvpc \<br/>            --requires-compatibilities EC2 FARGATE \<br/>            --cli-input-json file://taskdef.json"), returnPojo: true<br/>    }<br/>}</span></pre><p id="d6c7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">阶段5a </strong> —如果您没有为ECS服务使用CodeDeploy，那么普通的ECS更新就可以了。</p><pre class="mm mn mo mp gt mq ml mr ms aw mt bi"><span id="194c" class="mu lf it ml b gy mv mw l mx my">try {<br/>  withAWS(region: 'ap-southeast-1', credentials: 'awsId') {<br/>    def updateService = "aws ecs update-service --service &lt;your-ecs-service-name&gt; --cluster &lt;your-cluster-name&gt; --force-new-deployment"<br/>    def runUpdateService = sh(returnStdout: true, script: updateService)<br/>    def serviceStable = "aws ecs wait services-stable --service $internationalService --cluster $internationalCluster"<br/>    sh(returnStdout: true, script: serviceStable)<br/>    // put all your slack messaging here<br/>  }<br/>} catch(Exception e) {<br/>  echo e.message.toString()<br/>}</span></pre><p id="ed4e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">阶段5b </strong> —如果您使用CodeDeploy进行蓝绿色部署，那么您必须以不同的方式执行最终的Jenkinsfile阶段</p><pre class="mm mn mo mp gt mq ml mr ms aw mt bi"><span id="67ae" class="mu lf it ml b gy mv mw l mx my">try {<br/>  withAWS(region: 'ap-southeast-1', credentials: 'awsId') {<br/>    sh(returnStdout: true, script: "aws s3 cp appspec.yml s3://&lt;your-s3-bucket-name&gt;/appspec.yml")<br/>    def deploy = sh(returnStdout: true, script: "aws deploy create-deployment \<br/>    --application-name &lt;application-name&gt; \<br/>    --deployment-group-name &lt;deployment-group-name&gt; \<br/>    --s3-location bucket=&lt;your-s3-bucket-name&gt;,bundleType=yaml,key=appspec.yml")<br/>    def deployJson = readJSON text: deploy, returnPojo: true<br/>    def waitDeploy = "aws deploy wait deployment-successful --deployment-id ${deployJson['deploymentId']}"<br/>    sh(returnStdout: true, script: waitDeploy)<br/>    // your slack message here to alert you deployment is done<br/>    sh(returnStdout: true, script: "aws s3 rm s3://&lt;your-s3-bucket-name&gt;/appspec.yml")<br/>  }<br/>} catch(Exception e) {<br/>  echo e.toString()<br/>  env.ERROR_MESSAGE = e.toString()<br/>  currentBuild.result = 'FAILURE'<br/>}</span></pre><p id="60b2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，将Jenkinsfile推送到SCM源，并在Jenkins中运行管道。</p><p id="5922" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">恭喜你！！！你有一个AWS的工作詹金斯管道，享受自动化。</p><p id="246f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">注意:</strong><code class="fe mi mj mk ml b">wait</code>命令起着至关重要的作用，让你的Jenkins等到部署完成后再结束流水线。这不是强制性的，但是如果你想通过slack消息得到通知，这是一个好办法。如果不使用<a class="ae kf" href="https://mosesliao.medium.com/aws-sns-lambda-with-ms-teams-27c36f669b3" rel="noopener"> AWS SNS </a>给你更好的细粒消息是怎么回事。</p></div></div>    
</body>
</html>