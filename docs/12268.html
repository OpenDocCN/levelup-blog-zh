<html>
<head>
<title>Using python-oracledb 1.0 with SQLAlchemy, Pandas, Django and Flask</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用python-oracledb 1.0和SQLAlchemy、Pandas、Django和Flask</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-python-oracledb-1-0-with-sqlalchemy-pandas-django-and-flask-5d84e910cb19?source=collection_archive---------1-----------------------#2022-05-27">https://levelup.gitconnected.com/using-python-oracledb-1-0-with-sqlalchemy-pandas-django-and-flask-5d84e910cb19?source=collection_archive---------1-----------------------#2022-05-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/10fd266ab65e24951cca2ae74c49ea3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F61wyjujc2lFAUF_9LgeTg.png"/></div></div></figure><p id="6cba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用于Oracle数据库的Python cx_Oracle驱动程序的一个新的主要版本已经发布，并带有一个全新的名称:<a class="ae kw" href="https://oracle.github.io/python-oracledb/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> python-oracledb </strong> </a>。</p><p id="e739" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">详见<a class="ae kw" href="https://cjones-oracle.medium.com/open-source-python-thin-driver-for-oracle-database-e82aac7ecf5a" rel="noopener">发布公告</a>。</p><p id="7a34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个名称的改变对你喜欢的框架、ORM、SQL生成器和库意味着什么？驱动程序继续符合<a class="ae kw" href="https://www.python.org/dev/peps/pep-0249/" rel="noopener ugc nofollow" target="_blank"> Python数据库API v2.0规范</a>(有许多增加，只有几个排除)，因此任何框架等。那期望一个标准的驱动应该没有问题。直到每个框架等等。添加对新名称的支持，您可以在应用程序中添加几行代码来进行名称映射。请注意，一些功能，如死连接错误检测，可能无法工作，直到本机支持登陆，在这种情况下，因为一些驱动程序错误必须改变。</p><p id="f17b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里有一些调整，可以用来测试一些流行的环境。</p><h1 id="42ff" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">SQLAlchemy 1.4</h1><p id="5bd7" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><strong class="ka ir"> <em class="ma">更新:</em> </strong> <em class="ma">对python-oracledb的原生支持已经添加到即将发布的SQLAlchemy 2.0版本中，参见</em> <a class="ae kw" href="https://github.com/sqlalchemy/sqlalchemy/commit/1961e1321440a1e0500ecd13624837ed088eaceb#diff-3cfc940bb8ec8a69020c12f483a6ef4659a5f8ce5c31d2de830ad6ed5ae030e6R17" rel="noopener ugc nofollow" target="_blank"> <em class="ma">提交</em> </a> <em class="ma">和</em> <a class="ae kw" href="https://github.com/sqlalchemy/sqlalchemy/commit/1961e1321440a1e0500ecd13624837ed088eaceb#diff-d58626ed254b6d1d057fdd34e0aa8b56286406bd0be23ca7b534f9c95c4590dbR9-R41" rel="noopener ugc nofollow" target="_blank"> <em class="ma">用法说明</em> </a> <em class="ma">和本</em> <a class="ae kw" href="https://cjones-oracle.medium.com/using-the-development-branch-of-sqlalchemy-2-0-with-python-oracledb-d6e89090899c" rel="noopener"> <em class="ma">博文</em> </a> <em class="ma">。如果您使用的不是SQLAlchemy的预发布版本，请遵循下面的说明。</em></p><p id="e0b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要立即试用python-oracledb 1.0，请使用pip安装它:</p><p id="7e55" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mb mc md me b">python -m pip install oracledb</code></p><p id="0904" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后将其添加到您的顶级SQLAlchemy 1.4文件中:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="3d6c" class="mn ky iq me b gy mo mp l mq mr">import sys<br/>import oracledb<br/>oracledb.version = "8.3.0"<br/>sys.modules["cx_Oracle"] = oracledb</span></pre><p id="d8d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个片段需要在SQLAlchemy 1.4执行“导入cx_Oracle”之前出现。它启用python-oracledb的默认“瘦”模式。这是一种全新的模式，不需要任何Oracle客户端库。我们已经像这样运行了SQLAlchemy测试套件。我们非常感谢SQLAlchemy的测试广度，它在瘦模式的早期开发中帮助了我们。</p><p id="4a12" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您想使用python-oracledb的“厚”模式(它提供了更多的特性，如高级排队，参见<a class="ae kw" href="https://python-oracledb.readthedocs.io/en/latest/user_guide/appendix_a.html#featuresummary" rel="noopener ugc nofollow" target="_blank">特性列表</a>)，那么您可以添加对<code class="fe mb mc md me b">init_oracle_client()</code>的调用。我在上面显示的代码之后添加了这段代码:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="45f0" class="mn ky iq me b gy mo mp l mq mr">import os<br/>import platform<br/>if platform.system() == "Darwin":<br/>    oracledb.init_oracle_client(lib_dir=os.environ.get("HOME")+"/Downloads/instantclient_19_8")<br/>elif platform.system() == "Windows":<br/>    oracledb.init_oracle_client(lib_dir=r"C:\oracle\instantclient_19_14")<br/>else:<br/>    oracledb.init_oracle_client()</span></pre><p id="62e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Linux上，你需要调用<code class="fe mb mc md me b">init_oracle_client()</code>但不传递<code class="fe mb mc md me b">lib_dir</code>参数:在Linux上启动Python之前，你必须运行<code class="fe mb mc md me b">ldconfig</code>或设置<code class="fe mb mc md me b">LD_LIBRARY_PATH</code>。</p><p id="cd1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">python-oracledb厚模式与cx_Oracle具有相同的架构，并使用相同的Oracle客户端库堆栈。</p><p id="5d40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">SQLAlchemy中的连接与之前python-oracledb中的相同，例如:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="ee57" class="mn ky iq me b gy mo mp l mq mr">engine = create_engine(<br/>    f'oracle://{un}:{pw}@{host}:{port}/?service_name={service_name}', max_identifier_length=128<br/>)</span></pre><p id="e513" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过使用SQLAlchemy的<code class="fe mb mc md me b">connect_args</code>选项，可以有选择地使用python-oracledb中的一些新连接参数。下面是一个完整的应用程序，它设置了python-oracledb的新的单独的<code class="fe mb mc md me b">host</code>、<code class="fe mb mc md me b">port</code>和<code class="fe mb mc md me b">service_name</code>连接参数:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="f858" class="mn ky iq me b gy mo mp l mq mr">import os<br/>import oracledb<br/>import sys<br/>oracledb.version = "8.3.0"<br/>sys.modules["cx_Oracle"] = oracledb</span><span id="1569" class="mn ky iq me b gy ms mp l mq mr">from sqlalchemy import create_engine<br/>from sqlalchemy import text</span><span id="079c" class="mn ky iq me b gy ms mp l mq mr">un = os.environ.get("PYTHON_USERNAME")<br/>pw = os.environ.get("PYTHON_PASSWORD")</span><span id="5444" class="mn ky iq me b gy ms mp l mq mr">engine = create_engine(f'oracle://{un}:{pw}@',<br/>                       connect_args={<br/>                           "host": "localhost",<br/>                           "port": 1521,<br/>                           "service_name": "orclpdb"<br/>                       }<br/>         )</span><span id="bb4b" class="mn ky iq me b gy ms mp l mq mr">with engine.connect() as conn:<br/>    print(conn.scalar(text(<br/>           """SELECT UNIQUE CLIENT_DRIVER<br/>              FROM V$SESSION_CONNECT_INFO<br/>              WHERE SID = SYS_CONTEXT('USERENV', 'SID')""")))</span></pre><p id="8d8d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这表明正在使用驱动程序的精简模式:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="27a2" class="mn ky iq me b gy mo mp l mq mr">python-oracledb thn : 1.0.0</span></pre><p id="f73c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了适应<code class="fe mb mc md me b">CLIENT_DRIVER</code>列的宽度，缩写“thn”和“thk”用于表示两种驱动模式。</p><p id="3ace" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看python-oracledb <a class="ae kw" href="https://python-oracle.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank">文档</a>，了解可以传递的其他<code class="fe mb mc md me b">connect()</code>参数。</p><p id="e6ea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">更新</strong>:简介<a class="ae kw" href="https://github.com/sqlalchemy/sqlalchemy/commit/e347aa81a593252b6ee4f84a411f62f526ba0c77" rel="noopener ugc nofollow" target="_blank">中提到的死连接检测支持将在SQLAlchemy 1.4.37 </a>中登陆，但是在对python-oracledb的完全支持合并之前，您仍然需要使用名称映射片段。</p><p id="b908" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">更新</strong>:如果你也在看我在<a class="ae kw" href="https://medium.com/oracledevs/using-the-development-branch-of-sqlalchemy-2-0-with-python-oracledb-d6e89090899c" rel="noopener">上发表的关于使用SQLAlchemy 2.0(开发)和python-Oracle db for Oracle Database</a>的文章，请注意，在1.4版本中，你连接的是<code class="fe mb mc md me b">oracle://</code>，而在2.0版本中，你连接的是<code class="fe mb mc md me b">oracle+oracledb://</code>。</p><h1 id="02cb" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">熊猫</h1><p id="8317" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">由于Pandas使用SQLAlchemy，所以可以使用上面的步骤。将该代码段添加到第一个文件运行的顶部。</p><h1 id="937d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">姜戈</h1><p id="7a15" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">同样，用于SQLAlchemy的初始代码片段也可以用于Django。需要添加到<code class="fe mb mc md me b">settings.py</code>的顶部:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="c6a0" class="mn ky iq me b gy mo mp l mq mr">import sys<br/>import oracledb<br/>oracledb.version = "8.3.0"<br/>sys.modules["cx_Oracle"] = oracledb</span></pre><p id="0785" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您有Oracle客户端库，并且想要使用python-oracledb“厚”模式，您也可以调用<code class="fe mb mc md me b">init_oracle_client()</code>。</p><p id="5fa5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要连接到Oracle数据库，您的<code class="fe mb mc md me b">settings.py</code>文件连接设置将是正常的，例如:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="8ca6" class="mn ky iq me b gy mo mp l mq mr">DATABASES = {<br/>    'default': {<br/>        'ENGINE': 'django.db.backends.oracle',<br/>        'NAME': 'example.com:1521/orclpdb',<br/>        'USER': 'scott',<br/>        'PASSWORD': 'XXXX'<br/>    }<br/>}</span></pre><p id="a891" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">许多选项可以添加到简易连接字符串中，参见<a class="ae kw" href="https://download.oracle.com/ocomdocs/global/Oracle-Net-21c-Easy-Connect-Plus.pdf" rel="noopener ugc nofollow" target="_blank">简易连接加语法</a>。</p><p id="7d91" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于瘦模式下的python-oracledb，可以通过使用选项部分来选择使用新的python-oracledb连接参数。例如，要指定连接的时间限制，可以传递新的python-oracledb <code class="fe mb mc md me b">tcp_connect_timeout</code>参数，如下所示。在该示例中，作为示例，<code class="fe mb mc md me b">host</code>、<code class="fe mb mc md me b">port</code>和<code class="fe mb mc md me b">service_name</code>值也保持分开。注意服务名在<code class="fe mb mc md me b">OPTIONS</code>块中指定:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="dd18" class="mn ky iq me b gy mo mp l mq mr">DATABASES = {<br/>    'default': {<br/>            'ENGINE': 'django.db.backends.oracle',<br/>            'USER': 'scott',<br/>            'PASSWORD': 'xxx',<br/>            'HOST': 'localhost',<br/>            'PORT': 1521,<br/>            'OPTIONS': {<br/>                'service_name': 'orclpdb',<br/>                'tcp_connect_timeout': 10,<br/>            },<br/>    }<br/>}</span></pre><h1 id="c36c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">瓶</h1><p id="4144" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Flask是一个“微框架”,不强制依赖，所以你可以立即开始使用python-oracledb编写新的应用程序。查看<a class="ae kw" href="https://github.com/oracle/python-oracledb/blob/main/samples/connection_pool.py" rel="noopener ugc nofollow" target="_blank"> connection_pool.py </a>示例，它展示了如何使用带有连接池的Flask。如果您想将一个应用从cx_Oracle升级到python-oracledb，那么请查阅<a class="ae kw" href="https://python-oracledb.readthedocs.io/en/latest/user_guide/appendix_c.html#upgrading-from-cx-oracle-8-3-to-python-oracledb" rel="noopener ugc nofollow" target="_blank">升级</a>文档。</p><h1 id="c642" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">摘要</h1><p id="99c7" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">总之，您现在可以通过添加一点脚手架代码在您的应用程序中测试python-oracledb。当框架/ ORM / SQL生成器/库社区有时间添加新的“oracledb”名称空间时，就不需要这个脚手架了。</p><h1 id="7568" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">资源</h1><p id="9941" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">首页:<a class="ae kw" href="https://oracle.github.io/python-oracledb/index.html" rel="noopener ugc nofollow" target="_blank">oracle.github.io/python-oracledb</a></p><p id="99f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装说明:<a class="ae kw" href="https://python-oracledb.readthedocs.io/en/latest/user_guide/installation.html" rel="noopener ugc nofollow" target="_blank">python-oracledb.readthedocs.io/en/latest/installation.html</a></p><p id="15fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">文件:<a class="ae kw" href="https://python-oracle.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank">python-oracle.readthedocs.io/en/latest/index.html</a></p><p id="54fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">提问:<a class="ae kw" href="https://github.com/oracle/python-oracledb/discussions" rel="noopener ugc nofollow" target="_blank">github.com/oracle/python-oracledb/discussions</a></p><p id="5ce1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">源代码库:<a class="ae kw" href="https://github.com/oracle/python-oracledb" rel="noopener ugc nofollow" target="_blank">github.com/oracle/python-oracledb</a></p></div></div>    
</body>
</html>