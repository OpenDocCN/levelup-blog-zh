<html>
<head>
<title>How WhatsApp Messenger Works!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">WhatsApp Messenger是如何工作的！</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-whatsapp-messenger-works-82fc2d2188f8?source=collection_archive---------1-----------------------#2021-07-25">https://levelup.gitconnected.com/how-whatsapp-messenger-works-82fc2d2188f8?source=collection_archive---------1-----------------------#2021-07-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c2e556c1be717918b6879fc99365fc90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7VVluJLFU6qPi9O0VAq6tg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">资料来源:WhatsApp.com</figcaption></figure><p id="aee3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">WhatsApp messenger在全球拥有超过20亿用户，已经成为一个家喻户晓的名字，也是许多人的首选通讯应用。</p><p id="ecef" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这些令人印象深刻的数字引出了一个问题:“WhatsApp messenger是如何工作的？”</p><h1 id="5927" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">背景</h1><p id="7104" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">在一个小网络中，我们可以很容易地互相发送消息，一个完美的例子就是我给我的朋友迪迪发消息。这个过程非常简单，因为我们在同一个网络上，我的设备知道Dee设备的IP地址。</p><p id="5d9f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当我也想给Luvo，Langa，Fani，Bongi和Mampshika发送同样的消息时，问题就出现了。我们使用不同的网络服务，由于信任问题，他们不会共享他们的IP地址。</p><p id="62ae" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这些问题和其他没有提到的问题导致了互联网和服务器技术的产生。使用服务器并将其连接到互联网，使我们可以在不在同一个网络上的情况下共享消息，并且服务器处理IP地址问题。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi md"><img src="../Images/279c84fdd187dafa9a5ad4bddc5d1948.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1qaeWDUm5C2n8TS4MMMDfQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">资料来源:Sideteam.net</figcaption></figure><p id="6a7d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当Luvo想要发送消息给Bongi时，他的设备通过知道Bongi的设备的IP地址的服务器来完成，并且只是将消息转发给她。</p><p id="eefb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们都可以毫不费力地通过服务器相互发送消息，但WhatsApp的情况并不那么简单，一些技术问题需要解决。</p><p id="e9cb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在WhatsApp的场景中，我们都连接到多个横向扩展的消息服务器。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/c86b5106a8c3a32d7da4068e878cc2f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*4AZdzhJWCikK11d8AcO0lA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">来源:StackOverflow</figcaption></figure><p id="59a5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">横向扩展的多个服务器不足以处理WhatsApp用户的负载，因此添加了一个负载平衡器。</p><p id="010b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">负载平衡器负责根据各种参数(如服务器上的负载以及用户和服务器的会话)将请求卸载和重定向到不同的服务器。</p><p id="fd8d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">除了我们需要存储数据的负载，WhatsApp使用MnesiaDB作为其数据库管理系统，Mnesia非常有利于其在运行时可重新配置的能力。</p><h1 id="2e48" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">信息流</h1><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/2780be8fa22a4c6ea14d501b7d87b0d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LOrmAHL8GcmVjmGWhD-iOQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">来源:Twilio.com</figcaption></figure><p id="7f2b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该系统以双工连接系统为中心，这意味着消息是双向的。有不同类型的连接，即TCP，UDP，网络套接字，但最常见的是TCP。</p><p id="2594" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">回到我朋友的例子；Langa想要向Fani发送一条消息，只要Langa连接到系统，就会创建一个具有相应进程id和<a class="ae mk" href="https://www.programiz.com/dsa/queue" rel="noopener ugc nofollow" target="_blank">的进程和队列</a>。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/820faddad56d47b48291d42328748b73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*-duMPj3CXf8e4WJPrghwfw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图解说明所创建的不同流程</figcaption></figure><p id="801d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Fani还连接了一个具有相应进程ID的进程，并创建了一个队列。</p><p id="7781" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当这两个过程完成时，条目被输入数据库，显示在Langa的设备中发生了什么过程，在Fani的设备中发生了什么。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/3c41a9cc323df9e5eac3fa6c522ca26f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/format:webp/1*yPBptgZYxLjUiUI83M90eA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">说明流程和设备ID的表格</figcaption></figure><h1 id="9694" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">如果其中一个设备离线，会发生什么</h1><p id="c532" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">Fani收到了来自Langa的消息，并立即想将它转发给正在睡觉并且关机的Mampshika。</p><p id="e12a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">已经为Langa和Fani创建了一个流程，因为它们已连接到系统，但还没有为Mampshika创建流程。当Fani将消息转发给Mampshika时，负责处理Fani请求的进程在表中搜索处理Mampshika请求的进程，但什么也没有找到。</p><p id="091b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后将消息保存在数据库的附加表中。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/8a24ba1b26e788cea5bb73bb2f1eeba4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*Pvk5LOo8Cr9oiNzIBEQvew.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图示了待处理消息的附加表。</figcaption></figure><p id="0f3b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">6个小时后，Mampshika醒来，连接到WhatsApp messenger，只要他连接一个具有相应进程ID的进程，就会为他创建一个队列，处理他的所有请求。</p><p id="8285" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一旦创建了这个过程，它就开始检查数据库中是否有任何针对Mampshika的消息，一旦找到它们，它们就被转发到Mampshika的设备。</p><h1 id="c667" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">消息确认功能</h1><p id="797b" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">在整个消息传递马拉松中，我们作为用户看到了三种不同类型的刻度。</p><ul class=""><li id="1524" class="mo mp iq ke b kf kg kj kk kn mq kr mr kv ms kz mt mu mv mw bi translated">一次滴答</li></ul><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/5a7c838ccde687bececf73b7699eedd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:552/format:webp/1*J0e_iAmlyjVSkGraHypzbQ.jpeg"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">显示以一个刻度发送的消息的图表</figcaption></figure><ul class=""><li id="8aab" class="mo mp iq ke b kf kg kj kk kn mq kr mr kv ms kz mt mu mv mw bi translated">灰色的两个勾号</li></ul><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/e9cae64a46fabf512e4ca127d854ec66.png" data-original-src="https://miro.medium.com/v2/resize:fit:594/format:webp/1*tWPr4b0L2ye8OwmQa120xw.jpeg"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图示通过两个灰色勾号传递的信息</figcaption></figure><ul class=""><li id="ec34" class="mo mp iq ke b kf kg kj kk kn mq kr mr kv ms kz mt mu mv mw bi translated">蓝色的两个刻度</li></ul><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/7c61b015bfb290e8fadda4e61926cd3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*MpYFtiRdQ7P_G-12CyxpUQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图示用两个蓝色勾号表示的消息</figcaption></figure><p id="c288" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">其中一个消息服务器将为我们的设备寻找合适的连接，消息被发送到相应的设备，这用一个灰色勾号表示。</p><p id="189f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一旦我们上线，并且为我们的单个设备创建了一个流程，消息由该流程传递，那么这由两个灰色勾号指示。</p><p id="ba4f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一旦我们中的任何人阅读了我们的消息，就会向消息服务器发送一个响应，以表示来自该设备的确认。</p><h1 id="f32d" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">媒体</h1><p id="f42e" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">Mampshika读了这条消息，懒得回Fani，决定发一条语音留言。</p><p id="3513" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">语音笔记是mp3文件的形式，这是非常大的文件，会给我们的消息服务器带来压力。HTTP服务器用于处理媒体文件请求，如mp3、mp4、jpg或任何其他媒体文件。</p><p id="82ae" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">HTTP服务器有一个CDN或数据库作为它的合作者来处理这项繁重的工作。Mampshika的设备将忽略已经为轻量级消息请求建立的现有连接，并将媒体文件上传到HTTP服务器。</p><p id="45bc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一旦语音提示被上传到HTTP服务器，服务器就将一个唯一的散列作为具有媒体类型的消息返回给Mampshika的设备。该消息然后通过消息服务器被发送到Fani的设备，当Fani的设备接收到该消息时，它使用该散列从HTTP服务器下载媒体文件。</p><h1 id="ed5a" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">此外，请查看:</h1><div class="na nb gp gr nc nd"><a href="https://blog.usejournal.com/whatsapp-system-design-and-chat-messaging-architecture-part-1-29fb4f0d14af" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd ir gy z fp ni fr fs nj fu fw ip bi translated">Whatsapp系统设计和聊天消息架构(第1部分)</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">在本教程中，我们将讨论Whatsapp应用程序的设计。Whatsapp是一款基于聊天的应用。一旦你…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">blog.usejournal.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr jw nd"/></div></div></a></div><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure></div></div>    
</body>
</html>