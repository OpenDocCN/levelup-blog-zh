<html>
<head>
<title>Effective Access Control 😇</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有效的访问控制😇</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/effective-access-control-331f883cb0ff?source=collection_archive---------8-----------------------#2020-12-22">https://levelup.gitconnected.com/effective-access-control-331f883cb0ff?source=collection_archive---------8-----------------------#2020-12-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f51d83f06dbf0a3ca596f9997ba9c77f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*x6jN7svmjFxXJQLo"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@scienceinhd?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">科学高清照片</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="b3b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">访问控制是将访问权限限制在选定的一组人或系统的行为。该组被授权访问系统。为了检查一个人是否被授权访问，这个人通常必须被认证。</p><p id="63b9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我主要关注web服务。对物理系统(如笔记本电脑/全磁盘加密)的访问是另一回事。进入建筑物/尾门是另一回事。</p><p id="1446" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在访问控制的上下文中，人们通常会提到这些实体:</p><ul class=""><li id="cae3" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated"><strong class="ki iu">题材</strong>:我女朋友/奥巴马/我邻居这样的人；像国家安全局这样的组织；像Github/谷歌/脸书这样的公司；像机器人这样的软件</li><li id="3f97" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">对象</strong>:分区、文件、数据库、数据库模式、数据库表……</li><li id="4cd1" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">权限</strong>:读、写、修改/变更、删除、添加/插入、追加、输入、执行……</li></ul><p id="a3de" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">比如我女朋友有权限进我家。这种情况下，我女朋友是主语，宾语是“房子”，权利是“进入”。</p><p id="7742" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，您将了解如何破坏访问控制，不同类型的访问控制，以及一些有效访问控制的技巧。开始吧！</p></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h1 id="3949" class="lz ma it bd mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw bi translated">门禁怎么破？</h1><p id="f54d" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">在访问控制中，很多事情都可能出错，其中一些很难自动检查。这就是为什么在OWASP TOP-10 2017 中，破解访问控制(BAC)是<a class="ae kf" href="https://owasp.org/www-project-top-ten/2017/A5_2017-Broken_Access_Control" rel="noopener ugc nofollow" target="_blank">第4位的原因。</a></p><h2 id="3cd4" class="nc ma it bd mb nd ne dn mf nf ng dp mj kr nh ni mn kv nj nk mr kz nl nm mv nn bi translated">隐藏系统是不安全的</h2><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/9a8512f17948d71e6e5219194ad1b820.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RkzZtFb5kDtzEhqu"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com/@chernus_tr?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Taras Chernus </a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="8f55" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一些系统或数据不需要访问控制的(隐含)假设是一个常见的错误，因为它们从未(故意)向公众公开。我在这里想到的是AWS S3桶，人们让每个人上传。这里的想法是，人们需要知道存储桶的名称，没有人会尝试<code class="fe nt nu nv nw b">s3://company-data</code>或类似的名称。</p><p id="be5b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这方面的另一种攻击叫做<strong class="ki iu">不安全直接对象引用(IDOR) </strong>。假设你想从亚马逊下载一张发票，发现它是从<code class="fe nt nu nv nw b">https://amazon.com/invoice/1234/invoice.pdf</code>下载的。你不会好奇<code class="fe nt nu nv nw b"><a class="ae kf" href="https://amazon.com/invoice/1234/invoice.pdf" rel="noopener ugc nofollow" target="_blank">https://amazon.com/invoice/1233/invoice.pdf</a></code>包含了什么吗？很有可能这是另一个人的发票。并且可能不再执行访问控制。</p></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h2 id="08e9" class="nc ma it bd mb nd ne dn mf nf ng dp mj kr nh ni mn kv nj nk mr kz nl nm mv nn bi translated">忘记应用访问控制</h2><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nx"><img src="../Images/abb6e1582760519a9cb79190baacd98f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F7Gm_V9JJy11tuCeNmTs2A.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">谢尔盖·古特尼科夫的图片(来源:<a class="ae kf" href="https://commons.wikimedia.org/wiki/File:Gates_without_wall.jpg" rel="noopener ugc nofollow" target="_blank">维基共享</a>)</figcaption></figure><p id="2f34" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">很多后端系统有几十个路由。它们都需要应用访问控制。这取决于您的访问控制系统的实现，但是您可能需要向每个非公共的路由添加代码。这样很容易忘记。并且在一次代码审查中遗漏了它，它被遗忘了。即使所有人都同意该路由需要访问控制。</p></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h2 id="2361" class="nc ma it bd mb nd ne dn mf nf ng dp mj kr nh ni mn kv nj nk mr kz nl nm mv nn bi translated">客户端访问控制</h2><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ny"><img src="../Images/a9a472090c0fd50d983811e21f1addad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vtfvTaqe3QLcjA2v0Mh0vQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">成人内容的年龄验证是客户端访问控制的典型示例。图片由作者提供。</figcaption></figure><p id="04d2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">很久没有看到客户端的访问控制了，但是请不要忘记:访问控制需要在服务器端完成。我从未见过有效的web系统客户端访问控制。</p></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h2 id="63fb" class="nc ma it bd mb nd ne dn mf nf ng dp mj kr nh ni mn kv nj nk mr kz nl nm mv nn bi translated">信任客户</h2><p id="5e24" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">认证通常意味着用户需要输入用户名/电子邮件和密码。然后，服务器会创建一个会话或令牌来记住该用户。我们不希望用户不得不一次又一次地进行身份验证。</p><p id="fe15" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通常，至少有3个级别的用户:</p><ul class=""><li id="1d9a" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">匿名用户</li><li id="70ae" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">注册用户</li><li id="c1fe" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">管理员</li></ul><p id="52ea" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">管理员也是注册的，但是比所有其他用户有更多的特权。系统需要一种方法来区分管理员和普通用户。</p><p id="604b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有时，这是通过未签名的cookie来完成的。因此，如果用户是客户端的管理员，我们会存储这些信息。非恶意用户不会篡改这些信息，因此浏览器会在每次请求时告诉我们“我不是管理员”。但是恶意用户可以更改cookie。通过将<code class="fe nt nu nv nw b">is_admin</code> cookie从<code class="fe nt nu nv nw b">is_admin=false</code>更改为<code class="fe nt nu nv nw b">is_admin=true</code>，他们执行了<strong class="ki iu">权限提升</strong>。</p><p id="731e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有两种典型的解决方法:</p><ul class=""><li id="8560" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">对该信息进行加密签名，并在每次请求时检查签名</li><li id="f350" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">将该信息存储在服务器上，并在收到加密签名的用户id时进行查找。</li></ul><p id="b6eb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将信息存储在客户机上的好处是，您可以将一些请求保存到数据库中。</p><p id="a712" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将信息存储在服务器上的好处是，特权的丧失会立即生效。</p></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h2 id="d15f" class="nc ma it bd mb nd ne dn mf nf ng dp mj kr nh ni mn kv nj nk mr kz nl nm mv nn bi translated">缺少到期日期</h2><p id="5c92" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">想象一下:你的公司有一套员工制度。大多数员工只能看到他们的工资单，但是团队领导也可以看到他们团队的工资单。团队领导也可以奖励表现出色的员工。你是团队领导。你每天都使用那个系统，却从不注销。在某种程度上，你得到了晋升。不过，你不再是团队领导了。因此，你应该不再能够看到你的前团队的工资单。但你知道。</p><p id="a795" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果系统将授权和角色存储在客户机上永不过期的令牌中，客户机就可以永远使用该令牌。因为您的一些系统可能依赖于正确的令牌，所以它们从不检查另一个源。加密签名是正确的，因此令牌是可信的。的确如此。直到包含的信息发生变化。</p></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h2 id="4975" class="nc ma it bd mb nd ne dn mf nf ng dp mj kr nh ni mn kv nj nk mr kz nl nm mv nn bi translated">身份验证控制被破坏</h2><p id="0f68" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">如果您可以作为另一个用户进行身份验证，您将获得该用户的所有权利。这并没有真正破坏访问控制，但具有相同的效果。我将写几篇关于认证的文章:</p><ul class=""><li id="9e68" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated"><a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/password-hashing-eb3b97684636">密码哈希</a>😇</li><li id="4eda" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">多因素身份认证—尚未编写！</li><li id="1bb2" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">单点登录—它在我的列表中，伙计🤞</li><li id="24c4" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">OAuth和OpenID——你猜对了……它正在路上😅</li></ul></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h1 id="2966" class="lz ma it bd mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw bi translated">访问控制策略</h1><p id="5d1c" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">以下访问控制策略处理的问题略有不同。这里我不是在谈论具体的技术，而是许多实现使用的抽象概念。</p><h2 id="8575" class="nc ma it bd mb nd ne dn mf nf ng dp mj kr nh ni mn kv nj nk mr kz nl nm mv nn bi translated"><strong class="ak">自主访问控制(DAC) </strong></h2><p id="932a" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">您可以将所有权限正式存储为元组(主体、对象、权限)。您可以将这些元组存储为矩阵或元组列表。或者，您可以以对象为中心，存储所有主题及其权限的列表。例如，对于文件<code class="fe nt nu nv nw b">foobar.txt</code>，您可以存储<code class="fe nt nu nv nw b">Alice:read,write; Bob:read</code>。这被称为<strong class="ki iu">访问控制列表(ACL)。你也可以以主题为中心存储信息:对于每个用户，存储用户能做什么。这就是所谓的<strong class="ki iu">能力列表(C-List) </strong>。它仍然是相同的信息，但另一种数据结构。</strong></p><p id="a80e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">“自由”部分是允许用户更改对象的权限。</p><h2 id="3083" class="nc ma it bd mb nd ne dn mf nf ng dp mj kr nh ni mn kv nj nk mr kz nl nm mv nn bi translated"><strong class="ak">强制访问控制(MAC) </strong></h2><p id="7a76" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">就发展援助委员会而言，这些权利相互之间没有任何关系。这在MAC中是不一样的。对于MAC，权限的顺序是:公开</p><p id="32bf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与DAC不同，在MAC情况下，不允许用户更改权限。权限由系统管理员设置。</p><h2 id="f79f" class="nc ma it bd mb nd ne dn mf nf ng dp mj kr nh ni mn kv nj nk mr kz nl nm mv nn bi translated"><strong class="ak">基于角色的访问控制(RBAC) </strong></h2><p id="016d" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">将权限直接分配给主题可能需要大量的管理工作。相反，您可以创建一个角色，例如“团队领导”、“质量保证”、“开发人员”、“会计”、“CTO”。每个主题可以有任意数量的角色。角色拥有对象的权限。例如，对于“其他人的工资”,“CTO”角色可能有权“阅读”和“编辑”。对于给定的对象，主体的权限是用户拥有的所有角色的所有权限的集合。据我所知，所有的内容管理系统(CMS)都使用RBAC。著名的例子有维基百科、Reddit和StackExchange。</p><p id="3ee7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要应用RBAC，您需要一个<code class="fe nt nu nv nw b">role</code>表(也可以称为<code class="fe nt nu nv nw b">group</code>)和一个连接用户和组的表:</p><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/34128fc1b616399e4fe793bea69b8e86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XT6bjGvqQR9DNciLRlUXFA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</figcaption></figure><p id="498a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，您需要获得用户拥有的所有角色:</p><pre class="np nq nr ns gt oa nw ob oc aw od bi"><span id="1a58" class="nc ma it nw b gy oe of l og oh">SELECT role_id FROM role_user WHERE user_id = :current_user</span></pre><p id="b028" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可能希望缓存这个查询，因为您将会经常执行它，并且角色可能不会很快改变。</p><p id="57b2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后一个要素是为每条路线存储一个访问控制列表。在Flask中，使用<a class="ae kf" href="https://pypi.org/project/Flask-User/" rel="noopener ugc nofollow" target="_blank"> Flask-User </a>时可能是这样的:</p><pre class="np nq nr ns gt oa nw ob oc aw od bi"><span id="3b25" class="nc ma it nw b gy oe of l og oh">@app.route("/analytics", methods=["GET"])<br/>@roles_required("admin")<br/>def analytics_route():<br/>    return {"some": "analytics_data"}</span></pre><p id="a89a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当这个路径被调用时，<code class="fe nt nu nv nw b">@roles_required</code>装饰器首先执行访问控制代码。如果用户没有访问权限，其余的将被忽略，并抛出一个异常或返回一个错误响应。</p><p id="dc1b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">RBAC可以与DAC或MAC结合使用。对于web应用程序来说，对象(路由)通常有一些它们需要的固定角色。只有开发者能改变它们。它们固定在代码中，而不是数据库中。这里的装饰者<code class="fe nt nu nv nw b">@roles_required("admin")</code>是一个ACL。</p><h2 id="a3c4" class="nc ma it bd mb nd ne dn mf nf ng dp mj kr nh ni mn kv nj nk mr kz nl nm mv nn bi translated"><strong class="ak">基于属性的访问控制(ABAC) </strong></h2><p id="2239" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">RBAC缺少的一部分是背景。你想利用主体和客体之间的关系，例如，如果主体是客体的创建者，它可能会自动授予主体一些权利。或者根据时间或地点，权限可能会改变。例如，普通员工可能不允许在晚上11点至早上5点之间进入办公室。</p><p id="8f57" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们不想对数据库发出太多请求，给出有意义的错误响应，并且不重复代码。一个很好的折衷方案可能是这种模式:</p><pre class="np nq nr ns gt oa nw ob oc aw od bi"><span id="57b9" class="nc ma it nw b gy oe of l og oh">@app.route("/article/&lt;article_id&gt;", methods=["PATCH"]) # execute (1)<br/>@get_article  # execute (2)<br/>@attribute_required(is_author) # execute (3)<br/>def edit_article(article: Article): # execute (4)<br/>    ...  # update the article</span></pre><p id="994d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nt nu nv nw b">get_article</code>装饰者简单地使用了ORM:</p><pre class="np nq nr ns gt oa nw ob oc aw od bi"><span id="00e9" class="nc ma it nw b gy oe of l og oh">from typing import Any, Callable<br/>from functools import wraps</span><span id="633d" class="nc ma it nw b gy oi of l og oh">def get_article(func: Callable) -&gt; Callable:<br/>    """<br/>    Make the variable "article" available.</span><span id="eb66" class="nc ma it nw b gy oi of l og oh">    Parameters<br/>    ----------<br/>    func : Callable<br/>        Needs to have an 'article' keyword parameter.</span><span id="d28a" class="nc ma it nw b gy oi of l og oh">    Returns<br/>    -------<br/>    modified_func : Callable<br/>        A function where the parameter 'article' is added to<br/>        the signature<br/>    """<br/>    @wraps(func)<br/>    def wrapper(**kwargs: Any) -&gt; Any:<br/>        article_id = kwargs["article_id"]<br/>        article = get_article_from_db(article_id)<br/>        kwargs["article"] = article<br/>        return func(**kwargs)<br/>    return wrapper</span></pre><p id="36af" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nt nu nv nw b">is_author</code>功能非常简单:</p><pre class="np nq nr ns gt oa nw ob oc aw od bi"><span id="b6bc" class="nc ma it nw b gy oe of l og oh">def is_author(article: Article, user: User) -&gt; bool:<br/>    return article.author_id == user.id</span></pre><p id="f2c2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">更复杂的是<code class="fe nt nu nv nw b">attribute_required</code>的设计，但原则上，它的工作原理与上面的装饰器类似。</p><h2 id="0546" class="nc ma it bd mb nd ne dn mf nf ng dp mj kr nh ni mn kv nj nk mr kz nl nm mv nn bi translated">为什么有装饰师的RBAC/ABAC很棒</h2><p id="3b59" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">假设你建立了电子商务网站易贝。一个实体是拍卖。它具有各种属性:</p><ul class=""><li id="136d" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated"><strong class="ki iu">拍卖ID </strong>:由系统设定，不可修改</li><li id="0d8e" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">卖家ID </strong>:系统设置，不可修改</li><li id="66bc" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">标题</strong>:用户设置，不可修改</li><li id="c966" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">描述文本</strong>:由卖方设定，卖方可编辑</li></ul><p id="6b75" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以像这样实现<code class="fe nt nu nv nw b">change_descripion_text</code>函数:</p><pre class="np nq nr ns gt oa nw ob oc aw od bi"><span id="3452" class="nc ma it nw b gy oe of l og oh">def <!-- -->change_descripion_text(id):<br/>    auction = Auction.<!-- -->query.filter_by(Auction.id == <!-- -->id).first()<br/>    if current_user.id != auction.seller_id:<br/>        raise PermissionDeniedException("Only the seller may edit")</span></pre><p id="e269" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后您意识到管理员应该总是能够改变它:</p><pre class="np nq nr ns gt oa nw ob oc aw od bi"><span id="ef78" class="nc ma it nw b gy oe of l og oh">def <!-- -->change_descripion_text(id):<br/>    auction = Auction.<!-- -->query.filter_by(Auction.id == <!-- -->id).first()<br/>    is_seller = current_user.id == auction.seller_id<br/>    is_admin = is_admin(current_user)<br/>    if not (is_seller or is_admin):<br/>        raise PermissionDeniedException("Only the seller may edit")</span></pre><p id="5e98" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可能会意识到，你也应该检查版主。或许你也允许公司出售。因此，不仅把它放在商店里的人，而且该公司的版主也应该能够调整描述文本。然后你意识到还有元数据，比如物品的重量/体积。上面提到的访问控制有太多地方让开发人员出错。</p><p id="b64c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">相反，您可以使用角色。比如<code class="fe nt nu nv nw b">seller</code>听起来像个角色。角色可以是上下文相关的。</p><pre class="np nq nr ns gt oa nw ob oc aw od bi"><span id="bae1" class="nc ma it nw b gy oe of l og oh">@requires_role([SellerRole(id), AdminRole(), ModeratorRole()])<br/>def <!-- -->change_descripion_text(id):<br/>    auction = Auction.<!-- -->query.filter_by(Auction.id == <!-- -->id).first()</span></pre><h1 id="4cd6" class="lz ma it bd mb mc oj me mf mg ok mi mj mk ol mm mn mo om mq mr ms on mu mv mw bi translated">使访问控制有效的技巧</h1><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oo"><img src="../Images/0eb1b4cf51c7da843c34b882455f9358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qLPyfhzI9rq7ObkR"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Jaimie Harmsen 在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c888" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建web服务的例子肯定是大多数读者最感兴趣的，所以让我们把重点放在这上面。访问控制是在后端实施的，因此通常是在API级别。大多数时候是关于哪些用户可以调用哪些API端点，但有时可能会更复杂。例如，在一个社交网络中，每个用户都可以获得另一个用户的好友列表。但是如果你是那个用户的朋友，你可能只能看到他的生日。因此，一些端点可能是可调用的，但是根据调用者的不同而提供不同的数据。</p><p id="4ea4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，让我们只关注使用REST API的简单情况。如果您有权限用一组给定的参数调用端点，那么您将总是得到相同的结果。不管你是谁/你扮演什么角色。我们目前唯一关心的权利是“可以打电话”。我们的主体是“用户”，我们的对象是组合(路由、参数)。</p><p id="a713" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这种情况下，您通常会希望创建一个基于角色的系统。有一些简单的原则可以帮助你:</p><ul class=""><li id="7036" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated"><strong class="ki iu">默认拒绝</strong>:很容易在某个地方增加一条新路线。确保人们不会通过默认不允许任何访问来泄露数据。让他们写下哪些角色是允许的。</li><li id="0a5f" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">干</strong>:不要重复自己。实现一次访问控制代码，使检查变得简单，而不需要复制粘贴实现。在Python / Flask中，通常希望在函数上有一个装饰符来表示允许的角色。</li><li id="de81" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">最小特权</strong>:不要给人们不需要的角色。不要给角色他们不需要的权限。如果人们离开，就取消他们的角色——不管他们离开的是工作还是那个角色。接触的人越少，潜在的问题就越少。</li><li id="5aef" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu"> YAGNI </strong>:设计好的软件很难。一些软件工程师倾向于提前10步考虑，并为潜在的未来用例构建系统。当然，有时候你已经知道话题已经摆在桌面上了。否则，<strong class="ki iu">y</strong>ou<strong class="ki iu">a</strong>in t<strong class="ki iu">g</strong>onna<strong class="ki iu">n</strong>eed<strong class="ki iu">I</strong>t(YAGNI)。在你需要的时候制造东西。这可能意味着更多的工作和软件的重构。没关系。</li><li id="e75d" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">最大限度地减少攻击面</strong>:只要有可能，尽量删除特性和过时的代码。您删除的代码不需要维护。它不能有安全问题。</li><li id="0b7f" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">围绕权限对对象进行分组</strong>:如果您有几种类型的权限/角色，您可以围绕它们对对象进行分组。<br/>例如，如果你的对象是文件，你的角色是“所有者”、“组”、“其他”，权限是“读取”/“写入”/“执行”，那么这个分组就是一个具有Unix风格权限的目录。<br/>如果你在考虑web服务，你的对象可以是路由，权限可以是“调用”，角色可以是“匿名”、“注册”、“管理”。然后，您可以以这样一种方式组织您的代码，即没有任何文件包含匿名用户和管理员用户的路由。如果你这样做了，那么人为错误就更容易被排除。在审查中，如果一个管理员类型的路由突然出现在“普通用户”文件中，这很容易被发现。</li></ul><h1 id="6c25" class="lz ma it bd mb mc oj me mf mg ok mi mj mk ol mm mn mo om mq mr ms on mu mv mw bi translated">信用</h1><p id="a7d1" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">史蒂文·戈登很好地总结了部分术语:</p><figure class="np nq nr ns gt ju"><div class="bz fp l di"><div class="op oq l"/></div></figure><h1 id="9b2d" class="lz ma it bd mb mc oj me mf mg ok mi mj mk ol mm mn mo om mq mr ms on mu mv mw bi translated">下一步是什么？</h1><p id="d3af" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">在这个关于应用安全(AppSec)的系列文章中，我们已经解释了攻击者的一些技术😈以及防守队员的技术😇：</p><ul class=""><li id="4027" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">第1部分:<a class="ae kf" href="https://medium.com/faun/sql-injections-e8bc9a14c95" rel="noopener"> SQL注入</a>😈🐝</li><li id="599e" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">Part 2: <a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/leaking-secrets-240a3484cb80">不要泄密</a>😇</li><li id="c538" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">第3部分:<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/cross-site-scripting-xss-fd374ce71b2f">跨站点脚本(XSS) </a>😈🐝</li><li id="6b2a" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">第四部分:<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/password-hashing-eb3b97684636">密码哈希</a>😇</li><li id="0d16" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">第五部分:<a class="ae kf" href="https://medium.com/bugbountywriteup/zip-bombs-30337a1b0112" rel="noopener"> ZIP炸弹</a>😈</li><li id="3bdc" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">第六部分:<a class="ae kf" href="https://medium.com/plain-and-simple/captcha-500991bd90a3" rel="noopener">验证码</a>😇</li><li id="d825" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">第7部分:<a class="ae kf" href="https://medium.com/bugbountywriteup/email-spoofing-9da8d33406bf" rel="noopener">电子邮件欺骗</a>😈</li><li id="782c" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">第8部分:<a class="ae kf" href="https://medium.com/python-in-plain-english/software-composition-analysis-sca-7e573214a98e" rel="noopener">软件组成分析</a> (SCA)😇</li><li id="4b4c" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">第九部分:<a class="ae kf" href="https://medium.com/faun/xxe-attacks-750e91448e8f" rel="noopener"> XXE袭击</a>😈🐝</li><li id="6762" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">第10部分:有效的访问控制😇🐝</li></ul><p id="bffd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这即将到来:</p><ul class=""><li id="09dd" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">CSRF😈</li><li id="fd63" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">磁盘操作系统😈</li><li id="5ad0" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">凭据填充😈</li><li id="bcf0" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">密码劫持😈</li><li id="013a" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">单点登录😇</li><li id="7b81" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">双因素认证😇</li><li id="84fa" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">备份😇</li><li id="fbe6" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">磁盘加密😇</li></ul><p id="5df9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您对更多关于AppSec / InfoSec的文章感兴趣，请告诉我！</p></div></div>    
</body>
</html>