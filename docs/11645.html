<html>
<head>
<title>How We Reduced Our Firestore Cost by More Than 70%</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何将Firestore成本降低70%以上</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-we-reduced-our-firestore-cost-by-more-than-70-193fd3d6f8ca?source=collection_archive---------5-----------------------#2022-04-03">https://levelup.gitconnected.com/how-we-reduced-our-firestore-cost-by-more-than-70-193fd3d6f8ca?source=collection_archive---------5-----------------------#2022-04-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="324e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">开发人员应该超越编码来产生影响</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e04ed7e4fb3d3645f13621aca79c1a91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*n6wlF6s-85wf7NNp"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</figcaption></figure><p id="30b3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在创业初期，大多数开发人员或创始人往往不会以100%的效率设计他们的数据库，因为开发人员和创始人都必须赶着推出产品。</p><p id="870b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们一开始用Firebase Firestore作为我们的后端，因为成本太低，所以一开始看起来很无辜。但是当我们的用户增长时，成本呈指数增长，我们必须做些什么来削减成本。</p><p id="e711" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们做了一些重新设计。Firestore和云功能非常简单。让我们来谈谈这个:</p><h1 id="e2c3" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">写入与读取比率:</h1><p id="ddb9" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">这是我们数据库的重大更新，通过它我们可以大大降低成本。我们都知道，Firestore的计费是根据有多少文档被阅读和有多少文档被写入来计算的(其他一些次要因素，如文档的存储)。</p><p id="f4bd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们从上面的截图来看看Firestore document的读写删除定价的图表。</p><p id="150b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，让我们用一个最简单的例子。我已经为这篇文章创建了一个演示项目、一些集合和文档。</p><p id="5e93" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">假设你正在开发一个会计软件，显然你必须保存每一分钱的记录。</p><p id="c704" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">假设，在会计软件中，您将客户支付的所有货币记录保存在一个名为“CustomersMoney”的集合中，其中每个文档包含几个字段，包括“amount ”,即单个客户支付的货币金额。</p><p id="776f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了更好地理解，我创建了一个集合和一些文档。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4939e6f69894f769a70df50f8a5f4c88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*M6stnKxhbC8d1bUp"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</figcaption></figure><p id="b690" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，最有可能的是，在这个会计软件中，你必须有一个仪表板，在那里你必须显示收集的钱的总数，以及按月和按年收集的总数。比如有人想看看到2022年1月收了多少钱？</p><p id="6dca" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过查询“CustomersMoney”集合中从2022年1月1日到1月31日的所有文档，可以很容易地找到金额。</p><p id="e3c4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果文档数量没有那么大，那也没问题。您可能会认为，每100，000个文档，阅读一个文档只需要0.06美元。看起来很无辜，对吧？</p><p id="130d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是假设您有1000个客户，他们每天查看仪表板5次，一月份有500，000个文档。</p><p id="a199" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，如果您查询所有文档并计算2022年1月的总收款，那么仅是为了读取数据，Firestore就要花费您这么多:</p><p id="49df" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">1000*5*(50万/10万)* 0.06 $ = 1500 $每天！！</p><h2 id="7e66" class="mr lv it bd lw ms mt dn ma mu mv dp me lh mw mx mg ll my mz mi lp na nb mk nc bi translated">现在让我们来看看替代方案！</h2><p id="9b44" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">通过使用Firebase云函数，我们可以大大降低成本。我喜欢云Firestore触发器！这让你的工作非常顺利，让你的应用程序/网站速度更快。</p><p id="241d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但这不是今天的话题。我们以后再讨论。</p><p id="aae9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">先说省钱吧。让我们创建另一个名为“TotalCollectedSoFar”的集合，其中的文档id是月份和年份的组合，比如Jan2022。每个文档都有几个字段，包括“金额”。这个量是时间线之间的集合量。为了更好地理解，我还添加了另一个截图。</p><p id="28e7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好吧！！你可能知道Firestore触发功能。如果你不知道，你可以通过这个<a class="ae nd" href="https://firebase.google.com/docs/functions/firestore-events" rel="noopener ugc nofollow" target="_blank">链接</a>了解更多信息:</p><p id="76b4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当您创建、更新或删除特定集合中的文档时，触发函数将会触发。</p><p id="7aa2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">不是说我们写了一个触发函数。当在“CustomersMoney”集合中创建、更新或删除任何文档时，使用触发器函数，我们将更新“TotalCollectedSoFar”集合。</p><p id="849f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们来看下面的截图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/41550525b775d83c0bccddaa5242dff4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dtm1CnGfyYr9_K63"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</figcaption></figure><p id="9d47" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">假设，目前，到2022年1月收集的总资金是12000美元。现在另一个顾客已经支付了4美元。然后会调用触发函数，现在2022年1月的货币总量是12004美元。</p><p id="3dc4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，让我们计算一下你的那1000个客户的阅读成本。</p><p id="b336" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，您不必查询所有文档来计算2022年1月的总收集量。您只需阅读“TotalCollectedSoFar”集合中名为Jan2022的单个文档。</p><p id="e3c6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所以，现在对于同样的任务，成本将是:</p><p id="05f4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">1000*5*(1/100，000)* 0.06 $ = 0.003 $(用于读取)</p><p id="b9aa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是在触发器函数中，我们将有一些额外的“写成本”,用于更新2022年1月的500，000个文档的“TotalCollectedSoFar”集合。</p><p id="058c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">大约是:(500，000/100，000)*0.18美元= 0.9美元</p><p id="7a5e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在触发器函数中读取一些文档会有其他开销。但那也是很次要的。</p><p id="a551" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所以现在，总成本是:0.003+ 0.9= 1美元！！</p><p id="5771" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">比1500美元少多了，不是吗？</p><h1 id="8339" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">频繁读取和较少更改的数据:</h1><p id="e608" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">这是我们用来降低成本的另一项技术。这很简单。但是这个技术有一个要求。</p><p id="b143" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您的集合被用户频繁地大量阅读，并且不经常更改，那么您可以应用这种技术。</p><p id="e6ec" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们来讨论一个案例。假设一个新闻聚合应用程序或视频流应用程序在其主页上显示热门新闻或电影！</p><p id="fc6b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过Firebase数据包，您可以将所有这些情况的成本降至最低。有几篇关于它的文章写得很好，所以我认为把它们都重写一遍是浪费时间。</p><p id="3e69" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以从<a class="ae nd" href="https://firebase.blog/posts/2021/04/firestore-supports-data-bundles" rel="noopener ugc nofollow" target="_blank">这里</a>了解Firebase数据捆绑包，最大限度降低成本。在处理大量数据时，Firebase Data Bundle非常有用。</p><h2 id="0225" class="mr lv it bd lw ms mt dn ma mu mv dp me lh mw mx mg ll my mz mi lp na nb mk nc bi translated"><strong class="ak">我们的额外解决方案:</strong></h2><p id="531e" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">老实说，我们从来没有使用过Firebase Data Bundle，因为我们不需要处理那么多数据。</p><p id="dbab" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是我们采用了另一种方法，这种方法也非常有用，不太复杂，而且非常节省成本。我们的解决方案在很大程度上依赖于我们的移动应用。</p><p id="908f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们过去做的是智能缓存。当一个用户进入我们的系统，我们必须检查大量的收藏，如果他们目前的住所是否改变。由于解决方案是关于物业维护的，所以检查地址非常重要。但事实是用户的地址不会经常改变。也许一年一次，甚至更少。</p><p id="e9ec" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，每当用户启动我们的移动应用程序时，我们必须阅读至少10份文档。一个普通用户每天使用我们的应用2-3次，一个月50次。这意味着我们只需为进入应用程序承担500次阅读/用户。</p><p id="0b78" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后我们做了一件简单的事情。我们将所有10个文档缓存在本地内存中，并创建了另一个名为“IsAnythingChanged”的集合。在该集合中，我们使用userID作为文档ID，并且只有一个布尔字段。现在使用布尔字段，我们可以从我们的应用程序检查用户地址是否改变。</p><p id="6591" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所以现在，我们不必阅读10份文件，而只需阅读一份。所以我们的成本降低了90%。</p><p id="3c00" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果用户地址改变了，那么使用firebase云函数，我们改变了布尔字段的值。这么简单！这么有效！</p></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><p id="c8f7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="nl">感谢阅读！！这些技术简单、古老，但是有效。你削减成本的解决方案是什么？请在评论区与我们分享。</em></p></div></div>    
</body>
</html>