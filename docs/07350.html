<html>
<head>
<title>Setup Serverless Applications With AWS CloudFormation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS CloudFormation设置无服务器应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/setup-serverless-applications-with-aws-cloudformation-6042850f64d5?source=collection_archive---------7-----------------------#2021-02-11">https://levelup.gitconnected.com/setup-serverless-applications-with-aws-cloudformation-6042850f64d5?source=collection_archive---------7-----------------------#2021-02-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="ca07" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">自动气象站云形成的开始</h2><div class=""/><div class=""><h2 id="dcd9" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">使用AWS CloudFormation设置无服务器应用程序的实践指南</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/460317c6268e75c69bfc903a35a73a2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZcBG13rTgQgBoulD"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">照片由<a class="ae lh" href="https://unsplash.com/@sigmund?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank">西格蒙德</a> / <a class="ae lh" href="https://unsplash.com/?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="4830" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们了解一下CloudFormation模板，以及如何使用它们来创建无服务器应用程序。本指南非常实用，可以让你更加熟悉如何操作云生成模板。</p><p id="d26e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这是一个典型的公司/企业设置的例子。对于专业项目，开发人员通常无法访问AWS控制台中的所有功能，必须使用CloudFormation来部署基础架构更改。如果您在实践指南中遇到困难，可以在文章末尾找到完整的代码。</p><p id="53f2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果你还没有使用过无服务器应用，看看<a class="ae lh" href="https://kevinvr.medium.com/write-your-first-serverless-application-with-aws-lambda-9ff9c0f411a4" rel="noopener"> <em class="me">使用AWS Lambda </em> </a> <em class="me">编写你的第一个无服务器应用。那篇文章通过手动设置解释了无服务器应用的原因和方法。然而，本指南侧重于编写无服务器应用程序和CloudFormation模板。</em></p><h1 id="67ee" class="mf mg it bd mh mi mj mk ml mm mn mo mp ki mq kj mr kl ms km mt ko mu kp mv mw bi translated">为什么是云形成？</h1><p id="e983" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">CloudFormation是AWS的服务，用于以代码形式创建基础设施。开发人员存储一个配置文件，描述应用程序所需的所有资源，然后AWS自动为您的应用程序创建这些资源。</p><p id="6f5d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们为什么要那样做？首先，通过将您的基础设施作为代码，您可以享受git的所有优势。对基础架构的所有更改都会随时记录和备份。如果当前的基础设施中断，您可以简单地重新运行CloudFormation模板。对于手动设置，开发人员必须手动删除和重新创建应用程序的每个基础设施项目。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/7862d73b6b01a8a1556674d5e3893e89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-WKHl8_ddK1H9qMv"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">享受Git的优势。照片由<a class="ae lh" href="https://unsplash.com/@yancymin?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank">Yancy Min</a>/<a class="ae lh" href="https://unsplash.com/?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank">Unsplash</a>拍摄</figcaption></figure><h1 id="cbc2" class="mf mg it bd mh mi mj mk ml mm mn mo mp ki mq kj mr kl ms km mt ko mu kp mv mw bi translated">专业环境</h1><p id="0d7a" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">最后，在专业环境中，开发人员通常没有手动设置基础设施所需的权限。这就是CloudFormation模板派上用场的地方。它通常是这样工作的:</p><ol class=""><li id="eefe" class="nc nd it lk b ll lm lo lp lr ne lv nf lz ng md nh ni nj nk bi translated">云管理员创建一个IAM用户，拥有所需基础设施的所有必要权限。与云管理员一起，可以调整访问权限。</li><li id="77a6" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md nh ni nj nk bi translated">开发人员创建基础设施配置文件，也称为CloudFormation模板。</li><li id="0f62" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md nh ni nj nk bi translated">在许多情况下，开发人员使用CICD工具建立自动化构建和部署，将CloudFormation模板推送到AWS。</li><li id="29aa" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md nh ni nj nk bi translated">最后，CloudFormation模板使用IAM用户的凭证在AWS上运行，IAM用户是由云管理员创建的。</li></ol><p id="02b8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们将以类似的方式工作，在本指南中，我们将着重于熟悉云形成模板的操作。我们将定义我们的基础设施，用CloudFormation模板编写它，并部署它。我们走吧！</p></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><h1 id="c4ee" class="mf mg it bd mh mi nx mk ml mm ny mo mp ki nz kj mr kl oa km mt ko ob kp mv mw bi translated">创建我们的无服务器应用</h1><p id="1b3e" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">首先，我们需要一个我们想要部署的无服务器应用程序。让我们创建一个有趣的应用程序，在屏幕上画出会说话的奶牛！为此，我们将使用<a class="ae lh" href="https://www.npmjs.com/package/cowsay" rel="noopener ugc nofollow" target="_blank">考赛NPM套件</a>。</p><p id="c178" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">使用cowsay的依赖项创建package.json。别忘了跑<code class="fe oc od oe of b">npm install</code></p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">Cowsay package.json</figcaption></figure><p id="5251" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们创建应用程序的<code class="fe oc od oe of b">index.js</code>文件，我们希望在其中运行cowsay包。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">考赛指数</figcaption></figure><p id="66eb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">最后，让我们使用下面的命令在本地运行这个lambda。确保您的机器上安装了<a class="ae lh" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html" rel="noopener ugc nofollow" target="_blank"> <em class="me"> AWS SAM CLI </em> </a>。如果这对你来说是新的，看看我们以前的文章，<a class="ae lh" href="https://kevinvr.medium.com/write-your-first-serverless-application-with-aws-lambda-9ff9c0f411a4" rel="noopener"> <em class="me">编写你的第一个无服务器应用</em> </a>。</p><p id="a99b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在我们可以在命令行中运行它之前，我们还需要定义<code class="fe oc od oe of b">template.yaml</code>文件，来解释我们的lambda方法正在使用哪个运行时引擎。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">Cowsay模板. yaml</figcaption></figure><p id="6d70" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">最后，我们可以运行<code class="fe oc od oe of b">sam local invoke</code>命令在本地运行lambda。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">本地运行Lambda</figcaption></figure><p id="758a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们可以在输出中看到我们的牛！然而，这是HTML，所以在控制台上看起来不太好。一旦我们让它在我们的lambda上运行，我们就能看到我们的奶牛了！</p></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><h1 id="aa2b" class="mf mg it bd mh mi nx mk ml mm ny mo mp ki nz kj mr kl oa km mt ko ob kp mv mw bi translated">手动云形成模板</h1><h2 id="7bfa" class="oi mg it bd mh oj ok dn ml ol om dp mp lr on oo mr lv op oq mt lz or os mv iz bi translated">设置AWS Lambda函数</h2><p id="d478" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">在本指南中，我们将主要关注手动云形成设置，这样你就可以了解幕后发生了什么。如果我们立即自动化，这将是不可理解的。我们的下一个指南将解释如何用CICD自动设置。</p><p id="79b3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">转到<a class="ae lh" href="https://console.aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS控制台</a>，选择CloudFormation。我们将为我们的应用程序创建一个新的堆栈。堆栈是运行应用程序或应用程序的一部分所需的一组服务。选择<em class="me">带新资源(标准)</em>选项。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/f442b1d58191753e386bb17f2efedfe4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Y700-eVUv5ALsFCS.png"/></div></div></figure><p id="00b6" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然后，我们将选择使用设计器创建一个新的CloudFormation模板。一旦你掌握了云形成模板，你也可以开始手工制作它们。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/01db428d5f314884c4d3b1b92c05d448.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WcSTiWA6g0X8WMeb.png"/></div></div></figure><p id="8368" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">你会发现下面的屏幕出现。它看起来令人生畏，因为亚马逊有大量的服务可供选择。坚持你知道你将需要的服务，这将是好的。我们还注意到，在底部，提供了一个JSON输出。这将是你最终的云层模板。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ot"><img src="../Images/a053153706e06a988fb7d83a2ca926a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WxbJsj6anhMA3FuW.png"/></div></div></figure><p id="38f4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们把AWS Lambda资源拖到右边。在Lambda下，找到Function并将其拖到编辑器上。现在，您会注意到，一旦您按下Lambda，就会创建一个配置。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/0dace939f0ce9ed0bd54d2865459b63d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oXdZUQ2OGXwRIea_.png"/></div></div></figure><p id="41f4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然而，这个AWS Lambda的属性似乎是一个空对象<code class="fe oc od oe of b">{}</code>。要知道要填写什么，让我们去查看一下<a class="ae lh" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html" rel="noopener ugc nofollow" target="_blank"> AWS Lambda文档</a>。文档指定了哪些属性是必需的，以及它们的作用。向下滚动文档时，您还可以找到有用的示例。让我们复制他们例子的一部分。</p><p id="ee53" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">CloudFormation模板非常冗长，所以请耐心等待一会儿。你会发现你用这些东西越多，它们看起来就越不吓人。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">AWS 提供的示例配置<a class="ae lh" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html" rel="noopener ugc nofollow" target="_blank">:</a></figcaption></figure><p id="e6e5" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">首先，我们把我们的lambda的名字，改成<code class="fe oc od oe of b">cowsayLambda</code>。然后我们将需要<code class="fe oc od oe of b">Code</code>属性，在这里我们指定AWS可以在哪里找到我们的Lambda应用程序的代码。让我们将<code class="fe oc od oe of b">S3Bucket</code>的值设置为<code class="fe oc od oe of b">cowsaybucket</code>。我们还必须在CloudFormation文件中生成这个s3 bucket。可以将<code class="fe oc od oe of b">S3Key</code>设置为<code class="fe oc od oe of b">cowsay.zip</code>，它将包含我们的应用程序代码。我们还将复制<code class="fe oc od oe of b">Runtime</code>值，因为我们想要定义要在nodejs中运行的代码，将其设置为<code class="fe oc od oe of b">nodejs</code>。最后，将<code class="fe oc od oe of b">Handler</code>设置为<code class="fe oc od oe of b">index.handler</code>。这意味着lambda将运行<code class="fe oc od oe of b">index.js</code>文件中的<code class="fe oc od oe of b">handler</code>方法。</p><p id="bc28" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们现在应该有一个类似下面的配置，这是Lambda的一个好的开始。</p><p id="f8e7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><em class="me">专业提示:如果你想美化你的JSON模板，按下YAML按钮，回到JSON视图。亚马逊会自动美化。如果您喜欢以YAML格式编写配置，也可以反过来使用。</em></p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">考赛拉姆达配置</figcaption></figure><h1 id="8241" class="mf mg it bd mh mi mj mk ml mm mn mo mp ki mq kj mr kl ms km mt ko mu kp mv mw bi translated">为Lambda创建IAM角色</h1><p id="3acc" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">Lambda需要定义一个IAM执行角色。lambda将在运行时承担此角色，并将拥有相关的权限。对于我们的lambda，我们不需要任何特定的权限。让我们设置一个默认的IAM角色，然后我们可以在Lambda配置中引用它。将IAM:Role项拖到可视编辑器上，并将其更新为以下模板。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">来自<a class="ae lh" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/quickref-lambda.html" rel="noopener ugc nofollow" target="_blank"> AWS </a>的IAM角色示例</figcaption></figure><p id="b0eb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">该模板来自AWS文档中的一个示例。它创建Lambda可以承担的IAM角色，并授予对日志的访问权限，以防Lambda创建日志。</p><p id="9d14" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在我们需要更新Lambda上的角色，以使用这个新的IAM角色。将以下配置添加到Lambda函数的属性中。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">将该属性添加到我们之前创建的Lambda函数中。</figcaption></figure><h1 id="520e" class="mf mg it bd mh mi mj mk ml mm mn mo mp ki mq kj mr kl ms km mt ko mu kp mv mw bi translated">S3水桶的创作</h1><p id="b39c" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">我们在Lambda配置中指定了一个名为<code class="fe oc od oe of b">cowsaybucket</code>的S3桶。让我们将一个S3桶拖到我们的可视化编辑器中。打开<code class="fe oc od oe of b">S3</code>并将一个<code class="fe oc od oe of b">Bucket</code>拖到编辑器上。点击它，编辑属性将其重命名为<code class="fe oc od oe of b">cowsaybucket</code>。在可视化编辑器中的Lambda函数上找到一个粉红色的圆圈。将它拖向存储桶以创建一个依赖项。Lambda不能在没有Bucket的情况下运行，因为Bucket将包含代码。请注意，当您将箭头拖向桶时，桶必须亮起粉红色，以创建依赖关系链接。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ou"><img src="../Images/28deb9692b7ecf8b536babf0b9362fc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HkDADusYygmnzpEH.png"/></div></div></figure><p id="5ff2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在，我们可以设置S3存储桶属性，单击存储桶，让我们前往<a class="ae lh" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html" rel="noopener ugc nofollow" target="_blank">亚马逊S3云信息文档页面</a>。我们可以再找一个用法的例子。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">来自<a class="ae lh" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html" rel="noopener ugc nofollow" target="_blank"> AWS文件</a>的S3铲斗配置示例:</figcaption></figure><p id="ebf4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们不需要那个特定的删除策略，但是其余的可以保持不变。我们将不得不添加<code class="fe oc od oe of b">BucketName</code>属性。设置为<code class="fe oc od oe of b">cowsaybucket</code>。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">考赛S3铲斗配置</figcaption></figure><h1 id="18c8" class="mf mg it bd mh mi mj mk ml mm mn mo mp ki mq kj mr kl ms km mt ko mu kp mv mw bi translated">授予S3访问权限</h1><p id="d8c9" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">我们有自己的Lambda和bucket，但是Lambda还不能访问Bucket上的文件。让我们更新我们的S3桶的策略，允许lambda从桶中检索应用程序代码。<a class="ae lh" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-template-publishing-applications.html" rel="noopener ugc nofollow" target="_blank">AWS文档</a>对此有一个示例政策描述。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">兰达斯和S3的BucketPolicy示例</figcaption></figure><p id="10ab" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们将需要一个类似的政策为我们的水桶。让我们将一个S3 BucketPolicy拖到我们的可视化编辑器中。我们最终的<code class="fe oc od oe of b">BucketPolicy</code>看起来类似于下面的。如果调用资源的标识符ARN和Lambda是同一个ARN，我们就定义了对<code class="fe oc od oe of b">cowsaybucket</code>资源的访问。可视化编辑器中会自动出现一个与存储桶相关的箭头。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">考赛S3存储桶策略配置</figcaption></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/4a9d5bd43c8d7378c859fe12dd5643d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1NICO8rRVY330koF.png"/></div></div></figure><h1 id="478a" class="mf mg it bd mh mi mj mk ml mm mn mo mp ki mq kj mr kl ms km mt ko mu kp mv mw bi translated">重构云信息模板</h1><p id="794a" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">在这一点上，我们完整的CloudFormation模板看起来非常好！然而，还有一个问题。我们的Lambda正在等待一个S3桶，检查。这个Lambda期望在S3桶中有一个名为cowsay.zip的文件。以下是失败的原因。它将试图找到lambda的源代码并创建一个错误。</p><p id="f96f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">问题是，在为Lambda的属性检索源代码之前，源代码不存在于S3存储桶中。我们可以通过首先创建S3桶，然后上传源代码，最后运行第二个CloudFormation堆栈来创建Lambda来解决这个问题。我们可以将此视为一个3步流程。</p><ol class=""><li id="76f4" class="nc nd it lk b ll lm lo lp lr ne lv nf lz ng md nh ni nj nk bi translated">运行云形成堆栈以创建S3桶</li><li id="44f7" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md nh ni nj nk bi translated">把我们Lambda的源代码上传到S3桶</li><li id="4f01" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md nh ni nj nk bi translated">运行第二个CloudFormation堆栈来创建Lambda</li></ol><p id="a7d7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">同样有趣的是，我们可以在可视化编辑器底部的<code class="fe oc od oe of b">template</code>选项卡上找到完整的云信息模板。这是一个包含我们定义的所有资源的模板。</p><h1 id="05ff" class="mf mg it bd mh mi mj mk ml mm mn mo mp ki mq kj mr kl ms km mt ko mu kp mv mw bi translated">创建S3桶堆栈</h1><p id="d2e0" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">让我们首先创建一个名为<code class="fe oc od oe of b">cowsay-bucket</code>的新堆栈。在这个堆栈中，我们将只定义S3存储桶。将以前的S3存储桶属性复制到其中。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">考赛S3铲斗配置</figcaption></figure><p id="8c3d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在可视编辑器中，点击创建堆栈。然后，继续直到它被创建。它会提示输入一个栈名，姑且称之为<code class="fe oc od oe of b">cowsay-bucket</code>。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ou"><img src="../Images/baa01eca598a2d2f16c29d2d5796134b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WzssQsEaoM0V8ev4.png"/></div></div></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/6b0269672da07ba2a5d5afebd8d18968.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*06OyJQQ9DGQidHJN.png"/></div></div></figure><p id="865c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在堆栈事件中，您将能够找到堆栈创建的状态。应该是<code class="fe oc od oe of b">CREATE_COMPLETE</code>。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ov"><img src="../Images/74716c039cdd54c332243d27aa83d3c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SvYUFR5JBBtDaj6h.png"/></div></div></figure><p id="49ef" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们的S3存储桶应该已经创建好并可以使用了！</p><h1 id="43db" class="mf mg it bd mh mi mj mk ml mm mn mo mp ki mq kj mr kl ms km mt ko mu kp mv mw bi translated">部署Lambda应用程序源代码</h1><p id="5829" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">我们已经有了之前开发的cowsay应用程序的源代码。让我们将这段代码部署到S3桶中。AWS SAM CLI提供了一些命令来自动压缩源代码并将其上传到S3存储桶。这一次，让我们手动操作，这样您就可以了解幕后发生了什么。</p><p id="9c4a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">压缩源文件夹中的所有文件。(!)确保不要压缩包含源代码的文件夹，因为这将不起作用。对于我们当前的配置，AWS希望index.js文件位于源代码包的根目录下。调用压缩文件<code class="fe oc od oe of b">cowsay.zip</code>，如我们的Lambda <code class="fe oc od oe of b">S3Key</code>属性中所定义的。</p><p id="8d86" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们使用AWS控制台前往S3桶。将cowsay.zip文件上传到您的cowsay S3存储桶的根目录。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ow"><img src="../Images/175a5f8fdf5ce2150f2546c1988386c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HW5noTMsg8wWgXVF.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">将cowsay.zip上传到cowsay S3桶</figcaption></figure><h1 id="c525" class="mf mg it bd mh mi mj mk ml mm mn mo mp ki mq kj mr kl ms km mt ko mu kp mv mw bi translated">创建λ函数堆栈</h1><p id="a5f5" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">我们的代码是可用的，并准备好为我们的Lambda运行！让我们为Lambda创建一个新的CloudFormation堆栈。前往CloudFormation堆栈设计器。将S3:BucketPolicy、Lambda:Function和IAM:Role对象拖到编辑器上。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ox"><img src="../Images/2d62e32fbaf0400b02e6ddd0a147dfe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-xSoQe6UoMwV_4K2.png"/></div></div></figure><p id="2026" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如前所述，按下Create stack按钮并按照步骤操作，直到创建好为止。调用堆栈<code class="fe oc od oe of b">cowsay-lambda</code>。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/6a540f7d16ae0db1ea8d6a963754c2f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Bqp8ySiMwN5o0tI5.png"/></div></div></figure><p id="a3c8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们现在可以转到AWS控制台中的Lambda，找到cowsay Lambda并进行测试调用。这应该会像预期的那样工作。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/ea4741beb3ad821fb1aa7f66ba3367e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tYKF0KK8z4YmESZw.png"/></div></div></figure><p id="10dd" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">那看起来确实很棒！但是我们的Lambda的URL在哪里呢？默认情况下，Lambdas没有URL。相反，我们需要在AWS上设置一个API网关，它将路由到我们的Lambda函数。我们的下一个指南将是关于API网关的实践，如何手动设置它们，以及如何使用CloudFormation。</p></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><h1 id="8543" class="mf mg it bd mh mi nx mk ml mm ny mo mp ki nz kj mr kl oa km mt ko ob kp mv mw bi translated">摘要</h1><p id="d352" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">CloudFormation模板是用文本而不是手动配置基础设施的非常冗长的方式。这使得自动化基础架构或创建多个相似的基础架构变得更加容易。接下来，可以将模板提交给Git，以享受版本控制系统的优势。</p><p id="e59b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">开发人员通常无法在专业环境中手动创建基础设施，这正是CloudFormation派上用场的地方。它甚至可以用于为CICD构建和部署计划创建自动化管道。</p><p id="b357" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">要设置CloudFormation模板，AWS文档页面很有用，它解释了需要哪些属性以及如何配置它们。</p></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><h1 id="ffa2" class="mf mg it bd mh mi nx mk ml mm ny mo mp ki nz kj mr kl oa km mt ko ob kp mv mw bi translated">完整的应用程序代码</h1><p id="85b0" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">如果你在操作指南中遇到困难，你可以在下面找到完整的应用程序代码。</p><h2 id="5192" class="oi mg it bd mh oj ok dn ml ol om dp mp lr on oo mr lv op oq mt lz or os mv iz bi translated">应用代码</h2><p id="e62c" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated"><strong class="lk jd">。/package.json </strong></p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="0943" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd">。/index.js </strong></p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div></figure><h2 id="5be5" class="oi mg it bd mh oj ok dn ml ol om dp mp lr on oo mr lv op oq mt lz or os mv iz bi translated">S3桶形烟囱</h2><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div></figure><h2 id="3530" class="oi mg it bd mh oj ok dn ml ol om dp mp lr on oo mr lv op oq mt lz or os mv iz bi translated">λ堆栈</h2><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="og oh l"/></div></figure><h1 id="08e6" class="mf mg it bd mh mi mj mk ml mm mn mo mp ki mq kj mr kl ms km mt ko mu kp mv mw bi translated">资源</h1><ul class=""><li id="12c8" class="nc nd it lk b ll mx lo my lr oy lv oz lz pa md pb ni nj nk bi translated"><a class="ae lh" href="https://itnext.io/write-your-first-serverless-application-with-aws-lambda-9ff9c0f411a4" rel="noopener ugc nofollow" target="_blank">编写你的第一个无服务器应用</a></li><li id="da98" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md pb ni nj nk bi translated"><a class="ae lh" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html" rel="noopener ugc nofollow" target="_blank">云形成文件</a></li><li id="aa6b" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md pb ni nj nk bi translated"><a class="ae lh" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html" rel="noopener ugc nofollow" target="_blank"> S3:铲斗文件</a></li><li id="9d13" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md pb ni nj nk bi translated"><a class="ae lh" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-policy.html" rel="noopener ugc nofollow" target="_blank"> S3:桶政策文件</a></li><li id="bf5a" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md pb ni nj nk bi translated"><a class="ae lh" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html" rel="noopener ugc nofollow" target="_blank">λ:函数文档</a></li><li id="79cf" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md pb ni nj nk bi translated"><a class="ae lh" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html" rel="noopener ugc nofollow" target="_blank"> IAM:角色文档</a></li></ul></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><p id="ef59" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><a class="ae lh" href="https://kevinvr.medium.com/membership" rel="noopener">订阅我的媒体</a>到<strong class="lk jd">解锁</strong> <strong class="lk jd">所有</strong> <strong class="lk jd">文章</strong>。通过使用我的链接订阅，你是支持我的工作，没有额外的费用。你会得到我永远的感激。</p></div></div>    
</body>
</html>