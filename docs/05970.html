<html>
<head>
<title>Automating video editing with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python自动编辑视频</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/automating-video-editing-with-python-2de5f574d0ff?source=collection_archive---------5-----------------------#2020-10-15">https://levelup.gitconnected.com/automating-video-editing-with-python-2de5f574d0ff?source=collection_archive---------5-----------------------#2020-10-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b275" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">结合ffmpeg和Vimeo的API的力量，以令人难以置信的速度制作视频。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0066d337b76d9e314a35f79e8d9d09ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7ygDXs6-1cR-U4nE"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">沙哈达特·拉赫曼在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="d1ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我最近不得不解决一个自动化问题，客户希望自动生成数百个视频，将一个“基本视频”与从数百个视频列表中挑选的视频放在一起。虽然这可以很容易地用手工完成，但这个项目是一个正在进行的项目，生成的视频数量每天都在增长。出于这个原因，我决定使用Python和ffmpeg编写一个小脚本，自动生成这些视频并上传到客户端的Vimeo频道。</p><p id="cc21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇短文旨在关注自动化、视频编辑和Vimeo的API的一些特定方面，因此我不会在Python基础知识上花费任何时间。我将把重点放在我发现具有挑战性并且我认为分享起来很有趣的一些点点滴滴上。</p><h1 id="8a5b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">准备</h1><p id="6f92" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在自动化作业中，准备工作是必不可少的，尤其是当您试图从文件本身获取信息时。出于这个原因，我为脚本将要处理的视频文件设置了一些基本规则，并要求这些规则符合<em class="ms"/>。文件命名的最终决定如下:</p><p id="53a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ms">index _ artist name _出处. extension </em></p><p id="8aab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了这三条简单的信息，我就能够跟踪已经生成的视频，并使用提供的元数据在Vimeo上定制标题和描述。我使用下划线作为数据分隔符，然后在需要时使用存储在列表中的整齐分隔的数据。</p><h2 id="4a95" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">问题</h2><p id="e1f1" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">有两件事我在开始时没有考虑到，结果在尝试了几次后被添加到准备步骤中。</p><p id="562b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">1.由于ffmpeg是通过<em class="ms"> os.system </em> Python模块使用的(原因解释如下)，我很快意识到重音字母在脚本的ffmpeg阶段引起了问题。通过在zsh配置文件中<a class="ae ky" href="https://superuser.com/questions/583031/how-can-i-get-zsh-to-display-international-characters-properly" rel="noopener ugc nofollow" target="_blank">启用UTF-8解决了这个问题。</a></p><p id="17fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2.视频的堆叠要求视频长度完全相同(完美的帧)。出于这个原因，所有最初符合11分43秒的视频都必须进行修改，并增加2帧，以避免ffmpeg中的<a class="ae ky" href="https://video.stackexchange.com/questions/20958/ffmpeg-dropping-duplicate-frames" rel="noopener ugc nofollow" target="_blank"> <em class="ms">重复帧</em> </a>错误。这是因为原始的基础视频<em class="ms">实际上是</em> 11分43秒2帧长。</p><h1 id="da3c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">剧本</h1><p id="5f3f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">该脚本实际上是一个非常简单的文件夹迭代，它遍历两个特定文件夹中的所有文件，并使用ffmpeg生成一个视频。一旦视频生成，它就被保存并通过它的API上传到Vimeo。虽然文件夹迭代没有什么奇特或值得注意的地方</p><p id="86ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ms">对于os.walk中的根、目录、文件(文件夹):</em></p><p id="0446" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事情的ffmpeg方面有一些有趣的方面值得分析。</p><h1 id="6daa" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">ffmpeg</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">返回语句被输入到os.system以接入ffmpeg的简要概述。</figcaption></figure><p id="97ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ms">注意:决定通过os.system使用ffmpeg，而不是使用</em> <a class="ae ky" href="https://github.com/kkroening/ffmpeg-python" rel="noopener ugc nofollow" target="_blank"> <em class="ms"> ffmpeg的python绑定</em> </a> <em class="ms">，以避免该项目的开源和社区维护性质的潜在问题。虽然python绑定似乎得到了很好的记录和支持，但我还是选择了官方的ffmpeg库。这主要是因为脚本必须是面向未来的，并且由非开发人员使用。</em></p><p id="d849" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于需要在视频上执行一系列操作，我决定使用ffmpeg的filter_complex参数，虽然稍微复杂一些<em class="ms"/>(双关语)，但允许更高级别的控制。</p><p id="c9b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ffmpeg的filter complex在这样的假设下工作:我们传递一些变量(在本例中是视频)作为输入，在对它们执行一个动作后，我们为要输出的变量分配一个新的名称。这是理解视频是如何被编辑和传播的关键，并使链接效果变得非常容易。</p><h2 id="a3f9" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">规模</h2><p id="040b" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">首先，视频需要缩放。脚本处理的所有视频都是全高清(1920 x 1080像素)或<em class="ms">垂直</em>全高清(1080 x 1920像素)。考虑到我们已经讨论过最终的视频应该看起来像下面的图片，我使用缩放功能将视频的宽度缩小到884像素(对于水平视频，垂直视频使用了不同的比例)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/e32ca3c59cbe11d880697dd213bda111.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q36jeOuUh6NnRyj--FT9pA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">水平和垂直输入的视频组合布局。</figcaption></figure><h2 id="a6ec" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">衬垫</h2><p id="1832" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">即使缩放和hstacking足以生成所需的视频，这也意味着在Vimeo上打开视频而不完全屏蔽播放器会导致视频形状怪异:非常宽，与视频高度一样高。因为客户希望视频总是用黑边填充，所以在合并视频之前，我分别用黑边填充。这些黑色边距使得每个视频宽960像素，高1080像素:正好是全高清帧的一半。填充功能的第二部分将视频精确地放置在填充区域的中心。</p><h2 id="9297" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">HStack</h2><p id="bae7" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Hstacking是我发现的并排放置两个视频的最简单的方法。不需要太多解释。给定两个或更多的输入，它在一个文件中一个接一个地输出它们。h代表<em class="ms">水平</em>堆叠，垂直堆叠见<a class="ae ky" href="https://ffmpeg.org/ffmpeg-filters.html#vstack" rel="noopener ugc nofollow" target="_blank"> vstack </a>。</p><h2 id="3919" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">塞特萨尔</h2><p id="ccf6" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">最后，最后但同样重要的是，我必须对最终的视频合成使用setsar函数，以避免出现怪异的纵横比(我一直得到宽度短1个像素的最终视频)。setsar滤镜“为滤镜输出视频设置样本(即像素)纵横比”。</p><p id="afae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个主要代码块负责合成视频的生成，然后将合成视频传递给Vimeo API进行上传。根据视频输入是水平的还是垂直的，以及视频中出现的艺术家是歌手还是舞者，调用这个特定代码块的不同迭代。艺术家的类型决定了来自两个输入视频的音频是否需要混合:</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="7ee8" class="mt lw it nj b gy nn no l np nq">[0:a][1:a]amix=inputs=2:duration=longest[aud]<br/>-map “[aud]”</span></pre><p id="59f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者只需要使用来自主视频的音频。</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="6a6d" class="mt lw it nj b gy nn no l np nq">map 1:a</span></pre><h1 id="2e86" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Vimeo API</h1><p id="adba" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Vimeo API实现非常简单，但是需要一些后台设置工作才能运行。与Youtube不同，Vimeo有很高的上传配额，这使得它成为这类自动上传项目的优秀平台。这意味着任何人都可以使用脚本自动上传内容到他们的Vimeo挑战赛，而不会遇到任何限制。</p><p id="d3ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了启用API，用户需要在Vimeo的<a class="ae ky" href="https://developer.vimeo.com/apps/new" rel="noopener ugc nofollow" target="_blank">开发者门户</a>上创建一个应用。这个过程非常简单，如果应用程序只需要在用户的个人Vimeo账户上使用，Vimeo方面的批准周转将会非常快。</p><p id="2058" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦应用程序被创建和批准，你将能够访问<em class="ms">客户端id </em>、<em class="ms">客户端秘密</em>和<em class="ms">访问令牌</em>，这是脚本工作所必需的。使用Vimeo API的<a class="ae ky" href="https://github.com/vimeo/vimeo.py" rel="noopener ugc nofollow" target="_blank"> Python包装器</a>提供的视频上传示例，我们可以轻松地将视频上传到我们的频道。负责此操作的代码行有5行，出于安全原因，它们被放在“try: except:”块中，以捕捉潜在的错误。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">用于在Vimeo上上传生成的视频的try语句概述。</figcaption></figure><h1 id="6d80" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="27a2" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">差不多就是这样！你可以在这里找到完整代码的链接，并且可以在<a class="ae ky" href="https://www.human-signs.com/participants/" rel="noopener ugc nofollow" target="_blank">项目的网站</a>任何参与者的页面内看到结果。希望你觉得python、ffmpeg和vimeo的组合有用而且有趣。</p></div></div>    
</body>
</html>