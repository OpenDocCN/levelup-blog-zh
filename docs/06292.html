<html>
<head>
<title>How To Modernize your Old School SFTP Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何更新您的老式SFTP服务器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-modernize-your-old-school-sftp-server-703636fbc15f?source=collection_archive---------2-----------------------#2020-11-12">https://levelup.gitconnected.com/how-to-modernize-your-old-school-sftp-server-703636fbc15f?source=collection_archive---------2-----------------------#2020-11-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/c95f7bd49adc77f182bf931ebd029d1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DRzDAuxPJMb4uidq"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">乔里斯·维瑟在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="3e00" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">甚至在15年前，当有人谈到服务器时，他们指的是数据中心的一个硬件。“专用托管”和“协同定位”是更受欢迎和众所周知的术语。快进到今天，世界是一个非常不同的地方。硬件服务器变成了VM，VM变成了Virtuozzo容器(Docker的前身)，然后我们到了Docker。与上述发展类似，我们提供服务的方式也发生了变化。除了托管自己的服务，您还可以利用Paas(平台即服务)、Iaas(基础设施即服务)、Saas(软件即服务)等等。</p><p id="860b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你读过我以前的文章，如<a class="ae kf" href="https://medium.com/dev-genius/how-to-think-like-an-engineer-3b53fb42ac13#7757" rel="noopener">如何像工程师一样思考</a>，你会知道如果定制/自我管理工具是手头工作的最佳候选，我会很好。不过，通常情况下，现有的工具/回购/产品能更好地完成这项工作。对于自托管服务和Saas产品，我也有同感。托管我自己的服务会带来开销，如修补、更新、保护、调整、扩展等。与Saas产品相反，公司会担心开销，而我会使用服务。即使Saas产品是有价格的，想想你不用继续维护“另一项服务”所节省的时间。很多时候，Saas产品比自主托管便宜很多。</p><p id="611c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我最近开始使用的最喜欢的Saas产品之一是AWS的transfer family。对于不熟悉这项服务的人:</p><blockquote class="le lf lg"><p id="3205" class="kg kh lh ki b kj kk kl km kn ko kp kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated">AWS传输系列为直接进出亚马逊S3的文件传输提供全面的管理支持。支持安全文件传输协议(SFTP)、基于SSL的文件传输协议(FTPS)和文件传输协议(FTP)</p></blockquote><p id="e707" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">概括地说，AWS将为您托管一个使用S3作为后端的SFTP服务器！事实上，他们将为你托管一个SFTP服务器本身是有价值的，但事实上，所有的文件最终在S3也是令人兴奋的。大多数AWS服务已经自然地与S3集成。一旦文件在S3，你的Lambdas，Instances，StepFunction，_ _ _ _ _[你最喜欢的服务]可以抓取文件并处理它们。因为文件在S3，所以认证是通过标准IAM进行的，而您的代码/服务甚至不知道或不关心SFTP服务器从那里获得了文件。</p><p id="fac5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后但同样重要的是，因为这是一项AWS服务，所以设置可以完全地形化/自动化。你能从SFTP服务器设置中要求更多吗？</p><p id="4340" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您准备放弃旧的SFTP服务器，让我们来看看如何使用Terraform提供AWS SFTP服务器及其依赖项。到此结束时，你不仅会有一个SFTP服务器，而且它将是完全自动化的，它将能够支持尽可能多的用户。</p></div><div class="ab cl ll lm hx ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="im in io ip iq"><h1 id="6676" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">策略</h1><p id="b4b6" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">这个计划很简单。我们将有一个单一的SFTP服务器和S3桶，由所有用户共享。我们用户的主目录将是<code class="fe mv mw mx my b">${var.s3_bucket_name}/${var.username}</code>。我们将定义权限，以便每个用户只能访问其主目录中的内容。</p><p id="a0e8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为此，我们将创建两个代码集:</p><p id="d252" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">1.设置SFTP服务器的代码。这将包括以下所有地形资源:</p><ul class=""><li id="82c8" class="mz na it ki b kj kk kn ko kr nb kv nc kz nd ld ne nf ng nh bi translated">aws_transfer_server — SFTP服务器资源</li><li id="a397" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">iam_role —允许服务器记录流量的角色</li><li id="5c06" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">iam_policy —允许服务器记录流量的策略</li><li id="c202" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">aws_s3_bucket — s3 bucket将为我们的用户存放所有主目录。</li><li id="dc40" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">aws_route53_record —为我们的服务器创建一个DNS友好主机名(例如sftp.domain.com)</li></ul><p id="6428" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">2.为SFTP访问每个用户实例化一次的模块。</p><ul class=""><li id="3268" class="mz na it ki b kj kk kn ko kr nb kv nc kz nd ld ne nf ng nh bi translated">aws _ transfer _ user在SFTP服务中创建用户</li><li id="a828" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">aws_transfer_ssh_key —定义将用于身份验证的ssh密钥</li><li id="3e17" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">aws_s3_bucket_object —在上面定义的SFTP s3存储桶中创建特定于用户的主目录</li><li id="e77c" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">aws_iam_role —定义用户在其主目录中的权限</li><li id="be5b" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">aws_iam_role_policy —定义用户在其主目录中的权限</li></ul><p id="caeb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最终结果是一个完全自动化的设置。它将能够根据需要容纳尽可能多的用户，并且易于更新。如果你使用的是Terraform 0.13，你将能够采取额外的步骤来保持你的代码干燥。还将提供Terraform 0.12的方法。</p><h2 id="1bca" class="nn lt it bd lu no np dn ly nq nr dp mc kr ns nt mg kv nu nv mk kz nw nx mo ny bi translated">SFTP服务器</h2><p id="c4f3" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">如上所述，使用Terraform和AWS Transfer系列创建我们的SFTP服务器只需要4种资源。第五个可选资源用于创建DNS条目。自定义DNS条目不是必需的，因为AWS会代表您创建一个DNS记录，但是告诉您的客户更清楚:</p><ul class=""><li id="ba80" class="mz na it ki b kj kk kn ko kr nb kv nc kz nd ld ne nf ng nh bi translated">"转到sftp.domain.com "</li></ul><p id="aeca" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">和...相对</p><ul class=""><li id="1a79" class="mz na it ki b kj kk kn ko kr nb kv nc kz nd ld ne nf ng nh bi translated">"请转到s-1 x1 x1 x1 x1 x1 x1 x1 x1x 11 x . server . transfer . us-east-1 . Amazon AWS . com "</li></ul><p id="bcbd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们进入代码，然后解释我们在做什么。</p><pre class="nz oa ob oc gt od my oe of aw og bi"><span id="13c0" class="nn lt it my b gy oh oi l oj ok">resource "aws_transfer_server" "sftp" {<br/>  identity_provider_type = "SERVICE_MANAGED"<br/><br/>  logging_role = aws_iam_role.sftp-logging.arn<br/><br/>  tags = {<br/>    Terraform  = "true"<br/>  }<br/>}<br/><br/>resource "aws_iam_role" "sftp-logging" {<br/>  name = "sftp-logging-role"<br/><br/>  assume_role_policy = &lt;&lt;EOF<br/>{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>        "Effect": "Allow",<br/>        "Principal": {<br/>            "Service": "transfer.amazonaws.com"<br/>        },<br/>        "Action": "sts:AssumeRole"<br/>        }<br/>    ]<br/>}<br/>EOF<br/><br/>  tags = {<br/>    Name       = "sftp-transfer-logging-role"<br/>    Terraform  = "true"<br/>  }<br/>}<br/><br/>resource "aws_iam_role_policy" "sftp-logging" {<br/>  name = "sftp-logging-policy"<br/>  role = aws_iam_role.sftp-logging.id<br/><br/>  policy = &lt;&lt;POLICY<br/>{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "VisualEditor0",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "logs:CreateLogStream",<br/>                "logs:DescribeLogStreams",<br/>                "logs:CreateLogGroup",<br/>                "logs:PutLogEvents"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}<br/>POLICY<br/><br/>}<br/><br/>resource "aws_s3_bucket" "sftp" {<br/>  bucket = "sftp-homedirs"<br/><br/>  server_side_encryption_configuration {<br/>    rule {<br/>      apply_server_side_encryption_by_default {<br/>        sse_algorithm = "AES256"<br/>      }<br/>    }<br/>  }<br/><br/>  tags = {<br/>    Name       = "sftp-homedirs"<br/>    Terraform  = "true"<br/>  }<br/>}<br/><br/>resource "aws_route53_record" "sftpserver" {<br/><br/>  zone_id = var.aws_route53_id<br/>  name    = "sftp.domain.com"<br/>  type    = "CNAME"<br/>  ttl     = "300"<br/><br/>  records = [aws_transfer_server.sftp.endpoint]<br/>}</span></pre><p id="f72e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您熟悉AWS，这些资源对您来说应该不陌生。IAM角色和策略定义了SFTP服务器所需的权限。s3存储桶是我们所有用户的主目录存放的地方。这里唯一不熟悉的资源是“aws_transfer_server”。</p><p id="0b82" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如您可以从名称中推断的那样，这就是实际的SFTP服务器本身。我们只为我们的设置定义了三个选项:</p><ul class=""><li id="ad34" class="mz na it ki b kj kk kn ko kr nb kv nc kz nd ld ne nf ng nh bi translated">身份提供者—服务器应该使用什么身份验证机制？“SERVICE_MANAGED”意味着我们将在服务本身中配置访问权限。或者，您也可以使用API网关进行身份验证。</li><li id="6b31" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">logging_role —它附加了我们创建的IAM角色，以允许SFTP服务器将日志写入CloudWatch。</li><li id="a170" class="mz na it ki b kj ni kn nj kr nk kv nl kz nm ld ne nf ng nh bi translated">标签— AWS标签是不言自明的。</li></ul><p id="6cc8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要获得完整的选项列表，请查看Terraform的文档:<a class="ae kf" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/transfer_server" rel="noopener ugc nofollow" target="_blank">这里</a></p><h2 id="01fb" class="nn lt it bd lu no np dn ly nq nr dp mc kr ns nt mg kv nu nv mk kz nw nx mo ny bi translated">SFTP用户模块</h2><p id="8897" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">有了服务器，现在我们需要为每个用户实例化的用户模块。</p><pre class="nz oa ob oc gt od my oe of aw og bi"><span id="7c69" class="nn lt it my b gy oh oi l oj ok">resource "aws_iam_role" "sftp" {<br/>  name = "sftp-${var.username}-user-role"<br/><br/>  assume_role_policy = &lt;&lt;EOF<br/>{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>        "Effect": "Allow",<br/>        "Principal": {<br/>            "Service": "transfer.amazonaws.com"<br/>        },<br/>        "Action": "sts:AssumeRole"<br/>        }<br/>    ]<br/>}<br/>EOF<br/><br/>  tags = {<br/>    Name       = "sftp-${var.username}-user-role"<br/>    Terraform  = "true"<br/>  }<br/>}<br/><br/>resource "aws_iam_role_policy" "sftp" {<br/>  name = "sftp-${var.username}-user-policy"<br/>  role = aws_iam_role.sftp.id<br/><br/>  policy = &lt;&lt;POLICY<br/>{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "AllowListingFolder",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "s3:ListBucket",<br/>                "s3:GetBucketLocation"<br/>            ],<br/>            "Resource": "${var.s3_bucket_arn}",<br/>            "Condition": {<br/>                "StringLike": {<br/>                    "s3:prefix": [<br/>                        "${var.username}/*",<br/>                        "${var.username}"<br/>                    ]<br/>                }<br/>            }<br/>        },<br/>        {<br/>            "Sid": "AllowReadWriteToObject",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "s3:PutObject",<br/>                "s3:GetObject",<br/>                "s3:DeleteObjectVersion",<br/>                "s3:DeleteObject",<br/>                "s3:GetObjectVersion"<br/>            ],<br/>            "Resource": "${var.s3_bucket_arn}/${var.username}*"<br/>        }<br/>    ]<br/>}<br/>POLICY<br/>}<br/><br/>resource "aws_transfer_user" "user" {<br/>  server_id      = var.sftp_server_id<br/>  user_name      = var.username<br/>  role           = aws_iam_role.sftp.arn<br/>  home_directory = "/${var.s3_bucket_name}/${var.username}"<br/><br/>  tags = {<br/>    Terraform  = "true"<br/>  }<br/>}<br/><br/>resource "aws_transfer_ssh_key" "user" {<br/>  server_id = var.sftp_server_id<br/>  user_name = aws_transfer_user.user.user_name<br/>  body      = var.sshkey<br/><br/>}<br/></span></pre><p id="d188" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意我们正在定义的权限。由于我们所有的用户都共享一个s3存储桶，我们将他们的权限锁定到他们特定的主目录，以确保他们只能访问他们自己的内容。这是通过如下设置实现的:</p><pre class="nz oa ob oc gt od my oe of aw og bi"><span id="9f7e" class="nn lt it my b gy oh oi l oj ok">"Condition": {<br/>                "StringLike": {<br/>                    "s3:prefix": [<br/>                        "${var.username}/*",<br/>                        "${var.username}"<br/>                    ]</span></pre><p id="eee4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者</p><pre class="nz oa ob oc gt od my oe of aw og bi"><span id="d556" class="nn lt it my b gy oh oi l oj ok">"Resource": "${var.s3_bucket_arn}/${var.username}*"</span></pre><p id="10fa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于您自己的设置，您可以为每个用户创建一个s3 bucket，但是感觉没有必要，特别是如果您正确地锁定了权限。将所有东西放在一个S3桶中也为数据分析提供了很多好处。</p></div><div class="ab cl ll lm hx ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="im in io ip iq"><p id="5f62" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在权限之外，唯一值得突出显示的资源是“aws_transfer_ssh_key”和“aws_transfer_user”。正如您所看到的，这些资源创建了我们的用户，并定义了应该用于身份验证的SSH密钥。同样，您可以看到我们如何继续利用共享的s3存储桶。</p><pre class="nz oa ob oc gt od my oe of aw og bi"><span id="0dea" class="nn lt it my b gy oh oi l oj ok">home_directory = "/${var.s3_bucket_name}/${var.username}"</span></pre><p id="d992" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以做的一件可选的事情是在用户的主目录中配置文件夹，您可以通过以下方式实现这一点:</p><pre class="nz oa ob oc gt od my oe of aw og bi"><span id="f3be" class="nn lt it my b gy oh oi l oj ok">resource "aws_s3_bucket_object" "outbound" {<br/>  bucket = var.s3_bucket_name<br/>  acl    = "private"<br/>  key    = "${var.username}/OUTBOUND/"<br/>  source = "/dev/null"<br/>}</span></pre><h2 id="6c47" class="nn lt it bd lu no np dn ly nq nr dp mc kr ns nt mg kv nu nv mk kz nw nx mo ny bi translated">把所有的放在一起</h2><p id="6774" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">由于SFTP服务器不是一个模块，您可以简单地运行<code class="fe mv mw mx my b">teraform apply</code>，Terraform会完成剩下的工作。SFTP用户代码是一个模块，所以它需要实例化。根据您的Terraform版本，您有两种选择:</p><p id="78d2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">地形≤ 0.12:</p><p id="bd76" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在Terraform 0.13之前，不能在模块上使用<code class="fe mv mw mx my b">for_each</code>。这意味着您需要为每个用户定义模块。这看起来像是:</p><pre class="nz oa ob oc gt od my oe of aw og bi"><span id="4306" class="nn lt it my b gy oh oi l oj ok">module "exampleuser" {<br/>  source = "../modules/aws-sftp-user"<br/><br/>  username       = "exampleuser"<br/>  sshkey         = "ssh-rsa XXXXXXXXX"<br/>  s3_bucket_arn  = aws_s3_bucket.sftp.arn<br/>  s3_bucket_name = aws_s3_bucket.sftp.id<br/>  sftp_server_id = aws_transfer_server.sftp.id<br/>}<br/>module "exampleuser2" {<br/>  source = "../modules/aws-sftp-user"<br/><br/>  username       = "exampleuser2"<br/>  sshkey         = "ssh-rsa YYYYYYYYYY"<br/>  s3_bucket_arn  = aws_s3_bucket.sftp.arn<br/>  s3_bucket_name = aws_s3_bucket.sftp.id<br/>  sftp_server_id = aws_transfer_server.sftp.id<br/>}<br/>module "exampleuser3" {<br/>  source = "../modules/aws-sftp-user"<br/><br/>  username       = "exampleuser3"<br/>  sshkey         = "ssh-rsa ZZZZZZZZZZ"<br/>  s3_bucket_arn  = aws_s3_bucket.sftp.arn<br/>  s3_bucket_name = aws_s3_bucket.sftp.id<br/>  sftp_server_id = aws_transfer_server.sftp.id<br/>}</span></pre><p id="c314" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">地形0.13 ( <strong class="ki iu">最优</strong>):</p><p id="8bfa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">随着在Terraform 0.13中添加了<code class="fe mv mw mx my b">for_each</code>支持，我们可以将上述内容简化如下:</p><ul class=""><li id="5798" class="mz na it ki b kj kk kn ko kr nb kv nc kz nd ld ne nf ng nh bi translated">创建用户及其SSH密钥的映射。</li></ul><pre class="nz oa ob oc gt od my oe of aw og bi"><span id="e5e0" class="nn lt it my b gy oh oi l oj ok">variable "user_map" {<br/>  type = "map"<br/>  default = {<br/>    exampleuser1 = "ssh-rsa XXXXXXXXXX"<br/>    exampleuser2 = "ssh-rsa YYYYYYYYYY"<br/>    exampleuser3 = "ssh-rsa ZZZZZZZZZZ"<br/>  }<br/>}</span></pre><p id="fd34" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后使用<code class="fe mv mw mx my b">for_each</code>实例化您的模块:</p><pre class="nz oa ob oc gt od my oe of aw og bi"><span id="b23e" class="nn lt it my b gy oh oi l oj ok">module "sftpusers" {<br/>  for_each = var.user_map<br/>  source = "../modules/aws-sftp-user"<br/><br/>  username       = each.key<br/>  sshkey         = each.value<br/>  s3_bucket_arn  = aws_s3_bucket.sftp.arn<br/>  s3_bucket_name = aws_s3_bucket.sftp.id<br/>  sftp_server_id = aws_transfer_server.sftp.id<br/>}</span></pre><p id="18a9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，只需更新“user_map”变量并运行terraform，就可以轻松添加新用户。</p><h1 id="425d" class="ls lt it bd lu lv ol lx ly lz om mb mc md on mf mg mh oo mj mk ml op mn mo mp bi translated">结论</h1><p id="9ef7" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">通过10-20分钟的编码，我们能够提供一个全功能的SFTP服务器。它是完全自动化的，与AWS集成，永远不需要打补丁、进行冗余/容错、监控磁盘空间或加固。所有的开销都已经解决了，你可以享受所有的好处。因为这些都在AWS中，你甚至可以做一些在普通SFTP服务器上不可能做的事情。例如，您可以在S3中添加触发器，以便在文件上传时启动Lambdas。我们刚刚打开了可能性，同时消除开销，感觉像一个胜利！</p></div><div class="ab cl ll lm hx ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="im in io ip iq"><p id="c979" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了获得无限的故事，你还可以考虑注册<a class="ae kf" href="https://blog.rhel.solutions/membership" rel="noopener ugc nofollow" target="_blank"><em class="lh"/></a><em class="lh">成为中等会员，只需5美元。如果您使用</em> <a class="ae kf" href="https://blog.rhel.solutions/membership" rel="noopener ugc nofollow" target="_blank"> <em class="lh">我的链接</em> </a> <em class="lh">注册，我会收到一小笔佣金(无需您额外付费)。</em></p></div></div>    
</body>
</html>