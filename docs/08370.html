<html>
<head>
<title>Introduction to Message Queues: Build a Newsletter App using Django, Celery, and RabbitMQ in 30 min</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">消息队列介绍:使用Django、Celery和RabbitMQ在30分钟内构建一个时事通讯应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/introduction-to-message-queue-build-a-newsletter-app-using-django-celery-and-rabbitmq-in-30-min-6d484162391d?source=collection_archive---------1-----------------------#2021-04-26">https://levelup.gitconnected.com/introduction-to-message-queue-build-a-newsletter-app-using-django-celery-and-rabbitmq-in-30-min-6d484162391d?source=collection_archive---------1-----------------------#2021-04-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="966d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">消息队列广泛用于异步系统中。在数据密集型应用中，使用队列可以确保用户在完成复杂任务的同时获得快速体验。例如，当任务在后台完成时，您可以在UI中显示进度条。这允许用户从等待任务完成中解脱出来，因此可以在此期间做其他工作。</p><p id="0d2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个典型的请求-响应架构不会减少响应时间不可预测的地方，因为您有许多长时间运行的请求。如果您确信您的系统请求将会以指数或多项式的形式增长，那么队列将会非常有用。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/b2e6b24efc4addcd820cea08df2faadf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MMcIgmdZ5YMGqUF0"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">霍比工业在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="1c5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">消息队列提供了一些有用的特性，比如持久性、路由和任务管理。消息队列是典型的“代理”，它通过提供其他服务可以访问的接口来促进消息传递。这个接口连接了创建消息的<strong class="jp ir">生产者</strong>和处理消息的<strong class="jp ir">消费者</strong>。</p><p id="8810" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将建立一个简讯应用程序，用户可以订阅各种简讯，他们将定期收到他们的电子邮件。但是在我们继续之前，让我们理解workers +消息队列的工作原理。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/16fe58310478d7e08375c935db46c7c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/0*T2hl9WirMLj8Hv2u"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">信息排队</figcaption></figure><h1 id="b586" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">工人和消息队列</h1><p id="6714" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">工人是“后台任务服务器”。当您的web服务器响应用户请求时，工作服务器可以在后台处理任务。这些工作人员可以用来发送电子邮件、对数据库进行大的修改、处理文件等。</p><p id="682e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">工人通过消息队列被分配任务。例如，考虑存储大量消息的队列。它将以先进先出(FIFO)的方式进行处理。当一个工人变得可用时，它从队列的前面取出第一个任务并开始处理。如果我们有许多工人，每个人都按顺序完成一项任务。该队列确保每个工作线程一次只能获得一个任务，并且每个任务只能由一个工作线程处理。</p><p id="386f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用<strong class="jp ir"> Celery </strong>，它是用于<strong class="jp ir"> Python </strong> web应用<strong class="jp ir">的任务队列实现，用于在HTTP请求-响应周期之外异步执行工作。我们还将使用<a class="ae lb" href="https://www.rabbitmq.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> RabbitMQ </strong> </a>，这是部署最广泛的开源消息代理。它支持多种消息协议。</strong></p><h1 id="b1e4" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">构建简讯应用程序</h1><p id="c32e" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">我们将建立一个简讯应用程序，用户可以同时订阅各种简讯，并将定期通过电子邮件接收问题。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/7fa052fcd6d0af34e18071a2fabe5e00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*HTLkTq7wcYkQuxpdGORYVw.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">产品概述</figcaption></figure><p id="99f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将有我们的通讯应用程序作为一个芹菜Django应用程序运行。每当作者发布新的一期，Django应用程序就会发布一条消息，通过电子邮件将该期内容发送给使用celery的订户。芹菜工人将从经纪人那里收到任务，并开始发送电子邮件。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/fccf365c29f159536f6a07c8438925ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*UrWTsL6WirrwbLHmxxPURg.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">基础设施</figcaption></figure><h2 id="6f78" class="mi le iq bd lf mj mk dn lj ml mm dp ln jy mn mo lr kc mp mq lv kg mr ms lz mt bi translated"><strong class="ak">要求</strong></h2><ul class=""><li id="cad1" class="mu mv iq jp b jq mb ju mc jy mw kc mx kg my kk mz na nb nc bi translated">Python 3+版本</li><li id="618c" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated"><a class="ae lb" href="https://pipenv.pypa.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> Pipenv </a></li></ul><h2 id="3021" class="mi le iq bd lf mj mk dn lj ml mm dp ln jy mn mo lr kc mp mq lv kg mr ms lz mt bi translated">设置Django</h2><p id="05bf" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">在本地创建一个文件夹<code class="fe ni nj nk nl b">newsletter</code>，在虚拟环境中安装Django。内部文件夹运行:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="acea" class="mi le iq nl b gy nq nr l ns nt">pipenv shell<br/>pipenv install django</span></pre><p id="f69b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建应用程序:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="1984" class="mi le iq nl b gy nq nr l ns nt">django-admin startproject newsletter_site .</span></pre><p id="3c0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置模型:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="e257" class="mi le iq nl b gy nq nr l ns nt">python manage.py migrate</span></pre><p id="3dae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确保它正常工作并访问<a class="ae lb" href="http://127.0.0.1:8000/" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:8000/ </a>:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="e54b" class="mi le iq nl b gy nq nr l ns nt">python manage.py runserver 8000</span></pre><p id="0607" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建简讯应用程序:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="d9ae" class="mi le iq nl b gy nq nr l ns nt">python manage.py startapp newsletter</span></pre><h2 id="1269" class="mi le iq bd lf mj mk dn lj ml mm dp ln jy mn mo lr kc mp mq lv kg mr ms lz mt bi translated">装置</h2><ul class=""><li id="2477" class="mu mv iq jp b jq mb ju mc jy mw kc mx kg my kk mz na nb nc bi translated">安装芹菜</li><li id="8e56" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">安装dotenv从环境中读取设置。</li><li id="9faf" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">安装psycopg2-binary以连接Postgres。</li></ul><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="e57a" class="mi le iq nl b gy nq nr l ns nt">pipenv install celery<br/>pipenv install python-dotenv<br/>pipenv install psycopg2-binary</span></pre><h2 id="e78c" class="mi le iq bd lf mj mk dn lj ml mm dp ln jy mn mo lr kc mp mq lv kg mr ms lz mt bi translated">设置Postgres和RabbitMQ</h2><p id="4131" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">创建一个<code class="fe ni nj nk nl b">docker-compose.yaml</code>在后台运行Postgres和Rabbitmq。</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="a881" class="mi le iq nl b gy nq nr l ns nt">version: '3'<br/>services:<br/>  db:<br/>    image: postgres:13<br/>    env_file:<br/>      - .env<br/>    ports:<br/>      - 5432:5432<br/>  rabbitmq:<br/>    image: rabbitmq<br/>    ports:<br/>      - 5672:5672</span></pre><h2 id="303d" class="mi le iq bd lf mj mk dn lj ml mm dp ln jy mn mo lr kc mp mq lv kg mr ms lz mt bi translated">配置设置. py</h2><ul class=""><li id="77df" class="mu mv iq jp b jq mb ju mc jy mw kc mx kg my kk mz na nb nc bi translated">为了在我们的项目中包含该应用程序，我们需要在<code class="fe ni nj nk nl b">newsletter_site/settings.py</code>的<code class="fe ni nj nk nl b"><a class="ae lb" href="https://docs.djangoproject.com/en/3.2/ref/settings/#std:setting-INSTALLED_APPS" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">INSTALLED_APPS</strong></a></code>设置中添加对其配置类的引用。</li></ul><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="e9b5" class="mi le iq nl b gy nq nr l ns nt">INSTALLED_APPS = [<br/>    'newsletter.apps.NewsletterConfig',<br/>    'django.contrib.admin',<br/>    'django.contrib.auth',<br/>    'django.contrib.contenttypes',<br/>    'django.contrib.sessions',<br/>    'django.contrib.messages',<br/>    'django.contrib.staticfiles',<br/>]</span></pre><ul class=""><li id="0dad" class="mu mv iq jp b jq jr ju jv jy nu kc nv kg nw kk mz na nb nc bi translated">我们需要告诉芹菜怎么找到RabbitMQ。所以，打开<code class="fe ni nj nk nl b">settings.py</code>，加上这一行:</li></ul><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="2805" class="mi le iq nl b gy nq nr l ns nt">CELERY_BROKER_URL = os.getenv('CELERY_BROKER_URL') </span></pre><ul class=""><li id="de4d" class="mu mv iq jp b jq jr ju jv jy nu kc nv kg nw kk mz na nb nc bi translated">我们需要配置数据库设置:</li></ul><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="f614" class="mi le iq nl b gy nq nr l ns nt">uri = os.getenv('DATABASE_URL')<br/><br/>result = urlparse(uri)<br/><br/>database = result.path[1:]<br/>user = result.username<br/>password = result.password<br/>host = result.hostname<br/>port = result.port<br/><br/>DATABASES = {<br/>    'default': {<br/>        'ENGINE': 'django.db.backends.postgresql',<br/>        'NAME': database,<br/>        'USER': user,<br/>        'PASSWORD': password,<br/>        'HOST': host,<br/>        'PORT': port,<br/>    }<br/>}</span></pre><ul class=""><li id="6f83" class="mu mv iq jp b jq jr ju jv jy nu kc nv kg nw kk mz na nb nc bi translated">我们需要在<code class="fe ni nj nk nl b">settings.py</code>中配置SMTP服务器。SMTP服务器是负责向用户发送电子邮件的邮件服务器。对于开发，您可以使用Gmail SMTP服务器，但这有一定的限制，如果您有2 FA，这将不起作用。可以参考这篇<a class="ae lb" href="https://dev.to/abderrahmanemustapha/how-to-send-email-with-django-and-gmail-in-production-the-right-way-24ab" rel="noopener ugc nofollow" target="_blank">文章</a>。对于生产，您可以使用商业服务，如sendgrid。</li></ul><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="d293" class="mi le iq nl b gy nq nr l ns nt">EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'<br/>EMAIL_HOST = os.getenv('EMAIL_HOST')<br/>EMAIL_USE_TLS = bool(os.getenv('EMAIL_USE_TLS'))<br/>EMAIL_PORT = os.getenv('EMAIL_PORT')<br/>EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER')<br/>EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD')</span></pre><p id="1f49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为参考，你可以在这里看到settings.py <a class="ae lb" href="https://github.com/Nancy-Chauhan/newsletter/blob/main/newsletter_site/settings.py" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="98b1" class="mi le iq bd lf mj mk dn lj ml mm dp ln jy mn mo lr kc mp mq lv kg mr ms lz mt bi translated">创建环境文件</h2><ul class=""><li id="446a" class="mu mv iq jp b jq mb ju mc jy mw kc mx kg my kk mz na nb nc bi translated">创建一个<code class="fe ni nj nk nl b">.env</code>文件并分配密码。</li></ul><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="f4df" class="mi le iq nl b gy nq nr l ns nt">EMAIL_HOST=<strong class="nl ir">{EMAIL_HOST}</strong><br/>EMAIL_USE_TLS=True<br/>EMAIL_PORT=<strong class="nl ir">{EMAIL_PORT}</strong><br/>EMAIL_HOST_USER=<strong class="nl ir">{EMAIL_HOST_USER}</strong><br/>EMAIL_HOST_PASSWORD=<strong class="nl ir">{EMAIL_HOST_PASSWORD}</strong></span><span id="7e86" class="mi le iq nl b gy nx nr l ns nt">CELERY_BROKER_URL="pyamqp://localhost:5672"</span><span id="e2cc" class="mi le iq nl b gy nx nr l ns nt">SECRET_KEY=<strong class="nl ir">{SECRET_KEY}</strong></span><span id="278c" class="mi le iq nl b gy nx nr l ns nt">DATABASE_URL=postgres://postgres:password@localhost:5432/postgres</span><span id="1acd" class="mi le iq nl b gy nx nr l ns nt">POSTGRES_PASSWORD=password<br/>APP_DOMAIN=*<br/>DEBUG=True</span></pre><h2 id="3526" class="mi le iq bd lf mj mk dn lj ml mm dp ln jy mn mo lr kc mp mq lv kg mr ms lz mt bi translated">芹菜</h2><ul class=""><li id="e5b8" class="mu mv iq jp b jq mb ju mc jy mw kc mx kg my kk mz na nb nc bi translated">我们需要用一些配置选项来设置Celery。在<code class="fe ni nj nk nl b">newseletter_site</code>目录下创建一个名为<code class="fe ni nj nk nl b">celery.py</code>的新文件:</li></ul><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="9194" class="mi le iq nl b gy nq nr l ns nt">import os<br/><br/>from celery import Celery<br/><br/>os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'newsletter_site.settings')<br/><br/>app = Celery('newsletter_site')<br/><br/>app.config_from_object('django.conf:settings', namespace='CELERY')<br/><br/>app.autodiscover_tasks()</span></pre><h2 id="bac2" class="mi le iq bd lf mj mk dn lj ml mm dp ln jy mn mo lr kc mp mq lv kg mr ms lz mt bi translated">设计和实施模型并配置管理员</h2><p id="2bf5" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">这是我们试图建立的模式。模式在这里被实现<a class="ae lb" href="https://github.com/Nancy-Chauhan/newsletter/blob/main/newsletter/models.py" rel="noopener ugc nofollow" target="_blank">。创建一个内容相同的<code class="fe ni nj nk nl b">newsletter/models.py</code>。</a></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ny"><img src="../Images/d8468cdd76bbd2efbcd66638bc51adef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1SYrd7LgJ-nonMft0TBJ4g.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">模型设计</figcaption></figure><p id="ab90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要一个用户界面来管理时事通讯。为此，我们将使用Django Admin。用这个<a class="ae lb" href="https://github.com/Nancy-Chauhan/newsletter/blob/main/newsletter/admin.py" rel="noopener ugc nofollow" target="_blank">文件</a>的内容创建一个<code class="fe ni nj nk nl b">newsletter/admin.py</code>。</p><p id="7e42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe ni nj nk nl b">newsletter_site/urls.py</code>为管理员注册网址:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="e80b" class="mi le iq nl b gy nq nr l ns nt">urlpatterns = [<br/>    path('admin/', admin.site.urls),<br/>]</span></pre><h1 id="bba9" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">运行应用程序</h1><p id="c6bb" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">运行docker-compose启动依赖项:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="d49d" class="mi le iq nl b gy nq nr l ns nt">docker-compose up</span></pre><p id="5f4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为我们的模型生成迁移:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="73fb" class="mi le iq nl b gy nq nr l ns nt">python manage.py makemigrations</span></pre><p id="a098" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要将生成的迁移应用于数据库运行:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="6ae6" class="mi le iq nl b gy nq nr l ns nt">python manage.py migrate </span></pre><p id="b464" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建登录用户，请运行以下命令并提供您的详细信息:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="c5d4" class="mi le iq nl b gy nq nr l ns nt">python manage.py createsuperuser</span></pre><p id="8e4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令来运行应用程序，并打开<a class="ae lb" href="http://127.0.0.1:8000/admin/" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8000/Admin</a>来打开Django Admin:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="eea4" class="mi le iq nl b gy nq nr l ns nt">python manage.py runserver</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nz"><img src="../Images/9ab51add01b7a58b75bcaa070df8b527.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H4Vbp888k0K-4S5cImov6Q.png"/></div></div></figure><p id="1e77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行芹菜:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="a3af" class="mi le iq nl b gy nq nr l ns nt">celery -A newsletter_site worker --loglevel=INFO</span></pre><p id="43d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加新闻稿和订阅者，并为其订阅。创建一个问题并发送它。如果一切正常，您会在电子邮件中看到一个问题。</p><h2 id="a797" class="mi le iq bd lf mj mk dn lj ml mm dp ln jy mn mo lr kc mp mq lv kg mr ms lz mt bi translated">它是如何工作的？</h2><p id="0024" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">当我们单击“发送”时，将执行以下操作:</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="f971" class="mi le iq nl b gy nq nr l ns nt">def send(modeladmin, request, queryset):<br/>    for issue in queryset:<br/>        tasks.send_issue.delay(issue.id)<br/><br/><br/>send.short_description = "send"</span></pre><p id="2038" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这段代码负责排队一个新任务，用celery发送一个问题。它将任务发布到RabbitMQ。</p><pre class="km kn ko kp gt nm nl nn no aw np bi"><span id="7ca5" class="mi le iq nl b gy nq nr l ns nt">@shared_task()<br/>def send_issue(issue_id):<br/>    issue = Issue.objects.get(pk=issue_id)<br/>    for subscription in Subscription.objects.filter(newsletter=issue.newsletter):<br/>        send_email.delay(subscription.subscriber.email, issue.title, issue.content)<br/><br/><br/>@shared_task()<br/>def send_email(email, title, content):<br/>    send_mail(<br/>        title,<br/>        content,<br/>        'newsletters@nancychauhan.in',<br/>        [email],<br/>        fail_silently=False,<br/>    )</span></pre><p id="45f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">芹菜工人使用这些任务。当生产者发布任务时，工人运行相应的任务。</p><p id="f530" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们发布<code class="fe ni nj nk nl b">send_issue</code>任务时，我们确定时事通讯的订阅者，并发布子任务来发送实际的电子邮件。这种策略称为扇出。扇出是有用的，因为它允许我们在失败的情况下重试向单个用户发送电子邮件。</p><h2 id="0073" class="mi le iq bd lf mj mk dn lj ml mm dp ln jy mn mo lr kc mp mq lv kg mr ms lz mt bi translated">结论</h2><p id="6fbb" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">在这篇文章中，我们看到了如何使用RabbitMQ作为带有Celery和Django的消息队列来发送批量电子邮件。这非常适合适合消息队列。如果请求不确定，或者流程需要长时间运行且占用大量资源，请使用消息队列。</p><p id="d442" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在这里找到完成的项目:</p><div class="oa ob gp gr oc od"><a href="https://github.com/Nancy-Chauhan/newsletter" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">南希-肖汉/时事通讯</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">在GitHub上创建一个帐户，为Nancy-Chauhan/时事通讯的发展做出贡献。</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">github.com</p></div></div><div class="om l"><div class="on l oo op oq om or kv od"/></div></div></a></div></div><div class="ab cl os ot hu ou" role="separator"><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox"/></div><div class="ij ik il im in"><p id="e5e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢您的阅读！在评论框中分享您的反馈。</p></div></div>    
</body>
</html>