<html>
<head>
<title>Using Heroku to Quickly Build a Multi-Tenant SaaS Startup (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Heroku快速构建多租户SaaS创业公司(第1部分)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-heroku-to-quickly-build-a-multi-tenant-saas-startup-part-1-9f0da344a7a4?source=collection_archive---------17-----------------------#2020-09-17">https://levelup.gitconnected.com/using-heroku-to-quickly-build-a-multi-tenant-saas-startup-part-1-9f0da344a7a4?source=collection_archive---------17-----------------------#2020-09-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="83d3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">[在这个由多个部分组成的系列中，我将把一个新的应用程序转换成在Heroku生态系统中运行的多租户体验。本文主要关注对象模型、设计、架构和安全性。]</p><p id="496d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我的妻子妮可有一个同卵双胞胎叫丹妮儿。虽然妮可和丹耶尔一直保持着自己的个性，但她们都热衷于保持良好的身体状态和坚持日常锻炼。事实上，Danyel决定发展她的健身热情，并开始在她位于拉斯维加斯地区的私人健身房训练其他人。在听说Danyel在创业过程中所做的工作(即许可证、法律文件和保险)时，我询问了她跟踪业务的计划。</p><p id="6752" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">长话短说，Danyel一直专注于让她的业务运行，但并没有专注于拥有必要的技术来满足她的业务需求。由于我刚刚成功地将我岳母的应用程序从亚马逊网络服务(AWS)转换到Heroku(见<a class="ae ko" rel="noopener ugc nofollow" target="_blank" href="/heroku-my-new-home-f8ecfbc33886">Heroku——我的新家</a>)，我认为是时候从应用程序的角度来帮助Danyel的业务了。</p><p id="e165" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">经过几次视频通话和对拉斯维加斯地区的快速访问，我们确定新的健身应用程序将在初始版本中提供以下功能:</p><ul class=""><li id="ca46" class="kp kq it js b jt ju jx jy kb kr kf ks kj kt kn ku kv kw kx bi translated">客户管理(管理她的客户)</li><li id="e61f" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">锻炼管理(为她的顾客创造日常活动)</li><li id="802b" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">会话管理(创建由一个健身程序组成的健身程序会话，至少为一名客户)</li></ul><p id="ce3d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">展望未来，我后来绘制了未来功能的图表:</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ld"><img src="../Images/faa6626e2a0107ad84d3a11817f31f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*m4FNKyu0HE35Tfky.png"/></div></div></figure><p id="7c77" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在向Nicole展示应用程序的进度时，她漫不经心地问道:“我想知道有多少其他私人教练可能对拥有一个像你为我妹妹开发的应用程序这样的应用程序感兴趣？”</p><p id="6f61" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Nicole的问题激发了我去改变我的设计，创建一个不仅仅是她姐姐可以使用的系统。Nicole的评论将我的设计从一个在Heroku上运行的简单应用程序转变为一个可以被多个健身教练使用的多租户应用程序，而不管他们在哪里。从那时起，我开始考虑为私人教练提供类似Salesforce的体验。</p><p id="76ee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从技术角度来看，我想看看我能多快、多容易地构建一个SaaS解决方案，供多个健身教练使用。从商业角度来看，这种解决方案不仅可以让健身教练管理他们的客户、锻炼和会议，还可以成为他们业务各个方面的单一参考点，而且月租费很低。</p><p id="0d37" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">借助Heroku生态系统中可用的扩展选项，应用程序和数据库可以根据需要进行扩展。来自订户的收入将为额外的Heroku成本提供资金，使我的个人投资成本保持在较低水平。更重要的是，Heroku的易用性将允许我继续构建上面功能表中提到的功能，而不会被基础设施知识和决策所困扰。</p><p id="1cb1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我计划如何推广该解决方案？不太确定…太兴奋了以至于不能开始把我的想法付诸实施。</p><p id="2a54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，有了这个新的设计概念，我需要弄清楚如何做三件事:</p><ol class=""><li id="d616" class="kp kq it js b jt ju jx jy kb kr kf ks kj kt kn lp kv kw kx bi translated">设计一个像单个应用程序一样运行的多租户应用程序</li><li id="9d5e" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn lp kv kw kx bi translated">了解安全性的工作原理以及与单一应用程序的不同之处</li><li id="e786" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn lp kv kw kx bi translated">保护数据的安全，即使狡猾的开发者试图访问API</li></ol><h1 id="3f07" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">设计多租户应用程序</h1><p id="3fa1" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">根据维基百科的说法，<a class="ae ko" href="https://en.wikipedia.org/wiki/Multitenancy" rel="noopener ugc nofollow" target="_blank">多租户</a>“指的是一种软件架构，其中一个软件实例运行在一台服务器上，为多个租户服务。”在这种情况下，我正在创建一个服务于多个健身教练的软件实例。因此，每个健身教练使用该系统的成本将远远低于这些人创建和托管自己的解决方案的成本。</p><p id="fe78" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过一年来使用AWS的经验教训以及从AWS到Heroku的转换工作，我的研究引导我在这个应用程序中使用Heroku。我知道多租户对Heroku来说不是一个挑战，他们以开发人员为中心的方法非常适合我的情况。毕竟，我还在做全职工作，家里还有一个蹒跚学步的孩子。</p><p id="1d4b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">鉴于我在Java/Spring Boot和Angular方面的经验，我决定坚持使用我了解并尊重的技术。从数据库的角度来看，MySQL似乎也很适合这个应用程序，它在Heroku中运行时将使用ClearDB选项。</p><p id="f0e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了采用多租户设计，数据(客户、锻炼、会话等。)需要保护每个租户(健身教练)不受其他租户影响。在较高层次上，创建了一个租户对象，它包括一个租户属性对象，该对象将提供有关租户的属性，并链接到一个功能对象(其中可以启用/禁用某些功能)。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi mt"><img src="../Images/d6edd267d586552322aa3557bde4d7a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dB_ir4qRLzafeqjj.png"/></div></div></figure><p id="c61d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从实体的角度来看，为应用程序创建的所有对象都将包含对租户对象的tenantId引用。因为我使用Spring Boot作为RESTful API，下面是一个客户端对象的例子:</p><pre class="le lf lg lh gt mu mv mw mx aw my bi"><span id="d866" class="mz lr it mv b gy na nb l nc nd">@AllArgsConstructor</span><span id="9cd3" class="mz lr it mv b gy ne nb l nc nd">@NoArgsConstructor</span><span id="9210" class="mz lr it mv b gy ne nb l nc nd">@Data</span><span id="7df3" class="mz lr it mv b gy ne nb l nc nd">@Entity</span><span id="2221" class="mz lr it mv b gy ne nb l nc nd">@Table(name = “clients”)</span><span id="b480" class="mz lr it mv b gy ne nb l nc nd">public class Client {</span><span id="d2a0" class="mz lr it mv b gy ne nb l nc nd">  @Id</span><span id="ec0c" class="mz lr it mv b gy ne nb l nc nd">  @GeneratedValue(strategy = GenerationType.IDENTITY)</span><span id="1260" class="mz lr it mv b gy ne nb l nc nd">  private long id;<br/></span><span id="9fe8" class="mz lr it mv b gy ne nb l nc nd">  @OneToOne</span><span id="b8fd" class="mz lr it mv b gy ne nb l nc nd">  private Tenant tenant;</span><span id="f82f" class="mz lr it mv b gy ne nb l nc nd">  private boolean active;<br/></span><span id="a3d1" class="mz lr it mv b gy ne nb l nc nd">  @OneToOne</span><span id="b44d" class="mz lr it mv b gy ne nb l nc nd">  private Person person;<br/></span><span id="4485" class="mz lr it mv b gy ne nb l nc nd">  @OneToOne</span><span id="ab5c" class="mz lr it mv b gy ne nb l nc nd">  private Address address;</span><span id="3763" class="mz lr it mv b gy ne nb l nc nd">}</span></pre><p id="2909" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用相同的模式，为初始版本创建了剩余的实体:</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/9900821a9751bc81819f324c47593e76.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/0*IZfNtJMpftAyWvzO.png"/></div></figure><p id="518c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">知道Spring JPA能够为数据库层创建必要的SQL，我决定尝试一下这个选项。尽管我将<code class="fe ng nh ni mv b">application.yml</code>用于我的属性文件，但我还是将下面的application.properties文件放到了我的resources文件夹中:</p><pre class="le lf lg lh gt mu mv mw mx aw my bi"><span id="b818" class="mz lr it mv b gy na nb l nc nd">spring.jpa.properties.javax.persistence.schema-generation.scripts.action=create<br/>spring.jpa.properties.javax.persistence.schema-generation.scripts.create-target=fitness.sql<br/>spring.jpa.properties.javax.persistence.schema-generation.scripts.create-source=metadata</span></pre><p id="5fbd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我启动了Spring Boot服务，并能够在一个名为<code class="fe ng nh ni mv b">fitness.sql</code>的文件中看到健身数据库的完全填充的数据定义语言(DDL)脚本。</p><p id="167f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用Docker、Docker Compose和MySQL基础映像，我能够在几分钟内快速启动并运行数据库。如上所述，我计划在Heroku中使用ClearDB，但是我还没有准备好。对于那些不想使用Docker甚至不想在本地运行数据库的人来说，可以在Heroku中创建一个数据库实例，然后使用。要附加到远程实例的env文件。</p><p id="4968" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此后，我删除了application.properties文件，并暂时关闭了我的RESTful API。</p><h1 id="8a20" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">选择安全提供者</h1><p id="8035" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">过去五年来，Okta提供的服务给我留下了深刻的印象。在多个项目中，我还没有发现Okta工具集不能满足项目需求的场景。然而，在这种情况下，我的多租户应用程序的最终状态是Heroku。所以，我想利用他们推荐的安全合作伙伴。</p><p id="3671" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">令我惊讶的是，Heroku实际上已经与Okta在应用安全方面进行了合作。事实上，将Okta添加到Heroku应用程序就像下面的CLI命令一样简单:</p><pre class="le lf lg lh gt mu mv mw mx aw my bi"><span id="e210" class="mz lr it mv b gy na nb l nc nd">heroku addons:create okta</span></pre><p id="33e2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虽然该功能还处于测试阶段，但它会自动创建所有必需的项目，使您的Heroku应用程序能够与Okta集成。<a class="ae ko" href="https://devcenter.heroku.com/articles/okta" rel="noopener ugc nofollow" target="_blank">点击这里了解更多信息</a>。</p><h1 id="8b95" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">安全拦截器</h1><p id="521c" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">为了保护一个租户免受另一个租户的攻击，我想引入一个SecurityInterceptor来加强每个请求的安全性。这样，如果一个狡猾的用户试图在HTTP请求期间更改对象键，拦截器就会抛出一个错误。因此，所有非匿名请求都通过以下类传递:</p><pre class="le lf lg lh gt mu mv mw mx aw my bi"><span id="4a61" class="mz lr it mv b gy na nb l nc nd">public class SecurityInterceptor extends HandlerInterceptorAdapter {</span><span id="4813" class="mz lr it mv b gy ne nb l nc nd">  @Override</span><span id="2e4a" class="mz lr it mv b gy ne nb l nc nd">  public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {</span><span id="8320" class="mz lr it mv b gy ne nb l nc nd">    if (SecurityContextHolder.getContext().getAuthentication() != null &amp;&amp; SecurityContextHolder.getContext().getAuthentication().getName() != null) {</span><span id="1ddd" class="mz lr it mv b gy ne nb l nc nd">      try {</span><span id="6507" class="mz lr it mv b gy ne nb l nc nd">        // Perform the necessary logic<br/>                     processRequest(SecurityContextHolder.getContext().getAuthentication().getName());</span><span id="4e8b" class="mz lr it mv b gy ne nb l nc nd">        return true;</span><span id="2af9" class="mz lr it mv b gy ne nb l nc nd">      } catch (FitnessException e) {</span><span id="ffc4" class="mz lr it mv b gy ne nb l nc nd">      log.error(“Error code={}, message={}”, e.getCode(), e.getMessage(), e);</span><span id="0fdd" class="mz lr it mv b gy ne nb l nc nd">      response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);</span><span id="3694" class="mz lr it mv b gy ne nb l nc nd">      return false;</span><span id="2940" class="mz lr it mv b gy ne nb l nc nd">    }</span><span id="934b" class="mz lr it mv b gy ne nb l nc nd">  }</span><span id="498b" class="mz lr it mv b gy ne nb l nc nd">  log.error(“Could not determine requester information”);</span><span id="d06a" class="mz lr it mv b gy ne nb l nc nd">  response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);</span><span id="6197" class="mz lr it mv b gy ne nb l nc nd">  return false;</span><span id="613a" class="mz lr it mv b gy ne nb l nc nd">  }</span><span id="13ba" class="mz lr it mv b gy ne nb l nc nd">}</span></pre><p id="6f59" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">processRequest()方法将从authentication.name属性(来自经过身份验证的Okta用户)中提取必要的信息，并尝试检索请求的租户记录。</p><p id="5cc1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果请求不成功，就会抛出FitnessException，导致向请求者返回401(未授权)错误。但是，如果请求成功，拦截器代码将在请求上创建/放置以下对象以供将来使用:</p><pre class="le lf lg lh gt mu mv mw mx aw my bi"><span id="ddd0" class="mz lr it mv b gy na nb l nc nd">@AllArgsConstructor</span><span id="ca65" class="mz lr it mv b gy ne nb l nc nd">@NoArgsConstructor</span><span id="709c" class="mz lr it mv b gy ne nb l nc nd">@Data</span><span id="518b" class="mz lr it mv b gy ne nb l nc nd">public class UserData {</span><span id="10d3" class="mz lr it mv b gy ne nb l nc nd">private Tenant tenant;</span><span id="275d" class="mz lr it mv b gy ne nb l nc nd">private Person person;</span><span id="2077" class="mz lr it mv b gy ne nb l nc nd">}</span></pre><p id="f093" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，在请求生命周期中，对租户/个人(应用程序的用户)的引用将在所有HTTP请求中使用，而不是随请求提供的值。</p><h1 id="3906" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">展望未来</h1><p id="e76b" class="pw-post-body-paragraph jq jr it js b jt mo jv jw jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">总而言之，在这一点上，已经实施了以下设计:</p><ul class=""><li id="6e59" class="kp kq it js b jt ju jx jy kb kr kf ks kj kt kn ku kv kw kx bi translated">初步设计已经完成</li><li id="8fd7" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">暂定发布时间表已经确定</li><li id="e0a5" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">多租户设计已经过验证</li><li id="0c93" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">提供的担保已经选择和确定</li></ul><p id="d423" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下一篇文章中，我将重点介绍为1.0.0版本安装和运行多租户客户机和服务器，这将包括以下架构和设计:</p><ul class=""><li id="35df" class="kp kq it js b jt ju jx jy kb kr kf ks kj kt kn ku kv kw kx bi translated">Angular 9.1.11(浏览器客户端)</li><li id="1eb1" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">Spring Boot 2.3.1 (RESTful API)</li><li id="94b3" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">ClearDB/MySQL(数据库)</li><li id="5c77" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">Okta(安全)</li><li id="d1f2" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">GitLab(源代码管理和CI/CD)</li><li id="3084" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">Heroku(应用托管)</li></ul><p id="f6be" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">祝你今天过得愉快！</p></div></div>    
</body>
</html>