<html>
<head>
<title>Upload a Docker Image to an Elastic Container Repository and Deploy with Elastic Container Services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Docker映像上传到弹性容器存储库，并使用弹性容器服务进行部署</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/upload-a-docker-image-to-aws-elastic-container-repository-and-deploy-with-aws-elastic-container-5be9ad222413?source=collection_archive---------6-----------------------#2020-05-30">https://levelup.gitconnected.com/upload-a-docker-image-to-aws-elastic-container-repository-and-deploy-with-aws-elastic-container-5be9ad222413?source=collection_archive---------6-----------------------#2020-05-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f69191b6b958f70af166df7cad3d8e9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pjwur-vxn3tVIu9jIBnmzw.png"/></div></div></figure><p id="41ee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文将演示如何将docker映像上传到AWS弹性容器库，并使用带有Fargate的AWS弹性容器服务集群部署该映像。这是两部分教程的第二部分，旨在强调ECS和ECR的基本功能，以及它们如何帮助简化您的容器CI/CD管道。第1部分“将一个节点应用程序连接到一个RDS实例并用Docker进行容器化”可以在 <a class="ae kx" href="https://medium.com/@alexanderegiannini/connect-a-node-application-to-an-rds-instance-and-containerize-with-docker-4af1911bd998" rel="noopener"> <em class="kw">这里</em> </a> <em class="kw">找到。</em></p><h1 id="0c8d" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">步骤1:创建Amazon ECR实例并上传Docker映像</h1><p id="577f" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">导航到ECR控制台并创建新的存储库。由于我们只处理一个图像，因此为存储库指定与图像相同的名称，并单击“创建存储库”。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mb"><img src="../Images/cc14b9396f9c6024d35c0dc20c36973d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nBcj_6278C28Iwr2Euhy1A.png"/></div></div></figure><p id="12b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将存储库命名为与您正在构建的容器相同的名称。对我来说是的，ecr-test。选择默认值，创建存储库，然后进入存储库页面。然后，点击“查看推送命令”(右上角)。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/9a50bc3f10d5ae5a7e493d50ead259c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gg4nby5Qv60rsH0tEJQWzg.png"/></div></div></figure><p id="46c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将为您提供一组四个命令。第一个让您登录到ECR。第二步是在您的机器上构建映像。第三个标记上传的图像。第四个上传图像。如果已经构建了映像，只需要运行第一个、第三个和第四个。</p><p id="7979" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">*注意:为此，您需要使用具有正确权限的用户登录AWS CLI。如果需要，参见<a class="ae kx" href="https://medium.com/@alexanderegiannini/connect-a-node-application-to-an-rds-instance-and-containerize-with-docker-4af1911bd998" rel="noopener">第1部分</a>了解如何操作。</p><p id="977f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查存储库以确保图像已经上传。现在，任何拥有IAM帐户并拥有适当权限的人都可以访问docker映像，这意味着团队可以在容器上工作。通过从ECR包中获取存储库URI并运行以下命令，确保“拉”功能正常工作:</p><pre class="mc md me mf gt mh mi mj mk aw ml bi"><span id="804d" class="mm kz iq mi b gy mn mo l mp mq">docker pull $ECR_URI</span></pre><p id="7a45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">*注意:您必须“登录”到ECR。这是在推送过程的第一步中完成的，但是根据已经过去的时间，您可能需要再次执行:</p><pre class="mc md me mf gt mh mi mj mk aw ml bi"><span id="109b" class="mm kz iq mi b gy mn mo l mp mq">$(aws ecr get-login — no-include-email — region us-east-1)</span></pre><h1 id="1f72" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">步骤2:创建一个Amazon ECS集群</strong></h1><p id="4a03" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">ECS集群是一个集中的位置，在这里可以部署具有特定设置的容器。集群使用“任务”来部署docker容器，并允许内部容器网络自动扩展和负载平衡。下一步是创建集群和任务，然后在集群中运行任务。</p><p id="0c4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要创建集群，请单击右上角的“集群”,然后单击左上角的“创建集群”,并选择EC2 Linux +网络。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/fed87f5988e998dc3df7610f3cd9247f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35GGJ9_T_k75GhlNo73Jzg.png"/></div></div></figure><p id="cbac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在给你的集群命名。选择“按需实例”和一个实例类型(我为这个项目推荐t3a.medium，因为nano有时太小，无法运行任务)。选择1个实例，并创建或使用ssh密钥，以便可以直接访问集群。</p><p id="5686" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，选择默认的VPC和一个子网(对我来说是us-east-1a)。最后，选择一个安全组。确保安全组对您的特定docker容器(即20/80/3000等)。</p><p id="d2b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">单击创建。需要几秒钟才能生成。完成后，单击查看集群。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/6c63656164da9f02e4201c138678425a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZJBm0VviUFU4nFU0HuPKHw.png"/></div></div></figure><p id="f2c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的群集将有各种选项卡，包括服务任务、ECS实例、指标、计划任务、标记和容量提供者。</p><p id="57cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建后，集群将开始使用“创建集群对话”中提供的详细信息初始化EC2实例。这是容器将被部署的地方。通过选择“ECS instance”选项卡，然后单击ec2实例ID，确认这正在发生。</p><h1 id="9e0d" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">步骤3:创建ECS任务</h1><p id="bdad" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">现在已经创建了EC2实例，集群需要一个任务来部署容器。任务为ECS提供了如何部署容器的详细信息。本教程将创建一个基本任务来运行第1部分中构建的容器。您可能希望根据您的使用情况进行修改。</p><p id="3325" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要创建任务定义，请单击最左侧的任务定义选项卡，然后单击创建新任务定义按钮。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/fed87f5988e998dc3df7610f3cd9247f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35GGJ9_T_k75GhlNo73Jzg.png"/></div></div></figure><p id="ae22" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，选择EC2，为任务定义命名，并输入以下内容:</p><pre class="mc md me mf gt mh mi mj mk aw ml bi"><span id="2c32" class="mm kz iq mi b gy mn mo l mp mq">task role: None</span><span id="0302" class="mm kz iq mi b gy mt mo l mp mq">Network Mode: Bridge</span><span id="f76e" class="mm kz iq mi b gy mt mo l mp mq">Task Execution Role: None</span><span id="f2e3" class="mm kz iq mi b gy mt mo l mp mq">Task Memory: 1 gb</span><span id="f708" class="mm kz iq mi b gy mt mo l mp mq">Task CPU: 128</span></pre><p id="e4f6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，单击添加容器。您可以在这里输入将要部署的容器的详细信息。给它一个名字，和存储库URI(这可以通过点击最左边的ECR选项卡找到，并复制应用程序映像的存储库URI)。接下来，将内存限制设置为硬限制128，并识别您的端口所开放的容器。如果您的following来自<a class="ae kx" href="https://medium.com/@alexanderegiannini/connect-a-node-application-to-an-rds-instance-and-containerize-with-docker-4af1911bd998" rel="noopener"> part1 </a>，它应该是3000，看起来如下:</p><pre class="mc md me mf gt mh mi mj mk aw ml bi"><span id="62e4" class="mm kz iq mi b gy mn mo l mp mq">host port: 80</span><span id="b60c" class="mm kz iq mi b gy mt mo l mp mq">container port: 3000</span><span id="67ce" class="mm kz iq mi b gy mt mo l mp mq">protocol: TCP</span></pre><p id="0616" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，添加实例(使用所有默认值)并创建任务(使用所有默认值)。现在任务已创建，请返回到您的群集并选择“tasks”选项卡，然后选择“run new task”。它将带您进入以下内容:</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/f8d009738fb70ab4cbe28fd554a5ed28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8mBk_UK-hFU2vy_MYl6G6Q.png"/></div></div></figure><p id="1fca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击“切换到启动类型”，并选择ec2。然后，选择新的任务定义并运行任务。过一会儿，刷新您的屏幕，您应该看到容器已经部署完毕，没有任何错误。</p><p id="93b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，检查你的任务是否正常工作。单击任务ID链接，然后展开任务ID名称旁边的箭头。找到外部链接，并看到您的容器正在指定的端口上运行。</p><h1 id="0f58" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">结论</h1><p id="ea0e" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">本教程旨在强调ECS和ECR的基本功能。为了进一步增强，我建议探索容器的安全管理，以及如何使用ECS的自动伸缩和负载平衡特性来部署可伸缩的容器化应用程序。</p></div></div>    
</body>
</html>