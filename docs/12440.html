<html>
<head>
<title>Node.js: How To Optimize Server Performance?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js:如何优化服务器性能？</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/node-js-how-to-optimise-server-performance-35c85421db18?source=collection_archive---------2-----------------------#2022-06-11">https://levelup.gitconnected.com/node-js-how-to-optimise-server-performance-35c85421db18?source=collection_archive---------2-----------------------#2022-06-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/faa40e29380dc668442619cb036fb578.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BYhm8c-OibCUQzwa.png"/></div></div></figure><p id="a53d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="kz">如果你是Python或编程的新手，可以看看我的新书《Python学习指南》<strong class="kd iu">’</strong><em class="kz">下面:</em></em></p><div class="lb lc gp gr ld le"><a href="https://bamaniaashish.gumroad.com/l/python-book" rel="noopener  ugc nofollow" target="_blank"><div class="lf ab fo"><div class="lg ab lh cl cj li"><h2 class="bd iu gy z fp lj fr fs lk fu fw is bi translated">学习Python的无牛指南</h2><div class="ll l"><h3 class="bd b gy z fp lj fr fs lk fu fw dk translated">你是一个正在考虑学习编程却不知道从哪里开始的人吗？我有适合你的解决方案…</h3></div><div class="lm l"><p class="bd b dl z fp lj fr fs lk fu fw dk translated">bamaniaashish.gumroad.com</p></div></div><div class="ln l"><div class="lo l lp lq lr ln ls jz le"/></div></div></a></div></div><div class="ab cl lt lu hx lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="im in io ip iq"><p id="7975" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Node.js运行一个<strong class="kd iu">单线程</strong>来计算并返回对传入请求的响应。</p><h2 id="93ea" class="ma mb it bd mc md me dn mf mg mh dp mi km mj mk ml kq mm mn mo ku mp mq mr ms bi translated">当一些请求需要大量计算时间时会发生什么？</h2><p id="e87f" class="pw-post-body-paragraph kb kc it kd b ke mt kg kh ki mu kk kl km mv ko kp kq mw ks kt ku mx kw kx ky im bi translated">我们的服务器将被封锁所有路线的新请求。</p><p id="077f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们来看看实际情况。</p><h1 id="6316" class="my mb it bd mc mz na nb mf nc nd ne mi nf ng nh ml ni nj nk mo nl nm nn mr no bi translated">创建Express服务器</h1><p id="37af" class="pw-post-body-paragraph kb kc it kd b ke mt kg kh ki mu kk kl km mv ko kp kq mw ks kt ku mx kw kx ky im bi translated">我们将首先创建一个Express服务器，它有到两个GET请求的路由。</p><p id="0a24" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">根('/')路由返回字符串' Welcome！'。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="03a5" class="ma mb it nu b gy ny nz l oa ob">const express = require("express");</span><span id="e0c5" class="ma mb it nu b gy oc nz l oa ob">const app = express();</span><span id="01ee" class="ma mb it nu b gy oc nz l oa ob">app.get("/", (req, res) =&gt; {<br/>    res.send("Welcome!");<br/>});</span></pre><p id="8913" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了使第二个路由请求耗时，让我们创建一个函数来延迟对传入请求的响应。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="ad54" class="ma mb it nu b gy ny nz l oa ob">function delay(duration){<br/>    const start_time = Date.now();<br/>    <br/>    while(Date.now() - start_time &lt; duration){<br/>    //do nothing<br/>    };<br/>};</span></pre><p id="d48f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该函数将在指定的时间内延迟服务器响应。</p><p id="a097" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们为它创建一条路线('/delay ')，并将其添加到我们的Express服务器中。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="71c4" class="ma mb it nu b gy ny nz l oa ob">const express = require("express");</span><span id="8880" class="ma mb it nu b gy oc nz l oa ob">const app = express();</span><span id="bece" class="ma mb it nu b gy oc nz l oa ob">app.get("/", (req, res) =&gt; {<br/>    res.send("Welcome!");<br/>});</span><span id="5534" class="ma mb it nu b gy oc nz l oa ob">app.get("/delay", (req, res) =&gt; {<br/>    delay(5000);<br/>    res.send("Delayed welcome!")<br/>    };<br/>);</span><span id="9a61" class="ma mb it nu b gy oc nz l oa ob">app.listen(3000, () =&gt; console.log("The server is running on port 3000"));</span></pre><p id="a644" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当我们在Express服务器上向'/delay '路由发出请求时，响应会延迟5000毫秒(5秒)。</p><p id="63f3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将阻塞我们的服务器，并且发送到根('/')路由的任何请求也将被延迟。</p><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi od"><img src="../Images/106f7d3a5964d23870b5fd80870d57dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PTGWrVywocRybXPr"/></div></div><figcaption class="oe of gj gh gi og oh bd b be z dk translated"><a class="ae la" href="https://unsplash.com/@kellysikkema?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Kelly Sikkema </a>在<a class="ae la" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="44fc" class="my mb it bd mc mz na nb mf nc nd ne mi nf ng nh ml ni nj nk mo nl nm nn mr no bi translated">如何优化？</h1><p id="0eae" class="pw-post-body-paragraph kb kc it kd b ke mt kg kh ki mu kk kl km mv ko kp kq mw ks kt ku mx kw kx ky im bi translated">为了避免此类问题并优化服务器性能，我们希望使用多个进程来处理我们的请求。</p><p id="4d46" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因为Node.js是单线程的，所以我们不能并行运行多个线程。</p><blockquote class="oi oj ok"><p id="513e" class="kb kc kz kd b ke kf kg kh ki kj kk kl ol kn ko kp om kr ks kt on kv kw kx ky im bi translated"><strong class="kd iu">这可以通过创建我们的Express服务器代码的多个副本并在我们的服务器机器的不同内核上运行它们来解决。</strong></p></blockquote><p id="4983" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们先来看看Node.js是如何运行一个服务器的。</p><h2 id="b751" class="ma mb it bd mc md me dn mf mg mh dp mi km mj mk ml kq mm mn mo ku mp mq mr ms bi translated">节点的内部工作。射流研究…</h2><p id="c0e6" class="pw-post-body-paragraph kb kc it kd b ke mt kg kh ki mu kk kl km mv ko kp kq mw ks kt ku mx kw kx ky im bi translated">当在我们的终端上执行“node server.js”时，会创建一个“主”进程。</p><p id="50af" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个过程运行我们的服务器代码。</p><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oo"><img src="../Images/0aaad1c9035cd74c5b6dc013c3eb0693.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mE-6pyAOGr6ZKCbenRWkww.png"/></div></div></figure><p id="654e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们可以从这个“主”流程创建多个子流程。</p><p id="69f5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这些被称为“工人”进程。</p><p id="7da9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">每个工作进程将运行我们的服务器代码的一个实例。</p><p id="46db" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将使用Node.js模块来帮助我们。</p><h2 id="903b" class="ma mb it bd mc md me dn mf mg mh dp mi km mj mk ml kq mm mn mo ku mp mq mr ms bi translated">Node.js集群模块</h2><p id="f3af" class="pw-post-body-paragraph kb kc it kd b ke mt kg kh ki mu kk kl km mv ko kp kq mw ks kt ku mx kw kx ky im bi translated">为了使用这个模块，我们将它导入到我们的服务器代码中。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="bd6e" class="ma mb it nu b gy ny nz l oa ob">const cluster = require("cluster");</span></pre><p id="0779" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用<code class="fe op oq or nu b"><a class="ae la" href="https://nodejs.org/api/child_process.html#child_processforkmodulepath-args-options" rel="noopener ugc nofollow" target="_blank">.fork()</a></code>方法生成工作进程。</p><h2 id="a6ce" class="ma mb it bd mc md me dn mf mg mh dp mi km mj mk ml kq mm mn mo ku mp mq mr ms bi translated">改变我们的服务器代码</h2><p id="ed54" class="pw-post-body-paragraph kb kc it kd b ke mt kg kh ki mu kk kl km mv ko kp kq mw ks kt ku mx kw kx ky im bi translated">我们将在服务器代码中添加以下条件来使用工作进程。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="3785" class="ma mb it nu b gy ny nz l oa ob">if (cluster.isMaster) {<br/>    console.log("Master process is running");</span><span id="9eb6" class="ma mb it nu b gy oc nz l oa ob">cluster.fork();<br/>    cluster.fork();<br/>    cluster.fork();</span><span id="4e3f" class="ma mb it nu b gy oc nz l oa ob">} else {<br/>    console.log("Worker process is running");</span><span id="4eae" class="ma mb it nu b gy oc nz l oa ob">app.listen(3000, () =&gt; console.log("The server is running on port 3000"));<br/>};</span></pre><p id="44c5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将从父“主”进程创建三个“工作”进程。</p><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi os"><img src="../Images/d79c2438d5e10693fc0823f5ea3c0b67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LALBVu2AwKPkuqZdPgkVyQ.png"/></div></div></figure><blockquote class="oi oj ok"><p id="72b0" class="kb kc kz kd b ke kf kg kh ki kj kk kl ol kn ko kp om kr ks kt on kv kw kx ky im bi translated">我们如何预先知道，我们应该创建多少个“工人”流程？</p></blockquote><h1 id="10cc" class="my mb it bd mc mz na nb mf nc nd ne mi nf ng nh ml ni nj nk mo nl nm nn mr no bi translated">根据CPU内核进行优化</h1><p id="3858" class="pw-post-body-paragraph kb kc it kd b ke mt kg kh ki mu kk kl km mv ko kp kq mw ks kt ku mx kw kx ky im bi translated">我们将使用所有CPU内核来运行工作进程，以使我们的服务器应用程序最高效。</p><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ot"><img src="../Images/e62ed40072efd0f1009d29164d823848.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*18EvJVJgEOXfjliY"/></div></div><figcaption class="oe of gj gh gi og oh bd b be z dk translated">克里斯蒂安·威迪格在<a class="ae la" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c34c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这可以通过根据服务器中可用的CPU内核数量生成“工作”进程来实现。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="8ff7" class="ma mb it nu b gy ny nz l oa ob">const os = require("os");</span><span id="342f" class="ma mb it nu b gy oc nz l oa ob">const NUM_WORKERS = os.cpus().length;</span><span id="6fa2" class="ma mb it nu b gy oc nz l oa ob">//This gives the number of the CPU cores available in our machine.</span></pre><p id="6dc0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们的代码可以更新如下。</p><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="d0a9" class="ma mb it nu b gy ny nz l oa ob">if (cluster.isMaster) {<br/>    console.log("Master process is running");</span><span id="fc83" class="ma mb it nu b gy oc nz l oa ob">for (let i=0; i &lt;=NUM_WORKERS ;i++){<br/>        cluster.fork();<br/>    };</span><span id="8aa0" class="ma mb it nu b gy oc nz l oa ob">} else {<br/>    console.log("Worker process is running");</span><span id="8177" class="ma mb it nu b gy oc nz l oa ob">app.listen(3000, () =&gt; console.log("The server is running on          port 3000"));<br/>};</span></pre><h1 id="9e6b" class="my mb it bd mc mz na nb mf nc nd ne mi nf ng nh ml ni nj nk mo nl nm nn mr no bi translated">负载平衡</h1><p id="fa28" class="pw-post-body-paragraph kb kc it kd b ke mt kg kh ki mu kk kl km mv ko kp kq mw ks kt ku mx kw kx ky im bi translated">为了将传入的请求分发到我们的服务器，使用了<strong class="kd iu">循环</strong>负载平衡方法。</p><p id="6ba8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在循环算法中，第一个请求被发送到第一个服务器，然后是第二个，依此类推，直到最后一个。然后再次启动，将下一个请求分配给第一个服务器，依此类推。</p><p id="4409" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该算法可以被加权，使得最强大的单元接收最大数量的请求并首先接收它们。</p><p id="deaa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这就是优化服务器性能的方法！</p><h1 id="e4aa" class="my mb it bd mc mz na nb mf nc nd ne mi nf ng nh ml ni nj nk mo nl nm nn mr no bi translated">完整的代码</h1><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="8549" class="ma mb it nu b gy ny nz l oa ob">const express = require("express");<br/>const os = require("os");</span><span id="17fa" class="ma mb it nu b gy oc nz l oa ob">const app = express();</span><span id="527f" class="ma mb it nu b gy oc nz l oa ob">function delay(duration){<br/>    const start_time = Date.now();<br/>    <br/>    while(Date.now() - start_time &lt; duration){<br/>    //do nothing<br/>    };<br/>};</span><span id="560a" class="ma mb it nu b gy oc nz l oa ob">app.get("/", (req, res) =&gt; {<br/>    res.send("Welcome!");<br/>});</span><span id="6a44" class="ma mb it nu b gy oc nz l oa ob">app.get("/delay", (req, res) =&gt; {<br/>    delay(5000);<br/>    res.send("Delayed welcome!")<br/>    };<br/>);</span><span id="d3c0" class="ma mb it nu b gy oc nz l oa ob">if (cluster.isMaster) {<br/>    console.log("Master process is running");</span><span id="a46e" class="ma mb it nu b gy oc nz l oa ob">const NUM_WORKERS = os.cpus().length;</span><span id="928c" class="ma mb it nu b gy oc nz l oa ob">for (let i=0; i &lt;=NUM_WORKERS ;i++){<br/>        cluster.fork();<br/>    };</span><span id="de92" class="ma mb it nu b gy oc nz l oa ob">} else {<br/>    console.log("Worker process is running");</span><span id="a452" class="ma mb it nu b gy oc nz l oa ob">app.listen(3000, () =&gt; console.log("The server is running on          port 3000"));<br/>};</span></pre><p id="3553" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">链接到节点集群文档:<br/><a class="ae la" href="https://nodejs.org/api/cluster.html" rel="noopener ugc nofollow" target="_blank">https://nodejs.org/api/cluster.html</a></p><p id="0d64" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">阅读更多关于负载均衡的内容:<a class="ae la" href="https://en.wikipedia.org/wiki/Load_balancing_(computing)#Static_load_distribution_without_prior_knowledge" rel="noopener ugc nofollow" target="_blank">https://en . Wikipedia . org/wiki/Load _ Balancing _(计算)# Static _ Load _ distribution _ without _ prior _ knowledge</a></p></div><div class="ab cl lt lu hx lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="im in io ip iq"><p id="8a0c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="kz">感谢您阅读本文！</em></p><p id="8d06" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="kz">如果你是Python或编程的新手，可以看看我的新书《没有公牛**t学习Python指南<strong class="kd iu">’</strong><em class="kz">》:</em></em></p><div class="lb lc gp gr ld le"><a href="https://bamaniaashish.gumroad.com/l/python-book" rel="noopener  ugc nofollow" target="_blank"><div class="lf ab fo"><div class="lg ab lh cl cj li"><h2 class="bd iu gy z fp lj fr fs lk fu fw is bi translated">学习Python的无牛指南</h2><div class="ll l"><h3 class="bd b gy z fp lj fr fs lk fu fw dk translated">你是一个正在考虑学习编程却不知道从哪里开始的人吗？我有适合你的解决方案…</h3></div><div class="lm l"><p class="bd b dl z fp lj fr fs lk fu fw dk translated">bamaniaashish.gumroad.com</p></div></div><div class="ln l"><div class="lo l lp lq lr ln ls jz le"/></div></div></a></div><div class="lb lc gp gr ld le"><a href="https://bamania-ashish.medium.com/membership" rel="noopener follow" target="_blank"><div class="lf ab fo"><div class="lg ab lh cl cj li"><h2 class="bd iu gy z fp lj fr fs lk fu fw is bi translated">通过我的推荐链接加入Medium-Ashish Bama nia博士</h2><div class="ll l"><h3 class="bd b gy z fp lj fr fs lk fu fw dk translated">阅读Ashish Bamania博士(以及Medium上成千上万的其他作家)的每一个故事。您的会员费直接…</h3></div><div class="lm l"><p class="bd b dl z fp lj fr fs lk fu fw dk translated">bamania-ashish.medium.com</p></div></div><div class="ln l"><div class="ou l lp lq lr ln ls jz le"/></div></div></a></div><h1 id="2d36" class="my mb it bd mc mz na nb mf nc nd ne mi nf ng nh ml ni nj nk mo nl nm nn mr no bi translated">分级编码</h1><pre class="np nq nr ns gt nt nu nv nw aw nx bi"><span id="59cb" class="ma mb it nu b gy ny nz l oa ob">Thanks for being a part of our community! More content in the <a class="ae la" href="https://levelup.gitconnected.com/" rel="noopener ugc nofollow" target="_blank">Level Up Coding publication</a>.</span><span id="d1d7" class="ma mb it nu b gy oc nz l oa ob">Follow: <a class="ae la" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>, <a class="ae la" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>, <a class="ae la" href="https://newsletter.levelup.dev/" rel="noopener ugc nofollow" target="_blank">Newsletter</a></span><span id="4c77" class="ma mb it nu b gy oc nz l oa ob">Level Up is transforming tech recruiting 👉 <a class="ae la" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"><strong class="nu iu">Join our talent collective</strong></a></span></pre></div></div>    
</body>
</html>