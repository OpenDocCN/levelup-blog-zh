<html>
<head>
<title>How to retrieve connection strings in azure key vault from ASP.NET using configuration builders, XML transformation, and azure devops.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用配置生成器、XML转换和azure devops从ASP.NET检索azure key vault中的连接字符串。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-retrieve-connection-strings-in-azure-key-vault-from-asp-net-2d8d9e15c87c?source=collection_archive---------12-----------------------#2020-05-19">https://levelup.gitconnected.com/how-to-retrieve-connection-strings-in-azure-key-vault-from-asp-net-2d8d9e15c87c?source=collection_archive---------12-----------------------#2020-05-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/c518efc1741c33e0920e22ec1b0ae88a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CN_K56oVzAg-zvyOktjzmw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来自<a class="ae kf" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2054429" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae kf" href="https://pixabay.com/users/TayebMEZAHDIA-4194100/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2054429" rel="noopener ugc nofollow" target="_blank">塔伊布·梅扎迪亚</a>的图片</figcaption></figure><p id="4bd9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">配置生成器是从外部源检索连接字符串的机制。使用配置构建器，除了安装包和为连接到流行的源提供XML配置之外，您可能不需要做太多的编码工作。在这篇文章中，我将与你分享我使用配置生成器的经验。NET从azure密钥库中安全地检索连接字符串。我将检查设置，并分享我在将我的应用程序与azure key vault集成时遇到的一些问题。</p><h1 id="e5e4" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">配置生成器是用来做什么的。网</h1><p id="f042" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">配置生成器是一个类，它公开用于检索在web.config或appsettings文件的<code class="fe mh mi mj mk b">&lt;appSettings&gt;</code>或<code class="fe mh mi mj mk b">connectionStrings</code>节中指定的键值的元数据和方法。微软提供了连接到secrets.json、azure key vault、环境变量等流行资源的配置生成器...您还可以实现自己的配置生成器，以连接到您想要的任何源。</p><blockquote class="ml mm mn"><p id="8272" class="kg kh mo ki b kj kk kl km kn ko kp kq mp ks kt ku mq kw kx ky mr la lb lc ld im bi translated"><em class="it">配置生成器为ASP.NET应用程序提供了一种现代、灵活的机制来从外部来源获取配置值。</em></p><p id="f7d0" class="kg kh mo ki b kj kk kl km kn ko kp kq mp ks kt ku mq kw kx ky mr la lb lc ld im bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/aspnet/config-builder" rel="noopener ugc nofollow" target="_blank"> <em class="it">为ASP.NET配置建设者</em> </a></p></blockquote><p id="4ff3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于我的ASP.NET应用程序，我使用了微软提供的两个配置生成器:<code class="fe mh mi mj mk b">Microsoft.Configuration.ConfigurationBuilders.UserSecretsConfigBuilder </code>和<code class="fe mh mi mj mk b">Microsoft.Configuration.ConfigurationBuilders.AzureKeyVaultConfigBuilder</code></p><p id="fe76" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从文档中，配置生成器:</p><blockquote class="ml mm mn"><p id="515d" class="kg kh mo ki b kj kk kl km kn ko kp kq mp ks kt ku mq kw kx ky mr la lb lc ld im bi translated"><em class="it">。在中提供。NET Framework 4.7.1及更高版本。</em></p><p id="377a" class="kg kh mo ki b kj kk kl km kn ko kp kq mp ks kt ku mq kw kx ky mr la lb lc ld im bi translated"><em class="it">。为读取配置值提供灵活的机制。</em></p><p id="99f5" class="kg kh mo ki b kj kk kl km kn ko kp kq mp ks kt ku mq kw kx ky mr la lb lc ld im bi translated"><em class="it">。当应用程序迁移到以容器和云为中心的环境中时，满足它们的一些基本需求。</em></p><p id="732f" class="kg kh mo ki b kj kk kl km kn ko kp kq mp ks kt ku mq kw kx ky mr la lb lc ld im bi translated"><em class="it">。中以前不可用的资源(例如，Azure Key Vault和环境变量)来提高对配置数据的保护。NET配置系统。</em></p><p id="2606" class="kg kh mo ki b kj kk kl km kn ko kp kq mp ks kt ku mq kw kx ky mr la lb lc ld im bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/aspnet/config-builder" rel="noopener ugc nofollow" target="_blank"> <em class="it">配置建设者为ASP.NET</em></a></p></blockquote><h1 id="73d2" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">总体战略</h1><p id="e0a5" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">下面我概述了我用来从源代码中删除连接字符串的高级计划:</p><ol class=""><li id="f01e" class="ms mt it ki b kj kk kn ko kr mu kv mv kz mw ld mx my mz na bi translated">将应用程序更新到目标。NET framework 4.7.1或更高版本。</li><li id="4a53" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated">对于本地环境，利用<code class="fe mh mi mj mk b">UserSecretsConfigBuilder</code>和。NET secret management来存储和检索secrets.json中的连接字符串，secrets . JSON是一个驻留在您的计算机上并通过secret manager与您的项目链接的文件。</li><li id="640b" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated">对于其他环境(开发、试运行、生产等..)，使用<code class="fe mh mi mj mk b">AzureKeyVaultConfigBuilder</code>在azure key vault中存储和检索连接字符串。</li><li id="b353" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated">为每个其他环境创建一个web.config文件，在这些环境中，您可以指定XML转换规则来应用连接到特定密钥库的配置。</li><li id="967f" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated">在azure发布管道中，使用<strong class="ki iu">文件转换</strong>特性来转换web.config和web中的配置。{环境}。配置文件。</li></ol><p id="fb47" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在接下来的部分中，我将讨论细节并分享代码。</p><h1 id="cf10" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">将您的应用程序更新到目标。NET Framework 4.7.1或更高版本</h1><p id="e907" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">根据文档，如果您的应用程序的目标版本是。NET早于4.7.1，需要升级到4.7.1或更高版本。对于我的项目，我的目标是。NET 4.8，因为在撰写本文时这是最新版本。</p><h1 id="0e0a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用UserSecretsConfigBuilder存储和检索连接字符串</h1><p id="a05b" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">秘密管理是一个链接源代码之外的XML文件的工具。默认情况下，该文件的名称是<strong class="ki iu"> secrets.xml. </strong>在运行时，框架将secrets.xml中的名称与web.config或appsettings.config中的连接字符串进行匹配，并用secrets.xml文件中的值替换连接字符串。</p><blockquote class="ng"><p id="3231" class="nh ni it bd nj nk nl nm nn no np ld dk translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/azure/key-vault/general/vs-secure-secret-appsettings#save-secret-settings-in-user-secret-store-that-is-outside-of-source-control-folder" rel="noopener ugc nofollow" target="_blank"> <em class="nq">用户机密存储是保存在用户配置文件文件夹下的文件，因此机密不会签入源代码管理。</em> </a></p></blockquote><p id="07e6" class="pw-post-body-paragraph kg kh it ki b kj nr kl km kn ns kp kq kr nt kt ku kv nu kx ky kz nv lb lc ld im bi translated">使用秘密管理最简单的方法是使用Visual Studio。你只需要右击你的项目，选择<strong class="ki iu">管理用户机密</strong></p><figure class="nx ny nz oa gt ju gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/dfc97fa97b952ba0506d19b91695b6ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:802/0*IKg8cKjT0x6rSayD"/></div></figure><p id="66fe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该工具的作用是安装必要的nuget包，为您的秘密文件生成一个id，在以id为名称的文件夹下创建一个文件，并在web.xml文件中插入相关配置。比如我用的是Windows 10，对我来说，工具在:<code class="fe mh mi mj mk b">C:\Users\tbo\AppData\Roaming\Microsoft\UserSecrets\ffc6ae13-97c8-489c-b519-3f724580a587.</code>下创建文件</p><p id="30a7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在my web.xml中，该工具插入了以下内容:</p><pre class="nx ny nz oa gt ob mk oc od aw oe bi"><span id="4281" class="of lf it mk b gy og oh l oi oj">&lt;configSections&gt;<br/> &lt;section name="configBuilders" type="System.Configuration.ConfigurationBuildersSection, System.Configuration, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" restartOnExternalChanges="false" requirePermission="false" /&gt;<br/>&lt;/configSections&gt;<br/>&lt;configBuilders&gt;<br/> &lt;builders&gt;<br/>  &lt;add name="Secrets" userSecretsId="ffc6ae13-97c8-489c-b519-3f724580a587" type="Microsoft.Configuration.ConfigurationBuilders.UserSecretsConfigBuilder, Microsoft.Configuration.ConfigurationBuilders.UserSecrets, Version=1.0.0.0, Culture=neutral" /&gt;<br/> &lt;/builders&gt;<br/>&lt;/configBuilders&gt;</span></pre><p id="4851" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该工具还会将以下软件包安装到我的应用程序中:</p><pre class="nx ny nz oa gt ob mk oc od aw oe bi"><span id="4b9c" class="of lf it mk b gy og oh l oi oj">&lt;package id="Microsoft.Configuration.ConfigurationBuilders.Base" version="2.0.0" targetFramework="net48" /&gt; <br/>&lt;package id="Microsoft.Configuration.ConfigurationBuilders.UserSecrets" version="2.0.0" targetFramework="net48" /&gt;</span></pre><p id="f9db" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">My secrets.xml如下所示:</p><pre class="nx ny nz oa gt ob mk oc od aw oe bi"><span id="aa7c" class="of lf it mk b gy og oh l oi oj">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;root&gt;<br/> &lt;secrets ver="1.0"&gt;<br/>  &lt;secret name="MyConnectionString" value="insert your connection string here"&gt;&lt;/secret&gt;<br/> &lt;/secrets&gt;<br/>&lt;/root&gt;</span></pre><p id="df9d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我的web.config中，</p><pre class="nx ny nz oa gt ob mk oc od aw oe bi"><span id="f90b" class="of lf it mk b gy og oh l oi oj">&lt;connectionStrings configBuilders="Secrets"&gt;<br/> &lt;add name="MyConnectionString" providerName="System.Data.SqlClient" connectionString="from secrets" /&gt;<br/>&lt;/connectionStrings&gt;</span></pre><p id="e448" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意configBuilders的值是<strong class="ki iu"> Secrets </strong>，它与<strong class="ki iu">config sections-&gt;builders</strong>下的名称相匹配。您可以使用不同的名称，它必须与您在<strong class="ki iu"> builders </strong>部分中指定的名称相匹配。</p><h1 id="f9ce" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用AzureKeyVaultConfigBuilder存储和检索连接字符串</h1><p id="2ba8" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">添加一个配置生成器来与azure key vault集成是相当简单的，因为设置与secrets.xml文件类似。</p><p id="0e46" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，确保您的项目包含以下nuget包:</p><pre class="nx ny nz oa gt ob mk oc od aw oe bi"><span id="faac" class="of lf it mk b gy og oh l oi oj">&lt;package id="Microsoft.Configuration.ConfigurationBuilders.Azure" version="1.0.1" targetFramework="net48" /&gt;<br/>&lt;package id="Microsoft.Configuration.ConfigurationBuilders.Base" version="1.0.1" targetFramework="net48" /&gt;<br/>&lt;package id="Azure.Core" version="1.0.0" targetFramework="net48" /&gt;<br/>&lt;package id="Azure.Identity" version="1.0.0" targetFramework="net48" /&gt;<br/>&lt;package id="Azure.Security.KeyVault.Secrets" version="4.0.0" targetFramework="net48" /&gt;<br/>&lt;package id="Microsoft.Azure.KeyVault" version="3.0.5" targetFramework="net48" /&gt;<br/>&lt;package id="Microsoft.Azure.KeyVault.WebKey" version="3.0.5" targetFramework="net48" /&gt;<br/>&lt;package id="Microsoft.Azure.Services.AppAuthentication" version="1.4.0" targetFramework="net48" /&gt;</span></pre><p id="9c04" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的片段中，我展示了适用于我的项目的nuget版本。如果您的项目针对不同的。NET framework版本，您应该检查文档，或者您可能必须经过几次试验才能获得适用于您的项目的版本。由于不兼容的nuget包，我遇到了问题。</p><p id="b141" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mo">注意</em> : <br/> <strong class="ki iu"> <em class="mo">如果库的版本不兼容，您可能会遇到问题。比如微软。configuration builders . Azure 1 . 0 . 1版可能无法与Microsoft一起使用。configuration . configuration builders . base版本2.0。</em>T15】</strong></p><p id="353b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">安装完软件包后，在web.config中添加配置生成器:</p><pre class="nx ny nz oa gt ob mk oc od aw oe bi"><span id="7dcc" class="of lf it mk b gy og oh l oi oj">&lt;configBuilders&gt;<br/> &lt;builders&gt;<br/>  &lt;add name="AzureKeyVault" uri="[VaultUri]" type="Microsoft.Configuration.ConfigurationBuilders.AzureKeyVaultConfigBuilder, Microsoft.Configuration.ConfigurationBuilders.Azure, Version=1.0.0.0, Culture=neutral" /&gt;<br/> &lt;/builders&gt;<br/>&lt;/configBuilders&gt;</span></pre><p id="5fa1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的片段中，注意我有uri =<strong class="ki iu">【VaultUri】</strong>。请注意，我将展示如何使用azure devops在发布管道中进行XML转换，用连接到我的密钥库的Uri替换[VaultUri]。</p><p id="d159" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在您的<code class="fe mh mi mj mk b">&lt;connectionStrings&gt;</code>部分中，设置configBuilders属性以使用azure key vault配置生成器。</p><pre class="nx ny nz oa gt ob mk oc od aw oe bi"><span id="594a" class="of lf it mk b gy og oh l oi oj">&lt;connectionStrings configBuilders="AzureKeyVault"&gt;<br/> &lt;add name="MyConnectionString" providerName="System.Data.SqlClient" connectionString="from key vault" /&gt;<br/>&lt;/connectionStrings&gt;</span></pre><p id="eaed" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在您的密钥库中，您的机密的名称应该与您的连接字符串的名称相匹配。按照上面的例子，您应该在您的密钥库中将您的秘密命名为“MyConnectionString”。</p><p id="1b6d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可能想知道应用程序如何认证访问密钥库？神奇就在<code class="fe mh mi mj mk b">Microsoft.Azure.Services.AppAuthentication </code>包里。在没有连接字符串的情况下，库会自动尝试其他方法来验证azure:托管服务标识、Azure CLI和Visual Studio。我的应用运行在启用了托管身份的azure VM上，因此我不必指定连接字符串。我相信当前版本的<code class="fe mh mi mj mk b">AzureKeyVaultConfigBuilder</code>不允许指定连接字符串，因为它违背了在源代码中没有连接字符串的初衷。如果你的应用不在具有托管身份的azure资源上运行，你可能需要考虑通过其他方法配置身份验证。</p><p id="6a66" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果一切正常，您应该能够从密钥库中检索连接字符串。</p><p id="bdf0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在实际项目中，我们通常必须处理多种环境，并从不同的密钥库中提取连接字符串。此外，对于本地开发，我们可能希望只使用秘密管理。处理多种环境的一种方式是使用azure devops。</p><h1 id="0376" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">为多种环境应用不同的配置</h1><p id="b703" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在一个典型的ASP.NET项目中，通常有这些Web.config文件。使用MSBuild生成项目时，可以指定一个配置标志。例如，如果使用发布配置进行生成，MSBuild将应用您在Web文件中指定的XML转换逻辑。在构建的最后，您有了一个包含Web.config.xml的工件，其中的一些配置已经根据您的xml转换逻辑进行了更新。</p><p id="1da0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，下面的命令将在Web中应用XML转换逻辑。Release.config.xml来修改Web.config.xml中的内容。</p><pre class="nx ny nz oa gt ob mk oc od aw oe bi"><span id="7f8a" class="of lf it mk b gy og oh l oi oj">"C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\msbuild.exe" "D:\a\1\s\ASMAngular\ASMangular.sln" /nologo /nr:false /dl:CentralLogger,"D:\a\_tasks\VSBuild_71a9a2d3-a98a-4caa-96ab-affca411ecda\1.166.0\ps_modules\MSBuildHelpers\Microsoft.TeamFoundation.DistributedTask.MSBuild.Logger.dll";"RootDetailId=3985d9c0-f0b7-4859-974e-6de12c486b5e|SolutionDir=D:\a\1\s\ASMAngular"*ForwardingLogger,"D:\a\_tasks\VSBuild_71a9a2d3-a98a-4caa-96ab-affca411ecda\1.166.0\ps_modules\MSBuildHelpers\Microsoft.TeamFoundation.DistributedTask.MSBuild.Logger.dll" /p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="D:\a\1\a" /p:platform="Any CPU" /p:configuration="Release" /p:VisualStudioVersion="16.0" /p:_MSDeployUserAgent="VSTS_dbbe18ec-e0b5-4828-8485-4939250dac49_build_98_0"</span></pre><p id="c813" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为一个例子，我的Web中有以下转换逻辑。Development.config.xml来检索我们的开发环境密钥库中的连接字符串。</p><pre class="nx ny nz oa gt ob mk oc od aw oe bi"><span id="e343" class="of lf it mk b gy og oh l oi oj">&lt;configuration<br/> xmlns:xdt="<a class="ae kf" href="http://schemas.microsoft.com/XML-Document-Transform" rel="noopener ugc nofollow" target="_blank">http://schemas.microsoft.com/XML-Document-Transform</a>"&gt;<br/> &lt;configBuilders&gt;<br/>  &lt;builders&gt;<br/>   &lt;add name="AzureKeyVault" xdt:Transform="SetAttributes" xdt:Locator="Match(name)" uri="<a class="ae kf" href="https://myvaultdev.vault.azure.net/" rel="noopener ugc nofollow" target="_blank">https://myvaultdev.vault.azure.net/</a>"/&gt;<br/>  &lt;/builders&gt;<br/> &lt;/configBuilders&gt;<br/> &lt;connectionStrings configBuilders="AzureKeyVault" xdt:Transform="SetAttributes"&gt;&lt;/connectionStrings&gt;<br/>&lt;/configuration&gt;</span></pre><p id="139b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的代码片段搜索名为<strong class="ki iu">azurekeyfault</strong>的<code class="fe mh mi mj mk b">&lt;builders&gt; </code>部分，并用值设置uri属性以连接到密钥库。它还更新Web.config.xml中的<code class="fe mh mi mj mk b">&lt;connectionStrings&gt;</code>部分，以使用配置生成器<strong class="ki iu">azurekeyfault</strong>。</p><p id="a24d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如您所见，我们可以有一个Web.config文件，其中包含核心配置和多个Web。{环境}。每个文件都有针对不同环境的特定配置。接下来，我将向您展示如何使用azure devops在部署时转换Web.config，以实现“一次构建，随处部署”。</p><h1 id="3157" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">在azure发布管道中使用文件转换来转换Web.config。</h1><p id="34db" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">Azure devops拥有模板<strong class="ki iu"> IIS部署</strong>，它拥有将应用部署到IIS所需的一切。在<strong class="ki iu"> IIS Web App Deploy </strong>任务下，您可以启用<strong class="ki iu"> XML转换</strong>在您想要部署应用的机器上运行转换规则。Azure devops根据阶段<strong class="ki iu">的值</strong>选择正确的文件来获取转换逻辑。</p><p id="fb10" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，在我的发布管道中，我有<strong class="ki iu">开发</strong>阶段，我的任务是将应用程序部署到我们的开发服务器。当发布管道运行时，azure devops代理会自动在my Web中应用转换逻辑。将Development.config xml文件转换为Web.config xml文件。</p><figure class="nx ny nz oa gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ok"><img src="../Images/53e7f0ba492ef2279e23d1fb2210924c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4Mlacsir65n1DWZh"/></div></div></figure><p id="1065" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面的代码片段显示了应用转换后生成的Web.config文件中的相关部分:</p><pre class="nx ny nz oa gt ob mk oc od aw oe bi"><span id="92e2" class="of lf it mk b gy og oh l oi oj">&lt;configuration&gt;<br/> &lt;configSections&gt;<br/>  &lt;section name="configBuilders" type="System.Configuration.ConfigurationBuildersSection, System.Configuration, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" restartOnExternalChanges="false" requirePermission="false" /&gt;<br/> &lt;/configSections&gt;<br/> &lt;configBuilders&gt;<br/>  &lt;builders&gt;<br/>   &lt;add name="Secrets" userSecretsId="ffc6ae13-97c8-489c-b519-3f724580a587" type="Microsoft.Configuration.ConfigurationBuilders.UserSecretsConfigBuilder, Microsoft.Configuration.ConfigurationBuilders.UserSecrets, Version=1.0.0.0, Culture=neutral" /&gt;<br/>   &lt;add name="AzureKeyVault" uri="<a class="ae kf" href="https://myvaultdev.vault.azure.net/" rel="noopener ugc nofollow" target="_blank">https://myvaultdev.vault.azure.net/</a>" type="Microsoft.Configuration.ConfigurationBuilders.AzureKeyVaultConfigBuilder, Microsoft.Configuration.ConfigurationBuilders.Azure, Version=1.0.0.0, Culture=neutral" /&gt;<br/>  &lt;/builders&gt;<br/> &lt;/configBuilders&gt;<br/> &lt;connectionStrings configBuilders="AzureKeyVault"&gt;<br/>  &lt;add name="MyConnectionString" providerName="System.Data.SqlClient" connectionString="from key vault" /&gt;<br/> &lt;/connectionStrings&gt;<br/>&lt;/configuration&gt;</span></pre><p id="5970" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果一切正常，你可以声明你的代码没有敏感信息。但是，如果这是您第一次使用配置生成器，您可能会遇到问题。在下一节中，我将分享我在使用这个库时遇到的一些错误。</p><h1 id="1d55" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">您可能遇到的错误</h1><p id="92e8" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果你遇到错误，帮助调试的一个技巧是在本地浏览器中运行应用程序，因为如果你远程访问应用程序，框架可能不会显示太多细节。另一个技巧是在您的web.xml开发/测试环境中设置<code class="fe mh mi mj mk b">&lt;customErrors mode="Off"&gt;</code>，因为这将允许您查看错误细节。</p><blockquote class="ng"><p id="5f0f" class="nh ni it bd nj nk nl nm nn no np ld dk translated"><a class="ae kf" href="https://support.microsoft.com/en-us/help/815166/how-to-troubleshoot-asp-net-web-applications" rel="noopener ugc nofollow" target="_blank"> <em class="nq">当&lt; customErrors &gt;被启用时，ASP.NET不显示详细的错误信息。</em> </a></p></blockquote><p id="7f1b" class="pw-post-body-paragraph kg kh it ki b kj nr kl km kn ns kp kq kr nt kt ku kv nu kx ky kz nv lb lc ld im bi translated">我学到的第三个技巧是用最少的代码创建一个简单的控制台应用程序来测试配置。</p><p id="a4b3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是我在使用配置生成器将我的应用程序与azure key vault集成时遇到的一些错误。</p><figure class="nx ny nz oa gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ok"><img src="../Images/7eb49d408ff97a0e788134f1a0fbf53c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JVFNBFJgjMG35ugk"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">未能加载文件或程序集。配置. ConfigurationBuilders.Azure</figcaption></figure><p id="f3dc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的错误可能与不兼容的nuget包有关。检查您的依赖项列表，确保它们彼此兼容。</p><figure class="nx ny nz oa gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ok"><img src="../Images/92c842c4acbcbe6da7eb3ba6da639984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3qH_VjwX9PmHDPrC"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">加载程序集的另一个问题是</figcaption></figure><p id="5f00" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的错误确实具有误导性，因为它似乎表明库试图从密钥库中提取一个名为“LocalSqlServer”的秘密。我有时会花很多时间查看<code class="fe mh mi mj mk b">AzureKeyVaultConfigBuilder</code>的源代码，看看它为什么会试图获取那个秘密。然而，事实证明这个错误是因为无法加载Azure。堆芯组件，如<strong class="ki iu">组件载荷跟踪</strong>部分所示。</p><figure class="nx ny nz oa gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ok"><img src="../Images/9a5f0100fd74ae8783587423ffae54f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7R7P-VG7DRih9HO4"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">httpRuntime的问题</figcaption></figure><p id="2ec9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您使用面向的HttpRunTime的旧版本，则可能会出现上述错误。NET Framework 4.7.1或更低版本。在Web.config文件中，确保httpRunTime目标。NET Framework 4.7.1或以上版本。</p><pre class="nx ny nz oa gt ob mk oc od aw oe bi"><span id="201e" class="of lf it mk b gy og oh l oi oj">&lt;httpRuntime targetFramework="4.7.1" /&gt;</span></pre><p id="0a50" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我想分享的最后一个错误是例外:</p><blockquote class="ng"><p id="0cf9" class="nh ni it bd nj nk nl nm nn no np ld dk translated"><em class="nq">尝试了以下4种方法来获取访问令牌，但都不起作用</em>。</p></blockquote><p id="bfe8" class="pw-post-body-paragraph kg kh it ki b kj nr kl km kn ns kp kq kr nt kt ku kv nu kx ky kz nv lb lc ld im bi translated">我得到这个错误是因为使用了旧版本的</p><p id="ad9b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mh mi mj mk b">Microsoft.Azure.Services.AppAuthentication</code>。在我将这个库的版本更新到1.4.0之后，这个问题就消失了。</p><p id="8d03" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样。希望您现在已经知道如何使用配置生成器、每个环境一个Web.config文件、XML转换和azure devops来为不同的环境提取配置，而不必编写太多样板代码。</p><h1 id="7bcd" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">参考</h1><p id="4423" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/aspnet/config-builder#azurekeyvaultconfigbuilder" rel="noopener ugc nofollow" target="_blank"> Azure key vault配置生成器</a></p><p id="04aa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/azure/key-vault/general/vs-secure-secret-appsettings" rel="noopener ugc nofollow" target="_blank">安全保存网络应用的秘密应用设置</a></p><p id="66c4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://blog.elmah.io/web-config-transformations-the-definitive-syntax-guide/" rel="noopener ugc nofollow" target="_blank"> Web配置转换—权威语法指南</a></p><p id="ce5b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/previous-versions/dd465326(v=vs.100)?redirectedfrom=MSDN" rel="noopener ugc nofollow" target="_blank"> Web应用项目部署的Web.config转换语法</a></p><p id="0844" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/transforms-variable-substitution?view=azure-devops&amp;tabs=Classic" rel="noopener ugc nofollow" target="_blank"> Azure devops文件转换和变量替换参考</a></p><p id="b677" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://stackify.com/web-config-customerrors-asp-net/" rel="noopener ugc nofollow" target="_blank">如何使用Web。ASP.NET的配置客户错误</a></p></div><div class="ab cl ol om hx on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="im in io ip iq"><p id="a418" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mo">原载于2020年5月19日https://www.taithienbo.com</em><a class="ae kf" href="https://www.taithienbo.com/how-to-retrieve-connection-strings-in-azure-key-vault-from-asp-net-using-configuration-builders-xml-transformation-and-azure-devops/" rel="noopener ugc nofollow" target="_blank"><em class="mo"/></a><em class="mo">。</em></p></div></div>    
</body>
</html>