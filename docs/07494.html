<html>
<head>
<title>Gotchas using React Apollo MockProvider</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React Apollo MockProvider的陷阱</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/gotchas-using-react-apollo-mockprovider-ec2a22a07e76?source=collection_archive---------8-----------------------#2021-02-22">https://levelup.gitconnected.com/gotchas-using-react-apollo-mockprovider-ec2a22a07e76?source=collection_archive---------8-----------------------#2021-02-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/741686e64092ee839f66f408c6d52d08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lE7u6Ks0F7n3Kb8-ceufEQ.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">图片由<a class="ae kf" href="http://rawpixel.com/" rel="noopener ugc nofollow" target="_blank">rawpixel.com</a></figcaption></figure><p id="6271" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">MockProvider是模仿Apollo客户机的请求和结果的推荐方式。示例代码看起来很简单，但是在实际应用中，你可能会遇到一些障碍。尽管在medium上已经有一篇关于MockProvider使用技巧的很棒的<a class="ae kf" href="https://medium.com/@jialhe85/testing-tips-for-apolloclient-with-react-b58373eebb96" rel="noopener">文章</a>，我仍然花了几个小时处理MockProvier的意外行为。在这篇文章中，我将在适当地模仿回答之前，先回顾一下我发现的一些问题。</p><p id="9a64" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">仅供参考以下是我在本文中使用的环境:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="f9c0" class="ln lo it lj b gy lp lq l lr ls">@apollo/client: 3.2.0<br/>react-native:0.62.2<br/>jest: 24.9.0<br/>react-native-testing-library: 2.1.1</span></pre><h1 id="da8b" class="lt lo it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">1.直接从hooks包导入useQuery</h1><p id="7ec2" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">当您使用MockProvider运行第一个测试时，您可能会得到下面的错误消息:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="9cb9" class="ln lo it lj b gy lp lq l lr ls">TypeError: (0 , _client.useQuery) is not a function<br/>    &gt; 35 |   const { data } = useQuery(document, {</span></pre><figure class="le lf lg lh gt ju gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/8af1879e0c9584a85e0fbe84b58bd7d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/1*-qPimpmjSZPdAd-03bBRQA.png"/></div></figure><p id="8345" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当您从<code class="fe mw mx my lj b">@apollo/client</code>导入<code class="fe mw mx my lj b">useQuery</code>时会发生这种情况。你需要直接从<code class="fe mw mx my lj b">@apollo/client/react/hooks/useQuery</code>进口</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="e797" class="ln lo it lj b gy lp lq l lr ls">import { useQuery } from '<a class="ae kf" href="http://twitter.com/apollo/client" rel="noopener ugc nofollow" target="_blank">@apollo/client</a>/react/hooks/useQuery'</span></pre><h1 id="7783" class="lt lo it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">2.片段应该总是定义__typename</h1><p id="08f9" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">我在上面分享的文章中已经提到了这一点，但我想再次强调，因为你很容易陷入这个陷阱。如果使用Fragment，即使gql没有定义<code class="fe mw mx my lj b">__typename</code>，也应该始终将<code class="fe mw mx my lj b">__typename</code>添加到模拟响应中，否则Apollo将无法返回值。</p><p id="093e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里有一个例子:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="43f1" class="ln lo it lj b gy lp lq l lr ls">query currentUserFriends(<br/>   {<br/>  me {<br/>    id<br/>    friends {<br/>      pageInfo {<br/>        ...pageInfoFragment<br/>      }<br/>      ...<br/>    }<br/>  }<br/>}</span><span id="8834" class="ln lo it lj b gy mz lq l lr ls">fragment pageInfoFragment on PageInfo {<br/>  endCursor<br/>  hasNextPage<br/>  hasPreviousPage<br/>  startCursor<br/>}</span></pre><p id="ffa4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那么你的嘲笑应该是:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="fe1f" class="ln lo it lj b gy lp lq l lr ls">const mocks = [<br/>      {<br/>        request: {... },<br/>        result: {<br/>          data: {<br/>            me: {<br/>              id: '123',<br/>              friends: {<br/>                __typename: 'FriendConnection',<br/>                pageInfo: {<br/>                  __typename: 'PageInfo',<br/>                  endCursor: '1',<br/>                  hasNextPage: false,<br/>                  hasPreviousPage: false,<br/>                  startCursor: '2',<br/>                }, ...<br/>              },<br/>              __typename: 'Me',<br/>            },<br/>          },<br/>        },<br/>      },<br/>    ];</span></pre><p id="9d0a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，您希望确保<em class="na">模拟可选的字段。</em>假设一个<code class="fe mw mx my lj b">Friend</code>字段类型如下所示:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="4ade" class="ln lo it lj b gy lp lq l lr ls">{|<br/>  __typename: "Friend",<br/>  id: string,<br/>  name: string,<br/>  age: ?number<br/>|}</span></pre><p id="d32e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那么mock应该有<code class="fe mw mx my lj b">age</code>即使值可以是null。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="8d5f" class="ln lo it lj b gy lp lq l lr ls">{<br/>  __typename: "Friend",<br/>  id: 3,<br/>  name: "Buck",<br/>  age: null<br/>}</span></pre><h1 id="5457" class="lt lo it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">3.确保重新渲染组件以获得模拟结果</h1><p id="35d2" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">除非您显式触发render并执行更新，否则MockProvider不会给出模拟响应。如果您正在使用<code class="fe mw mx my lj b">react-native-testing-library</code>，那么<code class="fe mw mx my lj b">act</code>功能将更新组件。我创建了一个包装组件，如下所示:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="5566" class="ln lo it lj b gy lp lq l lr ls">const updateWrapper = async (wrapper, time = 10) =&gt; {<br/>  await act(async () =&gt; {<br/>    await new Promise(res =&gt; setTimeout(res, time));<br/>  });<br/>};</span></pre><p id="1e30" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">测试时，它看起来像这样:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="fb29" class="ln lo it lj b gy lp lq l lr ls">const { getByText } = render(component);<br/>await updateWrapper(component);<br/>expect(getByText('<a class="ae kf" href="http://twitter.com/Buck" rel="noopener ugc nofollow" target="_blank">@Buck</a>'));</span></pre><h1 id="f773" class="lt lo it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">4.注入InMemoryCache以显示错误消息</h1><p id="69e7" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">这是模拟查询失败时您将收到的典型消息。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="faed" class="ln lo it lj b gy lp lq l lr ls">No instances found</span><span id="51db" class="ln lo it lj b gy mz lq l lr ls">   96 |     const { getByText } = render(component);<br/>   97 |     await updateWrapper(component);<br/>&gt;  98 |     expect(getByText('<a class="ae kf" href="http://twitter.com/Buck" rel="noopener ugc nofollow" target="_blank">@Buck</a>'));</span></pre><figure class="le lf lg lh gt ju gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/017e63f0672a4134151d37487878d709.png" data-original-src="https://miro.medium.com/v2/resize:fit:714/format:webp/1*TRVrQmlSmcCaqfEEXcFivw.png"/></div></figure><p id="ea9d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">老实说，这个信息对我们一点帮助也没有；我们不知道它为什么会失败。为了获得更精确的错误消息，我们添加InMemoryCache作为MockProvider的道具。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="044a" class="ln lo it lj b gy lp lq l lr ls">&lt;MockedProvider<br/>  mocks={mocks}<br/>  addTypename<br/>  cache={<br/>    new InMemoryCache({<br/>      possibleTypes,<br/>    })<br/>  }<br/>&gt;<br/>  {component}<br/>&lt;/MockedProvider&gt;</span></pre><p id="4026" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在内部，Apollo将尝试在缓存中写入结果。在这个过程中，当InMemoryCache发现查询有不变冲突时，它将抛出一个错误。</p><p id="dfe7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">添加InMemoryCache后，您可能会看到下面的错误。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="368d" class="ln lo it lj b gy lp lq l lr ls">Invariant Violation: Missing field 'node' in {<br/>     "__typename": "FriendEdge",<br/>     "cursor": "a"<br/>   }</span></pre><figure class="le lf lg lh gt ju gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/0856f047879fab27704e53d2a4c93da5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/format:webp/1*6qLUnuO4jsB46UQ67Wn5Ow.png"/></div></figure><p id="778b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">错误消息更容易理解，对吗？现在您只需要添加错误中显示的缺失字段。</p><h1 id="33d8" class="lt lo it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">5.“不再有模拟响应”错误= &gt;检查您的输入</h1><p id="79be" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">我们经常看到的另一个错误是“不再有嘲笑的回答”。</p><figure class="le lf lg lh gt ju gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/9c640eb0301063e06d4ad39699b0d97e.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*AuKOg23yBtn2bV0yfRH1qA.png"/></div></figure><p id="ca81" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您看到这个错误，通常是因为测试中的变量与实际的组件不匹配。在这种情况下，您应该彻底检查您的变量。</p><p id="1c19" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我给你举一个例子。下面的组件将<code class="fe mw mx my lj b">{ first:10 }</code>作为输入。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="8d56" class="ln lo it lj b gy lp lq l lr ls">const FriendList = (props: Props) =&gt; {<br/>  const { data } = useQuery(document, { variables: { first: 10 }});</span></pre><p id="6e7b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">模拟应该是这样的</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="3f0f" class="ln lo it lj b gy lp lq l lr ls">const mocks = [<br/>  {<br/>    request: { query: currentUserFriends, variables: { first: 10 } },<br/>    result: { ... }<br/>  }<br/>]</span></pre><h1 id="73fb" class="lt lo it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">6.如果测试多个查询或突变，请禁用缓存</h1><p id="e173" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">有时禁用MockProvider的缓存是一个好主意，因为在处理多次运行的突变或查询时，这可能会导致意外的结果。</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="b41a" class="ln lo it lj b gy lp lq l lr ls">&lt;MockedProvider<br/>  mocks={mocks}<br/>  addTypename<br/>  defaultOptions={{<br/>    watchQuery: { fetchPolicy: 'no-cache' },<br/>    query: { fetchPolicy: 'no-cache' },<br/>  }}<br/>  cache={<br/>    new InMemoryCache({<br/>      possibleTypes,<br/>    })<br/>  }<br/>&gt;<br/>  {component}<br/>&lt;/MockedProvider&gt;</span></pre></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><p id="d18e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢您一路看完底部！请❤ ️if你认为这篇文章对你有用，它会激励我很多:)</p></div></div>    
</body>
</html>