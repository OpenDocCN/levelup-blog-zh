<html>
<head>
<title>Using Lightship to Check Express Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Lightship检查Express应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-lightship-to-check-express-apps-3ccbca6fb538?source=collection_archive---------2-----------------------#2020-02-22">https://levelup.gitconnected.com/using-lightship-to-check-express-apps-3ccbca6fb538?source=collection_archive---------2-----------------------#2020-02-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/4788fdc770d1fedb05980935266e6ad7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*w7GMHmr6a678Btbt"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">迪伦·麦克劳德在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="237d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Lightship是一个向我们的Express应用程序添加健康、就绪和活性检查的包。</p><p id="1b96" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它是一个独立的HTTP服务，作为单独运行，允许我们拥有健康/就绪/活动HTTP端点，而无需向公众公开它们。</p><p id="0361" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我们将看看如何将Lightship添加到我们的Express应用程序中。</p><h1 id="0e84" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">正常关机</h1><p id="7c32" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">优雅地关闭我们的应用程序包括向我们的应用程序发送SIGTERM信号，通知应用程序它将被杀死。一旦我们的应用程序收到信号，它将停止接受新的请求，完成当前的请求，并清理它使用的资源，如数据库连接和文件锁。</p><h1 id="3127" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">健康检查</h1><p id="6d07" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">有两种健康检查。它们包括:</p><ul class=""><li id="4fd5" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">活动—确定何时重新启动容器</li><li id="bcfe" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">就绪—确定容器何时准备好开始接受流量。</li></ul><h1 id="918b" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">添加光船</h1><p id="6d27" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">要添加Lightship，我们只需运行以下命令来安装Lightship包:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="f589" class="ne lf it na b gy nf ng l nh ni">npm i lightship</span></pre><p id="745d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们可以在代码中添加以下代码行:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="c979" class="ne lf it na b gy nf ng l nh ni">const {<br/>  createLightship<br/>} = require('lightship');<br/>const lightship = createLightship();</span><span id="f2d5" class="ne lf it na b gy nj ng l nh ni">app.listen(3000, () =&gt; lightship.signalReady());</span><span id="c301" class="ne lf it na b gy nj ng l nh ni">lightship.registerShutdownHandler(() =&gt; {<br/>  server.close();<br/>});</span><span id="28ac" class="ne lf it na b gy nj ng l nh ni">lightship.signalReady();</span></pre><p id="a0ae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们共同拥有:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="9665" class="ne lf it na b gy nf ng l nh ni">const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const {<br/>  createLightship<br/>} = require('lightship');<br/>const lightship = createLightship();<br/>const app = express();</span><span id="f019" class="ne lf it na b gy nj ng l nh ni">app.use(bodyParser.json());<br/>app.use(bodyParser.urlencoded({ extended: true }));</span><span id="07f4" class="ne lf it na b gy nj ng l nh ni">app.get('/', (req, res) =&gt; {<br/>  res.send('ok');<br/>});</span><span id="7b6f" class="ne lf it na b gy nj ng l nh ni">app.listen(3000, () =&gt; lightship.signalReady());</span><span id="47aa" class="ne lf it na b gy nj ng l nh ni">lightship.registerShutdownHandler(() =&gt; {<br/>  server.close();<br/>});</span><span id="9f85" class="ne lf it na b gy nj ng l nh ni">lightship.signalReady();</span></pre><p id="d9fb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果Lightship运行在非Kubernetes环境中，它将在任何可用的HTTP端口上运行其HTTP服务。</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/71d2f7730ac622308535c3c4aaac701e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yIshnNzfGPFoQ2Sz"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@ebplace?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">朱莉·诺斯</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="4855" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行后，我们有3个端点:</p><ul class=""><li id="2e09" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated"><code class="fe nl nm nn na b">/health</code></li><li id="2eb5" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><code class="fe nl nm nn na b">/live</code></li><li id="ccd8" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><code class="fe nl nm nn na b">/ready</code></li></ul><p id="0cb2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nl nm nn na b">/health</code>端点描述了我们应用程序的当前状态。它可以响应:</p><ul class=""><li id="8a92" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">200状态码和<code class="fe nl nm nn na b">SERVER_IS_READY</code>消息，这意味着它准备好接受新的连接</li><li id="774e" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">500状态码和<code class="fe nl nm nn na b">SERVER_IS_NOT_READY</code>消息，服务器初始化时返回</li><li id="85a7" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">服务器关闭时的500状态代码和<code class="fe nl nm nn na b">SERVER_IS_SHUTTING_DOWN</code>消息。</li></ul><p id="30ac" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nl nm nn na b">/live</code>端点可以响应:</p><ul class=""><li id="2d61" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">200状态和信息<code class="fe nl nm nn na b">SERVER_IS_NOT_SHUTTING_DOWN</code></li><li id="4547" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">500状态和信息<code class="fe nl nm nn na b">SERVER_IS_SHUTTING_DOWN</code></li></ul><p id="6f25" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以使用这个端点进行活性探测</p><p id="e3df" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nl nm nn na b">/ready</code>端点可以响应:</p><ul class=""><li id="34cf" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">200状态代码和信息<code class="fe nl nm nn na b">SERVER_IS_READY</code></li><li id="0330" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">500状态代码和信息<code class="fe nl nm nn na b">SERVER_IS_NOT_READY</code></li></ul><p id="5455" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此端点用于配置就绪探测器。</p><p id="36a0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以根据自己的要求发出不同的信号。例如，我们可以通过调用<code class="fe nl nm nn na b">lightship.signalNotReady()</code>将服务器状态更改为<code class="fe nl nm nn na b">SERVER_IS_NOT_READY</code>,如下所示:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="415a" class="ne lf it na b gy nf ng l nh ni">const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const {<br/>  createLightship<br/>} = require('lightship');<br/>const lightship = createLightship();<br/>const app = express();<br/>const period = 1000;<br/>let runningTotal = 0;<br/>app.use(bodyParser.json());<br/>app.use(bodyParser.urlencoded({ extended: true }));</span><span id="a9df" class="ne lf it na b gy nj ng l nh ni">app.get('/', (req, res) =&gt; {<br/>  runningTotal++;</span><span id="3ec5" class="ne lf it na b gy nj ng l nh ni">  setTimeout(() =&gt; {<br/>    runningTotal--;</span><span id="db9b" class="ne lf it na b gy nj ng l nh ni">    if (runningTotal &lt; 20) {<br/>      lightship.signalReady();<br/>    }<br/>    else {<br/>      lightship.signalNotReady();<br/>    }<br/>  }, period);</span><span id="554d" class="ne lf it na b gy nj ng l nh ni">  res.send('ok');<br/>});</span><span id="74ee" class="ne lf it na b gy nj ng l nh ni">app.listen(3000, () =&gt; lightship.signalReady());</span><span id="5df0" class="ne lf it na b gy nj ng l nh ni">lightship.registerShutdownHandler(() =&gt; {<br/>  server.close();<br/>});</span><span id="f63b" class="ne lf it na b gy nj ng l nh ni">lightship.signalReady();</span></pre><h1 id="81da" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="7409" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们可以使用Lightship向我们的应用程序添加健康检查，以确保它正在运行。</p><p id="ad6c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它让我们发送信号来指示我们的应用程序是否正在运行。我们可以通过使用Lightship提供的端点来检查我们的应用程序和服务器的状态。</p><p id="c662" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Lightship在非Kubernetes环境中作为单独的服务运行。</p></div></div>    
</body>
</html>