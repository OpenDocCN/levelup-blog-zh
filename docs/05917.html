<html>
<head>
<title>Modern PHP (Part 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">现代PHP(第3部分)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/modern-php-part-3-1f5b78b3371d?source=collection_archive---------9-----------------------#2020-10-12">https://levelup.gitconnected.com/modern-php-part-3-1f5b78b3371d?source=collection_archive---------9-----------------------#2020-10-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b1af" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">所有web应用程序的单点登录。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b86236e84838cac866972181f5bada37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8bSNaChytsL3ruFupFjWrQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1944688" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a></figcaption></figure><p id="dc45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些年来我学到的一件事就是不要让你的应用程序处理安全性。让专家来处理安全问题。不终止SSL或验证用户身份，应用程序就已经够复杂了。此外，这使得在开发环境中进行测试更加困难。试图用最新的安全补丁来修补你的PHP环境，比给他们一个像Nginx这样的入口点来修补要困难得多。</p><p id="8eb9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本系列的前几篇文章中(见下面的链接)，我创建了一个PHP应用程序，允许您列出和添加葡萄酒和奶酪的搭配。我还展示了如何将它部署到云中，并在互联网上提供它。然后我立刻把它撤了下来，因为让一个不安全的应用程序在互联网上运行通常不是一个好主意。因此，在本文中，我不仅要添加一个登录屏幕，还要构建它，以便运行在您的云虚拟机上的任何应用程序都可以轻松地使用身份验证。</p><p id="784a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了进一步减少您必须做的工作量，我将使用一个名为<a class="ae ky" href="https://www.okta.com/" rel="noopener ugc nofollow" target="_blank"> Okta </a>的服务来处理认证。我还将使用一个名为<a class="ae ky" href="https://github.com/vouch/vouch-proxy" rel="noopener ugc nofollow" target="_blank">的应用程序作为Nginx和Okta之间的中介。您的应用程序唯一关心的是授权(让某些用户能够访问特定于用户的数据)。带有JWT的安全cookie将被添加到每个请求中，应用程序可以使用它来确定特定用户是否能够访问或修改数据。</a></p><p id="5e78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先要做的是建立一个Okta开发者账号。这是一个免费帐户，最多允许1000名用户注册。登录后，创建一个新的应用程序并选择Web作为类型。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/25d08aaafbf8c28f9c3a6388e56c1876.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Unwoy8ZeJagKmIcHcjM9hg.png"/></div></div></figure><p id="73da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，它会将您带到一个配置屏幕，在这里您将添加与您的系统交互所需的所有URIs。因为您将只使用凭证应用程序，所以您需要在您的域中创建一个新主机。假设你的域名是“yourdomain.com”，你可以使用<a class="ae ky" href="https://vouch.yourdomain.com" rel="noopener ugc nofollow" target="_blank">https://vouch.yourdomain.com</a>作为这些项目的主机。其余的可以保留为默认值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/d33af5c2e52873c31e2c542f50220f8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HAHHHYTEKMXuoN4XwnLblA.png"/></div></div></figure><p id="dd76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建应用程序后，它会给你一个客户端id和客户端密码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lx"><img src="../Images/40a7f57f4fc709ee83ffc87af0cd603f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kcjF6khfYK7JscWrGmmnLw.png"/></div></div></figure><p id="7c4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">客户id是公共知识，但是客户秘密当然是秘密的。您必须将这两者作为您的凭证实例的参数。您需要的唯一其他信息是Okta组织的URL，您可以在Okta仪表板的右上角找到它。</p><p id="5a1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经在Okta仪表板中设置了凭证SSO应用程序，让我们将凭证部署到云中。在我的例子中，我将把它与我的应用程序和Nginx放在同一个VM中。在为多个应用程序提供身份验证的情况下，配置会更加复杂。但是，让我们从运行在同一虚拟机上的一个应用程序开始。如果您阅读了本系列中我以前的文章，您应该已经有了一个名为<code class="fe ly lz ma mb b">phpappprod</code>的存储库。如果没有，您可以将<a class="ae ky" href="https://github.com/rkamradt/phpappprod/tree/v0.2" rel="noopener ugc nofollow" target="_blank">库</a>克隆到您的本地驱动器。我们可以通过将它添加到我们<code class="fe ly lz ma mb b">docker-compose.yml</code>来开始凭证。</p><pre class="kj kk kl km gt mc mb md me aw mf bi"><span id="4f0f" class="mg mh it mb b gy mi mj l mk ml">vouch:<br/>    image: voucher/vouch-proxy<br/>    volumes:<br/>      - ..:/config<br/>    ports:<br/>      - 9090:9090</span></pre><p id="5a31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在存储库的父目录中使用相同的保密策略，这样它就不会被签入GitHub。该配置将保存在一个名为<code class="fe ly lz ma mb b">../config.yml</code>(相对于存储库目录)的文件中。它将包含所有凭证配置，如下所示:</p><pre class="kj kk kl km gt mc mb md me aw mf bi"><span id="110e" class="mg mh it mb b gy mi mj l mk ml">vouch:<br/>  logLevel: debug<br/>  domains:<br/>  - vouch<br/>  - {yourdomain}<br/>oauth:<br/>  provider: oidc<br/>  client_id: {your client ID}<br/>  client_secret: {your client secret}<br/>  auth_url: <a class="ae ky" href="https://dev-804011.okta.com/oauth2/default/v1/authorize" rel="noopener ugc nofollow" target="_blank">https://{organizationURL}/oauth2/default/v1/authorize</a><br/>  token_url: <a class="ae ky" href="https://dev-804011.okta.com/oauth2/default/v1/token" rel="noopener ugc nofollow" target="_blank">https://{organizationURL}/oauth2/default/v1/token</a><br/>  user_info_url: <a class="ae ky" href="https://dev-804011.okta.com/oauth2/default/v1/userinfo" rel="noopener ugc nofollow" target="_blank">https://{organizationURL}/oauth2/default/v1/userinfo</a><br/>  scopes:<br/>    - openid<br/>    - profile<br/>    - email<br/>  # Set the callback URL to the domain that Vouch is running on<br/>  callback_url: <a class="ae ky" href="https://vouch.kamradtfamily.net/auth" rel="noopener ugc nofollow" target="_blank">https://vouch.{yourdomain}/auth</a></span></pre><p id="13ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ly lz ma mb b">oauth.callback_url</code>必须与您在Okta配置中指定的登录重定向URI完全匹配。还请注意，我将<code class="fe ly lz ma mb b">vouch</code>添加到了域名中，这样我就可以直接访问凭证，而不必通过互联网进行重定向。</p><p id="a13e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以用<code class="fe ly lz ma mb b">docker-compose up</code>启动它来试试。它还不能工作，因为它只配置为在实际的域中工作，而不是在本地。您可以将额外的域添加到您的配置中进行测试，但是我们将只在现实世界中运行身份验证。对于本地测试，我们将假设一切都已经过身份验证。这是将身份验证排除在应用程序之外的一个好处。</p><p id="2a62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们将所有这些迁移到云之前，我们必须调整Nginx，不仅要反向代理我们的应用程序，还要反向代理凭证应用程序。此外，它应该阻止访问我们的应用程序，如果没有认证，并重定向到Okta正确登录，如果需要的话。这是我想到的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="978d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我们使用虚拟主机将应用程序请求发送到一个地方，将身份验证请求发送到另一个地方。同样，我们需要将秘密传递给VM。同样，我将在虚拟机上使用<code class="fe ly lz ma mb b">vi</code>进行复制和粘贴。到目前为止，我们只有三个需要复制的秘密文件，它们都是文本文件，不会有太大的变化，所以这似乎不是太大的负担。</p><p id="8b24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在虚拟机上打开一个SSH终端并运行<code class="fe ly lz ma mb b">vi config.yml</code>。然后，您可以复制本地<code class="fe ly lz ma mb b">../config.yml</code>的内容，并将它们粘贴到虚拟机上的文件中。然后<code class="fe ly lz ma mb b">cd</code>到<code class="fe ly lz ma mb b">phpappprod</code>目录并运行<code class="fe ly lz ma mb b">docker-compose up</code>。现在你的应用程序应该在互联网上运行，但是在登录之后。</p><p id="bdbd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你浏览到新安全的应用程序，你可能不需要登录。这是因为您可能仍然从配置会话登录到Okta。包括Okta在内的所有申请都是单点登录。你可以确认你Okta允许你在Chrome中使用开发者工具。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mo"><img src="../Images/dc29fb37bb743a2774d7f2aae1555334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WJKqrGzL2u1UskfOY1Ufzg.png"/></div></div></figure><p id="590d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有三个状态为302的额外请求，将您重定向到下一个阶段。另外，它将为您的新应用程序存储一个cookie，这样只需要执行第一步。第一个请求需要大约四分之一秒的时间来执行，因为它与Nginx和您的应用程序位于同一位置；延迟应该很难察觉。在更复杂的设置中，需要重定向到外部互联网，这可能需要更长的时间(但肯定没有再次输入密码那么长)。</p><p id="f58f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要查看当您被要求登录时会发生什么，您可以打开一个匿名窗口，浏览到您的应用程序，您应该被要求提供您的凭据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mp"><img src="../Images/0237444b989e40918e201b756075d8cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aZ_umqloNgfZbMZowARDhA.png"/></div></div></figure><p id="67da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想在你的应用程序中包含登录界面，给它一个独特的品牌，Okta有办法做到这一点，但这超出了本文的范围。</p><p id="c593" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想给出不同的作用域，传递给应用程序的cookie有一个JWT，您可以打开它来查找用户名和角色，这样您就可以基于用户名或角色添加授权。例如，您可以允许任何人查看列表，但是只有特定角色的人可以添加到列表中。</p><p id="34bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我打算暂时不去管它；该应用程序受到Okta、Nginx和Cloudflare的安全保护，所以我很高兴让它像那样运行。请注意，为了能够添加这个安全级别，我根本不需要更改主应用程序。事实上，应用程序是PHP并不重要，它可以是任何表达式语言。但是由于这是一个关于现代PHP的系列，所以我使用前面开发的PHP应用程序图像作为例子。我希望我已经能够帮助您将应用程序安全地部署到internet上。如果你需要进一步的帮助，Okta开发者的网站上有使用大多数表达式语言的Okta工具包的详细解释。</p><p id="20a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有脚本(除了秘密脚本)都包含在这个存储库中:</p><div class="mq mr gp gr ms mt"><a href="https://github.com/rkamradt/phpappprod/tree/v0.2" rel="noopener  ugc nofollow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd iu gy z fp my fr fs mz fu fw is bi translated">rkamradt/PHP pprod</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">github.com</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh ks mt"/></div></div></a></div><p id="32f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文引用的其他文章如下:</p><div class="mq mr gp gr ms mt"><a rel="noopener  ugc nofollow" target="_blank" href="/modern-php-df3d3bf343f8"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd iu gy z fp my fr fs mz fu fw is bi translated">现代PHP</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">使用Upstart上最需要的项目语言之一开始你的自由职业生涯。</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="nc l"><div class="ni l ne nf ng nc nh ks mt"/></div></div></a></div><div class="mq mr gp gr ms mt"><a rel="noopener  ugc nofollow" target="_blank" href="/modern-php-part-2-4973f48a90c0"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd iu gy z fp my fr fs mz fu fw is bi translated">现代PHP(第2部分)</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">部署到web</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="nc l"><div class="nj l ne nf ng nc nh ks mt"/></div></div></a></div></div></div>    
</body>
</html>