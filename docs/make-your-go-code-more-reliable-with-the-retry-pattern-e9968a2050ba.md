# 使用重试模式使您的 Go 代码更加可靠

> 原文：<https://levelup.gitconnected.com/make-your-go-code-more-reliable-with-the-retry-pattern-e9968a2050ba>

## 为分布式系统编写可靠的代码

![](img/12b63660619cb60432955236bbdb6c09.png)

在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上由[Duan veverkolog](https://unsplash.com/@veverkolog?utm_source=medium&utm_medium=referral)拍摄的照片

在云原生计算世界中，几乎所有系统都以某种形式或方式分布。*分布式系统*是由相互通信的节点组成的系统。节点可以指物理设备，如移动电话或服务器，但也可以是软件进程，如浏览器。

作为程序员，你迟早要和分布式系统打交道。一个简单的 web 应用程序已经是分布式系统的一个例子。浏览器是一个节点，还有一个节点是为浏览器服务 web app 的。web 应用程序很可能与某个后端 API(也是一个节点)进行通信。通常，后端需要一种持久存储形式:数据库，它也是分布式系统中的一个节点。

分布式系统提供了更高的可用性、效率和可伸缩性等优势。但是就像生活一样，并不都是阳光和彩虹。以在分布式系统方面的工作而闻名的计算机科学家莱斯利·兰波特(Leslie Lamport)的以下引用完美地总结了这一点:

> 在分布式系统中，一台您甚至不知道存在的计算机的故障会导致您自己的计算机无法使用。

大多数程序员在第一次使用分布式系统时会做一些假设。彼得·多伊奇将这些假设表述为[分布式计算的八大谬误](http://nighthacks.com/jag/res/Fallacies.html):

1.网络可靠
2。延迟为零
3。带宽无限
4。网络是安全的。拓扑不变
6。有一个管理员
7。运输成本为零
8。网络是同构的

# 强化您的代码

作为程序员，您的主要目标之一是编写干净的代码，并交付可靠的服务。或者至少在我看来应该是这样。但是，当我们编写的应用程序运行在不可靠的环境中时，我们如何确保它们是可靠的呢？您的应用程序所依赖的服务可能不可靠。

我们可以在代码中使用*稳定性模式*来使它更加可靠。本文讨论其中一种模式:重试模式。本文中选择的编程语言是 Go 编程语言。但是，您可以在您最喜欢的编程语言中应用该模式。

# 重试模式

让我们回到 web 应用程序的例子，利用我们的想象力添加虚构的细节。假设你工作的公司开发了一个待办事项管理器(是的，不是很有想象力)。这个应用程序有一个功能，用户可以收到一封包含 PDF 报告的电子邮件，总结他们已完成的任务。

第三方服务处理这些 pdf 的生成。遗憾的是，这项服务经常受到短暂故障的困扰。*瞬时故障*，也称为瞬时错误，其潜在原因会自行解决。第三方服务偶尔会中断，但总能迅速恢复。

像往常一样，没有时间和金钱来切换到一个不太容易出错的服务。然而，你的任务是使这项服务更加可靠，因为用户似乎很喜欢它。幸运的是，重试模式为您的困境提供了一个直接而有效的解决方案。

让我们直接进入代码，然后一点一点地消化它。重试模式可以按如下方式实现:

该模式有两个基本组成部分。`Effector`类型定义了一个函数签名，这个函数与第三方服务交互。效应器可以采用您想要的任何形式。对于演示代码，我们保持简单。

第二部分是`Retry`函数。该函数接受一个效应器，并返回一个与效应器具有相同签名的匿名函数*。它本质上用重试逻辑包装了接收到的函数。*

该函数接受三个参数:一个效应器，一个描述函数重试传递的效应器的次数和重试之间的延迟的整数。在重试模式中，通常会实现某种形式的退避算法，这会增加每次重试之间的延迟。为简洁起见，这留给读者作为练习。

# 匿名函数

最后一节提到了术语匿名函数。让我们先回避一下，讨论一下这是什么，以及如何使用它。我们可以在 Go 的包级别声明*命名函数*，重试函数就是一个例子。

声明函数的另一个选择是使用*函数文字。*函数字面量的写法类似于函数声明，在`func`关键字后没有名字。这个表达式的值称为匿名函数。

匿名函数最重要的一点是它们可以访问整个词法环境。换句话说，内部函数可以使用外围函数的变量。

例如，在 Retry 函数中，内部匿名函数可以访问封闭函数的参数。一个更简单的例子是平方函数:

该函数返回一个匿名函数。创建一个局部变量`x`，调用函数时返回一个匿名函数。每次调用返回的函数，它增加`x`并返回它的平方。

squares 示例演示了函数值不仅仅是代码，还可以有状态。像这样的函数值是用一种叫做*闭包*的技术实现的。

# 应用模式

让我们回到重试模式。为了使用这个模式，我们需要实现一个可能失败的功能。请记住，该功能的签名需要与效应器类型相匹配。在下面的例子中，`GetPdfUrl`模拟了我们可能失败的函数:

运行此代码将打印以下内容:

```
2022/03/06 13:14:40 Function call failed, retrying in 2s
2022/03/06 13:14:42 Function call failed, retrying in 2s
2022/03/06 13:14:44 Function call failed, retrying in 2s
[https://linktopdf.com](https://linktopdf.com) <nil>
```

# 结论

本文向您展示了如何在 Go 中实现重试模式。该模式考虑了分布式系统中可能的瞬时故障。如果你喜欢这篇文章，请考虑在媒体上关注我。