<html>
<head>
<title>Setting up Application Load Balancer (Ingress) for the Pods running in AWS EKS Fargate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为在AWS EKS Fargate中运行的pod设置应用程序负载平衡器(入口)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/setting-up-application-load-balancer-ingress-for-the-pods-running-in-aws-eks-fargate-519e20e97497?source=collection_archive---------3-----------------------#2021-08-22">https://levelup.gitconnected.com/setting-up-application-load-balancer-ingress-for-the-pods-running-in-aws-eks-fargate-519e20e97497?source=collection_archive---------3-----------------------#2021-08-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="3b97" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ko translated"><span class="l kp kq kr bm ks kt ku kv kw di"> H </span>高兴就是看到一个<em class="kx">成功的应用程序负载平衡器日志</em>为Kubernetes集群<strong class="js iu">在经历了如此多的奋斗和不眠之夜后终于</strong></p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="0b5e" class="lh li it ld b gy lj lk l ll lm">I0822 10:55:53.658057 1 controller.go:236] kubebuilder/controller “level”=1 “msg”=”Successfully Reconciled” “controller”=”alb-ingress-controller” “request”={“Namespace”:”default”,”Name”:”nginx-ingress”}<br/>I0822 10:57:22.687357 1 controller.go:236] kubebuilder/controller “level”=1 “msg”=”Successfully Reconciled” “controller”=”alb-ingress-controller” “request”={“Namespace”:”default”,”Name”:”nginx-ingress”}<br/></span></pre><figure class="ky kz la lb gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi ln"><img src="../Images/dfee046690a1b22629c937ca0556c37e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NZ6PTIOYlhdYdjU9kzvTUg.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">AWS EKS</figcaption></figure><p id="7d28" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一个<strong class="js iu">应用负载平衡器</strong>在管理Kubernetes集群中不同微服务(pods)的流量方面扮演着重要角色。您可以随时创建多个Kubernetes服务(类型为<strong class="js iu"> LoadBalancer) </strong>，这些服务将在AWS中为您的所有后端设备/应用提供<strong class="js iu">经典负载平衡器</strong>，但这将是一件昂贵的事情，因为它会成倍增加您的云账单。</p><p id="c76a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇博客中，您将看到如何配置<strong class="js iu">入口</strong>控制器，以在<strong class="js iu"> AWS (Amazon Web Services) </strong>中提供单个<strong class="js iu"> ALB </strong> ( <strong class="js iu">应用程序负载平衡器)</strong>来管理Kubernetes集群(AWS EKS <strong class="js iu">版本</strong> <strong class="js iu"> 1.20 </strong>)中运行的pods的所有流量。</p><h1 id="1750" class="lz li it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">我的建筑:-</h1><figure class="ky kz la lb gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mw"><img src="../Images/c0c75804a1deb2ac243b0fc5eb39543b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dr37oGi7pJRGZcKTVooEnQ.jpeg"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">ALB入口控制器— AWS EKS法盖特</figcaption></figure><p id="e45e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，我假设您已经有了一个正在运行的AWS EKS (Fargate)。</p><ol class=""><li id="4b3d" class="mx my it js b jt ju jx jy kb mz kf na kj nb kn nc nd ne nf bi translated">为Kubernetes集群或AWS EKS建立<strong class="js iu"> OIDC提供商</strong></li></ol><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="da96" class="lh li it ld b gy lj lk l ll lm">eksctl utils associate-iam-oidc-provider — cluster $CLUSTER_NAME — approve</span></pre><p id="a7cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="kx">(用您的AWS EKS集群名替换CLUSTER _ NAME，除非它在环境变量中设置)</em></p><p id="2092" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.为入口创建一个<strong class="js iu"> IAM策略</strong></p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="bce3" class="lh li it ld b gy lj lk l ll lm">wget -O alb-ingress-iam-policy.json <a class="ae ng" href="https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/master/docs/examples/iam-policy.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/master/docs/examples/iam-policy.json</a> aws iam create-policy — policy-name ALBIngressControllerIAMPolicy — policy-document file://alb-ingress-iam-policy.json</span></pre><p id="c7bf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.为入口Kubernetes对象创建一个<strong class="js iu">角色</strong>和<strong class="js iu">角色绑定</strong></p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="7850" class="lh li it ld b gy lj lk l ll lm">STACK_NAME=eksctl-$CLUSTER_NAME-cluster VPC_ID=$(aws cloudformation describe-stacks — stack-name “$STACK_NAME” | jq -r ‘[.Stacks[0].Outputs[] | {key: .OutputKey, value: .OutputValue}] | from_entries’ | jq -r ‘.VPC’) AWS_ACCOUNT_ID=$(aws sts get-caller-identity | jq -r ‘.Account’)</span><span id="d485" class="lh li it ld b gy nh lk l ll lm">---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRole<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/name: alb-ingress-controller<br/>  name: alb-ingress-controller<br/>rules:<br/>  - apiGroups:<br/>      - ""<br/>      - extensions<br/>    resources:<br/>      - configmaps<br/>      - endpoints<br/>      - events<br/>      - ingresses<br/>      - ingresses/status<br/>      - services<br/>    verbs:<br/>      - create<br/>      - get<br/>      - list<br/>      - update<br/>      - watch<br/>      - patch<br/>  - apiGroups:<br/>      - ""<br/>      - extensions<br/>    resources:<br/>      - nodes<br/>      - pods<br/>      - secrets<br/>      - services<br/>      - namespaces<br/>    verbs:<br/>      - get<br/>      - list<br/>      - watch<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/name: alb-ingress-controller<br/>  name: alb-ingress-controller<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: alb-ingress-controller<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: alb-ingress-controller<br/>    namespace: kube-system</span></pre><p id="1237" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.为入口创建<strong class="js iu">服务帐户</strong>对象</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="c783" class="lh li it ld b gy lj lk l ll lm">eksctl create iamserviceaccount \ — name alb-ingress-controller \ — namespace kube-system \ — cluster $CLUSTER_NAME \ — attach-policy-arn arn:aws:iam::$AWS_ACCOUNT_ID:policy/ALBIngressControllerIAMPolicy \ — approve</span></pre><p id="70a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.现在让我们为应用程序负载平衡器部署入口控制器(<strong class="js iu"> v 1.1.8 </strong>)</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="2c9a" class="lh li it ld b gy lj lk l ll lm">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/name: alb-ingress-controller<br/>  name: alb-ingress-controller<br/>  namespace: kube-system<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app.kubernetes.io/name: alb-ingress-controller<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app.kubernetes.io/name: alb-ingress-controller<br/>    spec:<br/>      containers:<br/>      - name: alb-ingress-controller<br/>        args:<br/>        - --ingress-class=alb<br/>        - --cluster-name=eks-fargate-alb-demo<br/>        - --aws-vpc-id=vpc-0dc46d370e38de475<br/>        - --aws-region=us-east-1<br/>        image: docker.io/amazon/aws-alb-ingress-controller:v1.1.8<br/>      serviceAccountName: alb-ingress-controller</span></pre><p id="ca50" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">参数<strong class="js iu"> — aws-vpc-id </strong>和<strong class="js iu"> — aws-region </strong>只需要在<strong class="js iu"> AWS </strong> <strong class="js iu"> EKS带有Fargate profile </strong>的情况下传递。如果您有配备了<strong class="js iu">节点组</strong>的AWS EKS，您不需要传递这两个信息。</p><p id="05da" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">6.现在让我们部署一个带有节点端口服务的示例应用程序:-</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="9c39" class="lh li it ld b gy lj lk l ll lm">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  creationTimestamp: null<br/>  labels:<br/>    run: mydocker<br/>  name: mydocker<br/>spec:<br/>  containers:<br/>  - image: ghcr.io/vinod827/my-docker:1.0<br/>    name: mydocker<br/>    resources: {}<br/>    ports:<br/>    - containerPort: 8080<br/>  dnsPolicy: ClusterFirst<br/>  restartPolicy: Always<br/>status: {}</span><span id="1802" class="lh li it ld b gy nh lk l ll lm">---</span><span id="d103" class="lh li it ld b gy nh lk l ll lm">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  creationTimestamp: null<br/>  labels:<br/>    eks.amazonaws.com/fargate-profile: fp-default<br/>    run: mydocker<br/>  name: mydocker-svc<br/>  annotations:<br/>    alb.ingress.kubernetes.io/target-type: ip<br/>spec:<br/>  ports:<br/>  - port: 8080<br/>    protocol: TCP<br/>    targetPort: 8080<br/>  selector:<br/>    eks.amazonaws.com/fargate-profile: fp-default<br/>    run: mydocker<br/>  type: NodePort<br/>status:<br/>  loadBalancer: {}</span></pre><p id="16c6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">7.最后，我们在集群中创建我们的<strong class="js iu">入口</strong>对象</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="1f86" class="lh li it ld b gy lj lk l ll lm">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: "nginx-ingress"<br/>  namespace: "default"<br/>  annotations:<br/>    kubernetes.io/ingress.class: alb<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    alb.ingress.kubernetes.io/security-groups: sg-014b302d73097d083<br/>  labels:<br/>    app: nginx-ingress<br/>spec:<br/>  rules:<br/>  - http:<br/>      paths:<br/>      - path: /foo<br/>        pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: "nginx-service"<br/>            port:<br/>              number: 80<br/>      - path: /*<br/>        pathType: Prefix<br/>        backend:<br/>          service:<br/>             name: "mydocker-svc"<br/>             port: <br/>               number: 8080</span></pre><p id="4929" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">输入以下命令查看入口对象的详细信息:-</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="f52b" class="lh li it ld b gy lj lk l ll lm">kubectl get ingress nginx-ingress</span></pre><figure class="ky kz la lb gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi ni"><img src="../Images/a28c3a03ef2b10048460903e4b875193.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0MX7v9950rTwIwgC7M5Glw.png"/></div></div></figure><p id="1285" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您将看到您的应用程序负载平衡器的一个端点URL，如<strong class="js iu">5e 07 DBE 1-default-nginingr-29e 9–1260427999 . us-east-1 . elb . Amazon AWS . com</strong></p><p id="170f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">还要检查入口控制器Pod的日志，查看负载平衡器是否有问题。如果您看到下面的日志(<strong class="js iu"><em class="kx"/></strong>)那么这意味着，您的负载平衡器是活跃的，并且正确地监听健康的目标组:-</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="7893" class="lh li it ld b gy lj lk l ll lm">kubectl logs alb-ingress-controller-5f6479d9c9-hg6xx -n kube-system -f</span><span id="fd1e" class="lh li it ld b gy nh lk l ll lm">I0822 15:30:53.385397 1 controller.go:236] kubebuilder/controller “level”=1 “msg”=”Successfully Reconciled” “controller”=”alb-ingress-controller” “request”={“Namespace”:”default”,”Name”:”nginx-ingress”}<br/>I0822 15:30:54.014297 1 controller.go:236] kubebuilder/controller “level”=1 “msg”=”Successfully Reconciled” “controller”=”alb-ingress-controller” “request”={“Namespace”:”default”,”Name”:”nginx-ingress”}</span></pre><figure class="ky kz la lb gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nj"><img src="../Images/88d449a290326194546fc707e5552cf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UKdCWbxuO8aEo9ptBl5sAw.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">入口控制器日志</figcaption></figure><p id="8a3c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，在浏览器上打开那个URL(您在前面的步骤中收到的)，查看来自Pods的响应:)</p><figure class="ky kz la lb gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nk"><img src="../Images/4a59824a88ac394d2c398f910e957609.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RlViKOnFuvW_7Zi2MAj5vQ.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">来自Pod的响应</figcaption></figure><p id="a9b9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你喜欢这篇文章:)</p><h1 id="f6ab" class="lz li it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">摘要:-</h1><p id="cc45" class="pw-post-body-paragraph jq jr it js b jt nl jv jw jx nm jz ka kb nn kd ke kf no kh ki kj np kl km kn im bi translated">在这篇博客中，我们看到了如何在Kubernetes集群中创建一个入口对象，以在AWS中配置一个应用负载平衡器，并使用该负载平衡器将流量高效地路由到在您的Kubernetes集群中运行的各种应用或pod，并将您的云账单成本降至最低。</p><p id="cc30" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通常，您总是可以在这里找到来自这个GitHub库的源代码</p><p id="1ca2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae ng" href="https://github.com/vinod827/k8s-nest/tree/main/iac/k8s/alb-demo" rel="noopener ugc nofollow" target="_blank">https://github . com/vinod 827/k8s-nest/tree/main/IAC/k8s/ALB-DEM</a>o</p><p id="346f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请随意为它贡献更多的IaC(基础设施代码)。</p></div></div>    
</body>
</html>