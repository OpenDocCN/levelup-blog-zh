<html>
<head>
<title>Creating Ansible Filters For Data Manipulation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建用于数据操作的可变过滤器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/creating-ansible-filters-for-data-manipulation-526656140ad3?source=collection_archive---------8-----------------------#2022-06-27">https://levelup.gitconnected.com/creating-ansible-filters-for-data-manipulation-526656140ad3?source=collection_archive---------8-----------------------#2022-06-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/cb0c5b3b0602424341f117459fa30de1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nu3Q7n-Gh8qmQmVF62bDqQ.png"/></div></div></figure><p id="5b7a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在编写可翻译的剧本时，您可能需要执行一些文本转换。这些转换可能包括一些简单的事情，比如直接数据类型转换，或者使用Ansible 中的一些<a class="ae kz" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html" rel="noopener ugc nofollow" target="_blank">内置Jinja2过滤器对字符串变量运行算法。</a></p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="5f8e" class="lj lk it lf b gy ll lm l ln lo"># For human-readable output, you can use:<br/>as_json: "{{ some_variable | to_nice_json }}"<br/>as_yaml: "{{ some_variable | to_nice_yaml }}"</span><span id="afed" class="lj lk it lf b gy lp lm l ln lo"># Get the min and max of lists<br/>min_num: "{{ [3, 4, 2] | min }}"<br/>max_num: "{{ [3, 4, 2] | max }}"</span><span id="9671" class="lj lk it lf b gy lp lm l ln lo"># Perform complex operations on strings<br/>sha1_hash: "{{ 'test1' | hash('sha1') }}"<br/>checksum: "{{ 'test1' | checksum }}"</span></pre><p id="4bff" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">但是，如果只使用内置的Ansible过滤器进行复杂的转换，您最终会得到一串不可读的连锁过滤器，很难理解您的数据发生了什么，并且会使您的行动手册和角色可读性更差。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="7a63" class="lj lk it lf b gy ll lm l ln lo">yucky_value: "{{ some_variable | filter_foo | filter_bar | when_will_it_end | theres_got_to_be_a_better_way }}"</span></pre><p id="0cc2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在本文中，我将介绍如何通过使用一些python代码创建一个自定义过滤器来简化这些复杂的转换，然后您可以在您的Ansible剧本中使用这些代码，以便通过可重用的过滤器保持它们的可读性。</p><h1 id="79b0" class="lq lk it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">创建自定义的可变筛选器</h1><p id="b320" class="pw-post-body-paragraph kb kc it kd b ke mn kg kh ki mo kk kl km mp ko kp kq mq ks kt ku mr kw kx ky im bi translated">以这个例子为例，可以很好地为我们想要的特定输入数据和输出格式创建一个定制的Ansible过滤器。我们有一个S3存储桶，它将其对象输出为一个长的路径列表，其中包含表示目录和下面的文件夹的对象。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="3bc3" class="lj lk it lf b gy ll lm l ln lo">- folder1/file1.js<br/>- folder1/sub-folder/file1.js<br/>- folder2/<br/>- folder3/file1.js<br/>- folder3/file2.js<br/>- folder3/file3.js</span></pre><p id="897b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然而，对于我们的需求，我们想知道对于下面的预期输出，bucket的顶层文件夹是什么样的。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="34fd" class="lj lk it lf b gy ll lm l ln lo">folder1<br/>folder2<br/>folder3</span></pre><p id="8cd3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要创建新的过滤器模块，在文件树中与我们的剧本相邻的名为<code class="fe ms mt mu lf b">filter_plugins</code>的目录中创建一个具有任意名称的<code class="fe ms mt mu lf b">.py</code>文件(Ansible将在剧本运行时为过滤器搜索在该过滤器中找到的任何<code class="fe ms mt mu lf b">.py</code>文件)。我们将创建一个python模块，它从Ansible库中定义了一个<code class="fe ms mt mu lf b">FilterModule</code>类。这个类必须有一个<code class="fe ms mt mu lf b">filters</code>方法，为每个定义的过滤器返回名称和可调用函数的映射。</p><p id="3c57" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">满足我们过滤S3路径的简单用例的过滤器模块看起来像下面的类。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="c936" class="lj lk it lf b gy ll lm l ln lo">#!/usr/bin/python</span><span id="e471" class="lj lk it lf b gy lp lm l ln lo">class FilterModule(object):<br/>    def filters(self):<br/>        return {'unique_folders': self.unique_base_paths}</span><span id="2859" class="lj lk it lf b gy lp lm l ln lo">def unique_base_paths(self, keys):<br/>        # A Set allows for no duplication of keys<br/>        base_paths = set()<br/>        for key in keys:<br/>            # A path contains a directory if it has a "/"<br/>            if "/" in key:<br/>                # Get the first folder in each path<br/>                base_folder = key.split("/")[0]<br/>                base_paths.add(base_folder)<br/>        # Sets aren't handled by ansible so convert to list<br/>        return list(base_paths)</span></pre><p id="ac5a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">既然已经定义了filter类，我们可以使用filters方法<code class="fe ms mt mu lf b">unique_folders</code>中指定的名称在我们的Ansible剧本和角色中使用它。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="9071" class="lj lk it lf b gy ll lm l ln lo">- hosts: localhost<br/>  vars:<br/>    deployment_bucket:<br/>      name: "some-bucket-with-packages"<br/>      region: "ap-southeast-2"<br/>  <br/>   tasks:<br/>    - name: List keys<br/>      aws_s3:<br/>        bucket: "{{ deployment_bucket.name }}"<br/>        region: "{{ deployment_bucket.region }}"<br/>        mode: list<br/>      register: bucket_content</span><span id="a059" class="lj lk it lf b gy lp lm l ln lo">    - name: All bucket paths<br/>      debug:<br/>        var: bucket_content.s3_keys</span><span id="4803" class="lj lk it lf b gy lp lm l ln lo">    - name: Get all top level folders in bucket<br/>      set_fact:<br/>        deployed_packages: "{{ bucket_content | unique_folders }}"</span><span id="b9d1" class="lj lk it lf b gy lp lm l ln lo">    - name: Unique top level folders<br/>      debug:<br/>        var: deployed_packages</span></pre><p id="1f27" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果我们对一个具有与原始示例数据相同的对象的bucket运行下面的剧本，我们将得到</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="799c" class="lj lk it lf b gy ll lm l ln lo">TASK [Unique top level folders] *********************<br/>ok: [localhost] =&gt; {<br/>    "deployed_packages": [<br/>        "folder1",<br/>        "folder2",<br/>        "folder3"<br/>    ]<br/>}</span></pre><h1 id="568b" class="lq lk it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">包扎</h1><p id="1bba" class="pw-post-body-paragraph kb kc it kd b ke mn kg kh ki mo kk kl km mp ko kp kq mq ks kt ku mr kw kx ky im bi translated">正如您所看到的，很容易创建一个定制的Ansible过滤器来操作您的剧本和角色中的数据。当您将配置作为代码开发时，它是一个强大的工具。因为我们只是在编写python，所以我们可以做相当复杂的事情，同时仍然保持良好的可读性，这样我们就可以在将来轻松地修改我们的配置。这些过滤器，像python代码一样，可以跨项目重用，并允许您为您的组织快速构建有价值的标准过滤器。</p><p id="5ee4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以查看以下参考资料，了解更多关于创建可解析过滤器的信息。</p><ul class=""><li id="8f86" class="mv mw it kd b ke kf ki kj km mx kq my ku mz ky na nb nc nd bi translated"><a class="ae kz" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html" rel="noopener ugc nofollow" target="_blank">可变过滤器文档</a></li><li id="3bad" class="mv mw it kd b ke ne ki nf km ng kq nh ku ni ky na nb nc nd bi translated"><a class="ae kz" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/filter" rel="noopener ugc nofollow" target="_blank">查看内置的可变过滤器源代码</a></li></ul><h1 id="0850" class="lq lk it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">进一步连接</h1><ul class=""><li id="bc7f" class="mv mw it kd b ke mn ki mo km nj kq nk ku nl ky na nb nc nd bi translated">如果你正在考虑获得一个中型订阅，你可以通过使用我的<a class="ae kz" href="https://aaron-kt-berry.medium.com/membership" rel="noopener">推荐链接</a>来帮助我。</li><li id="3311" class="mv mw it kd b ke ne ki nf km ng kq nh ku ni ky na nb nc nd bi translated">查看我在<a class="ae kz" href="https://medium.com/@aaron-kt-berry" rel="noopener">媒体</a>上的其他文章，如果你想了解最新消息，请通过<a class="ae kz" href="https://aaron-kt-berry.medium.com/subscribe" rel="noopener">电子邮件</a>订阅。</li><li id="7def" class="mv mw it kd b ke ne ki nf km ng kq nh ku ni ky na nb nc nd bi translated">如果你想聊天，请在Twitter或LinkedIn上联系我，如果你想雇佣我，我在Codementor上。</li></ul></div></div>    
</body>
</html>