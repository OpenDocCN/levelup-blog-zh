<html>
<head>
<title>Understanding and Handling Race Conditions at DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">理解和处理DynamoDB中的竞争条件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/understanding-and-handling-race-conditions-at-dynamodb-6b4850c4e524?source=collection_archive---------1-----------------------#2021-07-22">https://levelup.gitconnected.com/understanding-and-handling-race-conditions-at-dynamodb-6b4850c4e524?source=collection_archive---------1-----------------------#2021-07-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="69d9" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">从竞争条件到数据不一致</h2><div class=""/><div class=""><h2 id="2fb1" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">即使您的服务没有经历很多写操作，也值得尽早考虑可能的并发问题。</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/ec8ec3e4ab3a7ddad8cf8a26eb0d0eac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Odg5M4KK84rmxAZd7irj3A.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">照片由<a class="ae le" href="https://www.pexels.com/@pixabay?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> <strong class="bd lf"> Pixabay </strong> </a>发自<a class="ae le" href="https://www.pexels.com/photo/light-trails-on-highway-at-night-315938/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> <strong class="bd lf"> Pexels </strong> </a></figcaption></figure><p id="4bc2" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">侧重于无服务器开发，DynamoDB是数据库解决方案的一个顿悟。它是托管的、高度可用的，并且可以按需扩展。但不是所有的事情都可以由AWS接手:你仍然需要考虑你的使用模式。一个常见的错误是忘记脏读可能导致的竞争条件。</p><p id="1a62" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">在本文中，我将向您介绍一些常见的方法，如何避免由于对单个文档的冲突写入而导致数据不一致。</p><p id="cf70" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">配料:</p><ul class=""><li id="091f" class="mc md iq li b lj lk lm ln lp me lt mf lx mg mb mh mi mj mk bi translated"><em class="ml">比赛条件</em> —简短介绍。</li><li id="5235" class="mc md iq li b lj mm lm mn lp mo lt mp lx mq mb mh mi mj mk bi translated"><em class="ml">事务</em> —为什么它们不是一切的解决方案。</li><li id="3031" class="mc md iq li b lj mm lm mn lp mo lt mp lx mq mb mh mi mj mk bi translated"><em class="ml">检测冲突</em> —并利用乐观锁定。</li><li id="bd02" class="mc md iq li b lj mm lm mn lp mo lt mp lx mq mb mh mi mj mk bi translated"><em class="ml">更新表达式</em>—用于安全更新字段。</li><li id="44b2" class="mc md iq li b lj mm lm mn lp mo lt mp lx mq mb mh mi mj mk bi translated"><em class="ml">关键要点</em></li></ul><h1 id="f71e" class="mr ms iq bd lf mt mu mv mw mx my mz na kf nb kg nc ki nd kj ne kl nf km ng nh bi translated">什么是竞争条件？</h1><p id="34c5" class="pw-post-body-paragraph lg lh iq li b lj ni ka ll lm nj kd lo lp nk lr ls lt nl lv lw lx nm lz ma mb ij bi translated">从引用维基百科上的<a class="ae le" href="https://en.wikipedia.org/wiki/Race_condition" rel="noopener ugc nofollow" target="_blank">比赛条件</a>开始:</p><blockquote class="nn no np"><p id="a896" class="lg lh ml li b lj lk ka ll lm ln kd lo nq lq lr ls nr lu lv lw ns ly lz ma mb ij bi translated">竞争条件或竞争危险是电子、软件或其他系统的条件，其中系统的实质性行为取决于其他不可控事件的顺序或时间。</p></blockquote><p id="390b" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">所以换句话说:时间和顺序正在影响我们系统的确定性。如果我们将它转移到web领域，如果操作顺序和时间发生变化，我们的API操作将会得到不同的结果，即使它们提交相同的有效负载。</p><p id="f04d" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">让我们为此创建一个假想的(永远不会以这种方式实现，但有利于演示)示例:</p><ul class=""><li id="91bd" class="mc md iq li b lj lk lm ln lp me lt mf lx mg mb mh mi mj mk bi translated">我们在DynamoDB文档的列表中保存每个候选人的投票。</li><li id="fbf2" class="mc md iq li b lj mm lm mn lp mo lt mp lx mq mb mh mi mj mk bi translated">API网关后面的Lambda函数提交这些投票。</li></ul><p id="78af" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如果我们收到不同投票人对同一候选人的并发投票操作，如果操作是按照一定的顺序进行的，我们就会遇到麻烦。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nt"><img src="../Images/286c3e8acf657e1bd1738a09c59823f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xROVxOJ9LCEJJerU7b9cZg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">具有冲突写入操作的典型竞争情况</figcaption></figure><p id="6bfe" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">第二个投票请求在第一个提交其写操作之前到达。因此，将使用另一个Lambda实例(由于每个Lambda实例一次只能处理一个请求的事实)，它将接收候选人Z的相同查询结果，只包含a的投票。</p><p id="4834" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">两个实例都将尝试通过用表决器扩展列表来进行更新，因此我们将根据写操作的时间得到不同的结果。</p><p id="67e2" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated"><strong class="li ja">更糟糕的是</strong>:两条路——要么A在B之前结束，要么B在A之前结束——都会导致数据损坏，因为无论哪条路我们都会失去一票。</p><h1 id="a669" class="mr ms iq bd lf mt mu mv mw mx my mz na kf nb kg nc ki nd kj ne kl nf km ng nh bi translated">数据库事务</h1><p id="4845" class="pw-post-body-paragraph lg lh iq li b lj ni ka ll lm nj kd lo lp nk lr ls lt nl lv lw lx nm lz ma mb ij bi translated">DynamoDB支持事务，以确保一组操作耦合在一起，并且只一起执行，从而保证我们的确定性。</p><ul class=""><li id="ac00" class="mc md iq li b lj lk lm ln lp me lt mf lx mg mb mh mi mj mk bi translated"><a class="ae le" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/transaction-apis.html#transaction-apis-txwriteitems" rel="noopener ugc nofollow" target="_blank"> TransactWriteItems API </a> —允许在单个(原子的)“全有或全无”操作中将多达25个写操作组合在一起。</li><li id="2550" class="mc md iq li b lj mm lm mn lp mo lt mp lx mq mb mh mi mj mk bi translated"><a class="ae le" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/transaction-apis.html#transaction-apis-txgetitems" rel="noopener ugc nofollow" target="_blank"> TransactGetItems API </a> —同步读取最多25个项目(总共不超过4MB)。</li></ul><p id="7e72" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如所见，这些操作限于一组读<strong class="li ja">或</strong>写操作。所以在我们的例子中，这没有帮助，因为我们需要确保对单个文档的任意操作都保证以一致的状态结束。</p><h1 id="070d" class="mr ms iq bd lf mt mu mv mw mx my mz na kf nb kg nc ki nd kj ne kl nf km ng nh bi translated">检测冲突</h1><p id="b029" class="pw-post-body-paragraph lg lh iq li b lj ni ka ll lm nj kd lo lp nk lr ls lt nl lv lw lx nm lz ma mb ij bi translated">让我们退一步，不要试图从一开始就解决问题，而只是检测可能导致不一致状态的冲突操作。</p><h2 id="ad54" class="nu ms iq bd lf nv nw dn mw nx ny dp na lp nz oa nc lt ob oc ne lx od oe ng iw bi translated">乐观锁定</h2><p id="37bc" class="pw-post-body-paragraph lg lh iq li b lj ni ka ll lm nj kd lo lp nk lr ls lt nl lv lw lx nm lz ma mb ij bi translated">DynamoDB Mapper和它的<a class="ae le" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBMapper.OptimisticLocking.html" rel="noopener ugc nofollow" target="_blank">乐观锁定</a>允许我们通过使用一个专用的版本字段来验证我们确实在更新我们所期望的项目。</p><p id="a2a9" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如果我们回头看看我们的例子，我们会用一个新的字段<code class="fe of og oh oi b">version</code>来增强我们的文档。</p><pre class="kp kq kr ks gt oj oi ok ol aw om bi"><span id="f29f" class="nu ms iq oi b gy on oo l op oq">{<br/>  "key": "Z",<br/>  "votedBy": ["A"],<br/>  "version": 1<br/>}</span></pre><p id="aaad" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">当我们创建一个新的文档时，它会自动分配一个初始版本——给注释有<code class="fe of og oh oi b">@DynamoDBVersionAttribute</code>的字段。每隔一次对该项目的写操作将通过在内部使用一个<code class="fe of og oh oi b">ConditionExpression</code>来确保版本号匹配。如果是这样，它将自动增加，这保证我们在读取和写入操作之间没有中间写入操作。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi or"><img src="../Images/8f946c657c17776966c454d822c193a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VkILoKKuQlVdXSLD4aVRhw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">用乐观锁定扩展我们的场景</figcaption></figure><p id="3fd9" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如果有一个中间写，我们期望的版本将不匹配，我们将收到一个<code class="fe of og oh oi b">ConditionalCheckFailedException</code>。实例b写操作时的介绍示例就是这种情况。</p><p id="12d4" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">现在，我们可以通过重新加载文档的当前状态并合并我们的更改来手动解决我们的问题。在我们的例子中，这很容易，因为我们只有一个属性，但是对于一个有多个字段的复杂文档，这可能非常复杂，因为我们还需要知道我们在当前流程中所做的更改。</p><p id="6e9a" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">我们可以坚持使用乐观锁定来确保一致性，但是依赖DynamoDB内部来实现原子更新。</p><h1 id="c726" class="mr ms iq bd lf mt mu mv mw mx my mz na kf nb kg nc ki nd kj ne kl nf km ng nh bi translated">更新表达式</h1><p id="968c" class="pw-post-body-paragraph lg lh iq li b lj ni ka ll lm nj kd lo lp nk lr ls lt nl lv lw lx nm lz ma mb ij bi translated">使用<a class="ae le" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.UpdateExpressions.html#Expressions.UpdateExpressions.ADD" rel="noopener ugc nofollow" target="_blank">更新表达式</a>我们可以修改复杂文档的某些字段。例如，它允许我们在列表中添加或删除元素，这正是我们在用例中所需要的。</p><p id="0681" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">通常，有四种不同的操作:</p><ul class=""><li id="99ea" class="mc md iq li b lj lk lm ln lp me lt mf lx mg mb mh mi mj mk bi translated"><code class="fe of og oh oi b">SET</code> —用于向项目添加一个或多个属性。</li><li id="d78d" class="mc md iq li b lj mm lm mn lp mo lt mp lx mq mb mh mi mj mk bi translated"><code class="fe of og oh oi b">REMOVE</code> —用于删除一个或多个属性。</li><li id="c68c" class="mc md iq li b lj mm lm mn lp mo lt mp lx mq mb mh mi mj mk bi translated"><code class="fe of og oh oi b">ADD</code> —添加一个新的属性及其值。</li><li id="e2d7" class="mc md iq li b lj mm lm mn lp mo lt mp lx mq mb mh mi mj mk bi translated"><code class="fe of og oh oi b">DELETE</code> —从集合中删除一个或多个元素。</li></ul><p id="2d5d" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">对于我们的用例，我们可以使用<code class="fe of og oh oi b">ADD</code>或者<code class="fe of og oh oi b">SET</code>，但是亚马逊推荐使用<code class="fe of og oh oi b">SET</code>。让我们快速定义实例B的更新操作，而不使用特定的框架，只使用AWS-SDK:</p><pre class="kp kq kr ks gt oj oi ok ol aw om bi"><span id="a5c7" class="nu ms iq oi b gy on oo l op oq">aws dynamodb update-item \<br/>    --table-name votes \<br/>    --key '{"key":{"S":"Z"}}' \<br/>    --update-expression "<strong class="oi ja">SET</strong> #field = <strong class="oi ja">list_append</strong>(#ri, :value)" \<br/>    --expression-attribute-names '{"#field": "votedBy"}' \<br/>    --expression-attribute-values '{"value": {"L": ["B"]}}'</span></pre><p id="da57" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">使用节点的<a class="ae le" href="https://github.com/awslabs/dynamodb-data-mapper-js/tree/master/packages/dynamodb-expressions" rel="noopener ugc nofollow" target="_blank"> DynamoDB数据映射器，如下所示:</a></p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="d953" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如前所述，更新表达式还可以用于检查文档的某些状态——比如乐观锁定的实现使用版本字段来确保读操作和写操作之间没有冲突。</p></div><div class="ab cl ou ov hu ow" role="separator"><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz"/></div><div class="ij ik il im in"><h1 id="9766" class="mr ms iq bd lf mt pb mv mw mx pc mz na kf pd kg nc ki pe kj ne kl pf km ng nh bi translated">关键要点</h1><p id="8b43" class="pw-post-body-paragraph lg lh iq li b lj ni ka ll lm nj kd lo lp nk lr ls lt nl lv lw lx nm lz ma mb ij bi translated">确保分布式系统(或任何多节点服务)中的一致性是一项非常重要的任务。有了DynamoDB，我们得到了一个助手工具箱，它允许我们通过使用乐观锁定来检测冲突，并在更新表达式的帮助下进行细粒度的、一致的更新操作。</p><h1 id="c9ef" class="mr ms iq bd lf mt mu mv mw mx my mz na kf nb kg nc ki nd kj ne kl nf km ng nh bi translated">还有更多…</h1><p id="34db" class="pw-post-body-paragraph lg lh iq li b lj ni ka ll lm nj kd lo lp nk lr ls lt nl lv lw lx nm lz ma mb ij bi translated">我正在写一本关于AWS基础知识的书，以帮助其他人了解核心构建模块。重点是为现实世界学习，而不仅仅是为了证书！📚<br/>你可以在<a class="ae le" href="https://awsfundamentals.com" rel="noopener ugc nofollow" target="_blank">awsfundamentals.com</a>订阅时事通讯，每两周将一点点预览内容&amp;免费发送到你的收件箱。</p></div></div>    
</body>
</html>