<html>
<head>
<title>VPC Peering Between MongoDB Atlas and Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MongoDB Atlas和Google Cloud之间的VPC对等</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/vpc-peering-between-mongodb-atlas-google-cloud-eec89a261b75?source=collection_archive---------0-----------------------#2019-07-15">https://levelup.gitconnected.com/vpc-peering-between-mongodb-atlas-google-cloud-eec89a261b75?source=collection_archive---------0-----------------------#2019-07-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1af8a0a46d8c2d77f6e0204797ca2a16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3rItc3LeKx0NCtVcpi6Yyg.png"/></div></div></figure><h1 id="5481" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">介绍</h1><p id="d24b" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在Atlas上部署MongoDB集群时，确保其安全的唯一方法是将允许访问集群的IP地址列入白名单。这是一种非常有效的方法，但是在某些情况下会产生问题。</p><p id="6523" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我最近在Google Kubernetes引擎上部署了一个Kubernetes集群，并很快意识到我的pods没有明确的IP地址范围，这限制了我使用Mongo Atlas白名单来保护集群。对于那些没有任何Kubernetes背景的人来说，微服务编排系统通过自动扩展、重新创建和修复来维护一组应用和服务。一个应用程序的每个实例称为一个pod，因为这些pod会不断重新创建，所以不能有预定义的IP地址。</p><p id="e133" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">经过大量搜索，我发现解决这个问题的唯一方法是使用NAT(网络地址转换)网关。NAT通过相同的IP地址路由VPC(虚拟私有云)网络内的所有传出流量，允许我们将该地址列入白名单。我之前在这里写了一篇关于如何设置这个基础设施的教程<a class="ae lz" rel="noopener ugc nofollow" target="_blank" href="/part-2-deploy-and-secure-mongodb-on-atlas-4820d539a1dc?source=friends_link&amp;sk=a0fb79f7713e685b84be660f058b8656"/>，其中也包括<a class="ae lz" rel="noopener ugc nofollow" target="_blank" href="/part-2-deploy-and-secure-mongodb-on-atlas-4820d539a1dc?source=friends_link&amp;sk=a0fb79f7713e685b84be660f058b8656/#0d93">一个关于NAT网关如何工作的简要描述</a>。</p><p id="6ad0" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">尽管这个解决方案非常有效，但我意识到仅运行这个NAT网关每月就要花费我50美元。对于小项目来说，这似乎很荒谬。<strong class="ky ir">谢天谢地，Atlas有一个叫做私有网络对等的工具，它允许你把你的MongoDB Atlas集群连接到一个云提供商的VPC网络，就好像它们在同一个私有网络上一样。问题是，直到几个月前，这还只能在AWS上使用。现在，</strong> <a class="ae lz" href="https://www.mongodb.com/blog/post/atlas-mapped-private-network-peering-on-azure--gcp" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">他们又增加了对Google Cloud和Azure </strong> </a> <strong class="ky ir">的支持。</strong></p><h1 id="7ddd" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">设置谷歌云</h1><p id="1617" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">如果您已经拥有Google Cloud帐户，并且已经创建了一个项目，则可以跳过这一步。</p><p id="8494" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">前往<a class="ae lz" href="https://cloud.google.com/free/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/free</a>获取创建账户的指导。注册后，您将获得300美元的免费积分，因此不必担心需要为您在本教程中创建的资源付费。</p><p id="793e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在Google Cloud控制台中创建新项目。如果你以前从未这样做过，请参见<a class="ae lz" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/resource-manager/docs/creating-managing-projects</a>。我们将把我们的项目称为<em class="ma"> vpc对等教程</em>。</p><h1 id="0d71" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">设置MongoDB Atlas</h1><p id="ac7c" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">前往https://www.mongodb.com/cloud/atlas的<a class="ae lz" href="https://www.mongodb.com/cloud/atlas" rel="noopener ugc nofollow" target="_blank"/>，点击<em class="ma">免费试用。</em>注册后，您应该会立即进入一个页面，在这里您可以配置和部署您的第一个MongoDB集群。<strong class="ky ir">暂时不要创建集群，因为在此之前我们需要设置我们的VPC对等机。</strong></p><h1 id="0672" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">创建VPC对等</h1><p id="5f70" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">前往您的<a class="ae lz" href="https://cloud.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> Atlas仪表盘</a>，创建一个项目(如果您还没有创建的话),然后点击侧边栏中<em class="ma">安全</em>下的<em class="ma">网络访问</em>。点击<em class="ma">对等</em>和<em class="ma">新建对等连接</em>。选择<em class="ma">谷歌云平台</em>，点击<em class="ma">下一步</em>。</p><p id="dabb" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">输入你的GCP项目ID，可以在左上角的<em class="ma">项目信息</em>卡下的<a class="ae lz" href="https://console.cloud.google.com/home/dashboard" rel="noopener ugc nofollow" target="_blank">谷歌云控制台</a>中找到。接下来，输入您的VPC网络名称，如果您没有更改或创建另一个名称，这将是默认的名称。将地图集CIDR保留为默认值，应为<strong class="ky ir"> 192.168.0.0/16 </strong>。点击<em class="ma">发起对等</em>。</p><p id="0697" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">现在，在GCP控制台中转到<a class="ae lz" href="https://console.cloud.google.com/networking/peering/list" rel="noopener ugc nofollow" target="_blank"> VPC网络对等</a>并点击<em class="ma">创建连接</em>和<em class="ma">继续</em>。将连接命名为<strong class="ky ir"> atlas-peer </strong>，并选择<em class="ma">您的VPC网络</em>下的<strong class="ky ir">默认</strong>。在<em class="ma">对等VPC网络</em>下选择<strong class="ky ir">另一个项目</strong>。现在我们需要获取Atlas部署的GCP项目ID和项目名称。这两个值都可以在<a class="ae lz" href="https://cloud.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> Atlas仪表板</a>中<em class="ma"> Atlas GCP项目ID </em>和<em class="ma"> Atlas VPC名称</em>下的<em class="ma">网络访问</em>部分的<em class="ma">对等</em>选项卡中找到(如果它们还没有显示，请等待几分钟，让Atlas完成对对等的初始化)。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mb"><img src="../Images/bb47e7779c79215fb7550d01d277d9fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Xa9SwzHVtkciMY-NEziMg.png"/></div></div></figure><p id="38eb" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">将这些值输入到GCP的<em class="ma">项目ID </em>和<em class="ma"> VPC网络名称</em>表格中，并点击<em class="ma">创建</em>以完成对VPC同行的设置。</p><p id="0dc9" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我们需要做的最后一件事是在Atlas中将我们的GCP VPC IP地址范围列入白名单。在Atlas Network Peering dashboard中，您应该会在我们列出的以<em class="ma">结尾的VPC网络上方看到一条警告“…在</em> <a class="ae lz" href="https://cloud.google.com/vpc/docs/vpc#subnet-ranges" rel="noopener ugc nofollow" target="_blank"> <em class="ma">自动模式</em> </a> <em class="ma">中生成的GCP网络使用的CIDR范围为</em><strong class="ky ir"><em class="ma">10 . 128 . 0 . 0</em></strong><em class="ma"/>(您也可以在上面的截图中看到这一点)。复制这个CIDR范围，点击<em class="ma"> IP白名单</em>选项卡，点击<em class="ma">添加IP地址</em>。在<em class="ma">白名单条目</em>下输入复制的范围，点击<em class="ma">确认</em>。该范围将匹配我们默认的GCP VPC网络中的所有地区(对于当前项目)。</p><h1 id="917c" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">测试</h1><p id="a12e" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在继续之前，确保VPC对等连接从GCP和Atlas都成功连接，并且我们添加的IP白名单已完成配置。</p><p id="db23" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我们将创建一个MongoDB集群。我们将尝试从本地计算机连接到集群(这应该不起作用)，然后在Google Cloud中创建一个VM以确保它可以成功连接。</p><p id="5ca7" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">进入你的<a class="ae lz" href="https://cloud.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> Atlas仪表盘</a>，点击侧边栏<em class="ma"> Atlas </em>下的<em class="ma">集群</em>，然后点击<em class="ma">构建集群</em>。在<em class="ma">云提供商&amp;地区</em>下，选择<strong class="ky ir">谷歌云平台</strong>和<strong class="ky ir">爱荷华州(美国中部)</strong>。在<em class="ma">集群层</em>下，选择<strong class="ky ir"> M10 </strong>(任何更低的层都不允许我们使用VPC对等体)并在<em class="ma">集群名称</em>下输入<strong class="ky ir">测试集群</strong>。点击<em class="ma">创建集群</em>。群集将需要几分钟的时间来启动。</p><h2 id="2ecc" class="mg jz iq bd ka mh mi dn ke mj mk dp ki lh ml mm km ll mn mo kq lp mp mq ku mr bi translated">本地测试</h2><p id="9774" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">确保您安装了<a class="ae lz" href="https://docs.mongodb.com/v3.2/administration/install-community/" rel="noopener ugc nofollow" target="_blank">Mongo CLI</a>，一旦集群完成配置，单击集群名称下的<em class="ma"> Connect </em>。在<em class="ma">创建一个MongoDB用户</em>下，输入用户名<strong class="ky ir"> admin </strong>和任何密码(如果只是针对本教程，不必担心会太复杂)。点击<em class="ma">创建MongoDB用户</em>然后<em class="ma">选择连接方式</em>。选择<em class="ma">连接Mongo Shell </em>，点击连接字符串旁边的<em class="ma">复制</em>。该字符串应该类似于</p><pre class="mc md me mf gt ms mt mu mv aw mw bi"><span id="47e8" class="mg jz iq mt b gy mx my l mz na">mongo "mongodb+srv://test-cluster-2m6rh.gcp.mongodb.net/test" --username admin</span></pre><p id="6d35" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">将它输入到您的终端或命令行，并在出现提示时输入您选择的密码。Mongo shell应该尝试连接多次，但每次都失败，并出现以下错误:</p><pre class="mc md me mf gt ms mt mu mv aw mw bi"><span id="a329" class="mg jz iq mt b gy mx my l mz na">Unable to reach primary for set test-cluster-shard-0</span><span id="1b90" class="mg jz iq mt b gy nb my l mz na">Cannot reach any nodes for set test-cluster-shard-0. Please check network connectivity and the status of the set. This has happened for 2 checks in a row.</span></pre><p id="049e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">尝试几次后，它会以一个<code class="fe nc nd ne mt b">connection failed</code>异常结束。</p><h2 id="66d7" class="mg jz iq bd ka mh mi dn ke mj mk dp ki lh ml mm km ll mn mo kq lp mp mq ku mr bi translated">GCP测试</h2><p id="a93f" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">现在，我们将在Google Cloud上创建一个虚拟机。前往<a class="ae lz" href="https://console.cloud.google.com/compute/instances" rel="noopener ugc nofollow" target="_blank"> GCP计算引擎虚拟机仪表板</a>，点击<em class="ma">创建</em>(或者<em class="ma">创建实例</em>，如果你已经有一个虚拟机)。</p><p id="919a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在<em class="ma">启动盘</em>下点击<em class="ma">更换</em>，选择<strong class="ky ir"> Ubuntu 18.04 LTS </strong>，点击<em class="ma">选择</em>。保持所有其他默认设置不变，点击底部的<em class="ma">创建</em>。一旦它完成旋转，点击<em class="ma">连接</em>下<em class="ma"> SSH </em>旁边的箭头，并选择<em class="ma">在浏览器窗口</em>中打开(如果您愿意，您可以使用自己的终端或命令行，但为了简单起见，我们将通过浏览器SSH)。运行以下命令来安装Mongo shell(从<a class="ae lz" href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/" rel="noopener ugc nofollow" target="_blank">到这里的</a>):</p><pre class="mc md me mf gt ms mt mu mv aw mw bi"><span id="8b5e" class="mg jz iq mt b gy mx my l mz na">sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4</span><span id="78f2" class="mg jz iq mt b gy nb my l mz na">echo "deb [ arch=amd64 ] <a class="ae lz" href="https://repo.mongodb.org/apt/ubuntu" rel="noopener ugc nofollow" target="_blank">https://repo.mongodb.org/apt/ubuntu</a> bionic/mongodb-org/4.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.0.list</span><span id="9bfd" class="mg jz iq mt b gy nb my l mz na">sudo apt-get update</span><span id="4ec7" class="mg jz iq mt b gy nb my l mz na">sudo apt-get install -y mongodb-org</span></pre><p id="4b09" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">现在，从前面获取相同的连接字符串，并将其输入。出现提示时，输入相同的密码。您现在应该会看到一大堆输出，以成功连接到数据库结束:</p><pre class="mc md me mf gt ms mt mu mv aw mw bi"><span id="ee99" class="mg jz iq mt b gy mx my l mz na">MongoDB server version: 4.0.10<br/>Welcome to the MongoDB shell.<br/>For interactive help, type "help".<br/>For more comprehensive documentation, see <a class="ae lz" href="http://docs.mongodb.org/" rel="noopener ugc nofollow" target="_blank">http://docs.mongodb.org/</a><br/>Questions? Try the support group<br/>        <a class="ae lz" href="http://groups.google.com/group/mongodb-user" rel="noopener ugc nofollow" target="_blank">http://groups.google.com/group/mongodb-user</a><br/>MongoDB Enterprise test-cluster-shard-0:PRIMARY&gt;</span></pre><p id="68da" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">恭喜你。现在，您可以使用私有网络连接到MongoDB Atlas集群，在使用Kubernetes引擎时不再需要NAT网关。为了避免产生额外费用，请确保删除Google Compute Engine VM、MongoDB Atlas集群以及在每个集群中创建的项目。</p><p id="db7b" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">希望你喜欢这个教程，欢迎在下面留下任何评论或问题！</p></div></div>    
</body>
</html>