<html>
<head>
<title>Options Pattern in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang的期权模式</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/options-pattern-in-golang-9a0384a9d8db?source=collection_archive---------0-----------------------#2022-03-05">https://levelup.gitconnected.com/options-pattern-in-golang-9a0384a9d8db?source=collection_archive---------0-----------------------#2022-03-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="74d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在浏览其中一个<a class="ae kl" href="https://github.com/open-telemetry/opentelemetry-collector" rel="noopener ugc nofollow" target="_blank">开源库</a>时，我遇到了很多这样的代码。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/b373b2168eed5ba91625935feb0fee8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*2MC_t2ywHqyb5LE2Hr1EUA.png"/></div></figure><p id="a187" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">重点介绍<code class="fe ku kv kw kx b">ToServerOption</code>及其用途。我花了相当多的时间试图理解它，但无法理解为什么需要这样做。我理解我面前的所有代码，但无法将它们拼凑在一起。</p><p id="896e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">直到我在其中一期上读到这句话。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ky"><img src="../Images/b63b0804dceba9022e5445484e5c4bd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KVf0PVxaJbDaFZtpGo5SHQ.png"/></div></div></figure><p id="c690" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">突然，我灵机一动。我知道它指的是我一直看到的那段代码。它重新点燃了我的好奇心，因为我有了一个明确的方向，即“期权模式”，所以我开始对它进行更多的研究。</p><h1 id="8883" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">那么，什么是“期权模式”？</h1><p id="9269" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">选项模式是一种函数式编程模式，用于为函数提供可选参数，这些参数可用于修改函数的行为。</p><p id="52e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您有python背景，您可能对此很熟悉。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mg"><img src="../Images/653fe15f5eb5ee4c2c6cd4da04350bc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H9uh_or4FEOg_4LKH58ljQ.png"/></div></div></figure><p id="df86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果不需要，客户端可以选择跳过这个<code class="fe ku kv kw kx b">lastName</code>参数，或者在需要时使用它。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mh"><img src="../Images/1a7d667b5d21d33b3dfc090d5f434906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nzCqX9rw86SaypecobhX2A.png"/></div></div></figure><p id="609b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种能力在API设计中非常有用</p><ul class=""><li id="d11c" class="mi mj iq jp b jq jr ju jv jy mk kc ml kg mm kk mn mo mp mq bi translated">允许客户端使用最少的配置来使用您的SDK，同时仍然为有经验的用户提供充足的配置选项。</li><li id="a319" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">允许您在不破坏向后兼容性的情况下添加新选项。</li></ul><p id="0651" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而在Golang，这是不可能的。该语言没有提供添加可选参数的方法。</p><p id="4272" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是“选择模式”的由来。它允许您的客户端在调用您的SDK时传递附加选项，然后SDK可以相应地修改其行为。我们来看一个小例子。</p><p id="f418" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设我们有一个名为<code class="fe ku kv kw kx b">Server</code>的结构，它有3个属性<code class="fe ku kv kw kx b">port, timeout</code>和<code class="fe ku kv kw kx b">maxConnections</code></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mw"><img src="../Images/bd41ab66eafbfedec53dd79bb40a7554.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LPlbzHZmB9rVhTpI2zxCTw.png"/></div></div></figure><p id="aadc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的工厂方法看起来会像这样。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mx"><img src="../Images/7cdbf213a311c8e7b5a644c0714714a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cwx-CwPSs657rZO4caXAVA.png"/></div></div></figure><p id="74db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是我希望<code class="fe ku kv kw kx b">timeout</code>和<code class="fe ku kv kw kx b">maxConnections</code>是可选参数。在许多情况下，这些值的默认值就足够了。还有，我也不想用这些不必要的配置去轰炸刚刚学习或者试用我的SDK的新用户。让我们看看如何实现这一点。</p><p id="b65e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，让我们定义一个名为<code class="fe ku kv kw kx b">Option</code>的新<code class="fe ku kv kw kx b">type</code></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi my"><img src="../Images/8a0204fec401017ee0409c1d72617160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S6twPhgBr8_-O_ug0DLcYQ.png"/></div></div></figure><p id="bdbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ku kv kw kx b">Option</code>是一个将指针指向我们的<code class="fe ku kv kw kx b">Server</code>的函数。这很重要，因为我们将使用这些选项修改我们的服务器实例。</p><p id="7609" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们定义我们的选项。事情会变得明朗。惯例是在我们的选项前面加上一个<code class="fe ku kv kw kx b">With</code>前缀，但是您可以随意选择适合您的领域语言的名称</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mg"><img src="../Images/89953a183337007408921876db5378ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dieeqGn3j8K-3rvcDmC3sQ.png"/></div></div></figure><p id="61a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的两个选项<code class="fe ku kv kw kx b">WithTimeout</code>和<code class="fe ku kv kw kx b">WithMaxConnections</code>接受配置值并返回一个<code class="fe ku kv kw kx b">Option</code>。<code class="fe ku kv kw kx b">Option</code>只是一个函数，它将一个指针指向我们的服务器对象，并将所需的属性设置为所提供的值。例如，<code class="fe ku kv kw kx b">WithTimeout</code>获取超时持续时间，然后返回一个函数(其签名与<code class="fe ku kv kw kx b">Option</code>相同)，该函数将我们服务器的超时属性设置为所提供的值。</p><p id="9762" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们使用了一种被称为“<a class="ae kl" href="https://go.dev/tour/moretypes/25" rel="noopener ugc nofollow" target="_blank">闭包</a>的技术，几乎所有现代语言(包括Golang)都支持这种技术。</p><p id="66c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的工厂方法<code class="fe ku kv kw kx b">Server</code>现在需要修改以支持这种变化。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mz"><img src="../Images/5a6cd086b425a6fe74fff51658d05b28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4WZmZOQXiCky3vs44hjs3w.png"/></div></div></figure><p id="5aa8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你愿意，你也可以添加<code class="fe ku kv kw kx b">port</code>作为选项。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi na"><img src="../Images/7ae86848eac949b5ae42e4d6e3502738.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fUPgmGhCQcSxfX4zIApMUg.png"/></div></div></figure><p id="b29c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，您可以看到我们的客户端现在可以创建一个只有端口的最小服务器，但如果需要，还可以自由地提供更多的配置选项。</p><p id="f60b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以看看<a class="ae kl" href="https://www.youtube.com/watch?v=5ZZwmMI897c" rel="noopener ugc nofollow" target="_blank">这个</a>我为了更好的理解而参考的YouTube教程。</p><p id="967f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种设计具有高度的可伸缩性和可维护性，甚至比我们在python中看到的可选参数更是如此。它允许我们添加更多的选项，而不会膨胀我们的函数签名，也不会触及工厂方法中的代码。</p><h1 id="32f8" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">小切线</h1><p id="25e5" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">发生在我身上的这件事说明了名字的力量以及为什么需要名字。当我不知道这种模式的名称时，我努力理解这段代码在做什么，或者为什么需要它。每次看到这段代码，我的大脑都有一种解析它的开销。但我一知道它的名字，就本能地理解了这个代码。现在，当我在代码库中看到它时，我就知道它在做什么，它的目的是什么，并且代码更容易解析。</p><h1 id="4857" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">资源:</h1><ul class=""><li id="2180" class="mi mj iq jp b jq mb ju mc jy nb kc nc kg nd kk mn mo mp mq bi translated"><a class="ae kl" href="https://github.com/open-telemetry/opentelemetry-collector" rel="noopener ugc nofollow" target="_blank">开放式遥测/开放式遥测采集器:开放式遥测采集器(github.com)</a></li><li id="74f7" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated"><a class="ae kl" href="https://www.youtube.com/watch?v=5ZZwmMI897c" rel="noopener ugc nofollow" target="_blank"> Go (Golang)功能选项模式— YouTube </a></li><li id="058e" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated"><a class="ae kl" href="https://www.sohamkamani.com/golang/options-pattern/" rel="noopener ugc nofollow" target="_blank">Go中的功能选项:在Golang(sohamkamani.com)中实现选项模式</a></li></ul></div></div>    
</body>
</html>