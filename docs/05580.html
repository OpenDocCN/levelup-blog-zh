<html>
<head>
<title>Production Level Static Sites in AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS中的生产级静态站点</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/production-level-static-sites-in-aws-39573c9bf4d5?source=collection_archive---------1-----------------------#2020-09-11">https://levelup.gitconnected.com/production-level-static-sites-in-aws-39573c9bf4d5?source=collection_archive---------1-----------------------#2020-09-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1582" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">保持S3存储桶私有，将其放在CDN后面，同时将apex域路由到www子域</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3aff75d8be1d676489cda669ed2b4978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a9JlAJacRoYjp2Eb_QqXLA.jpeg"/></div></div></figure><p id="fcb7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当你去大多数网站时，你可能会注意到两件事，该网站通常重定向到HTTPS和它通常重定向到WWW子域。无论您是否输入裸域(apex域)。这样做的理由很长，但主要是出于SEO和专业期望，这里有一个好的<a class="ae lq" href="https://stackoverflow.com/a/624480" rel="noopener ugc nofollow" target="_blank">理由</a>的名单。</p><p id="2cee" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我要指出的另一件事是，当人们使用AWS S3进行托管时，会将他们的S3桶设置为公共的，这让我很恼火。我知道这是一个提供的功能，但你的一个错误配置的黑客破坏了你的网站。</p><p id="562a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本文中，我将详细介绍我认为的使用AWS托管静态站点的更安全、更专业的方法。虽然我使用Gatsby来呈现我的静态站点，但我不打算深入站点代码本身。<em class="lr">这就是如何托管你已经生成的静态文件。</em></p><p id="f9af" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这一开始看起来有些违反直觉，但是我们实际上是要先建立www子域。</p><h1 id="e4d8" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">创建一个私有S3存储桶</h1><p id="4efc" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">首先，我们将创建一个新的存储桶。名字并不重要，我们也不想给公众许可。我通常把它们称为名称中包含内容的桶。你<strong class="kw iu">不要</strong>想给桶域名，这个以后会搞混的。使用类似于<em class="lr"> domain-contents </em>的名称作为桶名。</p><p id="9af2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在在这里上传你的静态站点的内容。老实说，为了方便起见，我通常会上传一个简单的大标题index.html，只是为了测试我已经启动并运行了所有的东西，而不必同时调试我的站点。做一些可预见的事情。</p><p id="f869" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们有一个<strong class="kw iu"> <em class="lr">的私人</em> </strong>的S3跟我们的网站斗。我们应该根本无法从AWS外部达到这一点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mp"><img src="../Images/466cd012c0a2554c86769b9266ba95dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9uGSFo9_xZM9ZLVekAKhCg.png"/></div></div></figure><h1 id="4c09" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">在AWS ACM中设置DNS并创建SSL证书</h1><p id="9a88" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">接下来我们去玩AWS Route53吧。我们希望用您的域创建一个托管区域，并生成命名空间服务器。然后在你的域名托管(GoDaddy，Google Domains，Namecheap等)中，你要指向AWS命名空间域。如果你需要更多关于如何做的细节，这里有一个有用的<a class="ae lq" href="https://medium.com/@limichelle21/connecting-google-domains-to-amazon-s3-d0d9da467650" rel="noopener">教程</a>。</p><p id="7acf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您可以在终端中使用<code class="fe mq mr ms mt b">dig</code>命令来测试您的名称服务器是否正确。您也可以使用<code class="fe mq mr ms mt b">nslookup</code>命令。您应该会看到亚马逊域名服务器正在运行。</p><pre class="kj kk kl km gt mu mt mv mw aw mx bi"><span id="d3cb" class="my lt it mt b gy mz na l nb nc">dig @8.8.8.8 NS domain.com</span></pre><p id="9726" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">转到AWS证书管理器，ACM，在这里，我们将为裸域www域申请SSL证书，并可能为任何未来的项目通配符子域。如果你不太了解证书，那么幸运的是AWS让这变得非常容易。<a class="ae lq" href="https://stackoverflow.com/questions/37289994/aws-certificate-manager-do-regions-matter" rel="noopener ugc nofollow" target="_blank">请务必在<strong class="kw iu"> us-east-1 </strong>地区制作您的所有证书，以便我们可以在Cloudfront </a>使用它！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/663bb26dcd090ec94ffb06ea449d7d6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N4XUg30T3J5Rpgi3ag1GtQ.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">请求公共证书</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/3d12b592d5847ac9c032117abd12888d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rSQvbwjMK247DDp5h6zd0g.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">添加您的裸域，www域，可能还有一个通配符</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/7d24cb0e432f0ebeb5951960649387f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*61ythTefGxMVIWwYcJAb5g.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">你可以用任何一种方式来验证它，但是DNS更快</figcaption></figure><p id="42f4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">幸运的是，AWS允许我们通过一个简单的按钮自动为SSL创建DNS记录来验证证书。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/d4b2243ebdf6975ecdc6208c8e4a65b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nzxsHsXY7N5YEdoJeauNDw.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">在Route53中自动添加记录</figcaption></figure><p id="9aba" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您的证书可能需要一些时间来验证，但通常不会太长。下面应该是结果。<em class="lr">再次确认这都是在</em><strong class="kw iu"><em class="lr">us-east-1</em></strong><em class="lr">地区！</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/a6bb2fa71b719b4cb67fac4ddee229b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F_IA0eDZLYPDtycvBbvcEw.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">ACM中经过验证的域</figcaption></figure><p id="205b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">检查SSL证书是否连接正确。使用<code class="fe mq mr ms mt b">openssl</code>工具。</p><pre class="kj kk kl km gt mu mt mv mw aw mx bi"><span id="0d2f" class="my lt it mt b gy mz na l nb nc">openssl s_client -connect domain.com_cert_url</span></pre><p id="c1ef" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">酷，现在我们有了一个私人的S3桶来存放我们的内容，我们有了指向AWS的域名，还有一个SSL证书来保护我们用户到我们网站的连接。</p><h1 id="1e08" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">云锋CDN</h1><p id="953b" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">内容交付网络是一种快速共享静态资产的方式。基本思想是将人们最近使用的静态资产缓存在离他们很近的位置。</p><p id="bbf3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在AWS Cloudfront中创建一个发行版，并让它指向私有的S3桶。选择限制访问，创建新身份，并允许其更改S3存储桶权限。这使得只有Cloudfront可以从S3桶中获取数据。Cloudfront将对公众开放，而我们的桶的细节将保持私有。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/87efa9e49d98a01893ca8889cced3837.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S8Kv_Kt9mwC4PCEtLmeIIQ.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">确保限制存储桶访问，并允许它更新存储桶策略</figcaption></figure><p id="9d50" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在为备用域名添加<strong class="kw iu"> www子域</strong>。在我的例子中，它是<a class="ae lq" href="http://www.filthyaf.com" rel="noopener ugc nofollow" target="_blank">www.filthyaf.com</a>，如果您的证书通过验证，当您选中“使用自定义SSL证书”时，它将出现在下拉列表中。该证书再次需要位于<strong class="kw iu"> us-east-1 </strong>地区，并且必须拥有<strong class="kw iu"> www </strong>子域或*通配符子域才能工作。</p><p id="e300" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在选择选项<strong class="kw iu">将HTTP重定向到HTTPS </strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/600f87927ac0376ae9c2a21d09a584c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QxUlcfXtFbnkgAyWdp5HmQ.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">这是我们做所有从HTTP到HTTPS的重定向的地方</figcaption></figure><p id="ec46" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">创建发行版后，我们可以通过导航到提供的发行版URL来测试这一点。现在你应该可以公开看到S3水桶的index.html了！但是这个URL是一个丑陋的Cloudfront URL，我们想要指向它。</p><p id="64e5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">好了，让我们导航回Route53，为我们的www子域输入一个CNAME，并将其指向Cloudfront分发URL。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/b4ce262d7a10997647322548cf0932e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WhQ3igXVPJxMOTa84NG6vg.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">复制AWS Route53的Cloudfront域名</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/61fdb5d4ed5e5ceee210495825c9d41b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*17DWqlDqpmuYBexu959l2w.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">创建一个指向Cloudfront域的DNS记录</figcaption></figure><p id="3a06" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">找到了。我们有它，如果我们在浏览器中导航到www子域，我们可以看到我们被重定向到HTTPS安全连接，可以看到我们的静态网站！</p><p id="6a25" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">好了，现在我们有了我们网站的专业www子域。但是我们的apex域没有指向任何地方，这并不酷。</p><h1 id="05fd" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">将Apex域重定向到WWW</h1><p id="afb7" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">幸运的是，这非常简单，尽管我不喜欢这样做，但这是目前为止最简单的，也是AWS认可的将apex域重定向到WWW域的方法。</p><p id="4b74" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，我们需要用apex域名和域名扩展创建一个S3存储区。<em class="lr">了解我们为什么不想让我们的私有S3桶以域名命名。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/2df7904ed3435d35cd1567c47ae10f13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mGTdzeUKBSkQnkSwcFnLjw.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">创建空的公共S3存储桶</figcaption></figure><p id="967c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">确保它是公开的，并使它成为一个静态网站的网站托管桶。<strong class="kw iu">不要将任何文件添加到此桶中。</strong>现在确保你选择的是一个到www子域的重定向。现在，虽然这将在apex域自动重定向HTTP请求，但如果我们尝试在apex域上执行安全HTTPS请求，您会看到一些问题和挂起。原因是<strong class="kw iu"> S3无法检查SSL证书</strong>我们需要通过Cloudfront发行版来完成。我知道很差劲。</p><p id="a5cb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们创建一个新的Cloudfront发行版，并将其指向公共apex S3域的<strong class="kw iu">网站端点</strong>。省掉你的头痛，不要让它自动完成！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/dba5c4284d7015f28e2e25fec5652b88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_f-bbIRSy8-6Refj-QFPNw.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">不要让这在Cloudfront中自动填充！你应该看到名字里的“网站”了！</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/16bc41b315ab771a5eeb1a886de908dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EYHIgMmt4AGYWWeB5igwBg.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">使用这个端点从S3静态网站模态！</figcaption></figure><p id="037b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">不要忘记添加域名和正确的SSL票证。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/6f1e318b35f962a2f48259015a0d044e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p7ALm8ltd1E9x_se9JVH6w.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">不要忘记选择您的SSL证书并添加域名！</figcaption></figure><p id="0b04" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在保持公开和简单。现在，我们有一个分布式链接，应该访问S3桶，看到重定向，并前往HTTPS WWW子域。</p><p id="5977" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在转到Route53，在apex域设置一个A记录，并将其指向此分发链接。就像我们对另一桶做的一样。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/00c21eb62e5a84cec47dfdd246cfea8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ag15rQAxUZtHxv6mTlQIXQ.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">确保apex域指向它自己的Cloudfront发行版</figcaption></figure><p id="f84f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我使用<code class="fe mq mr ms mt b">curl</code>命令测试每个部分，看看是否一切都正常。我们希望能够看到一个301状态代码，位置更新到www子域和HTTPS。</p><pre class="kj kk kl km gt mu mt mv mw aw mx bi"><span id="051c" class="my lt it mt b gy mz na l nb nc">curl -i url </span></pre><p id="f52f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在带有基本HTTP的浏览器中键入apex域名，并看到它路由到HTTPS www子域！</p><p id="f4ee" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，请记住，我们本质上是在一个巨大的缓存后面，所以每次我们做出更改时，我们都需要确保在Cloudfront中使其无效，这样它就可以回到S3存储桶中，获得最新的内容，我们就可以看到最新的更改。</p><h1 id="14a1" class="ls lt it bd lu lv lw lx ly lz ma mb mc jz md ka me kc mf kd mg kf mh kg mi mj bi translated">TL；速度三角形定位法(dead reckoning)</h1><ul class=""><li id="63a2" class="nv nw it kw b kx mk la ml ld nx lh ny ll nz lp oa ob oc od bi translated">将HTTP裸域重定向到HTTPS WWW子域</li><li id="573d" class="nv nw it kw b kx oe la of ld og lh oh ll oi lp oa ob oc od bi translated">使用一个私人的S3桶，而不是一个公共的，同时也使您的网站快速！</li><li id="6be4" class="nv nw it kw b kx oe la of ld og lh oh ll oi lp oa ob oc od bi translated">使用AWS Route53、S3、ACM和Cloudfront创建更专业、更安全的连接和外观</li><li id="ca38" class="nv nw it kw b kx oe la of ld og lh oh ll oi lp oa ob oc od bi translated">任何HTTP或apex域都会直接重定向到https www域！</li></ul><p id="0184" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你是Github的用户并且喜欢CI/CD，那么让我们建立一个Github工作流，这样每次你推送或者与master合并时，它都会将你的内容推送到S3，然后使Cloudfront缓存失效。这是为此准备的一点小礼物。</p></div></div>    
</body>
</html>