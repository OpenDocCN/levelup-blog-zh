<html>
<head>
<title>Serverless Streamed Events 🚀</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器流式事件🚀</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/serverless-streamed-events-ada6ed9a9ecf?source=collection_archive---------3-----------------------#2022-03-19">https://levelup.gitconnected.com/serverless-streamed-events-ada6ed9a9ecf?source=collection_archive---------3-----------------------#2022-03-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/67f172988bee2bb36ff5af204c7e9844.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IyGdAnktCOm_JEJRR2Pjwg.png"/></div></div></figure><div class=""/><div class=""><h2 id="a9e7" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">如何使用EventBridge在DynamoDB和DocumentDB中基于数据库更改对域事件进行流式处理，并提供用TypeScript和CDK编写的视觉效果和代码示例。</h2></div><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi kq"><img src="../Images/ac4e6b002991702f82928b46fbf61c20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vDEWq2mQ_VLsvA-uG8Vmog.png"/></div></div></figure><h1 id="8eda" class="kv kw jb bd kx ky kz la lb lc ld le lf kh lg ki lh kk li kl lj kn lk ko ll lm bi translated">介绍</h1><p id="2c15" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">当我们跨多个域构建事件驱动的无服务器解决方案时，确保不可变事件仅在事件发生后才被明确引发是很重要的。</p><p id="f9f1" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我们可以利用<a class="ae mo" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.html" rel="noopener ugc nofollow" target="_blank"> DynamoDB流</a>和<a class="ae mo" href="https://docs.aws.amazon.com/documentdb/latest/developerguide/change_streams.html" rel="noopener ugc nofollow" target="_blank"> DocumentDB更改流</a>来确保我们只在数据被提交到相关数据库时才引发相关事件，并确保事件总是100%被引发(<em class="mp">通过使用死信队列、重试等</em>)。这种架构模式和附带的类型脚本repo可以在这里找到:<a class="ae mo" href="https://github.com/leegilmorecode/serverless-streamed-events" rel="noopener ugc nofollow" target="_blank">https://github . com/leegilmorecode/server less-streamled-events</a></p><blockquote class="mq mr ms"><p id="c1bc" class="ln lo mp lp b lq mj kc ls lt mk kf lv mt ml ly lz mu mm mc md mv mn mg mh mi ij bi translated"><strong class="lp jc">注意</strong>:为了方便人们部署和使用，这都在一个AWS帐户内。理想情况下，所有三个领域将在单独的AWS帐户。</p></blockquote><h2 id="34cd" class="mw kw jb bd kx mx my dn lb mz na dp lf lw nb nc lh ma nd ne lj me nf ng ll nh bi translated">我们可以用其他方法让自己置身于什么场景中？</h2><p id="3145" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">有三种常见的情况:</p><p id="7f4d" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">❌数据库记录在代码中提交，但是出现了一个问题，该事件未能引发。在这种情况下，我们的消费域永远不会被通知状态/事件的变化。</p><p id="54c0" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">❌:我们在代码中成功引发了该事件，但是在提交数据库记录时出现了问题。在这个场景中，我们的消费者认为状态/事件发生了变化，但实际上记录并没有被提交。</p><p id="a17c" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">✔️第三个选项是在成功提交到数据库的记录后面生成事件，并利用死信队列来确保事件总是100%为消费者引发(<em class="mp">即使它最终是一致的</em>)。</p><p id="acd6" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">如下所示:</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/69a0cb58952ac3711c29a12ef7af1fe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DGYNJwgHucT-BbHK1M4Wnw.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">我们可能遇到的一些奇怪情况以及解决方法</figcaption></figure><p id="d804" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">在下一节中，让我们看看如何对此进行设计。</p><h2 id="e06a" class="mw kw jb bd kx mx my dn lb mz na dp lf lw nb nc lh ma nd ne lj me nf ng ll nh bi translated">事务发件箱模式</h2><p id="a870" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">我们在上图的第三个设置中描述的是'<em class="mp">事务发件箱</em>'模式。</p><p id="e84d" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">下图显示了这一点:</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nn"><img src="../Images/f303c7830c244e21db581c4b218a06fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dxZQaSqD922ISlas.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated"><a class="ae mo" href="https://microservices.io/patterns/data/transactional-outbox.html" rel="noopener ugc nofollow" target="_blank">https://microservices . io/patterns/data/transactional-outbox . html</a></figcaption></figure><p id="3afa" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">一个域服务通常需要更新一个数据库，然后向数据库后面的其他域发送一个事件(<em class="mp">例如‘order created’</em>)。我们需要确保这个过程是原子性的，否则我们可能会陷入上一节讨论的场景中。</p><p id="cd11" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">当我们为数据库和消息代理使用AWS服务时，我们无法执行原子两阶段提交(<em class="mp">分布式事务</em>)，需要一种不同的方法。</p><p id="4ea8" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">如果我们确保只在实际更新的数据库后面引发事件，并确保我们在发送事件时有弹性，那么我们有以下好处:</p><ul class=""><li id="c62b" class="no np jb lp b lq mj lt mk lw nq ma nr me ns mi nt nu nv nw bi translated">我们不需要使用两阶段提交。</li><li id="59b0" class="no np jb lp b lq nx lt ny lw nz ma oa me ob mi nt nu nv nw bi translated">当且仅当数据库事务提交时，才能保证发送消息。</li></ul><p id="6ba9" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">让我们看看在使用EventBridge时，如何使用DynamoDB和DocumentDB来实现这一点。</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><h1 id="f907" class="kv kw jb bd kx ky oj la lb lc ok le lf kh ol ki lh kk om kl lj kn on ko ll lm bi translated">我们在建造什么？🏗️</h1><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oo"><img src="../Images/fd623b4be97279ed7be507a857a9d4f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KLxOShOjkP213wssKvSKag.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">我们虚构的剃须刀订阅公司'李詹姆斯剃须刀'</figcaption></figure><p id="0356" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我们将构建一个虚构的场景，其中客户可以在我们的<code class="fe op oq or os b">Subscription</code>域中创建mens razors的月度订阅，然后在<code class="fe op oq or os b">Stock</code>域中分配相关股票，并在<code class="fe op oq or os b">Payments</code>域中创建直接借记记录。</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ot"><img src="../Images/52f2c52525742713c90224e5075a2b66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-enFuNKkEK9kL0Xf83RyzQ.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">创建订阅</figcaption></figure><p id="9729" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">如果客户通过<code class="fe op oq or os b">Payments</code>域名取消他们的直接借记，那么<code class="fe op oq or os b">Stock</code>域名将解除股票分配，而<code class="fe op oq or os b">Subscription</code>域名将取消认购。如下所示:</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ou"><img src="../Images/ea73d3c1b587c602737d81cae756d518.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CJYYtkqXsiXwPNl7nNa3FQ.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">付款取消流程</figcaption></figure><p id="45ae" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">从这个示例基本架构中我们可以注意到，事件是在两个流的后面生成的(<em class="mp"> DynamoDB流和DocumentDB Change流</em>)。我们将在下面做更深的潜水。</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><h1 id="d4d1" class="kv kw jb bd kx ky oj la lb lc ok le lf kh ol ki lh kk om kl lj kn on ko ll lm bi translated">为什么没有中心事件总线？</h1><p id="d8ba" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">对于上图中的鹰眼，我们可以看到没有中央事件总线，每个事件总线都相互通信。这是我们将使用的多总线、多帐户模式。</p><p id="6a13" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">使用EventBridge，为了跨帐户进行通信，我们需要从一个总线到另一个总线，并且当正确地构建我们的域时，每个域应该被划分到它自己的AWS帐户中。这给了我们两个选择:</p><h2 id="f31e" class="mw kw jb bd kx mx my dn lb mz na dp lf lw nb nc lh ma nd ne lj me nf ng ll nh bi translated">单总线、多账户模式</h2><p id="4811" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">组织通常拥有一个“DevOps”团队，负责通过单一事件总线管理共享资源。每个服务团队拥有并管理自己的应用程序堆栈，而DevOps团队管理定义服务集成的事件总线规则和目标配置的堆栈。</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ov"><img src="../Images/900e136550a6a2a82a57c68283157d69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lxLCvSttQDJVWQsU.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated"><a class="ae mo" href="https://github.com/aws-samples/amazon-eventbridge-resource-policy-samples/blob/main/patterns/README.md" rel="noopener ugc nofollow" target="_blank">https://github . com/AWS-samples/Amazon-event bridge-resource-policy-samples/blob/main/patterns/readme . MD</a></figcaption></figure><p id="7f57" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><strong class="lp jc">注意事项</strong></p><ul class=""><li id="b291" class="no np jb lp b lq mj lt mk lw nq ma nr me ns mi nt nu nv nw bi translated">额外的跨账户策略管理(<em class="mp">相比于单总线、单账户模式</em>)。</li><li id="1091" class="no np jb lp b lq nx lt ny lw nz ma oa me ob mi nt nu nv nw bi translated">服务团队管理目标配置，但不管理路线</li><li id="5274" class="no np jb lp b lq nx lt ny lw nz ma oa me ob mi nt nu nv nw bi translated">引入了对多个事件总线的需求，以便在帐户之间传输事件</li><li id="b638" class="no np jb lp b lq nx lt ny lw nz ma oa me ob mi nt nu nv nw bi translated">仍然通过中央总线的路由规则</li><li id="4d3c" class="no np jb lp b lq nx lt ny lw nz ma oa me ob mi nt nu nv nw bi translated">目标规则迁移到服务帐户事件总线</li></ul><h2 id="b9a4" class="mw kw jb bd kx mx my dn lb mz na dp lf lw nb nc lh ma nd ne lj me nf ng ll nh bi translated">多总线、多账户模式</h2><p id="8895" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在这个模式中，每个事件总线都归服务团队所有。每个服务团队管理自己的公交车。没有路由逻辑或目标配置的集中管理。</p><p id="8bdd" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">服务团队需要了解对订阅他们发布的事件感兴趣的服务。</p><blockquote class="mq mr ms"><p id="23d3" class="ln lo mp lp b lq mj kc ls lt mk kf lv mt ml ly lz mu mm mc md mv mn mg mh mi ij bi translated"><strong class="lp jc">注意</strong>:每个事件总线都设置自己的EventBusPolicy来限定哪些事件源可以发布到总线，并创建EventBusPolicy来定义哪些帐户可以管理其帐户上的规则和目标。</p></blockquote><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ow"><img src="../Images/948b88dff6e8318ace10d5b5a1dbaba5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hwxrmWfW_avy1wQD.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated"><a class="ae mo" href="https://github.com/aws-samples/amazon-eventbridge-resource-policy-samples/blob/main/patterns/README.md" rel="noopener ugc nofollow" target="_blank">https://github . com/AWS-samples/Amazon-event bridge-resource-policy-samples/blob/main/patterns/readme . MD</a></figcaption></figure><p id="ae9c" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><strong class="lp jc">注意事项</strong></p><ul class=""><li id="be11" class="no np jb lp b lq mj lt mk lw nq ma nr me ns mi nt nu nv nw bi translated">服务团队管理发送和接收事件的所有资源</li><li id="217d" class="no np jb lp b lq nx lt ny lw nz ma oa me ob mi nt nu nv nw bi translated">管理分布式规则和资源策略的额外开销</li><li id="c688" class="no np jb lp b lq nx lt ny lw nz ma oa me ob mi nt nu nv nw bi translated">每个服务团队管理自己的事件总线</li><li id="42b9" class="no np jb lp b lq nx lt ny lw nz ma oa me ob mi nt nu nv nw bi translated">不需要额外的总线来促进跨客户事件交付</li><li id="f8af" class="no np jb lp b lq nx lt ny lw nz ma oa me ob mi nt nu nv nw bi translated">与服务边界一致</li></ul><h1 id="5552" class="kv kw jb bd kx ky kz la lb lc ld le lf kh lg ki lh kk li kl lj kn lk ko ll lm bi translated">入门！✔️</h1><p id="d945" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">首先，使用以下git命令克隆以下repo:</p><pre class="kr ks kt ku gt ox os oy oz aw pa bi"><span id="568b" class="mw kw jb os b gy pb pc l pd pe">git clone <a class="ae mo" href="https://github.com/leegilmorecode/serverless-streamed-events" rel="noopener ugc nofollow" target="_blank">https://github.com/leegilmorecode/serverless-streamed-events</a></span></pre><p id="ed83" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这将把示例代码下载到您的本地机器上。</p><blockquote class="mq mr ms"><p id="fb67" class="ln lo mp lp b lq mj kc ls lt mk kf lv mt ml ly lz mu mm mc md mv mn mg mh mi ij bi translated"><em class="jb">💡</em> <strong class="lp jc"> <em class="jb">注意</em> </strong> <em class="jb"> : </em>这不是生产就绪代码，仅用于演示概念。我们将所有的域服务部署到一个AWS帐户，但我们通常会将每个服务部署到自己的帐户中，这是最佳做法。我们还将强化发送事件等方面的弹性</p></blockquote></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><h1 id="bf93" class="kv kw jb bd kx ky oj la lb lc ok le lf kh ol ki lh kk om kl lj kn on ko ll lm bi translated">部署解决方案！👨‍💻</h1><p id="88c3" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">🛑 <strong class="lp jc">注意</strong> : <em class="mp">运行以下命令会在你的AWS账户上产生费用，而且有些服务不在免费层。</em></p><p id="2919" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">在文件夹下运行<code class="fe op oq or os b">npm run deploy</code>。</p><p id="4f47" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">在文件夹<em class="mp">支付服务/src/流</em>中运行<code class="fe op oq or os b">npm run build</code>。</p><p id="98b1" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">在文件夹<em class="mp">支付服务</em>中运行<code class="fe op oq or os b">npm run deploy</code>。</p><p id="a16e" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">在文件夹<em class="mp">库存服务</em>中运行<code class="fe op oq or os b">npm run deploy</code>。</p><p id="7b7c" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">在<em class="mp">订阅服务</em>中运行<code class="fe op oq or os b">npm run deploy</code>。</p><p id="1e41" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">🛑 <strong class="lp jc">注意</strong> : <em class="mp">记得在你完成的时候拆掉堆叠，这样你就不会继续被收费了，使用上面相关文件夹中的‘NPM run remove’。</em></p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><h1 id="e059" class="kv kw jb bd kx ky oj la lb lc ok le lf kh ol ki lh kk om kl lj kn on ko ll lm bi translated">讨论一下👊</h1><p id="c1b4" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">🛑 <strong class="lp jc">注意</strong> <em class="mp">:请记住，这段代码只是为了概念验证和讨论而编写的。我还试图将相关代码保存在更少的文件中，这样文章更容易阅读。</em></p><h2 id="a3cf" class="mw kw jb bd kx mx my dn lb mz na dp lf lw nb nc lh ma nd ne lj me nf ng ll nh bi translated">dynamodb中的流</h2><p id="09ea" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">下图显示了在DynamoDB中提交数据库记录后的流事件的基本示例:</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pf"><img src="../Images/bf1eb9ae8fc124fe169d0cc8c3312c95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0X4BNP1iVldo9pKLNoHBNQ.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">DynamoDB流的作用</figcaption></figure><p id="9180" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">正如我们从上图中看到的，我们从提交的DynamoDB记录的背面引发事件，并对任何未能引发的事件使用DLQ，这样它们就不会丢失。</p><h2 id="b5c6" class="mw kw jb bd kx mx my dn lb mz na dp lf lw nb nc lh ma nd ne lj me nf ng ll nh bi translated">✅文档中的流DB</h2><p id="4106" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">下图显示了通过<a class="ae mo" href="https://docs.aws.amazon.com/documentdb/latest/developerguide/change_streams.html" rel="noopener ugc nofollow" target="_blank">更改流</a>将数据库记录提交到DocumentDB之后的流事件的流程:</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pg"><img src="../Images/8427dea6c98ebcb1776bc3a6ee32e0f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U7fmtX5p-aa56Cx5V1bBvg.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">DocumentDB流在运行</figcaption></figure><p id="f912" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">正如我们从上图中看到的，当支付被取消并且DocumentDB数据库中的记录被更新时，ECS任务使用了更新的变更流。该任务将消息发送到FIFO队列，Lambda读取该队列并将正确的事件发送到EventBridge。</p><blockquote class="mq mr ms"><p id="9940" class="ln lo mp lp b lq mj kc ls lt mk kf lv mt ml ly lz mu mm mc md mv mn mg mh mi ij bi translated"><em class="jb">💡</em> <strong class="lp jc"> <em class="jb">注意</em> </strong> <em class="jb"> : </em>对于我们的变更流，如果出现问题或消息未能发送到SQS，例如网络问题或ECS任务失败，我们需要进行恢复。出于这个原因，我们将更新在ECS中运行的代码，以将更改流恢复到最后一个被处理的记录。<a class="ae mo" href="https://docs.aws.amazon.com/documentdb/latest/developerguide/change_streams.html#change_streams-resuming" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/document db/latest/developer guide/change _ streams . html # change _ streams-resumption</a></p></blockquote></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><h1 id="d41a" class="kv kw jb bd kx ky oj la lb lc ok le lf kh ol ki lh kk om kl lj kn on ko ll lm bi translated">测试解决方案🎯</h1><h2 id="dc23" class="mw kw jb bd kx mx my dn lb mz na dp lf lw nb nc lh ma nd ne lj me nf ng ll nh bi translated">新订阅🪒</h2><p id="2ea5" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">我们首先为我们的剃须刀创建一个新的客户订阅:</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ph"><img src="../Images/968b54e8d128fa4fffa946b1af424dec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7suTzgFOg_nvfLQJxF2kdg.png"/></div></div></figure><p id="faaa" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">然后在订阅域中创建相关记录:</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pi"><img src="../Images/3e1bfb082aec8210b9be13b47cdc3293.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IPIanpGukr77pLzTsiN9iw.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">新的客户预订已创建</figcaption></figure><p id="6f12" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">当股票域接收到'<code class="fe op oq or os b">SubscriptionCreated</code>'事件时，它分配相关的股票，如下所示，并且在支付域中创建相关的支付(<em class="mp">我们预先分配12个月的价值，并且还创建支付订阅记录</em>)。</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pj"><img src="../Images/7b3e87246ad1ae7d328098bfe938afdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sFREf8HIn3cxFa7jVbnvxg.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">创建库存记录以分配库存</figcaption></figure><h2 id="62c3" class="mw kw jb bd kx mx my dn lb mz na dp lf lw nb nc lh ma nd ne lj me nf ng ll nh bi translated">取消❌付款</h2><p id="7541" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">现在让我们取消付款，就像客户从第三方系统取消了他们的直接借记一样:</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pk"><img src="../Images/ee56e0802308dec3f8f52bf0a52bc34c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k_dvlGf3aM-CvwVT-Vv6lQ.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">取消付款</figcaption></figure><p id="72b7" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这引发了<code class="fe op oq or os b">PaymentCancelled</code>事件，这意味着订阅域现在取消了订阅:</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pl"><img src="../Images/2e2917ff0daa5a4b4bc3a20e49b356b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OsbpS8irXkQ3O7-Bsojdvw.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">客户订阅被取消</figcaption></figure><p id="335b" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">在股票领域，我们取消了相关股票的分配，因为付款和认购已经取消:</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pm"><img src="../Images/864ed7eea392178e85951ea028b51308.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-V7VaF6TT5gvkSwPDGTxIQ.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">股票域解除相关股票的分配</figcaption></figure></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="8935" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><strong class="lp jc">请访问我们的赞助商</strong> <a class="ae mo" href="https://www.sedai.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lp jc"> Sedai.io </strong> </a></p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pn"><img src="../Images/7a2ec298bec945a027504d5ddaf80673.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OOUUg0zWhR0aDpq7"/></div></div></figure><h1 id="03ba" class="kv kw jb bd kx ky kz la lb lc ld le lf kh lg ki lh kk li kl lj kn lk ko ll lm bi translated">摘要</h1><p id="1a96" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">我希望您发现这是一个有用的基本例子，它是DynamoDB和DocumentDB的无服务器模式！</p><p id="e91a" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">请点击此处订阅我的企业无服务器新闻稿，了解更多相同的内容:</p><div class="ip iq gp gr ir po"><a href="https://www.linkedin.com/newsletters/enterprise-serverless-%F0%9F%9A%80-6875837779876605952/" rel="noopener  ugc nofollow" target="_blank"><div class="pp ab fo"><div class="pq ab pr cl cj ps"><h2 class="bd jc gy z fp pt fr fs pu fu fw ja bi translated">企业无服务器🚀LinkedIn</h2><div class="pv l"><h3 class="bd b gy z fp pt fr fs pu fu fw dk translated">Lee Gilmore |面向AWS开发人员、DevOps工程师和云架构师的无服务器新闻和文章</h3></div><div class="pw l"><p class="bd b dl z fp pt fr fs pu fu fw dk translated">www.linkedin.com</p></div></div><div class="px l"><div class="py l pz qa qb px qc ix po"/></div></div></a></div><h1 id="6331" class="kv kw jb bd kx ky kz la lb lc ld le lf kh lg ki lh kk li kl lj kn lk ko ll lm bi translated">包扎👋</h1><p id="0508" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">请<a class="ae mo" href="https://www.youtube.com/channel/UC_Bi6eLsBXpLnNRNnxKQUsA" rel="noopener ugc nofollow" target="_blank">去我的YouTube频道</a>订阅类似的内容！</p><figure class="kr ks kt ku gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi qd"><img src="../Images/0f91bfcf52a73d34c3a4bb10462e530e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6HSrLpkaDR7p3ccI.png"/></div></div></figure><p id="61f1" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我很乐意就以下任何一个方面与您联系:</p><p id="737d" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><a class="ae mo" href="https://www.linkedin.com/in/lee-james-gilmore/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/lee-james-gilmore/</a>T10<a class="ae mo" href="https://twitter.com/LeeJamesGilmore" rel="noopener ugc nofollow" target="_blank">https://twitter.com/LeeJamesGilmore</a></p><p id="a406" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">如果你觉得这些文章鼓舞人心或有用，请随时用虚拟咖啡<a class="ae mo" href="https://www.buymeacoffee.com/leegilmore" rel="noopener ugc nofollow" target="_blank">https://www.buymeacoffee.com/leegilmore</a>来支持我，不管怎样，让我们联系和聊天吧！☕️</p><p id="6d8f" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">如果你喜欢这些帖子，请关注我的简介<a class="ae mo" href="https://medium.com/u/2906c6def240?source=post_page-----39c4f4ae5aff----------------------" rel="noopener">李·詹姆斯·吉尔摩</a>以获取更多的帖子/系列，不要忘记联系我并打招呼👋</p><p id="b8b7" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">如果你喜欢，也请使用帖子底部的“鼓掌”功能！(<em class="mp">可以不止一次鼓掌！！</em></p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><h1 id="7a64" class="kv kw jb bd kx ky oj la lb lc ok le lf kh ol ki lh kk om kl lj kn on ko ll lm bi translated">关于我</h1><p id="6173" class="pw-post-body-paragraph ln lo jb lp b lq lr kc ls lt lu kf lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">"<em class="mp">大家好，我是Lee，AWS社区构建者、博客作者、AWS认证云架构师和全球无服务器架构师，住在英国；目前在City Electrical Factors工作，过去6年主要从事AWS上的全栈JavaScript工作。</em></p><p id="de7d" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><em class="mp">我认为自己是一个无服务器倡导者，热爱AWS、创新、软件架构和技术。</em>”</p><p id="2591" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><strong class="lp jc"> ***所提供的信息是我个人的观点，我对这些信息的使用不承担任何责任。*** </strong></p><p id="f8ce" class="pw-post-body-paragraph ln lo jb lp b lq mj kc ls lt mk kf lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">您可能还对以下内容感兴趣:</p><div class="ip iq gp gr ir po"><a href="https://leejamesgilmore.medium.com/serverless-content-46ef5b562d8e" rel="noopener follow" target="_blank"><div class="pp ab fo"><div class="pq ab pr cl cj ps"><h2 class="bd jc gy z fp pt fr fs pu fu fw ja bi translated">无服务器内容🚀</h2><div class="pv l"><h3 class="bd b gy z fp pt fr fs pu fu fw dk translated">我的所有无服务器内容的索引，可以在一个地方轻松浏览，包括视频、博客文章等..</h3></div><div class="pw l"><p class="bd b dl z fp pt fr fs pu fu fw dk translated">leejamesgilmore.medium.com</p></div></div><div class="px l"><div class="qe l pz qa qb px qc ix po"/></div></div></a></div></div></div>    
</body>
</html>