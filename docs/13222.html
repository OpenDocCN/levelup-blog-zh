<html>
<head>
<title>Django app deployed using GitLab pipeline on AWS ECS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitLab管道在AWS ECS上部署Django应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/django-app-deployed-using-gitlab-pipeline-on-aws-ecs-43689d2fc5bf?source=collection_archive---------6-----------------------#2022-08-18">https://levelup.gitconnected.com/django-app-deployed-using-gitlab-pipeline-on-aws-ecs-43689d2fc5bf?source=collection_archive---------6-----------------------#2022-08-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/0655aefad3578587c82ce160cee197f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PC3pm8nH0v8VZwo4"/></div></div></figure><p id="a0cb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">作为一个新手，在GitLab中设置管道可能很麻烦。我将一步一步地向您介绍在特定分支发生合并请求时部署到AWS ECS容器服务的基本流程。对于这个例子，我将使用一个Django应用程序。</p><p id="e396" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">先决条件:</p><ul class=""><li id="4129" class="kz la it kd b ke kf ki kj km lb kq lc ku ld ky le lf lg lh bi translated">自动警报系统</li><li id="dcb3" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky le lf lg lh bi translated">姜戈</li><li id="40c4" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky le lf lg lh bi translated">码头工人</li><li id="10b5" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky le lf lg lh bi translated">网络服务</li></ul><p id="6a42" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们的第一个目标是尝试使用Docker和web服务让应用程序在本地工作，最好是在不同于通常的80端口上。在这个例子中，我将使用Nginx。</p></div><div class="ab cl ln lo hx lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="im in io ip iq"><p id="28ab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">检查一下你在https://eu-west-2.console.aws.amazon.com/ecr/repositories?有ECS仓库吗区域=欧盟-西方-2 。您将需要2个，一个用于应用程序，一个用于web服务。这是ECS将使用docker映像从下面进一步定义的地方进行加载的地方</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/58290d4462645b7483b339b1e7a8a883.png" data-original-src="https://miro.medium.com/v2/resize:fit:346/format:webp/1*AoYRaHLgQr1rEA8kvgd9xg.png"/></div></figure><p id="c3ed" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在创建一个新的测试集群、服务和任务。我将使用所有默认值</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ma"><img src="../Images/0fece5627607e68f4c3613a3e6afcbb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bmttpo1Asaed2M5XzKOhmg.png"/></div></div></figure><p id="1f4f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建一个新任务，可以使用向导或json。酌情替换***部分。</p><p id="3fd3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">json关键对象“environment”中的值是您的应用程序所需的值。我可能有一些额外的，这是不需要一个基本的应用程序。</p><p id="87b4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我启用了“日志配置”,因为这对于在AWS Cloudwatch中调试您的环境非常有用。</p><p id="38f2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于“端口映射”,您需要设置高端口，用于从浏览器访问应用程序。在该容器内，它本身将是端口80。</p><p id="7d8c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有两个“容器定义”,一个用于web服务，一个来自应用程序。他们将使用早先创建的存储库，在键<code class="fe mb mc md me b">image</code>下指定</p><pre class="lw lx ly lz gt mf me mg mh aw mi bi"><span id="e5b6" class="mj mk it me b gy ml mm l mn mo">{<br/>  "ipcMode": null,<br/>  "executionRoleArn": null,<br/>  "containerDefinitions": [<br/>    {<br/>      "dnsSearchDomains": null,<br/>      "environmentFiles": null,<br/>      "logConfiguration": {<br/>        "logDriver": "awslogs",<br/>        "secretOptions": null,<br/>        "options": {<br/>          "awslogs-group": "/ecs/pipelines_4000",<br/>          "awslogs-region": "eu-west-2",<br/>          "awslogs-stream-prefix": "ecs"<br/>        }<br/>      },<br/>      "entryPoint": null,<br/>      "portMappings": [<br/>        {<br/>          "hostPort": 4000,<br/>          "protocol": "tcp",<br/>          "containerPort": 4000<br/>        }<br/>      ],<br/>      "command": null,<br/>      "linuxParameters": null,<br/>      "cpu": 0,<br/>      "environment": [<br/>        {<br/>          "name": "ALLOWED_HOSTS",<br/>          "value": "*"<br/>        },<br/>        {<br/>          "name": "AWS_ACCESS_KEY_ID",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "AWS_S3_REGION_NAME",<br/>          "value": "eu-west-2"<br/>        },<br/>        {<br/>          "name": "AWS_SECRET_ACCESS_KEY",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "AWS_STORAGE_BUCKET_NAME",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "BASE_URL",<br/>          "value": "<a class="ae lu" href="https://qa-reachhf.hci.digital" rel="noopener ugc nofollow" target="_blank">*</a>**"<br/>        },<br/>        {<br/>          "name": "DEBUG",<br/>          "value": "1"<br/>        },<br/>        {<br/>          "name": "DEFAULT_FROM_EMAIL",<br/>          "value": "<a class="ae lu" href="mailto:info@reachhf.co.uk" rel="noopener ugc nofollow" target="_blank">*</a>**"<br/>        },<br/>        {<br/>          "name": "DEFAULT_SUPERUSER_EMAIL",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "DEFAULT_SUPERUSER_PASSWORD",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "DEFAULT_SUPERUSER_USERNAME",<br/>          "value": "reach_super"<br/>        },<br/>        {<br/>          "name": "EMAIL_BACKEND",<br/>          "value": "django.core.mail.backends.smtp.EmailBackend"<br/>        },<br/>        {<br/>          "name": "EMAIL_HOST",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "EMAIL_HOST_PASSWORD",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "EMAIL_HOST_USER",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "EMAIL_PORT",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "EMAIL_USE_SSL",<br/>          "value": "0"<br/>        },<br/>        {<br/>          "name": "EMAIL_USE_TLS",<br/>          "value": "1"<br/>        },<br/>        {<br/>          "name": "ENVIRONMENT",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "RDS_DB_NAME",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "RDS_HOSTNAME",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "RDS_PASSWORD",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "RDS_PORT",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "RDS_USERNAME",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "SECRET_KEY",<br/>          "value": "***"<br/>        },<br/>        {<br/>          "name": "SESSION_COOKIE_DOMAIN",<br/>          "value": "***"<br/>        }<br/>      ],<br/>      "resourceRequirements": null,<br/>      "ulimits": null,<br/>      "dnsServers": null,<br/>      "mountPoints": [],<br/>      "workingDirectory": null,<br/>      "secrets": null,<br/>      "dockerSecurityOptions": null,<br/>      "memory": 350,<br/>      "memoryReservation": null,<br/>      "volumesFrom": [],<br/>      "stopTimeout": null,<br/>      "image": "***.dkr.ecr.eu-west-2.amazonaws.com/pipelines-django",<br/>      "startTimeout": null,<br/>      "firelensConfiguration": null,<br/>      "dependsOn": null,<br/>      "disableNetworking": null,<br/>      "interactive": null,<br/>      "healthCheck": null,<br/>      "essential": true,<br/>      "links": null,<br/>      "hostname": null,<br/>      "extraHosts": null,<br/>      "pseudoTerminal": null,<br/>      "user": null,<br/>      "readonlyRootFilesystem": null,<br/>      "dockerLabels": null,<br/>      "systemControls": null,<br/>      "privileged": null,<br/>      "name": "pipelines_django"<br/>    },<br/>    {<br/>      "dnsSearchDomains": null,<br/>      "environmentFiles": null,<br/>      "logConfiguration": {<br/>        "logDriver": "awslogs",<br/>        "secretOptions": null,<br/>        "options": {<br/>          "awslogs-group": "/ecs/pipelines_4000",<br/>          "awslogs-region": "eu-west-2",<br/>          "awslogs-stream-prefix": "ecs"<br/>        }<br/>      },<br/>      "entryPoint": null,<br/>      "portMappings": [<br/>        {<br/>          "hostPort": 4001,<br/>          "protocol": "tcp",<br/>          "containerPort": 80<br/>        }<br/>      ],<br/>      "command": null,<br/>      "linuxParameters": null,<br/>      "cpu": 0,<br/>      "environment": [],<br/>      "resourceRequirements": null,<br/>      "ulimits": null,<br/>      "dnsServers": null,<br/>      "mountPoints": [],<br/>      "workingDirectory": null,<br/>      "secrets": null,<br/>      "dockerSecurityOptions": null,<br/>      "memory": 128,<br/>      "memoryReservation": null,<br/>      "volumesFrom": [],<br/>      "stopTimeout": null,<br/>      "image": "***.dkr.ecr.eu-west-2.amazonaws.com/pipelines-nginx",<br/>      "startTimeout": null,<br/>      "firelensConfiguration": null,<br/>      "dependsOn": null,<br/>      "disableNetworking": null,<br/>      "interactive": null,<br/>      "healthCheck": null,<br/>      "essential": true,<br/>      "links": [<br/>        "pipelines_django"<br/>      ],<br/>      "hostname": null,<br/>      "extraHosts": null,<br/>      "pseudoTerminal": null,<br/>      "user": null,<br/>      "readonlyRootFilesystem": null,<br/>      "dockerLabels": null,<br/>      "systemControls": null,<br/>      "privileged": null,<br/>      "name": "pipelines_nginx"<br/>    }<br/>  ],<br/>  "placementConstraints": [],<br/>  "memory": null,<br/>  "taskRoleArn": null,<br/>  "compatibilities": [<br/>    "EXTERNAL",<br/>    "EC2"<br/>  ],<br/>  "taskDefinitionArn": "arn:aws:ecs:eu-west-2:***:task-definition/pipelines_4000:8",<br/>  "family": "pipelines_4000",<br/>  "requiresAttributes": [<br/>    {<br/>      "targetId": null,<br/>      "targetType": null,<br/>      "value": null,<br/>      "name": "com.amazonaws.ecs.capability.logging-driver.awslogs"<br/>    },<br/>    {<br/>      "targetId": null,<br/>      "targetType": null,<br/>      "value": null,<br/>      "name": "com.amazonaws.ecs.capability.ecr-auth"<br/>    },<br/>    {<br/>      "targetId": null,<br/>      "targetType": null,<br/>      "value": null,<br/>      "name": "com.amazonaws.ecs.capability.docker-remote-api.1.19"<br/>    }<br/>  ],<br/>  "pidMode": null,<br/>  "requiresCompatibilities": [<br/>    "EC2"<br/>  ],<br/>  "networkMode": null,<br/>  "runtimePlatform": null,<br/>  "cpu": null,<br/>  "revision": 8,<br/>  "status": "ACTIVE",<br/>  "inferenceAccelerators": null,<br/>  "proxyConfiguration": null,<br/>  "volumes": []<br/>}</span></pre><p id="661d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建一个服务，将其命名为pipelines_demo，并关联您刚刚创建的任务</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/9e6463bb19cd44c6dd98695b51d35922.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*xN80mvVAg-Bo0JkbY5iw5A.png"/></div></figure></div><div class="ab cl ln lo hx lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="im in io ip iq"><p id="e0c5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在GitLab中创建一个名为Pipelines的新存储库。</p><p id="076c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">用Python初始化一个简单的Django应用程序。</p><p id="de35" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在为Nginx设置一个Docker映像</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/b904b0164e684a29dc7dedeea6ecd862.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*OXE1L2CxZvW2SwxJWAWjNA.png"/></div></figure><pre class="lw lx ly lz gt mf me mg mh aw mi bi"><span id="9ef7" class="mj mk it me b gy ml mm l mn mo">#Dockerfile<br/>FROM nginx:1.19.0-alpine<br/><br/>RUN rm /etc/nginx/conf.d/default.conf<br/>COPY nginx.conf /etc/nginx/conf.d</span></pre><p id="00da" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">#ecr_build_nginx.sh</p><p id="747a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">酌情替换***部分。您希望使用与您创建的存储库相同的名称，以保持一致性</p><pre class="lw lx ly lz gt mf me mg mh aw mi bi"><span id="8dee" class="mj mk it me b gy ml mm l mn mo"><strong class="me iu">#!/bin/sh<br/></strong>aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin ***.dkr.ecr.eu-west-2.amazonaws.com<br/># Build the docker container ( stipulating AMD chipset if on a Mac M1 )<br/>docker build  --no-cache --platform linux/amd64 -t pipelines-nginx .<br/># Tag the completed build in ECR<br/>docker tag pipelines-nginx:latest ***.dkr.ecr.eu-west-2.amazonaws.com/pipelines-nginx:latest<br/># Push this build to ECR as latest<br/>docker push ***.dkr.ecr.eu-west-2.amazonaws.com/pipelines-nginx:latest</span></pre><p id="d2fe" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"># nginx.conf</p><pre class="lw lx ly lz gt mf me mg mh aw mi bi"><span id="e7d9" class="mj mk it me b gy ml mm l mn mo"># should match name in docker-compose or container in ECR<br/>upstream pipelines-django {<br/>    server pipelines-django:9000;<br/>}<br/><br/>server {<br/><br/>    listen 80;<br/>    client_max_body_size 100M;<br/><br/>    location / {<br/>        proxy_pass http://pipelines-django;<br/>        proxy_set_header X-Forwarded-For <strong class="me iu">$</strong>proxy_add_x_forwarded_for;<br/>        proxy_set_header Host <strong class="me iu">$</strong>host;<br/>        proxy_redirect off;<br/>    }<br/><br/>}</span></pre><p id="d61f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">设置Docker来运行这个应用程序</p><pre class="lw lx ly lz gt mf me mg mh aw mi bi"><span id="a181" class="mj mk it me b gy ml mm l mn mo"># Dockerfile<br/>FROM python:3.7-slim<br/><br/>RUN apt-get update<br/>RUN apt-get install -y libpq-dev zip<br/>RUN apt-get install gcc -y<br/><br/>COPY . /pipeline<br/>RUN chmod +x pipeline/aws_start.sh<br/>RUN pip install -r /pipeline/dev-requirements.txt<br/>RUN pip install gunicorn<br/>VOLUME /pipeline<br/>WORKDIR /pipeline<br/>EXPOSE 4000<br/><br/>ENV PYTHONUNBUFFERED 1<br/>RUN ["chmod", "+x", "/pipeline/aws_start.sh"]<br/>ENTRYPOINT /pipeline/aws_start.sh</span></pre><p id="541f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Docker将运行这个条目文件</p><pre class="lw lx ly lz gt mf me mg mh aw mi bi"><span id="2c87" class="mj mk it me b gy ml mm l mn mo">#!/bin/sh</span><span id="ad6f" class="mj mk it me b gy mr mm l mn mo"># aws_start.sh<br/>python manage.py migrate<br/>python manage.py collectstatic --noinput<br/>python manage.py create_default_superuser<br/>gunicorn -w 3 -b :4000 pipeline.wsgi:application</span></pre><p id="57c2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个脚本将创建。环境文件。你会注意到它从AWS系统管理器获取秘密文本。它还将构建应用程序并将其部署到ECS</p><p id="314d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"># ecr_deploy.sh</p><pre class="lw lx ly lz gt mf me mg mh aw mi bi"><span id="36c4" class="mj mk it me b gy ml mm l mn mo"><strong class="me iu">#!/bin/sh<br/></strong>mv .env .env_local<br/><br/># Copy the QA env to the project root so it is automatically picker up during docker build<br/>echo -en 'ALLOWED_HOSTS=*\n' &gt;&gt; .env<br/>AWS_ACCESS_KEY_ID=`aws ssm get-parameter --name pipelines-AWS_SECRET_ACCESS_KEY | jq -r .Parameter.Value`<br/>echo -en 'AWS_ACCESS_KEY_ID='$AWS_ACCESS_KEY_ID'\n' &gt;&gt; .env<br/>echo -en 'AWS_S3_REGION_NAME=eu-west-2\n' &gt;&gt; .env<br/>AWS_SECRET_ACCESS_KEY=`aws ssm get-parameter --name pipelines-AWS_SECRET_ACCESS_KEY | jq -r .Parameter.Value`<br/>echo -en 'AWS_SECRET_ACCESS_KEY='$AWS_SECRET_ACCESS_KEY'\n' &gt;&gt; .env<br/>echo -en 'AWS_STORAGE_BUCKET_NAME=pipelines\n' &gt;&gt; .env<br/>echo -en 'BASE_URL=https://pipelines.co.uk\n' &gt;&gt; .env<br/>echo -en 'DATABASE_ENGINE=django.db.backends.mysql\n' &gt;&gt; .env<br/>echo -en 'DATABASE_HOST=pipelines.coz8h02qupfe.eu-west-2.rds.amazonaws.com\n' &gt;&gt; .env<br/>echo -en 'DATABASE_NAME=pipelines\n' &gt;&gt; .env<br/>DATABASE_PASSWORD=`aws ssm get-parameter --name pipelines-DATABASE_PASSWORD | jq -r .Parameter.Value`<br/>echo -en 'DATABASE_PASSWORD='$DATABASE_PASSWORD'\n' &gt;&gt; .env<br/>echo -en 'DATABASE_PORT=3306\n' &gt;&gt; .env<br/>echo -en 'DATABASE_USER=pipelines\n' &gt;&gt; .env<br/>echo -en 'DEBUG=0\n' &gt;&gt; .env<br/>echo -en 'DJANGO_SETTINGS_MODULE=zero_nineteen.settings\n' &gt;&gt; .env<br/>echo -en 'EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend\n' &gt;&gt; .env<br/>echo -en 'EMAIL_HOST=smtp.eu.sparkpostmail.com\n' &gt;&gt; .env<br/>EMAIL_HOST_PASSWORD=`aws ssm get-parameter --name pipelines-EMAIL_HOST_PASSWORD | jq -r .Parameter.Value`<br/>echo -en 'EMAIL_HOST_PASSWORD='$EMAIL_HOST_PASSWORD'\n' &gt;&gt; .env<br/>echo -en 'EMAIL_HOST_USER=SMTP_Injection\n' &gt;&gt; .env<br/>echo -en 'ENVIRONMENT=qa\n' &gt;&gt; .env<br/>FEEDBACK_EMAIL=`aws ssm get-parameter --name pipelines-FEEDBACK_EMAIL | jq -r .Parameter.Value`<br/>echo -en 'FEEDBACK_EMAIL='$FEEDBACK_EMAIL'\n' &gt;&gt; .env<br/>echo -en 'SEARCH_INDEX=pipelines\n' &gt;&gt; .env<br/>SEARCH_URL=`aws ssm get-parameter --name pipelines-SEARCH_URL | jq -r .Parameter.Value`<br/>echo -en 'SEARCH_URL='$SEARCH_URL'\n' &gt;&gt; .env<br/>SECRET_KEY=`aws ssm get-parameter --name pipelines-SECRET_KEY | jq -r .Parameter.Value`<br/>echo -en 'SECRET_KEY='$SECRET_KEY'\n' &gt;&gt; .env<br/><br/># Rename the local dev Dockerfile<br/>mv Dockerfile Dockerfile_local<br/># Copy the QA Docker file to root ( this one has references in to the aws_start.sh Entrypoint needed by ECR<br/>cp docker/Dockerfile_qa Dockerfile<br/># Login to Elastic container registry<br/>aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin ****.dkr.ecr.eu-west-2.amazonaws.com<br/># Build the docker container ( stipulating AMD chipset if on a Mac M1 )</span><span id="c27a" class="mj mk it me b gy mr mm l mn mo">docker build --no-cache --platform linux/amd64 -t pipelines-django .<br/># Tag the completed build in ECR<br/>docker tag pipelines-django:latest ***.dkr.ecr.eu-west-2.amazonaws.com/pipelines-django:latest<br/># Push this build to ECR as latest<br/>docker push ***.dkr.ecr.eu-west-2.amazonaws.com/pipelines-django:latest<br/># Update the service on the QA cluster to load the changes<br/>aws ecs update-service --force-new-deployment --service zero_nineteen_qa --cluster QA-2<br/># Delete the Dockerfile with QA settings that was copied into root<br/>rm Dockerfile<br/># Copy back the Dockerfile intended for local dev<br/>mv Dockerfile_local Dockerfile<br/># Remove the QA ENVS<br/>rm .env<br/># Restore the environment variables for local dev<br/>cp .env_local .env</span></pre><p id="468c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"># docker-compose.yml</p><pre class="lw lx ly lz gt mf me mg mh aw mi bi"><span id="89f0" class="mj mk it me b gy ml mm l mn mo">version: '3'<br/>services:<br/><br/>  pipelines_django:<br/>    build: .<br/>    command: ${CMD:-bash -c "pip install -r dev-requirements.txt &amp;&amp; python manage.py migrate &amp;&amp; python manage.py runserver 0.0.0.0:9000"}<br/>    container_name: pipelines_django<br/>    ports:<br/>      - "4000:4000"<br/>    volumes:<br/>      - .:/pipelines<br/>      - ./static:/pipelines/pipelines/static<br/>      - ./media:/pipelines/pipelines/media<br/>    depends_on:<br/>      - pipelines_mysql<br/>    tty: true<br/>    env_file:<br/>      - .env<br/><br/>  pipelines_mysql:<br/>    image: mysql/mysql-server:8.0.23<br/>    command: --default-authentication-plugin=mysql_native_password<br/>    volumes:<br/>      - mysql_data:/var/lib/mysql<br/>    ports:<br/>      - '3306:3306'<br/>    restart: always<br/>    environment:<br/>      MYSQL_ROOT_PASSWORD: pipelines<br/>      MYSQL_DATABASE: pipelines<br/>      MYSQL_ROOT_HOST: '%'<br/><br/>  <em class="ms"># Use for testing local nginx / QA site<br/>  </em>pipelines_nginx:<br/>    build: ./docker/containers/nginx<br/>    volumes:<br/>      - static_volume:/Users/Documents/projects/pipelines/static/<br/>    ports:<br/>      - 4001:80<br/>    depends_on:<br/>      - pipelines_mysql<br/>      - pipelines_django<br/><br/>volumes:<br/>  mysql_data:<br/>  static_volume:<br/><br/>networks:<br/>  default:<br/>    external:<br/>      name: pipelines_network</span></pre></div><div class="ab cl ln lo hx lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="im in io ip iq"><p id="626e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在新的repo中设置CI/CD设置。</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mt"><img src="../Images/99f64ccf1dfa8dcf039e79dd46153279.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J6tqzz4iNHlphnrUUDDUpA.png"/></div></div></figure><p id="252c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">启用跑步者下的共享跑步者。</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mu"><img src="../Images/e743fa70a7af469de3e00ea16ca5c3fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I1e4DsEv-kPB4Vsk70Mqbg.png"/></div></div></figure><p id="35ef" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在变量下，我创建了以下内容。您希望在您的应用程序`. gitlab-ci.yml `的GitLab模板文件中添加您将使用的那些</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mv"><img src="../Images/1650f9518cbe93dfa59aea4d5eda9a23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uYcUP3yyMo0R13IrZXNUtQ.png"/></div></div></figure><p id="6655" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">解释的变量</p><p id="632e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">ALLOWED_HOSTS:用于Django</p><p id="091d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">AWS_ACCESS_KEY_ID:我为管道部署创建了专用密钥</p><p id="e2c4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">AWS_ACCOUNT_ID:您的AWS帐户ID</p><p id="ab1c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">AWS_REGION:您将部署的区域</p><p id="2fa5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">AWS_SECRET_ACCESS_KEY:当你创建新的访问密钥时，你也会得到这个</p><p id="7d37" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">环境:用于应用程序</p><p id="f0fa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">SECRET_KEY:用于应用</p><p id="1d2c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这些变量将被传递到容器中，这样应用程序就可以在管道部署期间访问它们</p><p id="c2a7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"># .gitlab-ci.yml</p><pre class="lw lx ly lz gt mf me mg mh aw mi bi"><span id="5570" class="mj mk it me b gy ml mm l mn mo">image: python:latest<br/><br/>services:<br/>  - name: docker:dind<br/>    entrypoint: ["env", "-u", "DOCKER_HOST"]<br/>    command: ["dockerd-entrypoint.sh"]<br/><br/>stages:<br/>  - compile<br/>  - build<br/>  - test<br/><br/>variables:<br/>  DOCKER_HOST: tcp://docker:2375<br/>  DOCKER_DRIVER: overlay2<br/>  DOCKER_TLS_CERTDIR: ""<br/>  MOUNT_POINT: /builds/$CI_PROJECT_PATH/mnt<br/>  REPOSITORY_URL: $AWS_ACCOUNT_ID.dkr.ecr.eu-west-2.amazonaws.com/pipelines-django<br/>  TASK_DEFINITION_NAME: pipelines_4000<br/>  CLUSTER_NAME: QA-2<br/>  SERVICE_NAME: pipelines<br/>  ARTIFACT_REPORT_PATH: "app/reports/"<br/>  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"<br/><br/>cache:<br/>  paths:<br/>    - .cache/pip<br/>    - venv/<br/><br/>compile:<br/>  stage: compile<br/>  before_script:<br/>    - python -V  <em class="ms"># Print out python version for debugging<br/>#    - python -m venv venv<br/>#    - source venv/bin/activate<br/>    </em>- pip install -r dev-requirements.txt<br/>  script:<br/>    - python manage.py makemigrations<br/>  artifacts:<br/>    paths:<br/>      - "*/migrations/*.py"<br/>    expire_in: 1 day<br/>  only:<br/>    refs:<br/>      - merge_requests<br/>    variables:<br/>      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"<br/><br/>build:<br/>  image:<br/>    name: docker/compose:1.25.4<br/>    entrypoint: [ "" ]<br/>  stage: build<br/>  before_script:<br/>    - export IMAGE=$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME<br/>    - export WEB_IMAGE=$IMAGE/qa_django<br/>  script:<br/>    - apk add --no-cache bash<br/>    - chmod +x ./setup_env.sh<br/>    - bash ./setup_env.sh<br/>    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY<br/>    - docker-compose -f docker-compose-ci.yml build<br/>    - docker tag pipelines_django:latest $WEB_IMAGE:latest<br/>    - docker images<br/>    - docker push $WEB_IMAGE:latest<br/>  only:<br/>    refs:<br/>      - merge_requests<br/>    variables:<br/>      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"<br/><br/>unittests:<br/>  stage: test<br/>  image: registry.gitlab.com/pipelines/pipelines/qa_django:latest<br/>  script:<br/>    - bash<br/>    - echo $SHELL<br/>    - pwd<br/>    - ls -al venv/bin/<br/>    - ls -al<br/>    - bash -c "python manage.py jenkins  wellbeing --enable-coverage --coverage-format=html"<br/>  only:<br/>    refs:<br/>      - merge_requests<br/>    variables:<br/>      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"</span></pre></div></div>    
</body>
</html>