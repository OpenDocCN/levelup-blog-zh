<html>
<head>
<title>Rate Limiting at Edge with Cloudflare Workers and Serverless Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Cloudflare Workers和无服务器Redis的边缘速率限制</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/rate-limiting-at-edge-with-cloudflare-workers-and-serverless-redis-74c0468a1873?source=collection_archive---------3-----------------------#2022-08-22">https://levelup.gitconnected.com/rate-limiting-at-edge-with-cloudflare-workers-and-serverless-redis-74c0468a1873?source=collection_archive---------3-----------------------#2022-08-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a1e4f45fe1079062547ab4e4a1468f29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6DEVn_qa23gRF4Lgm2uZww.jpeg"/></div></div></figure><p id="271c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本教程中，我们将展示如何使用Cloudflare Workers和Upstash Redis对您的应用程序进行速率限制。我们将使用<a class="ae kw" href="https://github.com/upstash/ratelimit" rel="noopener ugc nofollow" target="_blank">速率限制SDK </a>，它将数据保存在Upstash Redis中。</p><h1 id="b156" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Redis设置</h1><p id="d4ba" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">使用<a class="ae kw" href="https://console.upstash.com" rel="noopener ugc nofollow" target="_blank"> Upstash控制台</a>或<a class="ae kw" href="https://github.com/upstash/cli" rel="noopener ugc nofollow" target="_blank"> Upstash CLI </a>创建一个或多个Redis数据库。不要选择全局，而是在不同的区域创建多个数据库，在那里你的站点会有流量。(为什么？我们将稍后解释)在接下来的步骤中，您将需要REST URL和令牌。</p><h1 id="3685" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">项目设置</h1><p id="be57" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们将使用牧马人2进行部署，因此安装(或升级)<a class="ae kw" href="https://developers.cloudflare.com/workers/wrangler/" rel="noopener ugc nofollow" target="_blank">牧马人2 </a>。</p><p id="d2ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为您的项目创建一个文件夹并运行<code class="fe ma mb mc md b">wrangler init</code>。选择<code class="fe ma mb mc md b">ts</code>:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="5be3" class="mm ky iq md b gy mn mo l mp mq">⛅️ wrangler 2.0.7 (update available 2.0.26) ------------------------------------------------------ Using npm as package manager. <br/>✨ Created wrangler.toml No package.json found.<br/> Would you like to create one? (y/n) <br/>✨ Created package.json Would you like to use TypeScript? (y/n) <br/>✨ Created tsconfig.json Would you like to create a Worker at src/index.ts? (y/n) <br/>✨ Created src/index.ts</span></pre><h1 id="d0e6" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">代码</h1><p id="f17c" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">更新工人功能如下:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="52e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">替换上面Redis实例的REST_URL和标记。您可以根据您的流量在不同的区域添加更多的Redis数据库(或设置一个)。</p><h1 id="dcfb" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">测试和部署</h1><p id="5b05" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">您可以使用<code class="fe ma mb mc md b">wrangler dev</code>在本地测试该功能。</p><p id="f817" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用<code class="fe ma mb mc md b">wrangler publish</code>将您的功能部署到Cloudflare</p><p id="fbb0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">函数的端点将被打印出来。例如<a class="ae kw" href="https://cloudflare-workers-rate-limiting.upsdev.workers.dev/" rel="noopener ugc nofollow" target="_blank">https://cloud flare-workers-rate-limiting . upsdev . workers . dev/</a>当你连续刷新页面5次，应该会看到你是速率受限的。</p><p id="05f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好了，教程结束了(很容易吧？)，现在让我们进入一些细节。</p><h1 id="d6a1" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">对每个请求进行远程调用的成本不是很高吗？</h1><p id="8532" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如果我们不使用短暂的缓存，它可能是。<a class="ae kw" href="https://github.com/upstash/ratelimit#ephemeral-cache" rel="noopener ugc nofollow" target="_blank">临时缓存</a>是在处理程序之外定义的map对象。当无服务器功能激活(热)时，速率限制SDK使用它来缓存标识符。在处理程序之外定义它很重要，因此它将是一个全局变量。Cloudflare Workers不保证不同的调用会使用同一个变量，但在流量高峰时缓存它还是很有帮助的。</p><h1 id="c997" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">为什么不是全球数据库？</h1><p id="1f56" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Upstash Global databases将Redis数据复制到多个地区。它非常适合许多边缘使用案例。但是对于速率限制，我们不需要将一个区域中的数据复制到所有其他区域。速率限制会话具有本地作用域。我们仍然可以使用一个全球数据库，但这将是不必要的成本，因为每次更新都将被复制到世界各地。这就是为什么我们选择创建多个区域性数据库，正如限速SDK推荐的那样。</p><h1 id="76c2" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">IP作为标识符</h1><p id="01dd" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们已经使用用户的IP作为速率限制功能的标识符。这意味着我们限制单个用户的速率。如果您的请求中有更好的标识符(用户名、电子邮件等)，请使用它。如果您想限制总流量，可以设置一个常量字符串。或者您可以使用地区或国家(<a class="ae kw" href="https://developers.cloudflare.com/workers/examples/country-code-redirect/" rel="noopener ugc nofollow" target="_blank"> request.cf.country </a>)作为标识符来限制每个地理区域的流量。</p><h1 id="380e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">我可以使用自托管Redis吗？</h1><p id="72ea" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Cloudflare Workers在V8隔离上运行，不允许TCP连接。所以你不能访问自托管的Redis、Redislabs或Elasticache，除非你使用REST代理。upshredis有一个内置的REST API。</p><h1 id="652e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">整合到您现有的网站</h1><p id="aef6" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">您可以对现有的web应用程序/网站进行分级限制，而无需触及它们的代码。您只需要在Cloudflare中创建一个站点，并相应地为您的域设置名称服务器。因此，Cloudflare将能够拦截对您网站的请求，并运行Workers功能。另外，取消对XX行的注释，如果请求没有速率限制，那么Workers函数会将请求转发到您的网站。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="1f22" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="na">原载于2022年8月22日</em><a class="ae kw" href="https://dev.to/noahfschr/rate-limiting-at-edge-with-cloudflare-workers-and-serverless-redis-4opd" rel="noopener ugc nofollow" target="_blank"><em class="na">https://dev . to</em></a><em class="na">。</em></p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="9ada" class="kx ky iq bd kz la nb lc ld le nc lg lh li nd lk ll lm ne lo lp lq nf ls lt lu bi translated">分级编码</h1><p id="814a" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="15bd" class="ng nh iq ka b kb kc kf kg kj ni kn nj kr nk kv nl nm nn no bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="f12b" class="ng nh iq ka b kb np kf nq kj nr kn ns kr nt kv nl nm nn no bi translated">📰查看<a class="ae kw" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="69fb" class="ng nh iq ka b kb np kf nq kj nr kn ns kr nt kv nl nm nn no bi translated">🔔关注我们:<a class="ae kw" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae kw" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae kw" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="c29a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">🚀👉<a class="ae kw" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>