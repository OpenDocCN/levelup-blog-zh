<html>
<head>
<title>Azure to AWS VPN: Step-by-step</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure到AWS VPN:循序渐进</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/azure-to-aws-vpn-step-by-step-b8c853a62?source=collection_archive---------1-----------------------#2020-05-28">https://levelup.gitconnected.com/azure-to-aws-vpn-step-by-step-b8c853a62?source=collection_archive---------1-----------------------#2020-05-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/7ffca2603520a7e3696570e24b8ef287.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BTgU5s8gHI_2I1dfcCVW_Q.png"/></div></div></figure><div class=""/><p id="dcec" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我在AWS有资源，我在Azure有资源。我如何让他们安全地、秘密地相互通信？</p><p id="0287" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是这一步一步的重点。更具体地说，我们将在AWS虚拟私有云(VPC)和Azure的对等虚拟网络(VNet)之间创建一个站点到站点的VPN。我们将通过展示AWS中的EC2实例可以通过其私有IP地址RDP到Azure中的虚拟机(VM ),反之亦然，来测试这一点是否成功。</p><p id="c007" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Azure中，我们将在云外壳中使用PowerShell来设置资源，对于AWS，我将使用控制台。我们将介绍以下步骤:</p><ol class=""><li id="c93b" class="kw kx jb ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">从头开始在Azure中创建基础架构</li><li id="a2eb" class="kw kx jb ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">为默认AWS VPC创建VPN组件。</li><li id="4930" class="kw kx jb ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">在Azure中创建VPN组件</li></ol><p id="de45" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从Azure上的新鲜环境开始。您需要以下内容:</p><p id="36d8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">一个资源组</strong>。Azure迫使你将组件逻辑地组合在一起。例如，你可能有一个应用程序A的组件资源组，另一个应用程序b的组件资源组。从AWS来看，这本质上感觉像是强制标记，我很喜欢它，因为它保持了整洁。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="e090" class="lt lu jb lp b gy lv lw l lx ly">New-AzResourceGroup -Name TestRG1 -Location UKSouth</span></pre><p id="2e98" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这在UKSouth位置创建了一个名为TestRG1的资源组。你会经常引用testrg 1——几乎你在Azure中构建的所有东西都需要分配给一个资源组。</p><p id="11d2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">一个虚拟的网络。</strong>在AWS中，这被称为VPC。确保它与您的AWS环境有不同的地址空间。我们还必须包括VNet将存在于哪个资源组中的参数、它的位置、它的名称和它的地址空间。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="b839" class="lt lu jb lp b gy lv lw l lx ly">$virtualNetwork = New-AzVirtualNetwork `<br/>-ResourceGroupName TestRG1 `<br/>-Location UKSouth `<br/>-Name VNet1 `<br/>-AddressPrefix 11.1.0.0/16</span></pre><p id="8a6c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在PowerShell中，您可以用$符号设置变量。我们告诉PowerShell我们想要设置一个名为$virtualNetwork的变量，然后我们给出关于这个变量是什么的指令。通常当你按回车键时，PowerShell会运行你的代码——通过在行尾输入`，PowerShell会允许你转到下一行。你可以不用`而把所有的东西都写在一行上，但是分开写通常会更清楚。</p><p id="3b80" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">你的虚拟机所在的子网。</strong></p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="ed72" class="lt lu jb lp b gy lv lw l lx ly">$subnetConfig = Add-AzVirtualNetworkSubnetConfig `<br/>-Name WebSub `<br/>-AddressPrefix 11.1.0.0/24 `<br/>-VirtualNetwork $virtualNetwork</span></pre><p id="20d5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大部分应该是不言自明的。注意我们是如何调用之前设置的变量来告诉Azure将子网放在哪个VNet中的。</p><p id="482d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">用您的新子网配置更新您的虚拟网络！</strong></p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="4698" class="lt lu jb lp b gy lv lw l lx ly">$virtualNetwork | Set-AzVirtualNetwork</span></pre><p id="367d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">起初，我没有意识到这一点的重要性——您需要在设置任何新的子网配置后运行它，以便用这些新设置更新VNet。</p><p id="c136" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">添加网关子网</strong></p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="59d8" class="lt lu jb lp b gy lv lw l lx ly">$vnet = Get-AzVirtualNetwork -ResourceGroupName TestRG1 -Name VNet1</span><span id="29e5" class="lt lu jb lp b gy lz lw l lx ly">Add-AzVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -AddressPrefix 11.1.255.0/27 -VirtualNetwork $vnet</span><span id="f6d3" class="lt lu jb lp b gy lz lw l lx ly">$vnet | Set-AzVirtualNetwork</span></pre><p id="6767" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Azure中，本地网络网关和虚拟网络网关<em class="ma">必须</em>放在名为GatewaySubnet的子网中才能工作。请注意，我们再次使用Set-AzVirtualNetwork命令来应用这些更改。</p><p id="e952" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">在我们继续之前，</strong>我想暂停一下，解释下一个重要的组件及其作用。在AWS和Azure中，你都需要设置两个设备。在Azure中我们有:<br/> -本地网络网关:这是你告诉Azure关于你想要连接的AWS VPN设备的细节的地方。<br/> -虚拟网络网关:这是你的Azure VPN设备。</p><p id="c6aa" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在AWS中，我们有:<br/> -客户网关:这是你告诉AWS关于你想要连接的Azure VPN设备的细节的地方。<br/> -虚拟专用网关:这是你的AWS VPN设备。</p><p id="038e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">希望您可以看到，通过这种设置，每个环境都有一个组件，即VPN设备，还有一个组件知道其他环境的详细信息，以便能够连接。现在，我们将在Azure中提供一个虚拟网络网关，将其放在GatewaySubnet中，并给它一个公共IP地址。<strong class="ka jc">注意:</strong>配置VNet网关可能需要45分钟！</p><p id="5a26" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">请求公共IP地址</strong></p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="0e4e" class="lt lu jb lp b gy lv lw l lx ly">$gwpip= New-AzPublicIpAddress -Name VNet1GWIP -ResourceGroupName TestRG1 -Location 'UKSouth' -AllocationMethod Dynamic</span></pre><p id="d7fd" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是将与您的Azure VPN设备(VPN网关)关联的公共IP地址。在AWS中创建您的客户网关时，您将引用这个IP地址。</p><p id="53c4" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">创建您的网关IP地址配置</strong></p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="d908" class="lt lu jb lp b gy lv lw l lx ly">$vnet = Get-AzVirtualNetwork -Name VNet1 -ResourceGroupName TestRG1</span><span id="9dc1" class="lt lu jb lp b gy lz lw l lx ly">$subnet = Get-AzVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -VirtualNetwork $vnet</span><span id="e683" class="lt lu jb lp b gy lz lw l lx ly">$gwipconfig = New-AzVirtualNetworkGatewayIpConfig -Name gwipconfig1 -SubnetId $subnet.Id -PublicIpAddressId $gwpip.Id</span></pre><p id="3e36" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我想这里需要一点解释。我们正在设置变量，准备运行下一个命令，这将创建虚拟网络网关。看看下一个命令，您将看到我们刚刚设置的变量是如何插入New-AzVirtualNetworkGateway命令的参数中的。</p><p id="bb33" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">创建虚拟网络网关</strong></p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="2663" class="lt lu jb lp b gy lv lw l lx ly">New-AzVirtualNetworkGateway -Name VNet1GW -ResourceGroupName TestRG1 `<br/>-Location 'UKSouth' -IpConfigurations $gwipconfig -GatewayType Vpn `<br/>-VpnType RouteBased -GatewaySku VpnGw1</span></pre><p id="3e06" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们终于创建了我们的虚拟网络网关。对于这个例子，我们做了一些决定，你可能不一定总是会做。例如，我们的VpnType是基于路由的。我们本可以选择基于策略，而不是— <a class="ae mb" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-connect-multiple-policybased-rm-ps" rel="noopener ugc nofollow" target="_blank">参见此处的</a>了解差异的解释。我们还选择了特定的网关Sku。关于GatewaySkus及其属性的列表，<a class="ae mb" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways" rel="noopener ugc nofollow" target="_blank">参见此处</a>。我们需要注意的重要一点是，我们必须选择一个支持我们的VPN隧道类型的SKU，即IKEv2。</p><p id="3fde" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将需要45分钟来调配资源。完成后，您可以通过运行以下命令来查看详细信息:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="3916" class="lt lu jb lp b gy lv lw l lx ly">Get-AzVirtualNetworkGateway -Name Vnet1GW -ResourceGroup TestRG1</span></pre><p id="a19f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在进行资源调配时，让我们转到AWS进行设置。我们将使用一个默认的VPC，这样你就很容易跟上。</p><ol class=""><li id="19f4" class="kw kx jb ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">在网络和内容交付下，选择VPC。在左侧面板中，选择客户网关→创建客户网关。在这里，我们将详细介绍我们的Azure虚拟网络网关。命名它，选择静态路由并输入你分配给Azure虚拟网络网关的IP地址，点击创建。</li><li id="b58e" class="kw kx jb ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">在左侧面板中，选择虚拟专用网关→创建虚拟专用网关。命名它，点击创建。与Azure不同，你不需要手动分配IP地址。创建完成后，右键单击它并将其附加到您的VPC。</li><li id="c2bd" class="kw kx jb ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">再次选择左侧面板，选择站点到站点VPN连接→创建VPN连接:<br/>名称:我调用了mine AWS-to-Azure <br/>目标网关类型:虚拟专用网关(然后选择您刚刚制作的)<br/>客户网关:选择现有的，然后选择您之前制作的<br/>路由选项:静态，然后输入您的Azure VNet的IP地址范围—整个VNet，<strong class="ka jc">而不是</strong>Gateway subnet的IP地址范围。</li><li id="e3bf" class="kw kx jb ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">下载通用设备的配置。在配置文件中，找到预共享密钥值和“外部IP地址:虚拟专用网关”值。您将把这些输入到您将创建的最后一个资源中，即Azure中的本地网络网关。</li></ol><p id="7898" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们暂时结束了AWS。快速返回Azure:</p><ul class=""><li id="e2ce" class="kw kx jb ka b kb kc kf kg kj ky kn kz kr la kv mc lc ld le bi translated"><strong class="ka jc">创建本地网络网关</strong></li></ul><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="1587" class="lt lu jb lp b gy lv lw l lx ly">New-AzLocalNetworkGateway -Name Site1 -ResourceGroupName TestRG1 `<br/>-Location 'UKSouth' -GatewayIpAddress '__________' -AddressPrefix '__________'</span></pre><p id="34c2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">GatewayIpAddress需要是您下载的AWS配置文档中的值“外部IP地址:虚拟专用网关”。</p><p id="9bf5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AddressPrefix必须是AWS VPC的地址范围。</p><ul class=""><li id="517a" class="kw kx jb ka b kb kc kf kg kj ky kn kz kr la kv mc lc ld le bi translated"><strong class="ka jc">创建VPN连接</strong></li></ul><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="0f0a" class="lt lu jb lp b gy lv lw l lx ly">$gateway1 = Get-AzVirtualNetworkGateway -Name VNet1GW -ResourceGroupName TestRG1</span><span id="b018" class="lt lu jb lp b gy lz lw l lx ly">$local = Get-AzLocalNetworkGateway -Name Site1 -ResourceGroupName TestRG1</span></pre><p id="bc1c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们已经设置了变量，现在开始创建！</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="79f5" class="lt lu jb lp b gy lv lw l lx ly">New-AzVirtualNetworkGatewayConnection -Name Azure-to-AWS -ResourceGroupName TestRG1 `<br/>-Location 'UKSouth' -VirtualNetworkGateway1 $gateway1 -LocalNetworkGateway2 $local `<br/>-ConnectionType IPsec -RoutingWeight 10 -SharedKey '_____'`<br/>-ConnectionProtocol IKEv2</span></pre><p id="f50f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用下载的AWS S2S连接配置文件中的预共享密钥值替换SharedKey。不要担心我们已经设置了IKEv2，AWS文档提到了ike v1——这似乎只是AWS的一个疏忽。</p><p id="152b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一切都在Azure中完成了，现在我们将在AWS中完成最后一块拼图:</p><ul class=""><li id="a2f1" class="kw kx jb ka b kb kc kf kg kj ky kn kz kr la kv mc lc ld le bi translated"><strong class="ka jc">启用路由传播</strong></li></ul><p id="276e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到您打算用于连接的路由表(如果您使用默认VPC，您只有一个)。突出显示路由表，单击路由传播→编辑路由传播，然后传播虚拟专用网关路由。</p><p id="ae6e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">证明它有效</strong></p><p id="66e3" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的站点到站点VPN连接现在应该在Azure中显示为“已连接”,在AWS中显示为“可用”!为了快速测试，您可以在Azure中创建一个VM，在AWS中创建一个EC2实例，并尝试从一个实例到另一个实例进行RDP。为了完成这项工作，您必须确保在AWS中，您在分配给EC2实例的安全组中创建了一个规则，允许流量进入Azure地址范围</p><p id="cd4b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Azure中，你给你的虚拟机所在的子网分配一个网络安全组，允许流量进入AWS VPC地址范围。</p><p id="b415" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">证明你的VPN正在工作的证据是，你将能够通过每台服务器的<em class="ma">私有</em> IP地址进行RDP。对于生产，请确保为高可用性提供第二个VPN隧道。现在，尽情享受您的互联云吧。</p></div></div>    
</body>
</html>