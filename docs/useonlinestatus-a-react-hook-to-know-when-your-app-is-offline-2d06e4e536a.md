# useOnlineStatus——一个 React 钩子，知道你的应用程序何时离线

> 原文：<https://levelup.gitconnected.com/useonlinestatus-a-react-hook-to-know-when-your-app-is-offline-2d06e4e536a>

![](img/4ca749d813962ee405385a20a9833f24.png)

我最近在做一个客户的渐进式网络应用(PWA)项目，偶然发现了一个有趣的问题。我需要一种可重复使用的方法来知道应用程序是在线还是离线。该票有以下要求:

*   我们需要能够直观地显示应用程序是在线还是离线
*   我们需要处理设备可能连接到网络，但互联网连接很弱或不存在的情况。

如果你准备接受挑战，在阅读本文的其余部分之前，请随意尝试自己做这件事。

请注意，所有代码示例都在 Typescript 中，但是在删除类型后，在 Javascript 中应该是一样的。

因为我们需要在应用程序的多个部分使用这种状态，所以我认为钩子是解决这个问题的好方法，同时还可以重用。如果你不熟悉 react 中的钩子，官方文档是一个很好的起点([https://reactjs.org/docs/hooks-intro.html](https://reactjs.org/docs/hooks-intro.html))。这个定制钩子有多种用途，作为用户的状态指示器，让用户知道是否应该进行 API 调用或者何时在应用程序中缓存信息。

我们可以通过使用大多数浏览器([导航器)中的`window`上的`navigator.onLine`属性轻松解决第一个问题。在线文档](https://developer.mozilla.org/en-US/docs/Web/API/NavigatorOnLine/onLine))。它几乎可以在所有浏览器中广泛使用。我们从一个简单的钩子开始，看起来像这样。

钩子使用 React context 使值在应用程序中可访问，并且在每次导入钩子时不会重复。你会看到我们从文件中导出了两个东西，一个`OnlineStatusProvider`和一个`useOnlineStatus`钩子。

我们需要确保用我们的`OnlineStatusProvider`包装将要使用我们的钩子的组件，以便我们的`OnlineStatusContext`在所有子组件中都可用。如果我们要在应用程序的多个地方使用这个状态，我们可以把它放在我们的`App.tsx`文件中，如下所示:

然后我们可以像这样在我们的`Home`组件中使用`useOnlineStatus`。

很好，现在我们有了一个钩子，它会告诉我们应用程序是否有网络连接。在很多应用程序中，这应该足够了，但是有些情况下我们需要更复杂的东西。我们只解决了第一个要求，这是因为:

1.  浏览器会告诉您您的设备是否连接到任何网络，而不是专门连接到互联网。这意味着，如果您的互联网连接断开，但网络保持连接，应用程序将仍然认为它是在线的。
2.  移动设备通常会有一个问题，即它们连接网络的时间太长，这可能会导致网络看起来处于连接状态。但我相信我们都经历过连接的速度或可靠性使其无法使用。

如果你的应用可以解决上面的问题，你可以就此打住。但是，通过尝试定期接触网络，解决这些问题是相当容易的。

我们可以向我们的应用程序添加一个非常小的文件`ping.txt`,我们可以在我们的应用程序中随时获取它，以确定我们是否有网络连接。该文件甚至可以是空的。然后，我们可以将获取请求设置为在一定时间后超时，以确保我们能够处理超慢的网络。

修改后，我们的钩子看起来像这样:

你可以看到我们做了几件事:

1.  我们添加了一个`checkOnlineStatus`函数，我们可以调用它来检查我们的资源是否可以在网络上被访问。
2.  我们每隔 10000 毫秒(10 秒)调用这个`checkOnlineStatus`函数来检查我们是否能获得这个资源。如果获取失败或耗时超过 3 秒，我们将中止请求并更新在线值。
3.  我们删除了网络联机时的事件侦听器，这是因为我们希望在再次连接时确保互联网连接，而不仅仅是网络连接。

您可以根据自己的需要调整这些时间和值，只需更改文件顶部的常量即可。

至此，我们已经满足了所有最初的需求。

1.  我们有一个钩子可以告诉我们应用程序是离线还是在线。
2.  我们还解决了连接速度慢或无法连接到互联网的问题。
3.  钩子应该在状态改变时快速更新值，并触发我们的应用程序进行更新。

如果你喜欢这篇文章，请随时给我一个👏，在 Medium 上关注我，或者与他人分享这篇文章。

大家好，我是 Patrick，我指导开发人员如何为不断变化的世界构建现代 Web 应用程序。欢迎在 [LinkedIn](https://www.linkedin.com/in/patrick-czeczko/) 或 [Medium](https://patrickcze.medium.com/) 上关注我，了解更多内容。