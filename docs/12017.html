<html>
<head>
<title>SSH Agent Explained</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SSH代理解释道</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/ssh-agent-explained-cf947034e63d?source=collection_archive---------5-----------------------#2022-05-08">https://levelup.gitconnected.com/ssh-agent-explained-cf947034e63d?source=collection_archive---------5-----------------------#2022-05-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="23d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解释SSH、SSH代理和ProxyJump的简单指南。</p><h1 id="7905" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">介绍</h1><p id="e259" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">SSH(安全外壳)广泛用于安全地连接到远程服务器。保护连接最常见的方法是使用密码。这种方法的缺陷是，有时密码是可预测的，而且很脆弱，因此很容易被猜到。另一个缺点是对密码复杂性的限制。尽管密码在通过网络传输时是加密的，但与其他身份验证方法相比，使用自动化脚本的暴力破解技术可以轻松地解密正常长度的密码。幸运的是，SSH提供了一种更好的安全认证方法。SSH代理消除了通过密码进行的身份验证。在这篇文章中，我们将看看SSH代理是如何工作的，它的安全风险是什么，以及如何减轻它们。</p><h1 id="3cee" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">背景</h1><h2 id="257a" class="lo km iq bd kn lp lq dn kr lr ls dp kv jy lt lu kz kc lv lw ld kg lx ly lh lz bi translated">通过SSH连接</h2><p id="98ae" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">当您第一次连接到远程服务器时，会出现一个提示，要求您确认远程服务器的真实性。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="fc5a" class="lo km iq mf b gy mj mk l ml mm">$ ssh [-p] user@hostname-or-ip.com</span></pre><p id="de43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其中–p是服务器的端口号，是可选的。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/d76b65dcea189d573b8796de9a25fc82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tz8tjfxyxX9Kk0HVzAG5hg.png"/></div></div></figure><p id="6732" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果输入yes，服务器的公钥被添加到一个名为<em class="mv"/><strong class="jp ir"><em class="mv">已知主机</em></strong><em class="mv"/>的文件中。这意味着您的计算机认为该服务器是可信的。因此，下次您尝试建立到同一台服务器的连接时，将不会提示您再次证明其真实性。这种机制被称为<strong class="jp ir">豆腐</strong>(<strong class="jp ir">T</strong>rust<strong class="jp ir">O</strong>n<strong class="jp ir">F</strong>first<strong class="jp ir">U</strong>se)，客户端使用它来建立到<strong class="jp ir"> <em class="mv">尚未信任的</em> </strong>服务器的连接。当客户端第一次成功建立连接时，该服务器的标识存储在客户端的本地信任数据库中。</p><p id="a7bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，输入服务器的密码。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/1be027c0d0234e58b6f726c517b31571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zkaQCGl5PjcMggW_AH5uNA.png"/></div></div></figure><p id="1518" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样，您就成功地连接到了远程服务器。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/b51fc47344b312467597035c6ef49965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TQGkPr1mpFLowGMe4p-dJQ.png"/></div></div></figure><p id="e18f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">指纹</strong>是必要的，因为它们是您连接的服务器的身份。现在，假设网络之外的某个人拦截了您的SSH连接，并将其路由到一个不同的IP地址，您会立即知道该活动，因为您必须对该IP进行身份验证。让我们看几个场景。</p><p id="7652" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">场景1 </strong>:你尝试使用“<strong class="jp ir"> ssh piyush@127.0.0.1 </strong>”建立到一个已经过认证的服务器的连接。一个未知的攻击者控制了连接，并更改了提供给ssh的IP地址。假设IP是127.1.2.3，有效地将您的指令更改为“<strong class="jp ir"> ssh piyush@127.1.2.3 </strong>”。因为您没有预料到攻击，所以您认为您的机器不会要求服务器进行身份验证，因为它已经被信任了。相反，会再次要求您进行身份验证，但这次是针对攻击者的服务器。这就是你知道有人在偷听的方法。</p><p id="eb00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">场景2 </strong>:当攻击者进入你的文件系统，改变你的可信服务器的指纹。当您尝试连接到该服务器时，ssh会抛出一个警告，指出“<strong class="jp ir">远程主机标识已经更改</strong>”。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/1f4e5ce940d321d0a9ce3ffa92d8fe45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LQ1r3FrAt-s_8aNM6TaTxw.png"/></div></div></figure><p id="673e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">场景1假设使用豆腐建立的服务器身份验证是真实的，并且客户机完全信任服务器提供的标识。但是您如何知道所提供的服务器标识是合法的呢？这就是豆腐失败的地方，不利于安全。</p><p id="ff41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">场景3 </strong>:你第一次尝试在客户端和服务器之间建立连接。如果客户端的连接被暴露，攻击者可以渗透它，然后将它重新路由到不同的机器。该机器仍然通过提供其公钥来响应，客户端计算机要求用户验证该公钥。但是用户并不总是做出正确的决定。豆腐假设攻击者在初始连接期间不存在，正如我们已经看到的，这可能是危险的。</p><h2 id="44df" class="lo km iq bd kn lp lq dn kr lr ls dp kv jy lt lu kz kc lv lw ld kg lx ly lh lz bi translated">SSH和密钥</h2><p id="ea2b" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">SSH本身是安全的，但是如果您的密码被泄露或者很容易被猜到，那么您很容易受到来自外部的攻击。因此，一个可能的解决方案是根本不使用密码，而是使用密钥。</p><p id="5657" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">密钥是连接到服务器的安全方式，并且总是成对生成。密钥对由一个公钥和一个私钥组成。密钥对在数学上是联系在一起的，这意味着使用公钥加密的数据只能由拥有相应私钥的人解密。公钥存储在远程服务器上，而私钥存储在客户端上。因此，当您需要连接到服务器时，只需使用您的私钥进行身份验证，您就会自动登录。但是在幕后，这个过程可能是这样的:</p><ol class=""><li id="a7e6" class="mw mx iq jp b jq jr ju jv jy my kc mz kg na kk nb nc nd ne bi translated">客户端将密钥对ID发送给服务器。</li><li id="65c8" class="mw mx iq jp b jq nf ju ng jy nh kc ni kg nj kk nb nc nd ne bi translated">服务器检查其信任数据库(<em class="mv"> authorized_key文件</em>)以找到与给定ID匹配的公钥。</li><li id="e243" class="mw mx iq jp b jq nf ju ng jy nh kc ni kg nj kk nb nc nd ne bi translated">一旦找到成功的匹配，服务器就生成一个唯一的随机挑战(类似于一个随机数)，使用它的公钥对它进行加密，并将其发送回客户端。</li><li id="6988" class="mw mx iq jp b jq nf ju ng jy nh kc ni kg nj kk nb nc nd ne bi translated">如果客户端拥有相应的私钥，它将能够解密该质询。</li><li id="ec59" class="mw mx iq jp b jq nf ju ng jy nh kc ni kg nj kk nb nc nd ne bi translated">另一个称为会话密钥的密钥由客户端和服务器共享，用于加密通信。</li><li id="356c" class="mw mx iq jp b jq nf ju ng jy nh kc ni kg nj kk nb nc nd ne bi translated">客户端将解密的质询与会话密钥相结合以生成一个值。该值被散列并作为加密质询的答案发送回服务器。</li><li id="0a2f" class="mw mx iq jp b jq nf ju ng jy nh kc ni kg nj kk nb nc nd ne bi translated">服务器对通过组合会话密钥和原始解密质询生成的值进行哈希运算。如果两个哈希匹配，则证明客户端拥有相应的私钥，因此客户端通过了身份验证。</li></ol><p id="6c73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要生成一对密钥，使用<strong class="jp ir"> ssh-keygen </strong>。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="daa1" class="lo km iq mf b gy mj mk l ml mm">$ ssh-keygen</span></pre><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nk"><img src="../Images/ace99f6289cfe15c61341cad4e8ab067.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2KRkwWLNKqiZjJd9fghU1w.png"/></div></div></figure><p id="2766" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">随即，系统会提示您输入位置和密钥的<strong class="jp ir"> <em class="mv">密码</em> </strong>。如果不指定位置，将使用默认位置。在上面的例子中，默认位置是Users/user/。ssh/并且文件以<strong class="jp ir"> <em class="mv"> id_rsa </em> </strong>的名称保存。对于本例，您可以将密码保持为空。</p><p id="d58e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">密码短语</strong>存储在本地，用于加密静态私钥。你可能认为它违背了没有密码的目的，但它是一个额外的安全层。它只验证您的密钥，而不像密码那样验证服务器。因此，即使您的公钥被泄露，也无法使用，因为密码短语只有您知道。</p><p id="9e09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正在调查<strong class="jp ir"> ~/。ssh </strong>目录我们可以用<strong class="jp ir">找到我们的公钥。pub </strong>扩展名(<em class="mv"> id_rsa.pub </em>)和不带扩展名的私钥(<em class="mv"> id_rsa </em>)。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/feab597f2ffb15260977b84453804f54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bHhy0mDxO1TsmIWHYH5PEA.png"/></div></div></figure><p id="93cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要使用您的私钥访问您的服务器，您需要首先使用<strong class="jp ir"> <em class="mv"> ssh-copy-id </em> </strong>将公钥放在您的服务器上。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="d791" class="lo km iq mf b gy mj mk l ml mm">$   ssh-copy-id [-p] -i ~/.ssh/id_rsa.pub user@host.com</span></pre><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nk"><img src="../Images/6c0f9314ba10a65116fae7b0a417f230.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-GXELlZSw6-WHW0WnCHABg.png"/></div></div></figure><p id="98ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ssh-copy-id接收一个输入公钥文件(使用<strong class="jp ir">–I</strong>标志)并将其存储在远程服务器的/中。ssh文件夹中的<strong class="jp ir"> authorized_keys </strong>文件。在底部，您还可以看到添加的键的数量。</p><p id="d0f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">登录的话，用<strong class="jp ir"> ssh &lt;服务器IP &gt; </strong>就可以了。不会提示您进行任何身份验证，您可以直接登录。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nl"><img src="../Images/f8da42ceb47a5fd17b5a1d0e1bd158b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GxgEPt8cDQZfcfAN2GQK_A.png"/></div></div></figure><p id="8620" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，从客户机和服务器上删除旧的密钥，这次用一个密码创建一个新的密钥。另外，记得将公钥复制到远程服务器。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nl"><img src="../Images/730f1ec88d4b1e0ecfbec0cb523eb66f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LwpwbHsrUuzGRzXjc9jbzg.png"/></div></div></figure><p id="dec2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尝试使用新密钥连接到您的服务器。</p><p id="a33f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一次，您的服务器会要求您输入密码来验证您的密钥，然后才允许您访问服务器。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/e3e7cd30db0929e8716e9cf64a0d3010.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A0TIYLRWmlKRZaZqqIDEfg.png"/></div></div></figure><p id="d0aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尝试断开连接，然后重新连接到服务器。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/663b25c69ccdca16dd6fb3847b1271f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XtkO6wccQPYKeweWkgniJw.png"/></div></div></figure><p id="1c5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一次，它会再次要求您输入密码，即使您之前已经输入过。每次登录时都要输入密码，这很烦人，但幸运的是有一个解决方案。</p><h1 id="a705" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">SSH代理</h1><p id="1615" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">SSH代理管理SSH的密钥。使用SSH代理，密码缓存在内存中，因此您只需使用一次，对于后续的每个连接，您只需登录即可。</p><p id="84af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意</strong> : <em class="mv">如果你正在连接一个使用Linux GUI的服务器，</em><strong class="jp ir"><em class="mv">ssh-agent</em></strong><em class="mv">已经在运行了。如果您连接到一个堡垒服务器，您需要启动ssh-agent </em>。</p><p id="01ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<strong class="jp ir"> <em class="mv"> ssh-add </em> </strong>添加您的私钥。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="6574" class="lo km iq mf b gy mj mk l ml mm">$   ssh-add &lt;private-key&gt;</span></pre><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nl"><img src="../Images/810bef0ece7f49037693ef3243f624d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kfp1K6m7VBjMaOl3D4ixGQ.png"/></div></div></figure><p id="a8c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ssh-add是ssh-agent的网关。它的工作原理如下图所示:</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nm"><img src="../Images/97b3a1d9cdf7567e858bf80a7d1590d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IDtpLDviALeEUUoZbDt2Rw.png"/></div></div></figure><p id="9532" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您使用ssh-add添加加密的私钥时，系统会提示您输入密码。这个密码短语只需输入一次，然后ssh-add解密并将其发送给ssh-agent。</p><p id="3e81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了理解ssh-agent做什么，让我们看一下客户机和服务器之间的握手。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nn"><img src="../Images/02423747a2b6b6d72d13d364b3d17478.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*DAFYFofZH3MABxL6WkO6lg.png"/></div></div></figure><p id="4431" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.客户端尝试使用ssh连接。</p><p id="8e8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.然后，服务器生成一个唯一的随机挑战，并要求客户端使用私钥签名。</p><p id="59ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.然后，客户机将该责任转发给ssh-agent，ssh-agent对该质询进行签名，并将其转发给服务器。</p><p id="fb0d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.如果服务器信任客户机的公钥，只有在那时它才检查签名的真实性。</p><p id="94ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.如果检查成功，并且客户端提供的私钥实际上是可信的，则在客户端和服务器之间建立连接。</p><p id="ae32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong> <em class="mv">无论何时使用ssh建立连接，密钥都不会暴露，也不会通过网络发送。如上所述，ssh-agent代表私钥对服务器发送的消息/请求进行签名，对该密钥执行一些与密钥相关的操作，并将操作结果传递给服务器。</em></p><h2 id="a1b5" class="lo km iq bd kn lp lq dn kr lr ls dp kv jy lt lu kz kc lv lw ld kg lx ly lh lz bi translated">SSH代理转发</h2><p id="62d7" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">假设你通过ssh连接到一个<strong class="jp ir"> <em class="mv">堡垒主机</em> </strong>。现在，您想登录Github并克隆一个repo。但是要登录Github，您需要本地机器上的ssh密钥。那么，如何从你的bastion主机连接到Github服务器呢？</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/e8a219a795e4671988326bf8a42393bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nqiZ4fzJDMYWnnqCM_B_Zg.png"/></div></div></figure><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nm"><img src="../Images/52e755ea9d13a00c46da9d8de299c9cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RlpxkXU7Q8K8m1XlpzKdOw.png"/></div></div></figure><p id="e78e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如上所示，您可以将Github repo克隆到您的本地机器上，但是不能从bastion主机上克隆。</p><p id="7c7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个可能的解决方案是将您的私钥从本地机器复制到bastion主机，并从该主机登录Github。这种做法不安全，会使您的密钥容易被连接到这个bastion主机的任何人使用。</p><p id="f9c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SSH代理转发通过一个跳转服务器(也称为<strong class="jp ir"> <em class="mv">跳转框</em> </strong>或<strong class="jp ir"> <em class="mv">委托代理</em> </strong>)透明连接到你的远程服务器，解决了这个问题。这不需要从本地机器上复制密钥。在上面的例子中，bastion主机是跳转服务器，Github是远程服务器。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nm"><img src="../Images/6674056bbb7dd3893753643a64eeb989.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dgOhgkHDKeJbOQcv7lRZlA.png"/></div></div></figure><p id="fb62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要启用SSH代理转发，请在跳转服务器上运行以下命令。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="1dbd" class="lo km iq mf b gy mj mk l ml mm">$ ssh -A &lt;user@distant-server-ip -or-name&gt;</span></pre><p id="8ada" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">-</strong>标志打开第二个通道，将请求转发回本地机器。</p><p id="2ca8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们测试一下与Github的连接。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/ecce0b91d95ceed097f82ab36356c919.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_B2cNG0tMYQUfQ-LiNa60g.png"/></div></div></figure><p id="92bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然您能够成功连接，现在您可以将Github repo克隆到您的跳转服务器上。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/6c4301c91a43e8019619527d9d666be8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8YkHSPR8ouYBX7v7r0JNHw.png"/></div></div></figure><p id="f30f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong> <em class="mv">对于macOS用户，ssh-agent将密钥存储在macOS Keychain中。根据钥匙串设置，您可能需要在重新启动后解锁钥匙，并重新输入密码。通过将密码存储在钥匙串中，ssh-agent将在需要时自动使用它们。</em></p><h2 id="643c" class="lo km iq bd kn lp lq dn kr lr ls dp kv jy lt lu kz kc lv lw ld kg lx ly lh lz bi translated">SSH代理的漏洞</h2><p id="08b5" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">当您使用SSH代理转发时，会打开一个<strong class="jp ir"> <em class="mv">套接字</em> </strong>用于与远程主机通信，这是一个安全风险。让我们假设你通过一个跳转服务器连接到一个远程服务器。如果其他任何人以root权限连接到跳转服务器，他们可以通过套接字秘密地访问您的本地SSH代理，并可以在其他机器上伪装成您。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nm"><img src="../Images/44456571d8ee8ecb0a94b35e18a3df99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pWygndnde0yNc-B8G8lg_g.png"/></div></div></figure><h2 id="679d" class="lo km iq bd kn lp lq dn kr lr ls dp kv jy lt lu kz kc lv lw ld kg lx ly lh lz bi translated">风险缓解</h2><p id="24d8" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">要保护SSH代理转发，您可以使用以下技术:</p><p id="c011" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.<strong class="jp ir">密码</strong>:您可以使用<strong class="jp ir"> <em class="mv"> ssh-add-x </em> </strong>锁定您的ssh-agent。这用密码保护您的ssh-agent，因此，即使在同一个网络上，用户也需要密码才能登录到您的shell。您还可以使用ssh-add-X解锁您的ssh-agent。</p><p id="d0c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.<strong class="jp ir">生物特征</strong>:您可以使用一个名为“<strong class="jp ir"> <em class="mv"> Sekey </em> </strong>的备用ssh代理。不使用密码，您可以使用您的指纹登录ssh-agent。在macOS上，触控ID将用于登录。</p><p id="6d74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.<strong class="jp ir"> ProxyJump </strong>:除了使用SSH代理之外，您还可以使用另一种方法，通过使用ProxyJump的跳转服务器连接到远程服务器。</p><h1 id="1bd4" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">ProxyJump跳转</h1><p id="b24f" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">当您使用SSH代理时，它会自动打开一个新的套接字，用于跳转服务器和远程服务器之间的通信。ProxyJump不会打开新的套接字。相反，它通过一个跳转服务器将本地SSH客户机的标准输入和输出转发到远程服务器。可以把它想象成SSH会话中的SSH。ssh从不在跳转服务器上运行。取而代之的是，一个名为<strong class="jp ir"> <em class="mv"> sshd </em> </strong>的程序连接到一个远程服务器，并将该会话的控制权交还给本地SSH。由于套接字从来不是由跳转服务器创建的，因此连接不会被拦截，从而更加安全。</p><h2 id="b198" class="lo km iq bd kn lp lq dn kr lr ls dp kv jy lt lu kz kc lv lw ld kg lx ly lh lz bi translated">设置ProxyJump</h2><p id="01e2" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">要设置ProxyJump，您需要在~/中创建一个配置文件。ssh文件夹。如果您已经有了该文件，请确保不要覆盖它，而是在文件末尾添加以下指令。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="8e5e" class="lo km iq mf b gy mj mk l ml mm">Host   jump-server<br/>    HostName 127.0.0.1<br/>    User piyush<br/>    Port 2222<br/>   <br/>   Host distant-server<br/>    ProxyJump jump-server<br/>    HostName github.com<br/>    User git</span></pre><p id="8ba7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在哪里，</p><ul class=""><li id="8b46" class="mw mx iq jp b jq jr ju jv jy my kc mz kg na kk no nc nd ne bi translated">跳转服务器和远程服务器是主机名的别名。</li><li id="09fc" class="mw mx iq jp b jq nf ju ng jy nh kc ni kg nj kk no nc nd ne bi translated">User是被授权建立连接的用户名(拥有私钥来验证连接的用户)。</li><li id="1f23" class="mw mx iq jp b jq nf ju ng jy nh kc ni kg nj kk no nc nd ne bi translated">Port是主机的端口号。</li><li id="5429" class="mw mx iq jp b jq nf ju ng jy nh kc ni kg nj kk no nc nd ne bi translated">ProxyJump是充当本地客户端和远程服务器之间的代理的服务器的名称。</li></ul><p id="7cb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而不是使用</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="c9ea" class="lo km iq mf b gy mj mk l ml mm">$   ssh -p 2222 piyush@127.0.0.1</span></pre><p id="74fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以简单地使用</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="39d6" class="lo km iq mf b gy mj mk l ml mm">$ ssh jump-server</span></pre><p id="26f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建ProxyJump连接，请使用:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="08c9" class="lo km iq mf b gy mj mk l ml mm">$ ssh -J &lt;jump-server-alias&gt; &lt;distant-server-alias&gt;</span></pre><p id="2d5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以使用跳转服务器在本地主机和远程服务器之间建立连接。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/df6d039f0d65a59ab78eb0c17f3d96a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BJgligStCt5u5Ac6-ipd2Q.png"/></div></div></figure><p id="bcc5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样，你就成功地建立了联系。</p><h1 id="90aa" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">结论</h1><p id="d6a3" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">使用SSH代理，您必须进入跳转服务器，然后手动连接到远程服务器。它也有安全问题。但是通过使用ProxyJump，您可以在本地机器上立即安全地建立连接。</p></div></div>    
</body>
</html>