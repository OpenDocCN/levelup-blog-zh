<html>
<head>
<title>Test Angular Pipes With Services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试带服务的弯管</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/test-angular-pipes-with-services-4cf77e34e576?source=collection_archive---------3-----------------------#2020-03-25">https://levelup.gitconnected.com/test-angular-pipes-with-services-4cf77e34e576?source=collection_archive---------3-----------------------#2020-03-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="37d0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何测试使用注入服务的角形管道</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/23852baacbe930c8a607bf976c33003c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q3KXO31t7qXMjn0bf5Z3OQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@guillaume_t?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Guillaume TECHER </a>在<a class="ae ky" href="https://unsplash.com/s/photos/free?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="8307" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我每天分享<a class="ae ky" href="https://medium.com/@david.dalbusco/one-trick-a-day-d-34-469a0336a07e" rel="noopener">一个小技巧</a>直到2020年4月19日新冠肺炎隔离期结束。离希望中的好日子还有25天。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="1498" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我花了很多时间专注于编写新的<a class="ae ky" href="https://angular.io" rel="noopener ugc nofollow" target="_blank"> Angular </a>组件及其相关的单元测试，以至于我甚至错过了今天早上的在线“单口相声”,几乎感觉我一天都在某种漩涡中度过。</p><p id="6be6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">反正我喜欢这个挑战。我不想跳过今天的博客帖子，我想和你分享我是如何测试我创建的一个新管道的。此外，我不假装是这项练习的冠军，因此，如果你注意到任何可以改进的地方，请给我留言，我很乐意提高我的技能🙏。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="37f7" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建管道</h1><p id="2a31" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">让我们首先用<code class="fe mz na nb nc b">ng</code>命令行创建一个名为“filter”的空白管道。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="0aa2" class="nh md it nc b gy ni nj l nk nl">ng g pipe filter</span></pre><p id="9aef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将创建如下所示的空白管道:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="a904" class="nh md it nc b gy ni nj l nk nl">import { Pipe, PipeTransform } from '@angular/core';<br/><br/>@Pipe({<br/>  name: 'filter'<br/>})<br/>export class FilterPipe implements PipeTransform {<br/><br/>  transform(value: any, ...args: any[]): any {<br/>    return null;<br/>  }<br/><br/>}</span></pre><p id="0c4b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和它相关的测试:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="4d9a" class="nh md it nc b gy ni nj l nk nl">import { FilterPipe } from './filter.pipe';<br/><br/>describe('FilterPipe', () =&gt; {<br/>  it('create an instance', () =&gt; {<br/>    const pipe = new FilterPipe();<br/>    expect(pipe).toBeTruthy();<br/>  });<br/>});</span></pre><p id="e877" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以是也可以不是一个狂热爱好者，但是我想我们都同意，拥有一个无需任何努力就能创建类和相关测试的CLI是非常酷的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="008c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建服务</h1><p id="b58f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">正如staten在我的开场白中所说，我们的目标是测试一个使用注入服务的管道。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="2bce" class="nh md it nc b gy ni nj l nk nl">ng g service translation</span></pre><p id="118f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">出于演示目的，我们创建了这个虚拟服务“translation ”,除了“Génial”或“Awesome”作为可观察值之外，它返回的内容并不多。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="79e1" class="nh md it nc b gy ni nj l nk nl">import { Injectable } from '@angular/core';<br/><br/>import { Observable, of } from 'rxjs';<br/><br/>@Injectable({<br/>    providedIn: 'root'<br/>})<br/>export class TranslationService {<br/>    translate(lang: string): Observable&lt;string&gt; {<br/>        return of(lang === 'fr' ? 'Génial' : 'Awesome');<br/>    }<br/>}</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6c6f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">机具管道</h1><p id="15c0" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们的服务准备好了，我们用它来增强我们的管道。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="baeb" class="nh md it nc b gy ni nj l nk nl">import { Pipe, PipeTransform } from '@angular/core';<br/><br/>import { TranslationService } from './translation.service';<br/>import { Observable } from 'rxjs';<br/><br/>@Pipe({<br/>    name: 'filter'<br/>})<br/>export class FilterPipe implements PipeTransform {<br/>    constructor(private translationService: TranslationService) {}<br/><br/>    transform(lang: string): Observable&lt;string&gt; {<br/>        return this.translationService.translate(lang);<br/>    }<br/>}</span></pre><p id="a042" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">顺便说一下，它可以在模板中的<code class="fe mz na nb nc b">async</code>管道的帮助下使用(在下面的例子中，<code class="fe mz na nb nc b">lang</code>是组件的公共字符串变量)</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="be1a" class="nh md it nc b gy ni nj l nk nl">&lt;textarea [value]="lang | filter | async"&gt;&lt;/textarea&gt;</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="bf1e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">更新管道测试</h1><p id="02e4" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在本地，我仍然能够运行我的测试而没有错误，但是，因为我们现在在我们的管道中注入了一个服务，如果我们打开相关的单元测试，我们会注意到在构造函数<code class="fe mz na nb nc b">TS2554: expected 1 arguments, but got 0</code>上有一个TypeScript错误。为了解决这个问题，我们现在要么注入服务，要么模仿它。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="6f8b" class="nh md it bd me nm nn dn mi no np dp mm li nq nr mo lm ns nt mq lq nu nv ms nw bi translated">测试中的解析服务</h2><p id="fcbd" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您可以通过<code class="fe mz na nb nc b">inject</code>功能或<code class="fe mz na nb nc b">TestBed</code>解决服务问题。因为第一个解决方案对我没有用，所以第二个是我的退路。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="8f4d" class="nh md it nc b gy ni nj l nk nl">import { FilterPipe } from './filter.pipe';<br/>import { TestBed } from '@angular/core/testing';<br/>import { TranslationService } from './translation.service';<br/><br/>describe('FilterPipe', () =&gt; {<br/>  beforeEach(() =&gt; {<br/>    TestBed<br/>      .configureTestingModule({<br/>        providers: [<br/>          TranslationService<br/>        ]<br/>      });<br/>  });<br/><br/>  it('create an instance', () =&gt; {<br/>    const service: TranslationService =<br/>                              TestBed.get(TranslationService);<br/><br/>    const pipe = new FilterPipe(service);<br/>    expect(pipe).toBeTruthy();<br/>  });<br/>});</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="2631" class="nh md it bd me nm nn dn mi no np dp mm li nq nr mo lm ns nt mq lq nu nv ms nw bi translated">模拟服务</h2><p id="5721" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">另一个解决方案，也是我最终应用的，是创建一个服务的模拟，而不是提供它。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="74d1" class="nh md it nc b gy ni nj l nk nl">import { FilterPipe } from './filter.pipe';<br/>import { of } from 'rxjs';<br/>import { TranslationService } from './translation.service';<br/><br/>describe('FilterPipe', () =&gt; {<br/>  let translationServiceMock: TranslationService;<br/><br/>  beforeEach(() =&gt; {<br/>    translationServiceMock = {<br/>      translate: jest.fn((lang: string) =&gt; of('Awesome'))<br/>    } as any;<br/>  });<br/><br/>  it('create an instance', () =&gt; {<br/>    const pipe = new FilterPipe(translationServiceMock);<br/>    expect(pipe).toBeTruthy();<br/>  });<br/>});</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3804" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">测试管道转换</h1><p id="ffdb" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">到目前为止，我们能够测试我们的管道可以被创建，即使它依赖于一个服务，但是我们仍然没有有效地测试它的结果。因此，这是最后一部分，我使用了服务的模拟。基本上，一旦创建了管道，我们就可以访问它的<code class="fe mz na nb nc b">transform</code>方法，并继续进行一些常见的测试。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="36ef" class="nh md it nc b gy ni nj l nk nl">import { FilterPipe } from './filter.pipe';<br/>import { of } from 'rxjs';<br/>import { take } from 'rxjs/operators';<br/>import { TranslationService } from './translation.service';<br/><br/>describe('FilterPipe', () =&gt; {<br/>  let translationServiceMock: TranslationService;<br/><br/>  beforeEach(() =&gt; {<br/>    translationServiceMock = {<br/>      translate: jest.fn((lang: string) =&gt; of('Awesome'))<br/>    } as any;<br/>  });<br/><br/>  it('create an instance', () =&gt; {<br/>    const pipe = new FilterPipe(translationServiceMock);<br/>    expect(pipe).toBeTruthy();<br/>  });<br/><br/>  it('should translate', () =&gt; {<br/>    const pipe = new FilterPipe(translationServiceMock);<br/>    pipe.transform('en')<br/>      .pipe(take(1))<br/>      .subscribe((text: string) =&gt; {<br/>        expect(text).not.toBe(null);<br/>        expect(text).toEqual('Awesome');<br/>      });<br/>  });<br/>});</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="cff6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">摘要</h1><p id="57c7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我仍然需要一点时间来为项目找到正确的测试设置，特别是当它们是新的项目时，但是一旦一切就绪，并且一旦我可以访问<code class="fe mz na nb nc b">nativeElement</code>来执行查询，就像我在Web组件中所做的那样，我会感觉更舒服，并且开始变得有趣😁。</p><p id="8390" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">呆在家里，注意安全！</p><p id="62af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大卫</p></div></div>    
</body>
</html>