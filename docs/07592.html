<html>
<head>
<title>A Guide to Storing Scraped Data with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python存储抓取数据的指南</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-guide-to-storing-scraped-data-with-python-a275d849463e?source=collection_archive---------0-----------------------#2021-02-26">https://levelup.gitconnected.com/a-guide-to-storing-scraped-data-with-python-a275d849463e?source=collection_archive---------0-----------------------#2021-02-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7c78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Web抓取是为数据科学项目收集大量数据的有效工具，根据您的目标，您需要以某种方式存储抓取的数据。</p><p id="1ae1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将介绍一些常见的、有效的存储抓取数据的方法，比如将数据存储在文件或数据库中，以及一个快速奖励。但是，让我们从数据的结构和一致性的一些考虑开始。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/6fc8126e368f641801aae9dabd8c87ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6U5-SmZyz2KQslcC"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae lb" href="https://unsplash.com/@ruchindra?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Ruchindra Gunasekara </a>拍摄的照片</figcaption></figure><h1 id="15e5" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">结构和一致性</h1><p id="883f" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在你开始收集甚至思考存储数据的最佳方式之前，考虑数据的结构以及如何保持数据的一致性是很重要的。这里的问题是:当代码停止运行时，您的数据会是什么样子？</p><p id="a44d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您从同一个网站上的几个相似页面收集数据，那么您可能能够将所有内容存储在同一个表中，但是如果您从非常不同的来源收集数据，那么一开始将它们分开存储可能更容易。</p><p id="552b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">知道你存储的变量的类型也很重要。是文字还是数字？如果某个特定页面上的某个字段丢失了，该怎么办？如果是数字，也许用零代替更有意义。如果是文本，你可以用任何字符串来表示一个空字段，比如“-”。</p><p id="30ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是如果这没有意义，就用空字符串替换它，比如" "。无论您做什么，做点什么，否则您的数据可能会变得不一致，因为有些行将比其他行长，您将无法信任您刚刚收集的数据。</p><h1 id="6f16" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">CSV文件</h1><h2 id="daef" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">关于一致性的最后一点说明</h2><p id="c8ee" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">为了在CSV文件中正确存储数据，您需要考虑分隔符。顾名思义，逗号分隔值— CSV是一个文件，其中的值用逗号分隔。但是如果你的数据也有很多逗号，那么你的文件将会变得一团糟。</p><p id="67d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，您可以删除数据中的每个逗号，或者使用不同的分隔符。如果逗号是像“1，000，000”这样的数字，那么可能更容易删除它们，因为它们不会有用。但是，如果您正在抓取的是文本，那么逗号可能是相关的，例如，最好将分隔符改为分号。</p><h2 id="f8aa" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">数据帧到CSV</h2><p id="982e" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">使用web抓取创建CSV文件的第一种方法是使用DataFrame.to_csv()方法。这非常简单，只需将数据帧导出为CSV文件。</p><p id="98ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，为了导出数据帧，您首先需要将数据作为数据帧。实现这一点的一个简单方法是创建一个包含所有数据的大列表。列表列表中的每个列表代表数据帧中的一行，包含单个页面中的数据。</p><p id="a51e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您收集完数据后，您可以将列表转换为DataFrame，然后将其导出为CSV文件。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="8d8c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，当创建DataFrame时，您可以直接传递列名，这也将在CSV文件中。</p><p id="b991" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，建议在<code class="fe mt mu mv mw b">to_csv()</code>方法中将index设置为<code class="fe mt mu mv mw b">False</code>,因为在文件中包含索引通常没有意义。最后，请注意sep参数用于用分号分隔值。</p><p id="6b76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不过，这种方法有一个很大的缺点。注意，代码完成后，您将只有一个包含一些信息的CSV文件。这种情况意味着，如果发生任何问题，您的代码崩溃，比方说，只抓取了一半的页面，您将无法访问这些数据，将不得不重新开始。</p><p id="d56b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，如果您选择使用这种方法，那么使用机制来避免代码引发异常就变得更加重要了。因此，请确保在需要时使用try和except子句，在代码中插入尽可能多的暂停以避免服务器过载，并利用代理提供商，如<a class="ae lb" href="https://infatica.io/" rel="noopener ugc nofollow" target="_blank"> Infatica </a>，因为他们能够为您提供更好的IP地址基础设施，这样您就可以确保您的代码将继续运行。</p><h2 id="87e1" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">在文件中写入</h2><p id="d7ce" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">另一种选择是在抓取数据时将所有内容写入CSV文件。这种方法减少了代码停止运行时造成的损害，因为您已经收集的所有内容都将保存在CSV文件中，您不需要从头开始。</p><p id="af3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实现起来也很简单。你可以选择使用Python <a class="ae lb" href="https://docs.python.org/3/library/csv.html" rel="noopener ugc nofollow" target="_blank"> CSV库</a>进行更复杂的操作，或者只使用内置函数<code class="fe mt mu mv mw b">open()</code>。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="56d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于此代码的两点注意事项:</p><ol class=""><li id="bb02" class="mx my iq jp b jq jr ju jv jy mz kc na kg nb kk nc nd ne nf bi translated"><code class="fe mt mu mv mw b">open </code>函数中的第二个参数是模式。有几种打开文件的模式。以下是其中的一些:</li></ol><ul class=""><li id="7c0a" class="mx my iq jp b jq jr ju jv jy mz kc na kg nb kk ng nd ne nf bi translated">r:打开阅读(默认)；</li><li id="a40a" class="mx my iq jp b jq nh ju ni jy nj kc nk kg nl kk ng nd ne nf bi translated">a:打开以供写入，追加到文件的末尾(如果存在的话)。如果文件不存在，它将被创建；</li><li id="b0d3" class="mx my iq jp b jq nh ju ni jy nj kc nk kg nl kk ng nd ne nf bi translated">w:打开进行写入，首先截断文件。如果该文件不存在，将会创建它。</li></ul><p id="f392" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于其他选项，查看<a class="ae lb" href="https://docs.python.org/3/library/functions.html#open" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="bac8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.关闭文件总是很重要的。这就是为什么你需要<code class="fe mt mu mv mw b">try </code>和<code class="fe mt mu mv mw b">finally </code>子句。如果在写入时发生错误，文件将被关闭。</p><p id="e0fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行相同操作的另一种方法是使用一个<code class="fe mt mu mv mw b">with</code>子句。它很有用，因为它保证了文件无论如何都会被关闭，这使得您的代码更加简单。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="5191" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用这种方法，您的CSV文件将没有列的名称，除非您手动添加它们，或者使用一个<code class="fe mt mu mv mw b">if</code>子句仅在您抓取的第一页之前将其写入文件。这是它看起来的样子:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mr ms l"/></div></figure><h2 id="786f" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">比较</h2><p id="c50c" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">虽然看起来第二种方法会消耗更多的时间，因为代码每次抓取新页面时都会打开文件，但事实并非如此。</p><p id="31fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我用每种方法抓取相同的网页一百次。刮刀完全一样，唯一的区别是我存储数据的方式。这是每次接近所用的平均时间。</p><pre class="km kn ko kp gt nm mw nn no aw np bi"><span id="f07f" class="mf ld iq mw b gy nq nr l ns nt"># First approach<br/>0.6287886786460877 seconds</span><span id="ecdf" class="mf ld iq mw b gy nu nr l ns nt"># Second approach<br/>0.6286333727836609 seconds</span></pre><p id="e4fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我边刮边写的速度甚至快了一点点。</p><h1 id="15f8" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">存储在数据库中</h1><p id="98c3" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">如果你有一个更复杂的系统，那么你可能想把数据放在一个数据库里。对于这种情况，很容易将Python代码与SQL数据库集成在一起。</p><p id="043b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本节假设您已经掌握了一些基本的SQL知识，它并不打算成为SQL速成课程。这个想法只是为了展示如何快速地将一个scraper集成到一个数据库中。</p><p id="1633" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Python有一些有用的库，允许用户连接数据库，比如PyMySQL(如果你使用MySQL)和sqlite3(如果你使用sqlite)。</p><p id="5701" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这两个库的用法非常相似，因此我们仅以sqlite3为例。为此，我假设您已经创建了数据库和表。如果是这样，那么我们有一些步骤可以遵循:</p><ol class=""><li id="9f01" class="mx my iq jp b jq jr ju jv jy mz kc na kg nb kk nc nd ne nf bi translated">创建与数据库的连接；</li><li id="4f8a" class="mx my iq jp b jq nh ju ni jy nj kc nk kg nl kk nc nd ne nf bi translated">实例化一个光标对象；</li><li id="d351" class="mx my iq jp b jq nh ju ni jy nj kc nk kg nl kk nc nd ne nf bi translated">确保游标使用的是正确的数据库，尤其是当您有多个数据库时。</li></ol><pre class="km kn ko kp gt nm mw nn no aw np bi"><span id="ccff" class="mf ld iq mw b gy nq nr l ns nt">import sqlite3</span><span id="ddab" class="mf ld iq mw b gy nu nr l ns nt">conn = sqlite3.connect('my_database.db')<br/>cur = conn.cursor()<br/>cur.execute('USE my_database')</span></pre><p id="1d23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，SQL命令是作为字符串传递的。</p><p id="00b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成后，我们需要做的就是使用光标将抓取的数据插入到我们抓取的每个页面的数据库中，然后使用连接进行提交。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="4ab6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，这种方法类似于编写CSV文件，除了我们提交到数据库。此外，关闭光标和连接也很重要，因此您可能希望使用try和finally子句来确保无论发生什么情况，它们都将被关闭。</p><h1 id="df37" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">奖励:电子邮件</h1><p id="8e29" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">有时您可能不需要存储数据，或者至少不仅仅需要存储数据。你可能希望立即得到通知，也许是因为这意味着有问题，也许是因为这是一个你不能错过的好机会。</p><p id="e71b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以作为奖励，让我们看看如何用Python发送电子邮件。使用SMTPlib模块，很容易编写一个自动发送电子邮件的函数。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="7c44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该函数接收电子邮件的主题、消息和收件人，但您也可以更改为接收发件人的信息。此外，这个特殊的功能被设置为从实时服务器发送电子邮件，但也可以使用Gmail和其他功能。检查<a class="ae lb" href="https://docs.python.org/3/library/smtplib.html" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="0197" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，如果在创建与电子邮件服务器的连接时出现问题，try和except子句对于防止代码崩溃非常重要。</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><p id="0c4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望这篇文章能有所帮助。如果你有问题，有建议，或者只是想保持联系，请随时通过<a class="ae lb" href="https://twitter.com/_otavioss" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae lb" href="https://github.com/otavio-s-s" rel="noopener ugc nofollow" target="_blank"> GitHub </a>，或者<a class="ae lb" href="https://www.linkedin.com/in/otavioss28/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>联系我。</p></div></div>    
</body>
</html>