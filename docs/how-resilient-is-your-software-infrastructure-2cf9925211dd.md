# 您的软件基础设施是什么样的？

> 原文：<https://levelup.gitconnected.com/how-resilient-is-your-software-infrastructure-2cf9925211dd>

![](img/969cebe8df01557c3b26e4185d32b04d.png)

在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上由[维斯瓦纳特 V 派](https://unsplash.com/@__pai_10_?utm_source=medium&utm_medium=referral)拍摄的照片

*这是我的现代软件开发实践系列* [*中的第六部分*](https://medium.com/@tylor.borgeson/my-series-on-modern-software-development-practices-372c65a2837e?source=friends_link&sk=3b037795f393df5554502e2c65365d0d) *。在这个系列中，我介绍了软件工程师可以通过改进他们的过程和实践来改进他们的软件的多种方法，所有这些都是我在 ThoughtWorks 担任软件顾问期间学到的，也是我目前在德国一家大型零售公司工作时的经历。*

当今世界上建造的许多结构，如桥梁，都是建立在包括自然界中最坚固的形状:三角形的基础上的。

我在 Thoughtworks 的一部分时间是作为一名基础设施工程师专门花在咨询其他软件团队如何加强他们的基础设施上的…咨询如何将他们的圆形基础设施变成三角形。

这个过程需要各种步骤，其中一些步骤因公司而异，但有一个步骤始终保持不变，那就是将基础设施作为代码来实现。

# **什么是基础设施代码**

基础设施作为一种代码是一种实践，它是为了应对基础设施团队处理的许多挑战而创建的。它侧重于可重复用于供应系统及其配置的例程。

这个想法是，基础设施就像任何其他软件一样对待，因为它应该灵活地适应频繁的更改和改进。最常见的实现是用代码编写服务器、云实例、管道或<insert infrastructure="" component="" here="">的定义，而不是通过用户界面进行配置，任何更改都在代码中实现，然后自动应用到组件，前提是它通过了各种检查，如验证。</insert>

由于资源的定义是代码，因此使用该代码提供的基础设施也可以受益于各种有益的开发工具，例如版本控制、CI/CD 或 TDD。

基础设施即代码旨在实现以下成果:

*   基础设施不是因公司需求和愿望扩大而导致的未来变化的障碍或限制
*   基础设施的改变是没有压力的，并且像任何其他软件改变一样容易应用
*   冗余和常规任务的自动化扩展到团队/公司的基础设施部分
*   基础设施的用户能够自己对基础设施进行更改和应用更改
*   团队基础架构方面的平均恢复时间缩短

# **代码地址挑战基础设施**

## **服务器和配置不一致**

随着越来越多的团队迁移到云并使用虚拟机，团队拥有数量不断增加的衍生服务器的能力和可能性也在增加。然而，这也意味着使所有这些机器保持最新和相互一致的挑战更加频繁地出现。如果机器开始相互区分，可能会导致各种程序或脚本只能在某些机器上运行。

想象一下，将一个更新部署到您的软件中，它在一个服务器上工作，而在另一个服务器上不工作，这意味着用户必须“幸运地”到达工作的服务器，以便在负载平衡模式的情况下拥有一个功能完整的软件实例。

## **雪花机**

据说雪花是完全独特的，因为没有两片雪花是完全相同的，因为一片雪花是不可复制的。同样的事情也会发生在软件机器上。

许多系统管理员试图通过手工修改服务器来补救不一致的服务器配置。这样做的结果是，服务器被专门更新以修复某个问题，并且没有更新历史。(是的，在云的情况下，有时仍然有在线历史，但是如果用户在解决问题之前点击了 100 次，历史也没有多大帮助)。唯一知道服务器被做了什么的人是更新它的人。那么“神奇”就是某个东西按预期运行的唯一原因，而当某个东西不工作的时候，就不容易解释了。

这通常不是故意的，但我们是人，人类会犯错误，比如更新服务器 1、2、3、4，但不知何故忘记了服务器号 5。

## **“别碰那个”**

在改造了一台服务器并最终让它按照预期工作和运行软件之后，最终的结果几乎就像一座纸牌屋。可以用，但是很脆弱。所以，“不要碰”。

任何进一步的更新或更改通常都是不情愿的，自动化成为管理员有点害怕的事情，因为他们不确定这些更改是否会导致服务器仍然正常工作。

# **基础设施作为代码原则**

## **点击按钮**即可复制系统

当基础设施是通过代码提供的，而不是通过点击一个 UI，如 Amazon Web Services 或 Jenkins，复制创建的步骤是微不足道的。所有的改变都被记录下来，没有一个步骤会被遗忘。

当来自不同团队的同事询问您的团队如何在 AWS 中配置 Kubernetes 集群的自动扩展时，您不必点击 UI 来查找 3 个月前最后一次编辑的设置。相反，他们可以只查看创建设置的代码，甚至可能复制代码用于他们自己的实例。

当从一个数据中心迁移到云，甚至从一个云提供商迁移到另一个云提供商时，同样的事情也很有用，因为创建资源的过程很容易重复。

## **一次性机器**

由于基础设施供应步骤是可编程重现的，因此您永远不必担心机器损坏或需要更换的长期后果。

云以及所谓的[【动态基础设施】](https://en.wikipedia.org/wiki/Dynamic_infrastructure)的主要优势之一是资源可以快速移动、更新、创建、替换、调整大小，甚至删除。当您不需要担心删除资源时可能会丢失所需的和未知的设置时，您可以充分利用动态基础结构所提供的好处。

## **一致性和适应变化**

当通过代码而不是 UI 提供资源时，当代码更新和运行时，用代码创建的所有资源也将被更新。

这意味着所有调配的资源(例如服务器)将保持一致，并且本质上是彼此的精确副本。由于我们无法轻易预测基础设施需求将如何随着我们系统的增长和变化而变化，当我们能够快速、频繁地改变我们的系统时，这在很大程度上是一个积极的场景。

有了基础设施作为代码，每个小的改变都可以像持续集成一样直接应用，通过“经常做小的改变”来增加系统的弹性。

# **如何入门**

## **定义文件**

为了以代码的形式开始使用基础设施，自然地，您的基础设施配置必须转换成代码，并在代码中定义。这些定义文件是基础设施的真实来源。

一个很好的工具是[地形](http://terraform.io)。

Terraform 允许您使用 HCL (Hashicorp 配置语言)配置和管理基础设施资源。使用它的各种提供者，您可以像在 UI 中一样使用关键字和变量来提供资源。当代码运行时，代码中定义的资源是以编程方式提供的。

Terraform 的一个令人惊叹的地方是，它允许将已有的资源导入代码。

这是一个如何在 Microsoft Azure 中将基本 Linux 虚拟机配置和分配给虚拟网络的示例。

## **版本控制**

一旦在代码中定义了您的资源，您的基础设施也可以从版本控制系统提供的优势中受益。

更改的历史、更改者、更改时间都被记录下来，这为在出现问题时需要调试甚至回滚提供了非常有价值的信息来源。

这还允许一个可见的更改日志，所有用户都可以很容易地看到发生了什么变化。对回购的新推动还可以触发管道的构建或其他操作，从而为基础架构中的 CI/CD 创造机会

不要忘记:和所有代码一样，进行小的改动比大的改动有很多好处。小的改动更容易测试和调试，修复起来也更快。对基础设施进行较小的改动也没什么不同。

# **代码为**的超赞基础设施工具

## [terra form](http://terraform.io)

如上所述，terraform 是一个为各种基础设施资源编写、管理和部署配置文件的工具。该网站将其描述为:

> “Terraform 是一种安全高效地构建、更改和管理基础设施的工具。Terraform 可以管理现有的和受欢迎的服务提供商以及定制的内部解决方案。
> 
> 配置文件描述了运行单个应用程序或整个数据中心所需组件的平台化。Terraform 生成一个执行计划，描述它将做什么来达到期望的状态，然后执行它来构建所描述的基础设施。随着配置的变化，Terraform 能够确定发生了什么变化，并创建可以应用的增量执行计划。"

## [**张风**](https://packer.io/)

Packer 也是 Hashicorp 的一个工具，它允许快速和自动地创建机器映像。在过去，创建虚拟机映像通常是通过创建虚拟机，手动配置它(即安装所需的软件包和依赖项)，然后制作其状态的副本来完成的。这个映像现在可以在一个位于中心的文件中定义，并通过 packer 构建。它甚至可以使用诸如 Chef 和 Puppet 之类的工具将东西安装到映像上。

## [**总汇**](https://concourse-ci.org/)

一个构建管道，它有一个用户界面，用户唯一能做的事情就是查看状态和日志。整个管道必须通过配置文件进行配置。在我看来，它是市场上最酷的管道工具之一…而且它是开源的。

关于基础设施代码的更多信息，我强烈推荐以下链接:

*   [https://www . hashi corp . com/resources/what-is-infra structure-as-code](https://www.hashicorp.com/resources/what-is-infrastructure-as-code)—hashi corp
*   [https://docs . Microsoft . com/en-us/azure/devo PS/learn/what-is-infra structure-as-code](https://docs.microsoft.com/en-us/azure/devops/learn/what-is-infrastructure-as-code)—微软
*   [https://www . Thoughtworks . com/de/insights/blog/infra structure-code-reason-smile](https://www.thoughtworks.com/de/insights/blog/infrastructure-code-reason-smile)—Thoughtworks

另一个重要的信息来源是基夫·莫里斯的同名书籍。它分享了我在上面写的许多相同的信息，同时更深入地研究了作为代码的基础设施背后的各种思想，解释了它如何在公共基础设施模式中发挥作用，并提供了关于团队工作流的输入。我强烈推荐。

本文只是略微涉及了作为代码的基础设施背后的思想。如果您有进一步的问题和意见，或者需要帮助来启动您的旅程，请随时与我联系！编码快乐，感谢阅读！

[*我的现代软件开发实践系列中的其他文章可以在这里找到*](https://medium.com/@tylor.borgeson/my-series-on-modern-software-development-practices-372c65a2837e?source=friends_link&sk=3b037795f393df5554502e2c65365d0d)