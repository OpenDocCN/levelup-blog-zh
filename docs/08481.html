<html>
<head>
<title>Istio + gRPC Web + Cert Manager = 🔥(Part 1/2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio + gRPC Web +证书管理器=🔥(第1/2部分)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/istio-grpc-web-cert-manager-e212873624d5?source=collection_archive---------4-----------------------#2021-05-06">https://levelup.gitconnected.com/istio-grpc-web-cert-manager-e212873624d5?source=collection_archive---------4-----------------------#2021-05-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/8b81430f3265ef79ec9597a4119b015b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*HTGHEVODx3l3tAuVdt7foA.png"/></div></figure><p id="f893" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我用gRPC-Web和Istio构建了一个概念验证，但是在将它们结合起来时，我几乎没有找到任何资源。更不用说当我在寻找用HTTPs加密流量的资源时，搜索结果变得更加稀缺。这促使我自己创建了一个指南。</p><p id="a496" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在第1部分中，我将解释如何使用Istio在gRPC后端服务器和使用gRPC-web的前端Web客户端之间建立通信。在第2部分中，我将介绍如何通过使用HTTPs加密前端和后端之间的网络流量来保护通信。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ks"><img src="../Images/cbb787ce71db7f830ed9317f52040cd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vNtMmvSVevy-w6axLr42vg.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">来源:<a class="ae lf" href="https://blogs.vmware.com/networkvirtualization/2019/04/grpc-web-and-istio.html/" rel="noopener ugc nofollow" target="_blank"> VMware博客</a></figcaption></figure><p id="deba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我们深入技术细节之前，让我先介绍一下Istio和gRPC-Web到底是什么。</p><p id="99f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae lf" href="https://istio.io/latest/docs/concepts/what-is-istio/" rel="noopener ugc nofollow" target="_blank"> Istio </a>是一个服务网格实现，它创建、管理并帮助理解微服务之间的网络。Istio在服务到服务的通信方面有很多优势，比如负载平衡、认证和授权、监控、可追溯性等等。</p><p id="bd00" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae lf" href="https://grpc.io/blog/grpc-web-ga/" rel="noopener ugc nofollow" target="_blank"> gRPC-Web </a>支持Web应用直接与gRPC后端服务通信，无需HTTP服务器作为中介。和gRPC一样，gRPC-Web允许您使用协议缓冲区定义客户端(Web)和后端gRPC服务之间的服务“契约”。<br/>由于我们似乎不会很快获得对gRPC的本地浏览器支持，gRPC-Web提供了一个很好的解决方案，它使用一个代理，如Envoy或Nginx，将来自浏览器的HTTP调用转换为对后端的本地gRPC调用。Istio使用Envoy作为其服务网格代理；因此，我们在该教程中使用Istio。</p><p id="0d6d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">介绍完了，让我们直接进入有趣的部分。</p></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><h1 id="5a0c" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated"><strong class="ak">我们将实现的目标:</strong></h1><ol class=""><li id="ecdc" class="ml mm iq jw b jx mn kb mo kf mp kj mq kn mr kr ms mt mu mv bi translated">部署单节点Kubernetes(k8s)集群。为了这个教程，我们将使用<a class="ae lf" href="https://k3s.io/" rel="noopener ugc nofollow" target="_blank"> K3s </a>。</li><li id="6488" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ms mt mu mv bi translated">在k8s集群中下载并安装Istio服务网格。</li><li id="77af" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ms mt mu mv bi translated">确定Istio的入口IP和端口。</li><li id="b998" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ms mt mu mv bi translated">将前端、gRPC后端服务和Envoy gRPC web过滤器部署为集群中的k8s对象。</li><li id="c561" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ms mt mu mv bi translated">创建Istio网关和虚拟服务</li><li id="e470" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ms mt mu mv bi translated">测试应用程序</li></ol><p id="e670" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在让我们把手弄脏吧！</p></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><h2 id="b94c" class="nb lo iq bd lp nc nd dn lt ne nf dp lx kf ng nh mb kj ni nj mf kn nk nl mj nm bi translated">1)部署一个k8s集群:</h2><p id="1dcb" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated"><em class="nq">我将在本教程中使用</em> <a class="ae lf" href="https://k3s.io/" rel="noopener ugc nofollow" target="_blank"> <em class="nq"> K3s </em> </a> <em class="nq">，在我看来，它是K8s的一个非常可靠的轻量级发行版，非常适合开发和edge(资源有限的环境)部署。要安装它，你只需要运行<br/> </em> <code class="fe nr ns nt nu b">$ curl -sfL https://get.k3s.io | sh -</code></p><p id="f6b4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在撰写本教程时，使用的是Kubernetes版本。</p><h2 id="f588" class="nb lo iq bd lp nc nd dn lt ne nf dp lx kf ng nh mb kj ni nj mf kn nk nl mj nm bi translated">2)下载并安装Istio:</h2><p id="c8f0" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">为了<a class="ae lf" href="https://istio.io/latest/docs/setup/getting-started/" rel="noopener ugc nofollow" target="_blank">安装</a> Istio，需要完成以下步骤:</p><ul class=""><li id="3193" class="ml mm iq jw b jx jy kb kc kf nv kj nw kn nx kr ny mt mu mv bi translated"><code class="fe nr ns nt nu b">$ curl -L <a class="ae lf" href="https://istio.io/downloadIstio" rel="noopener ugc nofollow" target="_blank">https://istio.io/downloadIstio</a> | sh -</code>(撰写本教程时，使用的是Istio 1 . 9 . 3版本)</li><li id="5abb" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated"><code class="fe nr ns nt nu b">$ cd istio-1.9.3</code></li><li id="9f4d" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated"><code class="fe nr ns nt nu b">$ export PATH=$PWD/bin:$PATH</code></li><li id="ceda" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated"><code class="fe nr ns nt nu b">$ istioctl install — set profile=demo -y</code>(如果运行该命令时出现连接被拒绝的错误，请按照此处<a class="ae lf" href="https://discuss.istio.io/t/solved-error-installing-istio-using-istioctl/5254" rel="noopener ugc nofollow" target="_blank">提到的步骤</a>，这应该可以解决问题)</li><li id="777a" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated">最后但同样重要的是，我们希望指示Istio在应用程序中自动注入其Envoy sidecar代理:<br/> <code class="fe nr ns nt nu b">$ kubectl label namespace default istio-injection=enabled</code></li></ul><h2 id="da46" class="nb lo iq bd lp nc nd dn lt ne nf dp lx kf ng nh mb kj ni nj mf kn nk nl mj nm bi translated">3)确定入口IP和端口</h2><p id="95cb" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">按照以下步骤识别k8s集群入口主机和端口:(有关以下步骤的更多详细信息，请查看Istio的<a class="ae lf" href="https://istio.io/latest/docs/setup/getting-started/#determining-the-ingress-ip-and-ports" rel="noopener ugc nofollow" target="_blank">文档</a></p><pre class="kt ku kv kw gt nz nu oa ob aw oc bi"><span id="b547" class="nb lo iq nu b gy od oe l of og">$ <!-- -->export INGRESS_HOST=$(kubectl get po -l istio=ingressgateway -n istio-system -o jsonpath='{.items[0].status.hostIP}')</span><span id="c974" class="nb lo iq nu b gy oh oe l of og">$ <!-- -->export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].nodePort}')</span><span id="1c7e" class="nb lo iq nu b gy oh oe l of og">$ <!-- -->export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="https")].nodePort}')</span><span id="bbb4" class="nb lo iq nu b gy oh oe l of og">$ export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT</span><span id="97ee" class="nb lo iq nu b gy oh oe l of og">$ echo "$GATEWAY_URL"</span></pre><p id="b669" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是将应用程序暴露在集群之外并允许浏览器中的前端客户端和后端之间通信所必需的。记下$GATEWAY_URL，我们以后会用到它。</p><h2 id="2a87" class="nb lo iq bd lp nc nd dn lt ne nf dp lx kf ng nh mb kj ni nj mf kn nk nl mj nm bi translated">4)部署前端、gRPC后端服务和Envoy gRPC web过滤器</h2><p id="2acb" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">由于后端和前端的实现细节不是本教程的范围，我将在这里重用后端和前端实现的<a class="ae lf" href="https://medium.com/swlh/building-a-realtime-dashboard-with-reactjs-go-grpc-and-envoy-7be155dfabfb" rel="noopener"/>。</p><p id="036d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我为后端和前端创建了一个docker映像，并将在下面的K8s部署清单中使用它们。</p><p id="dab1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要让它们运行，请遵循以下步骤:</p><ul class=""><li id="cfda" class="ml mm iq jw b jx jy kb kc kf nv kj nw kn nx kr ny mt mu mv bi translated">如果您还没有帐户，请在<a class="ae lf" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> dockerhub </a>上创建一个帐户。</li><li id="d344" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated">创建一个docker注册表秘密能够拉图片:<br/> <code class="fe nr ns nt nu b">$ kubectl create secret docker-registry regcred --docker-username=&lt;your-name&gt; --docker-password=&lt;your-password&gt;</code></li><li id="3651" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated">创建一个新目录，并将下面的目录复制到其中。</li></ul><figure class="kt ku kv kw gt jr"><div class="bz fp l di"><div class="oi oj l"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">特使过滤器</figcaption></figure><figure class="kt ku kv kw gt jr"><div class="bz fp l di"><div class="oi oj l"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">后端部署和服务</figcaption></figure><figure class="kt ku kv kw gt jr"><div class="bz fp l di"><div class="oi oj l"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">前端部署和服务</figcaption></figure><ul class=""><li id="47c5" class="ml mm iq jw b jx jy kb kc kf nv kj nw kn nx kr ny mt mu mv bi translated">用步骤3中确定的值替换环境变量<code class="fe nr ns nt nu b">REACT_APP_GATEWAY_URL</code>的值。</li><li id="7652" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated">按顺序运行以下命令(注意，需要在后端服务之前创建envoy过滤器，因为过滤器将安装在后端pod中运行的Istio的sidecar上)</li></ul><pre class="kt ku kv kw gt nz nu oa ob aw oc bi"><span id="8403" class="nb lo iq nu b gy od oe l of og">$ kubectl create -f envoy-filter.yaml<br/>$ kubectl create -f grpc-backend.yaml<br/>$ kubectl create -f grpc-web-frontend.yaml</span></pre><ul class=""><li id="6c8a" class="ml mm iq jw b jx jy kb kc kf nv kj nw kn nx kr ny mt mu mv bi translated">通过运行<code class="fe nr ns nt nu b">$ kubectl get pods</code>来验证部署，应该会看到与下面类似的输出</li></ul><pre class="kt ku kv kw gt nz nu oa ob aw oc bi"><span id="929e" class="nb lo iq nu b gy od oe l of og">NAME                      READY   STATUS    RESTARTS   AGE<br/>server-xxxxxx-xxxxxxxxx   2/2     Running   0          xm<br/>client-xxxxxx-xxxxxxxxx   2/2     Running   0          xm</span></pre><h2 id="9174" class="nb lo iq bd lp nc nd dn lt ne nf dp lx kf ng nh mb kj ni nj mf kn nk nl mj nm bi translated">5)创建Istio网关和虚拟服务</h2><p id="8c6e" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">我们需要指示Istio配置集群的入口流量，并将HTTP流量路由到后端。这可以通过为后端和前端创建目的地规则，以及创建网关和虚拟服务来实现。</p><p id="40cd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">正如您在下面的对象定义中看到的，虚拟服务定义应该有将流量路由到后端和前端的规则。</p><p id="bc1a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在项目目录下创建下面的文件，然后运行<br/> <code class="fe nr ns nt nu b">$ kubectl create -f gateway.yaml</code></p><figure class="kt ku kv kw gt jr"><div class="bz fp l di"><div class="oi oj l"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">Istio的目的地规则、网关和虚拟服务</figcaption></figure><h2 id="82ed" class="nb lo iq bd lp nc nd dn lt ne nf dp lx kf ng nh mb kj ni nj mf kn nk nl mj nm bi translated">6)测试应用程序</h2><p id="5891" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">按照前面的步骤，我们应该成功部署了gRPC后端服务和使用gRPC-web与后端通信的前端服务。Istio的网关充当代理，将来自浏览器的http调用转换为后端的gRPC调用。</p><p id="1ab8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要验证该流程，请打开一个新的浏览器选项卡并访问<code class="fe nr ns nt nu b">http://$GATEWAY_URL/ui</code></p><p id="c24b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您应该能够看到一个简单的UI，它具有如下所示的温度和湿度读数。数字应该每5秒或更短时间变化一次。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/2da6e5ac7150c0de83e5b95f2a076d54.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*Pb-vBdzGc7WCKT7_8KfSuA.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">用户界面中的预期输出</figcaption></figure></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><p id="a9f7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">那都是乡亲们！🎉</p><p id="e63a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这一部分，我们能够</p><ul class=""><li id="2f7c" class="ml mm iq jw b jx jy kb kc kf nv kj nw kn nx kr ny mt mu mv bi translated">部署gRPC后端服务和使用gRPC web与后端通信的前端服务。</li><li id="0382" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated">在前端和后端pod上注入Istio的sidecar代理</li><li id="bef0" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated">使用Istio入口网关公开服务</li><li id="0ac7" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated">配置Istio的入口网关，将HTTP流量代理到gRPC后端</li></ul><p id="d020" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<strong class="jw ir">第2部分</strong>中，我将解释如何使用<strong class="jw ir">证书管理器保护与HTTPs的前端到后端通信。</strong>敬请期待！</p><blockquote class="ol om on"><p id="392e" class="ju jv nq jw b jx jy jz ka kb kc kd ke oo kg kh ki op kk kl km oq ko kp kq kr ij bi translated"><em class="iq">免责声明:所有使用的yaml文件不一定是为生产使用而创建的。要在生产中使用它们，可能需要进行一些更改。</em></p></blockquote><h2 id="5a68" class="nb lo iq bd lp nc nd dn lt ne nf dp lx kf ng nh mb kj ni nj mf kn nk nl mj nm bi translated">资源:</h2><ul class=""><li id="97c3" class="ml mm iq jw b jx mn kb mo kf mp kj mq kn mr kr ny mt mu mv bi translated"><a class="ae lf" href="https://istio.io/latest/docs/setup/getting-started/" rel="noopener ugc nofollow" target="_blank">https://istio.io/latest/docs/setup/getting-started/</a></li><li id="279b" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated"><a class="ae lf" href="https://medium.com/swlh/building-a-realtime-dashboard-with-reactjs-go-grpc-and-envoy-7be155dfabfb" rel="noopener">https://medium . com/swlh/building-a-real time-dashboard-with-react js-go-grpc-and-envoy-7be 155 DFA FB</a></li><li id="0b8b" class="ml mm iq jw b jx mw kb mx kf my kj mz kn na kr ny mt mu mv bi translated"><a class="ae lf" href="https://venilnoronha.io/seamless-cloud-native-apps-with-grpc-web-and-istio" rel="noopener ugc nofollow" target="_blank">https://venil noroha . io/seamless-cloud-native-apps-with-grpc-web-and-istio</a></li></ul></div></div>    
</body>
</html>