<html>
<head>
<title>Build an Air Quality Reporting Service With Messages API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用消息API构建空气质量报告服务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/build-an-air-quality-reporting-service-with-messages-api-5852b53ab070?source=collection_archive---------10-----------------------#2020-12-18">https://levelup.gitconnected.com/build-an-air-quality-reporting-service-with-messages-api-5852b53ab070?source=collection_archive---------10-----------------------#2020-12-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/72ddcc08804dd3f5d6bd73160e97b12f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2KD0MD7t6Mr6BB3xPGsAPg.png"/></div></div></figure><p id="b077" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您是否考虑过扩展您现有的应用程序来与多个通信渠道进行交互？如果我们可以用这个想法来引起人们对空气污染和气候变化等问题的关注，会怎么样呢？</p><p id="5133" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">世界空气质量指数项目是一个始于2007年的非营利性项目。他们的任务是促进空气污染意识，并确保获得世界范围的空气质量信息。它们提供REST APIs来访问来自全球各地的天气和空气质量监测站的数据。您可以使用其他数据源来构建一个关注社会问题的服务！</p><p id="374c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个例子中，我们将构建一个由Node.js提供支持的服务，node . js是一个JavaScript运行时和<a class="ae kw" href="https://www.vonage.com/communications-apis/messages/" rel="noopener ugc nofollow" target="_blank"> Vonage Messages API </a>，它将通过WhatsApp和Facebook Messenger发送给定位置的当前空气质量信息。</p><p id="756a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将要构建的示例的源代码也可以在<a class="ae kw" href="https://github.com/sudiptog81/vonage-aqi" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p><h1 id="4c7d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Vonage API帐户</h1><p id="9ceb" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">要完成本教程，您将需要一个<a class="ae kw" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2020-12-02-build-an-air-quality-reporting-service-with-messages-api" rel="noopener ugc nofollow" target="_blank"> Vonage API帐户</a>。如果您还没有，您可以今天就<a class="ae kw" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2020-12-02-build-an-air-quality-reporting-service-with-messages-api" rel="noopener ugc nofollow" target="_blank">注册</a>并开始使用免费信用点数进行构建。一旦你有了一个帐户，你可以在<a class="ae kw" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2020-12-02-build-an-air-quality-reporting-service-with-messages-api" rel="noopener ugc nofollow" target="_blank"> Vonage API仪表板</a>的顶部找到你的API密匙和API秘密。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/941d1ebad7252085aa9c1e88f9dc18f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9RUNrmWVrhuK9uZKQ1igZA.png"/></div></div></figure><h1 id="830c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置开发环境</h1><p id="f0ab" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们需要为我们的应用程序打开一个<code class="fe me mf mg mh b">ngrok</code>隧道，以最小的配置在互联网上公开它。安装<code class="fe me mf mg mh b">ngrok</code>后，打开一个终端，执行<code class="fe me mf mg mh b">ngrok http 3070</code>，将本地端口3070暴露给互联网。确保使用<code class="fe me mf mg mh b">.env</code>中的<code class="fe me mf mg mh b">PORT</code>变量来覆盖它。将<code class="fe me mf mg mh b">ngrok</code>打印的HTTPS网址复制到控制台并记下。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/8397f76e33bccf9edcbb1b575e736e3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rDy8arJKOLXy1KZR3IASTQ.jpeg"/></div></div></figure><p id="1281" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在是时候为应用程序安装所需的依赖项了。执行<code class="fe me mf mg mh b">npm init -y</code>创建一个<code class="fe me mf mg mh b">package.json</code>文件。我们将使用express . js——node . js的一个流行的web应用程序框架，Axios——这个项目的一个HTTP客户端库，以及Dotenv——一个管理环境变量的模块。稍后，我们还将利用Dedent和Commander.js来实现更多功能。通过执行以下命令来安装这些模块:</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="d49e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于我们会不时地对源代码进行修改，所以我们可以通过安装Nodemon来节省一些击键次数，node mon会持续监视修改并自动重启应用程序。通过执行以下命令将其作为开发依赖项安装</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="a8b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于本教程，我们的切入点将是一个名为<code class="fe me mf mg mh b">lib/index.js</code>的文件。添加或更新<code class="fe me mf mg mh b">package.json</code>中的<code class="fe me mf mg mh b">main</code>和<code class="fe me mf mg mh b">script</code>键，使用nodemon执行应用程序:</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="d0d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将主目录中<code class="fe me mf mg mh b">.env.example</code>的内容复制到名为<code class="fe me mf mg mh b">.env</code>的新文件中。登录到Vonage API仪表板后，找到您的API密钥和API密码，并更新<code class="fe me mf mg mh b">.env</code>中的值。在接下来的章节中还会分配一些额外的变量。</p><h1 id="80bc" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">使用消息API接收入站消息</h1><p id="7fff" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">每当Vonage在您的虚拟电话号码上或通过其他渠道接收到一条传入消息时，Vonage服务器就会使用JSON有效负载向一个已定义的webhook端点发出HTTP请求。对于本教程，我们假设应用程序中的<code class="fe me mf mg mh b">/webhook/inbound</code>路由将监听所有这样的请求。</p><p id="df54" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了确保我们收到这个请求，我们需要配置沙盒环境，您可以在Vonage API仪表板的“消息和调度”下找到它。将入站消息Webhook (HTTP POST)设置为<code class="fe me mf mg mh b">&lt;ngrok-https-url&gt;/webhook/inbound</code>，并点击“保存webhooks”。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/fa4b3fbce1206fb89180232392afe366.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*OJhc9EdQ52p0TYzXFcvEgA.jpeg"/></div></figure><p id="23d0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在同一页面上，链接一个测试帐户以发送邮件。点击WhatsApp和Messenger频道上的“添加到沙盒”链接。然后扫描手机上的二维码或者点击给定的链接。它通常包括向为沙箱提供的号码或页面发送密码短语。一旦您链接了您的测试帐户并设置了webhook端点，您就可以继续了。将仪表板上提到的沙盒电话号码保存到您的地址簿中，以便于访问。</p><p id="1c67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将构建一个Express.js应用程序来监听端口<code class="fe me mf mg mh b">3070</code>上的webhook请求。最低要求是接受该路由上的HTTP POST请求，并发送一个状态代码<code class="fe me mf mg mh b">200</code>。在我们的Express.js应用程序中，可以通过<code class="fe me mf mg mh b">req.body</code>对象访问这个有效负载。为了查看有效负载请求数据，通过执行<code class="fe me mf mg mh b">npm run dev</code>来运行应用程序。</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="9873" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试从WhatsApp向沙盒号发送一条消息，并在运行应用程序的终端窗口上观察输出。从Messenger应用程序向沙盒页面发送另一条消息，并再次观察输出。</p><p id="b073" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上例中显示的输出表明，通过验证<code class="fe me mf mg mh b">req.body.from.type</code>可以区分不同的通道。根据渠道的不同，我们还注意到入站消息可能来自电话号码或页面/帐户ID。发送的消息可以通过请求体中的<code class="fe me mf mg mh b">req.body.message</code>对象来访问。</p><p id="576b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将<code class="fe me mf mg mh b">VONAGE_NUMBER</code>的值设置为<code class="fe me mf mg mh b">req.body.to.number</code>中接收到的电话号码，将<code class="fe me mf mg mh b">VONAGE_PAGE_ID</code>的值设置为<code class="fe me mf mg mh b">req.body.to.id</code>中的页面ID，将<code class="fe me mf mg mh b">.env</code>中的相应变量设置为我们正在使用的沙箱。在实践中，这将被一个WhatsApp商业账号和链接到Vonage应用程序的脸书页面ID所取代。</p><h1 id="c803" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">使用消息API发送消息</h1><p id="8da6" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">使用Vonage Messages API，向通道发送消息包括向API端点发送带有消息对象的HTTP POST请求。使用沙箱时，端点为:<code class="fe me mf mg mh b"><a class="ae kw" href="https://messages-sandbox.nexmo.com/v0.1/messages." rel="noopener ugc nofollow" target="_blank">https://messages-sandbox.nexmo.com/v0.1/messages</a></code> <a class="ae kw" href="https://messages-sandbox.nexmo.com/v0.1/messages." rel="noopener ugc nofollow" target="_blank">。</a></p><p id="260f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://developer.nexmo.com/api/messages-olympus?theme=dark#NewMessage" rel="noopener ugc nofollow" target="_blank">消息API引用</a>表明请求必须包含一个值为<code class="fe me mf mg mh b">Basic base64(apiKey):base64(apiToken)</code>或<code class="fe me mf mg mh b">Bearer jwtToken</code>的<code class="fe me mf mg mh b">Authorization</code>头和请求体中的一个消息对象。要使用它，用下面的例子更新您的<code class="fe me mf mg mh b">/lib/utils.js</code>文件:</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="75e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">助手函数<code class="fe me mf mg mh b">sendMessage</code>将把消息的正文发送到定义的WhatsApp号码。可以动态构造消息对象以支持多个通道；您可以在另一个实用函数中实现这一点。</p><p id="10e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新你的<code class="fe me mf mg mh b">/lib/index.js</code>文件，在webhook函数中，用你想发送的消息调用<code class="fe me mf mg mh b">sendMessage</code>函数，如下所示:</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="abeb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们已经为一个对话服务构建了一个框架，它将使用Messages API通过WhatsApp和Messenger发送和接收消息。尝试向WhatsApp上的Vonage沙盒号码发送消息！</p><h1 id="bbdd" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">从世界空气质量指数API获取数据</h1><p id="4e32" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">世界空气质量指数项目为接近实时的空气质量数据提供JSON APIs。为了访问数据，<a class="ae kw" href="https://aqicn.org/data-platform/token/" rel="noopener ugc nofollow" target="_blank">注册一个API令牌</a>。我们将在此页面上提供的电子邮件地址上收到一个验证链接，该链接会将我们重定向到显示API令牌的页面。将<code class="fe me mf mg mh b">.env</code>中<code class="fe me mf mg mh b">AQICN_TOKEN</code>的值设置为该页面上显示的令牌。</p><p id="3e86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用WAQI搜索API为特定城市搜索匹配的空气质量监测站。对<code class="fe me mf mg mh b">https://api.waqi.info/search/</code>的HTTP GET请求有两个必需的查询参数- <code class="fe me mf mg mh b">keyword</code>用作查找电台或城市名称的搜索词，以及<code class="fe me mf mg mh b">token</code>引用WAQI API令牌。</p><p id="d0de" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从Postman或失眠症(两者都是用于调试HTTP API请求的流行GUI应用程序)内部发出请求，我们可以看到对关键字<code class="fe me mf mg mh b">london</code>的响应包含每个搜索结果的<a class="ae kw" href="https://aqicn.org/json-api/doc/#api-Search-SearchByName" rel="noopener ugc nofollow" target="_blank">有限站元数据</a>。</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="19e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是时候为我们的应用程序实现一个实用函数来获取搜索结果的顶部结果，并使用它来检索预期的数据了。</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="ce81" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要从车站获取提要数据，再发出一个HTTP GET请求，这次是对WAQI City/Station提要API的请求。这个API的端点是<code class="fe me mf mg mh b">https://api.waqi.info/feed/&lt;station-url&gt;/</code>，其中<code class="fe me mf mg mh b">station-url</code>对应于由<code class="fe me mf mg mh b">getStation</code>返回的<code class="fe me mf mg mh b">station</code>对象中的<code class="fe me mf mg mh b">url</code>键值。API令牌也需要作为查询参数。</p><p id="2a2c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于<code class="fe me mf mg mh b">london</code>返回的测站请求，返回一个JSON对象，其中包含<a class="ae kw" href="https://aqicn.org/json-api/doc/#api-City_Feed-GetCityFeed" rel="noopener ugc nofollow" target="_blank">原始测量值和详细的测站元数据</a>，如下所示:</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="d3d1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实现另一个实用函数来发出这个请求。该函数将从<code class="fe me mf mg mh b">getStation</code>获取的<code class="fe me mf mg mh b">station</code>对象作为参数，并向API查询来自站点的数据。通过添加以下<code class="fe me mf mg mh b">getStationData</code>功能来更新<code class="fe me mf mg mh b">lib/utils.js</code>:</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="9ebf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们现在可以使用我们的实用函数来查询WAQI API，在Vonage Messages API支持的通道上接收消息，并在处理这些数据后发送回一个有意义的回复。</p><h1 id="c637" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">回复相关信息</h1><p id="588b" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们从WAQI APIs获得的数据需要进行处理，并使其“可读”。我们可以使用两种不同的模板来报告数据，一种是包含空气质量指数和美国环保署2016年健康影响的简要报告，另一种是提及污染物水平和天气信息及其各自测量单位的详细报告。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/e8f1140a962295742a1897e8a757a0a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*5nhDw3mJJ6Oz3uIndjpgDQ.png"/></div></figure><p id="8233" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">空气质量污染水平健康影响警告声明(针对PM 2.5)</p><p id="d9ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mn">来源:</em> <a class="ae kw" href="https://www.airnow.gov/aqi/aqi-basics/" rel="noopener ugc nofollow" target="_blank"> <em class="mn"> AQI基础知识，AirNow </em> </a></p><p id="fb1f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还必须从晦涩的缩写中分辨出污染物的名称和不同的天气指标。我们可以参考<a class="ae kw" href="https://aqicn.org/json-api/doc/" rel="noopener ugc nofollow" target="_blank"> WAQI API参考</a>并实现实用函数来完成这项工作。我们还可以定义额外的帮助函数，在这些函数中我们可以使用字符串插值方法，并可选地为WhatsApp 格式化消息。这些助手函数的实现可以在GitHub上的源代码中找到。</p><p id="9712" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://www.npmjs.com/package/dedent" rel="noopener ugc nofollow" target="_blank"> Dedent </a>在处理多行ES6 JavaScript模板文字时是一个有用的模块。您可能会发现它在源代码中被大量使用，以保持更好的可读性。</p><h1 id="e45f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">用Commander.js解析入站消息</h1><p id="021d" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">解析明确针对服务的消息并对不同的命令采取不同的操作是很有用的。最初为命令行应用程序构建的<a class="ae kw" href="https://github.com/tj/commander.js" rel="noopener ugc nofollow" target="_blank"> Commander.js </a>库可用于解析命令和参数的入站消息。</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="7da5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Commander.js库支持必需的和可选的参数、变量参数和命令别名，并且使任务比手动检查命令和参数容易得多。</p><h1 id="922a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">确保状态为Webhook的交货</h1><p id="0136" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们可以建立一个新的路由来监听我们在<code class="fe me mf mg mh b">/webhook/status</code>发送消息后发生的事件。确保您将此附加到<code class="fe me mf mg mh b">ngrok</code>隧道，并将其保存为Vonage API仪表板上的状态Webhook，然后单击“保存webhooks”。</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="c5a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下次我们的服务收到消息并回复它时，我们会观察到所发送消息的不同状态。<code class="fe me mf mg mh b">req.body.status</code>字段将包含发送webhook请求时消息对象转换到的状态。当Vonage服务器收到消息时，对象处于<code class="fe me mf mg mh b">submitted</code>状态。如果交付确实成功，我们应该收到一个状态值，可能是<code class="fe me mf mg mh b">delivered</code>后跟<code class="fe me mf mg mh b">read</code>。</p><p id="6e6c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果有错误，状态可能是<code class="fe me mf mg mh b">rejected</code>或<code class="fe me mf mg mh b">undeliverable</code>，理论上，我们可以单独处理这种情况。请注意，Vonage做了大量繁重的工作，在消息传递失败的情况下定期重试。</p><h1 id="7112" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">WhatsApp和Messenger游乐场</h1><p id="b491" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">确保应用程序正在运行，并且正确的<code class="fe me mf mg mh b">ngrok</code>隧道保存在消息沙箱中。拿起你的手机，发送信息到沙盒帐户。这东西真的能用的时候，感觉是不是很好？</p><h1 id="4758" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">WhatsApp</h1><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/4cbd85834366be5c9f278cca906959ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:930/1*NlTgKXNQoq3_XcUkJqZIww.gif"/></div></figure><h1 id="539f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">送信人；通信员</h1><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/efa8f0b5f9fbb509a2a6a1ee3e9739f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:930/1*k9_ZhN0B3zL0dI3gpYOSMw.gif"/></div></figure><h1 id="ff48" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">包扎</h1><p id="d6d1" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这个项目展示了Vonage APIs在集成几乎任何应用程序方面的灵活性。我们讨论了WhatsApp和Messenger的多渠道通信，并在本例中使用了WAQI APIs。我很好奇看完这篇文章后你会建造什么！</p><h1 id="de00" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">进一步阅读</h1><p id="f4de" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">你可以在<a class="ae kw" href="https://github.com/sudiptog81/vonage-aqi" rel="noopener ugc nofollow" target="_blank">GitHub库</a>上找到本教程中显示的代码和工作应用程序的完整源代码。</p><p id="652e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">务必在<a class="ae kw" href="https://developer.nexmo.com/messages/overview" rel="noopener ugc nofollow" target="_blank"> Vonage API开发者</a>和<a class="ae kw" href="https://developer.nexmo.com/api/messages-olympus" rel="noopener ugc nofollow" target="_blank"> Vonage API参考</a>上查看消息API的相关文档。进一步了解如何在Vonage API Developer上与<a class="ae kw" href="https://developer.nexmo.com/messages/concepts/whatsapp" rel="noopener ugc nofollow" target="_blank"> WhatsApp </a>和<a class="ae kw" href="https://developer.nexmo.com/messages/concepts/facebook" rel="noopener ugc nofollow" target="_blank"> Messenger </a>进行通信。</p><p id="054c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您没有Vonage帐户，<a class="ae kw" href="https://dashboard.nexmo.com/sign-up" rel="noopener ugc nofollow" target="_blank">现在就注册一个</a>以获得免费积分，并在您的下一个项目中使用Vonage APIs！在<a class="ae kw" href="https://twitter.com/VonageDev" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上联系我们，或者加入<a class="ae kw" href="https://developer.nexmo.com/community/slack" rel="noopener ugc nofollow" target="_blank">社区Slack频道</a>。让我们知道你打算用Vonage APIs构建什么！</p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><p id="67fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mn">最初发布于</em><a class="ae kw" href="https://learn.vonage.com/blog/2020/12/02/build-an-air-quality-reporting-service-with-messages-api" rel="noopener ugc nofollow" target="_blank"><em class="mn">https://learn . vonage . com/blog/2020/12/02/build-an-air-quality-reporting-service-with-messages-API</em></a></p></div></div>    
</body>
</html>