<html>
<head>
<title>Automating provisioning with Ansible — the basics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ansible自动化供应—基础知识</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/automating-provisioning-with-ansible-the-basics-b810c5bb92a9?source=collection_archive---------11-----------------------#2019-11-11">https://levelup.gitconnected.com/automating-provisioning-with-ansible-the-basics-b810c5bb92a9?source=collection_archive---------11-----------------------#2019-11-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="5411" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于我的项目，我经常需要一个干净的Linux盒子，它有一个定义好的状态，我可以用它来玩，如果我犯了一个错误，就简单地再次转储它。当然，我为此使用了云环境。然而，我经常发现自己登录到这些新创建的机器之一来手动执行安装。是时候学习如何实现自动化了。</p><h1 id="ee20" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">Ansible —基础知识</h1><p id="7669" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">Ansible是一个平台，旨在自动配置和安装虚拟机(或者更一般地说，任何类型的服务器，包括物理机甚至容器)。Ansible是无代理的，这意味着为了管理虚拟机，它不需要在该机器上安装任何特殊的代理。相反，它使用ssh来访问机器(在Linux / Unix世界中，而在Windows中，您将使用类似WinRM的东西)。</p><p id="2469" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您使用Ansible时，您在专用机器上运行Ansible引擎，在该机器上需要安装Ansible本身。这台机器叫做<strong class="js iu">控制机</strong>。从这个控制机器，你管理一个或多个<strong class="js iu">远程机器</strong>，称为<strong class="js iu">主机</strong>。Ansible将通过SSH连接到这些节点，并在那里执行所需的命令。Ansible需要它需要管理的所有主机的列表，这个列表被称为<strong class="js iu">清单</strong>。清单可以是静态的，即清单只是一个列出所有节点的文件，也可以是动态的，实现为提供JSON格式的节点列表并由Ansible调用的脚本，或者用Python编写的插件。这在将Ansible用于云环境时尤其有用，在云环境中，节点列表会随着节点的启动或关闭而发生变化。</p><p id="c587" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一天结束时，节点上“实际执行的事情”是一个Python脚本。这些脚本被称为Ansible <strong class="js iu">模块</strong>。您可能会问自己如何在节点上调用该模块。答案很简单——ansi ble将模块复制到节点，执行它，然后再次移除它。当您使用Ansible时，您为每个节点或节点组执行一列<strong class="js iu">任务</strong>，任务是对具有特定参数的模块的调用。</p><p id="8054" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">应用于特定节点组的任务序列称为<strong class="js iu">剧本</strong>，指定一组剧本的文件称为<strong class="js iu">剧本</strong>。因此，剧本允许您以可重复的方式将定义的模块调用序列应用于一组节点。行动手册只是YAML格式的普通文件，因此可以在版本控制下保存，并可以根据基础设施即代码的原则进行处理。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ls"><img src="../Images/df3cc4f9bcf989d02cf7855db2250af2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IQFkrXGifyaQXoF8"/></div></div></figure><h1 id="80c9" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">安装和第一步</h1><p id="560e" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">由于是无代理的，Ansible安装起来相当简单。事实上，Ansible是用Python编写的(社区版的源代码可以在<a class="ae lr" href="https://github.com/ansible/ansible" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到)，可以用</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="c41e" class="mj kp it mf b gy mk ml l mm mn">pip3 install --user ansible</span></pre><p id="8e97" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们需要一个主机。在这篇文章中，我在数字海洋上安装了一个主机。在我的例子中，主机被分配了IP地址134.209.240.213。我们需要将这个IP地址放入一个清单文件中，使它对Ansible可见。一个简单的清单文件(INI格式，也支持YAML)如下所示。</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="df0e" class="mj kp it mf b gy mk ml l mm mn">[servers] 134.209.240.213</span></pre><p id="f2af" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里，“服务器”是一个标签，如果我们需要管理具有不同配置文件的节点(例如web服务器、应用服务器或数据库服务器)，我们可以使用它来对节点进行分组。</p><p id="3f5d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通常情况下，您不会手动创建该文件。我们将在稍后的帖子中讨论动态库存，但目前，您可以使用我在DigitalOcean的早期帖子中使用的脚本的<a class="ae lr" href="https://github.com/christianb93/ansible-samples/blob/master/partI/create_droplet.sh" rel="noopener ugc nofollow" target="_blank">版本来自动供应液滴。该脚本启动一台机器，并将其添加到存储库文件hosts.ini中。</a></p><p id="097b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有了这个库存文件，我们就可以使用Ansible在这个节点上临时执行命令了。这里有一个简单的例子。</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="64fb" class="mj kp it mf b gy mk ml l mm mn">export ANSIBLE_HOST_KEY_CHECKING=False <br/>ansible -i hosts.ini \ <br/>  servers \ <br/>  -u root \ <br/>  --private-key ~/.ssh/do_k8s \ <br/>  -m ping</span></pre><p id="d9d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们一步步来看这个例子。首先，我们设置了一个环境变量，该变量在第一次连接到未知主机时阻止SSH主机密钥检查。接下来，我们调用ansible命令行客户端。第一个参数是库存文件的名称，在我们的例子中是<code class="fe mo mp mq mf b">host.ini</code>。第二个参数(<code class="fe mo mp mq mf b">servers</code>)指示Ansible仅对那些在我们的清单文件中带有标签<code class="fe mo mp mq mf b">servers</code>的主机运行我们的命令。这允许我们使用不同的节点配置文件，并对它们应用不同的命令。接下来，<code class="fe mo mp mq mf b">-u</code>交换机要求Ansible使用root用户连接到我们的主机(这是DigitalOcean上的默认ssh用户)。下一个开关指定存储私有主机密钥的文件，Ansible将使用该密钥连接到节点。</p><p id="d3b7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，开关<code class="fe mo mp mq mf b">-m</code>指定要使用的模块。对于这个例子，我们使用ping模块来尝试建立到主机的连接(您可以在这里查看这个模块的源代码<a class="ae lr" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/modules/system/ping.py" rel="noopener ugc nofollow" target="_blank"/>)。</p><p id="ae8c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">模块也可以接受参数。一个非常通用的模块是<code class="fe mo mp mq mf b">command</code>模块(如果没有指定模块，这实际上是默认的)。这个模块接受一个参数，它将简单地在节点上作为一个命令执行。例如，下面的代码片段在所有节点上执行<code class="fe mo mp mq mf b">uname -a</code>。</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="f09f" class="mj kp it mf b gy mk ml l mm mn">export ANSIBLE_HOST_KEY_CHECKING=False <br/>ansible -i hosts.ini \ <br/>servers \ <br/>-u root \ <br/>--private-key ~/.ssh/do_k8s \ <br/>-m command \ <br/>-a "uname -a"</span></pre><h1 id="165a" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">权限提升</h1><p id="1130" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">到目前为止，我们的例子都假设Ansible用来SSH到机器的用户拥有所有必需的特权，例如，运行<code class="fe mo mp mq mf b">apt</code>。在DigitalOcean上，标准用户是root，这种简单的方法在这里有效，但是在其他云环境中，比如EC2，情况就不同了。</p><p id="c315" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">假设我们已经使用Amazon Linux AMI创建了一个EC2实例(它有一个名为ec2-user的默认用户),并将它的IP地址添加到我们的hosts.ini文件中(当然，我已经编写了一个<a class="ae lr" href="https://github.com/christianb93/ansible-samples/blob/master/partI/create_ec2_instance.sh" rel="noopener ugc nofollow" target="_blank">脚本</a>来自动化这个操作)。我们还假设使用的SSH密钥名为ansibleTest，存储在目录<code class="fe mo mp mq mf b">~/.keys</code>中。然后，ping命令将如下所示。</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="d007" class="mj kp it mf b gy mk ml l mm mn">export ANSIBLE_HOST_KEY_CHECKING=False <br/>ansible -i hosts.ini \ <br/>servers \ <br/>-u ec2-user \ <br/>--private-key ~/.keys/ansibleTest.pem \ <br/>-m ping</span></pre><p id="4f61" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这实际上是可行的，但是如果我们想安装一个像Docker这样的包，这就变了。我们将在下一篇文章中了解更多关于软件包安装和状态的信息，但是实际安装软件包的命令应该如下所示。</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="01a5" class="mj kp it mf b gy mk ml l mm mn">export ANSIBLE_HOST_KEY_CHECKING=False <br/>ansible -i hosts.ini \ <br/>servers \ <br/>-u ec2-user \ <br/>--private-key ~/.keys/ansibleTest.pem \ <br/>-m yum -a 'name=docker state=present'</span></pre><p id="2d29" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里，我们使用yum模块，它能够利用Amazon Linux使用的YUM包管理器来安装、升级、删除和管理包。但是，这将会失败，您将会收到一条类似“您需要成为root用户才能执行此命令”的消息。发生这种情况是因为Ansible将使用ec2_user通过SSH进入您的机器，默认情况下，这个用户没有运行yum所需的权限。</p><p id="c30e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在命令行上，你当然可以使用<code class="fe mo mp mq mf b">sudo</code>来解决这个问题。为了指示Ansible这样做，我们必须在命令中添加开关-b。Ansible将使用sudo以root用户身份执行模块。</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="9191" class="mj kp it mf b gy mk ml l mm mn">export ANSIBLE_HOST_KEY_CHECKING=False <br/>ansible -i hosts.ini \ <br/>servers \ <br/>-b \ <br/>-u ec2-user \ <br/>--private-key ~/.keys/ansibleTest.pem \ <br/>-m yum -a 'name=docker state=present'</span></pre><p id="b52a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">附加参数<code class="fe mo mp mq mf b">-become-user</code>可用于控制Ansible将使用哪个用户来运行操作。缺省值是root，但是也可以使用任何其他用户(当然，假设用户拥有相应命令所需的特权)。</p><p id="eb43" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的例子看起来仍然像是可以用简单的shell脚本轻松完成的事情，在一个清单文件中遍历所有主机并调用一个ssh命令。然而，当我们在本系列的下一篇文章<a class="ae lr" href="https://leftasexercise.com/2019/11/18/automating-provisioning-with-ansible-using-modules/" rel="noopener ugc nofollow" target="_blank">中开始讨论模块时，Ansible的真正威力就变得显而易见了。</a></p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><p id="cd68" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="my">原载于2019年11月11日</em><a class="ae lr" href="https://leftasexercise.com/2019/11/11/automating-provisioning-with-ansible-part-i/" rel="noopener ugc nofollow" target="_blank"><em class="my">【http://leftasexercise.com】</em></a><em class="my">。</em></p></div></div>    
</body>
</html>