<html>
<head>
<title>Build an Xbox Controller Abstraction Layer in Python Using XInput API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用XInput API在Python中构建一个Xbox控制器抽象层</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/build-an-xbox-controller-abstraction-layer-in-python-using-xinput-api-f6d0c716adf?source=collection_archive---------3-----------------------#2020-12-10">https://levelup.gitconnected.com/build-an-xbox-controller-abstraction-layer-in-python-using-xinput-api-f6d0c716adf?source=collection_archive---------3-----------------------#2020-12-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8f45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者:如何用夸张的代码量实现简单的目标—第1部分</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/bc199815b2922bfaf7f5020f03bf72b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*D0hU19YEPy_bXGw3"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/@16bitspixelz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Kamil S </a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="67eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我曾经想过:输入——输出。按下游戏手柄按钮Python中的动作。<em class="lc">简单地说就是控制器映射</em>。概念上——是的。就是这么简单。但是，因为您使用XInput API与控制器交互，所以事情变得复杂了。毫不奇怪。你使用一个系统DLL，大概是通过<a class="ae lb" href="https://docs.python.org/3/library/ctypes.html" rel="noopener ugc nofollow" target="_blank"> ctypes </a>库，这意味着不同于Python原生的数据类型。当然，Microsoft API提供了一些方便的函数，在本教程中您将使用其中的两个，但是您使用C指针与它们进行交互。这样的例子不胜枚举。</p><p id="180a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在硬币的另一面，可能看起来令人讨厌的只是ctypes代码。幸运的是，你很早就将其抽象出来，然后开始解决实际问题。这是非常低级的东西，所以你需要执行一些繁琐的任务，但这是可以管理的。当你看到你的电脑收到输入并准备好处理它时，真的很有趣。希望你也会喜欢！</p></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h1 id="a779" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">实现XInput API</h1><p id="4fdc" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">您要做的第一件事是实现<a class="ae lb" href="https://docs.microsoft.com/en-us/windows/win32/xinput/xinput-game-controller-apis-portal" rel="noopener ugc nofollow" target="_blank"> XInput API </a>所需的类。您将定义三个类:</p><ul class=""><li id="5ae5" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk ms mt mu mv bi translated"><code class="fe mw mx my mz b">XInputGamepad</code> —控制器的实际状态。</li><li id="3e4a" class="mn mo iq jp b jq na ju nb jy nc kc nd kg ne kk ms mt mu mv bi translated"><code class="fe mw mx my mz b">XInputState</code> —控制者声称的状态。</li><li id="fd6a" class="mn mo iq jp b jq na ju nb jy nc kc nd kg ne kk ms mt mu mv bi translated"><code class="fe mw mx my mz b">XInputVibration</code> —马达的速度。</li></ul><p id="dc5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们把它们分解一下。</p><h2 id="f12c" class="nf ll iq bd lm ng nh dn lq ni nj dp lu jy nk nl ly kc nm nn mc kg no np mg nq bi translated"><a class="ae lb" href="https://docs.microsoft.com/en-us/windows/win32/api/xinput/ns-xinput-xinput_gamepad#syntax" rel="noopener ugc nofollow" target="_blank"> XInputGamepad </a></h2><p id="0126" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">一个<em class="lc">事实上的</em>控制器状态类:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nr ns l"/></div></figure><ul class=""><li id="a5e7" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk ms mt mu mv bi translated"><code class="fe mw mx my mz b">XInputGamepad</code>类继承自<code class="fe mw mx my mz b">Structure</code>类。这意味着我们在Python中的类应该被当作一个<code class="fe mw mx my mz b">struct</code>。</li><li id="312d" class="mn mo iq jp b jq na ju nb jy nc kc nd kg ne kk ms mt mu mv bi translated">定义<code class="fe mw mx my mz b">_fields_</code>变量。它包含结构的字段。如您所见，它们是元组——变量名及其类型。它们都是整数。</li></ul><p id="6839" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如文档中所述，它是以下C <code class="fe mw mx my mz b">struct</code>的直接映射:</p><pre class="km kn ko kp gt nt mz nu nv aw nw bi"><span id="28ad" class="nf ll iq mz b gy nx ny l nz oa">struct _XINPUT_GAMEPAD {<br/>  WORD  wButtons;<br/>  BYTE  bLeftTrigger;<br/>  BYTE  bRightTrigger;<br/>  SHORT sThumbLX;<br/>  SHORT sThumbLY;<br/>  SHORT sThumbRX;<br/>  SHORT sThumbRY;<br/>}</span></pre><p id="c3f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我认为理解<code class="fe mw mx my mz b">struct</code>概念最简单的方法是把它看作一个没有方法的类——只有变量。如果您将它定义为一个Python类，它将如下所示:</p><pre class="km kn ko kp gt nt mz nu nv aw nw bi"><span id="e822" class="nf ll iq mz b gy nx ny l nz oa">class XInputGamepad:<br/>    buttons: int<br/>    left_trigger: int<br/>    right_trigger: int<br/>    thumb_l_x: int<br/>    thumb_l_y: int<br/>    thumb_r_x: int<br/>    thumb_r_y: int</span></pre><p id="1349" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不会一直这么默默无闻。很快您将编写一些抽象层，使与XInput API的交互更加合理。</p></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h2 id="9c2d" class="nf ll iq bd lm ng nh dn lq ni nj dp lu jy nk nl ly kc nm nn mc kg no np mg nq bi translated"><a class="ae lb" href="https://docs.microsoft.com/en-us/windows/win32/api/xinput/ns-xinput-xinput_state" rel="noopener ugc nofollow" target="_blank">新输入状态</a></h2><p id="2e76" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">表示控制器状态的类。它基本上是<code class="fe mw mx my mz b">XInputGamepad</code>，但是有一个字段指示状态已经改变:</p><pre class="km kn ko kp gt nt mz nu nv aw nw bi"><span id="8019" class="nf ll iq mz b gy nx ny l nz oa">class XInputState(ctypes.Structure):<br/>    _fields_ = [<br/>        ('dwPacketNumber', ctypes.wintypes.DWORD),<br/>        ('Gamepad', XInputGamepad),<br/>    ]</span></pre><ul class=""><li id="45ac" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk ms mt mu mv bi translated">基本上和前面的类一样，唯一的不同是<code class="fe mw mx my mz b">Gamepad</code>字段是一个你之前定义过的结构。</li><li id="996b" class="mn mo iq jp b jq na ju nb jy nc kc nd kg ne kk ms mt mu mv bi translated"><code class="fe mw mx my mz b">dwPacketNumber</code>表示状态可能已经改变。</li></ul></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h2 id="ee77" class="nf ll iq bd lm ng nh dn lq ni nj dp lu jy nk nl ly kc nm nn mc kg no np mg nq bi translated"><a class="ae lb" href="https://docs.microsoft.com/en-us/windows/win32/api/xinput/ns-xinput-xinput_vibration" rel="noopener ugc nofollow" target="_blank"> XInputVibrations </a></h2><p id="b110" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">振动，顾名思义:</p><pre class="km kn ko kp gt nt mz nu nv aw nw bi"><span id="c275" class="nf ll iq mz b gy nx ny l nz oa">class XInputVibration(ctypes.Structure):<br/>    _fields_ = [<br/>        ('wLeftMotorSpeed', ctypes.wintypes.WORD),<br/>        ('wRightMotorSpeed', ctypes.wintypes.WORD)<br/>    ]</span></pre><ul class=""><li id="76a4" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk ms mt mu mv bi translated">Xbox游戏手柄有两个马达——左马达和右马达。他们独立工作。</li><li id="b197" class="mn mo iq jp b jq na ju nb jy nc kc nd kg ne kk ms mt mu mv bi translated">每个变量指定使用哪个马达。它们代表振动强度。</li></ul><p id="61d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们好好利用前面提到的类。</p></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h1 id="c3ca" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">获取输入</h1><p id="2ee1" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">你马上就会抛弃这些代码，但是看看它是否有效还是很好的。暂时不要创建任何函数。只需在<code class="fe mw mx my mz b">__main__</code>街区检查一下:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nr ns l"/></div></figure><ul class=""><li id="549a" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk ms mt mu mv bi translated">使用<code class="fe mw mx my mz b">ctypes</code>导入XInput <code class="fe mw mx my mz b">api</code>。</li><li id="4ecd" class="mn mo iq jp b jq na ju nb jy nc kc nd kg ne kk ms mt mu mv bi translated">定义控制器<code class="fe mw mx my mz b">state</code>。这是你一会儿要用到的一个函数所需要的。你现在还不知道状态。</li><li id="86b6" class="mn mo iq jp b jq na ju nb jy nc kc nd kg ne kk ms mt mu mv bi translated">如果连接了几个控制器，请在0-3的范围内指定要使用的控制器。如果只连接了一个控制器，它应该默认为<code class="fe mw mx my mz b">0</code>。</li><li id="9628" class="mn mo iq jp b jq na ju nb jy nc kc nd kg ne kk ms mt mu mv bi translated">在一个循环中获取状态，提供<code class="fe mw mx my mz b">gamepad_number</code>和一个指向<code class="fe mw mx my mz b">state</code>的指针。</li><li id="0f08" class="mn mo iq jp b jq na ju nb jy nc kc nd kg ne kk ms mt mu mv bi translated"><code class="fe mw mx my mz b">print</code>一个<code class="fe mw mx my mz b">dwPacketNumber</code>变量，指示控制器状态是否已经改变。</li><li id="46d5" class="mn mo iq jp b jq na ju nb jy nc kc nd kg ne kk ms mt mu mv bi translated"><code class="fe mw mx my mz b">sleep</code>，然后清除(<code class="fe mw mx my mz b">cls</code>)屏幕，使其可读。</li></ul><p id="889c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了这个，你就可以连接你的Xbox控制器并启动脚本了。首先，让我们将它保存为<code class="fe mw mx my mz b">xinput.py</code>，这样就可以用下面的命令运行它:</p><pre class="km kn ko kp gt nt mz nu nv aw nw bi"><span id="453c" class="nf ll iq mz b gy nx ny l nz oa">python xinput.py</span></pre><p id="61b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你会看到一个随机数。如果你操作控制器的时候它改变了，那一切都没问题。您可以删除<code class="fe mw mx my mz b">__main__</code>块内容，并移动到教程的<a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/build-an-xbox-controller-abstraction-layer-in-python-using-xinput-api-aaf0f8d05ac2">下一部分</a>。</p></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h1 id="6abe" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated"><strong class="ak">最后的话(目前)</strong></h1><p id="5d86" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">感谢阅读！</p><p id="f7f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在我的<a class="ae lb" href="https://github.com/izdwuut/xbox-mapper-tutorial/tree/main" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到完整的代码。</p></div></div>    
</body>
</html>