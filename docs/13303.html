<html>
<head>
<title>Kafka in Machine Learning for Real-time Predictions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于实时预测的机器学习中的卡夫卡</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/kafka-in-machine-learning-for-real-time-predictions-45a4adf4620b?source=collection_archive---------0-----------------------#2022-08-25">https://levelup.gitconnected.com/kafka-in-machine-learning-for-real-time-predictions-45a4adf4620b?source=collection_archive---------0-----------------------#2022-08-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e99e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用scikit运行Kafka学习实时应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/01f838e7c4967b09cfb71611aac68f27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*DiaawVMptg8Sf07A.png"/></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">来源:<a class="ae ku" href="https://www.confluent.io/blog/author/martin-kleppmann/" rel="noopener ugc nofollow" target="_blank">https://www.confluent.io/blog/author/martin-kleppmann/</a></figcaption></figure><p id="9bb6" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在我们的<a class="ae ku" href="https://betterprogramming.pub/kafka-with-python-how-to-get-your-projects-up-and-running-34bc58c46652" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>中，我们介绍了Apache Kafka的主要元素和功能，并看到了Kafka如何与Python API<a class="ae ku" href="https://github.com/confluentinc/confluent-kafka-python" rel="noopener ugc nofollow" target="_blank">confluent-Kafka</a>一起使用。在本文中，我们将重点讨论如何将Kafka应用于机器学习项目中的训练和预测。</p><p id="94b1" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">为此，我们将使用以前文章中的模型，在这些文章中，我们建立了回归模型，根据西班牙葡萄酒的种类、地区、年份、类型、酸度等来预测其价格。我们将把这个项目作为基线。</p><div class="lr ls gp gr lt lu"><a href="https://betterprogramming.pub/build-production-ready-ml-workflow-with-dvc-and-s3-cdd9c95bf19" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd iu gy z fp lz fr fs ma fu fw is bi translated">与DVC和S3一起构建生产就绪的ML工作流</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">DVC:和Git一样，只是数据不同</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">better编程. pub</p></div></div><div class="md l"><div class="me l mf mg mh md mi ko lu"/></div></div></a></div><p id="e0e5" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">工作流程将如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mj"><img src="../Images/1c02ee75728e71737db98b58b56a834e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_jndABzaQwYzfJnm9nm0Cw.png"/></div></div></figure><ul class=""><li id="10c3" class="mo mp it kx b ky kz lb lc le mq li mr lm ms lq mt mu mv mw bi translated">在<a class="ae ku" href="https://confluent.cloud/home" rel="noopener ugc nofollow" target="_blank">汇流云中运行Kafka集群</a>。创建远程主题:<code class="fe mx my mz na b">train</code>和<code class="fe mx my mz na b">app_messages</code>。</li><li id="3538" class="mo mp it kx b ky nb lb nc le nd li ne lm nf lq mt mu mv mw bi translated">运行<code class="fe mx my mz na b">trainer.py</code>中的Kafka Producer，将经过训练的模型的路径信息写入主题<code class="fe mx my mz na b">train</code>。</li><li id="c167" class="mo mp it kx b ky nb lb nc le nd li ne lm nf lq mt mu mv mw bi translated">把训练好的模型写给S3。</li><li id="54b5" class="mo mp it kx b ky nb lb nc le nd li ne lm nf lq mt mu mv mw bi translated">在<code class="fe mx my mz na b">predictor.py</code>经营卡夫卡生产者和消费者。这里我们会做预测，并写进题目<code class="fe mx my mz na b">app_messages</code>。</li></ul><p id="d254" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们在关于Kafka的第一篇文章中讨论了安装<a class="ae ku" href="https://docs.confluent.io/confluent-cli/current/overview.html" rel="noopener ugc nofollow" target="_blank">Confluent-CLI</a>、设置融合云帐户以及创建Kafka集群和主题。Kafka集群配置的以下工作将基于它，因此我鼓励您提前尝试本教程。</p><div class="lr ls gp gr lt lu"><a href="https://betterprogramming.pub/kafka-with-python-how-to-get-your-projects-up-and-running-34bc58c46652" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd iu gy z fp lz fr fs ma fu fw is bi translated">使用Python的Kafka:如何启动和运行您的项目</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">使用Kafka运行流式作业</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">better编程. pub</p></div></div><div class="md l"><div class="ng l mf mg mh md mi ko lu"/></div></div></a></div><p id="e314" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们应该添加到<code class="fe mx my mz na b">params.py</code>类来读取Kafka Broker和Consumer所必需的参数。这里我们添加了新的类<code class="fe mx my mz na b">KafkaConsumerParams</code>、<code class="fe mx my mz na b">KafkaBrokerParams</code>和<code class="fe mx my mz na b">KafkaParams</code>来设置服务器、安全协议和融合云凭证。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="b986" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">从<code class="fe mx my mz na b">kafka_config.yaml</code>中定义并读取参数值。在初始化消费者时，我们指定<code class="fe mx my mz na b">group.id</code>我们的消费者所属的消费者组。<code class="fe mx my mz na b">auto.offset.reset</code>指定如果分区没有提交的偏移量或者提交的偏移量无效，使用者应该从哪个偏移量开始读取。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="e988" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在，当Kafka集群的配置设置好后，我们可以在训练后使用生成器来编写模型参考。我们将以培训日期的形式书写模型路径，例如<code class="fe mx my mz na b">models/2022-08-19.pkl</code>。为了将<code class="fe mx my mz na b">.pkl</code>写入S3存储，我们使用了针对Python的AWS SDK <a class="ae ku" href="https://github.com/boto/boto3" rel="noopener ugc nofollow" target="_blank"> boto3 </a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="d9a3" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">培训结束后，我们将模型写入<code class="fe mx my mz na b">wines_models</code> S3铲斗。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nj"><img src="../Images/79e4d108883cdc25a2701248d33e1cdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lYXswNSkLixGim4NMwFsEg.png"/></div></div></figure><p id="f53a" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们实现了<code class="fe mx my mz na b">trainer.py</code>，在模型训练之后，我们用<code class="fe mx my mz na b">kafka_config.yaml</code>中定义的参数字典初始化一个生产者。为了向Kafka发送消息，我们调用<code class="fe mx my mz na b">producer.produce</code>方法，传递主题<code class="fe mx my mz na b">train</code>和消息键，值对。它将消息排队进行批处理、压缩和传输到代理。在这里，我们还使用<code class="fe mx my mz na b">flush</code>方法在关闭生产者之前进行同步写入，以确保所有排队的消息都被传递。因为我们不需要高吞吐量，所以保持高吞吐量是可以的，但是当应用程序需要写入大量数据时，就不应该使用高吞吐量。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="3bef" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">写完之后，我们可以在融合云中可视化<code class="fe mx my mz na b">train</code>主题中的消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nk"><img src="../Images/515617edacb07e7e68a3f53ca5a0141f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DycbQBtYOLeRJmNfSAwMiw.png"/></div></div></figure><p id="57e9" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><code class="fe mx my mz na b">predictor.py</code>代码如下所示。这里，生成器的配置与<code class="fe mx my mz na b">train.py</code>类似，但用于将预测写入<code class="fe mx my mz na b">app_messages</code>主题。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="ea32" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">下面的代码片段显示了一个消费者循环，它重复调用<code class="fe mx my mz na b">poll</code>方法来逐个检索记录。使用<code class="fe mx my mz na b">consumer.subscribe</code>,我们指定要从中获取的主题<code class="fe mx my mz na b">app_messages</code>。轮询超时设置为1秒，即如果在超时到期前没有收到记录，<code class="fe mx my mz na b">poll</code>将返回一个空记录集。我们还应该调用<code class="fe mx my mz na b">consumer.close</code>,因为它确保活动套接字被关闭，内部状态被清除。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="f152" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在运行<code class="fe mx my mz na b">predictor.py</code>之后，我们还可以可视化融合云的<code class="fe mx my mz na b">app_messages</code>主题中的消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nl"><img src="../Images/8cf82a5f276bdd6fb531b0bfa5537066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k2W6eZ8lYrfelnr6HWpwvw.png"/></div></div></figure><h2 id="4b04" class="nm nn it bd no np nq dn nr ns nt dp nu le nv nw nx li ny nz oa lm ob oc od oe bi translated">最后的想法</h2><p id="07cb" class="pw-post-body-paragraph kv kw it kx b ky of ju la lb og jx ld le oh lg lh li oi lk ll lm oj lo lp lq im bi translated">在本文中，我们将机器学习管道与Kafka集成在一起，并通过融合云在远程服务器上序列化Kafka主题中的训练结果和预测。您的应用程序可以进一步实时使用发布的消息。</p><p id="bdd1" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我将非常感谢你在下面评论区的反馈！</p><h2 id="8d3c" class="nm nn it bd no np nq dn nr ns nt dp nu le nv nw nx li ny nz oa lm ob oc od oe bi translated">链接</h2><ul class=""><li id="24d2" class="mo mp it kx b ky of lb og le ok li ol lm om lq mt mu mv mw bi translated"><a class="ae ku" href="https://docs.confluent.io/kafka-clients/python/current/overview.html" rel="noopener ugc nofollow" target="_blank">https://docs . confluent . io/Kafka-clients/python/current/overview . html</a></li><li id="4aaf" class="mo mp it kx b ky nb lb nc le nd li ne lm nf lq mt mu mv mw bi translated">【https://github.com/confluentinc/confluent-kafka-python T4】</li><li id="a744" class="mo mp it kx b ky nb lb nc le nd li ne lm nf lq mt mu mv mw bi translated"><a class="ae ku" href="https://github.com/EvgeniiMunin/dvc-art-minio" rel="noopener ugc nofollow" target="_blank">https://github.com/EvgeniiMunin/dvc-art-minio</a></li></ul><div class="lr ls gp gr lt lu"><a href="https://betterprogramming.pub/kafka-with-python-how-to-get-your-projects-up-and-running-34bc58c46652" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd iu gy z fp lz fr fs ma fu fw is bi translated">使用Python的Kafka:如何启动和运行您的项目</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">使用Kafka运行流式作业</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">better编程. pub</p></div></div><div class="md l"><div class="ng l mf mg mh md mi ko lu"/></div></div></a></div><div class="lr ls gp gr lt lu"><a href="https://betterprogramming.pub/build-production-ready-ml-workflow-with-dvc-and-s3-cdd9c95bf19" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd iu gy z fp lz fr fs ma fu fw is bi translated">与DVC和S3一起构建生产就绪的ML工作流</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">DVC:和Git一样，只是数据不同</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">better编程. pub</p></div></div><div class="md l"><div class="me l mf mg mh md mi ko lu"/></div></div></a></div></div><div class="ab cl on oo hx op" role="separator"><span class="oq bw bk or os ot"/><span class="oq bw bk or os ot"/><span class="oq bw bk or os"/></div><div class="im in io ip iq"><h1 id="1dcd" class="ou nn it bd no ov ow ox nr oy oz pa nu jz pb ka nx kc pc kd oa kf pd kg od pe bi translated">分级编码</h1><p id="eef7" class="pw-post-body-paragraph kv kw it kx b ky of ju la lb og jx ld le oh lg lh li oi lk ll lm oj lo lp lq im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="1644" class="mo mp it kx b ky kz lb lc le mq li mr lm ms lq mt mu mv mw bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="1cc1" class="mo mp it kx b ky nb lb nc le nd li ne lm nf lq mt mu mv mw bi translated">📰查看<a class="ae ku" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="bc1e" class="mo mp it kx b ky nb lb nc le nd li ne lm nf lq mt mu mv mw bi translated">🔔关注我们:<a class="ae ku" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae ku" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae ku" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="30be" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">🚀👉<a class="ae ku" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kx iu">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>