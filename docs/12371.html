<html>
<head>
<title>I wrote my first CI pipeline with dagger</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我用dagger写了我的第一个CI管道</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/i-wrote-my-first-ci-pipeline-with-dagger-d78f391e1f5e?source=collection_archive---------12-----------------------#2022-06-05">https://levelup.gitconnected.com/i-wrote-my-first-ci-pipeline-with-dagger-d78f391e1f5e?source=collection_archive---------12-----------------------#2022-06-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4fa0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Docker的创作者发起的项目最近随着他们的公开测试版的宣布达到了一个新的里程碑。现在它是公开的了，我们可以用这个有前途的CI/CD工具玩一玩了。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/4d9973416d9dee9baa85b1e06a0bed31.png" data-original-src="https://miro.medium.com/v2/resize:fit:584/format:webp/1*3r0dWMOFQcAOgTjN-Qv9xQ.png"/></div></figure><p id="7333" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">免责声明#1:这篇文章的目的是提供建设性的和客观的批评。我不想低估贡献者的工作。我做不到他们所做的百分之一。我非常尊重他们对这个项目的承诺。</p><p id="4075" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><em class="lj">免责声明#2:我选择用一个例子来说明这篇文章。作为一个匕首新手，我很确定还有提升的空间。但是它是有效的，目的是通过一个例子来介绍这些概念。优化以后再来。</em></p></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><p id="aee1" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">几周前，由Docker创始人创办的dagger公司宣布，他们筹集了2000万美元来加快产品开发。他们的使命:<strong class="kp ir">简化应用部署体验</strong>。有了这样的标语，他们引起了我的注意！</p><p id="1118" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">那么匕首是什么？</p><p id="328f" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Dagger带来了创建CI/CD管道的新方法。它提供了以下好处:</p><ul class=""><li id="2bd1" class="lr ls iq kp b kq kr kt ku kw lt la lu le lv li lw lx ly lz bi translated"><strong class="kp ir">统一开发和CI环境</strong>。使用Dagger，您可以在本地运行您的管道！</li><li id="89c2" class="lr ls iq kp b kq ma kt mb kw mc la md le me li lw lx ly lz bi translated"><strong class="kp ir">减少CI锁定</strong>。无论您是使用GitHub Actions、GitLab CI还是任何其他CI运行程序运行CI/CD管道，代码都是相同的。</li></ul><p id="e298" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">随着一组可重用包的引入，目标也是有利于开发人员的速度。</p><p id="6154" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果你还不知道匕首，我会掩护你。我将首先展示一个真实世界的用例。因此，您将为工具的审查做好准备。</p><p id="acaa" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这篇文章的结尾，你将有望对dagger有更多的了解，并对这个项目目前的状况有所了解。</p><h1 id="b68f" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">在简单用例上测试Dagger</h1><p id="50c9" class="pw-post-body-paragraph kn ko iq kp b kq mx jr ks kt my ju kv kw mz ky kz la na lc ld le nb lg lh li ij bi translated">当我测试新工具时，我喜欢把手弄脏。我的用例很简单:<strong class="kp ir">用GitHub Actions </strong>在Rust项目上运行测试。</p><p id="997c" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">一旦建立了环境，所有项目的流程几乎都是一样的:</p><ol class=""><li id="b0eb" class="lr ls iq kp b kq kr kt ku kw lt la lu le lv li nc lx ly lz bi translated">定义你的行动，并将它们添加到你的计划中。行动是管道的组成部分。</li><li id="b72d" class="lr ls iq kp b kq ma kt mb kw mc la md le me li nc lx ly lz bi translated">确保可以通过CLI发现您的操作。</li><li id="ae1f" class="lr ls iq kp b kq ma kt mb kw mc la md le me li nc lx ly lz bi translated">在本地执行您的操作。</li><li id="e382" class="lr ls iq kp b kq ma kt mb kw mc la md le me li nc lx ly lz bi translated">部署到您的远程CI运行程序。</li></ol><p id="d1a0" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在我的例子中，没有任何针对rust的包，无论是内置的还是来自社区的。因此，我不得不使用docker包来建立一个可重现的环境并运行我的测试套件。</p><p id="c618" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了配置动作，dagger利用了一种叫做<strong class="kp ir"> CUE </strong>的语言。我的配置如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="c110" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我现在可以运行我的操作了。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="8ada" class="nk mg iq ng b gy nl nm l nn no">dagger do test</span></pre><p id="60a3" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">所有测试都通过了。我现在可以部署到GitHub Actions。dagger的团队友好地创建了一个我们可以重用的GitHub动作，这使得过渡非常平稳。</p><p id="58a8" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我的配置文件很简单。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="857d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">就是这样！我有一个管道，只要我一推出新的变更，它就执行我的测试。</p><p id="a2bc" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在它起作用了，是时候后退一步，对dagger进行批判性的审视了。</p><h1 id="c26d" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">我真正喜欢的</h1><h2 id="0b19" class="nk mg iq bd mh np nq dn ml nr ns dp mp kw nt nu mr la nv nw mt le nx ny mv nz bi translated">CUE，一种超级配置语言</h2><p id="04a8" class="pw-post-body-paragraph kn ko iq kp b kq mx jr ks kt my ju kv kw mz ky kz la na lc ld le nb lg lh li ij bi translated">我喜欢匕首的第一点:<strong class="kp ir"> CUE </strong>！这是一个奇妙的发现。我以前不懂这种语言，但我立刻就爱上了它。这是团队做出的一个伟大的设计选择。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/9b60f4f4af24ca403b20bd63f9315e7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/format:webp/1*kFrcvDxpqacABP1aeuvc7w.png"/></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated">提示官方标志</figcaption></figure><p id="4ed7" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">CUE是一种<strong class="kp ir">配置语言</strong>。将其视为YAML和JSON的替代品。它实际上是JSON的超集。</p><p id="d611" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">以下内置特性尤其引起了我的兴趣:</p><ul class=""><li id="4816" class="lr ls iq kp b kq kr kt ku kw lt la lu le lv li lw lx ly lz bi translated"><strong class="kp ir">包管理</strong>:你可以通过一个包系统轻松地重用样板代码</li><li id="3af9" class="lr ls iq kp b kq ma kt mb kw mc la md le me li lw lx ly lz bi translated"><strong class="kp ir">类型检查</strong></li><li id="5396" class="lr ls iq kp b kq ma kt mb kw mc la md le me li lw lx ly lz bi translated"><strong class="kp ir">模式实施</strong>:您可以定义一个模式，并根据它验证您的数据。你的数据甚至可以是YAML文件或JSON文件！</li><li id="8567" class="lr ls iq kp b kq ma kt mb kw mc la md le me li lw lx ly lz bi translated"><strong class="kp ir">一个内置的开发工具链</strong>:你可以下载<code class="fe of og oh ng b">cue</code>二进制文件，它将允许你验证你的模式和格式化你的文件</li></ul><p id="d90b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">关于CUE还有很多要说的，但我需要抑制我的热情，因为它不是今天的话题。😇</p><h2 id="a0e3" class="nk mg iq bd mh np nq dn ml nr ns dp mp kw nt nu mr la nv nw mt le nx ny mv nz bi translated">DAG自动生成和缓存</h2><p id="0e57" class="pw-post-body-paragraph kn ko iq kp b kq mx jr ks kt my ju kv kw mz ky kz la na lc ld le nb lg lh li ij bi translated">我发现dagger动作之间的依赖管理做得很好。它构建了一个<strong class="kp ir">有向无环图(DAG) </strong>而不需要您明确定义DAG运行动作的顺序。</p><p id="0198" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在我的例子中，当我运行<code class="fe of og oh ng b">dagger do test</code>时，它也会因为<code class="fe of og oh ng b">input: deps.output</code>参数而运行<code class="fe of og oh ng b">deps</code>动作。dagger检测到一个依赖项，并将按照正确的顺序执行动作。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/f80a451b1f0aaa2cae10e114c48dc252.png" data-original-src="https://miro.medium.com/v2/resize:fit:216/format:webp/1*U1vb4cpArrQlAlXoIkL5lg.png"/></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated">表示我的管道步骤的DAG</figcaption></figure><p id="ac03" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">乍一看，您可能认为CUE文件与Makefile非常相似。但是隐式任务依赖管理是两者之间的一个关键区别。</p><p id="2475" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">另一个区别是缓存系统。匕首将藏物存放在一个缓存中。因此，如果代码中只有很小的变化，就不需要运行整个管道。</p><h2 id="8b2a" class="nk mg iq bd mh np nq dn ml nr ns dp mp kw nt nu mr la nv nw mt le nx ny mv nz bi translated">来自宇宙的可重复使用的包</h2><p id="0ebc" class="pw-post-body-paragraph kn ko iq kp b kq mx jr ks kt my ju kv kw mz ky kz la na lc ld le nb lg lh li ij bi translated">dagger提供了一组有限的核心动作。但是您可以依赖一组包含更多操作的包。这套包叫宇宙。</p><p id="683f" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">因此，您可以混合使用核心动作和外部包中的动作来创建自己的动作。</p><p id="54da" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">虽然这个数字目前还很有限，但是一旦社区做出贡献，它将会扩大规模。</p><h1 id="4f84" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">是什么让我保持怀疑</h1><p id="f3ef" class="pw-post-body-paragraph kn ko iq kp b kq mx jr ks kt my ju kv kw mz ky kz la na lc ld le nb lg lh li ij bi translated">你和dagger合作得越多，你就越能看到它的潜力。然而，dagger仍然是一个新生的项目，因此，还有许多工作要做。</p><h2 id="c324" class="nk mg iq bd mh np nq dn ml nr ns dp mp kw nt nu mr la nv nw mt le nx ny mv nz bi translated">开发者体验还不完美</h2><p id="3621" class="pw-post-body-paragraph kn ko iq kp b kq mx jr ks kt my ju kv kw mz ky kz la na lc ld le nb lg lh li ij bi translated">作为一个匕首新手，我先看了官方文档。老实说，入职并不顺利。一些代码片段不起作用。内容组织得不是很好。例如，文档在用户指南旁边包含投稿指南。此外，来自宇宙的包根本没有文档，所以你需要去找代码(幸运的是它是开源的😅)获取您需要的信息。</p><p id="1aa9" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">维护人员意识到了这个问题，因为有一个技术作家的职位空缺。社区还写了几期GitHub。</p><p id="b1f6" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">文件很难</strong>。这是一份全职工作。随着事物的快速变化，保持信息的更新是一个巨大的挑战。因此，祝贺团队尽了最大努力！我希望我有时间帮助他们改进入职流程。</p><p id="97ec" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">除了缺少文档之外，我还在开发人员界面<strong class="kp ir">上花了点功夫，尤其是CLI和使用CUE定义动作的标准。术语有时令人困惑。项目和计划之间的区别并不清楚。配置文件的某些部分是反直觉的，比如客户端部分。</strong></p><p id="6870" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">CLI设计可以改进。以下是运行help命令时得到的结果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ok ol di om bf on"><div class="gh gi oj"><img src="../Images/10eb51327dafa279bc705bd157d02a99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m-bdoSHnr9voxwNwKT72bw.png"/></div></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated">匕首帮助命令输出</figcaption></figure><p id="df9a" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">有像<code class="fe of og oh ng b">do</code>这样的动词和像<code class="fe of og oh ng b">project</code>这样的名词。但是当你运行<code class="fe of og oh ng b">dagger project</code>时，子命令是动词。我不知道这些选择背后的原因，但我梦想有一个更好的界面。</p><p id="717b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我花了一些时间浏览GitHub上的公开问题，我发现他们对界面想了很多。我们仍处于项目的开始阶段，这是进行结构性变革的最佳时机。</p><h2 id="3080" class="nk mg iq bd mh np nq dn ml nr ns dp mp kw nt nu mr la nv nw mt le nx ny mv nz bi translated">许多CI运行程序和语言还不被支持</h2><p id="1f3b" class="pw-post-body-paragraph kn ko iq kp b kq mx jr ks kt my ju kv kw mz ky kz la na lc ld le nb lg lh li ij bi translated">当然，这是项目的开始，他们必须优先考虑工作。他们公开做这件事，所以我并不感到惊讶。但对于我的日常工作，我需要更多的包，以避免重新发明轮子。好消息是我可以在GitHub上为下一个CI运行者和下一个要开发的包投票！📨</p><p id="5f1e" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">此外，由于它是开源的，我可以做出贡献！</p><h1 id="a85e" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">结论</h1><p id="1624" class="pw-post-body-paragraph kn ko iq kp b kq mx jr ks kt my ju kv kw mz ky kz la na lc ld le nb lg lh li ij bi translated">测试dagger在我的任务清单上已经太久了。我真的玩得很开心！</p><p id="19fd" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">该产品处于<strong class="kp ir">公开测试阶段</strong>，所以我对剩余的工作量并不感到惊讶。我<strong class="kp ir">现在不会在生产中使用dagger</strong>，但是我一定会在几个月内检查看看它的发展。</p><p id="4f59" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">作为一名为咨询公司工作的开发人员，我看到了真正的好处。事实上，我们经常在没有相同CI/CD堆栈的项目之间切换。因此，在现有CI运行程序之上创建一个抽象层的承诺很有意思。我们可以定义我们自己的行动，并独立于CI运行人员在我们的项目中利用它们。</p><p id="0305" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">最后，这个项目向<strong class="kp ir">展示了构建成功的开源软件</strong>有多么困难。这是一个技术挑战，也是一个人的挑战。每个人都对项目的发展方向有自己的看法(包括我自己)，维护人员必须做出决定。我祝他们一切顺利！</p></div></div>    
</body>
</html>