<html>
<head>
<title>Performance and Reliability Best Practices for Express Apps — Environment Changes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Express应用程序的性能和可靠性最佳实践—环境变化</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/performance-and-reliability-best-practices-for-express-apps-environment-changes-5a7cee26803?source=collection_archive---------12-----------------------#2020-03-12">https://levelup.gitconnected.com/performance-and-reliability-best-practices-for-express-apps-environment-changes-5a7cee26803?source=collection_archive---------12-----------------------#2020-03-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/7176fb244d031ca8dba65ac69c40adca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4ckqguy0T3Mk0Bw_"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@unandalusgus?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">古斯塔沃·奎蓬</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="4f62" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我们将Express应用程序用于生产用途时，即它由外部用户使用时，我们应该考虑性能，以便我们的用户在使用我们的应用程序时不会受到影响。</p><p id="7b70" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我们将了解在生产环境中运行Express应用程序时的一些性能和可靠性最佳实践。</p><h1 id="e778" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">环境变化</h1><h2 id="8b4d" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">将NODE_ENV设置为“生产”</h2><p id="a653" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们可以设置<code class="fe mt mu mv mw b">NODE_ENV</code>环境变量<code class="fe mt mu mv mw b">'production'</code>来加速或者app。</p><p id="401b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">设置它会使Express cache查看模板，缓存从CSS扩展生成的CSS文件，并生成较少的详细错误消息。</p><p id="5d73" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">仅仅通过这种改变，性能就可以提高3倍。</p><p id="e42d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以通过使用<code class="fe mt mu mv mw b">process.env.NODE_ENV</code>来检查<code class="fe mt mu mv mw b">NODE_ENV</code>的值。但是，我们不应该太频繁地这样做，因为每次这样做都会导致性能下降。</p><p id="02ff" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在开发中，我们使用命令行来设置变量。例如我们运行的Linux行:</p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="28a2" class="mc lf it mw b gy nf ng l nh ni">env NODE_ENV=production</span></pre><p id="6c91" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以通过在作业文件中输入相同的命令来启动我们的应用程序。</p><h2 id="48fd" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">确保我们的应用程序自动重启</h2><p id="0e50" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">为了确保我们的应用程序始终运行，我们应该在它崩溃时自动重启它。</p><p id="175c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为此，我们使用进程管理器在它崩溃时重启它。当遇到未捕获的异常时，节点应用程序会崩溃。我们应该确保正确处理它们，这样就不会经常崩溃。</p><p id="ebef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一些流程管理器包括StrongLoop流程管理器、PM2和Forever。</p><p id="40ce" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以使用StrongLoop PM在本地构建和打包，然后将其安全地部署到生产环境中。如果应用程序崩溃，它会自动重启。</p><p id="e333" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">还可以远程管理应用集群。它还允许我们查看CPU配置文件和堆快照，以监控资源使用情况。</p><p id="895c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，我们还可以获得性能指标，并通过Nginx负载均衡器的集成控制将其扩展到多台主机。</p><h2 id="6ac1" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">暴发户</h2><p id="06c8" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Upstart是一个系统工具，允许我们在启动时启动任务，在关机时停止任务，我们可以用它来运行我们的Express应用程序，在关机时停止它。</p><p id="5b07" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它也会在崩溃时自动重启。</p><h2 id="95e6" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">在集群中运行我们的应用</h2><p id="9266" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们可以为我们的应用启动一个进程集群，以提高它在多核系统中的性能。</p><p id="d4ca" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它让我们将负载分配到每个CPU内核。</p><p id="224b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每个集群工作线程都由集群主节点控制。</p><p id="627a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以使用node-pm或集群服务将我们的应用程序任务分配到集群中。</p><p id="29cd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，对于PM2，我们可以通过运行以下命令来启动5个工作进程:</p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="985d" class="mc lf it mw b gy nf ng l nh ni">pm2 start app.js -i 5</span></pre><p id="3bc9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者，我们可以让PM2自动检测我们服务器的CPU可以运行的最大工作线程数，并通过运行以下命令来运行这么多工作线程:</p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="eda7" class="mc lf it mw b gy nf ng l nh ni">pm2 start app.js -i max</span></pre><p id="6e81" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以通过运行以下命令来添加工人:</p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="ac59" class="mc lf it mw b gy nf ng l nh ni">pm2 scale app +3</span></pre><p id="9372" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">增加3名工人或</p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="6547" class="mc lf it mw b gy nf ng l nh ni">pm2 scale app 5</span></pre><p id="283d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将我们的应用程序扩展到5名员工即可运行。</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nj"><img src="../Images/2fd1faf048074d53b83162e97086b982.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3tSjih7P3fDVBaZf"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@boxedwater?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">盒装水更好</a>上<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><h2 id="146e" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">缓存请求结果</h2><p id="26a5" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">缓存请求结果意味着我们的应用程序不必重复已经缓存的操作。</p><p id="a4fc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Varnish和Nginx可以缓存结果，以提高我们的应用程序的性能。</p><h2 id="904a" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">使用负载平衡器</h2><p id="6a55" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们可以使用负载平衡器来运行应用程序的多个实例，这样我们就可以处理更多的流量和负载。</p><p id="572a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要使用负载平衡器运行，我们必须确保与特定会话ID相关联的请求连接到发起它们的实例。</p><p id="7d77" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这也意味着我们必须使用像Redis这样的数据存储来存储会话数据。</p><h2 id="2937" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">反向代理</h2><p id="4867" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">反向代理位于web应用程序的前面，并对请求执行操作。它可以将请求定向到应用程序，处理错误页面，压缩，提供文件，负载平衡，以及许多其他事情。</p><p id="f2f2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它释放了Express来执行专门的应用程序任务，所以在Nginx这样的反向代理后面运行我们的应用程序是个好主意。</p><h1 id="3edc" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="440b" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们可以通过改变服务器来提高应用的性能。</p><p id="a635" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以缓存结果，以便可以使用缓存的结果，而不是重复执行相同的任务。负载平衡器适用于运行一个应用程序的多个实例，但我们必须知道会话ID，并将其与启动会话的实例相匹配。</p><p id="fb34" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，我们可以创建一个集群，以便我们的应用程序可以与多个工作人员一起运行。</p><p id="3635" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">反向代理让我们做我们的应用程序必须做的各种操作。它将我们的应用从压缩、缓存等任务中解放出来。</p><p id="c9f1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，将我们的应用程序环境设置为生产环境还会使Express对资产进行一些缓存。</p><p id="b8ca" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了防止异常关闭我们的应用程序，我们应该在它与进程管理器崩溃时自动重启它。</p></div></div>    
</body>
</html>