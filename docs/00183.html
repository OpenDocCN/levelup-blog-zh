<html>
<head>
<title>Using Nginx and Docker to limit file upload size in React Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Nginx和Docker限制React应用程序中的文件上传大小</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-nginx-to-limit-file-upload-size-in-react-apps-4b2ce0e444c2?source=collection_archive---------0-----------------------#2018-08-01">https://levelup.gitconnected.com/using-nginx-to-limit-file-upload-size-in-react-apps-4b2ce0e444c2?source=collection_archive---------0-----------------------#2018-08-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5abe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在部署dockered React应用程序时，配置nginx以限制每个API调用的文件大小</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/fcdfa8a092b566f4821adec2f2e9bea7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OVym7hPX6uunrO9CFpQpEw.png"/></div></div></figure><h2 id="da2b" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">TL；速度三角形定位法(dead reckoning)</h2><p id="3f9f" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">根据nginx配置中可用的<code class="fe lv lw lx ly b">location</code>使用<code class="fe lv lw lx ly b">client_max_body_size</code>为每个被代理的端点设置自定义限制。</p><h2 id="ff38" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">问题是</h2><p id="b1ae" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">本文的主要目标是解决我们在创建UI应用程序时遇到的一个常见挑战。对于这个例子，我选择了React，但实际上这可以与任何框架一起工作，并且它并不排斥基于React的项目。</p><p id="6dd0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您曾经遇到过这样的情况，您的UI应用程序直接与多个具有不同文件大小限制的后端服务进行对话，那么这篇文章就是为您准备的。</p><h2 id="62f8" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">解决方案</h2><p id="5cb6" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">我们将使用nginx来匹配路径和路由请求，同时应用我们的自定义配置。</p><p id="6de5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们首先用<code class="fe lv lw lx ly b">create-react-app</code> CLI工具创建基本的app，安装<code class="fe lv lw lx ly b">axios</code>进行API调用，并用下面的文件替换<code class="fe lv lw lx ly b">App.js</code>文件的内容。如果你对它的工作原理感到困惑，不要担心。我们现在不担心这个。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="347b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们启动应用程序，并注意到下面的屏幕是我们非常基本的UI如何呈现文件上传:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mb"><img src="../Images/82d7c1ce330a65072e4a4593669bdfe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*woxEyoSAr_xOQs0UhG-y5w.png"/></div></div></figure><p id="a06b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，我们假设有两种不同类型的端点，一种允许无限制的文件大小，另一种阻止上传大于10MB的文件。</p><p id="c6f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">暂时不要尝试点击上传按钮！我们没有添加任何逻辑来限制文件大小，老实说，如果我们现在尝试上传任何东西，我们会看到404错误，因为我们的开发服务器不知道这些<code class="fe lv lw lx ly b">/api</code>端点是什么。</p><p id="a04e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了测试我们的更改，我们将应用程序与nginx基础映像对接，并在其中使用我们的自定义配置。</p><p id="19c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，通过运行build命令为react应用程序创建<code class="fe lv lw lx ly b">build</code>文件夹。第二，创建<code class="fe lv lw lx ly b">Dockerfile</code>，它提取nginx图像并将您的<code class="fe lv lw lx ly b">build</code>文件夹加载到其中。第三，创建nginx配置文件，该文件将包含我们希望在代理请求之前检查的路径。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="2156" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解决方案以<code class="fe lv lw lx ly b">client_max_body_size</code>参数的形式存在于<code class="fe lv lw lx ly b">nginx.config</code>文件中。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="5397" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，从上面的代码示例中，我们有一个<code class="fe lv lw lx ly b">/api</code>端点，它强制执行10MB的限制，而<code class="fe lv lw lx ly b">/unlimited</code>端点将文件大小限制为200MB。</p><p id="90f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是构建docker映像并运行容器:</p><pre class="km kn ko kp gt mc ly md me aw mf bi"><span id="96ae" class="kx ky iq ly b gy mg mh l mi mj">docker build --rm -f Dockerfile -t nginx-protection:latest .</span><span id="2738" class="kx ky iq ly b gy mk mh l mi mj">docker run --rm -d -p 80:80 nginx-protection:latest</span></pre><p id="d177" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这使我们的集装箱在港口80开始。当我们在浏览器上转到<code class="fe lv lw lx ly b">http://localhost</code>时，我们可以看到页面再次加载了我们的按钮和文本。我们现在准备尝试上传文件。有趣的是，根据上传的api和文件大小的组合，你会开始注意到我们的控制台充满了消息。在下面的场景中，我选择了一个15MB的图像，并尝试使用无限和有限端点上传它。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ml"><img src="../Images/aad48a2cca8877bcef8783a323b30f11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fQjvqxC9s9Mr94FP3F4t5Q.png"/></div></div></figure><p id="b58c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从上面我们可以看到，nginx服务器试图在<code class="fe lv lw lx ly b">/unlimited</code>端点上转发我们的上传文件，而在<code class="fe lv lw lx ly b">/limited</code>端点上返回413错误。第一个场景中的502是因为我们的请求被代理到的服务器，即<code class="fe lv lw lx ly b"><a class="ae mm" href="http://backend.com:8080/api/;" rel="noopener ugc nofollow" target="_blank">http://backend.com:8080/api/</a></code>不是我们可以访问的。</p><p id="35dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完整的代码库可以在这里找到<a class="ae mm" href="https://github.com/40x/nginx-protection" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="6f6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请在下面的评论区留下问题和评论。</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><p id="c7bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mu">如果你喜欢这个博客，一定要为它鼓掌或关注我的</em> <a class="ae mm" href="https://www.linkedin.com/in/kashyap-mukkamala/" rel="noopener ugc nofollow" target="_blank"> <em class="mu"> LinkedIn </em> </a></p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><figure class="km kn ko kp gt kq gh gi paragraph-image"><a href="https://levelup.gitconnected.com"><div class="gh gi mv"><img src="../Images/ff5028ba5a0041d2d76d2a155f00f05e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JaoZbi7tTKJ5vL7i2OAYMQ.png"/></div></a></figure><div class="mw mx gp gr my mz"><a href="https://gitconnected.com/learn/nginx" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd ir gy z fp ne fr fs nf fu fw ip bi translated">学习Nginx -最佳Nginx教程(2019) | gitconnected</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">6大Nginx教程。课程由开发者提交并投票，让你找到最好的Nginx…</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">gitconnected.com</p></div></div><div class="ni l"><div class="nj l nk nl nm ni nn kv mz"/></div></div></a></div></div></div>    
</body>
</html>