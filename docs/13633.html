<html>
<head>
<title>Fixing Obscure Bugs: Apache, GZip, ETags, &amp; Edge Compute</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">修复模糊错误:Apache、GZip、ETags和Edge Compute</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/fixing-obscure-bugs-apache-gzip-etags-edge-compute-7b5fbb63a57c?source=collection_archive---------16-----------------------#2022-09-22">https://levelup.gitconnected.com/fixing-obscure-bugs-apache-gzip-etags-edge-compute-7b5fbb63a57c?source=collection_archive---------16-----------------------#2022-09-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/5394b86f896794874f23ebe75b49917a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xgd0-B-DC2LPw-mXgcql1g.png"/></div></div></figure><div class=""/><p id="722c" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最近有人向我介绍了Apache的GZip模块的一个模糊的性能错误，以及一个使用<a class="ae kz" href="https://www.akamai.com/solutions/edge?utm_source=austingil.com&amp;utm_medium=blog&amp;utm_campaign=austin-gil" rel="noopener ugc nofollow" target="_blank"> EdgeWorkers </a>的巧妙解决方案。所以我做了一个视频，还发了一个小博文来介绍它:</p><figure class="la lb lc ld gt iv"><div class="bz fp l di"><div class="le lf l"/></div></figure><p id="cab1" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我喜欢我的工作的一点是，当我和比我聪明得多的人一起工作时，我从来没有兴趣或机会去做的事情。</p><p id="cb68" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">例如，虽然<a class="ae kz" href="https://httpd.apache.org/docs/" rel="noopener ugc nofollow" target="_blank"> Apache </a>可以说是这个星球上最流行的HTTP服务器技术，但它也不是没有缺陷。如果你回顾一下<a class="ae kz" href="https://bz.apache.org/bugzilla/" rel="noopener ugc nofollow" target="_blank">错误报告</a>，你可能会发现一个叫做“gzip:ed content 上<a class="ae kz" href="https://bz.apache.org/bugzilla/show_bug.cgi?id=39727" rel="noopener ugc nofollow" target="_blank">错误的ETag”的错误报告，这是亨德里克·诺德斯特龙在2006年报告的。</a></p><p id="9e71" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">亨德里克注意到，使用<code class="fe lg lh li lj b"><a class="ae kz" href="https://httpd.apache.org/docs/current/mod/mod_deflate.html" rel="noopener ugc nofollow" target="_blank">mod_deflate</a></code>模块压缩的实体仍然携带与普通实体相同的<a class="ae kz" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag" rel="noopener ugc nofollow" target="_blank"> ETag </a>，这导致了与ETag感知代理缓存的某种不一致。</p><p id="9f3c" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您不熟悉的话，ETags是HTTP响应头，主要用于标识资源的特定版本。ETag的值通常是一个哈希值，由文件内容或修改日期或者两者的组合生成。</p><p id="0e44" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它可能看起来像这样:</p><pre class="la lb lc ld gt lk lj ll lm aw ln bi"><span id="fc52" class="lo lp je lj b gy lq lr l ls lt">ETag: 27dc5-556d73fd7fa43</span></pre><p id="b23c" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果一个HTTP请求包含一个与现有ETag响应头匹配的<code class="fe lg lh li lj b"><a class="ae kz" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-None-Match" rel="noopener ugc nofollow" target="_blank">If-None-Match</a></code>头，代理缓存(如CDN)可以认为文件已经更改但未被修改，并可能以304“未修改”状态响应。</p><p id="0af2" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">理论上，这样会更快并节省带宽。</p><p id="fa31" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当您在Apache中启用GZip压缩模块时，它实际上会在这些为ETags生成的哈希值的末尾附加一个小小的“-gzip”后缀。</p><p id="915d" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">不幸的是，当Apache去比较<code class="fe lg lh li lj b">If-None-Match</code>头(" 27dc5-556d73fd7fa43-gzip ")和ETag值(" 27dc5-556d73fd7fa43 ")时，它没有考虑后缀。</p><p id="7b5f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，它总是要服务于整个资源负载，这是具有讽刺意味的，因为理论上ETags和GZip都是节省带宽的方法。</p><p id="0dd8" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我希望我能够清楚地解释这个问题，但如果我没有，在<a class="ae kz" href="https://flameeyes.blog/" rel="noopener ugc nofollow" target="_blank"> Flameeyes的博客</a>上有一篇题为“<a class="ae kz" href="https://flameeyes.blog/2017/08/22/apache-etag-and-not-modified/" rel="noopener ugc nofollow" target="_blank"> Apache，ETag和‘未修改’</a>”的精彩博文。它甚至提供了解决方案。</p><p id="035a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">那么，如果问题已经解决了，为什么我今天要谈这个？</p><p id="3ea1" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个解决方案要求您修改Apache配置。但是作为现在的开发人员，我非常清楚在很多情况下我们自己无法做到这一点。我可能没有权限，或者我可能正在使用第三方服务。</p><p id="bb75" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有趣的解决方案出现了。</p><p id="6b47" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://www.akamai.com/" rel="noopener ugc nofollow" target="_blank"> Akamai </a>有一款产品叫做<a class="ae kz" href="https://www.akamai.com/solutions/edge" rel="noopener ugc nofollow" target="_blank"> EdgeWorkers </a>，它基本上可以坐在客户端和源服务器之间，运行<a class="ae kz" href="https://austingil.com/category/javascript/" rel="noopener ugc nofollow" target="_blank"> JavaScript </a>逻辑。</p><p id="7bbe" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，当客户端发出请求时，EdgeWorker可以拦截请求，并在请求到达源服务器的途中对其进行修改。或者当源服务器做出响应时，Akamai EdgeWorker可以拦截该响应，并在它被传回客户端之前对其进行修改。</p><p id="6525" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">理论上，不能访问Apache配置的开发人员仍然可以打临时补丁，直到解决方案在Apache配置级别得到解决。</p><p id="e3f2" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它可能看起来像这样:</p><pre class="la lb lc ld gt lk lj ll lm aw ln bi"><span id="cb59" class="lo lp je lj b gy lq lr l ls lt">// Modify origin responses<br/>export function onOriginResponse(request, response) {<br/>  // Grab the server name<br/>  const serverName = response.getHeader('Server')[0];<br/>  // Grab the ETag header<br/>  const etag1 = response.getHeader('ETag')[0];<br/>  // Check if it's an Apache server and the ETag ends with '-gzip'<br/>  if (serverName.startsWith('Apache') &amp;&amp; etag1.endsWith('-gzip')) {<br/>    // If so, strip out the '-gzip' suffix<br/>    response.setHeader('ETag', etag1.replace('-gzip', ''));<br/>  }<br/>}</span></pre><p id="0645" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我意识到这可能实际上不适用于很多人，但我想分享它，因为它在模糊的错误、深厚的技术知识和需要修复的几行代码之间取得了良好的平衡。特别是当你包括Akamai EdgeWorkers部分时，这只是一个我以前从未想到过的很酷、很优雅的方法。</p><p id="f074" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以希望你也觉得它有趣，即使它与你今天没有直接关系。</p><p id="2878" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">非常感谢您的阅读。如果你喜欢这篇文章，请<a class="ae kz" href="https://twitter.com/share?via=heyAustinGil" rel="noopener ugc nofollow" target="_blank">分享它</a>。这是支持我的最好方式之一。你也可以<a class="ae kz" href="https://austingil.com/newsletter/" rel="noopener ugc nofollow" target="_blank">注册我的时事通讯</a>或者<a class="ae kz" href="https://twitter.com/heyAustinGil" rel="noopener ugc nofollow" target="_blank">在Twitter上关注我</a>如果你想知道什么时候有新文章发表。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><p id="2fde" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="mb">原载于</em><a class="ae kz" href="https://austingil.com/apache-gzip-etags-edge-compute/" rel="noopener ugc nofollow" target="_blank"><em class="mb"/></a><em class="mb">。</em></p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="f97a" class="mc lp je bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">分级编码</h1><p id="bed4" class="pw-post-body-paragraph kb kc je kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="a357" class="ne nf je kd b ke kf ki kj km ng kq nh ku ni ky nj nk nl nm bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="fd4a" class="ne nf je kd b ke nn ki no km np kq nq ku nr ky nj nk nl nm bi translated">📰查看<a class="ae kz" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">级编码出版物</a>中的更多内容</li><li id="0cde" class="ne nf je kd b ke nn ki no km np kq nq ku nr ky nj nk nl nm bi translated">🔔关注我们:<a class="ae kz" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a> | <a class="ae kz" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a> | <a class="ae kz" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="6080" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">🚀👉<a class="ae kz" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kd jf">将像你这样的开发人员安置在顶级创业公司和科技公司</strong> </a></p></div></div>    
</body>
</html>