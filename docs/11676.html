<html>
<head>
<title>Advanced SQL — CTEs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">高级SQL — CTEs</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/advanced-sql-ctes-f36d00cbf051?source=collection_archive---------8-----------------------#2022-04-05">https://levelup.gitconnected.com/advanced-sql-ctes-f36d00cbf051?source=collection_archive---------8-----------------------#2022-04-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d0fb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用WITH子句的常用表表达式。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0cad70b299fb49358ff2e0f98d52d9a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z3-wzrhNj0QplkOcLFGmeQ.jpeg"/></div></div></figure><p id="f1c7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当写出SQL查询时，事情很容易失控或过于复杂，以至于可读性大大降低。幸运的是，在2005年，cte(公共表表达式)被引入到SQL Server中，使我们能够为一组结果指定名称，这些结果可以在其他CRUD语句中使用。在这篇博文中，我想简单介绍一下CTE语法以及如何使用它。我希望将来能写另一篇博文，更详细地介绍复杂用例。</p><h1 id="f764" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">什么是CTE？</h1><p id="585c" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">如上所述，CTE(有时称为“WITH语句”)是一个临时命名的结果集，它不保存在任何位置，只在查询运行时存在于内存中(与存在于临时数据库文件中的临时表不同)。CTE的结果只存在于特定语句的执行范围内；换句话说，结果只能用于紧跟在定义CTE的WITH子句之后的CRUD语句。cte是简化和管理复杂查询的一种很好的方式，通过将代码分成几个部分，使代码更容易阅读。</p><h1 id="9a01" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">CTE语法</h1><p id="e660" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">我编写了一个简单的SQL查询作为示例来展示如何使用CTE:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="71d5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">基于我从<a class="ae mm" href="https://www.sqlservertutorial.net/load-sample-database/" rel="noopener ugc nofollow" target="_blank">sqlservertutorial.net</a>获得的样本数据，上面的查询将返回以下结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mn"><img src="../Images/fa56831ff1cd50244d2241ed8e5d4919.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MrrP-kuzLewqoimjV8teYA.png"/></div></div></figure><p id="2cc2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">关于CTE语法，首先要注意的是，它是在直接位于CRUD语句之前的WITH子句中定义的，CRUD语句的结果将在该语句中使用。基本语法如下:</p><pre class="kg kh ki kj gt mo mp mq mr aw ms bi"><span id="511b" class="mt lo iq mp b gy mu mv l mw mx">WITH CTE-name AS (CTE-definition) </span></pre><p id="289d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您还可以通过使用逗号分隔定义来定义多个cte:</p><pre class="kg kh ki kj gt mo mp mq mr aw ms bi"><span id="0cdb" class="mt lo iq mp b gy mu mv l mw mx">WITH name AS (definition),<br/>second-name AS (second-definition)</span></pre><p id="e4e5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了定义CTE，只需编写一条SELECT语句作为括号文本。该语句应该捕获您希望在另一个查询中使用的任何数据。一旦定义了CTE，就可以在最终查询中引用它了:</p><pre class="kg kh ki kj gt mo mp mq mr aw ms bi"><span id="18cb" class="mt lo iq mp b gy mu mv l mw mx">WITH <strong class="mp ir"><em class="my">name</em></strong> AS (definition)</span><span id="349d" class="mt lo iq mp b gy mz mv l mw mx">SELECT * FROM <strong class="mp ir"><em class="my">name</em></strong></span></pre><p id="4196" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们再看一下上面的示例查询:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/1a8d3487174d4c5fc0940e695f0d2ed9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z2tWLcdNKyWaO1O8CojNJQ.png"/></div></div></figure><p id="bf6f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以绿色突出显示的部分是定义CTE的WITH子句，以蓝色突出显示的部分是查询CTE的SELECT语句。这是一个很好的设置，因为CTE可以为我们处理大部分困难的工作，我们可以根据我们需要的数据编辑最终的查询。</p><h1 id="e804" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">常见使用案例</h1><p id="e638" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">CTE是一个非常有用和灵活的工具，可以添加到您的SQL清单中。以下是一些最常见的使用案例:</p><ol class=""><li id="8c6d" class="nb nc iq kt b ku kv kx ky la nd le ne li nf lm ng nh ni nj bi translated">cte通常用于提高查询的可读性和可管理性。通过定义多个cte，您可以将一个长而复杂的查询分解成可以在最终查询中引用的逻辑块。如果在多个子查询中引用相同的数据，它们也是遵循DRY原则的好方法。</li><li id="3b48" class="nb nc iq kt b ku nk kx nl la nm le nn li no lm ng nh ni nj bi translated">cte可用于创建递归查询，这很有帮助，因为普通的SELECT语句不能引用自身。参见微软关于使用cte进行递归查询的<a class="ae mm" href="https://docs.microsoft.com/en-us/previous-versions/sql/sql-server-2008-r2/ms186243(v=sql.105)?redirectedfrom=MSDN" rel="noopener ugc nofollow" target="_blank">文档</a>,了解更多信息。</li></ol></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="eacf" class="ln lo iq bd lp lq nw ls lt lu nx lw lx jw ny jx lz jz nz ka mb kc oa kd md me bi translated">TL；速度三角形定位法(dead reckoning)</h1><ol class=""><li id="ed70" class="nb nc iq kt b ku mf kx mg la ob le oc li od lm ng nh ni nj bi translated">CTE仅存在于后续语句的执行范围内。</li><li id="e619" class="nb nc iq kt b ku nk kx nl la nm le nn li no lm ng nh ni nj bi translated">与临时表不同，cte不会保存在任何地方。</li><li id="8824" class="nb nc iq kt b ku nk kx nl la nm le nn li no lm ng nh ni nj bi translated">CTE是通过在WITH子句后的括号中编写SELECT语句来定义的。</li><li id="12a9" class="nb nc iq kt b ku nk kx nl la nm le nn li no lm ng nh ni nj bi translated">可以像查询中FROM子句后面的任何其他表一样引用CTE。</li><li id="040d" class="nb nc iq kt b ku nk kx nl la nm le nn li no lm ng nh ni nj bi translated">CTE是干燥代码、增加可读性和可管理性以及编写递归查询的好方法。</li></ol></div></div>    
</body>
</html>