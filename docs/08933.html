<html>
<head>
<title>How To Monitor Your Services Hosted On AWS EC2 Instances</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何监控AWS EC2实例上托管的服务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-monitor-your-services-hosted-on-aws-ec2-instances-4abbc460332?source=collection_archive---------6-----------------------#2021-06-20">https://levelup.gitconnected.com/how-to-monitor-your-services-hosted-on-aws-ec2-instances-4abbc460332?source=collection_archive---------6-----------------------#2021-06-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e260" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一种实现Lambda函数的安全方法，该函数使用Secrets Manager监控EC2实例上托管的所有服务</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/205f8cc0beb76ba11bbfecb25a4f922b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T1tAElaHDl_mwUOSvdguTw.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自Unsplash上的<a class="ae ky" href="https://unsplash.com/@wocintechchat" rel="noopener ugc nofollow" target="_blank">克里斯蒂娜@ wocintechchat.com</a></figcaption></figure><h1 id="f907" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">问题</h1><p id="90db" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">AWS提供了许多工具来监控自己的服务。您可以在各种CloudWatch事件上添加警报。随着您在AWS上托管越来越多的服务，确保这些服务正在运行变得非常困难和重要。您可以使用CloudWatch通过创建新的指标来发现服务的状态。这一过程在某一点之后变得昂贵且难以管理。</p><h1 id="8e04" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">解决办法</h1><p id="01a5" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Lambda函数安全地监控EC2实例上运行的所有服务。以下是建议的架构:</p><h1 id="b373" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated"><strong class="ak">建筑</strong></h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/8db8f804f5e67dcaf841039b8f934c47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JgKsKt7xNT8UlLHFdDYahw.png"/></div></div></figure><p id="a4d4" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">这个架构背后的主要思想是通过SSH安全地访问EC2实例并监控服务。SSH密钥会定期轮换。</p><p id="add0" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">设置中涉及的实体:</p><ul class=""><li id="c3d1" class="mt mu it lt b lu mo lx mp ma mv me mw mi mx mm my mz na nb bi translated"><strong class="lt iu"> EC2实例</strong>:这些是运行服务的实例。</li><li id="f1f9" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated"><strong class="lt iu">监控Lambda </strong>:这个Lambda函数负责使用SSH安全地登录到各种实例，发现服务的状态，并在出现问题时发出警报。</li><li id="24ac" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated">AWS安全管理器:用于存储SSH密钥(私有和公共)的AWS服务。密钥由密钥轮换λ函数定期轮换。</li><li id="6c04" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated"><strong class="lt iu">密钥旋转Lambda </strong> : Lambda函数旋转SSH密钥，并在<em class="nh">中添加公钥。具有特定标记的实例中的ssh/authorized_keys </em>文件。它还在AWS S3的对象中添加了公钥。</li><li id="aa1b" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated"><strong class="lt iu"> AWS系统管理器</strong> : Rotation Lambda函数使用系统管理器运行脚本将ssh公钥添加到<em class="nh"> ~。ssh/authorized _ key。</em></li></ul><h1 id="9eea" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated"><strong class="ak">步骤</strong></h1><h2 id="c427" class="ni la it bd lb nj nk dn lf nl nm dp lj ma nn no ll me np nq ln mi nr ns lp nt bi translated"><span class="l nu nv nw bm nx ny nz oa ob di"> C </span></h2><p id="c12d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在这一步，我们使用CloudFormation创建一个Lambda函数，该函数旋转SSH密钥并在<em class="nh">中添加公钥。实例中的ssh/authorized_keys </em>文件。公钥放在AWS S3中的一个对象上。</p><p id="1c60" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">从这个<a class="ae ky" href="https://github.com/amritsingh/rotate-ssh-aws" rel="noopener ugc nofollow" target="_blank">库</a>下载Lambda代码</p><pre class="kj kk kl km gt oc od oe of aw og bi"><span id="ce8b" class="ni la it od b gy oh oi l oj ok"><strong class="od iu">$</strong> wget <a class="ae ky" href="https://github.com/amritsingh/rotate-ssh-aws/archive/master.zip" rel="noopener ugc nofollow" target="_blank">https://github.com/amritsingh/rotate-ssh-aws/archive/master.zip</a> -O rotate_ssh.zip<br/><strong class="od iu">$</strong> unzip rotate_ssh.zip</span></pre><p id="1598" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">压缩存储库的内容</p><pre class="kj kk kl km gt oc od oe of aw og bi"><span id="e04b" class="ni la it od b gy oh oi l oj ok"><strong class="od iu">$</strong> cd rotate-ssh-aws-master/<br/><strong class="od iu">$</strong> zip -r rotate-ssh-lambda.zip ./*</span></pre><p id="157c" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">上传rotate-ssh-lambda.zip到S3。</p><p id="ff79" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated"><code class="fe ol om on od b">cloudformation.yaml</code>是在AWS中创建Lambda函数的云形成脚本。在这个文件中，在将脚本提供给AWS Cloud Formation之前，根据您的设置更改一些参数(查找<strong class="lt iu"> <em class="nh"> FIXME </em> </strong>)。</p><p id="284f" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated"><code class="fe ol om on od b">cloudformation.yaml</code>需要配置</p><ul class=""><li id="b60d" class="mt mu it lt b lu mo lx mp ma mv me mw mi mx mm my mz na nb bi translated"><em class="nh">存储公钥的S3桶</em></li><li id="2d84" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated"><em class="nh">存储公钥的S3对象</em></li><li id="34a0" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated"><em class="nh">用于登录EC2实例的Linux用户的用户名</em></li><li id="4d5f" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated"><em class="nh">你上传的Lambda代码的S3·URI</em></li><li id="5864" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated"><em class="nh">存储公钥、安全组id和子集id的S3桶的ARN。</em></li></ul><p id="52bd" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">转到AWS控制台中的CloudFormation。点击“<strong class="lt iu">创建堆栈</strong>”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/631c576038d55399df8d10327702dade.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RVCB1ggfV4ShNv856Ok6-A.png"/></div></div></figure><p id="3c8a" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">选择“<strong class="lt iu">上传模板文件</strong>选项，从您的机器上选择<code class="fe ol om on od b">cloudformation.yaml</code>，点击<strong class="lt iu">下一步</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/21e35e3d110850d6c9e198bce844c67d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iWy2us4cun68FKU7LDkn5A.png"/></div></div></figure><p id="2ddb" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">输入“<strong class="lt iu">堆栈名称</strong>并根据需要更改参数，点击“<strong class="lt iu">下一步</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/a3032db347c0777b2dd19cddc3f5f7c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q6puGkrCp9qe9CHy9s68iA.png"/></div></div></figure><p id="eda1" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在步骤3和步骤4中，使用默认选项并创建堆栈。</p><p id="54ad" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">等待一段时间，直到堆栈创建完成。</p></div><div class="ab cl or os hx ot" role="separator"><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow"/></div><div class="im in io ip iq"><h2 id="4ebd" class="ni la it bd lb nj nk dn lf nl nm dp lj ma nn no ll me np nq ln mi nr ns lp nt bi translated">在<strong class="ak"> AWS秘密管理器</strong>中创建一个秘密</h2><p id="11e6" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在<strong class="lt iu"> AWS机密管理器控制台</strong>上选择“<strong class="lt iu">存储新的机密</strong>”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/6db60f702604c8ea7f6f5ad4329e652b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JCw_e2fms5zPR9LZvgEoZA.png"/></div></div></figure><p id="7428" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">选择<strong class="lt iu">其他类型的秘密</strong>，选择<strong class="lt iu">明文</strong>页签，输入<strong class="lt iu"> {} </strong>。将默认加密密钥更改为<strong class="lt iu">客户主密钥</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/b969fff4dba44c036c795bfc665c7ac5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f3-XmMoCAvqPSQYkCLJrtw.png"/></div></div></figure><p id="76b0" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在<strong class="lt iu">步骤2:名称和描述:</strong>输入钥匙的名称和描述。名字会像<strong class="lt iu"> /monitoring/ssh </strong>。添加描述后，点击下一个的<strong class="lt iu">。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/d5e3fb8c9214175c65a04459b40fa3c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l-uuE6Jcrf1Wt82ZDd2gRA.png"/></div></div></figure><p id="4b5e" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在<strong class="lt iu">第三步:配置旋转</strong>中，选择<strong class="lt iu">启用自动旋转。</strong>根据您的要求更改轮换间隔，并选择我们为轮换SSH密钥创建的lambda。选择下一个的<strong class="lt iu">。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/65a49b516e5410dab33d5a8c6718ddd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jl0-ft2tQkdu7IdsH7M_1g.png"/></div></div></figure><p id="a793" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在<strong class="lt iu">步骤4 </strong>中，查看并选择<strong class="lt iu">存储</strong>。</p></div><div class="ab cl or os hx ot" role="separator"><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow"/></div><div class="im in io ip iq"><h2 id="2b8d" class="ni la it bd lb nj nk dn lf nl nm dp lj ma nn no ll me np nq ln mi nr ns lp nt bi translated">将访问SSH公钥所在的S3存储桶的权限授予您用于EC2实例的IAM角色</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pc pd l"/></div></figure></div><div class="ab cl or os hx ot" role="separator"><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow"/></div><div class="im in io ip iq"><h2 id="fb84" class="ni la it bd lb nj nk dn lf nl nm dp lj ma nn no ll me np nq ln mi nr ns lp nt bi translated">更改EC2实例的部署，定期从S3桶中提取公钥</h2><p id="5519" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们创建了一个cron作业，以15分钟的时间从S3获取SSH公钥。</p><p id="73ab" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">crontab运行的Bash脚本如下所示</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pc pd l"/></div></figure></div><div class="ab cl or os hx ot" role="separator"><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow"/></div><div class="im in io ip iq"><h2 id="7d75" class="ni la it bd lb nj nk dn lf nl nm dp lj ma nn no ll me np nq ln mi nr ns lp nt bi translated">设置一个Lambda函数，通过SSH连接到EC2实例并监控服务</h2><p id="b86d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这是完整设置的最后一部分。每当您想要监视一个新的服务时，都必须修改这个代码。</p><p id="c554" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">为此，我推荐使用Python。Lambda函数应该可以访问Secrets Manager中的私钥。它执行以下任务:</p><ul class=""><li id="5acd" class="mt mu it lt b lu mo lx mp ma mv me mw mi mx mm my mz na nb bi translated">从Secrets Manager下载私钥。</li><li id="4ffd" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated">使用<a class="ae ky" href="https://github.com/paramiko/paramiko" rel="noopener ugc nofollow" target="_blank"> Paramiko </a>登录EC2机器。</li><li id="4cdb" class="mt mu it lt b lu nc lx nd ma ne me nf mi ng mm my mz na nb bi translated">监控服务的状态，并在需要时发送AWS SNS警报。</li></ul></div><div class="ab cl or os hx ot" role="separator"><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow"/></div><div class="im in io ip iq"><h1 id="1763" class="kz la it bd lb lc pe le lf lg pf li lj jz pg ka ll kc ph kd ln kf pi kg lp lq bi translated">包装它</h1><p id="adff" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">最后，完成所有这些步骤后，您就有了自己的定制显示器设置。该显示器可轻松扩展至您的所有服务。每次向后端添加服务时，您都需要将服务添加到监控Lambda中。设置的所有其他部分保持不变。</p></div></div>    
</body>
</html>