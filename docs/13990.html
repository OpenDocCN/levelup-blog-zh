<html>
<head>
<title>How to make your library tree-shakable</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何让你的图书馆树摇动</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-make-your-library-tree-shakable-20b5a446c1e2?source=collection_archive---------2-----------------------#2022-10-23">https://levelup.gitconnected.com/how-to-make-your-library-tree-shakable-20b5a446c1e2?source=collection_archive---------2-----------------------#2022-10-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b2ba06882fd1f4fd6a87f97e5a3f821b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PVQui9gPj6mx3IyX.png"/></div></div></figure><h1 id="4ee1" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">树摇晃</h1><p id="ec3d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated"><em class="lu">树摇动</em>是JavaScript上下文中常用的术语，用于消除死代码。虽然现在许多捆绑器支持像Rollup或Webpack这样的树抖动，但树抖动不仅仅是一个开/关特性。要使摇树变得有价值，有许多因素影响质量</p><p id="9f3f" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">基本上，树抖动是在捆绑时检测哪些导出在我们的应用程序中没有使用，并且不会将它包含到我们的捆绑器中。</p><h1 id="9f86" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">实现摇树</h1><p id="8483" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">从树抖动的基本定义来看，许多捆绑器默认支持它，你可能不需要做任何事情。看看我下面的例子:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/ab2d3ee1601a3f23249838fc866d7510.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*GsUs0ujOYhP1q5mCWzTV7A.png"/></div></figure><p id="15e6" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">这是我的库，名为<code class="fe mf mg mh mi b">common-ui</code>，我将我的代码分割成小模块，并将其全部导出到根<code class="fe mf mg mh mi b">index.ts</code>文件中。这是我的bundler配置(tsup)和我建立后的<code class="fe mf mg mh mi b">dist</code>文件夹</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/4493dc1f1d81c23300f75cf5d97e5615.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ql4ecogc8vXT1w6q2xXMrg.png"/></div></div></figure><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/b18eae57bce9149d2a7a889caca9a28f.png" data-original-src="https://miro.medium.com/v2/resize:fit:602/format:webp/1*MAtDYHrl1Y9vNmRR22gO6A.png"/></div></figure><p id="e14b" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">这是最基本的配置。我只设置了<code class="fe mf mg mh mi b">entry</code>指向<code class="fe mf mg mh mi b">index.ts</code>。因此，该文件未导出和使用的每一行代码都不会包含在我们的<code class="fe mf mg mh mi b">dist</code>文件夹中。这样，你就实现了<em class="lu">死代码消除</em>对吗<em class="lu">？</em></p><h1 id="12c1" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">但是事情比这更复杂</h1><p id="aea9" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">如果没有使用它的应用程序，库就什么都不是，因为我的例子是monorepo(你可以在这里看到如何创建一个<a class="ae ml" href="https://duckylele.medium.com/create-a-package-based-monorepo-with-nx-ce4476b08139" rel="noopener"/>)。我将创建一个包来使用这个库</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/72e3201a6e2578e4452140e5494112e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:496/format:webp/1*8101goNJ7eRI9sHci7LZnA.png"/></div></figure><p id="3064" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><code class="fe mf mg mh mi b">web</code>包将安装<code class="fe mf mg mh mi b">common-ui</code>包并使用其组件:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/6a3bca7995e12ff997d0ff91c95f38ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ou6oy0djYHVlm19eQ1hUWQ.png"/></div></div></figure><p id="1687" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">您可以看到我从<code class="fe mf mg mh mi b">common-ui</code>库中导入了9个组件，让我们看看我的<code class="fe mf mg mh mi b">web</code>应用程序的包大小是多少</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/ba1c0dea1693dd23dccd1f3c32bc71dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*fjDbneztl5mCGFwpIOI3-A.png"/></div></figure><p id="5b2a" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">258kb，挺重的。因此，让我们看看我是否从<code class="fe mf mg mh mi b">common-ui</code>库中删除了一些导入来减小包的大小</p><p id="be69" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">嗯…我试图删除一半的进口，但包的大小仍然相同。所以我上面做的<code class="fe mf mg mh mi b">tree-shaking</code>的事情绝对没有帮助。</p><h2 id="1c0c" class="mo jz iq bd ka mp mq dn ke mr ms dp ki lh mt mu km ll mv mw kq lp mx my ku mz bi translated">为什么？</h2><p id="e376" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这是因为<strong class="ky ir">普通JS模块VS ES6模块</strong></p><p id="2807" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">显著区别在于无害环境管理进口是静态的，而CJS进口是动态的</strong></p><p id="8e7a" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">TSup使用<code class="fe mf mg mh mi b">esbuild</code>作为它的捆绑器，它支持两种格式</p><p id="ad81" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">树摇依赖于静态代码分析。它检测哪些模块是代码运行所必需的，并在编译时从最终包中删除其他模块。</p><p id="11ed" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">所以ESM是摇树功能的一个要求。</strong></p><p id="fc0d" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">让我们稍微修改一下配置文件</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/2c9e7b51b012ba3130082675dedf1aff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ohe7NlzYgwMucjTxyqMYOg.png"/></div></div></figure><p id="23e6" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">通过为CommonJS模块和ES6模块以及多个入口点设置格式，我们的包将如下所示</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/8aaa60054a7e1bd966bb4548e3648270.png" data-original-src="https://miro.medium.com/v2/resize:fit:610/format:webp/1*M7LU39YkY0EfjR2YZlC9Lg.png"/></div></figure><p id="e601" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">对于我们文件中的每个模块，CommonJS和ES6模块分别有<code class="fe mf mg mh mi b">.cjs</code>文件和<code class="fe mf mg mh mi b">.js</code>文件。在我们的<code class="fe mf mg mh mi b">package.json</code>文件中:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/2401067b58330b4058a75f72e519c692.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/1*2NSadBZL_r6GzoT5MzYkcw.png"/></div></figure><p id="09dd" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">我们映射<code class="fe mf mg mh mi b">.cjs</code>、<code class="fe mf mg mh mi b">.js</code>和<code class="fe mf mg mh mi b">.d.ts</code>文件，设置副作用优化，使我们的库副作用免费。现在让我们回到我们的<code class="fe mf mg mh mi b">web</code>应用程序，看看当我删除导入时，包的大小是否变小了</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/67908636fdeb5118ebdd25ad7b508b04.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*phJuU5efh0CXQ3r8zC50vg.png"/></div></figure><p id="ecc7" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">您可以看到我移除了<code class="fe mf mg mh mi b">CodeEditor</code>组件，并运行构建</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/de941ce46b8930e6079c93bb744192af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1154/format:webp/1*vouI8GvORdrab9jwVUvPsA.png"/></div></figure><p id="941f" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">捆绑的大小比上面的260kb要小，因为捆绑器检测到我们只使用了部分库，所以它不会将整个库包含到捆绑文件中。</p><h1 id="ba33" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="01ea" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">树摇图书馆不简单。它的质量取决于多种因素，本文介绍了基本要素。理解什么是捆绑输出和格式是使我们的库不可动摇的基础</p><p id="a23e" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">你可以在这里查看我的源代码</p><h1 id="05ab" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">遗言</h1><p id="4fa9" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">虽然我的内容对每个人都是免费的，但是如果你觉得这篇文章有帮助，<a class="ae ml" href="https://www.buymeacoffee.com/kylele19" rel="noopener ugc nofollow" target="_blank">你可以在这里给我买杯咖啡</a></p></div></div>    
</body>
</html>