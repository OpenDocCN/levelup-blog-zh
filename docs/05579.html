<html>
<head>
<title>AWS Lambda with RDS using pymysql</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用pymysql的带有RDS的AWS Lambda</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/aws-lambda-with-rds-using-pymysql-23ad3cde46c8?source=collection_archive---------0-----------------------#2020-09-11">https://levelup.gitconnected.com/aws-lambda-with-rds-using-pymysql-23ad3cde46c8?source=collection_archive---------0-----------------------#2020-09-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="d983" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本教程中，我将向您展示如何创建一个Lambda函数，该函数使用pymysql库从RDS数据库中查询数据。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/f10d2498fe5a9bd91d0a72d9436b5392.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iRf0d1S8wRpGE0_y2qqsqQ.png"/></div></div></figure></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="f17d" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">1.AWS帐户设置</h1><p id="1d51" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">如果您已经有了AWS帐户设置，请直接跳到第2部分。如果你没有，你可以在这里注册一个账户。您将被要求输入付款细节，但注册时您可以获得12个月的免费层访问，本教程中的任何内容都不会超过免费层限制。</p><p id="f9db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ml">注意:</em> </strong>如果您的帐户已经超出了免费等级的使用量，您可能需要为使用本教程中描述的AWS服务付费。如果保持多个RDS实例运行，将会超出可用层限制。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="26d0" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">2.创建RDS实例</h1><p id="b8c2" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">在AWS控制台中，从服务列表中选择RDS。从RDS仪表板中选择“创建数据库”。我们将创建一个MySQL数据库，因此选择它作为引擎类型，您可以将版本保留为默认选项。</p><p id="8a0d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ml">注意:</em> </strong>创建数据库时，请确保在AWS控制台的右上角选择了所需的区域(通常是地理上离您最近的区域)。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mm"><img src="../Images/ac3e8f8dd4a024a496f4040cd1440076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VNHhdKECC7vRLYYs1vXWJg.png"/></div></div></figure><p id="346e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">选择“自由层”作为模板。在Settings部分，您需要为您的RDS实例命名，并提供用于登录到您的实例的主用户名和密码。确保您记得用于设置RDS实例的用户名和密码。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mn"><img src="../Images/c71d7644e3a39f8c2139c47a9c1a452b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xEJ-QWlTxhDHl7gfFthUCw.png"/></div></div></figure><p id="f4b8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将数据库实例大小、存储以及可用性和持久性部分保留为默认值。在连接部分，展开附加连接配置选项，并将公共访问选项选中为是。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mm"><img src="../Images/082e96491897e88df2139dd3c400ad23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6oIkcJp_vujkWTe5_080cA.png"/></div></div></figure><p id="8f9e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以选择指定的最终配置位于附加配置部分。如果您希望在创建RDS实例时创建一个数据库，您可以在此部分指定一个初始数据库名称。在本教程中，我将创建一个名为“playlist”的数据库。然后，您可以单击“创建数据库”。RDS实例启动并运行(状态为“可用”)可能需要几分钟时间。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mo"><img src="../Images/36323fd3e7a05db1fd78ecf72770c68f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UZNYnhiQacZT-Q527j5OJg.png"/></div></div></figure></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="c3fa" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">3.从MySQL Workbench连接到数据库</h1><p id="60aa" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">如果你还没有安装MySQL和Workbench，你需要从<a class="ae mk" href="https://dev.mysql.com/downloads/installer/" rel="noopener ugc nofollow" target="_blank">这里</a>下载并安装。至少需要安装MySQL服务器和工作台。</p><p id="364d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ml">注:</em> </strong>本教程假设对MySQL有一些基本的了解。</p><p id="5425" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建数据库实例后，选择刚刚创建的数据库，并转到Connectivity &amp; security部分。您将在这里看到数据库实例的端点和端口，这是连接到数据库所需要的。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mp"><img src="../Images/6f6f590f4aa2518f31af10b73feab046.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pCOUKQh5jHsAn7ILt92Haw.png"/></div></div></figure><p id="588a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在从MySQL Workbench连接到数据库实例之前，我们必须编辑RDS实例的VPC安全组规则。在Connectivity &amp; security部分，单击您的实例的默认VPC安全组。选择安全组的入站规则选项卡，然后单击“编辑入站规则”。默认情况下，安全组被配置为允许来自VPC安全组内部的所有流量，因此我们需要添加另一个入站规则来允许来自任何IP地址的所有流量。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mp"><img src="../Images/ac2bb682ebb2be5444d0ba7eaa6faa7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*arQSWfypI1HYT4mpOl3z1Q.png"/></div></div></figure><p id="6cdd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">保存规则。现在，您将能够在MySQL Workbench中添加连接，并使用端点地址作为主机名以及您创建的主用户名和密码连接到您的RDS实例。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mq"><img src="../Images/74a6098de99f13ae9136f5323b743f60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ErgaYsXs-NGw-hJPqbWbwg.png"/></div></div></figure><p id="ce59" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">打开到RDS实例的连接，您会注意到在左侧的SCHEMAS选项卡中已经为我们创建了“playlist”数据库。我们将运行几个简单的SQL命令，在数据库中创建一个表，并向表中添加一些数据。</p><pre class="kp kq kr ks gt mr ms mt mu aw mv bi"><span id="c172" class="mw li it ms b gy mx my l mz na">use playlist;</span><span id="e4ec" class="mw li it ms b gy nb my l mz na">create table playlist (<br/>    playlist_name varchar(100) not null,<br/>    song_name varchar(100) not null,<br/>    artist varchar(100) not null,<br/>    album varchar(100),<br/>    primary key (playlist_name, song_name, artist)<br/>);</span><span id="209c" class="mw li it ms b gy nb my l mz na">insert into playlist (playlist_name, song_name, artist) values ('#1', 'Your Song', 'Elton John');<br/>insert into playlist (playlist_name, song_name, artist) values ('#1', 'Hey Jude', 'The Beatles');<br/>insert into playlist (playlist_name, song_name, artist, album) values ('#1', 'Hotel California', 'The Eagles', 'Hotel California');<br/>insert into playlist (playlist_name, song_name, artist, album) values ('#1', 'Stairway to Heaven', 'Led Zeppelin', 'Led Zeppelin IV');</span></pre><p id="53de" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们已经创建了数据库并将数据插入到表中，我们可以将注意力转移到设置Lambda函数上了。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="c92e" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">4.创建你的Lambda函数</h1><p id="1ba4" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">现在是时候设置你的Lambda函数了。打开Lambda服务并确保选择了Functions dashboard。我建议在已经创建的RDS实例所在的区域创建Lambda函数。</p><p id="f8f7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">选择“创建函数”并给你的函数起一个名字，我在本教程中使用了“get-playlist-rds”。使用Python 3.8作为运行时，将“创建一个具有基本Lambda权限的新角色”作为执行角色。创建您的函数。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nc"><img src="../Images/bf0e40f48f93db5a47eb1e5161abab6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oA0Po9jNw9iJXTvLB8r6-w.png"/></div></div></figure><p id="ea0e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">默认情况下，pymysql库对Lambda函数不可用，因此我们需要导入它，以便它可以用于连接RDS。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="babc" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">5.添加pymysql库作为Lambda层</h1><p id="bdec" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">在我们可以将pymysql库作为Lambda层添加之前，我们必须首先将这个库打包成一个zip文件。在本教程中，我将解释如何在Windows上做到这一点，但在Mac/Linux上也可以遵循类似的过程。</p><p id="be42" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您需要在本地Windows PC上安装python，并且python版本应该与您为Lambda函数选择的运行时版本相匹配，在本例中为Python 3.8。您还需要安装pip，以便下载pymysql包。这里有一个<a class="ae mk" href="https://phoenixnap.com/kb/install-pip-windows" rel="noopener ugc nofollow" target="_blank">链接</a>指向如何在Windows上这样做的说明。</p><p id="7420" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦在您的PC上安装了pip，打开命令提示符并导航到您想要的目录，然后运行以下命令。</p><pre class="kp kq kr ks gt mr ms mt mu aw mv bi"><span id="d110" class="mw li it ms b gy mx my l mz na">pip install --target ./python pymysql</span></pre><p id="9059" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将在所需的目录中创建一个名为python的文件夹。然后，您需要将python文件夹压缩为zip文件，以便我们可以将其上传到AWS。</p><p id="e18f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在Lambda控制台窗口中，从左侧菜单中选择层选项，然后单击“创建层”。给你的图层命名为“pymysql ”,上传你刚刚创建的zip文件。选择Python 3.8作为兼容的运行时，然后单击“创建”。</p><p id="4ae0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">回到你已经创建的“get-playlist-rds”功能，点击Designer部分的图层。然后，您可以添加刚刚创建的自定义层(选择版本1)。现在，您已经准备好配置Lambda函数的其余部分了。</p><p id="3355" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ml">注意:</em> </strong>将Lambda层添加到您的函数的替代方法是直接将zip文件上传到您的Lambda函数(在函数代码部分的操作菜单下)。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="cb71" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">6.从Lambda函数连接到数据库</h1><p id="489c" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">既然pymysql库对您的Lambda函数代码可用，您可以添加下面的代码来允许您连接到RDS实例。该代码设置从rds_config导入的数据库连接属性，创建到数据库的连接，并执行一个简单的查询来从我们创建的“playlist”表中获取所有数据。lambda函数在HTTP响应的主体中返回这些数据，该响应可以从API Gateway调用(我在之前的<a class="ae mk" href="https://medium.com/swlh/aws-api-gateway-lambda-dynamodb-71bb930abe51" rel="noopener">教程</a>中讨论过这一点)。</p><pre class="kp kq kr ks gt mr ms mt mu aw mv bi"><span id="277a" class="mw li it ms b gy mx my l mz na">import json<br/>import pymysql<br/>import rds_config</span><span id="a990" class="mw li it ms b gy nb my l mz na">rds_host = rds_config.db_endpoint<br/>name = rds_config.db_username<br/>password = rds_config.db_password<br/>db_name = rds_config.db_name<br/>port = 3306</span><span id="588d" class="mw li it ms b gy nb my l mz na">try:<br/>    conn = pymysql.connect(host=rds_host,user=name,<br/>                           passwd=password,db=db_name,<br/>                           connect_timeout=5,<br/>                           cursorclass=pymysql.cursors.DictCursor)</span><span id="4abd" class="mw li it ms b gy nb my l mz na">except:<br/>    sys.exit()</span><span id="16e7" class="mw li it ms b gy nb my l mz na">def lambda_handler(event, context):</span><span id="fdfb" class="mw li it ms b gy nb my l mz na">    with conn.cursor() as cur:<br/>        qry = "select * from playlist"<br/>        cur.execute(qry)</span><span id="e7c2" class="mw li it ms b gy nb my l mz na">        body = cur.fetchall()</span><span id="fe44" class="mw li it ms b gy nb my l mz na">    return {<br/>        'statusCode': 200,<br/>        'headers': {<br/>            'Access-Control-Allow-Origin': '*',<br/>            'Access-Control-Allow-Headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token',<br/>            'Access-Control-Allow-Credentials': 'true',<br/>            'Content-Type': 'application/json'<br/>        },<br/>        'body': json.dumps(body)<br/>    }</span></pre><p id="4291" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下一步是将rds_config文件添加到Lambda函数中，以获取Lambda函数代码中引用的数据库属性。在Function code部分，选择File &gt; New File，并将文件命名为rds_config.py。您将在此处添加rds实例的配置属性。文件的结构如下所示，用RDS实例的值替换变量。</p><pre class="kp kq kr ks gt mr ms mt mu aw mv bi"><span id="d888" class="mw li it ms b gy mx my l mz na">db_endpoint = '<em class="ml">your_rds_endpoint_address'<br/></em>db_username = '<em class="ml">your_master_username'<br/></em>db_password = '<em class="ml">your_master_password'<br/></em>db_name = '<em class="ml">your_database_name'</em></span></pre><p id="7e93" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在与RDS实例通信之前，您需要将Lambda函数添加到与RDS实例相同的VPC中。为此，您需要更新Lambda执行角色，以附加NetworkAdministrator策略。在Lambda函数的Permissions选项卡中，单击角色名称以打开IAM控制台，您可以在其中附加策略。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nd"><img src="../Images/b874dddb406155dbf2d8713f96fb8370.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nmpcq-kBgZcXC0omEqADkg.png"/></div></div></figure><p id="6bc0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，您可以返回到Configuration选项卡，配置VPC以匹配RDS实例VPC配置，如上面的第3节所示。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ne"><img src="../Images/1a26ab8c658a26a623f3012934467b90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-er7lmFpARxEIKatz497Bw.png"/></div></div></figure><p id="46cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你现在已经准备好测试你的Lambda函数了。在Lambda函数控制台窗口的右上角，选择“选择测试事件”下拉菜单，然后单击“配置测试事件”。AWS附带了许多已经配置好的测试事件模板，您可以使用“hello-world”模板。给你的测试事件命名并创建。单击“测试”按钮，验证您的功能是否成功执行。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="a7da" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">6.结论</h1><p id="7942" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">现在，您已经成功地创建了一个简单的RDS实例，并通过创建pymysql层设置了一个Lambda函数来查询数据库的内容。</p></div></div>    
</body>
</html>