# 用 JWT 保护应用程序的简介

> 原文：<https://levelup.gitconnected.com/a-brief-introduction-to-securing-applications-with-jwt-2004e9f6c829>

## 了解什么是 JWT，它是如何工作的，以及它如何保护我们的应用程序的安全

![](img/93998b46e1fc7e39037429b967ccef14.png)

[迈卡·威廉姆斯](https://unsplash.com/@mr_williams_photography?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/s/photos/safe?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍照

JSON Web 令牌已经成为现代开发人员在实现用户认证时最喜欢的选择。JWT 的流行显然是因为它给应用程序开发带来的好处。在这篇文章中，我们将深入探讨 jwt，为什么它们在其他身份验证选项中脱颖而出，以及在使用它们时应该注意什么。

# 什么是 JWT 代币？

JWT 是一种独立的方法，可用于在两个端点之间安全地传输数据。jwt 最常用于用户认证。它们还可以用来安全地交换信息。在这篇文章中，我们将介绍 jwt 如何用于用户认证。然而，使用 JWT 的信息交换遵循与用户认证大致相同的步骤。

涉及 jwt 的认证过程遵循以下步骤。当用户第一次登录应用程序时，系统后端向用户发出一个 JWT，并将其发送到客户端。该令牌包含一个特殊的签名，用于验证该令牌是否为系统颁发的令牌。客户端将令牌存储在浏览器中，并将它与每个请求一起发送到服务器，在服务器中，令牌用于验证用户的身份。

JWT 由三根用句点分隔的琴弦组成。其中 3 个是报头、有效载荷和签名。下面是一个由这三部分组成的 JWT 令牌的例子。

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJteXdlYnNpdGUuY29tIiwiaWF0IjpudWxsLCJleHAiOjUxNDM3ODA4MDAwLCJhdWQiOiIiLCJzdWIiOiIiLCJpZCI6IjEyMzQ1OTEiLCJuYW1lIjoiTWFyeSBQb3BwaW5zIiwicm9sZSI6ImVkaXRvciJ9.LYKHdyKj6SnxYaRZH_ZhiW6yk31zaBQehYm4BgawH_o
```

![](img/b531602e448622fd58aa367f39d54154.png)

让我们看看这些部分对令牌的整体构成有什么贡献。

## 页眉

JWT 头包含 JSON 格式的关于令牌的元数据。报头中的两个字段是 alg 和 typ。“alg”指定了在生成签名时用于对令牌进行签名的算法，我们稍后会谈到这一点。“typ”指定令牌的类型，即“JWT”。下面的示例显示了一个典型的令牌头。

```
{
    "alg": "RS256",
    "typ": "JWT"
}
```

在这里，标头声明用于标记令牌的算法是 RS256。

在 base64url 中编码后，头被存储为令牌的第一部分。

## 有效载荷

JWT 的有效负载以 JSON 格式存储关于令牌和任何其他实体的信息。通常，用于身份验证的 JWT 存储了一些关于用户的重要信息，比如用户 ID 和用户角色。存储用户信息的令牌通常如下所示。

```
{
    "id": "1234591",
    "name": "Mary Poppins",
    "role": "editor"
}
```

这些存储在有效负载中的 JSON 字段被称为声明。

此外，还有一些索赔是由 JWT 标准定义的。没有必要在 JWT 中包含所有这些声明，但在大多数情况下，至少包含其中的一些是有益的。这里有一些我们可以使用的标准声明。

*   iss:定义令牌的颁发者。
*   exp:提供令牌的到期时间。一旦过期，令牌就不再有效。
*   aud:定义令牌的受众。
*   iat:存储颁发令牌的时间。

让我们看看带有一些标准声明的有效载荷是什么样子的。

```
{
    "id": "1234591",
    "name": "Mary Poppins",
    "role": "editor",
    "iss": "mywebsite.com",
    "exp": 3600
}
```

JWT 的有效载荷可以包含任意多的信息字段，但建议尽量保持较小的大小。此外，您不应该在有效负载中存储敏感信息，如用户密码，因为它没有加密。它只是用 base64url 编码。

## 签名

JWT 令牌的最后一部分，即签名，是一个消息认证码，用于验证令牌未被授权的应用服务器以外的其他人修改或生成。

通过使用加密算法和存储在服务器中的秘密对组合的 JWT 报头和有效载荷进行签名来生成签名。只有拥有令牌头、有效载荷和秘密的人才能生成服务器接受的签名。因此，使用强秘密来加密令牌并将其安全地存储在服务器中是很重要的。

如果我们使用像 HMAC·SHA-256 这样的对称算法，发布 JWT 的服务器和验证 JWT 的服务器应该可以安全地访问这个秘密。如果使用 RS256 这样的非对称算法，我们可以使用公钥-私钥系统，其中私钥用于标记令牌，公钥用于验证令牌。

正如你已经猜到的，签名是 JWT 令牌中最关键的部分。它将未经身份验证的来源排除在应用程序之外，保证了一切的安全。当发出的 JWT 随着来自客户端的每个请求被发送回服务器时，服务器检查签名以验证它是由系统本身发出的令牌，然后继续为客户端请求提供服务。

![](img/df3c4973da1c21aa34ae610f4589a516.png)

# JWT 有什么特别之处？

随着我们逐渐了解 JWT 令牌的构成，您可能会想，与其他身份验证方法(尤其是基于会话的身份验证)相比，是什么让它如此特别。

JWT 最重要的特点是它的无国籍性。在上一节中，我们看到了什么样的数据可以存储在 JWT 中，验证令牌和识别用户所需的所有数据都存储在令牌本身中。不需要在服务器中维护令牌的任何记录，就像我们在会话中那样将令牌存储在数据库中。这使得 jwt 成为无状态的。

这种无状态的特性给了我们 JWTs 带来的最大好处:发布 JWT 的服务器和验证它的服务器不必是同一个服务器。一台服务器可以发布 JWT 并执行身份验证任务，而实现应用程序逻辑的另一台服务器可以独立于第一台服务器验证 JWT。

在 API 后端和微服务架构应用的时代，这允许开发人员将所有认证任务委托给一个服务器，而其他服务器实现应用逻辑，并尽可能地分离系统。

当 JWT 证书的颁发和验证由不同的服务器执行时，使用公钥-私钥系统是最好的方法。在这种情况下，私钥应该安全地存储在身份验证服务器中。

# 如何将 JWT 令牌从客户端发送到服务器，反之亦然？

当在服务器和客户端之间来回发送 JWT 时，我们可以将它和授权 HTTP 头一起发送。然而，通过 HTTP 连接发送令牌使它们容易受到中间人(MITM)攻击和被盗令牌的攻击。因此，在使用 jwt 时，使用安全的 HTTP 连接是非常重要的。

在 HTTP 头中发送令牌的另一个问题是，在这种方法中，令牌通常存储在客户端浏览器的本地存储中。这使得令牌有可能被跨站点脚本(XSS)攻击窃取。

作为一个解决方案，您可以在 cookie 中发送令牌，而不是在授权头中。设置 cookie 的 HttpOnly 和 secure 标志以防止攻击者使用 XSS 攻击窃取令牌是非常重要的。

# 让您的 JWT 代币过期

如果 JWT 令牌以某种方式被第三方窃取，他们可以使用窃取的令牌访问应用程序并获得令牌所有者的特权。作为这个问题的解决方案，我们可以为 jwt 设置一个短的到期时间。这样，即使攻击者窃取了令牌，他们也无法长时间利用它来造成不良影响。

我们可以在有效负载中设置 exp 声明，为令牌提供一个短的过期时间。然而，这一行动并没有消除被盗令牌的威胁，只是减少了它导致严重攻击的机会。

在真实的应用程序中，为 JWTs 设置一个短的过期时间并不像听起来那么简单。如果我们创建了在创建 10 分钟后过期的令牌，这将极大地降低应用程序用户的用户体验。用户有多大可能容忍每 10 分钟重新登录一次你的应用程序？

但是有一个解决方案:刷新令牌。

# 刷新令牌—它们是什么？

由于每次 JWT 令牌在短时间内到期后要求用户再次登录不是一个好的解决方案，开发人员已经在刷新令牌中找到了解决方案。

刷新令牌是具有更长到期时间的 JWT 令牌。它用于在每次旧的接入令牌到期时发布新的接入令牌，新的接入令牌也是 JWT 令牌，但是具有更短的到期时间。

在这种情况下，访问令牌是在客户端和服务器之间来回发送的令牌，具有很短的过期时间。但是，当访问令牌在短时间内到期时，服务器不会要求用户再次登录，而是使用刷新令牌来生成新的访问令牌。刷新令牌存储创建新的访问令牌所需的数据。

![](img/1372d6fee0b83a140a94bfc65a5ce552.png)

由于刷新令牌有很长的过期时间，并且在任何情况下都不会被传递到客户端，所以我们应该将它们存储在后端数据库中。如果攻击者以某种方式获得了刷新令牌的访问权，鉴于刷新令牌的过期时间较长，这将对系统和刷新令牌的所有者构成严重的安全威胁。因此，刷新令牌必须在最高安全措施下存储。

用户在登录系统时首先会收到一个刷新令牌。然后，令牌存储在安全的数据库中。您可以在每次生成新的访问令牌时发布新的刷新令牌，以确保被盗刷新令牌的安全影响较低。

当刷新令牌过期时，用户必须再次登录到应用程序并获得新的刷新令牌。

如果 JWT 颁发和验证由不同的服务器处理，那么需要注意的是，使用刷新令牌颁发访问令牌是由身份验证服务器处理的任务。

# 结论

JWT 是一个现代化的、健壮的解决方案，用于在不维护状态的情况下认证用户和共享敏感信息。JWT 由三部分组成:报头、有效载荷和签名。尽管 jwt 在现代应用程序开发中有很多好处，但是我们需要采取一些特殊的措施来确保令牌和用户数据的安全性。在 cookies 中而不是在头部发送 jwt，缩短它们的到期时间，以及使用刷新令牌来发布新的访问令牌，这些都是我们可以采取的一些安全措施，以保证我们的应用程序、其用户及其数据的安全性。

在后续的文章中，我们将在一个 API 上实现所有这些。

感谢阅读！