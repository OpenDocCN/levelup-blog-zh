<html>
<head>
<title>What Can Snowflake’s Time Travel Really Do For You?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">雪花的时间旅行真的能为你做些什么？</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/what-can-time-travel-really-do-for-you-e24815ff5c0f?source=collection_archive---------4-----------------------#2021-06-14">https://levelup.gitconnected.com/what-can-time-travel-really-do-for-you-e24815ff5c0f?source=collection_archive---------4-----------------------#2021-06-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7cda" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用雪花的时间旅行功能优化您的工作流程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0eac6feda12aa43f9749e5df0ab88654.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AoK3i-pt-3_YuaG8"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@deloreanrental?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">德罗林出租</a>拍摄</figcaption></figure><p id="ba0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">雪花的一个很棒的功能是“时间旅行”<a class="ae ky" href="https://docs.snowflake.com/en/user-guide/data-time-travel.html" rel="noopener ugc nofollow" target="_blank">(这里有文档)</a>，它允许你设置你的表格，这样你就可以回到过去90天。这可能看起来只是另一个“很酷”的功能，但它远不止于此...这是改善你工作流程的好方法，可以节省你很多时间和麻烦。让我们直接开始吧。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="97ad" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">调试您的ETL失败(使用“当时看起来”的数据)</h1><p id="8576" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这是周五晚上，你在家看爱情岛<em class="mz">(你知道你做…) </em>，与此同时，财务月末对账脚本正在制作中失败。周末过去了。周一早上，你来到办公室，看到的是:一个红色的大盒子，一堆提醒，还有你最喜欢的财务人员向你询问最新进展。您重新运行脚本，它成功了！等等，怎么会这样？什么变了？？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/9a3753d397e2c43ac8f1abc97e4626bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CVCYfSKMY_514XvJ"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@brucemars?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">布鲁斯·马尔斯</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="c6a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是典型的<em class="mz">什么？成功了？我错过了什么？？</em>“场景:不知道它为什么从失败到成功意味着你可能有一个漏洞在雷达下:如果你没有发现它，它可能会再次发生！不好…</p><p id="031b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在是时候从你的魔术包里拿出时间旅行了！</p><p id="168c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您只需转到Snowflake控制台的history，检查失败的query_id，然后回到当时的上下文:</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="b588" class="ng md it nc b gy nh ni l nj nk">(...)<br/>SELECT this, and, that, sum(other)<br/>FROM super_important_table AT (STATEMENT=&gt; "....")<br/>INNER JOIN more_of_that AT (STATEMENT=&gt; "....")<br/>    ON this=this<br/>GROUP BY this, and, that;<br/>(...)</span></pre><p id="5165" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">公园散步！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7d53" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">回归测试</h1><p id="0f64" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">你正在调整一个通宵脚本的性能:删除那个，移动那个，删除这个，改进那里的连接。在它的结尾，剧本看起来是惊人的和最佳的。你测试了它，它看起来很好，但是你怎么能确定它在生产中100%地工作呢？这个问题很容易回答，甚至比找出这些图片中的7个不同点还要简单:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/80234261d82cc825f2c017eb09e31540.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e4-JWKjBz20OYJTRoxpq_g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">找出7个不同点！(感谢<a class="ae ky" href="https://games.kidzsearch.com/" rel="noopener ugc nofollow" target="_blank">https://games.kidzsearch.com/</a>)</figcaption></figure><p id="30cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将变更投入生产，并引发新一轮运行。然后你将它的样子与它之前的样子进行比较(使用时间旅行):</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="1436" class="ng md it nc b gy nh ni l nj nk">select 'before' when, hash_agg(*) <br/>from table AT (TIMESTAMP=&gt; date_add('hour',-1,current_timestamp))</span><span id="980c" class="ng md it nc b gy nm ni l nj nk">union all</span><span id="d728" class="ng md it nc b gy nm ni l nj nk">select 'after' when, hash_agg(*) <br/>from table</span></pre><p id="6c4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果整个表的哈希值匹配，就可以开始了。</p><p id="65d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果不匹配呢？好吧，那么你总是可以做好旧的“减/除”，或任何其他你喜欢的策略来找到哪些行改变了，为什么:</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="a412" class="ng md it nc b gy nh ni l nj nk">select * <br/>from table AT (TIMESTAMP =&gt; date_add('hour', -1, current_timestamp) )</span><span id="cd92" class="ng md it nc b gy nm ni l nj nk">minus</span><span id="d4f1" class="ng md it nc b gy nm ni l nj nk">select * from table</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6ad6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">维度版本控制被扭曲了，有重复的！现在怎么办？？</h1><p id="1438" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们都见过这种情况发生…有一天，由于一个错误或缺乏更好的了解，发生了一些事情，搞砸了所有的客户端维度有效性字段。我见过这样的错误花费一整天来正确修复，因为拥有重复版本或从来不存在的版本的所有代理键下游影响，突然你有几十个事实和dim需要修复。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/279709ae37404edb00712973337d2e1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9wEA9e3itsuKrbH0"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@yoshginsu?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">约什·金斯利</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="2a78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在过去，你可能会被一整天的选择和更新所困扰，或者恢复一个备份(<em class="mz">让我们面对它，这是一个巨大的痛苦，需要很长时间… </em>)，但现在不是了！现在你有了…你猜对了，时间旅行！只要及时回到你需要的桌子。如果你知道哪些实体被损坏了，你可以有选择地这样做:</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="f096" class="ng md it nc b gy nh ni l nj nk">CREATE TEMP TABLE please_save_me_from_myself AS <br/>SELECT * <br/>FROM table AT (TIMESTAMP =&gt; "before_i_screwed_up"::timestamp)<br/>WHERE some_col in ('damaged', 'records');</span><span id="722d" class="ng md it nc b gy nm ni l nj nk">DELETE FROM table WHERE some_col in ('damaged', 'records');<br/>INSERT INTO table <br/>SELECT * <br/>FROM please_save_me_from_myself;</span></pre><p id="1f9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是如果真的是审判日，你的大部分桌子都完蛋了呢？不要担心，只要在您喜欢的时候克隆DWH模式，重新运行ETL，然后继续您的下一个任务！</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="4c9a" class="ng md it nc b gy nh ni l nj nk">CREATE SCHEMA PRE_DOOM <br/>CLONE DWH <br/>AT (TIMESTAMP=&gt;'before_doom'::timestamp);</span><span id="4524" class="ng md it nc b gy nm ni l nj nk">ALTER SCHEMA PRE_DOOM <br/>SWAP WITH DWH;</span></pre><p id="47db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用一个简单的DDL就可以将几行数据恢复到一个完整的数据库，这有很多种组合方式…拜托，这很酷，对吧？</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="236a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">额外提示:使用HASH_AGG进行数据集比较</h1><p id="5a03" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这有点偏离了本文的主题，但是您可能已经注意到我在其中一个脚本中使用了一个名为HASH_AGG的函数。好吧，如果这是你第一次看到它，你必须仔细阅读它，并把它加入你的军火库。</p><p id="b800" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我第一次使用它是在Greenplum，这是一种非常棒的回归测试/匹配2个表的方法。因为它计算一个表的完整散列<em class="mz">(高度可并行化的操作)</em>，所以这是匹配两个数据集的最快和最有效的方法。此外，因为它只是一个类似于<em class="mz"> sum() </em>或<em class="mz"> avg() </em>的聚合，所以您可以聚合您喜欢的任何列(如果您觉得懒，甚至可以聚合<em class="mz"> all * </em>列)，您可以根据您需要的任何列进行分组，也可以过滤数据集。</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="a43c" class="ng md it nc b gy nh ni l nj nk">select hash_agg(col1::int, col2) <br/>from table_A <br/>where date=current_date;</span><span id="7708" class="ng md it nc b gy nm ni l nj nk">select hash_agg(col1, col2::varchar) <br/>from table_B;</span></pre><p id="26da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它可以无缝地处理空值和复杂数据类型，但是请注意，任何微小的偏差都会产生差异<em class="mz">(即。1.01 != 1.011) </em>，数据类型确实很重要<em class="mz">(即。1 != '1') </em>。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f4e5" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="f48d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这些都不是真正的突破性或火箭科学，但我认为我们有时会太沉迷于鼠标滚轮，以至于忘记利用我们周围的一些可用功能。在过去的几年里，我用了很多次，它们已经成了我的面包和黄油，但是有一天有人说"<em class="mz">哦，哇，你可以在雪花里做这个？</em>“那时我意识到这真的不是面包和黄油。所以我决定分享，希望它可以帮助别人。</p><p id="4589" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢你阅读这篇文章，干得好！下次见！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e289" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">雪花系列</h1><p id="7646" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated"><em class="mz">这篇文章是我的(不断成长的)雪花系列的一部分。如果你很好奇想了解更多关于雪花的知识，这些文章可能也会让你感兴趣:</em></p><ul class=""><li id="c8c2" class="no np it lb b lc ld lf lg li nq lm nr lq ns lu nt nu nv nw bi translated"><a class="ae ky" href="https://jmarquesdatabeyond.medium.com/what-makes-snowflake-so-much-better-than-others-58e839e29e80" rel="noopener">是什么让雪花比其他的好那么多</a></li><li id="51a4" class="no np it lb b lc nx lf ny li nz lm oa lq ob lu nt nu nv nw bi translated"><a class="ae ky" href="https://jmarquesdatabeyond.medium.com/migrating-to-snowflake-here-is-what-you-need-to-know-8310b84d2741" rel="noopener">迁移到雪花？下面是你需要知道的</a></li><li id="eda3" class="no np it lb b lc nx lf ny li nz lm oa lq ob lu nt nu nv nw bi translated"><a class="ae ky" href="https://jmarquesdatabeyond.medium.com/snowflake-configurations-you-probably-didnt-know-existed-ccc0c56c9d21" rel="noopener">你可能不知道存在的雪花结构</a></li><li id="527b" class="no np it lb b lc nx lf ny li nz lm oa lq ob lu nt nu nv nw bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/using-snowflake-dont-make-these-expensive-mistakes-66c1eaa7d1ee">使用雪花？不要犯这些代价高昂的错误</a></li><li id="9d87" class="no np it lb b lc nx lf ny li nz lm oa lq ob lu nt nu nv nw bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/near-realtime-data-ingestion-in-snowflake-7033d45ce860"> <em class="mz">雪花中的近实时数据摄取(以及如何实现热/冷/冻结数据存储策略)</em> </a></li><li id="221f" class="no np it lb b lc nx lf ny li nz lm oa lq ob lu nt nu nv nw bi translated"><a class="ae ky" href="https://jmarquesdatabeyond.medium.com/using-snowflake-external-tables-you-must-read-this-aeb66ae8e0e6" rel="noopener"> <em class="mz">使用外部表时的性能考虑</em> </a></li></ul></div></div>    
</body>
</html>