# 重用 TCP 端口是为了乐趣、利润和减少麻烦

> 原文：<https://levelup.gitconnected.com/reusing-tcp-ports-for-fun-profit-and-lack-of-headaches-cd57e7859dbb>

![](img/a38ab762328af10d7fac8770ddb9199b.png)

上周，我在问题跟踪系统中查看了一些老问题，这些问题在我任职之前就已经解决了。在浏览它们的时候，我注意到了一个未解决的问题，它包含了来自我之前的系统管理员和来自一个应用程序的开发人员的大量更新，这个应用程序每天运行几次，但是运行时总是有问题。

应用程序(它是用 Java 编写的)抛出的错误如下:

`java.net.NoRouteToHostException: Can’t assign requested address (Address not available)`

# 可能的原因

关于这个问题的所有更新都“指向”被调用的数据库集群，以便应用程序存储其输出(顺便说一下，引号是有目的的，只是等待和阅读)。现在，我可以看到两个团队讨论错误和可能的解决方案的一年的互动，但不知何故，他们都设法将错误“指向”数据库集群。

请注意，这是一个 Percona 集群，可以处理数万个连接，不包括并发性。很结实的东西。这是由一个我认识的同事*配置的*可以胜任他的工作，但是因为这张票引起了我的注意，我决定试一试。

# 解决纷争

我必须做的故障诊断的最初几步是排除所有明显的结论(一年的工作，记得吗？)我的同事来了；这让我想到了珀科纳星团。由于这是一个生产系统，我不能真正强调它，因为我知道我的测试会引起开发人员和管理人员不必要的注意，他们一看到度量标准上没有预期的东西就开始大喊狼来了。因此，我只是将大约 30k 个并发会话放入集群中，而这并不费事。

所以，下一步就是。在检查了 Java 的整个错误日志后，我注意到了错误，并决定从部署应用程序的地方 SSH 到应用服务器，当我连接到它时，我收到了一条 Slack 消息，要求我不要玩它，因为它正在生产中！！！

很自然地，我做了每个系统管理员至少做一次(一天)的事情，忽略了开发人员，开始检查我能得到的每一个日志，并注意到那些机器特有的东西，它们没有重用 TCP 连接。如您所见，它并没有“指向”数据库问题。这些类型的数据库集群被设计为在巨大的工作负载下运行。

# 可能的解决方案

此时，很明显，机器上部署的应用程序的内部端口不足，为了检查这一点，我使用以下命令检查了执行中的内核参数:

`sysctl -a | grep range`

以及端口的可重用性:

`sysctl -a | grep reuse`

# 更长久的解决办法

这两个命令都满足了我的需求，端口范围也没问题:

`net.ipv4.ip_local_port_range = 15000 65000`

这是意料之中的，因为这是默认行为，但是重用标志没有启用，所以我们只是在文件的内核配置中更改了它:

`/etc/sysctl.conf`

并添加了条目:

`net.ipv4.tcp_tw_reuse = 1`

现场应用:

`sysctl -p`

和，搞定。

瞧啊！

# 最后的想法

当我完成修改后，我走向开发人员的办公桌，描述了我的解决方案，当我告诉他我需要修改一个内核参数时，他的恐怖表情是无价的。他一直在漫无边际地谈论它需要如何安排，因为它需要重新启动，而这是一个必须得到上级批准的生产系统(好在这些类型的更改不需要重新启动)。我只是告诉他已经完成了，并添加了一个简单的“请再次运行应用程序，现在不会失败了”。

希望不会:p