<html>
<head>
<title>Having Fun with Run Length Encoded Sprites</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">享受游程编码精灵的乐趣</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/having-fun-with-run-length-encoded-sprites-662d6a8147c8?source=collection_archive---------8-----------------------#2021-03-22">https://levelup.gitconnected.com/having-fun-with-run-length-encoded-sprites-662d6a8147c8?source=collection_archive---------8-----------------------#2021-03-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8aa00c217376b53f77c1f22835f85d8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G8sC3WaLiVc1UsnhU3BE2Q.png"/></div></div></figure><p id="b2d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2018年，我提交了一份参赛作品给<a class="ae kw" href="https://js1k.com/" rel="noopener ugc nofollow" target="_blank"> JS1k </a>，这是一个现已停办的code高尔夫比赛。那年的主题是“不稳定的硬币矿”，我提交的是一个简单的游戏，你必须在躲避巨石的同时从不稳定的矿里收集硬币。我获得了第十名，这仍然是一个值得骄傲的时刻。</p><div class="kx ky gp gr kz la"><a href="https://mock.xyz/volatile-coin-mine/" rel="noopener  ugc nofollow" target="_blank"><div class="lb ab fo"><div class="lc ab ld cl cj le"><h2 class="bd ir gy z fp lf fr fs lg fu fw ip bi translated">挥发币矿- JS1k 2018</h2><div class="lh l"><h3 class="bd b gy z fp lf fr fs lg fu fw dk translated">JS1k 2018演示:《硬币和巨石》——矿塌了！去拿硬币。避开巨石。</h3></div><div class="li l"><p class="bd b dl z fp lf fr fs lg fu fw dk translated">模拟. xyz</p></div></div></div></a></div><p id="34f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如您可能已经猜到的，JS1k条目必须小于1KB。你要努力把每个字节的最后一滴都挤出来。有很多真正有趣的字节节省技术，其中一些你可以在我的条目的<a class="ae kw" href="https://github.com/andrewb/volatile-coin-mine/blob/master/index.js" rel="noopener ugc nofollow" target="_blank">未压缩源代码</a>中看到。很多会让你畏缩——这些不是真实世界的！</p><p id="4145" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我知道我想在我的游戏中包含一个动画角色，但是由于比赛规则，我不能使用精灵表。我的解决方案是使用游程编码(RLE)来代替。</p><p id="cfaa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在高级别上，RLE是一种压缩形式，其中数据的运行被表示为单个值和计数，而不是原始运行。一会儿我将向你展示这是如何工作的。</p><p id="fb2f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，这是我在游戏中想要的行走动画。只有4帧。这也是对我小时候最喜欢的游戏之一的肯定。</p><figure class="lj lk ll lm gt jr"><div class="bz fp l di"><div class="ln lo l"/></div><figcaption class="lp lq gj gh gi lr ls bd b be z dk translated">步行环路。您也可以在浏览器中查看。</figcaption></figure><p id="8f64" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">每一帧由一个RLE字符串表示。例如，使用<code class="fe lt lu lv lw b">x2d3x3dbx4b3x3bcx4bcx4c2x3ac2x4a2</code>表示第一帧。</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8feb210e8bd8567c11cf431b9e209d46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pdaQZyZeEh_ZlBsV3pjwhw.png"/></div></div><figcaption class="lp lq gj gh gi lr ls bd b be z dk translated">每一帧都用RLE字符串表示</figcaption></figure><p id="ebf2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">乍一看，这些字符串可能看起来有点难以解析，但是一旦理解了规则，就变得非常简单了。</p><ul class=""><li id="32d7" class="lx ly iq ka b kb kc kf kg kj lz kn ma kr mb kv mc md me mf bi translated">每个字母代表一种颜色。在我的代码中<code class="fe lt lu lv lw b">x</code>是透明的，<code class="fe lt lu lv lw b">a</code>是黑色，<code class="fe lt lu lv lw b">b</code>是棕褐色，以此类推。</li><li id="e200" class="lx ly iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">该数字表示前一种颜色应该重复的次数。例如<code class="fe lt lu lv lw b">a2</code>将是2个单位宽。</li><li id="4b60" class="lx ly iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">长度为1的单位不包括数字。</li><li id="779e" class="lx ly iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">玩家精灵有6个单位宽。这意味着一个值为<code class="fe lt lu lv lw b">a6</code>的RLE字符串将代表一条黑线，这条黑线是精灵的全宽。</li><li id="c4a6" class="lx ly iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">你可以把RLE想象成一串像素。例如，在一个6单位宽的精灵中，你用<code class="fe lt lu lv lw b">x3a6</code>而不是<code class="fe lt lu lv lw b">x3a3a3</code>来描述下面的第三个形状。后者是可行的，但是我们不需要额外的2个字节。类似地<code class="fe lt lu lv lw b">a36</code>会画一个黑色的正方形。</li></ul><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/031e88532cca484da0e3a624dc5c16dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ltKO71StVqgP6ovlquDUhQ.png"/></div></div></figure><p id="5718" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我还为所有其他的角色造型和游戏资产使用了RLE。其中一些对玩家精灵有不同的尺寸，例如硬币和巨石是4个单位宽而不是6个单位。</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3eb37ab0eca96fb8b57333a6ec6e632e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_1uQH0pBhygzejB9mICr1g.png"/></div></div></figure><p id="790a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，RLE也可以用不同的方式来表达。在一些实现中，字母的位置被交换，即数字在字母之前。</p><h1 id="3351" class="ml mm iq bd mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni bi translated">渲染精灵</h1><p id="8527" class="pw-post-body-paragraph jy jz iq ka b kb nj kd ke kf nk kh ki kj nl kl km kn nm kp kq kr nn kt ku kv ij bi translated">我的条目中的<a class="ae kw" href="https://github.com/andrewb/volatile-coin-mine/blob/master/index.js#L21-L54" rel="noopener ugc nofollow" target="_blank"> sprite渲染代码</a>可读性不是很好，因为它是针对一个非常具体的用例进行优化的。我们改写一下，供一般消费。</p><p id="bee1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先必须解码字符串。这个函数会将类似于<code class="fe lt lu lv lw b">x3b3</code>的字符串转换成<code class="fe lt lu lv lw b">xxxbbb</code>。该函数使用<code class="fe lt lu lv lw b"><a class="ae kw" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace" rel="noopener ugc nofollow" target="_blank">replace</a></code>和一个简单的正则表达式，该表达式将匹配后面跟有一个或多个数字的任何单词字符。<code class="fe lt lu lv lw b">replace</code>的第二个参数是一个函数，它将匹配的单词字符(<code class="fe lt lu lv lw b">\w</code>)重复必要的次数(<code class="fe lt lu lv lw b">\d+</code>)。</p><figure class="lj lk ll lm gt jr"><div class="bz fp l di"><div class="no lo l"/></div></figure><p id="d778" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">字符串解码后，渲染sprite就相对简单了。</p><p id="3413" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一步是将解码后的字符串转换成一个数组，并遍历每个字符。当前像素的颜色可以通过将字符(例如<code class="fe lt lu lv lw b">a</code>)映射到调色板来找到。接下来，必须找到x和y坐标。这些是使用精灵的当前索引和宽度(单位)计算的。</p><p id="0265" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，当前“像素”被绘制到屏幕上。在这个例子中，我使用HTML画布和<code class="fe lt lu lv lw b">fillRect</code>。</p><figure class="lj lk ll lm gt jr"><div class="bz fp l di"><div class="no lo l"/></div></figure><p id="c8ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe lt lu lv lw b">width</code>参数允许该函数渲染不同尺寸的子画面，例如4个单位宽。<code class="fe lt lu lv lw b">scale</code>参数用于增加每个“像素”的大小，例如，<code class="fe lt lu lv lw b">scale</code>为5会将每个精灵的“像素”渲染为一个5×5px的块。</p><figure class="lj lk ll lm gt jr"><div class="bz fp l di"><div class="no lo l"/></div></figure><p id="d8b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以在Repl.it 上看到<a class="ae kw" href="https://replit.com/@AndrewBerry1/RLE#script.js" rel="noopener ugc nofollow" target="_blank">完整步行循环示例的示例代码。如果你想在我的JS1k条目中看到我是如何处理的，你可以在Github </a>上查看<a class="ae kw" href="https://github.com/andrewb/volatile-coin-mine/blob/master/index.js" rel="noopener ugc nofollow" target="_blank">未压缩的源代码。</a></p><p id="e4ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">RLE可以是一个有用的方式来代表小精灵。在JS1k之外，它不一定是我的第一选择，但是除了节省字节之外还有其他好处。例如，调色板可以很容易地改变(包括在飞行中)，资产很容易存储和加载，因为它们只是字符串。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><p id="5065" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">[1]例如可以用<code class="fe lt lu lv lw b">~~n</code><strong class="ka ir"/>代替<code class="fe lt lu lv lw b">Math.floor(n)</code>，<code class="fe lt lu lv lw b">+'1'</code>代替<code class="fe lt lu lv lw b">parseInt('1', 10)</code>。Can被强调——我绝不会在规范高尔夫之外做这件事。</p></div></div>    
</body>
</html>