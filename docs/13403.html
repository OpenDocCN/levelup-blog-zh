<html>
<head>
<title>How to Connect to AWS ElastiCache Redis in Spring Boot App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Spring Boot App中连接AWS ElastiCache Redis</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-connect-to-aws-elasticache-redis-in-spring-boot-app-9dd2e0908467?source=collection_archive---------2-----------------------#2022-09-02">https://levelup.gitconnected.com/how-to-connect-to-aws-elasticache-redis-in-spring-boot-app-9dd2e0908467?source=collection_archive---------2-----------------------#2022-09-02</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="993d" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">如何在Spring Boot用测试容器复制Redis</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/8f10e37352a05bec2e85e522067b1de3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nl-_yVmLa4ZR2dHbgSTMfQ.jpeg"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://www.pexels.com/photo/crop-male-freelancer-drinking-water-while-watching-laptop-in-kitchen-4050445/" rel="noopener ugc nofollow" target="_blank">弗拉达·卡尔波维奇</a></figcaption></figure><p id="9e0d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv"> <em class="lw">你需要连接Spring Boot的AWS ElastiCache Redis。此外，您需要准备部署。</em> </strong></p><p id="407c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">假设你想在本地Redis上测试一些东西，并为AWS ElastiCache Redis做准备。你可能会遇到几个问题。其中一个可能是AWS ElastiCache Redis中的<a class="ae kz" href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/in-transit-encryption.html" rel="noopener ugc nofollow" target="_blank">传输中加密</a>。</p><p id="c328" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此外，你会发现大多数教程不涵盖主/副本设置。您可以使用Spring Data Redis找到必要的配置。尽管如此，还是有一些缺失的部分。</p><p id="b923" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们开始吧。<strong class="lc iv"> <em class="lw">如果要源代码，这里是</em></strong><a class="ae kz" href="https://zivce.gumroad.com/l/mtwtj" rel="noopener ugc nofollow" target="_blank"><strong class="lc iv"><em class="lw"/></strong></a>。</p></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="1e8d" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">创建Spring Boot应用程序</h1><p id="b28f" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated"><em class="lw">为此需要从依赖关系中得到什么？</em></p><p id="be05" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本教程中，我将重点介绍如何使用Spring Data Redis和Spring Data JPA。你也可以同时使用Spring cache和Redis，这样你的缓存是独立的。但是对于这个场景，我们将把重点放在使用Redis作为数据库，而不是作为缓存。</p><p id="eb09" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此外，我们还需要测试容器和相关的JUnit依赖项。对于web测试客户端，您还需要spring web和spring web flux。对于我偶然发现的一些问题，我也添加了一个<code class="fe nb nc nd ne b">reactor-core</code>。</p><p id="9725" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这是该项目的pom.xml。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><h1 id="9c20" class="me mf iu bd mg mh nh mj mk ml ni mn mo ka nj kb mq kd nk ke ms kg nl kh mu mv bi translated">创建配置和Redis散列实体</h1><p id="fa87" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">我创建了一个虚拟控制器，将产品保存在Redis中。这里重要的是什么？</p><p id="7d2e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">产品需要<code class="fe nb nc nd ne b">@RedisHash</code>注释和注释中的一个键。这样，Redis存储库将实体存储为散列。此外，注释中的名称与Redis键的id相结合。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="6ae1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果需要你可以添加<code class="fe nb nc nd ne b">@TimeToLive</code>方法设置需要的时间单位并返回一个数量单位。Redis存储库将对此进行解析，并在散列上设置TTL。</p><h1 id="0407" class="me mf iu bd mg mh nh mj mk ml ni mn mo ka nj kb mq kd nk ke ms kg nl kh mu mv bi translated">为主副本连接配置莴苣</h1><p id="b09e" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">下面是配置莴苣连接工厂所需的代码。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="d77f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe nb nc nd ne b">RedisStaticMasterReplicaConfiguration</code>配置从<code class="fe nb nc nd ne b">application.yml</code>读取的所需密码和端点。</p><p id="5c3e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">然后在<code class="fe nb nc nd ne b">RedisConnectionFactory</code> bean中我们配置其他参数。最重要的是<code class="fe nb nc nd ne b">clientConfig</code>中的<code class="fe nb nc nd ne b">readFrom</code>。这样，副本更适合于读取，而母版更适合于写入。还有其他选择，但我会留给你去探索。</p><p id="1d32" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">还需要<code class="fe nb nc nd ne b">useSsl</code>和<code class="fe nb nc nd ne b">disablePeerVerification</code>。生菜不支持AWS Elasticcache上的在途加密连接。如果您确定Redis暴露，您可以禁用对等验证。如果Redis只暴露在集群中，中间人攻击应该不是问题。即使没有对等验证，您的连接也是安全的，因为URL将采用<code class="fe nb nc nd ne b">rediss://</code>的形式。</p><p id="dffc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">甚至在Google Cloud <a class="ae kz" href="https://cloud.google.com/memorystore/docs/redis/enabling-in-transit-encryption#configuring_your_client_for_in-transit_encryption" rel="noopener ugc nofollow" target="_blank"> docs </a>上，也提到了莴苣和客户端。有了对自签名证书的支持，就可以实现对等验证。使用对等验证，您可能会遇到问题，例如转换为IP的证书中的<a class="ae kz" href="https://stackoverflow.com/questions/64287424/lettuce-cant-connect-to-redis-cluster-using-ssl-but-can-connect-to-same-redis-s/67511216#67511216" rel="noopener ugc nofollow" target="_blank">主机名。</a></p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="fbee" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您还需要启用Redis存储库并传入所需的存储库。出于这个目的，只有一个类是Redis存储库，您也可以提供一个包。</p><p id="aeac" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这是关于代码中的配置。让我们转到配置属性。</p><h1 id="e27c" class="me mf iu bd mg mh nh mj mk ml ni mn mo ka nj kb mq kd nk ke ms kg nl kh mu mv bi translated">配置应用程序属性</h1><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="0efc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您在application.yml中定义所需的属性。为此，我为主主机输入了<code class="fe nb nc nd ne b">redis</code>，为redis副本主机输入了<code class="fe nb nc nd ne b">redis-replica</code>。这些名称应该与您的AWS Redis端点匹配。或本地码头集装箱的名称。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="e083" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">对于本地，您可以禁用SSL，以避免生成证书。此外，您需要将副本端口更改为<code class="fe nb nc nd ne b">6380</code>。这是为了避免与主控主机发生冲突。</p><p id="bb08" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要在本地运行，可以使用docker-compose.yml。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="51d6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您需要通过文件传递额外的env变量。以下是文件的内容。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="8590" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这使得复制成为可能。此外，在各自的env文件中设置主服务器和副本服务器。</p><p id="da10" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这个规范使用以前的auth，没有Redis ACLs。这意味着这将使用默认用户和密码。有关Redis和ACLs配置的更多信息<a class="ae kz" href="https://raw.githubusercontent.com/redis/redis/6.2/redis.conf" rel="noopener ugc nofollow" target="_blank">请参考配置文件</a>。</p><h1 id="3873" class="me mf iu bd mg mh nh mj mk ml ni mn mo ka nj kb mq kd nk ke ms kg nl kh mu mv bi translated">设置测试容器和集成测试</h1><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="ed41" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下面是使用测试容器的集成测试。这里我们需要创建两个通用容器，两者都将使用Redis映像。一个是主服务器，另一个是副本服务器。</p><p id="d904" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">需要</strong> <code class="fe nb nc nd ne b"><strong class="lc iv">redisNetwork</strong></code> <strong class="lc iv">来避免环回。由于两个容器都将暴露localhost作为主机名，docker网络中的副本将尝试联系自己。docker中的一个副本试图联系<code class="fe nb nc nd ne b">localhost:6379</code>，并将请求返回。添加网络和网络别名使它们的主机名唯一。</strong></p></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><p id="eb99" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果复制配置良好，这是副本的输出。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="2267" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这是主控器的输出。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="2842" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">作为Redis客户端，您可以使用<a class="ae kz" href="https://github.com/joeferner/redis-commander" rel="noopener ugc nofollow" target="_blank"> redis-commander </a>。您需要将以下配置添加到您的<code class="fe nb nc nd ne b">redis-commander/config</code>文件夹中。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="2e6d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">设置完成后，运行测试。主服务器和副本服务器都应该包含哈希。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nm"><img src="../Images/34e4e4919cd667c9b25d3cb69c6fdd8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x1QP8Ngy2Z2SUFdVeABzEw.png"/></div></div></figure><p id="bf8d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">请在回复中告诉我你对这个解决方案的看法。</p><h2 id="f2f4" class="nn mf iu bd mg no np dn mk nq nr dp mo lj ns nt mq ln nu nv ms lr nw nx mu ny bi translated">你可以在这里找到源代码<a class="ae kz" href="https://zivce.gumroad.com/l/mtwtj" rel="noopener ugc nofollow" target="_blank">。</a></h2></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="c96a" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">分级编码</h1><p id="fd46" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="9048" class="nz oa iu lc b ld le lg lh lj ob ln oc lr od lv oe of og oh bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="9912" class="nz oa iu lc b ld oi lg oj lj ok ln ol lr om lv oe of og oh bi translated">📰查看<a class="ae kz" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">升级编码出版物</a>中的更多内容</li><li id="0cba" class="nz oa iu lc b ld oi lg oj lj ok ln ol lr om lv oe of og oh bi translated">🔔关注我们:<a class="ae kz" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae kz" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae kz" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="773b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">🚀👉<a class="ae kz" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="lc iv">加入升级人才集体，找到一份神奇的工作</strong> </a></p></div></div>    
</body>
</html>