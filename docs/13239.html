<html>
<head>
<title>I Have a Black Hole in My Code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我的代码中有一个黑洞</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/i-have-a-black-hole-in-my-code-dd0cac235fef?source=collection_archive---------23-----------------------#2022-08-18">https://levelup.gitconnected.com/i-have-a-black-hole-in-my-code-dd0cac235fef?source=collection_archive---------23-----------------------#2022-08-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4fb05bc936577330c54aa31ba350064f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Pota583boXir6dhA"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kc" href="https://unsplash.com/@haythemgataa?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Haythem Gataa </a>拍摄</figcaption></figure><p id="bda5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最近我遇到了一个奇怪的问题，所有进入程序的信息都消失了，就像被黑洞吞噬了一样。</p><h1 id="9e7f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak"> 1。问题描述</strong></h1><p id="fdd7" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">最近发现一个批处理程序会失败。这个程序有很长的历史，很少使用。而且我还有其他高优先级的任务，所以一开始没注意。</p><p id="8696" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在过去的几天里，我有时间处理这个问题。</p><p id="03a0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果在处理了一些简单的问题，添加了一些错误的判断之后，批处理进程在第50个任务之后就卡住了，好像被挂起了一样，没有任何后续的日志打印。但是查了一下代码，并没有什么渠道堵塞之类的可疑点。</p><p id="18f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">而且其他后续的任务调用也全部卡死。查了系统信息，没有高占用率。</p><p id="b34c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所有的请求似乎都掉进了黑洞，消失了。</p><h1 id="21af" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak"> 2。开始故障排除</strong></h1><p id="f2dc" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><strong class="kf ir"> 2.1。添加日志</strong></p><p id="b8d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在最后一行代码后开始添加日志。对于每个分支，在函数调用之前和之后，尽可能详细地记录参数信息。</p><p id="7512" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我发现代码停在了一个SQL查询上。打印了查询前的日志，但是没有后续操作，没有报告错误，也没有打印正确的日志。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="9b07" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果</p><pre class="me mf mg mh gt mk ml mm mn aw mo bi"><span id="ab9f" class="mp lc iq ml b gy mq mr l ms mt">…</span><span id="2ea6" class="mp lc iq ml b gy mu mr l ms mt">### before search sameObject,name:tom</span></pre><p id="dc12" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 2.2。检查数据库状态</strong></p><p id="dfd6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从目前情况来看，数据库调用受阻。</p><p id="2f99" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，检查数据库的连接状态</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="437d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">总共30个连接</p><p id="578e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为我将程序中的最大连接数设置为30，所以它显示所有连接都被占用了。</p><pre class="me mf mg mh gt mk ml mm mn aw mo bi"><span id="0b0f" class="mp lc iq ml b gy mq mr l ms mt">db.DB().SetMaxIdleConns(10)<br/>db.DB().SetMaxOpenConns(30)</span></pre><p id="4389" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">起初，我怀疑是查询速度慢导致所有连接都被占用。</p><p id="066f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">于是我打开慢查询日志搜索了一下，没有关于对象表的。</p><p id="74a9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事情变得有点奇怪。</p><p id="318a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我没有一点头绪，所以我要看一下gorm调用，看看它是否有阻塞。</p><p id="4171" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 2.3。检查gorm源代码</strong></p><p id="7f37" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个项目是很久以前创建的，现在仍在使用</p><pre class="me mf mg mh gt mk ml mm mn aw mo bi"><span id="0469" class="mp lc iq ml b gy mq mr l ms mt">“github.com/jinzhu/gorm”</span></pre><p id="ca67" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看看这到底是什么发现()</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="bfb0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在NewScope()、inlineCondition()和callCallbacks()这三个函数中添加了日志，但是有些回调函数也是在callCallbacks()中调用的。</p><p id="8ee1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我写信给UT，看看有什么样的试镜</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="0d5d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/bf025ac50c8268e504f510ac6483cdd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*ZSrvihM9DIqE0vAuc5Nmbw.png"/></div></figure><p id="2d18" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从测试结果可以看出，回调函数具有</p><pre class="me mf mg mh gt mk ml mm mn aw mo bi"><span id="438a" class="mp lc iq ml b gy mq mr l ms mt">queryCallback<br/>preloadCallback<br/>afterQueryCallback</span></pre><p id="4e20" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">直觉告诉我，实际调用查询的函数是queryCallback。</p><p id="ee78" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">查了一下源代码，发现是这样的</p><pre class="me mf mg mh gt mk ml mm mn aw mo bi"><span id="504c" class="mp lc iq ml b gy mq mr l ms mt">if rows, err := scope.SQLDB().Query(scope.SQL, scope.SQLVars...); scope.Err(err) == nil {<br/>    ....<br/>}</span></pre><p id="ecdc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">先添加一些日志。</p><p id="3c9b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 2.4。调查queryCallback </strong></p><p id="ea40" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">再次触发批量，发现查询后的日志没有打印出来。</p><p id="1cc3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">再去查询源代码，发现里面确实有连接池的信息。看来我没有看错方向。</p><p id="282b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">查了一下代码，发现conn函数会涉及到连接池的分配。</p><pre class="me mf mg mh gt mk ml mm mn aw mo bi"><span id="810d" class="mp lc iq ml b gy mq mr l ms mt">// conn returns a newly-opened or cached *driverConn.<br/>func (db *DB) conn(ctx context.Context, strategy connReuseStrategy) (*driverConn, error)</span></pre><p id="489a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我想在连接被分配和释放的地方添加一些日志，看看哪个查询持有连接而没有释放它。</p><p id="7b42" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">幸运的是，获得连接池时有一个查询语句。当我们发现一个未释放的连接时，我们可以直接看到哪个查询使用了这个连接。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="01de" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我再次触发批处理任务，并告诉我的同事在运行时停止访问这个服务，以减少对其他数据库的操作，并减少日志的数量。</p><p id="89f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我漫长而乏味地挖掘了数以千计的过滤日志后，我惊奇地发现所有的连接都被释放了！</p><p id="814a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我不敢相信我的眼睛。找的方向应该没问题。而且为了不遗漏信息，我已经高亮显示了每一个查询过没有问题的日志。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/8fc39b61886d2b2e7f0b847d5a73021a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*uvAkhxOTaXm35GtGbpj8Mw.png"/></div></figure><p id="3159" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 2.5。回顾</strong></p><p id="d923" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">整个过程是环环相扣的，大方向应该是对的，中间可能会有所遗漏。</p><p id="98c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我喝了一杯咖啡，然后出去散步。</p><p id="f637" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">啊，灯亮了。</p><p id="4238" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">占用连接池的不仅仅是我的查询。不，应该说不是我的查询。否则30个连接早就用完了，直到处理完50个任务才可能。</p><p id="e878" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我需要检查其他查询的连接池使用情况。</p><p id="5b04" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">总共有9个地方调用了conn函数。全部添加日志并检查一遍。</p><p id="90b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> 2.6。再次检查连接池</strong></p><p id="b937" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这次我很快发现了问题</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/78a8aa7e991afe8ac6e7bb2336b85b78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HWBD92jelHwDeMI3OG6t4w.png"/></div></div></figure><p id="e3e2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">0xc0018c17c8该连接在begin()函数中获取后不会被释放。</p><p id="056c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">果然不出我所料，连接池是在别处泄露的。</p><p id="a025" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对begin的调用是在事务启动时，这很可能是没有提交或回滚的事务导致的泄漏。</p><p id="c029" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">检查代码后，发现确实如此。有一个比较长的事务，中间有很多操作和异常处理。随着需求的变化，代码变得越来越长。有人加了错误检查后，忘记回滚，直接返回。</p><h1 id="e638" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">3.错误修复</h1><p id="b228" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">过了两天，问题终于找到了。添加回滚后，重新运行批处理可以成功完成。</p><p id="a133" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我要看看到底是谁写代码如此粗心，我想我应该教他如何优雅地编码。</p><p id="3bbe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看一下提交日志:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/24672b6347542fd80bfd6fe7fdf5f944.png" data-original-src="https://miro.medium.com/v2/resize:fit:398/format:webp/1*sLXuD4POrOrw5BFWMt5svA.png"/></div></figure></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="3a46" class="lb lc iq bd ld le ng lg lh li nh lk ll lm ni lo lp lq nj ls lt lu nk lw lx ly bi translated">分级编码</h1><p id="0778" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">感谢您成为我们社区的一员！在你离开之前:</p><ul class=""><li id="4e12" class="nl nm iq kf b kg kh kk kl ko nn ks no kw np la nq nr ns nt bi translated">👏为故事鼓掌，跟着作者走👉</li><li id="cb02" class="nl nm iq kf b kg nu kk nv ko nw ks nx kw ny la nq nr ns nt bi translated">📰查看<a class="ae kc" href="https://levelup.gitconnected.com/?utm_source=pub&amp;utm_medium=post" rel="noopener ugc nofollow" target="_blank">级编码出版物</a>中的更多内容</li><li id="b3fa" class="nl nm iq kf b kg nu kk nv ko nw ks nx kw ny la nq nr ns nt bi translated">🔔关注我们:<a class="ae kc" href="https://twitter.com/gitconnected" rel="noopener ugc nofollow" target="_blank">推特</a> | <a class="ae kc" href="https://www.linkedin.com/company/gitconnected" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a> | <a class="ae kc" href="https://newsletter.levelup.dev" rel="noopener ugc nofollow" target="_blank">时事通讯</a></li></ul><p id="74d8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">🚀👉<a class="ae kc" href="https://jobs.levelup.dev/talent/welcome?referral=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">加入升级人才集体，找到一份惊艳的工作</strong> </a></p></div></div>    
</body>
</html>