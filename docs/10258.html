<html>
<head>
<title>Authenticate against azure ad using a certificate in a client credentials flow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用客户端凭据流中的证书针对azure ad进行身份验证</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/authenticate-against-azure-ad-using-certificate-in-a-client-credentials-flow-c02eedec4ed9?source=collection_archive---------0-----------------------#2021-11-13">https://levelup.gitconnected.com/authenticate-against-azure-ad-using-certificate-in-a-client-credentials-flow-c02eedec4ed9?source=collection_archive---------0-----------------------#2021-11-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/ff14691d6e975a03067dbc9b0ebd8ecd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hn7Nrl3wM-s7RY_HK6NwwA.png"/></div></div></figure><p id="ff6b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我有一个API，它需要针对azure AD进行身份验证，以获得调用另一个下游API的访问令牌。当在azure AD中为调用者API注册应用程序时，我可以为API设置一个共享秘密或证书，作为其在客户端凭证流中的凭证的一部分。在过去，我一直使用共享的秘密，因为它更方便，更容易设置。但是，使用证书可以提供更强的安全性。在花了几个小时的谷歌搜索和黑客攻击后，我能够设置并使用一个证书而不是一个共享秘密作为调用者API的凭证来验证azure AD。</p><h1 id="4ed8" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">为什么使用证书比共享密钥更安全？</h1><p id="ea7c" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">共享密码就像明文密码一样。在访问令牌请求中，客户端传输共享秘密，没有任何伪装，如下面的示例请求所示。任何知道客户端id和共享密钥的人都可以模拟客户端。下面的代码片段显示了一个来自<a class="ae mc" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow#first-case-access-token-request-with-a-shared-secret" rel="noopener ugc nofollow" target="_blank">文档</a>的请求示例。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="8f0d" class="mm la it mi b gy mn mo l mp mq">POST /{tenant}/oauth2/v2.0/token HTTP/1.1           //Line breaks for clarity<br/>Host: login.microsoftonline.com<br/>Content-Type: application/x-www-form-urlencoded<br/><br/>client_id=535fb089-9ff3-47b6-9bfb-4f1264799865<br/>&amp;scope=https%3A%2F%2Fgraph.microsoft.com%2F.default<br/>&amp;client_secret=sampleCredentia1s<br/>&amp;grant_type=client_credentials</span></pre><p id="b24e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">另一方面，当使用证书时，客户端不传输证书。相反，客户端使用证书的私钥对请求进行签名。Azure AD使用证书的公钥来验证签名。如果签名验证通过，azure AD知道该请求一定是由拥有证书的客户端签名的。下面来自<a class="ae mc" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow#second-case-access-token-request-with-a-certificate" rel="noopener ugc nofollow" target="_blank">文档</a>的片段显示了一个使用证书的访问令牌请求。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="714b" class="mm la it mi b gy mn mo l mp mq">POST /{tenant}/oauth2/v2.0/token HTTP/1.1               // Line breaks for clarity<br/>Host: login.microsoftonline.com<br/>Content-Type: application/x-www-form-urlencoded<br/><br/>scope=https%3A%2F%2Fgraph.microsoft.com%2F.default<br/>&amp;client_id=97e0a5b7-d745-40b6-94fe-5f77d35c6e05<br/>&amp;client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer<br/>&amp;client_assertion=eyJhbGciOiJSUzI1NiIsIng1dCI6Imd4OHRHeXN5amNScUtqRlBuZDdSRnd2d1pJMCJ9.eyJ{a lot of characters here}M8U3bSUKKJDEg<br/>&amp;grant_type=client_credentials</span></pre><p id="43b3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在上面的请求中，client_assertion参数是</p><blockquote class="mr ms mt"><p id="cafb" class="kb kc mu kd b ke kf kg kh ki kj kk kl mv kn ko kp mw kr ks kt mx kv kw kx ky im bi translated"><em class="it">您需要创建一个断言(一个JSON web令牌),并用您注册为应用程序凭证的证书进行签名。阅读关于证书凭据，了解如何注册您的证书和声明的格式。</em></p><p id="9fcf" class="kb kc mu kd b ke kf kg kh ki kj kk kl mv kn ko kp mw kr ks kt mx kv kw kx ky im bi translated"><a class="ae mc" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow#second-case-access-token-request-with-a-certificate" rel="noopener ugc nofollow" target="_blank"> <em class="it">用证书请求访问令牌</em> </a></p></blockquote><h1 id="0b4d" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">使用azure key vault设置自签名证书</h1><p id="05bb" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">证书可以来自不同的来源。例如，您可以将它存储在Windows证书存储区、硬盘上的某个位置、azure key vault等，Azure key vault具有存储和管理证书的内置支持。此外，由于我的应用运行在azure应用服务上，并使用托管身份连接到azure key vault，因此使用azure key vault来存储证书似乎是显而易见的。</p><p id="2e79" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">关于如何创建一个应用程序中使用的自签名证书的信息，请查看<a class="ae mc" href="https://docs.microsoft.com/en-us/azure/key-vault/certificates/quick-create-portal" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="9ec7" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">将证书上传到azure应用注册</h1><p id="5962" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">创建证书后，下载CER或PFX/PEM格式的证书。就我而言，我下载了。CER档案。证书文件包含我上传到调用者API的应用注册的公钥信息。</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi my"><img src="../Images/f3b16679dc712d048a3946e7ebe87b5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fml-kXTSVRZp567S1cqPVA.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">在azure应用注册中上传证书</figcaption></figure><h1 id="dfc0" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">使用Microsoft身份验证库的代码设置。NET(MSAL.NET)和Azure Key Vault证书客户端库。网</h1><p id="d94e" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">在应用程序中，我使用MSAL.NET为调用者API请求一个访问令牌。我只需要设置一个<code class="fe nd ne nf mi b">IConfidentialClientApplication</code>并使用API方法<code class="fe nd ne nf mi b">AcquireTokenForClient</code>根据azure AD方便地验证客户端，并通过客户端凭证流获得访问令牌。我将检索访问令牌的所有逻辑封装在一个类中，如下面的代码片段所示。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="a518" class="mm la it mi b gy mn mo l mp mq">using Azure.Identity;<br/>using Azure.Security.KeyVault.Certificates;<br/>using App.Core.Options;<br/>using Microsoft.Extensions.Options;<br/>using Microsoft.Identity.Client;<br/>using System;<br/>using System.Security.Cryptography.X509Certificates;<br/>using System.Threading.Tasks;    <br/><br/>public class AzureTokenService <br/>    {<br/>        private readonly IConfidentialClientApplication _confidentialClientApplication;<br/>        private readonly AzureADOptions _azureADOptions;<br/>        private readonly KeyVaultOptions _keyVaultOptions; <br/><br/>        public AzureTokenService(IOptions&lt;AzureADOptions&gt; azureADOptions,<br/>            IOptions&lt;KeyVaultOptions&gt; keyVaultOptions)<br/>        {<br/>            _azureADOptions = azureADOptions.Value;<br/>            _keyVaultOptions = keyVaultOptions.Value;<br/><br/>            _confidentialClientApplication = ConfidentialClientApplicationBuilder.Create(_azureADOptions.ClientId)<br/>                .WithCertificate(GetCertificate())<br/>                .WithAuthority(_azureADOptions.Authority).Build();<br/>        }<br/><br/>        public async Task&lt;string&gt; GetToken()<br/>        {<br/>            AuthenticationResult result = await _confidentialClientApplication.AcquireTokenForClient(new string[] { _azureADOptions.Scope })<br/>                   .ExecuteAsync();<br/><br/>            return result.AccessToken;<br/>        }<br/><br/>        private X509Certificate2 GetCertificate()<br/>        {<br/>            var certificateClient = new CertificateClient(vaultUri: new Uri(_keyVaultOptions.URL), credential: new DefaultAzureCredential());<br/>            var keyVaultCertificate = certificateClient.DownloadCertificate(_azureADOptions.KeyVaultCertificateName);<br/>        <br/>            return keyVaultCertificate;<br/>        }<br/>    }</span></pre><p id="990b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从上面的片段中可以注意到，在配置<code class="fe nd ne nf mi b">IConfidentialApplication</code>时，可以通过调用ConfidentialClientApplicationBuilder上的<code class="fe nd ne nf mi b">WithCertificate</code>()方法并传入X509Certificates类型的证书来设置证书。</p><p id="fec6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以下片段显示了我的应用程序设置中的配置。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="5795" class="mm la it mi b gy mn mo l mp mq">"AzureADOptions": {<br/>        "TenantId": "********-****-****-****-4a418e0cca7e",<br/>        "ClientId": "********-****-****-****-4415a019b235",<br/>        "Scope": "api://7********-****-****-****-9acf38c274a9/.default",<br/>        "Authority": "https://login.microsoftonline.us/********-****-****-****-4a418e0cca7e/v2.0/",<br/>        "KeyVaultCertificateName": "MyAppCert"<br/>    },<br/><br/>    "KeyVault": {<br/>        "URL": "https://keyvaulturl"<br/>    },</span></pre><p id="6464" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，您用来访问密钥库的azure凭据需要拥有获取和列出证书权限。在我的例子中，由于我使用托管身份，所以我将权限分配给托管身份。</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ng"><img src="../Images/710deea1a288f13399dcf1294bce9eae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HGcDUatjhWMvPnK_mvy9-A.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">配置用于检索证书的密钥库访问策略</figcaption></figure><h1 id="ff5e" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">参考</h1><p id="7dcc" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated"><a class="ae mc" href="https://stackoverflow.com/questions/18257185/how-does-a-public-key-verify-a-signature" rel="noopener ugc nofollow" target="_blank">公钥如何验证签名</a></p><p id="1dcf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://docs.microsoft.com/en-us/azure/key-vault/certificates/quick-create-portal" rel="noopener ugc nofollow" target="_blank">快速入门:使用Azure门户从Azure Key Vault设置和检索证书</a></p><p id="6404" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow#first-case-access-token-request-with-a-shared-secret" rel="noopener ugc nofollow" target="_blank">第一种情况:具有共享秘密的访问令牌请求</a></p><p id="1fc8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow#second-case-access-token-request-with-a-certificate" rel="noopener ugc nofollow" target="_blank">第二种情况:带有证书的访问令牌请求</a></p><p id="d5d9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-certificate-credentials" rel="noopener ugc nofollow" target="_blank">微软身份平台应用认证证书凭证</a></p><p id="4736" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://github.com/AzureAD/microsoft-identity-web/wiki/certificates#using-certificates-with-microsoftidentityweb" rel="noopener ugc nofollow" target="_blank">与微软一起使用证书。Identity.Web </a></p><p id="8611" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">的Azure Key Vault证书客户端库。网</p><p id="bce9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/wiki#conceptual-documentation" rel="noopener ugc nofollow" target="_blank">微软认证库。NET(MSAL.NET)</a></p></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><p id="b718" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="mu">原载于2021年11月13日https://www.taithienbo.com</em><a class="ae mc" href="https://www.taithienbo.com/authenticate-against-azure-ad-using-certificate-in-a-client-credentials-flow/" rel="noopener ugc nofollow" target="_blank"><em class="mu"/></a><em class="mu">。</em></p></div></div>    
</body>
</html>