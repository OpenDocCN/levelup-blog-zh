<html>
<head>
<title>Deploying Strapi CMS on AWS with ECS on Fargate, Aurora Serverless v2 and CDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS上部署Strapi CMS，在Fargate、Aurora无服务器v2和CDK上部署ECS</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploying-strapi-cms-on-aws-with-ecs-on-fargate-aurora-serverless-v2-and-cdk-3c9b9ec732a3?source=collection_archive---------2-----------------------#2022-12-22">https://levelup.gitconnected.com/deploying-strapi-cms-on-aws-with-ecs-on-fargate-aurora-serverless-v2-and-cdk-3c9b9ec732a3?source=collection_archive---------2-----------------------#2022-12-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="37a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我是一个狂热的T4 Strapi用户已经有一段时间了。Strapi是一个开源的node.js headless CMS，它帮助您以一种简单的方式用其管理UI搭建api，并让您使用REST APIs或GraphQL管理内容。</p><p id="c807" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS上部署的官方Strapi <a class="ae kl" href="https://docs.strapi.io/developer-docs/latest/setup-deployment-guides/deployment/hosting-guides/amazon-aws.html" rel="noopener ugc nofollow" target="_blank">文档</a>有助于快速入门，但不适合可重复和可伸缩的部署。</p><p id="eaa8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我将向您展示如何使用CDK在AWS上使用无服务器组件部署Strapi项目:我们将在Fargate上的ECS上部署Strapi以及Postgres Aurora无服务器V2数据库。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/cef657b3f5997e2e7bff8d663589d179.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*RAxQnOm-CFFCiZhvJkv2_w.png"/></div></figure><h2 id="8dcd" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">TL；速度三角形定位法(dead reckoning)</h2><p id="a36b" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">你可以在这里找到完整的repo和完整的Github actions工作流程</p><p id="45cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">👉<a class="ae kl" href="https://github.com/ziedbentahar/strapi-on-aws-with-cdk" rel="noopener ugc nofollow" target="_blank">https://github.com/ziedbentahar/strapi-on-aws-with-cdk</a></p><h1 id="1d17" class="ls kv iq bd kw lt lu lv kz lw lx ly lc lz ma mb lf mc md me li mf mg mh ll mi bi translated">1 —架构概述</h1><p id="7ede" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">下面是我们将在AWS客户上部署的组件的体系结构图:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mj"><img src="../Images/f11ef592b250cccdb80fdb8f27cc10f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nMmca2gnp2B6OLN0GCOGTA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Strapi部署在Fragate上的ECS上，使用Aurora无服务器V2作为数据库</figcaption></figure><p id="7644" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本例中，我们创建了一个专用的VPC，但是如果您想在您自己现有的VPC上部署Strapi，则不需要这样做。</p><p id="5d52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有三个子网:</p><ul class=""><li id="f88c" class="ms mt iq jp b jq jr ju jv jy mu kc mv kg mw kk mx my mz na bi translated">一个公共的，部署应用程序负载平衡器的地方</li><li id="e0dd" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">部署ECS群集的专用子网。在这个集群中，我们定义了由Strapi任务组成的ECS服务。</li><li id="84f6" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">隔离子网:数据库的子网:它不会将流量路由到互联网；它不需要NAT网关。</li></ul><p id="71db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还创建了一个Aurora V2无服务器PostgreSQL数据库以及一个包含数据库凭证的秘密。然后，这个秘密被安全地注入到Strapi容器中。</p><h1 id="7b86" class="ls kv iq bd kw lt lu lv kz lw lx ly lc lz ma mb lf mc md me li mf mg mh ll mi bi translated">2 —设置Strapi</h1><p id="4174" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">在定义基础设施之前，让我们首先创建一个样本Strapi项目。直接根据文档，创建一个新的Strapi项目轻而易举:</p><pre class="kn ko kp kq gt ng nh ni bn nj nk bi"><span id="cd5b" class="nl kv iq nh b be nm nn l no np">npx create-strapi-app@latest my-awesome-strapi-api</span></pre><p id="3eb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这一步，让我们确保选择<code class="fe nq nr ns nh b">postgres</code>作为dbclient，选择<code class="fe nq nr ns nh b">typescript </code>作为首选语言。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nt"><img src="../Images/8b0f8226aff3726f671d553b12c0467d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UCcbbUcpHSfTYe1o1W0lRw.png"/></div></div></figure><h2 id="fd25" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated"><strong class="ak">数据库配置</strong></h2><p id="d130" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated"><code class="fe nq nr ns nh b"><a class="ae kl" href="https://github.com/ziedbentahar/strapi-on-aws-with-cdk/blob/main/cms/config/database.ts" rel="noopener ugc nofollow" target="_blank">config/database.ts</a></code>文件定义了连接数据库所需的配置。它期望定义这些<code class="fe nq nr ns nh b">DATABASE_* </code>环境变量:</p><pre class="kn ko kp kq gt ng nh ni bn nj nk bi"><span id="c129" class="nl kv iq nh b be nm nn l no np">export default ({ env }) =&gt; ({<br/>  connection: {<br/>    client: "postgres",<br/>    connection: {<br/>      host: env("DATABASE_HOST"),<br/>      port: env.int("DATABASE_PORT"),<br/>      database: env("DATABASE_NAME"),<br/>      user: env("DATABASE_USERNAME"),<br/>      password: env("DATABASE_PASSWORD"),<br/>      ssl: env.bool("DATABASE_SSL"),<br/>    },<br/>  },<br/>});</span></pre><p id="ae33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将配置ECS任务定义，从一个秘密中检索数据库密码<a class="ae kl" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data-tutorial.html" rel="noopener ugc nofollow" target="_blank">，而不是直接将其作为明文环境变量注入。这样，AWS管理控制台和任何有权访问ECS任务定义的人都无法发现它。</a></p><p id="20c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ECS容器代理将通过引用秘密安全地将<code class="fe nq nr ns nh b">DATABASE_PASSWORD</code> env变量注入到Strapi容器中。</p><p id="778f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将在下面描述如何使用CDK在ESC任务定义上安全地注入秘密。</p><h2 id="dd3c" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated"><strong class="ak">创建Dockerfile文件</strong></h2><p id="8b4c" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">需要一个定义容器的Dockerfile文件来部署到ECS集群中。在这个例子中，我将使用Strapi提供的官方Dockerfile文件，你可以在<a class="ae kl" href="https://docs.strapi.io/developer-docs/latest/setup-deployment-guides/installation/docker.html#production-environments" rel="noopener ugc nofollow" target="_blank">这个链接</a>中找到它</p><p id="737f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了在构建映像时忽略这些文件夹，还需要一个<code class="fe nq nr ns nh b">.dockerignore</code>文件。</p><pre class="kn ko kp kq gt ng nh ni bn nj nk bi"><span id="c08a" class="nl kv iq nh b be nm nn l nu np">node_modules/<br/>.tmp/<br/>.cache/<br/>.git/<br/>build/<br/></span></pre><h1 id="acf3" class="ls kv iq bd kw lt lu lv kz lw lx ly lc lz ma mb lf mc md me li mf mg mh ll mi bi translated"><strong class="ak"> 3 —用CDK编码基础设施</strong></h1><p id="4014" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">让我们首先初始化CDK项目。它将位于与Strapi项目相同的git repo和父文件夹中:</p><pre class="kn ko kp kq gt ng nh ni bn nj nk bi"><span id="8430" class="nl kv iq nh b be nm nn l no np">mkdir my-awesome-strapi-project-infra \<br/> &amp;&amp; cd my-awesome-strapi-project-infra \<br/> &amp;&amp; npx aws-cdk init app --l typescript</span></pre><p id="1009" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了使我们的CDK项目组织良好，我们的基础设施的每个组件都将被定义为Strapi根堆栈的嵌套堆栈:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/fcfad6fcb0276b14638b2fd68278636e.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*QRGNMM56gfMzhY-B5hgtwA.png"/></div></figure><p id="1f5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个新搭建的项目上，创建堆栈时，我们需要将<code class="fe nq nr ns nh b">account</code>和<code class="fe nq nr ns nh b">region</code>分别设置为<strong class="jp ir"> </strong> <code class="fe nq nr ns nh b">CDK_DEFAULT_ACCOUNT</code>和<code class="fe nq nr ns nh b">CDK_DEFAULT_REGION</code>环境变量。这可确保堆栈部署在AWS CDK CLI在合成时确定的客户和区域中:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><a class="ae kl" href="https://github.com/ziedbentahar/strapi-on-aws-with-cdk/blob/main/infrastructure/bin/my-awesome-strapi.ts" rel="noopener ugc nofollow" target="_blank">bin/my-awesome-strapi-project-infra . ts</a>文件内容</figcaption></figure><h2 id="23fa" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated"><strong class="ak">创建数据库</strong></h2><p id="91a3" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">如上图所示，数据库将部署在隔离的子网上。创建一个安全组，以允许流量从专用子网(ECS群集所在的子网)流向数据库。</p><p id="3eba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还创建了一个包含数据库凭证(用户名和密码)的密码:它将在定义Aurora数据库凭证时使用，并将传递给ECS任务，以便安全地注入到容器中:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Aurora无服务器V2配置</figcaption></figure><p id="c030" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">☝️ <strong class="jp ir">注意</strong>在这个例子中，我们使用Aurora无服务器V2，它具有最小的扩展配置和一个实例。根据您的使用情况，您可能想要定义不同的配置。Aurora无服务器V2允许的最小容量为0.5 ACU。</p><p id="61c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在<a class="ae kl" href="https://github.com/ziedbentahar/strapi-on-aws-with-cdk/blob/main/infrastructure/lib/database.ts" rel="noopener ugc nofollow" target="_blank">这个链接</a>后面找到数据库嵌套栈定义。</p><h2 id="95b1" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated"><strong class="ak">创建证书</strong></h2><p id="e8e5" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">要使用TLS保护应用程序，需要在AWS证书管理器中为自定义Strapi域创建一个证书。它将与我们部署在同一个地区。该证书将与公共负载平衡器相关联:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="1867" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为先决条件，必须已经创建了托管区域。我们使用<code class="fe nq nr ns nh b">HostedZone.fromLookup</code>按名称检索托管区域信息。</p><p id="ea1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/ziedbentahar/strapi-on-aws-with-cdk/blob/main/infrastructure/lib/certificate.ts" rel="noopener ugc nofollow" target="_blank">该链接</a>提供了证书嵌套栈定义。</p><h2 id="8765" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated"><strong class="ak">定义ECS部署</strong></h2><p id="6c55" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">我们使用这个CDK <a class="ae kl" href="https://docs.aws.amazon.com/cdk/v2/guide/constructs.html" rel="noopener ugc nofollow" target="_blank"> L3解决方案构造</a> <code class="fe nq nr ns nh b"><a class="ae kl" href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ecs_patterns.ApplicationLoadBalancedFargateService.html" rel="noopener ugc nofollow" target="_blank">ApplicationLoadBalancedFargateService</a></code>:顾名思义，这个构造表示一个解决方案，包括一个AWS Fargate容器服务，该服务通过一个公共应用程序负载平衡器公开(默认)。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="15d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们分解一下Fargate服务的定义:</p><ul class=""><li id="2f36" class="ms mt iq jp b jq jr ju jv jy mu kc mv kg mw kk mx my mz na bi translated">在<code class="fe nq nr ns nh b">taskImageOptions</code>属性上，我们用<code class="fe nq nr ns nh b">ContainerImage.FromAsset</code>来定义<code class="fe nq nr ns nh b">image</code>。这个CDK内置助手从提供的目录中自动构建映像，并将其自动推送到ECR。</li><li id="cd7b" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">如上所述，一些值需要被定义为Strapi容器中的环境变量:我们将创建包含<code class="fe nq nr ns nh b">DATABASE_PASSWORD</code>的值以及这些标记<code class="fe nq nr ns nh b">JWT_SECRET</code>、<code class="fe nq nr ns nh b">APP_KEYS</code>、<code class="fe nq nr ns nh b">API_TOKEN_SALT</code>、<code class="fe nq nr ns nh b">ADMIN_JWT_SECRET</code>的秘密。</li><li id="ada2" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">然后，通过使用<code class="fe nq nr ns nh b">ecs_Secret.fromSecretsManager.</code>在<code class="fe nq nr ns nh b">taskImageOptions.secrets</code>中引用这些秘密，ECS容器代理将安全地将它们注入到Strapi容器中:</li></ul><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="3bce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将确保更新任务执行角色策略，以便能够读取<code class="fe nq nr ns nh b">dbSecret</code>和<code class="fe nq nr ns nh b">strapiSecret</code>。</p><p id="880f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">☝️ <strong class="jp ir">注意</strong> : <strong class="jp ir"> </strong>为了保持这个例子的简单，我创建了一个单独的秘密<code class="fe nq nr ns nh b">StrapiKey</code>用于所需的Strapi令牌。</p><p id="5966" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">限制对管理UI的访问:</strong>我想只授权一些IP地址访问Strapi管理UI和api(以<code class="fe nq nr ns nh b">/admin/*</code>开头的路由)。我在ALB上添加了基于路径和入站源IP的侦听器规则:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="5ddd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将在此处找到此部署<a class="ae kl" href="https://github.com/ziedbentahar/strapi-on-aws-with-cdk/blob/main/infrastructure/lib/ecs-service.ts" rel="noopener ugc nofollow" target="_blank">的完整定义。</a></p><h2 id="83ca" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated"><strong class="ak">创建DNS记录</strong></h2><p id="0d68" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">这个嵌套堆栈创建两个记录<code class="fe nq nr ns nh b">A</code> IPV4和<code class="fe nq nr ns nh b">AAAA</code> IPV6记录，目标是ALB:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h2 id="ca05" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">将整个堆栈放在一起</h2><p id="f924" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">我将使用<a class="ae kl" href="https://docs.aws.amazon.com/cdk/v2/guide/context.html" rel="noopener ugc nofollow" target="_blank"> CDK上下文</a>来传递<code class="fe nq nr ns nh b">applicationName</code>、<code class="fe nq nr ns nh b">hostedZoneDomainName</code>和<code class="fe nq nr ns nh b">authorizedIPsForAdminAccess</code>参数，因为它们在合成时可用，我们可以在代码中使用它们。</p><p id="8a87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还将依赖每个嵌套栈<code class="fe nq nr ns nh b">props</code>来传递来自根栈的值:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><a class="ae kl" href="https://github.com/ziedbentahar/strapi-on-aws-with-cdk/blob/main/infrastructure/lib/strapi.ts" rel="noopener ugc nofollow" target="_blank"> Strapi根栈</a></figcaption></figure><p id="cd77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">☝️在这个例子中，Strapi实例的域名将是<code class="fe nq nr ns nh b">https://&lt;your application name&gt;.&lt;your hosted zone domain name&gt;</code></p><h1 id="e734" class="ls kv iq bd kw lt lu lv kz lw lx ly lc lz ma mb lf mc md me li mf mg mh ll mi bi translated">4—让我们开始部署吧！</h1><p id="46b9" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">在部署基础设施之前:如果这是您的AWS帐户中的第一个CDK应用程序，您将需要执行以下命令来将CDK引导到您的帐户中:</p><pre class="kn ko kp kq gt ng nh ni bn nj nk bi"><span id="a0bd" class="nl kv iq nh b be nm nn l no np">cdk bootstrap</span></pre><p id="c7c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用CDK进行部署非常简单:</p><pre class="kn ko kp kq gt ng nh ni bn nj nk bi"><span id="98dc" class="nl kv iq nh b be nm nn l no np">npx cdk deploy --require-approval never \<br/>  --context applicationName=&lt;your application name&gt; \<br/>  --context hostedZoneDomainName=&lt;your hosted zone domain name&gt; \<br/>  --context authorizedIPsForAdminAccess=&lt;comma-separated list of IPs&gt;</span></pre><p id="8ae1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将能够直接从CloudFormation控制台跟踪堆栈部署</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ny"><img src="../Images/45b7fa20c4651c8a15f5a19d223e5120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fRhxTGIQkUi0Go6OaOHDBQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">云形成控制台上的StrapiStack</figcaption></figure><p id="e4bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">🎉部署完成后，您将能够使用这个公共URL <code class="fe nq nr ns nh b">https://&lt;your application name&gt;.&lt;your hosted zone domain name&gt;</code>访问您的Strapi</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nz"><img src="../Images/52260e5f81a35230a8b80e68d1f23585.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ZcI1kGrqDW6ebHBVOorPg.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Strapi服务器状态</figcaption></figure><p id="5615" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您的管理用户界面也将仅限于在您的部署的CDK环境中提供的授权IP:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nz"><img src="../Images/1464ae27893490049185271ad3a2899b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z1qcnP07z1juZEMW9RNYVQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Strapi管理控制台</figcaption></figure><h2 id="51b8" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">带有github操作的CI/CD管道示例</h2><p id="8e62" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">👉你可以在下面的<a class="ae kl" href="https://github.com/ziedbentahar/strapi-on-aws-with-cdk/blob/main/.github/workflows/main-pipeline.yml" rel="noopener ugc nofollow" target="_blank">链接中找到一个完整的Github actions pipline </a>，它将这个Strapi堆栈部署到一个AWS帐户中。</p></div><div class="ab cl oa ob hu oc" role="separator"><span class="od bw bk oe of og"/><span class="od bw bk oe of og"/><span class="od bw bk oe of"/></div><div class="ij ik il im in"><h2 id="ee7a" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">包扎</h2><p id="b49b" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">在本文中，我们已经看到了如何使用无服务器组件在AWS上部署CDK·斯特拉皮:Fargate和Aurora无服务器V2。我们可以通过改进这个架构走得更远:配置一个WAF (web应用防火墙)并将其关联到负载平衡器，以及配置Strapi媒体库以使用一个<a class="ae kl" href="https://market.strapi.io/providers/@strapi-provider-upload-aws-s3" rel="noopener ugc nofollow" target="_blank">专用的S3桶</a>。</p></div><div class="ab cl oa ob hu oc" role="separator"><span class="od bw bk oe of og"/><span class="od bw bk oe of og"/><span class="od bw bk oe of"/></div><div class="ij ik il im in"><h2 id="a104" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">进一步阅读</h2><div class="oh oi gp gr oj ok"><a href="https://docs.strapi.io/developer-docs/latest/getting-started/introduction.html" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">Strapi开发人员文档</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">本文档包含与…的设置、部署、更新和定制相关的所有技术文档</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">docs.strapi.io</p></div></div></div></a></div><div class="oh oi gp gr oj ok"><a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ecs_patterns-readme.html" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">aws-cdk-lib.aws_ecs_patterns模块cdk</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">语言|包</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">docs.aws.amazon.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy ks ok"/></div></div></a></div><div class="oh oi gp gr oj ok"><a href="https://github.com/aws/aws-cdk/issues/20197" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">(rds):支持Aurora无服务器V2问题#20197 aws/aws-cdk</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">描述该功能请喜欢原帖，而不是留下+1评论。添加CDK对aurora的支持…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">github.com</p></div></div><div class="ot l"><div class="oz l ov ow ox ot oy ks ok"/></div></div></a></div><div class="oh oi gp gr oj ok"><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data-tutorial.html" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">教程:使用机密管理器机密指定敏感数据</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">Amazon ECS通过将敏感数据存储在AWS Secrets中，使您能够将敏感数据注入到容器中…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div></div></div>    
</body>
</html>