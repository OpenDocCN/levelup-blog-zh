<html>
<head>
<title>Add Video Capabilities to Zendesk With Vonage Video API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Vonage视频API为Zendesk添加视频功能</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/add-video-capabilities-to-zendesk-with-vonage-video-api-b32a922c3997?source=collection_archive---------3-----------------------#2020-09-25">https://levelup.gitconnected.com/add-video-capabilities-to-zendesk-with-vonage-video-api-b32a922c3997?source=collection_archive---------3-----------------------#2020-09-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/16eb123648e3e63e6a06fbefc8a0ae0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bprzdXzXR1mU5OtwKwCbBQ.png"/></div></div></figure><p id="53ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本教程中，我们将通过使用Vonage Video API为Zendesk添加视频、屏幕共享和录制功能，以便您可以提供更丰富的客户体验。</p><p id="77cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可能会认为这不适合你，因为你不使用Zendesk，但事实上，有许多其他售票系统可以应用这些外卖。如果这还不能说服你，让我们向你展示如何以编程方式处理录音并将它们上传到Zendesk票证，这样双方都可以下载它。</p><h1 id="4005" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">场景</h1><ul class=""><li id="2d1f" class="lu lv iq ka b kb lw kf lx kj ly kn lz kr ma kv mb mc md me bi translated">客户希望与支持工程师讨论一个未解决的问题。她通过点击<code class="fe mf mg mh mi b">Discuss Live with Javier</code>按钮请求与支持工程师进行视频通话，并等待他加入。</li></ul><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/7a33204746672e1827d8c3839a669a09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*r_ydF6kZc8VLJKx7"/></div></figure><ul class=""><li id="f9af" class="lu lv iq ka b kb kc kf kg kj mo kn mp kr mq kv mb mc md me bi translated">票证会更新为内部注释，因此支持工程师会得到通知，票证的请求者希望进行视频会话。</li></ul><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/0bf2bfe6a0680dc830ed01c663bce025.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6_jwMM11dgQHVviC"/></div></div></figure><ul class=""><li id="298b" class="lu lv iq ka b kb kc kf kg kj mo kn mp kr mq kv mb mc md me bi translated">支持工程师加入会议，他们检查票证(在这个特定的案例中没有太多讨论。他们决定对通话进行录音，一旦录音停止，就会以票证评论的形式上传，以便双方都可以下载。</li></ul><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/b9e804cb0a063da3c694fcfc70dedb3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*G4tRpoaF4389UJv5"/></div></figure><p id="e2d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果这引起了你的注意，请跟着做。</p><h1 id="3166" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">体系结构</h1><p id="6ca6" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">为了更好地概述这一集成的架构，我们想与您分享下图:</p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/b85054a6922d5898c5ccbf534d0d4618.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tCCXs9LDsTkhsXL9"/></div></div></figure><p id="e84b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一方面，终端客户通过Zendesk请求页面请求与支持工程师进行视频通话。服务器将处理该请求，并更新票证以引起代理的注意。另一方面，使用Zendesk的代理将加入同一个会话以进行实时讨论。</p><h1 id="dd36" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">先决条件</h1><p id="dc9f" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">在我们开始之前，您需要以下内容:</p><ol class=""><li id="359d" class="lu lv iq ka b kb kc kf kg kj mo kn mp kr mq kv mw mc md me bi translated"><a class="ae mx" href="https://tokbox.com/account" rel="noopener ugc nofollow" target="_blank">一个Vonage视频API账户</a>，你可以免费创建</li><li id="b55b" class="lu lv iq ka b kb my kf mz kj na kn nb kr nc kv mw mc md me bi translated"><a class="ae mx" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>安装以及一些<a class="ae mx" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/First_steps" rel="noopener ugc nofollow" target="_blank">基础JavaScript知识</a></li><li id="1fae" class="lu lv iq ka b kb my kf mz kj na kn nb kr nc kv mw mc md me bi translated">具有管理员权限的Zendesk帐户</li><li id="7b58" class="lu lv iq ka b kb my kf mz kj na kn nb kr nc kv mw mc md me bi translated"><a class="ae mx" href="https://developer.zendesk.com/apps/docs/developer-guide/zat" rel="noopener ugc nofollow" target="_blank">Zendesk App工具(ZAT) </a>已安装</li><li id="b93b" class="lu lv iq ka b kb my kf mz kj na kn nb kr nc kv mw mc md me bi translated">亚马逊S3账户</li></ol><h1 id="1719" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">Zendesk代理</h1><p id="e032" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">从Zendesk应用开始，你可以遵循他们的<a class="ae mx" href="https://develop.zendesk.com/hc/en-us/articles/360001074788-Build-your-first-Support-app-Part-1-Laying-the-groundwork" rel="noopener ugc nofollow" target="_blank">构建你的第一个支持应用</a>教程。移动到您的项目目录并运行以下命令。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="0edc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将提示您一些信息，如应用程序的名称；我们就叫它<em class="nf"> Zendesk视频App </em>。它还会询问您的电子邮件和其他一些不会影响功能的参数。一旦命令被执行，您将看到应用程序被创建。我们还将为我们的服务器创建一个文件夹。最终的项目结构如下所示。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="fc17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的应用程序将由一个嵌入到Zendesk界面中的框架组成，它将有一个视频聊天区域，其中有几个可用的操作。让我们通过添加一些简单的按钮元素来编辑<code class="fe mf mg mh mi b">iframe.html</code>文件，这将允许代理与票证内的客户进行视频通话。您可以将以下代码复制粘贴到您的<code class="fe mf mg mh mi b">iframe.html</code>中:</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="450a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还将为按钮添加一些基本的CSS。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="32f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，编辑实例化ZAF客户机的<code class="fe mf mg mh mi b">main.js</code>文件。ZAF客户端让你的应用程序与主机Zendesk产品进行通信。您可以在应用程序中使用客户端来侦听事件、获取或设置属性，或者调用操作。在这种情况下，我们感兴趣的是我们正在处理的票据的细节。特别是票证ID和请求者ID。一旦承诺兑现，我们就可以向服务器发送一个请求来获取API密钥、会话ID和该票证的令牌。所有会话生成逻辑将来自我们的服务器。我们稍后会谈到这一点。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="41f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们已经获得了这些值，我们可以让代理选择何时启动视频会话。我们将定义一个<code class="fe mf mg mh mi b">initializeSession</code>函数，一旦代理点击<code class="fe mf mg mh mi b">Initiate session</code>按钮，该函数将被触发。我们将publisher容器显示设置为block，使其可见(因为它最初设置为none)。我们将通过实例化一个会话对象来启动会话，然后初始化发布者。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="e6d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还将为会话对象分派的<a class="ae mx" href="https://tokbox.com/developer/sdks/js/reference/Session.html#events" rel="noopener ugc nofollow" target="_blank">事件</a>创建一些监听器。我们将利用<code class="fe mf mg mh mi b">archiveStarted</code>和<code class="fe mf mg mh mi b">archiveSopped</code>事件来控制应用程序的状态，也就是说，知道我们是否正在发布视频，或者如果我们正在录制，它是否被关闭。</p><p id="1526" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将根据状态在HTML按钮中显示不同的值。例如，一旦我们收到<code class="fe mf mg mh mi b">archiveStarted</code>，我们将希望我们的按钮显示“停止存档”而不是“开始存档”，因为存档/记录已经开始。在我们代码的顶部，我们定义了一些状态变量(<code class="fe mf mg mh mi b">archiving</code>、<code class="fe mf mg mh mi b">video</code>和<code class="fe mf mg mh mi b">screen</code>)，它们将根据这些事件发生变化。</p><p id="2c7d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还想在一个流创建后就订阅它，所以我们将监听<code class="fe mf mg mh mi b">streamCreated</code>事件。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="9438" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们作为回调传递的<code class="fe mf mg mh mi b">handleError</code>函数是一个函数，如果在监听会话中的事件时发生错误，它会抛出一个警告。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="e03b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以创建一个<code class="fe mf mg mh mi b">handleRecording</code>函数来确定我们是否已经在记录。这将允许我们根据状态触发不同的功能。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="bbfc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mf mg mh mi b">StartArchive</code>函数将向我们的服务器的<code class="fe mf mg mh mi b">archive/start</code>路由发出POST请求。我们需要传递我们的<code class="fe mf mg mh mi b">sessionId</code>,以便我们的服务器知道哪个会话触发了记录。您将在本教程的后面看到，我们指的是会话的记录和存储。不要混淆；这是相同的概念，但是我们在内部使用术语“归档:)</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="4be5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">至于<code class="fe mf mg mh mi b">StopArchive</code>功能，和<code class="fe mf mg mh mi b">StartArchive</code>差不多。但是，在这种情况下，我们需要传递来自<code class="fe mf mg mh mi b">archiveStarted</code>事件的<code class="fe mf mg mh mi b">archiveID</code>。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="ffed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要添加对屏幕共享流的支持。我们将创建一个功能来检查我们是否已经共享了我们的屏幕，如果没有，它将创建一个新的发布者。这个函数将在一些事件中充当屏幕共享流的触发器，就像我们在存档中所做的一样。</p><p id="0d69" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将通过调用<code class="fe mf mg mh mi b">OT.checkScreenSharingCapability</code>方法来检查浏览器是否支持屏幕共享。我们在<a class="ae mx" href="https://tokbox.com/developer/sdks/js/reference/OT.html#checkScreenSharingCapability" rel="noopener ugc nofollow" target="_blank">关于checkScreenSharingCapability回调</a>的文档中解释了更多关于屏幕共享支持的内容。对于一些旧版本的浏览器，您可能需要安装一个扩展，但是为了简单起见，我们将假设两个参与者都将使用最新的浏览器。</p><p id="a3f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，我们在这种情况下监听的事件是由publisher对象而不是session对象调度的。更多信息请参考<a class="ae mx" href="https://tokbox.com/developer/sdks/js/reference/StreamEvent.html" rel="noopener ugc nofollow" target="_blank"> StreamEvent </a>。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><h1 id="cdd1" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">客户方</h1><p id="842c" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">既然我们的代理端已经启动并运行，我们需要考虑为客户端添加视频功能。这篇帖子的主要目的是将最终客户(票证请求者)和支持代理(票证受让人)联系起来。</p><p id="8685" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此，我们将按照<a class="ae mx" href="https://support.zendesk.com/hc/en-us/articles/203664326-Customizing-your-Help-Center-theme-Guide-Professional-and-Enterprise-" rel="noopener ugc nofollow" target="_blank">定制您的帮助中心主题指南</a>，以便我们可以访问票证请求者的页面代码，并在帮助中心构建更丰富的客户体验。</p><p id="78c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这种情况下，我们对定制<code class="fe mf mg mh mi b">Requests page</code>感兴趣，即分配给特定用户的请求或票据列表。正如上面链接的文章中所解释的，帮助中心的HTML包含在可编辑的模板中。我们将编辑<code class="fe mf mg mh mi b">requests_page.hbs</code>文件。代码将非常类似于<code class="fe mf mg mh mi b">main.js</code>文件中的JavaScript代码。</p><p id="57c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们要导入Opentok库。这将下载JS SDK的最新版本。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="0214" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们添加了一些包含发布者和订阅者视频的基本标记，以及一些处理应用程序功能的按钮。你会注意到我们有<code class="fe mf mg mh mi b">{{assignee.avatar_url}}</code>。这是一种叫做<code class="fe mf mg mh mi b">Curlybars</code>的模板语言，它将允许我们在Zendsk ticket的上下文中与帮助中心数据进行交互。</p><p id="45f8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本例中，我们将在启动视频通话的按钮上显示票证受让人的图片。目的是为顾客提供近距离体验。此外，为了一开始就简单起见，我们将隐藏所有按钮，只留下启动呼叫的按钮。我们将通过将HTML元素的display属性设置为<code class="fe mf mg mh mi b">none</code>来实现这一点。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7eae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将定义一些在代码中会用到的变量。正如我们在代理端所做的那样，我们将使用一些状态变量(<code class="fe mf mg mh mi b">video</code>、<code class="fe mf mg mh mi b">archiving</code>和<code class="fe mf mg mh mi b">screenSharing</code>)。我们还将定义服务器的端点。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="523d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们正在定义一个简单的错误处理函数，我们将使用它在发生错误时提醒用户。将它定义为一个单独的函数的唯一目的是稍微清理一下我们的代码。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="bb33" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们从我们的服务器获取<code class="fe mf mg mh mi b">apiKey</code>、<code class="fe mf mg mh mi b">sessionId</code>和<code class="fe mf mg mh mi b">token</code>。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="5836" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，添加下面的<code class="fe mf mg mh mi b">initializeSession</code>功能，一旦客户决定请求与支持代理进行视频通话，就会触发该功能。我们将显示最初隐藏的按钮，然后我们首先实例化一个会话对象并创建一个发布者。最后，我们尝试连接到会话。如前所述，如果连接成功，我们将尝试发布到会话。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="068c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将利用三元运算符来决定是否需要打开或关闭视频。同样的逻辑也适用于确定我们是要调用函数来开始记录还是停止记录。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="40b1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mf mg mh mi b">startArchive()</code>和<code class="fe mf mg mh mi b">startArchive()</code>功能看起来与<code class="fe mf mg mh mi b">main.js</code>中的完全一样，所以为了简单起见，我们将省略它们。您可能还希望只向支持代理而不是最终客户提供启动录制的选项，但这完全取决于您。为了让它更有趣，我们将允许双方启动和停止录音，因为他们都将能够在通话后检索录音。</p><h1 id="5887" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">计算机网络服务器</h1><p id="199f" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">我们的服务器端将由几个路由组成，以处理来自代理或支持工程师的请求。</p><p id="e192" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们导入我们的应用程序将要使用的模块，并定义一些环境变量。</p><p id="245a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mf mg mh mi b">apiKey</code>和<code class="fe mf mg mh mi b">apiSecret</code>是在您的<a class="ae mx" href="https://tokbox.com/account/" rel="noopener ugc nofollow" target="_blank">仪表板</a>中找到的视频API凭证，<code class="fe mf mg mh mi b">remoteUri</code>以<a class="ae mx" href="https://xxxxxx.zendesk.com/" rel="noopener ugc nofollow" target="_blank">https://xxxxxx.zendesk.com/</a>的形式引用您组织的Zendesk端点。对于Zendesk认证，查看他们的“<a class="ae mx" href="https://support.zendesk.com/hc/en-us/articles/115000510267-How-can-I-authenticate-API-requests-" rel="noopener ugc nofollow" target="_blank">我如何认证API请求</a>”文章，因为他们支持不同的认证方法；我们使用用户名和令牌。</p><p id="c91b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">至于AWS的认证，有几个<a class="ae mx" href="https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/setting-credentials-node.html" rel="noopener ugc nofollow" target="_blank">支持的方法</a>，但是我们也决定使用环境变量。请注意，在这种情况下，SDK会自动检测环境中设置为变量的AWS凭据，并将其用于SDK请求，从而消除了在应用程序中管理凭据的需要。这就是为什么我们没有从我们的<code class="fe mf mg mh mi b">.env</code>文件中读取变量。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="8e73" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将此添加到您的<code class="fe mf mg mh mi b">index.js</code>文件中。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="4a9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">处理会话和令牌创建的路由将检查是否已经创建了一个会话来讨论该票证，如果没有，它将创建一个会话。如果你不熟悉视频API的<a class="ae mx" href="https://tokbox.com/developer/guides/create-token/" rel="noopener ugc nofollow" target="_blank">令牌</a>的概念，它就像是房间(会话)的钥匙。</p><p id="8bae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可能希望有一个更安全的解决方案，但我们决定在这里做一些基本的验证，以保持简单。在本例中，我们接收到一个格式为<code class="fe mf mg mh mi b">XXXXXX-YYYYY</code>的<code class="fe mf mg mh mi b">name</code>参数。你还记得我们在两个部分(代理和客户)做的那些提取呼叫吗？是从那里传来的。</p><p id="de82" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果票据的请求者ID与收到的<code class="fe mf mg mh mi b">:name</code>参数的第二部分匹配，我们将只生成一个会话和一个令牌。我们将使用Zendesk包来执行验证。例如，如果我们接收到<code class="fe mf mg mh mi b">1222-1234</code>，我们将通过Zendesk API检查用户1222是否请求了票证1234。如果没有，我们将返回一个HTTP 404。</p><p id="afa8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还会看到，对于referer和请求的来源有一些验证。只有当请求来自客户时，才快速更新票证，并让支持工程师知道票证请求者想要进行视频会话。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="9648" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在实际应用程序中，您可能需要将会话id存储在数据库中，并检查是否已经为该票证创建了会话。然而，在本教程中，我们决定简单地使用一个字典来存储与房间名称相关联的会话id。请记住，一旦您重新启动服务器，这将被重置。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="971f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如我们提到的，只有当没有与收到的房间名称相关联的会话时，我们才会创建会话。我们将基于回调的方法包装在一个承诺中，该承诺将返回一个会话对象。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="850d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还包装了一个承诺Zendesk check，它允许我们查询收到的票ID，这样我们就可以确定请求是否合法。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="467d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果请求是有效的，并且来自客户端(而不是来自代理)，请更新票证，以便通知支持工程师有人在等待视频会话。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="5cd2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们正在定义开始和停止存档的路线。请注意，停止存档的路由也采用会话ID。这是，所以我们的服务器知道你试图停止记录的会话ID。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="9fa5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你运行你的服务器，用<a class="ae mx" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank"> ngrok </a>暴露它，在两个前端(客户和代理端)都配置ngrok URL为<code class="fe mf mg mh mi b">SERVER_BASE_URL</code>。你现在有一个视频会议，干得好！</p><p id="4df1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好吧，这很酷，但让我们更进一步！如果我们还可以动态处理通话记录并将其上传到Zendesk，以便支持工程师和客户都可以在最方便的时候检索它，这不是很好吗？就这么办吧！</p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/77de6471dc4e37c9b352707b55d437fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*qoRwIhzWYAqpQI5K"/></div></figure><h1 id="d28f" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">处理录像</h1><p id="51d3" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">首先，我们必须让视频API知道我们希望视频记录上传到哪里。由于我们将使用AWS S3端点，您可以遵循我们的<a class="ae mx" href="https://tokbox.com/developer/guides/archiving/using-s3.html" rel="noopener ugc nofollow" target="_blank">使用带有Vonage视频API归档的S3存储</a>指南。配置完成后，如果您有一个视频会话，并且您启动和停止了录制，它将自动上传到您的S3存储桶。</p><p id="4ed5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所有归档文件都保存在S3存储桶的子目录中，该子目录的名称是OpenTok API密钥，每个归档文件都保存在该子目录中，名称是归档文件ID。存档文件为<code class="fe mf mg mh mi b">archive.mp4</code>。</p><p id="a423" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，考虑具有以下API键和ID的档案:</p><ul class=""><li id="7d40" class="lu lv iq ka b kb kc kf kg kj mo kn mp kr mq kv mb mc md me bi translated">API密钥— 123456</li><li id="f207" class="lu lv iq ka b kb my kf mz kj na kn nb kr nc kv mb mc md me bi translated">存档ID-ab 0 baa 3d-2539–43 a6-be42-b41ff 1488 af 3</li></ul><p id="769a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此归档的文件上传到您的S3存储桶的以下目录:</p><p id="d9be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">123456/ab 0 baa 3d-2539–43 a6-be42-b41ff 1488 af3/archive . MP4</p><p id="ac67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们需要知道归档文件何时上传到我们的S3存储桶，以便我们可以检索它。我们将在服务器中配置一个路由来侦听与归档相关的事件。当档案的状态改变时，视频API平台将向您发送一个指向您之前配置的回调URL的webhook。</p><p id="302d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">进入你的仪表板，点击你正在使用的项目，将你的服务器URL配置为<code class="fe mf mg mh mi b">https://YOUR_SERVER_URL/events</code>。如<a class="ae mx" href="https://tokbox.com/developer/guides/archiving/" rel="noopener ugc nofollow" target="_blank">存档指南</a>中所述，一旦存档文件可供从S3桶下载，视频API平台将向您发送可用状态。我们将在我们的服务器上监听该事件并下载它。所有的逻辑都将在服务器端处理(<code class="fe mf mg mh mi b">server.js</code>文件)。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="c24c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请记住在您的视频API帐户中配置您的服务器URL。否则，你不会在你的服务器上收到这些网页挂钩。它应该如下所示:</p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/1b3c71224477825d48c5a6a13d888c5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_qZWoVmMTILW-06J"/></div></div></figure><p id="3edc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将向<code class="fe mf mg mh mi b">downloadVideo</code>函数传递两个变量；一个是我们希望下载存档时使用的名称，另一个是密钥，因此我们的S3存储桶知道我们试图检索什么记录。</p><p id="5130" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过调用请求上的<code class="fe mf mg mh mi b">createReadStream</code>方法，请求将返回的数据直接传输到Node.js流对象。调用<code class="fe mf mg mh mi b">createReadStream</code>返回由请求管理的原始HTTP流。然后，原始数据流可以通过管道传输到Node.js流对象中。一旦上传到我们的桶，我们现在应该能够动态下载记录。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="c828" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你会注意到，一旦下载完文件，我们就调用一个<code class="fe mf mg mh mi b">getToken</code>函数。那是因为上传一个文件到Zendesk的过程。此时，您可以对该文件做任何您想做的事情，因为它已经被下载了。然而，为了完成我们的帖子，让我们将录音上传到Zendesk ticket，这样双方都可以在通话后观看录音。</p><p id="c562" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们首先需要获得一个令牌，然后我们需要更新传递这个令牌的票证。我们将在一个名为<code class="fe mf mg mh mi b">uploadVideo</code>的独立函数中执行第二部分。</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="d526" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看<a class="ae mx" href="https://github.com/javiermolsanz/blogOpenhack/blob/master/index.md#demo" rel="noopener ugc nofollow" target="_blank">演示</a>来更好地了解这一切是如何工作的。改编本教程以满足您的需求，让您的客户高度满意并成为支持体验的真正倡导者。</p><p id="2c21" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae mx" href="https://github.com/nexmo-community/vonage-zendesk-integration" rel="noopener ugc nofollow" target="_blank">vonage-zendesk-integration</a>GitHub repo中找到该项目的代码。</p><p id="9f6c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你下一步会建什么？让我们知道！</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><p id="6705" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nf">最初发布于</em><a class="ae mx" href="https://www.nexmo.com/blog/2020/09/08/add-video-capabilities-to-zendesk-with-vonage-video-api" rel="noopener ugc nofollow" target="_blank"><em class="nf">https://www . NEX mo . com/blog/2020/09/08/add-video-capabilities-to-zendesk-with-vonage-video-API</em></a></p></div></div>    
</body>
</html>