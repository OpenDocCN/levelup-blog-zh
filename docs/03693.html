<html>
<head>
<title>HTTPs on CloudFront using Certificate Manager and aws-cdk</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用证书管理器和aws-cdk的CloudFront上的HTTPs</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/https-on-cloudfront-using-certificate-manager-and-aws-cdk-5d61c676393c?source=collection_archive---------21-----------------------#2020-05-22">https://levelup.gitconnected.com/https-on-cloudfront-using-certificate-manager-and-aws-cdk-5d61c676393c?source=collection_archive---------21-----------------------#2020-05-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f7a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://miensol.pl/fast-static-website-with-aws-cdk" rel="noopener ugc nofollow" target="_blank">用aws-cdk部署到CloudFront的静态网站帖子</a>展示了如何用aws-cdk部署静态内容。我们仍然错过了我们的网站自定义域名配置虽然。以下示例显示了如何:</p><ul class=""><li id="d005" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">为CloudFront发行版设置自定义域名</li><li id="887e" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">使用AWS颁发的可信证书启用https</li></ul><h1 id="88d5" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">使用aws-cdk从AWS证书管理器获取可信证书</h1><p id="333d" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">使用前一篇文章中的<a class="ae kl" href="https://github.com/miensol/miensol.github.io/tree/develop/content/posts/cloudfront-custom-domain-https" rel="noopener ugc nofollow" target="_blank">示例作为基础</a>，在<code class="fe md me mf mg b">infrastructure</code>目录中，让我们添加一个额外的包:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="6c2a" class="mp lb iq mg b gy mq mr l ms mt">npm i --save @aws-cdk/aws-certificatemanager</span></pre><p id="ef98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CloudFront只能在us-east-1地区(N. Virginia)内使用AWS Certificate Manager颁发的证书。我们可以在us-east-1地区创建我们的<code class="fe md me mf mg b">FrontendStack</code>。或者，我们可以创建另一个仅包含证书的堆栈。下面我将展示如何使用第二个选项。</p><p id="b988" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们为美国东部地区的给定域名申请证书。在AWS证书管理器颁发受信任的TLS证书之前，它需要验证您是否拥有该域。使用以下任一方法进行验证:</p><ul class=""><li id="19c9" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">电子邮件:AWS CM向该域的<em class="mu">管理员</em>电子邮件地址发送消息</li><li id="5815" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">DNS: AWS CM请求特定的DNS记录配置</li></ul><p id="7cbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的例子中，我使用了<code class="fe md me mf mg b">fast-static-website.miensol.pl</code>和DNS验证方法。因为我拥有这个域名，我可以向AWS证书管理器证明这一点。</p><p id="7a7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还更新了<code class="fe md me mf mg b">bin/infrastructure.ts</code>文件，以包含我们的新堆栈:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="061f" class="mp lb iq mg b gy mq mr l ms mt">#!/usr/bin/env node<br/>import "source-map-support/register";<br/>import * as cdk from "@aws-cdk/core";<br/>import { CertificateStack, FrontendStack } from "../lib/frontend-stack";<br/><br/>const app = new cdk.App();<br/>new CertificateStack(app);<br/>new FrontendStack(app);</span></pre><p id="ab4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们通过以下方式启动下一次部署:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="6dd4" class="mp lb iq mg b gy mq mr l ms mt">npm run cdk deploy '*'</span></pre><p id="3b4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该过程将等待证书请求验证。请求的DNS记录将显示在部署命令输出中:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="429b" class="mp lb iq mg b gy mq mr l ms mt">&gt; npm run cdk deploy<br/>...<br/>1/5 | 6:03:37 PM | CREATE_IN_PROGRESS   | AWS::CertificateManager::Certificate<br/> | CustomDomainCertificate (CustomDomainCertificateXXXXX) Content of DNS Record is: {Name: XXXXXX.fast-static-website.miensol.pl.,Type: CNAME,Value: XXXXX.auiqqraehs.acm-validations.aws.}<br/>1/5 Currently in progress: CustomDomainCertificateXXXXX</span></pre><p id="cf4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您也可以在AWS Web控制台内的<a class="ae kl" href="https://eu-central-1.console.aws.amazon.com/acm/home?region=eu-central-1#/" rel="noopener ugc nofollow" target="_blank">证书管理器</a>中找到该请求。配置DNS记录后，该过程将继续。在命令输出中，您应该会看到类似以下内容的消息:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="82e0" class="mp lb iq mg b gy mq mr l ms mt">CertificateStack.CertificateArn = arn:aws:acm:us-east-1:XXXXXXX:certificate/XXXXX-XXXXX-XXXX-XXXX-XXXXXXXX</span></pre><p id="7333" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意上面的值，我们将在下面的步骤中需要它。</p><h1 id="8ace" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">使用aws-cdk将证书附加到CloudFront分发版</h1><p id="7cc9" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">我们需要告诉CloudFront发行版使用新的证书。让我们修改<code class="fe md me mf mg b">FrontendStack</code>来接受参数:</p><p id="bd55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe md me mf mg b">viewerCertificate</code>部分，我们指定了域名以及CloudFront发行版应该使用的证书。接下来我们通过证书考试。证书上述作为参数的值:</p><p id="9f52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署需要一段时间才能完成，因为CF发行版需要更新。我们可以使用这个时间来配置<code class="fe md me mf mg b">fast-static-website.miensol.pl</code> DNS记录。记录需要指向<code class="fe md me mf mg b">FrontendStack.DistributionDomainName</code>。我使用CloudFlare，因此在我的情况下，这意味着创建一个CNAME记录:</p><figure class="mh mi mj mk gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mv"><img src="../Images/63065e6674bfff98162d6a820b0c80dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Y2DiEu5fBq2Nm7Ls.png"/></div></div></figure><p id="456b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在可以使用HTTPS加载我们的静态网站了！</p><figure class="mh mi mj mk gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mv"><img src="../Images/d8062d6714b238f60399b7f89bd12962.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FZnqo3v5B_8wI2PX.png"/></div></div></figure><p id="ad18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">遗憾的是，不能使用aws-cdk 创建<a class="ae kl" href="https://github.com/aws/aws-cdk/issues/49#issuecomment-454800305" rel="noopener ugc nofollow" target="_blank">跨区域参考:</a></p><blockquote class="nd ne nf"><p id="7aa4" class="jn jo mu jp b jq jr js jt ju jv jw jx ng jz ka kb nh kd ke kf ni kh ki kj kk ij bi translated">不幸的是，没有。您将不得不跨区域手动执行API URL。那意思是:</p><p id="d402" class="jn jo mu jp b jq jr js jt ju jv jw jx ng jz ka kb nh kd ke kf ni kh ki kj kk ij bi translated"><em class="iq">首先部署ApiStackIreland。记下API URL(也许把它做成输出，这样就容易找到了)。部署EdgeStack并插入第一步中的API URL的值。有很多方法可以做到这一点，老实说，我不知道该推荐哪一种。</em></p><p id="830f" class="jn jo mu jp b jq jr js jt ju jv jw jx ng jz ka kb nh kd ke kf ni kh ki kj kk ij bi translated"><em class="iq">我想一个实用的方法是使用</em> <code class="fe md me mf mg b"><em class="iq">this.node.getContext()</em></code> <em class="iq">并在部署第二个堆栈时在命令行上传递值(使用</em> <code class="fe md me mf mg b"><em class="iq">-c KEY=VALUE fflag</em></code> <em class="iq">)，或者将它放入cdk.json的context: {} section下。</em></p></blockquote><p id="c2f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完整的工作示例可以在github库中找到<a class="ae kl" href="https://github.com/miensol/miensol.github.io/tree/develop/content/posts/cloudfront-custom-domain-https" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><p id="e79c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mu">原载于</em><a class="ae kl" href="https://miensol.pl/cloudfront-custom-domain-https/" rel="noopener ugc nofollow" target="_blank"><em class="mu">https://mien sol . pl</em></a><em class="mu">。</em></p></div></div>    
</body>
</html>