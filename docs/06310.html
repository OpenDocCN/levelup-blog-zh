<html>
<head>
<title>Notes on using Microsoft Graph SDK to manage users in an Azure AD B2C tenant.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于使用Microsoft Graph SDK管理Azure AD B2C租户中的用户的说明。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/notes-on-using-microsoft-graph-sdk-to-manage-users-in-an-azure-ad-b2c-tenant-69132409d34a?source=collection_archive---------4-----------------------#2020-11-14">https://levelup.gitconnected.com/notes-on-using-microsoft-graph-sdk-to-manage-users-in-an-azure-ad-b2c-tenant-69132409d34a?source=collection_archive---------4-----------------------#2020-11-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/95c6d76d9b0c8db8e816b73b1421198b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jls_PZpS_aQKZar-wXTttg.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">图片由<a class="ae kf" href="https://pixabay.com/users/congerdesign-509903/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2481718" rel="noopener ugc nofollow" target="_blank">康格设计</a>来自<a class="ae kf" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2481718" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></figcaption></figure><p id="33b6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我最近致力于将现有SQL数据库中的用户帐户迁移到Azure AD B2C。我从微软找到了一些有用的文章，它们记录了不同的迁移方法，并提供了使用Microsoft Graph SDK管理用户的示例代码。您可以在参考资料部分找到这些文章和示例项目的链接。</p><p id="c7ac" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在很大程度上，我在基本的CRUD操作上没有遇到太多麻烦。然而，我在处理自定义属性和通过电子邮件检索用户时遇到了一些困难。在这篇文章中，我将分享一些我学到的技巧和注意事项。特别是，我将讨论:</p><ul class=""><li id="00ec" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">管理用户所需的Microsoft Graph API权限。</li><li id="9205" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">关于UserPrincipalName属性和通过电子邮件检索用户的警告。</li><li id="d1c4" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">在Azure ADB2C中设置和检索自定义属性。</li></ul><h1 id="e626" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">您可能需要的Microsoft Graph API权限</h1><p id="afd7" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">根据有关Microsoft Graph权限的文档，您至少需要以下应用程序权限来创建和更新用户简档:</p><p id="fe55" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mv mw mx my b"><em class="mz">Directory.ReadWrite.All</em></code></p><p id="787c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据文件，<em class="mz">目录。ReadWrite.All </em></p><p id="d8cc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">允许应用程序在没有登录用户的情况下读取和写入组织目录中的数据，如用户和组。不允许删除用户或组。</p><p id="ebb3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/graph/permissions-reference#application-permissions-61" rel="noopener ugc nofollow" target="_blank">图表权限参考</a></p><p id="176a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，当您阅读文档时，如果您还想删除用户的帐户或重置用户的密码，上述权限是不够的。对于这些操作，您需要以下权限:</p><p id="12bc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据文档，用户为<em class="mz">。ReadWrite.All </em></p><blockquote class="na nb nc"><p id="6fe9" class="kg kh mz ki b kj kk kl km kn ko kp kq nd ks kt ku ne kw kx ky nf la lb lc ld im bi translated">允许应用程序读取和写入您组织中其他用户的全套简档属性、组成员资格、报告和经理，无需登录用户。还允许应用程序创建和删除非管理用户。不允许重置用户密码。</p><p id="9701" class="kg kh mz ki b kj kk kl km kn ko kp kq nd ks kt ku ne kw kx ky nf la lb lc ld im bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/graph/permissions-reference#application-permissions-61" rel="noopener ugc nofollow" target="_blank">图形权限</a></p></blockquote><p id="cfc0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据您的设置，在应用程序或委派权限之间进行选择。在我的应用程序中，我使用应用程序权限，因为迁移脚本不涉及用户。欲了解更多信息，请查看此<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/developer-glossary#permissions" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="b9e7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是如何通过Azure门户向应用添加权限:</p><ol class=""><li id="77cd" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld ng lk ll lm bi translated">在app注册页面，进入<strong class="ki iu"> API权限</strong>。</li><li id="5622" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld ng lk ll lm bi translated">点击<strong class="ki iu">添加一个权限</strong>。</li><li id="d424" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld ng lk ll lm bi translated">在<strong class="ki iu">下选择一个API </strong>，选择<strong class="ki iu">微软图形</strong>。</li><li id="c96c" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld ng lk ll lm bi translated">选择<strong class="ki iu">应用权限</strong>。</li><li id="043c" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld ng lk ll lm bi translated">搜索并添加所需的权限。</li></ol><figure class="ni nj nk nl gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nh"><img src="../Images/4d8c2c25d71dfee74db1e1e10851b28f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VTJwVErrS2Tr9fxc"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在Azure ADB2C中添加API权限</figcaption></figure><p id="1992" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">无论是用户。ReadWrite.All和目录。读写。所有权限都需要管理员同意。如果您是租户的管理员，添加权限后，您可以单击“配置的权限”下的“授予{您的租户名称}管理员权限”链接来授予权限。如果您不是管理员，请联系具有管理员权限的人员，该人员可以通过转到API权限下的同一个屏幕来给予同意。</p><figure class="ni nj nk nl gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nh"><img src="../Images/c9a466a07e9df8cf11f449f1366b879f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MJ7WXZR_x4GkJERd"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">授予管理员权限</figcaption></figure><p id="0da2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我没有尝试使用graph SDK更新用户密码。但是，如果您需要重置用户密码，您需要为您的应用程序分配<em class="mz">用户管理员</em>角色。欲了解更多信息，请查看<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/microsoft-graph-get-started?tabs=app-reg-ga#enable-user-delete-and-password-update" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="706b" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">UserPrincipalName属性的警告</h1><p id="6e38" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">在通过id检索用户对象时，我检查了默认属性，以确定哪些属性可以用于过滤电子邮件。在我得到的属性中，只有“mail”和“userPrincipalName”属性是合适的。然而，在我们的目录中，所有用户都有空白邮件。这应该不成问题，因为我希望能够使用userPrincipalName属性，因为在门户中，该属性似乎包含一封电子邮件。</p><figure class="ni nj nk nl gt ju gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/86f41468360c67992ada78c5bcbc8982.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/0*2qptVRwzrowLK33o"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在azure ADB2C门户中，用户主体名称显示用户的电子邮件</figcaption></figure><p id="0030" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mz">然而，我从graph API为那个用户返回的userPrincipalName的值是用户的对象id，而不是电子邮件。</em></p><p id="0ac2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这让我有点吃惊。幸运的是，我已经习惯了惊喜，与不同的API一起工作。我想到了使用替代方法，比如过滤多个属性，比如givenName和surName。虽然我们不可能有两个同名同姓的人，但这仍然是可能的，我需要一个确切的结果，所以根据这些属性进行过滤是行不通的。</p><p id="df7e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在咨询了我最好的朋友Google之后，我发现通过邮件完成过滤的方法是使用<em class="mz"> issuerAssignedId </em>属性。</p><pre class="ni nj nk nl gt nn my no np aw nq bi"><span id="1361" class="nr lt it my b gy ns nt l nu nv">private async Task&lt;User&gt; ExpectExactUserByEmail(string email)<br/>        {<br/>            // https://github.com/microsoftgraph/microsoft-graph-docs/issues/7282<br/>            var filter = $"identities / any(id: id / issuer eq '{_migrationAppOptions.Issuer}' and id / issuerAssignedId eq '{email}')";<br/>            return await ExpectExactUser(filter);<br/>        }<br/><br/>private async Task&lt;User&gt; ExpectExactUser(string filter)<br/>        {<br/>            var users = await _graphClient.Users.Request().Filter(filter).Select(_defaultUserSelectAttributes).GetAsync();<br/>            if (users.Count == 0)<br/>            {<br/>                throw new KeyNotFoundException($"Not able to find user with given filter: {filter}");<br/>            }<br/>            else if (users.Count &gt; 1)<br/>            {<br/>                throw new ArgumentException($"More than one users found with given filter: {filter}");<br/>            }<br/>            return users[0];<br/>        }</span></pre><p id="0c48" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的代码片段中，请注意过滤是基于身份的，并使用了issuer和issuerAssignedId属性，按照这个<a class="ae kf" href="https://github.com/microsoftgraph/microsoft-graph-docs/issues/7282" rel="noopener ugc nofollow" target="_blank">问题</a>。我怀疑这只是因为我们在创建用户时使用了“emailAddress”登录类型。事实上，当使用SDK创建用户时，我必须将graph用户对象的Identities属性设置为:</p><pre class="ni nj nk nl gt nn my no np aw nq bi"><span id="1e08" class="nr lt it my b gy ns nt l nu nv">Identities = new ObjectIdentity[] {<br/>  new ObjectIdentity() {<br/>    SignInType = "emailAddress",<br/>    Issuer = _migrationAppOptions.Issuer,<br/>    IssuerAssignedId = adB2CUser.UserEmail<br/>  }<br/>}</span></pre><h1 id="6e96" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">设置和检索自定义用户属性</h1><p id="3e68" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">我曾经看到过过时的帖子，暗示微软Graph SDK不支持Azure AD B2C中的自定义属性，替代方案是使用<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-graph-api" rel="noopener ugc nofollow" target="_blank">Azure Active Directory Graph API</a>。然而，azure active directory graph api正在逐渐消失，微软Graph SDK是其继任者。</p><p id="d6cd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我使用它的时候，Microsoft Graph SDK确实支持使用自定义属性，因为我能够按照示例代码来设置和检索自定义属性，所以您可以尝试一下。</p><p id="66a5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">需要注意的一点是，您需要使用自定义属性的全名，您可以使用以下格式来构造它:</p><p id="535b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">扩展_ {删除了所有破折号的b2c扩展应用程序的客户端} _ {属性名称} '</p><p id="ee8d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当您创建azure ad b2c租户时，b2c-extensions-app会自动注册。</p><figure class="ni nj nk nl gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nh"><img src="../Images/09611f9c06c97ecc6981d8c3b3f1189c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GY10D5jGe5-6Fqwk"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">B2C-扩展-当您创建租户时，应用程序会自动注册</figcaption></figure><p id="2932" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面展示了我用来构建完整属性名的代码片段。</p><pre class="ni nj nk nl gt nn my no np aw nq bi"><span id="e130" class="nr lt it my b gy ns nt l nu nv">private string ExtensionAttributeFullName(string attributeName)<br/>        {<br/>            return $"extension_{B2CExtensionsAppClientId.Replace("-", "")}_{attributeName}";<br/>        }</span></pre><p id="cfc5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在检索用户时，可以使用$select子句将自定义属性包含在从图中返回的结果中，如下例所示。</p><pre class="ni nj nk nl gt nn my no np aw nq bi"><span id="710e" class="nr lt it my b gy ns nt l nu nv">public async Task &lt; User &gt; GetUserByIdAsync(string userId) {<br/>  var select = $ "id, givenName, surName, extension_2b76741733644c348db79bdc2e1002ce_MigrationSource";<br/>  return await _graphClient.Users[userId].Request().Select(select).GetAsync();<br/>}</span></pre><p id="fd1e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建用户时，可以使用字典设置自定义属性，并将其分配给图形用户的AdditionalData属性，如下面的代码片段所示。</p><pre class="ni nj nk nl gt nn my no np aw nq bi"><span id="08c4" class="nr lt it my b gy ns nt l nu nv">public async Task &lt; User &gt; MergeUser([Required] ADB2CUserDTO adB2CUser) {<br/>  IDictionary &lt; string,<br/>  object &gt; extensionInstance = new Dictionary &lt; string,<br/>  object &gt; {<br/>    {<br/>      _migrationAppOptions.ExtensionAttributeMigrationSourceFullName,<br/>      "My web app"<br/>    }<br/>  };<br/>  User user = new User() {<br/>    AccountEnabled = true,<br/>    DisplayName = adB2CUser.DisplayName,<br/>    PasswordProfile = new PasswordProfile {<br/>      ForceChangePasswordNextSignIn = true,<br/>      Password = _passwordGenerator.GenerateAlphanumericPassword()<br/>    },<br/>    GivenName = adB2CUser.GivenName,<br/>    Surname = adB2CUser.Surname,<br/>    PostalCode = adB2CUser.PostalCode,<br/>    State = adB2CUser.State,<br/>    StreetAddress = adB2CUser.StreetAddress,<br/>    City = adB2CUser.City,<br/>    MobilePhone = adB2CUser.TelephoneNumber,<br/>    Country = adB2CUser.Country,<br/>    Identities = new ObjectIdentity[] {<br/>      new ObjectIdentity() {<br/>        SignInType = "emailAddress",<br/>        Issuer = _migrationAppOptions.Issuer,<br/>        IssuerAssignedId = adB2CUser.UserEmail<br/>      }<br/>    },<br/>    AdditionalData = extensionInstance<br/>  };<br/>  return await _graphClient.Users.Request().AddAsync(user);<br/>}</span></pre><p id="0d08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这就是这篇文章的全部内容。一如既往，如果你有任何问题，请随时联系我们。</p><h1 id="4016" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">参考</h1><p id="5b2f" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/graph/best-practices-concept" rel="noopener ugc nofollow" target="_blank">使用Microsoft Graph的最佳实践</a></p><p id="f23d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://github.com/azure-ad-b2c/user-migration" rel="noopener ugc nofollow" target="_blank"> Git报告用户迁移示例代码</a></p><p id="f87e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/user-profile-attributes" rel="noopener ugc nofollow" target="_blank"> Azure ADB2C用户属性</a></p><p id="6c6a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/microsoft-graph-get-started?tabs=app-reg-ga#enable-user-delete-and-password-update" rel="noopener ugc nofollow" target="_blank">用户删除和密码更新权限</a></p><p id="1201" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://github.com/microsoftgraph/microsoft-graph-docs/issues/7282" rel="noopener ugc nofollow" target="_blank"> Microsoft graph文档问题:无法按身份过滤用户</a></p><p id="1589" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://www.nuget.org/packages/Microsoft.Graph" rel="noopener ugc nofollow" target="_blank">微软Graph nuget包</a></p></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><p id="a606" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mz">原载于2020年11月14日</em><a class="ae kf" href="https://www.taithienbo.com/notes-on-using-microsoft-graph-sdk-to-manage-users-in-an-azure-ad-b2c-tenant/" rel="noopener ugc nofollow" target="_blank"><em class="mz"/></a><em class="mz">。</em></p></div></div>    
</body>
</html>