<html>
<head>
<title>Build a Simple Stock Price Indicator with SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用SQL构建一个简单的股票价格指标</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/build-a-simple-stock-price-indicator-with-sql-7ddf169d8b33?source=collection_archive---------8-----------------------#2020-05-29">https://levelup.gitconnected.com/build-a-simple-stock-price-indicator-with-sql-7ddf169d8b33?source=collection_archive---------8-----------------------#2020-05-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="4093" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当你进入投资世界时，你会做的第一件事是挑选一只股票，看它的股价，但你不知道它意味着什么。这时候你可能需要获取股票的基本面和一些指标来评价股票是否公允。当然，像市盈率、净收入利润率、股息收益率这样的基本指标是很好的指标，但是像移动平均线这样的技术指标对于理解股价的趋势是有用的。直到我用移动平均线构建可视化股票价格的仪表板时，我才意识到这个有用的指标很容易用pandas或SQL来计算。在这篇文章中，我将解释如何用SQL (Postgre SQL)计算移动平均线。</p><p id="e872" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">移动平均线是如何计算的？</strong> <br/>均线是识别股价趋势、支撑位、阻力位的技术指标。它是用一定时期内的平均股价计算出来的。例如，对于50天移动平均线的计算，我将对过去50天每天的平均股价求和，然后除以50。简单来说，我后面举的例子是将一只股票最近50天的收盘价相加，然后除以50。</p><p id="c367" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">示例</strong> <br/>我已经从Yahoo Finance的本地数据库的股票模式的stock price表中获取了标准普尔500指数中所有股票成分的股价。stockprice表由以下几列组成:<br/> - ticker(股票的股票代码)<br/> - tradedate(交易日，在时间戳中)<br/> - openprice(开盘价)<br/> - high(每日最高价)<br/> - low(每日最低价)<br/> - closeprice(收盘价)<br/> - volume(当天的交易量)</p><p id="66b9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">先通过查询苹果(AAPL)2019年收盘价来预热一下:</p><pre class="ko kp kq kr gt ks kt ku kv aw kw bi"><span id="ebe9" class="kx ky it kt b gy kz la l lb lc">select tradedate, closeprice<br/>from stock.stockprice<br/>where date_part(‘year’, tradedate) = 2019<br/>and ticker = ‘AAPL’;</span></pre><p id="b103" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们可以计算苹果股票的50天移动平均线。为此，我们可以使用分析功能来帮助我们。SQL中的分析函数可以帮助我们对表中的一组行进行平均或其他聚合。利用这一点，我们可以使用分析功能来帮助我们收集最近50天的收盘价，并对2019年的每个交易日进行平均。</p><p id="1f98" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">分析函数的语法如下所示:</p><pre class="ko kp kq kr gt ks kt ku kv aw kw bi"><span id="9cda" class="kx ky it kt b gy kz la l lb lc">avg(closeprice) over (partition by ticker<br/>order by tradedate<br/>rows 50 preceding)</span></pre><p id="91a6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个语法中，我们将所有股票价格按股票代号分组，然后股票价格按交易日期排序。之后，获取最后50行并取平均值。完整的查询是:</p><pre class="ko kp kq kr gt ks kt ku kv aw kw bi"><span id="e305" class="kx ky it kt b gy kz la l lb lc">select tradedate, closeprice,<br/>avg(closeprice) over (partition by ticker<br/>order by tradedate rows 50 preceding ) as ma50<br/>from stock.stockprice<br/>where ticker = ‘AAPL’ and <br/>date_part(‘year’, tradedate) = 2019;</span></pre><p id="6f7d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们用这个查询请求数据，结果看起来不像我们想要的:</p><figure class="ko kp kq kr gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi ld"><img src="../Images/d7a03b2a3b31ba14a78b2ff2dc03ab09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bwy4EDZT5x8Buq12cM_OVw.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">上述查询的结果</figcaption></figure><p id="bf6f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果仔细观察ma50列，该列仅取第一行到当前行之间的平均值。如果当前行之前没有50行，这不是我们想要的！为了解决这个问题，让我们使用一个子查询来获取2018年和2019年之间的股票价格，以便采用移动平均，查询如下:</p><pre class="ko kp kq kr gt ks kt ku kv aw kw bi"><span id="33f0" class="kx ky it kt b gy kz la l lb lc">select tradedate, closeprice, ma50<br/>from(<br/>select tradedate, closeprice, <br/>avg(closeprice) over (partition by ticker order by tradedate rows 50 preceding) as ma50 from stock.stockprice<br/>where ticker = ‘AAPL’ and <br/>date_part(‘year’, tradedate) between 2018 and 2019) as i<br/>where date_part(‘year’, i.tradedate) = 2019;</span></pre><p id="2e4d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，它将返回以下结果:</p><figure class="ko kp kq kr gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi lp"><img src="../Images/8e8a71e37a4049a5b8613d2a2e8ca8d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TyADCWwpJWYrUuMPTY-EfQ.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">上述查询的结果</figcaption></figure><p id="3a00" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，结果看起来更有希望。</p><p id="340d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不同时间间隔的均线是观察股票是看涨还是看跌的好指标。如果我们有苹果(AAPL)的50天移动平均线和100天移动平均线，如果50天移动平均线在100天移动平均线之上，我们可以判断该股票是看涨，还是看跌。我们可以在SQL中做到这一点！让我们通过下面的查询找出苹果股票每天是看涨还是看跌:</p><pre class="ko kp kq kr gt ks kt ku kv aw kw bi"><span id="a075" class="kx ky it kt b gy kz la l lb lc">select tradedate, closeprice,<br/>round(ma50::numeric, 2) as ma50,<br/>round(ma100::numeric, 2) as ma100,<br/>case when ma50&gt;ma100 then ‘Bullish’ else ‘Bearish’ end as bullish_indicator<br/>from( select tradedate, closeprice,<br/>avg(closeprice) over (partition by ticker order by tradedate rows 50 preceding) as ma50,<br/>avg(closeprice) over (partition by ticker order by tradedate rows 100 preceding) as ma100 from stock.stockprice<br/>where ticker = ‘AAPL’ <br/>and date_part(‘year’, tradedate) between 2018 and 2019) as i<br/>where date_part(‘year’, i.tradedate) = 2019;</span></pre><p id="a8b6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">结果看起来像这样:</p><figure class="ko kp kq kr gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi lq"><img src="../Images/c8f84f90b86a0ef2e3bd7abab8e0a2dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HVr8s7mm33MsidHMc9bp4A.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">上述查询的结果</figcaption></figure><p id="5f64" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个查询看起来更复杂，但是我们只添加了两个块:添加100天移动平均线和案例条件。案例条件基本上是检查ma50中的值是否大于ma100，如果是，此列返回“看涨”，否则返回“看跌”。</p><p id="b3fc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们向下滚动到2019年3月，我们可以看到看涨_指标从看跌转为看涨，因此它告诉我们该指标正在发挥作用。现在，我们可以使用SQL创建一个简单的股价指标进行技术分析！</p><p id="3a57" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">奖励—熊猫</strong> <br/>我们也可以用Python在熊猫里做同样的事情！语法也很简单。如果我们有Pandas数据帧，数据帧名为df，列名相同，我们可以用下面的语法做同样的事情:</p><pre class="ko kp kq kr gt ks kt ku kv aw kw bi"><span id="ef6f" class="kx ky it kt b gy kz la l lb lc">df[‘MA50’] = df.closeprice.rolling(50).mean()<br/>df[‘MA100’] = df.closeprice.rolling(100).mean()</span><span id="d70c" class="kx ky it kt b gy lr la l lb lc">def bullish_indicator(row):<br/> row[‘MA50’] &gt; row[‘MA100’]: return ‘Bullish’<br/> return ‘Bearish’</span><span id="1005" class="kx ky it kt b gy lr la l lb lc">df[‘bullish_indicator’] = df.apply(lambda row: bullish_indicator(row), axis=1)</span></pre><p id="e29f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">应用</strong> <br/>将股价与均线一起可视化更有帮助。在我的另一篇中篇文章中，<em class="ls"> </em> <a class="ae lt" href="https://medium.com/@jjsham/building-stock-price-dashboard-with-plotly-dash-part-i-b165b3edfdd6" rel="noopener"> <em class="ls">用Plotly Dash构建的股票价格仪表板—第1部分</em> </a>，我在那里谈到了如何用Dash构建股票价格仪表板。股价可视化显示移动平均指标和股价。可视化依赖于来自该SQL查询或Pandas数据框的数据来生成。</p><figure class="ko kp kq kr gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi lu"><img src="../Images/5fe5fc82f9ec03a2b91f5da8d62157de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oOx28zZRxAWSwymYD7J7FA.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">股票价格仪表板</figcaption></figure><p id="b0a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除了股票是看涨还是看跌，我们还可以用均线的较长周期来判断股价的走势。如果我们看到200天移动平均线向上倾斜，这意味着股价趋势正在上升；如果200天移动平均线向下倾斜，趋势就会下降。有趣的是，如果200天移动平均线是平的，我们可以看出股价非常稳定。</p><p id="012d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">结论</strong> <br/>投资很难，但是用股价做技术分析并没有我们想象的那么难。SQL很简单，我们可以使用这个工具轻松地制作简单的指标。一旦将股票价格保存在本地数据库中，您就可以查询结果并自行进行一些简单的技术分析。</p><p id="b869" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">免责声明</strong> <br/>本帖中的任何预测仅供参考，并非事实。任何交易行为都应咨询您的理财经理，我不对任何交易损失负责。</p><div class="lv lw gp gr lx ly"><a href="https://www.linkedin.com/in/jacquessham/" rel="noopener  ugc nofollow" target="_blank"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd iu gy z fp md fr fs me fu fw is bi translated">雅克·沙姆-旧金山湾区|职业简介| LinkedIn</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">查看雅克·沙姆在全球最大的职业社区LinkedIn上的个人资料。雅克有4个工作列在他们的…</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">www.linkedin.com</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm lj ly"/></div></div></a></div></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><p id="1bd9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">参考</strong><br/>【1】Investopedia。<em class="ls">移动平均线(MA) </em>。<br/><a class="ae lt" href="https://www.investopedia.com/terms/m/movingaverage.asp" rel="noopener ugc nofollow" target="_blank">https://www.investopedia.com/terms/m/movingaverage.asp</a></p><p id="d397" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">[2]尼古拉斯·罗斯博士<em class="ls">数据管理或被SQL和熊猫打脸。</em></p></div></div>    
</body>
</html>