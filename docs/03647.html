<html>
<head>
<title>Geo distance search using Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用弹性搜索进行地理距离搜索</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/geo-distance-search-using-elasticsearch-7e2e69d76343?source=collection_archive---------13-----------------------#2020-05-20">https://levelup.gitconnected.com/geo-distance-search-using-elasticsearch-7e2e69d76343?source=collection_archive---------13-----------------------#2020-05-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/28f81e7d797c5cb870e9a64d14ab65c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xbBq_BuxX48n823V.jpeg"/></div></div></figure><p id="b714" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇博客中，我将讲述如何使用Elasticsearch测量距离。地理距离测量是许多应用程序的一个非常重要的方面。现在让我们举一个非常简单的例子，当我们搬到任何一个新的地点时，谷歌开始向我们显示最近的景点，或者任何出租车聚合服务使用你的当前位置为你预订最近的出租车。基于地理距离的搜索也是一个非常重要的用例，我们试图找到最近的餐馆、自动取款机、医院或几乎任何东西。</p><p id="b48f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">到目前为止，我们已经讨论了基于地理距离的搜索非常重要的不同使用案例，对于一些企业来说，这一点非常重要。但是问题出现了:你实际上如何执行地理搜索？因此，让我们来看看如何在Elasticsearch中执行地理搜索。</p><p id="fd29" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Elasticsearch还支持地理数据类型，这些数据可以是地理点和地理形状两种类型。在这个博客中，我们将重点关注地理点，它是一个点的表示，而点只不过是一个具有纬度和经度的地理坐标。尽管Elasticsearch接受没有为地理数据显式创建映射的数据，但我们需要显式创建映射，因为这是执行地理查询的第一步。</p><p id="9514" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是在创建映射之前，让我们了解我们在这个博客中要实现什么。因此，我们的想法是在Elasticsearch中创建一个索引，并创建一个geo-point类型的字段来保存纬度和经度。然后，我们将添加一些地理数据来表示一个假的位置，如一些停车位置。添加这些停车位置后，我们将传递一个任意的用户当前位置，并尝试找到最近的停车位置。</p><p id="ef11" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，让我们从索引创建以及地理点类型的位置字段映射开始。我们需要执行以下命令来创建索引和位置映射:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="40c0" class="lf lg iq lb b gy lh li l lj lk">PUT parking_locations<br/>{<br/>  "mappings": {<br/>    "properties": {<br/>      "location": {<br/>        "type": "geo_point"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="19bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">执行上述命令后，我们可以获得以下成功响应:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="5076" class="lf lg iq lb b gy lh li l lj lk">{<br/> "acknowledged" : true,<br/> "shards_acknowledged" : true,<br/> "index" : "parking_locations"<br/>}</span></pre><p id="3b05" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的停车位置索引与位置字段的映射一起创建。现在让我们添加一些任意位置，以便我们可以在以后应用地理搜索。我们将添加以下数据:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="721a" class="lf lg iq lb b gy lh li l lj lk">Parking 1 28.594817, 77.046608<br/>Parking 2 28.593168, 77.041244<br/>Parking 3 28.601345, 77.026352<br/>Parking 4 28.590606, 77.062959</span></pre><p id="e5cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要添加这些数据，我们可以对每个文档执行以下查询:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="585e" class="lf lg iq lb b gy lh li l lj lk">POST parking_locations/_doc<br/>{<br/> "name": "Parking 1",<br/> "location": "28.594817, 77.046608",<br/> "address": "street 1, sec abc"<br/>}</span></pre><p id="d0bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">执行上述命令后，我们可以得到以下响应:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="87d0" class="lf lg iq lb b gy lh li l lj lk">{<br/>  "_index" : "parking_locations",<br/>  "_type" : "_doc",<br/>  "_id" : "uDz1HnIBtlnNM0yOpqq6",<br/>  "_version" : 1,<br/>  "result" : "created",<br/>  "_shards" : {<br/>    "total" : 2,<br/>    "successful" : 1,<br/>    "failed" : 0<br/>  },<br/>  "_seq_no" : 0,<br/>  "_primary_term" : 1<br/>}</span></pre><p id="d227" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以对其他三个文档进行同样的操作，也可以使用批量索引在单个查询中添加所有这些文档。现在我们有了一个包含四个不同停车位置的索引。要验证是否添加了所有文档，我们可以运行以下命令:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="b93d" class="lf lg iq lb b gy lh li l lj lk">GET parking_locations/_search</span></pre><p id="3996" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面的命令将列出parking_locations索引的所有文档，我们可以验证是否在索引中创建了所有四个文档。现在我们的索引已经为地理查询做好了准备。现在假设我是城市的新用户，当前位置为<strong class="ka ir"> 28.580116，77.051673 </strong>。我正在寻找一个停车位置，如何找到最近的停车地址？</p><p id="ca3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">举个例子，我想搜索距离我当前位置2公里范围内的所有停车场。因此，要获得2公里范围内的停车位置，我们需要执行以下查询:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="0baf" class="lf lg iq lb b gy lh li l lj lk">GET parking_locations/_search<br/>{<br/>    "query": {<br/>        "bool" : {<br/>            "must" : {<br/>                "match_all" : {}<br/>            },<br/>            "filter" : {<br/>                "geo_distance" : {<br/>                    "distance" : "2km",<br/>                    "location" : "28.580116, 77.051673"<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="7fa5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">执行以下命令后，我们可以看到在离我的位置2公里以内有三个停车场。请参考执行上述查询后我们可以收到的以下响应:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="e7a3" class="lf lg iq lb b gy lh li l lj lk">{<br/>  "took" : 8,<br/>  "timed_out" : false,<br/>  "_shards" : {<br/>    "total" : 1,<br/>    "successful" : 1,<br/>    "skipped" : 0,<br/>    "failed" : 0<br/>  },<br/>  "hits" : {<br/>    "total" : {<br/>      "value" : 3,<br/>      "relation" : "eq"<br/>    },<br/>    "max_score" : 1.0,<br/>    "hits" : [<br/>      {<br/>        "_index" : "parking_locations",<br/>        "_type" : "_doc",<br/>        "_id" : "uDz1HnIBtlnNM0yOpqq6",<br/>        "_score" : 1.0,<br/>        "_source" : {<br/>          "name" : "Parking 1",<br/>          "location" : "28.594817, 77.046608",<br/>          "address" : "street 1, sec abc"<br/>        }<br/>      },<br/>      {<br/>        "_index" : "parking_locations",<br/>        "_type" : "_doc",<br/>        "_id" : "uTz3HnIBtlnNM0yOj6qg",<br/>        "_score" : 1.0,<br/>        "_source" : {<br/>          "name" : "Parking 2",<br/>          "location" : "28.593168, 77.041244",<br/>          "address" : "street 3, sec wer"<br/>        }<br/>      },<br/>      {<br/>        "_index" : "parking_locations",<br/>        "_type" : "_doc",<br/>        "_id" : "uzz3HnIBtlnNM0yO_aou",<br/>        "_score" : 1.0,<br/>        "_source" : {<br/>          "name" : "Parking 4",<br/>          "location" : "28.590606, 77.062959",<br/>          "address" : "street 4, sec qer"<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="f9d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这样，通过提供不同的距离范围，我们可以从我们的当前位置获取具有地理位置的文档。我们可以将这个2 KM范围更改为任何其他范围，并且可以获得不同的文档集。</p><p id="8c5f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如有任何疑问，请留下您的意见。你也可以在推特上关注我:<a class="ae ll" href="https://twitter.com/anu4udilse" rel="noopener ugc nofollow" target="_blank">https://twitter.com/anu4udilse</a></p><p id="a1cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lm">如果你觉得这篇文章有趣，那么你可以探索一下“</em> <a class="ae ll" href="https://www.amazon.com/Mastering-Kibana-6-x-Visualize-histograms/dp/1788831039/ref=olp_product_details?_encoding=UTF8&amp;me=" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="lm">【掌握基巴纳6.0】</em></strong></a><em class="lm">”、</em> <a class="ae ll" href="https://www.amazon.com/Kibana-Quick-Start-Guide-Elasticsearch/dp/1789804035" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="lm">基巴纳7快速入门指南</em> </strong> </a> <em class="lm">”、</em> <a class="ae ll" href="https://www.amazon.com/Learning-Kibana-dashboards-visualization-capabilities-ebook/dp/B07V4SQR6T" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="lm">学习基巴纳7 </em> </strong> </a> <em class="lm">”、</em> <a class="ae ll" href="https://www.amazon.com/gp/product/1789803322?pf_rd_p=2d1ab404-3b11-4c97-b3db-48081e145e35" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="lm">弹力</em></strong></a></p></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><p id="b6ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其他博客:</p><p id="b8a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ll" href="https://faun.pub/introduction-to-logstash-afe109b886f0" rel="noopener ugc nofollow" target="_blank">Logstash简介</a></p><p id="0368" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ll" rel="noopener ugc nofollow" target="_blank" href="/introduction-to-kibana-5ce16ae7244b">基巴纳简介</a></p><p id="03e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ll" href="https://faun.pub/log-analysis-with-elastic-stack-2a493c113084" rel="noopener ugc nofollow" target="_blank">弹性叠加测井分析</a></p><p id="6209" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ll" href="https://medium.com/swlh/introduction-to-openapi-specification-10c9d6fb0c8a" rel="noopener">open API规范介绍</a></p><p id="70ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ll" rel="noopener ugc nofollow" target="_blank" href="/geo-distance-search-using-elasticsearch-7e2e69d76343">使用弹性搜索进行地理距离搜索</a></p><p id="12da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ll" rel="noopener ugc nofollow" target="_blank" href="/load-csv-data-into-elasticsearch-fdb562a7abd9">将CSV数据加载到Elasticsearch </a></p><p id="9f19" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ll" href="https://faun.pub/configure-sonarqube-scanner-with-jenkins-27c23e7758fd" rel="noopener ugc nofollow" target="_blank">用Jenkins配置SonarQube扫描仪</a></p><p id="c6fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ll" rel="noopener ugc nofollow" target="_blank" href="/configure-logstash-to-send-mongodb-data-into-elasticsearch-49cc0e9c2a8d">配置Logstash将MongoDB数据发送到Elasticsearch </a></p></div></div>    
</body>
</html>