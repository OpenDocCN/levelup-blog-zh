<html>
<head>
<title>How to solve Django memory leak</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何解决Django内存泄漏</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/the-experience-of-solving-memory-leak-of-django-uwsgi-nginx-aws-cdb998244cfb?source=collection_archive---------2-----------------------#2020-06-07">https://levelup.gitconnected.com/the-experience-of-solving-memory-leak-of-django-uwsgi-nginx-aws-cdb998244cfb?source=collection_archive---------2-----------------------#2020-06-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="01e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">django 2+uws gi+Nginx+AWS(ECR+ECS+EC2+ALB+VPC+CloudFront)</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/07f53e60ca91a23d8a4d590dbc57c29d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ByF2bI_th39NCQ9a0Q9Yw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图片来源:谷歌</figcaption></figure><p id="97eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近，在AWS上部署了一个小的Django应用程序后，我们遇到了内存泄漏问题。幸运的是，我们最终通过修改uswgi.ini解决了这个问题。</p><p id="cb72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在得到这个问题之前，我们用<a class="ae lb" href="https://uwsgi-docs.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> uWSGI </a>和<a class="ae lb" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> Nginx </a>对应用进行了dockerized，构建了一个镜像，用CI/CD推送到<a class="ae lb" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank"> AWS ECR </a>。之后我们用<a class="ae lb" href="https://aws.amazon.com/vpc/" rel="noopener ugc nofollow" target="_blank"> VPC </a>、<a class="ae lb" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html" rel="noopener ugc nofollow" target="_blank"> ALB </a>、<a class="ae lb" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank"> ECS </a>、<a class="ae lb" href="https://aws.amazon.com/ec2/" rel="noopener ugc nofollow" target="_blank"> EC2 </a>、<a class="ae lb" href="https://aws.amazon.com/cloudfront/?sc_channel=PS&amp;sc_campaign=acquisition_TW&amp;sc_publisher=google&amp;sc_medium=cloudfront_b&amp;sc_content=cloudfront_e&amp;sc_detail=aws%20cloud%20front&amp;sc_category=cloudfront&amp;sc_segment=165240657802&amp;sc_matchtype=e&amp;sc_country=TW&amp;s_kwcid=AL!4422!3!165240657802!e!!g!!aws%20cloud%20front&amp;ef_id=EAIaIQobChMIvoae68rs6QIVQ6WWCh2ltQvrEAAYASAAEgJc2vD_BwE:G:s&amp;s_kwcid=AL!4422!3!165240657802!e!!g!!aws%20cloud%20front" rel="noopener ugc nofollow" target="_blank"> CloudFront </a>进行了部署。</p><h1 id="01a5" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">问题</h1><p id="f2a3" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">起初，它像预期的那样工作。然而，在运行了几个小时后，我们得到了大约500个错误。在做了一些研究后，我们发现应用程序的内存使用率几乎是100%。所以我们增加了内存，设置了软限制。然而，我们发现，当请求数量增加时，内存使用量会增加，而不会减少。也就是说，我们遇到了内存泄漏问题。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/3f682a875f575d14a7d4589edd41afd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*byVSsBF4IqOEKwsY.jpg"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图片来源:<a class="ae lb" href="https://makeameme.org/meme/memory-leaks-memory-8f1cc7495e" rel="noopener ugc nofollow" target="_blank">https://makeameme.org/meme/memory-leaks-memory-8f1cc7495e</a></figcaption></figure><p id="135f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用一些工具来找到原因并解决它，例如<a class="ae lb" href="https://docs.python.org/3/library/tracemalloc.html#module-tracemalloc" rel="noopener ugc nofollow" target="_blank"> tracemalloc </a>、<a class="ae lb" href="https://mg.pov.lt/objgraph/" rel="noopener ugc nofollow" target="_blank"> objgraph </a>，或者我们可以将<a class="ae lb" href="https://docs.djangoproject.com/en/dev/ref/settings/#std:setting-DEBUG" rel="noopener ugc nofollow" target="_blank"> DEBUG </a>设置为False。然而，我们没有足够的时间使用工具来找到bug，即使我们将DEBUG设置为False，问题仍然存在。</p><h1 id="4a69" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">说明</h1><p id="bf64" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">幸运的是，我们从这篇文章中找到了一个解释— <a class="ae lb" href="https://blog.gingerlime.com/2011/django-memory-leaks-part-i/" rel="noopener ugc nofollow" target="_blank"> django内存泄漏，第一部分</a>。</p><blockquote class="mg mh mi"><p id="e32e" class="jn jo mj jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated">Django会泄漏内存吗？事实上，不是这样的。因此，该标题具有误导性。我知道。然而，如果你不小心，你的内存使用或配置很容易导致耗尽所有内存和崩溃django。因此，虽然django本身不会泄漏内存，但最终结果是非常相似的。</p></blockquote><p id="f948" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是什么意思？简而言之，文章说Django进程有一个初始空间，用于在请求到来时将对象加载到内存中。一旦进程处理完一个请求，它将从内存中清除所有对象，并返回到“空”状态。但是，如果要求太大，进程就会增加，永远不会收缩。因此，如果多个大的请求几乎同时出现，Django process将不仅仅扩展一个流程，而是扩展其中的几个。因此，这些Django进程会竞争服务器上的空间。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/95ee5fb03be0dbb08a7df6a0e8c6bbec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*pUBSuN_yj8LZEsC9.jpg"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图片来源:<a class="ae lb" href="https://makeameme.org/meme/i-eat-to-5b7c9e" rel="noopener ugc nofollow" target="_blank">https://makeameme.org/meme/i-eat-to-5b7c9e</a></figcaption></figure><h1 id="9b40" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">解决办法</h1><p id="38a9" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">好，要解决这个问题，我们需要在某些条件下重新启动工人。因此，我们按照<a class="ae lb" href="https://www.techatbloomberg.com/blog/configuring-uwsgi-production-deployment/" rel="noopener ugc nofollow" target="_blank">为生产部署配置uw SGI</a>通过添加以下代码来修改<em class="mj"> uswgi.ini </em>:</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="abcc" class="ms ld iq mo b gy mt mu l mv mw"># Worker Management<br/>max-requests = 1000                  ; Restart workers after this many requests<br/>max-worker-lifetime = 3600           ; Restart workers after this many seconds<br/>reload-on-rss = 512                  ; Restart workers after this much resident memory<br/>worker-reload-mercy = 60             ; How long to wait before forcefully killing workers</span></pre><h1 id="54f9" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">结果</h1><p id="1589" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">如您所见，在部署新的Docker映像之前，内存使用量(蓝线)随着请求数量(红线)的增加而增加，从未减少。之后，在消耗请求之后，内存使用量下降。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mx"><img src="../Images/bb9c91a3fb27874e6161831b82ed41a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6RMZ1-QcwaOT61keZ457hg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">内存使用和请求计数</figcaption></figure><p id="3635" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望这篇文章能帮助你解决你的问题:)。</p></div><div class="ab cl my mz hu na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ij ik il im in"><div class="km kn ko kp gt nf"><a href="https://blog.gingerlime.com/2011/django-memory-leaks-part-i/" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd ir gy z fp nk fr fs nl fu fw ip bi translated">django内存泄漏，第一部分</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">不久前，我在为一些django实例优化内存使用。在这个过程中，我设法更好地…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">blog.gingerlime.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt kv nf"/></div></div></a></div><div class="nu nv gp gr nw nf"><a href="https://blog.csdn.net/ll641058431/article/details/78268303" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd ir gy z fp nk fr fs nl fu fw ip bi">python-Django内存泄露问题_soman的博客-CSDN博客</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk">一、python有自动垃圾回收机制（当对象的引用计数为零时解释器会自动释放内存），出现内存泄露的场景一般是扩展库内存泄露或者循环引用（还有一种是全局容器里的对象没有删除）…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">blog.csdn.net</p></div></div><div class="no l"><div class="nx l nq nr ns no nt kv nf"/></div></div></a></div><p id="d00b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://www.techatbloomberg.com/blog/configuring-uwsgi-production-deployment/" rel="noopener ugc nofollow" target="_blank">https://www . techatbloomberg . com/blog/configuring-uws gi-production-deployment/</a></p></div></div>    
</body>
</html>