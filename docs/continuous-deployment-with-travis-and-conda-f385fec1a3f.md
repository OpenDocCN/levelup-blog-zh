# Travis 和 CONDA 的持续部署

> 原文：<https://levelup.gitconnected.com/continuous-deployment-with-travis-and-conda-f385fec1a3f>

![](img/dba19dc8d23cf546b6dd5063c024e268.png)

Travis 和 Azure 等持续集成平台现在在现代开发环境中无处不在。自动使用别人的计算资源来测试和部署你的软件当然值得去弄清楚这些工具是如何工作的。在使用 Python 和 CONDA 时，下面的指南将把你推向更高的学习曲线。

这里的目标不仅仅是让这个工作一次，而是如何创建尽可能低的维护系统。请注意，这不是 CONDA 或 Travis 的入门指南，下面的说明假设您对这两个系统都有初步的了解。如果没有，这里有一些有用的链接，分别为[特拉维斯](https://docs.travis-ci.com/user/languages/python/)和[康达](https://docs.conda.io/projects/conda/en/latest/user-guide/getting-started.html)提供帮助。我们将讨论的内容是:

*   如何安装康达
*   如何用 CONDA 方法安装 Python 包
*   如何将包上传到 CONDA

第一步是用我们计划用来测试我们的包的 Python 版本安装 Miniconda。如果您只熟悉 Anaconda，那么 Miniconda 是相同的软件包管理系统，只是没有默认的预安装软件包。这将减少我们的构建时间。下面的设置是样板文件，除了 Python 版本矩阵之外，无需修改就可以在存储库之间共享

安装 Miniconda

现在我们已经安装了 Miniconda，我们准备创建一个虚拟环境，其中包含执行测试所必需的包。蛮力方法看起来像这样，我在各种仓库中看到很多。

不可维护！

现在，这是可行的，但是我发现两个主要的缺陷在开发周期中很快暴露出来:

1.  我们现在已经在我们的仓库中创建了**第二个**位置，在那里我们需要管理我们的依赖项。如果我们需要改变环境，我们需要记住改变 CONDA 配方和 Travis 测试套件中的列表
2.  更糟糕的是，我们没有使用康达配方进行测试。我们甚至不会注意到我们没有指定正确的包，直到我们尝试并使用我们希望在这里部署的 CONDA 包，这意味着我们可能会部署一个无法工作的 CONDA 包。

这里的解决方案是在我们的 CONDA 配方中指定的环境中构建和测试。我喜欢将我的菜谱放在与我的代码相同的存储库中，但是如果这不适合您的应用程序，那么总是可以克隆或者子模块菜谱，以确保它在 Travis 上可用。这里我们假设我们有一个名为`pkg_name`的包，它的 CONDA recipe 位于顶层文件夹`conda-recipe`(我知道真正的创意)。这个解决方案看起来像这样:

诀窍是我们首先使用这个方法构建我们的包，然后直接从文件系统安装它，就好像它是托管在其他地方的通道一样。这尽可能地复制了用户从我们的存储库中安装软件包时会收到的代码。您可能会注意到我们在创建环境时使用的额外的`dev-requirements.txt`文件。这是只需要运行测试套件的包所在的地方，我们不想给我们的用户增加额外的依赖，但我们确实希望向其他开发人员明确他们在运行测试套件时需要的环境。

如果从`pip`安装软件包切换，您可能会注意到这种方法需要更长的时间来完成。总的来说，CONDA 似乎比`pip`慢一点，在我们测试之前构建我们的包的额外步骤增加了开销。然而，如果我们要建立和运输我们的包到我们的 CONDA 渠道，无论如何这一步必须是复杂的，这只是有点讨厌，它增加了我们看到测试是否失败之前的时间。我认为，知道您正在部署的 CONDA 配方已经过全面审查，这种安慰是值得多花一两分钟的，这是使用其他人的硬件来完成所有这些工作的好处的一部分。

测试套件的实际调用对于您的存储库来说可能是唯一的。最简单的执行可能看起来像这样，如果你`pytest`。

我个人喜欢使用 verbose 选项运行我的`pytest`套件，但是您应该根据自己的个人喜好来选择输出的结构。

现在，我们已经执行了测试，并对我们创建的代码充满信心，我们准备将我们的包上传到我们的 CONDA 通道。幸运的是，由于我们已经构建了测试它的包，这一步应该很短。不过，我们确实要小心一些“陷阱”。首先，如果我们在一个特定的分支上，我们可能只想上传。我们还必须小心，如果有人分叉这个存储库，他们的 Travis 构建不会上传文件。下面我举了一个例子来说明这可能是什么样子:

一些有用的环境变量包括:

*   `TRAVIS_PULL_REQUEST`:(对/错)基于 Travis 构建是否由 pull 请求触发。
*   `TRAVIS_REPO_SLUG`:触发 Travis 构建的组织和存储库名称
*   `TRAVIS_BRANCH`:触发 Travis 构建的分支的名称
*   `TRAVIS_TAG`:如果 Travis 构建是由标签触发的，那么可以在这个变量中找到它。否则就是空的。

您可能注意到我们在 Travis 文件中使用了一个环境变量`$CONDA_UPLOAD_TOKEN`。这是我们在 Anaconda 站点上生成的一个密钥，它允许上传新的包。请记住，这个令牌允许任何人将包上传到您的存储库中。像对待密码一样小心对待它。要生成令牌，请执行以下操作:

1.  登录[https://anaconda.org](https://anaconda.org)并导航至您希望上传软件包的组织。
2.  点击右上角的用户名，导航至*设置- >访问。*此时您很可能会被要求重新认证。
3.  使用该表单创建新令牌。给它一个描述性的名称，至少要有读写权限。

![](img/ae0d520e0628134fbd2c1194f6e6bfa9.png)

您的令牌需要读写权限

4.创建后，令牌将在下表中可见。查看它并将其复制到您的剪贴板中。

现在，关于如何在 Travis 上添加环境变量作为令牌，您有几个[选项](https://docs.travis-ci.com/user/environment-variables/#defining-encrypted-variables-in-travisyml)。最简单的方法是导航到 Travis 网站上的存储库，并在右上角找到“更多选项”菜单。从那里，进入“Settings”选项卡，使用提示添加您的令牌，其名称与我们在上面的`travis.yml`文件中编写的环境变量相匹配。确保该值未设置为在您的生成的日志输出中显示。

![](img/21df22411db535963a85a824649f715d.png)

Travis 中的环境变量条目

将对 Travis 文件的更改提交到存储库应该会自动触发构建。通过查看 Anaconda 页面上的构建列表，或者从命令行使用`conda search`,您可以在构建结束时检查包是否被正确上传。请注意，如果您担心添加到 Conda 设置中的另一个频道有重复的软件包，您可以随时添加`--override-channels`选项。整个文件可以在[这里](https://gist.github.com/teddyrendahl/617bb8cab711c78a588d66b4b6b72623)找到。

现在你知道了！希望这是有帮助的。我在任何地方都找不到完整的指南，所以我想我应该写下我的过程。如果您有任何反馈，请随时参与进来。