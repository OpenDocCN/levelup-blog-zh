# 使用 dbt 从多回购架构迁移到单回购架构的经验教训

> 原文：<https://levelup.gitconnected.com/lessons-learned-while-moving-from-a-multi-to-a-mono-repo-architecture-with-dbt-95e2982bd49c>

![](img/aec3e334bad5d4b27801358ce9d76fcb.png)

这显然是 Joel Filipe 在 T2 Unsplash T3 上解释什么是“单块”架构的方式。

几个月前，我加入了目前的组织，担任数据主管。我的首要任务是建立一个强大可靠的数据平台。数据团队中的公分母是 SQL，而不是 Python。因此，选择 dbt 来帮助我们完成这项任务是显而易见的。

数据团队(4 人)是最近才成立的，没有人对 dbt 有太多的经验。那时，来自 dbt 实验室的关于如何构建 dbt 项目的著名的[帖子](https://docs.getdbt.com/guides/best-practices/how-we-structure/1-guide-overview)还没有发布。作为一名数据科学背景的人，我觉得围绕独立的回购组织我们的 dbt 项目是很自然的。

仅仅过了 8 个月，我们就获得了多达 33 次回购。我们开始遇到维护清晰的数据谱系和最新文档的严重问题。简而言之，我们无法恰当地利用 dbt 最重要的特性。

因此，我决定进行一次大的飞跃，在积累太多技术债务之前，围绕单个回购协议彻底重组我们的 dbt 代码。

我会在这篇文章中讲述我们的旅程。虽然我认为这种迁移 100%值得，但本文并不讨论每种方法的优缺点。相反，它解释了如何最好地从多回购 dbt 架构转移到单回购 dbt 架构。这篇文章的重点是项目管理方面，但也注入了技术技巧。它的目标是领导这一计划的数据工作者。

> 本文讨论的是如何最好地从多回购 dbt 架构迁移到单回购 dbt 架构，而不是权衡每种方法的利弊。

# 📆在日程中安排时间

迁移许多回购很可能需要团队成员之间的积极协作。事实上，回购往往相互依赖，而他们的所有权往往分散在整个团队。换句话说，在进行迁移时，人们需要相互交流。我不认为你能通过把它分成星期五下午的票来处理这样一个任务。

为您的团队提供受保护的时间对于该计划的成功至关重要。你在驾驶席上，你的工作是让你的利益相关者明白他们的请求会被暂时搁置。

一般来说，做两件事更容易获得管理团队的认可:

*   列出迁移的业务优势(例如:对 PII 数据的更好治理，因为单一回购架构将使跟踪数据谱系变得更加容易)
*   提出一组您想要达到的明确目标，而不仅仅是一个模糊的提议(例如:在第 2 天，与核心数据模型相关的所有回购都被迁移，在第 4 天，与业务应用程序相关的所有回购都被迁移)

在我们的案例中，我们有整整一周的时间专注于迁移。你需要的时间当然取决于你的团队的规模和你的业务流程的复杂性。

# 👩‍💻提前做好准备

你希望你的团队在第一天就全速前进。这需要你方做相当多的准备。

在搬迁的前一周，准备一个追踪器，列出所有需要迁移的回购。区分列表的优先次序，这很重要。您可能有一些构建核心数据模型的 dbt 项目，这些项目可能必须在与业务仪表板或分析相关联的项目之前移动。最后，将每个回购分配给一名团队成员，以便您的同事确切知道从哪里开始。

> 你应该为搬家制定明确的指导方针。

您还应该为搬迁制定明确的指导方针，这些指导方针必须至少包括:

*   单一回购结构的详细视图(即什么去哪里)。米罗思维导图是一个方便的工具来起草文件夹的结构。
*   关于如何迁移现有回购协议的说明
*   团队惯例的列表(模型名称、文件夹名称等)

指南所需的详细程度取决于团队的成熟度。但是经验告诉我，更规范一点通常更好。初级团队成员会找到他们需要的指导，而高级团队成员会跳过细节。

我强烈建议在搬迁前两三天组织一次启动会议。利用这次会议来调查团队是否对推荐的指导方针感到满意，并收集反馈。如果团队没有完全一致，最好在这个阶段进行辩论，而不是进行长时间的讨论，这可能会在迁移的第一天延迟实施。

# 在开始迁移之前，🧪酸测试您的指导方针

你现在有了一套漂亮的指导方针，整个团队似乎都很满意。从理论上来说，这一切都很好，但是如果你想在移动过程中按预期运行，你最好测试一下你的指令。

我将用对我有效的方法来说明上面的观点。迁移开始前的那个星期五，我创建了与我们新的独立 dbt repo 相关联的远程。迁移我们的一个高优先级 dbt 项目允许我检查:

*   提议的文件夹结构确实是相关的
*   在保留 git 历史记录的同时，可以很容易地引入现有的文件夹(稍后将详细介绍)
*   CI 渠道正常工作(我还会回到这一点)

# ⚔️明智地选择你的战斗

在这种类型的练习中，很容易偏离你的主要焦点。这是一个常见的陷阱。

你和你的团队基本上要重组所有的 dbt 模型。您可能会看到一些蹩脚的代码片段经过。不要陷入重构一切的陷阱。否则，您将面临无法实现关键目标的严重风险，即拥有一个正在运行的单一回购 dbt 项目。

相反，建立一个无论如何都必须重构的 3-4 点的简短列表。其余的必须保持不变。

在我们的案例中，必须勾选以下项目:

*   所有模型都有记录。
*   所有型号都经过测试。测试应至少检查相应表的主键
*   只有暂存文件夹中的模型可以链接到`{{ sources() }}`，所有剩余的模型只能依赖于`{{ ref() }}`。

最后一点实际上是需要大部分重构的地方。通过设计，多回购架构所需的许多资源现在可以转化为参考。你最喜欢的想法的搜索功能肯定会有所帮助。请注意，您也可以使用`grep -rnw models/ -e "{{ sources(<source-to-move-to-ref>) }}"`命令直接在终端中搜索文件夹树

# ⏳迁移仓库，同时保留 git 历史记录

有两种方法可以把旧的回购文件带到你的单声道回购。

*   选项 1:强力复制粘贴文件到它们的新位置。也许这不是最好的主意，因为您将丢失 git 历史记录。
*   选项 2:合并回购协议，同时保留 git 历史记录。

选项 2 只需要几个额外的步骤，但是要安全得多。下面的食谱对我们很有效

```
## checkout to a new branch on the mono repo
git checkout -b <migrate-old-repo>## add the <old-repo> remote to the mono repo
git remote add <old-repo> git@github.com:<old-repo>.git## get the <old-repo> files
git fetch <old-repo>## merge the old and mono repo branches
git merge remotes/<old-repo>/main --allow-unrelated-histories## ... you will then move the new files to the desired location and 
## open a pull request
```

这样做时，合并冲突将不可避免地出现。你可能会在一些常见的文件上有冲突，比如`dbt_project.profile`、`README.md`、`gitignore`，当然还有`_sources.yml`。

保持冷静，解决冲突。

起初，手动修复每个冲突可能是好的。在迁移了一些回购之后，您可能只想保留文件的 mono 回购版本。这可以用一个简单的`git checkout --ours <my-file>`来完成。

# 🩺有严格的审查程序

迁移许多 repos 都与协作和协调有关。因此，你需要一个首要任务是协调团队成员努力的人。

这个人(可能是团队领导或者准备迁移的人)应该主要关注于确保贡献符合指导方针。只有这个特定的人有批准的权限来确保合并的 PRs 的一致性是一个好主意。

如果你是这样的人，在回顾一份简历时，问自己以下几个问题:

*   团队惯例(即命名惯例、文件夹结构等)是否得到尊重？
*   关键[要求](#0d09)是否得到满足？

你还需要扮演一点飞行控制员的角色。因为你的团队非常活跃，公关会像蘑菇一样冒出来。当一些 PRs 被合并时，其他合并冲突将出现在剩余的 PRs 上。为了避免陷入长期合并冲突的无限循环，您的工作是协调合并，并为 Bob 的合并开绿灯，同时让 Alice 和 Joe 等待一分钟。

# 🍻Slim CI 管道是您的朋友

因为你是一个谨慎的人，你要确保公关没有破坏下游的任何模型。dbt 提供了这个漂亮的 webhook，它可以在打开 PR 时触发 CI 管道。由于您的 mono repo 的规模将会增长，为每个 PR 执行完整构建可能不是最好的主意，这将花费太长时间。

相反，你应该利用所谓的[瘦 CI](https://docs.getdbt.com/docs/deploy/cloud-ci-job#configuring-a-dbt-cloud-ci-job) 功能。它允许您仅运行已修改的模型及其下游从属模型。唯一的缺点是，你需要一个最初的成功运行被用作延期(即运行用于进行比较)。请注意，您可以使用以前的 CI 作业作为延期。然而，这个选项对我们来说并不那么有效。当并行打开太多 PRs 时，dbt 不知道使用哪个临时数据集作为参考。作为替代，我建议尽快执行 mono-repo 的生产运行(如果您想确保不破坏生产数据中的某些内容，可能只需更改目标数据库)，并以此作为参考。

# 总结想法

在开始迁移之前，对于单一回购方法的好处仍有一些疑问。合并冲突会不会变得有些频繁以至于每次公关都变成噩梦？我们要永远等着 CI 管道完工吗？
搬家几周后，我必须说这些问题并没有变成具体的问题。单一回购的好处显然是值得投资的，dbt 有充分的理由强烈支持这一方法。
话虽如此，但在数据世界里，往往没有放之四海而皆准的东西。对我的团队(只有 4 个人，大部分使用中等大小的桌子，但是来自很多不同的来源)来说效果很好的东西对你来说可能并不理想。在开始这种迁移之前，最好先进行尽职调查。