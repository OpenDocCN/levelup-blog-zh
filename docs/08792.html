<html>
<head>
<title>Operators : Extending Kubernetes Capabilities</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">运营商:扩展Kubernetes功能</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/operators-extending-kubernetes-capabilities-184df001b7e?source=collection_archive---------3-----------------------#2021-06-06">https://levelup.gitconnected.com/operators-extending-kubernetes-capabilities-184df001b7e?source=collection_archive---------3-----------------------#2021-06-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ea640e9b9e9ecc2e0c8629748a78b8e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jkue986Wp6eBpAcbaADtow.png"/></div></div></figure><p id="4fe8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">操作员是Kubernetes的软件扩展，它利用<a class="ae kw" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank">定制资源</a>来管理应用程序及其组件。这意味着，有些应用的部署和管理可能需要手动干预，而运营商是实现自动化的解决方案。</p><p id="2a97" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">假设您需要部署一个数据库集群，每个pod在部署后都需要同步，或者每当部署一个新组件时都需要执行安全扫描，或者可能需要根据某个事件填充某些配置。这种功能在Kubernetes中不是现成的，但是可以使用操作符来实现。</p><p id="d8b7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们经历一次创建操作符的旅程，每一步我们都将详细了解它是如何工作的</p><h2 id="ce9c" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">第一步:为控制器想一个主意</h2><p id="ff0a" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">很明显，对吧？<br/>因此，我们将在这里创建一个自定义资源，该资源将指定一个位置，我们的操作员将读取该事件并调用<a class="ae kw" href="https://openweathermap.org/api" rel="noopener ugc nofollow" target="_blank"> OpenWeather </a> API来获取该位置的天气详情，并将其填充到配置图中。</p><h2 id="6b42" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">步骤2:创建自定义资源定义</h2><p id="a937" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">首先创建一个自定义资源定义，我们将在其中定义自定义资源的配置。因此，基本上对于我们的用例，我们将定义我们的自定义资源可以在其spec部分保存一个位置变量。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lv"><img src="../Images/64b3f94ef96efe92b073de6a8558f4a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rKVAWJrE98BiQ9Y5gAo0Xg.png"/></div></div></figure><div class="ma mb gp gr mc md"><a href="https://github.com/RajputVaibhav/openweather_operator/blob/master/crd.yaml" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ir gy z fp mi fr fs mj fu fw ip bi translated">RajputVaibhav/open weather _ operator</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">使用Open Weather API填充数据的Kubernetes运算符-RajputVaibhav/Open Weather _ operator</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="mn l mo mp mq mm mr jw md"/></div></div></a></div><p id="28cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，您可以注意到，我们已经创建了一个自定义API组，我们将使用它来创建自定义资源。</p><p id="1271" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用<code class="fe ms mt mu mv b">kubectl apply -f crd.yaml</code>命令部署这个文件。</p><h2 id="1528" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">步骤3:创建主操作符逻辑</h2><p id="2389" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">您可以通过<a class="ae kw" href="https://github.com/kubernetes-client" rel="noopener ugc nofollow" target="_blank">从这里选择一个客户端</a>来创建多种语言的kubernetes操作符。我将在这里使用python</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/b7071297d2a516b75e009cb1f7a4704f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HHPYeq2zgZzjN0QWdotSSg.png"/></div></div></figure><div class="ma mb gp gr mc md"><a href="https://github.com/RajputVaibhav/openweather_operator/blob/master/python-operator/operator_logic.py" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ir gy z fp mi fr fs mj fu fw ip bi translated">RajputVaibhav/open weather _ operator</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">使用Open Weather API填充数据的Kubernetes运算符-RajputVaibhav/Open Weather _ operator</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="mx l mo mp mq mm mr jw md"/></div></div></a></div><p id="c8be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们来分解这个代码… <br/>我们需要一个代码，它可以像kubernetes控制循环一样工作，通过不断观察、检查差异并采取行动将实际状态带到所需状态。您当然可以自己实现它，但是对于python，您可以直接使用<a class="ae kw" href="https://kopf.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> kopf </a>库，它抽象了所有这些逻辑，使您可以轻松地专注于您的需求。</p><p id="3aa2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们将它打包到一个简单的docker文件中</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/cbc1bccddd1356620e94ecf3bc05cb24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*snM4qcbBxw-FLaBNPvZ4bg.png"/></div></div></figure><div class="ma mb gp gr mc md"><a href="https://github.com/RajputVaibhav/openweather_operator/blob/master/python-operator/Dockerfile" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ir gy z fp mi fr fs mj fu fw ip bi translated">RajputVaibhav/open weather _ operator</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">使用Open Weather API填充数据的Kubernetes运算符-RajputVaibhav/Open Weather _ operator</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="my l mo mp mq mm mr jw md"/></div></div></a></div><h2 id="cd70" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">步骤4:部署操作员</h2><p id="3015" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">我们将以通过部署创建的pod的形式部署操作员。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/6829f547f9e2ca0fdb1bf9cadb206a48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gnj-KGktfJjeXbAmydct9Q.png"/></div></div></figure><div class="ma mb gp gr mc md"><a href="https://github.com/RajputVaibhav/openweather_operator/blob/master/deployment.yaml" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ir gy z fp mi fr fs mj fu fw ip bi translated">RajputVaibhav/open weather _ operator</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">使用Open Weather API填充数据的Kubernetes运算符-RajputVaibhav/Open Weather _ operator</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="mz l mo mp mq mm mr jw md"/></div></div></a></div><p id="cc3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在使用<code class="fe ms mt mu mv b">kubectl apply -f deployment.yaml</code>部署它</p><h2 id="f4d0" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">步骤5:向操作员提供许可</h2><p id="5ea0" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">为了确保安全性，您需要明确地为操作员提供所需的权限。为此，我们将创建一个集群角色</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/d6d7a2894777c13d586f1c64a07bf57c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jj8HFx21uSWpdLtDPApOrQ.png"/></div></div></figure><div class="ma mb gp gr mc md"><a href="https://github.com/RajputVaibhav/openweather_operator/blob/master/rbac.yaml" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ir gy z fp mi fr fs mj fu fw ip bi translated">RajputVaibhav/open weather _ operator</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">使用Open Weather API填充数据的Kubernetes运算符-RajputVaibhav/Open Weather _ operator</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="na l mo mp mq mm mr jw md"/></div></div></a></div><p id="d119" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并使用<code class="fe ms mt mu mv b">kubectl apply -f rbac.yaml</code>部署它</p><h2 id="441f" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">步骤6:创建自定义资源</h2><p id="6667" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">现在我们的定义已经准备好了，我们将使用location的一个允许值来创建一个定制资源</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/e354b2c10badb4b5575f590adb216005.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XdLy12QDjimGlyPm3W9huw.png"/></div></div></figure><div class="ma mb gp gr mc md"><a href="https://github.com/RajputVaibhav/openweather_operator/blob/master/weather_report.yaml" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ir gy z fp mi fr fs mj fu fw ip bi translated">RajputVaibhav/open weather _ operator</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">使用Open Weather API填充数据的Kubernetes运算符-RajputVaibhav/Open Weather _ operator</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="nb l mo mp mq mm mr jw md"/></div></div></a></div><p id="fb58" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦使用<code class="fe ms mt mu mv b">kubectl apply -f weather_report.yaml</code>命令进行了部署，您就可以使用这个命令<code class="fe ms mt mu mv b">kubectl api-resources --api-group=operators.rajputvaibhav.github.io</code>查看定制资源</p><p id="9860" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建完成后，你应该很快就能看到德里天气详细信息的配置图。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/f73092d375cc3b72a9a5b879ca71ffdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ts4aCYhRHlobSm1xsSSFLA.png"/></div></div></figure><h2 id="fb62" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">离别赠言</h2><p id="5160" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">这里我们看到了如何基于kubernetes集群中的事件触发一组命令。同样，您可以为运营商找到各种应用程序来扩展您的集群的功能。</p><p id="8f0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你还可以在<a class="ae kw" href="https://operatorhub.io" rel="noopener ugc nofollow" target="_blank"> operatorhub.io </a>找到一长串由kubernetes社区创建的现有运营商。此外，您可以创建自己的运营商，并将其列在那里，为社区做出贡献。</p></div></div>    
</body>
</html>