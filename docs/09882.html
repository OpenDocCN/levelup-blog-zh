<html>
<head>
<title>Deploy AWS Amplify Python Lambda from MacOS with Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker从MacOS部署AWS Amplify Python Lambda</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploy-aws-amplify-python-lambda-from-macos-with-docker-68212e889a38?source=collection_archive---------1-----------------------#2021-09-27">https://levelup.gitconnected.com/deploy-aws-amplify-python-lambda-from-macos-with-docker-68212e889a38?source=collection_archive---------1-----------------------#2021-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/b9fd6988f20ea8f05b5cac6a36e6e0a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kmjkfDNuJ3UubEZH_IC_CA.png"/></div></div></figure><div class=""/><h1 id="b68d" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="627d" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">本文介绍了如何使用Docker从MacOS(或任何非Linux平台)构建和部署AWS Python Lambda。</p><h1 id="4a54" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">概观</h1><p id="bf20" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">AWS Amplify是一款帮助开发者方便地设置和管理AWS资源的工具。AWS Amplify提供了一个交互式cli调用<code class="fe lu lv lw lx b">amplify-cli</code>来创建后端资源和前端网页。所有创建的资源都有CloudFormation配置文件，这使得开发团队可以轻松地将其迁移到自有的包或管道中。<a class="ae ly" href="https://docs.amplify.aws/" rel="noopener ugc nofollow" target="_blank">【阅读更多】</a></p><p id="baf7" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">回到本文的主题，在我最近使用Amplify Python Lambda期间，如果我从MacOS部署Lambda，我会发现以下错误:</p><pre class="me mf mg mh gt mi lx mj mk aw ml bi"><span id="9862" class="mm jz jb lx b gy mn mo l mp mq">{<br/>  "errorMessage": "Unable to import module 'index': No module named 'regex._regex'",<br/>  "errorType": "Runtime.ImportModuleError",<br/>  "stackTrace": []<br/>}</span></pre><p id="1eb7" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">问题的原因是我添加了对<code class="fe lu lv lw lx b">Pipfile</code> : <a class="ae ly" href="https://github.com/zijing07/aws-lambda-python-deploy/blob/master/amplify/backend/function/amplifypylambda7935db62/Pipfile#L10" rel="noopener ugc nofollow" target="_blank">【代码链接】</a>的依赖</p><pre class="me mf mg mh gt mi lx mj mk aw ml bi"><span id="72ac" class="mm jz jb lx b gy mn mo l mp mq">[packages]<br/>nltk = "~=3.4"</span></pre><p id="0dcb" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">从Mac部署时，<code class="fe lu lv lw lx b">pipenv</code>自动获取MacOS平台的二进制文件。同时，AWS Lambda运行在Linux平台上，因此需要依赖于Linux。</p><h1 id="4776" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">解决问题</h1><p id="918c" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">为了解决这个问题，我们必须让<code class="fe lu lv lw lx b">pipenv</code>检索Linux依赖项，然后进行部署。有两种方法可以达到目标:</p><p id="7364" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">用VirtualBox安装Linux系统，并从那里部署代码</p><ul class=""><li id="6f4c" class="mr ms jb ky b kz lz ld ma lh mt ll mu lp mv lt mw mx my mz bi translated">优点:简单明了</li><li id="b9c1" class="mr ms jb ky b kz na ld nb lh nc ll nd lp ne lt mw mx my mz bi translated">缺点:效率低，不支持CI/CD</li></ul><p id="095f" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">使用docker创建虚拟环境，并在docker中部署</p><ul class=""><li id="1d5a" class="mr ms jb ky b kz lz ld ma lh mt ll mu lp mv lt mw mx my mz bi translated">优点:快速，可脚本化</li><li id="422e" class="mr ms jb ky b kz na ld nb lh nc ll nd lp ne lt mw mx my mz bi translated">缺点:与<code class="fe lu lv lw lx b">amplify-cli</code>不兼容</li></ul><p id="c2a0" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">我选择了Docker解决方案。虽然它不能与<code class="fe lu lv lw lx b">amplify-cli</code>一起工作，但是解决方案很快，并且每一步都在代码中，这使得它具有可扩展性。</p><p id="4713" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">为了完成构建和部署工作流，我们需要执行以下步骤:</p><ol class=""><li id="cba4" class="mr ms jb ky b kz lz ld ma lh mt ll mu lp mv lt nf mx my mz bi translated">设置Linux环境<br/>这个步骤可以通过正确配置的done文件来完成。</li><li id="3969" class="mr ms jb ky b kz na ld nb lh nc ll nd lp ne lt nf mx my mz bi translated">下载docker容器中的依赖关系<br/>我们需要在docker容器中运行<code class="fe lu lv lw lx b">pipenv install</code>。</li><li id="f7bb" class="mr ms jb ky b kz na ld nb lh nc ll nd lp ne lt nf mx my mz bi translated">压缩AWS Lambda并使用<code class="fe lu lv lw lx b">aws lambda update-function-code</code>将其部署到AWS <br/>可以完成这一步。</li></ol><h1 id="53c8" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">设置Linux环境</h1><p id="8e15" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">为了强制<code class="fe lu lv lw lx b">pipenv</code>下载Linux依赖项，我选择了下面的Docker映像，它与AWS Lambda CI/CD使用的是同一个映像:</p><blockquote class="ng nh ni"><p id="d38e" class="kw kx nj ky b kz lz lb lc ld ma lf lg nk mb lj lk nl mc ln lo nm md lr ls lt ij bi translated"><em class="jb">lambci/lambda:build-python 3.8</em></p></blockquote><p id="5441" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">这种图像的好处是:</p><ol class=""><li id="6c13" class="mr ms jb ky b kz lz ld ma lh mt ll mu lp mv lt nf mx my mz bi translated">该映像提供了一个Linux环境</li><li id="4d84" class="mr ms jb ky b kz na ld nb lh nc ll nd lp ne lt nf mx my mz bi translated">该图像包含<code class="fe lu lv lw lx b">aws</code>命令，稍后会用到</li></ol><p id="dbef" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated"><code class="fe lu lv lw lx b">Dockerfile</code>是这样的:<a class="ae ly" href="https://github.com/zijing07/aws-lambda-python-deploy/blob/master/amplify/backend/function/amplifypylambda7935db62/Dockerfile" rel="noopener ugc nofollow" target="_blank">【代码链接】</a></p><pre class="me mf mg mh gt mi lx mj mk aw ml bi"><span id="c6d8" class="mm jz jb lx b gy mn mo l mp mq">FROM lambci/lambda:build-python3.8</span><span id="8b21" class="mm jz jb lx b gy nn mo l mp mq">ENV AWS_DEFAULT_REGION us-west-2<br/>ENV AWS_ACCESS_KEY_ID [YOUR_AWS_ACCESS_KEY_ID]<br/>ENV AWS_SECRET_ACCESS_KEY [YOUR_AWS_SECRET_ACCESS_KEY]</span><span id="4a98" class="mm jz jb lx b gy nn mo l mp mq"># copy the code base into Docker container<br/>COPY . . </span><span id="8d7d" class="mm jz jb lx b gy nn mo l mp mq"># this script will be shown below<br/>CMD ./dockerCmd.sh</span></pre><h1 id="fdf0" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">准备构建和部署脚本</h1><p id="ec01" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">如上所述，我们需要在Docker容器中执行以下步骤:</p><blockquote class="ng nh ni"><p id="99a8" class="kw kx nj ky b kz lz lb lc ld ma lf lg nk mb lj lk nl mc ln lo nm md lr ls lt ij bi translated">构建→压缩→部署</p></blockquote><p id="8a1d" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">下面是一个将在Docker容器中执行的<code class="fe lu lv lw lx b">dockerCmd.sh</code>的便捷脚本:<a class="ae ly" href="https://github.com/zijing07/aws-lambda-python-deploy/blob/master/amplify/backend/function/amplifypylambda7935db62/dockerCmd.sh" rel="noopener ugc nofollow" target="_blank">【代码链接】</a></p><pre class="me mf mg mh gt mi lx mj mk aw ml bi"><span id="dbd5" class="mm jz jb lx b gy mn mo l mp mq">#!/bin/bash</span><span id="a0ca" class="mm jz jb lx b gy nn mo l mp mq"># 1. build, fetch the dependencies<br/>pipenv install</span><span id="1746" class="mm jz jb lx b gy nn mo l mp mq"># 2. zip, prepare the AWS Lambda to upload<br/>cd `pipenv --venv`/lib/python3.8/site-packages/<br/>zip -r /var/task/my-deployment-package.zip .<br/>cd -<br/>zip -r -g my-deployment-package.zip src/</span><span id="6230" class="mm jz jb lx b gy nn mo l mp mq"># 3. deploy, using `aws` command to update the remote AWS Lambda<br/>aws lambda update-function-code --function-name amplifypylambda7935db62-dev --zip-file fileb://my-deployment-package.zip</span></pre><h1 id="6599" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">部署和测试</h1><p id="1d07" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">作为最后一步，让我们点亮Docker容器并测试它。</p><p id="7c59" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">启动Docker容器并构建和部署:</p><pre class="me mf mg mh gt mi lx mj mk aw ml bi"><span id="442a" class="mm jz jb lx b gy mn mo l mp mq">docker build -t tmp-awslambda . &amp;&amp; docker run --rm tmp-awslambda</span></pre><p id="7a51" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">测试调用lambda: <a class="ae ly" href="https://github.com/zijing07/aws-lambda-python-deploy/blob/master/amplify/backend/function/amplifypylambda7935db62/src/index.py" rel="noopener ugc nofollow" target="_blank">【代码链接】</a></p><pre class="me mf mg mh gt mi lx mj mk aw ml bi"><span id="5ed3" class="mm jz jb lx b gy mn mo l mp mq">{<br/>  "statusCode": 200,<br/>  "body": "[\\"The\\", \\"Docker\\", \\"solution\\", \\"works\\", \\"!\\"]"<br/>}</span></pre><h1 id="45b5" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="5265" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">通常，一旦代码被推送到repos中，部署就由CI/CD负责。但是有时开发人员需要在测试阶段进行临时部署，因此本文中的解决方案会有所帮助。</p><p id="5af5" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">使用Docker很方便，欢迎在下面的评论中分享你的想法！</p><p id="9c52" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated"><a class="ae ly" href="https://github.com/zijing07/aws-lambda-python-deploy" rel="noopener ugc nofollow" target="_blank">【Github回购】</a></p><p id="fe7a" class="pw-post-body-paragraph kw kx jb ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated"><em class="nj">如果你觉得这篇文章有用，请关注这个账号，以便将来更新。感谢支持！</em></p></div></div>    
</body>
</html>