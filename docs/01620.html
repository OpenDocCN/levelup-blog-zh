<html>
<head>
<title>Push Notifications &amp; Your Business Logic: What Firebase doesn’t tell you</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">推送通知&amp;你的业务逻辑:Firebase没有告诉你什么</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-handle-push-notification-with-fcm-9973b086736b?source=collection_archive---------5-----------------------#2020-01-16">https://levelup.gitconnected.com/how-to-handle-push-notification-with-fcm-9973b086736b?source=collection_archive---------5-----------------------#2020-01-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="106b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">over app(<a class="ae ko" href="https://www.overapp.com" rel="noopener ugc nofollow" target="_blank">https://www.overapp.com</a>)的iOS开发者拉维尼娅·伯图齐</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/aed05d71c60177d7b5581a257b35e33f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WDC6A91l9j4hCww4YVnK5g.png"/></div></div></figure><h2 id="e7c7" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated"><strong class="ak">摘要</strong></h2><p id="9c8b" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">Firebase Cloud Messasing是Google推出的一款功能极其强大且易于使用的产品，用于发送消息和通知。它是一个巨大的集成工具生态系统的一部分，这个生态系统被称为Firebase。它提供了一个强大的控制台，一个与其他工具如<a class="ae ko" href="https://firebase.google.com/docs/ab-testing" rel="noopener ugc nofollow" target="_blank"> A/B测试</a>和<a class="ae ko" href="https://firebase.google.com/docs/predictions" rel="noopener ugc nofollow" target="_blank">预测</a>的现成集成。</p><p id="4738" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于共享同一设备并登录和注销该设备的用户的管理，以及对于同时想要接收自己的通知并决定通过它们接收什么类型的内容的用户，它不提供特定的功能。因此，开发人员必须考虑自己的解决方案。</p><h2 id="630c" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated"><strong class="ak">我们文章的重点</strong></h2><p id="6922" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">我们将与各种平台上的Firebase设置相关的所有细节留给网上的众多教程。相反，我们想讨论我们开发的使用FCM的产品所采用的解决方案。这迫使我们特别要处理一些问题:处理多个用户，他们可以使用同一个设备，或者在不同的设备上有不同的设置，他们可以接收不同类型的通知。</p><p id="f135" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Firebase没有提供处理这种场景的特定特性，阅读一些关于我们采用的解决方案的内容可能会对您有所帮助。</p><p id="2923" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的产品使用定制的后端服务器，实现注册、激活、登录用户、返回任何内容的所有逻辑。</p><p id="831a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，还有一个计划工具，可以循环验证必须通知的用户，并确定哪些类型的内容将与推送通知一起发送。然后它与FCM接口进行交付。</p><h2 id="b3e4" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated"><strong class="ak">数据库</strong></h2><p id="5b0f" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">我们在数据库上创建了一些表:</p><ul class=""><li id="6832" class="lz ma it js b jt ju jx jy kb mb kf mc kj md kn me mf mg mh bi translated">包含用户个人信息的表格，如姓名、电话、地址等。</li><li id="8570" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn me mf mg mh bi translated">包含用户会话信息的表，其中存储了每个用户登录时生成的不记名令牌。</li><li id="e074" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn me mf mg mh bi translated">包含安装信息的表格。</li></ul><h2 id="ed50" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated"><strong class="ak">代币和装置</strong></h2><p id="0051" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">当用户安装并执行应用程序时，Firebase会返回一个令牌。</p><p id="1826" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该应用程序将其存储在应用程序沙箱中(在iOS上使用UserDefaults或在Android上使用SharedPreferences ),以便在需要时和未来登录时使用。当用户第一次登录时，应用程序调用一个登录API，该API接收:</p><ul class=""><li id="c6ec" class="lz ma it js b jt ju jx jy kb mb kf mc kj md kn me mf mg mh bi translated">用户的凭据；</li><li id="b908" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn me mf mg mh bi translated">名为InstallationID的空参数；</li><li id="3be7" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn me mf mg mh bi translated">关于设备和操作系统版本的信息；</li></ul><p id="81bc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个API执行所有检查来验证凭证，如果它们有效，它就创建一个会话并将一个不记名令牌保存到相应的表中。</p><p id="5dfa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，因为我们传递了一个空的安装ID，所以它会生成一个GUID，并将其与不记名令牌ID一起存储在Installations表中。</p><p id="bcee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个新的安装ID以与Firebase令牌相同的方式表示应用程序在设备上的当前安装。</p><p id="8bc5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">登录API返回一个响应，其中包含有关用户会话和新安装Id的信息，并存储这些值(供用户进一步登录时使用)。</p><p id="ef2f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了完成登录过程，我们需要执行Assign API，将用户(不记名令牌)、firebase令牌和安装ID配对。</p><p id="8ed2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此时，我们的后端可以轻松识别用户和正在使用的设备，并最终要求FCM发送通知。</p><p id="f85b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果用户注销，应用程序调用Logout API，该API在Sessions表中搜索用户会话id，将其标记为过期，然后在installations表中搜索相同的值，将其设置为null。</p><p id="c43e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">负责请求FCM发送通知的计划工具只考虑在安装表中有记录的用户，该记录与安装id、firebase令牌和用户会话Id成对出现。</p><p id="18dd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果不同的用户使用自己的凭据登录应用程序，installationID和firebase令牌仍然保持不变。在登录调用验证了用户的凭证之后，会生成另一个承载令牌来标识具有活动会话的用户。</p><p id="4381" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这样，如果一个用户注销，另一个用户尝试登录(或者如果多个用户登录到您的应用程序)，我们就知道哪个用户有活动会话。</p><h2 id="736a" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated"><strong class="ak"> Firebase令牌到期</strong></h2><p id="c4c9" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">尽管在非常有限的情况下，firebase令牌可能会过期。有关必要的详细信息，请参考官方文档。</p><p id="bbce" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果Firebase令牌发生更改，则无法识别用户登录的设备。</p><p id="ccb1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，后端不再能够向FCM提供正确有效的令牌来标识用户的设备以向其发送通知</p><p id="726e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">幸运的是，FCM SDK设计得很好，它会自动管理新刷新令牌的接收，每次它发生变化时，我们都会将其存储为新令牌，并通过调用Assign API与后端进行通信。</p><h2 id="0a6a" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated"><strong class="ak">推送通知瞄准</strong></h2><p id="c177" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">在我们产品的需求中，也有用户选择通过通知接收的内容类型的可能性。例如，他必须能够接收提醒，并禁止发送不同类型的信息。顺便说一下，FCM没有提供任何特性。</p><p id="5123" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这种情况下，我们采用了一种非常简单的解决方案。我们在数据库中添加了一个表，所有用户的首选项都以键/值对的形式存储在这个表中。</p><p id="995e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里有一个例子:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/2664f50e90e3ac699544ec9b8b91aab8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*tGmYXjcBEWG4mFW1yoFvmw.png"/></div></figure><p id="3628" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过这种方式，我们有可能以非常简单的方式访问单一设置，并且很容易添加将来可能变得必要的新设置。然后，我们将单个设置不仅链接到用户id，还链接到安装id。</p><p id="ed3c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过这样做，在两个不同设备(例如智能手机和平板电脑)上共享帐户的用户可以选择在一个设备上接收某种类型的消息，而在另一个设备上不接收。</p><h2 id="f80e" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated"><strong class="ak">结论</strong></h2><p id="64f2" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">Firebase Cloud Messaging是向运行您的网站或移动应用程序的用户发送消息的绝佳工具。</p><p id="3610" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它没有提供处理目标通知或本文开头部分描述的其他主题的功能。如上所述，开发人员必须编写自己的解决方案。</p><p id="7c65" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们希望这些概念可能对你有用！😄</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><p id="ba5e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">over app(【https://www.overapp.com】)的iOS开发者拉维尼娅·伯图齐(Lavinia Bertuzzi)。感谢<a class="ae ko" href="https://medium.com/@davide.fin" rel="noopener">大卫·芬</a></p></div></div>    
</body>
</html>