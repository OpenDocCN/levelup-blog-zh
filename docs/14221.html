<html>
<head>
<title>How to add JWT Authentication to NextJS Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将JWT认证添加到NextJS应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-add-jwt-authentication-to-nextjs-apps-a0dc83bd257d?source=collection_archive---------1-----------------------#2022-11-09">https://levelup.gitconnected.com/how-to-add-jwt-authentication-to-nextjs-apps-a0dc83bd257d?source=collection_archive---------1-----------------------#2022-11-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ee4b2ffe08b144e7ed5753fc4f9ed9ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9hp_E39rDZkzASyb.jpeg"/></div></div></figure><h1 id="f597" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">介绍</h1><p id="32b7" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">本文是一篇关于如何使用NextJS实现身份验证的简单教程，在进入本指南之前，我将演示本指南中将要使用的技术:</p><ul class=""><li id="a51b" class="lu lv iq ky b kz lw ld lx lh ly ll lz lp ma lt mb mc md me bi translated">JWT或JSON Web Token是一种行业标准<a class="ae mf" href="https://tools.ietf.org/html/rfc7519" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> RFC 7519 </strong> </a>方法，用于安全地表示双方之间的声明。</li><li id="e610" class="lu lv iq ky b kz mg ld mh lh mi ll mj lp mk lt mb mc md me bi translated">NextJS中间件:中间件允许您在请求完成之前运行代码，然后基于传入的请求，您可以通过重写、重定向、修改请求或响应头或直接响应来修改响应。这将帮助我们处理带身份验证的路由</li><li id="0d98" class="lu lv iq ky b kz mg ld mh lh mi ll mj lp mk lt mb mc md me bi translated">JWT认证服务:你需要一个支持JWT认证的后端服务，你可以查看我的教程<a class="ae mf" href="https://blog.bitsrc.io/jwt-authentication-with-nestjs-4f587c5dd649" rel="noopener ugc nofollow" target="_blank">如何用NestJS </a>创建一个，或者你可以用任何技术自己创建一个</li></ul><h1 id="1af2" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">布局</h1><p id="a53a" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们首先需要一个用户界面，看看这个简单的布局:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/d8304d2580c242d7e5c8804ece6c1a97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-a5045aogLqsYYMm_0-Nag.png"/></div></div></figure><p id="ad11" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">你只要看一下布局就能告诉我路线。有3种类型的路线:</p><ul class=""><li id="668f" class="lu lv iq ky b kz lw ld lx lh ly ll lz lp ma lt mb mc md me bi translated">公共路线:任何人都可以进入的路线</li><li id="0cfa" class="lu lv iq ky b kz mg ld mh lh mi ll mj lp mk lt mb mc md me bi translated">授权路由:只有未经授权的用户才能访问的路由</li><li id="c724" class="lu lv iq ky b kz mg ld mh lh mi ll mj lp mk lt mb mc md me bi translated">受保护的路由:只有经过身份验证的用户才能访问的路由</li></ul><h1 id="34de" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">授权服务</h1><p id="bd06" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们需要调用API登录对吗？所以我们需要一个服务来处理认证API调用。在这个例子中，我将使用<code class="fe mt mu mv mw b">axios</code>来处理API调用</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/502c9c03003c1854dce13d56540503e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BKzUzUzQZEya2jP3X02ehg.png"/></div></div></figure><p id="ae09" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">您可以看到，如果<code class="fe mt mu mv mw b">login</code>请求成功，我们将拥有<code class="fe mt mu mv mw b">username</code>、<code class="fe mt mu mv mw b">accessToken</code>或JWT，以及到期时间。</p><h1 id="e253" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">认证挂钩</h1><p id="aee1" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们需要3个简单的挂钩:</p><ul class=""><li id="f744" class="lu lv iq ky b kz lw ld lx lh ly ll lz lp ma lt mb mc md me bi translated"><code class="fe mt mu mv mw b">useCurrentUser</code>:获取当前登录用户信息的钩子</li><li id="4193" class="lu lv iq ky b kz mg ld mh lh mi ll mj lp mk lt mb mc md me bi translated"><code class="fe mt mu mv mw b">useLogin</code>:提供<code class="fe mt mu mv mw b">login</code>方法的钩子</li><li id="fb88" class="lu lv iq ky b kz mg ld mh lh mi ll mj lp mk lt mb mc md me bi translated"><code class="fe mt mu mv mw b">useLogout</code>:提供<code class="fe mt mu mv mw b">logout</code>方法的钩子</li></ul><p id="9929" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">我先进入第一个<code class="fe mt mu mv mw b">useLogin</code>:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/8090d5c3745d11e7f9633017d1c5e43b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QNw0JcF17nuLJx9Bpa8E6Q.png"/></div></div></figure><p id="2153" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">你可以看到我用cookie登录后保存了用户信息，为什么是cookie？我稍后会解释</p><p id="8c99" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated"><code class="fe mt mu mv mw b">useLogout</code>:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/0721ed2e5a3472cdabc118b52b16e98d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G-ykPixGlpZat7wLFGI8_Q.png"/></div></div></figure><p id="84e9" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">要注销，我们只需要清除cookie</p><p id="b5cc" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated"><code class="fe mt mu mv mw b">useCurrentUser</code></p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/be52098d2218a4816b9ca93f21c5a6b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YMlluW7I-dqdVFChN_og1g.png"/></div></div></figure><h1 id="f377" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">中间件</h1><p id="38d3" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">使用React only，很难检查每个路由上的身份验证。但是有了NextJS中间件，这变得非常容易。</p><p id="e80e" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">首先，让我们来看看路线:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/6ca0a8923455bc5d7cd2afb5e6e82fb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aJG3vU7NGGYUdXHmigUkmQ.png"/></div></div></figure><p id="d642" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">由于这只是一个简单的指南，所以我会选择这些路线。</p><p id="c212" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">重要的部分是中间件。在NextJS中，中间件允许您在请求完成之前运行代码，然后基于传入的请求，您可以通过重写、重定向、修改请求或响应头或直接响应来修改响应。</p><p id="2b47" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">这意味着中间件将为您的项目中的<strong class="ky ir">每条路线调用。</strong></p><p id="881c" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">让我们看看<code class="fe mt mu mv mw b">middleware.ts</code>文件:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/c11b554f9fa1558e7b66ad5a027e04aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ZrKGD2gdO924ts3t7MFoQ.png"/></div></div></figure><p id="5435" class="pw-post-body-paragraph kw kx iq ky b kz lw lb lc ld lx lf lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">解释:</p><ul class=""><li id="9452" class="lu lv iq ky b kz lw ld lx lh ly ll lz lp ma lt mb mc md me bi translated">首先，从cookies中获取当前用户</li><li id="f55b" class="lu lv iq ky b kz mg ld mh lh mi ll mj lp mk lt mb mc md me bi translated">检查下一个路由是否受保护，然后检查用户是否未经身份验证或令牌是否过期。从cookies中删除用户，并重定向至<code class="fe mt mu mv mw b">/login</code></li><li id="91b7" class="lu lv iq ky b kz mg ld mh lh mi ll mj lp mk lt mb mc md me bi translated">检查下一个路由是否是授权路由，但用户已登录，将用户重定向到<code class="fe mt mu mv mw b">/profile</code></li></ul><h1 id="8d1d" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="a023" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这是在NextJS中处理认证的简单实现。我希望这篇文章对你有用，如果示例代码晦涩难懂，请点击这里查看源代码</p><h1 id="775c" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">遗言</h1><p id="1836" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">虽然我的内容对每个人都是免费的，但是如果你觉得这篇文章有帮助，<a class="ae mf" href="https://www.buymeacoffee.com/kylele19" rel="noopener ugc nofollow" target="_blank">你可以在这里给我买杯咖啡</a></p></div></div>    
</body>
</html>