<html>
<head>
<title>Introducing pandagg: pandas-inspired library for ElasticSearch aggregations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">pandagg简介:熊猫启发的弹性搜索聚合库</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/introducing-pandagg-pandas-inspired-library-for-elasticsearch-aggregations-6647df33ce63?source=collection_archive---------24-----------------------#2020-06-29">https://levelup.gitconnected.com/introducing-pandagg-pandas-inspired-library-for-elasticsearch-aggregations-6647df33ce63?source=collection_archive---------24-----------------------#2020-06-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/178c036a6a6bac987ccdae142e7a460c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q95lSnMPtimi6c-1LgeeFQ.jpeg"/></div></div></figure><p id="78bd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在本文中，我将向您展示如何使用<strong class="kd iu"> pandagg </strong>库有效地探索索引并计算ElasticSearch中索引数据的深度嵌套聚合。</p><p id="043e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在解释了编写这个库的动机之后(如果赶时间的话，<em class="kz">转至“</em>让我们开始吧<em class="kz">”一节</em>，我们将处理IMDB数据集并计算聚合，以回答需要越来越复杂的查询的问题。</p><p id="f243" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它假设你有弹性搜索概念的基本知识。</p><blockquote class="la lb lc"><p id="b77f" class="kb kc kz kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">这里涉及的所有概念在<a class="ae lg" href="https://pandagg.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">库文档</a>中有更详细的解释。github库在这里可用<a class="ae lg" href="https://github.com/alkemics/pandagg" rel="noopener ugc nofollow" target="_blank">。</a></p></blockquote></div><div class="ab cl lh li hx lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="im in io ip iq"><h1 id="c8cc" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">动机</h1><p id="a610" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">ElasticSearch提供了一个强大的API来计算索引数据的聚合指标:聚合。其中一个致命的特性是能够嵌套聚合子句，桶聚合中提供了参数<code class="fe mr ms mt mu b">aggs</code>。</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="38b9" class="nd lp it mu b gy ne nf l ng nh">{<br/>    "per_genre": {<br/>        "terms": {"field": "genres","size": 3},<br/>        "aggs": {<br/>            "rating_average": {"avg": {"field": "rank"}},<br/>            "nb_roles_average": {"avg": {"field": "nb_roles"}<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="0c80" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">但是如果您已经尝试过计算嵌套很深的查询，那么您可能很难解析查询的输出。</p></div><div class="ab cl lh li hx lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="im in io ip iq"><h2 id="a625" class="nd lp it bd lq ni nj dn lu nk nl dp ly km nm nn mc kq no np mg ku nq nr mk ns bi translated">聚合异构结果格式</h2><p id="07c0" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">一个原因是聚合具有不同的结果格式。例如，让我们比较一下筛选器和术语聚合:</p><p id="1324" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此<code class="fe mr ms mt mu b">filters</code>聚合:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="6842" class="nd lp it mu b gy ne nf l ng nh">{"decade": {"filters": {"filters": {<br/>  "1990-2000": {"range": {"year": {"lte": 2000,"gte": 1990}}},<br/>  "1980-1990": {"range": {"year": {"lte": 1990,"gte": 1980}}}}}<br/>  }}</span></pre><p id="67e1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">…以映射“键”-&gt;“桶”的方式提供桶:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="6639" class="nd lp it mu b gy ne nf l ng nh">{<br/>  "decade": {"buckets": {<br/>      "1980-1990": {"doc_count": 56623},<br/>      "1990-2000": {"doc_count": 91138}<br/>  }}<br/>}</span></pre><p id="8d55" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">而这个<code class="fe mr ms mt mu b">terms</code>聚合:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="1ac5" class="nd lp it mu b gy ne nf l ng nh">{"genres": {"terms": {"field": "genres", "size": 3}}}</span></pre><p id="ee6e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">…以字典数组的形式提供存储桶，每个存储桶都包含自己的关键字:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="40f1" class="nd lp it mu b gy ne nf l ng nh">{<br/>  "genres": {<br/>    "doc_count_error_upper_bound": 0,<br/>    "sum_other_doc_count": 184804,<br/>    "buckets": [<br/>      {"key": "Short", "doc_count": 81013},<br/>      {"key": "Drama", "doc_count": 72877},<br/>      {"key": "Comedy", "doc_count": 56425}<br/>    ]<br/>  }<br/>}</span></pre><p id="7d3b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了启用通用格式，<strong class="kd iu"> pandagg </strong>将为所有聚合响应使用一个公共接口:它将在内部考虑每个响应桶由以下各项组成:</p><ul class=""><li id="bdb4" class="nt nu it kd b ke kf ki kj km nv kq nw ku nx ky ny nz oa ob bi translated">a <code class="fe mr ms mt mu b">level</code>:聚合的名称</li><li id="1ac9" class="nt nu it kd b ke oc ki od km oe kq of ku og ky ny nz oa ob bi translated">一个<code class="fe mr ms mt mu b">key</code>:那个桶的钥匙</li><li id="bba9" class="nt nu it kd b ke oc ki od km oe kq of ku og ky ny nz oa ob bi translated">一个或多个<code class="fe mr ms mt mu b">values</code>:例如<code class="fe mr ms mt mu b">doc_count</code>用于大多数桶聚合，或者<code class="fe mr ms mt mu b">value</code>用于大多数度量聚合。这些值是返回感兴趣的值的json键。</li></ul><p id="81be" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以上面的例子为例，<code class="fe mr ms mt mu b">decades</code>过滤器聚合返回两个桶:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="6794" class="nd lp it mu b gy ne nf l ng nh">{"level": "decade", "key": "1980-1990", "value": 56623}<br/>{"level": "decade", "key": "1990-2000", "value": 91138}</span></pre><p id="0dad" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">…以及<code class="fe mr ms mt mu b">genres</code>字段三上的术语聚合:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="c730" class="nd lp it mu b gy ne nf l ng nh">{"level": "genres", "key": "Short", "value": 81013}<br/>{"level": "genres", "key": "Drama", "value": 72877}<br/>{"level": "genres", "key": "Comedy", "value": 56425}</span></pre><h2 id="4e2e" class="nd lp it bd lq ni nj dn lu nk nl dp ly km nm nn mc kq no np mg ku nq nr mk ns bi translated">树形与表格形状</h2><p id="6d67" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">另一个原因是，许多用例需要表格格式的数据，而ElasticSearch aggregations响应具有树形结构。</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="ab1c" class="nd lp it mu b gy ne nf l ng nh">{<br/>    "per_genre": {<br/>        "terms": {"field": "genres","size": 3},<br/>        "aggs": {<br/>            "rating_average": {"avg": {"field": "rank"}},<br/>            "nb_roles_average": {"avg": {"field": "nb_roles"}<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="6fab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">会导致:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="de63" class="nd lp it mu b gy ne nf l ng nh">{<br/>  "per_genre": {<br/>    "doc_count_error_upper_bound": 0,<br/>    "sum_other_doc_count": 241229,<br/>    "buckets": [<br/>      {<br/>        "key": "Short",<br/>        "doc_count": 81013,<br/>        "rating_average": {<br/>          "value": 6.39<br/>        },<br/>        "nb_roles_average": {<br/>          "value": 2.63<br/>        }<br/>      },<br/>      {<br/>        "key": "Drama",<br/>        "doc_count": 72877,<br/>        "rating_average": {<br/>          "value": 6.13<br/>        },<br/>        "nb_roles_average": {<br/>          "value": 14.93<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="5689" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这可以表示为:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="7301" class="nd lp it mu b gy ne nf l ng nh">_<br/>├── <strong class="mu iu">per_genre</strong>=Drama                                    72877<br/>│   ├── nb_roles_average                               14.93<br/>│   └── rating_average                                  6.13<br/>└── <strong class="mu iu">per_genre</strong>=Short                                    81013<br/>    ├── nb_roles_average                                2.63<br/>    └── rating_average                                  6.39</span></pre><p id="0076" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">而表格格式在许多情况下更合适。它可以表示为:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="aa4e" class="nd lp it mu b gy ne nf l ng nh"><strong class="mu iu">              doc_count  nb_roles_average  rating_average</strong><br/><strong class="mu iu">per_genre</strong>                                             <br/>Short          81013              2.63            6.39<br/>Drama          72877             14.93            6.13</span></pre><p id="c1b7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这样做需要确定一个级别，在以下两者之间划一条线:</p><ul class=""><li id="c019" class="nt nu it kd b ke kf ki kj km nv kq nw ku nx ky ny nz oa ob bi translated">分组级别:那些将被用来识别行的级别(这里是<code class="fe mr ms mt mu b">genres</code>，但是正如我们将在后面看到的，可以使用多个级别)</li><li id="1ed6" class="nt nu it kd b ke oc ki od km oe kq of ku og ky ny nz oa ob bi translated">列级别:将用于填充列和单元格的级别(这里是<code class="fe mr ms mt mu b">nb_roles_average</code>和<code class="fe mr ms mt mu b">rating_average</code>)</li></ul><p id="1b03" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">表格格式特别适合具有<code class="fe mr ms mt mu b">T</code>形状的聚合，例如:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="b429" class="nd lp it mu b gy ne nf l ng nh">group_level_1 -&gt; group_level_2 -&gt; column_level_A<br/>                              ├─&gt; column_level_B<br/>                              └─&gt; column_level_C</span></pre><p id="ecd7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">…可以分为:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="85f9" class="nd lp it mu b gy ne nf l ng nh"><strong class="mu iu">                      lvl_A         lvl_B        lvl_C</strong><br/><strong class="mu iu">lvl_1</strong>    <strong class="mu iu">lvl_2</strong>                                             <br/>key_1    key_11        xxx           xxx          xxx<br/>key_2    key_21        xxx           xxx          xxx<br/>key_2    key_22        xxx           xxx          xxx</span></pre></div><div class="ab cl lh li hx lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="im in io ip iq"><p id="b1d7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，编写<strong class="kd iu"> pandagg </strong>的最初目标是消除解析聚合响应的障碍，并能够轻松地将其转换为合适的格式。这就是本文将要展示的内容。</p><p id="3bbe" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它提供了其他有用的功能，这些功能将在后面介绍。</p><h1 id="765b" class="lo lp it bd lq lr oh lt lu lv oi lx ly lz oj mb mc md ok mf mg mh ol mj mk ml bi translated">我们走吧</h1><p id="cf92" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">在本文的其余部分，我们将处理从IMDB中提取的样本数据，这些数据在我用Elastic Cloud设置的AWS托管集群中进行索引，以便您在本教程中使用它们，这些数据可以在<a class="ae lg" href="https://beba020ee88d49488d8f30c163472151.eu-west-2.aws.cloud.es.io:9243/" rel="noopener ugc nofollow" target="_blank"> <strong class="kd iu">这个地址</strong> </a>获得，用户<code class="fe mr ms mt mu b">pandagg</code>，密码<code class="fe mr ms mt mu b">pandagg</code>具有读取权限。</p><p id="1bc5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于这个演示，我鼓励您在<code class="fe mr ms mt mu b">ipython</code>中启动脚本进行交互使用，并安装<code class="fe mr ms mt mu b">pandagg</code>和<code class="fe mr ms mt mu b">pandas</code> (pandas是一个软依赖)。在您的虚拟环境中:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="1b53" class="nd lp it mu b gy ne nf l ng nh">pip install ipython pandagg pandas</span></pre><p id="ad43" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这一部分中，我们将了解如何:构建和执行聚合，将它们的响应解析为表格格式(在本例中，解析为pandas <a class="ae lg" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html" rel="noopener ugc nofollow" target="_blank"> dataframes </a>以获得更好的可读性)和交互式树。</p></div><div class="ab cl lh li hx lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="im in io ip iq"><p id="bc6a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们来看看最具代表性的电影类型有哪些:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="9125" class="nd lp it mu b gy ne nf l ng nh">from pandagg.search import Search<br/>from elasticsearch import Elasticsearch</span><span id="bdab" class="nd lp it mu b gy om nf l ng nh">client = Elasticsearch(hosts=['<a class="ae lg" href="https://beba020ee88d49488d8f30c163472151.eu-west-2.aws.cloud.es.io:9243/'" rel="noopener ugc nofollow" target="_blank">https://beba020ee88d49488d8f30c163472151.eu-west-2.aws.cloud.es.io:9243/'</a>], http_auth=('pandagg', 'pandagg'))</span><span id="fcb8" class="nd lp it mu b gy om nf l ng nh">r = Search(index='movies', using=client)\<br/>    .aggs("genres_counts", "terms", field="genres", size=4)\<br/>    .size(0)\<br/>    .execute()</span><span id="c077" class="nd lp it mu b gy om nf l ng nh">r<br/>&gt;&gt;&gt; &lt;Response&gt; took 1ms, success: True, total result &gt;=10000, contains 10 hits</span></pre><blockquote class="la lb lc"><p id="2aa5" class="kb kc kz kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">注意事项:</p><p id="0410" class="kb kc kz kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">-如果不需要点击，请将大小设置为0。</p><p id="8da7" class="kb kc kz kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">-这是声明该搜索查询的一种方式，所有可用的语法在pandagg <a class="ae lg" href="https://pandagg.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">文档</a>中有详细说明</p><p id="dd1b" class="kb kc kz kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">-我们在这里使用了官方elasticsearch-dsl python库中使用的语法，提供了(agg_name，agg_type，**body)参数。姑且称之为“平面语法”。</p></blockquote><p id="aaeb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">Response</code>对象持有<code class="fe mr ms mt mu b">hits</code>和<code class="fe mr ms mt mu b">aggregation</code>属性。</p><p id="34b0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">聚合对象提供了几种方法来解析几种树或表格格式的响应，这些格式不需要<code class="fe mr ms mt mu b">pandas</code>依赖项(<code class="fe mr ms mt mu b">to_tabular</code>、<code class="fe mr ms mt mu b">to_interactive_tree</code>等)。这里我们将重点关注具有更好显示的<code class="fe mr ms mt mu b">to_dataframe</code>方法，因此在博客文章中看起来更好。</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="beaf" class="nd lp it mu b gy ne nf l ng nh">r.aggregations.to_dataframe()</span></pre><p id="b7f2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这导致:</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi on"><img src="../Images/daa63e931a4cfe02b0220b847d3167e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:724/format:webp/1*1B9h_6LXe5ZUoE-4pDNbhw.png"/></div></figure><p id="103b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们每十年打破它，并计算其他指标:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="2610" class="nd lp it mu b gy ne nf l ng nh">r = Search(index='movies', using=client)\<br/>    .groupby('decade', 'histogram', interval=10, field='year')\<br/>    .groupby('genres', size=3)\<br/>    .aggs({<br/>        "avg_rank": {"avg": {"field": "rank"}},<br/>        "avg_nb_roles": {"max": {"field": "nb_roles"}}<br/>    })\<br/>    .filter('range', year={"gte": 1990})\<br/>    .execute()</span></pre><blockquote class="la lb lc"><p id="370b" class="kb kc kz kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">我们在这里使用平面语法进行分组操作，并使用本地“dict”语法来声明aggs部分</p></blockquote><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="4e20" class="nd lp it mu b gy ne nf l ng nh">r.aggregations.to_dataframe()</span></pre><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oo"><img src="../Images/daecb2b0079804638ef4589adfc1c6a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GiZvv_gw0IAKvjB0Mm7vvg.png"/></div></div></figure><p id="68ab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，如果适合您来获得完全相同的结果，您实际上可以直接使用常规的dict语法:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="28b6" class="nd lp it mu b gy ne nf l ng nh">r = Search(using=client, index="movies")\<br/>  .aggs({<br/>    "decade": {<br/>      "histogram": {"field": "year", "interval": 10},<br/>      "aggs": {<br/>        "genres": {"terms": {"field": "genres", "size": 3},<br/>        "aggs":{<br/>          "avg_nb_roles": {"max": {"field":"nb_roles"}},<br/>          "avg_rank": {"avg": {"field": "rank"}}}<br/>        }<br/>      }<br/>    }<br/>  })\<br/>  .execute()</span></pre><h2 id="766b" class="nd lp it bd lq ni nj dn lu nk nl dp ly km nm nn mc kq no np mg ku nq nr mk ns bi translated">在聚合响应中导航</h2><p id="dcb4" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">在其他聚合序列化方法中，我们来看看<code class="fe mr ms mt mu b">to_interactive_tree</code>:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="1f93" class="nd lp it mu b gy ne nf l ng nh">interactive_agg = r.aggregations.to_interactive_tree()<br/>interactive_agg</span><span id="fc6e" class="nd lp it mu b gy om nf l ng nh">&gt;&gt;&gt;<br/>&lt;IResponse&gt;<br/>root<br/>├── decade=1990                                        79495<br/>│   ├── genres=Documentary                              8393<br/>│   │   ├── avg_nb_roles                               217.0<br/>│   │   └── avg_rank                       6.517093241977517<br/>│   ├── genres=Drama                                   12232<br/>│   │   ├── avg_nb_roles                               340.0<br/>│   │   └── avg_rank                       5.981429367965072<br/>│   └── genres=Short                                   12197<br/>│       ├── avg_nb_roles                                82.0<br/>│       └── avg_rank                       6.311325829450123<br/>└── decade=2000                                        57649<br/>    ├── genres=Documentary                              8639<br/>    │   ├── avg_nb_roles                               178.0<br/>    │   └── avg_rank                       6.980897812811443<br/>    ├── genres=Drama                                   11500<br/>    │   ├── avg_nb_roles                               227.0<br/>    │   └── avg_rank                       6.269675415719865<br/>    └── genres=Short                                   13451<br/>        ├── avg_nb_roles                               118.0<br/>        └── avg_rank                        6.83625304327684</span></pre><p id="53f1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以使用自动完成功能在其中导航:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="0c0c" class="nd lp it mu b gy ne nf l ng nh">interactive_agg.decade_1990.genres_Drama</span><span id="dc67" class="nd lp it mu b gy om nf l ng nh">&gt;&gt;&gt;<br/>&lt;IResponse subpart: decade_1990.genres_Drama&gt;<br/>genres=Drama                                           12232<br/>├── avg_nb_roles                                       340.0<br/>└── avg_rank                               5.981429367965072</span></pre><p id="15cf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">get_bucket_filter</code>给你查询过滤属于给定桶的文档:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="72a6" class="nd lp it mu b gy ne nf l ng nh">interactive_agg.decade_1990.genres_Drama.get_bucket_filter()</span><span id="4d95" class="nd lp it mu b gy om nf l ng nh">&gt;&gt;&gt;<br/>{<br/>    "bool": {<br/>        "must": [<br/>            {"range": {"year": {"gte": 1990.0, "lt": 2000.0}}},<br/>            {"term": {"genres": {"value": "Drama"}}}<br/>        ],<br/>        "filter": [{"range": {"year": {"gte": 1990}}}]<br/>    }<br/>}</span></pre><p id="9fd4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mr ms mt mu b">list_documents</code>方法实际执行查询，列出属于bucket的文档:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="3b56" class="nd lp it mu b gy ne nf l ng nh">interactive_agg.decade_1990.genres_Drama.list_documents(size=2, _source={"includes": ['name']})</span><span id="7c15" class="nd lp it mu b gy om nf l ng nh">&gt;&gt;&gt;<br/>{<br/>  "took": 13,<br/>  "timed_out": false,<br/>  "_shards": {"total": 1, "successful": 1, "skipped": 0, "failed": 0},<br/>  "hits": {<br/>    "total": {"value": 10000, "relation": "gte"},<br/>    "max_score": 2.4539857,<br/>    "hits": [<br/>      {<br/>        "_index": "movies", "_type": "_doc", <br/>        "_id": "706", "_score": 2.4539857, <br/>        "_source": {"name": "100 meter fri"}<br/>      },<br/>      {<br/>        "_index": "movies", "_type": "_doc", <br/>        "_id": "714", "_score": 2.4539857, <br/>        "_source": {"name": "100 Proof"}<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><h1 id="1856" class="lo lp it bd lq lr oh lt lu lv oi lx ly lz oj mb mc md ok mf mg mh ol mj mk ml bi translated">就这样？</h1><p id="7904" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">不，实际上在<strong class="kd iu"> pandagg </strong>中还有很多其他很酷的功能！这里是一个快速的概述，如果这个库引起了一些兴趣，我可能会进一步详述。</p><h2 id="5ff3" class="nd lp it bd lq ni nj dn lu nk nl dp ly km nm nn mc kq no np mg ku nq nr mk ns bi translated">发现模块</h2><p id="1990" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">发现模块允许快速浏览集群中的可用索引:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="e371" class="nd lp it mu b gy ne nf l ng nh">from elasticsearch import Elasticsearch<br/>from pandagg.discovery import discover</span><span id="8baf" class="nd lp it mu b gy om nf l ng nh">client = Elasticsearch(hosts=['<a class="ae lg" href="https://beba020ee88d49488d8f30c163472151.eu-west-2.aws.cloud.es.io:9243/'" rel="noopener ugc nofollow" target="_blank">https://beba020ee88d49488d8f30c163472151.eu-west-2.aws.cloud.es.io:9243/'</a>], http_auth=('pandagg', 'pandagg'))</span><span id="4f4a" class="nd lp it mu b gy om nf l ng nh">indices = discover(client, index="mov*")</span><span id="236b" class="nd lp it mu b gy om nf l ng nh"># indices provides autocomplete on contained indices<br/>indices<br/>&gt;&gt;&gt; &lt;Indices&gt; ['movies', 'movies_fake']</span><span id="dd47" class="nd lp it mu b gy om nf l ng nh">movies = indices.movies</span></pre><p id="6c80" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Indice对象包含相关的<code class="fe mr ms mt mu b">settings</code>、<code class="fe mr ms mt mu b">mappings</code>和<code class="fe mr ms mt mu b">settings</code>属性，以及用于构建查询的<code class="fe mr ms mt mu b">search</code>方法:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="ca9c" class="nd lp it mu b gy ne nf l ng nh">recent_movies = movies.search().filter("range", year={"gte": 1990}).execute()</span></pre><h2 id="19fd" class="nd lp it bd lq ni nj dn lu nk nl dp ly km nm nn mc kq no np mg ku nq nr mk ns bi translated">地图导航</h2><p id="1a71" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated"><code class="fe mr ms mt mu b">mapping</code>属性具有有趣的特性，它返回一个具有可导航自动完成功能的交互式树:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="0c6a" class="nd lp it mu b gy ne nf l ng nh">movies.mapping</span><span id="d402" class="nd lp it mu b gy om nf l ng nh">&gt;&gt;&gt;</span><span id="eb5a" class="nd lp it mu b gy om nf l ng nh">&lt;Mapping&gt;<br/>_<br/>├── directors                                     [Nested]<br/>│   ├── director_id                                Keyword<br/>│   ├── first_name                                 Text<br/>│   │   └── raw                                  ~ Keyword<br/>│   ├── full_name                                  Text<br/>│   │   └── raw                                  ~ Keyword<br/>│   ├── gender                                     Keyword<br/>│   ├── last_name                                  Text<br/>│   │   └── raw                                  ~ Keyword<br/>│   └── role                                       Keyword<br/>├── genres                                         Keyword<br/>├── movie_id                                       Keyword<br/>...</span></pre><p id="bdf6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">自动完成功能可用于无缝导航:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="a88d" class="nd lp it mu b gy ne nf l ng nh">movies.mapping.directors.first_name</span><span id="cfbe" class="nd lp it mu b gy om nf l ng nh">&gt;&gt;&gt;<br/>&lt;Mapping subpart: directors.first_name&gt;<br/>first_name                                        Text<br/>└── raw                                         ~ Keyword</span></pre><p id="b99d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">调用它将显示详细的字段体:</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="17ea" class="nd lp it mu b gy ne nf l ng nh">movies.mapping.directors.first_name()</span><span id="f797" class="nd lp it mu b gy om nf l ng nh">&gt;&gt;&gt;<br/>{<br/>  "fields": {<br/>    "raw": {<br/>      "type": "keyword"<br/>    }<br/>  },<br/>  "type": "text"<br/>}</span></pre><p id="efdf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">叶字段上的<code class="fe mr ms mt mu b">a</code>属性列出了可以在该字段类型上计算的所有聚合，并计算它(同样使用自动完成):</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="a86d" class="nd lp it mu b gy ne nf l ng nh">movies.mapping.nb_roles.a.extended_stats()</span></pre><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi op"><img src="../Images/df65da1e5103a3e606c7bc312abd3d40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WDfYxGyF8UhUekHvSyLO7g.png"/></div></div></figure><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="225f" class="nd lp it mu b gy ne nf l ng nh">movies.mapping.genres.a.terms()</span></pre><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/05be731efbaca307c8b75f5d75e1f30c.png" data-original-src="https://miro.medium.com/v2/resize:fit:534/format:webp/1*gSzJoOlQxeheOnS6XTslYA.png"/></div></figure><h2 id="3338" class="nd lp it bd lq ni nj dn lu nk nl dp ly km nm nn mc kq no np mg ku nq nr mk ns bi translated">其他功能包括:</h2><ul class=""><li id="6891" class="nt nu it kd b ke mm ki mn km or kq os ku ot ky ny nz oa ob bi translated"><strong class="kd iu">计算搜索操作的完整DSL</strong>(查询/聚合/post_filter等)，具有灵活的语法，能够在特定位置插入查询子句，指定要在哪个指定的查询子句下/上插入新子句</li><li id="d3f7" class="nt nu it kd b ke oc ki od km oe kq of ku og ky ny nz oa ob bi translated">选择加入自动嵌套功能，可在需要的地方自动将嵌套子句插入到聚合中</li></ul></div><div class="ab cl lh li hx lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="im in io ip iq"><h1 id="ad4e" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">接下来呢？</h1><p id="c63a" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">未来的工作重点是:</p><ul class=""><li id="db2d" class="nt nu it kd b ke kf ki kj km nv kq nw ku nx ky ny nz oa ob bi translated">文档:此处<a class="ae lg" href="https://pandagg.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">有</a>的文档，将根据更多的例子和反馈进行改进</li><li id="756f" class="nt nu it kd b ke oc ki od km oe kq of ku og ky ny nz oa ob bi translated">交付每个主要Elasticsearch版本≥ 5的版本(当前<strong class="kd iu"> pandagg </strong>版本仅与Elasticsearch ≥7.x.x兼容，不与以前的版本兼容)</li><li id="7f6e" class="nt nu it kd b ke oc ki od km oe kq of ku og ky ny nz oa ob bi translated">涵盖了大部分的弹性搜索操作。现在它主要关注于<strong class="kd iu">读</strong>操作，我想把它扩展到<strong class="kd iu">写</strong>操作</li></ul><p id="1c9b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">希望你觉得有用。欢迎并感谢每一个反馈、功能请求和对改进<strong class="kd iu"> pandagg </strong>的帮助！</p><p id="d5c3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi">👋 🚀</p></div></div>    
</body>
</html>