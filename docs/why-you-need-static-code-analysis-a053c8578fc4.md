# 为什么需要静态代码分析

> 原文：<https://levelup.gitconnected.com/why-you-need-static-code-analysis-a053c8578fc4>

编程变得越来越面向领域。有数百个框架和数十个库帮助克服低级细节的复杂性，以便专注于更重要甚至更复杂的事情。我说的是商业逻辑。今天，我将试图让你相信，静态代码分析不仅能让你的编码生活更加愉快，还能帮助企业建立更健壮的流程。

![](img/65406b1ccd506794c65e7c7c09d1670d.png)

苏·托马斯在 [Unsplash](https://unsplash.com/s/photos/bug-code?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上的照片

# 商业目标

让我们弄清楚一些事情。在一个软件系统中，商业最看重的是什么？是性能吗？现代技术？或者文档？实际上，商业关心两件事。

1.  软件获得的收入。
2.  可维护性。

第一个非常明显。任何公司的本质目标都是赚钱。软件应该直接或间接地帮助达到这个目标。比如让客户在网上订酒店房间，提前付款的系统，直接挣钱。而能自动构建神器并部署到生产阶段的软件则间接挣钱。因为它减少了工程师在常规任务上花费的时间，并帮助他们专注于那些可以带来更多好处的任务。

与第一点相比，第二点似乎不那么重要，但是不注意它可能会导致更糟糕的后果。

假设你是一家提供 [B2C](https://www.investopedia.com/terms/b/btoc.asp) 服务的公司的 CEO。我们假设它是一家网上书店。你雇佣软件工程师来保证开发的进行。他们实现新特性，修复错误，等等。但是随着员工的变化，时间也在流逝。新的开发者来了，老的离开了。一切都进行得比较顺利。直到有一天。

> “嗨，简。我们需要为我们的客户提供一个选择，以 weel 的形式购买电子书，”该系统分析师声称。
> 
> “实际上，我们在实现新功能时遇到了一些问题。约翰:你知道，代码库已经变得如此混乱，几乎不可能继续维护它。你问的那个可能需要几个月才能实现。”
> 
> “那么，你打算怎么做？”约翰怀疑地问道。
> 
> “我认为我们应该从头开始，从头开始重新构建系统。否则，我认为不可能继续进行开发”。

现在你的生意有很大的危险。客户既不会容忍未来的更新缺失，也不会容忍你需要重写软件来使过程继续的事实。他们会离开你，选择一个能满足他们需求的公司。

软件应用程序已经使用了很多年甚至几十年。作为管理者，你应该意识到维护水平差的后果。

顺便说一下，由于第二个系统效应，从头重写系统也不是一个好的选择。解决这些问题的正确方法是[重构](https://martinfowler.com/books/refactoring.html)，但那是另一篇文章的主题。

# 代码检查自动化

有一些关键点定义了系统的可维护性。这些是命名策略、设计架构、单元测试、代码风格等等。如果开发人员注意到这一点，代码会变得更清晰、更容易理解。毫无疑问。但是有一个警告。并不是所有这些东西都可以通过人工方式充分检查。

例如，假设我们希望所有的类都没有未使用的导入。相当合理的要求。我们如何检查它？好吧，最直接的方法是在代码评审期间完成。

你能在这个类中找出一个未使用的导入吗？没有 IDE，这不是一件容易的事情。

未使用导入的示例

答案在第 6 行— `java.util.function.Predicate`。而且这个班毕竟没那么大。你可以想象在真正的代码审查过程中会有多困难。

我们再假设一个例子。管理层决定我们需要增加系统的测试覆盖率。我们选择的解决方案是为新代码(为每个拉取请求)设置最小的需求覆盖率。同样，我们如何检查它？我们可以要求评审人员在本地运行所有的测试。但是，即使他们这样做了，他们如何将新代码与已经存在的代码区分开来呢？当结果需要如此多的资源时，不做任何事情更合理，这就是优势。

可能还有很多其他的案例。“所有注释都要用英文写”、“代码中不能有拼写错误”、“代码库要按照预定义的[代码编辑器文件](https://www.mediawiki.org/wiki/Extension:CodeEditor)格式化”等等。关键的一点是，我们需要某种自动化来集成这些检查。

# 争论

当我谈到静态代码分析器以及它们的使用有多重要时，我听到了许多关于为什么一个团队不能将它们集成到产品中的争论。

## 我们的代码库已经庞大到足以改变工作流程

这似乎是一个合理的说法，但只有在特殊情况下。如果你的项目没有测试，并且已经五年了，那么不可能(或者可能太贵了)立即将覆盖率提高到 80%。但是你不需要。从较低的小节开始，然后不断增加。可以是一开始的 5%一个季度变成 25%。

另一个例子可以应用于代码质量本身。大多数静态分析器都是可配置的。如果您试图将[checkstyle Google configuration](https://github.com/checkstyle/checkstyle/blob/master/src/main/resources/google_checks.xml)设置为成熟项目，您可能会得到数百甚至数千个错误。你可以从一个规则开始。Ar 乍一看，好像没那么重要。但是在配置到达存储库的那一刻之后，您可以确定将来没有其他人能够违反这条规则。

## 我们根据风格指南审查拉式请求。静态分析仪对我们来说是多余的

你还记得一个未使用导入的例子吗？如果你有二十个类似的规则呢？你怎么能确定评论者发现了所有这些小细节呢？反正你已经在 Wiki/Markdown/HTML 里声明了你的风格指南。为什么不把它转换成一个静态分析器能理解的格式？我知道不是所有的事情都可以自动化。但如果有可能，就应该去做。

## 静态分析器不能让我们快速实现特性

如果可维护性不是你的首要任务，那么我同意你的观点。但你应该意识到后果。就像我们之前看到的那样，它们可能是戏剧性的。

## 我们的团队由许多初级开发人员组成。静态分析器使它们太慢了

对于一个刚刚开始编程的人来说，代码静态分析器的需求可能是一个真正的挑战。但是当我们解决困难的任务时，我们会成长为专业人士。反正不增加体重怎么变强？

## 我们的项目只有资深人员。不需要静态分析仪

假设我想建一座摩天大楼。我雇佣了一群专业建筑工人。所以，他们不需要保护。因为我们都知道高技能的人不会犯任何错误，对吗？

我想你明白我的意思了。不管你有多专业。我们都会犯错。我们都需要保护。

> 不仅如此，我个人认为，你希望你的代码被检查的事实是真正专业人士的特征。

# 工具

市场为我们提供了大量的静态代码分析器。我列出了一些最受欢迎的。

## [SonarQube](https://www.sonarqube.org/)

那是我个人最喜欢的。它支持 27 种编程语言(在撰写本文时)。它已经为所有东西预定义了推荐的代码风格，并且可以很容易地与 Github/Bitbucket/Gitlab 集成。虽然要花钱，但你可以完全免费地为你的开源项目使用 [SonarCloud](https://sonarcloud.io/) 。

## [Checkstyle](https://checkstyle.sourceforge.io/)

最著名和最成熟的 Java 静态代码分析器之一。你所要做的就是为你的 Maven/Gradle 项目添加一个插件。没有 CI 集成。没有昂贵的订阅。和许多可用的配置。

## [PVS-studio](https://pvs-studio.com/en/pvs-studio/)

这是一个针对 C、C++、C#和 Java 的静态代码分析器。它既可以作为插件安装在您的 IDE 中，也可以作为现有 CI/CD 乐器(包括 SonarQube)的附件。虽然支持的语言种类不多，但该产品对代码的分析非常深入，可以发现隐藏得很好的错误和漏洞。

## [ESLint](https://eslint.org/)

Javascript/Typescript linter。它变得如此受欢迎，以至于它几乎成为了你的 React/Angular/Vue 项目中的一个标准。如果你在 NodeJS 上做前端或者后端，而且从来没有听说过 ESLint，你绝对应该试试。

# 结论

我认为静态代码分析器不是替代品，而是编写维护良好的代码的现有过程的重要补充。如果您有任何问题或建议，请在下面写下您的意见。感谢阅读！