# æˆ‘è®¨åŒå‘ç°ä¼Ÿå¤§çš„ï¼Œè¿‡æ—¶çš„ Docker å›¾åƒğŸ¤¬

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/i-hate-finding-great-outdated-docker-images-9eea8f76ed0d>

## ä¸åŒçš„ CI å¹³å°å¦‚ä½•è‡ªåŠ¨å’Œå®šæœŸåœ°æ„å»ºå’Œæ¨é€æ‚¨çš„å¼€æº Docker æ˜ åƒã€‚

![](img/deccb7f3440d9b08bd73fcf51c19f6dd.png)

å®‰å¾·çƒˆÂ·äº¨ç‰¹åœ¨ [Unsplash](https://unsplash.com/s/photos/angry?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) ä¸Šçš„ç…§ç‰‡

æœ€ç³Ÿç³•çš„äº‹æƒ…è«è¿‡äºåœ¨ç½‘ä¸Šæœç´¢é€‚åˆæ‚¨å½“å‰ä½¿ç”¨æƒ…å†µçš„ Docker å›¾ç‰‡ï¼Œå´åœ¨å‡ ä¸ªè¯¯å¯¼æ€§é“¾æ¥åå‘ç°æ‚¨æƒ³è¦ä½¿ç”¨çš„å›¾ç‰‡æ˜¯â€œæœ€åä¸€æ¬¡æ¨é€:3 å¹´å‰â€â€¦

# æœ€ä½³ç å¤´å·¥äººå½¢è±¡

åœ¨æœç´¢ç¬¦åˆè‡ªå·±éœ€æ±‚çš„å…¬å…± docker å›¾ç‰‡æ—¶ï¼Œä½ ä¼šå¯»æ‰¾ä»€ä¹ˆï¼Ÿæˆ‘çš„æ„æ€æ˜¯ï¼Œè¿™æ ·çš„å½¢è±¡åº”è¯¥æ»¡è¶³ä»€ä¹ˆè¦æ±‚ï¼Ÿ

æˆ‘å‡è®¾å½“ä½ æœ€åä¸€æ¬¡å¤åˆ¶å’Œç²˜è´´ docker å›¾ç‰‡åˆ°ä½ çš„ CI å¹³å°æˆ–èˆµå›¾æˆ–ä»»ä½•ä½ ä½¿ç”¨å®ƒçš„åœ°æ–¹æ—¶ï¼Œä½ ç¡®å®è€ƒè™‘è¿‡è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœæ²¡æœ‰ï¼Œç°åœ¨æˆ–è€…ä¸‹æ¬¡å†è€ƒè™‘å§ã€‚åŸå› å¾ˆç®€å•ï¼Œå°½ç®¡åœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œä½†æ‚¨å¯èƒ½æ­£åœ¨æ‰§è¡Œæ¥è‡ªå…¶ä»–äººçš„ä»£ç ï¼Œè¿™äº›äººå¯èƒ½æ€€æœ‰æ¶æ„ã€‚

## ä»€ä¹ˆæ˜¯ç›¸å…³çš„

æ‚¨æ˜¯å¦éœ€è¦è®¿é—®æºä»£ç (Dockerfile)æ¥éªŒè¯å’Œ/æˆ–è‡ªå·±æ„å»ºå®ƒï¼Ÿ

å¿…é¡»æ˜¯æœ€è¿‘å»ºçš„è¿˜æ˜¯è‡ªåŠ¨å»ºçš„ï¼Ÿä»¥ä¾¿å®ƒåŒ…å«æœ€æ–°ç‰ˆæœ¬çš„åº“å’Œå·¥å…·ï¼Ÿ

CI ç®¡é“è¿è¡Œ(å’Œç»“æœ)æ˜¯å¦ä¹Ÿå¿…é¡»å…¬å¼€ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥æ£€æŸ¥å’ŒéªŒè¯æ„å»ºè¿‡ç¨‹ï¼Ÿ

ä½ ä¼šæ£€æŸ¥å®ƒæ‰€ä¾èµ–çš„åŸºæœ¬æ˜ åƒå’Œå®ƒä½¿ç”¨çš„ç‰ˆæœ¬å—ï¼Ÿä»¥ä¾¿æ‚¨å¯ä»¥ç¡®ä¿å…¼å®¹æ€§ï¼Œå¹¶ä¸”å®ƒä½¿ç”¨æœ€æ–°çš„åŸºæœ¬ç³»ç»Ÿï¼Ÿ

å°ºå¯¸é‡è¦å—ï¼Ÿ

ä½ ä¸Šä¸€æ¬¡åœ¨å®¹å™¨ä¸­ä½¿ç”¨ç§˜å¯†æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Œä½ æ²¡æœ‰ 100%æ£€æŸ¥å…¶å›¾åƒæ˜¯å¦æœ‰æ¶æ„è½¯ä»¶ï¼Ÿ

## å¦‚ä½•å»ºç«‹ä½ çš„å…¬ä¼—å½¢è±¡

ä¸ºäº†å›ç­”ä½ å…³äºå¦‚ä½•è¯†åˆ«æ¯”å…¶ä»–äººæ›´å¯ä¿¡çš„å…¬å…±å›¾åƒçš„é—®é¢˜ï¼Œè®©æˆ‘å‘ä½ å±•ç¤ºè¿™ä¸ªè¿‡ç¨‹å¯èƒ½æ˜¯ä»€ä¹ˆæ ·å­çš„â€”â€”å¹¶æŒ‡å‡ºä¸€äº›å®é™…çš„ä¾‹å­ã€‚

# å»ºç«‹ä½ çš„å½¢è±¡

æ¯ä¸ª Docker å›¾åƒçš„åŸºç¡€æ˜¯ Docker æ–‡ä»¶ã€‚ä¸‹é¢æ˜¯æˆ‘åœ¨æ„å»ºå›¾åƒæ—¶å­¦åˆ°çš„ä¸€äº›ä¸œè¥¿â€”â€”åˆ°ç›®å‰ä¸ºæ­¢è¿˜ä¸å®Œæ•´ï¼Œæ‰€ä»¥ä½ å¿…é¡»è‡ªå·±çœ‹å¾—æ›´è¿œï¼Œé‚£é‡Œæœ‰å¾ˆå¤šå¥½çš„æ¥æºå’Œä¾‹å­ã€‚

## ä½¿ç”¨`ARG`æ¥æ”¯æŒç‰ˆæœ¬

ä½¿ç”¨`ARG`,æ‚¨å¯ä»¥å°†å˜é‡ä¼ é€’ç»™æ„å»ºè¿‡ç¨‹ã€‚è¿™å…è®¸æ‚¨åœ¨ docker æ–‡ä»¶ä¸­åšå„ç§æœ‰è¶£çš„äº‹æƒ…ï¼Œæ¯”å¦‚ä¼ é€’ç‰ˆæœ¬æˆ–æ¡ä»¶æ„å»ºæ­¥éª¤ã€‚

```
ARG VERSION=latest
FROM alpine:$VERSION AS base
# do some base work# each `FROM` resets ARGs, so define it before you use it
FROM base AS case-one
ARG CASE_VALUE=something
# run command(s) that use CASE_VALUEFROM base AS case-two
ARG CASE_VALUE=other
# run command(s) that use CASE_VALUEARG CASE=one
FROM case-$CASE
# continue build steps 
```

*   ç¡®ä¿åœ¨ä½¿ç”¨`FROM`åå®šä¹‰é»˜è®¤å€¼å¹¶é‡æ–°å®šä¹‰å‚æ•°ã€‚
*   è¿è¡Œ`docker build --build-arg CASE=two`æ¥åŸºäºä¸Šé¢ä¾‹å­ä¸­çš„`case-two`æ„å»ºä¸€ä¸ªæ˜ åƒã€‚

é“¾æ¥åˆ° Dockerfile `ARG`å‚è€ƒ:

[](https://docs.docker.com/engine/reference/builder/#arg) [## Dockerfile æ–‡ä»¶å‚è€ƒ

### æœ¬é¡µæè¿°äº†æ‚¨å¯ä»¥åœ¨ Dockerfile æ–‡ä»¶ä¸­ä½¿ç”¨çš„å‘½ä»¤ã€‚å½“æ‚¨é˜…è¯»å®Œæœ¬é¡µåï¼Œè¯·å‚é˜…â€¦

docs.docker.com](https://docs.docker.com/engine/reference/builder/#arg) 

## ä¸ºå¤šç§æ¶æ„æ„å»º

ä½ å¯èƒ½ä¸éœ€è¦ï¼Œä½†æ˜¯ä¸åŒæ¶æ„çš„ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯`arm64`ï¼Œæ­£åœ¨ä¸Šå‡ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„åŸºç¡€æ˜ åƒæ”¯æŒå®ƒï¼Œé‚£ä¹ˆæ‚¨åªéœ€è¦åœ¨æ„å»ºç®¡é“ä¸­å¢åŠ å‡ ä¸ªæ­¥éª¤å°±å¯ä»¥æ„å»ºå¤šä¸ªæ¶æ„äº†ï¼

æˆ‘å·²ç»åœ¨ä¸‹é¢çš„æ–‡ç« ä¸­æè¿°äº†å¦‚ä½•å»ºç«‹ä¸€ä¸ªå¤šæ‹±å›¾åƒï¼Œæ‰€ä»¥æˆ‘åœ¨è¿™é‡Œä¸å†èµ˜è¿°ã€‚å…³é”®æ˜¯:å½“ä½ å‘å¸ƒå¼€æºè½¯ä»¶æ—¶ï¼Œä½ çš„å—ä¼—æ˜¯å¹¿æ³›çš„ï¼Œæ‰€ä»¥ä¸è¦é—æ¼é‚£äº›æ­£åœ¨å°è¯•æ–°æ¶æ„çš„æå®¢ï¼Œæ¯”å¦‚åœ¨æ ‘è“ Pi ä¸Šè¿è¡Œã€Šæˆ‘çš„ä¸–ç•Œã€‹æœåŠ¡å™¨...

[](https://betterprogramming.pub/setting-up-a-multi-arch-docker-build-with-circleci-and-alpine-for-your-apple-m1-ba739ef1f754) [## ç”¨ CircleCI å’Œ Alpine(ä¸ºæ‚¨çš„ Apple M1)è®¾ç½®å¤šæ‹±é—¨ç å¤´æ„ä»¶

### ä¸ºå¤šä¸ªåŸºæœ¬æ˜ åƒç‰ˆæœ¬å’Œå¹³å°æ„å»º Docker æ˜ åƒçš„ç®€æ´è®¾ç½®

better ç¼–ç¨‹. pub](https://betterprogramming.pub/setting-up-a-multi-arch-docker-build-with-circleci-and-alpine-for-your-apple-m1-ba739ef1f754) 

# æ·»åŠ  CI å¹³å°

ç°åœ¨ï¼Œæ‚¨çš„ Dockerfile å·²ç»åœ¨æ‚¨çš„å…¬å…± Git å­˜å‚¨åº“ä¸­äº†(å†æ¬¡ï¼Œåœ¨è¿™é‡Œåšä¸€äº›å‡è®¾â€¦)ï¼Œæ˜¯æ—¶å€™åœ¨ç®¡é“ä¸­æ„å»ºå®ƒäº†â€”â€”å¯èƒ½ç”¨äºå¤šç§æ¶æ„ã€‚

ä¸åŒç®¡é“ä¸­çš„æ–¹æ³•æ˜¯ä¸åŒçš„ï¼Œä½†å®ƒä»¬éƒ½æœ‰ä¸€äº›å…±åŒç‚¹:å®ƒä»¬å¯ä»¥åœ¨æ‚¨æ¨é€ä»£ç æ—¶è¢«è§¦å‘ï¼Œå®ƒä»¬å…è®¸æ‚¨ä½¿ç”¨ Docker æœåŠ¡æˆ– Docker-in-Docker ( `dind`)æ„å»º Docker æ˜ åƒã€‚ä»–ä»¬éƒ½éå¸¸æœ‰èƒ½åŠ›å»ºç«‹ä½ çš„å…¬ä¼—ç å¤´å·¥äººå½¢è±¡ï¼Œæ‰€ä»¥ä¸è¦æµªè´¹å¤ªå¤šæ—¶é—´é€‰æ‹©ã€‚

> ä¸ºäº†å»ºç«‹å…¬å…± Docker å½¢è±¡ï¼Œä½ çš„ CI å¹³å°çš„é€‰æ‹©åº”è¯¥æ˜¯:â€œå¯ç”¨çš„é‚£ä¸ªâ€ã€‚

æˆ‘å°†åœ¨å¦ä¸€ç¯‡æ–‡ç« ä¸­å‘å¸ƒå…³äºä½¿ç”¨è¿™äº› CI å¹³å°çš„è¯¦ç»†ä¿¡æ¯ï¼Œä½†æˆ‘æƒ³åœ¨è¿™é‡Œæåˆ°ä¸€äº›å·®å¼‚å’Œç¤ºä¾‹:

## åŸºäºæœºå™¨çš„ CI å¹³å°

è¿™äº› CI å¹³å°åœ¨è™šæ‹Ÿæœºä¸Šè¿è¡Œæ‚¨çš„ä»£ç ï¼Œå› æ­¤æ‚¨å¯ä»¥é€‰æ‹©å®ƒä»¬è¿è¡Œçš„æœºå™¨æ˜ åƒ(ä¾‹å¦‚`ubuntu:bionic`æˆ–`ubuntu-2004:202101â€“01`æˆ–`macos`æˆ–`windows-latest`)ã€‚

ä¾‹å­æœ‰ [Travis-CI](https://travis-ci.com) ã€ [Circle-CI](https://circleci.com) (å¦‚æœä½¿ç”¨ [Circle-CI æœºå™¨æ‰§è¡Œå™¨](https://circleci.com/docs/2.0/configuration-reference/?section=configuration#machine))ã€ [GitHub åŠ¨ä½œ](https://docs.github.com/en/actions)æˆ–[ä¿¡å·é‡-CI](https://semaphoreci.com)

*   æˆ‘ç”¨ Travis-CI æ„å»ºçš„å¤šæ‹±`dnsmasq` Docker å½¢è±¡çš„ä¾‹å­:`[drpsychick/dnsmasq](https://github.com/DrPsychick/docker-dnsmasq)`(ä¸æ˜¯æœ€å¥½çš„ä¾‹å­ï¼Œæˆ‘å¿…é¡»æ‰¿è®¤ï¼Œä½†ç¡®å®æœ‰æ•ˆ)ã€‚
*   GitHub Actions é€šè¿‡ä¸€ä¸ªé€‚å½“çš„åŠ¨ä½œè®©å®ƒå˜å¾—ç®€å•:[æ„å»ºå¹¶æ¨é€ Docker å›¾ç‰‡](https://github.com/marketplace/actions/build-and-push-docker-images)ã€‚

## åŸºäº Docker çš„ CI å¹³å°

è¿™äº› CI å¹³å°åœ¨ docker æ˜ åƒä¸­è¿è¡Œæ‚¨çš„ä»£ç ã€‚åœ¨æ¯ä¸ªæ„å»ºé˜¶æ®µï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä¸åŒçš„æ˜ åƒæ¥è¿è¡Œä»£ç ï¼Œå› æ­¤éå¸¸çµæ´»ã€‚ç„¶è€Œï¼Œä½ éœ€è¦æ¥å—çš„æ˜¯ï¼Œåœ¨ docker ä¸­è¿è¡Œä»»ä½•ä¸œè¥¿ä¹Ÿå¯èƒ½å¸¦æ¥ä¸€äº›æŒ‘æˆ˜:è®¿é—®ç£ç›˜ç©ºé—´ã€æœåŠ¡ä¹‹é—´çš„é€šä¿¡æˆ–ä¸è¿œç¨‹ docker å¼•æ“çš„é€šä¿¡ç­‰ç­‰

ä¾‹å¦‚ [GitLab-CI](https://about.gitlab.com/stages-devops-lifecycle/continuous-integration/) ã€ [Circle-CI](https://circleci.com) æˆ– [Semaphore-CI](https://semaphoreci.com)

ä¸ºäº†ç®€åŒ–åœ¨åŸºäº Docker çš„ CI å¹³å°ä¸Šçš„æ„å»ºï¼Œæˆ‘å‘å¸ƒäº†ä¸€ç»„ç®€å•çš„ [Docker CI æ˜ åƒ](https://github.com/DrPsychick/docker-ci-images)ï¼Œå…¶ä¸­åŒ…å«äº†ä½¿ç”¨`kubectl`æˆ–`helm`åœ¨ kubernetes ä¸Šæ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²æ˜ åƒæ‰€éœ€çš„å…¨éƒ¨å†…å®¹ã€‚å®ƒä»¬å®é™…ä¸Šæ˜¯é€šè¿‡ Circle-CI ç®¡é“æ„å»ºå¹¶ä¿æŒæœ€æ–°çš„ã€‚

[](https://github.com/DrPsychick/docker-ci-images) [## DrPsychick/docker-ci-images

### å¯ä»¥åœ¨åŸºäº docker çš„ CI ç®¡é“ä¸­ä½¿ç”¨çš„å›¾åƒé›†åˆã€‚è€Œä¸æ˜¯å°†ä¾èµ–é¡¹å®‰è£…åœ¨â€¦

github.com](https://github.com/DrPsychick/docker-ci-images) 

ä½œä¸ºå¦ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘çš„ [Helm Charts repository](https://github.com/DrPsychick/charts) ä½¿ç”¨è¿™äº›å¸¦æœ‰ Circle-CI çš„å›¾åƒæ¥æµ‹è¯•å¸¦æœ‰ [Chart-Testing](https://github.com/helm/chart-testing) çš„å›¾è¡¨ï¼Œå¹¶å°†å®ƒä»¬æµ‹è¯•éƒ¨ç½²åˆ°ç®¡é“ä¸­çš„[Kubernetes-in-Docker(KinD)](https://kind.sigs.k8s.io)é›†ç¾¤ã€‚

# æ·»åŠ è®¡åˆ’

æœ€åä¸€æ­¥éå¸¸é‡è¦ï¼Œä¹Ÿéå¸¸å®¹æ˜“è®¾ç½®:å®‰æ’ç®¡é“å®šæœŸè¿è¡Œ:æ¯å‘¨ä¸€æ¬¡æˆ–æ¯æœˆä¸€æ¬¡ã€‚è¿™å°†ä½¿æ‚¨çš„å›¾åƒä¿æŒæœ€æ–°ï¼Œå¦‚æœç®¡é“å‡ºç°æ•…éšœï¼Œæ‚¨ä¼šæ”¶åˆ°é€šçŸ¥(è¿™ç§æƒ…å†µ**å°†**å‘ç”Ÿ)ã€‚

## åœ¨ä¸­è®¾ç½®è®¡åˆ’çš„ç®¡é“è¿è¡Œ

*   GitLab-CI:é€šè¿‡ [GitLab UI](https://docs.gitlab.com/ee/ci/pipelines/schedules.html) é…ç½®æ—¥ç¨‹
*   GitHub åŠ¨ä½œ:å°†æ—¶é—´è¡¨æ·»åŠ åˆ°æ‚¨çš„[å·¥ä½œæµç¨‹](https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#onschedule)
*   Circle-CI:å°†æ—¶é—´è¡¨æ·»åŠ åˆ°æ‚¨çš„ç®¡é“ [config.yml](https://github.com/DrPsychick/docker-ci-images/blob/53f6137bde972aba4b9cea3a4142b75ce452274f/.circleci/config.yml#L128)
*   Travis-CI:é€šè¿‡ [Travis UI](https://docs.travis-ci.com/user/cron-jobs/) é…ç½® cronjobs
*   ä¿¡å·é‡-CI:é€šè¿‡ [Web UI æˆ– CLI](https://docs.semaphoreci.com/essentials/schedule-a-workflow-run/) é…ç½®

# æ‘˜è¦

æˆ‘å¸Œæœ›è¿™èƒ½è®©æ‚¨å¾ˆå¥½åœ°ç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”å®ƒå®é™…ä¸Šå¾ˆå®¹æ˜“æ„å»ºï¼Œç„¶åå‘å¼€æºç¤¾åŒºæä¾›æœ€æ–°çš„å›¾åƒã€‚

åœ¨ä¸€å®šçš„é¢„ç®—å†…ï¼Œå¤§å¤šæ•° CI å¹³å°å¯¹äºå¼€æºé¡¹ç›®éƒ½æ˜¯å…è´¹çš„ï¼Œæ‰€ä»¥**è¯•è¯•å§ï¼è®©æˆ‘çŸ¥é“æˆ‘æ˜¯å¦å¯ä»¥ä¸ºè¿™ä¸ªä½œå“æ·»åŠ ä¸€äº›æˆ‘å·²ç»å¿˜è®°æˆ–é”™è¿‡çš„ä¸œè¥¿ã€‚æˆ–è€…ç»™æˆ‘ä¸€ä¸ªä½ çš„é¡¹ç›®çš„é“¾æ¥ï¼Œä¾‹å¦‚ Semaphore-CIï¼Œæˆ‘å¯ä»¥æŠŠå®ƒæ·»åŠ åˆ°ä¾‹å­ä¸­ã€‚**

å®Œå…¨æ²¡æœ‰å¿…è¦æµªè´¹äººä»¬ä¸ºå»ºç«‹æœ‰ç”¨çš„ Docker å½¢è±¡æ‰€ä»˜å‡ºçš„åŠªåŠ›â€”â€”å› ä¸ºç°åœ¨ç¼ºå°‘çš„åªæ˜¯ä¸€ä¸ª CI å¹³å°ã€‚