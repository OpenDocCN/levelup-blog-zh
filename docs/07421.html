<html>
<head>
<title>Deploying a Simple NodeJS Microservice using CDK8s</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CDK8s部署简单的NodeJS微服务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/deploying-a-simple-nodejs-microservice-using-cdk8s-4da8c3b7a32d?source=collection_archive---------7-----------------------#2021-02-16">https://levelup.gitconnected.com/deploying-a-simple-nodejs-microservice-using-cdk8s-4da8c3b7a32d?source=collection_archive---------7-----------------------#2021-02-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e4b688490641107f27527676cc7de62f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sfBEoReW5kigNsvxeaVYsQ.jpeg"/></div></div></figure><p id="1451" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于一个DevOps工程师来说，仅仅为了在Kubernetes上部署一个微服务而编写200多行YAML代码是一件非常痛苦的事情。</p><p id="db68" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjLtOHq8O7uAhVIeX0KHfFqCUYQFjAAegQIAxAC&amp;url=https%3A%2F%2Fgithub.com%2Fawslabs%2Fcdk8s&amp;usg=AOvVaw2y3ffai280pM2lKZMp5tmj" rel="noopener ugc nofollow" target="_blank"> CDK8s </a>可用于删除所有重复的代码，使部署您的微服务变得更容易，而不必编写大量的YAML清单。</p><p id="259d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还可以使用我们最喜欢的面向对象语言编写代码。</p><p id="9a95" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将使用TypeScript和开源CDK8s结构编写一个示例CDK8s图表。</p><p id="cd85" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">使用的结构:</strong></p><ul class=""><li id="bcde" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><a class="ae kw" href="https://github.com/opencdk8s/cdk8s-redis-sts" rel="noopener ugc nofollow" target="_blank">@ open CDK 8s/CDK 8s-redis-STS</a>* v 0 . 0 . 7</li><li id="f982" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">cdk8s-plus-17 * v 1 . 0 . 0-beta 8</li></ul><ol class=""><li id="026d" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv ll ld le lf bi translated">初始化CDK8s项目</li></ol><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="f491" class="lv lw iq lr b gy lx ly l lz ma">mkdir cdk8s-node-app &amp;&amp; cd cdk8s-node-app<br/>cdk8s init typescript-app</span></pre><p id="335d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.安装构造库</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="1051" class="lv lw iq lr b gy lx ly l lz ma">npm install @opencdk8s/cdk8s-redis-sts </span></pre><p id="033d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.编辑<code class="fe mb mc md lr b">main.ts</code>以包含我们的Redis db和NodeJS应用程序</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="98ab" class="lv lw iq lr b gy lx ly l lz ma">import { Construct } from 'constructs';<br/>import { App, Chart, ChartProps } from 'cdk8s';<br/>import { MyRedis } from '<a class="ae kw" href="http://twitter.com/opencdk8s/cdk8s-redis-sts" rel="noopener ugc nofollow" target="_blank">@opencdk8s/cdk8s-redis-sts</a>';<br/>import { Deployment } from 'cdk8s-plus-17';</span><span id="0abd" class="lv lw iq lr b gy me ly l lz ma">export class MyChart extends Chart {<br/>  constructor(scope: Construct, id: string, props: ChartProps = { }) {<br/>    super(scope, id, props);</span><span id="483f" class="lv lw iq lr b gy me ly l lz ma">const redis = new MyRedis(this, 'redis', {<br/>      image: 'redis',<br/>      namespace: 'default',<br/>      volumeSize: '10Gi',<br/>      replicas: 3,<br/>      createStorageClass: false,<br/>    });</span><span id="ae02" class="lv lw iq lr b gy me ly l lz ma">new Deployment(this, "deployment", {<br/>      metadata: {<br/>        namespace: 'default',<br/>      },<br/>      containers: [{<br/>        image: "hunterthompson/node-redis-counter:latest",<br/>        name: "hello",<br/>        env: {<br/>          'REDIS_URI': {<br/>            value: redis.name<br/>          }<br/>        }<br/>      }]<br/>    })</span><span id="805c" class="lv lw iq lr b gy me ly l lz ma">  }<br/>}</span><span id="d503" class="lv lw iq lr b gy me ly l lz ma">const app = new App();<br/>new MyChart(app, 'microservice');<br/>app.synth();</span></pre><p id="642a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.运行编译和合成</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="1027" class="lv lw iq lr b gy lx ly l lz ma">npm run compile &amp;&amp; npm run synth</span></pre><p id="6625" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"/><code class="fe mb mc md lr b"><strong class="ka ir">npm run synth</strong></code><strong class="ka ir">命令的最终结果是您可以使用</strong> <code class="fe mb mc md lr b"><strong class="ka ir">kubectl</strong></code>应用的YAML清单</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="d003" class="lv lw iq lr b gy lx ly l lz ma">apiVersion: v1<br/>data:<br/>  master.conf: |-<br/>    <br/>    bind 0.0.0.0<br/>    daemonize no<br/>    port 6379<br/>    tcp-backlog 511<br/>    timeout 0<br/>    tcp-keepalive 300<br/>    supervised no<br/>  slave.conf: |-<br/>    <br/>    slaveof redis 6379<br/>kind: ConfigMap<br/>metadata:<br/>  name: redis-redis-conf<br/>  namespace: default<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    app: redis<br/>  name: redis<br/>  namespace: default<br/>spec:<br/>  ports:<br/>    - port: 6379<br/>      targetPort: 6379<br/>  selector:<br/>    app: redis<br/>  type: ClusterIP<br/>---<br/>apiVersion: apps/v1<br/>kind: StatefulSet<br/>metadata:<br/>  labels:<br/>    app: redis<br/>  name: redis<br/>  namespace: default<br/>spec:<br/>  replicas: 3<br/>  selector:<br/>    matchLabels:<br/>      app: redis<br/>  serviceName: redis<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: redis<br/>    spec:<br/>      containers:<br/>        - command:<br/>            - bash<br/>            - -c<br/>            - |-<br/>              [[ `hostname` =~ -([0-9]+)$ ]] || exit 1<br/>              ordinal=${BASH_REMATCH[1]}<br/>              if [[ $ordinal -eq 0 ]]; then<br/>              redis-server /mnt/redis/master.conf<br/>              else<br/>              redis-server /mnt/redis/slave.conf<br/>              fi<br/>          env: []<br/>          image: redis<br/>          name: redis<br/>          ports:<br/>            - containerPort: 6379<br/>          resources:<br/>            limits:<br/>              cpu: 400m<br/>              memory: 512Mi<br/>            requests:<br/>              cpu: 200m<br/>              memory: 256Mi<br/>          volumeMounts:<br/>            - mountPath: /data<br/>              name: redis<br/>            - mountPath: /mnt/redis/<br/>              name: redis-redis-conf<br/>      terminationGracePeriodSeconds: 10<br/>      volumes:<br/>        - configMap:<br/>            name: redis-redis-conf<br/>          name: redis-redis-conf<br/>  volumeClaimTemplates:<br/>    - metadata:<br/>        name: redis<br/>        namespace: default<br/>      spec:<br/>        accessModes:<br/>          - ReadWriteOnce<br/>        resources:<br/>          requests:<br/>            storage: 10Gi<br/>        storageClassName: gp2<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: microservice-deployment-c89e8760<br/>  namespace: default<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      cdk8s.deployment: microservice-deployment-c87f6fea<br/>  template:<br/>    metadata:<br/>      labels:<br/>        cdk8s.deployment: microservice-deployment-c87f6fea<br/>    spec:<br/>      containers:<br/>        - env:<br/>            - name: REDIS_URI<br/>              value: redis<br/>          image: hunterthompson/node-redis-counter:latest<br/>          imagePullPolicy: Always<br/>          name: hello<br/>          ports: []<br/>          volumeMounts: []<br/>      volumes: []</span></pre><p id="f1c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们刚刚通过编写33行CDK8s代码合成了一个130行的YAML清单。</p></div></div>    
</body>
</html>