<html>
<head>
<title>Server logs stream into BigQuery: yes, of course</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">服务器日志流进入BigQuery:是的，当然</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/server-logs-stream-into-bigquery-yes-of-course-5e47d5983d6b?source=collection_archive---------10-----------------------#2020-06-27">https://levelup.gitconnected.com/server-logs-stream-into-bigquery-yes-of-course-5e47d5983d6b?source=collection_archive---------10-----------------------#2020-06-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="569a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">监控您的服务器流量，检测机器人的行为，并轻松创建图表</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fea260196400bb146cf1159af57a5f32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xSA3_ZPj6MJZmfBYygUgaw.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://depositphotos.com/" rel="noopener ugc nofollow" target="_blank"> Depositphotos </a></figcaption></figure><h1 id="0519" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">摘要</h1><p id="2fba" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本教程中，我们将完成从服务器向Google BigQuery发送包含日志数据的流所需的所有设置。<br/>网上还有一些关于这个话题的教程，但是我发现它们不够清楚或者充满了过时的信息。为了让一切如我所料地工作，需要做各种各样的改变，我将在本文中介绍这些改变。我已经在一个语音识别平台上测试了这种方法，该平台名为<a class="ae ky" href="https://voxpow.com/" rel="noopener ugc nofollow" target="_blank"> Voxpow </a>(运行在Ubuntu 18.04和Nginx上)，几周以来，大量数据的结果已经足够好了。</p><h1 id="ca6b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">但是我们为什么需要这个呢？</h1><p id="116f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一个问题出现了——我们为什么需要它？为什么我们不直接下载日志并用<a class="ae ky" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> Pandas </a>或其他工具如<a class="ae ky" href="https://goaccess.io/" rel="noopener ugc nofollow" target="_blank"> GoAccess </a>(超棒的开源网络日志分析器)进行分析？</p><p id="bdd4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我希望能够实时查看数据，并能够对流量进行某种分析。在我们的语音平台中，我们也有一个API，我需要更多关于每个用户点击率的信息。</p><p id="5ed3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这就是我寻找实现日志流进入<a class="ae ky" href="https://cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank"> Google BigQuery </a>的最佳方式，在那里我们能够检查每个请求、IP和访问过的页面。</p><p id="9bcc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这就像谷歌分析所有的服务器流量，而不仅仅是JavaScript检测到的访客。嗯，不多，但我们很接近…</p><p id="079d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">借助这一技术，我们正在实现:</p><ul class=""><li id="d37c" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">能够在我们的服务器上几乎实时监控点击量；</li><li id="18cf" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">有可能看到搜索引擎机器人是如何抓取我们的网站；</li><li id="2276" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">检查是否有太多来自特定IP地址的访问。</li></ul><p id="43b6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">每个数据都存储在BigQuery中，在那里我们可以使用SQL语法执行闪电般的请求。最重要的是，我们可以在Google Data Studio或定制的数据可视化解决方案中集成我们的数据。</p><h2 id="cad8" class="ng la it bd lb nh ni dn lf nj nk dp lj ma nl nm ll me nn no ln mi np nq lp nr bi translated">什么是谷歌大查询</h2><p id="3b82" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">它是一个无服务器、高度可扩展且经济高效的云数据仓库，旨在实现业务灵活性。它允许我们执行极快的查询，并使用简单的SQL获得我们需要的数据——只需很少的时间。<br/>此外，BigQuery的高速流插入API为实时分析提供了强大的基础，使我们的数据可立即用于分析。这非常适合我们的需要，因为我们通常需要处理大量的信息，你可以想象普通机器人的爬行速度。</p><h2 id="c86c" class="ng la it bd lb nh ni dn lf nj nk dp lj ma nl nm ll me nn no ln mi np nq lp nr bi translated">受影响的是什么</h2><p id="b00e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为了发送所有这些流信息，我们需要从服务器到BigQuery的某种类型的连接。使用定制的方法从日志中发送信息可能很难实现，因为我们需要在日志循环、服务器关闭、从同一个地方恢复等情况下实现特定行为的逻辑。到目前为止，我发现Fluentd 是最适合这些需求的工具。它是统一日志记录层的开源数据收集器。它适用于Apache和Nginx，但是对于本教程，我们将更多地关注Nginx。</p><h1 id="845f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">在Ubuntu + nginx上安装</h1><p id="aa23" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们开始，去扔设置一切的过程。在Ubuntu 18.04 + Nginx 1.14上进行设置。</p><ol class=""><li id="c008" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm ns my mz na bi translated"><strong class="lt iu">安装流体</strong></li></ol><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="25d2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> 2。创建一个大查询数据集</strong></p><p id="ffbb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">首先，您需要在Google Cloud中注册，然后开始创建项目和设置服务帐户凭证的过程。如果您遇到任何问题，可以参考文档。</p><p id="e794" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后，我们必须选择使用CLI或可视化界面。如果你喜欢命令行，你需要检查一下<a class="ae ky" href="https://cloud.google.com/bigquery/docs/bq-command-line-tool" rel="noopener ugc nofollow" target="_blank"> bq </a>。这是一个基于python的BigQuery命令行工具。</p><p id="fcd8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">从可视控制台中，您可以创建这样的数据集:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/fcaf457e805268537e6e7a9440fd8e20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UqvRRpBxW3NYOh-bkWb14A.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">在BigQuery中创建数据集</figcaption></figure><p id="9c32" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">创建数据集后，您需要创建一个表和模式。对于命名，我们使用<strong class="lt iu"> voxpow:logs:ubuntu </strong>(数据集:表:模式)</p><p id="be03" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> 3。创建一个JSON模式来处理web日志+服务器主机名+ vhost名称</strong></p><p id="3ddb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">重要的一步是定义包含所有字段的模式，这些字段应该与数据相匹配。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">BigQuery的JSON模式</figcaption></figure><p id="87ae" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果使用Apache服务器，由于日志格式不同，这个模式需要修改。</p><p id="c970" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> 4。安装Fluentd谷歌大查询插件</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">安装流畅的附加插件，以便与BiqQuery进行通信</figcaption></figure><p id="ce8d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> 5。配置fluentd来读取这个vhost的nginx访问日志，并上传到BigQuery </strong></p><p id="bdbb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">配置文件的位置:<strong class="lt iu">/etc/TD-agent/TD-agent . conf</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Nginx的td代理配置</figcaption></figure><p id="0884" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这可能是最难的部分，因为您需要根据自己的需要调整这个配置。我们也在使用vhosts，这可能会增加额外的复杂性，但允许我们将此功能扩展到更多的服务。</p><p id="5118" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果您想读取不同的格式，您可以更改<service>标签。</service></p><p id="8084" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">连接到BigQuery的所有服务都放在安全位置的JSON文件中，不能通过HTTP访问。这是一部分:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="40ea" class="ng la it nx b gy ob oc l od oe"><strong class="nx iu">json_key /home/voxpow/voxpow-aSdx3sf0spf.json</strong></span></pre><p id="cdc1" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果有些事情没有按预期工作或只是为了确认，您需要检查fluentd的日志:</p><p id="31e1" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> 6。在确保用户fluentd运行身份(默认为td-agent)对您的Nginx访问日志拥有读取权限后，启动(或重启)fluentd。</strong></p><p id="5bde" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以像这样控制和检查Fluend守护程序:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="7696" class="ng la it nx b gy ob oc l od oe"><strong class="nx iu">$ sudo systemctl status td-agent</strong></span></pre><p id="2deb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您还可以启动和停止服务:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="863f" class="ng la it nx b gy ob oc l od oe"><strong class="nx iu">$ sudo systemctl start td-agent<br/>$ sudo systemctl stop td-agent</strong></span></pre><p id="3c51" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果您面临权限问题，这可以从日志中识别出来，那么可以使用这个简单bash脚本来授予日志目录权限:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="1dbc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">以及在特定的时间内设置cron作业，以适应您的网站负载。请记住，日志轮换服务将根据权限更改访问文件。</p><p id="b9dd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> 7。恭喜，您已经设置了web访问日志，可以注入到BigQuery中。</strong></p><p id="6814" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果有任何错误，你可以在日志中找到:<strong class="lt iu">/var/log/TD-agent/TD-agent . log</strong></p><h1 id="b3cb" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">BigQuery中的服务器日志</h1><p id="4200" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果设置一切正常，您应该能够在BigQuery控制台中看到点击。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/c4fb83db4a8eeb1424b394702bf1ebed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LSCc7REwJMHmGANZ7IlQOA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">BigQuery统计</figcaption></figure><h1 id="6635" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">SQL查询示例</h1><p id="7d7e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">您可以修改并使用其中的一些示例查询，但是请记住，如果您有很多行，您可能需要为“大查询”付费，黄金法则是只询问您真正需要的信息。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">对日志数据使用的SQL查询示例</figcaption></figure><h1 id="93c8" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">图表</h1><p id="3a66" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">您可以制作各种图表，将数据直接导出到Data Studio。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi og"><img src="../Images/e24c9539b8d5b02e7b4843349cacbc0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1154/format:webp/1*dvqN3AGZyzAMKMQaKRW25A.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用Data Studio探索</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/78d3d82b1a450ea2da81edc728a68c45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BKVdZE8P4xfPMbmPL_apqg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">简单数据工作室可视化</figcaption></figure><h1 id="552c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">资源使用</h1><p id="3356" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在最初的几周，我们有一些高CPU峰值，但这是由于td-agent.conf中的错误配置。</p><h1 id="a22e" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">摘要</h1><p id="0d9f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本文中，我们讨论了BigQuery中的示例配置和日志流。有很多服务器分析工具，但我发现以下要点很难通过其他解决方案获得:</p><ul class=""><li id="9453" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">对Google bot抓取做一个分析；</li><li id="db70" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">API使用情况的实时统计，在不同的命令行界面中可用；</li><li id="85ff" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">快速获得IP信息和请求频率的可能性；</li><li id="6a3a" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">数据仓库并存储该信息以执行进一步的分析；</li></ul><p id="5f5d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">使用这种方法，很容易对搜索引擎爬虫进行详细的分析，并获得洞察力——它们如何抓取你的网站，什么样的因素对访问频率有影响，等等。</p></div></div>    
</body>
</html>