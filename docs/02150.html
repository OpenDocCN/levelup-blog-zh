<html>
<head>
<title>Spring Boot: Soft Delete functionality with Hibernate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spring Boot:Hibernate的软删除功能</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/spring-boot-soft-delete-functionality-with-hibernate-f5ee8c24c99f?source=collection_archive---------0-----------------------#2020-02-22">https://levelup.gitconnected.com/spring-boot-soft-delete-functionality-with-hibernate-f5ee8c24c99f?source=collection_archive---------0-----------------------#2020-02-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/fb3cf36b8699982e400f429f0a64471e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GydwTmGPaZuxA3Oq.png"/></div></div></figure><p id="2a44" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<a class="ae kz" href="https://medium.com/@patelromil/spring-boot-annotations-b358628918ac" rel="noopener">之前的</a>文章中，我们已经讨论了<em class="la"> Web和原型注释</em>，并且看到了带有代码的例子。在本文中，我将使用注释演示基本的软删除功能。</p><p id="7901" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了实现软删除功能，我们将使用<strong class="kd iu"> <em class="la"> @SQLDelete、@Where、@Filter和@FilterDef。</em> </strong>为了生成公共的getter-setter，我们将如下使用<strong class="kd iu"> <em class="la"> @Data </em> </strong>。</p><h2 id="ff28" class="lb lc it bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated">@数据</h2><p id="c753" class="pw-post-body-paragraph kb kc it kd b ke lu kg kh ki lv kk kl km lw ko kp kq lx ks kt ku ly kw kx ky im bi translated">所有字段上的<code class="fe lz ma mb mc b">@ToString</code>、<code class="fe lz ma mb mc b">@EqualsAndHashCode</code>、<code class="fe lz ma mb mc b">@Getter</code>、所有非最终字段上的<code class="fe lz ma mb mc b">@Setter</code>、<code class="fe lz ma mb mc b">@RequiredArgsConstructor</code>的快捷方式。</p><p id="86bf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要使用它，你必须在<em class="la"> pom.xml </em>或<em class="la"> build.gradle </em>中添加以下依赖项，并为你的<a class="ae kz" href="https://stackoverflow.com/q/41161076/10961238" rel="noopener ugc nofollow" target="_blank"> IntelliJ IDEA </a>、<a class="ae kz" href="https://stackoverflow.com/a/46520849/10961238" rel="noopener ugc nofollow" target="_blank"> Eclipse </a>添加Lombok插件。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="6146" class="lb lc it mc b gy ml mm l mn mo"><strong class="mc iu"><em class="la">//For Maven Project</em></strong><br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br/>   &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br/>   &lt;scope&gt;provided&lt;/scope&gt;<br/>&lt;/dependency&gt;</span><span id="ff6b" class="lb lc it mc b gy mp mm l mn mo"><strong class="mc iu"><em class="la">//For Gradle Project</em></strong><br/>dependencies {<br/>	compileOnly 'org.projectlombok:lombok:1.18.12'<br/>	annotationProcessor 'org.projectlombok:lombok:1.18.12'<br/>	<br/>	testCompileOnly 'org.projectlombok:lombok:1.18.12'<br/>	testAnnotationProcessor 'org.projectlombok:lombok:1.18.12'<br/>}</span></pre><p id="4c2a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们首先为用户实体创建一个用于保存、列出和删除的API，并将探索<strong class="kd iu"> <em class="la">、@SQLDelete、@Where、@Filter和@FilterDef </em> </strong></p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="3e6f" class="lb lc it mc b gy ml mm l mn mo">@Entity<br/>@Data<br/>@Table(name = "user")<br/>public class <strong class="mc iu">User </strong>{</span><span id="e696" class="lb lc it mc b gy mp mm l mn mo">    @Id<br/>    @GeneratedValue<br/>    private Long id;<br/>    private String firstname;<br/>    private String lastname;<br/>    private String contact;<br/>    private Boolean deleted;<br/>}</span><span id="cbb4" class="lb lc it mc b gy mp mm l mn mo"><strong class="mc iu">//APIs</strong><br/>@PostMapping(value = "/save")<br/>public @ResponseBody User <strong class="mc iu">save</strong>(@RequestBody User user) {<br/>    user = userService.save(user);<br/>    return user;<br/>}</span><span id="25b3" class="lb lc it mc b gy mp mm l mn mo">@DeleteMapping("/delete/{id}")<br/>public void <strong class="mc iu">delete</strong>(@PathVariable Long id) {<br/>    userService.delete(id);<br/>}</span><span id="b3f5" class="lb lc it mc b gy mp mm l mn mo">@GetMapping(value = "/list")<br/>public ResponseEntity&lt;List&lt;User&gt;&gt; <strong class="mc iu">findAll</strong>() {<br/>    List&lt;User&gt; users = userService.findAll();<br/>    return new ResponseEntity&lt;&gt;(users, HttpStatus.<em class="la">OK</em>);<br/>}</span></pre><h2 id="1ab2" class="lb lc it bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated">@SQLDelete</h2><p id="df3a" class="pw-post-body-paragraph kb kc it kd b ke lu kg kh ki lv kk kl km lw ko kp kq lx ks kt ku ly kw kx ky im bi translated">该注释支持3参数<em class="la"> sql，可调用和检查。</em></p><ul class=""><li id="9783" class="mq mr it kd b ke kf ki kj km ms kq mt ku mu ky mv mw mx my bi translated"><strong class="kd iu"> <em class="la"> sql: </em> </strong>过程名或SQL UPDATE/DELETE语句。</li><li id="387d" class="mq mr it kd b ke mz ki na km nb kq nc ku nd ky mv mw mx my bi translated"><strong class="kd iu"> <em class="la">可调用:</em> </strong> <em class="la"> </em>是可调用的语句(又名<code class="fe lz ma mb mc b">CallableStatement</code></li><li id="0548" class="mq mr it kd b ke mz ki na km nb kq nc ku nd ky mv mw mx my bi translated"><strong class="kd iu"> <em class="la">检查:</em> </strong>对于持久性操作，将使用什么风格的确定结果(成功/失败)。</li></ul><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="e410" class="lb lc it mc b gy ml mm l mn mo"><strong class="mc iu">ResultCheckStyle.NONE<br/></strong>Do not perform checking. Default Paramter</span><span id="e20e" class="lb lc it mc b gy mp mm l mn mo"><strong class="mc iu">ResultCheckStyle.COUNT</strong><br/>Perform row-count checking. Row counts are the int values returned by both <!-- -->PreparedStatement.executeUpdate()<!-- --> and <!-- -->Statement.executeBatch()<!-- -->. These values are checked against some expected count.</span><span id="a70f" class="lb lc it mc b gy mp mm l mn mo"><strong class="mc iu">ResultCheckStyle.PARAM</strong><br/>Essentially the same as COUNT except that the row count actually comes from an output parameter registered as part of a <!-- -->CallableStatement<!-- -->. This style explicitly prohibits statement batching from being usedimplmen</span></pre><p id="323f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因为我们希望实现软删除，所以我们将把deleted标志值更新为true，并且记录将被保存在数据库中。为了实现这一点，我们必须在<em class="la">用户实体类</em>中添加这条语句</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="8168" class="lb lc it mc b gy ml mm l mn mo">@Entity<br/>@Data<br/>@Table(name = "user")<br/><strong class="mc iu">@SQLDelete(sql = "UPDATE user SET deleted=true WHERE id=?")</strong><br/>public class User {<br/>   ...<br/>}</span></pre><p id="39ae" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当我们在“<em class="la"> /delete/{id}”上发出删除请求时，</em> delete语句将被<em class="la"> @SQLDelete中定义的SQL查询覆盖。为了验证，</em>我们可以添加日志属性来使用<em class="la"> application.properties </em>或<em class="la"> application.yml. </em>文件<em class="la">。</em></p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="cd03" class="lb lc it mc b gy ml mm l mn mo">#Logging properties<br/>logging.level.org.hibernate.SQL=DEBUG<br/>logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE</span></pre><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ne"><img src="../Images/dd320a35669c2c625ecf5da21725e4f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZWPQumA_JHGG6aj1RpZNQA.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">由@SQLDelete生成的Update语句</figcaption></figure><p id="136c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，当我们请求“/list”API获取用户时，它返回所有用户(已删除+未删除)。为了根据删除的标志过滤用户，我们可以使用<a class="ae kz" href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repository-query-keywords" rel="noopener ugc nofollow" target="_blank"> JPA的查询关键字</a>。想象一下，一个有很多方法的项目，你需要实现软删除，你必须用JPA关键字修改所有的方法，这可能导致容易出错。我们有<strong class="kd iu"> <em class="la"> @Where </em> </strong> <em class="la">来解救我们修改所有的方法，节省时间</em> <strong class="kd iu"> <em class="la">。</em> </strong>将此注释添加到用户实体，如下所示。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="e1df" class="lb lc it mc b gy ml mm l mn mo">@Entity<br/>@Data<br/>@Table(name = "user")<br/>@SQLDelete(sql = "UPDATE user SET deleted=true WHERE id=?")<br/><strong class="mc iu">@Where(clause = "deleted = false")</strong><br/>public class User {<br/>   ...<br/>}</span></pre><ul class=""><li id="5449" class="mq mr it kd b ke kf ki kj km ms kq mt ku mu ky mv mw mx my bi translated">不带<strong class="kd iu">@ Where(clause = " deleted = false ")</strong></li></ul><figure class="md me mf mg gt ju gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/4187eb8d0c1be916e744904316210fc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/1*ob-hCUYjIN6aglfwcyxk4Q.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">来自“列表”API的响应，<strong class="bd ld">所有记录都存在。</strong></figcaption></figure><ul class=""><li id="56a6" class="mq mr it kd b ke kf ki kj km ms kq mt ku mu ky mv mw mx my bi translated">用<strong class="kd iu">@ Where(clause = " deleted = false ")</strong></li></ul><figure class="md me mf mg gt ju gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/b8c95b8ec808ea3a23c8203754ded379.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*cP8szlTb3yoEzBdG9ytUwQ.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">来自"/list" API的响应，<strong class="bd ld">只有未删除的用户存在。</strong></figcaption></figure><p id="3430" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="la">注意:</em>您无法检索已被删除的用户的记录，因为@Where会删除带有已删除标志的用户记录。<strong class="kd iu">如果我们需要显示软删除和未删除用户的记录，我们可以使用@Filter </strong>，如下例所示。</p><p id="4fa0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在用户实体类中添加下面的语句并删除@Where，因为保留这两个注释会使彼此的功能发生冲突。 </p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="af77" class="lb lc it mc b gy ml mm l mn mo">@Entity<br/>@Data<br/>@Table(name = "user")<br/>@SQLDelete(sql = "UPDATE user SET deleted=true WHERE id=?")<br/><strong class="mc iu">@FilterDef(<br/>        name = "deletedUserFilter",<br/>        parameters = @ParamDef(name = "isDeleted", type = "boolean")<br/>)<br/>@Filter(<br/>        name = "deletedUserFilter",<br/>        condition = "deleted = :isDeleted"<br/>)</strong><br/>public class <strong class="mc iu">User </strong>{<br/>   ... <br/>}</span></pre><h2 id="5963" class="lb lc it bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated"><strong class="ak"> @FilterDef </strong></h2><p id="a197" class="pw-post-body-paragraph kb kc it kd b ke lu kg kh ki lv kk kl km lw ko kp kq lx ks kt ku ly kw kx ky im bi translated">该注释定义了将由<em class="la">@过滤器使用的基本要求。</em></p><ul class=""><li id="92ca" class="mq mr it kd b ke kf ki kj km ms kq mt ku mu ky mv mw mx my bi translated"><strong class="kd iu"> <em class="la">名称</em> </strong>:将在<em class="la">@过滤器和会话</em>中使用的过滤器名称</li><li id="5142" class="mq mr it kd b ke mz ki na km nb kq nc ku nd ky mv mw mx my bi translated"><strong class="kd iu"> <em class="la">参数</em> </strong>:使用<strong class="kd iu"> @ParamDef </strong>注释定义参数，参数<em class="la">名称和类型</em></li></ul><h2 id="7e85" class="lb lc it bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated"><strong class="ak">@滤镜</strong></h2><p id="e407" class="pw-post-body-paragraph kb kc it kd b ke lu kg kh ki lv kk kl km lw ko kp kq lx ks kt ku ly kw kx ky im bi translated">这使用了使用<em class="la">名称</em>参数在<em class="la"> @FilterDef </em>中定义的过滤器定义。我们可以使用<em class="la">条件</em>参数定义我们需要的条件。</p><p id="3191" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们快速修改一下<em class="la"> findAll() </em>方法。我们将添加名为<em class="la">的参数isDeleted </em>来获取基于它的用户记录。要启用过滤器，我们可以添加<em class="la">session . enable filter(" filterName ")</em>，并可以动态设置参数值。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="4b72" class="lb lc it mc b gy ml mm l mn mo">@GetMapping(value = "/list")<br/>public ResponseEntity&lt;List&lt;User&gt;&gt; findAll(<br/><strong class="mc iu">@RequestParam(value = "isDeleted", required = false, defaultValue = "false") boolean isDeleted</strong>) {<br/>    List&lt;User&gt; users = userService.<strong class="mc iu">findAllFilter(isDeleted)</strong>;<br/>    return new ResponseEntity&lt;&gt;(users, HttpStatus.<em class="la">OK</em>);<br/>}</span><span id="91c5" class="lb lc it mc b gy mp mm l mn mo"><strong class="mc iu">public List&lt;User&gt; findAllFilter(boolean isDeleted) {<br/>    Session session = entityManager.unwrap(Session.class);<br/>    Filter filter = session.enableFilter("deletedUserFilter");<br/>    filter.setParameter("isDeleted", isDeleted);<br/>    List&lt;User&gt; users = userRepository.findAll();<br/>    session.disableFilter("deletedUserFilter");<br/>    return users;<br/>}</strong></span></pre><ul class=""><li id="0077" class="mq mr it kd b ke kf ki kj km ms kq mt ku mu ky mv mw mx my bi translated">获取参数<strong class="kd iu"> isDeleted=true </strong>软删除用户的记录</li></ul><figure class="md me mf mg gt ju gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/692300336cf9b3b5582609750c93ecf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*bjeW5XSFO_FzOiCvZUOejg.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">localhost:8080/users/rest/list？isDeleted=true</figcaption></figure><ul class=""><li id="df59" class="mq mr it kd b ke kf ki kj km ms kq mt ku mu ky mv mw mx my bi translated">用参数<strong class="kd iu"> isDeleted=false </strong>获取未删除用户的记录</li></ul><figure class="md me mf mg gt ju gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/12e467890efd5c058c7bb22909a3eafc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*exOLc8NyzFoY1ndOIm5uTA.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">localhost:8080/users/rest/list？isDeleted=false</figcaption></figure><p id="90aa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从<a class="ae kz" href="https://github.com/romilptl/spring-boot-annotations" rel="noopener ugc nofollow" target="_blank">这里</a>获取源代码。</p></div></div>    
</body>
</html>