<html>
<head>
<title>Facebook Instant Games 1v1 Multiplayer using Firebase (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Firebase的脸书即时游戏1v1多人游戏(第1部分)</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/facebook-instant-games-1v1-multiplayer-using-firebase-part-1-30c1f6e32b92?source=collection_archive---------0-----------------------#2018-07-01">https://levelup.gitconnected.com/facebook-instant-games-1v1-multiplayer-using-firebase-part-1-30c1f6e32b92?source=collection_archive---------0-----------------------#2018-07-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/910e541a21e533641102e5dc423a06a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EMUF0zb9T7TVeGW2"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">凯莉·西克玛在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="aee8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi lb translated">由于脸书即时游戏是一个相对较新的平台，有许多部分已经丢失或者根本没有按照人们期望的方式工作。</p><p id="a219" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，为了推出支持多人(1v1)的游戏，我们必须实现自己的解决方案，我们选择了Firebase，因为他们的新技术<code class="fe lk ll lm ln b">Functions</code>允许后端逻辑上传并在他们的服务器上运行，还因为他们的平台和解决方案能够根据我们的需要进行扩展(相对较低的价格)。</p><p id="9eb2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，下面的后端代码是由前端开发人员编写的，事情可能不是超级优化，但嘿，它的工作原理是如此…</p><p id="addd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本文还假设您知道如何设置一个Firebase项目和一个简单的游戏，并主要关注多人游戏部分。</p><p id="f163" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以让我们开始初始化我们的脸书即时游戏SDK</p><pre class="lo lp lq lr gt ls ln lt lu aw lv bi"><span id="1388" class="lw lx iq ln b gy ly lz l ma mb">var facebookStuff = {<br/>  name: "",<br/>  picture: "",<br/>  contextId: "",<br/>  userId: ""<br/>};</span><span id="97c1" class="lw lx iq ln b gy mc lz l ma mb">FBInstant.initializeAsync().then(function() {<br/>  FBInstant.setLoadingProgress(0);<br/>  FBInstant.startGameAsync().then(function() {<br/>  <br/>  facebookStuff.name = FBInstant.player.getName();<br/>  facebookStuff.picture = FBInstant.player.getPhoto();<br/>  facebookStuff.userId = FBInstant.player.getID();<br/>  facebookStuff.contextId = FBInstant.context.getID();<br/>}</span></pre><p id="41cd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们可以开始了，我们已经收到了来自脸书的必要的<code class="fe lk ll lm ln b">userId</code>来识别我们的用户。</p><p id="d7e8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，让我们创建对服务器进行API调用的函数。</p><figure class="lo lp lq lr gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><figure class="lo lp lq lr gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="b1ba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过使用<code class="fe lk ll lm ln b">getSignedPlayerInfoAsync</code>,我们请求一个安全令牌，该令牌将被发送到我们的服务器，并使用即时游戏平台将用户识别为合法的脸书用户。</p><blockquote class="mf mg mh"><p id="d59b" class="kd ke mi kf b kg kh ki kj kk kl km kn mj kp kq kr mk kt ku kv ml kx ky kz la ij bi translated">在这里阅读更多:<a class="ae kc" href="https://developers.facebook.com/docs/games/instant-games/sdk/fbinstant6.2" rel="noopener ugc nofollow" target="_blank">https://developers . Facebook . com/docs/games/instant-games/SDK/FB instant 6.2</a></p></blockquote><p id="e72f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">API调用然后将所需的数据发送到服务器，以便它将我们特定的<code class="fe lk ll lm ln b">userId</code>存储在专用的DB文档中(使用Firebase Firestore DB ),这实际上是我们的多人队列。</p><p id="f4ba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">玩家注册成功后，<code class="fe lk ll lm ln b">findMatch</code>函数将被作为回调函数调用，该函数的作用如下:</p><figure class="lo lp lq lr gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="000d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们再次向服务器发送签名以验证我们，我们进行另一个API调用以实际启动对对手的搜索，我们将这两个操作分开，以便在负载平衡、分析(加入队列的玩家与实际参与游戏的玩家)方面为后端提供更多选项。以及给用户更多的时间来取消搜索。将来，这两项职能可以合并。</p><p id="077b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，一旦<code class="fe lk ll lm ln b">findMatch</code>回调成功解析，服务器就会主动为我们搜索匹配。我们如何接收已经找到匹配的信息？简单来说，我们在特定集合<code class="fe lk ll lm ln b">FirebaseAPI.db.collection("multiplayerQueue").doc(facebookStuff.userId).onSnapshot()</code>下的特定文档上添加一个事件监听器</p><p id="876e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看起来是这样的:</p><figure class="lo lp lq lr gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="a09d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，它的作用是监听数据库中特定的集合和特定的文档的变化。</p><blockquote class="mf mg mh"><p id="c30b" class="kd ke mi kf b kg kh ki kj kk kl km kn mj kp kq kr mk kt ku kv ml kx ky kz la ij bi translated">参见:<a class="ae kc" href="https://firebase.google.com/docs/firestore/query-data/listen?authuser=1" rel="noopener ugc nofollow" target="_blank">https://firebase . Google . com/docs/firestore/query-data/listen</a></p></blockquote><p id="b7f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，当服务器实际上找到一个匹配时，它用我们的<code class="fe lk ll lm ln b">userId</code>在一个文档上的数据库中写入一些数据，当然对我们的对手也是如此，所以每个人都收到一个关于上述函数的事件。</p><p id="e330" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦接收到事件，我们现在只需要实际连接到我们的对手，在数据库文档中，我们的<code class="fe lk ll lm ln b">userId</code>也有我们的对手<code class="fe lk ll lm ln b">userId</code>，我们将通过脸书API使用它来连接到他们(脸书确认窗口也会弹出，这是我们无法控制的)。</p><blockquote class="mf mg mh"><p id="d350" class="kd ke mi kf b kg kh ki kj kk kl km kn mj kp kq kr mk kt ku kv ml kx ky kz la ij bi translated">！注意，一旦接收到事件并触发回调函数，我们就关闭并断开事件侦听器(我们不再需要任何其他事件)。如果我们再次执行<code class="fe lk ll lm ln b">findMatch</code>过程，将会建立一个新的事件监听器。</p></blockquote><p id="717c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看看与播放器部分的联系:</p><figure class="lo lp lq lr gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="8ea9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当这个问题解决并且弹出窗口被用户接受时，两个玩家被连接并插入到一个信使线程中，并接收一个用于他们游戏会话的<code class="fe lk ll lm ln b">matchId</code>。</p><p id="fb5e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为一个额外的，我们也可以接收连接的玩家的信息(假设他们也同意和我们一起玩他们的弹出窗口)</p><figure class="lo lp lq lr gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="a1c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上面的函数接收来自这个上下文(messenger线程)的所有玩家，基本上是我们自己和对手，我们通过<code class="fe lk ll lm ln b">userId</code>过滤掉我们自己，并加载对手的个人资料图像和数据。然后我们可以在游戏中随心所欲地使用它们。</p><p id="d8bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请继续关注第2部分，这是这些API调用背后的后端逻辑。</p><p id="7f16" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">尽情享受！</strong></p></div></div>    
</body>
</html>