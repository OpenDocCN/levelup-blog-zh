<html>
<head>
<title>How to use Glue to load data from S3 into an AWS Elasticsearch cluster that’s in your VPC</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Glue将S3的数据加载到VPC的AWS Elasticsearch集群中</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-use-glue-to-load-data-from-s3-into-an-aws-elasticsearch-cluster-thats-in-your-vpc-fa883e73c403?source=collection_archive---------2-----------------------#2020-03-12">https://levelup.gitconnected.com/how-to-use-glue-to-load-data-from-s3-into-an-aws-elasticsearch-cluster-thats-in-your-vpc-fa883e73c403?source=collection_archive---------2-----------------------#2020-03-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="bbed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我写这篇文章是因为当我遇到这个问题时，网上似乎没有任何资源详细说明如何解决这个问题(不是在堆栈溢出，AWS支持页面等)。希望即使你的问题不完全相同，这个文档仍然会有所帮助。此外，如果有任何问题，或者如果有任何事情我可以做得更容易，请让我知道！</p><p id="e7b1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，我将大量使用AWS CLI和<strong class="js iu"> jq </strong>命令来解析我从CLI获得的json。所以确保你已经安装了<strong class="js iu"> jq </strong>。如果你有一台mac，你可以像<a class="ae ko" href="http://macappstore.org/jq/" rel="noopener ugc nofollow" target="_blank">这台</a>一样安装它。</p><h1 id="546d" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">在VPC的子网内创建一个Elasticsearch集群(如果您已经有了这个集群，可以跳过这一部分)</h1><p id="f6b0" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">我将假设您已经有一个可用的VPC和子网(因为创建一个已经超出了本文的范围！).我还假设您的VPC中可能已经有一个Elasticsearch集群，但出于本教程的目的，我将通过AWS CLI创建一个与我的子网关联的AWS Elasticsearch集群，尽管您可以使用GUI或terraform(CLI更简洁)。</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="56b3" class="mb kq it lx b gy mc md l me mf">aws es create-elasticsearch-domain \<br/>   --domain-name my-cool-cluster \<br/>   --access-policies file://policy.json \<br/>   --vpc-options SubnetIds=subnet-123456 \<br/>   --ebs-options EBSEnabled=true,VolumeType=standard,VolumeSize=10</span><span id="f5d0" class="mb kq it lx b gy mg md l me mf"># Make sure your Elasticsearch cluster is attached to your subnet!</span></pre><p id="957d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我的<strong class="js iu"> policy.json </strong>中定义的访问策略如下所示:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="90f4" class="mb kq it lx b gy mc md l me mf">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "AWS": "*"<br/>      },<br/>      "Action": "es:*",<br/>      "Resource": "arn:aws:es:*:*:domain/*/*"<br/>    }<br/>  ]<br/>}</span></pre><p id="321d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我把它做得非常开放，因为我不想在本教程中处理签名</p><h1 id="25cb" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">接下来，创建一个自引用安全组</h1><p id="862c" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">您需要创建一个自引用安全组。稍后您将使用这个安全组，方法是将它附加到Elasticsearch集群和AWS Glue连接(如果其中一些没有意义，请不要惊慌！).</p><p id="935c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在创建安全组之前，您必须获得您的Elasticsearch集群所在的vpc id。您可以通过AWS CLI和jq命令行这样做:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="c001" class="mb kq it lx b gy mc md l me mf">VPC_ID=$(aws es describe-elasticsearch-domain-config \<br/>             --domain-name my-cool-cluster \<br/>             | jq -r .DomainConfig.VPCOptions.Options.VPCId)</span></pre><p id="380e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">执行一个<strong class="js iu"> echo $VPC_ID </strong>来确保命令成功。</p><p id="1051" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">像这样创建安全组:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="76d0" class="mb kq it lx b gy mc md l me mf">aws ec2 create-security-group \<br/>    --group-name ElasticsearchLoadingSecurityGroup \<br/>    --description "Security group to allow loading into AWS" \<br/>    --vpc-id $VPC_ID</span></pre><p id="2977" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可能会想什么是自引用安全组？它是一个安全组，使用自己作为入口和出口规则的来源(基本上，来源就是该安全组所连接的任何实例)。</p><p id="4d80" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要为您的<strong class="js iu">ElasticsearchLoadingSecurityGroup</strong>创建入口和出口规则，您需要获得安全组id。您可以通过以下方式实现:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="8bd7" class="mb kq it lx b gy mc md l me mf"># sorry this is so ugly</span><span id="905d" class="mb kq it lx b gy mg md l me mf">SEC_GROUP_ID=$(aws ec2 describe-security-groups \<br/> --filter Name=vpc-id,Values=$VPC_ID Name=group-name,Values=ElasticsearchLoadingSecurityGroup \<br/>             | jq -r .SecurityGroups[0].GroupId)</span></pre><p id="e03b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建入口规则:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="8838" class="mb kq it lx b gy mc md l me mf">aws ec2 authorize-security-group-ingress \<br/>    --group-id $SEC_GROUP_ID \<br/>    --protocol tcp \<br/>    --port 0-65535 \<br/>    --source-group $SEC_GROUP_ID</span></pre><p id="1bb3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建出口规则:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="5ef4" class="mb kq it lx b gy mc md l me mf">aws ec2 authorize-security-group-egress \<br/>    --group-id $SEC_GROUP_ID \<br/>    --protocol tcp \<br/>    --port 0-65535 \<br/>    --source-group $SEC_GROUP_ID</span></pre><p id="ec9b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，任何两个连接了该安全组的实例都将能够在所有TCP端口上自由通信。那么…现在让我们开始连接过程。</p><h1 id="9421" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">将安全组连接到您的弹性搜索集群</h1><p id="8407" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">我们将使用AWS CLI来更新Elasticsearch集群的配置。</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="1e34" class="mb kq it lx b gy mc md l me mf">aws es update-elasticsearch-domain-config \<br/>     --domain-name my-cool-cluster \<br/>     --vpc-options SecurityGroupIds=$SEC_GROUP_ID</span></pre><h1 id="019e" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">创建粘合连接</h1><p id="e378" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">既然我们已经将它附加到Elasticsearch集群，我们还想将它附加到一个胶合连接上。但在此之前，我们必须先在VPC内部建立一个胶水连接！</p><p id="d649" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">关于这整个胶合连接考验的最令人困惑的部分是，你将创建胶合连接，但是你实际上不需要在你的代码中使用胶合连接。你只需要在VPC内创建一个胶合连接，这样你就可以把它附加到你的胶合工作上，这样你就可以在你的VPC内启动胶合工作了。我想这对我来说可能是最令人困惑的部分。当您创建粘合连接时，您实际上可以只输入假的配置，因为您甚至不会真正使用该粘合连接。只要确保胶水连接只是连接到VPC！</p><p id="c359" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我将在接下来的几个步骤中使用GUI，因为Glue AWS CLI有点难用，也没有很好的文档。</p><p id="17a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你需要在AWS控制台中进入<strong class="js iu">粘合</strong>服务，然后点击<strong class="js iu">连接</strong>。您将被带到设置连接属性的页面。选择<strong class="js iu"> JDBC </strong>作为连接类型。</p><figure class="ls lt lu lv gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mh"><img src="../Images/5f30d595429fc11573eedee7c75c5621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gxHBN62hjK7I0YdtPSigrg.png"/></div></div></figure><p id="4d1d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，你基本上可以在<strong class="js iu"> JDBC </strong> url中放一个垃圾字符串，看起来像<strong class="js iu"> JDBC </strong>语法。我输入<strong class="js iu">JDBC:es//elastic search/elastic search</strong>——你也可以！您也可以在用户名和密码输入框中输入任何内容。<strong class="js iu">先别打下一个！！！！</strong>我会在这张截图后谈论VPC！</p><figure class="ls lt lu lv gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mp"><img src="../Images/05f156c3415087cd9cf60a7690ecb6a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bXTUw5FaZxVRh3-NTKe6cw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">你可以将JDBC的网址、用户名和密码放入垃圾中</figcaption></figure><p id="5f92" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，让我们配置这个粘合连接的网络部分。对于<strong class="js iu"> VPC </strong>和<strong class="js iu">子网</strong>，选择您的Elasticsearch集群所在的同一个VPC和子网。还记得我们在上面创建的自引用安全组吗？我们要将它附加到这个粘合连接上，所以在安全组下面，选择那个<strong class="js iu">ElasticsearchLoadingSecurityGroup</strong>(或者你给它起的任何名字)。</p><figure class="ls lt lu lv gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mu"><img src="../Images/bbb253962e605a4f546fd4ea66a8efee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cSjXAzukBJhI6Wat2GzA8Q.png"/></div></div></figure><h1 id="c731" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">创建弹性搜索加载胶合作业</h1><p id="3d63" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">让我们创建Elasticsearch加载胶合作业。我不会在本教程的代码，但只是向你展示胶水工作应该有属性。将加载到Elasticsearch中的实际pyspark代码将在我稍后链接的另一个教程中(因为编写加载到Elasticsearch中的实际Pyspark代码对我来说也是一项不简单的任务)。</p><p id="9030" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建作业并将粘合连接附加到作业(我在截图中也犯了一个错误，粘合连接的elastic search loader名称应该是elasticsearch_loader，因为这是我们在创建粘合连接时命名的！我的错！)</p><figure class="ls lt lu lv gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mv"><img src="../Images/f543b9f756bc475dcf14e53539aeb1bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mKJwCJkQ9-Fb91VLAUm-cA.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">ElasticsearchLoader应该说elasticsearch_loader，因为这是我们对粘合连接的命名。</figcaption></figure><p id="3bd1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你已经有了可以在本地加载到Elasticsearch的工作代码，那么一旦你上传了代码作为粘合作业，那么你就应该能够加载到Elasticsearch的这些配置中——然而，如果你是从S3读取，而你不能再从桶中读取，因为S3桶在公共网络上，而你的粘合作业在你的VPC——那么请继续阅读，以找到解决这个问题的方法。</p><h1 id="5bb0" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">如果你读S3的作品有困难… </strong></h1><p id="1324" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">如果您在从S3读取时遇到问题，那么您可以使用S3端点来解决这个问题。我假设您可能已经设置了一个S3端点。导航至<strong class="js iu"> VPC →终点</strong>，然后选择您的S3终点。然后点击<strong class="js iu">路由表</strong>。找到与您的Elasticsearch集群所在的子网相关联的<strong class="js iu">路由表ID </strong>，然后为<strong class="js iu">路由表ID </strong>复制该值。</p><figure class="ls lt lu lv gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mw"><img src="../Images/647ec0e7253484427a695184bfbb715d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_uBQF82LCfOwYX1FGmX2OQ.png"/></div></div></figure><p id="3940" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后返回到<strong class="js iu"> VPC </strong> → <strong class="js iu">安全组</strong>中的<strong class="js iu">elasticsearchloadingsecuritygroup</strong>安全组，然后创建一个允许该路由表ID上所有TCP端口流量的入口和出口规则。</p></div></div>    
</body>
</html>