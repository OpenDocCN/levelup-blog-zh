<html>
<head>
<title>Streaming Videos in Your Livestream Using the Agora Cloud Player</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Agora云播放器在您的直播流中播放视频</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/streaming-videos-in-your-livestream-using-the-agora-cloud-player-179199301eec?source=collection_archive---------6-----------------------#2022-04-04">https://levelup.gitconnected.com/streaming-videos-in-your-livestream-using-the-agora-cloud-player-179199301eec?source=collection_archive---------6-----------------------#2022-04-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ff38d9f55c089fd4471bb94ebe75814c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uTKJqeC974xYE3cnXR5apg.png"/></div></div></figure><p id="bbec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在之前的一篇博客文章中，我们讨论了如何使用Agora媒体推送服务将我们的直播发布到第三方服务，如YouTube、脸书或Twitch。在这篇博文中，我们将在该项目的基础上，使用Agora Cloud Player服务在视频通话或直播中向所有用户传输云视频。</p><h1 id="5711" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">先决条件</h1><ul class=""><li id="8445" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated">一个Agora开发者账户(免费，<a class="ae kw" href="https://sso.agora.io/en/signup?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=streaming-videos-in-your-videocall-or-livestream-using-agora-cloud-player" rel="noopener ugc nofollow" target="_blank">在这里注册！</a>)</li><li id="fd78" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">Node.js LTS版本</li><li id="ecf1" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">对React和Node/Express的高级理解</li></ul><h1 id="b8c1" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置</h1><p id="ebcb" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">可以在<a class="ae kw" href="https://github.com/EkaanshArora/Agora-Web-UIKit-RTMP/tree/cloudplayer" rel="noopener ugc nofollow" target="_blank"> cloudplayer分支</a>上找到完成的项目。我们将从我们在上一篇博文中构建的项目开始。如果你正在编码，你可以从GitHub 中克隆我们目前拥有的东西。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="ccf9" class="mx ky iq mt b gy my mz l na nb">git clone <a class="ae kw" href="https://github.com/EkaanshArora/Agora-Web-UIKit-RTMP.git" rel="noopener ugc nofollow" target="_blank">https://github.com/EkaanshArora/Agora-Web-UIKit-RTMP.git</a><br/>cd Agora-Web-UIKit-RTMP</span></pre><p id="8c48" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装依赖项:<code class="fe nc nd ne mt b">npm i</code></p><h2 id="52bc" class="mx ky iq bd kz nf ng dn ld nh ni dp lh kj nj nk ll kn nl nm lp kr nn no lt np bi translated">1.启用RTMP转换器</h2><p id="4a53" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在<a class="ae kw" href="https://console.agora.io/" rel="noopener ugc nofollow" target="_blank"> Agora控制台</a>中，转到使用选项卡并从下拉菜单中选择您的项目。单击RTMP转换器子菜单，并通过单击按钮启用:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/d32839b5504801d49e3d28ac891b65ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7x9eT5gT7ZXFTgyTHGUsGg.png"/></div></div></figure><h2 id="c9c9" class="mx ky iq bd kz nf ng dn ld nh ni dp lh kj nj nk ll kn nl nm lp kr nn no lt np bi translated">2.获取客户凭据</h2><p id="1548" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">转到<a class="ae kw" href="https://console.agora.io/restfulApi" rel="noopener ugc nofollow" target="_blank"> RESTful API页面</a>并点击Add Secret按钮。将客户ID和客户机密复制到文本文件中。我们将使用这些凭证从后端服务调用Agora Cloud Player端点。在控制台中，您可以从项目管理选项卡中获取应用ID。</p><p id="83fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">后端将侦听来自React前端的请求。让我们从添加一个按钮向网站发出这个请求开始。</p><h2 id="c38f" class="mx ky iq bd kz nf ng dn ld nh ni dp lh kj nj nk ll kn nl nm lp kr nn no lt np bi translated">3.启用Agora云播放器服务</h2><p id="9b34" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">要为您的项目启用Agora Cloud Player服务，您需要提供您的应用ID，通过<a class="ae kw" href="https://agora-ticket.agora.io/" rel="noopener ugc nofollow" target="_blank"> Agora Support </a>提出请求。</p><h1 id="a39f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">我们目前所拥有的</h1><p id="05ac" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">您可以执行<code class="fe nc nd ne mt b">npm start</code>来启动本地主机上的web服务器。我们将从<code class="fe nc nd ne mt b">./src/App.tsx</code>文件开始。我们将替换<code class="fe nc nd ne mt b">&lt;RTMP&gt;</code>组件，添加一个名为<code class="fe nc nd ne mt b">CloudPlayer</code>的新组件。</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="6fd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将通过创建一个新文件来定义<code class="fe nc nd ne mt b">CloudPlayer</code>组件。</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="a047" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是一个简单的组件，它呈现一个按钮来从云中传输视频。我们定义了将在下一步构建的<code class="fe nc nd ne mt b">serverUrl</code>。我们还将定义使用<code class="fe nc nd ne mt b">requestBody</code>向后端端点发送请求的<code class="fe nc nd ne mt b">playVideo</code>函数，在这里我们可以定义频道名称、Agora Cloud Player服务的UID、RTC令牌以及我们想要播放的视频的URL。</p><blockquote class="nt nu nv"><p id="0bde" class="jy jz nw ka b kb kc kd ke kf kg kh ki nx kk kl km ny ko kp kq nz ks kt ku kv ij bi translated"><em class="iq">注意:</em>视频网址应该是公开可访问的。</p></blockquote><h1 id="a944" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">让我们构建后端服务</h1><p id="7f94" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们将使用Express构建一个后端服务，该服务将侦听来自网站前端的请求，并使用所需的凭据调用Agora Cloud Player端点。你可以在<a class="ae kw" href="https://github.com/EkaanshArora/Agora-Cloud-Player-Backend" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到代码，带有一个按钮，可以在readme中快速部署到Heroku。</p><p id="6add" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将导入库。<code class="fe nc nd ne mt b">Fetch</code>用于发出HTTP请求，<code class="fe nc nd ne mt b">Express</code>管理服务器，<code class="fe nc nd ne mt b">dotenv</code>让您使用。env文件来存储您的凭证，<code class="fe nc nd ne mt b">bodyParser</code>解析来自传入请求的JSON有效负载，<code class="fe nc nd ne mt b">cors</code>是一个中间件来处理。。。好吧，科尔斯。</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="baff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将定义Express app对象并使用所需的中间件。我们将初始化dotenv并定义我们的常数。您将需要<code class="fe nc nd ne mt b">.env</code>文件设置中的客户凭证。我们将对凭证进行编码，以生成一个基本的auth头。您可以重命名<code class="fe nc nd ne mt b">.env.example</code>文件并添加您的详细信息。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="6c94" class="mx ky iq mt b gy my mz l na nb">APP_ID=30a6bc899.............<br/>REST_KEY=58cb3034............<br/>REST_SECRET=93803f1..........<br/>PORT=8080</span></pre><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="4e60" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将定义一个接受请求和响应的<code class="fe nc nd ne mt b">play</code>函数。我们将把access-control-allow-origin头添加到响应对象中。我们将从请求中获得<code class="fe nc nd ne mt b">channelName</code>、<code class="fe nc nd ne mt b">uid</code>、<code class="fe nc nd ne mt b">url</code>和<code class="fe nc nd ne mt b">token</code>。如果请求中缺少它们，我们会发送一个<code class="fe nc nd ne mt b">500</code>错误响应。</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="7121" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我们将为请求定义<code class="fe nc nd ne mt b">headers</code>和<code class="fe nc nd ne mt b">data</code>，我们将向Agora Cloud Player端点发出请求，如这里的<a class="ae kw" href="https://documenter.getpostman.com/view/6319646/SVSLr9AM#66a79ef6-5286-49de-86e2-13400aa744c4" rel="noopener ugc nofollow" target="_blank">所述</a>。我们将使用<code class="fe nc nd ne mt b">fetch</code>等待响应，并将其记录到控制台。并将其返回到前端。</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="3430" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将定义一个<code class="fe nc nd ne mt b">ping</code>函数来确保后端服务器配置正确。接下来，我们将为我们的服务定义路由。我们将对<code class="fe nc nd ne mt b">/play</code>发送路线使用<code class="fe nc nd ne mt b">play</code>函数，对<code class="fe nc nd ne mt b">/ping</code>获取路线使用<code class="fe nc nd ne mt b">ping</code>函数。我们将使用<code class="fe nc nd ne mt b">listen</code>方法在定义的端口上监听请求。</p><p id="a244" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这就是我们需要的所有代码。您可以通过执行<code class="fe nc nd ne mt b">node index.js</code>在本地运行服务。或者你可以使用<a class="ae kw" href="https://heroku.com/deploy" rel="noopener ugc nofollow" target="_blank">这个链接</a>把它放在Heroku上。</p><h1 id="9373" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结论</h1><p id="83f9" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">如果您认为有一些特性可以添加到后端服务中，请随意派生存储库并添加一个拉请求。感谢所有的贡献！</p><p id="661f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您在使用该项目时有任何问题，我邀请您加入<a class="ae kw" href="https://agora.io/en/join-slack" rel="noopener ugc nofollow" target="_blank"> Agora开发者Slack社区</a>，您可以在<code class="fe nc nd ne mt b">#web-help-me</code>频道中提问。请随意打开功能请求问题或报告关于<a class="ae kw" href="https://github.com/AgoraIO-Community/Web-React-UIKit/issues" rel="noopener ugc nofollow" target="_blank"> UIKit Repo </a>、<a class="ae kw" href="https://github.com/EkaanshArora/Agora-Web-UIKit-RTMP" rel="noopener ugc nofollow" target="_blank">项目repo </a>或<a class="ae kw" href="https://github.com/EkaanshArora/Agora-Cloud-Player-Backend" rel="noopener ugc nofollow" target="_blank">后端repo </a>的错误。</p></div></div>    
</body>
</html>