<html>
<head>
<title>Core Location — Integration with MapKit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">核心位置—与地图工具包集成</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/exordium-c6850a298e6f?source=collection_archive---------14-----------------------#2020-10-12">https://levelup.gitconnected.com/exordium-c6850a298e6f?source=collection_archive---------14-----------------------#2020-10-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/91770f136cba586a691d89c294015610.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vYMM7HQPm5FO8y-_6n2gEQ.jpeg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">照片由<a class="ae jd" href="https://unsplash.com/@delfidelarua7?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">德尔菲·德拉鲁阿</a>在<a class="ae jd" href="https://unsplash.com/s/photos/map?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><div class=""/><h1 id="5872" class="kd ke jg bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">绪论</h1><p id="a6ad" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在这篇文章中，我将带你经历集成核心位置和地图工具包的过程。我们将从这里开始的<a class="ae jd" href="https://rustynailsoftware.com/?utm_source=site&amp;utm_medium=blog&amp;utm_campaign=core_location_mapkit" rel="noopener ugc nofollow" target="_blank">系列的</a>开始。你可以在GitHub 上找到本教程的代码。</p><p id="7419" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">核心位置是Cocoa Touch的一部分，是用于获取用户位置详细信息的框架。位置详细信息有多种不同的用途，如何使用这些信息取决于应用程序的功能。无论你是在构建一个送餐应用程序、音乐会预订系统，还是一个寻找最近浴室的工具，核心位置都将是你产品的关键组成部分。在这种情况下，用户位置将显示在承载地图的视图控制器的中间。</p><p id="c504" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">我们开始吧。</p><h1 id="3c85" class="kd ke jg bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">添加地图</h1><p id="4a9e" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">先从上面提到的回购的<code class="fe me mf mg mh b">mapkit</code>分支说起。您将在<code class="fe me mf mg mh b">ViewController</code>中看到一个新按钮和一个名为<code class="fe me mf mg mh b">MapViewController.</code>的新视图控制器(我已经为您添加了这两个组件，与<code class="fe me mf mg mh b">geocoder</code>分支相比，您可以看到)。</p><p id="cd09" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">在<code class="fe me mf mg mh b">MapViewController</code>中要做的第一件事是添加地图视图，这将是一个<code class="fe me mf mg mh b">MKMapView</code>对象。将该属性添加到<code class="fe me mf mg mh b">MapViewController</code>类中:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="2d66" class="mq ke jg mh b gy mr ms l mt mu">private var mapView: MKMapView!</span></pre><p id="014b" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">接下来要做的事情是创建<code class="fe me mf mg mh b">MapViewController.</code>的布局<code class="fe me mf mg mh b">ViewController</code>类连接到<code class="fe me mf mg mh b">Main.storyboard</code>文件，但是我将通过编程来构建<code class="fe me mf mg mh b">MapViewController</code>。当用代码构建视图控制器接口时，我喜欢将所有的UI工作放在一个<code class="fe me mf mg mh b">setupView</code>方法中，该方法最终调用另一个应用所有自动布局约束的方法。</p><p id="1ca9" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">下面是<code class="fe me mf mg mh b">MapViewController</code>的简单设置:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="5bd3" class="mq ke jg mh b gy mr ms l mt mu">import UIKit<br/>import CoreLocation<br/>import MapKit<br/><br/>class MapViewController: UIViewController {<br/><br/>    // MARK: - Properties<br/>    private var mapView: MKMapView!<br/>    <br/>    // MARK: - Methods<br/>    <br/>    // 1. Complete any user interface work.<br/>    func setupView() {<br/>        mapView = MKMapView()<br/>        mapView.translatesAutoresizingMaskIntoConstraints = false<br/>        view.addSubview(mapView)<br/>        <br/>        applyAutoConstraints()<br/>    }<br/>    <br/>    // 2. Complete any Auto Layout work.<br/>    func applyAutoConstraints() {<br/>        NSLayoutConstraint.activate([<br/>            mapView.topAnchor.constraint(equalTo: view.topAnchor),<br/>            mapView.leadingAnchor.constraint(equalTo: view.leadingAnchor),<br/>            mapView.trailingAnchor.constraint(equalTo: view.trailingAnchor),<br/>            mapView.bottomAnchor.constraint(equalTo: view.bottomAnchor)<br/>        ])<br/>    }<br/>    <br/>    <br/>    // MARK: - Overrides<br/>    override func viewDidLoad() {<br/>        super.viewDidLoad()<br/>        <br/>        // 3. Call the method that sets up the user interface.<br/>        setupView()<br/>    }<br/>}</span></pre><p id="2a1d" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">这里我导入了<code class="fe me mf mg mh b">Core Location</code>和<code class="fe me mf mg mh b">MapKit</code>。导入框架后要做的第一件事是设置用户界面。</p><p id="e06d" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">1.)方法<code class="fe me mf mg mh b">setupView</code>将保存任何涉及设置组件及其属性的UI工作。在这种情况下，我们实例化了<code class="fe me mf mg mh b">MKMapView</code>对象，并将其<code class="fe me mf mg mh b">translatesAutoresizingMaskIntoConstraints</code>设置为<code class="fe me mf mg mh b">false</code>。将该属性设置为<code class="fe me mf mg mh b">false</code>会让UI组件受到自动布局的影响。<a class="ae jd" href="https://developer.apple.com/documentation/uikit/uiview/1622572-translatesautoresizingmaskintoco" rel="noopener ugc nofollow" target="_blank">如Apple的文档</a> ' <strong class="ld jh"> <em class="mv">中所述，如果您想使用自动布局来动态计算视图的大小和位置，您必须将该属性设置为false，然后为视图</em> </strong>提供一组明确、无冲突的约束。只有从<code class="fe me mf mg mh b">UIView</code>继承的对象才能访问<code class="fe me mf mg mh b">translatesAutoresizingMaskIntoConstraints</code>属性。对<code class="fe me mf mg mh b">mapView</code>对象做的最后一件事是将其作为子视图添加到视图中。</p><p id="63af" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">2.)任何需要为UI组件完成的自动布局工作都将在<code class="fe me mf mg mh b">applyAutoConstraints</code>方法中完成。这里，<code class="fe me mf mg mh b">mapView</code>将填充整个屏幕，因为锚都等于视图的相应锚。</p><p id="5250" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">3.)要让这些代码做任何事情，调用<code class="fe me mf mg mh b">viewDidLoad</code>方法中的<code class="fe me mf mg mh b">setupView</code>方法。</p><p id="af83" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">UI设置要做的最后一点是在<code class="fe me mf mg mh b">MapViewController</code>的导航栏上添加一个标题和取消按钮。在调用<code class="fe me mf mg mh b">setupView</code>之前，将以下内容添加到<code class="fe me mf mg mh b">viewDidLoad</code>方法的开头。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="46cc" class="mq ke jg mh b gy mr ms l mt mu">title = "View Your Location"<br/>navigationItem.leftBarButtonItem = UIBarButtonItem(barButtonSystemItem: .cancel, target: self, action: #selector(dismissToMainView))</span></pre><p id="df13" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated"><code class="fe me mf mg mh b">dismissToMainView</code>选择器是位于<code class="fe me mf mg mh b">MapViewController</code>中的物镜C选择器。它只是关闭了当前的视图控制器。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="3fa2" class="mq ke jg mh b gy mr ms l mt mu">@objc func dismissToMainView() {<br/>    dismiss(animated: true, completion: nil)<br/>}</span></pre><h1 id="65ac" class="kd ke jg bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">传递用户的位置</h1><p id="7909" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">为了让用户的位置显示在地图上，它必须从<code class="fe me mf mg mh b">ViewController</code>传递到<code class="fe me mf mg mh b">MapViewController</code>。现在，<code class="fe me mf mg mh b">MapViewController</code>不包含我们可以存储位置的属性——所以添加一个默认访问级别的属性。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="ef4a" class="mq ke jg mh b gy mr ms l mt mu">var userLocation: CLLocation!</span></pre><p id="40ae" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">然后，在<code class="fe me mf mg mh b">ViewController</code>中，类定位到名为<code class="fe me mf mg mh b">viewLocationOnMapButtonPressed</code>的<code class="fe me mf mg mh b">IBAction</code>并且:</p><p id="38f6" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">1.)创建一个<code class="fe me mf mg mh b">MapViewController</code>的实例。<br/> 2。)将当前位置传递给<code class="fe me mf mg mh b">mapViewController</code>的<code class="fe me mf mg mh b">userLocation</code>属性。<br/> 3。)将<code class="fe me mf mg mh b">mapViewController</code>嵌入<code class="fe me mf mg mh b">UINavigationController</code>中，并展示<code class="fe me mf mg mh b">navigationController</code>。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6ad2" class="mq ke jg mh b gy mr ms l mt mu">@IBAction func viewLocationOnMapButtonPressed(_ sender: Any) {<br/>    // 1<br/>    let mapViewController = MapViewController()<br/>    // 2<br/>    mapViewController.userLocation = currentLocation<br/>    // 3<br/>    let navigationController = UINavigationController(rootViewController: mapViewController)<br/>    present(navigationController, animated: true, completion: nil)<br/>}</span></pre><h1 id="e543" class="kd ke jg bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">在地图上显示用户的位置</h1><p id="27bd" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">地图上显示位置之前:<br/> 1。)地图的<code class="fe me mf mg mh b">showsUserLocation</code>属性必须设置为<code class="fe me mf mg mh b">true</code>。<br/> 2。)代理将被设置为<code class="fe me mf mg mh b">self</code>(确保<code class="fe me mf mg mh b">MapViewController</code>与<code class="fe me mf mg mh b">MKMapViewDelegate</code>一致)。<br/> 3。)区域将基于从<code class="fe me mf mg mh b">ViewController</code>传入的用户位置。地图的区域是当前显示在屏幕上的地图的一部分。它的类型是<code class="fe me mf mg mh b">MKCoordinateRegion</code>，将用包含<code class="fe me mf mg mh b">center</code>和<code class="fe me mf mg mh b">span</code>参数的初始化器创建。<code class="fe me mf mg mh b">center</code>将是用户的坐标，<code class="fe me mf mg mh b">span</code>是类型<code class="fe me mf mg mh b">MKCoordinateSpan</code>。该属性定义区域的高度和宽度。较低的增量值将增加地图的缩放级别。</p><p id="fd32" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated"><code class="fe me mf mg mh b">setUpView</code>方法现在应该是这样的:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6f2a" class="mq ke jg mh b gy mr ms l mt mu">func setupView() {<br/>    mapView = MKMapView()<br/>    mapView.translatesAutoresizingMaskIntoConstraints = false<br/>    <br/>    // 1<br/>    mapView.showsUserLocation = true<br/>    // 2<br/>    mapView.delegate = self<br/>    // 3<br/>    mapView.region = MKCoordinateRegion(center: userLocation.coordinate, span: MKCoordinateSpan(latitudeDelta: 0.1, longitudeDelta: 0.1))<br/><br/>    view.addSubview(mapView)   <br/>    applyAutoConstraints()<br/>}</span></pre><p id="18f5" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">最后要做的是在<code class="fe me mf mg mh b">MKMapViewDelegate</code>中实现<code class="fe me mf mg mh b">regionDidChangeAnimated</code>方法，并在区域更新后设置地图的区域。这不是必须的，但是当用户用手指滚动离开他们的位置时，这有助于重新将地图居中。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="ef70" class="mq ke jg mh b gy mr ms l mt mu">extension MapViewController: MKMapViewDelegate {<br/>    func mapView(_ mapView: MKMapView, regionDidChangeAnimated animated: Bool) {<br/>        mapView.setRegion(MKCoordinateRegion(center: userLocation.coordinate, span: MKCoordinateSpan(latitudeDelta: 0.1, longitudeDelta: 0.1)), animated: true)<br/>    }<br/>}</span></pre><p id="f36f" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">如果应用程序正在运行，位置将被获取，点击“查看地图上的位置”按钮——将显示<code class="fe me mf mg mh b">MapViewController</code>,您将在地图中央看到您的位置。使用MapKit还可以做更多的事情，这篇博文只是触及了MapKit是什么以及如何使用它的基础知识。</p><p id="dbe5" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">核心位置与地图工具包完美集成，是任何基于位置的iOS应用程序的关键组件。核心定位还使开发人员能够对GPS坐标进行反向地理编码，并创建人类可读的地址。在我们的博客上了解更多关于使用核心位置<a class="ae jd" href="https://rustynailsoftware.com/dev-blog/core-location-reverse-geocoding-locations-using-clgeocoder?utm_source=site&amp;utm_medium=blog&amp;utm_campaign=core_location_mapkit" rel="noopener ugc nofollow" target="_blank">进行反向地理编码的信息。</a></p><p id="f186" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">你可以在rustynailsoftware.com的<a class="ae jd" href="https://rustynailsoftware.com/dev-blog/" rel="noopener ugc nofollow" target="_blank">阅读更多与iOS开发、自由职业、软件工程等相关的文章。欢迎随时在</a><a class="ae jd" href="https://twitter.com/andrewlundydev" rel="noopener ugc nofollow" target="_blank">推特</a>上联系。或者，<a class="ae jd" href="https://rustynailsoftware.com/andrew-lundy#contact" rel="noopener ugc nofollow" target="_blank">联系</a>如果你正在为你的下一个项目寻找一个可靠的iOS开发者。</p></div></div>    
</body>
</html>