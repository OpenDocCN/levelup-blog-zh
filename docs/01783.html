<html>
<head>
<title>Android UI Test with mocked API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用模拟API的Android UI测试</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/android-ui-test-with-mocked-api-7b8e11f5499c?source=collection_archive---------6-----------------------#2020-01-29">https://levelup.gitconnected.com/android-ui-test-with-mocked-api-7b8e11f5499c?source=collection_archive---------6-----------------------#2020-01-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0701" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Android中的UI测试非常重要，非常有用。它确保应用程序本身在与外部依赖(如API)分离时不会出现任何问题。</p><p id="9533" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">TL；你可以直接去我在GitHub上的库运行应用程序和UI测试。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/9292e50dd2e5d2e85526667262dca211.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E5c3vO-euLnJQeoajzuQmA.jpeg"/></div></div></figure><p id="2d8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有许多不同的方法可以在android上进行UI测试。在本文中，我将使用espresso和mockwebserver来实现它。Espresso是Android UI测试的默认框架。Mockwebserver是我们用来在android测试环境中启动web服务器的库。</p><h1 id="2c69" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">我们做个app吧</h1><p id="3309" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">我将用一个非常简单的例子来解释我们如何让mockwebserver在Android上工作。我们将创建一个带有一个按钮的android应用程序，这个按钮将调用一个API。打开Android Studio，让我们创建一个新项目。在<em class="mb">创建新项目</em>窗口中选择空活动。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mc"><img src="../Images/2a06255fdd08ea8aea08ee599aefd56e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4prtFjHbPYBaR54XLUO6zw.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">创建新项目窗口</figcaption></figure><p id="7756" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在等待gradle同步完成时，我们可以检查项目结构。确保它在<em class="mb"> AndroidManifest.xml </em>上有MainActivity，并且文件存在于src/main/java上。</p><p id="34d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们添加按钮:转到<em class="mb">RES/layout/activity _ main . XML</em>单击组件选项上的按钮，然后将其拖动到屏幕设计。之后，我们可以打开文本选项卡，因为默认情况下它使用的是<em class="mb"> ConstraintLayout </em>，为了简单起见，我们不会更改它。下一步是向textview添加一个id，然后使textview成为new button的约束。完整的代码将如下所示:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="e65d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们继续之前，让我们运行应用程序，以确保一切都在正确的位置。如果一切正常，那么您应该会在模拟器的屏幕上看到以下内容:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/a59e58ed15013761f6fae3ad16855065.png" data-original-src="https://miro.medium.com/v2/resize:fit:676/format:webp/1*dCJgiapx4bChP8RXKabNew.png"/></div></figure><p id="5a55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">祝贺你，拍拍你的背。休息5分钟，喝点咖啡或茶。</p><p id="bdff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们可以继续。现在，我们将使用HttpUrlConnection调用API，HttpUrlConnection是一个android内置库。<strong class="jp ir">这不是调用API </strong>的最佳实践，但为了简单起见在这里使用。我们首先在AndroidManifest.xml中添加新的权限来访问互联网和访问网络状态:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="c1f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是调用API。点击<em class="mb">调用API按钮</em>，然后在按钮顶部的文本视图上显示结果。我们将使用Postman提供的公共API。这个API将为我们提供当前的GMT日期时间，然后我们将在textView上显示它。再次以简单的名义，我们将把一切都放在不是最佳实践的活动上。主活动代码如下所示:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="3feb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，我们的申请都完成了。您可以运行它并单击Call API按钮。它会是这样的:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/c9697c6642335bc7c311e3c350be9de2.png" data-original-src="https://miro.medium.com/v2/resize:fit:676/1*GNSkV13IbcT1QRYKe9Ty0Q.gif"/></div></figure><p id="3dd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太好了，你应该得到一块饼干(网飞最终空间的休说)。我们刚刚上完主菜。我们现在要上主菜了:Android UI测试和mockwebserver。</p><h1 id="61ff" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">让我们写一些测试</h1><p id="e337" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">我知道你们中的一些人会对我大喊这不是TDD，所以这不是最佳实践。在我看来，TDD测试需要快速运行(不到1分钟)以使开发过程高效。这不是UI测试的目的。与测试的全面性相比，UI测试的执行时间是第二重要的。</p><p id="9cc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，请检查您安装了espresso依赖项的项目的<em class="mb"> build.gradle </em>:</p><pre class="kn ko kp kq gt mk ml mm mn aw mo bi"><span id="8b6e" class="mp kz iq ml b gy mq mr l ms mt">androidTestImplementation 'androidx.test.espresso:espresso-core:3.1.1'<br/>androidTestImplementation 'androidx.test:rules:1.1.0'</span></pre><p id="970d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你已经有了它，那么去文件<em class="mb">exampleinstrumentedtest . kt . W</em>我们需要更新这个文件，所以它点击调用API按钮，然后等待它从API得到结果。它看起来像这样:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="2cbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，你可以在Android Studio上点击<em class="mb">类示例InstrumentedTest </em>旁边的绿色箭头，应用程序将运行并执行测试。目前看来不错。</p><h1 id="c8fd" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">让我们嘲笑它</h1><p id="ae8f" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">这是本文有趣且重要的部分。我们想要模仿API的返回值。让我们说，而不是格林威治时间，我们想把固定日期:<em class="mb">星期三，2020年1月29日23:19:51 +1000 </em></p><p id="f820" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一步是我们需要在build.gradle中安装mockwebserver依赖项，它看起来像这样:</p><pre class="kn ko kp kq gt mk ml mm mn aw mo bi"><span id="9323" class="mp kz iq ml b gy mq mr l ms mt">androidTestImplementation 'com.squareup.okhttp3:mockwebserver:4.3.0'</span></pre><p id="2f83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们同步项目的gradle，这样它将获取依赖关系。webmock服务器将运行在<a class="ae kl" href="http://127.0.0.1:8080." rel="noopener ugc nofollow" target="_blank"> <em class="mb"> http://127.0.0.1:8080上。</em> </a> <em class="mb"> </em>然而，我们目前指向的网址是<a class="ae kl" href="https://postman-echo.com/time/now" rel="noopener ugc nofollow" target="_blank">https://postman-echo.com/time/now</a>。所以我们需要更新URL来使用基于构建类型的构建配置(您也可以使用构建风格)。一旦同步过程完成，我们可以将<em class="mb"> build.gradle </em>更新如下:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="86bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们需要将配置和模拟放到<em class="mb"> ExampleInstrumentedTest中。</em>文件的更新将如下所示:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="63f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意前后标注。正如它所呈现的，我们把嘲弄的结果。当我们运行测试(使用绿色箭头)时，它将失败。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mu"><img src="../Images/a713ea2b24f890a82ce2765bab3ba110.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GWnb-26db6DyCHF5LSKivA.png"/></div></div></figure><p id="3e10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，我们不能让它处于失败状态。因此，我们需要更新contains字符串来查找+1000，如下所示:</p><pre class="kn ko kp kq gt mk ml mm mn aw mo bi"><span id="94f6" class="mp kz iq ml b gy mq mr l ms mt">onView(ViewMatchers.withId(R.id.<em class="mb">hello_world</em>))<br/> .check(ViewAssertions.matches(ViewMatchers.withText(StringContains.containsString("+1000"))))</span></pre><p id="2ba1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再次运行它，它将是绿色的。</p><p id="33a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">恭喜你成功地模拟了你的android应用程序的API。</p><h1 id="49f2" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">这之后是什么？</h1><p id="ef88" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">当您的应用程序在增长时，API的复杂性也在增长。Mockwebserver可以使用dispatcher根据请求的路径或参数映射请求和响应，并使用资产返回更复杂的结构，如JSON。</p><p id="1452" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目前就这些。</p><blockquote class="mv mw mx"><p id="9d41" class="jn jo mb jp b jq jr js jt ju jv jw jx my jz ka kb mz kd ke kf na kh ki kj kk ij bi translated">分享是关爱，像爱自己一样爱你的邻居。</p></blockquote></div></div>    
</body>
</html>