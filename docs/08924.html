<html>
<head>
<title>Containerized Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">集装箱化气流</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/containerized-airflow-4148c3044603?source=collection_archive---------2-----------------------#2021-06-19">https://levelup.gitconnected.com/containerized-airflow-4148c3044603?source=collection_archive---------2-----------------------#2021-06-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="d3a1" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">AWS ECS上气流的部署</h1><p id="791e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir">先决条件<br/> </strong> →关于气流和DAG的基本信息<br/> →关于容器和容器部署(ECS、k8s等)的基本概念<br/> → Docker</p><p id="59bb" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">air flow</strong><strong class="kn ir"><br/></strong>air flow是一款开源工具，用于调度和监控工作流。Airflow具有web服务器、调度器和工作节点作为组件，web服务器是交互和监控工作流的UI，调度器调度工作流，工作器执行调度的任务。在气流中，工作流被定义为DAG(有向无环图)</p><p id="7e6d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">动机<br/></strong></p><p id="9e95" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">为了解决这些问题，我们将使用docker映像来发布气流DAGS、插件和配置，作为docker映像的一部分</p><p id="ad52" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">要求</strong></p><ul class=""><li id="7bc3" class="lp lq iq kn b ko lj ks lk kw lr la ls le lt li lu lv lw lx bi translated">一个主节点，其上运行有airflow web服务器和调度程序，并且可以从公共互联网访问airflow web服务器</li><li id="5211" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">可访问主节点的多个工作节点(与主节点运行在同一网络中)</li><li id="a921" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">(CI/CD)将Dag复制到所有工作节点和主节点的＄air flow _ HOME/DAGs/并将插件复制到＄air flow _ HOME/plugin目录</li><li id="1122" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">保持气流变量的机制</li></ul><p id="2f62" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">步骤</strong></p><ul class=""><li id="dced" class="lp lq iq kn b ko lj ks lk kw lr la ls le lt li lu lv lw lx bi translated">打包Dag、插件和配置</li><li id="c3c2" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">展开气流</li><li id="706b" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">Dag、插件和配置的CI/CD</li></ul><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/e97ad1d5984d49dd82ed3441e61cf1ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6x0j0t5hUUQHXkrIo4tKIg.png"/></div></div></figure><h1 id="a2ee" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated"><strong class="ak">第一步(包装)</strong></h1><p id="129a" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">使用Dag和插件创建docker映像<br/>docker文件</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="224d" class="mu jo iq mq b gy mv mw l mx my">ARG BASE_IMAGE<br/>ARG TAG<br/>FROM $BASE_IMAGE:$TAG <br/>COPY ./run-master.sh /opt/ <br/>COPY ./run-worker.sh /opt/<br/>COPY ./dags/ /opt/airflow/dags<br/>COPY ./plugin/ /opt/airflow/plugin/<br/>COPY ./config/ /opt/airflow/config/</span></pre><p id="5b52" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">run-master.sh和run-worker.sh是运行主调度程序和工作程序的脚本</p><p id="1e94" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><code class="fe mz na nb mq b"><strong class="kn ir">run-master.sh</strong></code></p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="b1b2" class="mu jo iq mq b gy mv mw l mx my">airflow initdb<br/>airflow variables --import /opt/airflow/config/*<br/>nohup airflow scheduler &gt;&gt; /opt/airflow/logs/scheduler.logs &amp;<br/>nohup airflow flower &gt;&gt; /opt/airflow/logs/flower.logs &amp;<br/>airflow webserver -p 8080</span></pre><p id="8c5a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">该脚本从/opt/airflow/config/目录导入所有JSON配置(键值对),并将它们保存到airflow变量中，并运行scheduler、flower和webserver</p><p id="5faf" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><code class="fe mz na nb mq b"><strong class="kn ir">run-worker.sh</strong></code></p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="9d19" class="mu jo iq mq b gy mv mw l mx my">airflow initdb<br/>airflow worker</span></pre><p id="8eec" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这将在工作节点上启动气流工作器</p><p id="9772" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">“apache/airflow:latest”可以用作airflow的基础图像</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="07ce" class="mu jo iq mq b gy mv mw l mx my">$ docker build --build-arg BASE_IMAGE=apache/airflow --build-arg TAG=latest -t airflow:1.0.0 .</span></pre><p id="9b9b" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">此命令可用于构建docker映像，将标签作为版本，该版本将是包版本(本例中为1.0.0)</p><h1 id="2f1c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">步骤2(部署)</h1><p id="4aa6" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们将在本文中使用AWS ECS进行部署</p><p id="5c7e" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">要在AWS ECS上部署docker映像，需要一个docker注册表和一个Mysql实例，其中包含一个用于airflow的数据库</p><p id="7d14" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">从AWS控制台创建一个ECR注册表，然后使用</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="110d" class="mu jo iq mq b gy mv mw l mx my">$ aws ecr get-login-password --region &lt;region&gt; | docker login --username AWS --password-stdin &lt;account_id&gt;.ecr.&lt;region&gt;.amazonaws.com</span><span id="b975" class="mu jo iq mq b gy nc mw l mx my">$ docker tag airflow:1.0.0 &lt;ECR_registry_name&gt;:1.0.0 <br/>$ docker push &lt;ECR_registry_name&gt;:1.0.0</span></pre><p id="9ff7" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这将把映像推送到AWS ECS，供AWS ECS稍后使用</p><p id="cc15" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">第二步是为部署创建任务定义<br/>我们将创建两个任务定义，一个用于主任务，一个用于工作任务</p><p id="67fd" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">任务定义主规范</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="ab73" class="mu jo iq mq b gy mv mw l mx my">Network mode: awsvpc<br/>Memory: 4GB<br/>CPU: 2vpcu<br/>Container spec<br/>- Image: &lt;image path from ECR&gt;<br/>- Entry point : ["bash","-c"]<br/>- Command: ["/bin/bash -c '/opt/run-master.sh'"]<br/>- PORT: 8080<br/>ENV variable<br/>- AIRFLOW__CORE__SQL_ALCHEMY_CONN: mysql://&lt;user&gt;:&lt;password&gt;@mysql_uri:3306/&lt;database&gt;<br/>- AIRFLOW__CORE__LOAD_EXAMPLES: False<br/>- AIRFLOW__CORE__EXECUTOR: CeleryExecutor</span></pre><p id="6fd7" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">任务定义工作规范</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="972f" class="mu jo iq mq b gy mv mw l mx my">Network mode: awsvpc<br/>Memory: 4GB<br/>CPU: 2vpcu<br/>Container spec<br/>- Image: &lt;image path from ECR&gt;<br/>- Entry point : ["bash","-c"]<br/>- Command: ["/bin/bash -c '/opt/run-worker.sh'"]<br/>- PORT: 8080<br/>ENV variable<br/>- AIRFLOW__CORE__SQL_ALCHEMY_CONN: mysql://&lt;user&gt;:&lt;password&gt;@mysql_uri:3306/&lt;database&gt;<br/>- AIRFLOW__CORE__LOAD_EXAMPLES: False<br/>- AIRFLOW__CELERY__FLOWER_HOST: airflow.airflow-master<br/>- AIRFLOW__CORE__EXECUTOR: CeleryExecutor</span></pre><p id="95e1" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">定义任务后，部署将需要ECS群集</p><p id="4f3c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">在集群上，我们将添加两个服务，一个用于主服务器，另一个用于辅助服务器</p><p id="245f" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">对于主服务，将需要应用程序负载平衡，以使web服务器在专用子网外可用，并通过主机“airflow.airflow-master”进行服务发现，这已在容器规格的ENV变量中提及，以便工作人员能够与主服务器通信</p><p id="b084" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">常见问题:<br/> → </strong>容器不在私有子网中(如果容器在公共子网中，AWS不允许容器内部的互联网访问)<br/> →主容器和ALB之间的通信<br/>→ALB的健康检查失败，气流给出302 on "/"路由，该路由在ALB中失败，气流的健康检查路径应为"/health "</p><h1 id="09a3" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><ul class=""><li id="93af" class="lp lq iq kn b ko kp ks kt kw nd la ne le nf li lu lv lw lx bi translated">现在，部署版本可用于更容易的回滚</li><li id="d833" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">集装箱化包装确保跨环境的一致性</li><li id="47b0" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">扩展将像增加工人服务的容量一样容易</li><li id="5d16" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">船长和所有工人都可以使用集装箱日志，以防任何工人停止作业，ECS将启动一个新的集装箱；可以在此基础上启用Cloudwatch监控和警报</li></ul><h1 id="b0a5" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">参考</h1><ul class=""><li id="7b85" class="lp lq iq kn b ko kp ks kt kw nd la ne le nf li lu lv lw lx bi translated">阿帕奇气流<a class="ae ng" href="https://airflow.apache.org/docs/apache-airflow/2.0.1/" rel="noopener ugc nofollow" target="_blank">https://airflow.apache.org/docs/apache-airflow/2.0.1/</a></li><li id="cf4e" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">AWS ECS<a class="ae ng" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AmazonECS/latest/developer guide/welcome . html</a></li><li id="577c" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">https://docs.docker.com/get-started/码头工人<a class="ae ng" href="https://docs.docker.com/get-started/" rel="noopener ugc nofollow" target="_blank"/></li></ul></div></div>    
</body>
</html>