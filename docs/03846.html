<html>
<head>
<title>AWS SNS/Lambda with MS Teams</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带MS团队的AWS SNS/Lambda</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/aws-sns-lambda-with-ms-teams-27c36f669b3?source=collection_archive---------11-----------------------#2020-05-29">https://levelup.gitconnected.com/aws-sns-lambda-with-ms-teams-27c36f669b3?source=collection_archive---------11-----------------------#2020-05-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="c8dc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我的设置中，我使用Jenkins作为CI工具来构建和测试docker映像，然后将其推送到ECR，并使用代码Deploy Blue Green部署到ECS服务。</p><p id="f98c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">问题是我不能使用Jenkins的office365ConnectorSend向开发人员宣布ECS已经部署。这是因为Jenkins运行AWS deploy命令行，运行命令行并不意味着新服务会立即部署。熟悉代码部署的人都知道蓝绿色部署需要一段时间，所以HTTP调用必须来自AWS SNS/Lambda，这是一个更可靠的信息源。从CodeDeploy中，您可以准确地告诉您的开发人员code deploy已经开始、成功或失败。</p><p id="8f5d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要开始，你需要在你的MS团队上创建一个连接器，这样你的Lambda函数就有一个URI可以调用。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/d0b2272c34ce6811c04c7eb26f87e3ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QFSI5-mWrBXZ9IDom1Yo4w.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">点击配置传入网络挂钩</figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi le"><img src="../Images/cb8a8768e246d783e16d0976e3a18519.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aIjoa2eYB4vn_Ml2KnKRlQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">给它一个名字</figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lf"><img src="../Images/a2dcd4781ab68f06b1d508fac8336faf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PpL0AXga0bvI4P8k-ztTKw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">复制webhook URL</figcaption></figure><p id="e81e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我设置了这个Lambda脚本来调用微软团队。我用它来创建lambda函数。将webhook粘贴到url变量中。</p><pre class="kp kq kr ks gt lg lh li lj aw lk bi"><span id="ac7b" class="ll lm it lh b gy ln lo l lp lq">import urllib3<br/>import json<br/>import logging<br/>http = urllib3.PoolManager()</span><span id="9be5" class="ll lm it lh b gy lr lo l lp lq">logger = logging.getLogger()<br/>logger.setLevel(logging.INFO)</span><span id="9e22" class="ll lm it lh b gy lr lo l lp lq">def lambda_handler(event, context):<br/>    logger.info("Event: " + str(event["Records"][0]["Sns"]["Message"]))<br/>    url = "&lt;Your MS Teams webhook&gt;"<br/>    message = json.loads(event["Records"][0]["Sns"]["Message"])<br/>    <br/>    deploymentGroupName = message["deploymentGroupName"]<br/>    status = message["status"]<br/>    if status == 'FAILED':<br/>        color_name = '#D50A21'<br/>    elif status == 'SUCCEEDED':<br/>        color_name = '#2eb886'<br/>    else:<br/>        color_name = '#39A3E3'<br/>        <br/>summary = deploymentGroupName + " deployment " + status<br/>    msg = {<br/>    "<a class="ae ls" href="http://twitter.com/type" rel="noopener ugc nofollow" target="_blank">@type</a>": "MessageCard",<br/>    "<a class="ae ls" href="http://twitter.com/context" rel="noopener ugc nofollow" target="_blank">@context</a>": "<a class="ae ls" href="http://schema.org/extensions" rel="noopener ugc nofollow" target="_blank">http://schema.org/extensions</a>",<br/>    "themeColor": color_name,<br/>    "summary": summary,<br/>    "sections": [{<br/>        "activityTitle": "![CodeDeploy](<a class="ae ls" href="https://teamsnodesample.azurewebsites.net/static/img/image5.png)CodeDeploy" rel="noopener ugc nofollow" target="_blank">https://teamsnodesample.azurewebsites.net/static/img/image5.png)CodeDeploy</a> " + deploymentGroupName,<br/>        "activitySubtitle": summary,<br/>        "activityImage": "<a class="ae ls" href="https://teamsnodesample.azurewebsites.net/static/img/image5.png)CodeDeploy" rel="noopener ugc nofollow" target="_blank">https://teamsnodesample.azurewebsites.net/static/img/image5.png</a>",<br/>        "facts": [{<br/>            "name": "Status",<br/>            "value": status<br/>        }],<br/>        "markdown": True<br/>    }]}<br/>    <br/>    encoded_msg = json.dumps(msg).encode('utf-8')<br/>    resp = http.request('POST',url, body=encoded_msg)<br/>    print({<br/>        "message": str(resp),<br/>        # "message": event['Records'][0]['Sns']['Message'], <br/>        "status_code": resp.status, <br/>        "response": resp.data<br/>    })</span></pre><p id="3b49" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请记住，<code class="fe lt lu lv lh b">event[“Records”][0][“Sns”][“Message”]</code>实际上是一个JSON字符串，而不是一个JSON对象。您需要json.loads它，这样您就可以获取嵌套在其中的值。</p><p id="da19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，创建一个SNS主题，并为其订阅lamba函数</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lw"><img src="../Images/5b61b3be5d549b8e8b562bddd8e964ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d1CaDlyNM1rvTPiWeMdx_A.jpeg"/></div></div></figure><p id="87eb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后在CodeDeploy部署组触发器中设置SNS警报</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/3f3db2cf60c7fadc56bf14f27a35e29b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*USELAPhTwcnuIiog4HAvTA.jpeg"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">用事件创建触发器</figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ly"><img src="../Images/eb62bdcb5e2744c65dfc012c5b68093e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rR1gme2vAJCmGt7lxz18Gw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">记住，您需要单击高级箭头来创建触发器</figcaption></figure><p id="bffb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当Code Deploy开始运行时，它会在部署的不同阶段向您发送消息。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lz"><img src="../Images/2b1a78189c3e41ae1964b63c9c532c33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YAFs3lc9pZieba-QdfkNEg.png"/></div></div></figure></div></div>    
</body>
</html>