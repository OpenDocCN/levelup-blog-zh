# ä½¿ç”¨ Terraform Cloud CI/CD æ„å»ºä¸¤å±‚æ¶æ„

> åŸæ–‡ï¼š<https://levelup.gitconnected.com/construct-a-two-tier-architecture-with-terraform-cloud-ci-cd-c64b49c94440>

![](img/c93bd9fc8aee1a2ba57b4dbceb0ee2dc.png)

åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘ä½¿ç”¨ **Terraform Cloud** åœ¨ **AWS** ä¸­éƒ¨ç½²ä¸€ä¸ªä¸¤å±‚æ¶æ„ã€‚ç„¶åæˆ‘ç”¨ Github>terra form Cloud>AWS åˆ¶ä½œäº†ä¸€ä¸ª **CI/CD ç®¡é“**ã€‚è‡ªåŠ¨åŒ–å¯¹ä»£ç è¿›è¡Œæ›´æ–°å¹¶å°†æ›´æ”¹åº”ç”¨åˆ°åŸºç¡€ç»“æ„çš„è¿‡ç¨‹ã€‚

## å…ˆå†³æ¡ä»¶

*   Terraform äº‘å¸æˆ·
*   GitHub å¸æˆ·
*   AWS å¸æˆ·ã€ç®¡ç†æƒé™å’Œå¯†é’¥å¯¹

æˆ‘ä»¬å°†åœ¨ AWS ä¸­æ„å»ºçš„æ¶æ„:

![](img/409e28f85f5eeeaf4265d75272297b7d.png)

è¦å¼€å§‹ï¼Œä½ éœ€è¦ä» GitHub [**åˆ°è¿™é‡Œ**](https://github.com/melisgibson/terraform_project.git) ã€‚å®ƒåŒ…å«ä»¥ä¸‹æ–‡ä»¶ç»“æ„ã€‚

![](img/064ac6a3048385a1c68fbefd1a6b5500.png)

æ–‡ä»¶ç»“æ„

æˆ‘å°†åœ¨ä¸‹é¢å‘æ‚¨å±•ç¤ºæ ¹ç›®å½• *main.tf* ï¼Œè®©æ‚¨äº†è§£æˆ‘ä»¬æ­£åœ¨åˆ›å»ºçš„å†…å®¹ã€‚è¯·éšæ„æ¢ç´¢ä»£ç çš„å…¶ä½™éƒ¨åˆ†ï¼Œå¹¶æ ¹æ®æ‚¨çš„éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚

æ³¨æ„æ‚¨éœ€è¦å°† *key_name* æ›´æ”¹ä¸ºæ‚¨è‡ªå·±çš„å¯†é’¥å¯¹ã€‚

ä»æ ¹ main.tf å¯ä»¥çœ‹åˆ°å®ƒå¼•ç”¨äº† 3 ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼›*è”ç½‘*ã€*è´Ÿè½½å‡è¡¡*å’Œ *ec2* ã€‚

*   *ç»„ç½‘*:æ„å»ºä¸€ä¸ªæœ‰ 3 ä¸ªç§æœ‰å­ç½‘å’Œ 3 ä¸ªå…¬æœ‰å­ç½‘çš„ VPCã€‚å®ƒåˆ›å»ºäº†äº’è”ç½‘ç½‘å…³ã€NAT ç½‘å…³å’Œå¼¹æ€§ IPã€‚ç”Ÿæˆè·¯ç”±è¡¨å’Œè·¯ç”±è¡¨å…³è”ï¼Œå°† internet æµé‡å®šå‘åˆ°å…¬å…±å­ç½‘ï¼Œç„¶åé€šè¿‡ NAT ç½‘å…³å®šå‘åˆ°ç§æœ‰å­ç½‘ã€‚è¯¥æ¨¡å—è¿˜ä¸ºå…¬å…±å­ç½‘å®ä¾‹ã€ç§æœ‰å­ç½‘å®ä¾‹å’Œè´Ÿè½½å¹³è¡¡å™¨åˆ›å»ºå®‰å…¨ç»„ã€‚
*   *è´Ÿè½½å‡è¡¡*:è¯¥æ¨¡å—è®¾è®¡é¢å‘äº’è”ç½‘çš„åº”ç”¨è´Ÿè½½å‡è¡¡å™¨ï¼Œä»¥åŠç›®æ ‡ç»„å’Œç›‘å¬å™¨ã€‚ALB ä½äºå…¬å…±å­ç½‘ä¸­ï¼Œä¼šå°†æµé‡å¯¼å‘ç§æœ‰å­ç½‘ã€‚ç›®æ ‡ç»„æ˜¯åœ¨ *EC2* æ¨¡å—ä¸­åˆ›å»ºçš„ç§æœ‰ EC2 å®ä¾‹çš„è‡ªåŠ¨ç¼©æ”¾ç»„ã€‚
*   *EC2* :ä¸ºå…¬å…±å­ç½‘ä¸­çš„å•ä¸ªå®ä¾‹æ„å»ºå¯åŠ¨æ¨¡æ¿å’Œè‡ªåŠ¨ç¼©æ”¾ç»„ã€‚è¿™ä¸ªå®ä¾‹æ˜¯æˆ‘ä»¬çš„å ¡å’ä¸»æœºï¼Œå¦‚æœå‡ºç°æ•…éšœï¼Œå®ƒå°†å‘å¤–æ‰©å±•ã€‚ä¸å ¡å’ä¸»æœºç›¸å…³è”çš„å®‰å…¨ç»„åªå…è®¸ SSH æµé‡ã€‚EC2 æ¨¡å—è¿˜ä¸º web æœåŠ¡å™¨æˆ–ä¸“ç”¨å­ç½‘åˆ›å»º ASGï¼Œæ‰€éœ€å®¹é‡ä¸º 3ã€‚æ¯ä¸ªå¯ç”¨æ€§åŒºåŸŸä¸­æœ‰ä¸€ä¸ªå®ä¾‹ã€‚web æœåŠ¡å™¨å®ä¾‹çš„å®‰å…¨ç»„åªå…è®¸æ¥è‡ªåœ¨*è´Ÿè½½å¹³è¡¡*æ¨¡å—ä¸­åˆ›å»ºçš„ ALB çš„æµé‡ã€‚

æ‰€æœ‰çš„æ¨¡å—éƒ½åŒ…å«å˜é‡å’Œè¾“å‡ºä»¥ç›¸äº’å¼•ç”¨ã€‚å®ƒä»¬å…±åŒåä½œæ¥æ„å»ºä¸¤å±‚ä½“ç³»ç»“æ„ã€‚æˆ‘è¿™æ ·å†™ä»£ç æ˜¯ä¸ºäº†å¢åŠ å¯é‡ç”¨æ€§ã€‚

ç°åœ¨æˆ‘ä»¬å·²ç»è®¾ç½®å¥½äº†æ‰€æœ‰ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ä½¿ç”¨ Terraform Cloud äº†ã€‚åœ¨æ‚¨çš„ Terraform Cloud å¸æˆ·ä¸­ï¼Œæ‚¨éœ€è¦è®¾ç½®ä¸€ä¸ªæ–°ç»„ç»‡ã€‚å‘½åä½ çš„ç»„ç»‡å¹¶ç‚¹å‡»*åˆ›å»ºç»„ç»‡*ã€‚ç„¶åä¼šæç¤ºä½ åˆ›å»ºä¸€ä¸ªå·¥ä½œåŒºï¼Œé€‰æ‹©*ç‰ˆæœ¬æ§åˆ¶å·¥ä½œæµ*ã€‚

![](img/32f9c95f85f88008648927f102e50a69.png)

æ¥ä¸‹æ¥ï¼Œæ‚¨å°†é€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬æ§åˆ¶æä¾›ç¨‹åºã€‚ä½ ä¼šé€‰æ‹©*GitHub>GitHub.com*ã€‚

![](img/92dd40b3ac0cf4fd5ec167bda943fa8d.png)

ç„¶åï¼Œæ‚¨éœ€è¦å…è®¸ Terraform è®¿é—®æ‚¨çš„ GitHub å¸æˆ·ã€‚æ‚¨å¯èƒ½éœ€è¦æš‚æ—¶ç¦ç”¨å¼¹å‡ºçª—å£é˜»æ­¢ç¨‹åºã€‚æ¥ä¸‹æ¥ï¼Œæ‚¨å¯ä»¥é€‰æ‹©æƒ³è¦ä½¿ç”¨çš„å­˜å‚¨åº“ã€‚

![](img/c375b718e98cf61956570cde987f8e64.png)

ç‚¹å‡» *Install* ï¼Œæ‚¨é€‰æ‹©çš„ repo å°†è¢«å¡«å……ã€‚ç°åœ¨ä½ å¯ä»¥ç‚¹å‡»*åˆ›å»ºå·¥ä½œç©ºé—´*ã€‚ç„¶åå¯ä»¥æ·»åŠ ç¯å¢ƒå˜é‡: *AWS_ACCESS_KEY_IDï¼ŒAWS_SECRET_ACCESS_KEYï¼ŒAWS_DEFAULT_REGIONã€‚*åœ°å½¢å˜é‡: *access_ip = 0.0.0.0/0ã€‚*

![](img/62ef94fc14689277abb898bf949674f1.png)

æ ‡è®°ä¸ºæ•æ„Ÿ

ç°åœ¨å˜é‡å·²ç»è®¾ç½®å¥½ï¼Œæ‚¨å¯ä»¥å¯¼èˆªåˆ°å±å¹•çš„å³ä¸Šè§’å¹¶é€‰æ‹©*åŠ¨ä½œ>å¼€å§‹æ–°çš„è¿è¡Œ*ã€‚

![](img/ec4e1f9865de0581f08575e9e29ba953.png)

é€‰æ‹©*è®¡åˆ’å¹¶åº”ç”¨*è¿è¡Œç±»å‹ï¼Œç„¶åç‚¹å‡»*å¼€å§‹è¿è¡Œ*ã€‚

![](img/ad182f18552e673ea9b2a0b552fff78e.png)

è¯¥è®¡åˆ’å°†è‡ªåŠ¨å¯åŠ¨ã€‚æˆåŠŸåï¼Œæ‚¨çš„å±å¹•å°†å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](img/e73debcb9e54dbe92f9b5399b256b10d.png)

æ­£åœ¨åˆ›å»º 33 ä¸ªèµ„æºã€‚

è¿™å®é™…ä¸Šæ˜¯`terraform plan`å‘½ä»¤ã€‚å¦‚æœå®ƒçœ‹èµ·æ¥ä¸é”™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç»§ç»­ç”³è¯·ã€‚å•å‡»â€œåº”ç”¨â€åï¼Œå°†å¼€å§‹åˆ›å»ºèµ„æºã€‚ä½ å¯ä»¥çœ‹ç€å®ƒè¢«å®Œæˆï¼

![](img/22ab50947a86c870aafac81d1d7884db.png)

å½“å®ƒå®Œæˆæ—¶ã€‚

![](img/2e09c1c7f6f9445e865ac2dd76f13bb9.png)

è¦æŸ¥çœ‹æˆ‘ä»¬çš„èµ„æºï¼Œè¯·å‰å¾€ AWS æ§åˆ¶å°ã€‚

![](img/b1b5cfd169d9f6bb16a18824c56ea36f.png)

å®ä¾‹è¿è¡Œåœ¨ 3 ä¸ª az ä¸­ï¼Œ3 ä¸ªç§æœ‰ï¼Œ1 ä¸ªå…¬å…±(bastion)ã€‚

![](img/c325089c8a4c6e014bc5ff0a74e3ed84.png)

å…·æœ‰ 3 ä¸ªå¥åº·å®ä¾‹çš„ ALB çš„ç›®æ ‡ç»„ã€‚

![](img/a3b5c5ea4b88c115663a911e6e46a78d.png)

ALBï¼Œå¤åˆ¶ DNS

è¦æ£€æŸ¥æˆ‘ä»¬çš„è´Ÿè½½å¹³è¡¡å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œè¯·å°† DNS ç²˜è´´åˆ°æµè§ˆå™¨ä¸­ã€‚åº”è¯¥ä¼šå‡ºç°ä»¥ä¸‹é¡µé¢ã€‚

![](img/195180167a7bec25a59d8c160d7293d4.png)

ç°åœ¨ï¼Œä¸ºäº†ç¡®è®¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ SSH è®¿é—®æˆ‘ä»¬çš„ Bastion ä¸»æœºå®ä¾‹ã€‚bastion ä¸»æœºå®ä¾‹å……å½“ç§æœ‰å­ç½‘ä¸­å®ä¾‹çš„è·³è½¬ä¸»æœºã€‚æˆ‘å°†ä½¿ç”¨`ssh -A`æ¥ä¼ é€’æˆ‘çš„è®¿é—®å¯†é’¥ã€‚

![](img/c1ae86db74c022b6fe15fdd3527ac130.png)

æˆ‘ä»¬ç°åœ¨åœ¨ Bastion ä¸»æœºå®ä¾‹ä¸­ã€‚è¦è®¿é—®ç§æœ‰å®ä¾‹ï¼Œä» Bastion å®ä¾‹å¤åˆ¶ç§æœ‰ IP åœ°å€å’Œ SSHã€‚

![](img/bdd9691315ad5d8b665d8e54a778cd5b.png)

æˆ‘ä»¬ç°åœ¨å·²ç»æˆåŠŸåœ°è®¿é—®äº†ç§æœ‰å®ä¾‹ã€‚

å°†æ¥ï¼Œå¦‚æœæ‚¨æˆ–æ‚¨çš„å›¢é˜Ÿæƒ³è¦å¯¹åŸºç¡€æ¶æ„è¿›è¡Œæ›´æ”¹ï¼Œæ‚¨å¯ä»¥è‡ªåŠ¨åŒ–è¿™ä¸€è¿‡ç¨‹ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦è®© Terraform Cloud åœ¨ä»£ç å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨å¯¹æˆ‘ä»¬çš„åŸºç¡€è®¾æ–½è¿›è¡Œæ›´æ”¹ã€‚å¯¼èˆªè‡³ Terraform cloud å·¥ä½œç©ºé—´ä¸­çš„*è®¾ç½®*ã€‚å‘ä¸‹æ»šåŠ¨å¹¶å°†*åº”ç”¨æ–¹æ³•*æ›´æ”¹ä¸º*è‡ªåŠ¨åº”ç”¨*ã€‚

![](img/cf320c11ec8a84953e76e2669d3257fe.png)

ç„¶åç‚¹å‡»*ä¿å­˜è®¾ç½®*ã€‚ç°åœ¨ï¼Œä¸ºäº†æµ‹è¯•è¿™æ˜¯å¦å¯è¡Œï¼Œæˆ‘å°†åœ¨ GitHub ä¸­ç¼–è¾‘ä»£ç ã€‚æˆ‘å°†æ›´æ”¹ç”¨æˆ·æ•°æ®æ–‡ä»¶å¹¶æäº¤æ›´æ”¹ã€‚

![](img/db668ae5fc67b1ba619f61b16f83668c.png)

å›åˆ° Terraform cloudï¼Œä½ å¯ä»¥çœ‹åˆ° GitHub è‡ªåŠ¨åšå‡ºå’Œåº”ç”¨çš„æ›´æ”¹ï¼

![](img/11732fe579b3db7c2479f1f954fe8c24.png)

è§„åˆ’

![](img/dd200689cc7435aa547cb1ccfff0b28e.png)

åº”ç”¨çš„æ›´æ”¹

è®©æˆ‘ä»¬å›åˆ° AWS æ§åˆ¶å°ã€‚é¦–å…ˆè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘çš„è‡ªåŠ¨ç¼©æ”¾ç»„æ˜¯å¦é€šè¿‡ç»ˆæ­¢ä¸€ä¸ªå®ä¾‹æ¥å·¥ä½œã€‚

![](img/ed16549a795fc8aae95bd9a3f4a40b33.png)

ç»ˆæ­¢çš„å®ä¾‹

åº”è¯¥ä¼šå¡«å……ä¸€ä¸ªæ–°å®ä¾‹ã€‚

![](img/0ab381b5751fd936158be04eb0bdf595.png)

å‘å¤–æ‰©å±•ï¼Œåˆ›å»ºæ–°å®ä¾‹

è¿™ä¸ªæ–°å®ä¾‹å°†æ‹¥æœ‰æ›´æ–°çš„ç”¨æˆ·æ•°æ®ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­åˆ·æ–°å‡ æ¬¡ DNSï¼Œåº”è¯¥ä¼šå‡ºç°â€œæ›´æ–°â€é¡µé¢ã€‚

![](img/e40e9dfac19b5145be992cf6dd8768f5.png)

è‡ªåŠ¨æ›´æ–°æˆåŠŸï¼

ç°åœ¨ï¼Œè¦é”€æ¯æˆ‘ä»¬çš„åŸºç¡€æ¶æ„ï¼Œè¯·é€‰æ‹©*è®¾ç½®>é”€æ¯å’Œåˆ é™¤>é˜Ÿåˆ—é”€æ¯è®¡åˆ’ã€‚*

![](img/62a64d3930e4ef651a99e7ee64575815.png)

è¿™å°†è®¡åˆ’é”€æ¯ï¼Œç„¶åæ‚¨éœ€è¦ç¡®è®¤å¹¶åº”ç”¨é”€æ¯ã€‚

![](img/7490658b051cf1b8f89226ba66ff38c0.png)

é”€æ¯å·²å®Œæˆã€‚

![](img/a6951a16b9effafeaa25c68c14942601.png)

æ€»ä¹‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ GitHubã€Terraform cloud å’Œ AWS åˆ›å»ºäº†ä¸€ä¸ª CI/CD ç®¡é“ã€‚æˆ‘ä»¬åœ¨ AWS ä¸­æ„å»ºäº†ä¸€ä¸ªä¸¤å±‚æ¶æ„ï¼Œå¯¹å®ƒè¿›è¡Œäº†ä¸€äº›æµ‹è¯•ä»¥ç¡®ä¿å®ƒèƒ½å¤Ÿå·¥ä½œï¼Œç„¶åæ‹†é™¤äº†å®ƒã€‚æ„Ÿè°¢è·Ÿéšã€‚

# åˆ†çº§ç¼–ç 

æ„Ÿè°¢æ‚¨æˆä¸ºæˆ‘ä»¬ç¤¾åŒºçš„ä¸€å‘˜ï¼åœ¨ä½ ç¦»å¼€ä¹‹å‰:

*   ğŸ‘ä¸ºæ•…äº‹é¼“æŒï¼Œè·Ÿç€ä½œè€…èµ°ğŸ‘‰
*   ğŸ“°æ›´å¤šå†…å®¹è¯·æŸ¥çœ‹[å‡çº§ç¼–ç åˆŠç‰©](https://levelup.gitconnected.com/?utm_source=pub&utm_medium=post)
*   ğŸ””å…³æ³¨æˆ‘ä»¬:[æ¨ç‰¹](https://twitter.com/gitconnected) | [LinkedIn](https://www.linkedin.com/company/gitconnected) | [æ—¶äº‹é€šè®¯](https://newsletter.levelup.dev)

ğŸš€ğŸ‘‰ [**åŠ å…¥å‡çº§äººæ‰é›†ä½“ï¼Œæ‰¾åˆ°ä¸€ä»½ç¥å¥‡çš„å·¥ä½œ**](https://jobs.levelup.dev/talent/welcome?referral=true)