<html>
<head>
<title>Circuit Breaker Example in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang的断路器示例</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/circuit-breaker-example-in-golang-e6459c87eaeb?source=collection_archive---------0-----------------------#2022-06-02">https://levelup.gitconnected.com/circuit-breaker-example-in-golang-e6459c87eaeb?source=collection_archive---------0-----------------------#2022-06-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/8cd856dd90ea43ad45d82be9a4c5cb77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*u5EBd3_CveUVdiSq"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">阿尼鲁德·雷迪在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="154d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在微服务架构中，一个服务通常调用其他服务来检索数据，上游服务有可能会关闭。如果问题是由暂时网络问题或暂时不可用引起的，客户端服务可以重试请求几次来解决问题。</p><p id="4a47" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，可能会出现其他严重的问题，例如数据库中断或服务没有快速响应。在这种情况下，太多注定失败的重复请求可能会导致整个系统的<strong class="ki iu">级联故障</strong>。</p><p id="05c9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所以，救援来了:<strong class="ki iu">断路器</strong>。这是一种允许您保护您的服务在短时间内不执行太多请求的机制。</p><p id="a4b3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇文章中，我将在一个真实的例子中展示如何使用<a class="ae kf" href="https://github.com/sony/gobreaker" rel="noopener ugc nofollow" target="_blank"><em class="le">gobreaker</em></a><em class="le"/>库来实现断路器模式。</p><p id="bd24" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们开始吧！</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><h1 id="c926" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">概念概述</h1><h2 id="c5f6" class="mk ln it bd lo ml mm dn ls mn mo dp lw kr mp mq ma kv mr ms me kz mt mu mi mv bi translated">三种状态</h2><p id="5599" class="pw-post-body-paragraph kg kh it ki b kj mw kl km kn mx kp kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">断路器有三种不同的状态，闭合、断开和半开。</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/333c7a0f9bb614e2c5dc11857fb11c99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*H9kEJg-TMT5YE1yEVgc9aA.jpeg"/></div></figure><ul class=""><li id="cc18" class="ng nh it ki b kj kk kn ko kr ni kv nj kz nk ld nl nm nn no bi translated"><strong class="ki iu">关闭</strong> —所有请求都被允许传递给上游服务。</li><li id="8f58" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated"><strong class="ki iu">打开</strong> —所有请求都不允许传递给上游服务。</li><li id="d944" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated"><strong class="ki iu">半开</strong> —为了确定上游服务是否恢复，断路器将只允许少量请求在此状态下通过。</li></ul><p id="9731" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">状态变化</strong></p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nu"><img src="../Images/d78bc794dd9a96a5aa2982d7fd3260b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NL1JUDCDs_HA947e.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">图片来自<a class="ae kf" href="https://banzaicloud.com/docs/backyards/traffic-management/circuit-breaking/" rel="noopener ugc nofollow" target="_blank">链接</a></figcaption></figure><ul class=""><li id="a81f" class="ng nh it ki b kj kk kn ko kr ni kv nj kz nk ld nl nm nn no bi translated"><strong class="ki iu">合分</strong> —断路器处于闭合状态；当失败的请求超过阈值时，断路器将变为断开状态。</li><li id="1d6a" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated"><strong class="ki iu">打开至半开</strong> —断路器处于打开状态；当经过一定的超时时间后，断路器将变为半开状态。</li><li id="d168" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated"><strong class="ki iu">半开打开</strong> —断路器处于半开状态；当对上游服务的请求仍然失败时，断路器将再次变为打开状态。</li><li id="5ecb" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated"><strong class="ki iu">半开转合</strong> —断路器处于半开状态；当一定数量的预定义请求成功时，断路器将变为闭合状态。</li></ul><h2 id="4fc3" class="mk ln it bd lo ml mm dn ls mn mo dp lw kr mp mq ma kv mr ms me kz mt mu mi mv bi translated">请求计数</h2><p id="ce34" class="pw-post-body-paragraph kg kh it ki b kj mw kl km kn mx kp kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">断路器保存请求的数量及其成功/失败。</p><pre class="nc nd ne nf gt nv nw nx ny aw nz bi"><span id="c489" class="mk ln it nw b gy oa ob l oc od">type Counts struct {<br/>    Requests             uint32<br/>    TotalSuccesses       uint32<br/>    TotalFailures        uint32<br/>    ConsecutiveSuccesses uint32<br/>    ConsecutiveFailures  uint32<br/>}</span></pre><h1 id="8a9a" class="lm ln it bd lo lp oe lr ls lt of lv lw lx og lz ma mb oh md me mf oi mh mi mj bi translated">动手示例</h1><h2 id="cb6f" class="mk ln it bd lo ml mm dn ls mn mo dp lw kr mp mq ma kv mr ms me kz mt mu mi mv bi translated">计算机网络服务器</h2><p id="a401" class="pw-post-body-paragraph kg kh it ki b kj mw kl km kn mx kp kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">在我们的示例中，我们有一个运行在端口8080上的HTTP服务器作为上游服务。为了模拟上游服务关闭，我们在启动的前5秒钟向客户端返回一个500错误代码。</p><figure class="nc nd ne nf gt ju"><div class="bz fp l di"><div class="oj ok l"/></div></figure><h2 id="b4d1" class="mk ln it bd lo ml mm dn ls mn mo dp lw kr mp mq ma kv mr ms me kz mt mu mi mv bi translated">客户</h2><p id="8e6c" class="pw-post-body-paragraph kg kh it ki b kj mw kl km kn mx kp kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">我们定义了一个简单的函数来调用客户端的上游服务。</p><figure class="nc nd ne nf gt ju"><div class="bz fp l di"><div class="oj ok l"/></div></figure><h2 id="d2cd" class="mk ln it bd lo ml mm dn ls mn mo dp lw kr mp mq ma kv mr ms me kz mt mu mi mv bi translated">主要功能</h2><p id="f1a9" class="pw-post-body-paragraph kg kh it ki b kj mw kl km kn mx kp kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">在<code class="fe ol om on nw b">main</code>功能中，我们首先用其配置初始化断路器。</p><ul class=""><li id="fdb9" class="ng nh it ki b kj kk kn ko kr ni kv nj kz nk ld nl nm nn no bi translated"><code class="fe ol om on nw b">Name</code>是断路器的名称</li><li id="836e" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated"><code class="fe ol om on nw b">MaxRequests</code>是断路器半开时允许通过的最大请求数。</li><li id="fd98" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated"><code class="fe ol om on nw b">Interval</code>是断路器清除内部计数的闭合状态循环周期。</li><li id="2409" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated"><code class="fe ol om on nw b">Timeout</code>是断开状态的周期，在此之后，断路器的状态变为半开。</li><li id="e3ee" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">当请求在关闭状态下失败时，就会调用<code class="fe ol om on nw b">ReadyToTrip</code>。如果该函数返回true，断路器将进入打开状态。</li><li id="d55f" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">每当断路器状态改变时，调用<code class="fe ol om on nw b">OnStateChange</code>。</li></ul><p id="6f1e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们向上游服务发出100个请求，并观察断路器的状态变化。</p><figure class="nc nd ne nf gt ju"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="ed6f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://gist.github.com/jerryan999/bcfdd746f3f8c2c11c3d27f1b65dfcf3?file=circuit-breaker-full.go" rel="noopener ugc nofollow" target="_blank">完整代码</a></p><h2 id="f744" class="mk ln it bd lo ml mm dn ls mn mo dp lw kr mp mq ma kv mr ms me kz mt mu mi mv bi translated">结果解释</h2><p id="29ea" class="pw-post-body-paragraph kg kh it ki b kj mw kl km kn mx kp kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">在第一秒钟，断路器发现上游服务连续失败三次以上；它从关闭状态切换到打开状态。</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oo"><img src="../Images/fe3d1b09405a0433857c04901c7fc1f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FUqdtuh_XVFaPiW2hE825Q.png"/></div></div></figure><p id="27bf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">超时时间过后，断路器将切换到半开状态。</p><p id="d95b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当以下请求从上游服务返回错误时，断路器切换到断开状态。</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi op"><img src="../Images/3132c9719b476c4109787d171d592fca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iWoqGWUCnzGEcoh7V6L__Q.png"/></div></div></figure><p id="712e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当上游恢复时，断路器通过连续发出三次成功请求来观察这种变化。然后它切换到关闭状态。</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oq"><img src="../Images/7a2bb2dd8840008282e72dc02d570933.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XwfP8IXUWYwqzZQ_xZA97A.png"/></div></div></figure><h1 id="380f" class="lm ln it bd lo lp oe lr ls lt of lv lw lx og lz ma mb oh md me mf oi mh mi mj bi translated">结论</h1><p id="d94e" class="pw-post-body-paragraph kg kh it ki b kj mw kl km kn mx kp kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">希望这篇文章已经让您认识到断路器模式是如何在现实应用中使用的。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="32a5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我希望你喜欢读这篇文章。如果你愿意支持我成为一名作家，考虑成为<a class="ae kf" href="https://jerryan.medium.com/membership" rel="noopener">一名媒体成员</a>。你还可以无限制地访问媒体上的每个故事。</p></div></div>    
</body>
</html>