# 酥脆的(作为一种好糕点)测试。

> 原文：<https://levelup.gitconnected.com/flaky-as-a-good-pastry-tests-e9c8f8ec4d13>

![](img/0fcc1f9c60c4a70714453249e7fbd05e.png)

照片由[梅姆](https://unsplash.com/@picoftasty?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

前段时间我在面试一群 SDET 的工程师。我问他们的一个标准问题是关于古怪的测试。他们看到他们了吗/你是如何处理他们的？

这个问题几乎是一个试金石。每个人都有古怪的测试(尤其是当你有复杂的端到端测试时)。甚至简单的单元测试也很容易出问题。

最有趣的部分是听听人们是如何处理的。

个人故事。当我在俄克拉荷马州呆了一段时间后，我负责管理 Eng 生产力团队。一个(可能是最重要的职责)团队正在开发/运营一个本土的 CI 系统。片状测试的问题是最重要的。有大约 20k 的测试可用于 monolith，你有大约 2/3 的概率踩在一个片状的测试上。

[蒂姆·塞科尔和我花了很长时间讨论/辩论如何解决这个问题。](https://www.linkedin.com/in/timsecor/)

接下来，我将谈谈我们当时发现的一些想法/解决方案，以及我后来读到/想到的一些事情。

顺便说一句。像往常一样，不要期待魔法。一切都比较直白和务实。

# 不要

![](img/193428d8b88703b0232b438b04344efc.png)

桑迪·米勒在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

在开始之前，你应该做什么。这是一件你不应该做的简单事情。

**重新运行**

重播是一大禁忌。无论是自动还是手动。就像尤达说的，“重播会导致恐惧。恐惧导致愤怒。愤怒导致仇恨等等”。

重播感觉太自然了。就在那里。只需点击一下，你就能得到一个绿色建筑。显而易见的问题是，你只是将问题掩盖起来，而不是修正一些不可靠的测试。而且会越积越多。

例如，当我加入 Okta 的 Eng Productivity 团队时，我们对失败的测试自动进行了三次重新测试。我们花了一段时间才从这个整体中挖掘出来(因为它让成百上千的片状测试积累起来，并且没有得到解决)。

顺便说一句。我不是说你应该停止所有的重播。如果你在这条路上走得很远(使用重播)，你将无法戒掉冷火鸡。然而，你真的想放松一下。

**不要认为是测试代码坏了。**

这几乎是重播的延续。人们使用重新运行是因为他们认为测试代码被破坏了(相对于生产代码)。然而，想象一下你的生产代码在这个地方有 30%的几率失败。CI 显示了您对它闪烁的红色警报，而您没有修复产品代码，只是忽略了它。你真的想让它投入生产，让客户这一次发出红色警告信号吗？

**做得太多的测试**

我见过试图做太多事情的测试(在一行中)。这在端到端测试中尤其常见。通常的说法是，“测试设置又长又复杂，所以我们不想对每个测试都这样做。因此，让我们将所有这些测试放在一个超级测试中。”

是的。您赢得了计算机时间，却失去了测试的简单性/可重复性(以及大量的工程时间)。

# 磁盘操作系统

![](img/0642dba4ee61c28d0ed3f1db1a45fc45.png)

照片由[尼图·拉德哈](https://unsplash.com/@neetuladdha83?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

**修正你的古怪测试**

这听起来很明显。但是，你真的需要在这些事情上花时间。如果您正处于旅程的起点，这一点尤其正确(不要让数百个古怪的测试积累起来)。

然而，我知道这并不总是可能的。有时你无法修复它，因为你无法在本地复制它，和/或它千载难逢地发生一次，你只是没有足够的线索来搞清楚它。

然而，总的来说，你想解决的问题比引入的问题多。

保持你的测试代码干净。

通常情况下，生产代码会得到很好的处理。和测试代码被当作三等公民对待。

公平地说，我的测试可能无法赢得选美比赛，但它们简单/可读，等等。

糟糕/难闻且复杂的测试代码通常会导致脆弱(在更干净的代码中更容易发现)。

**统计是你的朋友**

我们几乎立即开始做的事情之一(回到 Okta)是获取每次测试失败频率的统计数据。这很有帮助。如果你有一个很大的测试库，你不想开始修复那些只有 0.1%失败的测试。相反，您希望从失败率为 30%的测试开始。(只是为了让你的钱发挥更大的作用)。

**找出如何只运行你需要的测试**

这里让我用两边的嘴说话。一方面，微服务很好，因为你有明确的界限，因此，你只能运行与该服务相关的测试。

另一方面，测试的大部分问题发生在端到端的场景中(相对于单元测试)。而且端到端的测试会跨越多个微服务，所以微服务架构并没有完全去除这个问题。

但是，退一步讲。假设你不需要为特定的变更运行一些测试(因为它们不相关)，就不要运行。您不希望在不相关的测试上花费周期(特别是如果它们不在您的职责范围内)。

**尊重测试金字塔**

有一个经典的测试金字塔，我已经在几篇文章中提到过(包括[构建高质量的软件](https://medium.com/nerd-for-tech/building-high-quality-software-1efa45c719bc))。这个想法是你应该有大量的单元测试，更少的集成测试，甚至更少的端到端测试。单元测试应该很快，而且(大多数时候)它们是防弹的。集成测试更慢，通常失败的可能性更大，端到端测试甚至更慢，失败的可能性更大。

因此，你真的希望进行大量的单元测试，因为这可以让你的测试更加健壮，端到端的测试应该放在最上面。

**有时候取消测试没关系。**

请-请小心点。这通常是最后的手段。通常，测试有一个正值。它们防止倒退，让我们充满信心地前进。然而，我看到了一些写得很差的测试，失败的概率很高，这被容忍了很长时间(使用重新运行)。它们肯定有严重的负面价值(因此，有时删除它们是可以的)。

显然，修复或重写它们更好。然而，同样，在一些特殊情况下删除测试是可以的。(万不得已的事情)。

顺便说一句。我总是支持两件事情中的一件——要么修改测试，要么删除它，永远不要注释掉它。把事情注释掉会产生一个非常奇怪的中间地带。

# 最后的想法

![](img/fb77c3c830593e6ecf36a00f91ede8be.png)

照片由 [Kate Remmer](https://unsplash.com/@studioktr?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

易出问题的测试将永远不会离开你。它会在疯狂的情况下一次又一次地露出它丑陋的头。

这里最重要的部分不是根除问题(这是不可能的),而是持续地阻止它。

一个简单的经验法则是，你的项目应该至少有 95%的时间是绿色构建的(如果你只是继续重新运行它)。如果失败的次数比这还多，那么开始花费额外的周期来解决这些问题是有好处的。

可能还要重复一遍。我不是圣人。我从事的一些项目在回家的路上都是绿色的，而一些问题与古怪的测试有关，我在相当长的一段时间里没有注意到这些问题。

最终，这是一个务实的决定。创建测试是为了减少手动测试、回归的时间(以及所有相关的费用)。在大多数情况下，您在 it 方面的投资会获得数倍的回报，但最终您会判断什么时候足够的投资是足够的。