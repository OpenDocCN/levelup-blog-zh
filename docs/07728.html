<html>
<head>
<title>The Way To Use Pre-Commit For Reliable Terraform Code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为可靠的Terraform代码使用预提交的方法</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/produce-reliable-terraform-code-with-pre-commit-hooks-d263bc332e6a?source=collection_archive---------20-----------------------#2021-03-07">https://levelup.gitconnected.com/produce-reliable-terraform-code-with-pre-commit-hooks-d263bc332e6a?source=collection_archive---------20-----------------------#2021-03-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="84be" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在您的CI/CD中运行代码搜索和扫描程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f6dc44a0cf6daf1e65b0e05a463e7cb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QUlw9WboaE2FYMMF"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@samuelpenn?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank">塞缪尔·佩恩</a> / <a class="ae ky" href="https://unsplash.com/?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="73d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上一篇文章中，我向您展示了<a class="ae ky" href="https://medium.com/faun/why-you-should-use-coding-style-and-pre-commit-bb0d10ef9a1e" rel="noopener">编码风格的重要性和预提交框架</a>。今天，我们将处理Terraform代码的预提交。它将负责使用棉绒和扫描仪验证代码。对于任何新的git提交，我们将能够<strong class="lb iu">确保没有回归</strong>并保持恒定的质量。</p><p id="14a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们将创建一个Terraform模块来测试一些东西。这些模块不会重复代码，应该很难测试其可靠性。我们将看看哪些预提交插件用于Terraform。</p><p id="d8ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦模块就绪，我们将为预提交生成一个Docker映像。目标是为使用<a class="ae ky" href="https://circleci.com/" rel="noopener ugc nofollow" target="_blank"> Circle CI </a>的CI/CD提供一个便携且随时可用的工具箱。Terraform模块也将有自己的Circle CI项目，并重复使用图像进行测试。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="bed9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Terraform模块示例</h1><p id="364c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Terraform模块非常适合分解代码。在这种情况下，持续测试非常有意义。例如，我们将编写一个模块来<strong class="lb iu">配置AWS </strong>中的网络。</p><h2 id="fde8" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">模块版本和提供商</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Terraform模块的版本文件</figcaption></figure><h2 id="1d8a" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">模块输入</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Terraform模块的变量文件</figcaption></figure><h2 id="f511" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">模块输出</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Terraform模块的输出文件</figcaption></figure><h2 id="d93a" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">模块心脏</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">terraform模块的主文件</figcaption></figure><h2 id="2130" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">提交前配置</h2><p id="a67c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">git repo包括预提交配置。在内部，我耦合了两个预提交回购:</p><ul class=""><li id="7de2" class="nn no it lb b lc ld lf lg li np lm nq lq nr lu ns nt nu nv bi translated"><a class="ae ky" href="https://github.com/gruntwork-io/pre-commit" rel="noopener ugc nofollow" target="_blank">gruntwork-io/pre-commit</a>格式化、验证和lint模块代码，并检查降价。</li><li id="549f" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><a class="ae ky" href="https://github.com/antonbabenko/pre-commit-terraform" rel="noopener ugc nofollow" target="_blank">antonbabenko/预提交</a>出于安全目的运行<code class="fe ob oc od oe b">tfsec</code>并自动更新文档。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Terraform模块库中的预提交配置</figcaption></figure><p id="94a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ob oc od oe b">tflint</code> <a class="ae ky" href="https://github.com/terraform-linters/tflint/tree/master/docs/rules" rel="noopener ugc nofollow" target="_blank">规则</a>存在于单独的文件中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">tflint配置文件</figcaption></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c61b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">CI/CD的预提交Docker映像</h1><h2 id="c744" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">文档文件</h2><p id="3c34" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在我们要创建Docker图像。它应该准备好与所有的依赖项一起使用，并且尽可能的轻便。我们将根据一张阿尔卑斯山的图片来建造它。我们尽可能地限制层数。Docker将更快地恢复和构建它，从而加快CI/CD工作流程。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">预提交-terraform Docker图像内容</figcaption></figure><h2 id="ac9d" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">测试并构建Docker映像</h2><p id="c957" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们在Circle CI项目中配置映像的测试和构建。它运行<a class="ae ky" href="https://github.com/hadolint/hadolint" rel="noopener ugc nofollow" target="_blank"> hadolint </a>来确保图像是干净的。然后，它构建映像并将其推送到DockerHub存储库:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">将CI配置圈到lint并构建预提交平台Docker映像</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/da409b9ce6ae0a27227d6700fbb29c51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FUl1HryrEpNW1GXoqV16iQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">预提交-平台化Circle CI项目</figcaption></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="30ec" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">带预提交的Terraform CI/CD</h1><h2 id="331a" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">圆形CI配置</h2><p id="60ad" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">模块repo有自己的Circle CI配置。工作流签出存储库并执行映像以运行提交前检查:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">圈出terraform模块库中的CI配置文件</figcaption></figure><h2 id="5289" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">决赛成绩</h2><p id="4750" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">git中的任何更改都会触发检查工作流:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/740d71458d78e2ecb4d54a649f7c909c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DU5xOl1U3frQJy3fjF6dzg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Terraform模块的Circle CI项目</figcaption></figure><p id="fc00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查结果在工作流日志中可见:</p><pre class="kj kk kl km gt oh oe oi oj aw ok bi"><span id="0140" class="mz md it oe b gy ol om l on oo">#!/bin/bash -eo pipefail docker run -v $PWD:/pre-commit --rm guivin/pre-commit-terraform</span><span id="11f8" class="mz md it oe b gy op om l on oo">Unable to find image 'guivin/pre-commit-terraform:latest' locally<br/>latest: Pulling from guivin/pre-commit-terraform<br/><br/>ab65f19f: Pulling fs layer <br/>2803aa7c: Pulling fs layer <br/>1c1036d2: Pulling fs layer <br/>Digest: sha256:fcbef363542a891ef0a238381aed17e974279cb657083d8abe5852ba2c1d144a<br/>Status: Downloaded newer image for guivin/pre-commit-terraform:latest<br/>[INFO] Initializing environment for https://github.com/gruntwork-io/pre-commit.<br/>[INFO] Initializing environment for git://github.com/antonbabenko/pre-commit-terraform.<br/>Terraform fmt............................................................Failed<br/>- hook id: terraform-fmt<br/>- exit code: 3<br/><br/>main.tf<br/>--- old/main.tf<br/>+++ new/main.tf<br/>@@ -25,8 +25,8 @@<br/>   vpc_id = join("", aws_vpc.this[*].id)<br/> <br/>   route {<br/>-	cidr_block = "0.0.0.0/0"<br/>-	gateway_id = join("", aws_internet_gateway.this[*].id)<br/>+    cidr_block = "0.0.0.0/0"<br/>+    gateway_id = join("", aws_internet_gateway.this[*].id)<br/>   }<br/> <br/>   tags = var.tags<br/>variables.tf<br/>--- old/variables.tf<br/>+++ new/variables.tf<br/>@@ -6,9 +6,9 @@<br/> <br/> <br/> variable "region" {<br/>-  type = string<br/>+  type        = string<br/>   description = "AWS region where to create resources"<br/>-  default = "us-east-1"<br/>+  default     = "us-east-1"<br/> }<br/> <br/> variable "tags" {<br/>@@ -28,7 +28,7 @@<br/> variable "public_subnet_cidr_blocks" {<br/>   type        = list(string)<br/>   description = "List of CIDR blocks for public subnets"<br/>-  default     = [<br/>+  default = [<br/>     "10.0.1.0/24",<br/>     "10.0.2.0/24",<br/>     "10.0.3.0/24"<br/>@@ -38,7 +38,7 @@<br/> variable "private_subnet_cidr_blocks" {<br/>   type        = list(string)<br/>   description = "List of CIDR blocks for private subnets"<br/>-  default     = [<br/>+  default = [<br/>     "10.0.4.0/24",<br/>     "10.0.5.0/24",<br/>     "10.0.6.0/24"<br/><br/>Terraform validate.......................................................Failed<br/>- hook id: terraform-validate<br/>- files were modified by this hook<br/><br/>--&gt; Running 'terraform validate' in directory '.'<br/><br/>Initializing provider plugins...<br/>- Reusing previous version of hashicorp/aws from the dependency lock file<br/>- Installing hashicorp/aws v3.30.0...<br/>- Installed hashicorp/aws v3.30.0 (signed by HashiCorp)<br/><br/>Terraform has been successfully initialized!<br/>Success! The configuration is valid.<br/><br/><br/>tflint...................................................................Failed<br/>- hook id: tflint<br/>- exit code: 2<br/><br/>Failed to check `terraform_naming_convention` rule. 1 error(s) occurred:<br/><br/>Error: Unsupported block type<br/><br/>  on .tflint.hcl line 42:<br/>  (source code not available)<br/><br/>Blocks of type "local" are not expected here. Did you mean "locals"?<br/><br/>markdown-link-check......................................................Failed<br/>- hook id: markdown-link-check<br/>- exit code: 1<br/><br/>markdown-link-check is not available on this system.<br/>Please install it by running 'npm install -g markdown-link-check'<br/><br/>Terraform validate with tfsec............................................Passed<br/>Terraform docs...........................................................Passed<br/><br/>Exited with code exit status 1<br/>CircleCI received exit code 1</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e9b6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">资源</h1><div class="oq or gp gr os ot"><a href="https://pre-commit.com/" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd iu gy z fp oy fr fs oz fu fw is bi translated">预提交</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">编辑描述</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">pre-commit.com</p></div></div><div class="pc l"><div class="pd l pe pf pg pc ph ks ot"/></div></div></a></div><div class="oq or gp gr os ot"><a href="https://github.com/hadolint/hadolint" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd iu gy z fp oy fr fs oz fu fw is bi translated">哈多林特/哈多林特</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">一个更智能的Docker文件链接器，帮助您建立最佳实践Docker图像。linter正在将docker文件解析成…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">github.com</p></div></div><div class="pc l"><div class="pi l pe pf pg pc ph ks ot"/></div></div></a></div><div class="oq or gp gr os ot"><a href="https://github.com/antonbabenko/pre-commit-terraform" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd iu gy z fp oy fr fs oz fu fw is bi translated">antonbabenko/预提交-地形</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">terraform_docs挂钩需要terraform-docs。如果使用0.8.0之前的terraform-docs和…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">github.com</p></div></div><div class="pc l"><div class="pj l pe pf pg pc ph ks ot"/></div></div></a></div><div class="oq or gp gr os ot"><a href="https://github.com/gruntwork-io/pre-commit" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd iu gy z fp oy fr fs oz fu fw is bi translated">gruntwork-io/预提交</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">这个repo定义了用于预提交的Git预提交挂钩。目前支持的挂钩有…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">github.com</p></div></div><div class="pc l"><div class="pk l pe pf pg pc ph ks ot"/></div></div></a></div></div></div>    
</body>
</html>