<html>
<head>
<title>Creating a Short URL Service Using Cloudflare Workers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cloudflare Workers创建短URL服务</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/creating-a-short-url-service-using-cloudflare-workers-b3092d427250?source=collection_archive---------6-----------------------#2022-01-27">https://levelup.gitconnected.com/creating-a-short-url-service-using-cloudflare-workers-b3092d427250?source=collection_archive---------6-----------------------#2022-01-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2ddb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在全球范围内即时部署无服务器代码</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/dd6b15dcd9a101644789c24b60c9eda8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jGyjke3GMqUQoIxknzn-Yg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/photos/rzJKYpq2is4" rel="noopener ugc nofollow" target="_blank">图片来源:Unsplash </a></figcaption></figure><h1 id="b0bd" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="4a6f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">你是否曾经使用过像bitly或类似的短URL服务，并想知道它是如何工作的？更好的是，你想为自己创造一个吗？如果你对这两个问题的回答都是肯定的，那么你就来对地方了。在本文中，我们将看看如何使用<a class="ae ky" href="https://workers.cloudflare.com/" rel="noopener ugc nofollow" target="_blank"> Cloudflare Workers </a>创建一个短URL服务。</p><h1 id="fbcd" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">什么是Cloudflare Workers？</h1><p id="88e6" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated"><a class="ae ky" href="https://workers.cloudflare.com/" rel="noopener ugc nofollow" target="_blank"> Cloudflare Workers </a>允许您将无服务器代码部署到Cloudflare的边缘网络，这意味着您的代码将在全球任何地方即时可用。你不必担心它的伸缩性，而且运行代码的成本非常低。Cloudflare Workers附带了一个名为<a class="ae ky" href="https://developers.cloudflare.com/workers/learning/how-kv-works" rel="noopener ugc nofollow" target="_blank"> Workers KV </a>的全局低延迟键值数据存储。在本文中，我们将使用Workers KV和Cloudflare Workers。</p><h1 id="1802" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤1:注册Cloudflare</h1><p id="3233" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">访问cloudflare.com并注册一个免费账户。一旦您验证了您的电子邮件地址并访问了您的仪表板，您可能会看到一条添加站点的消息—您不需要添加站点，只需跳到仪表板页面并单击<strong class="lt iu"> Workers </strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/42c67ffc9399599e97fff52d7bbf3394.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/format:webp/1*l5vratkH9Ls6vBw7gUyg_w.png"/></div></figure><p id="9cbc" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">由于这是您第一次使用Cloudflare Workers，您将被要求设置一个子域。此子域名称对您来说是唯一的，并将标识部署到您帐户的所有员工。输入合适的子域，然后点击<strong class="lt iu">设置</strong>进入下一步。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/234848f91618c1b0f1a94b0d0bc49954.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UX8yzI1rPWIC2JUFjPihFQ.png"/></div></div></figure><p id="249f" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在下一步中，我们将继续免费计划，因为我们将仅用于学习目的。最后一步，验证你的电子邮件，然后你就可以开始了。</p><p id="478c" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在“Workers dashboard”页面中，您不会看到列出的任何员工，因为我们尚未创建任何员工。现在，只需复制应该在右侧面板中可见的<strong class="lt iu">帐户ID </strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/969e941219e212257c1b6d9d54cb9d07.png" data-original-src="https://miro.medium.com/v2/resize:fit:750/format:webp/1*fac3j6pJ7ivpLo0y5vMyHg.png"/></div></figure><h1 id="7a8b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤2:设置您的开发环境</h1><p id="6a46" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们将使用Wrangler CLI执行各种开发任务，因此，如果您尚未安装CLI工具，请按照本官方Cloudflare指南<a class="ae ky" href="https://developers.cloudflare.com/workers/cli-wrangler/install-update" rel="noopener ugc nofollow" target="_blank">在您的本地计算机上安装该工具</a>。</p><p id="c3fb" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">使用命令<code class="fe mv mw mx my b">wrangler login</code>使用Wrangler CLI工具登录您的Cloudflare帐户。建议使用管理员权限打开命令提示符。</p><p id="d1a6" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">这应该会在浏览器中打开Cloudflare，您可能需要授权Wrangler。Cloudflare会在可以关闭页面时显示一条消息。回到控制台，您应该会看到一条消息，告诉您一切都已成功配置。</p><h1 id="3b84" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤3:生成一些代码</h1><p id="94e3" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本地文件夹中，运行命令<code class="fe mv mw mx my b">wrangler generate shorturl <a class="ae ky" href="https://github.com/cloudflare/worker-template" rel="noopener ugc nofollow" target="_blank">https://github.com/cloudflare/worker-template</a></code>基于Cloudflare的<a class="ae ky" href="https://github.com/cloudflare/worker-template" rel="noopener ugc nofollow" target="_blank"> GitHub存储库</a>中的模板生成一些代码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/4d86b24ce98d69f8d68aa7fdf119e217.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X_nQAkFFOE6r5VR4t3hdVA.png"/></div></div></figure><p id="2bb5" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">按照控制台输出中的指示，我们需要更新<code class="fe mv mw mx my b">wrangler.toml</code>文件，并向其中添加帐户ID。根据<a class="ae ky" href="https://github.com/cloudflare/wrangler/issues/209#issuecomment-541654484" rel="noopener ugc nofollow" target="_blank">这个注释</a>，可以将<code class="fe mv mw mx my b">wrangler.toml</code>文件提交给源代码控制。此文件中包含的信息不敏感。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="1a6c" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">最后，如果您运行命令<code class="fe mv mw mx my b">wrangler dev</code>，您应该会看到下面的输出。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/7d17808c0f91a9d1e90b8e8fa2183c49.png" data-original-src="https://miro.medium.com/v2/resize:fit:618/format:webp/1*gV1OJWEoMxWjjxqIorEwsA.png"/></div></figure><h1 id="c6bc" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">第四步:获得一个简短的网址并重定向</h1><p id="94b3" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在<code class="fe mv mw mx my b">index.js</code>文件中，用下面的代码片段替换<code class="fe mv mw mx my b">handleRequest()</code>方法。我们从接收到的对象中获取整个请求URL，然后从中获取路径名，然后简单地将用户重定向到example.com，以相同的路径名作为后缀。例如，前往我们的开发人员URL <code class="fe mv mw mx my b">127.0.0.1:8787/abc</code>会将用户重定向到<code class="fe mv mw mx my b">https://example.com/abc</code>。如果没有提供路径名，则在浏览器中打印一条简单的文本消息。使用命令<code class="fe mv mw mx my b">wrangler dev</code>对此进行测试。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="61c4" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤#5用静态集合映射路径</h1><p id="b715" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">下一步是使它稍微更有活力，并符合最终存储的样子。我们添加了<code class="fe mv mw mx my b">getRedirectURL()</code>方法，该方法简单地根据提供的键获取重定向URL。在<code class="fe mv mw mx my b">handleRequest()</code>方法中，我们修改了一行来使用<code class="fe mv mw mx my b">getRedirectURL()</code>方法。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="bd00" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">到目前为止，我们已经得到了一个静态的短URL列表和它们的重定向。现在是时候让它充满活力了。</p><h1 id="ce9c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤#6:设置KV存储</h1><p id="5a34" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们将使用Cloudflare的KV存储，而不是存储它重定向到的密钥和相应网站的静态列表。</p><p id="81d2" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">让我们从运行命令<code class="fe mv mw mx my b">wrangler kv:namespace create “SHORTURLS”</code>开始，其中<code class="fe mv mw mx my b">SHORTURLS</code>是我用于KV名称空间的名称。该命令在控制台中打印一条消息，指示将KV配置添加到<code class="fe mv mw mx my b">wrangler.toml</code>文件中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/3e4ba298a5ac8bd0261ca131fa831d4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*g_EX-IiZwPppI7nZ-AuL6A.png"/></div></figure><h1 id="154f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤7:播种KV存储</h1><p id="8760" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为了快速测试我们的应用程序，让我们使用下面的命令向数据库中添加一条记录。</p><pre class="kj kk kl km gt ne my nf ng aw nh bi"><span id="d6f0" class="ni la it my b gy nj nk l nl nm">wrangler kv:key put --binding=&lt;BINDING NAME&gt; “&lt;KEY&gt;” “&lt;URL&gt;"</span></pre><p id="0e3a" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在我工作的仓库中，我已经将命令更新为<code class="fe mv mw mx my b">wrangler kv:key put --binding=SHORTURLS “twitter” “<a class="ae ky" href="https://twitter.com/clydedz" rel="noopener ugc nofollow" target="_blank">https://twitter.com/clydedz</a>"</code>。如果一切顺利，您应该会立即看到一条成功消息。</p><p id="17d4" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">现在，如果您尝试运行命令<code class="fe mv mw mx my b">wrangler dev</code>,您应该会看到类似这样的错误消息:</p><blockquote class="nn no np"><p id="688a" class="lr ls nq lt b lu mo ju lw lx mp jx lz nr mq mc md ns mr mg mh nt ms mk ml mm im bi translated">错误:为了预览具有KV名称空间的worker，您必须在您的配置文件中为您想要预览的每个KV名称空间<br/>指定一个preview_id。</p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/f8d263f4629861d456e4cbd5816c25a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fyYIgdq1T1kMKjppIfD7sg.png"/></div></div></figure><p id="d986" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在阅读了<a class="ae ky" href="https://github.com/cloudflare/wrangler/issues/1458#issuecomment-671465444" rel="noopener ugc nofollow" target="_blank">这个有用的GitHub答案</a>后，很明显我们需要的只是一个预览环境。当我们之前创建名称空间时，它与您的生产环境相关联。因此，当您使用<code class="fe mv mw mx my b">wrangler dev</code>进行测试时，它不允许您从开发环境中操纵生产KV存储。</p><h1 id="1089" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤8:设置预览KV环境</h1><p id="6d3a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为了解决这个问题，我们需要像以前一样重复KV创建步骤，但是这次我们将添加参数<code class="fe mv mw mx my b">--preview</code>,表明我们需要一个预览，即创建开发实例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/2ea9d8b8409a37ce0ea0388253fca3a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X0Y7qIFeesMrK5ZgEr_HGg.png"/></div></div></figure><p id="69d5" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">因为我们输入了相同的KV名称空间名称，请注意主名称<code class="fe mv mw mx my b">id</code>仍然是原来的名称，除此之外，我们还被分配了一个<code class="fe mv mw mx my b">preview_id</code>。</p><p id="08af" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">如果您现在尝试运行应用程序，Worker将会工作，但是前往<code class="fe mv mw mx my b">/twitter</code>不会将您重定向到Twitter URL。这是因为我们只播种了KV名称空间的生产环境。既然我们已经连接到preview，我们还需要用一个测试记录来播种这个preview名称空间。我将像以前一样运行下面的命令，但是这次我将添加<code class="fe mv mw mx my b">--preview</code>参数。</p><pre class="kj kk kl km gt ne my nf ng aw nh bi"><span id="2040" class="ni la it my b gy nj nk l nl nm">wrangler kv:key put --binding=SHORTURLS “twitter” “<a class="ae ky" href="https://twitter.com/clydedz" rel="noopener ugc nofollow" target="_blank">https://twitter.com/clydedz</a>" --preview<!-- -->.</span></pre><h1 id="cd05" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤9:从KV存储器中检索值</h1><p id="4e1a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们现在将更新<code class="fe mv mw mx my b">getRedirectURL()</code>方法，使用我们的KV名称空间来获取值，而不是本地静态集合。注意，我们写了<code class="fe mv mw mx my b">SHORTURLS.get()</code>来匹配我们的绑定名<code class="fe mv mw mx my b">SHORTURLS</code>。因此，如果您的绑定名称是<code class="fe mv mw mx my b">XYZ</code>，那么您应该将这个代码更新为<code class="fe mv mw mx my b">XYZ.get()</code>。我还将这个方法更新为异步的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="1fbb" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">最后，让我们在本地运行应用程序进行测试。正如你在下面的GIF中看到的，它现在可以正常工作了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/5201cf227d934ea8e6067be14552985d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/1*BWD9UbqD9m_K4gjQWvcIpQ.gif"/></div></figure><h1 id="6f83" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤#10:自动化部署</h1><p id="079d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们不希望现在每次进行更改时都手动部署我们的Cloudflare Worker，不是吗？对于自动化部署，我们将看一下GitHub动作，因为我的存储库已经在GitHub中受源代码控制。</p><h2 id="99ee" class="ni la it bd lb nx ny dn lf nz oa dp lj ma ob oc ll me od oe ln mi of og lp oh bi translated">GitHub工作流文件</h2><p id="9616" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">GitHub工作流文件是一个YAML文件，允许您通过代码配置构建和部署管道。我将解释我们在这个项目中使用了什么，但是如果你热衷于阅读更多关于GitHub workflow的内容，请在这里查看他们的官方文档<a class="ae ky" href="https://docs.github.com/en/actions" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="8fb7" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">让我们首先将下面的代码片段添加到一个名为<code class="fe mv mw mx my b">build-deploy.yml</code>的文件中，并将该文件存储在<code class="fe mv mw mx my b">.github/workflows/</code>文件夹中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="3469" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">我们首先使用<code class="fe mv mw mx my b">name</code>关键字给它一个好听的描述性名称。然后，使用<code class="fe mv mw mx my b">on</code>关键字，我们配置这个管道在每次代码被推送到主分支时运行。</p><p id="9c80" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在这个文件的最后一部分，我们使用<code class="fe mv mw mx my b">jobs</code>关键字来定义一个作业，这个作业只是一批将要执行的步骤。关键字<code class="fe mv mw mx my b">deploy</code>只是这个作业的一个标识符，也可以被命名为其他名称。关键字<code class="fe mv mw mx my b">steps</code>包含了实现部署的各个步骤。</p><p id="18a2" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">我们使用来自市场的GitHub动作<a class="ae ky" href="https://github.com/marketplace/actions/checkout" rel="noopener ugc nofollow" target="_blank"> actions/checkout </a>来从我们的Git仓库中检查代码。接下来，我们使用cloudflare提供的<a class="ae ky" href="https://github.com/marketplace/actions/deploy-to-cloudflare-workers-with-wrangler" rel="noopener ugc nofollow" target="_blank">Cloudflare/wrangler-action</a>将我们的工作人员部署到cloud flare。我们使用名为<code class="fe mv mw mx my b">CF_API_TOKEN</code>的GitHub secret变量，而不是硬编码API令牌，这是根据我们的Cloudflare帐户进行身份验证的步骤所必需的。前缀<code class="fe mv mw mx my b">secrets</code>和它周围的花括号只是访问<a class="ae ky" href="https://docs.github.com/en/actions/security-guides/encrypted-secrets" rel="noopener ugc nofollow" target="_blank"> GitHub秘密</a>的语法。不要担心，我们将在下一步中添加这个秘密。</p><p id="5036" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">我们使用<code class="fe mv mw mx my b">workingDirectory</code>关键字将我们的Cloudflare Worker的工作目录设置为子目录(相对于根目录)，因为我们的Worker的代码不在根目录中，这通常是默认设置——下面将详细介绍这个决定。</p><h2 id="ade7" class="ni la it bd lb nx ny dn lf nz oa dp lj ma ob oc ll me od oe ln mi of og lp oh bi translated">Cloudflare令牌</h2><p id="780e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">导航到Cloudflare中的<a class="ae ky" href="https://dash.cloudflare.com/profile/api-tokens" rel="noopener ugc nofollow" target="_blank"> API令牌页面</a>，然后单击<strong class="lt iu">创建令牌</strong>按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/f462c79b3a7bf067329841864a018192.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uHucyp-XXEn32Rqvqfhm0g.png"/></div></div></figure><p id="b149" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">从API令牌模板页面，我们将单击<strong class="lt iu">编辑Cloudflare Workers </strong>行项目旁边的<strong class="lt iu">使用模板</strong>按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/9f8830fe484cf380a5d7f63fbcbd9e4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4U7ZaLs4jxiN8oTsWbnUfQ.png"/></div></div></figure><p id="16ef" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在下一页，从<strong class="lt iu">帐户资源</strong>和<strong class="lt iu">区域资源</strong>下拉列表中，选择您的帐户(电子邮件地址应该显示在这些下拉列表中)。如果您是多个Cloudflare帐户的用户，您需要小心选择正确的帐户。</p><p id="48ab" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">继续总结，然后点击<strong class="lt iu">创建令牌</strong>按钮。复制令牌并安全保存。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/3b32cce37623d0ff1682e428a22f9be5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F6E6VF-kO35iqU9rC98DCg.png"/></div></div></figure><h2 id="e20a" class="ni la it bd lb nx ny dn lf nz oa dp lj ma ob oc ll me od oe ln mi of og lp oh bi translated">在GitHub中添加秘密</h2><p id="47e9" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">由于我们已经在工作流文件中使用了变量<code class="fe mv mw mx my b">CF_API_TOKEN</code>，所以让我们在GitHub中添加一个同名的秘密。点击<strong class="lt iu">设置</strong>，然后点击<strong class="lt iu">秘密</strong>，再点击<strong class="lt iu">新秘密</strong>。键入秘密变量名<code class="fe mv mw mx my b">CF_API_TOKEN</code>，并在<strong class="lt iu">值</strong>字段中，输入我们之前生成的Cloudflare API令牌。点击<strong class="lt iu">添加密码</strong>按钮保存这些更改。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/4e074c728c50a247e3f3b8fff85ed487.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aBbi8J8rKopUZWBPw3A3Bw.png"/></div></div></figure><h1 id="545b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤#11:最终检查</h1><p id="2d73" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在，我们已经准备好了所有的项目，不要忘记提交和推送对工作流文件的更改。如果一切都设置好了，你应该在GitHub的<strong class="lt iu">动作</strong>标签中看到一次成功的运行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/12072365912e441ebe31976643e2d2ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y69YYHGn9fnNC6m3hgdQmw.png"/></div></div></figure><p id="cdb6" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">现在，如果您转到Cloudflare帐户中的Workers页面，您应该会看到刚刚部署的Worker弹出在屏幕上。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/27ce3a4c9b034f0fbb3512366428e064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y7ffTi0BLi-TPSJ6ha9jPA.png"/></div></div></figure><p id="6460" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">转到Worker URL，测试URL重定向是否有效。我们仍然可以测试<code class="fe mv mw mx my b">&lt;URL of your Worker&gt;/twitter</code>短URL，因为我们之前已经植入了该数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/67917110dc0828abe021cfefe5f4bfe7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/1*YHmeK66PEc-RGyQSIFXtug.gif"/></div></figure></div><div class="ab cl op oq hx or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="im in io ip iq"><h1 id="752b" class="kz la it bd lb lc ow le lf lg ox li lj jz oy ka ll kc oz kd ln kf pa kg lp lq bi translated">下一步是什么？</h1><h2 id="5f55" class="ni la it bd lb nx ny dn lf nz oa dp lj ma ob oc ll me od oe ln mi of og lp oh bi translated">单元测试</h2><p id="3275" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为了简洁起见，我们没有考虑编写单元测试和设置测试覆盖。然而，在实际的解决方案中，您可能希望考虑对代码进行单元测试，并且在CI/CD管道中包含必要的步骤。</p><h2 id="f1cb" class="ni la it bd lb nx ny dn lf nz oa dp lj ma ob oc ll me od oe ln mi of og lp oh bi translated">添加更多员工</h2><p id="6383" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在上面的文章中，我们只看到了一个在我们提供了一个短URL之后将我们重定向到目标URL的Worker。如果你想创建一个成熟的短URL服务，你也想创建一个允许我们创建一个新的短URL映射的服务，它将作为后端，并且可能是一个微服务，它将帮助发布短URL上的每次点击的分析，并且也取回这些分析。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/35b77318cf43c4f2072943b4d19eb79e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YC-pmfE9i4QZI3qw_HumJQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者绘制的手绘示意图</figcaption></figure><h2 id="60a6" class="ni la it bd lb nx ny dn lf nz oa dp lj ma ob oc ll me od oe ln mi of og lp oh bi translated">源代码控制多个工作线程</h2><p id="3304" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">您不必创建不同的Git存储库来托管每个Cloudflare Worker。您可以为所有员工创建monorepo，并为每个员工创建包含内容的子文件夹。如果您在不同的工作人员之间共享代码，这将非常有用，这样您就不会重复代码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/3886000ff7d781f36e314013cfac1691.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t6vUl_1ITc5D_P3GpKRS3w.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者绘制的手绘示意图</figcaption></figure><h2 id="fb0c" class="ni la it bd lb nx ny dn lf nz oa dp lj ma ob oc ll me od oe ln mi of og lp oh bi translated">捆绑到单个JavaScript文件中</h2><p id="b9f1" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们还在一个文件中编写了所有的JavaScript代码，这并不理想。开箱即用，我们不能将另一个JavaScript文件导入到我们工人的<code class="fe mv mw mx my b">index.js</code>文件中。为了解决这个问题，我们可以从最终生成的Worker JavaScript文件中分离出源代码。我的意思是(如上所述)，例如，我们在一个名为<code class="fe mv mw mx my b">src</code>的文件夹中维护一个工人的源代码，然后运行一个类似<a class="ae ky" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank"> webpack </a>的过程，将一个JavaScript文件捆绑并生成到一个目标文件夹中，我们称之为<code class="fe mv mw mx my b">dist</code>。该目标文件夹的内容就是我们随后可以发布到Cloudflare的内容。</p><h2 id="7c46" class="ni la it bd lb nx ny dn lf nz oa dp lj ma ob oc ll me od oe ln mi of og lp oh bi translated">自定义域</h2><p id="8d04" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果您正在构建一个完整的解决方案，您可能还会考虑为您的员工设置一个自定义域名——这确实是可能的，您的最终解决方案可能会类似于下图，使用bit.ly作为参考域名。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/5c96904261179418b13deb054805c172.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cxAr7Kz9jvQZe2y0BxMAEQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者绘制的手绘示意图</figcaption></figure></div><div class="ab cl op oq hx or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="im in io ip iq"><h1 id="772d" class="kz la it bd lb lc ow le lf lg ox li lj jz oy ka ll kc oz kd ln kf pa kg lp lq bi translated">源代码</h1><p id="363d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果你想看这个项目的完整源代码，可以在<a class="ae ky" href="https://github.com/ClydeDz/shorturl-cloudflare-workers" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。在同一个存储库中，您还会发现一个<a class="ae ky" href="https://github.com/ClydeDz/shorturl-cloudflare-workers/blob/main/cloudflare.ps1" rel="noopener ugc nofollow" target="_blank"> PowerShell脚本</a>，它包含了我们上面使用过的所有命令。</p><p id="7251" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">就是这样。感谢阅读。</p></div></div>    
</body>
</html>