<html>
<head>
<title>Build a Serverless Histogram API with Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Redis构建无服务器直方图API</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/build-a-serverless-histogram-api-with-redis-7aff7ec69114?source=collection_archive---------19-----------------------#2021-04-27">https://levelup.gitconnected.com/build-a-serverless-histogram-api-with-redis-7aff7ec69114?source=collection_archive---------19-----------------------#2021-04-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a25d5581d8827d1bd51199015408a232.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ci9t8s1_1muaRwGd.jpg"/></div></div></figure><p id="ee0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在开发<a class="ae kw" href="https://blog.upstash.com/latency-comparison" rel="noopener ugc nofollow" target="_blank">无服务器数据库(DynamoDB、FaunaDB、Upstash) </a>的延迟基准测试时，我希望有一个API可以记录延迟数字并获取直方图。在本教程中，我将构建这样一个API，您可以在其中记录来自任何应用程序的延迟值。它将是一个无服务器的REST API，具有以下方法:</p><ul class=""><li id="03e4" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">记录:将数值记录到直方图中。</li><li id="d9f6" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">get:返回直方图对象。</li></ul><h1 id="fdab" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">动机</h1><p id="8a3a" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我将展示使用AWS Lambda和无服务器Redis开发通用API有多容易。</p><h1 id="7f3b" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建一个Redis数据库</h1><p id="de7b" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">按照<a class="ae kw" href="https://docs.upstash.com/" rel="noopener ugc nofollow" target="_blank">入门</a>中的定义创建一个数据库</p><h1 id="7793" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><code class="fe mo mp mq mr b">Step-2:</code>无服务器项目设置</h1><p id="9d40" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">如果您还没有，请通过以下方式安装无服务器框架:</p><p id="50c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mo mp mq mr b">npm install -g serverless</code></p><p id="4410" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在任何文件夹中运行如下<code class="fe mo mp mq mr b">serverless</code>:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="9961" class="na lm iq mr b gy nb nc l nd ne"><em class="nf">&gt;&gt; serverless<br/><br/>Serverless: No project detected. Do you want to create a new one? Yes<br/>Serverless: What do you want to make? AWS Node.js<br/>Serverless: What do you want to call this project? histogram-api<br/><br/>Project successfully created in 'histogram-api' folder.<br/><br/>You can monitor, troubleshoot, and test your new service with a free Serverless account.<br/><br/>Serverless: Would you like to enable this? No<br/>You can run the “serverless” command again if you change your mind later.</em></span></pre><p id="1012" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在项目文件夹中，使用以下命令创建一个节点项目:</p><p id="a486" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mo mp mq mr b">npm init</code></p><p id="1efb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后安装redis客户端和直方图库，包括:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="ad5e" class="na lm iq mr b gy nb nc l nd ne"><em class="nf">npm install ioredis<br/><br/>npm install hdr-histogram-js</em></span></pre><p id="3230" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如下更新<code class="fe mo mp mq mr b">serverless.yml</code>。从控制台复制您的Redis URL并替换以下内容:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="b9a8" class="na lm iq mr b gy nb nc l nd ne"><em class="nf">service: histogram-api<br/>frameworkVersion: '2'<br/><br/>provider:<br/>  name: aws<br/>  runtime: nodejs12.x<br/>  lambdaHashingVersion: 20201221<br/>  environment:<br/>    REDIS_URL: REPLACE_YOUR_URL_HERE<br/><br/>functions:<br/>  record:<br/>    handler: handler.record<br/>    events:<br/>      - httpApi:<br/>          path: /record<br/>          method: post<br/>          cors: true<br/>  get:<br/>    handler: handler.get<br/>    events:<br/>      - httpApi:<br/>          path: /get<br/>          method: get<br/>          cors: true</em></span></pre><h1 id="47e6" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">第三步:编码</h1><p id="6626" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">如下所示编辑handler.js:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="8c83" class="na lm iq mr b gy nb nc l nd ne"><em class="nf">const hdr = require("hdr-histogram-js");<br/>const Redis = require("ioredis");<br/>if (typeof client === 'undefined') {<br/>    var client = new Redis(fixUrl(process.env.REDIS_URL));<br/>}<br/>const headers = {<br/>    'Access-Control-Allow-Origin': '*',<br/>    'Access-Control-Allow-Credentials': true,<br/>};<br/>const SIZE = 10000;<br/><br/>module.exports.get = async (event) =&gt; {<br/>    if (!event.queryStringParameters || !event.queryStringParameters.name) {<br/>        return {<br/>            statusCode: 400,<br/>            headers: headers,<br/>            body: JSON.stringify(<br/>                {<br/>                    message: 'Invalid parameters. Name is needed.',<br/>                }<br/>            ),<br/>        };<br/>    }<br/>    const name = event.queryStringParameters.name;<br/>    const data = await client.lrange(name, 0, SIZE);<br/>    const histogram = hdr.build();<br/>    data.forEach(item =&gt; {<br/>        histogram.recordValue(item);<br/>    })<br/><br/>    return {<br/>        statusCode: 200,<br/>        body: JSON.stringify(<br/>            {<br/>                histogram: histogram<br/>            }<br/>        ),<br/>    };<br/>};<br/><br/>module.exports.record = async (event) =&gt; {<br/>    let body = JSON.parse(event.body)<br/>    if (!body || !body.name || !body.values) {<br/>        return {<br/>            statusCode: 400,<br/>            headers: headers,<br/>            body: JSON.stringify(<br/>                {<br/>                    message: 'Invalid parameters. Name and values are needed.',<br/>                }<br/>            ),<br/>        };<br/>    }<br/>    const name = body.name;<br/>    const values = body.values;<br/>    await client.lpush(name, values)<br/>    return {<br/>        statusCode: 200,<br/>        body: JSON.stringify(<br/>            {<br/>                message: 'Success',<br/>                name: name<br/>            }<br/>        ),<br/>    };<br/>};<br/><br/><br/>function fixUrl(url) {<br/>    if (!url) {<br/>        return ''<br/>    }<br/>    if (url.startsWith('redis://') &amp;&amp; !url.startsWith('redis://:')) {<br/>        return url.replace('redis://', 'redis://:')<br/>    }<br/>    if (url.startsWith('rediss://') &amp;&amp; !url.startsWith('rediss://:')) {<br/>        return url.replace('rediss://', 'rediss://:')<br/>    }<br/>    return url<br/>}</em></span></pre><p id="7ea3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面我们有两个无服务器功能。<code class="fe mo mp mq mr b">get</code>以<code class="fe mo mp mq mr b">name</code>为参数，从Redis加载一个列表。然后使用列表中的值构建直方图。</p><p id="b5db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mo mp mq mr b">record</code>函数以<code class="fe mo mp mq mr b">name</code>和<code class="fe mo mp mq mr b">values</code>为参数。它将<code class="fe mo mp mq mr b">values</code>添加到名为<code class="fe mo mp mq mr b">name</code>的Redis列表中。</p><p id="c6e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mo mp mq mr b">get</code>函数计算最近10000条延迟记录的直方图。更新SIZE参数以更改该数字。</p><p id="4d5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mo mp mq mr b">fixUrl</code>是一个帮助器方法，用于纠正Redis url格式。</p><h1 id="222b" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">步骤4:部署您的功能</h1><p id="fc6e" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">通过以下方式部署您的功能:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="cd95" class="na lm iq mr b gy nb nc l nd ne"><em class="nf">serverless deploy</em></span></pre><p id="93f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该命令将部署两个函数并输出两个端点。尝试使用如下设置参数的端点:</p><p id="553d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将延迟次数记录到<code class="fe mo mp mq mr b">perf-test-1</code>:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="29dc" class="na lm iq mr b gy nb nc l nd ne"><em class="nf"><br/>curl --header "Content-Type: application/json" -d "{\"name\":\"perf-test-1\", \"values\": [90,80,34,97,93,45,49,57,99,12]}" https://v7xx4aa2ib.execute-api.us-east-1.amazonaws.com/record</em></span></pre><p id="99b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">获取<code class="fe mo mp mq mr b">perf-test-1</code>的直方图:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="7327" class="na lm iq mr b gy nb nc l nd ne"><em class="nf">curl https://v7xx4aa2ib.execute-api.us-east-1.amazonaws.com/get?name=perf-test-1</em></span></pre><h1 id="42cf" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">定量</h1><p id="c91a" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">每次调用远程函数进行延迟计算的成本可能很高。在您的应用程序中，您应该保留一个数组或队列作为延迟数的缓冲区，然后在数组达到批处理大小时将它们成批提交给API。如下图所示:</p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><p id="31f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nf">最初发表于</em><a class="ae kw" href="https://docs.upstash.com/tutorials/histogram" rel="noopener ugc nofollow" target="_blank"><em class="nf">【https://docs.upstash.com】</em></a><em class="nf">。</em></p></div></div>    
</body>
</html>