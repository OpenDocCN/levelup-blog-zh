<html>
<head>
<title>Kotlin Multiplatform iOS: Certificate Pinning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kotlin多平台iOS:证书锁定</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/kotlin-multiplatform-ios-certificate-pinning-fd1abba5ca8f?source=collection_archive---------5-----------------------#2020-03-04">https://levelup.gitconnected.com/kotlin-multiplatform-ios-certificate-pinning-fd1abba5ca8f?source=collection_archive---------5-----------------------#2020-03-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/d70601b293bd6a6181065c162c8e190e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PrXb17ewu8CGH9SLK7Z5gg.jpeg"/></div></div></figure><div class=""/><div class=""><h2 id="9848" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">如何使用Ktor在Kotlin多平台中实现证书锁定</h2></div><h1 id="5ffd" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">证书锁定</h1><p id="62f5" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">在与远程API交互时，固定证书是一种常见的做法。这是限制您信任哪些证书的行为。这有助于抵御对证书颁发机构的攻击。它还有助于对抗中间人攻击。</p><p id="7da5" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">有大量关于证书锁定的信息。以下是一些帮助您开始的信息:</p><p id="1a21" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">-<a class="ae mj" href="https://owasp.org/www-community/controls/Certificate_and_Public_Key_Pinning" rel="noopener ugc nofollow" target="_blank">https://owasp . org/www-community/controls/Certificate _ and _ Public _ Key _ Pinning</a></p><p id="fb64" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">-<a class="ae mj" href="https://labs.nettitude.com/tutorials/tls-certificate-pinning-101/" rel="noopener ugc nofollow" target="_blank">https://labs . nettitude . com/tutorials/TLS-certificate-pinning-101/</a></p><p id="015d" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">-<a class="ae mj" href="https://docs.broadcom.com/docs/certificate-pinning-en" rel="noopener ugc nofollow" target="_blank">https://docs.broadcom.com/docs/certificate-pinning-en</a></p><h1 id="ef81" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">科特林多平台</h1><p id="d13f" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated"><a class="ae mj" href="https://kotlinlang.org/docs/reference/multiplatform.html" rel="noopener ugc nofollow" target="_blank"> Kotlin多平台</a> (KMP)是用<a class="ae mj" href="https://kotlinlang.org/" rel="noopener ugc nofollow" target="_blank"> Kotlin </a>编写跨平台代码的一种方式。它不是要为所有平台编译所有代码，也不是要把你限制在一个公共API的子集上。KMP提供了为通用API编写特定于平台的实现的机制。</p><h1 id="7175" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">Ktor</h1><p id="69f6" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">Ktor是一个用于构建异步服务器和客户端的KMP框架。Ktor的客户端库使您能够创作连接到远程API的多平台代码。</p><p id="c5af" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">Ktor客户端支持JVM、Android、iOS、Javascript、macOS、Linux和Windows。</p><p id="e7ce" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">Ktor提供了执行特定于平台的请求的引擎。这些引擎遵循一个公共接口。在普通代码中，您可以通过引擎发出HTTP请求。</p><p id="a4b7" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">对于Android，可以使用一个<a class="ae mj" href="https://square.github.io/okhttp/" rel="noopener ugc nofollow" target="_blank"> OkHttp </a>引擎。Ktor内置了一个使用<code class="fe mk ml mm mn b">NSURLSession</code>类的iOS引擎。</p><h1 id="3618" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">用OkHttp锁定</h1><p id="136f" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">OkHttp长期以来一直支持针对公钥的证书锁定。实现很简单，我喜欢他们解决这个问题的方法。</p><p id="6bff" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated"><a class="ae mj" href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-certificate-pinner/#setting-up-certificate-pinning" rel="noopener ugc nofollow" target="_blank">https://square . github . io/ok http/4 . x/ok http/ok http 3/-certificate-pinner/# setting-up-certificate-pinning</a></p><h1 id="a9b8" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">用iOS钉住</h1><p id="6119" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">在iOS上，这就没那么简单了。你必须覆盖<code class="fe mk ml mm mn b">NSURLSessionDataDelegateProtocol</code>上的一个函数，并用它配置一个<code class="fe mk ml mm mn b">NSURLSession</code>。</p><p id="5186" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated"><a class="ae mj" href="https://developer.apple.com/documentation/foundation/nsurlsessiondelegate/1409308-urlsession?language=objc" rel="noopener ugc nofollow" target="_blank">https://developer . apple . com/documentation/foundation/nsurlsessiondelegate/1409308-urlsession？language=objc </a></p><p id="867d" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">以科特林为代表:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="8b8c" class="mw kr jb mn b gy mx my l mz na">fun invoke(<br/>    session: NSURLSession,<br/>    challenge: NSURLAuthenticationChallenge,<br/>    completionHandler: (NSURLSessionAuthChallengeDisposition, NSURLCredential?) -&gt; Unit<br/>)</span></pre><p id="11d7" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">在这个函数中，您需要检查挑战的各个方面。最终检查证书符合您的期望。</p><h1 id="f6a9" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">认证员</h1><p id="24ad" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">我开始为KMP编写一个简洁的类来实现这个证书锁定功能。因为我们需要能够覆盖一个委托方法，所以我们至少需要使用Ktor的1.3.2版本。</p><figure class="mo mp mq mr gt is"><div class="bz fp l di"><div class="nb nc l"/></div></figure><figure class="mo mp mq mr gt is"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="04db" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">这是我想到的类。它受到OkHttp的<code class="fe mk ml mm mn b">CertificatePinner</code>的启发，与他们的实现非常接近。</p><h1 id="4e03" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">如何使用</h1><p id="172c" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">若要开始，请使用中断的配置来配置证书固定。然后，当连接失败时，在日志中读取预期的配置。一定要在一个可信的网络上做这件事，不要使用像查尔斯<a class="ae mj" href="http://charlesproxy.com" rel="noopener ugc nofollow" target="_blank">或小提琴</a><a class="ae mj" href="http://fiddlertool.com" rel="noopener ugc nofollow" target="_blank">这样的中间人工具。</a></p><p id="e413" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">例如，要锁定<a class="ae mj" href="https://publicobject.com," rel="noopener ugc nofollow" target="_blank">https://publicobject.com，</a>从断开的配置开始:</p><figure class="mo mp mq mr gt is"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="eec6" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">不出所料，此操作会因异常而失败，请查看日志:</p><figure class="mo mp mq mr gt is"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="5294" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">现在将公钥散列粘贴到证书pinner的配置中:</p><figure class="mo mp mq mr gt is"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h1 id="7d76" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">在后台</h1><h2 id="481b" class="mw kr jb bd ks nd ne dn kw nf ng dp la lr nh ni lc lv nj nk le lz nl nm lg nn bi translated">挑战主持人</h2><p id="c4f3" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">首先要注意的是<code class="fe mk ml mm mn b">CertificatePinner</code>实现了<code class="fe mk ml mm mn b">ChallengeHandler</code>。这意味着它实现了所需的委托方法。它将在iOS引擎中被调用。</p><p id="4a32" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">这个<code class="fe mk ml mm mn b">Builder</code>和<code class="fe mk ml mm mn b">Pin</code>类使用户能够轻松地创建一组公钥来锁定。它们还提供通配符功能。你可以在课程文档中读到这方面的内容。</p><h2 id="f614" class="mw kr jb bd ks nd ne dn kw nf ng dp la lr nh ni lc lv nj nk le lz nl nm lg nn bi translated"><code class="fe mk ml mm mn b">NSURLSession</code>委派</h2><p id="9c1c" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated"><code class="fe mk ml mm mn b">invoke</code>功能是实际锁定功能发生的地方。</p><p id="05b7" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">首先，我从<code class="fe mk ml mm mn b">challenge</code>中检索<code class="fe mk ml mm mn b">hostname</code>。然后，我检查是否有针对该主机的引脚。然后我检查<code class="fe mk ml mm mn b">authenticationMethod</code>是否适合证书固定。</p><p id="a9c3" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">详见<a class="ae mj" href="https://developer.apple.com/documentation/foundation/nsurlauthenticationmethodservertrust?language=objc" rel="noopener ugc nofollow" target="_blank">苹果文档</a>。</p><p id="02a1" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">我检索<code class="fe mk ml mm mn b">serverTrust</code>并检查它的<a class="ae mj" href="https://developer.apple.com/documentation/security/2980705-sectrustevaluatewitherror" rel="noopener ugc nofollow" target="_blank">有效性</a>(如果配置了的话)。</p><p id="8512" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">现在到了我检查证书公钥和固定公钥的时候了。这里的大部分复杂性是以我想要的格式检索公钥。</p><p id="676f" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">一旦格式正确，我们就检查它是否与固定格式匹配，并返回结果。</p><h1 id="3aea" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">结论</h1><p id="5695" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">这是一个很难解决的问题。它涉及到使用Kotlin的C-interop特性，这可能很难掌握。</p><p id="3bf1" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">这个类可供您随意使用和更改。希望它也能帮助你解决这个问题。</p><p id="2cdd" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated"><em class="no">上一篇文章</em></p><div class="ip iq gp gr ir np"><a href="https://medium.com/@alistairsykes/kotlin-multiplatform-android-ios-connecting-coding-and-culture-a2412efd7c0c" rel="noopener follow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd jc gy z fp nu fr fs nv fu fw ja bi translated">Kotlin多平台Android/iOS:连接编码和文化</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">Kotlin多平台如何影响您的开发文化？</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">medium.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od ix np"/></div></div></a></div></div><div class="ab cl oe of hu og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="ij ik il im in"><p id="d705" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated"><em class="no">最初发表于</em><a class="ae mj" href="https://www.brightec.co.uk/blog/kotlin-multiplatform-ios-certificate-pinning" rel="noopener ugc nofollow" target="_blank"><em class="no">https://www.brightec.co.uk</em></a><em class="no">。</em></p></div></div>    
</body>
</html>