<html>
<head>
<title>The Risks and Dangers of Amplified Routing Loops.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">放大路由环路的风险和危险。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/the-risks-and-dangers-of-amplified-routing-loops-b052a9bd31bf?source=collection_archive---------10-----------------------#2021-04-14">https://levelup.gitconnected.com/the-risks-and-dangers-of-amplified-routing-loops-b052a9bd31bf?source=collection_archive---------10-----------------------#2021-04-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/fee48258903ef40c29eb72646529bc71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*igyT3V3nxGBScFE9"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Yves Scheuber 在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><blockquote class="kd ke kf"><p id="e54f" class="kg kh ki kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ir">本文将深入探讨网络环路以及它们如何被滥用为DDoS攻击的一部分。网络环路与现有的基于反射的攻击相结合，可以产生超过一千倍的流量放大系数。在本文中，我们将了解攻击者如何只需要50mb/s就能填满100gb/s的链路。我将在实验室环境中演示这一点。</strong></p><p id="d5ef" class="kg kh ki kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">本博客也呼吁所有网络工程师采取行动，清理那些挥之不去的网络环路，因为它们不仅仅是糟糕的卫生状况，也是重大的操作性DDoS风险。</p></blockquote><h1 id="3b6e" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">网络环路</h1><p id="b39b" class="pw-post-body-paragraph kg kh iq kj b kk md km kn ko me kq kr mf mg ku kv mh mi ky kz mj mk lc ld le ij bi translated">所有网络工程师都熟悉网络环路。网络环路会导致单个数据包在网络中来回跳动，同时消耗宝贵的网络资源(带宽和PPS)。IP网络出现环路有多种原因，通常是由配置错误引起的。针对网络环路的唯一真正“保护”是生存时间(TTL)检查。然而,“生存时间”检查对循环的保护更少，对它们永远循环的保护更多。</p><p id="60a7" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">生存时间(TTL)是指数据包在被路由器丢弃之前在网络中存在的时间或“跳数”。TTL是IP报头中的一个8位字段，因此它的最大值为255。大多数操作系统上的典型TTL值是64，在大多数情况下应该可以正常工作。</p><p id="e4cc" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">大多数网络工程师都知道环路不卫生。我认为对循环的操作风险的理解(或思考)要少得多。根据我的经验，大多数环路都是针对那些实际上并没有使用的IP地址的(否则，这将是一次中断)，所以通常情况下，解决这个问题最终会被搁置。</p><h2 id="ba91" class="ml lg iq bd lh mm mn dn ll mo mp dp lp mf mq mr lt mh ms mt lx mj mu mv mb mw bi translated">一个简单的循环示例</h2><p id="e1a5" class="pw-post-body-paragraph kg kh iq kj b kk md km kn ko me kq kr mf mg ku kv mh mi ky kz mj mk lc ld le ij bi translated">让我们看一个简单的例子。下图显示了两台路由器；想象一下，这些是您数据中心的核心或边缘路由器。</p><figure class="my mz na nb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/d1e489c7f99b80dd10b114c795743095.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qTSrjmBOqaTv--PPajeA5A.png"/></div></div></figure><p id="008c" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">不管出于什么原因，它们都认为192.0.2.0/24可以通过另一台路由器到达。因此，发往该目的地的数据包会在两台路由器之间来回传送。根据TTL值，用于该数据包的带宽为:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="45d0" class="ml lg iq nd b gy nh ni l nj nk">packet size in bytes x 8 x TTL. </span></pre><p id="27e3" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">这意味着对于一个512字节的数据包和60的TTL，使用的带宽量是245Kbs。换句话说，512字节的数据包在被丢弃之前变成了307，20字节(60x)。你可以把这个数字60看作放大系数。</p><h1 id="5270" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">但是..但是..网络环路很少见</h1><p id="7967" class="pw-post-body-paragraph kg kh iq kj b kk md km kn ko me kq kr mf mg ku kv mh mi ky kz mj mk lc ld le ij bi translated">那要看你对稀有的定义了。Qrator 的好人们监控互联网上的环路。根据Qrator的测量，大约有2000万个独特的环路(作为独特的路由器对来测量)。</p><figure class="my mz na nb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/847f81f5ac6bb5496be4d8901c02fbe2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s0AUKUQoHReU1s53r4AGaw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">来源:Qrator雷达。全局路由环路的数量</figcaption></figure><h1 id="021c" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">组合循环和常见的放大攻击。</h1><p id="ba5c" class="pw-post-body-paragraph kg kh iq kj b kk md km kn ko me kq kr mf mg ku kv mh mi ky kz mj mk lc ld le ij bi translated">现在，我们已经讨论了环路的风险及其超过100倍(TLL)的潜在放大系数，这可能会让您想起传统的DDoS攻击。</p><p id="65cc" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">你在新闻中读到的创纪录的DDOS攻击现在达到每秒数百千兆比特，并达到万亿比特的峰值。所有这些大容量度量攻击大多是同一类型的攻击，通常被称为放大或反射攻击。</p><p id="1204" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">它们依赖于攻击者发送一个带有假冒源IP的小数据包，然后该数据包被反射并放大到攻击目标。反射器/放大器通常是某种开放的UDP服务，接受一个小请求并产生一个大答案。典型的例子有DNS、NTP、SSDP和LDAP。您在新闻中读到的大型攻击通常结合了其中一些服务。</p><p id="7d04" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">到目前为止，将这两种类型的场景结合在一起的危险可能已经很明显了。让我们看一个例子。一个典型的DNS扩增查询可能是这样的，RRSIG的RRSIG查询</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="d5d7" class="ml lg iq nd b gy nh ni l nj nk"><br/>dig -t RRSIG irs.gov @8.8.8.8</span></pre><p id="44e6" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">这个查询在网络上有64个字节。得到的答案很大，需要分两个包发送；第一个包是1500字节，第二个包是944字节。所以总的来说，我们的放大系数是(1500+944)/64 = 38。</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="dbea" class="ml lg iq nd b gy nh ni l nj nk">IP (tos 0x0, ttl 64, id 32810, offset 0, flags [none], proto UDP (17), length 64)<br/>    192.168.0.30.57327 &gt; 8.8.8.8.53: 42548+ [1au] RRSIG? irs.gov. (36)</span><span id="bdff" class="ml lg iq nd b gy nm ni l nj nk">IP (tos 0x0, ttl 123, id 15817, offset 0, flags [+], proto UDP (17), length 1500)<br/>    8.8.8.8.53 &gt; 192.168.0.30.57327: 42548 8/0/1 irs.gov. RRSIG, irs.gov. RRSIG, irs.gov. RRSIG, irs.gov. RRSIG, irs.gov. RRSIG[|domain]</span><span id="3337" class="ml lg iq nd b gy nm ni l nj nk">IP (tos 0x0, ttl 123, id 15817, offset 1448, flags [none], proto UDP (17), length 944)<br/>    8.8.8.8 &gt; 192.168.0.30: ip-proto-17</span></pre><p id="897f" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated"><em class="ki">注意:有许多不同类型的放大攻击。这只是一个简单明了的DNS例子。此外，请注意，公共开放反射器(如公共DNS解析器)通常具有智能机制来限制可疑流量，以减少这些服务可能带来的负面影响。</em></p><p id="3433" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">上面的tcpdump输出显示，当答案从Google的DNS服务返回时，TTL值为123；这高于大多数其他公共DNS解析器(大多数默认为64)。</p><p id="75ef" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">如果我们将这种攻击与我们之前看到的“环路”因子(由TTL值决定)结合起来，我们就有了总放大因子。</p><h1 id="4e5f" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">把数字加起来</h1><p id="f3f2" class="pw-post-body-paragraph kg kh iq kj b kk md km kn ko me kq kr mf mg ku kv mh mi ky kz mj mk lc ld le ij bi translated">好，让我们继续研究DNS扩增的例子。放大倍数为38，TTL为123，则总放大倍数为:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="92d6" class="ml lg iq nd b gy nh ni l nj nk">38 * (123 / 2) = 2,337</span></pre><p id="7b38" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated"><em class="ki">请注意，我将TTL数除以2，这样我们就可以得到每个接收(RX)和发送(tx)数。</em></p><p id="b1e4" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">现在，我们用2337作为一个合理的总扩增数。攻击者需要什么样的流量才能产生10G或100G流量？一条10g链路饱和只需要5Mbs，一条100Gbs链路饱和大约需要50Mbs！这些数字低到足以从简单的家庭连接中产生。现在想象一下，一个心怀不轨并能访问更大僵尸网络的攻击者会做些什么…</p><h1 id="8ae3" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">让我们用一个演示来仔细检查一下</h1><p id="1b0f" class="pw-post-body-paragraph kg kh iq kj b kk md km kn ko me kq kr mf mg ku kv mh mi ky kz mj mk lc ld le ij bi translated">为了确保这一切都是可能的，并且数学上是合理的，我决定建一个实验室来重现我们上面看到的场景。</p><figure class="my mz na nb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/5867bc0a85206547b53fefef035d4f28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8CuFLCPtV9POhazPmjx2Dw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">事情的进展</figcaption></figure><p id="e03b" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">实验室包含四个设备:</p><ol class=""><li id="375a" class="no np iq kj b kk kl ko kp mf nq mh nr mj ns le nt nu nv nw bi translated">一个<strong class="kj ir">攻击者:</strong>发起基于DNS的反射攻击。(假冒的)源IP被设置为192.0.2.53</li><li id="106a" class="no np iq kj b kk nx ko ny mf nz mh oa mj ob le nt nu nv nw bi translated">一个<strong class="kj ir"> DNS解析器:</strong>接收DNS查询(带有伪造的源IP)并回复一个比原始问题大38倍的答案。DNS应答中的IP TTL值是123。</li><li id="2eda" class="no np iq kj b kk nx ko ny mf nz mh oa mj ob le nt nu nv nw bi translated">一个<strong class="kj ir">路由器对</strong> (rtr1 — rtr2):两个路由器都有一条指向彼此的192.0.2.0/24的路由。因此，目的IP为192.0.2.53的DNS应答将在两台路由器之间来回跳动，直到TTL过期。</li></ol><figure class="my mz na nb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/456c639a6b3f07f55123932cc3c026e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rBJV8ku4B8Zk93WK0S_8mw.png"/></div></div></figure><p id="e7fe" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">在上面的截图中，我们看到左上角的攻击者以5.9兆字节的速率发送查询。在左下角，我们看到DNS解析器以5.9兆字节的速率从客户端接收流量，并以大约173兆字节的速率回答查询。带有DNS响应的IP数据包的TTL为123。</p><p id="91d2" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">我们看到右边的路由器对:右上方的rtr1和右下方的rtr2。如您所见，两台设备都以10Gb/s的速度发送和接收。因此，在这种情况下，我们观察客户端(攻击者)如何将6mb/s变为10Gb/s。</p><h1 id="5359" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">包扎</h1><p id="a024" class="pw-post-body-paragraph kg kh iq kj b kk md km kn ko me kq kr mf mg ku kv mh mi ky kz mj mk lc ld le ij bi translated">在这篇博客中，我们探讨了网络环路的危险。我希望很清楚，循环不仅仅是一个卫生或装饰问题，而是暴露了一个重要的漏洞，应该尽快清理。</p><p id="fba7" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">我们看到，环路并不罕见，有数百万对路由器存在网络环路。事实上，根据Qrator的数据，超过30%的自治系统(ASN ),包括许多大型云提供商，都有带环路的网络。</p><p id="037c" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr mf kt ku kv mh kx ky kz mj lb lc ld le ij bi translated">我们观察到，攻击者可以轻松地使85Mbs的10G链路饱和(TTL为240 ),而无需任何UDP放大。或者，如果与典型的UDP放大攻击相结合，6mb的种子流量将在环路上产生10G的流量，或者60Mb/s的流量可能会填满100Gbs的路径！</p><h2 id="7cc6" class="ml lg iq bd lh mm mn dn ll mo mp dp lp mf mq mr lt mh ms mt lx mj mu mv mb mw bi translated">并非所有的循环都是相同的</h2><p id="4f55" class="pw-post-body-paragraph kg kh iq kj b kk md km kn ko me kq kr mf mg ku kv mh mi ky kz mj mk lc ld le ij bi translated">大多数环路发生在两台相邻的路由器之间；其中相当一部分出现在ISP路由器和客户路由器之间。我也看到过在欧洲和美国之间的环路中，多达8跳(路由器)跨越不同的城域网。这些跨大西洋环路成本高昂，而且很难迅速扩大规模。因此，像这样的链接上的循环会产生更大的影响。</p><h2 id="4acc" class="ml lg iq bd lh mm mn dn ll mo mp dp lp mf mq mr lt mh ms mt lx mj mu mv mb mw bi translated">行动呼吁</h2><p id="1ed1" class="pw-post-body-paragraph kg kh iq kj b kk md km kn ko me kq kr mf mg ku kv mh mi ky kz mj mk lc ld le ij bi translated">我希望这篇文章说服您检查您的网络是否存在环路，并确保您不会受到此类攻击的影响。考虑注册免费的<a class="ae kc" href="https://radar.qrator.net/" rel="noopener ugc nofollow" target="_blank"> Qrator </a>服务，当在您的网络中检测到新的环路(或其他问题)时，您会收到警报。</p></div></div>    
</body>
</html>