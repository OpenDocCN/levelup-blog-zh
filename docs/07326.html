<html>
<head>
<title>How to Use Gatling as a Performance Testing Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Gatling作为性能测试框架</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-use-gatling-as-a-performance-testing-framework-d95f1c90bbfc?source=collection_archive---------8-----------------------#2021-02-09">https://levelup.gitconnected.com/how-to-use-gatling-as-a-performance-testing-framework-d95f1c90bbfc?source=collection_archive---------8-----------------------#2021-02-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="984a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">安装和使用加特林的初学者指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/de43beecaccfb7f38ba2ade472715ae1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NJG3Xk4DaEm93Rg16p1sug.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Kolleen Gladden 在<a class="ae ky" href="https://unsplash.com/s/photos/performance?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="9ce8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Gatling是一个基于Scala的高性能负载测试工具。它使用Akka演员来模拟巨大的负载。默认情况下，它支持以下功能:</p><p id="32ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本质上，Gatling提供了对HTTP协议的强大支持，这使得它成为负载测试任何HTTP服务器的首选工具。它还支持WebSockets、JMS等。社区插件也支持其他协议。</p><p id="1ffd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">加特林网站上的<a class="ae ky" href="https://gatling.io/docs/current/" rel="noopener ugc nofollow" target="_blank">入门文档相当不错。它包括下载一个zip文件，然后运行BAT或SH脚本来启动Gatling。然后，您可以从列表中选择要运行的测试。如果您想将Gatling测试作为持续集成的一部分来运行，那么使用像Gradle或Maven这样的构建工具来做同样的设置会非常有帮助。</a></p><p id="7240" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将带您一步步地使用Gradle设置Gatling，并运行一些测试。</p><h1 id="6e9d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用Gradle设置加特林</h1><p id="b43f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">加特林的GitHub组织有一个我们可以使用的Gradle插件。</p><h2 id="b1db" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">克隆回购</h2><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="fc19" class="ms lw it nf b gy nj nk l nl nm">git clone https://github.com/gatling/gatling-gradle-plugin-demo.git</span><span id="313d" class="ms lw it nf b gy nn nk l nl nm">Cloning into 'gatling-gradle-plugin-demo'...<br/>remote: Enumerating objects: 83, done.<br/>remote: Counting objects: 100% (83/83), done.<br/>remote: Compressing objects: 100% (54/54), done.<br/>remote: Total 83 (delta 27), reused 61 (delta 14), pack-reused 0<br/>Unpacking objects: 100% (83/83), done.</span></pre><h2 id="5373" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">在某个IDE中打开repo</h2><p id="8b0e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">一旦设置完成，我们需要在一些IDE中打开代码。我已经为此使用了IntelliJ。</p><p id="d8ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到文件→打开→ <select directory="" where="" you="" cloned="" the="" plugin=""/></p><p id="71fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是build.gradle的样子</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="dcfc" class="ms lw it nf b gy nj nk l nl nm">plugins <strong class="nf iu">{<br/>    </strong>// The following line allows to load io.gatling.gradle plugin and directly apply it<br/>    id 'io.gatling.gradle' version '3.5.1'<br/><strong class="nf iu">}<br/><br/></strong>gatling <strong class="nf iu">{<br/>  </strong>// WARNING: options below only work when logback config file isn't provided<br/>  logLevel = 'WARN' // logback root level<br/>  logHttp = 'NONE' // set to 'ALL' for all HTTP traffic in TRACE, 'FAILURES' for failed HTTP traffic in DEBUG<br/><strong class="nf iu">}</strong></span></pre><h1 id="43f5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">开发模拟类</h1><p id="e0bd" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">要创建一个测试，我们需要做的第一件事是创建一个模拟类。在上面的例子中，回购已经附带了一个默认类—基本模拟。但是这里我们将从头开始编写一个新的模拟类</p><h2 id="f808" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">创建一个新的Scala类</h2><p id="49e5" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">右键单击scala目录并创建一个新的scala类。让我们将其命名为PerfTestSample。这个Scala类应该扩展Simulation类。</p><p id="ac34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为模拟类添加导入语句</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="230a" class="ms lw it nf b gy nj nk l nl nm">import io.gatling.core.scenario.Simulation</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/4d5e880149715600561c573597576f17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c6tSUhtybNg8eTGj13kXzA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">新的Scala模拟类。作者图片</figcaption></figure><h2 id="4c1d" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">添加所有导入</h2><p id="193b" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这可以在编写代码时完成，当错误出现时，但我只是提前分享它。这些是您将需要的导入:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="477e" class="ms lw it nf b gy nj nk l nl nm">import io.gatling.core.Predef._<br/>import io.gatling.core.scenario.Simulation<br/>import io.gatling.http.Predef._</span></pre><h2 id="b7c9" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">编写测试模拟类</h2><p id="4ea5" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">典型的模拟课程由三个主要部分组成</p><ol class=""><li id="38ce" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">HTTP协议配置</li><li id="dc7d" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">场景定义</li><li id="4e4a" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">模拟定义</li></ol><p id="d69b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在下面逐一探讨。</p><p id="2882" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们要做的第一件事是配置<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Overview" rel="noopener ugc nofollow" target="_blank"> HTTP </a>协议。下面是一个看起来像这样的例子:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="29f7" class="ms lw it nf b gy nj nk l nl nm">val <em class="od">httpConf </em>= http.baseUrl("http://localhost:8082/druid/")<br/>  .header("Content-Type", "application/json")<br/>  .proxy(Proxy("localhost", 8082))</span></pre><p id="684c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此基本URL将被添加到不以<code class="fe oe of og nf b">http.</code>开头的所有URL的前面</p><p id="33a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认情况下，Gatling试图以尽可能真实的方式模拟web浏览器。您可以使用<a class="ae ky" href="https://octoperf.com/blog/2020/03/05/kraken-gatling-getting-started-with-simulation-scripts/#the-http-protocol-configuration" rel="noopener ugc nofollow" target="_blank">各种配置选项</a>(应该添加在<code class="fe oe of og nf b">baseUrl()</code>语句之后)来改变这种行为:</p><ul class=""><li id="c9ac" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu oh nv nw nx bi translated"><code class="fe oe of og nf b">.maxConnectionsPerHost(4)</code>:在同一主机上获取资源时，要更改每个虚拟用户的并发连接数(默认为6)，</li><li id="3abb" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu oh nv nw nx bi translated"><code class="fe oe of og nf b">.disableAutoReferer</code>:禁用自动<em class="od">引用器</em> HTTP头计算，</li><li id="8b34" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu oh nv nw nx bi translated"><code class="fe oe of og nf b">.disableCaching</code>:禁用响应缓存(加特林使用<em class="od"> Expires </em>、<em class="od"> Cache-Control </em>、<em class="od"> Last-Modified </em>和<em class="od"> ETag </em>头缓存响应)</li></ul><p id="baa0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更多的配置可以在协议层进行管理:<a class="ae ky" href="https://gatling.io/docs/current/http/http_protocol/" rel="noopener ugc nofollow" target="_blank"> Gatling文档</a>。</p><p id="6cac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将研究如何定义一个场景。这是一个样品</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="f59b" class="ms lw it nf b gy nj nk l nl nm">val <em class="od">scn </em>= scenario("ScenarioName")<br/>  .exec(http("Submit Query")<br/>   .post("v2/sql").body(RawFileBody("&lt;FileName&gt;")))</span></pre><p id="620d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个例子中，我向http://localhost:8082/druid/v2/SQL提交一个post请求，并在一个文件中传递查询。正如您所看到的，前面部分中的基本URL是前置的。</p><p id="9308" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有一个可选的暂停方法来模拟用户在连续请求之间的思考时间。</p><p id="7d7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来是模拟定义。这告诉加特林你想如何模拟你的测试。下面是一个样本的样子:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="c098" class="ms lw it nf b gy nj nk l nl nm">setUp(<br/>  scn.inject(atOnceUsers(10))<br/>).protocols(<em class="od">httpConf</em>)</span></pre><p id="c1ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着有20个用户同时提交post请求。这是一个开放请求的例子，它无法控制并发用户的数量。开放式模型的其他一些例子有:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="2952" class="ms lw it nf b gy nj nk l nl nm">rampUsers(10) during(60 seconds)<!-- -->: to inject 10 users over 60 seconds,<br/>constantUsersPerSec(5) during(60 seconds)<!-- -->: to inject 5 users every second during a total of 60sec</span></pre><p id="ab53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">封闭模型是预先定义并发用户数量的模型。一些例子是:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="1d7f" class="ms lw it nf b gy nj nk l nl nm">constantConcurrentUsers(10) during(60 seconds)<!-- -->: to inject 10 concurrent users during 60 seconds,<br/>rampConcurrentUsers(5) to(15) during(30 seconds)<!-- --> : to inject 5 concurrent users at the start of the test and up to 15 concurrent users after 30 seconds.</span></pre><h2 id="0531" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">运行模拟</h2><p id="cd9f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">一旦我们定义了这三个部分，就该运行模拟了</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="fb0a" class="ms lw it nf b gy nj nk l nl nm">./gradlew gatlingRun-PerfTestSample</span></pre><p id="ba40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输出通常是一个HTML文件</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="64a0" class="ms lw it nf b gy nj nk l nl nm">Please open the following file: /Users/cinto/Desktop/gatling-gradle-plugin-demo/build/reports/gatling/perftestsample-20210208165203819/index.html</span></pre><h2 id="b449" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">查看输出</h2><p id="f642" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">您可以使用简单的open命令打开文件:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="2e35" class="ms lw it nf b gy nj nk l nl nm">open /Users/cinto/Desktop/gatling-gradle-plugin-demo/build/reports/gatling/perftestsample-20210208165203819/index.html</span></pre><p id="c5cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是一个样本文件的样子</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/ba92ef765060229577fc18afdc7e4574.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ynCLq7QV5uhx3-4bHilSAg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">加特林性能测试截图。作者图片</figcaption></figure><p id="4d71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">HTML页面上有更多的细节，如</p><ol class=""><li id="6f31" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">每秒请求数</li><li id="8e62" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">响应时间分布</li><li id="cd7f" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">每秒响应等</li></ol></div><div class="ab cl oj ok hx ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="im in io ip iq"><p id="bfe0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你现在已经知道什么是加特林，以及如何建立一个基本的加特林测试模拟。我在上面分享了一个例子，说明了我如何使用它来测试我的Apache Druid安装。</p></div></div>    
</body>
</html>