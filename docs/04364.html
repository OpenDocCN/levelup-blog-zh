<html>
<head>
<title>A cookbook to deal with throttling issues in Amazon DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一本处理Amazon DynamoDB节流问题的食谱</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/a-cookbook-to-deal-with-throttling-issues-in-amazon-dynamodb-f953c4ea4785?source=collection_archive---------5-----------------------#2020-06-23">https://levelup.gitconnected.com/a-cookbook-to-deal-with-throttling-issues-in-amazon-dynamodb-f953c4ea4785?source=collection_archive---------5-----------------------#2020-06-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><blockquote class="jq jr js"><p id="c120" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated">根据Amazon DynamoDB文档，它是一个完全托管的NoSQL数据库服务，提供快速和可预测的性能以及无缝的可伸缩性。DynamoDB让我们能够减轻操作和扩展分布式数据库的管理负担，因此我们不必担心硬件供应、设置和配置、复制、软件修补或集群扩展。</p></blockquote><p id="9610" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">DynamoDB还提供静态加密，这消除了保护敏感数据的操作负担和复杂性。</p><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi kv"><img src="../Images/c84bd0bd65da69a663457cc3035edf09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q1SqGhnaUzNmntqLJlR-Rg.jpeg"/></div></div><figcaption class="lh li gj gh gi lj lk bd b be z dk translated">来源:https://foxutech.com/how-to-create-a-dynamodb-table-on-aws/</figcaption></figure><p id="11ce" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">在DynamoDB表中，根据每个条目的分区键，条目被存储在许多<em class="jv">分区</em>中。每个分区都有一份表的调配的<strong class="jw iu"> RCU </strong>(读容量单位)和<strong class="jw iu"> WCU </strong>(写容量单位)。</p><p id="d989" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">当发出请求时，它会被路由到正确的数据分区，该分区的容量用于确定请求是被允许，还是将被<em class="jv">抑制</em>(拒绝)。应用程序应该预期并处理一定量的节流。</p><p id="d0b1" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated"><strong class="jw iu"> <em class="jv">过度节流是由</em> </strong>引起的:</p><blockquote class="jq jr js"><p id="eba2" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated"><strong class="jw iu">热分区:</strong>节流是由表中的几个分区引起的，这些分区接收的请求比平均分区多</p><p id="9f04" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated"><strong class="jw iu">容量不足:</strong>节流是由于表本身没有足够的容量来处理许多分区上的请求。</p></blockquote><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi lm"><img src="../Images/23da6b4b75191d2f87313e59b301ae04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o8E6CvH9EFOnxL5IWge6XQ.png"/></div></div></figure><p id="d1c4" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated"><strong class="jw iu"> <em class="jv">写节流的影响</em> </strong> —我们最终可能会错过可能导致下游系统级联故障的事件。</p><p id="1286" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated"><strong class="jw iu"> <em class="jv">读取限制的影响</em> </strong> —如果先前处理的记录无法检索，我们可能会结束处理双重/重复事件。</p><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi ln"><img src="../Images/ccc278ede99180935599c4fa8a5d9ce2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*69iNlaxq6RmlbS8cBjNqNw.png"/></div></div></figure><p id="1d9a" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">Amazon DynamoDB是一项NoSQL云数据库服务，旨在为大规模运行的应用程序和服务提供低延迟和高吞吐量性能。示例用例包括:</p><ul class=""><li id="9db0" class="lo lp it jw b jx jy kb kc ks lq kt lr ku ls kr lt lu lv lw bi translated"><em class="jv">大型多人在线游戏</em></li><li id="a1e2" class="lo lp it jw b jx lx kb ly ks lz kt ma ku mb kr lt lu lv lw bi translated"><em class="jv">虚拟和增强现实</em></li><li id="0781" class="lo lp it jw b jx lx kb ly ks lz kt ma ku mb kr lt lu lv lw bi translated"><em class="jv">电子商务中的结账和订单处理</em></li><li id="dae1" class="lo lp it jw b jx lx kb ly ks lz kt ma ku mb kr lt lu lv lw bi translated"><em class="jv">实时股票定价和交易</em></li></ul><p id="3280" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">当我们在全球范围内运行这样的系统时，我们偶尔会遇到延迟高峰。这些峰值可能是由于短暂的网络中断、服务器端和网络端问题或者客户端过载和速度慢而导致的重试造成的。</p><blockquote class="jq jr js"><p id="e28b" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated">DynamoDB旨在确保我们调配的容量每秒可用。如果我们为一个表提供每秒10次1kB的读取，那么DynamoDB将为我们提供足够的容量来处理这个吞吐率。此外，DynamoDB有时允许我们在短时间内实现有限的突发，超过我们提供的吞吐量。这是为了吸收客户工作负载的自然变化。这种突发不能保证，也不总是可用的(可用突发的性质可能会随着时间的推移而改变)。正如最佳实践文档中当前所述，为了获得最佳性能，我们应该有一个均匀分布的工作负载，该负载不超过我们调配的容量，并在关键空间上均匀分布负载。</p></blockquote><p id="f861" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">可以从AWS控制台调整调配的容量和自动扩展的容量，以根据应用程序的需求微调性能。</p><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi mc"><img src="../Images/14dcb718522be444a8a6f13e29c33894.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L8viB7r1d32G-Flsxayzbw.png"/></div></div></figure><p id="d1ff" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">不管根本原因是什么，与DynamoDB服务交互的应用程序应该调整为遵循<strong class="jw iu">重试策略</strong>，这有助于避免延迟高峰。</p><p id="005f" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">根据所使用的AWS SDK，底层HTTP客户端行为可以从默认设置重新配置，以帮助确保HTTP上的低级客户端-服务器通信满足应用程序的延迟要求。</p><p id="dd39" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">但是在这篇博客中，我将讨论AWS Java SDK为我们提供的对HTTP客户端行为和重试策略的控制。</p><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi md"><img src="../Images/3f0fa880c367d59bedbfa3b086c49a8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2yleMfQAu85M-PrBTbgH7w.jpeg"/></div></div></figure><p id="934b" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">下面是我为构建延迟感知型DynamoDB应用程序客户端而创建的更具体的配置。我用Java从头构建了一个异步DynamoDB客户端，并展示了如何使用AWS SDK中的<code class="fe me mf mg mh b">ClientConfiguration</code>实现来定义特定于应用程序的延迟需求。</p><p id="885f" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">在本例中，我创建了一个异步DynamoDB客户端，它可以对服务端点进行多次连续的DynamoDB API调用，而无需在发出下一个API调用之前等待响应返回。因为我希望我们的DynamoDB应用程序对延迟敏感，所以异步客户端应用程序是一个不错的选择。它可以准备和处理越来越多的从不同模块或微服务到后端的API调用，从而分离各个执行过程。</p><p id="b109" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">首先，我用函数<code class="fe me mf mg mh b">createDynamoDBClient()</code>和<code class="fe me mf mg mh b">createDynamoDBClientConfiguration()</code>创建了一个名为<code class="fe me mf mg mh b">DynamoDBConfig</code>的Java类。</p><p id="7a87" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated"><code class="fe me mf mg mh b">createDynamoDBClient()</code>函数返回一个异步DynamoDB客户端对象，该对象使用来自<code class="fe me mf mg mh b">ClientConfiguration</code>对象的低级HTTP客户端配置，这些配置由<code class="fe me mf mg mh b">createDynamoDBClientConfiguration()</code>私有API操作返回。正如我们在下面的代码示例中看到的，在<code class="fe me mf mg mh b">ClientConfiguration</code>对象创建期间设置了五个HTTP客户端配置参数:</p><blockquote class="jq jr js"><p id="a4ca" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated"><strong class="jw iu"><em class="it">connection time out</em></strong>:connection time out是客户端等待SDK中底层HTTP客户端与DynamoDB端点建立TCP连接的最长时间。该连接是客户端和服务器之间的端到端双向通信链接，它被用来和重用来进行API调用和接收响应。</p><p id="ab17" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated"><strong class="jw iu"><em class="it">ClientExecutionTimeout</em></strong>:ClientExecutionTimeout是执行端到端操作和接收所需响应所花费的最大允许总时间，包括可能发生的任何重试。本质上，这是DynamoDB操作的SLA完成所有HTTP请求的时间框架，包括重试。</p><p id="3d0a" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated"><strong class="jw iu">request time out</strong>:request time out是客户端执行一个HTTP请求所花费的时间。<code class="fe me mf mg mh b">RequestTimeout</code>是从发出DynamoDB API调用(比如<code class="fe me mf mg mh b">PutItem</code>或<code class="fe me mf mg mh b">GetItem</code>)的时刻开始测量的，直到收到来自服务的响应。从逻辑上讲，这个超时值应该小于<code class="fe me mf mg mh b">ClientExecutionTimeout</code>。与<code class="fe me mf mg mh b">ClientExecutionTimeout</code>一样，该设置默认禁用。</p><p id="606c" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated"><strong class="jw iu"><em class="it">socket time out:</em></strong>socket time out定义了HTTP客户端等待从已经建立的TCP连接读取数据的最长时间。这是HTTP POST结束和收到请求的整个响应之间的时间，包括服务和网络往返时间。</p><p id="24f8" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated"><strong class="jw iu"> <em class="it"> DynamoDB默认重试策略</em> </strong>:用于DynamoDB的AWS Java SDK中可用的默认重试策略是为底层HTTP客户端定义客户端重试策略的良好起点。对于任何5XX服务器端异常(如“HTTP状态代码-500内部服务器错误”或“HTTP状态代码-503服务不可用”)，默认策略开始时最多重试10次，预定义的基本延迟为25毫秒；对于任何4XX客户端异常(如“HTTP状态代码400-provisionedthroughputexceededexexception”)，则为500毫秒。<code class="fe me mf mg mh b">PredefinedBackoffStrategies</code>包括在这些重试中使用的两种回退策略。对于非节流的5XX请求，选择<code class="fe me mf mg mh b">FullJitterBackoffStrategy</code>并使用25毫秒的基本延迟，最大延迟为20秒。对于节流的4XX请求，使用<code class="fe me mf mg mh b">EqualJitterBackoffStrategy</code>。它从500毫秒的基本延迟开始，最长可以达到20秒，以500毫秒、1，000毫秒、2，000毫秒等指数级增长，直到达到20，000毫秒。</p></blockquote><p id="e72b" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">我已经通过配置文件(即我的spring-boot应用程序中的application.properties)将其作为输入，并使用@Value注释将它们的值注入到相应的变量中，从而为上述参数赋值。</p><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi mi"><img src="../Images/3be8d6c53a0b8c2105034075dd54f9b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aXtCryQKuiQT8-r7ybuQ7g.png"/></div></div><figcaption class="lh li gj gh gi lj lk bd b be z dk translated">DynamoDB客户端配置所需的配置变量的分配</figcaption></figure><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi mj"><img src="../Images/c7764355b450b8349e1e769303c7fbc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VyBZx3bsnDGpgqcReSQVqg.jpeg"/></div></div><figcaption class="lh li gj gh gi lj lk bd b be z dk translated">创建DynamoDBClient的源代码</figcaption></figure><ul class=""><li id="df17" class="lo lp it jw b jx jy kb kc ks lq kt lr ku ls kr lt lu lv lw bi translated"><strong class="jw iu"><em class="jv">DynamoDB Mapper</em></strong>:如果我们在应用程序中使用dynamo db Mapper类，它会在内部使用我之前提到的默认<code class="fe me mf mg mh b">ClientConfiguration</code>选项启动客户端。此外，这个类还使用自己的重试机制<code class="fe me mf mg mh b">DefaultBatchWriteRetryStrategy</code>，用于来自<code class="fe me mf mg mh b">BatchWriteItem</code> API调用的未处理项目。它包括一秒钟的最小延迟和三秒钟的最大延迟，以及指数退避策略。因此，使用带有默认设置的<code class="fe me mf mg mh b">DynamoDBMapper</code>类会给你的请求增加意想不到的额外延迟。换句话说，为了保持最大限度的控制，您应该考虑尽可能首先使用低级别的DynamoDB API操作，然后调整SDK级别的设置来定义应用程序在生产中的行为。</li></ul><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi mk"><img src="../Images/6f272387bf0f1746737e757deb16379e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ym-ks0sRNWZTFB2YoIz-NA.jpeg"/></div></div><figcaption class="lh li gj gh gi lj lk bd b be z dk translated">使用默认配置创建DynamoDBMapper的源代码</figcaption></figure><p id="451d" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">我们还可以覆盖DefaultDynamoDBMapperConfig，它可以在调用DynamoDBMapper方法时作为参数与一起传递。</p><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi ml"><img src="../Images/61a628f9c06ef7d88f88202ad31155f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ozaKVPvtso9mN7av8WDhtg.png"/></div></div><figcaption class="lh li gj gh gi lj lk bd b be z dk translated">带有定制重试策略的DynamoDBMapperConfig</figcaption></figure><p id="bb58" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">最后，如果默认策略不能解决我们的用例，那么在创建<code class="fe me mf mg mh b">ClientConfiguration</code>时，通过用<code class="fe me mf mg mh b">RetryPolicy</code> ( <code class="fe me mf mg mh b">PredefinedRetryPolicies.NO_RETRY_POLICY</code>)指定默认重试选项，用<code class="fe me mf mg mh b">NO_RETRY_POLICY</code>禁用它。我们也可以通过扩展<em class="jv">v2 compatiblebackoffstrategyadapter</em>类来实现我们自己的重试逻辑。</p><p id="0f65" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ks kg kh ki kt kk kl km ku ko kp kq kr im bi translated">目前就这些。回头见。:-)</p><h1 id="4019" class="mm mn it bd mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj bi translated">参考资料:</h1><div class="nk nl gp gr nm nn"><a href="https://stackoverflow.com/questions/16980678/when-does-dynamodb-throttle-request" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd iu gy z fp ns fr fs nt fu fw is bi translated">DynamoDB油门请求是什么时候？</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">感谢贡献一个堆栈溢出的答案！请务必回答问题。提供详细信息并分享…</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">stackoverflow.com</p></div></div><div class="nw l"><div class="nx l ny nz oa nw ob lf nn"/></div></div></a></div><div class="nk nl gp gr nm nn"><a href="https://aws.amazon.com/blogs/database/tuning-aws-java-sdk-http-request-settings-for-latency-aware-amazon-dynamodb-applications/" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd iu gy z fp ns fr fs nt fu fw is bi translated">为延迟敏感的Amazon DynamoDB应用程序调整AWS Java SDK HTTP请求设置| Amazon…</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">Amazon DynamoDB是一项NoSQL云数据库服务，旨在提供低延迟和高吞吐量…</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">aws.amazon.com</p></div></div><div class="nw l"><div class="oc l ny nz oa nw ob lf nn"/></div></div></a></div></div></div>    
</body>
</html>