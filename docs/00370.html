<html>
<head>
<title>Using the IndexedDB API with React (and Hooks)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将IndexedDB API与React(和钩子)一起使用</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/using-the-indexeddb-api-with-react-and-hooks-4e63d83a5d1b?source=collection_archive---------0-----------------------#2019-01-28">https://levelup.gitconnected.com/using-the-indexeddb-api-with-react-and-hooks-4e63d83a5d1b?source=collection_archive---------0-----------------------#2019-01-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8e36b810eff1e875703a814fda6232b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H4CDVRKvnZn_hwjS"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">凯文·Ku在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="8493" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">2019年2月7日编辑:React Hooks现在是React版本16.8.0的一个稳定特性。本教程现在使用16.8.1。</em></p><p id="4592" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">2019年2月21日编辑:我上传了一个演示到GitHub页面:</em><a class="ae kc" href="https://brookslybrand.github.io/react-indexeddb-example/" rel="noopener ugc nofollow" target="_blank">https://brookslybrand.github.io/react-indexeddb-example/</a></p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="8eb3" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">灵感</h1><p id="8fb2" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">我的公司正在开发一款令人兴奋的新产品，将目前完全靠笔和纸完成的流程数字化。和大多数新项目一样，没多久就发现了主要的障碍。</p><p id="9927" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们最初的一次发现会话中，我们意识到我们的应用程序需要能够完全脱机工作。更重要的是，由于我们的目标受众将在我们的应用程序上填写大量的表单，他们可能会在使用它时多次失去连接，因此表单数据必须是持久的。最后，我们正在构建一个渐进式web应用程序(PWA ),所以所有这些都必须在浏览器中使用javascript来完成。</p><p id="82c7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我开始研究我们的应用程序是否可以脱机运行时，我很快发现了<a class="ae kc" href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API" rel="noopener ugc nofollow" target="_blank"> IndexedDB API </a>。我很兴奋地了解了这个工具，以及如何利用浏览器中的磁盘来保存用户对表单所做的更改，即使他们脱机时也是如此。</p><p id="fed6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在研究过程中，我确实找到了至少一篇<a class="ae kc" href="https://itnext.io/indexeddb-your-second-step-towards-progressive-web-apps-pwa-dcbcd6cc2076" rel="noopener ugc nofollow" target="_blank">不错的文章解释了IndexedDB API的一些基础知识，但是我找不到一个使用React的例子，而这正是我真正想要的。经过一段时间的搜索，我放弃了，并决定建立自己的简单的例子。这是相当草率的，但我仍然能够创建我想要的概念证明。</a></p><p id="46e5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在这里查看我最初的尝试。</p><p id="3c03" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">后来，当我阅读MDN关于IndexedDB API的文档时，我意识到我忽略了一个重要的注意事项:</p><blockquote class="mm mn mo"><p id="c1c4" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><strong class="kf ir">注意</strong> : IndexedDB API很强大，但是对于简单的情况来说似乎太复杂了。如果您更喜欢简单的API，可以尝试使用一些库，如<a class="ae kc" href="https://localforage.github.io/localForage/" rel="noopener ugc nofollow" target="_blank">local feed</a>、<a class="ae kc" href="http://www.dexie.org/" rel="noopener ugc nofollow" target="_blank"> dexie.js </a>、<a class="ae kc" href="https://github.com/erikolson186/zangodb" rel="noopener ugc nofollow" target="_blank"> ZangoDB </a>、<a class="ae kc" href="https://pouchdb.com/" rel="noopener ugc nofollow" target="_blank"> PouchDB </a>和<a class="ae kc" href="http://jsstore.net/" rel="noopener ugc nofollow" target="_blank"> JsStore </a>，它们使得IndexedDB对程序员来说更加友好。</p></blockquote><p id="be84" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在快速浏览了所有选项、比较了API方法、包大小、npm上的每周下载量以及库的维护之后，我决定尝试使用<a class="ae kc" href="http://dexie.org" rel="noopener ugc nofollow" target="_blank"> Dexie.js </a>重写我的概念证明。根据dexie的描述:</p><blockquote class="mm mn mo"><p id="c1de" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">Dexie.js是IndexedDB的包装器库，indexed db是浏览器中的标准数据库。</p></blockquote><p id="1371" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我故意放慢向项目添加npm包的速度。然而，鉴于我是一个前端开发团队，我认为依靠其他人的知识和IndexedDB API的打包可能是实现我的目标的更好选择。</p><p id="a32a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是我如何使用Dexie.js、React和React即将推出的最激动人心的特性之一<a class="ae kc" href="https://reactjs.org/docs/hooks-intro.html" rel="noopener ugc nofollow" target="_blank"> Hooks </a>来解决在简单PWA上持久化数据的问题。</p><h1 id="6cf6" class="lj lk iq bd ll lm ms lo lp lq mt ls lt lu mu lw lx ly mv ma mb mc mw me mf mg bi translated">教程</h1><p id="4046" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">首先要注意的是，在本教程中，您将希望在所有开发和测试中使用匿名窗口。如果您使用常规窗口，除非您手动删除它，否则数据库不会被重置。使用隐名窗口，如果你搞砸了，或者想重新开始，你只需要关闭并重新打开窗口，一切都会恢复正常。你可以通过右击你的浏览器图标并点击“新建匿名[私人]窗口”来打开一个匿名窗口，或者在Windows上点击<code class="fe mx my mz na b">Ctrl + Shift + n </code>，或者在Mac上点击<code class="fe mx my mz na b">⌘ + Shift + n</code>来打开Chrome。</p><p id="8885" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们将使用<a class="ae kc" href="https://facebook.github.io/create-react-app/" rel="noopener ugc nofollow" target="_blank">创建-反应-应用</a>来使开始更容易。</p><p id="3bf9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在您的终端中，键入:</p><p id="4613" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mx my mz na b">npx create-react-app indexeddb-example &amp;&amp; cd indexeddb-example</code></p><p id="666b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们已经完成了React应用程序的设置，让我们删除所有不需要的内容:</p><p id="5723" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mx my mz na b">rm src/App.css src/App.test.js src/logo.svg</code></p><p id="ac55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">太好了！现在我们准备开始写了。首先，我们需要注册服务人员，以便我们的应用程序可以离线运行。我不打算详细介绍服务人员，但幸运的是，create-react-app使设置一个简单的服务人员变得很容易。如果您想了解更多关于使用React服务工作者的信息，<a class="ae kc" href="https://facebook.github.io/create-react-app/docs/making-a-progressive-web-app" rel="noopener ugc nofollow" target="_blank">这里是我开始</a>的地方。</p><p id="e20f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们需要知道的是，这将允许我们离线运行应用程序。需要注意的是，离线功能在我们运行<code class="fe mx my mz na b">npm run build</code>之前是不可用的，但是我们会实现的。在文件底部的<code class="fe mx my mz na b">src/index.js</code>中，将<code class="fe mx my mz na b">serviceWorker.unregister()</code>改为<code class="fe mx my mz na b">serviceWorker.register()</code>。你的<code class="fe mx my mz na b">index.js</code>现在应该是这样的:</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="9c1c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧，让我们进入<code class="fe mx my mz na b">src/App.js</code>。您可以删除该文件中的所有内容。我们的应用程序组件将非常简单。本质上，它只是一个包含<code class="fe mx my mz na b">Form</code>组件的div，带有一点逻辑，用于安装/卸载表单以供演示。</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="21e4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里有一些事情要做，但是首先我们需要继续安装Dexie.js</p><p id="bbe7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mx my mz na b">npm install dexie</code></p><p id="8b78" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mx my mz na b">App</code>包含一个简单的div，一个打开/关闭(挂载/卸载)表单的小按钮，以及实际挂载表单的逻辑。注意，每当我们装载表单时，我们也在创建数据库连接。如果我们的应用程序组件要经常重新呈现，这不是一个好主意，我们可能希望将它移动到一个状态钩子、redux或其他什么地方，但对于我们的目的来说，这将是很好的。</p><p id="a1ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在进入本教程的核心部分。让我们在<code class="fe mx my mz na b">src</code>中制作一个名为<code class="fe mx my mz na b">Form.js</code>的文件。为了让它工作，我们需要再安装一个npm包(最后一个，我保证)。这将允许我们动态隐藏我们的提交，直到客户端重新上线。</p><p id="7d21" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mx my mz na b">npm install react-detect-offline</code></p><p id="aee5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里是<code class="fe mx my mz na b">Form.js</code></p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="d36f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注释应该能够解释大部分代码，但是我们真正做的只是用React钩子制作一个受控表单。还没什么特别的。如果你运行<code class="fe mx my mz na b">npm start</code>，你会看到这个表单“有效”。但是，如果在键入后刷新页面，数据就会消失。我们还没有完全持久化数据。让我们利用我们传承下来的<code class="fe mx my mz na b">db</code>道具。首先，我们将使用另一个钩子，<code class="fe mx my mz na b">useEffect</code>(不要忘记在顶部从React导入它)。在您的<code class="fe mx my mz na b">useState</code>下方和事件处理程序上方添加以下代码:</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="e6ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个效果只有在<code class="fe mx my mz na b">db</code>道具改变的时候才会被调用，在我们的例子中，只有当它被安装的时候才会被调用。我们将它设置在第33行，这是第二个，也是<code class="fe mx my mz na b">useEffect</code>的可选参数。从第4行开始的第一个参数是一个函数，它</p><ol class=""><li id="e901" class="nh ni iq kf b kg kh kk kl ko nj ks nk kw nl la nm nn no np bi translated">连接或创建商店<code class="fe mx my mz na b">formData</code></li><li id="5928" class="nh ni iq kf b kg nq kk nr ko ns ks nt kw nu la nm nn no np bi translated">执行读/写事务</li><li id="7612" class="nh ni iq kf b kg nq kk nr ko ns ks nt kw nu la nm nn no np bi translated">获取<code class="fe mx my mz na b">firstname</code>和<code class="fe mx my mz na b">lastname</code>的值，如果它们不存在，则将它们设置为空字符串</li><li id="ac9a" class="nh ni iq kf b kg nq kk nr ko ns ks nt kw nu la nm nn no np bi translated">将存储中的值设置为州的值</li><li id="a4d7" class="nh ni iq kf b kg nq kk nr ko ns ks nt kw nu la nm nn no np bi translated">返回一个函数，该函数在该效果重新运行之前或组件卸载时被调用。该函数本身关闭数据库连接，因为一旦表单被卸载，我们就不再需要它了</li></ol><p id="7070" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">太好了，我们已经建立了数据库！但是我们还是遗漏了一些东西。我们需要我们的事件处理程序在发生变化时写入数据库，这样即使我们离线和/或刷新页面，数据也会被保存…也就是持久性。</p><p id="f203" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">幸运的是，这并不是很难完成。只需更新<code class="fe mx my mz na b">setName</code>，用id和新值调用<code class="fe mx my mz na b">formData</code>存储上的<code class="fe mx my mz na b">put</code>方法:</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="354e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！现在，您应该能够在表单中键入一些内容，刷新页面，并看到您的数据仍然在那里！要想知道即使你的应用程序离线也能工作，继续运行<code class="fe mx my mz na b">npm run build</code>，然后运行<code class="fe mx my mz na b">serve -s build/</code>。您可能需要首先全局安装<code class="fe mx my mz na b">serve</code>，这可以通过运行<code class="fe mx my mz na b">npm -g install serve</code>来完成。一定要打开一个匿名/私人窗口，进入localhost:5000，输入你的名字，离线(你可以从Chrome上的检查器的网络标签中完成)，刷新页面。</p><p id="0588" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你的应用程序有些地方不太正常，完整的项目可以在这个GitHub库中找到<a class="ae kc" href="https://github.com/brookslybrand/react-indexeddb-example/tree/master/dexie-example" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="3ee9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我希望这个小教程对任何想利用React应用程序内部的IndexedDB API的人有所帮助。如果你喜欢这个教程，请给它一个或两个掌声。如果我没有解释清楚，或者我的代码有问题，请留下评论。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><figure class="nb nc nd ne gt jr gh gi paragraph-image"><a href="https://levelup.gitconnected.com"><div class="gh gi nv"><img src="../Images/9914c5dd23ac08b70eea6f4f9ba6fed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E6CoI_MRyZ1JInNPsBSHtA.png"/></div></a></figure><div class="nw nx gp gr ny nz"><a href="https://gitconnected.com/learn/react" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd ir gy z fp oe fr fs of fu fw ip bi translated">学习React -最佳React教程(2019) | gitconnected</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">排名前49的React教程-免费学习React。课程由开发人员提交并投票，使您能够…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">gitconnected.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on jw nz"/></div></div></a></div></div></div>    
</body>
</html>