<html>
<head>
<title>Writing Plugins for Linux in Flutter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Flutter中为Linux编写插件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/writing-plugins-for-linux-in-flutter-38e46bd7872f?source=collection_archive---------5-----------------------#2020-08-09">https://levelup.gitconnected.com/writing-plugins-for-linux-in-flutter-38e46bd7872f?source=collection_archive---------5-----------------------#2020-08-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="1c83" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">众所周知，Flutter最近用<a class="ae ko" href="https://medium.com/flutter/announcing-flutter-linux-alpha-with-canonical-19eb824590a9" rel="noopener"> canonical </a>扩展了对linux的支持。有了它，我们现在可以更容易地用Flutter为linux构建和部署应用程序。</p><h1 id="daab" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">从升级Flutter开始</h1><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="46dd" class="lw kq it ls b gy lx ly l lz ma">flutter channel master<br/>flutter upgrade</span></pre><h1 id="5c30" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">在Flutter中启用Linux支持</h1><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="dff1" class="lw kq it ls b gy lx ly l lz ma">flutter config --enable-linux-desktop</span></pre><h1 id="79f8" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">让我们创建一个简单的电池插件</h1><p id="1931" class="pw-post-body-paragraph jq jr it js b jt mb jv jw jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">在这个例子中，我们将创建一个插件，它将为我们提供电池百分比水平及其技术。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="1dc4" class="lw kq it ls b gy lx ly l lz ma">flutter create -t plugin --platforms=linux battery</span></pre><h1 id="0f81" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">分析环境</h1><p id="2f47" class="pw-post-body-paragraph jq jr it js b jt mb jv jw jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">在你的插件文件夹中，你会得到一个包含处理你的方法通道的<code class="fe mg mh mi ls b">battery.dart </code>文件的<code class="fe mg mh mi ls b">lib</code>文件夹，一个包含演示你的插件使用的示例应用的<code class="fe mg mh mi ls b">example</code>文件夹和一个包含处理你的平台级方法的<code class="fe mg mh mi ls b">battery_plugin.cc</code>文件的<code class="fe mg mh mi ls b">linux</code>文件夹。平台级代码是用C++为Linux编写的。</p><p id="87d3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">每当收到来自Flutter的调用时，将调用函数<code class="fe mg mh mi ls b">battery_plugin_handle_method_call</code>。我们可以通过调用<code class="fe mg mh mi ls b">fl_method_call_get_name(method_call)</code>函数得到方法。响应将从linux平台以<code class="fe mg mh mi ls b">FlMethodResponse</code>数据类型发送。</p><p id="f527" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将在linux中处理的数据类型是<code class="fe mg mh mi ls b">FlValue</code>。以下是FlValue的一些示例:</p><p id="930b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于字符串:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="62f8" class="lw kq it ls b gy lx ly l lz ma">string flutter = "Flutter";<br/>g_autoptr(FlValue) converted = fl_value_new_string(flutter.c_str());</span></pre><p id="bdd5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于地图:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="6415" class="lw kq it ls b gy lx ly l lz ma">// Initialize a map.<br/>g_autoptr(FlValue) mapExample = fl_value_new_map();</span><span id="71d5" class="lw kq it ls b gy mj ly l lz ma">string flutter = "Flutter", dart = "Dart";</span><span id="9d2d" class="lw kq it ls b gy mj ly l lz ma">// Set a value in map.<br/>fl_value_set(mapExample, fl_value_new_string(flutter.c_str()),               fl_value_new_string(dart.c_str()));</span><span id="2f6a" class="lw kq it ls b gy mj ly l lz ma">// First parameter is the variable.<br/>// Second parameter is the key.<br/>// Third paramter is its value.</span></pre><p id="d2a0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要将FlValue转换为响应，我们必须使用:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="bea4" class="lw kq it ls b gy lx ly l lz ma">g_autoptr(FlMethodResponse) response = FL_METHOD_RESPONSE(fl_method_success_response_new(value));<br/>// It takes a FlValue as its parameter.</span></pre><p id="07c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">更多关于<code class="fe mg mh mi ls b">FlValue</code>的信息可以在这里找到<a class="ae ko" href="https://engine.chinmaygarde.com/fl__value_8h.html#a248fb199aa2cc2b92f692067e2d15cd9" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="c28e" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">让我们工作吧</h1><p id="ae30" class="pw-post-body-paragraph jq jr it js b jt mb jv jw jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">在<code class="fe mg mh mi ls b">lib/battery.dart</code>文件中，添加一个函数来调用<code class="fe mg mh mi ls b">getBatteryData</code>方法，如下所示:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="e6b4" class="lw kq it ls b gy lx ly l lz ma">static Future&lt;Map&lt;String, dynamic&gt;&gt; get getBatteryLevel async {<br/>    final Map&lt;String, dynamic&gt; version = Map&lt;String, dynamic&gt;.from(<br/>        await _channel.invokeMethod('getBatteryData')<br/>    );<br/>    return version;<br/>}</span></pre><p id="5e23" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是我们将在flutter应用程序中调用的getter。现在，在<code class="fe mg mh mi ls b">linux/battery_plugin.cc</code>中，我们必须为<code class="fe mg mh mi ls b">getBatteryData</code>方法通道添加一个条件。</p><figure class="ln lo lp lq gt mk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><blockquote class="mn mo mp"><p id="8853" class="jq jr mq js b jt ju jv jw jx jy jz ka mr kc kd ke ms kg kh ki mt kk kl km kn im bi translated">注意:这不是battery_plugin.cc的全部，只是我们实现的部分。</p></blockquote><p id="b97d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里，我们用C++打开linux系统文件来获取信息。我们使用文件<code class="fe mg mh mi ls b">/sys/class/power_supply/BAT1/capacity</code>获取电池百分比水平，使用文件<code class="fe mg mh mi ls b">/sys/class/power_supply/BAT1/technology</code>获取其技术。</p><h1 id="a0fb" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">现在到前端</h1><p id="36c2" class="pw-post-body-paragraph jq jr it js b jt mb jv jw jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">这是我们的<code class="fe mg mh mi ls b">main.dart</code>文件，它使用电池插件来获取电池数据。</p><figure class="ln lo lp lq gt mk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><h1 id="e394" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">运行应用程序</h1><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="3476" class="lw kq it ls b gy lx ly l lz ma">flutter run -d linux</span></pre><p id="1434" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要获取详细的调试数据，请使用:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="ccc6" class="lw kq it ls b gy lx ly l lz ma">flutter run -d linux -v</span></pre><h1 id="535b" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">就这样</h1><p id="32ac" class="pw-post-body-paragraph jq jr it js b jt mb jv jw jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">下面是作为linux可执行文件运行的应用程序的屏幕截图。</p><figure class="ln lo lp lq gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mu"><img src="../Images/e5f509dc3733dd6e365ca4eb3d19ae0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0mSEhpT4aCKYnVXCAP-JzA.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">电池插件示例</figcaption></figure><h2 id="76e0" class="lw kq it bd kr nf ng dn kv nh ni dp kz kb nj nk ld kf nl nm lh kj nn no ll np bi translated">github:<a class="ae ko" href="https://github.com/yash1200/flutter_battery_linux" rel="noopener ugc nofollow" target="_blank">https://github.com/yash1200/flutter_battery_linux</a></h2></div></div>    
</body>
</html>