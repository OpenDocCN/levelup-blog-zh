<html>
<head>
<title>Extending Kubectl with Plugins</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用插件扩展Kubectl</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/extending-kubectl-with-plugins-a9bf2d065441?source=collection_archive---------12-----------------------#2022-10-23">https://levelup.gitconnected.com/extending-kubectl-with-plugins-a9bf2d065441?source=collection_archive---------12-----------------------#2022-10-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7cfecd6d0bafcfd3e80296e2bbab48a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4X0BU-IwednDQiy0"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@silvawebdesigns?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">内森·达席尔瓦</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="2770" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">插件是软件扩展，可以加载到程序中以改进其功能。<code class="fe lb lc ld le b">kubectl</code>是一个工具，可以让你执行几乎所有与Kubernetes相关的任务。该工具用于列出集群和调试节点中的所有pod。kubectl的功能可以在插件的帮助下进行扩展。您可以创建kubectl插件来解决一些本质上复杂的用例。</p><h1 id="a057" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">但是kubectl插件是什么呢？</h1><p id="861f" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">插件是一个独立的可执行文件，其名称以<code class="fe lb lc ld le b">kubectl-</code>开头。要安装一个插件，把它的可执行文件移动到你的<code class="fe lb lc ld le b">PATH.</code>上的任何地方。Krew是<code class="fe lb lc ld le b">kubectl</code>插件的包管理器，也是Kubernetes SIG，旨在解决<code class="fe lb lc ld le b">kubectl.</code>的包管理问题</p><h1 id="2a1f" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">成为插件的标准</h1><p id="b9cb" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">有两个重要的标准可以成为一个kubectl插件</p><ol class=""><li id="7628" class="mi mj iq kf b kg kh kk kl ko mk ks ml kw mm la mn mo mp mq bi translated">插件二进制名称必须以<code class="fe lb lc ld le b">kubectl-</code>开头，后跟插件名称。Ex <code class="fe lb lc ld le b">kubectl-decode</code>，<code class="fe lb lc ld le b">kubectl-count</code>。</li><li id="86e6" class="mi mj iq kf b kg mr kk ms ko mt ks mu kw mv la mn mo mp mq bi translated">插件二进制文件必须出现在<code class="fe lb lc ld le b">PATH</code>变量中，这样kubectl才能识别它是插件。</li></ol><h1 id="cfa3" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">用例</strong></h1><p id="3a97" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们将创建一个kubectl插件来解码Kubernetes的秘密。我们都知道Kubernetes以base64解码格式存储秘密，如果要查看这些秘密的值，我们需要提取base64编码值，然后用纯文本解码。</p><figure class="mx my mz na gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/6e7762416c3614651c5147ba667507fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DK15eY4MWNitRhS6-ivtqg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><em class="nb">以base64格式存储的Kubernetes秘密</em></figcaption></figure><h1 id="b7bb" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">预期</h1><p id="a14a" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">让我们首先设置我们将要开发的插件的期望/预期输出。我们希望插件以纯文本形式返回base64编码的秘密。此外，它应该支持指定Kubernetes名称空间的方式。</p><figure class="mx my mz na gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/27cd8972bef9e5de3e4f2c0b88070483.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1dLPo-vRQFl2AK1ah31Xgw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">kubectl解码插件</figcaption></figure><h1 id="3bb7" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">履行</h1><p id="ddb8" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">对于本文，我们将使用shell脚本来创建这个插件，但是使用任何编程语言都可以做到这一点。</p><p id="5a19" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们希望这个插件像一个普通的kubectl命令一样工作，其中用户指定操作(创建、更新、删除和获取)和资源(pod、部署、配置映射、秘密)，用户也可以提供他想要执行该操作的名称空间，但是如果没有提供名称空间，则考虑默认名称空间。</p><p id="0185" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://youtu.be/2epdFWbiE_c" rel="noopener ugc nofollow" target="_blank">我用GoLang制作了一个关于创建kubectl插件的视频</a></p><ol class=""><li id="a3bf" class="mi mj iq kf b kg kh kk kl ko mk ks ml kw mm la mn mo mp mq bi translated">我们将创建一个名为<code class="fe lb lc ld le b">kubectl-decode</code>的文本文件，其中decode是我们插件的名称。</li><li id="827d" class="mi mj iq kf b kg mr kk ms ko mt ks mu kw mv la mn mo mp mq bi translated">接下来，将使用kubectl命令本身来获取秘密，在go-template的帮助下，我们可以迭代秘密并解码它们。</li><li id="2680" class="mi mj iq kf b kg mr kk ms ko mt ks mu kw mv la mn mo mp mq bi translated">将插件放在<code class="fe lb lc ld le b">PATH</code>变量中，这样kubectl就可以识别它是插件。</li></ol><pre class="mx my mz na gt nd le ne nf aw ng bi"><span id="8f70" class="nh lg iq le b gy ni nj l nk nl">#!/bin/bash</span><span id="44ec" class="nh lg iq le b gy nm nj l nk nl">if [ $# -lt 1 ]<br/>then<br/>  echo "invalid argument "<br/>  exit 1<br/>fi<br/>NAMESPACE="default"<br/>if [ "$2" = "-n" ]<br/>then<br/>   if [ $# -eq 3 ]<br/>   then<br/>     NAMESPACE=$3<br/>    fi<br/>fi</span><span id="f986" class="nh lg iq le b gy nm nj l nk nl">kubectl get secrets "$1" -o go-template='{{range $k,$v := .data}}{{printf "%s: " $k}}{{if not $v}}{{$v}}{{else}}{{$v | base64decode}}{{end}}{{"\n\n"}}{{end}}' -n "$NAMESPACE"</span></pre><h1 id="3e1c" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">总结</h1><p id="b5d9" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">当我们使用这个库时，我们可以将繁琐的任务简化得非常简单。kubectl插件对你来说可能看起来很复杂，但是相信我，它们会让你的生活变得更容易。</p><p id="a4ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">基于bash的插件有一些缺点，但是当您使用任何编程语言如go、java或nodejs时，这些缺点都可以很容易地解决。</p><p id="3eff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们学习了kubectl插件的基础知识，以及成为一个kubectl插件需要具备的条件，还了解了如何创建一个kubectl插件。</p><h1 id="849e" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">资源</h1><ol class=""><li id="8853" class="mi mj iq kf b kg md kk me ko nn ks no kw np la mn mo mp mq bi translated"><strong class="kf ir">【实现】</strong>该模式在本<a class="ae kc" href="https://github.com/adityajoshi12/kubernetes-development/tree/main/kubectl-plugins" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="nq">GitHub repo</em></strong></a>中完全实现</li><li id="ffeb" class="mi mj iq kf b kg mr kk ms ko mt ks mu kw mv la mn mo mp mq bi translated"><strong class="kf ir">【视频】</strong>详细的视频讲解可以在<a class="ae kc" href="https://youtu.be/QO7TRRPc1AY" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</li><li id="0ec3" class="mi mj iq kf b kg mr kk ms ko mt ks mu kw mv la mn mo mp mq bi translated"><strong class="kf ir">【GoLang】</strong>实现可以在<a class="ae kc" href="https://youtu.be/2epdFWbiE_c" rel="noopener ugc nofollow" target="_blank">这里找到</a></li></ol><p id="8154" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢您的阅读，我希望您能发现这是有用的！</p></div></div>    
</body>
</html>