<html>
<head>
<title>Mimic Laravel Model Events using Firebase and Cloud Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Firebase和Cloud函数模拟Laravel模型事件</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/mimic-laravel-model-events-using-firebase-and-cloud-functions-70357b5ac6f7?source=collection_archive---------12-----------------------#2020-03-28">https://levelup.gitconnected.com/mimic-laravel-model-events-using-firebase-and-cloud-functions-70357b5ac6f7?source=collection_archive---------12-----------------------#2020-03-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b7b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你正在读这篇文章的标题，并且在想:</p><blockquote class="kl km kn"><p id="767d" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">什么？敬哈？</p></blockquote><p id="a203" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那也许我忽略了这一点。但是如果你想的更多的是:</p><blockquote class="kl km kn"><p id="66f0" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">哦，我是一个使用传统后端的人，也对无服务器后端感兴趣。</p></blockquote><p id="b5c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后继续读下去。</p></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><p id="f226" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将谈谈为什么我如此喜欢使用<a class="ae kz" href="https://laravel-news.com/laravel-model-events-getting-started" rel="noopener ugc nofollow" target="_blank"> Laravel模型事件</a>，然后通过一个非常基本的例子来说明如何在基于Firebase的应用程序中使用类似的方法来驱动事件。</p><h1 id="a401" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">为什么我喜欢模特活动</h1><p id="a540" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">如果您熟悉Laravel，那么您可能会遇到一个方便的工具，用于在您的模型发生某些事情时触发事件。比如，你创建一个新的<code class="fe md me mf mg b">User</code>:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="9913" class="mp lb iq mg b gy mq mr l ms mt">/*<br/> * from a function somewhere in your Controller<br/> */</span><span id="9609" class="mp lb iq mg b gy mu mr l ms mt">\App\User::create([/*user data*/]);</span></pre><p id="0a94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在怎么办？也许他们会收到一封电子邮件:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="44ff" class="mp lb iq mg b gy mq mr l ms mt">/*<br/> * from a Listener that you registered<br/> */</span><span id="8e2c" class="mp lb iq mg b gy mu mr l ms mt">User::created(function($user) {<br/>  Mail::to($user-&gt;email)-&gt;send(new WelcomeEmail($user));<br/>});</span></pre><p id="656c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我的过度简化的代码代表了Laravel的因果功能，这使得确保某些事情总是发生变得简单，无论您在代码中的什么地方调用更改，这是一种提取复杂代码并将其划分的好方法。</p><h1 id="a35b" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">使用云函数和Firebase获得相同的行为</h1><p id="f918" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">如果你用过Firebase，那么你已经准备好了。如果没有，让我们花点时间讨论一下Firebase。</p><p id="22fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Firebase对我来说是相当新的，但是到目前为止，它为我提供了良好的服务。</p><p id="b9ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Firebase是web和应用程序开发人员的梦想，如果使用Flutter就更好了。它允许您非常快速、轻松地处理应用程序身份验证、数据库和存储。我还尝试了Android的应用分发功能，发现它比使用Play Store的Publisher dashboard要高效得多。</p><p id="792c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Firebase的另一个伟大特性是与Google Cloud的直接集成，也就是说，在这里是云功能。</p><h1 id="1068" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">选择一个数据库</h1><p id="a508" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">在你<a class="ae kz" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank">创建了你的Firebase项目</a>之后，你可能会想要选择一个数据库。查看<a class="ae kz" href="https://firebase.google.com/docs/database/rtdb-vs-firestore" rel="noopener ugc nofollow" target="_blank">这篇文章</a>了解如何设置。在下一步中，您将看到，基于<a class="ae kz" href="https://firebase.google.com/docs/auth" rel="noopener ugc nofollow" target="_blank"> Firebase身份验证</a>服务触发事件也是可能的，根本不需要数据库设置。</p><p id="7cd9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是因为我在这里的目标是演示一个类似于Laravel模型事件的功能，所以我将用一个使用Cloud Firestore(一个非常好的NoSQL选项)的例子来说明。</p><h1 id="6aed" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">创建云函数</h1><p id="8e88" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">让我们直接创建一个云函数来监听它发出电子邮件的提示。如果你以前没有这样做过，试试这个关于<a class="ae kz" href="https://cloud.google.com/functions/docs/quickstart-console" rel="noopener ugc nofollow" target="_blank">让设置开始使用云功能</a>的有用的小技巧。在“创建函数”部分，返回到这里了解设置触发器的详细信息。</p><p id="0cf4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，扳机！</p><p id="8bf4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是有趣的部分，这就是为什么我把你链接到所有其他无聊的东西，而不是在这里一步一步地看🤭。</p><figure class="mh mi mj mk gt mw gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/d55bc2fcb1487b87ce976e35434a6c49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*oCK5JwTtct4h0yTzKPj-IA.png"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">设置一个云函数来监听user_settings集合中文档的创建。</figcaption></figure><p id="fe63" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如前所述，我使用云Firestore作为我的数据库。在这个例子中，假设在您的项目的Firebase身份验证服务中创建了一个新用户，您还创建了一个名为<code class="fe md me mf mg b">user_settings</code>的集合文档(例如表条目),其中包含了这个用户的一些附加属性。设置文档的输入现在将导致上面定义的函数启动。</p><p id="50d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我真正喜欢的是另一件小事:安全。如果你从你的应用程序中与外部API来回通信，把访问和API密匙留在你的应用程序代码之外，并把它整齐地保存在云中。</p><p id="b04f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回到我们的例子，让我们发送电子邮件！我将展示一个使用我强烈推荐的<a class="ae kz" href="https://postmarkapp.com/" rel="noopener ugc nofollow" target="_blank">邮戳</a>的例子。</p><p id="351e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将使用Node.js 8作为上面选择的运行时来展示我的例子。</p><p id="1bf8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在在包裹里。JSON选项卡中的代码编辑器部分设置了几个库:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="045e" class="mp lb iq mg b gy mq mr l ms mt">{<br/>  "name": "sample-firestore",<br/>  "version": "0.0.1",<br/>  "dependencies": {<br/>    "nodemailer": "^6.4.0",<br/>    "nodemailer-postmark-transport": "^2.2.0",<br/>    "postmark": "^2.3.5"<br/>  }<br/>}</span></pre><p id="d0a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在索引中。JS编辑器:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="3db7" class="mp lb iq mg b gy mq mr l ms mt">const nodemailer = require('nodemailer');<br/>const postmarkTransport = require('nodemailer-postmark-transport')<br/>const postmark = require("postmark");</span><span id="7a55" class="mp lb iq mg b gy mu mr l ms mt">/**<br/> * Triggered by a change to a Firestore document.<br/> *<br/> * <a class="ae kz" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> {!Object} event Event payload.<br/> * <a class="ae kz" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> {!Object} context Metadata for the event.<br/> */<br/>exports.helloFirestore = (event, context) =&gt; {<br/>  const resource = context.resource;<br/>  // log out the resource string that triggered the function<br/>  console.log('Function triggered by change to: ' +  resource);<br/>  // now log the full event object<br/>  console.log(JSON.stringify(event));<br/>  <br/>  // Send an email:<br/>  var client = new postmark.ServerClient("[ENTER YOUR SERVER CLIENT KEY HERE]");</span><span id="f02e" class="mp lb iq mg b gy mu mr l ms mt">if (event.value.fields.email.stringValue != '') {<br/>    client.sendEmailWithTemplate({<br/>      "From": "welcome<a class="ae kz" href="mailto:hello@your-app-name.com" rel="noopener ugc nofollow" target="_blank">@your-app-name.com</a>",<br/>      "To": event.value.fields.email.stringValue,<br/>      "TemplateAlias": "welcome-email",<br/>      "TemplateModel": {<br/>        "content": "Welcome to Your-App-Name!",<br/>        "name": event.value.fields.name.stringValue,<br/>        "email": event.value.fields.email.stringValue<br/>      }<br/>    });<br/>  }<br/>};</span></pre><p id="51ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我在邮戳中设置了一个名为<code class="fe md me mf mg b">welcome-email</code>的模板，我只是使用<code class="fe md me mf mg b">TemplateModel</code>属性发送一些信息。你可能想要利用任意数量的可用服务来处理你的事务性电子邮件，比如<a class="ae kz" href="https://sendgrid.com/" rel="noopener ugc nofollow" target="_blank"> Sendgrid </a>或<a class="ae kz" href="https://www.mailgun.com/" rel="noopener ugc nofollow" target="_blank"> Mailgun </a>。我特别喜欢在邮戳中管理电子邮件模板的方式。</p><p id="27b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，只需部署您的函数，您就可以开始构建基础了！受够了这种欢迎邮件的东西…</p></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><p id="d08a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你手上有这么多权力，你会建造什么？无论您是刚刚开始云开发，还是云专家，我都希望听到您的反馈。你用什么服务来完成我正在讨论的事情？比起谷歌云函数，你更喜欢AWS Lambda函数吗？直接联系我或者在下面留下你的评论。</p><figure class="mh mi mj mk gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nd"><img src="../Images/b7a6eb69920084b7936f8d7d6b0633bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LV6xB4Haho37wd9-"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">泰勒·尼克斯在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure></div></div>    
</body>
</html>