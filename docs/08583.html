<html>
<head>
<title>Running SonarQube in AWS ECS as Docker Container by AWS Cloud Formation (IaC)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过AWS Cloud Formation (IaC)在AWS ECS中运行SonarQube作为Docker容器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/running-sonarqube-in-aws-ecs-as-docker-container-by-aws-cloud-formation-iac-8c0ff640f714?source=collection_archive---------7-----------------------#2021-05-14">https://levelup.gitconnected.com/running-sonarqube-in-aws-ecs-as-docker-container-by-aws-cloud-formation-iac-8c0ff640f714?source=collection_archive---------7-----------------------#2021-05-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="7b79" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ko translated">onarQube是一个静态代码分析工具，可以帮助你扫描源代码的质量、代码覆盖率和漏洞问题。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/5e12396bfc11e2bd873caa544ebcda7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*SqFrhNa-b5JL0jamdLl4uw.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">索纳库贝</figcaption></figure><p id="a4ab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我将向您展示如何使用AWS(Amazon Web Services)ECS(Elastic Container Services)服务将高度可用和可伸缩的SonarQube服务器作为Docker容器进行配置和运行。</p><p id="4173" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(<em class="lj">请注意，这不是一个Fargate解决方案，而是一个基于节点组的解决方案，因为SonarQube尚不支持无服务器技术，因为它在写入底层卷时受到限制</em>)</p><p id="bab7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">整个设置是使用<strong class="js iu"> AWS云形成</strong>模板作为基础设施代码(IaC)完成的。</p><p id="22b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们继续之前，先了解一下SonarQube。SonarQube有多种版本可供我们选择:</p><ol class=""><li id="107d" class="lk ll it js b jt ju jx jy kb lm kf ln kj lo kn lp lq lr ls bi translated"><strong class="js iu">社区版— </strong>免费版，适用于开源项目，但只扫描主分支。</li><li id="4e04" class="lk ll it js b jt lt jx lu kb lv kf lw kj lx kn lp lq lr ls bi translated"><strong class="js iu">开发者版</strong>支持22种语言，但不支持传统语言，如COBOL、RPG、PL/1、VB以及Apex。此外，开发者版提供了所有功能，但<strong class="js iu">不支持</strong>最重要的功能<strong class="js iu">项目组合管理</strong>和<strong class="js iu">报告生成</strong>。<a class="ae ly" href="https://www.sonarsource.com/plans-and-pricing/developer/" rel="noopener ugc nofollow" target="_blank">https://www.sonarsource.com/plans-and-pricing/developer/</a></li><li id="2d47" class="lk ll it js b jt lt jx lu kb lv kf lw kj lx kn lp lq lr ls bi translated"><strong class="js iu">企业版</strong>支持所有27种语言和所有特性，包括项目组合管理、报告生成、分支分析、泄漏期、质量关口、质量概况、代码气味、重复、复杂性、代码覆盖、技术债务、潜在缺陷、安全报告、热点、漏洞、分支分析、拉请求等。投资组合管理将有助于创建/定制仪表板、各种报告，包括执行报告、自动邮件、导入/导出、指标整合等。此外，企业版客户在获得主生产许可证的同时还获得了2个附加许可证(试运行/测试)。<a class="ae ly" href="https://www.sonarsource.com/plans-and-pricing/enterprise/" rel="noopener ugc nofollow" target="_blank">https://www.sonarsource.com/plans-and-pricing/enterprise/</a></li><li id="30ad" class="lk ll it js b jt lt jx lu kb lv kf lw kj lx kn lp lq lr ls bi translated"><strong class="js iu">数据中心版</strong>将具有与企业版相同的功能，但除此之外，它还具有“高可用性和高可扩展性”。<a class="ae ly" href="https://www.sonarsource.com/plans-and-pricing/data-center/" rel="noopener ugc nofollow" target="_blank">https://www.sonarsource.com/plans-and-pricing/data-center/</a></li></ol><h1 id="8d0d" class="lz ma it bd mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw bi translated"><strong class="ak">运行SonarQube的AWS网络图</strong></h1><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi mx"><img src="../Images/d213d64a0564d8633ed1df0d136dd415.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T0wEkW5wcaD_vdhmMymQSA.jpeg"/></div></div></figure><p id="cebc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里，我将运行<strong class="js iu">sonar cube Community Edition</strong>，但是您可以根据自己的选择自由选择任何其他docker容器，如Developer edition等。</p><pre class="ky kz la lb gt nc nd ne nf aw ng bi"><span id="aada" class="nh ma it nd b gy ni nj l nk nl">sonarqube:latest<br/>sonarqube:lts-developer<br/>sonarqube:lts-enterprise</span></pre><p id="3696" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有关SonarQube支持的更多Docker图像标签，请参考此处:</p><div class="nm nn gp gr no np"><a href="https://hub.docker.com/_/sonarqube?tab=tags&amp;page=1&amp;ordering=last_updated" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd iu gy z fp nu fr fs nv fu fw is bi translated">sonarqube标签- Docker Hub</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">SonarQube是一个用于持续检查代码质量的开源平台。</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">hub.docker.com</p></div></div></div></a></div><p id="d2b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本文展示的完整源代码包括AWS CloudFormation可以在这里获得。</p><div class="nm nn gp gr no np"><a href="https://github.com/vinod827/k8s-nest/tree/main/iac/aws/ecs" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd iu gy z fp nu fr fs nv fu fw is bi translated">vinod827/k8s-nest</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">所有k8s都住在这里。通过在GitHub上创建帐户，为vinod827/k8s-nest开发做出贡献。</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">github.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od ld np"/></div></div></a></div><p id="8ea7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦你从提供的GitHub库中克隆了源代码，你将会看到两个YAML文件，它们只不过是AWS CloudFormation模板:</p><ol class=""><li id="4fad" class="lk ll it js b jt ju jx jy kb lm kf ln kj lo kn lp lq lr ls bi translated"><a class="ae ly" href="https://github.com/vinod827/k8s-nest/blob/main/iac/aws/ecs/001-ecs-cluster-creation.yaml" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">001-ECS-Cluster-creation . YAML</strong></a><strong class="js iu"/>—负责创建AWS ECS集群</li><li id="0f04" class="lk ll it js b jt lt jx lu kb lv kf lw kj lx kn lp lq lr ls bi translated"><a class="ae ly" href="https://github.com/vinod827/k8s-nest/blob/main/iac/aws/ecs/002-ecs-service-creation.yaml" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">002-ecs-Service-creation . YAML</strong></a><strong class="js iu"/>—负责为SonarQube创建ECS服务。在这里，您还可以选择是否希望应用程序负载平衡器(ALB)类型为<strong class="js iu">内部</strong>或<strong class="js iu">面向互联网</strong></li></ol><p id="329c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在登录到AWS控制台，进入AWS CloudFormaton，然后上传第一个文件(<a class="ae ly" href="https://github.com/vinod827/k8s-nest/blob/main/iac/aws/ecs/001-ecs-cluster-creation.yaml" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">001-ecs-Cluster-creation . YAML</strong></a>)来创建ECS集群。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oe"><img src="../Images/011636e306e8cd03dad43d1e0bad2791.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YHdtHSL7zBWqyNdQahfUTQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">AWS云形成—创建ECS集群</figcaption></figure><p id="c109" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下一步是上传第二个文件(<a class="ae ly" href="https://github.com/vinod827/k8s-nest/blob/main/iac/aws/ecs/002-ecs-service-creation.yaml" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">002-ECS-service-creation . YAML</strong></a>)，其中会要求您提供一些参数，如RDS (Postgres)详细信息(因为SonarQube需要数据库支持生产级环境)、应用程序负载平衡器、Docker容器映像及其标签等。</p><p id="9c2c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(请稍候，因为RDS服务需要很长时间来创建新的Postgres数据库及其备份操作，然后才开始创建ECS服务)</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi of"><img src="../Images/d77ec66da0410f11e30b5732e981b956.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OikDHBKGwWNShNi3_-aUTg.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">AWS CloudFormation — ECS服务(针对SonarQube)</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi og"><img src="../Images/77f510ea737fa60b613e29cb48ceadd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qf8Zi2RhqGf1pDNpu0Cqcg.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">AWS云形成-可选参数</figcaption></figure><p id="5494" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">AWS CloudFormation服务需要一段时间来提供所有需要的服务，因为在幕后发生了许多事情，如创建RDS服务(Postgres数据库)、创建IAM角色/权限、ECS任务和ECS服务创建、提取SonarQube docker映像，以及最终提供您选择的负载平衡器(内部或面向互联网)。</p><p id="df69" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">准备就绪后，您可以查看CloudFormation的<strong class="js iu">输出</strong>部分(第二个模板，即<a class="ae ly" href="https://github.com/vinod827/k8s-nest/blob/main/iac/aws/ecs/002-ecs-service-creation.yaml" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">002-ECS-service-creation . YAML</strong></a>)以找到应用负载平衡器URL，或者前往EC2负载平衡器部分以查看在那里创建的新负载平衡器。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oh"><img src="../Images/36aeea8e3fbcc50d7347746d54cf409b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XBW2DobcihznkVYYFfrWDA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">自动气象站云形成-输出</figcaption></figure><p id="c80a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">复制负载平衡器URL，并在您的浏览器和boom中键入！您可以在AWS上设置和运行一个完全成熟的SonarQube。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oi"><img src="../Images/a7def5606396ba4accfc572d082bd762.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-6N_sDsEJXwD3sixwgJPnA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">索纳库贝</figcaption></figure><p id="e3ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以在AWS Route 53服务中使用新的托管区域进一步配置您的负载平衡器URL，以拥有类似于<a class="ae ly" href="https://quality.example.com" rel="noopener ugc nofollow" target="_blank">https://quality.example.com</a>的友好DNS，并配置TLS证书以使其安全。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oj"><img src="../Images/699cc5bc42c82efec9342e5480699d2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S6pgqesfrysUCpHYXZMkwg.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">53号公路— HostedZone</figcaption></figure><p id="a4c6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我的在<a class="ae ly" href="https://quality.acloudtiger.com" rel="noopener ugc nofollow" target="_blank">https://quality.acloudtiger.com</a>(可能，为了节省我的云账单的成本，会被关闭和删除:)</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ok"><img src="../Images/9ac38df0bbb80e0917a7b0be842fb202.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zHq2bh9mQ5OfwzAVACMhgw.png"/></div></div></figure><p id="98c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">键入<strong class="js iu">admin</strong>(sonar cube的默认凭证)作为登录和密码，以访问sonar cube服务器。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ol"><img src="../Images/43c7bfbec49bc9054952363f8e4f0a03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dwejOOtpyvVaCNDyUulwJQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">SonarQube服务器</figcaption></figure><p id="8676" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你喜欢这篇文章:)</p><p id="57d0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以将它与Jenkins、Atlassian Bamboo等持续集成服务器集成，以自动化生产就绪SonarQube服务器的整个流程。</p><p id="bb8a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请分享您的反馈:)</p><p id="d62f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您也可以将您的IaC贡献给这个项目:</p><div class="nm nn gp gr no np"><a href="https://github.com/vinod827/k8s-nest" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd iu gy z fp nu fr fs nv fu fw is bi translated">vinod827/k8s-nest</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">所有k8s都住在这里。通过在GitHub上创建帐户，为vinod827/k8s-nest开发做出贡献。</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">github.com</p></div></div><div class="ny l"><div class="om l oa ob oc ny od ld np"/></div></div></a></div><p id="ede8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">干杯:)</p></div></div>    
</body>
</html>