<html>
<head>
<title>Hacking with the Raspberry Pi Zero W</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Raspberry Pi Zero W黑客攻击</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/hacking-with-the-raspberry-pi-zero-w-8520a4d72b2e?source=collection_archive---------6-----------------------#2021-01-25">https://levelup.gitconnected.com/hacking-with-the-raspberry-pi-zero-w-8520a4d72b2e?source=collection_archive---------6-----------------------#2021-01-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9edd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">没有互联网连接…禁用蓝牙和WiFi…禁用外部媒体存储…硬盘加密…但这不是我们不能从这类机器中检索敏感信息的理由！我将分享的漏洞基于以下行为:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/922f4e0e4fd25f71f6613ac1e8b7a2d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*Z5zJO8rnaluM48KO9lwyMQ.gif"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">该图显示了在所有连接的键盘之间共享的键盘状态</figcaption></figure><p id="aee0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看看在一个键盘上切换<em class="kx"> Caps Lock </em>实际上是如何更新另一个键盘上的状态的——对于<em class="kx"> Scroll Lock </em>和<em class="kx"> Num Lock </em>也观察到相同的行为。这告诉我们，你的操作系统跟踪这些键盘状态，<strong class="jp ir">输出</strong>到所有连接的键盘设备。很抱歉我是显而易见的队长，但我们通常与键盘的互动也告诉我们，它是一个<strong class="jp ir">输入</strong>设备，将字符输入操作系统。这意味着，只要您的目标笔记本电脑/台式机有一个开放的USB端口，允许外部键盘连接，就可以取出数据。总而言之，以下是你需要的:</p><ul class=""><li id="9a77" class="ky kz iq jp b jq jr ju jv jy la kc lb kg lc kk ld le lf lg bi translated">允许通过USB连接外部键盘的目标笔记本电脑</li><li id="83ec" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">一个树莓派Zero W(约15美元)，安装了P4wnP1 A.L.O.A</li><li id="65f1" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">坚持完成这篇文章需要一些耐心</li></ul><p id="d7a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">P4wnP1 A.L.O.A(一个小的攻击性设备)为你提供了一个图像，可以将你的RPi Zero W转化为一个方便的pentest/trolling设备。它有两个重要的功能，1)欺骗目标机器，使其认为这是一个外部键盘，2)广播一个(隐藏的)WiFi热点/蓝牙连接，允许您在范围内控制它。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi lm"><img src="../Images/bb49cfb03f967e3c2798e9a3f8b8099d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hNRHSReehChBGzcnMTwcWA.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">RPi作为键盘提取信息的示意图</figcaption></figure><p id="ad92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上图显示了一个通用流程，说明如何在目标机器上触发一系列击键，以及如何从中检索所需信息。为了增加趣味，本指南将帮助您完成一个概念验证，该验证执行以下操作:</p><ol class=""><li id="058c" class="ky kz iq jp b jq jr ju jv jy la kc lb kg lc kk lr le lf lg bi translated">将一个键盘记录脚本注入目标机器，该脚本将击键输出到一个文本文件中</li><li id="8cbb" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk lr le lf lg bi translated">注入第二个脚本，该脚本读取文本文件，将其编码为一系列的<em class="kx"> Num </em>，<em class="kx"> Scroll </em>，<em class="kx"> Caps </em>按键，然后由RPi Zero W解码。</li></ol><p id="5c2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然P4wnP1 A.L.O.A可以在Windows、OSX和Linux上运行，但是我们将注入到目标机器中的脚本是Powershell脚本。您需要将它们改编成另一种语言，并且确信可以在您的目标机器上执行(例如，Python已经预装在OSX和大多数流行的Linux版本中)</p><h1 id="3e9a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">设置P4wnP1 A.L.O.A</h1><ul class=""><li id="976f" class="ky kz iq jp b jq mq ju mr jy ms kc mt kg mu kk ld le lf lg bi translated">从<a class="ae mv" href="https://github.com/RoganDawes/P4wnP1_aloa/releases" rel="noopener ugc nofollow" target="_blank">官方A.L.O.A GitHub发布页面</a>下载最新图片</li><li id="fd73" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">使用<a class="ae mv" href="https://www.balena.io/etcher/" rel="noopener ugc nofollow" target="_blank"> Balena Etcher </a>将图像闪存到microSD卡中</li><li id="56bc" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">将microSD卡插入RPi Zero W。确保microUSB电缆连接到第二个端口，然后将其插入<em class="kx">目标机器</em>。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi mw"><img src="../Images/1369fb9fd069b531914ed12ddbcee55a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ukzLXM6k1nfbEhRXgq9b3A.jpeg"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">将此microUSB端口用于电源和数据供应</figcaption></figure><ul class=""><li id="7c5f" class="ky kz iq jp b jq jr ju jv jy la kc lb kg lc kk ld le lf lg bi translated">1-2分钟后，您的RPi应开始广播WiFi热点，如下图所示。从<em class="kx">摄魂机</em>，使用密码<code class="fe mx my mz na b">MaMe82-P4wnP1</code>连接到摄魂机。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/3802c5b72dff0ea84a8f360bf33e31f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:410/format:webp/1*HNsHKqXTQaKyutupTMR3pg.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">RPi热点的SSID</figcaption></figure><ul class=""><li id="3e68" class="ky kz iq jp b jq jr ju jv jy la kc lb kg lc kk ld le lf lg bi translated">打开您的浏览器到<code class="fe mx my mz na b">http://172.24.0.1:8000</code>，它为您提供了一个方便的GUI来更改任何配置。借此机会隐藏/修改热点SSID。</li></ul><h1 id="9153" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">web GUI快速介绍</h1><p id="ed3a" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">首先，让我们看看<code class="fe mx my mz na b">USB SETTINGS</code>选项卡。为了确保您的RPi不会被<em class="kx">目标机器</em>阻塞，请确保在右下面板中仅启用了<em class="kx">键盘</em>功能。您还应该让您的RPi复制您的<em class="kx">目标机器</em>预期使用的外部键盘的产品描述。毕竟，当用户看到通知说'<em class="kx"> P4wnP1 by MaMe82 </em>'已经可以使用时，你不会想让目标机器的用户惊慌😅。快速的谷歌搜索会返回所需的罗技USB键盘信息。相关信息更新后，点击<code class="fe mx my mz na b">DEPLOY</code>使更改生效。要让这些设置在启动时运行，<code class="fe mx my mz na b">STORE</code>将其作为一个新的配置文件，并在<code class="fe mx my mz na b">GENERIC SETTINGS</code>选项卡下将其设置为默认值。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi nf"><img src="../Images/445a812832fe5f19dbdc195f2147d06a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3gLFW59ZJ7-sTGrAufOF3w.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">P4wnP1 A.L.O.A的USB设置</figcaption></figure><p id="13fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将关注<code class="fe mx my mz na b">HIDSCRIPT</code>选项卡，在这里我们可以配置要运行的脚本，以及返回的任何结果。花些时间浏览一下<a class="ae mv" href="https://github.com/RoganDawes/P4wnP1_aloa" rel="noopener ugc nofollow" target="_blank"> GitHub自述文件</a>，以及默认情况下A.L.O.A映像附带的默认脚本——可通过<code class="fe mx my mz na b">LOAD &amp; REPLACE</code>按钮访问。这允许您快速熟悉可供您使用的标准功能。请注意，虽然HID脚本是用JavaScript编写的，但是setTimeout、setInterval甚至Promises等方法似乎都不可用。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi ng"><img src="../Images/6e352afe6f7b62a9a48ba5018c2c9e84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MEwjnt10ZrOV31dfA_cbgA.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">P4wnP1 A.L.O.A的HID脚本</figcaption></figure><p id="1213" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每当脚本成功运行完成时，它将被附加到右侧面板的“成功”部分。如果您的脚本被编写为返回一个结果，您可以通过点击<code class="fe mx my mz na b">i</code>工具提示来查看详细信息。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/e91a8fd5a50029a93cf3f2126be24101.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/format:webp/1*LWQOVEkDIDxyZG3_TeHd5A.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">单击“I”工具提示查看脚本结果</figcaption></figure><h1 id="cd11" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">将字符映射到数字、滚动、大写锁定</h1><p id="c9cf" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">P4wnP1将Num、Scroll和Caps Lock按钮称为一组按键，称为<em class="kx"> LED按键</em>。如前所述，我们的目标是利用LED按键状态可以输出到键盘的事实，将数据从<em class="kx">目标机器</em>传输到RPi。为了容纳所有26个小写字母+空格键，我们可以将它们中的每一个映射到3个LED按键的唯一组合(因为3个按键= 27个按键)。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/38b127643bf592420be26d3789f71cd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*KIKljduwZ5GpQjz2ncdGWg.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">字符到LED按键的映射</figcaption></figure><p id="d2f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据A.L.O.A文档，注意到除了<em class="kx"> Num </em>、<em class="kx"> Scroll </em>和<em class="kx"> Caps Lock </em>之外，<code class="fe mx my mz na b">waitLED()</code>和<code class="fe mx my mz na b">waitAnyLED()</code>函数还返回了<em class="kx"> Compose </em>和<em class="kx"> Kana </em>的额外LED状态。我还没有尝试使用它们，但可能有必要将键盘改为日语布局，以便这两个额外的LED键正常工作。如果你真的让它们工作，你可以通过3次击键(5 = 125)大幅增加字符数。</p><h1 id="8781" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">HID脚本1:键盘记录器</h1><p id="5677" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">下面的Powershell脚本(改编自<a class="ae mv" href="https://gist.github.com/dasgoll/7ca1c059dd3b3fbc7277" rel="noopener ugc nofollow" target="_blank">这里是</a>)记录了用户输入到桌面上一个名为<code class="fe mx my mz na b">testing-log.txt</code>的文件中的字符。为便于调试，<code class="fe mx my mz na b">testing-log.txt</code>在<code class="fe mx my mz na b">CTRL + C</code>键记录取消后打开。在Powershell终端中执行该命令，以验证它是否按预期工作。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">键盘记录器Powershell脚本</figcaption></figure><p id="9b40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要做一些额外的工作，因为Powershell脚本预计将在目标机器上运行。假设我们的<em class="kx">目标机器</em>没有任何互联网连接，我们将需要让我们的RPi打开Powershell，并一次一个字符地输入脚本(谢天谢地，这只需要大约3秒)。请注意我们是如何在下面的HID脚本中将整个Powershell脚本压缩成一行(第11行)的。一定要警惕需要对特殊字符进行转义，比如<code class="fe mx my mz na b">"</code>和<code class="fe mx my mz na b">\</code>。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">用于将键盘记录器PS脚本注入<em class="nl">目标机器</em>的HID脚本</figcaption></figure><h1 id="2f8e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">HID脚本2:读取文件和启动LED键</h1><p id="f0bf" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">一旦您觉得键盘记录器有您想要的某些信息，您可以尝试使用第二个脚本获取它。首先，我们将依赖注入的Powershell脚本来读取<code class="fe mx my mz na b">testing-log.txt</code>文件，并将每个字符翻译成一系列LED按键。同时，HID脚本(JavaScript部分)必须准备好响应每个LED状态变化，并将这些变化映射回其原始字符。以下是Powershell脚本:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">用于读取日志文件和触发LED按键的Powershell脚本</figcaption></figure><p id="3c69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确保您的桌面上有一个包含一些内容的<code class="fe mx my mz na b">testing-log.txt</code>文件(只保留a-z和空格字符)。然后，在Powershell终端中运行上面的脚本。验证当它对日志文件的内容进行编码并触发LED按键时，键盘上的LED灯是否会发生变化。</p><p id="38a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像往常一样，一旦您对结果感到满意，我们就准备将整个Powershell脚本折叠成一行，并将其放在一个HID脚本中。需要注意的重要一点是我们在上面第54行引入Powershell脚本的延迟。通过在触发LED按键之前允许3s，我们允许HID脚本的JavaScript部分正确初始化。这确保了当LED按键被触发时，HID脚本准备好将它们翻译回实际的字符。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">HID脚本，用于注入触发LED按键的Powershell脚本，并将其解码为字符</figcaption></figure><h1 id="923c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">这个怎么执行？</h1><ol class=""><li id="7a18" class="ky kz iq jp b jq mq ju mr jy ms kc mt kg mu kk lr le lf lg bi translated">如果你只有一两分钟的时间，将RPi连接到<em class="kx">目标机器</em>上的USB端口。如果是台式机，你有更多的时间，你可以打开机箱，在主板上加一个USB接口，把你的RPi藏起来。</li><li id="7114" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk lr le lf lg bi translated">到达距离目标机器几米以内的地方，将您的手机连接到广播的热点。</li><li id="6bf6" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk lr le lf lg bi translated">当你从你的手机上触发HID脚本#1的时候，分散用户几秒钟的注意力(取消对<code class="fe mx my mz na b">hidePS()</code>的注释，并隐藏日志文件的位置)，这将启动键盘记录程序。</li><li id="216a" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk lr le lf lg bi translated">让用户输入一些敏感的东西……“嘿，兄弟，我登录XYZ系统有困难。您是否面临同样的问题？”</li><li id="bf35" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk lr le lf lg bi translated">当你触发HID脚本#2的时候，再次分散用户的注意力。这将对数据进行编码，触发LED按键，然后在RPi中对其进行解码。</li><li id="0e41" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk lr le lf lg bi translated">一旦脚本提取了数据，点击<code class="fe mx my mz na b">i</code>工具提示查看提取的内容(例如，在下图中，“苹果不是梨”)。</li></ol><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi nm"><img src="../Images/fa6e4e18e73fd6030e8c88a7fd426496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ozRrgdondMGTUMu3qTpAjg.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">查看从目标计算机提取的信息</figcaption></figure><h1 id="5239" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">结论</h1><p id="8794" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">只要你的机器不阻塞它的USB端口，你就不会安全地避免这种数据泄露。除了这里分享的材料之外，您的P4wnP1 A.L.O.A可以作为一个很好的工具来学习pentesting，因为它是建立在Kali Linux之上的。不过，在使用这些工具时一定要小心——学习如何更好地保护自己，与在密友的电脑上钓鱼，与非法/犯罪行为之间有一条细微的界限。</p><p id="6db8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于本指南中的脚本是用Powershell编写的，它们只与Windows <em class="kx">目标机器</em>相关。然而，它们可以很容易地适应其他操作系统支持的另一种语言。此外，我认为目前的实施是片状和不完整的。需要做额外的工作来覆盖全部键盘字符(映射功能增强)，以及处理按键发生得太快以至于丢失一些信息的情况(充当分隔符的LED按键序列？).</p><p id="9d65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不管你关注这篇文章是为了什么，我希望你喜欢它。黑客快乐！</p></div></div>    
</body>
</html>