<html>
<head>
<title>How to move a git tag using GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用GitHub动作移动git标签</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-move-a-git-tag-using-github-actions-e23a523eb325?source=collection_archive---------13-----------------------#2021-01-25">https://levelup.gitconnected.com/how-to-move-a-git-tag-using-github-actions-e23a523eb325?source=collection_archive---------13-----------------------#2021-01-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5597d9895da1a20e2d184ad947352e5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZHY7At82_njSoauYJB8COQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图片来自<a class="ae kc" href="https://pixabay.com/ru/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=3887038" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae kc" href="https://pixabay.com/ru/users/prettysleepy-2973588/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=3887038" rel="noopener ugc nofollow" target="_blank"> Prettysleepy </a></figcaption></figure><p id="58af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有时，您可能希望将标签作为GitHub操作管道的一部分进行移动或推进。</p><p id="bf73" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，确保您知道自己在做什么— <strong class="kf ir">在git存储库中移动标签通常是一个坏主意</strong>，因为它可能会扰乱其他人的存储库，并导致不可再现的构建和部署问题。但是，有一些工作流和情况证明移动标签是合理的。</p><p id="984b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，您的存储库中可能有一个<code class="fe lb lc ld le b">latest</code>或者一个<code class="fe lb lc ld le b">nightly</code>标签，您用它来执行每夜的构建。</p><p id="5c34" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想使用您的本地开发环境手动移动一个标记，这将非常简单:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="6118" class="ln lo iq le b gy lp lq l lr ls"># delete the tag both locally and in the origin remote<br/>git tag -d nightly<br/>git push origin :nightly</span><span id="6677" class="ln lo iq le b gy lt lq l lr ls"># recreate the tag at the new location<br/>git tag nightly<br/>git push origin nightly</span></pre><p id="0598" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是手工工作一点也不好玩。让我们尝试使用<a class="ae kc" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>来实现自动化。</p><p id="0f2f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们将创建一个新的<code class="fe lb lc ld le b">advance-nightly-tag.yaml</code>文件，并把它放到我们的<code class="fe lb lc ld le b">.github/workflows</code>文件夹中。出于测试目的，我们只在推送时触发它:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="71f6" class="ln lo iq le b gy lp lq l lr ls">name: "advance nightly tag"<br/>on:<br/>    push:<br/>jobs:<br/>    advanceNightlyTag:<br/>      runs-on: ubuntu-latest</span></pre><p id="5e17" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将有一个使用<code class="fe lb lc ld le b">actions/github-script</code>动作的单一步骤:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="f229" class="ln lo iq le b gy lp lq l lr ls">steps:<br/>- name: Advance nightly tag<br/>  uses: actions/github-script@v3<br/>  with:<br/>    github-token: ${{secrets.GITHUB_TOKEN}}          <br/>    script: |</span></pre><p id="ce05" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe lb lc ld le b">script</code>部分，我们基本上可以编写任何JavaScript代码。我们将使用<a class="ae kc" href="https://octokit.github.io/rest.js/" rel="noopener ugc nofollow" target="_blank"> oktokit/rest.js </a>，它可以在这个脚本中的<code class="fe lb lc ld le b">github-script</code>下使用，变量名为<code class="fe lb lc ld le b">github</code>。它允许我们使用JavaScript调用GitHub API。这里有一个调用将删除一个<code class="fe lb lc ld le b">nightly</code>标签:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="cc8c" class="ln lo iq le b gy lp lq l lr ls">github.git.deleteRef({<br/>  owner: context.repo.owner,<br/>  repo: context.repo.repo,<br/>  ref: "tags/nightly"<br/>})</span></pre><p id="5687" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里有一个调用将重新创建它，注意指向当前提交的<code class="fe lb lc ld le b">context.sha</code>参数:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="a65d" class="ln lo iq le b gy lp lq l lr ls">github.git.createRef({<br/>  owner: context.repo.owner,<br/>  repo: context.repo.repo,<br/>  ref: "refs/tags/nightly",<br/>  sha: context.sha<br/>})</span></pre><p id="bef4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以一个接一个地运行这两个调用，这很可能会成功。然而，我们将使我们的代码更具弹性:</p><ul class=""><li id="e08c" class="lu lv iq kf b kg kh kk kl ko lw ks lx kw ly la lz ma mb mc bi translated"><strong class="kf ir">这些对API的调用是异步的</strong>，这意味着第一个调用可能在第二个调用之前在服务器上执行，脚本将会失败。我们将在每次调用前添加<code class="fe lb lc ld le b">await</code>关键字，这样第二次调用只在第一次调用完成后执行；</li><li id="49ea" class="lu lv iq kf b kg md kk me ko mf ks mg kw mh la lz ma mb mc bi translated">如果标签最初不存在，第一次调用将会失败，所以我们将把它包装到<code class="fe lb lc ld le b">try-catch</code>中，并提供一个有意义的警告消息。</li></ul><p id="883f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里是我们的<code class="fe lb lc ld le b">advance-nightly-tag.yaml</code>文件的完整代码:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="610d" class="ln lo iq le b gy lp lq l lr ls">name: "advance nightly tag"<br/>on:<br/>    push:<br/>jobs:<br/>    advanceNightlyTag:<br/>      runs-on: ubuntu-latest<br/>      steps:<br/>      - name: Advance nightly tag<br/>        uses: actions/github-script@v3<br/>        with:<br/>          github-token: ${{secrets.GITHUB_TOKEN}}          <br/>          script: |<br/>            try {<br/>                await github.git.deleteRef({<br/>                  owner: context.repo.owner,<br/>                  repo: context.repo.repo,<br/>                  ref: "tags/nightly"<br/>                })<br/>            } catch (e) {<br/>              console.log("The nightly tag doesn't exist yet: " + e)<br/>            }<br/>            await github.git.createRef({<br/>              owner: context.repo.owner,<br/>              repo: context.repo.repo,<br/>              ref: "refs/tags/nightly",<br/>              sha: context.sha<br/>            })</span></pre><p id="7f33" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">GitHub动作<a class="ae kc" href="https://github.com/forketyfork/test-actions" rel="noopener ugc nofollow" target="_blank">的示例项目可以在GitHub </a>获得。</p></div></div>    
</body>
</html>