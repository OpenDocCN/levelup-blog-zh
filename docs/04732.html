<html>
<head>
<title>Use images from ECR with Jenkins pipeline on Kubernetes.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用来自ECR的图像和Kubernetes上的Jenkins pipeline。</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/use-images-from-ecr-with-jenkins-pipeline-on-kubernetes-f67dc83852e9?source=collection_archive---------1-----------------------#2020-07-12">https://levelup.gitconnected.com/use-images-from-ecr-with-jenkins-pipeline-on-kubernetes-f67dc83852e9?source=collection_archive---------1-----------------------#2020-07-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/a693f860c8aabfb321a77c7689705a64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IBqrzfoNFC2fd-ymP9mm3g.png"/></div></div></figure><p id="3fe6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">作为Cloudify.co公司的DevOps工程师，我正在基于Kubernetes和Jenkins建立一个新的CI/CD管道。最近，我将弹性容器注册与我们基于Jenkins的CI/CD集成在一起。在本指南中，我将分享这方面的知识。</p><p id="7f6a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们开始吧。</p><h2 id="d87f" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">什么是ECR —亚马逊弹性容器注册中心？</h2><blockquote class="lt lu lv"><p id="dfd5" class="kb kc lw kd b ke kf kg kh ki kj kk kl lx kn ko kp ly kr ks kt lz kv kw kx ky im bi translated">Amazon Elastic Container Registry(ECR)是一个完全托管的<a class="ae kz" href="https://aws.amazon.com/docker/" rel="noopener ugc nofollow" target="_blank"> Docker </a>容器注册表，它使开发人员可以轻松地存储、管理和部署Docker容器映像。亚马逊ECR与<a class="ae kz" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank">亚马逊弹性容器服务(ECS) </a>集成，简化你的开发到生产的工作流程。Amazon ECR消除了操作自己的容器存储库的需要，也不用担心底层基础设施的扩展。</p></blockquote><p id="4b2a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/ecr/</a></p><h2 id="3dd3" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">詹金斯是什么？</h2><blockquote class="lt lu lv"><p id="2c24" class="kb kc lw kd b ke kf kg kh ki kj kk kl lx kn ko kp ly kr ks kt lz kv kw kx ky im bi translated"><em class="it"> Jenkins是一款独立的开源自动化服务器，可用于自动化与构建、测试、交付或部署软件相关的各种任务。</em></p><p id="9e53" class="kb kc lw kd b ke kf kg kh ki kj kk kl lx kn ko kp ly kr ks kt lz kv kw kx ky im bi translated"><a class="ae kz" href="https://jenkins.io/doc/" rel="noopener ugc nofollow" target="_blank"><em class="it">https://jenkins.io/doc/</em></a></p></blockquote><h2 id="239f" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">詹金斯管道是什么？</h2><blockquote class="lt lu lv"><p id="e4c6" class="kb kc lw kd b ke kf kg kh ki kj kk kl lx kn ko kp ly kr ks kt lz kv kw kx ky im bi translated">Jenkins Pipeline(或简称为“Pipeline”，大写字母为“P”)是一套插件，支持将<em class="it">连续交付管道</em>实现和集成到Jenkins中。</p><p id="e058" class="kb kc lw kd b ke kf kg kh ki kj kk kl lx kn ko kp ly kr ks kt lz kv kw kx ky im bi translated"><a class="ae kz" href="https://www.jenkins.io/doc/book/pipeline/" rel="noopener ugc nofollow" target="_blank">https://www.jenkins.io/doc/book/pipeline/</a></p></blockquote><h2 id="7b4c" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">先决条件</h2><ul class=""><li id="1192" class="ma mb it kd b ke mc ki md km me kq mf ku mg ky mh mi mj mk bi translated">您必须有一个AWS帐户</li><li id="f6cc" class="ma mb it kd b ke ml ki mm km mn kq mo ku mp ky mh mi mj mk bi translated">Kubernetes上的Jenkins在您的集群上运行</li></ul><h1 id="5257" class="mq lb it bd lc mr ms mt lf mu mv mw li mx my mz ll na nb nc lo nd ne nf lr ng bi translated">在AWS上创建具有ECR完全访问权限和编程访问权限的用户</h1><h2 id="fde8" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">创建对ECR具有完全访问权限的策略</h2><p id="6374" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated">在AWS帐户中，转到服务-&gt; IAM -&gt;策略-&gt;创建策略-&gt; JSON</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="f410" class="la lb it np b gy nt nu l nv nw">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "ecr:*",<br/>                "cloudtrail:LookupEvents"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="d96e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">单击查看并创建策略</p><figure class="nk nl nm nn gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nx"><img src="../Images/d38a4e6ed00961727a5f281496cbd323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OsLRaHTjyH8KpKWJ5cfy9Q.png"/></div></div></figure><figure class="nk nl nm nn gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ny"><img src="../Images/f0a4b647f555c1ba035f35e096d42e9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1U9q9huyuAucW0U8g-u0hg.png"/></div></div></figure><h2 id="4bf4" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">使用我们创建的附加策略和编程访问权限创建一个用户</h2><p id="92b4" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated">在AWS帐户中，转到服务-&gt; IAM -&gt;用户-&gt;添加用户</p><p id="e95b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">选择编程访问</p><figure class="nk nl nm nn gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/660f8dde71980435511da32de9da1d9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sA-Ccdn4RBmbdDeoiCGu6Q.png"/></div></div></figure><p id="9da9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">附加创建的策略</p><figure class="nk nl nm nn gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oa"><img src="../Images/e9d86250a1947471993cc2693bb7b7e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FXREEZi9DYfBwt2OQyN9xg.png"/></div></div></figure><p id="c05b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建用户并下载。带有AWS编程访问凭据的csv文件</p><figure class="nk nl nm nn gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ob"><img src="../Images/7ff8b9cacef7fe1174c64546d5aebead.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LE7Aq3SWW_-mN4pocTvIWg.png"/></div></div></figure><h2 id="391e" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">将AWS CLI安装到您的计算机上</h2><p id="8244" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated"><a class="ae kz" href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/CLI/latest/user guide/install-CLI v2 . html</a></p><h2 id="5114" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">在你的机器上安装docker</h2><p id="f3a9" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated"><a class="ae kz" href="https://docs.docker.com/engine/install/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/engine/install/</a></p><h1 id="62b1" class="mq lb it bd lc mr ms mt lf mu mv mw li mx my mz ll na nb nc lo nd ne nf lr ng bi translated">如何用ECR认证？</h1><p id="f8be" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated">所以基本上你有两个选择:</p><h2 id="d0c0" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">选项1</h2><p id="d672" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated">将AWS _ ACCESS _ KEY _ ID/AWS _ SECRET _ ACCESS _ KEY作为环境变量导出到您的控制台/终端</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="5934" class="la lb it np b gy nt nu l nv nw">$ export AWS_ACCESS_KEY_ID=Your_access_key_id_from_csv</span><span id="7a58" class="la lb it np b gy oc nu l nv nw">$ export AWS_SECRET_ACCESS_KEY=your_secret_access_ key_from_csv</span></pre><h2 id="a913" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">选项2</h2><p id="0633" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated">使用“aws configure”设置您的凭据和区域，它会将凭据永久存储在您的＄HOME/中。aws目录</p><p id="9366" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于这两个选项，您需要使用AWS _ ACCESS _ KEY _ ID/AWS _ SECRET _ ACCESS _ KEY，您可以在下载中找到它。csv文件</p><h1 id="9b50" class="mq lb it bd lc mr ms mt lf mu mv mw li mx my mz ll na nb nc lo nd ne nf lr ng bi translated">创建亚马逊弹性容器注册中心</h1><p id="9a63" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated">在AWS帐户中，转到服务-&gt;弹性容器注册表</p><p id="8fe6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">点击“开始”</p><figure class="nk nl nm nn gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi od"><img src="../Images/af373eca9287e6d1c7595da94e594af5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FShQYLaEuQVPPZIJtXpB6w.png"/></div></div></figure><p id="05c2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为测试创建一个名为hello-world的存储库</p><figure class="nk nl nm nn gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oe"><img src="../Images/97fcf7dfbdf274d0ee0c55db1d6bd8e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FlypzLifHPxjQTYUBoFZZQ.png"/></div></div></figure><figure class="nk nl nm nn gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi of"><img src="../Images/4647f25ae89e5c242698bab234ca9850.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MlRwnRZxwqimgEU1PYRO3g.png"/></div></div></figure><p id="1217" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<strong class="kd iu">美国东部-1 </strong>地区创建ECR，<strong class="kd iu"> 796556984717 </strong>是您的AWS账户id</p><h1 id="9550" class="mq lb it bd lc mr ms mt lf mu mv mw li mx my mz ll na nb nc lo nd ne nf lr ng bi translated"><strong class="ak">用docker登录到AWS </strong></h1><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="ff06" class="la lb it np b gy nt nu l nv nw">$ aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 796556984717.dkr.ecr.us-east-1.amazonaws.com</span></pre><h1 id="3ae9" class="mq lb it bd lc mr ms mt lf mu mv mw li mx my mz ll na nb nc lo nd ne nf lr ng bi translated"><strong class="ak">测试您对ECR的访问权限</strong></h1><p id="0605" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated">确保你像我解释的那样配置了AWS或者导出了需要的变量，并且用docker登录了</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="89a1" class="la lb it np b gy nt nu l nv nw">$ aws ecr list-images --repository-name hello-world --region=us-east-1</span></pre><p id="bab1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你得到了类似这样的回复</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="f874" class="la lb it np b gy nt nu l nv nw">{</span><span id="0a37" class="la lb it np b gy oc nu l nv nw">  "imageIds": []</span><span id="267b" class="la lb it np b gy oc nu l nv nw">}</span></pre><p id="b4ce" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这意味着一切都配置正确，否则，你会得到拒绝访问的消息。</p><h1 id="9688" class="mq lb it bd lc mr ms mt lf mu mv mw li mx my mz ll na nb nc lo nd ne nf lr ng bi translated">如何创建图像并推送到ECR？</h1><p id="26e1" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated">让我们构建一个示例图像，并将它推送到ECR</p><p id="9405" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">示例图像的Dockerfile文件</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="b095" class="la lb it np b gy nt nu l nv nw">FROM alpine:3.4</span><span id="cbf3" class="la lb it np b gy oc nu l nv nw">RUN apk update &amp;&amp; \<br/>    apk add curl &amp;&amp; \<br/>    apk add git &amp;&amp; \<br/>    apk add vim</span></pre><p id="8c42" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从Dockerfile构建hello-world映像</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="1188" class="la lb it np b gy nt nu l nv nw">$ docker build -t hello-world .</span></pre><h2 id="66b4" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated"><strong class="ak">标记图像</strong></h2><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="7bc8" class="la lb it np b gy nt nu l nv nw"><br/>$ docker tag hello-world:latest 796556984717.dkr.ecr.us-east-1.amazonaws.com/hello-world:1.1</span></pre><h2 id="91e8" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated"><strong class="ak">推至集控室</strong></h2><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="15df" class="la lb it np b gy nt nu l nv nw">$ docker push 796556984717.dkr.ecr.us-east-1.amazonaws.com/hello-world:1.1</span></pre><p id="c934" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将我们的映像推送到hello-world存储库，版本是1.1</p><h2 id="0c62" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">检查hello-world存储库中是否存在我们的图像</h2><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="fced" class="la lb it np b gy nt nu l nv nw">$ aws ecr list-images --repository-name hello-world --region=us-east-1</span></pre><p id="3973" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">响应必须与此类似</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="c093" class="la lb it np b gy nt nu l nv nw">{<br/>  "imageIds": [<br/>    {<br/>      "imageDigest": "sha256:6045a7fdc628f8764cc52f6d0fe640029a2eb9b860bfc265c3ff9a5048068546",<br/>      "imageTag": "1.1"<br/>    }<br/>  ]<br/>}</span></pre><h1 id="8069" class="mq lb it bd lc mr ms mt lf mu mv mw li mx my mz ll na nb nc lo nd ne nf lr ng bi translated">那么如何在Kubernetes上使用带有Jenkins管道的ECR中的图像呢？</h1><p id="5f70" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated">我使用“Jenkins Kubernetes”插件在Jenkins上运行Kubernetes的工作流</p><h2 id="1b7b" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">Jenkins的Kubernetes插件是什么？</h2><blockquote class="lt lu lv"><p id="c019" class="kb kc lw kd b ke kf kg kh ki kj kk kl lx kn ko kp ly kr ks kt lz kv kw kx ky im bi translated"><em class="it">在Kubernetes集群中运行动态代理的Jenkins插件。</em></p><p id="1f69" class="kb kc lw kd b ke kf kg kh ki kj kk kl lx kn ko kp ly kr ks kt lz kv kw kx ky im bi translated"><em class="it">插件为每个启动的代理创建一个Kubernetes Pod，由Docker映像定义运行，并在每次构建后停止它。</em></p><p id="b338" class="kb kc lw kd b ke kf kg kh ki kj kk kl lx kn ko kp ly kr ks kt lz kv kw kx ky im bi translated"><a class="ae kz" href="https://plugins.jenkins.io/kubernetes/" rel="noopener ugc nofollow" target="_blank"><em class="it">https://plugins.jenkins.io/kubernetes/</em></a></p></blockquote><p id="a25f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您的管道的pod模板必须与此相似</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="58bc" class="la lb it np b gy nt nu l nv nw">apiVersion: v1<br/>kind: Pod<br/>spec:<br/>  containers: <br/>    - name:  hello-world<br/>      image: 796556984717.dkr.ecr.us-east-1.amazonaws.com/hello-world:1.1<br/>      command:<br/>      - cat<br/>      tty: true</span></pre><p id="5f82" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这意味着我们以一种常规的方式使用一个带有ECR路径的图像</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="3e87" class="la lb it np b gy nt nu l nv nw">image: 796556984717.dkr.ecr.us-east-1.amazonaws.com/hello-world:1.1</span></pre><h2 id="07bf" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">那么，在这种情况下，为什么我们不需要权限来访问我们管道中的ECR呢？</h2><p id="4285" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated">如果您像我一样使用EKS集群，它是使用eksctl实用程序或AWS CloudFormation模板创建的，默认情况下，所有创建的工作节点都需要IAM权限来访问ECR。</p><p id="5cd8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">每个工作节点都有“AmazonEKSWorkerNodePolicy”和所需的IAM策略权限。</p><p id="c3ca" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果不是这样，您需要将此策略附加到您的工作节点策略</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="fc49" class="la lb it np b gy nt nu l nv nw">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": [<br/>        "ecr:BatchCheckLayerAvailability",<br/>        "ecr:BatchGetImage",<br/>        "ecr:GetDownloadUrlForLayer",<br/>        "ecr:GetAuthorizationToken"<br/>      ],<br/>      "Resource": "*"<br/>    }<br/>  ]<br/>}</span></pre><p id="59fb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/ECR_on_EKS.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AmazonECR/latest/user guide/ECR _ on _ eks . html</a></p><h1 id="c94f" class="mq lb it bd lc mr ms mt lf mu mv mw li mx my mz ll na nb nc lo nd ne nf lr ng bi translated">结论</h1><p id="6cf9" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated">我在本指南中解释了如何在您的帐户中配置ECR，创建一个映像并将其推送到ECR存储库，然后使用Kubernetes上的Jenkins pipeline从ECR中提取一个映像，我还解释了为什么在许多情况下在Kubernetes集群(如EKS)上默认情况下它会工作。</p><p id="18c1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我希望这个指南对你有所帮助，感谢你的阅读。</p><p id="8bc6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你也可以在我的博客中读到:<a class="ae kz" href="https://igorzhivilo.com/" rel="noopener ugc nofollow" target="_blank">https://igorzhivilo.com/</a></p><p id="6ba1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于咨询演出，你可以通过<a class="ae kz" href="https://www.upwork.com/freelancers/warolv" rel="noopener ugc nofollow" target="_blank"> Upwork </a>联系我</p><h1 id="09bd" class="mq lb it bd lc mr ms mt lf mu mv mw li mx my mz ll na nb nc lo nd ne nf lr ng bi translated">参考</h1><p id="d269" class="pw-post-body-paragraph kb kc it kd b ke mc kg kh ki md kk kl km nh ko kp kq ni ks kt ku nj kw kx ky im bi translated"><a class="ae kz" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/getting-started-cli.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AmazonECR/latest/user guide/getting-started-CLI . html</a></p><p id="b0bb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/CLI/latest/user guide/install-CLI v2 . html</a></p><p id="a5c1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://docs.docker.com/engine/install/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/engine/install/</a></p><p id="4f3b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/ECR_on_EKS.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AmazonECR/latest/user guide/ECR _ on _ eks . html</a></p></div></div>    
</body>
</html>