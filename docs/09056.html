<html>
<head>
<title>Configuring OnPremises Azure DevOps 2020 Server with GitHub for CI/ CB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitHub为CI/ CB配置OnPremises Azure DevOps 2020服务器</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/configuring-onpremises-azure-devops-2020-server-with-github-for-ci-cb-146ab7758e53?source=collection_archive---------8-----------------------#2021-06-30">https://levelup.gitconnected.com/configuring-onpremises-azure-devops-2020-server-with-github-for-ci-cb-146ab7758e53?source=collection_archive---------8-----------------------#2021-06-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/1842516f559996a8d5d28d546f86c076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yg7-6zR7fZUp2biEimd0jw.jpeg"/></div></div></figure><p id="b1a6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我已经用TFS十多年了。我们在办公室使用一台服务器，它随着时间的推移慢慢从TFS升级到Azure DevOps服务器。它现在有2020版本，带有最新的补丁。作为参考，我将它与Windows Server 2019和SQL Server 2019配合使用(操作系统和服务器都已升级)。</p><p id="04e1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这样做的最初原因是，即使我们使用GitHub来存储代码，我们仍然需要一些东西来编写我们的测试用例。TFS附带了一个测试管理工具。</p><p id="fa2c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在过去的一周里，我不得不开始在这台服务器上使用构建和发布管道，因为我需要CI/ CB用于一些需要作为发布的一部分进行部署的本地应用程序。</p><blockquote class="kz la lb"><p id="9cc0" class="kb kc lc kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">当您有3个应用程序需要在总共6种不同的配置中部署时，手动部署不是一个选项&amp;手动部署需要一些时间。</p></blockquote><h1 id="b17a" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">酒店内的Azure DevOps</h1><h2 id="d997" class="me lh it bd li mf mg dn lm mh mi dp lq km mj mk lu kq ml mm ly ku mn mo mc mp bi translated">障碍1: GitHub集成</h2><p id="5eae" class="pw-post-body-paragraph kb kc it kd b ke mq kg kh ki mr kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">这很奇怪，但是当你设置一个构建管道时，云版本的GitHub并不作为一个选项被本地支持。</p><ul class=""><li id="2907" class="mv mw it kd b ke kf ki kj km mx kq my ku mz ky na nb nc nd bi translated">你必须选择“其他”</li><li id="41b1" class="mv mw it kd b ke ne ki nf km ng kq nh ku ni ky na nb nc nd bi translated">输入您的回购的URL</li><li id="3bb2" class="mv mw it kd b ke ne ki nf km ng kq nh ku ni ky na nb nc nd bi translated">输入您的用户名</li><li id="c5b8" class="mv mw it kd b ke ne ki nf km ng kq nh ku ni ky na nb nc nd bi translated">输入您的“令牌”作为密码，而不是真正的密码。</li></ul><p id="3dfc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您在创建构建管道时这样做，您将不知道如何获得这个“令牌”。</p><p id="0b82" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">学习如何做到这一点的最好方法是从左下角进入项目设置，并尝试设置一个“连接”。在那里你看到GitHub是一个选项。当您尝试进行此配置时:</p><ul class=""><li id="f710" class="mv mw it kd b ke kf ki kj km mx kq my ku mz ky na nb nc nd bi translated">它告诉你在github.com上的网址，你可以从那里得到你的令牌(纯文本)。</li></ul><p id="e3ce" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae nj" href="https://dev.azure.com/" rel="noopener ugc nofollow" target="_blank">https://dev.azure.com/</a>&lt;orgname&gt;/_用户设置/令牌</p><ul class=""><li id="0039" class="mv mw it kd b ke kf ki kj km mx kq my ku mz ky na nb nc nd bi translated">它告诉你令牌需要有什么权限(非常非常难看到，细文本)。</li></ul><p id="b14e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">本文将告诉您如何获取个人访问令牌，以便在您将部署到的OnPremises服务器上进行身份验证:</p><p id="5701" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae nj" href="https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops&amp;tabs=preview-page" rel="noopener ugc nofollow" target="_blank">使用个人访问令牌进行身份验证— Azure DevOps | Microsoft Docs </a></p><p id="cec3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，如果您没有选择所有推荐的权限，验证将会失败。因此，请确保选择正确的权限，然后获得令牌。</p><blockquote class="nk"><p id="569c" class="nl nm it bd nn no np nq nr ns nt ky dk translated">您在项目设置中创建的GitHub连接不会出现在构建管道中！</p></blockquote><p id="5f4e" class="pw-post-body-paragraph kb kc it kd b ke nu kg kh ki nv kk kl km nw ko kp kq nx ks kt ku ny kw kx ky im bi translated">这只是一个学习如何获得令牌的好方法。只需返回到构建管道并重用您在上述步骤中创建的令牌。</p><p id="8a08" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">这很难相信，但是构建管道现在可以获得你的代码并开始构建了！</strong></p><h2 id="6a90" class="me lh it bd li mf mg dn lm mh mi dp lq km mj mk lu kq ml mm ly ku mn mo mc mp bi translated">障碍2: nuget restore失败，出现关于未指定文件夹路径的神秘错误</h2><p id="d512" class="pw-post-body-paragraph kb kc it kd b ke mq kg kh ki mr kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">我花了一天的时间来确保构建代理得到更新，并安装了最新的VS 2019。我怀疑这是奇怪错误的根本原因——构建代理是不久前设置的，并且状态不佳。</p><p id="eb62" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">服务器硬件陈旧，速度很慢。加载页面的时间太长了。目前，我打算“顺其自然”,明天继续尝试完成构建管道。</p><p id="322f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">通过在nuget restore任务的高级设置中指定输出文件夹，我能够克服这个错误。这基本上设置为:“SolutionFolder/packages”(我就是这么做的)。</p><h2 id="bcda" class="me lh it bd li mf mg dn lm mh mi dp lq km mj mk lu kq ml mm ly ku mn mo mc mp bi translated">障碍3:我的服务器太旧了</h2><p id="dbac" class="pw-post-body-paragraph kb kc it kd b ke mq kg kh ki mr kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">即使我设法让我的构建工作，我注意到整个网站将在构建成功后挂起。在尝试了一整天之后，我最终决定转向Azure云</p><h1 id="b495" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">云上的Azure DevOps</h1><p id="edf5" class="pw-post-body-paragraph kb kc it kd b ke mq kg kh ki mr kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">这里，最大的障碍是我需要部署到OnPremises。幸运的是，它已经为我们的办公室设置了一个VPN，我已经用它将Azure虚拟机连接到我们的办公室。</p><p id="931b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我还必须提到，我已经在云上有了一个构建系统，但是它只能部署到云上。我不得不设置一个定制的构建VM Scaleset，因为常规的托管Azure解决方案没有足够的磁盘空间来处理我的源代码。</p><blockquote class="kz la lb"><p id="3159" class="kb kc lc kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">可以使用Azure CLI命令增加检索文件的驱动器的磁盘大小，但这涉及到停止虚拟机规模集。当您这样做时，DevOps管道池会发现虚拟机已关闭，因此它会删除并重新创建虚拟机。所以，我仍然在等待一个支持票来解决这个问题。目前，我已经通过从VS 2019安装程序中卸载所有我不需要的东西来管理。</p></blockquote><h2 id="c97c" class="me lh it bd li mf mg dn lm mh mi dp lq km mj mk lu kq ml mm ly ku mn mo mc mp bi translated">虚拟机规模集与开发运维管道的噩梦</h2><p id="50c7" class="pw-post-body-paragraph kb kc it kd b ke mq kg kh ki mr kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">请注意，在撰写本文时，如果您试图在创建虚拟机规模集时进行任何定制，DevOps将无法很好地处理它，并且它将进入一个可怕的循环，在这个循环中，它将尝试设置虚拟机、失败、删除、重新创建…直到永远。</p><p id="ffb1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，在创建VM scaleset时，不要打开任何时髦的新定制设置。我花了一天多的时间来学习这个，希望这能节省你一些时间。</p><h2 id="7476" class="me lh it bd li mf mg dn lm mh mi dp lq km mj mk lu kq ml mm ly ku mn mo mc mp bi translated">YAML疯狂</h2><p id="8581" class="pw-post-body-paragraph kb kc it kd b ke mq kg kh ki mr kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">当我在费力地完成了确保这一点的整个过程之后，试图设置构建管道时。NET 4.8，。NET Core等都在新构建的虚拟机上，它把我带到了对我来说毫无意义的可怕的YAML界面。</p><p id="00a2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您必须眯着眼睛才能看到用“经典方式”创建构建管道的选项。令人惊讶的是，Azure是如何设法让“易用的东西”变得“经典”的。</p><h2 id="e03f" class="me lh it bd li mf mg dn lm mh mi dp lq km mj mk lu kq ml mm ly ku mn mo mc mp bi translated">nuget restore仍然是一个问题</h2><p id="c620" class="pw-post-body-paragraph kb kc it kd b ke mq kg kh ki mr kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">当我选择ASP.NET构建管道时，nuget restore给了我同样的错误，原因和我在问题上注意到的一样。</p><p id="06e9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">显然，nuget restore对于云应用和常规ASP.NET应用的工作方式不同，或者模板已经过时。</p><p id="f4b9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我今天设法让构建工作，让我们看看我是否能在下周让部署工作！</p><h2 id="4f4f" class="me lh it bd li mf mg dn lm mh mi dp lq km mj mk lu kq ml mm ly ku mn mo mc mp bi translated">调试模式是关键</h2><p id="045a" class="pw-post-body-paragraph kb kc it kd b ke mq kg kh ki mr kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">我花了很多时间试图让部署工作。不管怎样，它都不会起作用。最终，我不得不启用调试模式来尝试理解错误。但是，部署没有调试错误，而是开始工作了！</p><p id="51bc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">未完待续……</strong></p></div></div>    
</body>
</html>