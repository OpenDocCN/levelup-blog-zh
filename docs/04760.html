<html>
<head>
<title>Manage Azure Event Hubs with Azure Service Operator on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Kubernetes上的Azure服务运营商管理Azure活动中心</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/manage-azure-event-hubs-with-azure-service-operator-on-kubernetes-be61decb069?source=collection_archive---------7-----------------------#2020-07-13">https://levelup.gitconnected.com/manage-azure-event-hubs-with-azure-service-operator-on-kubernetes-be61decb069?source=collection_archive---------7-----------------------#2020-07-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7932" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/Azure/azure-service-operator" rel="noopener ugc nofollow" target="_blank"> Azure Service Operator </a>是一个开源项目，帮助你使用Kubernetes提供和管理Azure服务。开发人员可以使用它从任何环境中提供Azure服务，无论是Azure、任何其他云提供商还是内部部署——Kubernetes是唯一的共同点！</p><p id="dc24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它也可以作为CI/CD管道的一部分，按需创建、使用和拆除Azure资源。在幕后，所有繁重的工作都由定义Azure资源的<a class="ae kl" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank">自定义资源定义</a>和相应的<a class="ae kl" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" rel="noopener ugc nofollow" target="_blank"> Kubernetes操作符</a>的组合来负责，后者确保自定义资源定义定义的状态也反映在Azure中。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/25007db0d74ef6809b596609a8eeb19b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*E5kMZF8tRWcNzy2M.jpg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Azure服务运营商</figcaption></figure><blockquote class="lc ld le"><p id="8a98" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">在这里阅读更多最近的公告—</em><a class="ae kl" href="https://cloudblogs.microsoft.com/opensource/2020/06/25/announcing-azure-service-operator-kubernetes/" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://cloud blogs . Microsoft . com/open source/2020/06/25/announding-azure-service-operator-kubernetes/</em></a></p></blockquote><p id="e490" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博文中:</p><ul class=""><li id="2314" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">你将获得Azure Service Operator的高级概述(在本博客中有时被称为<code class="fe ls lt lu lv b">ASO</code>)</li><li id="f5db" class="lj lk iq jp b jq lw ju lx jy ly kc lz kg ma kk lo lp lq lr bi translated">如何设置并使用它来提供<a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure事件中心</a></li><li id="54ce" class="lj lk iq jp b jq lw ju lx jy ly kc lz kg ma kk lo lp lq lr bi translated">将应用部署到使用Azure Event Hubs集群的Kubernetes</li></ul><blockquote class="lc ld le"><p id="9b3a" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">本GitHub回购</em><a class="ae kl" href="https://github.com/abhirockzz/eventhubs-using-aso-on-k8s" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://github.com/abhirockzz/eventhubs-using-aso-on-k8s</em></a>中有该代码</p></blockquote><h1 id="a3d5" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">开始使用…</h1><p id="ae48" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">Azure服务运营商支持许多Azure服务，包括数据库(<a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/introduction?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Cosmos DB </a>、<a class="ae kl" href="https://docs.microsoft.com/azure/postgresql/overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>、<a class="ae kl" href="https://docs.microsoft.com/azure/mysql/overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> MySQL </a>、<a class="ae kl" href="https://docs.microsoft.com/azure/azure-sql/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure SQL </a>等。)、核心基础架构组件(<a class="ae kl" href="https://docs.microsoft.com/azure/virtual-machines/linux/overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">虚拟机</a>、<a class="ae kl" href="https://docs.microsoft.com/azure/virtual-machine-scale-sets/overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">虚拟机规模集</a>、虚拟网络等。)和其他人也一样。</p><p id="62e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它还支持Azure Event Hubs，这是一个完全托管的数据流平台和事件摄取服务<a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-for-kafka-ecosystem-overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">，支持Apache Kafka </a>和Kafka生态系统中的其他工具。使用Azure Service Operator，您可以供应和管理Azure事件中心名称空间、事件中心和消费者组。</p><p id="6ad7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，让我们开始吧！在我们开始之前，请注意，您需要以下内容来试用本教程:</p><h2 id="cb55" class="ne mc iq bd md nf ng dn mh nh ni dp ml jy nj nk mp kc nl nm mt kg nn no mx np bi translated">先决条件</h2><p id="0a34" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">如果你还没有Azure帐户，那就先注册吧——你可以<a class="ae kl" href="https://azure.microsoft.com/free/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">免费获得！</a>请确认你已经安装了<a class="ae kl" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank"> kubectl </a>和<a class="ae kl" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank"> Helm 3 </a>。</p><p id="da01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尽管这篇博客中概述的步骤应该适用于任何Kubernetes集群(包括<code class="fe ls lt lu lv b">minikube</code>等)。)，我用的是<a class="ae kl" href="https://docs.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Kubernetes服务(AKS) </a>。你可以使用<a class="ae kl" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>、<a class="ae kl" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-portal?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure portal </a>甚至是<a class="ae kl" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-rm-template?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> ARM模板</a>来设置一个集群。一旦完成，只需<a class="ae kl" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?WT.mc_id=medium-blog-abhishgu#connect-to-the-cluster" rel="noopener ugc nofollow" target="_blank">配置</a> <code class="fe ls lt lu lv b"><a class="ae kl" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?WT.mc_id=medium-blog-abhishgu#connect-to-the-cluster" rel="noopener ugc nofollow" target="_blank">kubectl</a></code> <a class="ae kl" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?WT.mc_id=medium-blog-abhishgu#connect-to-the-cluster" rel="noopener ugc nofollow" target="_blank">指向它</a></p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="13fe" class="ne mc iq lv b gy nu nv l nw nx">az aks get-credentials --resource-group &lt;CLUSTER_RESOURCE_GROUP&gt; --name &lt;CLUSTER_NAME&gt;</span></pre></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><p id="c556" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，你现在可以…</p><h1 id="2261" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">…安装Azure服务运营商</h1><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi of"><img src="../Images/dccae43aef75fa824f55ae07dbf8e196.png" data-original-src="https://miro.medium.com/v2/resize:fit:500/0*Mf0s8xfw5YJ3-avJ.gif"/></div></figure><p id="f48e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">没有什么太花哨的…只是按照步骤使用<code class="fe ls lt lu lv b">Helm</code>安装它</p><p id="7715" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先安装<a class="ae kl" href="https://cert-manager.io/docs/installation/kubernetes/" rel="noopener ugc nofollow" target="_blank">证书管理器</a></p><h2 id="573d" class="ne mc iq bd md nf ng dn mh nh ni dp ml jy nj nk mp kc nl nm mt kg nn no mx np bi translated">设置<code class="fe ls lt lu lv b">cert-manager</code></h2><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="5074" class="ne mc iq lv b gy nu nv l nw nx">kubectl create namespace cert-manager</span><span id="6bd7" class="ne mc iq lv b gy og nv l nw nx">kubectl label namespace cert-manager cert-manager.io/disable-validation=true</span><span id="65d7" class="ne mc iq lv b gy og nv l nw nx">kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v0.12.0/cert-manager.yaml</span><span id="1122" class="ne mc iq lv b gy og nv l nw nx">//make sure cert manager is up and running<br/>kubectl rollout status -n cert-manager deploy/cert-manager-webhook</span></pre><h2 id="84d9" class="ne mc iq bd md nf ng dn mh nh ni dp ml jy nj nk mp kc nl nm mt kg nn no mx np bi translated">认证…</h2><p id="6364" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">由于操作员将在Azure上创建资源，我们需要通过提供适当的凭证来授权它这样做。目前，您可以使用<a class="ae kl" href="https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">托管身份</a>或<a class="ae kl" href="https://docs.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals?WT.mc_id=medium-blog-abhishgu#service-principal-object" rel="noopener ugc nofollow" target="_blank">服务主体</a></p><p id="03d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将使用一个服务主体，所以让我们从使用<a class="ae kl" href="https://docs.microsoft.com/cli/azure/ad/sp?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-ad-sp-create-for-rbac" rel="noopener ugc nofollow" target="_blank"> az ad sp create-for-rbac </a>命令创建一个服务主体开始(使用<a class="ae kl" href="https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a></p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="d0e5" class="ne mc iq lv b gy nu nv l nw nx">az ad sp create-for-rbac -n "aso-rbac-sp"</span><span id="ccb8" class="ne mc iq lv b gy og nv l nw nx">//JSON output<br/>{<br/>  "appId": "eb4280db-4242-4ed0-a7d2-42424242f0d0",<br/>  "displayName": "aso-rbac-sp",<br/>  "name": "http://aso-rbac-sp",<br/>  "password": "7d69a422-428d-42d4-a242-cd1d425424b2",<br/>  "tenant": "42f988bf-42f1-42af-42ab-2d7cd421db42"<br/>}</span></pre><h2 id="9fcc" class="ne mc iq bd md nf ng dn mh nh ni dp ml jy nj nk mp kc nl nm mt kg nn no mx np bi translated">安装</h2><p id="e6e4" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">设置所需的环境变量:</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="d41a" class="ne mc iq lv b gy nu nv l nw nx">export AZURE_SUBSCRIPTION_ID=&lt;enter Azure subscription ID&gt;<br/>export AZURE_TENANT_ID=&lt;enter value from the "tenant" attribute in the JSON payload above&gt;<br/>export AZURE_CLIENT_ID=&lt;enter value from the "appId" attribute in the JSON payload above&gt;<br/>export AZURE_CLIENT_SECRET=&lt;enter value from the "password" attribute in the JSON payload above&gt;<br/>export AZURE_SERVICE_OPERATOR_NAMESPACE=&lt;name of the namespace into which ASO will be installed&gt;</span></pre><p id="c0aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加repo，创建命名空间</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="ce03" class="ne mc iq lv b gy nu nv l nw nx">helm repo add azureserviceoperator https://raw.githubusercontent.com/Azure/azure-service-operator/master/charts</span><span id="67ca" class="ne mc iq lv b gy og nv l nw nx">kubectl create namespace $AZURE_SERVICE_OPERATOR_NAMESPACE</span></pre><p id="2751" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe ls lt lu lv b">helm upgrade</code>启动设置:</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="1f05" class="ne mc iq lv b gy nu nv l nw nx">helm upgrade --install aso azureserviceoperator/azure-service-operator \<br/>-n $AZURE_SERVICE_OPERATOR_NAMESPACE \<br/>--set azureSubscriptionID=$AZURE_SUBSCRIPTION_ID \<br/>--set azureTenantID=$AZURE_TENANT_ID \<br/>--set azureClientID=$AZURE_CLIENT_ID \<br/>--set azureClientSecret=$AZURE_CLIENT_SECRET</span></pre><p id="610b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在继续之前，请等待Azure服务操作器<code class="fe ls lt lu lv b">Pod</code>启动</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="f05d" class="ne mc iq lv b gy nu nv l nw nx">kubectl get pods -n $AZURE_SERVICE_OPERATOR_NAMESPACE</span><span id="583a" class="ne mc iq lv b gy og nv l nw nx">NAME                                              READY   STATUS    RESTARTS   AGE<br/>azureoperator-controller-manager-68f44fd4-cm6wl   2/2     Running   0          6m</span></pre><h1 id="9c7e" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">设置Azure事件中心组件…</h1><p id="12d4" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">从克隆回购开始:</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="2c1e" class="ne mc iq lv b gy nu nv l nw nx">git clone https://github.com/abhirockzz/eventhubs-using-aso-on-k8s<br/>cd eventhubs-using-aso-on-k8s</span></pre><p id="dcc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个<a class="ae kl" href="https://docs.microsoft.com/azure/azure-resource-manager/management/overview?WT.mc_id=medium-blog-abhishgu#resource-groups" rel="noopener ugc nofollow" target="_blank"> Azure资源组</a></p><blockquote class="lc ld le"><p id="0b2e" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">我已经使用了</em> <code class="fe ls lt lu lv b"><em class="iq">southeastasia</em></code> <em class="iq">位置。如果需要使用不同的</em>，请更新 <code class="fe ls lt lu lv b"><em class="iq">eh-resource-group.yaml</em></code> <em class="iq"/></p></blockquote><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="ad1f" class="ne mc iq lv b gy nu nv l nw nx">kubectl apply -f deploy/eh-resource-group.yaml</span><span id="a8d8" class="ne mc iq lv b gy og nv l nw nx">//confirm that its created<br/>kubectl get resourcegroups/eh-aso-rg</span></pre><p id="e473" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建<a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-features?WT.mc_id=medium-blog-abhishgu#namespace" rel="noopener ugc nofollow" target="_blank">事件中心名称空间</a></p><blockquote class="lc ld le"><p id="2aaa" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">我已经用</em> <code class="fe ls lt lu lv b"><em class="iq">southeastasia</em></code> <em class="iq">定位了。如果您需要使用不同的</em>，请更新 <code class="fe ls lt lu lv b"><em class="iq">eh-namespace.yaml</em></code> <em class="iq"/></p></blockquote><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="99bf" class="ne mc iq lv b gy nu nv l nw nx">kubectl apply -f deploy/eh-namespace.yaml</span><span id="4f23" class="ne mc iq lv b gy og nv l nw nx">//wait for creation<br/>kubectl get eventhubnamespaces -w</span></pre><p id="74dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成后，您应该会看到:</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="a152" class="ne mc iq lv b gy nu nv l nw nx">NAME        PROVISIONED   MESSAGE<br/>eh-aso-ns   true          successfully provisioned</span></pre><p id="9591" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用<code class="fe ls lt lu lv b">kubectl describe eventhubnamespaces</code>获得详细信息，也可以使用<a class="ae kl" href="https://docs.microsoft.com/cli/azure/eventhubs/namespace?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-eventhubs-namespace-show" rel="noopener ugc nofollow" target="_blank"> az eventhubs名称空间show </a>进行复查</p><p id="e122" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">名称空间已经准备好了，我们现在可以创建一个事件中心</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="c381" class="ne mc iq lv b gy nu nv l nw nx">kubectl apply -f deploy/eh-hub.yaml</span><span id="a91f" class="ne mc iq lv b gy og nv l nw nx">kubectl get eventhubs/eh-aso-hub</span><span id="5d8e" class="ne mc iq lv b gy og nv l nw nx">//once done...<br/>NAME        PROVISIONED   MESSAGE<br/>eh-aso-hub  true          successfully provisioned</span></pre><p id="5165" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用<code class="fe ls lt lu lv b">kubectl describe eventhub</code>获得详细信息，也可以使用<a class="ae kl" href="https://docs.microsoft.com/cli/azure/eventhubs/eventhub?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-eventhubs-eventhub-show" rel="noopener ugc nofollow" target="_blank">az event hubs event hub show</a>进行复查</p><p id="4d37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一步，创建消费者组</p><blockquote class="lc ld le"><p id="d595" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">这是对默认消费群体的补充(适当命名为</em> <code class="fe ls lt lu lv b"><em class="iq">$Default</em></code> <em class="iq"> ) </em></p></blockquote><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="c816" class="ne mc iq lv b gy nu nv l nw nx">kubectl apply -f deploy/eh-consumer-group.yaml</span><span id="5e89" class="ne mc iq lv b gy og nv l nw nx">kubectl get consumergroups/eh-aso-cg</span><span id="31ca" class="ne mc iq lv b gy og nv l nw nx">NAME        PROVISIONED   MESSAGE<br/>eh-aso-cg  true          successfully provisioned</span></pre><p id="3492" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用<code class="fe ls lt lu lv b">kubectl describe consumergroup</code>获得详细信息，也可以使用<a class="ae kl" href="https://docs.microsoft.com/cli/azure/eventhubs/eventhub/consumer-group?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-eventhubs-eventhub-consumer-group-show" rel="noopener ugc nofollow" target="_blank"> eazventhubs eventhub消费者小组秀</a>进行复查</p></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><h1 id="e28d" class="mb mc iq bd md me oh mg mh mi oi mk ml mm oj mo mp mq ok ms mt mu ol mw mx my bi translated">下一步是什么？</h1><p id="5a69" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">让我们利用我们刚刚设置的东西！我们将向Kubernetes部署一对生产者和消费者应用程序，它们将分别从事件中心发送和接收消息。这两个客户端应用程序都是用<a class="ae kl" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go </a>编写的，并使用<a class="ae kl" href="https://github.com/Shopify/sarama/" rel="noopener ugc nofollow" target="_blank">用于Kafka </a>的Sarama库。我不打算深究细节，因为它们相对简单</p><p id="5922" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署消费者应用程序:</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="10b5" class="ne mc iq lv b gy nu nv l nw nx">kubectl apply -f deploy/consumer.yaml</span><span id="7728" class="ne mc iq lv b gy og nv l nw nx">//wait for it to start<br/>kubectl get pods -l=app=eh-consumer -w</span></pre><p id="d7e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">跟踪消费者应用程序的日志:</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="f87d" class="ne mc iq lv b gy nu nv l nw nx">kubectl logs -f $(kubectl get pods -l=app=eh-consumer --output=jsonpath={.items..metadata.name})</span></pre><p id="44e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会看到类似如下的内容:</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="2e4a" class="ne mc iq lv b gy nu nv l nw nx">Event Hubs broker [eh-aso-ns.servicebus.windows.net:9093]<br/>Sarama client consumer group ID eh-aso-cg<br/>new consumer group created<br/>Event Hubs topic eh-aso-hub<br/>Waiting for program to exit<br/>Partition allocation - map[eh-aso-hub:[0 1 2]]</span></pre><p id="4da0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用另一个终端，部署生成器应用程序:</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="4a5f" class="ne mc iq lv b gy nu nv l nw nx">kubectl apply -f deploy/producer.yaml</span></pre><p id="495c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦生产者应用程序启动并运行，消费者就应该启动，开始消费消息，并将它们打印到控制台。因此，您将看到类似于以下内容的日志:</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="ca99" class="ne mc iq lv b gy nu nv l nw nx">...<br/>Message topic:"eh-aso-hub" partition:0 offset:6<br/>Message content value-2020-07-06 15:37:06.116674866 +0000 UTC m=+67.450171692<br/>Message topic:"eh-aso-hub" partition:0 offset:7<br/>Message content value-2020-07-06 15:37:09.133115988 +0000 UTC m=+70.466612714<br/>Message topic:"eh-aso-hub" partition:0 offset:8<br/>Message content value-2020-07-06 15:37:12.149068005 +0000 UTC m=+73.482564831<br/>...</span></pre><blockquote class="lc ld le"><p id="1690" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">如果你也想检查生产者日志:</em> <code class="fe ls lt lu lv b"><em class="iq">kubectl logs -f $(kubectl get pods -l=app=eh-producer --output=jsonpath={.items..metadata.name})</em></code></p></blockquote><p id="8cdb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，成功了！</p><ul class=""><li id="7399" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">我们创建了一个事件中心名称空间、事件中心和一个消费者组..全部使用<code class="fe ls lt lu lv b">kubectl</code>(当然还有YAMLs)</li><li id="9da5" class="lj lk iq jp b jq lw ju lx jy ly kc lz kg ma kk lo lp lq lr bi translated">部署一个简单的生产者和消费者进行测试</li></ul></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><h1 id="341b" class="mb mc iq bd md me oh mg mh mi oi mk ml mm oj mo mp mq ok ms mt mu ol mw mx my bi translated">但是，刚刚发生了什么…？</h1><p id="a475" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">…消费者和生产者应用程序如何在没有连接信息、凭证等的情况下连接到事件中心？？</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi om"><img src="../Images/8f3030829dd4a584f9a2bf9698d63b53.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/0*Z9xK8gQSus8t2yhc.gif"/></div></figure><p id="8fa2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意事件中心清单的这一部分(<code class="fe ls lt lu lv b">eh-hub.yaml</code>文件):</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="5b6b" class="ne mc iq lv b gy nu nv l nw nx">...<br/>spec:<br/>  secretName: eh-secret<br/>  location: southeastasia<br/>  resourceGroup: eh-aso-rg<br/>...</span></pre><p id="8aab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ls lt lu lv b">secretName: eh-secret</code>确保创建了一个Kubernetes <code class="fe ls lt lu lv b">Secret</code>，其中包含所需的连接细节，包括连接字符串(主要、次要)、密钥(主要、次要)，以及基本信息，如事件中心名称空间和中心名称。</p><p id="2c73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">生产者和消费者可以简单地参考这个。看看这个来自消费者应用<code class="fe ls lt lu lv b">Deployment</code>的片段</p><pre class="kn ko kp kq gt nq lv nr ns aw nt bi"><span id="932b" class="ne mc iq lv b gy nu nv l nw nx">...<br/>      containers:<br/>        - name: eh-consumer<br/>          image: abhirockzz/eh-kafka-consumer<br/>          env:<br/>            - name: EVENTHUBS_CONNECTION_STRING<br/>              valueFrom:<br/>                secretKeyRef:<br/>                  name: eh-secret<br/>                  key: primaryConnectionString<br/>            - name: EVENTHUBS_NAMESPACE<br/>              valueFrom:<br/>                secretKeyRef:<br/>                  name: eh-secret<br/>                  key: eventhubNamespace<br/>            - name: EVENTHUBS_BROKER<br/>              value: $(EVENTHUBS_NAMESPACE).servicebus.windows.net:9093<br/>            - name: EVENTHUBS_TOPIC<br/>              valueFrom:<br/>                secretKeyRef:<br/>                  name: eh-secret<br/>                  key: eventhubName<br/>            - name: EVENTHUBS_CONSUMER_GROUPID<br/>              value: eh-aso-cg<br/>...</span></pre><p id="3725" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该应用程序使用环境变量<code class="fe ls lt lu lv b">EVENTHUBS_CONNECTION_STRING</code>、<code class="fe ls lt lu lv b">EVENTHUBS_NAMESPACE</code>和<code class="fe ls lt lu lv b">EVENTHUBS_TOPIC</code>，它们的值来源于秘密(<code class="fe ls lt lu lv b">eh-secret</code>)。<code class="fe ls lt lu lv b">EVENTHUBS_CONSUMER_GROUPID</code>的值被硬编码为<code class="fe ls lt lu lv b">eh-aso-cg</code>，这是在<code class="fe ls lt lu lv b">eh-consumer-group.yaml</code>中指定的消费群体的名称。</p><h2 id="f0e2" class="ne mc iq bd md nf ng dn mh nh ni dp ml jy nj nk mp kc nl nm mt kg nn no mx np bi translated">打扫</h2><p id="cac8" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">要删除所有资源，包括事件中心和客户端应用程序，只需使用<code class="fe ls lt lu lv b">kubectl delete -f deploy</code></p></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><h1 id="91a9" class="mb mc iq bd md me oh mg mh mi oi mk ml mm oj mo mp mq ok ms mt mu ol mw mx my bi translated">结论</h1><p id="9fe1" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">Azure Service Operator在特定于Azure的原语之上提供了一个抽象层。它允许您管理Azure资源，还提供了使用部署在同一个Kubernetes集群中的其他应用程序连接到这些资源的方法。</p><p id="2004" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我以Azure Event Hubs为例，但是正如我前面提到的，Azure Service Operator也支持其他服务。前往<a class="ae kl" href="https://github.com/Azure/azure-service-operator" rel="noopener ugc nofollow" target="_blank">GitHub repo</a>并给他们一个尝试！</p></div></div>    
</body>
</html>