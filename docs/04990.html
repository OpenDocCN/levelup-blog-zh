<html>
<head>
<title>How to properly calculate text size in PIL images</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何正确计算PIL图像中的文本大小</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/how-to-properly-calculate-text-size-in-pil-images-17a2cc6f51fd?source=collection_archive---------1-----------------------#2020-07-28">https://levelup.gitconnected.com/how-to-properly-calculate-text-size-in-pil-images-17a2cc6f51fd?source=collection_archive---------1-----------------------#2020-07-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7dac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">PIL是一个很棒的用Python创建和编辑图像的包。然而，它的一个问题是计算文本大小。所以今天我将向大家展示一个简短的Python脚本，它用于在用PIL创建的图像中绘制适当居中的文本。</p><h1 id="5692" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">问题是</h1><p id="1af6" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">不幸的是，绘图接口的<code class="fe lo lp lq lr b">textsize</code>方法没有返回字符串的正确文本大小。</p><p id="ec8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，使用这个示例代码</p><pre class="ls lt lu lv gt lw lr lx ly aw lz bi"><span id="2ffb" class="ma km iq lr b gy mb mc l md me">img = Image.new("RGB", (width, height), color="white")<br/>draw_interface = ImageDraw.Draw(img)<br/>size_width, size_height = draw_interface.textsize("some string", font)</span></pre><p id="5bbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lo lp lq lr b">size_width</code>和<code class="fe lo lp lq lr b">size_height</code>将会<a class="ae mf" href="https://github.com/python-pillow/Pillow/issues/644" rel="noopener ugc nofollow" target="_blank">返回不正确的值</a>。</p><h1 id="6cba" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">解决方案</h1><p id="1b17" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">因此，解决方案是对文本大小使用不同的计算方法。遵循<a class="ae mf" href="https://stackoverflow.com/questions/43060479/how-to-get-the-font-pixel-height-using-pils-imagefont-class/46220683#46220683" rel="noopener ugc nofollow" target="_blank">中发布的解决方案，这个</a>堆栈溢出线程(有一些变化)，下面的函数是我最后得到的。</p><figure class="ls lt lu lv gt mg"><div class="bz fp l di"><div class="mh mi l"/></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">文本大小计算</figcaption></figure><p id="35b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我试着解释一下代码。</p><figure class="ls lt lu lv gt mg gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/554355d19395c8608140f1c76bc08cc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/format:webp/0*MmAER7Xfh89aL_8E.png"/></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">字体规格(<a class="ae mf" href="https://stackoverflow.com/questions/43060479/how-to-get-the-font-pixel-height-using-pils-imagefont-class/46220683#46220683" rel="noopener ugc nofollow" target="_blank">来源</a>)</figcaption></figure><p id="cd55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从那个堆栈溢出线程借用上面的图片，我从用<code class="fe lo lp lq lr b">font.getmetrics</code>获取一些字体度量开始。这返回上升和下降，即根据<a class="ae mf" href="https://pillow.readthedocs.io/en/stable/reference/ImageFont.html?highlight=getmetrics#PIL.ImageFont.FreeTypeFont.getmetrics" rel="noopener ugc nofollow" target="_blank"> PIL文档</a></p><blockquote class="mq"><p id="a1f0" class="mr ms iq bd mt mu mv mw mx my mz kk dk translated">“从基线到最高轮廓点的距离”和“从基线到最低轮廓点的距离，负值”</p></blockquote><p id="5f31" class="pw-post-body-paragraph jn jo iq jp b jq na js jt ju nb jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">换句话说，<code class="fe lo lp lq lr b">font.getmetrics</code>返回一个元组，分别包含图像的红色和蓝色区域。</p><p id="ede3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">黑色矩形由<code class="fe lo lp lq lr b">font.getmask(text_string).getbox()</code>给出，它返回一个四项元组:水平偏移量、垂直偏移量、矩形的宽度和矩形的高度。</p><p id="3c87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们有了黑色矩形的下降和尺寸，高度由下式给出:</p><pre class="ls lt lu lv gt lw lr lx ly aw lz bi"><span id="f732" class="ma km iq lr b gy mb mc l md me">font.getmask(text_string).getbox()[3] + descent</span></pre><p id="c243" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">宽度为:</p><pre class="ls lt lu lv gt lw lr lx ly aw lz bi"><span id="56b0" class="ma km iq lr b gy mb mc l md me">font.getmask(text_string).getbox()[2]</span></pre><p id="3548" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着高度是通过将图像中所有区域的高度相加计算出来的，宽度就是黑色矩形的宽度。</p><h1 id="825b" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">实际例子</h1><p id="eea7" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">最后，让我们应用这个新发现的知识来创建一个文本居中的PIL图像。</p><figure class="ls lt lu lv gt mg"><div class="bz fp l di"><div class="mh mi l"/></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">创建文本居中的图像</figcaption></figure><p id="ffe4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lo lp lq lr b">get_y_and_heights</code>是对先前代码要点中<code class="fe lo lp lq lr b">get_text_dimensions</code>功能的改编。通过这种方式，函数返回开始绘制文本的垂直坐标以及每一文本行的高度列表。由于这个新函数还返回一个包含每行高度的列表，所以我还在高度计算中添加了垂直边距。这样，当循环通过文本行来绘制它们(第55到65行)时，可以将文本高度添加到<code class="fe lo lp lq lr b">y</code>变量中来找到下一个垂直坐标。</p><p id="b8fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">代码的其余部分是创建新的PIL图像并在其上绘制文本的标准代码。</p><figure class="ls lt lu lv gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nf"><img src="../Images/1b7b06012c249630aeeb5a964bff523e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tUezjW_Lq0rqKZI0qAQmOA.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">结果图像</figcaption></figure><h1 id="0dc9" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">结论</h1><p id="cf54" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">希望这段代码对你将来和PIL一起工作有用。所有这些文本度量对我来说仍然是混乱的，没有包括在PIL文档中也没有帮助(即<code class="fe lo lp lq lr b">getbox</code>函数)。</p><p id="9863" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">无论如何，我认为这是一个实现目标的好解决方案:正确计算用特定字体绘制的字符串的文本大小。</p><p id="7e93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像往常一样，这篇文章的代码可以在我的<a class="ae mf" href="https://github.com/Ze1598/medium-articles/tree/a4d4c28a8fdd847a1fa45efa9dcd8bab0bb0c593/How%20to%20properly%20calculate%20text%20size%20in%20PIL%C2%A0images" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>上找到。</p><p id="9748" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于额外的阅读，我建议查看“<a class="ae mf" href="https://neptune.ai/blog/pil-image-tutorial-for-machine-learning" rel="noopener ugc nofollow" target="_blank">基本Pil(枕头)图像教程(针对机器学习人员)</a>”博客帖子，以全面介绍PIL的功能。</p></div></div>    
</body>
</html>