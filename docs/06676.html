<html>
<head>
<title>Run Node.js application on Apache server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Apache服务器上运行Node.js应用程序</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/run-node-js-application-on-apache-server-c79985014869?source=collection_archive---------1-----------------------#2020-12-19">https://levelup.gitconnected.com/run-node-js-application-on-apache-server-c79985014869?source=collection_archive---------1-----------------------#2020-12-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ea06e95f503ac10f98ce45e55ba21528.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kuxaEREGm81TiWUdcsHp4A.png"/></div></div></figure><p id="d3c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为我们有一个运行在GCP机器上的Apache服务器，所以我们现在想在其上运行一个额外的Node.js应用程序。(因为我打算利用它的公共url来👉<a class="ae kw" href="https://wendeehsu.medium.com/echo-messages-from-line-chat-to-slack-e12f5d929b81" rel="noopener">从LINE chat到Slack的回显消息</a>)我的项目结构如下:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="3f4b" class="lg lh iq lc b gy li lj l lk ll">- Project       # &lt;--- DocumentRoot for the apache server  <br/>|- index.html   # &lt;--- This is the website now hosted by apache<br/>|- folder<br/>|  |- index.php<br/>|  |_ some-other-php-files.php<br/>|<br/>|_ line-node    # &lt;--- we want to run this node.js server<br/>   |- index.js<br/>   |- package.json<br/>   |_ package-lock.json</span></pre><p id="cfee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">🚩我们的最终目标是:</p><ul class=""><li id="e91b" class="lm ln iq ka b kb kc kf kg kj lo kn lp kr lq kv lr ls lt lu bi translated">apache托管<code class="fe lv lw lx lc b">https://project.site</code>，这是现有的网站</li><li id="a986" class="lm ln iq ka b kb ly kf lz kj ma kn mb kr mc kv lr ls lt lu bi translated">node.js托管<code class="fe lv lw lx lc b">https://project.site/callback</code>，处理对Line messaging api的<strong class="ka ir"> POST </strong>请求</li></ul><p id="28b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们开始之前，我真诚地建议您使用<a class="ae kw" href="https://firebase.google.com/docs/functions" rel="noopener ugc nofollow" target="_blank"> Firebase函数</a>,如果您只需要一个运行在公共url上的小node.js应用程序(在我的例子中，因为我只是想提供一个<code class="fe lv lw lx lc b">/callback</code> api帖子，所以它适合使用Firebase，但是我选择了一个困难的路径😂😂</p><p id="d342" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你准备好了，那么深呼吸，让我们一起渡过难关🤝</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="fcca" class="mk lh iq bd ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng bi translated">结构概述</h1><p id="1b56" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">我的项目(名为<code class="fe lv lw lx lc b">sophie</code>)包含网站和node.js应用程序，放在根目录<code class="fe lv lw lx lc b">/var/www</code>下。apache主机设置在根目录<code class="fe lv lw lx lc b">/etc/apache2</code>下:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/295b676b93dc2c0ad65e66e71d98f54b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3CaOtJfU7q2fPuV7RF6d-g.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">ssh到GCP机器</figcaption></figure><p id="7c3e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们要修改的文件有:</p><ul class=""><li id="8740" class="lm ln iq ka b kb kc kf kg kj lo kn lp kr lq kv lr ls lt lu bi translated"><code class="fe lv lw lx lc b">apache2.conf</code>Apache服务器的主配置文件。</li><li id="976a" class="lm ln iq ka b kb ly kf lz kj ma kn mb kr mc kv lr ls lt lu bi translated"><code class="fe lv lw lx lc b">sites-available/000-default.conf</code>我们需要在这里指定<strong class="ka ir"> ProxyPass </strong>规则(我稍后会解释。我保证😉)</li><li id="a9ab" class="lm ln iq ka b kb ly kf lz kj ma kn mb kr mc kv lr ls lt lu bi translated">我们还将在<code class="fe lv lw lx lc b">/var/www/sophie</code>中创建一个名为<code class="fe lv lw lx lc b">.htaccess</code>的文件，以根据url目录进行配置更改。(所以在我们的例子中，如果url以<code class="fe lv lw lx lc b">/callback</code>结尾，我们将把它路由到node.js服务器，而其他的将由apache服务器处理。)</li></ul></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="8750" class="mk lh iq bd ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng bi translated">将HTTP更改为HTTPS(可选)</h1><p id="919d" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">我的最终目标是在GCP上添加一个处理<code class="fe lv lw lx lc b">https://project.site/callback</code>的node.js服务器。然而，GCP机器的当前地址是<code class="fe lv lw lx lc b"><strong class="ka ir">http</strong>://project.site</code>而不是<code class="fe lv lw lx lc b"><strong class="ka ir">https</strong>://project.site</code>。在这里，我们可以按照<a class="ae kw" href="https://certbot.eff.org/lets-encrypt/ubuntubionic-apache" rel="noopener ugc nofollow" target="_blank"> Cerbot文档</a>中的步骤将我们的站点放在https上:</p><div class="nr ns gp gr nt nu"><a href="https://certbot.eff.org/lets-encrypt/ubuntubionic-apache" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd ir gy z fp nz fr fs oa fu fw ip bi translated">cert bot-ubuntubonic Apache</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">和一个带有开口...它托管在一个可选的上，如果您需要，可以通过通配符证书访问它…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">certbot.eff.org</p></div></div><div class="od l"><div class="oe l of og oh od oi jw nu"/></div></div></a></div><p id="7407" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们的网站由apache提供服务，显示在https 🥳</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/b5dbb070f6a6d9a438d97086ff729934.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RUpzdNR4Uzi6baKtMu-u3Q.png"/></div></div></figure></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="2235" class="mk lh iq bd ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng bi translated">添加代理通道</h1><p id="76ff" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">可以想象，当我们运行node.js应用程序时，它将监听一个端口(我在<code class="fe lv lw lx lc b">line-node/.env</code>中将端口指定为8080)</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/964221c4206de29692b2e67c90c89035.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1vAf-Kuc_A6D9f7AzTGKqA.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">在GCP上运行node.js应用程序</figcaption></figure><p id="2b19" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">计划是这样的:</p><blockquote class="ol om on"><p id="ac3a" class="jy jz oo ka b kb kc kd ke kf kg kh ki op kk kl km oq ko kp kq or ks kt ku kv ij bi translated">当GCP收到发布到<code class="fe lv lw lx lc b">https://project.site/callback</code>的请求时🔜将请求发送到<code class="fe lv lw lx lc b">localhost:8080/callback</code>，由node.js应用程序处理。</p></blockquote><p id="47f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该规则应在<code class="fe lv lw lx lc b">etc/apache2/sites-available/000-default.conf</code>中设置:</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="6d9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过将<strong class="ka ir"> ProxyRequests </strong>和<strong class="ka ir">proxyreservehost</strong>设置为<code class="fe lv lw lx lc b">on</code>，以<code class="fe lv lw lx lc b">/callback</code>(写在<code class="fe lv lw lx lc b">&lt;Location&gt;</code>标签中)结束的请求现在将被传递到<code class="fe lv lw lx lc b">http://localhost:8080/callback</code>🙌</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="ef5e" class="mk lh iq bd ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng bi translated">启用重写规则</h1><p id="67e2" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">为了覆盖基于目录的Apache配置，我们必须将<code class="fe lv lw lx lc b">AllowOverride</code>设置为<code class="fe lv lw lx lc b">all</code>，这样我们就可以使用<code class="fe lv lw lx lc b">.htaccess</code>:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ou"><img src="../Images/32a4f7ae009a0298ba9ae2b9a6247a7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TePu3yxIMtl51cBhQE5W6g.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">vim etc/apache2/apache2.conf</figcaption></figure><p id="11e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，转到我们的项目并添加一个<code class="fe lv lw lx lc b">.htaccess</code>文件:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="af8f" class="lg lh iq lc b gy li lj l lk ll">- Project <br/>|- .htaccess    # &lt;--- here<br/>|- index.html <br/>|- folder<br/>|  |- index.php<br/>|  |_ some-other-php-files.php<br/>|<br/>|_ line-node    <br/>   |- index.js<br/>   |- package.json<br/>   |_ package-lock.json</span></pre><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="os ot l"/></div></figure><ul class=""><li id="8226" class="lm ln iq ka b kb kc kf kg kj lo kn lp kr lq kv lr ls lt lu bi translated">第一个重写规则是将<code class="fe lv lw lx lc b">/callback</code>请求代理给node.js应用程序。</li><li id="d820" class="lm ln iq ka b kb ly kf lz kj ma kn mb kr mc kv lr ls lt lu bi translated">第二个重写规则是可选的。它是用来存放我原来的网站的，因为我在每个子文件夹中都有不同的<code class="fe lv lw lx lc b">index.php</code>。该规则使我能够在<code class="fe lv lw lx lc b">https://project.site</code>和<code class="fe lv lw lx lc b">https://project.site/subfolder-name</code>上显示不同的页面。</li></ul><p id="1d90" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">/*你可以在这里找到<a class="ae kw" href="https://support.acquia.com/hc/en-us/articles/360005257234-Introduction-to-htaccess-rewrite-rules" rel="noopener ugc nofollow" target="_blank">更多重写规则</a>。*/</p><p id="f90c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们可以在终端中启用重写模式:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="d9f0" class="lg lh iq lc b gy li lj l lk ll">$ sudo a2enmod rewrite</span></pre></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="cbbd" class="mk lh iq bd ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng bi translated">奔跑👩‍💻</h1><p id="f982" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">用命令<code class="fe lv lw lx lc b">service apache restart</code>重启apache服务器。现在，我们可以在同一台机器上运行node.js应用程序:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ov"><img src="../Images/e1401b7c22f985fbd2b97ad860691375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XOAVMZL-4aZBwbAAVPBlOg.png"/></div></div></figure><p id="fa8b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe lv lw lx lc b">&amp;</code>用于在后台执行命令。(所以即使终端被关闭，⛹️‍♀️的进程也会继续运行)</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ow"><img src="../Images/0748821277878acda3f93357de3d2c36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lFK6snxHN6ZzIe-rxjggiQ.png"/></div></div></figure><h2 id="3e67" class="lg lh iq bd ml ox oy dn mp oz pa dp mt kj pb pc mx kn pd pe nb kr pf pg nf ph bi translated">杂音…</h2><p id="97ac" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">启用重写规则的步骤非常重要。如果没有在<code class="fe lv lw lx lc b">apache2.conf</code>中设置<code class="fe lv lw lx lc b">AllowOverride all</code>，POST可能在http(端口80)上工作，但在https(端口443)上失败</p><div class="nr ns gp gr nt nu"><a href="https://stackoverflow.com/questions/53040363/apache-2-4-29-ubuntu-server-at-port-443-for-wordpress/53040859" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd ir gy z fp nz fr fs oa fu fw ip bi translated">用于wordpress的Apache/2.4.29 (Ubuntu)服务器，端口443</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">感谢贡献一个堆栈溢出的答案！请务必回答问题。提供详细信息并分享…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">stackoverflow.com</p></div></div><div class="od l"><div class="pi l of og oh od oi jw nu"/></div></div></a></div><p id="8d65" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，如果我们没有在<code class="fe lv lw lx lc b">.htaccess</code>中指定代理的重写规则，服务器可能会将每个POST视为GET:</p><div class="nr ns gp gr nt nu"><a href="https://stackoverflow.com/questions/10586779/redirectmatch-changes-post-to-get/10655325#10655325" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd ir gy z fp nz fr fs oa fu fw ip bi translated">redirectmatch将post更改为get</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">感谢贡献一个堆栈溢出的答案！请务必回答问题。提供详细信息并分享…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">stackoverflow.com</p></div></div><div class="od l"><div class="pj l of og oh od oi jw nu"/></div></div></a></div><p id="b0e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">真是一场噩梦👻 😂</p></div></div>    
</body>
</html>