<html>
<head>
<title>Python — How to implement asynchronous execution</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">python——如何实现异步执行</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/python-how-to-implement-asynchronously-execution-b2132eab23e1?source=collection_archive---------12-----------------------#2020-06-28">https://levelup.gitconnected.com/python-how-to-implement-asynchronously-execution-b2132eab23e1?source=collection_archive---------12-----------------------#2020-06-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="780a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近工作中接触了多线程/异步实现，想分享一下经验。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/725623ea0f8d2701465b699859e89097.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5aBwwS8f0F7rbB-8FYNzRA.jpeg"/></div></div></figure><h1 id="4602" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">串联实施</h1><p id="8a7e" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">让我向您展示系列实现的示例。</p><ul class=""><li id="9b46" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated"><strong class="jp ir"> Main.py </strong></li></ul><pre class="km kn ko kp gt mj mk ml mm aw mn bi"><span id="deb7" class="mo ky iq mk b gy mp mq l mr ms">import sub<br/>from datetime import datetime, timedelta</span><span id="db3d" class="mo ky iq mk b gy mt mq l mr ms">def main(sec):<br/>    sub.wait(sec)<br/>    return True</span><span id="f7f0" class="mo ky iq mk b gy mt mq l mr ms">print(datetime.today())</span><span id="69a0" class="mo ky iq mk b gy mt mq l mr ms">for i in range(0,2):<br/>    result = main(5)<br/>    print(result)</span><span id="2dae" class="mo ky iq mk b gy mt mq l mr ms">print(datetime.today())</span></pre><ul class=""><li id="f949" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated"><strong class="jp ir">sub py</strong></li></ul><pre class="km kn ko kp gt mj mk ml mm aw mn bi"><span id="a95e" class="mo ky iq mk b gy mp mq l mr ms">import time</span><span id="bb89" class="mo ky iq mk b gy mt mq l mr ms">def wait(sec):<br/>    time.sleep(sec)</span></pre><p id="53ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行结果如下:</p><pre class="km kn ko kp gt mj mk ml mm aw mn bi"><span id="f392" class="mo ky iq mk b gy mp mq l mr ms">$ python main.py</span><span id="afa7" class="mo ky iq mk b gy mt mq l mr ms">2020-06-28 16:58:12.163089<br/>True<br/>True<br/>2020-06-28 16:58:22.173504</span></pre><p id="9901" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然整个实现需要10秒。然而，如果你不需要等待来自“def main(sec)”的结果，我们该如何实现呢？我们可以使用“并发.未来”模块。</p><h1 id="b83e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">并发.未来</h1><p id="15de" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">什么是“并发.未来”？我们可以参考文档。</p><pre class="km kn ko kp gt mj mk ml mm aw mn bi"><span id="469d" class="mo ky iq mk b gy mp mq l mr ms">The <a class="ae mu" href="https://docs.python.org/3/library/concurrent.futures.html#module-concurrent.futures" rel="noopener ugc nofollow" target="_blank">concurrent.futures</a> module provides a high-level interface for asynchronously executing callables.</span><span id="e3dc" class="mo ky iq mk b gy mt mq l mr ms">The asynchronous execution can be performed with threads, using <a class="ae mu" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor" rel="noopener ugc nofollow" target="_blank">ThreadPoolExecutor</a>, or separate processes, using <a class="ae mu" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.ProcessPoolExecutor" rel="noopener ugc nofollow" target="_blank">ProcessPoolExecutor</a>. Both implement the same interface, which is defined by the abstract <a class="ae mu" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor" rel="noopener ugc nofollow" target="_blank">Executor</a> class.</span></pre><p id="4547" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要多线程，所以让我用“ThreadPoolExecutor”。</p><p id="a0a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，需要调用ThreadPoolExecutor实例。您可以使用参数设置线程数量。默认值为5。</p><pre class="km kn ko kp gt mj mk ml mm aw mn bi"><span id="db46" class="mo ky iq mk b gy mp mq l mr ms">executor = ThreadPoolExecutor(max_workers=2)</span></pre><p id="75ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如何异步调用函数？使用“submit”方法，并设置要用参数调用的函数名。你也可以得到一个返回值。</p><pre class="km kn ko kp gt mj mk ml mm aw mn bi"><span id="b329" class="mo ky iq mk b gy mp mq l mr ms">result = executor.submit(main, 5)</span></pre><p id="b11b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想在异步调用的函数执行后得到一个返回值，实现如下:</p><pre class="km kn ko kp gt mj mk ml mm aw mn bi"><span id="be1f" class="mo ky iq mk b gy mp mq l mr ms">future_results = []</span><span id="926b" class="mo ky iq mk b gy mt mq l mr ms">future_result = executor.submit(main, 5)<br/>future_results.append(future_result)</span><span id="15f3" class="mo ky iq mk b gy mt mq l mr ms">for future_result in future_results:<br/>    print(future_result.result())</span></pre><h1 id="0726" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">异步实现</h1><p id="590e" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">仅此而已！！让我给你看完整的代码。</p><ul class=""><li id="a765" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated"><strong class="jp ir"> Main.py </strong></li></ul><pre class="km kn ko kp gt mj mk ml mm aw mn bi"><span id="9457" class="mo ky iq mk b gy mp mq l mr ms">import sub<br/>from datetime import datetime, timedelta<br/>from concurrent.futures import ThreadPoolExecutor</span><span id="d445" class="mo ky iq mk b gy mt mq l mr ms">def main(sec):<br/>    sub.wait(sec)<br/>    return True</span><span id="e72e" class="mo ky iq mk b gy mt mq l mr ms">print(datetime.today())</span><span id="4692" class="mo ky iq mk b gy mt mq l mr ms">executor = ThreadPoolExecutor(max_workers=5)<br/>future_results = []</span><span id="d317" class="mo ky iq mk b gy mt mq l mr ms">for i in range(0,2):<br/>    future_result = executor.submit(main, 5)<br/>    future_results.append(future_result)</span><span id="1245" class="mo ky iq mk b gy mt mq l mr ms">print(datetime.today())</span><span id="85a0" class="mo ky iq mk b gy mt mq l mr ms">for future_result in future_results:<br/>    print(future_result.result())</span></pre><ul class=""><li id="0613" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated"><strong class="jp ir">subpy</strong></li></ul><pre class="km kn ko kp gt mj mk ml mm aw mn bi"><span id="52a8" class="mo ky iq mk b gy mp mq l mr ms">import time</span><span id="eb0f" class="mo ky iq mk b gy mt mq l mr ms">def wait(sec):<br/>    time.sleep(sec)</span></pre><p id="02c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行结果如下:</p><pre class="km kn ko kp gt mj mk ml mm aw mn bi"><span id="7281" class="mo ky iq mk b gy mp mq l mr ms">$ python main.py</span><span id="9006" class="mo ky iq mk b gy mt mq l mr ms">2020-06-28 17:23:19.522269<br/>2020-06-28 17:23:19.523261<br/>True<br/>True</span></pre><p id="f72f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以看到2nd "print(datetime.today())"没有等待主函数结束，也在稍后获得返回值！！</p><p id="ab0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢阅读！！</p></div></div>    
</body>
</html>