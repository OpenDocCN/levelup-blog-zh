<html>
<head>
<title>Lambda Retry and Error Notification With AWS Step Function</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有AWS步进功能的Lambda重试和错误通知</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/lambda-retry-and-error-notification-with-aws-step-function-bce84b48b042?source=collection_archive---------1-----------------------#2021-11-27">https://levelup.gitconnected.com/lambda-retry-and-error-notification-with-aws-step-function-bce84b48b042?source=collection_archive---------1-----------------------#2021-11-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/048df69a89388af9859dd4813160983e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*43ycFF1f3uiswdw7FVXrCA.png"/></div></div></figure><h1 id="b2a3" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">问题是</h1><p id="5ae3" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我的团队有一个lambda函数，计划每小时运行一次。由于网络错误，它有90%的成功几率，但有10%的失败几率。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lu"><img src="../Images/c7b816ed02a8706a5d4c905d282e85de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ogcmjv_TjJpfEDnBH_E-Mw.png"/></div></div></figure><p id="c99f" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">当它失败时，它默默地这样做。我们必须定期检查其日志，并手动弥补缺失的内容。这是相当不方便的。</p><p id="bfc8" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">我们想要一个更好的方法来做这件事。我们希望lambda在失败后自动重试几次。如果在所有尝试后仍然失败，我们希望通过电子邮件得到通知。</p><p id="b60a" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">我们使用<strong class="ky ir"> AWS步进函数</strong>实现了这一点。它节省了我们大量的时间，我们喜欢它简化了逻辑并减少了我们必须编写的代码量(和bug)。</p><p id="e6f1" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">这篇文章将告诉你如何做到这一点。</p><p id="c360" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">我们将首先看到如何在AWS控制台中创建一个step函数，然后如何通过一个基础设施即代码工具(如<strong class="ky ir">无服务器</strong>)来实现。</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h1 id="b354" class="jy jz iq bd ka kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv bi translated">在AWS控制台中创建步骤功能</h1><h2 id="1155" class="mq jz iq bd ka mr ms dn ke mt mu dp ki lh mv mw km ll mx my kq lp mz na ku nb bi translated"><strong class="ak"> 1。添加λ</strong></h2><p id="bf9d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">转到<strong class="ky ir"> AWS控制台&gt;步骤功能&gt;点击<strong class="ky ir">创建状态机。</strong></strong></p><p id="3f51" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">选择<strong class="ky ir">可视化设计您的工作流程</strong>，选择<strong class="ky ir">标准型</strong>，点击<strong class="ky ir">下一步</strong>。</p><p id="f18c" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">在Workflow Studio中，将一个<strong class="ky ir"> Lambda: Invoke </strong>块拖入第一个状态。</p><p id="b314" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">在<strong class="ky ir">配置下</strong> &gt; <strong class="ky ir"> API参数</strong> &gt; <strong class="ky ir">函数名</strong>，在下拉列表中选择目标lambda。</p><p id="47f1" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">在<strong class="ky ir">配置下</strong> &gt; <strong class="ky ir">追加配置&gt;下一个状态，</strong>选择<strong class="ky ir">转到结束。</strong></p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/cb801eb9b9aeac98ff84b97de4152330.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9_V41ciKDQ_ZqHSUcrQVJw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">Lambda调用配置</figcaption></figure></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h2 id="f4a4" class="mq jz iq bd ka mr ms dn ke mt mu dp ki lh mv mw km ll mx my kq lp mz na ku nb bi translated"><strong class="ak"> 2。添加一个检索器</strong></h2><p id="34c7" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated"><strong class="ky ir">重试器</strong>定义了一组重试规则，如最大重试次数和重试间隔。retrier在lambda因某个错误而失败后重新运行它。</p><p id="a68c" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">阶跃函数允许您添加多个重试器来处理不同的错误。为了简单起见，我们将添加一个针对所有错误运行的retrier。</p><p id="87f5" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">在<strong class="ky ir">错误处理&gt;错误重试下，</strong>点击<strong class="ky ir">添加新重试。</strong></p><p id="526f" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">在<strong class="ky ir"> Retrier # 1 </strong> &gt; <strong class="ky ir">错误</strong>下，选择<strong class="ky ir"> States.ALL. </strong>这意味着该Retrier将应用于所有错误。</p><p id="b4ef" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">将<strong class="ky ir">间隔</strong>设置为5秒，<strong class="ky ir">最大尝试次数</strong>设置为2，<strong class="ky ir">回退速率</strong>设置为1。</p><p id="8f29" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">间隔和最大尝试次数很容易理解，补偿率决定了重试间隔的增加。例如，如果间隔为5秒，回退率为2，则lambda将在第一次失败后等待5秒后重试，第二次失败后等待10秒，第三次失败后等待20秒，依此类推。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/02ea3866c918f82734416ba757d8a717.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pz9OGksLWTfHcsWmex-C6g.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">Lambda调用&gt;错误处理&gt;错误重试</figcaption></figure></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h2 id="0b51" class="mq jz iq bd ka mr ms dn ke mt mu dp ki lh mv mw km ll mx my kq lp mz na ku nb bi translated"><strong class="ak"> 3。添加一个捕捉器</strong></h2><p id="77df" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">一个<strong class="ky ir">捕捉器</strong>定义了一组错误处理规则，如果lambda在所有重试后失败。</p><p id="a657" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">如果所有重试失败，我想发送一封带有<a class="ae ni" href="https://docs.aws.amazon.com/sns/latest/dg/sns-email-notifications.html" rel="noopener ugc nofollow" target="_blank"> AWS简单通知服务</a>的电子邮件。</p><p id="47bb" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">在<strong class="ky ir">错误处理下</strong> &gt; <strong class="ky ir">捕捉错误，</strong>点击<strong class="ky ir">添加新的捕捉器。</strong></p><p id="1019" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">在<strong class="ky ir">捕捉器# 1 </strong> &gt; <strong class="ky ir">错误</strong>下，选择<strong class="ky ir"> States.ALL. </strong>这意味着捕捉器可以被所有错误触发。</p><p id="6acc" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">在<strong class="ky ir">捕手# 1 &gt;回退状态下，</strong>点击<strong class="ky ir">添加新状态。</strong>这将在工作流中创建一个新的错误处理分支。</p><p id="b959" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">在左侧搜索栏搜索SNS，拖动一个<strong class="ky ir">亚马逊SNS发布块</strong>进入回退状态。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/19a5bd41c1554da0bf788405c52bd470.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BA9MVkPNCn_yNqQvM4aw4g.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">Lambda调用&gt;错误处理&gt;捕获错误</figcaption></figure><p id="af3c" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">接下来，点击<strong class="ky ir"> SNS: Publish </strong>块进行编辑。</p><p id="220d" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">在<strong class="ky ir">配置</strong> &gt; <strong class="ky ir"> API参数</strong> &gt; <strong class="ky ir">主题</strong>下，选择一个主题。比如这里的HelloFuncFailed话题会发邮件给我。参见此<a class="ae ni" href="https://docs.aws.amazon.com/sns/latest/dg/sns-email-notifications.html" rel="noopener ugc nofollow" target="_blank">文档</a>了解如何设置社交网络来发送电子邮件。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/8c88f5274f17729279dc38ae27b3126f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*obEzQPNpnBM5ghSzngow0Q.png"/></div></div></figure><p id="3c80" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">既然我们已经添加了Lambda，在step函数中定义了retry和catch规则，您可以单击下一个的<strong class="ky ir">来查看定义，然后创建状态机。</strong></p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h1 id="abe5" class="jy jz iq bd ka kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv bi translated">使用无服务器部署分步功能</h1><p id="68ea" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">为了更容易地共享和维护step函数配置，您还可以使用基础设施即代码工具来部署相同的step函数。下面是我们上面创建的step函数的<a class="ae ni" href="https://www.serverless.com/plugins/serverless-step-functions" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"/></a><strong class="ky ir"/>定义。</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="429b" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">上面的模板假设lambda代码是在同一目录下的hello.js文件中定义的。还可以通过Amazon资源名(Arn)引用现有的Lambda。参见<a class="ae ni" href="https://www.serverless.com/plugins/serverless-step-functions" rel="noopener ugc nofollow" target="_blank">无服务器文档</a>了解更多详情。</p><h1 id="2ad3" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="3652" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这就是如何使用<strong class="ky ir"> AWS步骤函数</strong>向lambda函数添加错误重试和通知逻辑。您可以通过AWS控制台创建一个step函数，或者使用基础设施代码工具(如Serverless)创建一个。</p><p id="bd4a" class="pw-post-body-paragraph kw kx iq ky b kz lz lb lc ld ma lf lg lh mb lj lk ll mc ln lo lp md lr ls lt ij bi translated">阶跃函数为我的团队节省了大量时间。它简化了我们的错误处理逻辑，并允许我们用几行代码实现一组相当复杂的规则。希望有一些东西你可以带走并应用到你的项目中。如果你有任何问题，请告诉我。🙂</p></div></div>    
</body>
</html>