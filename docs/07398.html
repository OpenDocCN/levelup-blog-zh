<html>
<head>
<title>Overriding an Array Configuration Object</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">覆盖数组配置对象</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/overriding-an-array-configuration-object-4d93470e97d0?source=collection_archive---------9-----------------------#2021-02-15">https://levelup.gitconnected.com/overriding-an-array-configuration-object-4d93470e97d0?source=collection_archive---------9-----------------------#2021-02-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3607" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">惊喜！阵列不会被整体替换。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/71b09dd249b17efd5b282c5d67f092f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*obr8tbmdHDqbrPr_iGWYhQ.png"/></div></div></figure><p id="e754" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">ASP。NET Core使用配置提供程序从各种来源读取配置键值对。你可以在<a class="ae lq" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/" rel="noopener ugc nofollow" target="_blank">的官方文档</a>中了解更多关于ASP.NET核心的配置，其中详细介绍了大量用例。</p><p id="a13f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最近，当我在ASP.NET核心项目的<code class="fe lr ls lt lu b">appsettings.json</code>文件中设置JSON数组时，最终配置数据的结果让我大吃一惊。该数组的行为与其他JSON对象不同，后者可以在特定于环境的<code class="fe lr ls lt lu b">appsettings.json</code>文件中被覆盖。相反，最终数组的元素可能比预期的多。经过一番googling，发现已经有很多栈溢出问题(<a class="ae lq" href="https://stackoverflow.com/questions/51614792/how-to-override-an-asp-net-core-configuration-array-setting-reducing-length-of-t" rel="noopener ugc nofollow" target="_blank"> 1 </a>、<a class="ae lq" href="https://stackoverflow.com/questions/49136954/how-can-i-override-an-array-based-setting-from-appsettings-json-in-an-environmen" rel="noopener ugc nofollow" target="_blank"> 2 </a>、<a class="ae lq" href="https://stackoverflow.com/questions/37657320/how-to-override-asp-net-core-configuration-array-settings-using-environment-vari" rel="noopener ugc nofollow" target="_blank"> 3 </a>、<a class="ae lq" href="https://stackoverflow.com/questions/52755027/override-array-settings-in-appsettings-json-with-those-in-appsettings-production" rel="noopener ugc nofollow" target="_blank"> 4 </a>、<a class="ae lq" href="https://stackoverflow.com/questions/45819524/removing-inherited-asp-net-core-appsettings" rel="noopener ugc nofollow" target="_blank"> 5 </a>)和GitHub问题(<a class="ae lq" href="https://github.com/dotnet/runtime/issues/36569" rel="noopener ugc nofollow" target="_blank"> 1 </a>、<a class="ae lq" href="https://github.com/dotnet/runtime/issues/36384" rel="noopener ugc nofollow" target="_blank"> 2 </a>、<a class="ae lq" href="https://github.com/aspnet/Configuration/issues/836" rel="noopener ugc nofollow" target="_blank"> 3 </a>、<a class="ae lq" href="https://github.com/aspnet/Configuration/issues/694" rel="noopener ugc nofollow" target="_blank"> 4 </a>、<a class="ae lq" href="https://github.com/aspnet/Configuration/issues/727" rel="noopener ugc nofollow" target="_blank"> 5 </a>和<a class="ae lq" href="https://github.com/aspnet/Configuration/issues/773" rel="noopener ugc nofollow" target="_blank">6</a><a class="ae lq" href="https://github.com/aspnet/Configuration/issues/773" rel="noopener ugc nofollow" target="_blank">我认为写一篇短文来描述“问题”是值得的，这样你就不会被同一块石头绊倒。</a></p><h1 id="8bf5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">“问题”是什么</h1><p id="7d23" class="pw-post-body-paragraph ku kv it kw b kx mn ju kz la mo jx lc ld mp lf lg lh mq lj lk ll mr ln lo lp im bi translated">ASP.NET核心配置中的一个众所周知的特性是，如果在不同的配置源中有一些具有相同键的键值对，那么稍后添加的配置提供程序将覆盖先前的键设置。例如，如果在<code class="fe lr ls lt lu b">appsettings.Development.json</code>文件中没有设置连接字符串的值，那么在<code class="fe lr ls lt lu b">appsettings.json</code>文件中设置的连接字符串将用于开发环境。另一方面，如果在<code class="fe lr ls lt lu b">appsettings.Production.json</code>文件中设置了连接字符串，那么<code class="fe lr ls lt lu b">appsettings.json</code>文件中的值将被覆盖，而<code class="fe lr ls lt lu b">appsettings.Production.json</code>文件中的值将用于生产环境。</p><p id="f5a4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，我们通常将一些通用配置数据放在<code class="fe lr ls lt lu b">appsettings.json</code>文件中，将特定于环境的配置放在<code class="fe lr ls lt lu b">appsettings.{Environment}.json</code>文件和/或环境变量中。这样，当应用程序启动时，系统可以基于运行时环境覆盖设置。</p><p id="0aa3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，对于数组来说，它的工作方式并不完全相同。出于演示的目的，我创建了一个控制台应用程序，可以在<a class="ae lq" href="https://github.com/changhuixu/ConfigurationBuilderDemos" rel="noopener ugc nofollow" target="_blank">我的GitHub库</a>中找到。</p><p id="a422" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">演示控制台应用程序使用默认的<code class="fe lr ls lt lu b">HostBuilder</code>。当我们在开发模式下运行应用程序时，应用程序首先从<code class="fe lr ls lt lu b">appsettings.json</code>文件加载配置，然后从<code class="fe lr ls lt lu b">appsettings.Development.json</code>文件加载。我们将配置对象定义为一个类<code class="fe lr ls lt lu b">AppSettings</code>，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="8261" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">类<code class="fe lr ls lt lu b">AppSettings</code>包含三个属性，每个属性代表一个字符串数组。<code class="fe lr ls lt lu b">AppSettings</code>类下面的代码行显示控制台应用程序绑定来自JSON文件的配置并输出它们的值。</p><p id="c6a4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本演示中，我们将使用这三个阵列做一些实验来模拟阵列覆盖的效果。我们在每个JSON文件中用不同的数组长度为它们设置不同的值。两个JSON文件如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/028e6494c7f39337fdfaa6bab2e908c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gpovjrXC0pZpi2CAB-NMXw.png"/></div></div></figure><p id="9cb1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您可能认为三个数组的最终值都应该从<code class="fe lr ls lt lu b">appsettings.Development.json</code>文件中读取，因为该文件是最后一个加载的文件。然而，你说对了一部分。最终输出如下。</p><pre class="kj kk kl km gt mv lu mw mx aw my bi"><span id="089e" class="mz lw it lu b gy na nb l nc nd">MyArray0:        value1-override, value2-override<br/>MyArray1:        value1-override, value2-override<br/>MyArray2:        value2-override, value1</span></pre><p id="9253" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你看到棘手的部分了吗？</p><p id="ece5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">前两个数组具有来自<code class="fe lr ls lt lu b">appsettings.Devleopment.json</code>文件的预期值。而第三个数组<code class="fe lr ls lt lu b">MyArray2</code>的值来自两个<code class="fe lr ls lt lu b">appsettings.*.json</code>文件，这与我们的直觉相矛盾。</p><h1 id="92d5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">发生了什么</h1><p id="04b6" class="pw-post-body-paragraph ku kv it kw b kx mn ju kz la mo jx lc ld mp lf lg lh mq lj lk ll mr ln lo lp im bi translated"><a class="ae lq" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/#bind-an-array" rel="noopener ugc nofollow" target="_blank">关于ASP.NET核心中配置的官方文档</a>指出<code class="fe lr ls lt lu b">ConfigurationBinder</code>使用配置键中的数组索引将数组绑定到对象。</p><p id="eff5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果我们使用Visual Studio调试器来检查配置对象，我们可以发现JSON提供程序从<code class="fe lr ls lt lu b">appsettings.Development.json</code>文件中给出了以下配置数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/fd8678d938fa058291dd29ef2b8e0e52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*shyeb4zl016Twoz6HeqU8Q.png"/></div></figure><p id="9171" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">数组中的元素由它们的索引来标识。例如，<code class="fe lr ls lt lu b">MyArray1</code>中的第二个元素被标识为<code class="fe lr ls lt lu b">AppSettings:MyArray1:1</code>。换句话说，如果我们将下面两个JSONs(一个在对象样式，另一个在数组样式，见下面的截图)绑定到数组对象，它们将具有相同的值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/47378b04d7e0f55d739be7cfee7749cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FNWpC0EjpFkI3Iyez0fkPw.png"/></div></div></figure><p id="258c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，如果我们在设置文件中使用JSON数组格式，<code class="fe lr ls lt lu b">ConfigurationBinder</code>将利用每个元素的索引并设置其唯一的键。在上面的演示中，<code class="fe lr ls lt lu b">appsettings.Development.json</code>文件中的<code class="fe lr ls lt lu b">MyArray2</code>只有一个元素，因此<code class="fe lr ls lt lu b">ConfigurationBinder</code>用关键字<code class="fe lr ls lt lu b">AppSettings:MyArray2:0</code>覆盖配置数据，并保留来自<code class="fe lr ls lt lu b">appsettings.json</code>文件的其他带有关键字<code class="fe lr ls lt lu b">AppSettings:MyArray2:1</code>的配置数据。最后，<code class="fe lr ls lt lu b">MyArray2</code>包含两个元素。</p><h1 id="3e4a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">解决办法</h1><p id="0bab" class="pw-post-body-paragraph ku kv it kw b kx mn ju kz la mo jx lc ld mp lf lg lh mq lj lk ll mr ln lo lp im bi translated">由于这种行为是设计出来的，我们真的没有太多可以做的。对我来说，我更喜欢远离覆盖数组对象。我有两个选择。</p><ol class=""><li id="5d60" class="ng nh it kw b kx ky la lb ld ni lh nj ll nk lp nl nm nn no bi translated">不要在我的基本配置中存储数组值，这样就消除了数组覆盖的可能性。</li><li id="be57" class="ng nh it kw b kx np la nq ld nr lh ns ll nt lp nl nm nn no bi translated">使用逗号或分号分隔的字符串来存储配置数据，并将该字符串拆分为一个数组。</li></ol><p id="bca9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你呢？请分享你的想法。</p></div></div>    
</body>
</html>