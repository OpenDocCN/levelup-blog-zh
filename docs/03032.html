<html>
<head>
<title>Creating an API with FastAPI and Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用FastAPI和Docker创建API</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/creating-an-api-with-fastapi-and-docker-809429d778e6?source=collection_archive---------6-----------------------#2020-04-16">https://levelup.gitconnected.com/creating-an-api-with-fastapi-and-docker-809429d778e6?source=collection_archive---------6-----------------------#2020-04-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/7306588af9dfc7b7f4e559b2a49ff9ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cElQ2F-_v43zeyfGGbuPrg.png"/></div></div></figure><div class=""/><blockquote class="jy jz ka"><p id="9e6e" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">本教程基于大约2020年我们在<a class="ae la" href="http://lifemetrics.io" rel="noopener ugc nofollow" target="_blank"> LifeMetrics </a>建立的东西</p></blockquote><p id="4a27" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">部署一个生产就绪的API服务器通常是很麻烦的，但也不尽然。大约只需要15分钟！</p><p id="3e9b" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">FastAPI是一个令人惊叹的python框架，它使编写API变得简单，但也非常快！我们将把它构建在docker容器中，以实现提供者之间最大的可移植性，以及在Kubernetes部署中的潜在用途。</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="ad9a" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">设置项目</h1><p id="d507" class="pw-post-body-paragraph kb kc jb ke b kf mj kh ki kj mk kl km lb ml kp kq lc mm kt ku ld mn kx ky kz ij bi translated">我们将使用<a class="ae la" href="https://github.com/python-poetry/poetry" rel="noopener ugc nofollow" target="_blank">诗歌</a>来处理我们所有的依赖关系(这让人想起Node.js世界中的npm)。对于开发，我们将使用推荐的安装诗歌的方式:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="2045" class="mx lm jb mt b gy my mz l na nb">curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python</span></pre><p id="1488" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated"><strong class="ke jc">注意:</strong>在这一点上，你可能需要在你的道路上添加诗歌:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="04af" class="mx lm jb mt b gy my mz l na nb">export PATH=$PATH:$HOME/.poetry/bin</span></pre><p id="c8f7" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">接下来，我们将初始化我们的项目目录。这里我们制作了一个名为“orangutan”的API，让我们像这样设置我们的目录:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="90ae" class="mx lm jb mt b gy my mz l na nb"><strong class="mt jc">orangutan</strong><br/>    - <strong class="mt jc">orangutan</strong><br/>        - server.py</span></pre><p id="20ad" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">让我们有一个非常基本的服务器(学习如何制作一个更复杂/完整的API查看<a class="ae la" href="https://fastapi.tiangolo.com/tutorial/first-steps/" rel="noopener ugc nofollow" target="_blank">官方FastAPI教程</a>):</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="ff39" class="mx lm jb mt b gy my mz l na nb">"""An API about orangutans"""<br/>from fastapi import FastAPI</span><span id="dabf" class="mx lm jb mt b gy nc mz l na nb">app = FastAPI()</span><span id="817c" class="mx lm jb mt b gy nc mz l na nb"><a class="ae la" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.get("/")<br/>async def root():<br/>    return { "message": "The orangutans are three extant species of great apes native to Indonesia and Malaysia." }</span></pre><p id="f263" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">我们需要实际安装我们的fastapi依赖项以及任何附加的依赖项。让我们设置诗歌:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="9c50" class="mx lm jb mt b gy my mz l na nb">poetry init</span></pre><p id="37c8" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">在这个初始化过程中，会要求您添加依赖项，但是您也可以在之后使用:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="d4ee" class="mx lm jb mt b gy my mz l na nb">poetry add package_name</span></pre><p id="fdfa" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">我们需要确保添加我们的fastapi依赖项，让我们也向我们的Orangutan API添加一些公共包:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="f4cc" class="mx lm jb mt b gy my mz l na nb">poetry add fastapi<br/>poetry add requests<br/>poetry add pymongo<br/>poetry add -D black --allow-prereleases<br/>poetry add -D pytest<br/>poetry add -D flake8</span></pre><p id="9851" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated"><strong class="ke jc">注意:</strong><code class="fe nd ne nf mt b">-D</code>标志将一个依赖项标记为dev-dependency，我们可以安全地将其从生产部署中删除。添加black时需要使用<code class="fe nd ne nf mt b">--allow-prereleases</code>标志，因为从技术上来说，它并没有发布，只需要将它添加到black依赖项中。</p><p id="906c" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">我们的文件夹结构现在应该是这样的:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="323a" class="mx lm jb mt b gy my mz l na nb"><strong class="mt jc">orangutan</strong><br/>    - <strong class="mt jc">orangutan</strong><br/>        - server.py<br/>    - pyproject.toml<br/>    - poetry.lock</span></pre></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="388f" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">设置Docker</h1><p id="7945" class="pw-post-body-paragraph kb kc jb ke b kf mj kh ki kj mk kl km lb ml kp kq lc mm kt ku ld mn kx ky kz ij bi translated">我们将把我们的API打包到docker容器中用于生产。确保您已经在本地机器上安装了docker。然后，我们可以从在我们的基本orangutan目录中添加Dockerfile开始:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="e9f6" class="mx lm jb mt b gy my mz l na nb">FROM tiangolo/uvicorn-gunicorn-fastapi:python3.7</span><span id="f76a" class="mx lm jb mt b gy nc mz l na nb"># set path to our python api file<br/>ENV MODULE_NAME="orangutan.server"</span><span id="681c" class="mx lm jb mt b gy nc mz l na nb"># copy contents of project into docker<br/>COPY ./ /app</span><span id="d598" class="mx lm jb mt b gy nc mz l na nb"># install poetry<br/>RUN pip install poetry</span><span id="afd3" class="mx lm jb mt b gy nc mz l na nb"># disable virtualenv for peotry<br/>RUN poetry config virtualenvs.create false</span><span id="d42f" class="mx lm jb mt b gy nc mz l na nb"># install dependencies<br/>RUN poetry install</span></pre><p id="6c77" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">我们可以使用伟大的<a class="ae la" href="https://github.com/tiangolo/uvicorn-gunicorn-fastapi-docker" rel="noopener ugc nofollow" target="_blank">uvicon-guni corn-fastapi-docker</a>docker镜像，因为它通过合理的缺省值为我们做了很多工作。</p><p id="3f8a" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">&gt;<em class="kd">这个映像使用gunicorn，它在uvicon的基础上增加了负载平衡，但是如果我们将我们的容器作为负载平衡kubernetes部署的一部分来部署，我们可以使用一个只包含uvicon的docker映像，并让我们的容器编排复制来管理我们的负载平衡，这在生产环境中是很好的。感谢指出这一点</em> <a class="ng nh ep" href="https://medium.com/u/f1a1aed26c53?source=post_page-----809429d778e6--------------------------------" rel="noopener" target="_blank"> <em class="kd">埃里克·帕斯夸尔</em> </a></p><p id="a47d" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated"><strong class="ke jc">注意</strong>:我们应该禁用诗歌的默认行为来为我们的每个项目创建虚拟环境，因为一切都已经被隔离在docker容器中了。</p><p id="7c16" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated"><strong class="ke jc">注意</strong>:我们在这里以不同的方式安装诗歌，因为稍后更容易锁定我们需要的诗歌版本，以确保不会发生意外的变化。</p><p id="5621" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">我们只需将我们的文件移动到适当的目录中，docker镜像会处理剩下的工作。注意:确保您的FastAPI()实例被名为app的变量引用，或者您可以<a class="ae la" href="https://github.com/tiangolo/uvicorn-gunicorn-fastapi-docker#variable_name" rel="noopener ugc nofollow" target="_blank">更改docker容器的ENV以反映其名称</a>。</p><p id="54b9" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">让我们试着从我们的基本目录开始构建我们的映像吧！</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="73db" class="mx lm jb mt b gy my mz l na nb">docker build -t orangutan ./</span></pre><p id="72b2" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">这应该已经成功完成了，接下来让我们在本地机器上启动容器以确保它能够工作:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="ad25" class="mx lm jb mt b gy my mz l na nb">docker run -d --name orangutan0 -p 80:80 orangutan</span></pre><p id="36ec" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated"><code class="fe nd ne nf mt b">-d</code>标志将我们的容器作为守护进程启动，<code class="fe nd ne nf mt b">-name</code>标志命名我们的容器，<code class="fe nd ne nf mt b">-p</code>标志发布一个端口供docker之外的人访问。我们现在应该有一个运行在本地机器上的容器<code class="fe nd ne nf mt b">orangutan0</code>，我们可以通过<a class="ae la" href="http://127.0.0.1/" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1/ </a> 🥳访问它</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="b9d1" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">部署到服务器</h1><p id="38ed" class="pw-post-body-paragraph kb kc jb ke b kf mj kh ki kj mk kl km lb ml kp kq lc mm kt ku ld mn kx ky kz ij bi translated">我们将使用数字Ocean droplet来部署我们的API，但是您可以将它部署在任何可以运行docker容器的地方！这些是步骤:</p><ol class=""><li id="0891" class="ni nj jb ke b kf kg kj kk lb nk lc nl ld nm kz nn no np nq bi translated">将我们的docker图像推送到Docker Hub</li><li id="ca86" class="ni nj jb ke b kf nr kj ns lb nt lc nu ld nv kz nn no np nq bi translated">创建一个液滴</li><li id="c34d" class="ni nj jb ke b kf nr kj ns lb nt lc nu ld nv kz nn no np nq bi translated">ssh进入水滴</li><li id="2581" class="ni nj jb ke b kf nr kj ns lb nt lc nu ld nv kz nn no np nq bi translated">将我们的图像下载到我们的droplet上</li><li id="6cc9" class="ni nj jb ke b kf nr kj ns lb nt lc nu ld nv kz nn no np nq bi translated">发布我们的猩猩API🚀</li></ol><p id="1026" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">因此，让我们创建一个存储库，并将我们的映像推送到Docker Hub上(Docker映像的默认托管存储库，您必须拥有一个帐户并登录)。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="bd63" class="mx lm jb mt b gy my mz l na nb">docker tag orangutan:latest orangutan:latest<br/>docker push dockerhub_username/orangutan:latest</span></pre><p id="2b62" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated"><strong class="ke jc">注意:</strong>这将创建一个公共回购。我们很可能不希望这种情况出现在生产中，但是你可以在https://hub.docker.com/repositories改变这种情况。</p><p id="85b9" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">现在我们的图像已经公开了，让我们旋转我们的数字海洋水滴(这只是一个vps)。我们将使用rancherOS，因为它是专门为托管容器而设计的，并且非常轻量级。我们并不真的需要一个完整的操作系统，因为我们只是在运行我们的容器。</p><p id="cbb5" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">一旦你创造了一个牧场主的小滴。让我们用ssh登录rancher用户(您需要提供一个与digitalocean相关的ssh密钥来创建droplet)。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="c819" class="mx lm jb mt b gy my mz l na nb">ssh rancher@your_droplet_ip</span></pre><p id="c57b" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">在那里，我们需要执行几个命令来拉取和启动我们的映像:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="f6d6" class="mx lm jb mt b gy my mz l na nb">docker login</span><span id="eae9" class="mx lm jb mt b gy nc mz l na nb">docker pull dockerhub_username/orangutan</span><span id="9b73" class="mx lm jb mt b gy nc mz l na nb">docker run -d --name orangutan0 -p 80:80 dockerhub_username/orangutan</span></pre><p id="0c23" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">现在让我们尝试访问我们的水滴的ip！🚀我们已经部署了我们的api！</p><p id="f298" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">现在我们的工作流程看起来像这样:</p><ol class=""><li id="5c3a" class="ni nj jb ke b kf kg kj kk lb nk lc nl ld nm kz nn no np nq bi translated">在我们的本地机器上开发</li><li id="66fe" class="ni nj jb ke b kf nr kj ns lb nt lc nu ld nv kz nn no np nq bi translated">建立并推广我们新改变的码头工人形象</li><li id="e3d8" class="ni nj jb ke b kf nr kj ns lb nt lc nu ld nv kz nn no np nq bi translated">将最新版本放到我们的droplet上并重新发布</li></ol></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><p id="dd47" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">对于真实的生产环境，我们还需要设置一些东西:</p><ol class=""><li id="f7fd" class="ni nj jb ke b kf kg kj kk lb nk lc nl ld nm kz nn no np nq bi translated">负载平衡器后的冗余液滴(或使用负载平衡器的kubernetes)</li><li id="5a09" class="ni nj jb ke b kf nr kj ns lb nt lc nu ld nv kz nn no np nq bi translated">HTTPS支持</li><li id="76e8" class="ni nj jb ke b kf nr kj ns lb nt lc nu ld nv kz nn no np nq bi translated">将私人秘密注入ENV</li><li id="fdbf" class="ni nj jb ke b kf nr kj ns lb nt lc nu ld nv kz nn no np nq bi translated">当我们发布新版本时，自动重新部署我们的容器</li></ol><p id="3df6" class="pw-post-body-paragraph kb kc jb ke b kf kg kh ki kj kk kl km lb ko kp kq lc ks kt ku ld kw kx ky kz ij bi translated">我打算在以后的教程中讨论这些，但是我们已经从fastAPI中转移了技术栈，所以我不打算写更多的内容。</p></div></div>    
</body>
</html>