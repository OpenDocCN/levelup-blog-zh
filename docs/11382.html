<html>
<head>
<title>Stacked lines by percentiles: A new way to compare quantitative data across different categories</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">百分比堆积线:一种比较不同类别定量数据的新方法</h1>
<blockquote>原文：<a href="https://levelup.gitconnected.com/stacked-lines-by-percentiles-a-new-way-to-compare-quantitative-data-across-different-categories-9686794e1048?source=collection_archive---------7-----------------------#2022-03-12">https://levelup.gitconnected.com/stacked-lines-by-percentiles-a-new-way-to-compare-quantitative-data-across-different-categories-9686794e1048?source=collection_archive---------7-----------------------#2022-03-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ab7b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何在Python中创建一个新的绘图，以便在一个绘图中有效地比较多个类别的数字数据。</h2></div><p id="73c8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为一名数据分析师，我一直在寻找视觉上吸引人且有效的方式来传达数据见解。有一次，我无意中发现了一个类似这样的情节。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="ab gu cl lj"><img src="../Images/3e9b1c5684682760f9ae4b68b7e6cb7f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*hnW6Q-ewK90el-0sd38uIQ.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">按类别分类的每百分位平均销售额:按作者分类的图片</figcaption></figure><p id="cd8d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个图表的简单性和有效性让我震惊。该图完美地比较了不同类别的数字数据。它以x轴上的百分位数和y轴上的销售额为特征。在这个图表上，每个类别的销售额用一条线表示。然后，这些线中的许多线被水平堆叠，只占用它们对总销售额的贡献(占总销售额的百分比)一样多的空间。</p><p id="be4f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从上面的情节中得到的关键信息是:</p><ol class=""><li id="1062" class="lq lr it kk b kl km ko kp kr ls kv lt kz lu ld lv lw lx ly bi translated">“技术”领域的销售额最大，约占总销售额的37%。接下来是“家具”，约占总销售额的32%。其次是“办公用品”，占剩余的31%。</li><li id="0129" class="lq lr it kk b kl lz ko ma kr mb kv mc kz md ld lv lw lx ly bi translated">线条的形状也讲述了一个故事。在“技术”类别中，最大值是10000，这是最高百分位数的平均值。“家具”的最高百分位数平均值为5000，“办公用品”的最高百分位数平均值为6000。相对平坦的“办公用品”曲线告诉你，这一类别的最大销售额不到2000英镑，很少会达到6000英镑。</li><li id="46b7" class="lq lr it kk b kl lz ko ma kr mb kv mc kz md ld lv lw lx ly bi translated">这三个类别的平均值也显示了哪个类别的高价值产品更多。</li></ol><p id="1817" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们已经看到了这些情节是多么有信息价值，让我们言归正传，学习创造一个这样的情节。</p><h2 id="fb4c" class="me mf it bd mg mh mi dn mj mk ml dp mm kr mn mo mp kv mq mr ms kz mt mu mv mw bi translated">创建一条线</h2><p id="76d5" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">让我们先为一个产品类别画一条线。稍后，我们可以在下一步中将多行堆叠在一起。</p><p id="5ef0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该图的数据取自<a class="ae nc" href="https://www.kaggle.com/rohitsahoo/sales-forecasting" rel="noopener ugc nofollow" target="_blank">这里的</a>。它是来自美国几个城市的销售数据，涵盖各种产品类别、子类别、客户群和地理位置。让我们简单地看一下数据及其列。</p><figure class="le lf lg lh gt li"><div class="bz fp l di"><div class="nd ne l"/></div></figure><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="ab gu cl lj"><img src="../Images/416250365f252fad05e7978443147e15.png" data-original-src="https://miro.medium.com/v2/format:webp/1*QEY1ABonQ-3-DXZenp5FBA.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">数据框的头部:作者提供的图像</figcaption></figure><p id="fb34" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将首先为产品类别“办公用品”创建一个图。为此，我们首先按此类别过滤数据，然后按客户对数据进行分组，添加每个客户的销售额。然后，每个客户的总销售额按升序排序。</p><figure class="le lf lg lh gt li"><div class="bz fp l di"><div class="nd ne l"/></div></figure><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/3cd4783c03d59f9446505aea9a76f65e.png" data-original-src="https://miro.medium.com/v2/resize:fit:766/format:webp/1*MvI0GwXwmnm9AiEf9_RoDQ.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">产品类别-办公用品中每个客户的总销售额:作者图片</figcaption></figure><p id="4401" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据上面的数据，这个群体有787名消费者。这787个客户被分成100个百分点，每个百分点大约有7或8个客户。首先按照总销售额的顺序对客户进行排序，然后使用一个函数对其进行平均分配，从而将客户划分为百分位数。</p><p id="1b89" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面提供了将消费者平均分配到百分位数的代码。这段代码包括一些例子来更好地解释这个函数是如何工作的。</p><figure class="le lf lg lh gt li"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="464f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦客户被分成百分位数(第14行)，我们就计算每个百分位数的总销售额(第17行)、每个百分位数的客户数量(第18行)以及每个百分位数的平均销售额(第19行)。</p><figure class="le lf lg lh gt li"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="beaa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如此计算的汇总数据显示如下。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/3dc35f175e557fb6372d1d4aeee1075e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*IwZR63lU2xF-jtnLAsbwhQ.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">按客户和每百分位平均销售额汇总的数据:按作者分类的图片</figcaption></figure><p id="5206" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦所有的计算都完成了，剩下的就是在y轴上绘制每百分位的平均销售额，在x轴上绘制百分位。这是在第22–23行完成的，平均值显示在上面代码片段的第24–25行。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/56992e32875eec790191fb732e6166d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*o4fdT5BIXw7uXrxfp-0u8A.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">“办公用品”类别中每百分位平均销售额的折线图:作者图片</figcaption></figure><p id="7a04" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">尽管办公用品的最大销售额是8000，但该线的形状强烈表明大多数销售额都很适中。事实上，大约90%的销售额低于2000英镑。</p><h2 id="1e0f" class="me mf it bd mg mh mi dn mj mk ml dp mm kr mn mo mp kv mq mr ms kz mt mu mv mw bi translated">水平堆叠多行</h2><p id="7ec3" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">如果我们知道如何绘制一条直线，就很容易将它们水平堆叠起来。x轴(百分位数)被分成与堆叠类别一样多的段。创建单行的代码与我们之前看到的相同。</p><p id="a83c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们把这段代码放在一个函数中，它会更容易使用。该函数的参数有:-绘图所基于的列名、当前正在为其创建折线图的列值(类别)、低值和高值。参数“下限值”和“上限值”是百分位数(x值)的范围，我们希望该线位于该范围内。完整的代码如下。</p><figure class="le lf lg lh gt li"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="8c2f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在必须确定每个类别对总销售额的贡献。我们通过按列名对数据进行分组并计算总销售额来做到这一点。然后，通过将每个类别的销售额除以总销售额，可以计算出百分比。这是在上面的第27–28行中完成的。下面是显示总销售额和每个类别占总销售额的百分比的结果数据框。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/4c9d4e8b6a600612a5ffa24a07912e20.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/format:webp/1*Frn8FS4QRumsrm_WwsLaZg.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">按类别划分的销售额及其占总销售额的百分比:按作者划分的图像</figcaption></figure><p id="a08f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据上表,“技术”数据应绘制在百分位数0-36之间,“家具”数据应绘制在百分位数37-69之间，而“办公用品”数据应绘制在剩余的百分位数70-100之间。</p><p id="20e3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们通过运行一个循环(下面的第49行)来实现这一点，该循环遍历所有的类别值，并使用函数agg_df_by_category()重复聚合数据(第54行)。然后，数据被绘制成一个线形图(第57-62行),位于上述每个类别的百分位值之间。下面是创建百分比堆积折线图的完整代码。</p><figure class="le lf lg lh gt li"><div class="bz fp l di"><div class="nd ne l"/></div></figure><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="ab gu cl lj"><img src="../Images/3e9b1c5684682760f9ae4b68b7e6cb7f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*hnW6Q-ewK90el-0sd38uIQ.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">按产品类别的百分位图的堆积线:按作者的图像</figcaption></figure><p id="447b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为不同的列概括和应用堆叠线的代码是非常容易的，因为它被放在一个函数中，并将列名作为参数传递。对于customer-segment、region和ship-mode列，我们可以做出与上面类似的图。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nj"><img src="../Images/6645a9eaa63307bc4f899fcd5b0e3e6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m2OoPiwzvyLcU7gi9RihvA.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">按客户细分的每个百分点的平均销售额:按作者的图像</figcaption></figure><p id="48d2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">细分市场的百分比堆积线图显示,“消费者”细分市场的销售额最大(50%)，其次是“企业”(30%)，然后是“家庭办公”细分市场。这三个部分的平均值非常相似。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi no"><img src="../Images/3f836548c4b9827c7dc2af69d121a4cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TT_voL41eSPGDYcCxmv6Pg.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">按运输方式分类的每百分位平均销售额:按作者分类的图片</figcaption></figure><p id="ba1e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">按运输模式划分的每百分位平均销售额显示，“标准”模式占总销售额的60%，“二级”占19%，“一级”占17%，“当日”仅占5%。然而，值得注意的是，尽管当天交付的峰值明显短于其他运输方式，但其平均值高于标准和一流。这是一种典型的模式，价值较高的物品一般倾向于当天送达，价值较低的物品通常采用标准和二等送达。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi np"><img src="../Images/b78ce32031cd1c89727527e904c29664.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UqzH5JCmokbQRJQ0MaUtsw.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">各地区每百分位平均销售额:按作者分类的图片</figcaption></figure><p id="89a1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每个地区的平均销售额绘制成堆叠线。所有四个部分看起来具有相似的形状和特征。尽管东部在总销售额方面排名第二，但其平均销售额高于西部。它的峰值是所有地区中最高的，表明这个地区一定发生了一些高价值的销售。通过查看人口统计数据来进一步分析这一趋势，以确定该地区是否比其他地区拥有更多富裕客户，这将是一件有趣的事情。</p><h2 id="a371" class="me mf it bd mg mh mi dn mj mk ml dp mm kr mn mo mp kv mq mr ms kz mt mu mv mw bi translated">创建堆叠线图的面格网</h2><p id="76cb" class="pw-post-body-paragraph ki kj it kk b kl mx ju kn ko my jx kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">我们已经看到这些图表是多么的强大和有洞察力；比较两个或三个类别的趋势无疑会更加有用。这可以通过使用小平面网格来实现。这是通过将数据框(按所需列过滤)传递给stacked_line_plot()方法，然后在面格网中使用它来完成的。尽管详细的代码可能超出了本文的范围，感兴趣的读者可以在这里找到它。</p><p id="e9b6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是跨不同消费者细分市场的产品类别的多面网格示例</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/cf05907a1d108ae156692a5b197b4c21.png" data-original-src="https://miro.medium.com/v2/resize:fit:928/format:webp/1*MbMmI6s3blTf1hgY5v9uzw.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">按产品类别和客户群划分的每个百分点的平均销售额</figcaption></figure><p id="d445" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个图给我们提供了很多有用的信息。<br/> 1。家庭办公室似乎在三个类别的技术上花费最多。“技术曲线”的形状和x轴跨度及其平均值证明了这一点。<br/> 2。“家具”产品类别在“消费者”细分市场中的销售额位居第二，而“办公用品”在“企业”和“家庭办公”细分市场中的总销售额位居第二。尽管“家具”的平均销售价值高于“办公用品”。</p><p id="4706" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">按运输方式和产品类别划分的类似图表如下</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/c01833765bec82b4cbe5b24b11b7a9f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*cw-waCdxyvk3A4NrWZXW4Q.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">按运输方式和产品类别划分的平均每百分位销售额</figcaption></figure><p id="15f5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该图还提供了一些有趣的观察结果，例如:</p><ol class=""><li id="9720" class="lq lr it kk b kl km ko kp kr ls kv lt kz lu ld lv lw lx ly bi translated">“技术”部门从“当天”发货中获得的销售额最多。它的平均值也是所有细分市场和产品类别中最高的。只有一小部分办公用品是当天交货的。</li><li id="7cd4" class="lq lr it kk b kl lz ko ma kr mb kv mc kz md ld lv lw lx ly bi translated">有趣的是，“办公用品”是最受欢迎的“二类”商品，而“技术”排在第三位。</li></ol></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><p id="487b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这就结束了关于百分位数堆积线图的帖子。完整的代码可以在<a class="ae nc" href="https://github.com/hgarg01/Stacked-lines-by-percentiles" rel="noopener ugc nofollow" target="_blank">这里</a>找到。感谢您抽出时间阅读本文。我希望你学到了新的东西。我的一些其他受欢迎的文章可以在<a class="ae nc" href="https://medium.com/analytics-vidhya/a-complete-guide-to-twitter-sentiment-analysis-part-two-7349550bdea9" rel="noopener">这里</a>和<a class="ae nc" href="https://medium.com/analytics-vidhya/calendar-heatmaps-a-perfect-way-to-display-your-time-series-quantitative-data-ad36bf81a3ed" rel="noopener">这里</a>找到。如果这篇文章值得你花时间，请随意鼓掌并跟随<a class="ae nc" href="https://hgarg01.medium.com/" rel="noopener">。如果没有，请告诉我如何才能做得更好。继续读，继续学！！</a></p></div></div>    
</body>
</html>